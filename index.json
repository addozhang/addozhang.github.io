[{"categories":null,"contents":"Tetragon æ˜¯ä¸€ç§çµæ´»çš„å®‰å…¨å¯è§‚å¯Ÿæ€§å’Œè¿è¡Œæ—¶ç­–ç•¥æ‰§è¡Œå·¥å…·ï¼Œå¯ç›´æ¥ä½¿ç”¨ eBPF åº”ç”¨ç­–ç•¥å’Œè¿‡æ»¤ï¼Œä»è€Œå‡å°‘äº†ç›‘æ§ã€è¿›ç¨‹è·Ÿè¸ªä»¥åŠå®æ—¶æ‰§è¡Œç­–ç•¥çš„å¼€é”€ã€‚\nTetragon æä¾›äº†å¦‚ä¸‹åŠŸèƒ½ï¼š\nç›‘æ§è¿›ç¨‹æ‰§è¡Œ ç›‘æ§æ–‡ä»¶æ“ä½œ ç›‘æ§ç½‘ç»œæ´»åŠ¨ æ‰§è¡Œç­–ç•¥ æœ€åä¸€ä¸ªä¾§é‡ç­–ç•¥çš„æ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡å‘é€ä¿¡å·æˆ–è¦†ç›–ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼å¯¹é‡è¦çš„å®‰å…¨äº‹ä»¶åšå‡ºååº”ï¼›å‰ä¸‰ç§ä¾§é‡ç›‘æ§ï¼Œå¹¶å¯ä»¥å°†ç›‘æ§æ•°æ®ä¸å®¹å™¨ã€Kubernetes å…ƒæ•°æ®è¿›è¡Œå…³è”ã€‚\næ¼”ç¤º ç¯å¢ƒ æ“ä½œç³»ç»Ÿï¼šUbuntu 20.04 å†…æ ¸ï¼š5.15.122 K8s é›†ç¾¤ï¼šk3s v1.27.1+k3s1 åˆ›å»ºé›†ç¾¤ export INSTALL_K3S_VERSION=v1.27.1+k3s1 curl -sfL https://get.k3s.io | sh -s - --disable traefik --disable local-storage --disable metrics-server --disable servicelb --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config éƒ¨ç½²ç¤ºä¾‹åº”ç”¨ ç¤ºä¾‹åº”ç”¨ä½¿ç”¨æˆ‘ä»¬åœ¨ ä½¿ç”¨ Cilium å¢å¼º Kubernetes ç½‘ç»œå®‰å…¨ ä¸­æœ‰ç”¨è¿‡çš„â€æ˜Ÿçƒå¤§æˆ˜â€œçš„åœºæ™¯ã€‚\nkubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.15.0-pre.1/examples/minikube/http-sw-app.yaml å®‰è£… Tetragon ä½¿ç”¨ helm æ¥å®‰è£… Tetragonã€‚\nhelm repo add cilium https://helm.cilium.io helm repo update helm install tetragon cilium/tetragon -n kube-system æŸ¥çœ‹ Tetragon çš„ç»„ä»¶ã€‚\nkubectl get pod -n kube-system -l app.kubernetes.io/instance=tetragon NAME READY STATUS RESTARTS AGE tetragon-operator-f68fdfcf6-jltn2 1/1 Running 0 6m23s tetragon-mh8fp 2/2 Running 0 6m23s å…¶ä¸­ tetragon æ˜¯ Daemonset ç±»å‹ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½ä¼šè¿è¡Œå…¶ç¤ºä¾‹ã€‚åœ¨åé¢çš„æ¼”ç¤ºä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å…¶è·å–äº‹ä»¶ä¿¡æ¯ã€‚\nè¯¥å‘½ä»¤ä¼šä½¿ç”¨ pod ä¸­çš„ tetra CLI é“¾æ¥ Tetragon çš„ daemon server æ‰“å°å’Œè¿‡æ»¤äº‹ä»¶ã€‚\n-o æ”¯æŒ json å’Œ compactï¼šå‰è€…æ‰“å°è¯¦ç»†ä¿¡æ¯ï¼Œåè€…æ‰“å°ç´§å‡‘çš„ä¿¡æ¯ --pods æ‰“å°æŒ‡å®š pods çš„äº‹ä»¶ï¼Œè¿™é‡Œæ”¯æŒæ­£åˆ™\nkubectl exec -ti -n kube-system ds/tetragon -c tetragon -- tetra getevents -o compact --pods xwing ç›‘æ§è¿›ç¨‹æ‰§è¡Œ æˆ‘ä»¬åœ¨ xwing çš„ pod ä¸­å°è¯• curl å‘é€è¯·æ±‚ã€‚\nkubectl exec -ti xwing -- bash -c \u0026#39;curl -I https://ebpf.io/applications/#tetragon\u0026#39; åœ¨ CLI äº‹ä»¶ç›‘æ§ä¸­å¯ä»¥çœ‹åˆ°ç›‘æ§åˆ°è¿›è¡Œçš„æ‰§è¡Œã€‚\nğŸš€ process default/xwing /usr/bin/bash -c \u0026#34;curl -I https://ebpf.io/applications/#tetragon\u0026#34; ğŸš€ process default/xwing /usr/bin/curl -I https://ebpf.io/applications/#tetragon ğŸ’¥ exit default/xwing /usr/bin/curl -I https://ebpf.io/applications/#tetragon 0 è¦è·å–è¯¦ç»†çš„äº‹ä»¶ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ -o jsonã€‚åœ¨è¯¦ç»†ä¿¡æ¯ä¸­ï¼Œæ˜¯è®°å½•æ›´å¤šè¿›ç¨‹çš„è¯¦ç»†å†…å®¹ï¼ˆpidã€æ—¶é—´æˆ³ç­‰ï¼‰ä»¥åŠ Kubernetes çš„å…ƒæ•°æ®ï¼ˆæ‰€åœ¨çš„ podã€labelã€å®¹å™¨ç›¸å…³ã€node ç­‰ä¿¡æ¯ï¼‰ã€‚\n{ \u0026#34;process_exec\u0026#34;: { \u0026#34;process\u0026#34;: { \u0026#34;exec_id\u0026#34;: \u0026#34;bWFzdGVyOjEwOTE5NTI2MzMxNDc4OTM6ODY1Njk3\u0026#34;, \u0026#34;pid\u0026#34;: 865697, \u0026#34;uid\u0026#34;: 0, \u0026#34;cwd\u0026#34;: \u0026#34;/\u0026#34;, \u0026#34;binary\u0026#34;: \u0026#34;/usr/bin/bash\u0026#34;, \u0026#34;arguments\u0026#34;: \u0026#34;-c \\\u0026#34;curl -I https://ebpf.io/applications/#tetragon\\\u0026#34;\u0026#34;, \u0026#34;flags\u0026#34;: \u0026#34;execve rootcwd clone\u0026#34;, \u0026#34;start_time\u0026#34;: \u0026#34;2023-11-15T21:09:01.365214693Z\u0026#34;, \u0026#34;auid\u0026#34;: 4294967295, \u0026#34;pod\u0026#34;: { \u0026#34;namespace\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;xwing\u0026#34;, \u0026#34;container\u0026#34;: { \u0026#34;id\u0026#34;: \u0026#34;containerd://53d9871b8ef6acb30a918cd2edd036ef2482f3d2f50322296b846f9a964f23c6\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;spaceship\u0026#34;, \u0026#34;image\u0026#34;: { \u0026#34;id\u0026#34;: \u0026#34;docker.io/cilium/json-mock@sha256:4abfabfc1ac49834ce79b5594719e82b518107aa97e1867c42234a5126b1e1be\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;docker.io/cilium/json-mock:latest\u0026#34; }, \u0026#34;start_time\u0026#34;: \u0026#34;2023-11-15T14:09:41Z\u0026#34;, \u0026#34;pid\u0026#34;: 39 }, \u0026#34;pod_labels\u0026#34;: { \u0026#34;app.kubernetes.io/name\u0026#34;: \u0026#34;xwing\u0026#34;, \u0026#34;class\u0026#34;: \u0026#34;xwing\u0026#34;, \u0026#34;org\u0026#34;: \u0026#34;alliance\u0026#34; }, \u0026#34;workload\u0026#34;: \u0026#34;xwing\u0026#34;, \u0026#34;workload_kind\u0026#34;: \u0026#34;Pod\u0026#34; }, \u0026#34;docker\u0026#34;: \u0026#34;53d9871b8ef6acb30a918cd2edd036e\u0026#34;, \u0026#34;parent_exec_id\u0026#34;: \u0026#34;bWFzdGVyOjEwOTE5NTI1OTA0NDY0NzM6ODY1Njg3\u0026#34;, \u0026#34;tid\u0026#34;: 865697 }, \u0026#34;parent\u0026#34;: { \u0026#34;exec_id\u0026#34;: \u0026#34;bWFzdGVyOjEwOTE5NTI1OTA0NDY0NzM6ODY1Njg3\u0026#34;, \u0026#34;pid\u0026#34;: 865687, \u0026#34;uid\u0026#34;: 0, \u0026#34;cwd\u0026#34;: \u0026#34;/run/k3s/containerd/io.containerd.runtime.v2.task/k8s.io/9a020d636a187acf021007efe3aaf2bc2ac5af8c7bcaec8cff80834e1e456c49\u0026#34;, \u0026#34;binary\u0026#34;: \u0026#34;/var/lib/rancher/k3s/data/ead6a1703a6dcb4fa71296173ee208c5b05b95a27574fe74946557324bab2582/bin/runc\u0026#34;, \u0026#34;arguments\u0026#34;: \u0026#34;--root /run/containerd/runc/k8s.io --log /run/k3s/containerd/io.containerd.runtime.v2.task/k8s.io/53d9871b8ef6acb30a918cd2edd036ef2482f3d2f50322296b846f9a964f23c6/log.json --log-format json --systemd-cgroup exec --process /tmp/runc-process2446102553 --console-socket /tmp/pty4128173919/pty.sock --detach --pid-file /run/k3s/containerd/io.containerd.runtime.v2.task/k8s.io/53d9871b8ef6acb30a918cd2edd036ef2482f3d2f50322296b846f9a964f23c6/eaef092e99f54c7c3898984db0e0c36bc8859d695c753db86e672c8db576f4d8.pid 53d9871b8ef6acb30a918cd2edd036ef2482f3d2f50322296b846f9a964f23c6\u0026#34;, \u0026#34;flags\u0026#34;: \u0026#34;execve clone\u0026#34;, \u0026#34;start_time\u0026#34;: \u0026#34;2023-11-15T21:09:01.322512873Z\u0026#34;, \u0026#34;auid\u0026#34;: 4294967295, \u0026#34;parent_exec_id\u0026#34;: \u0026#34;bWFzdGVyOjEwNjY3Nzk1NTk0MzcxNTE6NzgyNTA4\u0026#34;, \u0026#34;tid\u0026#34;: 865687 } }, \u0026#34;node_name\u0026#34;: \u0026#34;master\u0026#34;, \u0026#34;time\u0026#34;: \u0026#34;2023-11-15T21:09:01.365213793Z\u0026#34; } ç›‘æ§æ–‡ä»¶æ“ä½œ æ¥ä¸‹æ¥åœ¨ xwing pod ä¸­çš„æ“ä½œæ–‡ä»¶ã€‚åœ¨ Linux ä¸­ /etc ç›®å½•é€šå¸¸åŒ…å«ç³»ç»Ÿçº§çš„é…ç½®æ–‡ä»¶å’Œè„šæœ¬ï¼Œè¿™äº›æ–‡ä»¶ç”¨äºé…ç½®ç³»ç»Ÿçš„å„ç§æ–¹é¢ï¼Œå› æ­¤å¯¹è¯¥ç›®å½•çš„æ“ä½œåº”å½“è°¨æ…ã€‚\nkubectl exec -ti xwing -- bash -c \u0026#39;echo foo \u0026gt;\u0026gt; /etc/bar\u0026#39; æ­¤æ—¶è¿™é‡Œçœ‹åˆ°è¿˜åªæ˜¯è¿›ç¨‹ç›¸å…³çš„äº‹ä»¶ã€‚\nğŸš€ process default/xwing /usr/bin/bash -c \u0026#34;cat /etc/bar\u0026#34; ğŸš€ process default/xwing /usr/bin/cat /etc/bar ğŸ’¥ exit default/xwing /usr/bin/cat /etc/bar 0 åº”ç”¨ä¸‹é¢çš„ç­–ç•¥ï¼š\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: cilium.io/v1alpha1 kind: TracingPolicy metadata: name: \u0026#34;file-monitoring-filtered\u0026#34; spec: kprobes: - call: \u0026#34;security_file_permission\u0026#34; syscall: false return: true args: - index: 0 type: \u0026#34;file\u0026#34; # (struct file *) used for getting the path - index: 1 type: \u0026#34;int\u0026#34; # 0x04 is MAY_READ, 0x02 is MAY_WRITE returnArg: index: 0 type: \u0026#34;int\u0026#34; returnArgAction: \u0026#34;Post\u0026#34; selectors: - matchArgs: - index: 0 operator: \u0026#34;Prefix\u0026#34; values: - \u0026#34;/etc\u0026#34; - index: 1 operator: \u0026#34;Equal\u0026#34; values: - \u0026#34;2\u0026#34; # MAY_WRITE EOF ç„¶åå°±å¯ä»¥çœ‹åˆ°æ–‡ä»¶æ“ä½œçš„ç›¸å…³äº‹ä»¶äº†ã€‚\nğŸš€ process default/xwing /usr/bin/bash -c \u0026#34;echo foo \u0026gt;\u0026gt; /etc/bar\u0026#34; ğŸ“ write default/xwing /usr/bin/bash /etc/bar ğŸ“ write default/xwing /usr/bin/bash /etc/bar ğŸ’¥ exit default/xwing /usr/bin/bash -c \u0026#34;echo foo \u0026gt;\u0026gt; /etc/bar\u0026#34; 0 ç›‘æ§ç½‘ç»œæ´»åŠ¨ åº”ç”¨ä¸‹é¢çš„ç­–ç•¥ï¼Œç›‘æ§ TCP è¿æ¥çš„å»ºç«‹ï¼Œä½†æ˜¯æ’é™¤é›†ç¾¤å†…çš„ç½‘ç»œè¿æ¥ï¼Œå°†å®¹å™¨çš„ IP CIDR æ’é™¤æ·»åŠ åˆ° NotDAddr çš„åˆ—è¡¨ä¸­ã€‚\n10.42.0.0/16 å’Œ 10.43.0.0/16 åˆ†åˆ«æ˜¯ K3s çš„ pod CIDR å’Œ service CIDRã€‚\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: cilium.io/v1alpha1 kind: TracingPolicy metadata: name: \u0026#34;monitor-network-activity-outside-cluster\u0026#34; spec: kprobes: - call: \u0026#34;tcp_connect\u0026#34; syscall: false args: - index: 0 type: \u0026#34;sock\u0026#34; selectors: - matchArgs: - index: 0 operator: \u0026#34;NotDAddr\u0026#34; values: - 127.0.0.1 - 10.42.0.0/16 - 10.43.0.0/16 matchActions: - action: Sigkill EOF åœ¨ç›‘æ§çš„äº‹ä»¶å°±å¯ä»¥çœ‹åˆ° TCP è¿æ¥çš„å»ºç«‹äº†ã€‚\nğŸš€ process default/xwing /usr/bin/bash -c \u0026#34;curl -I https://ebpf.io/applications/#tetragon\u0026#34; ğŸš€ process default/xwing /usr/bin/curl -I https://ebpf.io/applications/#tetragon ğŸ”Œ connect default/xwing /usr/bin/curl tcp 10.42.0.7:38676 -\u0026gt; 104.198.14.52:443 ğŸ’¥ exit default/xwing /usr/bin/curl -I https://ebpf.io/applications/#tetragon 0 æ‰§è¡Œç­–ç•¥ å‡å¦‚éœ€è¦å¯¹ /etc ç›®å½•è¿›è¡Œå†™ä¿æŠ¤ï¼Œéœ€è¦ä¸Šé¢åˆ›å»ºçš„ file-monitoring-filtered ç­–ç•¥ï¼Œæ·»åŠ  matchActionsã€‚\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: cilium.io/v1alpha1 kind: TracingPolicy metadata: name: \u0026#34;file-monitoring-filtered\u0026#34; spec: kprobes: - call: \u0026#34;security_file_permission\u0026#34; syscall: false return: true args: - index: 0 type: \u0026#34;file\u0026#34; # (struct file *) used for getting the path - index: 1 type: \u0026#34;int\u0026#34; # 0x04 is MAY_READ, 0x02 is MAY_WRITE returnArg: index: 0 type: \u0026#34;int\u0026#34; returnArgAction: \u0026#34;Post\u0026#34; selectors: - matchArgs: - index: 0 operator: \u0026#34;Prefix\u0026#34; values: - \u0026#34;/etc\u0026#34; - index: 1 operator: \u0026#34;Equal\u0026#34; values: - \u0026#34;2\u0026#34; # MAY_WRITE matchActions: - action: Sigkill EOF ç°åœ¨å°è¯•ä¿®æ”¹ /etc ä¸‹çš„æ–‡ä»¶æ—¶ï¼Œè¿›ç¨‹ä¼šç›´æ¥é€€å‡ºã€‚\nkubectl exec -ti xwing -- bash -c \u0026#39;echo foo \u0026gt;\u0026gt; /etc/bar\u0026#39; command terminated with exit code 137 åœ¨äº‹ä»¶ç›‘æ§ä¸­å¯ä»¥çœ‹åˆ°è¿›ç¨‹æ‰§è¡Œæ”¶åˆ°äº† SIGKILL æŒ‡ä»¤ã€‚\nğŸš€ process default/xwing /usr/bin/bash -c \u0026#34;echo foo \u0026gt;\u0026gt; /etc/bar\u0026#34; ğŸ“ write default/xwing /usr/bin/bash /etc/bar ğŸ“ write default/xwing /usr/bin/bash /etc/bar ğŸ’¥ exit default/xwing /usr/bin/bash -c \u0026#34;echo foo \u0026gt;\u0026gt; /etc/bar\u0026#34; SIGKILL åŒæ ·ï¼Œé’ˆå¯¹ç½‘ç»œæ´»åŠ¨çš„ç›‘æ§ä¹Ÿå¯ä»¥å¦‚æ³•ç‚®åˆ¶ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è¯•è¯•ã€‚\nåˆ†æ Tetragon æ¶æ„ è¿™ä¸ªæ¶æ„å›¾è·Ÿä¹‹å‰åœ¨ æ¢ç´¢ Cilium çš„å·¥ä½œæœºåˆ¶ æ‰€åšçš„å›¾ç±»ä¼¼ï¼Œå®é™…çš„å·¥ä½œæœºåˆ¶ä¹Ÿç±»ä¼¼ã€‚\né€šè¿‡å‘½ä»¤å¯ä»¥çœ‹åˆ° tetragon pod ä¸­å®é™…ä¸Šæœ‰ä¸¤ä¸ªå®¹å™¨ï¼šexport-stdout å’Œ tetragonã€‚\nkubectl get pod tetragon-mh8fp -o=jsonpath=\u0026#39;{.spec.containers[*].name}\u0026#39; -n kube-system export-stdout tetragon tetragon å®¹å™¨ä¸­è¿è¡Œäº† Tetragon çš„ Daemon è¿›ç¨‹ï¼Œåœ¨è¿™ä¸ªå®¹å™¨ä¸­è¿˜å¯ä»¥æ‰§è¡Œ tetra å‘½ä»¤ï¼ˆtetragon CLIï¼‰ã€‚\nDaemon è¿›ç¨‹ï¼š\nåŠ è½½/å¸è½½ BPF ç¨‹åº ç›‘æ§ç­–ç•¥çš„å˜åŒ–ï¼Œå°†ç­–ç•¥å†™å…¥åˆ° eBPF Map ä¸­ã€‚åœ¨é K8s ç¯å¢ƒï¼Œä¼šç›‘æ§æ–‡ä»¶ç›®å½•ä¸­çš„ç­–ç•¥æ›´æ–°ã€‚ å¯¹å¤–æä¾›äº† gRPC çš„ APIï¼Œç›‘å¬åœ¨ 127.0.0.1:54321ã€‚CLI çš„æ‰§è¡Œå®é™…ä¸Šéƒ½æ˜¯é€šè¿‡è¯¥ API ä¸ Daemon è¿›è¡Œäº¤äº’ã€‚ è·Ÿè¸ªç­–ç•¥ ä¸Šé¢æ¼”ç¤ºä¸­ä¸ç®¡æ˜¯ç›‘æ§è¿˜æ˜¯ç­–ç•¥æ‰§è¡Œï¼Œéƒ½æ˜¯é€šè¿‡ è·Ÿè¸ªç­–ç•¥ï¼ˆTracing Policyï¼‰ æ¥å®Œæˆã€‚è·Ÿè¸ªç­–ç•¥ TracingPolicy æ˜¯ Tetragon çš„è‡ªå®šä¹‰èµ„æºï¼Œå…è®¸ç”¨æˆ·è·Ÿè¸ªå†…æ ¸ä¸­çš„ä»»æ„äº‹ä»¶ï¼Œå¹¶å¯å®šä¹‰å¯¹åŒ¹é…é‡‡å–çš„æ“ä½œã€‚\nç­–ç•¥ç”±æŒ‚é’©ç‚¹ï¼ˆhook pointï¼Œæ”¯æŒ kprobesã€tracepoint å’Œ uprobesï¼‰ä»¥åŠç”¨äºå†…æ ¸è¿‡æ»¤å’ŒæŒ‡å®šæ“ä½œçš„é€‰æ‹©å™¨ç»„æˆã€‚\næŒ‚é’©ç‚¹ Hook Point Tetragon æ”¯æŒä¸‰ç§æŒ‚é’©ç‚¹ï¼šæ”¯æŒ kprobesã€tracepoint å’Œ uprobesã€‚kprobesÂ å’ŒÂ tracepointsÂ å¯ç”¨äºè¿æ¥å†…æ ¸ç©ºé—´ï¼Œè€ŒÂ uprobesÂ ç”¨äºè¿æ¥åˆ°ç”¨æˆ·ç©ºé—´ç¨‹åºã€‚\nkprobes å†…æ ¸ç©ºé—´æ¢é’ˆï¼šå°† BPF ä»£ç æŒ‚è½½åˆ°å†…æ ¸å‡½æ•°ï¼Œæ¯”å¦‚å‰é¢ç›‘æ§ç½‘ç»œæ´»åŠ¨æ—¶ç”¨çš„ tcp_connectï¼Œä¸å†…æ ¸ç‰ˆæœ¬å¼ºç›¸å…³ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒå†…æ ¸ç‰ˆæœ¬çš„å†…æ ¸å‡½æ•°æ¢é’ˆå¯èƒ½å­˜åœ¨å·®å¼‚ã€‚ tracepoints è·Ÿè¸ªç‚¹ï¼šä¸ kprobes ç›¸æ¯”ï¼Œåœ¨ä¸åŒå†…æ ¸ç‰ˆæœ¬é—´çš„å·®å¼‚å¾ˆå°ï¼Œæ›´åŠ ç¨³å®šã€‚å¯ä»¥é€šè¿‡ sudo ls /sys/kernel/debug/tracing/events æŸ¥çœ‹å†…æ ¸ä¸Šå¯ç”¨çš„è·Ÿè¸ªç‚¹åˆ—è¡¨ã€‚ uprobes å†…æ ¸ç©ºé—´æ¢é’ˆï¼šåœ¨ç”¨æˆ·ç©ºé—´ç¨‹åºçš„ç‰¹å®šåœ°å€è®¾ç½®æ¢é’ˆï¼Œç›‘æ§å’Œè·Ÿè¸ªç”¨æˆ·ç©ºé—´ä»£ç çš„æ‰§è¡Œã€‚ï¼ˆç›®å‰ Tetragon è¿™éƒ¨åˆ†çš„æ–‡æ¡£æ˜¯ç¼ºå¤±çš„ï¼‰ã€‚ é€‰æ‹©å™¨ Selector åœ¨ Tetragon ä¸­ï¼ŒTracingPolicyä½¿ç”¨é€‰æ‹©å™¨æ¥å®šä¹‰å¯¹äº‹ä»¶æ‰€è¦æ‰§è¡Œçš„å†…æ ¸ BPF è¿‡æ»¤å’Œæ“ä½œï¼Œä¹Ÿå°±æ˜¯ç­–ç•¥ä¸­æŒ‡å®šå…³æ³¨çš„äº‹ä»¶ä»¥åŠäº‹ä»¶å‘ç”Ÿæ—¶è¦è§¦å‘çš„æ“ä½œã€‚é€‰æ‹©å™¨åŒ…å«å¦‚ä¸‹å‡ ç§ï¼š\nå‚æ•° è¿”å›å€¼ è¿›ç¨‹ PID äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„ Linux å‘½åç©ºé—´ Linux åŠŸèƒ½ å‘½åç©ºé—´å˜æ›´ Linux åŠŸèƒ½å˜æ›´ å¯¹é€‰æ‹©å™¨åº”ç”¨æ“ä½œ æ¯”å¦‚æˆ‘ä»¬åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œé’ˆå¯¹ /etc ç›®å½•çš„å†™ä¿æŠ¤å°±ç”¨åˆ°äº†å‚æ•°é€‰æ‹©å™¨ï¼ˆåŒ¹é…æ“ä½œçš„ç›®å½•å’Œæ“ä½œç±»å‹ï¼‰å’Œæ“ä½œé€‰æ‹©å™¨ï¼ˆè¿”å› Sigkill ä¿¡å·ï¼‰ã€‚\næ€»ç»“ Tetragon æ˜¯ä¸€ä¸ªä¸“æ³¨äº eBPFã€å®æ—¶å¤„ç†ã€å®‰å…¨æ€§ã€å¯è§‚æµ‹æ€§å’Œç­–ç•¥æ‰§è¡Œçš„å·¥å…·ï¼Œç‰¹åˆ«æ˜¯åœ¨ Kubernetes ç¯å¢ƒä¸­ã€‚å®ƒé€šè¿‡åˆ©ç”¨ä¸€ç³»åˆ—é«˜çº§çš„æŒ‚é’©ç‚¹ï¼ˆhook pointsï¼‰å’Œé€‰æ‹©å™¨ï¼ˆselectorsï¼‰ï¼Œä¸ºåŸºç¡€è®¾æ–½å®‰å…¨æä¾›äº†å¼ºå¤§æ”¯æŒï¼Œå¹¶èƒ½å¤Ÿé’ˆå¯¹å…³é”®äº‹ä»¶è¿›è¡Œæœ‰æ•ˆé˜²æŠ¤ã€‚\næ·±å…¥ç†è§£ Tetragonï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒä¸»è¦æ˜¯ä¸€ä¸ªåº•å±‚å·¥å…·ï¼Œä¸“æ³¨äºå›´ç»•è¿›ç¨‹ã€æ–‡ä»¶å’Œç½‘ç»œæ´»åŠ¨å®æ–½å®‰å…¨ç­–ç•¥ã€‚åœ¨ç½‘ç»œæ–¹é¢ï¼ŒTetragon ä¸»è¦å¤„ç†ç¬¬ä¸‰å±‚ï¼ˆL3ï¼‰çš„åŸºç¡€ä¿¡æ¯äº‹ä»¶ï¼Œå¦‚ IP å±‚é¢çš„é€šä¿¡ã€‚ä½†å®ƒåœ¨å¤„ç†æ›´é«˜å±‚æ¬¡çš„åº”ç”¨åè®®ï¼Œå¦‚ç¬¬å››å±‚ï¼ˆL4ï¼‰çš„ä¼ è¾“æ§åˆ¶åè®®ï¼ˆTCPï¼‰æˆ–ç¬¬ä¸ƒå±‚ï¼ˆL7ï¼‰çš„åº”ç”¨å±‚åè®®æ–¹é¢ï¼Œèƒ½åŠ›æœ‰é™ã€‚è¿™ç§é™åˆ¶åæ˜ äº† Tetragon çš„æ ¸å¿ƒå®šä½ï¼šä¸“æ³¨äºåº•å±‚ç»“æ„çš„ç›‘æ§å’Œå®‰å…¨ï¼Œè€Œéé«˜å±‚åº”ç”¨åè®®çš„åˆ†æã€‚\næ€»çš„æ¥è¯´ï¼ŒTetragon æä¾›äº†ä¸€ä¸ªé’ˆå¯¹ Kubernetes ç¯å¢ƒä¼˜åŒ–çš„ã€åº•å±‚çš„å®‰å…¨å’Œç›‘æ§å·¥å…·ï¼Œå…¶å¼ºå¤§çš„ eBPF æ”¯æŒä½¿å…¶åœ¨å¤„ç†åŸºç¡€è®¾æ–½å®‰å…¨äº‹ä»¶æ—¶è¡¨ç°å‡ºè‰²ï¼Œå°½ç®¡åœ¨æ›´é«˜å±‚æ¬¡çš„ç½‘ç»œåè®®å¤„ç†ä¸Šæœ‰æ‰€å±€é™ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/11/16/pexels-quang-nguyen-vinh-2649403.jpg","permalink":"https://atbug.com/explore-tetragon-security-observability-and-enforcement-tool-based-on-ebpf/","tags":null,"title":"å¿«é€Ÿæ¢ç´¢ Tetragonï¼šåŸºäº eBPF çš„å®‰å…¨å¯è§‚å¯Ÿæ€§å’Œæ‰§è¡Œå·¥å…·"},{"categories":["ç¬”è®°"],"contents":"èƒŒæ™¯ åœ¨å¹³æ—¶çš„å·¥ä½œä¸­ï¼Œä¸ºäº†æ–¹ä¾¿åœ¨çº¯å‡€çš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ï¼Œæˆ‘ç»å¸¸éœ€è¦åœ¨æœ¬åœ°æˆ–è€…å…¬æœ‰äº‘ç¯å¢ƒä¸­é¢‘ç¹åœ°æ­å»ºå’Œé”€æ¯é›†ç¾¤ã€‚æœ‰æ—¶æ˜¯åœ¨ æˆ‘çš„ HomeLab ç¯å¢ƒä¸­ï¼Œè™½ç„¶ CPU ä¸å¼ºä½†èƒœåœ¨å†…å­˜å¤Ÿå¤§ï¼›åæ¥æœ‰äº†å¾®è½¯ MVP èµ é€çš„ Azure é¢åº¦ä¹‹åï¼Œæˆ‘ä¹Ÿä¼šç»å¸¸åœ¨ Azure è™šæ‹Ÿæœº ä¸­æ­å»ºï¼Œå› ä¸ºæ²¡æœ‰æ‹‰å–é•œåƒçš„ç½‘ç»œé—®é¢˜ã€‚\nåœ¨ä¸¤ä¸ªç¯å¢ƒä¸­æˆ‘é€šè¿‡ Terraform å®ç°äº†è™šæ‹Ÿæœºçš„å¿«é€Ÿåˆ›å»ºå’Œé”€æ¯ï¼Œç„¶ååœ¨è™šæ‹Ÿæœºä¸Šåˆ›å»º K3s é›†ç¾¤ã€‚K3s é›†ç¾¤è¶³å¤Ÿè½»é‡çº§ï¼Œå¹¶æ”¯æŒå¯¹ç»„ä»¶çš„å®šåˆ¶ã€‚ç»“åˆ Alfred Snippetsï¼Œæˆ‘åªéœ€è¦ ssh åˆ°è™šæ‹Ÿæœºä¸Šå¹¶é”®å…¥ k3si å°±å¯ä»¥å¿«é€Ÿè¾“å…¥å®šåˆ¶å¥½çš„å‘½ä»¤ï¼Œç„¶åå†è·å–è™šæ‹Ÿæœºä¸Šçš„ kubeconfig æ–‡ä»¶å¹¶æ›¿æ¢å…¶ä¸­çš„ api-server åœ°å€ï¼ˆè¿™äº›ä¹Ÿé€šè¿‡ snippetï¼‰è§£å†³ï¼š\nexport MASTER_IP=${MASTER_IP:-$(ip addr show eth0 | grep \u0026#39;inet \u0026#39; | awk \u0026#39;{print $2}\u0026#39; | cut -d/ -f1)} export INSTALL_K3S_VERSION=v1.23.8+k3s1 curl -sfL https://get.k3s.io | sh -s - --disable traefik --disable local-storage --disable metrics-server --advertise-address=$MASTER_IP --disable servicelb --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config å•èŠ‚ç‚¹çš„é›†ç¾¤æ“ä½œèµ·æ¥è¿˜ç®—ä¾¿æ·ï¼Œä½†éœ€è¦å¤šèŠ‚ç‚¹çš„é›†ç¾¤æ—¶ä¹Ÿè¿˜è¦ ssh åˆ°æ‰€æœ‰ä¸»æœºä¸Šè¿›è¡Œæ“ä½œï¼Œå½“ç„¶å°‘ä¸äº†å¤åˆ¶ master èŠ‚ç‚¹çš„ tokenã€‚ä¸å…è¿˜æ˜¯æœ‰äº›ç¹çã€‚\nåæ¥å°±å‘ç°äº†æ›´å¿«æ·çš„å·¥å…·ï¼Œç”± Alex Ellis åˆ›å»ºçš„ k3supï¼ˆå‘éŸ³ â€˜ketchupâ€™ï¼‰ã€‚\nk3sup ç®€ä»‹ k3sup æ˜¯ä¸€ä¸ªè½»é‡çº§å·¥å…·ï¼Œç”¨äºå¿«é€Ÿæ­å»º K3s é›†ç¾¤ã€‚\nk3sup çš„ç‰¹ç‚¹æ˜¯æ˜“äºä½¿ç”¨ï¼Œåªéœ€å•ä¸ªå‘½ä»¤å³å¯åœ¨ä¸åŒçš„å¹³å°ä¸Šå®‰è£… K3sã€‚å®ƒä½¿ç”¨æˆ·å¯ä»¥å¿«é€Ÿåˆ›å»º Kubernetes é›†ç¾¤ï¼Œå¹¶å¯ä»¥è½»æ¾åœ°å°†æ–°èŠ‚ç‚¹åŠ å…¥åˆ°ç°æœ‰é›†ç¾¤ä¸­ã€‚\nk3sup é€šè¿‡ SSH è¿æ¥åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼Œç„¶åè‡ªåŠ¨å®‰è£…å’Œé…ç½® K3sã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•å¯ä»¥é€šè¿‡ SSH è®¿é—®çš„æœºå™¨ä¸Šå®‰è£…å’Œè¿è¡Œ Kubernetesï¼ŒåŒ…æ‹¬æœ¬åœ°æœºå™¨ã€äº‘æœåŠ¡å™¨æˆ–æ ‘è“æ´¾ç­‰è®¾å¤‡ã€‚\nç®€å•ç†è§£å°±æ˜¯ä½¿ç”¨ k3sup å®Œæˆäº† ssh åˆ°ä¸»æœºã€å®‰è£… K3s serverã€å¤åˆ¶ tokenã€ssh åˆ° agent ä¸»æœºã€å®‰è£… K3s agent \u0026hellip; ç­‰ä¸€ç³»åˆ—çš„æ“ä½œã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•ä½¿ç”¨ k3supã€‚\nå®‰è£… k3sup k3sup æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œä½¿ç”¨å‰è¦ä¸‹è½½å®‰è£… CLIã€‚\nLinux:\ncurl -sLS https://get.k3sup.dev | sh sudo install k3sup /usr/local/bin/ macOS:\nbrew install k3sup ä½¿ç”¨ k3sup æ”¯æŒå¦‚ä¸‹å‘½ä»¤ï¼š\ncompletionï¼šä¸ºæŒ‡å®šçš„ shell ç”Ÿæˆè‡ªåŠ¨å®Œæˆè„šæœ¬ helpï¼šå¸®åŠ© installï¼šé€šè¿‡ SSH åœ¨æœåŠ¡å™¨ä¸Šå®‰è£… K3s joinï¼šåœ¨è¿œç¨‹ä¸»æœºä¸Šå®‰è£… K3s ä»£ç†å¹¶å°†å…¶åŠ å…¥åˆ°ç°æœ‰é›†ç¾¤ readyï¼šä½¿ç”¨ kubectl æ£€æŸ¥é›†ç¾¤æ˜¯å¦å·²å°±ç»ªã€‚ updateï¼šæ‰“å°æ›´æ–°è¯´æ˜ versionï¼šæ‰“å°ç‰ˆæœ¬ åˆ›å»ºé›†ç¾¤ä¼šç”¨åˆ° install å’Œ join ä¸¤ä¸ªå‘½ä»¤ã€‚\ninstall å‘½ä»¤ install å‘½ä»¤ç”¨äºåœ¨æœåŠ¡å™¨ä¸Šå®‰è£… K3sï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å³å¯åœ¨è¿œç¨‹ä¸»æœºä¸Šå®‰è£… k3sã€‚\nå…¶ä¸­ --ip æŒ‡å‘è¿œç¨‹ä¸»æœºçš„åœ°å€ï¼Œ--user ä¸ºç™»å½•è¿œç¨‹ä¸»æœºçš„ç”¨æˆ·åï¼Œ--k3s-channel è¿™æ˜¯è¦å®‰è£…çš„ç‰ˆæœ¬ï¼Œ--local-path é›†ç¾¤ kubeconf çš„æœ¬åœ°ä¿å­˜åœ°å€ã€‚æ›´å¤šçš„é€‰é¡¹å¯ä»¥é€šè¿‡ k3sup help install æ¥æŸ¥çœ‹ã€‚\nk3sup é»˜è®¤ä½¿ç”¨ ssh key ~/.ssh/id_rsa æ¥è®¿é—®ä¸»æœºï¼Œå¯é€šè¿‡ --ssh-key é€‰é¡¹æŒ‡å®šã€‚\nexport MASTER_IP=192.168.1.11 k3sup install --ip $MASTER_IP \\ --user addo \\ --k3s-channel v1.24 \\ --local-path /tmp/config æ‰§è¡Œå‘½ä»¤ä¼šæ‰“å°å®‰è£…è¿‡ç¨‹ä¸­çš„æ—¥å¿—ã€‚\nRunning: k3sup install 2023/10/26 09:04:35 192.168.1.11 Public IP: 192.168.1.11 [INFO] Finding release for channel v1.24 [INFO] Using v1.24.17+k3s1 as release ... Saving file to: /tmp/config # Test your cluster with: export KUBECONFIG=/tmp/config kubectl config use-context default kubectl get node -o wide æ‰§è¡Œå‘½ä»¤ï¼ŒæŸ¥çœ‹èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚\nexport KUBECONFIG=/tmp/config kubectl get node -o wide NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME master Ready control-plane,master 1m v1.24.17+k3s1 10.0.2.4 \u0026lt;none\u0026gt; Ubuntu 20.04.6 LTS 5.15.0-1047-azure containerd://1.7.3-k3s1 å¦‚æœæ˜¯å®‰è£…å•èŠ‚ç‚¹é›†ç¾¤ï¼Œinstall å‘½ä»¤å°±è¶³å¤Ÿäº†ã€‚å‡å¦‚æ˜¯å¤šèŠ‚ç‚¹é›†ç¾¤ï¼Œå°±è¿˜éœ€è¦ç”¨åˆ° join å‘½ä»¤ã€‚\njoin å‘½ä»¤ ä½¿ç”¨ join å‘½ä»¤å¯ä»¥åˆå§‹åŒ– agent èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ°å½“å‰çš„é›†ç¾¤ä¸­ï¼Œéœ€è¦ä½¿ç”¨ --server-ip æŒ‡å®š server èŠ‚ç‚¹çš„ IP åœ°å€ï¼ŒåŒæ ·éœ€è¦ --k3s-channel æŒ‡å®šå®‰è£…çš„ç‰ˆæœ¬ï¼Œå¼ºçƒˆå»ºè®®å®‰è£…äº server èŠ‚ç‚¹åŒæ ·çš„ç‰ˆæœ¬ã€‚\nexport AGENT_IP=192.168.1.12 k3sup join --ip $AGENT_IP --user addo --server-ip $MASTER_IP --k3s-channel v1.24 Running: k3sup join Agent: 192.168.1.11 Server: 192.168.1.12 Received node-token from 192.168.1.11.. ok. [INFO] Finding release for channel v1.24 [INFO] Using v1.24.17+k3s1 as release ... æŸ¥çœ‹èŠ‚ç‚¹ï¼š\nkubectl get no NAME STATUS ROLES AGE VERSION node-1 Ready \u0026lt;none\u0026gt; 43s v1.24.17+k3s1 master Ready control-plane,master 2m58s v1.24.17+k3s1 å®Œæ•´è„šæœ¬ è®© ChatGPT ç”Ÿæˆäº†è„šæœ¬ä¸€é”®åˆ›å»ºé›†ç¾¤ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è¯•è¯•åˆ›å»ºä¸ªåŒèŠ‚ç‚¹çš„é›†ç¾¤éœ€è¦å¤šä¹…ã€‚æˆ‘è¯•äº†ä¸‹ï¼Œè€—æ—¶ 32s å·¦å³ã€‚\n# Define IP addresses export HOSTS=\u0026#34;192.168.1.11 192.168.1.12\u0026#34; æ­å»ºé›†ç¾¤ #!/bin/bash # Read the list of IP addresses from the environment variable IP_ADDRESSES=($HOSTS) # Define the k3s version K3S_VERSION=\u0026#34;v1.24\u0026#34; # Check if there is at least one IP address if [ ${#IP_ADDRESSES[@]} -eq 0 ]; then echo \u0026#34;No IP addresses found. Please ensure the HOSTS environment variable is correctly set.\u0026#34; exit 1 fi # Install the master node MASTER_IP=${IP_ADDRESSES[0]} echo \u0026#34;Installing master node: $MASTER_IP\u0026#34; k3sup install --ip $MASTER_IP --user addo --k3s-channel $K3S_VERSION \\ --k3s-extra-args \u0026#39;--write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config --disable traefik --disable metrics-server --disable local-storage --disable servicelb\u0026#39; \\ --local-path /tmp/config # Install the other agent nodes for i in \u0026#34;${!IP_ADDRESSES[@]}\u0026#34;; do if [ $i -ne 0 ]; then AGENT_IP=${IP_ADDRESSES[$i]} echo \u0026#34;Installing agent node: $AGENT_IP\u0026#34; k3sup join --ip $AGENT_IP --server-ip $MASTER_IP --user addo --k3s-channel $K3S_VERSION fi done echo \u0026#34;k3s cluster installation complete.\u0026#34; å¸è½½é›†ç¾¤ #!/bin/bash # Read the list of IP addresses from the environment variable IP_ADDRESSES=($HOSTS) # Check if there is at least one IP address if [ ${#IP_ADDRESSES[@]} -eq 0 ]; then echo \u0026#34;No IP addresses found. Please ensure the HOSTS environment variable is correctly set.\u0026#34; exit 1 fi # Clean up the master node MASTER_IP=${IP_ADDRESSES[0]} echo \u0026#34;Cleaning up master node: $MASTER_IP\u0026#34; ssh -i ~/.ssh/id_rsa $MASTER_IP k3s-uninstall.sh # Clean up the other agent nodes for i in \u0026#34;${!IP_ADDRESSES[@]}\u0026#34;; do if [ $i -ne 0 ]; then AGENT_IP=${IP_ADDRESSES[$i]} echo \u0026#34;Cleaning up agent node: $AGENT_IP\u0026#34; ssh -i ~/.ssh/id_rsa $AGENT_IP k3s-agent-uninstall.sh fi done echo \u0026#34;k3s cluster cleanup complete.\u0026#34; ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/10/27/pexels-pixabay-417018.jpg","permalink":"https://atbug.com/setup-k3s-cluster-with-k3sup-in-one-minute/","tags":["k3s","å·¥å…·"],"title":"ä½¿ç”¨ k3sup ä¸€åˆ†é’Ÿå¿«é€Ÿæ­å»º K3s é›†ç¾¤"},{"categories":["ç¬”è®°"],"contents":"TL;DR æ€ä¹ˆç†è§£ Service Weaverï¼Œå°±æ˜¯ä¸€ä¸ªåº”ç”¨ä¸­æœ‰å¾ˆå¤šçš„æ¥å£ï¼Œè¿™äº›æ¥å£é—´ä¼šäº’ç›¸è°ƒç”¨ã€‚å¦‚æœå°†æ“ä½œç³»ç»Ÿè¿›ç¨‹ï¼ˆåº”ç”¨ï¼‰æ¯”åšä¸€å—ç”µè·¯æ¿ï¼Œæ¥å£æ¯”åšå…ƒå™¨ä»¶ã€‚å¯ä»¥é€‰æ‹©å°†å“ªäº›å…ƒå™¨ä»¶æ”¾å…¥è¯¥ç”µè·¯æ¿ä¸­ï¼Œå“ªäº›å…ƒå™¨ä»¶æ”¾å…¥å…¶ä»–çš„ç”µè·¯æ¿ä¸­ã€‚\nåŒä¸€å—ç”µè·¯æ¿ä¸­çš„å…ƒå™¨ä»¶é—´é€šè¿‡æ¿ä¸Šçš„å¯¼çº¿è¿æ¥ï¼ˆè¿›ç¨‹å†…çš„æœ¬åœ°æ–¹æ³•è°ƒç”¨ï¼‰ï¼›ä¸åŒç”µè·¯æ¿ä¸­çš„å…ƒå™¨ä»¶é—´é€šè¿‡æ’çº¿æ¥è¿æ¥ï¼ˆè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼‰ã€‚\næ€»ç»“å‡ ä¸ªå…³é”®è¯ï¼š\nä¸€ä¸ªç¼–ç¨‹æ¡†æ¶ ç”¨äºç¼–å†™ã€éƒ¨ç½²ã€ç®¡ç†åˆ†å¸ƒå¼åº”ç”¨ æ”¯æŒçš„è¯­è¨€ Go åœ¨æœ¬åœ°ä»¥å•è¿›ç¨‹ã€å¤šè¿›ç¨‹è¿è¡Œ åœ¨äº‘ç«¯ç”±æ¡†æ¶æ‹†åˆ†æˆå¾®æœåŠ¡ï¼Œå¹¶äºäº‘ä¾›åº”å•†é›†æˆ å•ä½“æ–¹å¼å¼€å‘ï¼Œå¾®æœåŠ¡æ–¹å¼éƒ¨ç½² ä½“éªŒäº†ä¸€åœˆä¸‹æ¥ï¼Œç»™æˆ‘çš„æ„Ÿè§‰æœ‰ç‚¹ç±»ä¼¼ Notionã€Obsidian è¿™ç±»ç¬”è®°è½¯ä»¶ã€‚ä¼ ç»Ÿçš„ç¬”è®°è½¯ä»¶åªèƒ½å¼•ç”¨å…¶ä»–çš„ç¬”è®°ï¼Œè€Œè¿™ç±»ç¬”è®°å¯ä»¥ç»†ç²’åº¦åˆ° heading å†…å®¹ã€‚\næ”¾åˆ°å¾®æœåŠ¡ä¸‹å°±æ˜¯ç®¡ç†çš„ç»´åº¦ä¸åœ¨æ˜¯æœåŠ¡æœ¬èº«ï¼Œè€Œä¸”æ›´å°çš„æ¥å£ï¼Œå¹¶ä¸”å¯¹æŸäº›æ¥å£è¿›è¡Œæ‰©å±•ï¼Œå³ä½¿æ‰€æœ‰æ¥å£éƒ½ä½äºåŒä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚\nèƒŒæ™¯ æ¶æ„çš„æ¼”è¿›ï¼Œæ€»æ˜¯åœ¨è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­å¼•å…¥æ–°çš„é—®é¢˜ï¼Œç„¶åå†è§£å†³é—®é¢˜ï¼Œå¾ªç¯å¾€å¤ã€‚\nä»å•ä½“åˆ°å¾®æœåŠ¡ è½¯ä»¶æ¶æ„ä»å•ä½“æ¼”è¿›åˆ°å¾®æœåŠ¡æ¶æ„å·²ç»åå¤šå¹´äº†ï¼Œå°¤å…¶æ˜¯è¿‘å‡ å¹´äº‘åŸç”Ÿé£ç”Ÿæ°´èµ·ï¼Œå¾®æœåŠ¡æ¶æ„å·²æœ‰æ·±å…¥äººå¿ƒçš„æ¶åŠ¿ã€‚\nå•ä½“æ¶æ„ç”±äºåœ¨è§„æ¨¡æ‰©å¤§æ—¶ï¼Œå•ä½“é¢ä¸´æ€§èƒ½ç“¶é¢ˆå’Œç¡¬ä»¶é™åˆ¶ã€æ— æ³•æ”¯æ’‘ä¸šåŠ¡çš„å¿«è¯»è¿­ä»£ã€å¼€å‘æ•ˆç‡ä¸‹é™ååŒéš¾åº¦å¢åŠ ç­‰åŸå› ï¼Œé¢“åŠ¿æ—¥æ¸æ˜æ˜¾ã€‚ç„¶åå°±æœ‰äº†å¾®æœåŠ¡æ¶æ„çš„æå‡ºï¼Œæ¥è§£å†³å•ä½“æ¶æ„çš„å„ç§é—®é¢˜ã€‚\nä¸Šäº‘ ç”±äºäº‘å¹³å°æä¾›æ˜¾è‘—çš„æˆæœ¬æ•ˆç›Šï¼Œå‡å°‘åˆå§‹æŠ•èµ„å¹¶å®ç°æŒ‰éœ€ä»˜è´¹ã€æä¾›æå¤§çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€æä¾›çš„ç¨³å®šæ€§å’Œå¯é æ€§ç¡®ä¿ä¸šåŠ¡è¿ç»­æ€§ã€ä¸“ä¸šçš„å®‰å…¨ä¿éšœå’Œåˆè§„æ€§æ”¯æŒå‡è½»ä¼ä¸šçš„è¿è¥è´Ÿæ‹…ï¼Œä¼ä¸šå°†å…¶ä¸šåŠ¡å’Œæ•°æ®è¿ç§»è‡³äº‘è®¡ç®—å¹³å°ã€‚\né—®é¢˜ æ‹†åˆ†æˆå¾®æœåŠ¡ï¼Œç”±æ­¤å¸¦æ¥äº†ä¸å°‘å¥½å¤„ï¼šæ›´é«˜æ•ˆçš„åº”ç”¨æ‰©å±•ã€æ›´å°çš„é”™è¯¯ä¼ æ’­åŠå¾„ã€ç‹¬ç«‹çš„å®‰å…¨åŸŸä»¥åŠå®Œå–„çš„æ¨¡å—è¾¹ç•Œã€‚\nåè¿‡æ¥ï¼Œå¦‚ä½•æ­£ç¡®åœ°æ‰¾åˆ°è¾¹ç•Œè¿›è¡Œæ‹†åˆ†å¹¶éæ˜“äº‹ã€‚æ‹†åˆ†çš„ä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿtwo pizza teamï¼Ÿä¾æ®èµ„æºä½¿ç”¨ã€ç»„ç»‡æ¶æ„ã€æ•°æ®ç»“æ„ï¼Ÿäº¦æˆ–æ˜¯è€ƒè™‘æœªæ¥çš„å¢é•¿ï¼Ÿ\nå¾®æœåŠ¡çš„æ‹†åˆ†æ‰§è¡Œä¸‹æ¥æ¯«æ— ç« æ³•ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯å¾®æœåŠ¡è¶Šæ¥è¶Šå¤šã€æ›´å¤šçš„æ•…éšœç‚¹ã€æ›´é•¿çš„é“¾è·¯ã€æ›´å¤§çš„å»¶è¿Ÿã€‚è¿™å®é™…ä¸Šå¢åŠ äº†åº”ç”¨çš„å¼€å‘ã€éƒ¨ç½²å’Œç®¡ç†æˆæœ¬ã€‚\nåŸæœ¬å•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‹†åˆ†åæœ‰å¤šä¸ªï¼›åŸæœ¬ä¸€æ¬¡éƒ¨ç½²å®Œæˆï¼Œæ‹†åˆ†åéœ€è¦å¤šä¸ª CI/CD æµæ°´çº¿æ¥éƒ¨ç½²ï¼›åŸæœ¬ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ‹†åˆ†åéœ€è¦ç»´æŠ¤å¤šä¸ªã€‚ å¾®æœåŠ¡å½¼æ­¤ç‹¬ç«‹éƒ¨ç½²ï¼Œæ— æ³•å¿½ç•¥å¤šç‰ˆæœ¬çš„æƒ…å†µã€‚éœ€è¦è°ƒæ•´éƒ¨ç½²ç­–ç•¥æ¥é™ä½é£é™©ï¼ŒåŒæ ·è¿˜æœ‰æœ¬åœ°å¼€å‘å’Œæµ‹è¯•çš„éš¾åº¦å¢åŠ ã€‚ å­¦ä¹ æˆæœ¬é«˜ï¼Œéœ€è¦å­¦ä¹ å¦‚ä½•å°†åº”ç”¨äºŒè¿›åˆ¶æ–‡ä»¶åŒ…è£…æˆå®¹å™¨ï¼Œå¹¶äº†è§£äº‘çš„å„ç§å·¥å…·å’Œéƒ¨ç½²æ–¹å¼ï¼Œå³ä½¿å¯¹ç»éªŒä¸°å¯Œçš„ç¨‹åºå‘˜æ¥è¯´ä¹Ÿéš¾ä»¥ç†è§£ã€‚ åŒæ—¶è¿˜è¦è§£å†³åˆ†å¸ƒå¼å¸¦æ¥çš„å„ç§é—®é¢˜ï¼Œå¦‚æœåŠ¡å‘ç°ã€å®‰å…¨ã€è´Ÿè½½å‡è¡¡ï¼Œä»¥åŠæœåŠ¡é—´çš„è°ƒç”¨ã€‚ å»¶è¿Ÿå¢åŠ ï¼Œæ—¶é—´æ¶ˆè€—åœ¨æ•°æ®çš„åºåˆ—åŒ–ä»¥åŠç½‘ç»œä¼ è¾“ä¸Šã€‚ ä¸ºä»€ä¹ˆç”¨ Service Weaverï¼Ÿ ä»Šå¹´ 3 æœˆ Google å¼€æºäº† Service Weaverï¼Œå¸Œæœ›èƒ½è§£å†³å¾®æœåŠ¡æ¶æ„çš„å„ç§é—®é¢˜ã€‚\næœ‰äº† Servier Weaverï¼Œä½ å¯ä»¥ä¸“æ³¨åœ¨ä¸šåŠ¡é€»è¾‘çš„å¼€å‘ä¸Šï¼Œå…¶ä»–çš„å·¥ä½œäº¤ç»™ Service Weaver æ¥å®Œæˆã€‚\næ— éœ€è¦çº ç»“å¾®æœåŠ¡çš„æ‹†åˆ†è§„åˆ™ï¼Œå¯ä»¥æ‹†åˆ†ä¸ºä»»æ„æ•°é‡çš„ç»„ä»¶ã€‚å¯ä»¥åœ¨éƒ¨ç½²çš„æ—¶å€™è½»æ¾æŒ‡å®šå“ªäº›ç»„ä»¶ä½œä¸ºä¸€ä¸ªå¾®æœåŠ¡æ¥è¿è¡Œï¼Œå“ªäº›åœ¨ä¸åŒçš„å¾®æœåŠ¡ä¸Šè¿è¡Œã€‚\nä½¿ç”¨ Service å¯ä»¥éƒ¨ç½²å’Œç®¡ç†å•ä¸€äºŒè¿›åˆ¶æ–‡ä»¶ã€‚\nService Weaver ä½¿ç”¨è‡ªå®šä¹‰çš„åºåˆ—åŒ–å’Œä¼ è¾“åè®®ï¼Œæˆæœ¬æ•ˆç›Šæ¯”è¡Œä¸šæœ€ä½³çš„è§£å†³æ–¹æ¡ˆï¼ˆgRPC+protobufï¼‰é«˜å‡ºä¸‰å€ã€‚\nå¦‚ä½•ä½¿ç”¨ Service Weaver å¼€å‘åº”ç”¨ï¼Ÿ Service Weaver çš„æ ¸å¿ƒæ˜¯ç»„ä»¶ï¼ˆcomponentï¼‰ï¼Œä¸€ä¸ªç±»ä¼¼ actor çš„è®¡ç®—å•å…ƒã€‚\nç»„ä»¶æ˜¯ä¸ªå¸¸è§çš„ Go æ¥å£ï¼Œç»„ä»¶é—´çš„äº¤äº’é€šè¿‡è°ƒç”¨æ¥å£å®šä¹‰çš„æ–¹æ³•æ¥å®Œæˆã€‚\nä¸‹é¢çš„ç¤ºä¾‹ä¸­å®šä¹‰äº†ä¸€ä¸ª Reverser ç»„ä»¶ï¼Œç”¨äºåè½¬å­—ç¬¦ä¸²ã€‚\n// The interface of the Reverser component. type Reverser interface { Reverse(context.Context, string) (string, error) } // The implementation of the Reverser component. type reverser struct{ weaver.Implements[Reverser] } func (r reverser) Reverse(_ context.Context, s string) (string, error) { runes := []rune(s) n := len(runes) for i := 0; i \u0026lt; n/2; i++ { runes[i], runes[n-i-1] = runes[n-i-1], runes[i] } return string(runes), nil } å…¶ä»–ç»„ä»¶å¯ä»¥è°ƒç”¨ Reverser ç»„ä»¶çš„æ–¹æ³•ï¼š\nreversed, err := reverser.Reverse(ctx, \u0026#34;Hello, World!\u0026#34;) ç»„ä»¶çš„æœ€å¤§ä¼˜ç‚¹æ˜¯ä¸ä¾èµ–äºç³»ç»Ÿè¿›ç¨‹ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå°½ç®¡æ²¡æœ‰ç¼–å†™ä»»ä½•ç½‘ç»œå’Œåºåˆ—åŒ–ç›¸å…³çš„ä»£ç ï¼Œè¿™äº›ç»„ä»¶å¯ä»¥è¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ç”šè‡³æ˜¯ä¸åŒçš„æœºå™¨ä¸Šã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¦‚æœç»„ä»¶ä½äºåŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œæ–¹æ³•çš„è°ƒç”¨å°±æ˜¯ä¼ ç»Ÿçš„ Go æ–¹æ³•è°ƒç”¨ï¼›å¦‚æœä½äºä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œæ–¹æ³•çš„è°ƒç”¨å°±æ˜¯ RPCã€‚\nå°†åº”ç”¨æ‹†åˆ†ä¸ºä¸åŒç»„ä»¶çš„è¿‡ç¨‹ï¼Œæœ‰ç‚¹ç±»ä¼¼å¾®æœåŠ¡çš„æ‹†åˆ†ã€‚ç»„ä»¶ä¹ŸåŒæ ·æœ‰ç€æ¸…æ™°çš„è¾¹ç•Œï¼Œä»¥åŠå¾ˆå¥½çš„æ‰©å±•æ€§ã€‚ä½†åˆæ²¡æœ‰å¾®æœåŠ¡çš„ç¼ºé™·ï¼š\næ‰€æœ‰ç»„ä»¶éƒ½è¿è¡ŒåŒä¸€ä¸ªç‰ˆæœ¬ï¼Œæ— éœ€è€ƒè™‘ç‰ˆæœ¬çš„å…¼å®¹æ€§ã€‚ å¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡ go run å’Œ go test è¿è¡Œå’Œæµ‹è¯•åº”ç”¨ã€‚ å¾®æœåŠ¡çš„æ‹†åˆ†å’Œåˆå¹¶æ˜¯éå¸¸ç—›è‹¦çš„ã€‚ å¦‚ä½•ç®¡ç† Service Weaver åº”ç”¨ï¼Ÿ éƒ¨ç½² åœ¨äº‘ä¸Šè¿è¡Œå°±è·Ÿæœ¬åœ°è¿è¡Œä¸€æ ·ç®€å•ï¼š\n$ go run . # Run locally, in the same OS process. $ weaver multi deploy weaver.toml # Run locally, in multiple OS processes. $ weaver gke deploy weaver.toml # Run in the cloud. é…ç½® Service Weaver éœ€è¦çš„é…ç½®éå¸¸å°‘ã€‚ä¸€ä¸ª åœ¨çº¿å•†åŸ çš„æ¼”ç¤ºä¸­å¯èƒ½éœ€è¦è¶…è¿‡ 1500 è¡Œé…ç½®ï¼Œè€Œ Service Weaver ç¼–å†™çš„åŒæ ·åº”ç”¨æ‰€éœ€çš„é…ç½®ä¸è¶…è¿‡ 10 è¡Œï¼š\n[weaver] binary = \u0026#34;./online_boutique\u0026#34; rollout = \u0026#34;6h\u0026#34; [gke] regions = [\u0026#34;us-west1\u0026#34;, \u0026#34;us-east2\u0026#34;] listeners.boutique = {public_hostname = \u0026#34;online-boutique.net\u0026#34;} åªéœ€æŒ‡å®šäºŒè¿›åˆ¶æ–‡ä»¶ã€éƒ¨ç½²çš„æŒç»­æ—¶é—´ã€éƒ¨ç½²çš„åŒºåŸŸä»¥åŠå…¬å¼€è®¿é—®çš„åœ°å€ã€‚å°±è¿™ä¹ˆç®€å•ã€‚\nå‘å¸ƒæ–°ç‰ˆæœ¬ ä¼ ç»Ÿçš„å¾®æœåŠ¡ï¼Œåœ¨å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶ï¼Œæ—§ç‰ˆæœ¬çš„ç¤ºä¾‹å¯ä»¥ä¼šä¸å…¶ä»–æ–°ç‰ˆæœ¬çš„ç¤ºä¾‹è¿›è¡Œé€šä¿¡ã€‚\nService Weaver ä½¿ç”¨ä¸åŒçš„æ–¹å¼å‡çº§ï¼Œç¡®ä¿å®¢æˆ·ç«¯çš„è¯·æ±‚å®Œå…¨åœ¨ç›¸åŒçš„ç‰ˆæœ¬ä¸‹å¤„ç†ï¼šä¸åŒç‰ˆæœ¬çš„ç»„ä»¶ä¸ä¼šå‘ç”Ÿé€šä¿¡ã€‚\nè¿™å°±é¿å…äº†å¤§å¤šæ•°çš„ç³»ç»Ÿæ•…éšœï¼šç ”ç©¶è¡¨æ˜çš„ï¼šå¤šå¤§ä¸‰åˆ†ä¹‹äºŒçš„æ•…éšœæ˜¯ç”±ç³»ç»Ÿå¤šä¸ªç‰ˆæœ¬ä¹‹é—´çš„äº¤äº’å¼•èµ·çš„ã€‚\næœ‰äº† Service Weaverï¼Œä»…éœ€æ›´æ–°ä»£ç ã€æ„å»ºã€è¿è¡Œå³å¯ï¼Œå…¶ä»–çš„äº¤ç»™ Service Weaverã€‚\nå¯è§‚æµ‹æ€§ Service Weaver æä¾›äº†ç”¨äºæ—¥å¿—ã€æŒ‡æ ‡å’Œé“¾è·¯è·Ÿè¸ªçš„åº“ï¼Œå¹¶è‡ªåŠ¨ä¸åº”ç”¨çš„éƒ¨ç½²ç¯å¢ƒé›†æˆã€‚\nä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•ä¸º Reverser ç»„ä»¶æ·»åŠ è®¡æ•°æŒ‡æ ‡ï¼š\nvar reverseCount = metrics.NewCounter( \u0026#34;reverse_count\u0026#34;, \u0026#34;The number of times Reverser.Reverse has been called\u0026#34;, ) func (reverser) Reverse(_ context.Context, s string) (string, error) { reverseCount.Add(1.0) // ... } æµ‹è¯• ä¼ ç»Ÿçš„å¾®æœåŠ¡ï¼Œåº”ç”¨å¼€å‘å‘¨æœŸéå¸¸æ…¢ã€‚åœ¨è¿­ä»£ä¸­ï¼Œéœ€è¦å®‰è£…ç¬¨é‡çš„äº‘ä¾èµ–ã€å¤æ‚çš„æµ‹è¯•æ¡†æ¶ï¼Œæˆ–è€…éƒ¨ç½²åˆ°äº‘ä¸Šã€‚è¿™äº›éƒ½æå¤§å½±å“äº†å¼€å‘è¿›åº¦ã€‚\næœ‰äº† Service Weaver å¯ä»¥æƒ³è¿è¡Œ Go ç¨‹åºä¸€æ ·å®Œæˆæ„å»ºã€è¿è¡Œã€æµ‹è¯•ã€‚æä¾›çš„ weavertest åŒ…å¯ç”¨æ¥ç¼–å†™ç«¯åˆ°ç«¯æµ‹è¯•ï¼Œå°±åƒå†™å•å…ƒæµ‹è¯•ä¸€æ ·ç®€å•ã€‚\næ¼”ç¤º å®‰è£… Service Weaver å‚è€ƒ å®‰è£…æ–‡æ¡£ï¼Œæ³¨æ„è¦æ±‚ Go çš„ç‰ˆæœ¬ä¸ä½äº 1.21ã€‚åœ¨ macOS ä¸Šç›´æ¥ç”¨ Homebrew å®‰è£…ï¼š\nbrew install service-weaver weaver version weaver v0.21.2 darwin/arm64 go version go version go1.21.3 darwin/arm64 åˆå§‹åŒ–å·¥ç¨‹ mkdir hello-sample cd hello-sample go mod init hello-sample ä½¿ç”¨ä¸Šé¢ Reverser ç»„ä»¶çš„ä¾‹å­ã€‚\nç¼–å†™ Reverser ç»„ä»¶ åˆ›å»º reverser.go æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\npackage main import ( \u0026#34;context\u0026#34; \u0026#34;github.com/ServiceWeaver/weaver\u0026#34; ) // Reverser component. type Reverser interface { Reverse(context.Context, string) (string, error) } // Implementation of the Reverser component. type reverser struct{ weaver.Implements[Reverser] } func (r *reverser) Reverse(_ context.Context, s string) (string, error) { runes := []rune(s) n := len(runes) for i := 0; i \u0026lt; n/2; i++ { runes[i], runes[n-i-1] = runes[n-i-1], runes[i] } return string(runes), nil } Reverser ç»„ä»¶é€šè¿‡å®šä¹‰åˆ›å»ºæ¥å£ Reverser å®šä¹‰ï¼Œè¯¥æ¥å£å®šä¹‰äº†ç”¨äºåè½¬å­—ç¬¦ä¸²çš„æ–¹æ³• Reverseï¼›ç»“æ„ä½“ç±»å‹ reverser é€šè¿‡ weaver.Implements[Reverser] å®šä¹‰ä¸ºç»„ä»¶ Reverser çš„å®ç°ã€‚\næ¥ä¸‹æ¥æ˜¯è°ƒç”¨ç»„ä»¶çš„ä»£ç ã€‚\nç¼–å†™ Main ç»„ä»¶ åˆ›å»º main.go æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼Œä¹Ÿå°±æ˜¯ main ç»„ä»¶ï¼š\npackage main import ( \u0026#34;context\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;github.com/ServiceWeaver/weaver\u0026#34; ) func main() { if err := weaver.Run(context.Background(), serve); err != nil { log.Fatal(err) } } type app struct{ weaver.Implements[weaver.Main] reverser weaver.Ref[Reverser] } func serve(ctx context.Context, app *app) error { // Call the Reverse method. var r Reverser = app.reverser.Get() reversed, err := r.Reverse(ctx, \u0026#34;!dlroW ,olleH\u0026#34;) if err != nil { return err } fmt.Println(reversed) return nil } weaver.Run(...) åˆå§‹åŒ–å¹¶è¿è¡Œ Service Weaver åº”ç”¨ï¼Œæ¯ä¸ªåº”ç”¨éƒ½æœ‰ä¸€ç»„ç»„ä»¶ç»„æˆã€‚è¿è¡Œæ—¶ä¼šè‡ªåŠ¨åˆ›å»º weaver.Main å¹¶å°†å…¶äº¤ç»™åº”ç”¨ã€‚\næŸ¥çœ‹å…¶æºç å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†æ³›å‹ï¼š\nfunc Run[T any, P PointerToMain[T]](ctx context.Context, app func(context.Context, *T) error) error { ... } Run æ‰§è¡Œæ—¶ä¼šå…ˆæ‰¾åˆ° Main ç»„ä»¶çš„å®šä¹‰ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­ç»“æ„ä½“ç±»å‹ app è¢«å®šä¹‰ä¸º weaver.Main ç»„ä»¶ï¼Œç„¶ååˆ›å»ºè¯¥ç»„ä»¶å¹¶å°†å…¶äº¤ç»™ä»£ç ä¸­çš„ serve æ¥ä½¿ç”¨ï¼Œç„¶åè°ƒç”¨ serve å‡½æ•°ã€‚\nåœ¨ Main ç»„ä»¶ app ä¸­æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ° reverser weaver.Ref[Reverser]ã€‚åœ¨ Service Weaver ä¸­ï¼Œå¦‚æœä¸€ä¸ªç»„ä»¶ X è¦è°ƒç”¨ç»„ä»¶ Yï¼Œå°±ä¼šå† X çš„å®šä¹‰ä¸­åŠ å…¥ y weaver.Ref[Y]ï¼Œå› æ­¤è¿™é‡Œ Main ç»„ä»¶å°†ä¼šè°ƒç”¨ Reverser ç»„ä»¶ã€‚\nåœ¨åˆ›å»º Main ç»„ä»¶æ—¶ï¼Œä¼šä»â€œæ³¨å†Œè¡¨â€ä¸­æ‰¾åˆ°ç»„ä»¶ Reverser çš„â€œçœŸæ­£â€å®ç°ï¼Œå¹¶å°†å…¶äº¤ç»™ Main ç»„ä»¶ã€‚\nè¿™é‡Œçš„çœŸæ­£å®ç°ï¼Œå¯èƒ½æ˜¯æœ¬åœ°çš„è°ƒç”¨ï¼Œä¹Ÿå¯èƒ½æ˜¯è¿œç¨‹çš„è°ƒç”¨ã€‚æ€ä¹ˆå®ç°çš„ï¼Ÿè¿˜æœ‰å¾ˆé‡è¦çš„ä¸€æ­¥ï¼šç”Ÿæˆä»£ç ã€‚\nç”Ÿæˆä»£ç  ç„¶åæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆä»£ç  weaver_gen.goï¼š\nweaver generate ç®€å•çœ‹ä¸‹æ–‡ä»¶çš„å†…å®¹ï¼ˆé‡Œé¢ç”¨äº†å¤§é‡çš„åå°„ï¼‰ï¼Œé¦–å…ˆæœ‰ä¸ª init() æ–¹æ³•è¿›è¡Œç»„ä»¶çš„æ³¨å†Œï¼Œæ³¨å†Œä¿¡æ¯åŒ…æ‹¬\nç»„ä»¶å æ¥å£ æ¥å£çš„å®ç° æœ¬åœ°è°ƒç”¨ stub è¿œç¨‹è°ƒç”¨çš„å®¢æˆ·ç«¯ stub ä¾›è¿œç¨‹è°ƒç”¨çš„æœåŠ¡ç«¯ stub é€šè¿‡åå°„è¿›è¡Œæ–¹æ³•è°ƒç”¨çš„ stub å…¶ä¸­å‡ ä¸ª stub ä¹Ÿéƒ½åœ¨ weaver_gen.go æ–‡ä»¶ä¸­ï¼Œç”±ä¸Šé¢çš„å‘½ä»¤è‡ªåŠ¨ç”Ÿæˆã€‚\nå› æ­¤ï¼Œå‡å¦‚ä¸æ‰§è¡Œ weaver generate å‘½ä»¤å°±æ²¡æœ‰ weaver_gen.go æ–‡ä»¶ï¼Œåœ¨è¿è¡Œæ—¶ä¹Ÿå°±æ‰¾ä¸åˆ°ä»»ä½•ç»„ä»¶çš„æ³¨å†Œä¿¡æ¯çš„ã€‚\nè¿è¡Œ ç°åœ¨å¯ä»¥è¿è¡Œåº”ç”¨ï¼š\ngo run . â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â”‚ app : hello-sample â”‚ â”‚ deployment : 09caf84b-822c-44d3-a149-a5b2e733a136 â”‚ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ Hello, World! å¯¹æœåŠ¡æ¥è¯´ç”¨è¿™ç§æ–¹å¼æ¥è§¦å‘è°ƒç”¨è‚¯å®šä¸åˆç†ï¼Œè€Œæ˜¯åº”è¯¥è®©å…¶æ¥æ”¶ HTTP çš„æµé‡ã€‚\nè¿›é˜¶ - å•è¿›ç¨‹éƒ¨ç½²éƒ¨ç½² æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ä¸‹é¢çš„ä»£ç æ›¿æ¢ main.goï¼š\npackage main import ( \u0026#34;context\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;github.com/ServiceWeaver/weaver\u0026#34; ) func main() { if err := weaver.Run(context.Background(), serve); err != nil { log.Fatal(err) } } type app struct { weaver.Implements[weaver.Main] reverser weaver.Ref[Reverser] hello weaver.Listener } func serve(ctx context.Context, app *app) error { // The hello listener will listen on a random port chosen by the operating // system. This behavior can be changed in the config file. fmt.Printf(\u0026#34;hello listener available on %v\\n\u0026#34;, app.hello) // Serve the /hello endpoint. http.HandleFunc(\u0026#34;/hello\u0026#34;, func(w http.ResponseWriter, r *http.Request) { name := r.URL.Query().Get(\u0026#34;name\u0026#34;) if name == \u0026#34;\u0026#34; { name = \u0026#34;World\u0026#34; } reversed, err := app.reverser.Get().Reverse(ctx, name) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } fmt.Fprintf(w, \u0026#34;Hello, %s!\\n\u0026#34;, reversed) }) return http.Serve(app.hello, nil) } åœ¨å®šä¹‰ Main ç»„ä»¶æ—¶åŠ å…¥äº† hello weaver.Listenerï¼ŒService Weaver ä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¸€ä¸ª HTTP ç›‘å¬å™¨ï¼Œå¹¶æ¥æ”¶ç½‘ç»œæµé‡ã€‚\nåœ¨ serve ä¸­å®šä¹‰äº† HTTP è·¯å¾„ /helloï¼šåœ¨æ¥æ”¶åˆ°æµé‡åä»è¯·æ±‚ä¸­è¯»å–å‚æ•° name çš„å€¼ï¼Œç„¶åè°ƒç”¨ Reverser ç»„ä»¶ï¼›åŒæ—¶ serve è¿”å›çš„ http.Server è¿è¡Œåœ¨ Main ç»„ä»¶çš„ HTTP ç›‘å¬å™¨ä¸Šã€‚\nç”Ÿæˆä»£ç  ç”±äºä¿®æ”¹äº† Main ç»„ä»¶çš„å®šä¹‰ï¼Œéœ€è¦æ‰§è¡Œ weaver generate é‡æ–°ç”Ÿæˆä»£ç ã€‚åœ¨æ›´æ–°åçš„ weaver_gen.go ä¸­å¯ä»¥çœ‹åˆ° Main ç»„ä»¶çš„æ³¨å†Œä¿¡æ¯å¤šäº†ä¸€ä¸ª Listenersï¼Œå€¼æ˜¯ä¸ªå­—ç¬¦ä¸²æ•°ç»„ []string{\u0026quot;hello\u0026quot;}ï¼Œå¯¹åº”ç€ä»£ç ä¸­ç›‘å¬å™¨çš„åå­— helloã€‚\né…ç½®æ–‡ä»¶ æ­¤æ—¶å¦‚æœè¿è¡Œåº”ç”¨ï¼Œä¼šéšæœºç»™åº”ç”¨åˆ†é…ä¸€ä¸ªç«¯å£ã€‚å¦‚æœè¦è‡ªå®šä¹‰ç«¯å£çš„è¯ï¼Œå°±éœ€è¦å¢åŠ é…ç½®æ–‡ä»¶äº†ã€‚\nåˆ›å»ºä¸€ä¸ªåä¸º weaver.toml çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n[single] listeners.hello = {address = \u0026#34;localhost:12345\u0026#34;} åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ç›‘å¬å™¨ hello çš„ç›‘å¬åœ°å€ã€‚\nè¿è¡Œ åœ¨è¿è¡Œæ—¶éœ€è¦å°†é…ç½®æ–‡ä»¶çš„è·¯å¾„æä¾›ç»™åº”ç”¨ã€‚\nSERVICEWEAVER_CONFIG=weaver.toml go run . â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â”‚ app : hello-sample â”‚ â”‚ deployment : 68e82ba2-a5ba-49c0-8b56-4edb775dba4b â”‚ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ hello listener available on 127.0.0.1:12345 å‘é€è¯·æ±‚ï¼Œå¯ä»¥æ”¶åˆ°åè½¬åçš„å­—ç¬¦ä¸²ã€‚\ncurl \u0026#34;localhost:12345/hello?name=world\u0026#34; Hello, dlrow! [!INFO] å¯ä»¥é€šè¿‡ /debug/weaver/healthz ç«¯ç‚¹æŸ¥çœ‹åº”ç”¨çš„å¥åº·çŠ¶æ€ã€‚ curl -i \u0026ldquo;localhost:12345/debug/weaver/healthz\u0026rdquo; HTTP/1.1 200 OK Date: Wed, 11 Oct 2023 00:20:01 GMT Content-Length: 2 Content-Type: text/plain; charset=utf-8 OK\nè¿›é˜¶ - å¤šè¿›ç¨‹ é…ç½®æ–‡ä»¶ æ¥ä¸‹æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œç”¨ä¸‹é¢çš„å†…å®¹æ›¿æ¢ï¼š\n[serviceweaver] binary = \u0026#34;./hello-sample\u0026#34; [multi] listeners.hello = {address = \u0026#34;localhost:12345\u0026#34;} åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ¬¡æˆ‘ä»¬åŠ å…¥äº†äºŒè¿›åˆ¶æ–‡ä»¶åœ°å€ï¼Œä»¥åŠå¤šè¿›ç¨‹éƒ¨ç½²çš„åœ°å€ã€‚\nè¿è¡Œ å› ä¸ºæ˜¯å¤šè¿›ç¨‹è¿è¡Œæ— æ³•ä½¿ç”¨ go run å‘½ä»¤äº†ï¼Œæ­¤æ—¶è¦ç”¨åˆ° weaver multi å‘½ä»¤äº†ï¼ˆé€šè¿‡ weaver multi -h æŸ¥çœ‹ä½¿ç”¨æ–¹å¼ï¼‰ï¼š\nweaver multi deploy weaver.toml â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â”‚ app : hello-sample â”‚ â”‚ deployment : 9956d5c9-e88b-4d0f-a808-d4f7f475ed36 â”‚ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ S1011 08:36:28.419836 stdout 5df75365 â”‚ hello listener available on 127.0.0.1:12345 S1011 08:36:28.419922 stdout 74d79043 â”‚ hello listener available on 127.0.0.1:12345 weaver multi ä¸ºæ¯ä¸ªç»„ä»¶å„åˆ›å»ºäº†ä¸¤ä¸ªå‰¯æœ¬ï¼Œå› æ­¤å¯ä»¥çœ‹åˆ°æ‰“å°äº†ä¸¤è¡Œæ—¥å¿—ã€‚å¦‚æœå†æ¬¡å‘é€è¯·æ±‚ï¼Œä¹Ÿä¼šå¾—åˆ°åŒæ ·çš„åº”ç­”ã€‚\nè¿™æ¬¡æˆ‘ä»¬é€šè¿‡ Weaver Dashboard æ¥æŸ¥çœ‹åº”ç”¨æƒ…å†µï¼Œé€šè¿‡ä¸‹é¢çš„å‘½ä»¤å¯ç”¨ dashboardï¼ˆä¸ºå…¶éšæœºåˆ†é…ç›‘å¬æ¥å£ï¼‰ï¼š\nweaver multi dashboard Dashboard available at: http://127.0.0.1:56108 åœ¨æµè§ˆå™¨ä¸­å¯ä»¥æ‰“å¼€å…¶ dashboardã€‚\nç‚¹å‡»é“¾æ¥åå¯ä»¥è·å–å…¶è¯¦ç»†ä¿¡æ¯ï¼Œå…¶ä¸­å°±å¯ä»¥çœ‹åˆ°æ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸¤ä¸ªè¿›ç¨‹ï¼š\nDashboard å±•ç¤ºçš„ä¿¡æ¯ç›¸æ¯”å‘½ä»¤è¡Œçš„å†…å®¹ä¼šæ›´åŠ è¯¦ç»†ï¼š\nweaver multi status â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â”‚ DEPLOYMENTS â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ APP â”‚ DEPLOYMENT â”‚ AGE â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ hello-sample â”‚ 9956d5c9-e88b-4d0f-a808-d4f7f475ed36 â”‚ 1h46m17s â”‚ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â”‚ COMPONENTS â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ APP â”‚ DEPLOYMENT â”‚ COMPONENT â”‚ REPLICA PIDS â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ hello-sample â”‚ 9956d5c9 â”‚ weaver.Main â”‚ 28079, 28082 â”‚ â”‚ hello-sample â”‚ 9956d5c9 â”‚ hello-sample.Reverser â”‚ 28083, 28084 â”‚ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â”‚ LISTENERS â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ APP â”‚ DEPLOYMENT â”‚ LISTENER â”‚ ADDRESS â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ hello-sample â”‚ 9956d5c9 â”‚ hello â”‚ 127.0.0.1:12345 â”‚ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ è¿›é˜¶ - äº‘ç«¯éƒ¨ç½² [!IMPORTANT] æ³¨æ„ï¼ æ¥ä¸‹æ¥çš„æ“ä½œæ˜¯åœ¨ X86 çš„å¹³å°ä¸Šå®Œæˆçš„ã€‚\nå®‰è£… weaver-kube ä½¿ç”¨ weaver-kube å¯ä»¥å°†åº”ç”¨éƒ¨ç½²åˆ°æ™®é€šçš„ Kubernetes ä¸Šã€‚\ngo install github.com/ServiceWeaver/weaver-kube/cmd/weaver-kube@latest weaver-kube version weaver kube v0.21.2 darwin/arm64 é…ç½®æ–‡ä»¶ ä½¿ç”¨ä¸‹é¢çš„å†…å®¹æ›¿æ¢ weaver.toml æ–‡ä»¶ï¼š\n[serviceweaver] binary = \u0026#34;./hello-sample\u0026#34; [kube] repo = \u0026#34;docker.io/addozhang\u0026#34; listeners.hello = {public = true} è¿™æ¬¡ä½¿ç”¨ kube é…ç½®ï¼Œå¯¹åº” weaver kube deploy æ“ä½œã€‚å…¶ä¸­ repo æ˜¯æ‰§è¡Œæ“ä½œæ—¶æ„å»ºé•œåƒæ‰€æ¨é€çš„ä»“åº“åœ°å€ï¼Œè®¾ç½®ç›‘å¬å™¨ä¸º {public = true} å°†ä¼šä¸ºå…¶åˆ›å»º Kubernetes LoadBalancer Serviceã€‚\nweaver kube deploy weaver.toml ... Generating kube deployment info ... Generated roles and bindings Replica sets generated successfully [hello-sample/Reverser github.com/ServiceWeaver/weaver/Main] Generated kube deployment for replica set github.com/ServiceWeaver/weaver/Main Generated kube autoscaler for replica set github.com/ServiceWeaver/weaver/Main Generated kube listener service for listener hello Generated kube deployment for replica set hello-sample/Reverser Generated kube autoscaler for replica set hello-sample/Reverser Generated Jaeger deployment Generated Jaeger service Generated kube deployment for config map hello-sample-prometheus-config-4beb9a0b Generated kube deployment for Prometheus hello-sample-prometheus-21ee5ea1 Generated kube service for Prometheus hello-sample-prometheus-21ee5ea1 Generated kube deployment for config map hello-sample-loki-config-e2c46e76 Generated kube deployment for config map hello-sample-promtail-b648e7f2 Generated kube deployment for Loki hello-sample-loki-e8d90de6 Generated kube service for Loki hello-sample-loki-e8d90de6 Generated kube daemonset for Promtail hello-sample-promtail-b648e7f2 Generated kube deployment for config map hello-sample-grafana-config-a873d265 Generated Grafana deployment Generated Grafana service kube deployment information successfully generated /tmp/kube_1cfbd355-10a4-47b6-aaec-efd9bbd17a06.yaml é•œåƒæ¨é€åˆ°ä»“åº“åï¼Œè¿˜ä¼šç”Ÿæˆéƒ¨ç½²æ‰€éœ€çš„ manifest æ–‡ä»¶ï¼Œæ‰§è¡Œå‘½ä»¤è¿›è¡Œéƒ¨ç½²ï¼š\nkubectl apply -f /tmp/kube_1cfbd355-10a4-47b6-aaec-efd9bbd17a06.yaml é›†ç¾¤æˆ‘ç”¨çš„æ˜¯ k3s åˆ›å»ºçš„ï¼š\nexport INSTALL_K3S_VERSION=v1.27.1+k3s1 curl -sfL https://get.k3s.io | sh -s - \u0026ndash;disable traefik \u0026ndash;disable local-storage \u0026ndash;disable metrics-server \u0026ndash;write-kubeconfig-mode 644 \u0026ndash;write-kubeconfig ~/.kube/config\næµ‹è¯• æŸ¥çœ‹ Pod å’Œ LoadBalancer çš„ç«¯å£ï¼Œå¯ä»¥çœ‹åˆ°ä¸ºä¸¤ä¸ªç»„ä»¶å„åˆ›å»ºäº†ä¸€ä¸ª Podã€‚\nkubectl get po,svc -l appName=hello-sample NAME READY STATUS RESTARTS AGE pod/hello-sample-github-com-serviceweaver-weaver-main-a0713fddsfgb2 1/1 Running 0 6h16m pod/hello-sample-hello-sample-reverser-ad954898-01bf315f-86df6pvchc 1/1 Running 0 6h16m kubectl get svc -l lisName=hello î‚² default âˆ NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE hello-sample-lis-hello-4701ccf4 LoadBalancer 10.43.195.210 10.0.2.4 80:31340/TCP 6h17m åœ¨å®¿ä¸»æœºä¸Šæ‰§è¡Œå‘½ä»¤ï¼Œæ‰§è¡ŒæˆåŠŸã€‚\ncurl \u0026#34;localhost/hello?name=world\u0026#34; Hello, dlrow! æ€»ç»“ Service Weaver çš„æ€è·¯å¾ˆå¥½ï¼Œé’ˆå¯¹ç›®å‰å¾®æœåŠ¡æ¶æ„çš„é—®é¢˜åšäº†ä¼˜åŒ–å’Œæå‡ï¼Œå†åŠ ä¸Šæœ‰ Google çš„èƒŒä¹¦ï¼Œå¸Œæœ›ç»§ç»­æ¼”è¿›ä¸‹å»ã€‚å°¤å…¶å½“å‰åªæ”¯æŒ Go è¯­è¨€ï¼Œè™½è¯´ Go åœ¨äº‘åŸç”Ÿä¸­é£ç”Ÿæ°´èµ·ï¼Œå½“æ—¶ä¸šåŠ¡å¼€å‘å¤§éƒ¨åˆ†ä»æ˜¯ Java æŠ€æœ¯æ ˆã€‚åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼ŒGo çš„å—ä¼—è¿˜æ˜¯ç›¸å½“å°ã€‚\nå½“å‰çš„ç‰ˆæœ¬æ˜¯ v0.21.2ï¼Œä»å¤„äºå¾ˆæ—©æœŸçš„é˜¶æ®µï¼Œè¯·è°¨æ…å¯¹å¾…ï¼ˆæºç é‡Œæœäº†ä¸‹ TODO å…³é”®è¯æœ‰ 100 å¤šå¤„ï¼‰ã€‚\næ²¡æœ‰å®Œç¾çš„æ¶æ„ï¼Œæ²¡æœ‰é“¶å¼¹ï¼\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/10/11/left_vs_right.jpg","permalink":"https://atbug.com/service-weaver-framework-for-writing-distributed-applications/","tags":["ServiceWeaver","æ¶æ„","å¾®æœåŠ¡"],"title":"å•ä½“ or å¾®æœåŠ¡ï¼ŸService Weaverï¼šæˆ‘å…¨éƒ½è¦ï¼"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬æ–‡ç¿»è¯‘è‡ªç”± David Vroom, James Mulcahy, Ling Yuan, Rob Gulewich ç¼–å†™çš„ Netflix åšå®¢ Zero Configuration Service Mesh with On-Demand Cluster Discoveryã€‚\nNetflix ç›¸ä¿¡å¤§å®¶å¹¶ä¸é™Œç”Ÿï¼Œåœ¨ Spring Cloud ç”Ÿæ€ä¸­å°±æœ‰ Netflix å…¨å®¶æ¡¶ã€‚å¤šå¹´å‰ï¼Œæˆ‘ä¹Ÿæ›¾å°†åŸºäº Netflix OSS æ„å»ºçš„å¾®æœåŠ¡æ¶æ„æ¬ä¸Šäº† Kubernetes å¹³å°ï¼Œå¹¶æŒç»­æŠ˜è…¾å¥½å‡ å¹´ã€‚\nSpring Cloud Netflix æœ‰ç€åºå¤§çš„ç”¨æˆ·ç¾¤ä»¥åŠç”¨æˆ·åœºæ™¯ï¼Œå…¶æä¾›äº†å¾®æœåŠ¡æ²»ç†çš„ä¸€æ•´å¥—è§£å†³æ–¹æ¡ˆï¼šæœåŠ¡å‘ç° Eurekaã€å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ Ribbonã€æ–­è·¯å™¨ Hystrixã€å¾®æœåŠ¡ç½‘æ ¼ Zuulã€‚\næœ‰è¿‡ç›¸åŒç»å†çš„å°ä¼™ä¼´åº”è¯¥éƒ½ä¼šåŒæ„Ÿï¼Œè¿™æ ·ä¸€å¥—å¾®æœåŠ¡è§£å†³æ–¹æ¡ˆçš„æ¶æ„ï¼Œç»è¿‡å¤šå¹´çš„æ¼”è¿›ä¹Ÿä¼šè®©äººç—›è‹¦ä¸å ªï¼šå¤æ‚åº¦è¶Šæ¥è¶Šé«˜ã€ç‰ˆæœ¬ç¢ç‰‡åŒ–ä¸¥é‡ã€å¤šè¯­è¨€å¤šæ¡†æ¶çš„æ”¯æŒå’ŒåŠŸèƒ½æ— æ³•ç»Ÿä¸€ç­‰ç­‰ã€‚è¿™ä¹Ÿæ˜¯ Netflix è‡ªå·±ä¹Ÿä¸å¾—ä¸é¢å¯¹çš„é—®é¢˜ï¼Œéšåä»–ä»¬å°†ç›®å…‰è½¬å‘äº†æœåŠ¡ç½‘æ ¼ï¼Œå¹¶å¯»æ±‚ä¸€ä¸ªæ— ç¼è¿ç§»çš„æ–¹æ¡ˆã€‚\nè¿™ç¯‡æ–‡ç« ä¸­ï¼Œä»–ä»¬ç»™å‡ºäº†ç­”æ¡ˆï¼šNetflix ä¸ç¤¾åŒºåˆä½œï¼Œå¹¶è‡ªå»ºæ§åˆ¶å¹³é¢ä¸å·²æœ‰çš„æœåŠ¡å‘ç°ä½“ç³»å…¼å®¹ã€‚è¿™å¥—å®ç°ä¸‹æ¥å¯èƒ½å¹¶ä¸å®¹æ˜“ï¼Œä¹Ÿæœªçœ‹åˆ°ä»–ä»¬è¦å°†å…¶å¼€æºçš„æƒ³æ³•ï¼Œä½†æ˜¯è‡³å°‘å¯ä»¥ç»™å¤§å®¶ä¸€ä¸ªå‚è€ƒã€‚\né¡ºä¾¿é¢„å‘Šä¸€ä¸‹è‡ªå·±æ­£åœ¨è®¡åˆ’çš„ä¸€ç¯‡ï¼Œå¦‚ä½•å°†å¾®æœåŠ¡å¹³æ»‘è¿ç§»åˆ° Flomesh æœåŠ¡ç½‘æ ¼å¹³å°ã€‚ä¸æ­¢æ— ç¼å…¼å®¹ Eurekaï¼Œè¿˜æœ‰ HashiCorp Consulï¼Œæœªæ¥è¿˜ä¼šå…¼å®¹æ›´å¤šçš„æœåŠ¡å‘ç°æ–¹æ¡ˆã€‚\nä»¥ä¸‹æ˜¯åŸæ–‡çš„ç¿»è¯‘ï¼š\nåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®º Netflix æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰å®è·µçš„ç›¸å…³ä¿¡æ¯ï¼šå†å²èƒŒæ™¯ã€åŠ¨æœºï¼Œä»¥åŠæˆ‘ä»¬å¦‚ä½•ä¸ Kinvolk å’Œ Envoy ç¤¾åŒºåˆä½œï¼Œåœ¨å¤æ‚çš„å¾®æœåŠ¡ç¯å¢ƒä¸­æ¨åŠ¨æœåŠ¡ç½‘æ ¼è½åœ°çš„ä¸€ä¸ªç‰¹å¾ï¼šæŒ‰éœ€é›†ç¾¤å‘ç°ï¼ˆOn-demand Cluster Discoveryï¼‰ã€‚\nNetflix çš„ IPC ç®€å² Netflix æ˜¯æ—©æœŸäº‘è®¡ç®—çš„é‡‡çº³è€…ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¤§è§„æ¨¡çš„å…¬å¸ï¼šæˆ‘ä»¬åœ¨ 2008 å¹´å¼€å§‹äº†è¿ç§»ï¼Œå¹¶ä¸”åˆ° 2010 å¹´ï¼ŒNetflixçš„æµåª’ä½“å®Œå…¨è¿è¡Œåœ¨AWSä¸Šã€‚ä»Šå¤©æˆ‘ä»¬æ‹¥æœ‰ä¸°å¯Œçš„å·¥å…·ï¼ŒåŒ…æ‹¬å¼€æºå’Œå•†ä¸šçš„ï¼Œæ‰€æœ‰è¿™äº›éƒ½æ˜¯ä¸ºäº‘åŸç”Ÿç¯å¢ƒè®¾è®¡çš„ã€‚ç„¶è€Œï¼Œåœ¨ 2010 å¹´ï¼Œå‡ ä¹æ²¡æœ‰è¿™æ ·çš„å·¥å…·å­˜åœ¨ï¼šCNCF ç›´åˆ° 2015 å¹´æ‰æˆç«‹ï¼ç”±äºæ²¡æœ‰ç°æˆçš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±æ„å»ºå®ƒä»¬ã€‚\nå¯¹äºæœåŠ¡é—´çš„è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸­é—´å±‚è´Ÿè½½å‡è¡¡å™¨é€šå¸¸æä¾›çš„ä¸°å¯ŒåŠŸèƒ½é›†ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæ¥åº”å¯¹äº‘ç¯å¢ƒçš„ç°å®ï¼šä¸€ä¸ªé«˜åº¦åŠ¨æ€çš„ç¯å¢ƒï¼Œå…¶ä¸­èŠ‚ç‚¹ä¸æ–­ä¸Šçº¿å’Œä¸‹çº¿ï¼ŒæœåŠ¡éœ€è¦å¿«é€Ÿå“åº”å˜åŒ–å¹¶éš”ç¦»å¤±è´¥ã€‚ä¸ºäº†æé«˜å¯ç”¨æ€§ï¼Œæˆ‘ä»¬è®¾è®¡äº†å¯ä»¥å•ç‹¬å‘ç”Ÿæ•…éšœçš„ç³»ç»Ÿç»„ä»¶ï¼Œä»¥é¿å…å•ç‚¹æ•…éšœã€‚è¿™äº›è®¾è®¡åŸåˆ™å¼•å¯¼æˆ‘ä»¬èµ°å‘äº†å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œè€Œ 2012å¹´åœ£è¯èŠ‚çš„å®•æœº è¿›ä¸€æ­¥åšå®šäº†è¿™ä¸ªå†³ç­–ã€‚åœ¨äº‘æ—©æœŸï¼Œæˆ‘ä»¬æ„å»ºäº†Eureka ç”¨äºæœåŠ¡å‘ç°ï¼Œä»¥åŠ Ribbonï¼ˆå†…éƒ¨åä¸ºNIWSï¼‰ç”¨äºIPCã€‚Eureka è§£å†³äº†æœåŠ¡å¦‚ä½•å‘ç°ä¸å…¶é€šä¿¡çš„å®ä¾‹çš„é—®é¢˜ï¼Œè€Œ Ribbon æä¾›äº†è´Ÿè½½å‡è¡¡çš„å®¢æˆ·ç«¯ï¼Œä»¥åŠè®¸å¤šå…¶ä»–çš„å¼¹æ€§ç‰¹æ€§ã€‚è¿™ä¸¤é¡¹æŠ€æœ¯ï¼ŒåŠ ä¸Šä¸€ç³»åˆ—å…¶ä»–çš„å¼¹æ€§å’Œæ··æ²Œå·¥å…·ï¼Œäº§ç”Ÿäº†å·¨å¤§çš„æ”¶ç›Šï¼šæˆ‘ä»¬çš„å¯é æ€§å› æ­¤å¾—åˆ°äº†æ˜¾è‘—çš„æ”¹å–„ã€‚\nEureka å’Œ Ribbon æä¾›äº†ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„æ¥å£ï¼Œè®©å®ƒä»¬çš„ä½¿ç”¨å˜å¾—å®¹æ˜“ã€‚ä¸€ä¸ªæœåŠ¡ä¸å¦ä¸€ä¸ªæœåŠ¡é€šä¿¡ï¼Œéœ€è¦çŸ¥é“ä¸¤ä»¶äº‹ï¼šç›®çš„æœåŠ¡çš„åç§°ï¼Œä»¥åŠæµé‡æ˜¯å¦åº”è¯¥æ˜¯å®‰å…¨çš„ã€‚Eureka ä¸ºæ­¤æä¾›çš„æŠ½è±¡æ˜¯è™šæ‹Ÿ IPï¼ˆVIPsï¼‰ç”¨äºéå®‰å…¨é€šä¿¡ï¼Œå’Œå®‰å…¨ VIPsï¼ˆSVIPsï¼‰ç”¨äºå®‰å…¨é€šä¿¡ã€‚æœåŠ¡å‘ Eureka å®£å¸ƒä¸€ä¸ª VIP åå’Œç«¯å£ï¼ˆä¾‹å¦‚ï¼šmyserviceï¼Œç«¯å£ 8080ï¼‰ï¼Œæˆ–ä¸€ä¸ª SVIP åå’Œç«¯å£ï¼ˆä¾‹å¦‚ï¼šmyservice-secureï¼Œç«¯å£ 8443ï¼‰ï¼Œæˆ–åŒæ—¶ä½¿ç”¨ä¸¤è€…ã€‚IPC å®¢æˆ·ç«¯é’ˆå¯¹è¯¥ VIP æˆ– SVIP è¿›è¡Œå®ä¾‹åŒ–ï¼Œè€Œ Eureka å®¢æˆ·ç«¯ä»£ç é€šè¿‡ä» Eureka æœåŠ¡å™¨è·å–å®ƒä»¬æ¥å¤„ç†è¯¥ VIP åˆ°ä¸€ç»„ IP å’Œç«¯å£å¯¹çš„è½¬æ¢ã€‚å®¢æˆ·ç«¯è¿˜å¯ä»¥é€‰æ‹©å¯ç”¨åƒé‡è¯•æˆ–ç†”æ–­è¿™æ ·çš„ IPC åŠŸèƒ½ï¼Œæˆ–è€…ä½¿ç”¨ä¸€ç»„åˆç†çš„é»˜è®¤å€¼ã€‚\nåœ¨è¿™ç§æ¶æ„ä¸­ï¼ŒæœåŠ¡é—´é€šä¿¡ä¸å†é€šè¿‡è´Ÿè½½å‡è¡¡å™¨çš„å•ç‚¹æ•…éšœé€šé“ã€‚ä½†é—®é¢˜æ˜¯ï¼ŒEureka ç°åœ¨æˆä¸ºäº† VIP æ³¨å†Œä¸»æœºçœŸå®æ€§çš„æ–°çš„å•ä¸€æ•…éšœç‚¹ã€‚ç„¶è€Œï¼Œå¦‚æœ Eureka å®•æœºï¼ŒæœåŠ¡ä»ç„¶å¯ä»¥äº’ç›¸é€šä¿¡ï¼Œå°½ç®¡å®ƒä»¬çš„ä¸»æœºä¿¡æ¯éšç€ VIP çš„ä¸Šä¸‹çº¿è€Œé€æ¸è¿‡æ—¶ã€‚åœ¨æ•…éšœæœŸé—´ä»¥é™çº§ä½†å¯ç”¨çš„çŠ¶æ€è¿è¡Œä»ç„¶æ˜¯ç›¸æ¯”å®Œå…¨åœæ­¢æµé‡çš„æ˜æ˜¾æ”¹è¿›ã€‚\nåœ¨è¿™ç§æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¸æœåŠ¡é—´çš„é€šä¿¡ä¸å†ç»è¿‡è´Ÿè½½å‡è¡¡å™¨çš„å•ä¸€æ•…éšœç‚¹ã€‚ä½†é—®é¢˜æ˜¯ï¼ŒEureka ç°åœ¨æˆä¸ºäº† VIP æ³¨å†Œä¸»æœºçœŸå®æ€§çš„æ–°çš„å•ä¸€æ•…éšœç‚¹ã€‚ç„¶è€Œï¼Œå¦‚æœ Eureka å®•æœºï¼ŒæœåŠ¡ä»ç„¶å¯ä»¥äº’ç›¸é€šä¿¡ï¼Œå°½ç®¡å®ƒä»¬çš„ä¸»æœºä¿¡æ¯éšç€ VIP çš„ä¸Šä¸‹çº¿è€Œé€æ¸è¿‡æ—¶ã€‚åœ¨æ•…éšœæœŸé—´ä»¥é™çº§ä½†å¯ç”¨çš„çŠ¶æ€è¿è¡Œä»ç„¶æ˜¯ç›¸æ¯”å®Œå…¨åœæ­¢æµé‡çš„æ˜æ˜¾æ”¹è¿›ã€‚\nä¸ºä»€ä¹ˆé€‰æ‹©ç½‘æ ¼ï¼Ÿ ä¸Šè¿°æ¶æ„åœ¨è¿‡å»çš„åå¹´é‡Œä¸ºæˆ‘ä»¬æœåŠ¡å¾—å¾ˆå¥½ï¼Œä½†éšç€ä¸šåŠ¡éœ€æ±‚çš„å˜åŒ–å’Œè¡Œä¸šæ ‡å‡†çš„æ¼”å˜ï¼Œæˆ‘ä»¬çš„ IPC ç”Ÿæ€ç³»ç»Ÿåœ¨å¾ˆå¤šæ–¹é¢éƒ½å¢åŠ äº†æ›´å¤šçš„å¤æ‚æ€§ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¢åŠ äº†ä¸åŒçš„ IPC å®¢æˆ·ç«¯çš„æ•°é‡ã€‚æˆ‘ä»¬çš„å†…éƒ¨ IPC æµé‡ç°åœ¨æ˜¯çº¯ RESTã€GraphQL å’Œ gRPC çš„æ··åˆã€‚å…¶æ¬¡ï¼Œæˆ‘ä»¬ä»åªä½¿ç”¨ Java ç¯å¢ƒè¿ç§»åˆ°äº†å¤šè¯­è¨€ç¯å¢ƒï¼šæˆ‘ä»¬ç°åœ¨ä¹Ÿæ”¯æŒ node.jsã€Python ä»¥åŠå„ç§å¼€æºå’Œç°æˆçš„è½¯ä»¶ã€‚ç¬¬ä¸‰ï¼Œæˆ‘ä»¬ç»§ç»­ä¸º IPC å®¢æˆ·ç«¯å¢åŠ æ›´å¤šåŠŸèƒ½ï¼Œå¦‚ è‡ªé€‚åº”å¹¶å‘é™åˆ¶ã€æ–­è·¯å™¨ã€å¯¹å†²å’Œæ•…éšœæ³¨å…¥å·²æˆä¸ºæˆ‘ä»¬å·¥ç¨‹å¸ˆä¸ºä½¿ç³»ç»Ÿæ›´å¯é è€Œé‡‡ç”¨çš„æ ‡å‡†å·¥å…·ã€‚ä¸åå¹´å‰ç›¸æ¯”ï¼Œæˆ‘ä»¬ç°åœ¨æ”¯æŒæ›´å¤šåŠŸèƒ½ã€æ›´å¤šè¯­è¨€ã€æ›´å¤šå®¢æˆ·ç«¯ã€‚ç¡®ä¿æ‰€æœ‰è¿™äº›å®ç°ä¹‹é—´çš„åŠŸèƒ½ä¸€è‡´æ€§å¹¶ç¡®ä¿å®ƒä»¬éƒ½ä»¥ç›¸åŒçš„æ–¹å¼è¿è¡Œæ˜¯å…·æœ‰æŒ‘æˆ˜æ€§çš„ï¼šæˆ‘ä»¬å¸Œæœ›è¿™äº›åŠŸèƒ½æœ‰ä¸€ä¸ªå•ä¸€ã€ç»è¿‡å……åˆ†æµ‹è¯•çš„å®ç°ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹è¿›è¡Œæ›´æ”¹å’Œä¿®å¤é”™è¯¯ã€‚\nè¿™å°±æ˜¯æœåŠ¡ç½‘æ ¼çš„ä»·å€¼æ‰€åœ¨ï¼šæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªå®ç°ä¸­é›†ä¸­ IPC åŠŸèƒ½ï¼Œå¹¶ä½¿æ¯ç§è¯­è¨€çš„å®¢æˆ·ç«¯å°½å¯èƒ½ç®€å•ï¼šå®ƒä»¬åªéœ€è¦çŸ¥é“å¦‚ä½•ä¸æœ¬åœ°ä»£ç†é€šè¯ã€‚Envoy å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ä»£ç†çš„ç»ä½³é€‰æ‹©ï¼šå®ƒæ˜¯ä¸€ä¸ªç»è¿‡æˆ˜æ–—è€ƒéªŒçš„å¼€æºäº§å“ï¼Œå·²ç»åœ¨è¡Œä¸šä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œæ‹¥æœ‰ è®¸å¤šå…³é”®çš„å¼¹æ€§åŠŸèƒ½ï¼Œä»¥åŠå½“æˆ‘ä»¬éœ€è¦æ‰©å±•å…¶åŠŸèƒ½æ—¶çš„ è‰¯å¥½çš„æ‰©å±•ç‚¹ã€‚èƒ½å¤Ÿ é€šè¿‡ä¸€ä¸ªé›†ä¸­çš„æ§åˆ¶å¹³é¢é…ç½®ä»£ç† æ˜¯ä¸€ä¸ªæ€æ‰‹çº§çš„åŠŸèƒ½ï¼šè¿™ä½¿æˆ‘ä»¬å¯ä»¥åŠ¨æ€é…ç½®å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œå°±åƒå®ƒæ˜¯ä¸€ä¸ªé›†ä¸­çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œä½†ä»ç„¶é¿å…äº†æœåŠ¡åˆ°æœåŠ¡è¯·æ±‚è·¯å¾„ä¸­çš„è´Ÿè½½å‡è¡¡å™¨ä½œä¸ºå•ä¸€çš„æ•…éšœç‚¹ã€‚\nè½¬å‘æœåŠ¡ç½‘æ ¼ ä¸€æ—¦è®¤å®šæˆ‘ä»¬å†³å®šè½¬å‘æœåŠ¡ç½‘æ ¼æ˜¯æ­£ç¡®çš„é€‰æ‹©ï¼Œä¸‹ä¸€ä¸ªé—®é¢˜ä¾¿æ˜¯ï¼šæˆ‘ä»¬åº”å¦‚ä½•è¿›è¡Œè¿ç§»ï¼Ÿæˆ‘ä»¬ç¡®å®šäº†ä¸€äº›è¿ç§»çš„é™åˆ¶æ¡ä»¶ã€‚é¦–å…ˆï¼šæˆ‘ä»¬å¸Œæœ›ä¿ç•™ç°æœ‰çš„æ¥å£ã€‚é€šè¿‡æŒ‡å®š VIP åç§°åŠ ä¸Šå®‰å…¨æœåŠ¡çš„æŠ½è±¡ä¸ºæˆ‘ä»¬æä¾›äº†è‰¯å¥½æœåŠ¡ï¼Œæˆ‘ä»¬ä¸æƒ³ç ´åå‘åå…¼å®¹æ€§ã€‚å…¶æ¬¡ï¼šæˆ‘ä»¬å¸Œæœ›è‡ªåŠ¨åŒ–è¿ç§»ï¼Œå¹¶ä½¿å…¶å°½å¯èƒ½æ— ç¼ã€‚è¿™ä¸¤ä¸ªé™åˆ¶æ„å‘³ç€æˆ‘ä»¬éœ€è¦æ”¯æŒ Envoy ä¸­çš„ Discovery æŠ½è±¡ï¼Œä»¥ä¾¿ IPC å®¢æˆ·ç«¯å¯ä»¥ç»§ç»­åœ¨åº•å±‚ä½¿ç”¨å®ƒã€‚å¹¸è¿çš„æ˜¯ï¼ŒEnvoy å·²ç»æœ‰äº† ç°æˆçš„æŠ½è±¡ å¯ä»¥ç”¨ã€‚VIP å¯ä»¥è¡¨ç¤ºä¸º Envoy é›†ç¾¤ï¼Œä»£ç†å¯ä»¥ä»æˆ‘ä»¬çš„æ§åˆ¶å¹³é¢ä½¿ç”¨é›†ç¾¤å‘ç°æœåŠ¡ (CDS) è·å–å®ƒä»¬ã€‚è¿™äº›é›†ç¾¤ä¸­çš„ä¸»æœºè¡¨ç¤ºä¸º Envoy ç«¯ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨ç«¯ç‚¹å‘ç°æœåŠ¡ (EDS) è·å–ã€‚\næˆ‘ä»¬å¾ˆå¿«é‡åˆ°äº†ä¸€ä¸ªæ— ç¼è¿ç§»çš„éšœç¢ï¼šEnvoy è¦æ±‚åœ¨ä»£ç†çš„é…ç½®ä¸­æŒ‡å®šé›†ç¾¤ã€‚å¦‚æœæœåŠ¡ A éœ€è¦ä¸é›†ç¾¤ B å’Œ C é€šä¿¡ï¼Œé‚£ä¹ˆéœ€è¦åœ¨ A çš„ä»£ç†é…ç½®ä¸­å®šä¹‰é›†ç¾¤ B å’Œ Cã€‚è¿™åœ¨è§„æ¨¡ä¸Šå¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ï¼šä»»ä½•ç»™å®šçš„æœåŠ¡å¯èƒ½ä¼šä¸æ•°åä¸ªé›†ç¾¤é€šä¿¡ï¼Œè€Œæ¯ä¸ªåº”ç”¨ç¨‹åºçš„é›†ç¾¤é›†åˆéƒ½æ˜¯ä¸åŒçš„ã€‚æ­¤å¤–ï¼ŒNetflix å§‹ç»ˆåœ¨å˜åŒ–ï¼šæˆ‘ä»¬ä¸æ–­æ¨å‡ºæ–°çš„é¡¹ç›®ï¼Œå¦‚ç›´æ’­ã€å¹¿å‘Š å’Œæ¸¸æˆï¼Œå¹¶ä¸”ä¸æ–­å‘å±•æˆ‘ä»¬çš„æ¶æ„ã€‚è¿™æ„å‘³ç€æœåŠ¡é€šä¿¡çš„é›†ç¾¤ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œæ”¹å˜ã€‚é‰´äºæˆ‘ä»¬å¯ç”¨çš„ Envoy åŸè¯­ï¼Œæˆ‘ä»¬è¯„ä¼°äº†ä¸€äº›å¡«å……é›†ç¾¤é…ç½®çš„ä¸åŒæ–¹æ³•ï¼š\nè®©æœåŠ¡æ‰€æœ‰è€…å®šä¹‰ä»–ä»¬çš„æœåŠ¡éœ€è¦ä¸ä¹‹é€šä¿¡çš„é›†ç¾¤ã€‚è¿™ä¸ªé€‰é¡¹çœ‹ä¼¼ç®€å•ï¼Œä½†å®é™…ä¸Šï¼ŒæœåŠ¡æ‰€æœ‰è€…å¹¶ä¸æ€»æ˜¯çŸ¥é“ï¼Œæˆ–æƒ³è¦çŸ¥é“ï¼Œä»–ä»¬ä¸å“ªäº›æœåŠ¡é€šä¿¡ã€‚æœåŠ¡é€šå¸¸ä¼šå¯¼å…¥ç”±å…¶ä»–å›¢é˜Ÿæä¾›çš„åº“ï¼Œè¿™äº›åº“åœ¨åº•å±‚ä¸å¤šä¸ªå…¶ä»–æœåŠ¡é€šä¿¡ï¼Œæˆ–ä¸åƒé¥æµ‹å’Œæ—¥å¿—è®°å½•ç­‰å…¶ä»–æ“ä½œæœåŠ¡é€šä¿¡ã€‚è¿™æ„å‘³ç€æœåŠ¡æ‰€æœ‰è€…éœ€è¦çŸ¥é“è¿™äº›è¾…åŠ©æœåŠ¡å’Œåº“æ˜¯å¦‚ä½•åœ¨åº•å±‚å®ç°çš„ï¼Œå¹¶åœ¨å®ƒä»¬å‘ç”Ÿå˜åŒ–æ—¶è°ƒæ•´é…ç½®ã€‚ æ ¹æ®æœåŠ¡çš„è°ƒç”¨å›¾è‡ªåŠ¨ç”Ÿæˆ Envoy é…ç½®ã€‚è¿™ç§æ–¹æ³•å¯¹äºé¢„å…ˆå­˜åœ¨çš„æœåŠ¡æ¥è¯´å¾ˆç®€å•ï¼Œä½†æ˜¯åœ¨å¯åŠ¨æ–°æœåŠ¡æˆ–æ·»åŠ æ–°çš„ä¸Šæ¸¸é›†ç¾¤ä»¥è¿›è¡Œé€šä¿¡æ—¶å…·æœ‰æŒ‘æˆ˜æ€§ã€‚ å°†æ‰€æœ‰é›†ç¾¤æ¨é€åˆ°æ¯ä¸ªåº”ç”¨ç¨‹åºï¼šè¿™ä¸ªé€‰é¡¹ä»¥å…¶ç®€å•æ€§å¸å¼•äº†æˆ‘ä»¬ï¼Œä½†æ˜¯çº¸å·¾ä¸Šçš„ç®€å•è®¡ç®—å¾ˆå¿«å‘æˆ‘ä»¬æ˜¾ç¤ºï¼Œå°†æ•°ç™¾ä¸‡ä¸ªç«¯ç‚¹æ¨é€åˆ°æ¯ä¸ªä»£ç†æ˜¯ä¸å¯è¡Œçš„ã€‚ è€ƒè™‘åˆ°æˆ‘ä»¬æ— ç¼é‡‡çº³çš„ç›®æ ‡ï¼Œæ¯ä¸ªé€‰é¡¹éƒ½æœ‰è¶³å¤Ÿé‡å¤§çš„ç¼ºç‚¹ï¼Œä½¿æˆ‘ä»¬æ¢ç´¢äº†å¦ä¸€ä¸ªé€‰é¡¹ï¼šå¦‚æœæˆ‘ä»¬èƒ½åœ¨è¿è¡Œæ—¶æŒ‰éœ€è·å–é›†ç¾¤ä¿¡æ¯ï¼Œè€Œä¸æ˜¯é¢„å…ˆå®šä¹‰å®ƒï¼Œä¼šæ€æ ·ï¼Ÿå½“æ—¶ï¼ŒæœåŠ¡ç½‘æ ¼å·¥ä½œä»åœ¨å¯åŠ¨é˜¶æ®µï¼Œåªæœ‰å°‘æ•°å‡ ä¸ªå·¥ç¨‹å¸ˆåœ¨è‡´åŠ›äºå®ƒã€‚æˆ‘ä»¬è”ç³»äº† Kinvolkï¼Œçœ‹çœ‹ä»–ä»¬æ˜¯å¦èƒ½ä¸æˆ‘ä»¬å’Œ Envoy ç¤¾åŒºåˆä½œå®æ–½è¿™ä¸ªåŠŸèƒ½ã€‚è¿™æ¬¡åˆä½œçš„ç»“æœæ˜¯ æŒ‰éœ€é›†ç¾¤å‘ç°(On-Demand Cluster Discoveryï¼ŒODCDS)ã€‚æœ‰äº†è¿™ä¸ªåŠŸèƒ½ï¼Œä»£ç†ç°åœ¨å¯ä»¥åœ¨ç¬¬ä¸€æ¬¡å°è¯•è¿æ¥å®ƒæ—¶æŸ¥æ‰¾é›†ç¾¤ä¿¡æ¯ï¼Œè€Œä¸æ˜¯åœ¨é…ç½®ä¸­é¢„å…ˆå®šä¹‰æ‰€æœ‰é›†ç¾¤ã€‚\næœ‰äº†è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦ç»™ä»£ç†æä¾›é›†ç¾¤ä¿¡æ¯ä»¥ä¾›æŸ¥è¯¢ã€‚æˆ‘ä»¬å·²ç»å¼€å‘äº†ä¸€ä¸ªå®ç° Envoy XDS æœåŠ¡çš„æœåŠ¡ç½‘æ ¼æ§åˆ¶å¹³é¢ã€‚ç„¶åæˆ‘ä»¬éœ€è¦ä» Eureka è·å–æœåŠ¡ä¿¡æ¯ä»¥è¿”å›ç»™ä»£ç†ã€‚æˆ‘ä»¬å°† Eureka çš„ VIP å’Œ SVIP è¡¨ç¤ºä¸ºå•ç‹¬çš„ Envoy Cluster Discovery Service (CDS) é›†ç¾¤ï¼ˆå› æ­¤ï¼ŒæœåŠ¡ myservice å¯èƒ½æœ‰é›†ç¾¤ myservice.vip å’Œ myservice.svipï¼‰ã€‚é›†ç¾¤ä¸­çš„å•ä¸ªä¸»æœºè¢«è¡¨ç¤ºä¸ºå•ç‹¬çš„ Endpoint Discovery Service (EDS) ç«¯ç‚¹ã€‚è¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿé‡å¤ä½¿ç”¨ç›¸åŒçš„ Eureka æŠ½è±¡ï¼Œå¹¶ä¸”åƒ Ribbon è¿™æ ·çš„ IPC å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æœ€å°çš„æ›´æ”¹è½¬ç§»åˆ°ç½‘æ ¼ã€‚æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢çš„æ›´æ”¹åˆ°ä½åï¼Œæµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š\nå®¢æˆ·ç«¯è¯·æ±‚è¿›å…¥ Envoyã€‚ æ ¹æ® Host / :authority å¤´ï¼ˆæ­¤å¤„ä½¿ç”¨çš„å¤´å¯é…ç½®ï¼Œä½†è¿™æ˜¯æˆ‘ä»¬çš„æ–¹æ³•ï¼‰æå–ç›®æ ‡é›†ç¾¤ã€‚å¦‚æœå·²çŸ¥è¯¥é›†ç¾¤ï¼Œè·³åˆ°æ­¥éª¤ 7ã€‚ é›†ç¾¤ä¸å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æš‚åœäº†æ­£åœ¨ä¼ è¾“çš„è¯·æ±‚ã€‚ å‘æ§åˆ¶å¹³é¢çš„ Cluster Discovery Service (CDS) ç«¯ç‚¹å‘å‡ºè¯·æ±‚ã€‚æ§åˆ¶å¹³é¢æ ¹æ®æœåŠ¡çš„é…ç½®å’Œ Eureka æ³¨å†Œä¿¡æ¯ç”Ÿæˆå®šåˆ¶çš„ CDS å“åº”ã€‚ Envoy è·å–é›†ç¾¤ï¼ˆCDSï¼‰ï¼Œè§¦å‘é€šè¿‡ Endpoint Discovery Service (EDS) æ‹‰å–ç«¯ç‚¹ã€‚æ ¹æ®è¯¥ VIP æˆ– SVIP çš„ Eureka çŠ¶æ€ä¿¡æ¯è¿”å›é›†ç¾¤çš„ç«¯ç‚¹ã€‚ å®¢æˆ·ç«¯è¯·æ±‚è§£é™¤æš‚åœã€‚ Envoy æ­£å¸¸å¤„ç†è¯·æ±‚ï¼šå®ƒä½¿ç”¨è´Ÿè½½å¹³è¡¡ç®—æ³•é€‰æ‹©ä¸€ä¸ªç«¯ç‚¹å¹¶å‘å‡ºè¯·æ±‚ã€‚ è¿™ä¸ªæµç¨‹åœ¨å‡ æ¯«ç§’å†…å®Œæˆï¼Œä½†åªåœ¨å¯¹é›†ç¾¤çš„ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶ã€‚ä¹‹åï¼ŒEnvoy çš„è¡Œä¸ºå°±å¥½åƒé›†ç¾¤æ˜¯åœ¨é…ç½®ä¸­å®šä¹‰çš„ä¸€æ ·ã€‚å…³é”®æ˜¯ï¼Œè¯¥ç³»ç»Ÿå…è®¸æˆ‘ä»¬æ— éœ€ä»»ä½•é…ç½®å³å¯æ— ç¼è¿ç§»æœåŠ¡è‡³æœåŠ¡ç½‘æ ¼ï¼Œæ»¡è¶³æˆ‘ä»¬çš„ä¸»è¦é‡‡çº³é™åˆ¶ä¹‹ä¸€ã€‚æˆ‘ä»¬å‘ˆç°çš„æŠ½è±¡ç»§ç»­æ˜¯ VIP åç§°åŠ ä¸Šå®‰å…¨ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®å•ä¸ª IPC å®¢æˆ·ç«¯è¿æ¥åˆ°æœ¬åœ°ä»£ç†è€Œä¸æ˜¯ç›´æ¥è¿æ¥åˆ°ä¸Šæ¸¸åº”ç”¨ç¨‹åºæ¥è¿ç§»åˆ°ç½‘æ ¼ã€‚æˆ‘ä»¬ç»§ç»­ä½¿ç”¨ Eureka ä½œä¸º VIP å’Œå®ä¾‹çŠ¶æ€çš„çœŸå®æ¥æºï¼Œè¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿåœ¨è¿ç§»æ—¶æ”¯æŒä¸€äº›åº”ç”¨ç¨‹åºåœ¨ç½‘æ ¼ä¸Šï¼Œè€Œå¦ä¸€äº›ä¸åœ¨ç½‘æ ¼ä¸Šçš„å¼‚æ„ç¯å¢ƒã€‚è¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„å¥½å¤„ï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»…ä¸ºæˆ‘ä»¬å®é™…é€šä¿¡çš„é›†ç¾¤è·å–æ•°æ®æ¥ä¿æŒ Envoy çš„å†…å­˜ä½¿ç”¨ç‡è¾ƒä½ã€‚\nä¸Šå›¾å±•ç¤ºäº†ä¸€ä¸ª Java åº”ç”¨ä¸­çš„ IPC å®¢æˆ·ç«¯é€šè¿‡ Envoy ä¸æ³¨å†Œä¸º SVIP A çš„ä¸»æœºé€šä¿¡ã€‚ Envoy ä»ç½‘æ ¼æ§åˆ¶å¹³é¢è·å– SVIP A çš„é›†ç¾¤å’Œç«¯ç‚¹ä¿¡æ¯ã€‚ç½‘æ ¼æ§åˆ¶å¹³é¢ä» Eureka è·å–ä¸»æœºä¿¡æ¯ã€‚\næŒ‰éœ€è·å–æ­¤æ•°æ®çš„ç¼ºç‚¹æ˜¯ï¼šè¿™ä¼šå¢åŠ å¯¹é›†ç¾¤çš„ç¬¬ä¸€æ¬¡è¯·æ±‚çš„å»¶è¿Ÿã€‚æˆ‘ä»¬é‡åˆ°äº†æœåŠ¡åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶éœ€è¦éå¸¸ä½å»¶è¿Ÿè®¿é—®çš„ç”¨ä¾‹ï¼Œå¹¶ä¸”å¢åŠ äº†å‡ æ¯«ç§’é¢å¤–çš„å¼€é”€ã€‚å¯¹äºè¿™äº›ç”¨ä¾‹ï¼ŒæœåŠ¡éœ€è¦é¢„å®šä¹‰å®ƒä»¬é€šä¿¡çš„é›†ç¾¤ï¼Œæˆ–åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚ä¹‹å‰å‡†å¤‡å¥½è¿æ¥ã€‚æˆ‘ä»¬è¿˜è€ƒè™‘è¿‡æ ¹æ®å†å²è¯·æ±‚æ¨¡å¼åœ¨ä»£ç†å¯åŠ¨æ—¶ä»æ§åˆ¶å¹³é¢é¢„æ¨é€é›†ç¾¤ã€‚æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬è§‰å¾—ç³»ç»Ÿä¸­çš„é™ä½çš„å¤æ‚æ€§è¯æ˜äº†å¯¹å°‘é‡æœåŠ¡çš„ç¼ºç‚¹æ˜¯åˆç†çš„ã€‚\næˆ‘ä»¬åœ¨æœåŠ¡ç½‘æ ¼ä¹‹æ—…çš„åˆæœŸã€‚ç°åœ¨æˆ‘ä»¬çœŸè¯šåœ°ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬å¸Œæœ›ä¸ç¤¾åŒºåˆä½œåšå‡ºæ›´å¤šçš„ Envoy æ”¹è¿›ã€‚å°†æˆ‘ä»¬çš„ è‡ªé€‚åº”å¹¶å‘é™åˆ¶ å®ç°ç§»æ¤åˆ° Envoy æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¼€å§‹ - æˆ‘ä»¬æœŸå¾…ç€ä¸ç¤¾åŒºåœ¨æ›´å¤šæ–¹é¢åˆä½œã€‚æˆ‘ä»¬ç‰¹åˆ«å¯¹ç¤¾åŒºåœ¨å¢é‡ EDS æ–¹é¢çš„å·¥ä½œæ„Ÿå…´è¶£ã€‚EDS ç«¯ç‚¹å äº†æ›´æ–°é‡çš„æœ€å¤§éƒ¨åˆ†ï¼Œè¿™å¯¹æ§åˆ¶å¹³é¢å’Œ Envoy é€ æˆäº†ä¸å¿…è¦çš„å‹åŠ›ã€‚\næˆ‘ä»¬è¦éå¸¸æ„Ÿè°¢ Kinvolk çš„äººå‘˜å¯¹ Envoy çš„è´¡çŒ®ï¼šAlban Crequy, Andrew Randall, Danielle Tal, ç‰¹åˆ«æ˜¯ Krzesimir Nowak çš„å‡ºè‰²å·¥ä½œã€‚æˆ‘ä»¬ä¹Ÿè¦æ„Ÿè°¢ Envoy ç¤¾åŒºçš„æ”¯æŒå’Œé”‹åˆ©çš„å®¡æŸ¥ï¼šAdi Peleg, Dmitri Dolguikh, Harvey Tuch, Matt Klein, å’Œ Mark Rothã€‚ä¸ä½ ä»¬æ‰€æœ‰äººåˆä½œæ˜¯ä¸€æ¬¡å¾ˆå¥½çš„ç»å†ã€‚\nè¿™æ˜¯æˆ‘ä»¬é€šå‘æœåŠ¡ç½‘æ ¼ä¹‹æ—…çš„ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€ç¯‡ï¼Œæ•¬è¯·æœŸå¾…ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/09/25/pexels-krivec-ales-547115%201.jpg","permalink":"https://atbug.com/translation-zero-configuration-service-mesh-with-on-demand-cluster-discovery/","tags":["Service Mesh","äº‘åŸç”Ÿ"],"title":"Netflix é›¶é…ç½®æœåŠ¡ç½‘æ ¼ä¸æŒ‰éœ€é›†ç¾¤å‘ç°"},{"categories":["äº‘åŸç”Ÿ"],"contents":"å‰å‡ å¤© Gateway API å®£å¸ƒåœ¨ 0.8.0 ä¸­æ”¯æŒæœåŠ¡ç½‘æ ¼ï¼Œè¿™æ„å‘³ç€ GAMMAï¼ˆGatewayÂ API forÂ MeshÂ Management andÂ Administrationï¼‰æœ‰äº†æ–°è¿›å±•ï¼Œè™½ç„¶ç›®å‰è¿˜æ˜¯å®éªŒé˜¶æ®µã€‚å»å¹´ 6 æœˆ Gateway API å‘å¸ƒ 0.5.0 æ—¶ï¼Œæˆ‘è¿˜å†™äº†ä¸€ç¯‡ SMI ä¸ Gateway API çš„ GAMMA å€¡è®®æ„å‘³ç€ä»€ä¹ˆï¼Ÿã€‚å¦‚ä»Šï¼ŒSMI ä½œä¸º sandbox é¡¹ç›®çš„å¹´åº¦å®¡æŸ¥å·²ç» è¿‡äº†å‡ ä¸ªæœˆä»æœªæäº¤ï¼Œå”å˜˜ã€‚\nåºŸè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ 0.8.0 ä¸‹çš„ Gateway API å¦‚ä½•åœ¨ Service Mesh ä¸­å·¥ä½œã€‚\nTL;DR Gateway API å¯¹æœåŠ¡ç½‘æ ¼çš„æ”¯æŒä»ç„¶æ˜¯å®éªŒé˜¶æ®µï¼Œä½†æ˜¯å·²ç»æœ‰å‚å•†è·Ÿè¿›ï¼ˆå½“ç„¶ä¹Ÿéƒ½æ˜¯å®éªŒé˜¶æ®µï¼‰ã€‚\nç›¸æ¯” Gateway API å¤„ç†å—åŒ—å‘æµé‡å°†è·¯ç”±ç»‘å®šåˆ° Gateway èµ„æº ç›¸æ¯”ï¼Œåœ¨ç½‘æ ¼ä¸­è·¯ç”±åˆ™æ˜¯ä¸ Service è¿›è¡Œç»‘å®šã€‚ç®€å•ç†è§£æˆ Service ä»£ç†äº† Gateway çš„è§’è‰²ï¼Œä¸è¿‡è¯¥ Service æ˜¯ç›®æ ‡ Serviceã€‚\nGateway API ä¸­çš„æœåŠ¡ç½‘æ ¼ è¦è¯´æœåŠ¡ç½‘æ ¼ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æœåŠ¡ Serviceã€‚\næŠ½è±¡ Service Service ä¸­ Kubernetes ä¸­æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„èµ„æºï¼Œè¿™é‡Œè¯´çš„æŠ½è±¡æ˜¯ä»é€»è¾‘ä¸Šè¿›è¡ŒæŠ½è±¡ï¼ŒæŠ½è±¡æˆå‰ç«¯å’Œåç«¯ä¸¤éƒ¨åˆ†ã€‚\nå‰ç«¯ï¼ˆFrontendï¼‰é€šå¸¸å°±æ˜¯ Service çš„ DNS åå­—æˆ–è€… ClusterIPï¼›åç«¯ï¼ˆBackendï¼‰åˆ™æ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨é€‰æ‹©çš„ Endpoint æˆ–è€… EndpointSliceã€‚\nè·¯ç”±ä¸æœåŠ¡ æŠŠè·¯ç”±ç›´æ¥ç»‘å®šåˆ° Service ä¸Šï¼Œè¢«è®¤ä¸ºæ˜¯å½“ä¸‹æœ€ä¼˜çš„é€‰æ‹©ã€‚Service ä¸å…¶ä»–èµ„æºçš„è€¦åˆåº¦å¤ªé«˜ï¼Œæ¯”å¦‚ IP åˆ†é…ã€DNSã€ç«¯ç‚¹é›†åˆã€è´Ÿè½½å‡è¡¡ç­‰ç­‰ï¼Œä½†åœ¨ç›®å‰çš„ç½‘æ ¼è®¾è®¡ä¸­ä¹Ÿæ˜¯å”¯ä¸€çš„æœ€ä¼˜é€‰æ‹©ï¼Œæœªæ¥ä¼šå¯»æ±‚æ›´å¥½çš„é€‰æ‹©ï¼Œæ¯”å¦‚ ServiceBindingï¼ˆè§åæ–‡ï¼‰\nè¿™æ ·åšçš„å¥½å¤„å‘¢ï¼Œå°±æ˜¯å°†æœåŠ¡çš„å‰åç«¯åˆ†åˆ«ä¸ç°åœ¨çš„ xRoute API ä¸­çš„ parentRef å’Œ backendRef å…³è”ï¼Œæ— éœ€å¼•å…¥é¢å¤–çš„ APIã€‚\nä¸åŒçš„æ—¶å€™ï¼Œåœ¨ xRoute API ä¸­çš„ backendRef ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª Serviceï¼Œä½†æ˜¯æœ€ç»ˆåœ¨è·¯ç”±è¯·æ±‚æ—¶ï¼Œç›®æ ‡è¿˜æ˜¯ Endpoint æˆ–è€… EndpointSliceï¼Œåªä¸è¿‡ä»–ä»¬ä¸ parentRef ä¸­çš„ Service ä¸æ˜¯å¼ºå…³è”çš„ã€‚\nkind: HTTPRoute metadata: name: smiley-route namespace: faces spec: parentRefs: - name: smiley kind: Service group: core port: 80 rules: ... å¦‚æœä¸€ä¸ª Service ä¸Šé…ç½®äº†å¤šä¸ªè·¯ç”±ï¼ŒåŒ¹é…åˆ°å¤šæ¡è·¯ç”±çš„è¯·æ±‚å°†è¢«æ‹’ç»ã€‚\nè¯·æ±‚æµç¨‹ å®¢æˆ·ç«¯å‘é€è¯·æ±‚ ç½‘æ ¼æ•°æ®é¢ä»£ç†æ‹¦æˆªè¯·æ±‚ é€šè¿‡è™šæ‹Ÿ IP åœ°å€ã€DNS ä¸»æœºåã€æˆ–è€…åå­—æ¥ç¡®è®¤æµé‡æ˜¯å±äºå“ªä¸ª Serviceï¼ˆä¸ä¼šä½¿ç”¨ xRoute ä¸Šçš„ hostname å­—æ®µï¼‰ å¦‚æœ Service æ²¡æœ‰é…ç½®è·¯ç”±ï¼Œå°†ä½¿ç”¨è¯·æ±‚çš„åŸå§‹ç›®çš„åœ°è¿›è¡Œè½¬å‘ æ‰¾åˆ°åŒ¹é…çš„ä¼˜å…ˆçº§æœ€é«˜ï¼ˆæ¶ˆè´¹è€…è·¯ç”±é«˜äºç”Ÿäº§è€…è·¯ç”±ï¼Œè§ä¸‹æ–‡ï¼‰çš„è·¯ç”±è¿›è¡Œè½¬å‘ å¦‚æœé…ç½®äº†è·¯ç”±ï¼Œä½†éƒ½æ— æ³•åŒ¹é…ï¼Œåˆ™æ‹’ç»è¯·æ±‚ è·¯ç”±çš„å‘½åç©ºé—´ ä¸ºä»€ä¹ˆè¦æå‘½åç©ºé—´ï¼Œæ˜¯å› ä¸ºè·¯ç”±ä¸æœåŠ¡åœ¨ç›¸åŒæˆ–è€…ä¸åŒå‘½åç©ºé—´ä¸‹æ‰€ä»£è¡¨çš„å«ä¹‰ä¸åŒã€‚\nåŒå‘½åç©ºé—´ è·¯ç”± smiley-route ä¸ Service smiley ä½äºåŒä¸€ä¸ªå‘½åç©ºé—´ facesï¼Œè¯¥è·¯ç”±ä¸Šè®¾ç½®äº†è¯·æ±‚è¶…æ—¶æ—¶é—´ 100msã€‚è¿™æ„å‘³ç€ï¼Œæ‰€æœ‰è®¿é—® Service smiley ï¼ˆæ¥è‡ªä»»ä¸€å‘½åç©ºé—´ä¸‹çš„ä»»ä¸€å·¥ä½œè´Ÿè½½ï¼‰å¹¶åŒ¹é… smiley-route è·¯ç”±è§„åˆ™çš„è¯·æ±‚ï¼Œéƒ½å—è¯¥è¶…æ—¶é…ç½®çš„å½±å“ã€‚\nè¿™ç§è·¯ç”±è¢«ç§°ä¸º ç”Ÿäº§è€…è·¯ç”±ï¼ˆProducer Routeï¼‰ï¼Œå½±å“ç›®æ ‡ä¸ºè¯¥æœåŠ¡çš„æ‰€æœ‰è¯·æ±‚ã€‚\nkind: HTTPRoute metadata: name: smiley-route namespace: faces spec: parentRefs: - name: smiley namespace: faces kind: Service group: core port: 80 rules: ... timeouts: request: 100ms ä¸åŒå‘½åç©ºé—´ è·¯ç”± smiley-route ä¸ Service smiley ä½äºä¸åŒçš„å‘½åç©ºé—´ï¼Œä¸ä¸Šé¢ä¸åŒçš„æ˜¯ï¼Œæ‰€æœ‰è®¿é—® Service smiley ï¼ˆæ¥è‡ªå‘½åç©ºé—´ fast-clients ä¸‹çš„ä»»ä¸€å·¥ä½œè´Ÿè½½ï¼‰å¹¶åŒ¹é… smiley-route è·¯ç”±è§„åˆ™çš„è¯·æ±‚ï¼Œéƒ½å—è¯¥è¶…æ—¶é…ç½®çš„å½±å“ã€‚\nè¿™ç§è·¯ç”±è¢«ç§°ä¸º æ¶ˆè´¹è€…è·¯ç”±ï¼ˆConsumer Routeï¼‰ï¼Œå½±å“åŒå‘½åç©ºé—´ä¸‹è®¿é—®æœ¨é›•æœåŠ¡çš„æ‰€æœ‰è¯·æ±‚ã€‚\nkind: HTTPRoute metadata: name: smiley-route namespace: fast-clients spec: parentRefs: - name: smiley namespace: faces kind: Service group: core port: 80 rules: ... timeouts: request: 100ms åŒä¸€ Service ä¸Šçš„å¤šä¸ªè·¯ç”± è¿™é‡Œçš„å‰ææ¡ä»¶æ˜¯è¿™äº›è·¯ç”±éƒ½ä½äºåŒä¸€å‘½åç©ºé—´ä¸‹ï¼Œå³åŒä¸ºç”Ÿäº§è€…è·¯ç”±ï¼Œæˆ–åŒä¸ºæ¶ˆè´¹è€…è·¯ç”±ã€‚è¿™ç§æƒ…å†µå°†ä¼šéµå¾ª è·¯ç”±åˆå¹¶è§„åˆ™ å¤šè¿™ä¸ªè·¯ç”±è¿›è¡Œåˆå¹¶ï¼Œå¦‚æœè¦ä¸ºåŒä¸€å‘½åç©ºé—´ä¸‹çš„å¤šä¸ªå·¥ä½œè´Ÿè½½é…ç½®ä¸åŒçš„æ¶ˆè´¹è€…è·¯ç”±ï¼Œç›®å‰è¿˜æ— æ³•å®ç°ã€‚å”¯ä¸€çš„\næ¯”å¦‚ä¸‹é¢å®šä¹‰äº†ä¸¤ä¸ªæ¶ˆè´¹è€…è·¯ç”± smiley-route-50 å’Œ smiley-route-100\nkind: HTTPRoute metadata: name: smiley-route-50 namespace: fast-clients spec: parentRefs: - name: smiley namespace: faces kind: Service group: core port: 80 rules: ... timeouts: request: 50ms --- kind: HTTPRoute metadata: name: smiley-route-100 namespace: fast-clients spec: parentRefs: - name: smiley namespace: faces kind: Service group: core port: 80 rules: ... timeouts: request: 100ms è·¯ç”±ä¸ç­–ç•¥ ä¹‹å‰ä¹Ÿå†™æ–‡ä»‹ç»è¿‡ Gateway API ä¸­çš„ç­–ç•¥ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹ ä¸€æ–‡ææ‡‚ Kubernetes Gateway API çš„ Policy Attachmentã€‚\nåœ¨ç½‘æ ¼ä¸­ç­–ç•¥é™„åŠ å¯ä»¥éå¸¸ç®€å•ã€‚ç­–ç•¥å¯ä»¥åº”ç”¨äºä»»ä½•å‘½åç©ºé—´ä¸­çš„ä»»ä½•èµ„æºï¼Œä½†å¦‚æœç›®æ ‡ä½äºä¸åŒçš„å‘½åç©ºé—´ä¸­ï¼Œåˆ™å®ƒåªèƒ½åº”ç”¨äºæ¥è‡ªåŒä¸€å‘½åç©ºé—´çš„è¯·æ±‚ï¼ˆè·Ÿéšæ¶ˆè´¹è€…è·¯ç”±çš„é€»è¾‘ï¼‰ã€‚\nç½‘æ ¼ä¸€è‡´æ€§æµ‹è¯• é¦–å…ˆæ¥çœ‹ä¸‹ä½•ä¸º ä¸€è‡´æ€§é…ç½®æ–‡ä»¶ï¼š\nGateway API ä¼šæä¾›ç”¨äºä¸€è‡´æ€§æµ‹è¯•çš„é…ç½®æ–‡ä»¶ï¼Œåœ¨è¿è¡Œä¸€è‡´æ€§æµ‹è¯•å¯ä»¥é€‰æ‹©è¿™äº›é…ç½®æ–‡ä»¶ã€‚ç„¶åå°†ä¸€è‡´æ€§ç»“æœæŠ¥å‘Šå›ç½‘å…³ API é¡¹ç›®å¹¶è·å¾—è®¤è¯ï¼ˆä¾‹å¦‚å¾½ç« ï¼‰ã€‚é™¤äº†æµ‹è¯•æ ¸å¿ƒçš„åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥è‡ªä¸»æ·»åŠ å‚å•†çš„ç‰¹å®šå®ç°ä¸­çš„æ‰©å±•åŠŸèƒ½è¿›è¡Œæµ‹è¯•ã€‚\nè¿™äº› Gateway API çš„å®ç°ä¼šå°†æµ‹è¯•æŠ¥å‘Šæäº¤åˆ° å®˜æ–¹ä»“åº“çš„ä¸€è‡´æ€§æµ‹è¯•æŠ¥å‘Šç›®å½• ä¸­ï¼Œå¯ä»¥ä½œä¸ºå¤§å®¶é€‰å‹æ—¶çš„ä¾æ®ä¹‹ä¸€ã€‚\nç›®å‰æœ‰ HTTPã€TLSã€TLSPassthroughï¼ˆåŸºæœ¬ä¸Šéƒ½æ˜¯æ ¹æ® xRoute æ¥è¿›è¡Œç»„ç»‡ï¼Œå› æ­¤åç»­ä¹Ÿä¼šæœ‰ GRPCã€TCPã€UDPï¼‰ã€‚é’ˆå¯¹æœåŠ¡ç½‘æ ¼ï¼Œä¹Ÿæå‡ºäº† mesh é…ç½®æ–‡ä»¶ã€‚\nå®˜æ–¹åšå®¢ ä¸­æåˆ° Kuma 2.3+ã€Linkerd 2.14+ã€å’Œ Istio 1.16+ ä¸­çš„ Gateway API å®ç°å·²ç»å…¨éƒ¨é€šè¿‡ mesh ä¸€è‡´æ€§æµ‹è¯•ï¼Œä½†æˆªæ­¢ç›®å‰æœªçœ‹åˆ°æµ‹è¯•æŠ¥å‘Šï¼Œä¼°è®¡è¿˜åœ¨ä¸Šä¼ ä¸­ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/09/07/pexels-pixabay-261821.jpg","permalink":"https://atbug.com/explore-how-gateway-api-works-in-service-mesh/","tags":["Kubernetes","ç½‘å…³","Service Mesh"],"title":"æ¢ç´¢ Gateway API åœ¨ Service Mesh ä¸­çš„å·¥ä½œæœºåˆ¶"},{"categories":["å·¥å…·"],"contents":"ä¹‹å‰å†™ åœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ MetalLB ä½œä¸º LoadBalancerï¼ˆä¸‹ï¼‰- BGP æ—¶ï¼Œæˆ‘æ›¾åœ¨ OpenWRT å®‰è£… FRR æ¥è¿›è¡Œäº†æµ‹è¯•ã€‚éœ€è¦ OpenWRT çš„ç¯å¢ƒä¸å…ä¼šæœ‰äº›ç¹çï¼Œå‡å¦‚åªæ˜¯åšäº›æ›´ç®€å•çš„æµ‹è¯•ï¼Œæ¯”å¦‚ä» FRR æ‰€åœ¨æœåŠ¡å™¨ä¸Šè¿›è¡Œ VIP çš„è®¿é—®ï¼Œåˆ™æ˜¯ä¸éœ€è¦ OpenWRT çš„ï¼Œä»…ä»…éƒ¨ç½² FRR å°±è¶³å¤Ÿäº†ã€‚\nä»Šå¤©æˆ‘å°±å°è¯•äº†ç›´æ¥ä½¿ç”¨ Docker è¿è¡Œ FRR æ¥å¯åŠ¨ BGP Router è¿›ç¨‹ï¼Œç®€å•çš„å‡ æ­¥å³å¯å®ç°ï¼Œå¯¹ç¯å¢ƒè¦æ±‚éå¸¸ä½ï¼Œåªéœ€è¦ä¸ª Docker å°±è¡Œã€‚å¦‚æœä½ åˆæ›´ç®€å•çš„æ–¹æ³•ï¼Œä¹Ÿè¯·ç•™è¨€åˆ†äº«ã€‚\né…ç½® åˆ›å»ºä¸€ä¸ªæœ¬åœ°ç›®å½•åœ¨ç®¡ç† FRR é…ç½®ï¼Œè¿™ä¸ªç›®å½•å°†ä¼šæŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚\nmkdir frr å‡†å¤‡ FRR Daemon çš„æ—¥å¿—ï¼Œå¼€å¯ BGP daemon è¿›ç¨‹ã€‚\ntee \u0026gt; ./frr/daemons \u0026lt;\u0026lt;EOF # This file tells the frr package which daemons to start. # # Sample configurations for these daemons can be found in # /usr/share/doc/frr/examples/. # # ATTENTION: # # When activating a daemon for the first time, a config file, even if it is # empty, has to be present *and* be owned by the user and group \u0026#34;frr\u0026#34;, else # the daemon will not be started by /etc/init.d/frr. The permissions should # be u=rw,g=r,o=. # When using \u0026#34;vtysh\u0026#34; such a config file is also needed. It should be owned by # group \u0026#34;frrvty\u0026#34; and set to ug=rw,o= though. Check /etc/pam.d/frr, too. # # The watchfrr, zebra and staticd daemons are always started. # bgpd=yes ospfd=no ospf6d=no ripd=no ripngd=no isisd=no pimd=no pim6d=no ldpd=no nhrpd=no eigrpd=no babeld=no sharpd=no pbrd=no bfdd=no fabricd=no vrrpd=no pathd=no # # If this option is set the /etc/init.d/frr script automatically loads # the config via \u0026#34;vtysh -b\u0026#34; when the servers are started. # Check /etc/pam.d/frr if you intend to use \u0026#34;vtysh\u0026#34;! # vtysh_enable=yes zebra_options=\u0026#34; -A 127.0.0.1 -s 90000000\u0026#34; bgpd_options=\u0026#34; -A 127.0.0.1\u0026#34; ospfd_options=\u0026#34; -A 127.0.0.1\u0026#34; ospf6d_options=\u0026#34; -A ::1\u0026#34; ripd_options=\u0026#34; -A 127.0.0.1\u0026#34; ripngd_options=\u0026#34; -A ::1\u0026#34; isisd_options=\u0026#34; -A 127.0.0.1\u0026#34; pimd_options=\u0026#34; -A 127.0.0.1\u0026#34; pim6d_options=\u0026#34; -A ::1\u0026#34; ldpd_options=\u0026#34; -A 127.0.0.1\u0026#34; nhrpd_options=\u0026#34; -A 127.0.0.1\u0026#34; eigrpd_options=\u0026#34; -A 127.0.0.1\u0026#34; babeld_options=\u0026#34; -A 127.0.0.1\u0026#34; sharpd_options=\u0026#34; -A 127.0.0.1\u0026#34; pbrd_options=\u0026#34; -A 127.0.0.1\u0026#34; staticd_options=\u0026#34;-A 127.0.0.1\u0026#34; bfdd_options=\u0026#34; -A 127.0.0.1\u0026#34; fabricd_options=\u0026#34;-A 127.0.0.1\u0026#34; vrrpd_options=\u0026#34; -A 127.0.0.1\u0026#34; pathd_options=\u0026#34; -A 127.0.0.1\u0026#34; # If you want to pass a common option to all daemons, you can use the # \u0026#34;frr_global_options\u0026#34; variable. # #frr_global_options=\u0026#34;\u0026#34; # The list of daemons to watch is automatically generated by the init script. # This variable can be used to pass options to watchfrr that will be passed # prior to the daemon list. # # To make watchfrr create/join the specified netns, add the the \u0026#34;--netns\u0026#34; # option here. It will only have an effect in /etc/frr/\u0026lt;somename\u0026gt;/daemons, and # you need to start FRR with \u0026#34;/usr/lib/frr/frrinit.sh start \u0026lt;somename\u0026gt;\u0026#34;. # #watchfrr_options=\u0026#34;\u0026#34; # configuration profile # #frr_profile=\u0026#34;traditional\u0026#34; #frr_profile=\u0026#34;datacenter\u0026#34; # This is the maximum number of FD\u0026#39;s that will be available. Upon startup this # is read by the control files and ulimit is called. Uncomment and use a # reasonable value for your setup if you are expecting a large number of peers # in say BGP. # #MAX_FDS=1024 # For any daemon, you can specify a \u0026#34;wrap\u0026#34; command to start instead of starting # the daemon directly. This will simply be prepended to the daemon invocation. # These variables have the form daemon_wrap, where \u0026#39;daemon\u0026#39; is the name of the # daemon (the same pattern as the daemon_options variables). # # Note that when daemons are started, they are told to daemonize with the `-d` # option. This has several implications. For one, the init script expects that # when it invokes a daemon, the invocation returns immediately. If you add a # wrap command here, it must comply with this expectation and daemonize as # well, or the init script will never return. Furthermore, because daemons are # themselves daemonized with -d, you must ensure that your wrapper command is # capable of following child processes after a fork() if you need it to do so. # # If your desired wrapper does not support daemonization, you can wrap it with # a utility program that daemonizes programs, such as \u0026#39;daemonize\u0026#39;. An example # of this might look like: # # bgpd_wrap=\u0026#34;/usr/bin/daemonize /usr/bin/mywrapper\u0026#34; # # This is particularly useful for programs which record processes but lack # daemonization options, such as perf and rr. # # If you wish to wrap all daemons in the same way, you may set the \u0026#34;all_wrap\u0026#34; # variable. # #all_wrap=\u0026#34;\u0026#34; EOF å‡†å¤‡ BGP çš„é…ç½®ï¼ŒåŒ…æ‹¬è·¯ç”±å™¨çš„ AS ä»¥åŠé‚»å±…çš„é…ç½®ã€‚\ntee \u0026gt;\u0026gt; ./frr/frr.conf \u0026lt;\u0026lt;EOF ip forwarding ! router bgp 65000 bgp router-id 192.168.1.11 no bgp ebgp-requires-policy bgp bestpath peer-type multipath-relax neighbor 192.168.1.13 remote-as 65001 neighbor 192.168.1.14 remote-as 65001 exit ! EOF é…ç½®è¯´æ˜\nè¯¥æ®µé…ç½®æ˜¯ FRRouting ä¸­çš„ BGP é…ç½®ã€‚ä¸‹é¢æ˜¯è¯¦ç»†çš„è§£é‡Šï¼š\nip forwardingï¼š è¿™å¯ç”¨äº† IP è½¬å‘ã€‚å®ƒå‘Šè¯‰ FRR å®ƒåº”è¯¥å…è®¸ä»ä¸€ä¸ªç½‘ç»œæ¥å£ä¼ é€’åˆ°å¦ä¸€ä¸ªç½‘ç»œæ¥å£çš„ IP æ•°æ®åŒ…è½¬å‘ã€‚ router bgp 65000ï¼š å¼€å§‹å®šä¹‰ä¸€ä¸ª BGP è·¯ç”±å™¨è¿›ç¨‹ï¼Œå…¶ä¸­ 65000 æ˜¯è¯¥ BGP å®ä¾‹çš„ AS (è‡ªæ²»ç³»ç»Ÿ) å·ã€‚ bgp router-id 10.0.2.5ï¼š è®¾ç½® BGP è·¯ç”±å™¨çš„ router-idã€‚Router-ID æ˜¯ BGP ä¼šè¯ä¸­ä½¿ç”¨çš„æ ‡è¯†ç¬¦ï¼Œé€šå¸¸é€‰æ‹©ä¸ºè·¯ç”±å™¨ä¸Šçš„ä¸€ä¸ª IP åœ°å€ã€‚ no bgp ebgp-requires-policyï¼š é»˜è®¤æƒ…å†µä¸‹ï¼ŒBGP éœ€è¦ä¸º eBGP (å¤–éƒ¨ BGP) é‚»å±…å®šä¹‰ç­–ç•¥ï¼ˆæŒ‡å‡ºå…è®¸æˆ–æ‹’ç»çš„è·¯ç”±ï¼‰ã€‚è¿™æ¡å‘½ä»¤ç¦ç”¨äº†è¿™ä¸ªè¦æ±‚ï¼Œå…è®¸æ‰€æœ‰çš„è·¯ç”±å¹¿æ’­ç»™ eBGP é‚»å±…ï¼Œé™¤éæ˜ç¡®é…ç½®äº†ç­–ç•¥æ¥è¿›è¡Œè¿‡æ»¤ã€‚ bgp bestpath peer-type multipath-relaxï¼š é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ BGP è€ƒè™‘å¤šè·¯å¾„è·¯ç”±æ—¶ï¼Œå®ƒåªä¼šè€ƒè™‘æ¥è‡ªç›¸åŒç±»å‹çš„é‚»å±…ï¼ˆå†…éƒ¨ BGP æˆ–å¤–éƒ¨ BGPï¼‰çš„è·¯ç”±ã€‚æ­¤å‘½ä»¤ä¿®æ”¹äº†è¿™ä¸€è¡Œä¸ºï¼Œå…è®¸æ¥è‡ªä¸åŒç±»å‹çš„é‚»å±…çš„è·¯ç”±è¢«è€ƒè™‘ä¸ºç­‰ä»·å¤šè·¯å¾„ (ECMP) çš„å€™é€‰ã€‚ neighbor 10.0.2.6 remote-as 65001ï¼š å®šä¹‰äº†ä¸€ä¸ª BGP é‚»å±…ï¼Œå…¶ IP åœ°å€ä¸º 10.0.2.6ï¼Œå¹¶æŒ‡å®šå®ƒä½äº AS 65001ã€‚è¿™æ„å‘³ç€æ‚¨çš„è·¯ç”±å™¨ï¼ˆåœ¨ AS 65000ï¼‰å°†å°è¯•ä¸ä½äº AS 65001 çš„ 10.0.2.6 å»ºç«‹ BGP ä¼šè¯ã€‚ exitï¼š é€€å‡º BGP é…ç½®æ¨¡å¼ï¼Œè¿”å›åˆ° FRR çš„ä¸»é…ç½®æ¨¡å¼ã€‚ è¿™æ®µé…ç½®åŸºæœ¬ä¸Šå®šä¹‰äº†ä¸€ä¸ª BGP ä¼šè¯ï¼Œå…¶ä¸­æœ¬åœ° AS å·ä¸º 65000ï¼Œä¸è¿œç¨‹é‚»å±… 10.0.2.6ï¼ˆå…¶ AS å·ä¸º 65001ï¼‰é€šä¿¡ã€‚\nè¿è¡Œ å‡†å¤‡å¥½é…ç½®åå°±å¯ä»¥å¯åŠ¨å®¹å™¨äº†ï¼Œæ³¨æ„è¿™é‡Œä½¿ç”¨çš„å‚æ•°ã€‚ç”±äºåšäº†é…ç½®æŒä¹…åŒ–ï¼Œæˆ‘ä½¿ç”¨äº† -rm å‚æ•°ï¼Œå¯ä»¥éšæ—¶é”€æ¯å‚æ•°ï¼›ä½¿ç”¨äº†ä¸»æœºç½‘ç»œï¼Œå› æ­¤æ— éœ€æš´éœ² BGP çš„ 179 ç«¯å£ã€‚\ndocker run --rm -d --privileged --name frr --net=host -e watchfrr_debug=true -v ./frr:/etc/frr frrouting/frr:latest æ£€æŸ¥ ssh åˆ°å®¹å™¨ä¸­ã€‚\ndocker exec -it frr sh æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ã€‚\nvtysh show bgp summary å°†çœ‹åˆ°å¦‚ä¸‹çš„ä¿¡æ¯ï¼Œç”±äºä¸¤ä¸ªé‚»å±…éƒ½æœªä¸Šçº¿ï¼Œå› æ­¤å¯ä»¥çœ‹åˆ°çŠ¶æ€æ˜¯ Active ä½†æ˜¯è¿è¡Œæ—¶é—´æ˜¯ neverã€‚\nIPv4 Unicast Summary (VRF default): BGP router identifier 192.168.1.11, local AS number 65000 vrf-id 0 BGP table version 0 RIB entries 0, using 0 bytes of memory Peers 2, using 1434 KiB of memory Neighbor V AS MsgRcvd MsgSent TblVer InQ OutQ Up/Down State/PfxRcd PfxSnt Desc 192.168.1.13 4 65001 0 0 0 0 0 never Active 0 N/A 192.168.1.14 4 65001 0 0 0 0 0 never Active 0 N/A Total number of neighbors 2 åé¢å°±å¯ä»¥å¯åŠ¨é‚»å±…çš„ BGP å®£å‘Šäº†ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/09/01/pexels-dibakar-roy-4064969.jpg","permalink":"https://atbug.com/run-frr-bgp-with-docker/","tags":["BGP","å·¥å…·"],"title":"ä½¿ç”¨ Docker è¿è¡Œ FRR BGP"},{"categories":["ç¬”è®°"],"contents":"å†™è¿™ç¯‡æ–‡ç« æ˜¯æ¥å¡« å¾ˆä¹…ä¹‹å‰æŒ–ä¸‹çš„å‘ã€‚\næœ¬æ–‡æ¶‰åŠç»„ä»¶çš„æºç ç‰ˆæœ¬å¦‚ä¸‹ï¼š\nKubernetes 1.24 CRI 0.25.0 Containerd 1.6 å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰æ˜¯è´Ÿè´£ç®¡ç†å’Œæ‰§è¡Œå®¹å™¨çš„ç»„ä»¶ã€‚å®ƒè´Ÿè´£å°†å®¹å™¨é•œåƒè½¬åŒ–ä¸ºåœ¨ä¸»æœºä¸Šè¿è¡Œçš„å®é™…å®¹å™¨è¿›ç¨‹ï¼Œæä¾›é•œåƒç®¡ç†ã€å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€èµ„æºéš”ç¦»ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œé…ç½®ç­‰åŠŸèƒ½ã€‚\nå¸¸è§å®¹å™¨è¿è¡Œæ—¶æœ‰ä¸‹é¢è¿™å‡ ç§ï¼Œè¿™äº›å®¹å™¨è¿è¡Œæ—¶éƒ½æä¾›äº†ä¸åŒç¨‹åº¦çš„åŠŸèƒ½å’Œæ€§èƒ½ã€‚ä½†ä»–ä»¬éƒ½éµå¾ªå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰ï¼Œä»¥ä¾¿èƒ½å¤Ÿä¸ Kubernetes æˆ–å…¶ä»–å®¹å™¨ç¼–æ’ç³»ç»Ÿé›†æˆï¼Œå®ç°å®¹å™¨çš„è°ƒåº¦å’Œç®¡ç†ã€‚\ncontainerd CRI-O Docker Engine Mirantis Container Runtime æœ‰äº† CRIï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥â€œéšæ„â€åœ°åœ¨å‡ ç§å®¹å™¨è¿è¡Œæ—¶ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘ Kubernetesã€‚ç®€å•æ¥è®²ï¼ŒCRI å®šä¹‰äº†æ‰€æœ‰å¯¹å®¹å™¨çš„æ“ä½œï¼Œä½œä¸ºå®¹å™¨ç¼–æ’ç³»ç»Ÿä¸å®¹å™¨è¿è¡Œæ—¶é—´çš„æ ‡å‡†æ¥å£å­˜åœ¨ã€‚\nCRI çš„å‰ç”Ÿä»Šä¸– CRI çš„é¦–æ¬¡å¼•å…¥æ˜¯åœ¨ Kubernets 1.5ï¼Œåˆå§‹ç‰ˆæœ¬æ˜¯ v1alpha1ã€‚åœ¨è¿™ä¹‹å‰ï¼ŒKubernetes éœ€è¦åœ¨ kubelet æºç ä¸­ç»´æŠ¤å¯¹å„ä¸ªå®¹å™¨è¿è¡Œæ—¶çš„æ”¯æŒã€‚\næœ‰äº† CRI ä¹‹åï¼Œåœ¨ kubelet ä¸­ä»…éœ€æ”¯æŒ CRI å³å¯ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªä¸­é—´å±‚ CRI shimï¼ˆgrpc æœåŠ¡å™¨ï¼‰ä¸å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ã€‚å› ä¸ºæ­¤æ—¶å„å®¶å®¹å™¨è¿è¡Œæ—¶å®ç°è¿˜æœªæ”¯æŒ CRIã€‚\nåœ¨å»å¹´å‘å¸ƒçš„ Kubernetes 1.24 ä¸­ï¼Œæ­£å¼ç§»é™¤äº† Dockershimï¼Œä¸å®¹æ˜“è¿è¡Œæ—¶çš„äº¤äº’å¾—åˆ°äº†ç®€åŒ–ã€‚\nKubernetes ç›®å‰æ”¯æŒ CRI çš„ v1alpha2 å’Œ v1ã€‚å…¶ä¸­ v1 ç‰ˆæœ¬æ˜¯åœ¨ Kubernetes 1.23 ç‰ˆæœ¬ä¸­å¼•å…¥çš„ã€‚\næ¯æ¬¡ kubelet å¯åŠ¨æ—¶ï¼Œé¦–å…ˆä¼šå°è¯•ä½¿ç”¨ v1 çš„ API ä¸å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œè¿æ¥ã€‚å¦‚æœå¤±è´¥ï¼Œæ‰ä¼šå°è¯•ä½¿ç”¨ v1alpha2ã€‚\nkubelet ä¸ CRI åœ¨ä¹‹å‰åšè¿‡çš„Â kubelet æºç åˆ†æÂ ä¸­æ›¾æåˆ°Â Kubelet#syncLoop()Â ä¼šæŒç»­ç›‘æ§æ¥è‡ªÂ æ–‡ä»¶ã€apiserverã€httpÂ çš„å˜æ›´ï¼Œæ¥æ›´æ–° pod çš„çŠ¶æ€ã€‚å†™é‚£ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œåˆ†æåˆ°è¿™é‡Œå°±ç»“æŸäº†ã€‚å› ä¸ºè¿™ä¹‹åçš„å·¥ä½œå°±äº¤ç»™ å®¹å™¨è¿è¡Œæ—¶ æ¥å®ŒæˆÂ sandboxÂ å’Œå„ç§å®¹å™¨çš„åˆ›å»ºå’Œè¿è¡Œï¼Œè§Â kubeGenericRuntimeManager#SyncPod()ã€‚\nkubelet å¯åŠ¨æ—¶ä¾¿ä¼š åˆå§‹åŒ– CRI å®¢æˆ·ç«¯ï¼Œä¸å®¹å™¨è¿è¡Œæ—¶å»ºç«‹è¿æ¥å¹¶ç¡®è®¤ CRI çš„ç‰ˆæœ¬ã€‚\nåˆ›å»º pod çš„è¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šé€šè¿‡ CRI ä¸å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ï¼š\nåˆ›å»º sandbox åˆ›å»ºå®¹å™¨ æ‹‰å–é•œåƒ å‚è€ƒæºç  pkg/kubelet/kuberuntime/kuberuntime_sandbox.go#L39 pkg/kubelet/kuberuntime/kuberuntime_container.go#L176 pkg/kubelet/images/image_manager.go#L89 æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ Containerd ä¸ºä¾‹ï¼Œçœ‹ä¸‹å¦‚ä½•å¤„ç† kubelet çš„è¯·æ±‚ã€‚\nContainerd ä¸ CRI Containerd çš„ criService å®ç°äº† CRI æ¥å£ RuntimeService å’Œ ImageService çš„ RuntimeServiceServer å’Œ ImageServiceServerã€‚\ncirService ä¼šè¿›ä¸€æ­¥åŒ…è£…æˆ instrumentedServiceï¼Œä¿è¯æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åœ¨ k8s.io å‘½åç©ºé—´ä¸‹æ‰§è¡Œçš„\nRuntimeServiceServer RuntimeServiceServer\ntype RuntimeServiceServer interface { // Version returns the runtime name, runtime version, and runtime API version. Version(context.Context, *VersionRequest) (*VersionResponse, error) // RunPodSandbox creates and starts a pod-level sandbox. Runtimes must ensure // the sandbox is in the ready state on success. RunPodSandbox(context.Context, *RunPodSandboxRequest) (*RunPodSandboxResponse, error) // StopPodSandbox stops any running process that is part of the sandbox and // reclaims network resources (e.g., IP addresses) allocated to the sandbox. // If there are any running containers in the sandbox, they must be forcibly // terminated. // This call is idempotent, and must not return an error if all relevant // resources have already been reclaimed. kubelet will call StopPodSandbox // at least once before calling RemovePodSandbox. It will also attempt to // reclaim resources eagerly, as soon as a sandbox is not needed. Hence, // multiple StopPodSandbox calls are expected. StopPodSandbox(context.Context, *StopPodSandboxRequest) (*StopPodSandboxResponse, error) // RemovePodSandbox removes the sandbox. If there are any running containers // in the sandbox, they must be forcibly terminated and removed. // This call is idempotent, and must not return an error if the sandbox has // already been removed. RemovePodSandbox(context.Context, *RemovePodSandboxRequest) (*RemovePodSandboxResponse, error) // PodSandboxStatus returns the status of the PodSandbox. If the PodSandbox is not // present, returns an error. PodSandboxStatus(context.Context, *PodSandboxStatusRequest) (*PodSandboxStatusResponse, error) // ListPodSandbox returns a list of PodSandboxes. ListPodSandbox(context.Context, *ListPodSandboxRequest) (*ListPodSandboxResponse, error) // CreateContainer creates a new container in specified PodSandbox CreateContainer(context.Context, *CreateContainerRequest) (*CreateContainerResponse, error) // StartContainer starts the container. StartContainer(context.Context, *StartContainerRequest) (*StartContainerResponse, error) // StopContainer stops a running container with a grace period (i.e., timeout). // This call is idempotent, and must not return an error if the container has // already been stopped. // The runtime must forcibly kill the container after the grace period is // reached. StopContainer(context.Context, *StopContainerRequest) (*StopContainerResponse, error) // RemoveContainer removes the container. If the container is running, the // container must be forcibly removed. // This call is idempotent, and must not return an error if the container has // already been removed. RemoveContainer(context.Context, *RemoveContainerRequest) (*RemoveContainerResponse, error) // ListContainers lists all containers by filters. ListContainers(context.Context, *ListContainersRequest) (*ListContainersResponse, error) // ContainerStatus returns status of the container. If the container is not // present, returns an error. ContainerStatus(context.Context, *ContainerStatusRequest) (*ContainerStatusResponse, error) // UpdateContainerResources updates ContainerConfig of the container synchronously. // If runtime fails to transactionally update the requested resources, an error is returned. UpdateContainerResources(context.Context, *UpdateContainerResourcesRequest) (*UpdateContainerResourcesResponse, error) // ReopenContainerLog asks runtime to reopen the stdout/stderr log file // for the container. This is often called after the log file has been // rotated. If the container is not running, container runtime can choose // to either create a new log file and return nil, or return an error. // Once it returns error, new container log file MUST NOT be created. ReopenContainerLog(context.Context, *ReopenContainerLogRequest) (*ReopenContainerLogResponse, error) // ExecSync runs a command in a container synchronously. ExecSync(context.Context, *ExecSyncRequest) (*ExecSyncResponse, error) // Exec prepares a streaming endpoint to execute a command in the container. Exec(context.Context, *ExecRequest) (*ExecResponse, error) // Attach prepares a streaming endpoint to attach to a running container. Attach(context.Context, *AttachRequest) (*AttachResponse, error) // PortForward prepares a streaming endpoint to forward ports from a PodSandbox. PortForward(context.Context, *PortForwardRequest) (*PortForwardResponse, error) // ContainerStats returns stats of the container. If the container does not // exist, the call returns an error. ContainerStats(context.Context, *ContainerStatsRequest) (*ContainerStatsResponse, error) // ListContainerStats returns stats of all running containers. ListContainerStats(context.Context, *ListContainerStatsRequest) (*ListContainerStatsResponse, error) // PodSandboxStats returns stats of the pod sandbox. If the pod sandbox does not // exist, the call returns an error. PodSandboxStats(context.Context, *PodSandboxStatsRequest) (*PodSandboxStatsResponse, error) // ListPodSandboxStats returns stats of the pod sandboxes matching a filter. ListPodSandboxStats(context.Context, *ListPodSandboxStatsRequest) (*ListPodSandboxStatsResponse, error) // UpdateRuntimeConfig updates the runtime configuration based on the given request. UpdateRuntimeConfig(context.Context, *UpdateRuntimeConfigRequest) (*UpdateRuntimeConfigResponse, error) // Status returns the status of the runtime. Status(context.Context, *StatusRequest) (*StatusResponse, error) // CheckpointContainer checkpoints a container CheckpointContainer(context.Context, *CheckpointContainerRequest) (*CheckpointContainerResponse, error) // GetContainerEvents gets container events from the CRI runtime GetContainerEvents(*GetEventsRequest, RuntimeService_GetContainerEventsServer) error } ImageServiceServer ImageServiceServer\ntype ImageServiceServer interface { // ListImages lists existing images. ListImages(context.Context, *ListImagesRequest) (*ListImagesResponse, error) // ImageStatus returns the status of the image. If the image is not // present, returns a response with ImageStatusResponse.Image set to // nil. ImageStatus(context.Context, *ImageStatusRequest) (*ImageStatusResponse, error) // PullImage pulls an image with authentication config. PullImage(context.Context, *PullImageRequest) (*PullImageResponse, error) // RemoveImage removes the image. // This call is idempotent, and must not return an error if the image has // already been removed. RemoveImage(context.Context, *RemoveImageRequest) (*RemoveImageResponse, error) // ImageFSInfo returns information of the filesystem that is used to store images. ImageFsInfo(context.Context, *ImageFsInfoRequest) (*ImageFsInfoResponse, error) } ä¸‹é¢ä»¥åˆ›å»º sandbox ä¸ºä¾‹çœ‹ä¸€ä¸‹ Containerd çš„æºç ã€‚\nContainerd æºç åˆ†æ åˆ›å»º sandbox å®¹å™¨çš„è¯·æ±‚é€šè¿‡ CRI çš„ UDSï¼ˆUnix domain socketï¼‰ æ¥å£ /runtime.v1.RuntimeService/RunPodSandboxï¼Œè¿›å…¥åˆ° criService çš„å¤„ç†æµç¨‹ä¸­ã€‚åœ¨ criService#RunPodSandbox()ï¼Œè´Ÿè´£åˆ›å»ºå’Œè¿è¡Œ sandbox å®¹å™¨ï¼Œå¹¶ä¿è¯å®¹å™¨çŠ¶æ€æ­£å¸¸ã€‚\nä¸‹è½½ sandobx å®¹å™¨é•œåƒ åˆå§‹åŒ–å®¹å™¨å…ƒæ•°æ® åˆå§‹åŒ– pod ç½‘ç»œå‘½åç©ºé—´ï¼Œè¯¦ç»†å†…å®¹å¯å‚è€ƒä¹‹å‰çš„æ–‡ç«  æºç è§£æï¼šä» kubeletã€å®¹å™¨è¿è¡Œæ—¶çœ‹ CNI çš„ä½¿ç”¨ æ›´æ–°å®¹å™¨å…ƒæ•°æ® å†™å…¥æ–‡ä»¶ç³»ç»Ÿ å‚è€ƒæºç  pkg/cri/server/sandbox_run.go#L61 services/tasks/local.go#L156 æ€»ç»“ CRI æä¾›äº†ä¸€ç§æ ‡å‡†åŒ–çš„æ¥å£ï¼Œç”¨äºä¸åº•å±‚å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ã€‚è¿™å¯¹ä¸å‘å±•å’ŒçŠ¶å¤§ Kubernetes ç”Ÿæ€ç³»ç»Ÿéå¸¸é‡è¦ï¼š\nKubernetes æ§åˆ¶å¹³é¢ä¸å®¹å™¨ç®¡ç†çš„å…·ä½“å®ç°è§£è€¦ï¼Œå¯ä»¥ç‹¬ç«‹å‡çº§æˆ–è€…åˆ‡æ¢å®¹å™¨è¿è¡Œæ—¶ï¼Œæ–¹ä¾¿æ‰©å±•å’Œä¼˜åŒ–ã€‚ Kubernetes ä½œä¸ºä¸€ä¸ªè·¨äº‘ã€è·¨å¹³å°å’Œå¤šç¯å¢ƒçš„å®¹å™¨ç¼–æ’ç³»ç»Ÿï¼Œåœ¨ä¸åŒçš„ç¯å¢ƒå’Œåœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒçš„å®¹å™¨å¹³å°ã€‚CRI çš„å‡ºç°ï¼Œä¿è¯å¹³å°çš„å¤šæ ·æ€§å’Œçµæ´»æ€§ã€‚ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/08/28/pexels-steven-putong-2410871.jpg","permalink":"https://atbug.com/deep-dive-into-kubernetes-cri/","tags":["Kubernetes","å®¹å™¨","CRI"],"title":"Kubernetes å®¹å™¨è¿è¡Œæ—¶æ¥å£ CRI"},{"categories":["å·¥å…·"],"contents":"ä»‹ç» Fortio æ˜¯ä¸€ä¸ªç”¨äºå¾®æœåŠ¡æ€§èƒ½è´Ÿè½½ã€æ€§èƒ½ã€å»¶è¿Ÿæµ‹è¯•å’Œ Web UI çš„å·¥å…·ã€‚å®ƒé€šå¸¸ä¸ Istio å’Œå…¶ä»–æœåŠ¡ç½‘æ ¼è§£å†³æ–¹æ¡ˆä¸€èµ·ä½¿ç”¨ï¼Œä½†å¯ä»¥ç‹¬ç«‹ä½¿ç”¨æ¥æµ‹è¯•ç½‘ç»œå»¶è¿Ÿå’Œ HTTP/gRPC çš„è´Ÿè½½ç‰¹æ€§ã€‚ä»¥ä¸‹æ˜¯å…³äº Fortio çš„ä¸€äº›ä¸»è¦ç‰¹ç‚¹å’Œä¿¡æ¯ï¼š\nç”¨é€”ï¼šFortio å¯ä»¥åˆ›å»ºä¸€ä¸ªå®šåˆ¶çš„è´Ÿè½½ï¼ˆæŸ¥è¯¢/ç§’æˆ– qpsï¼‰å¹¶è®°å½•è¯·æ±‚å»¶è¿Ÿçš„ç›´æ–¹å›¾ï¼Œä»¥åŠæ¯ç§’æŸ¥è¯¢çš„ç™¾åˆ†ä½æ•°ã€‚ å¤šåè®®æ”¯æŒï¼šè™½ç„¶æœ€åˆæ˜¯ä¸º HTTP/1.1 è®¾è®¡çš„ï¼Œä½† Fortio è¿˜æ”¯æŒ HTTP/2, gRPC, TCP å’Œ UDPã€‚ Web UIï¼šFortio æä¾›äº†ä¸€ä¸ª Web ç•Œé¢ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿä»æµè§ˆå™¨ä¸­è½»æ¾é…ç½®æµ‹è¯•å¹¶æŸ¥çœ‹ç»“æœçš„ç›´æ–¹å›¾å’Œç™¾åˆ†ä½æ•°ã€‚ ç»“æœå­˜å‚¨ï¼šå¯ä»¥å°†ç»“æœå­˜å‚¨ä¸º JSON æ–‡ä»¶ï¼Œä¾¿äºè¿›ä¸€æ­¥çš„åˆ†æå’Œæ¯”è¾ƒã€‚ çµæ´»æ€§ï¼šæ”¯æŒå¤šç§è¯·æ±‚è´Ÿè½½æ¨¡å¼ï¼ŒåŒ…æ‹¬å›ºå®š qpsã€å›ºå®šå¹¶å‘è¿æ¥æ•°å’Œæœ€å¤§è‡ªåŠ¨è°ƒæ•´ qpsã€‚ è½»é‡çº§ï¼šFortio æ˜¯ç”¨ Go ç¼–å†™çš„ï¼Œå¯ä»¥ä½œä¸ºä¸€ä¸ªå•ä¸€çš„äºŒè¿›åˆ¶æ–‡ä»¶è½»æ¾éƒ¨ç½²ã€‚ é›†æˆï¼šFortio å¯ä»¥ä¸ Istioã€Prometheus ç­‰å·¥å…·é›†æˆï¼Œä»¥æä¾›æ›´æ·±å…¥çš„æ€§èƒ½åˆ†æå’Œè§‚å¯Ÿã€‚ Fortio ä½œä¸ºæœåŠ¡å™¨ fortio server \u0026amp; 08:24:40.002 r1 [INF] scli.go:117\u0026gt; Starting, command=\u0026#34;Î¦Î¿ÏÏ„Î¯Î¿\u0026#34;, version=\u0026#34;1.59.0 h1:juuL/l3N/YyIP0P078YkkrtFfG4CaItqeZSkv5VnXCE= go1.20.7 arm64 darwin\u0026#34; 08:24:40.003 r1 Fortio 1.59.0 tcp-echo server listening on tcp [::]:8078 08:24:40.004 r1 Fortio 1.59.0 udp-echo server listening on udp [::]:8078 08:24:40.004 r1 Fortio 1.59.0 grpc \u0026#39;ping\u0026#39; server listening on tcp [::]:8079 08:24:40.004 r1 Fortio 1.59.0 https redirector server listening on tcp [::]:8081 08:24:40.004 r1 Fortio 1.59.0 http-echo server listening on tcp [::]:8080 08:24:40.005 r1 Data directory is /Users/addo 08:24:40.005 r1 REST API on /fortio/rest/run, /fortio/rest/status, /fortio/rest/stop, /fortio/rest/dns 08:24:40.005 r1 Debug endpoint on /debug, Additional Echo on /debug/echo/, Flags on /fortio/flags, and Metrics on /debug/metrics UI started - visit: http://localhost:8080/fortio/ (or any host/ip reachable on this server) 08:24:40.005 r1 [INF] fortio_main.go:292\u0026gt; All fortio 1.59.0 h1:juuL/l3N/YyIP0P078YkkrtFfG4CaItqeZSkv5VnXCE= go1.20.7 arm64 darwin servers started! Fortio ä½œä¸ºæœåŠ¡å™¨è¿è¡Œæ˜¯ï¼Œé»˜è®¤ä¼šå¯åŠ¨ 8078ã€8079ã€8081ã€8080 å››ä¸ªç«¯å£ï¼Œåˆ†åˆ«æ˜¯ tcp echoã€udp echoã€grpc ping ä»¥åŠ http echoã€‚è¿˜å¯ä»¥é€šè¿‡ http://localhost:8080/fortio/ è®¿é—®å†…ç½®çš„é¡µé¢ã€‚\nä½œä¸º HTTP Echo æœåŠ¡å™¨è¿è¡Œæ—¶ï¼Œå¯ä»¥åè®®å¦‚ä¸‹çš„è¯·æ±‚å‚æ•°ã€‚\nå‚æ•° ç”¨æ³•ç¤ºä¾‹ dely å»¶è¿Ÿå“åº”çš„æŒç»­æ—¶é—´ã€‚å¯ä»¥æ˜¯å•ä¸ªå€¼æˆ–é€—å·åˆ†éš”çš„æ¦‚ç‡åˆ—è¡¨ï¼Œä¾‹å¦‚â€œdelay=150us:10,2ms:5,0.5s:1â€ï¼Œè¡¨ç¤º 150 us å»¶è¿Ÿçš„æ¦‚ç‡ä¸º 10%ï¼Œ2ms å»¶è¿Ÿçš„ 5% å’Œ 1/2 ç§’å»¶è¿Ÿçš„ 1% status http çŠ¶æ€è¿”å›è€Œä¸æ˜¯ 200ã€‚å¯ä»¥æ˜¯å•ä¸ªå€¼æˆ–é€—å·åˆ†éš”çš„æ¦‚ç‡åˆ—è¡¨ï¼Œä¾‹å¦‚â€œstatus=404:10,503:5,429:1â€è¡¨ç¤º 404 çŠ¶æ€çš„å‡ ç‡ä¸º 10%ï¼Œ503 çŠ¶æ€çš„ 5% å’Œ 429 çŠ¶æ€çš„ 1% size è¦å›å¤è€Œä¸æ˜¯å›æ˜¾è¾“å…¥çš„æœ‰æ•ˆè´Ÿè½½çš„å¤§å°ã€‚ä¹Ÿå¯ç”¨ä½œæ¦‚ç‡åˆ—è¡¨ã€‚\u0026lsquo;size=1024:10,512:5\u0026rsquo; 10% çš„å“åº”å°†ä¸º 1kï¼Œ5% å°†ä¸º 512 å­—èŠ‚æœ‰æ•ˆè´Ÿè½½ï¼Œå…¶ä½™éƒ¨åˆ†é»˜è®¤ä¸ºå›æ˜¾ã€‚ close åœ¨å›ç­”åå…³é—­å¥—æ¥å­—ï¼Œä¾‹å¦‚â€œclose=trueâ€è¡¨ç¤ºåœ¨æ‰€æœ‰è¯·æ±‚åå…³é—­ï¼Œæˆ–â€œclose=5.3â€åœ¨å¤§çº¦ 5.3% çš„è¯·æ±‚åå…³é—­ header s è¦æ·»åŠ åˆ°å›å¤ä¸­çš„æ ‡å¤´ï¼Œä¾‹å¦‚ \u0026lsquo;\u0026amp;header=Fooï¼šBar\u0026amp;header=Xï¼šY\u0026rsquo; gzip å¦‚æœâ€œæ¥å—ç¼–ç ï¼šgzipâ€ç”±è°ƒç”¨æ–¹/å®¢æˆ·ç«¯åœ¨æ ‡å¤´ä¸­ä¼ é€’; è€Œ \u0026lsquo;gzip=true\u0026rsquo; åœ¨æŸ¥è¯¢å‚æ•°ä¸­ï¼Œæ‰€æœ‰å“åº”éƒ½å°†è¢« gzip å‹ç¼©; æˆ–è€…å¦‚æœé€šè¿‡â€œgzip=42.7â€ï¼Œå¤§çº¦ 42.7% çš„äººä¼š Fortio ä½œä¸ºè´Ÿè½½ç”Ÿæˆå™¨ ä¾‹å¦‚ä»¥ 10/s é€Ÿç‡ã€æŒç»­ 30s å‘é€è¯·æ±‚åˆ° http://localhost:8080ã€‚\nfortio load -qps 10 -t 30s http://localhost:8080 æ›´å¤š fortio load çš„å‚æ•°\nFlag Description, example -qps rate æ‰€æœ‰è¿æ¥/çº¿ç¨‹çš„æ¯ç§’æŸ¥è¯¢æ€»æ•°æˆ– 0 è¡¨ç¤ºæ— ç­‰å¾…/æœ€å¤§ qps -nocatchup ä¸è¦è¯•å›¾åœ¨æœåŠ¡è½åç„¶åæ¢å¤æ—¶é€šè¿‡åŠ å¿«é€Ÿåº¦æ¥è¾¾åˆ°ç›®æ ‡ qpsã€‚ä½¿ QPS æˆä¸ºç»å¯¹ä¸Šé™ å³ä½¿æœåŠ¡æœ‰ä¸€äº›å»¶è¿Ÿå³°å€¼ï¼Œfortio ä¹Ÿä¸ä¼šè¡¥å¿ï¼ˆä½†ä¹Ÿä¸ä¼šå¯¹ç›®æ ‡æ–½åŠ è¶…è¿‡è®¾å®šçš„ qps çš„å‹åŠ›ï¼‰ã€‚å»ºè®®ä¸ -uniform. -c connections å¹¶è¡ŒåŒæ—¶è¿æ¥æ•°ï¼ˆå’ŒåŒ¹é…çš„ go ä¾‹ç¨‹ï¼‰ -t duration è¿è¡Œæµ‹è¯•å¤šé•¿æ—¶é—´ï¼ˆä¾‹å¦‚â€œ-t 30mâ€è¿è¡Œ 30 åˆ†é’Ÿï¼‰æˆ–è¿è¡Œ 0 ç›´åˆ° ^Cï¼Œè€ƒè¯• ple (default 5s) -n numcalls æ­£å¥½é’ˆå¯¹æ­¤æ•°é‡çš„è°ƒç”¨è€Œä¸æ˜¯æŒç»­æ—¶é—´è¿è¡Œã€‚é»˜è®¤å€¼ ï¼ˆ0ï¼‰ æ˜¯ä½¿ç”¨æŒç»­æ—¶é—´ ï¼ˆ-tï¼‰ã€‚ -payload strÂ æˆ–è€…Â -payload-file fname åˆ‡æ¢åˆ°ä½¿ç”¨å¸¦æœ‰ç»™å®šæœ‰æ•ˆè´Ÿè½½çš„ POSTï¼ˆå¦è¯·å‚é˜… -payload-size äº†è§£éšæœºæœ‰æ•ˆè´Ÿè½½ï¼‰ -uniform å°†è°ƒç”¨åŠæ—¶åˆ†æ•£åˆ°çº¿ç¨‹ä¸­ï¼Œä»¥å®ç°æ›´å‡åŒ€çš„è°ƒç”¨åˆ†é…ã€‚ ä¸ -nocatchup ç»“åˆä½¿ç”¨æ•ˆæœæ›´å¥½ã€‚ -r resolution ç›´æ–¹å›¾æœ€ä½å­˜å‚¨æ¡¶çš„åˆ†è¾¨ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ï¼ˆé»˜è®¤ä¸º 0.001ï¼Œå³ 1 æ¯«ç§’ï¼‰ï¼Œä½¿ç”¨é¢„æœŸå…¸å‹å€¼çš„ 1/10ical latency -H \u0026quot;header: value\u0026quot; å¯ä»¥å¤šæ¬¡æŒ‡å®šæ·»åŠ æ ‡å¤´ï¼ˆåŒ…æ‹¬ Hostï¼šï¼‰ -a æ ¹æ®æ ‡ç­¾å’Œæ—¶é—´æˆ³è‡ªåŠ¨ä¿å­˜å¸¦æœ‰æ–‡ä»¶åçš„ JSON ç»“æœ -json filename æ–‡ä»¶åæˆ–â€œ-â€ç”¨äº stdout è¾“å‡º json ç»“æœï¼ˆé»˜è®¤æƒ…å†µä¸‹ç›¸å¯¹äºâ€œ-data-dirâ€ï¼Œå¦‚æœ wantÂ fortio reportÂ to show them; usingÂ -aÂ is typicallly a better option) -labels \u0026quot;l1 l2 ...\u0026quot; è¦æ·»åŠ åˆ°ç”Ÿæˆçš„ JSON ä¸­çš„å…¶ä»–é…ç½®æ•°æ®/æ ‡ç­¾ï¼Œé»˜è®¤ä¸ºç›®æ ‡ URL å’Œä¸»æœºå -h2 å®¢æˆ·ç«¯è°ƒç”¨å°†å°è¯•åå•† http/2.0 è€Œä¸æ˜¯ http1.1ï¼Œè¿™æ„å‘³ç€Â -stdclient -X method å°† http æ–¹æ³•æ›´æ”¹ä¸ºæŒ‡å®šçš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯åŸºäº -payload-*Â æˆ–è€…Â -content-type -logger-force-color å¯¹äºé¢œè‰²è€Œä¸æ˜¯ JSON è¾“å‡ºçš„äº¤äº’å¼è¿è¡Œ -logger-no-color å³ä½¿ä»ç»ˆç«¯è¿è¡Œæ—¶ä¹Ÿå¼ºåˆ¶ JSON è¾“å‡º ä½¿ç”¨ æ¯”å¦‚åšç†”æ–­åŠŸèƒ½çš„æµ‹è¯•ï¼Œéœ€è¦å¯¹æœåŠ¡çš„å»¶è¿Ÿæˆ–è€…é”™è¯¯ï¼Œä»¥åŠå‡ºç°æ¦‚ç‡è¿›è¡Œè°ƒæ•´ã€‚\nfortio load -quiet -c 10 -n 100 -p 50,75,90,95,99 http://localhost:8080/echo\\?status\\=500:30 fortio load -quiet -c 10 -n 100 -p 50,75,90,95,99 http://localhost:8080/echo\\?delay\\=600ms:15 ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/09/01/pexels-ignacio-domato-18172972.jpg","permalink":"https://atbug.com/use-fortio-for-proxy-test/","tags":["æµ‹è¯•","å·¥å…·"],"title":"ä½¿ç”¨ Fortio åšä»£ç†åŠŸèƒ½æµ‹è¯•"},{"categories":["ç¬”è®°"],"contents":"Kubernetes ä½œä¸ºä¸€é¡¹æ ¸å¿ƒæŠ€æœ¯å·²æˆä¸ºç°ä»£åº”ç”¨ç¨‹åºæ¶æ„çš„åŸºç¡€ï¼Œè¶Šæ¥è¶Šå¤šçš„ä¼ä¸šä½¿ç”¨å…¶ä½œä¸ºå®¹å™¨ç¼–æ’ç³»ç»Ÿã€‚Kubernetes é›†ç¾¤ç»å†äº† ä»å• Kubernetes é›†ç¾¤åˆ°å¤š Kubernetes é›†ç¾¤ã€ä»å¤š Kubernetes é›†ç¾¤åˆ° Kubernetes å¤šé›†ç¾¤çš„æ¼”è¿›ï¼Œé›†ç¾¤çš„å±•ç°å½¢å¼ä¸æ–­å‘ç”Ÿç€å˜åŒ–ã€‚\nä¸ºæ­¤ï¼ŒKubernetes å¤šé›†ç¾¤ SIG æå‡ºäº† KEP-1645: Multi-Cluster Services APIï¼ˆä»¥ä¸‹ç®€ç§° MCS APIï¼‰åº”å¯¹ Kubernetes å¤šé›†ç¾¤å¸¦æ¥çš„æŒ‘æˆ˜ï¼Œè¯¦ç»†å†…å®¹å¯ä»¥çœ‹ä¹‹å‰çš„ä»‹ç»ï¼šè®¤è¯†ä¸€ä¸‹ Kubernetes å¤šé›†ç¾¤æœåŠ¡ API ï¼Œè¿™ç¯‡è¦ä»‹ç»çš„æ˜¯å¤šé›†ç¾¤æœåŠ¡ DNSã€‚\nå¤šé›†ç¾¤æœåŠ¡ DNS åœ¨å®˜æ–¹å»ºè®®çš„æ–¹æ¡ˆä¸­ä½¿ç”¨äº† å¤šé›†ç¾¤æœåŠ¡ DNS ï¼Œå¹¶æå‡ºäº† Kubernetes åŸºäº DNS çš„å¤šé›†ç¾¤æœåŠ¡å‘ç°è§„èŒƒ ç”¨äºæŒ‡å¯¼å¤šé›†ç¾¤æœåŠ¡ API çš„å®ç°ã€‚è¯¥è§„èŒƒå¯ä»¥è®¤ä¸ºæ˜¯ Kubernetes çš„åŸºäº DNS çš„æœåŠ¡å‘ç°è§„èŒƒ çš„æ‰©å±•ã€‚\nç®€å•æ¥è¯´ï¼Œè¯¥è§„èŒƒå¼•å…¥äº†æ–°çš„ DNS æœç´¢åŸŸ clusterset.localï¼Œåœ¨ DNS è§£æ \u0026lt;service\u0026gt;.\u0026lt;ns\u0026gt;.svc.clusterset.local æ—¶ï¼Œè¿”å› ServiceImport ä¸­çš„ IP åœ°å€ã€‚\nCoreDNS çš„ multicluster æ’ä»¶å®ç°äº†è¯¥é€»è¾‘ã€‚\nCoreDNS å¤šé›†ç¾¤æ’ä»¶ æ’ä»¶å¯ä»¥è¯´æ˜¯ CoreDNS ç²¾é«“ï¼Œå…¶æ’ä»¶å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼šæ ¸å¿ƒæ’ä»¶ å’Œ å¤–éƒ¨æ’ä»¶ï¼ˆExternal Pluginï¼‰ã€‚\næ ¸å¿ƒæ’ä»¶ï¼Œä¹Ÿå°±æ˜¯é€šå¸¸æ‰€è¯´çš„æ’ä»¶ï¼Œé»˜è®¤æ˜¯ç¼–è¯‘åœ¨ CoreDNS ä¸­çš„ï¼Œåªéœ€åœ¨ Corefile ä¸­æ·»åŠ é…ç½®å³å¯å¯ç”¨è¯¥æ’ä»¶ã€‚ å¤–éƒ¨æ’ä»¶ï¼Œä¸æ˜¯ CoreDNS é»˜è®¤æ”¯æŒçš„ï¼Œéœ€è¦ç¼–è¯‘æ—¶åŠ å…¥åˆ° CoreDNS ä¸­ã€‚ä¸‹é¢ä¼šè¯¦ç»†ä»‹ç»å¦‚ä½•å°†å¤–éƒ¨æ’ä»¶ç¼–è¯‘åˆ° CoreDNS ä¸­ã€‚ multicluster æ’ä»¶æ˜¯ä¼—å¤šå¤–éƒ¨æ’ä»¶ä¸­çš„ä¸€ä¸ªï¼Œå®ç°äº†åŸºäº DNS çš„å¤šé›†ç¾¤æœåŠ¡å‘ç°è§„èŒƒã€‚\nå·¥ä½œåŸç† multicluster æ’ä»¶åœ¨å¯åŠ¨æ—¶ åˆ›å»ºä¸€ä¸ªæ§åˆ¶å™¨ï¼Œç”¨äºç›‘æ§ ServiceImports èµ„æºï¼›åœ¨å¤„ç† DNS è§£æè¯·æ±‚é˜¶æ®µï¼Œåªå¤„ç† clusterset.local åŸŸçš„è§£æè¯·æ±‚ï¼šä»æ‰€æœ‰ ServiceImports èµ„æºä¸­ æ£€ç´¢å‡ºåŒ¹é…çš„ç»“æœï¼Œè¿”å›å…¶ä¸­çš„ IP åœ°å€ï¼Œç”šè‡³ç«¯å£ã€‚\næ¼”ç¤º ç¼–è¯‘ CoreDNS ä¿®æ”¹ plugin.cfgï¼Œæ·»åŠ ï¼š\n... kubernetes:kubernetes multicluster: github.com/coredns/multicluster ... æ‰§è¡Œå‘½ä»¤ make è¿›è¡Œç¼–è¯‘åï¼Œç„¶åæ‰§è¡Œå‘½ä»¤æ£€æŸ¥æ’ä»¶æ˜¯å¦ç¼–è¯‘æˆåŠŸï¼š\n./coredns --plugins | grep -A1 dns.minimal dns.minimal dns.multicluster åœ¨ç»“æœä¸­æˆ‘ä»¬æœ‰çœ‹åˆ° dns.multicluster è¯´æ˜é…ç½®éƒ½æˆåŠŸäº†ã€‚\næ¥ä¸‹æ¥å°±æ˜¯æ„å»ºå¤šå¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶äº†äº†ï¼š\nmake build -f Makefile.release å¯ä»¥å†æ£€æŸ¥ä¸‹ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä½¿ç”¨å¯¹åº”å¹³å°çš„ç‰ˆæœ¬ï¼Œæˆ‘è¿™é‡Œæ˜¯ Ubuntuï¼‰ï¼š\n./build/linux/amd64/coredns --plugins | grep -A1 mini dns.minimal dns.multicluster æ„å»ºé•œåƒ æ„å»ºé•œåƒä¹‹å‰è®°å¾—æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è°ƒæ•´ä¸‹æ–‡ä»¶ç›®å½•ï¼š\ncp -r build/linux build/docker for arch in amd64 arm arm64 mips64le ppc64le s390x; do cp Dockerfile build/docker/${arch} ; done; æ‰§è¡Œå‘½ä»¤æ„å»ºå¹¶æ¨é€é•œåƒï¼Œè¿™é‡Œ DOCKER=addozhang æ˜¯é•œåƒ repository åå­—ï¼ŒNAME=coredns-multicluster æ˜¯é•œåƒåï¼ŒæŒ‰ç…§ä¸‹é¢çš„é…ç½®æœ€ç»ˆæ„å»ºçš„é•œåƒæ˜¯ addozhang/coredns-multicluster:1.10.1ï¼š\nexport DOCKER_LOGIN=addozhang export DOCKER_PASSWORD=\u0026lt;pass\u0026gt; make docker-build docker-push DOCKER=addozhang NAME=coredns-multicluster VERSION=1.10.1 -f Makefile.docker æ›´æ–° CoreDNS å› ä¸ºè¿™æ¬¡æ¼”ç¤ºä¸ä¼šæ¶‰åŠ ServiceExportï¼Œå¯ä»¥åªéƒ¨ç½² ServiceImport CRDã€‚\nkubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/mcs-api/master/config/crd/multicluster.x-k8s.io_serviceimports.yaml ä¿®æ”¹äº† ClusterRole corednsï¼Œå¢åŠ  multicluster.x-k8s.io çš„ serviceimports èµ„æºçš„æ“ä½œæƒé™ã€‚\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: system:coredns rules: - apiGroups: - \u0026#34;\u0026#34; resources: - endpoints - services - pods - namespaces verbs: - list - watch - apiGroups: #add serviceimports resource verbs - multicluster.x-k8s.io resources: - serviceimports verbs: - get - list - watch - apiGroups: - \u0026#34;\u0026#34; resources: - nodes verbs: - get - apiGroups: - discovery.k8s.io resources: - endpointslices verbs: - list - watch EOF å°†é›†ç¾¤ CoreDNS çš„é•œåƒæ”¹ä¸ºä¸Šé¢æ„å»ºçš„é•œåƒï¼š\nkubectl patch deployment coredns -n kube-system -p \u0026#39;{\u0026#34;spec\u0026#34;:{\u0026#34;template\u0026#34;:{\u0026#34;spec\u0026#34;:{\u0026#34;containers\u0026#34;:[{\u0026#34;name\u0026#34;:\u0026#34;coredns\u0026#34;,\u0026#34;image\u0026#34;:\u0026#34;addozhang/coredns-multicluster:1.10.1\u0026#34;}]}}}}\u0026#39; åªæ›´æ–° CoreDNS è¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦ä¿®æ”¹ Corefileï¼Œæ·»åŠ  multicluster é…ç½®ã€‚\nkubectl apply -n kube-system -f - \u0026lt;\u0026lt;EOF apiVersion: v1 data: Corefile: | .:53 { errors health { lameduck 5s } ready multicluster clusterset.local kubernetes cluster.local in-addr.arpa ip6.arpa { pods insecure fallthrough in-addr.arpa ip6.arpa ttl 30 } prometheus :9153 forward . /etc/resolv.conf { max_concurrent 1000 } cache 30 loop reload loadbalance } kind: ConfigMap metadata: name: coredns namespace: kube-system EOF æµ‹è¯• æ‰‹åŠ¨åˆ›å»º ServiceImport èµ„æºï¼Œå°†æœåŠ¡åœ°å€é…ç½®ä¸ºæˆ‘æœ¬åœ°è¿è¡Œçš„ web æœåŠ¡ 192.168.1.174:8080ï¼Œæ¥æ¨¡æ‹Ÿå…¶ä»–é›†ç¾¤çš„æœåŠ¡ã€‚ç±»å‹è®¾ç½®ä¸º ClusterSetIPï¼š\napiVersion: multicluster.x-k8s.io/v1alpha1 kind: ServiceImport metadata: name: my-svc namespace: default spec: ips: - 192.168.1.174 type: \u0026#34;ClusterSetIP\u0026#34; ports: - name: http protocol: TCP port: 8080 sessionAffinity: None æ¥ä¸‹æ¥æµ‹è¯•ä¸‹å¤šé›†ç¾¤æœåŠ¡ DNS çš„è§£æï¼Œè¿è¡Œä¸€ä¸ª pod æ¥æ¨¡æ‹Ÿå®¢æˆ·ç«¯ï¼š\nkubectl run tmp-shell --rm -i --tty --image nicolaka/netshoot -n default æŸ¥è¯¢ my-svc.default.svc.clusterset.local çš„è§£æï¼Œæµ‹è¯• A è®°å½•å’Œ SRV è®°å½•çš„è§£æï¼š\ndig +short my-svc.default.svc.clusterset.local 192.168.1.174 dig +short SRV my-svc.default.svc.clusterset.local 0 100 8080 my-svc.default.svc.clusterset.local. åº”ç”¨ä¹Ÿå¯ä»¥æ­£å¸¸è®¿é—®ï¼š\ncurl my-svc.default.svc.clusterset.local:8080 Hi, there! æ€»ç»“ è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬é€šè¿‡ DNS è§£å†³äº†è·¨é›†ç¾¤çš„æœåŠ¡å‘ç°é—®é¢˜ï¼Œç›¸ä¿¡çœ‹åˆ°è¿™é‡Œå¤§å®¶ä¹Ÿå‘ç°äº† DNS æ–¹æ¡ˆçš„å¼Šç«¯ï¼š\nå¼•å…¥äº†æ–°çš„ DNS åŸŸ clusterset.localï¼Œéœ€è¦æ”¹åŠ¨åº”ç”¨ä»£ç ã€‚ ä¸¤ä¸ªé›†ç¾¤é—´çš„ç½‘ç»œè¦æ‰“é€šï¼Œå¯¹åº•å±‚çš„ç½‘ç»œæ¶æ„è¦æ±‚é«˜ï¼Œå¦‚æœæ¶‰åŠè·¨äº‘è·¨æ•°æ®ä¸­å¿ƒçš„è¯è¿™ä¸ªé—®é¢˜ä¼šæ›´åŠ æ˜æ˜¾ã€‚ å¤šé›†ç¾¤æœåŠ¡ DNS æ’ä»¶ç›®å‰è¿˜å±äº external pluginï¼Œè¿˜è¦åƒä¸Šé¢é‚£æ ·é‡æ–°ç¼–è¯‘ã€éƒ¨ç½² CoreDNS å…¶ä¸­ï¼Œç”±äºç›®å‰ KEP1645 è¿˜å¤„äºææ¡ˆé˜¶æ®µï¼Œå¾…æ­£å¼å‘å¸ƒä¹‹åï¼Œç›¸ä¿¡ #3 çš„é—®é¢˜å¾…æ’ä»¶è¿›å…¥æ ¸å¿ƒæ’ä»¶åˆ—è¡¨åå¯ä»¥è§£å†³ã€‚\nè€Œ #1 çš„é—®é¢˜ï¼Œå‡å¦‚å½“å‰åº”ç”¨å†…çš„ä»£ç ä¸­æ˜¯ä½¿ç”¨ NAME.NS çš„æ–¹å¼çš„è¯ï¼Œå¯ä»¥é€šè¿‡åœ¨ Pod /etc/resolv.conf å¢åŠ  clusterset.local æœç´¢åŸŸæ¥è§£å†³ã€‚ç”±äº Kubernetes é›†ç¾¤åªæ”¯æŒä¸€ä¸ª clusterDomainï¼Œåªèƒ½é€šè¿‡ pod.dnsConfig åœ¨æ·»åŠ æœç´¢åŸŸäº†ã€‚å•åˆä¼šæ¥å¦ä¸€ä¸ªé—®é¢˜ï¼šæœç´¢åŸŸçš„å¢åŠ åŠ¿å¿…å¸¦æ¥æ€§èƒ½çš„å¼€é”€ã€‚\nè¿™é‡Œ #2 çš„å¯èƒ½æœ€ä¸ºæ£˜æ‰‹ï¼Œéœ€è¦è°ƒæ•´åº•å±‚çš„ç½‘ç»œæ¶æ„ï¼Œä½¿ç”¨æ‰å¹³ç½‘ç»œæˆ–è€…å…¶ä»–å¦‚ vxlanã€éš§é“ç­‰æ–¹æ¡ˆã€‚\næˆ‘æ›¾ç»åœ¨å¦ä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»è¿‡ä½¿ç”¨ 7 å±‚ç½‘ç»œè§£å†³ #2 çš„ç½‘ç»œäº’é€šé—®é¢˜ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹ è¿™ç¯‡ã€‚\nä¸çŸ¥é“ä½ æ˜¯å¦æœ‰æ›´å¥½çš„æ–¹æ¡ˆï¼Ÿæ¬¢è¿ç•™è¨€è®¨è®ºã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/07/17/pexels-kaique-rocha-57645.jpg","permalink":"https://atbug.com/multi-cluster-service-with-coredns/","tags":["å¤šé›†ç¾¤","CoreDNS","Kubernetes"],"title":"CoreDNS ä¸å¤šé›†ç¾¤æœåŠ¡ MCS"},{"categories":["ç¬”è®°"],"contents":"åœ¨è¿‡å»çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ›¾ è¿½è¸ªè¿‡ Kubernetes ä¸­çš„ç½‘ç»œæ•°æ®åŒ…ï¼Œè¿™ç¯‡æ–‡ç« å°†è¿½è¸ª Kubernetes ä¸­çš„ DNS æŸ¥è¯¢ã€‚\nè®©æˆ‘ä»¬ä»¥åœ¨ Pod ä¸­è§£æ Service å®Œå…¨é™å®šåŸŸåï¼ˆFQDNï¼‰ foo.bar.svc.cluster.local ä¸ºä¾‹ã€‚\nåœ¨å¼€å§‹ä¹‹å‰ï¼Œå…ˆå›é¡¾ä¸‹ DNS çš„è§£ææµç¨‹ã€‚\nDNS çš„è§£ææµç¨‹ ç®€åŒ–ç‰ˆçš„ DNS å¤„ç†æµç¨‹ï¼š\nDNS å®¢æˆ·ç«¯ï¼ˆå¦‚æµè§ˆå™¨ã€åº”ç”¨ç¨‹åºæˆ–è€…è®¾å¤‡ï¼‰å‘é€åŸŸå example.com çš„æŸ¥è¯¢è¯·æ±‚ã€‚ DNS è§£æå™¨æ”¶åˆ°è¯·æ±‚ï¼ŒæŸ¥è¯¢æœ¬åœ°ç¼“å­˜ï¼Œå¦‚æœæœ¬åœ°æœ‰è®°å½•ä¸”æœªè¿‡æœŸä¼šè¿”å›æœ¬åœ°çš„è®°å½•ã€‚ å¦‚æœæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼ŒDNS è§£æå™¨å°†ä» DNS æ ¹æœåŠ¡å™¨å¼€å§‹å‘ä¸‹æŸ¥è¯¢ï¼Œé¦–å…ˆæ˜¯é¡¶çº§åŸŸåï¼ˆTop Level Domain, TLDï¼‰ DNS æœåŠ¡å™¨ï¼ˆè¿™é‡Œæ˜¯ .comï¼‰ï¼Œä¸€ç›´å‘ä¸‹ç›´åˆ°å¯ä»¥è§£æ example.com çš„æœåŠ¡å™¨ã€‚ èƒ½å¤Ÿè§£æ example.com çš„æœåŠ¡å™¨æˆä¸ºæƒå¨ DNS åç§°æœåŠ¡å™¨ï¼ˆAuthoritative DNS name serverï¼‰ï¼Œè§£æå™¨è®¿é—®è¯¥æœåŠ¡å™¨å¹¶æ”¶åˆ° IP åœ°å€ç­‰ç›¸å…³ä¿¡æ¯ï¼Œç„¶åè¿”å›ç»™ç»™å®¢æˆ·ç«¯ã€‚è§£æå®Œæˆã€‚ ä»æµç¨‹æ¥çœ‹éå¸¸é‡è¦çš„ä¸€é¡¹é…ç½®å°±æ˜¯ä¸Šæ¸¸ DNS æœåŠ¡å™¨ï¼Œè¯¥é…ç½®ä½äº Pod ä¸­ã€‚è¿™é‡Œ Kubernetes çš„é›†ç¾¤ DNS æœåŠ¡å™¨æ­£æ˜¯æ‰®æ¼”ä¸Šæ¸¸ DNS æœåŠ¡å™¨çš„è§’è‰²ï¼Œæ¯”å¦‚ kube-dnsã€CoreDNSï¼ŒäºŒè€…å‡å®ç°äº† Kubernetes çš„åŸºäº DNS çš„æœåŠ¡å‘ç°è§„èŒƒã€‚å¯¹ CoreDNS æ„Ÿå…´è¶£çš„ï¼Œå¯ä»¥å‚è€ƒä¸Šä¸€ç¯‡æ–‡ç«  æµ…æ CoreDNS çš„å·¥ä½œæœºåˆ¶ã€‚\nPod DNS é…ç½® åœ¨ è§£æ kubelet æºç  ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬æ›¾åˆ†æäº† kubelet åˆ›å»º pod çš„æµç¨‹ã€‚kubelet åˆ›å»º pod sandbox é…ç½®æ—¶ ï¼Œå…¶ä¸­é‡è¦çš„ä¸€é¡¹é…ç½®å°±æ˜¯å‡†å¤‡ pod çš„ DNS é…ç½®ï¼ˆPod çš„ DNS é…ç½®ç”± pod çš„ dnsPolicy å’Œ dnsConfig å­—æ®µè¿›è¡Œæ“ä½œï¼Œè¿™é‡Œä¸å±•å¼€ï¼Œä¸‹é¢çš„éƒ¨åˆ†æŒ‰ç…§ dnsPolicy=ClusterFirst æƒ…å†µè¿›è¡Œè¯´æ˜ï¼‰ã€‚\né…ç½®çš„å†…å®¹åŒ…æ‹¬å¦‚ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼š\nDNS æœåŠ¡å™¨ nameserverï¼šæ¥è‡ª kubelet é…ç½®ï¼ˆé€šå¸¸ä½äº /var/lib/kubelet/config.yamlï¼‰çš„ clusterDNS å­—æ®µ æœç´¢åŸŸ searchï¼šåŒ…å«å››ç§åŸŸï¼šå‘½åç©ºé—´åŸŸã€æœåŠ¡åŸŸã€é›†ç¾¤åŸŸï¼Œä»¥åŠèŠ‚ç‚¹ /etc/resolv.conf ä¸­å®šä¹‰çš„æœç´¢åŸŸã€‚é›†ç¾¤åŸŸæ¥è‡ª kubelet é…ç½®çš„ clusterDomain å­—æ®µï¼Œé»˜è®¤ä¸º cluster.localï¼›å‘½åç©ºé—´åŸŸ NS.svc.cluster.localï¼›æœåŠ¡åŸŸ svc.cluster.local é€‰é¡¹ optionsï¼šé»˜è®¤ä¸º ndots:5 ç„¶å kubelet è°ƒç”¨ CRI æ¥å£åˆ›å»ºå®¹å™¨ï¼Œç”± CRI çš„å®ç°å°† DNS é…ç½®å†™å…¥åˆ°å®¹å™¨æ–‡ä»¶ï¼ˆé»˜è®¤åœ°å€ /etc/resolv.confï¼‰ä¸­ï¼Œå¦‚ Containerd çš„ pkg/cri/server/sandbox_run_linux.go#L272ã€‚\næˆ‘ä»¬æŸ¥çœ‹å‘½åç©ºé—´ default ä¸‹æŸä¸ª pod çš„ DNS é…ç½®ï¼š\ncat /etc/resolv.conf search default.svc.cluster.local svc.cluster.local cluster.local nameserver 10.96.0.10 options ndots:5 è¿™é‡Œçš„ nameserver æ­£æ˜¯ Service kube-dns çš„ cluster IP åœ°å€ï¼Œä¹Ÿå°±æ˜¯é›†ç¾¤çš„ DNS æœåŠ¡å™¨ï¼Œå³ dnsPolicy=ClusterFirst çš„ç»“æœã€‚\nsearch ä¸ ndots search ç”¨äºæŒ‡å®šé»˜è®¤çš„æœç´¢åŸŸã€‚å½“ä½ åœ¨ä½¿ç”¨ä¸å®Œå…¨é™å®šåŸŸåï¼ˆä¾‹å¦‚ï¼Œåªæä¾›ä¸»æœºåè€Œæ²¡æœ‰åŸŸåï¼‰è¿›è¡ŒåŸŸåè§£ææ—¶ï¼Œç³»ç»Ÿä¼šå°è¯•åœ¨æœç´¢åŸŸä¸­æ‰¾åˆ°åŒ¹é…çš„å®Œå…¨é™å®šåŸŸåã€‚æœç´¢åŸŸæŒ‰ç…§å‡ºç°çš„é¡ºåºè¿›è¡Œæœç´¢ï¼Œç›´åˆ°æ‰¾åˆ°åŒ¹é…çš„åŸŸåæˆ–æœç´¢å®Œæ‰€æœ‰çš„åŸŸåã€‚\nndots ç”¨äºæŒ‡å®šåœ¨è¿›è¡ŒåŸŸåè§£ææ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨æ·»åŠ åŸŸåçš„ç‚¹å·ä¸ªæ•°é˜ˆå€¼ã€‚å½“æä¾›çš„åŸŸåä¸­ç‚¹å·çš„ä¸ªæ•°è¾¾åˆ°æˆ–è¶…è¿‡è¿™ä¸ªé˜ˆå€¼æ—¶ï¼Œç³»ç»Ÿä¼šå°†å…¶è§†ä¸ºå®Œå…¨é™å®šåŸŸåï¼Œè€Œä¸å†ä½¿ç”¨æœç´¢åŸŸè¿›è¡Œæœç´¢ã€‚é»˜è®¤ä¸º 1ï¼Œè¿™é‡Œå°†å…¶è®¾ç½®ä¸º 5ã€‚\næ³¨ï¼šndots çš„å€¼å¤§å°ä¼šå½±å“ DNS è§£æçš„æ€§èƒ½ï¼Œä¸ºäº†è·å¾—è¾ƒå¥½çš„æ€§èƒ½ï¼Œå»ºè®®ä½¿ç”¨ FQDN è¿›è¡ŒæœåŠ¡è®¿é—®ï¼Œä»¥åŠå°† ndots æ”¹ä¸ºæ›´å°çš„å€¼ã€‚\nPod DNS è§£æ å½“åœ¨ Pod ä¸­æ‰§è¡Œ DNS è§£ææ—¶ï¼ŒæŸ¥è¯¢è¯·æ±‚è¢«å‘åˆ°æœ¬åœ°ï¼ˆpod ä¸­ï¼‰çš„ DNS è§£æå™¨ã€‚è¿™ä¸ªè§£æå™¨å…ˆåœ¨ç¼“å­˜ä¸­æŸ¥è¯¢ï¼Œå¦‚æœæœªå‘½ä¸­ï¼Œåˆ™ä¼šæ ¹æ® /etc/resolv.conf ä¸­çš„é…ç½®ï¼Œå°†è¯·æ±‚å‘åˆ°ä¸Šæ¸¸çš„ DNS æœåŠ¡å™¨ï¼Œå³é›†ç¾¤ DNS æœåŠ¡å™¨ 10.96.0.10 å®ŒæˆåŸŸåè§£æã€‚\næ ¹æ®å‰é¢çš„ä»‹ç»ï¼Œå‡å¦‚æˆ‘ä»¬è¦è§£æçš„åŸŸåæ˜¯ foo.barï¼Œä¼šä¾æ¬¡è¿›è¡Œå¦‚ä¸‹çš„æŸ¥è¯¢ï¼š\nfoo.bar.default.svc.cluster.local foo.bar.svc.cluster.localï¼ˆåŒ¹é…åˆ°ç»“æœï¼‰ å½“æˆ‘ä»¬ä½¿ç”¨ foo.barã€foo.bar.svc éƒ½å¯ä»¥å®Œæˆè§£æï¼Œä½† foo.bar.svc.cluster ä¸è¡Œï¼Œå› ä¸ºè¿½åŠ äº†æœç´¢åŸŸåæ— æ³•åŒ¹é…åˆ°ç»“æœã€‚å‡å¦‚è¯·æ±‚æ–¹ä¸ç›®æ ‡æœåŠ¡åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹ï¼Œåªç”¨ foo ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/07/15/pexels-kamil-5408541.jpg","permalink":"https://atbug.com/tracing-dns-queries-in-kubernetes/","tags":["DNS","Kubernetes"],"title":"è¿½è¸ª Kubernetes ä¸­çš„ DNS æŸ¥è¯¢"},{"categories":["ç¬”è®°"],"contents":"CoreDNS æ˜¯ä¸€ä¸ªå¼€æºçš„åŸŸåç³»ç»Ÿï¼ˆDNSï¼‰æœåŠ¡å™¨ï¼Œç”¨äºå°†åŸŸåè§£æä¸º IP åœ°å€ä»¥å®ç°ç½‘ç»œé€šä¿¡ã€‚å®ƒæ˜¯ä¸€ä¸ªç”¨ Go è¯­è¨€ç¼–å†™çš„å¯æ‰©å±• DNS æœåŠ¡å™¨ï¼Œæ—¨åœ¨å–ä»£ä¼ ç»Ÿçš„ DNS æœåŠ¡å™¨å¹¶æä¾›æ›´çµæ´»ã€å¯é…ç½®çš„è§£ææ–¹æ¡ˆã€‚\nCoreDNS æä¾›äº†æ¨¡å—åŒ–çš„æ’ä»¶ç³»ç»Ÿï¼Œå…è®¸ç”¨æˆ·æ ¹æ®éœ€æ±‚é€‰æ‹©å’Œç»„åˆæ’ä»¶ï¼Œä»¥å®šåˆ¶ DNS æœåŠ¡å™¨çš„åŠŸèƒ½å’Œè¡Œä¸ºã€‚é€šè¿‡æ·»åŠ ä¸åŒçš„æ’ä»¶ï¼Œç”¨æˆ·å¯ä»¥å®ç°ç¼“å­˜ã€è½¬å‘ã€é‡å†™ã€ç­–ç•¥è·¯ç”±ã€æœåŠ¡å‘ç°ç­‰åŠŸèƒ½ï¼Œä»è€Œæ»¡è¶³å„ç§å¤æ‚çš„åŸŸåè§£æéœ€æ±‚ã€‚\næ’ä»¶ç”±è®¾ç½®ï¼ˆSetupï¼‰ã€**æ³¨å†Œï¼ˆRegistrationï¼‰å’Œå¤„ç†ç¨‹åºï¼ˆHandlerï¼‰**éƒ¨åˆ†ç»„æˆã€‚\nSetup ç¨‹åºè§£æé…ç½®å’Œæ’ä»¶çš„æŒ‡ä»¤ã€‚ Handler æ˜¯å¤„ç†æŸ¥è¯¢å¹¶å®ç°æ‰€æœ‰é€»è¾‘çš„ä»£ç ã€‚ Registration æ˜¯åœ¨ CoreDNS ä¸­æ³¨å†Œæ’ä»¶ - è¿™åœ¨ç¼–è¯‘ CoreDNS æ—¶å®Œæˆã€‚æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨æ‰€æœ‰æ³¨å†Œçš„æ’ä»¶ï¼Œæ¯ä¸ªæœåŠ¡å™¨ä¸­é…ç½®å“ªäº›æ’ä»¶çš„å†³å®šåœ¨è¿è¡Œæ—¶è¿›è¡Œï¼Œå¹¶åœ¨ CoreDNS çš„é…ç½®æ–‡ä»¶ Corefile ä¸­å®Œæˆã€‚ å®‰è£…è¿è¡Œ åœ¨ macOS ä¸Šå®‰è£… CoreDNSï¼š\nbrew install coredns å¯ä»¥æ‰§è¡Œ coredns -plugins æ¥æŸ¥çœ‹å·²ç»å®‰è£…çš„æ’ä»¶ï¼š\ncoredns -plugins Server types: dns Caddyfile loaders: flag default Other plugins: dns.acl dns.any dns.auto dns.autopath dns.azure dns.bind dns.bufsize dns.cache dns.cancel dns.chaos dns.clouddns dns.debug dns.dns64 dns.dnssec dns.dnstap dns.erratic dns.errors dns.etcd dns.file dns.forward dns.geoip dns.grpc dns.header dns.health dns.hosts dns.k8s_external dns.kubernetes dns.loadbalance dns.local dns.log dns.loop dns.metadata dns.minimal dns.nsid dns.pprof dns.prometheus dns.ready dns.reload dns.rewrite dns.root dns.route53 dns.secondary dns.sign dns.template dns.tls dns.trace dns.transfer dns.tsig dns.view dns.whoami on CoreDNS çš„è¿è¡Œéå¸¸ç®€å•ï¼Œæ‰§è¡Œ coredns å‘½ä»¤å³å¯å¯åŠ¨æœåŠ¡å™¨ã€‚ä¸ºäº†é¿å…ç«¯å£å†²çªï¼Œå¯ä»¥æŒ‡å®šå…¶ä»–çš„ç«¯å£å¯åŠ¨ï¼š\ncoredns -dns.port=1053 .:1053 CoreDNS-1.10.0 darwin/arm64, go1.19.1, å¦‚æœéœ€è¦å¯¹ DNS æœåŠ¡å™¨è¿›è¡Œé…ç½®ï¼Œéœ€è¦é€šè¿‡ -conf æŒ‡å®šä¸€ä¸ª Corefile é…ç½®æ–‡ä»¶ï¼Œè¿˜å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨æ’ä»¶ã€‚ä¸æŒ‡å®šé…ç½®æ–‡ä»¶çš„è¯ï¼ŒCoreDNS ä¼šä½¿ç”¨ é»˜è®¤çš„é…ç½®ï¼Œä»…å¯ç”¨ whoami å’Œ log ä¸¤ä¸ªæ’ä»¶ï¼š\n.:PORT { whoami log } æ¯”å¦‚æˆ‘ä»ä¸€å°è™šæ‹Ÿæœºä¸Šæ‰§è¡Œ DNS çš„è§£æè¯·æ±‚ï¼Œ192.168.1.174 æ˜¯è¿è¡Œ CoreDNS æœåŠ¡å™¨çš„ macOS åœ°å€ï¼š\ndig @192.168.1.174 -p 1053 example.com ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.16.1-Ubuntu \u0026lt;\u0026lt;\u0026gt;\u0026gt; @192.168.1.174 -p 1053 example.com ; (1 server found) ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 1283 ;; flags: qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 3 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: d73ad3e9df490541 (echoed) ;; QUESTION SECTION: ;example.com.\tIN\tA ;; ADDITIONAL SECTION: example.com.\t0\tIN\tA\t192.168.1.11 _udp.example.com.\t0\tIN\tSRV\t0 0 48788 . ;; Query time: 8 msec ;; SERVER: 192.168.1.174#1053(192.168.1.174) ;; WHEN: Sat Jul 15 02:38:11 UTC 2023 ;; MSG SIZE rcvd: 114 åœ¨å“åº”çš„ ADDITIONAL ä¸­å¯ä»¥çœ‹åˆ° example.com è§£æåˆ°äº† 192.168.1.11ï¼Œè€Œè¿™ä¸ªåœ°å€åˆ™æ˜¯å‘èµ·è¯·æ±‚çš„è™šæ‹Ÿæœºçš„ IP åœ°å€ã€‚è¿™å°±æ˜¯ whoami æ’ä»¶çš„ é€»è¾‘ï¼š\nwhoami ä¼šè¿”å›è¯·æ±‚æ–¹çš„æœ¬åœ° IP åœ°å€ã€ç«¯å£ã€‚\næºç è§£æ å¯åŠ¨ Coredns ä½¿ç”¨ fork è‡ª Caddy çš„ Coredns Caddy å¯åŠ¨ DNS æœåŠ¡å™¨ã€‚\nåŠ è½½æŒ‡å®šçš„ Corefile é…ç½®æ–‡ä»¶ï¼Œå¦‚ /etc/coredns/Corefile coremain/run.go#L60 å¯åŠ¨ Caddy Server coremain/run.go#L66 è¿è¡Œæ’ä»¶ 1. æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„æ’ä»¶ã€‚Coredns æœ‰ä¸€ä¸ªæ”¯æŒçš„ æ’ä»¶åˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨ä¸­æ’ä»¶çš„é¡ºåºéå¸¸é‡è¦ã€‚ 2. ä¸ºå„æ’ä»¶åˆ›å»ºæ§åˆ¶å™¨ï¼ˆControllerï¼‰ 3. æ‰¾åˆ°æ’ä»¶æ³¨å†Œçš„å¯åŠ¨æ–¹æ³• setupï¼Œå¦‚ Kubernetes æ’ä»¶çš„ setup æ–¹æ³•ã€‚å„æ’ä»¶çš„ setup æ–¹æ³•éƒ½å¯ä»¥åœ¨ coredns/plugin/[PLUGIN NAME]/setup.go ä¸­æ‰¾åˆ°ã€‚ 4. å¯åŠ¨æ’ä»¶ã€‚ åˆ›å»ºæœåŠ¡å™¨ core/dnsserver/register.go#L134 å¯åŠ¨æœåŠ¡å™¨ github.com/coredns/caddy@v1.1.1/caddy.go:542 å¤„ç†è¯·æ±‚ æœåŠ¡å™¨å¯åŠ¨ä¹‹åå¼€å§‹æ¥æ”¶ DNS çš„è§£æè¯·æ±‚ï¼Œè§ github.com/coredns/caddy@v1.1.1/caddy.go:805ã€‚ å¤„ç† DNS è§£æè¯·æ±‚ core/dnsserver/server.go#L173ï¼Œè¿™é‡Œä¼šè°ƒç”¨ æ–¹æ³• ServeDNS æŒ‰é¡ºåºæ‰§è¡Œé…ç½®çš„æ’ä»¶ï¼Œæ‰€æœ‰æ’ä»¶éƒ½å®ç°äº† plugin.Handler æ¥å£ã€‚ é…ç½®çš„æ¯ä¸ªæ’ä»¶ä¼šå†³å®šæ˜¯å¦æ‰§è¡Œ DNS çš„è§£æï¼Œä»¥åŠä¸‹ä¸€æ­¥çš„æ“ä½œï¼šè¿”å›å“åº”ã€æŠ¥é”™ã€ç«‹å³è¿”å›ï¼Œäº¦æˆ–æ˜¯è°ƒç”¨ä¸‹ä¸€ä¸ªæ’ä»¶ç»§ç»­æ‰§è¡Œã€‚è¯¦ç»†å†…å®¹ï¼Œçœ‹å‚è€ƒ å®˜æ–¹æ–‡æ¡£ã€‚\nCoreDNS ä¸ Kubernetes CoreDNS åœ¨ Kubernetes ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ï¼Œä¸ºé›†ç¾¤å†…éƒ¨çš„ DNS è§£ææä¾›æœåŠ¡ã€‚é€šè¿‡ä¸ Kubernetes çš„ç´§å¯†é›†æˆï¼ŒCoreDNS èƒ½å¤Ÿæä¾›å¯é çš„æœåŠ¡å‘ç°å’Œé€šä¿¡åŠŸèƒ½ï¼Œä½¿å¾—å®¹å™¨å’ŒæœåŠ¡èƒ½å¤Ÿé€šè¿‡åŸŸåè¿›è¡Œäº’ç›¸è®¿é—®å’Œé€šä¿¡ï¼Œä¸º Kubernetes é›†ç¾¤çš„è¿è¡Œæä¾›äº†åŸºç¡€è®¾æ–½æ”¯æŒã€‚\næ‰€æœ‰åŠŸèƒ½çš„å®ç°ï¼Œéƒ½åœ¨ kubernetes æ’ä»¶ ä¸­ï¼Œè¯¥æ’ä»¶å®ç°äº† Kubernetes çš„åŸºäº DNS çš„æœåŠ¡å‘ç°è§„èŒƒï¼ŒCoreDNS ä»¥æ­¤æ¥æ›¿ä»£ kube-dnsã€‚\nCoreDNS åœ¨ Kubernetes ä¸­çš„é…ç½®ï¼ˆç»´æŠ¤åœ¨ ConfigMap coredns ä¸­ï¼‰ï¼š\n.:53 { errors health { lameduck 5s } ready kubernetes cluster.local in-addr.arpa ip6.arpa { pods insecure fallthrough in-addr.arpa ip6.arpa ttl 30 } prometheus :9153 forward . /etc/resolv.conf { max_concurrent 1000 } cache 30 loop reload loadbalance } CoreDNS åœ¨å¤„ç†è§£æè¯·æ±‚æ—¶ï¼Œä¼šæŒ‰é¡ºåºæ‰§è¡Œå„ä¸ªæ’ä»¶ã€‚\næ’ä»¶é…ç½® kubernetes cluster.local in-addr.arpa ip6.arpa { #1 pods insecure #2 fallthrough in-addr.arpa ip6.arpa #3 ttl 30 #4 } #1 kubernetes æ’ä»¶ä¼šå¤„ç† cluster.local åŸŸçš„ DNS è§£æè¯·æ±‚ï¼Œå¦‚ foo.bar.svc.cluster.localï¼›in-addr.arpa å’Œ ip6.arpa ç”¨äºåš DNS åå‘æŸ¥è¯¢ï¼Œå¦‚ 4.4.8.8.in-addr.arpaã€‚ #2 å°† POD åŸŸåï¼ˆå¦‚ 10-244-0-2.bar.pod.cluster.localï¼‰çš„è§£ææ¨¡å¼è®¾ç½®ä¸º insecureï¼Œè¿˜æ”¯æŒ disabled å’Œ verified å¦å¤–ä¸¤ç§æ¨¡å¼ã€‚ #3 å¯¹äºåå‘æŸ¥è¯¢çš„è§£æè¯·æ±‚ï¼Œä¼šäº¤ç»™å…¶ä»–æ’ä»¶ç»§ç»­æŸ¥è¯¢ã€‚ #4 è§£æç»“æœçš„æœ‰æ•ˆæœŸï¼Œé»˜è®¤æ˜¯ 5sï¼Œè¿™é‡Œè®¾ç½®ä¸º 30sã€‚ å¯åŠ¨ CoreDNS å¯åŠ¨æ—¶ä¼šå»¶è¿Ÿæœ€å¤š 5 ç§’æä¾› DNS æœåŠ¡ï¼Œç›´åˆ°å¯ä»¥è¿æ¥åˆ° Kubernetes API å¹¶åŒæ­¥æ‰€æœ‰ç›‘æ§çš„å¯¹è±¡ï¼Œè§ æ–‡æ¡£ã€‚\nkubernetes æ’ä»¶å°†æ ¹æ®é…ç½® æœ€å¤šå¯åŠ¨ 4 ä¸ªæ§åˆ¶å™¨ï¼Œåˆ†åˆ«æŒç»­ç›‘æ§ Serviceã€Podï¼ˆè§£ææ¨¡å¼è®¾ç½®ä¸º verified æ—¶å¯åŠ¨ï¼‰ã€Endpointã€Namespace èµ„æºï¼Œç»´æŠ¤æœ¬åœ°ç¼“å­˜ã€‚\nå¤„ç†è¯·æ±‚ kubernetes æ’ä»¶å®ç°äº† plugin.ServiceBackend æ¥å£ï¼Œå“åº”è¯·æ±‚æ—¶ä»æœ¬åœ°ç¼“å­˜ä¸­æŸ¥æ‰¾è®°å½•ã€‚\nä»¥ A è®°å½•çš„æŸ¥è¯¢ä¸ºä¾‹ï¼Œè°ƒç”¨ plugin#A æ–¹æ³• é—´æ¥è°ƒç”¨ ServiceBackend#Services æ–¹æ³•çš„å®ç° è¿›è¡Œæ£€ç´¢ï¼Œè¿”å› IP åœ°å€ã€‚\nnslookup -type=a foo.bar.svc.cluster.local Server:\t10.96.0.10 Address:\t10.96.0.10:53 Name:\tfoo.bar.svc.cluster.local Address: 10.96.60.147 ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/07/15/pexels-flo-maderebner-869258.jpg","permalink":"https://atbug.com/analysis-of-the-working-mechanism-of-coredns/","tags":["Kubernetes","DNS","CoreDNS"],"title":"æµ…æ CoreDNS çš„å·¥ä½œæœºåˆ¶"},{"categories":["ç¬”è®°"],"contents":"è¿˜è®°å¾—åœ¨ ä½¿ç”¨ Cilium å¢å¼º Kubernetes ç½‘ç»œå®‰å…¨ ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è®¾ç½®ç½‘ç»œç­–ç•¥é™åˆ¶é’›æˆ˜æœºÂ tiefighter è®¿é—®æ­»æ˜Ÿ deathstar çš„ /v1/exhaust-port ç«¯ç‚¹ï¼Œä½†æ”¾è¡Œç€é™†è¯·æ±‚ /v1/request-landingã€‚åœ¨æèµ· Cilium æ—¶ï¼Œéƒ½è¯´å…¶æ˜¯ä½¿ç”¨ eBPF æŠ€æœ¯æ¨åŠ¨çš„ç”¨äºæä¾›ã€ä¿æŠ¤å’Œè§‚å¯Ÿå®¹å™¨å·¥ä½œè´Ÿè½½ä¹‹é—´çš„ç½‘ç»œè¿æ¥çš„å¼€æºè½¯ä»¶ã€‚eBPF å¯ä»¥å¤„ç† L3/4 çš„æ•°æ®åŒ…ï¼Œä½†æ˜¯å¯¹å¤æ‚çš„ L7 çš„åè®®å¤„ç†çš„æˆæœ¬æ¯”è¾ƒé«˜ï¼Œå¹¶ä¸”æ— æ³•åº”å¯¹ L7 åè®®ç­–ç•¥çš„çµæ´»æ€§ã€‚Cilium å¼•å…¥ Envoy Proxyï¼ˆCilium å®šåˆ¶çš„å‘è¡Œç‰ˆï¼‰ä½œä¸º L7 ä»£ç†ï¼Œæ¥å¤„ç†è¯¥åœºæ™¯ã€‚\né‚£ Cilium æ˜¯å¦‚ä½•å¤„ç† L7 æµé‡çš„å‘¢ï¼Ÿä»Šå¤©å°±è®©æˆ‘ä»¬ä¸€æ¢ç©¶ç«Ÿã€‚\næ³¨ï¼Œè¿™ç¯‡çš„å†…å®¹æ˜¯åŸºäºç›®å‰æœ€æ–°çš„ Cilium 1.13.3 å’Œ proxy 1.23.9ï¼Œä¸åŒç‰ˆæœ¬é—´ä¼šæœ‰å·®å¼‚ã€‚\nåœ¨å¼€å§‹ä¹‹å‰å…ˆæ­å»ºå…ˆå‰çš„â€œæ˜Ÿçƒå¤§æˆ˜â€ç¯å¢ƒï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥ç›´æ¥è·³åˆ° Debug é˜¶æ®µã€‚\nç¯å¢ƒæ­å»º é›†ç¾¤ export INSTALL_K3S_VERSION=v1.27.1+k3s1 curl -sfL https://get.k3s.io | sh -s - --disable traefik --disable local-storage --disable metrics-server --disable servicelb --flannel-backend=none --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config å®‰è£… Cilium CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/master/stable.txt) CLI_ARCH=amd64 if [ \u0026#34;$(uname -m)\u0026#34; = \u0026#34;aarch64\u0026#34; ]; then CLI_ARCH=arm64; fi curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum} sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum} cilium install å®‰è£…ç¤ºä¾‹åº”ç”¨ kubectl apply -n default -f - \u0026lt;\u0026lt;EOF apiVersion: v1 kind: Service metadata: name: deathstar labels: app.kubernetes.io/name: deathstar spec: type: ClusterIP ports: - port: 80 selector: org: empire class: deathstar --- apiVersion: apps/v1 kind: Deployment metadata: name: deathstar labels: app.kubernetes.io/name: deathstar spec: replicas: 1 selector: matchLabels: org: empire class: deathstar template: metadata: labels: org: empire class: deathstar app.kubernetes.io/name: deathstar spec: containers: - name: deathstar image: docker.io/cilium/starwars --- apiVersion: v1 kind: Pod metadata: name: tiefighter labels: org: empire class: tiefighter app.kubernetes.io/name: tiefighter spec: containers: - name: spaceship image: docker.io/tgraf/netperf --- apiVersion: v1 kind: Pod metadata: name: xwing labels: app.kubernetes.io/name: xwing org: alliance class: xwing spec: containers: - name: spaceship image: docker.io/tgraf/netperf EOF è®¾ç½®ç­–ç•¥ kubectl apply -n default -f - \u0026lt;\u0026lt;EOF apiVersion: \u0026#34;cilium.io/v2\u0026#34; kind: CiliumNetworkPolicy metadata: name: \u0026#34;rule1\u0026#34; spec: description: \u0026#34;L7 policy to restrict access to specific HTTP call\u0026#34; endpointSelector: matchLabels: org: empire class: deathstar ingress: - fromEndpoints: - matchLabels: org: empire toPorts: - ports: - port: \u0026#34;80\u0026#34; protocol: TCP rules: http: - method: \u0026#34;POST\u0026#34; path: \u0026#34;/v1/request-landing\u0026#34; EOF æµ‹è¯• kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port #Access denied kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing #Ship landed æŸ¥çœ‹ pod ä¿¡æ¯ã€‚\nkubectl get po -o wide -n default NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES deathstar-7848d6c4d5-58jc8 1/1 Running 0 6h57m 10.0.0.111 ubuntu-dev3 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; xwing 1/1 Running 0 6h57m 10.0.0.209 ubuntu-dev3 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; tiefighter 1/1 Running 0 6h57m 10.0.0.123 ubuntu-dev3 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; åé¢ debug çš„æ“ä½œæˆ‘ä»¬ä¼šç›´æ¥åœ¨ cilium çš„ agent pod è¿›è¡Œã€‚\nagent=$(kubectl get po -l app.kubernetes.io/name=cilium-agent -n kube-system -o jsonpath=\u0026#39;{.items[0].metadata.name}\u0026#39;) Debug å…ˆè´´ä¸Šæ€»ç»“çš„å›¾ã€‚\næ€ä¹ˆä¸‹æ‰‹å‘¢ï¼Ÿ\nåœ¨ æ·±å…¥æ¢ç´¢ Cilium çš„å·¥ä½œæœºåˆ¶ æ—¶ï¼Œæˆ‘ä»¬å¯¹ Cilium çš„ç½‘ç»œç­–ç•¥å¤„ç†æœºåˆ¶ä¸€ç¬”å¸¦è¿‡ï¼š\nCilium Agent ä¸­è¿è¡Œç€å¤§é‡çš„ watcherï¼Œå…¶ä¸­ä¸€ä¸ªå°±æ˜¯ CiliumNetworkPolicy watcherã€‚å½“ç­–ç•¥åˆ›å»ºæˆ–è€…æ›´æ–°æ—¶ï¼ŒAgent ä¼šå¯¹ç­–ç•¥è¿›è¡Œè½¬æ¢å¹¶å°†è§„åˆ™å­˜å‚¨åˆ° BPF Map ä¸­ã€‚åœ¨ç½‘ç»œé€šä¿¡æ—¶ï¼ŒBPF ç¨‹åºä¼šå¯¹ç½‘ç»œæµé‡è¿›è¡Œæ£€æŸ¥å¹¶å†³å®šåº”å½“å…è®¸æˆ–è€…æ‹’ç»è®¿é—®ã€‚\nå®é™…ä¸Šè¿™é‡Œçš„å¤„ç†æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä» watcher çš„åˆå§‹åŒ–å…¥æ‰‹ã€‚\n#enableK8sWatchers å¼€å¯ä¸€äº›åˆ—çš„ watcher #ciliumNetworkPoliciesInit å¼€å¯ CiliumNetworkPolicy watcher #addCiliumNetworkPolicyV2 æ·»åŠ  CiliumNetworkPolicy çš„å¤„ç† #PolicyAdd å°†è§„åˆ™å†™å…¥ Daemon çš„ç­–ç•¥ä»“åº“ä¸­ï¼Œå®é™…å‘ PolicyAddEvent åˆ° repository-change-queue é˜Ÿåˆ—ä¸­ã€‚ #policyAdd å¯¹è§„åˆ™è¿›è¡Œé¢„å¤„ç†ï¼Œå¹¶æ”¶é›†ä¸è§„åˆ™ç›¸å…³çš„ endpointï¼ˆéœ€è¦é‡æ–°ç”Ÿæˆ endpoint çš„æ•°æ®ï¼Œå¦‚åŠ è½½ BPF ç¨‹åºã€æ›´æ–° map ç­‰ï¼‰ï¼Œæ¨é€ PolicyReactionEvent äº‹ä»¶ PolicyReactionEvent.Handle äº‹ä»¶å¤„ç†çš„è¿‡ç¨‹ï¼Œä¾æ¬¡å¤„ç†æ‰€æœ‰ç­–ç•¥ç›¸å…³çš„ endpointï¼Œæœ€åæœ‰å‘å‡º EndpointRegenerationEvent äº‹ä»¶ EndpointRegenerationEvent#Handle äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ Endpoint.regenerate Endpoint.regenerateBPF é‡æ–°åŠ è½½ datapath BPF ç¨‹åºï¼Œåˆ·æ–° Mapã€‚ è‡³æ­¤æˆ‘ä»¬ apply çš„ç½‘ç»œç­–ç•¥è¢«å†™å…¥åˆ° map ä¸­ã€‚\næ¥ä¸‹æ¥çœ‹ä¸‹ ebpf ç¨‹åºæœ‰ä»»ä½•ä½¿ç”¨è¯¥ç­–ç•¥ã€‚\neBPF è¿˜è®°å¾—åœ¨ Kubernetes ç½‘ç»œå­¦ä¹ ä¹‹ Cilium ä¸ eBPF ä¸­æˆ‘ä»¬åˆ†æå®¹å™¨å‘å‡ºçš„æ•°æ®åŒ…ï¼Œè¢« LXC BPF Ingress ç¨‹åºå¤„ç†ã€‚è¿™é‡Œä¸å†èµ˜è¿°ï¼Œå¤„ç†æµç¨‹å¯ä»¥çœ‹é‚£ç¯‡æ–‡ç« ã€‚\næˆ‘ä»¬å…ˆæŸ¥çœ‹æ­»æ˜Ÿçš„ endpoint id å’Œ identity åˆ†åˆ«ä¸º 863 å’Œ 2033ã€‚\nkubectl get ciliumendpoint -n default NAME ENDPOINT ID IDENTITY ID INGRESS ENFORCEMENT EGRESS ENFORCEMENT VISIBILITY POLICY ENDPOINT STATE IPV4 IPV6 tiefighter 2216 29439 \u0026lt;status disabled\u0026gt; \u0026lt;status disabled\u0026gt; \u0026lt;status disabled\u0026gt; ready 10.0.0.123 deathstar-7848d6c4d5-58jc8 863 2033 \u0026lt;status disabled\u0026gt; \u0026lt;status disabled\u0026gt; \u0026lt;status disabled\u0026gt; ready 10.0.0.111 xwing 775 5513 \u0026lt;status disabled\u0026gt; \u0026lt;status disabled\u0026gt; \u0026lt;status disabled\u0026gt; ready 10.0.0.209 ä½¿ç”¨ endpoint id é€šè¿‡é€šè¿‡å‘½ä»¤æŸ¥çœ‹ä¸ºæ­»æ˜Ÿé…ç½®çš„ç½‘ç»œç­–ç•¥ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­çš„ä¸¤æ¡ ingress çš„ç­–ç•¥ï¼Œå…¶ä»£ç†ç«¯å£ 19313ï¼Œè¿™ä¸ªç«¯å£å°±æ˜¯ Cilium ä¸­ L7 ä»£ç†çš„ç›‘å¬ç«¯å£ã€‚\nkubectl exec $agent -n kube-system -c cilium-agent -- cilium bpf policy get 863 POLICY DIRECTION LABELS (source:key[=value]) PORT/PROTO PROXY PORT BYTES PACKETS Allow Ingress reserved:host ANY NONE 0 0 reserved:kube-apiserver Allow Ingress k8s:app.kubernetes.io/name=deathstar 80/TCP 19313 0 0 k8s:class=deathstar k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire Allow Ingress k8s:app.kubernetes.io/name=tiefighter 80/TCP 19313 0 0 k8s:class=tiefighter k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire Allow Egress reserved:unknown ANY NONE 0 0 BPF ç¨‹åºå¤„ç†æµé‡åœ¨æ£€æŸ¥ç­–ç•¥æ—¶ bpf_lxc.c#L1842ï¼Œæ£€æŸ¥é…ç½®çš„ç­–ç•¥å¸¦æœ‰ä»£ç†ç«¯å£æ‰§è¡Œ POLICY_ACT_PROXY_REDIRECT å°†æµé‡é‡å®šå‘ç»™ä»£ç†ï¼ˆç«¯å£ 19313ï¼Œåœ°å€ä¸ºä¸»æœºåœ°å€ï¼‰ã€‚\nCilium Proxy Cilium agent æä¾›äº† xds server å®ç°ï¼Œé€šè¿‡ Unix Domain Socket /var/run/cilium/xds.sock ä¸ proxy è¿›è¡Œé€šä¿¡ï¼Œä¸‹å‘é…ç½®ã€‚\næˆ‘ä»¬å‚è€ƒ cilium-bugtool çš„ dump æºç ï¼Œdump ä»£ç†çš„é…ç½®ã€‚\nkubectl exec $agent -n kube-system -c cilium-agent -- curl -s --unix-socket /var/run/cilium/envoy-admin.sock http://admin/config_dump?include_eds ä»é…ç½® config.json ä¸­å¯ä»¥çœ‹åˆ° Cilium åœ¨ envoy proxy ä¸­å®ç°äº†å¦‚ä¸‹ä¸‰ä¸ªä¸åŒç±»å‹çš„è¿‡æ»¤å™¨ï¼ˆFilterï¼‰ï¼š\nlistener filter filter http filter ç›‘å¬å™¨è¿‡æ»¤å™¨ ç›‘å¬å™¨è¿‡æ»¤å™¨ï¼ˆListener Filterï¼‰cilium.BpfMetadata ä¼šä»å‡ ä¸ªæ•°æ®æºä¸­å‡†å¤‡å…ƒæ•°æ®ï¼šç­–ç•¥ã€ç›‘å¬å™¨è®¾ç½®ã€è¯·æ±‚æ–¹çš„æ ‡è¯†ç­‰ã€‚æ•°æ®æºåŒ…æ‹¬ xds é…ç½®ã€BPF map cilium_ipcacheã€cilium_ct4_globalï¼ˆctï¼šconnection trackingã€‚å½“ç„¶è¿˜åŒ…æ‹¬ ct6 ç›¸å…³çš„ mapï¼‰ã€‚\nä»æ•°æ®æºä¸­è·å–çš„æ•°æ®ä¿å­˜åœ¨ socket option ä¸­ï¼ˆproxy æºç  bpf_metadata.cc#L364ï¼‰ï¼Œä½œä¸ºä¸Šä¸‹æ–‡å…ƒæ•°æ®çš„åœ¨å…¶ä»–çš„è¿‡æ»¤å™¨ä¸­ä½¿ç”¨ã€‚\nå…ƒæ•°æ®æ•°æ®æº xds filter é…ç½®ï¼Œè¿™é‡Œæä¾›äº† bpf map çš„æ ¹ç›®å½• /sys/fs/bpfï¼Œä»¥åŠ is_ingress: true è¡¨ç¤ºå½“å‰ filter æ˜¯åœ¨å…¥å£ç›‘å¬å™¨ä¸Šï¼ˆingress listenerï¼‰ï¼š\n{ \u0026#34;name\u0026#34;: \u0026#34;cilium.bpf_metadata\u0026#34;, \u0026#34;typed_config\u0026#34;: { \u0026#34;@type\u0026#34;: \u0026#34;type.googleapis.com/cilium.BpfMetadata\u0026#34;, \u0026#34;bpf_root\u0026#34;: \u0026#34;/sys/fs/bpf\u0026#34;, \u0026#34;is_ingress\u0026#34;: true } xds network policy é…ç½®ï¼ˆæˆªå–äº† proxy çš„éƒ¨åˆ†é…ç½®ï¼‰ï¼Œä»é…ç½®ä¸­å¯ä»¥æ‰¾åˆ° endpoint çš„ IP å’Œ idï¼Œä»¥åŠå‰é¢æˆ‘ä»¬è®¾ç½®çš„ è§„åˆ™ï¼š\n{ \u0026#34;@type\u0026#34;: \u0026#34;type.googleapis.com/cilium.NetworkPoliciesConfigDump\u0026#34;, \u0026#34;networkpolicies\u0026#34;: [ { \u0026#34;endpoint_ips\u0026#34;: [ \u0026#34;10.0.0.111\u0026#34; ], \u0026#34;endpoint_id\u0026#34;: \u0026#34;863\u0026#34;, \u0026#34;ingress_per_port_policies\u0026#34;: [ { \u0026#34;port\u0026#34;: 80, \u0026#34;rules\u0026#34;: [ { \u0026#34;http_rules\u0026#34;: { \u0026#34;http_rules\u0026#34;: [ { \u0026#34;headers\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;:method\u0026#34;, \u0026#34;safe_regex_match\u0026#34;: { \u0026#34;google_re2\u0026#34;: {}, \u0026#34;regex\u0026#34;: \u0026#34;POST\u0026#34; } }, { \u0026#34;name\u0026#34;: \u0026#34;:path\u0026#34;, \u0026#34;safe_regex_match\u0026#34;: { \u0026#34;google_re2\u0026#34;: {}, \u0026#34;regex\u0026#34;: \u0026#34;/v1/request-landing\u0026#34; } } ] } ] } } ] } ], \u0026#34;egress_per_port_policies\u0026#34;: [ {} ], \u0026#34;conntrack_map_name\u0026#34;: \u0026#34;global\u0026#34; }, ... } Map cilium_ipcacheï¼Œå¯ä»¥é€šè¿‡è¿æ¥ä¿¡æ¯ä¸­çš„ IP åœ°å€è·å–èº«ä»½æ ‡è¯†ï¼Œå¦‚æ­»æ˜Ÿçš„ identity ä¸º 2033ï¼ˆè§ proxy æºç  bpf_metadata.cc#L165ï¼‰ï¼š\nkubectl exec $agent -n kube-system -c cilium-agent -- cilium bpf ipcache list IP PREFIX/ADDRESS IDENTITY 10.0.0.67/32 identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 nodeid=0 10.0.0.111/32 identity=2033 encryptkey=0 tunnelendpoint=0.0.0.0 nodeid=0 10.0.0.123/32 identity=29439 encryptkey=0 tunnelendpoint=0.0.0.0 nodeid=0 10.0.0.243/32 identity=4 encryptkey=0 tunnelendpoint=0.0.0.0 nodeid=0 10.0.0.160/32 identity=19608 encryptkey=0 tunnelendpoint=0.0.0.0 nodeid=0 10.0.0.209/32 identity=5513 encryptkey=0 tunnelendpoint=0.0.0.0 nodeid=0 192.168.1.13/32 identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 nodeid=0 0.0.0.0/0 identity=2 encryptkey=0 tunnelendpoint=0.0.0.0 nodeid=0 Map cilium_ct4_globalï¼Œä»è¿æ¥è·Ÿè¸ªï¼ˆconnection trackingï¼‰ä¸­è·å–è¯·æ±‚æ–¹çš„ identityï¼ˆSourceSecurityID 29439ï¼Œé’›æˆ˜æœºçš„æ ‡è¯†ï¼‰ï¼š\ncilium bpf ct list global TCP OUT 10.0.0.123:48954 -\u0026gt; 10.0.0.111:80 expires=58774 RxPackets=4 RxBytes=435 RxFlagsSeen=0x1b LastRxReport=58764 TxPackets=6 TxBytes=522 TxFlagsSeen=0x1b LastTxReport=58764 Flags=0x0013 [ RxClosing TxClosing SeenNonSyn ] RevNAT=4 SourceSecurityID=29439 IfIndex=0 TCP IN 10.0.0.67:33988 -\u0026gt; 10.0.0.111:80 expires=58776 RxPackets=6 RxBytes=659 RxFlagsSeen=0x1b LastRxReport=58766 TxPackets=4 TxBytes=386 TxFlagsSeen=0x1b LastTxReport=58766 Flags=0x0013 [ RxClosing TxClosing SeenNonSyn ] RevNAT=0 SourceSecurityID=29439 IfIndex=0 TCP IN 10.0.0.123:48954 -\u0026gt; 10.0.0.111:80 expires=80364 RxPackets=6 RxBytes=522 RxFlagsSeen=0x1b LastRxReport=58764 TxPackets=0 TxBytes=0 TxFlagsSeen=0x00 LastTxReport=0 Flags=0x0051 [ RxClosing SeenNonSyn ProxyRedirect ] RevNAT=0 SourceSecurityID=29439 IfIndex=0 è¿‡æ»¤å™¨ è¿‡æ»¤å™¨ï¼ˆFilterï¼‰cilium.NetworkFilter å·¥ä½œåœ¨ L4ï¼Œç”¨äºå¤„ç†å·²å»ºç«‹çš„é“¾æ¥ï¼Œåº”ç”¨ç«¯å£çº§çš„ç­–ç•¥ï¼Œå³ L4 ç­–ç•¥ã€‚\nä»ä¸Šä¸‹æ–‡å…ƒæ•°æ®ä¸­ä¿å­˜çš„ endpoint ç›¸å…³çš„ç­–ç•¥ä¸­æŸ¥æ‰¾ä¸ç›®æ ‡ç«¯å£ç›¸å…³çš„ç­–ç•¥ï¼Œæ£€æŸ¥è¯·æ±‚æ–¹è¯ä¹¦ä¸­çš„ sni å’Œè¯·æ±‚æ–¹çš„èº«ä»½æ ‡è¯† identity æ˜¯å¦åœ¨ç™½åå•ä¸­ï¼Œè§ proxy æºç  network_filter.cc#L169ã€‚\nå‡å¦‚ç­–ç•¥ä¸Šè®¾ç½®äº† L7 çš„åè®®ï¼Œä¼šä½¿ç”¨ Golang ç¼–å†™çš„è§£æå™¨å¯¹ L7 çš„æ•°æ®è¿›è¡Œè§£æã€‚\nåœ¨æœ¬ç¤ºä¾‹ä¸­å¹¶æœªä½¿ç”¨ L4 çš„ç­–ç•¥ã€‚\nHTTP è¿‡æ»¤å™¨ HTTP è¿‡æ»¤å™¨ï¼ˆHTTP Filterï¼‰cilium.L7Policy æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œä½†ç›¸å¯¹å…¶ä»–ä¸¤ä¸ªè¿‡æ»¤å™¨æ¥è¯´é€»è¾‘å°±ç®€å•å¤šäº†ã€‚\n\u0026#34;http_filters\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;cilium.l7policy\u0026#34;, \u0026#34;typed_config\u0026#34;: { \u0026#34;@type\u0026#34;: \u0026#34;type.googleapis.com/cilium.L7Policy\u0026#34;, \u0026#34;access_log_path\u0026#34;: \u0026#34;/var/run/cilium/access_log.sock\u0026#34; } } åœ¨è¿‡æ»¤å™¨å¯¹ HTTP è¯·æ±‚å¤´è¿›è¡Œè§£ç æ—¶ï¼ˆè§ proxy æºç  l7policy.cc#L97ï¼‰ï¼Œä¾ç„¶æ˜¯ä»ä¸Šä¸‹æ–‡å…ƒæ•°æ®ä¸­è·å–ç­–ç•¥ç­‰å†…å®¹ã€‚æ‹¿åˆ°ç­–ç•¥åï¼Œä¸è¯·æ±‚æ–¹ï¼ˆå¯¹äºè¿™é‡Œ ingress çš„åœºæ™¯æ£€æŸ¥è¯·æ±‚æ–¹ï¼Œå¦‚æœæ˜¯ egress çš„åœºæ™¯ï¼Œæ£€æŸ¥ä¸Šæ¸¸çš„æ ‡è¯†ï¼‰çš„æ ‡è¯†ã€è¯·æ±‚å¤´çš„ä¿¡æ¯è¿›è¡Œæ¯”å¯¹ï¼Œå†³å®šæ”¾è¡Œè¿˜æ˜¯æ‹’ç»è¯·æ±‚ã€‚\næ€»ç»“ æ•´ç¯‡çœ‹ä¸‹æ¥ï¼ŒCilium åœ¨å¤„ç† L7 æµé‡ä¸Šçš„å®ç°è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œç‰µæ‰¯å¤šä¸ªç»„ä»¶ååŒã€‚eBPF åœ¨ L3/L4 æµé‡å¤„ç†ä¸Šæœ‰ç€ä¼˜å¼‚çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œä½†æ˜¯å¯¹ L7 æµé‡å¤„ç†ä»ç„¶æ— æ³•è„±ç¦» sidecar ä»£ç†ï¼ˆä¸è®º sidecar æ˜¯ per pod è¿˜æ˜¯ per nodeï¼‰ã€‚è€Œ L7 æµé‡å¤„ç†ä¹Ÿæ°æ°æœ‰ç€éå¸¸å¤šçš„ä½¿ç”¨åœºæ™¯ï¼Œä¸ä»…ä»…æ˜¯ HTTP åè®®ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/06/11/pexels-dana-tentis-371678.jpg","permalink":"https://atbug.com/deep-dive-into-cilium-l7-packet-processing/","tags":["Cilium","eBPF"],"title":"Cilium å¦‚ä½•å¤„ç† L7 æµé‡"},{"categories":["å·¥å…·"],"contents":"è¿™ç¯‡æ–‡ç« ä¸»è¦æ¥ä»‹ç»ä¸‹æˆ‘å¼€å‘çš„ Obsidian å›¾ç‰‡ä¸Šä¼ æ’ä»¶ Image Upload Toolkitã€‚\nèƒŒæ™¯ ä¸ºä»€ä¹ˆå¼€å‘è¿™ä¸ªæ’ä»¶ï¼Ÿè¿™è¿˜è¦ä»å»å¹´è¯´èµ·ã€‚\nå»å¹´æˆ‘æ„Ÿè§‰åˆ°ä½¿ç”¨äº† 6 å¹´çš„ Mweb Pro å·²ç»æ— æ³•æ»¡è¶³æˆ‘çš„éœ€æ±‚äº†ï¼Œè¿™å¹¶ä¸æ˜¯è¯´ Mweb ä¸æ˜¯ä¸ªå¥½äº§å“ï¼Œåè€Œè¿‡å»å‡ å¹´ä¸­æˆ‘ç»å¸¸å‘èº«è¾¹çš„æœ‹å‹æ¨èè¿™ä¸ªäº§å“ã€‚Mweb æ˜¯ä¸ªéå¸¸å¥½çš„äº§å“ï¼ŒåŠŸèƒ½å¤šã€å¿«æ·é”®æ–¹ä¾¿ã€ç•Œé¢ä¹Ÿæ»¡è¶³æˆ‘ä¸ªäººçš„å®¡ç¾ï¼Œè€Œä¸”ä¹°æ–­åˆ¶çš„ä»˜è´¹ä¹Ÿå¾ˆæœ‰å¸å¼•åŠ›ã€‚\néšç€è¿™ä¸¤å¹´å†™çš„å†…å®¹è¶Šæ¥è¶Šå¤šï¼ŒMweb å³ä½¿å†å¤šçš„åŠŸèƒ½ä¹Ÿæ— æ³•æ»¡è¶³ä¸€äº›ä¸ªæ€§åŒ–çš„éœ€æ±‚ã€‚å°±æ¯”å¦‚è¯´å†…å®¹è‡ªåŠ¨æ’ç‰ˆï¼Œä¸ªäººä¹ æƒ¯ä¸­è‹±æ–‡ã€æ•°å­—é—´åŠ ä¸Šç©ºæ ¼ã€æ®µè½é—´çš„ç©ºè¡Œï¼Œç­‰ç­‰ã€‚è¿™äº›éƒ½æ˜¯ Mweb è¿™ç§å°é—­çš„äº§å“æ— æ³•å®ç°çš„ï¼Œå°¤å…¶æ˜¯å¯¹ä¸ªäººå¼€å‘è€…ï¼ˆMweb æ˜¯ç‹¬ç«‹å¼€å‘è€…å¼€å‘çš„ï¼‰æ¥è¯´ï¼Œæ»¡è¶³ä¸ªæ€§åŒ–éœ€æ±‚çš„æˆæœ¬æ˜¯éå¸¸å¤§çš„ã€‚ä½•å†µï¼Œä¼—å£éš¾è°ƒã€‚\nåé¢æˆ‘é™†ç»­ä½¿ç”¨äº† NotePlanã€Notion ä¸€æ®µæ—¶é—´ï¼ŒNotion æˆ‘ä¸ªäººè¿˜ç®—å–œæ¬¢ï¼Œä½†å…¶ä»æ˜¯å°é—­çš„äº§å“ï¼Œå¾ˆéš¾å¯¹å…¶è¿›è¡Œæ‰©å±•ã€‚\næ­£å½“æˆ‘åœ¨æœ‹å‹åœˆæ„Ÿæ…¨æ—¶ï¼Œæœ‰äººæ¨èäº† Obsidianã€‚è¯•ç”¨ä¹‹åçœ¼å‰ä¸€äº®ï¼Œè¿™æ’ä»¶ç³»ç»Ÿå¤ªå¼ºå¤§äº†ã€‚æ¯”å¦‚ä¸Šé¢çš„è‡ªåŠ¨æ’ç‰ˆé—®é¢˜ï¼Œä½¿ç”¨ Linter æ’ä»¶å®Œç¾å¾—åˆ°è§£å†³ã€‚\näºæ˜¯ä¹ï¼Œæˆ‘é€šè¿‡å®‰è£…å¤šç§æ’ä»¶ã€å°†å¿«æ·é”®æ”¹æˆä¸ Mweb ä¸€è‡´ï¼Œå‡ ä¹æ˜¯å¹³ç§»åˆ°äº† Obsidianï¼Œå¹¶æ”¶è·äº†æ›´å¤šçš„åŠŸèƒ½ã€‚å”¯ç‹¬ä»¤äººé—æ†¾çš„æ˜¯æ— æ³•å¤åˆ» Mweb çš„å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼ˆæˆ‘ä¸€ç›´ç”¨é˜¿é‡Œäº‘çš„ OSS ä½œä¸ºå›¾åºŠï¼Œä½¿ç”¨ Mweb å¯ä»¥è‡ªåŠ¨ä¸Šä¼ å¹¶æ›¿æ¢ markdown è¯­æ³•ä¸­çš„å›¾ç‰‡åœ°å€ï¼‰ï¼Œæ¯æ¬¡ç¼–è¾‘å®Œéœ€è¦å‘å¸ƒåˆ°åšå®¢å‰æˆ‘éƒ½è¦å¤åˆ¶åˆ° Mweb ä¸­ä¸Šä¼ ã€‚\næœ¬ç€ç¨‹åºå‘˜æ²¡æœ‰å°±è‡ªå·±é€ è½®å­çš„æƒ³æ³•ï¼Œå»å¹´å›½åº†æˆ‘å¼€å‘äº†æ’ä»¶çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ã€‚ä½¿ç”¨å‡ ä¸ªæœˆä¹‹åæˆ‘å°†å…¶æäº¤åˆ°äº†å®˜æ–¹çš„ æ’ä»¶åˆ—è¡¨ï¼Œç°åœ¨å¯ä»¥ä»æ’ä»¶åˆ—è¡¨æœåˆ°å¹¶å®‰è£…äº†ã€‚\nåŠŸèƒ½ è¿™ä¸ªæ’ä»¶çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯å°†æœ¬åœ°å›¾ç‰‡ä¸Šä¼ åˆ°æŒ‡å®šçš„å›¾åºŠï¼Œå¹¶ä½¿ç”¨å›¾åºŠçš„é“¾æ¥æ›´æ–° markdown è¯­æ³•ä¸­çš„å›¾ç‰‡åœ°å€ï¼Œå¹¶å°†ç»“æœå¤åˆ¶åˆ°å‰ªåˆ‡æ¿ä¸­ï¼Œä¹Ÿå¯é€‰æ‹©æ›´æ–°åŸå†…å®¹ã€‚ç›®å‰ï¼Œæ’ä»¶æ”¯æŒä¸¤ç§å›¾ç‰‡ï¼šImgur å’Œé˜¿é‡Œäº‘ OSSã€‚\né€šç”¨é…ç½® é€šç”¨è®¾ç½®ä¸­å¯ä»¥é…ç½®ï¼š\nå›¾ç‰‡çš„æœ¬åœ°ç›®å½•ï¼Œæ’ä»¶ä¼šä»è¯¥ç›®å½•ä¸­è·å–æ–‡ä¸­çš„å›¾ç‰‡ æ˜¯å¦ä½¿ç”¨å›¾ç‰‡åå­—æ›¿æ¢ - å’Œ _ æˆç©ºæ ¼ä½œä¸ºå›¾ç‰‡çš„ alt textï¼Œå³ [alt_text](image_url) å›¾ç‰‡ä¸Šä¼ å®Œæˆåæ˜¯å¦æ›´æ–°åŸæ–‡ Imgur é…ç½® Imgur çš„é…ç½®å¾ˆç®€å•ï¼Œå¯ä»¥ä½¿ç”¨é»˜è®¤çš„ Client IDï¼Œå¯ä»¥ä½¿ç”¨ è‡ªå·±è´¦å·çš„ Client IDã€‚\né˜¿é‡Œäº‘ OSS é…ç½® é˜¿é‡Œäº‘ OSS çš„é…ç½®é¡¹ç¨å¤šï¼Œä½†æœ‰ OSS ä½¿ç”¨ç»éªŒçš„å¹¶ä¸é™Œç”Ÿï¼š\nå¯ç”¨åŒº Access Key Id Access Key Secret å­˜å‚¨æ¡¶å å›¾ç‰‡çš„ä¿å­˜ç›®å½•ï¼Œæ”¯æŒ {year} {mon} {day} {random} {filename} ç­‰å˜é‡ï¼Œæ¯”å¦‚ä½¿ç”¨ /{year}/{mon}/{day}/{filename}ï¼Œä¸Šä¼ çš„å›¾ç‰‡ pic.jpg å°†ä¿å­˜åœ¨ /2023/06/08/pic.jpgã€‚ æ„Ÿè°¢ åœ¨æ’ä»¶çš„å¼€å‘ä¸­ï¼Œæˆ‘å‚è€ƒäº† obsidian-imgur-pluginã€obsidian-image-auto-upload-pluginã€create-obsidian-pluginï¼Œè¿˜æœ‰ Mweb çš„å¯å‘ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/06/08/pexels-pixabay-533646.jpg","permalink":"https://atbug.com/obsidian-plugin-image-upload-toolkit/","tags":["å·¥å…·","å¼€å‘"],"title":"Obsidian å›¾ç‰‡ä¸Šä¼ æ’ä»¶ï¼šImage Upload Toolkit"},{"categories":["ç¬”è®°"],"contents":"æœ‰å¹¸å‚åŠ  2023 å¹´ GOTCï¼ˆThe Global Opensource Technology Conferenceï¼Œå…¨çƒå¼€æºæŠ€æœ¯å³°ä¼šï¼‰ä¸¤å¤©çš„æ´»åŠ¨ï¼Œå¯è°“æ˜¯æ˜¯æ”¶è·æ»¡æ»¡ã€‚\nè¿™æ¬¡å‚åŠ æ´»åŠ¨æœ¬æ˜¯å¸¦ç€ä¸¤ä¸ªä»»åŠ¡æ¥çš„ï¼šä¸€ä¸ªæ˜¯çœ‹ï¼ˆä¸€å£°ï¼‰ LF APACï¼ˆLinux åŸºé‡‘ä¼šäºšå¤ªåŒºï¼‰å¼€æºå¸ƒé“è€…çš„å±•å°ï¼›å¦ä¸€ä¸ªæ˜¯åœ¨äº‘åŸç”Ÿä¸“åœºçš„åˆ†äº«ï¼šKubernetes è·¨é›†ç¾¤çš„æµé‡ç®¡ç†å®è·µã€‚\nä¸¤å¤©çš„æ´»åŠ¨åŸæœ¬è®¡åˆ’ç¬¬ä¸€å¤©åœ¨å±•å°ï¼Œå¬å„è·¯å¤§ä½¬åˆ†äº«â€œå…«å¦â€ï¼›ç¬¬äºŒå¤©é™¤åˆ†äº«å¤–å°±æ˜¯å¬å¬å…¶ä»–å‡ ä¸ªæ„Ÿå…´è¶£çš„åˆ†è®ºå›ã€‚ä½†ä¸´æ—¶è¢«æ‹‰å»ä¸»æŒäº‘åŸç”Ÿåˆ†ä¼šåœºï¼Œåœ¨åˆ†ä¼šåœºåäº†ä¸€å¤©ï¼Œå¬äº†å…¨éƒ¨è®®é¢˜ã€‚ä¹Ÿå› ä¸ºçªç„¶çš„å˜åŒ–ï¼Œæœ‰äº†ä¸ä¸€æ ·çš„æ„Ÿæ‚Ÿã€‚\nå‰æ–¹é¢„è­¦ï¼Œå†…å®¹æœ‰äº›æ‚ä¹±ï¼Œå®šä¹‰ä¸ºæµæ°´è´¦ä¸€ç¯‡ã€‚æˆ–å¯¹æˆ–é”™ï¼Œéƒ½æ˜¯ä¸ªäººè§è§£ï¼Œå…¶ä»–çš„å°±å½“éƒ½å¸‚ä¼ è¯´å§ã€‚\nç¬¬ä¸€å¤© è¿™æ¬¡å¼€æºå¸ƒé“è€…å›¢é˜Ÿåœ¨å±•åŒºè·å¾—äº†ä¸€ä¸ªå±•ä½ï¼Œå¤§ä¼šä¹‹å‰å¤§å®¶å‡†å¤‡å¤§å±•æ‹³è„šå‡†å¤‡ä¸ªé…·ç‚¹çš„èƒŒæ¿ã€‚æ— å¥ˆè¢«ç°å®æ‰“è¶´ä¸‹ï¼Œç”±äºå‡ ä¸ªäººéƒ½å¤ªå¿™ï¼Œæœ€åèƒŒæ¿æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ã€‚æ˜¯çš„ï¼Œå½“ä½ ä¸åšé€‰æ‹©çš„æ—¶å€™ç³»ç»Ÿä¼šç»™ä½ ä¸ªé»˜è®¤çš„ï¼ˆå½“ç„¶ï¼Œè¿™éƒ½ä¸é‡è¦ï¼‰ã€‚\næˆ‘æ˜¯åœ¨ 2021 å¹´åº•åœ¨å°é©¬å“¥çš„æ€‚ï¼ˆé¼“ï¼‰æ¿ï¼ˆåŠ±ï¼‰ä¸‹åŠ å…¥å¸ƒé“å¸ˆå›¢é˜Ÿçš„ï¼Œæ­£å¼å¼€å§‹æ˜¯åœ¨ 2022 å¹´åˆã€‚å‡ ä¹ä¸€æ•´å¹´å¤§å®¶éƒ½æ˜¯çº¿ä¸Šçš„äº¤æµï¼Œè¿™æ¬¡å°±å˜æˆäº†å¤§å‹çš„ç½‘å‹è§é¢ä¼šã€‚è¿™æ¬¡è™½ç„¶ä¸æ˜¯æ‰€æœ‰å¸ƒé“è€…éƒ½æ¥å‚åŠ ï¼Œä½†æ˜¯æ‰€æœ‰å‚åŠ çš„äººä¹Ÿæ²¡æ‹æˆé›†ä½“ç…§ã€‚\nå¼€æºä¸å¼€å‘è€… ä¸€æ•´å¤©éƒ½åœ¨ä¸äººäº¤æµï¼Œæ›´å¤šçš„æ˜¯å¬ï¼Œå¬å„ä¸ªå¼€æºé¢†åŸŸä¸“å®¶çš„åˆ†ï¼ˆåï¼‰äº«ï¼ˆæ§½ï¼‰ã€‚åæ§½å¯ä»¥è®©äººå¾ˆæ„‰æ‚¦ï¼Œå°†åŸæœ¬ç¨æ˜¾æ²‰é‡çš„è¯é¢˜è½»æ¾è®²å‡ºã€‚\næœ‰å¼€å‘å›¢é˜Ÿåæ§½å¼€æºå›¢é˜Ÿï¼ˆå¦‚ OSPO ç­‰ï¼‰ï¼šå½±å“å¼€å‘è¿›åº¦ã€è§„èŒƒæµç¨‹ä¸åˆç†ç­‰ç­‰ã€‚æœ‰å¼€æºä¸“å®¶å°±åæ˜ å›¢é˜Ÿè®¾ç½®æµç¨‹æ£€æŸ¥èŠ‚ç‚¹çœ‹ä¼¼åˆç†ï¼Œå®é™…ä¸Šå´å¡ä½äº†æµç¨‹ï¼Œæœ€åè°éƒ½ä¸æ„¿æ‹…è´£ã€‚ æœ‰å¼€æºå›¢é˜Ÿåæ§½å¼€å‘è€…ï¼šå¼€æºäº§å“é€‰å‹ä¸åˆç†ã€ä¸éµå®ˆè§„èŒƒç­‰ã€‚æ¯”å¦‚éœ€è¦æŸä¸ªåŠŸèƒ½ï¼Œç›´æ¥ä»ç½‘ä¸Šæ‰¾æ¥çš„å¼€æºé¡¹ç›®æ²¡æœ‰è®¸å¯ã€æ²¡æœ‰ READEMEã€‚ æœ‰å¼€æºå›¢é˜Ÿåæ§½ä¼ä¸šçš„ KPI è®¾å®šï¼Œå¼€æºæˆ–åšå•†ä¸šåŒ–ï¼Œæˆ–è¦ä½“ç°å‡ºä»·å€¼ã€‚ è¿™é‡Œé¢æœ‰ä¼ä¸šã€å¼€å‘å›¢é˜Ÿã€å¼€æºå›¢é˜Ÿï¼Œæœ¬åº”æˆä¸ºäº’ç›¸æ”¯æŒçš„æ­£å¾ªç¯çš„ï¼Œä½†ä¼ä¸šéœ€è¦ä¸šç»©ï¼ˆæ´»ä¸‹å»ï¼‰ã€å¼€å‘å›¢é˜Ÿè¦æ”¯æ’‘ä¸šåŠ¡ï¼ˆæœ‰äº§å‡ºï¼‰ã€å¼€æºå›¢é˜Ÿå¸®åŠ©ä¼ä¸šæ›´å¥½åœ°åˆ©ç”¨å’Œè´¡çŒ®å¼€æºã€‚å½¼æ­¤çš„å…³æ³¨ç‚¹ä¸åŒï¼Œå´æœ‰ä¸€æ¡æ— å½¢çš„çº¿è”ç³»ç€ã€‚å¼€æºå›¢é˜Ÿå¦‚ä½•å‘ä¸Šæä¾›å¼€æºæˆ˜ç•¥å’ŒæŒ‡å¯¼ã€é™ä½æˆæœ¬å’Œé£é™©ã€ä¿ƒè¿›å…±äº«å’Œåˆä½œï¼›å‘ä¸‹ä¼ æ’­å¼€æºæ–‡åŒ–ã€æä¾›åˆè§„æŒ‡å¯¼ã€æŠ€æœ¯æ”¯æŒã€‚\nè¯´èµ·æ¥å®¹æ˜“ï¼Œåšèµ·æ¥éš¾ã€‚ä¸ªäººè®¤ä¸ºå¼€æºçš„æœ€åä¸€å…¬é‡Œå†³å®šäº†å¼€æºåœ¨å†…éƒ¨è½åœ°çš„æˆè´¥ã€‚æˆ‘ä»¬æ˜¯å¦èƒ½å¤Ÿä»å½“å‰ä¼ä¸šçš„è§„æ¨¡å’Œå®é™…éœ€æ±‚å‡ºå‘ï¼Œä»¥ä¸€ç§åŠ¡å®çš„æ€åº¦æ·±å…¥å¼€å‘è€…ç¾¤ä½“ï¼Œå»äº†è§£ä»–ä»¬æ‰€é¢å¯¹çš„æƒ…å†µã€‚æˆ‘ä¸åå¯¹è§„èŒƒæµç¨‹ç¡®å®éœ€è¦ä»ä¸Šè€Œä¸‹çš„æ‰§è¡Œï¼Œä½†æ˜¯è§„èŒƒæµç¨‹çš„åˆ¶å®šä¹Ÿéœ€è¦å¼€å‘è€…çš„å‚ä¸æä¾›æŒ‡å¯¼ã€‚æˆ‘èƒ½æƒ³åˆ°çš„å¦ä¸€ä¸ªç‚¹æ˜¯ï¼Œå½“ä¸€ä»¶äº‹åšèµ·æ¥å¾ˆå®¹æ˜“çš„è¯ï¼Œåº”è¯¥å¯ä»¥è®©æ›´å¤šçš„äººè¿›å…¥ã€‚ æ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œéœ€è¦å€ŸåŠ©å·¥å…·çš„åŠ›é‡å»æå‡è‡ªåŠ¨åŒ–å‡å°‘äººå·¥çš„å‚ä¸ã€‚\nå…³äºå¼€æºå¸ƒé“ å…¶å®åŠ å…¥å¼€æºå¸ƒé“å¸ˆä¹‹åå¾ˆé•¿ä¸€æ®µæ—¶é—´æˆ‘éƒ½æ˜¯å¾ˆè¿·èŒ«çš„ã€‚æˆ‘æœ¬èº«å‚ä¸å¼€æºçš„æ—¶é—´ä¸é•¿ï¼Œæ–‡åŒ–ç†è§£ä¹Ÿä¸å¤Ÿã€‚å¹³æ—¶çœ‹ç€å¤§å®¶å¯¹å¼€æºæ–‡åŒ–ã€å¼€æºåˆè§„ç­‰æ–¹é¢çš„ä¸“ä¸šï¼Œæ„Ÿè§‰ç”šæ˜¯æƒ­æ„§ã€‚è‡ªå·±åªèƒ½å†™å†™å…¬ä¼—å·åšå®¢ã€åœ¨æ´»åŠ¨ä¸Šåˆ†äº«ä¸‹æŠ€æœ¯ã€‚åæ¥è¢«é€‚å…•è€å¸ˆâ€œæ•™è‚²â€ä¸¤æ¬¡ï¼Œä¹Ÿç†è§£åˆ°åˆ†äº«å°±æ˜¯å¼€æºçš„æœ¬è´¨ä¹‹ä¸€ï¼Œå¼€æºçš„ç†å¿µæ˜¯å…±äº«å’Œå¼€æ”¾ã€‚\nå¯èƒ½å¾ˆå¤šäººä¹Ÿåƒæˆ‘ä¸€æ ·ä¸äº†è§£â€œå¼€æºå¸ƒé“â€ã€‚ç»è¿‡ä¸¤å¤©å‡ æ¬¡çš„è®¨è®ºï¼Œæˆ‘ä»¬å‘ç°åšä¸ªâ€œå¼€æºå¸ƒé“è€…ç”»åƒâ€å¯èƒ½ä¼šæœ‰å¸®åŠ©ã€‚èƒ½å¤Ÿå¸®åŠ©æ›´å¤šçš„äººç†è§£å¼€æºå¸ƒé“ï¼Œèƒ½å¤ŸåŠ å…¥è¿›æ¥ã€‚\né¥­å±€ å½“å¤©çš„é¥­å±€æ˜¯ä¸»åŠæ–¹å®‰æ’çš„è‡ªåŠ©é¤ï¼Œå¤§å®¶åçš„æ¯”è¾ƒåˆ†æ•£ï¼Œä¸€èµ·çš„å‡ ä¸ªäººå¿«é€Ÿåœ°åƒå®Œç¦»å¼€å‡†å¤‡ä¸‹ä¸€åœºèŠå¤©ã€‚å·§åˆçš„æ˜¯ï¼Œåƒé¥­æ—¶éš”å£æ¡Œçš„å‡ ä¸ªäººåœ¨èŠå¤©ï¼Œå…¶ä¸­æœ‰äººè¯´â€œæ¬¢è¿å¤§å®¶å»çƒŸå°ç©â€ã€‚ä½œä¸ºè€å®¶å¨æµ·å°±åœ¨çƒŸå°éš”å£çš„æˆ‘æ¥è¯´å°±æ¥äº†å…´è¶£ï¼Œæ”€è°ˆä¹‹åå‘ç°æ˜¯å…¬å¸çš„å®¢æˆ·ï¼Œå…¶ä¸­æœ‰äººè¿˜åœ¨å¨æµ·ä¸Šçš„å¤§å­¦ã€‚\næ¥ä¸‹æ¥çš„ä¸€åœºèŠå¤©æ˜¯äº‘åŸç”Ÿç¤¾åŒºç®¡å§”ä¼šçš„æˆ‘ä»¬å››ä¸ªï¼Œå¤§å®¶èŠèµ·å½“åˆåŠ å…¥ç¤¾åŒºçš„åˆè¡·ä»¥åŠè¿™ä¸¤å¹´æ¥çš„æ„Ÿå—ã€‚æ„Ÿè§‰å¾ˆå¥½ï¼Œèƒ½æ„Ÿå—åˆ°å¤§å®¶å¯¹äºç¤¾åŒºçš„çƒ­æƒ…å’ŒæŠ•å…¥ï¼Œå¾ˆå—é¼“èˆã€‚\nç¬¬äºŒå¤© ç¬¬äºŒå¤©å¯¹æˆ‘æ¥è¯´éå¸¸å¿™ç¢Œï¼Œæ•´å¤©éƒ½åœ¨äº‘åŸç”Ÿä¸“åœºä¸»æŒã€‚å…¨å¤© 19 ä¸ªè®®é¢˜ï¼Œæ¶µç›–ä¼—å¤šé¢†åŸŸï¼šå¤šé›†ç¾¤ã€æœåŠ¡ç½‘æ ¼ã€WebAssemblyã€è¾¹ç¼˜è®¡ç®—ã€å­˜å‚¨ã€FinOpsã€é™æœ¬å¢æ•ˆã€å®‰å…¨ã€ç½‘ç»œç­‰ã€‚å¤§å®¶ä»‹ç»äº†è‡ªå·±å‚ä¸çš„å¼€æºé¡¹ç›®ã€äº‘åŸç”Ÿçš„æ–¹æ¡ˆçš„å®è·µã€‚\nåœ¨æ­¤æˆ‘å¹¶ä¸å‡†å¤‡å¯¹å„ä¸ªè®®é¢˜è¿›è¡Œä»‹ç»ï¼Œå†…å®¹å¤ªå¤šã€‚è¯´å®è¯å‘¢ï¼Œå°±æ˜¯æˆ‘è®°ä½çš„ä¸å¤šã€‚ä½†å€Ÿç€è¿™æ¬¡å›é¡¾ï¼Œåˆ†äº«ä¸‹æˆ‘è¿‘æœŸçš„ä¸€äº›æ€è€ƒï¼Œæ­£å¥½ä¹Ÿä¸æ­¤æœ‰å…³ã€‚\nå…³äºäº‘åŸç”Ÿ è§†é¢‘\nä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰çœ‹è¿‡è¿™ä¸ªè§†é¢‘ï¼Œæˆ‘æ›´å–œæ¬¢çœ‹å€’æ”¾çš„ç‰ˆæœ¬ã€‚äº‘åŸç”Ÿå‘å±•å¥½å¤šå¹´äº†ï¼Œå¾—ç›Šäº Kubernetes çš„çµæ´»æ‰©å±•è½¯ä»¶ç”Ÿæ€å‘å±•ç¹è£ï¼Œè¿‘äº›å¹´å„ç§é¡¹ç›®ä¹Ÿæ˜¯å±‚å‡ºä¸ç©·ã€‚ç»Ÿè®¡äº†ä¸‹ CNCF å…¨æ™¯å›¾ä¸­ç›®å‰æœ‰é¡¹ç›® 2078 ä¸ªï¼Œå…¶ä¸­æ²™ç›’é¡¹ç›® 97ï¼Œå­µåŒ–ä¸­çš„é¡¹ç›® 38ï¼Œæ¯•ä¸šçš„é¡¹ç›® 20ã€‚è¿‡å¾€å‡ å¹´äº‘åŸç”Ÿä¹Ÿéƒ½æ˜¯æ¯æ¬¡æ´»åŠ¨ä¸­å…³æ³¨æœ€å¤šçš„è¯é¢˜ï¼Œå»å¹´åº•å¼€å§‹åŠ¿å¤´è¢«ç«çƒ­çš„ AI ç›–è¿‡ã€‚\nKubernetes ä½œä¸º CNCF çš„æ˜æ˜Ÿé¡¹ç›®ï¼Œæˆä¸ºäº‘åŸç”ŸæŠ€æœ¯çš„äº‹å®æ ‡å‡†å’Œæ ¸å¿ƒç»„ä»¶ã€‚å…¶å¼ºå¤§çš„åŠŸèƒ½å’Œå¯æ‰©å±•æ€§å¸å¼•äº†å¹¿æ³›çš„å…³æ³¨å’Œé‡‡ç”¨ï¼Œæ¨åŠ¨äº†æ•´ä¸ªç”Ÿæ€ç³»ç»Ÿçš„å‘å±•ã€‚Kubernetes çš„ CRD è®¾è®¡å°†åŸºç¡€è®¾æ–½çš„èƒ½åŠ›ä»¥ API çš„æ–¹å¼æŠ½è±¡å‡ºæ¥ï¼Œä½¿å¾—æˆ‘ä»¬æ“ä½œåŸºç¡€è®¾æ–½æ›´åŠ å®¹æ˜“ã€‚ä»¥å‰ï¼Œæˆ‘ä»¬é€šè¿‡ API ä¸åç«¯æœåŠ¡è¿›è¡Œäº¤äº’ï¼Œå¦‚ä»Šåœ¨äº‘åŸç”Ÿçš„æ—¶ä»£æ˜¯é€šè¿‡ API ä¸åŸºç¡€è®¾æ–½äº¤äº’ã€‚\næœ‰äººæ›¾è¯´è¿‡â€œè½¯ä»¶æ­£åœ¨åå™¬ä¸–ç•Œâ€ï¼ŒAPI æ­£æ˜¯è½¯ä»¶è¿æ¥ä¸–ç•Œçš„æ¡¥æ¢ï¼Œä¹Ÿå°±æœ‰äº† OpenAPI è§„èŒƒï¼ˆKubernetes ä¹Ÿéµå¾ªäº† OpenAPI è§„èŒƒï¼‰ã€‚åŸºç¡€è®¾æ–½ API åŒ–å¹¶æ…¢æ…¢è¿ç§»åˆ° Kubernetesï¼Œä½¿å¾— Kubernetes æˆä¸ºæ–°ä¸€ä»£çš„åŸºç¡€è®¾æ–½å¯æ‰©å±•å±‚ã€‚\nè¿˜æ˜¯é‚£å¥è¯ï¼Œå½“ä¸€ä»¶äº‹åšèµ·æ¥å¾ˆå®¹æ˜“çš„è¯ï¼Œåº”è¯¥å¯ä»¥è®©æ›´å¤šçš„äººè¿›å…¥ã€‚ å¯¹é¡¹ç›®æ¥è¯´ä¹Ÿä¸€æ ·ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆäº‘åŸç”Ÿçš„é¡¹ç›®è¦†ç›–è¶Šæ¥è¶Šå¤šçš„é¢†åŸŸã€‚\né¥­å±€ æ™šä¸Šæ˜¯ OSPO çš„é¥­å±€â€œå®‰åŠ¿ä¹‹å¤œâ€ï¼Œç”±å®‰åŠ¿èµåŠ©ï¼Œé…’å§åŒ…åœºã€‚æˆ‘å¯è€»çš„å…¨ç¨‹æœæ± + æ°´ã€‚å› ä¸ºæœ‰äº†é…’ç²¾çš„åŠ å…¥ï¼Œå¤§å®¶èŠå¾—æ›´å¼€äº†ã€‚\næœ‰äººåæ§½æŠ€æœ¯å¤§ä¼šå¤§å‚è¯é¢˜å¤ªå¤šï¼Œâ€œç§€è‚Œè‚‰â€ï¼›æœ‰å¤§å‚çš„äººåæ§½æ´»åŠ¨å¤ªå¤šï¼Œç–²åŠ³äº†ï¼Œè¿˜å½±å“å¼€å‘è¿›åº¦ï¼›æœ‰äººåæ§½ç°åœ¨çš„é£é™©æŠ•èµ„ï¼Œå…¶å®éƒ½æ˜¯é¿â€œé£é™©â€æŠ•èµ„ï¼Œè¦æ±‚å¤ªè‹›åˆ»ï¼Œå¤ªçŸ­è§†ã€‚\né¥­å±€ç»“æŸæ•£åœºï¼Œè·¯è¾¹å‡†å¤‡æ‰“è½¦æ—¶å‡ äººåˆèŠäº†åŠä¸ªå¤šå°æ—¶ã€‚æœ€ç»ˆå†³å®šèµ°å‡ å…¬é‡Œå›é…’åº—ï¼Œç„¶ååˆèŠäº†ä¸€è·¯ã€‚\næœ€å è¿™æ¬¡æ´»åŠ¨æ”¶è·æ»¡æ»¡ï¼Œè®¤è¯†äº†å¾ˆå¤šå„ä¸ªé¢†åŸŸçš„ä¸“å®¶ï¼Œå—ç›ŠåŒªæµ…ã€‚\næœ€åï¼Œæ„Ÿè°¢ GOTC æ´»åŠ¨ä¸»åŠæ–¹çš„é‚€è¯·ï¼Œæ„Ÿè°¢å„ä½è€å¸ˆçš„åˆ†äº«ï¼ŒæœŸå¾…ä¸‹æ¬¡çš„ç›¸èšã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/lf-apac-evangelist.jpg","permalink":"https://atbug.com/gotc-2023-thoughts/","tags":null,"title":"GOTC 2023 å‚ä¼šæµæ°´è´¦"},{"categories":["å·¥å…·"],"contents":"Podmanï¼ˆPOD MANagerï¼‰æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„å®¹å™¨ç®¡ç†å·¥å…·ï¼Œå¯ç”¨äºç®¡ç†å®¹å™¨ã€é•œåƒã€å·ä»¥åŠä»¥å®¹å™¨ç»„å½¢å¼å­˜åœ¨çš„ Podã€‚Podman å¯ä»¥åœ¨ Linux ä¸Šç›´æ¥è¿è¡Œå®¹å™¨ï¼Œä½†åœ¨åƒ macOS å’Œ Windows è¿™æ ·çš„å¹³å°ï¼Œæ˜¯é€šè¿‡è™šæ‹Ÿæœºé—´æ¥è¿è¡Œå®¹å™¨ã€‚\nPodman Desktop æä¾›çš„å›¾å½¢ç”¨æˆ·ç•Œé¢ä½¿å¼€å‘äººå‘˜å¯ä»¥æ–¹ä¾¿å¿«æ·åœ°åœ¨æœ¬åœ°ç¯å¢ƒä¸­åˆ›å»ºå’Œç®¡ç†å®¹å™¨ï¼Œç®€åŒ–äº†å®¹å™¨çš„ä½¿ç”¨ï¼Œæ— éœ€è®°å¿†å’Œè¾“å…¥å¤æ‚çš„å‘½ä»¤ï¼Œé™ä½å®¹å™¨çš„ä½¿ç”¨é—¨æ§›ã€‚\nä¸»è¦ç‰¹ç‚¹ ä¼˜ç§€çš„å…¼å®¹æ€§ å¤šå¹³å°ï¼šæ”¯æŒ Linuxã€macOSã€Windows å…¼å®¹ Docker APIã€Limaã€Kindã€Openshift Localã€Podman Machine å®¹å™¨å’Œ Pod ç®¡ç† æ„å»ºã€è¿è¡Œå®¹å™¨çš„ Pod æ— éœ€ Kubernetes ç›´æ¥è¿è¡Œ Pod å†…ç½®ç»ˆç«¯ ssh åˆ°å®¹å™¨ ä¸ Docker Compose å…¼å®¹ é•œåƒå’Œä»“åº“ç®¡ç† é…ç½®ç®¡ç†å¤šä¸ªé•œåƒä»“åº“ æ„å»ºã€æ‹‰å–ã€tag å’Œæ¨é€é•œåƒ æ¨é€é•œåƒåˆ° Kind é›†ç¾¤ Kubernetes å…¼å®¹ Kubernetes YAML åˆ›å»º Pod ä»å®¹å™¨æˆ–è€… Pod ç”Ÿæˆ Kubernetes YAML å…¼å®¹ Docker Extension æ”¯æŒ Docker Desktop UI extensionsï¼Œå¯ä»¥ä½¿ç”¨ OCI é•œåƒè¿è¡Œ Extensionï¼Œå¦‚ flomesh/pipy-docker-ext ã€‚\n### å¯æ‰©å±•æ€§ æ‰©å±•å®¹å™¨å¼•æ“ï¼ˆå¦‚ Podmanã€Dockerã€Lima ç­‰ï¼‰ ä¸ç¬¬ä¸‰æ–¹å·¥å…·é›†æˆï¼Œå¦‚ Kind æˆ–è€… Compose æä¾›æ‰©å±•ç‚¹ï¼Œç”¨äºæ·»åŠ æ“ä½œã€èœå•ã€é…ç½®ï¼Œå¹¶ç”¨ç‰¹å®šåŠŸèƒ½ä¸°å¯Œç”¨æˆ·ç•Œé¢ å®‰è£… åœ¨å®‰è£… Podman Desktop ä¹‹å‰è¦å…ˆ å®‰è£… Podmanï¼Œåœ¨ macOS ä¸Šå¯ä»¥é€šè¿‡ Homebrew è¿›è¡Œå®‰è£…ã€‚\nbrew install podman å®‰è£…å®Œæˆåæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤åˆ›å»ºå¹¶å¯åŠ¨è™šæ‹Ÿæœºã€‚\npodman machine init podman machine start Podman Desktop çš„å®‰è£… ä¹Ÿå¾ˆç®€å•ï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨ Homebrew æ¥å®‰è£…ã€‚\nbrew install podman-desktop ç„¶åå°±å¯ä»¥ä½¿ç”¨äº†ã€‚\nè‡³äº Podman Desktop èƒ½å¦å–ä»£ Docker Desktopï¼Œä½ æ€ä¹ˆçœ‹ï¼Ÿ\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-tobias-aeppli-1125278.jpg","permalink":"https://atbug.com/podman-desktop-announce-general-availability/","tags":["å®¹å™¨","Docker"],"title":"å–ä»£ Docker Desktopï¼ŸPodman Desktop å‘å¸ƒ GA ç‰ˆæœ¬ 1.0"},{"categories":["ç¬”è®°"],"contents":"è¿™ç¯‡ä¹‹å‰å†™ Kubernetes ç½‘ç»œå­¦ä¹ ä¹‹ Cilium ä¸ eBPF è®°å½•çš„å†…å®¹ï¼Œéš”äº†å‡ ä¸ªæœˆç»ˆäºæƒ³èµ·æŠŠç¬”è®°å®Œæˆï¼Œä½œä¸ºæ¢ç´¢ Cilium å·¥ä½œåŸç†çš„å…¥é—¨ï¼Œä¹Ÿè¿˜æ˜¯ Cilium å†°å±±ä¸€è§’ï¼Œåƒæ˜¯é«˜çº§çš„ç½‘ç»œç­–ç•¥ã€ç½‘ç»œåŠ å¯†ã€BGP ç½‘ç»œã€æœåŠ¡ç½‘æ ¼ç­‰æ–¹é¢å¹¶æ²¡æœ‰æ·±å…¥ã€‚å¦‚æœé˜…è¯»è¿‡ç¨‹ä¸­æœ‰å‘ç°ä»»ä½•é—®é¢˜ï¼Œä¹Ÿçƒ¦è¯·çº æ­£ã€‚\næœ¬æ–‡åŸºäº Cilium v1.12 åŠ Kubernetes v1.25ã€‚\nå®éªŒç¯å¢ƒ æˆ‘ä»¬ä½¿ç”¨ k8e åˆ›å»ºé›†ç¾¤ï¼Œå› ä¸º k8e ä½¿ç”¨ Cilium ä½œä¸ºé»˜è®¤çš„ CNI å®ç°ã€‚åœ¨æˆ‘çš„ homelab ä¸Šåšä¸ªåŒèŠ‚ç‚¹ï¼ˆubuntu-test1: 192.168.1.21ã€ubuntu-test2: 192.168.1.22ï¼‰çš„é›†ç¾¤ã€‚\nMaster èŠ‚ç‚¹\ncurl -sfL https://getk8e.com/install.sh | API_SERVER_IP=192.168.1.21 K8E_TOKEN=ilovek8e INSTALL_K8E_EXEC=\u0026#34;server --cluster-init --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config\u0026#34; sh - å·¥ä½œèŠ‚ç‚¹\ncurl -sfL https://getk8e.com/install.sh | K8E_TOKEN=ilovek8e K8E_URL=https://192.168.1.21:6443 sh - éƒ¨ç½²ç¤ºä¾‹åº”ç”¨ï¼Œé€šè¿‡ä¿®æ”¹ nodeName å°†ä¸¤ä¸ª pod åˆ†åˆ«è°ƒåº¦ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šã€‚\nNODE1=ubuntu-test1 NODE2=ubuntu-test2 kubectl apply -n default -f - \u0026lt;\u0026lt;EOF apiVersion: v1 kind: Pod metadata: labels: app: curl name: curl spec: containers: - image: curlimages/curl name: curl command: [\u0026#34;sleep\u0026#34;, \u0026#34;365d\u0026#34;] nodeName: $NODE1 --- apiVersion: v1 kind: Pod metadata: labels: app: httpbin name: httpbin spec: containers: - image: kennethreitz/httpbin name: httpbin nodeName: $NODE2 EOF Cilium ç»„ä»¶ Agent cilium-agent è¿è¡Œåœ¨é›†ç¾¤çš„å„ä¸ªèŠ‚ç‚¹ä¸Šï¼ˆä¸Šå›¾çš„ Cilium Daemonï¼‰ã€‚æ¥æ”¶æ¥è‡ª Kubernetes æˆ–è€… Cilium API çš„æè¿°ç½‘ç»œã€æœåŠ¡è´Ÿè½½å‡è¡¡ã€ç½‘ç»œç­–ç•¥ä»¥åŠå¯è§æ€§å’Œç›‘æ§éœ€æ±‚çš„é…ç½®ã€‚\nAgent ç›‘æ§å¦‚ Kubernetes ç­‰ç¼–æ’ç³»ç»Ÿä¸­å®¹å™¨æˆ–è€…è´Ÿè½½çš„ç”Ÿå‘½å‘¨æœŸå˜åŒ–ï¼Œç®¡ç†ç€ç”¨æ¥æ§åˆ¶è¿›å‡ºå®¹å™¨çš„ç½‘ç»œè®¿é—®çš„ eBPF ç¨‹åºï¼›å¯¹å¤–ï¼ˆCNI Pluginã€CLIï¼‰æä¾› API æ¥æ“ä½œé…ç½®ã€Endpointã€Nodeã€Policyã€Serviceã€IP åœ°å€ç­‰èµ„æºã€‚\nAPI åŒ…å«å¦‚ä¸‹å‡ ä¸ªæ¨¡å—ï¼š\ndaemon endpoint ipam metrics policy prefilter recorder service CLI Cilium CLI å®¢æˆ·ç«¯ï¼Œä¸ cilium-agent ä¸€èµ·å®‰è£…ã€‚é€šè¿‡ Cilium REST API ä¸åŒèŠ‚ç‚¹ä¸Šçš„æœ¬åœ° agent è¿›è¡Œäº¤äº’ã€‚é€šè¿‡ CLI å¯ä»¥æ£€æŸ¥æœ¬åœ° agent çš„çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è®¿é—® eBPF map çš„å†…å®¹ä»¥ä¾¿éšæ—¶éªŒè¯çŠ¶æ€ã€‚\ncilium CLI for interacting with the local Cilium Agent Usage: cilium [command] Available Commands: bpf Direct access to local BPF maps cleanup Remove system state installed by Cilium at runtime completion Output shell completion code config Cilium configuration options debuginfo Request available debugging information from agent encrypt Manage transparent encryption endpoint Manage endpoints fqdn Manage fqdn proxy help Help about any command identity Manage security identities ip Manage IP addresses and associated information kvstore Direct access to the kvstore lrp Manage local redirect policies map Access userspace cached content of BPF maps metrics Access metric status monitor Display BPF program events node Manage cluster nodes policy Manage security policies prefilter Manage XDP CIDR filters preflight cilium upgrade helper recorder Introspect or mangle pcap recorder service Manage services \u0026amp; loadbalancers status Display status of daemon version Print version information Flags: --config string config file (default is $HOME/.cilium.yaml) -D, --debug Enable debug messages -h, --help help for cilium -H, --host string URI to server-side API Use \u0026#34;cilium [command] --help\u0026#34; for more information about a command. Operator Cilium Operator è´Ÿè´£ç®¡ç†é›†ç¾¤ä¸­çš„èŒè´£ï¼Œé€»è¾‘ä¸Šåº”è¯¥ä¸ºæ•´ä¸ªé›†ç¾¤å¤„ç†ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯ä¸ºé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¤„ç†ä¸€æ¬¡ã€‚Operator ä¸å‚ä¸ä»»ä½•è½¬å‘æˆ–è€…ç½‘ç»œç­–ç•¥çš„å†³ç­–ã€‚å³ä½¿ Operator çŸ­æš‚ä¸å¯ç”¨ï¼Œé›†ç¾¤é€šå¸¸ä¼šç»§ç»­è¿è¡Œï¼Œé™¤äº†æŸäº›æ“ä½œå¯èƒ½ä¼šå¤±è´¥ã€‚\nOperator å…è®¸å¤šå®ä¾‹è¿è¡Œï¼Œä½†ç”± leader å®ä¾‹å®Œæˆç‰¹å®šæ“ä½œï¼Œæ¯”å¦‚ Node CIDR çš„åˆ†é…ã€‚\nCNI Plugin Cilium çš„ CNI å®ç°ï¼Œå½“ pod è°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹åï¼Œè¯¥èŠ‚ç‚¹çš„å®¹å™¨è¿è¡Œæ—¶ä¼šè°ƒç”¨ Cilium CNI å®Œæˆä¸€ç³»åˆ—çš„ç½‘ç»œé…ç½®ã€‚CNI Plugin ä¼šä¸ Agent ç»„ä»¶é€šè¿‡ REST API è¿›è¡Œäº¤äº’ï¼Œæ¯”å¦‚è°ƒç”¨ API åˆ†é… IP åœ°å€ã€åˆ›å»º Endpoint ç­‰ã€‚\nå¯¹è¿™éƒ¨åˆ†æœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸‹ä¹‹å‰çš„æ–‡ç«  ã€ŠKubernetes ç½‘ç»œå­¦ä¹ ä¹‹ Cilium ä¸ eBPFã€‹ã€‚\nIPAM Cilium ç®¡ç†ç½‘ç»œ Endpointï¼ŒEndpoint ä½¿ç”¨çš„ IP åœ°å€ï¼Œç”± IPAM åˆ†é…å’Œç®¡ç†ã€‚\næ”¯æŒ å¤šç§ IPAM æ¨¡å‹ï¼Œé»˜è®¤ä½¿ç”¨ Cluster Scope cluster-poolï¼Œé€šè¿‡ cilium-config ä¸­çš„å­—æ®µ ipam æ¥è®¾ç½®ã€‚\ncluster-scope IPAM æ¨¡å‹ä¸ºå„ä¸ªé›†ç¾¤ node åˆ†é… PodCIDRsï¼Œç„¶ååœ¨å„ä¸ª node ä¸Šä½¿ç”¨ host-scope åˆ†é…å™¨åˆ†é… IP åœ°å€ã€‚\nè¿™ä¸ª PodCIDRs çš„åˆ†é…ä¸ Flannel ä¸­çš„ PodCIDRs åˆ†é… çš„ä¸åŒï¼šåè€…ä½¿ç”¨ v1.Node ä¸Šç”± Kubernetes åˆ†é…çš„ podCIDRï¼Œè¿™ä¸ªä¸ Cilium çš„ Kubernetes Host Scope ç±»ä¼¼ï¼›è€Œ Cilium çš„ cluster-scope ä½¿ç”¨çš„ PodCIDRs åˆ™æ˜¯ç”± Cilium operator æ¥åˆ†é…å’Œç®¡ç†çš„ï¼Œoperator å°†åˆ†é…çš„ PodCIDR é™„åŠ åœ¨ v2.CiliumNode ä¸Šã€‚\nAgent å¯åŠ¨åï¼Œä» v2.CiliumNode ä¸Šè·å– podCIDRsï¼Œè€Œååœ¨ CNI æ’ä»¶è°ƒç”¨æ—¶ä¸º pod åˆ†é… IP åœ°å€ã€‚\neBPF eBPF æ˜¯ä¸€ç§ Linux å†…æ ¸å­—èŠ‚ç è§£é‡Šå™¨ï¼Œæœ€åˆç”¨äºè¿‡æ»¤ç½‘ç»œæ•°æ®åŒ…ï¼Œä¾‹å¦‚ tcpdump å’Œå¥—æ¥å­—è¿‡æ»¤å™¨ã€‚æ­¤åï¼Œå®ƒæ‰©å±•äº†é¢å¤–çš„æ•°æ®ç»“æ„ï¼Œå¦‚å“ˆå¸Œè¡¨å’Œæ•°ç»„ï¼Œä»¥åŠæ”¯æŒæ•°æ®åŒ…å¤„ç†ã€è½¬å‘ã€å°è£…ç­‰çš„å…¶ä»–æ“ä½œã€‚\nCilium åˆ©ç”¨ eBPF æ‰§è¡Œæ ¸å¿ƒæ•°æ®è·¯å¾„è¿‡æ»¤ã€å¤„ç†ã€ç›‘æ§å’Œé‡å®šå‘ï¼Œå¹¶éœ€è¦ä»»ä½• Linux å†…æ ¸ç‰ˆæœ¬ 4.8.0 æˆ–æ›´é«˜ç‰ˆæœ¬çš„ eBPF åŠŸèƒ½ã€‚\nLinux å†…æ ¸ä¸€ç›´æ˜¯å®ç°ç›‘æ§/å¯è§‚æµ‹æ€§ã€ç½‘ç»œå’Œå®‰å…¨åŠŸèƒ½çš„ç†æƒ³åœ°æ–¹ã€‚ä¸è¿‡å¾ˆå¤šæƒ…å†µä¸‹è¿™å¹¶éæ˜“äº‹ï¼Œå› ä¸ºè¿™äº›å·¥ä½œéœ€è¦ä¿®æ”¹å†…æ ¸æºç æˆ–åŠ è½½å†…æ ¸æ¨¡å—ï¼Œæœ€ç»ˆå®ç°å½¢å¼æ˜¯åœ¨å·²æœ‰çš„å±‚å±‚æŠ½è±¡ä¹‹ä¸Šå åŠ æ–°çš„æŠ½è±¡ã€‚eBPF æ˜¯ä¸€é¡¹é©å‘½æ€§æŠ€æœ¯ï¼Œå®ƒèƒ½åœ¨å†…æ ¸ä¸­è¿è¡Œæ²™ç®±ç¨‹åºï¼ˆsandbox programsï¼‰ï¼Œè€Œæ— éœ€ä¿®æ”¹å†…æ ¸æºç æˆ–è€…åŠ è½½å†…æ ¸æ¨¡å—ã€‚\nå°† Linux å†…æ ¸å˜æˆå¯ç¼–ç¨‹ä¹‹åï¼Œå°±èƒ½åŸºäºç°æœ‰çš„ï¼ˆè€Œéå¢åŠ æ–°çš„ï¼‰æŠ½è±¡å±‚æ¥æ‰“é€ æ›´åŠ æ™ºèƒ½ã€åŠŸèƒ½æ›´åŠ ä¸°å¯Œçš„åŸºç¡€è®¾æ–½è½¯ä»¶ï¼Œè€Œä¸ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œä¹Ÿä¸ä¼šç‰ºç‰²æ‰§è¡Œæ•ˆç‡å’Œå®‰å…¨æ€§ã€‚\næ¦‚å¿µ æ ‡ç­¾ Label æ ‡ç­¾æ˜¯å¤„ç†å¤§é‡èµ„æºçš„é€šç”¨ã€çµæ´»ä¸”é«˜åº¦å¯æ‰©å±•çš„æ–¹å¼ï¼Œåœ¨ Kubernetes ä¸­ä¸ æ ‡ç­¾é€‰æ‹©å™¨ ä¸€èµ·è¢«å¹¿æ³›åº”ç”¨ã€‚ç®€å•æ¥è¯´ï¼Œä¸€ä¸ªæ ‡ç­¾å°±æ˜¯ä¸€ä¸ª key å’Œ value çš„ç»„åˆï¼škey=valueï¼ˆä½¿ç”¨æ—¶ä¹Ÿå¯ä¸æä¾› valueï¼‰ã€‚\nåœ¨ Cilium ä¸­æ ‡ç­¾æœ‰äº›è®¸ä¸åŒï¼šæ¯ä¸ªæ ‡ç­¾éƒ½æœ‰ä¸ªå‰ç¼€ [source]:ï¼Œè¿™ä¸ª source è¡¨ç¤ºè¯¥æ ‡ç­¾æ˜¯è¡ç”Ÿè‡ªå“ªé‡Œã€‚åˆ›å»º Pod æ—¶ï¼Œè¡ç”Ÿæ¥çš„æ ‡ç­¾ä¼šå¸¦æœ‰ k8s: å‰ç¼€ï¼Œå¦‚ k8s:io.kubernetes.pod.namespace=defaultï¼›è€Œä½¿ç”¨ docker run [...] -l foo=bar è¿è¡Œçš„å®¹å™¨ï¼Œåˆ™å¸¦æœ‰æ ‡ç­¾ container:foo=barã€‚\né™¤äº†åˆšæ‰æåˆ°çš„ k8s: å’Œ container:ï¼Œè¿˜æœ‰ä¸¤ç§ reserved: å’Œ unspec:ã€‚å‰è€…è¡¨ç¤ºæ˜¯ Cilium çš„ä¿ç•™æ ‡ç­¾ï¼Œåè€…åˆ™è¡¨ç¤ºæ²¡æœ‰æŒ‡å®šæ¥æºã€‚\nç«¯ç‚¹ Endpoint Cilium é€šè¿‡ä¸ºå®¹å™¨åˆ†é… IP åœ°å€ä½¿å…¶åœ¨ç½‘ç»œä¸Šå¯ç”¨ã€‚å¤šä¸ªå®¹å™¨å¯ä»¥å…±äº«åŒä¸€ä¸ª IP åœ°å€ï¼Œå°±åƒä¸€ä¸ª Kubernetes Pod ä¸­å¯ä»¥æœ‰å¤šä¸ªå®¹å™¨ï¼Œè¿™äº›å®¹å™¨ä¹‹é—´å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼Œä½¿ç”¨åŒä¸€ä¸ª IP åœ°å€ã€‚è¿™äº›å…±äº«åŒä¸€ä¸ªåœ°å€çš„å®¹å™¨ï¼ŒCilium å°†å…¶ç»„åˆèµ·æ¥ï¼Œæˆä¸º Endpointï¼ˆç«¯ç‚¹ï¼‰ã€‚\næ³¨æ„ï¼Œè¿™ä¸ª Endpoint ä¸ Kubernetes åŸç”Ÿèµ„æº v1.Endpoints ç±»ä¼¼ä½†å´ä¸åŒï¼ŒCilium ä¸ºå…¶æä¾›äº† CRD CiliumEndpointã€‚æœ¬æ–‡ä¸­æåˆ° Endpoint é™¤éç‰¹åˆ«è¯´æ˜ï¼Œéƒ½æ˜¯æŒ‡ CiliumEndpointã€‚\nkubectl get CiliumEndpoint -n default NAME ENDPOINT ID IDENTITY ID INGRESS ENFORCEMENT EGRESS ENFORCEMENT VISIBILITY POLICY ENDPOINT STATE IPV4 IPV6 curl 2580 1979 \u0026lt;status disabled\u0026gt; \u0026lt;status disabled\u0026gt; \u0026lt;status disabled\u0026gt; ready 10.42.0.171 httpbin 205 20965 \u0026lt;status disabled\u0026gt; \u0026lt;status disabled\u0026gt; \u0026lt;status disabled\u0026gt; ready 10.42.1.205 å¯ä»¥çœ‹åˆ°æˆ‘ä»¬éƒ¨ç½²çš„ç¤ºä¾‹åº”ç”¨å¯¹åº”çš„ Endpoint ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹ Endpoint curl çš„è¯¦ç»†ä¿¡æ¯ï¼š\napiVersion: cilium.io/v2 kind: CiliumEndpoint metadata: creationTimestamp: \u0026#34;2023-05-20T05:15:24Z\u0026#34; generation: 1 labels: app: curl name: curl namespace: default ownerReferences: - apiVersion: v1 kind: Pod name: curl uid: d34675ea-8f4d-4bad-a1c4-02d183380846 resourceVersion: \u0026#34;1197\u0026#34; uid: c4d7cdb5-c3a8-4ff8-bf03-d6623a0ec00a status: encryption: {} external-identifiers: container-id: 60dbc4edc0e5bf70b5290feea448559693b7fb51f7b1c3cf996b310c6cd8a576 k8s-namespace: default k8s-pod-name: curl pod-name: default/curl id: 2580 identity: id: 1979 labels: - k8s:app=curl - k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default - k8s:io.cilium.k8s.policy.cluster=default - k8s:io.cilium.k8s.policy.serviceaccount=default - k8s:io.kubernetes.pod.namespace=default networking: addressing: - ipv4: 10.42.0.171 node: 192.168.1.21 policy: egress: enforcing: false state: \u0026lt;status disabled\u0026gt; ingress: enforcing: false state: \u0026lt;status disabled\u0026gt; state: ready visibility-policy-status: \u0026lt;status disabled\u0026gt; Endpoint å¤§éƒ¨åˆ†ä¿¡æ¯éƒ½é›†ä¸­åœ¨ status éƒ¨åˆ†ã€‚ä¸ºäº†è¾¨åˆ« Endpointï¼Œæ¯ä¸ª Endpoint éƒ½æœ‰ä¸€ä¸ªåœ¨ Node èŠ‚ç‚¹èŒƒå›´ä¸Šå”¯ä¸€çš„ IDã€‚ æ¯”å¦‚ä½¿ç”¨ Endpoint curl çš„ ID 2580ï¼Œåœ¨æ‰€åœ¨èŠ‚ç‚¹çš„ agent ä¸­æ‰§è¡Œ cilium endpoint get 2580 åŒæ ·å¯ä»¥å¾—åˆ°ä¸ status éƒ¨åˆ†ç›¸åŒçš„ä¿¡æ¯ã€‚\né™¤æ­¤ä»¥å¤–æ¯ä¸ª Endpoint è¿˜æœ‰ä¸€ä¸ª Identityï¼ˆèº«ä»½ï¼‰ï¼Œèº«ä»½æ˜¯ç”¨äºæ‰§è¡Œåœ¨ Endpoint ä¹‹é—´æ‰§è¡ŒåŸºæœ¬è¿æ¥çš„ä¿¡æ¯ï¼Œåœ¨é›†ç¾¤èŒƒå›´å†…å”¯ä¸€ã€‚èº«ä»½ä¸­åŒ…å«äº†æ ‡ç­¾ä¿¡æ¯ï¼Œè¿™äº›æ ‡ç­¾ä¿¡æ¯æ˜¯åˆ›å»º Endpoint æ—¶ä» Pod æˆ–è€…å®¹å™¨æ¥çš„ã€‚\næ¯”å¦‚è¿™é‡Œæˆ‘ä»¬åˆ›å»º Pod curlï¼Œå®¹å™¨è¿è¡Œæ—¶å°† Pod ç›¸å…³çš„ä¿¡æ¯ä½œä¸ºæ‰§è¡Œ CNI ADD æ“ä½œçš„å‚æ•° CNI_ARGS ä¼ é€’ç»™ CNI æ’ä»¶ï¼ˆè¿™é‡Œæ˜¯ Cilium CNIï¼Œå¯¹è¿™éƒ¨åˆ†æœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸‹ä¹‹å‰çš„æ–‡ç«  ã€Šè®¤è¯†ä¸€ä¸‹å®¹å™¨ç½‘ç»œæ¥å£ CNIã€‹ï¼‰ã€‚Cilium CNI å°†è¿™äº›ä¿¡æ¯ä»¥åŠå…¶ä»–å†…å®¹ä½œä¸ºåˆ›å»º Endpoint çš„ä¾æ®ï¼Œä¼ é€’ç»™ cilium-agent æ¥åˆ›å»º Endpointã€‚è¿™äº›ä¿¡æ¯æœ€ç»ˆä½œä¸º identity.labels å­˜åœ¨ã€‚\nèŠ‚ç‚¹ Node Cilium ä¸­èŠ‚ç‚¹æ˜¯é›†ç¾¤çš„æˆå‘˜ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½å¿…é¡»è¿è¡Œ cilium-agentã€‚ä¸ Endpoint ä¸€æ ·ï¼ŒCilium ä¹Ÿæä¾›äº† CRD CiliumNodeï¼Œåé¢æ–‡ä¸­æåˆ°çš„èŠ‚ç‚¹ï¼Œå¦‚éç‰¹æŒ‡å‡æ˜¯ Cilium çš„ CiliumNodeã€‚\nkubectl get CiliumNode NAME AGE ubuntu-test1 14m ubuntu-test2 13m å·¥ä½œæœºåˆ¶ ä¸‹é¢åªæ˜¯ç®€å•æ¦‚æ‹¬äº† Cilium åœ¨å‡ ä¸ªåœºæ™¯ä¸‹çš„å·¥ä½œåŸç†ï¼Œå¿½ç•¥äº†å¤§é‡çš„ç»†èŠ‚ã€‚\næ–°èŠ‚ç‚¹åŠ å…¥ Cilium Agent ä»¥ DaemonSet çš„æ–¹å¼éƒ¨ç½²ï¼Œè¿è¡Œåœ¨å„ä¸ª Node èŠ‚ç‚¹ä¸Šã€‚å½“æœ‰æ–°çš„èŠ‚ç‚¹åŠ å…¥æ—¶ï¼ŒOperator ä¼šç›‘æµ‹åˆ°æ–°çš„èŠ‚ç‚¹åŠ å…¥ï¼Œä¸ºèŠ‚ç‚¹åˆ†é… Pod CIDR å¹¶åˆ›å»º CiliumNodeã€‚\næ–°çš„ Agent å®ä¾‹è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œæ¥ç€ä¸ºèŠ‚ç‚¹ä¸Šçš„ CLIã€CNI ç­‰æ“ä½œæä¾› API çš„æ”¯æŒï¼›åŠ è½½åŸºç¡€ BPF ç¨‹åºï¼›åˆå§‹åŒ– BPF Map ç­‰æ“ä½œã€‚\nPod åˆ›å»º å½“å®¹å™¨è¿è¡Œæ—¶é€šè¿‡ CNI æ¥åˆ›å»º Pod çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œå½“æ‰§è¡Œåˆ° CNI æ’ä»¶æ—¶ï¼ŒCNI æ’ä»¶ä¼šè°ƒç”¨ Agent API æ¥åˆ†é… IP åœ°å€ã€åˆ›å»º CiliumEndpointï¼Œå¹¶åœ¨ Pod çš„ç½‘ç»œå‘½åç©ºé—´ä¸­åŠ è½½å¿…è¦çš„ BPF ç¨‹åºã€‚\nç½‘ç»œç­–ç•¥ ä½¿ç”¨ Cilium çš„ CiliumNetworkPolicy å¯ä»¥çµæ´»åœ°å®šä¹‰åº”ç”¨çš„ç½‘ç»œé€šä¿¡ç­–ç•¥ï¼Œä¾‹å¦‚å…è®¸æˆ–æ‹’ç»ç‰¹å®šçš„æµé‡æµå…¥å’Œæµå‡ºåº”ç”¨ã€‚ä»¥æ­¤ä¿è¯åªæœ‰ç»è¿‡æˆæƒçš„æµé‡å¯ä»¥è®¿é—®åº”ç”¨ç¨‹åºï¼Œæä¾›ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ã€‚\nä»¥ ã€Šä½¿ç”¨ Cilium å¢å¼º Kubernetes ç½‘ç»œå®‰å…¨ã€‹ ä¸­ä½¿ç”¨çš„ç­–ç•¥ä¸ºä¾‹ã€‚\napiVersion: \u0026#34;cilium.io/v2\u0026#34; kind: CiliumNetworkPolicy metadata: name: \u0026#34;rule1\u0026#34; spec: description: \u0026#34;L7 policy to restrict access to specific HTTP call\u0026#34; endpointSelector: matchLabels: org: empire class: deathstar ingress: - fromEndpoints: - matchLabels: org: empire toPorts: - ports: - port: \u0026#34;80\u0026#34; protocol: TCP rules: http: - method: \u0026#34;POST\u0026#34; path: \u0026#34;/v1/request-landing\u0026#34; Cilium Agent ä¸­è¿è¡Œç€å¤§é‡çš„ watcherï¼Œå…¶ä¸­ä¸€ä¸ªå°±æ˜¯ CiliumNetworkPolicy watcherã€‚å½“ç­–ç•¥åˆ›å»ºæˆ–è€…æ›´æ–°æ—¶ï¼ŒAgent ä¼šå¯¹ç­–ç•¥è¿›è¡Œè½¬æ¢å¹¶å°†è§„åˆ™å­˜å‚¨åˆ° BPF Map ä¸­ã€‚åœ¨ç½‘ç»œé€šä¿¡æ—¶ï¼ŒBPF ç¨‹åºä¼šå¯¹ç½‘ç»œæµé‡è¿›è¡Œæ£€æŸ¥å¹¶å†³å®šåº”å½“å…è®¸æˆ–è€…æ‹’ç»è®¿é—®ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-andrea-p-coan-878352.jpg","permalink":"https://atbug.com/deep-dive-into-cilium/","tags":["Kubernetes","Cilium","eBPF"],"title":"æ·±å…¥æ¢ç´¢ Cilium çš„å·¥ä½œæœºåˆ¶"},{"categories":["äº‘åŸç”Ÿ"],"contents":"èƒŒæ™¯ åœ¨ Kubernetes ä¸Šï¼Œä»éƒ¨ç½² Deployment åˆ°æ­£å¸¸æä¾›æœåŠ¡ï¼Œæ•´ä¸ªæµç¨‹å¯èƒ½ä¼šå‡ºç°å„ç§å„æ ·é—®é¢˜ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æµè§ˆ Kubernetes Deployment çš„æ•…éšœæ’æŸ¥å¯è§†åŒ–æŒ‡å—ï¼ˆ2021 ä¸­æ–‡ç‰ˆï¼‰ã€‚ä»å¯è§†åŒ–æŒ‡å—ä¹Ÿå¯èƒ½çœ‹å‡ºè¿™äº›é—®é¢˜å®é™…ä¸Šéƒ½æ˜¯æœ‰è¿¹å¯å¾ªï¼Œæ ¹æ®é”™è¯¯ä¿¡æ¯åŸºæœ¬å¾ˆå®¹æ˜“æ‰¾åˆ°è§£å†³æ–¹æ³•ã€‚éšç€ ChatGPT çš„æµè¡Œï¼ŒåŸºäº LLM çš„æ–‡æœ¬ç”Ÿæˆé¡¹ç›®ä¸æ–­æ¶Œç°ï¼Œk8sgpt ä¾¿æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚\nk8sgpt æ˜¯ä¸€ä¸ªæ‰«æ Kubernetes é›†ç¾¤ã€è¯Šæ–­å’Œåˆ†ç±»é—®é¢˜çš„å·¥å…·ã€‚å®ƒå°† SRE ç»éªŒç¼–å…¥å…¶åˆ†æå™¨ï¼Œå¹¶é€šè¿‡ AI å¸®åŠ©æå–å¹¶ä¸°å¯Œç›¸å…³çš„ä¿¡æ¯ã€‚\nå…¶å†…ç½®äº†å¤§é‡çš„åˆ†æå™¨ï¼š\npodAnalyzer pvcAnalyzer rsAnalyzer serviceAnalyzer eventAnalyzer ingressAnalyzer statefulSetAnalyzer deploymentAnalyzer cronJobAnalyzer nodeAnalyzer hpaAnalyzerï¼ˆå¯é€‰ï¼‰ pdbAnalyzerï¼ˆå¯é€‰ï¼‰ networkPolicyAnalyzerï¼ˆå¯é€‰ï¼‰ k8sgpt çš„èƒ½åŠ›æ˜¯é€šè¿‡ CLI æ¥æä¾›çš„ï¼Œé€šè¿‡ CLI å¯ä»¥å¯¹é›†ç¾¤ä¸­çš„é”™è¯¯è¿›è¡Œå¿«é€Ÿçš„è¯Šæ–­ã€‚\nk8sgpt analyze --explain --filter=Pod --namespace=default --output=json { \u0026#34;status\u0026#34;: \u0026#34;ProblemDetected\u0026#34;, \u0026#34;problems\u0026#34;: 1, \u0026#34;results\u0026#34;: [ { \u0026#34;kind\u0026#34;: \u0026#34;Pod\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;default/test\u0026#34;, \u0026#34;error\u0026#34;: [ { \u0026#34;Text\u0026#34;: \u0026#34;Back-off pulling image \\\u0026#34;flomesh/pipy2\\\u0026#34;\u0026#34;, \u0026#34;Sensitive\u0026#34;: [] } ], \u0026#34;details\u0026#34;: \u0026#34;The Kubernetes system is experiencing difficulty pulling the requested image named \\\u0026#34;flomesh/pipy2\\\u0026#34;. \\n\\nThe solution may be to check that the image is correctly spelled or to verify that it exists in the specified container registry. Additionally, ensure that the networking infrastructure that connects the container registry and Kubernetes system is working properly. Finally, check if there are any access restrictions or credentials required to pull the image and ensure they are provided correctly.\u0026#34;, \u0026#34;parentObject\u0026#34;: \u0026#34;test\u0026#34; } ] } ä½†æ˜¯ï¼Œæ¯æ¬¡è¿›è¡Œè¯Šæ–­éƒ½è¦æ‰§è¡Œå‘½ä»¤ï¼Œæœ‰ç‚¹ç¹çä¸”é™åˆ¶è¾ƒå¤šã€‚æˆ‘æƒ³å¤§å®¶æƒ³è¦çš„è‚¯å®šæ˜¯èƒ½å¤Ÿç›‘æ§åˆ°é—®é¢˜å¹¶è‡ªåŠ¨è¯Šæ–­ã€‚è¿™å°±æœ‰äº†ä»Šå¤©è¦ä»‹ç»çš„ k8sgpt-operator\nä»‹ç» ç®€å•æ¥è¯´ k8sgpt-operator å¯ä»¥åœ¨é›†ç¾¤ä¸­å¼€å¯è‡ªåŠ¨åŒ–çš„ k8sgptã€‚å®ƒæä¾›äº†ä¸¤ä¸ª CRDï¼š K8sGPT å’Œ Resultã€‚å‰è€…å¯ä»¥ç”¨æ¥è®¾ç½® k8sgpt åŠå…¶è¡Œä¸ºï¼›è€Œåè€…åˆ™æ˜¯ç”¨æ¥å±•ç¤ºé—®é¢˜èµ„æºçš„è¯Šæ–­ç»“æœã€‚\napiVersion: core.k8sgpt.ai/v1alpha1 kind: K8sGPT metadata: name: k8sgpt-sample namespace: kube-system spec: model: gpt-3.5-turbo backend: openai noCache: false version: v0.2.7 enableAI: true secret: name: k8sgpt-sample-secret key: openai-api-key æ¼”ç¤º å®éªŒç¯å¢ƒä½¿ç”¨ k3s é›†ç¾¤ã€‚\nexport INSTALL_K3S_VERSION=v1.23.8+k3s2 curl -sfL https://get.k3s.io | sh -s - --disable traefik --disable local-storage --disable servicelb --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config å®‰è£… k8sgpt-operator helm repo add k8sgpt https://charts.k8sgpt.ai/ helm repo update helm install release k8sgpt/k8sgpt-operator -n openai --create-namespace å®‰è£…å®Œæˆåï¼Œå¯ä»¥çœ‹åˆ°éš operator å®‰è£…çš„ä¸¤ä¸ª CRDï¼šk8sgpts å’Œ resultsã€‚\nkubectl api-resources | grep -i gpt k8sgpts core.k8sgpt.ai/v1alpha1 true K8sGPT results core.k8sgpt.ai/v1alpha1 true Result åœ¨å¼€å§‹ä¹‹å‰ï¼Œéœ€è¦å…ˆç”Ÿæˆä¸€ä¸ª OpenAI çš„ keyï¼Œå¹¶ä¿å­˜åˆ° secret ä¸­ã€‚\nOPENAI_TOKEN=xxxx kubectl create secret generic k8sgpt-sample-secret --from-literal=openai-api-key=$OPENAI_TOKEN -n openai æ¥ä¸‹æ¥åˆ›å»º K8sGPT èµ„æºã€‚\nkubectl apply -n openai -f - \u0026lt;\u0026lt; EOF apiVersion: core.k8sgpt.ai/v1alpha1 kind: K8sGPT metadata: name: k8sgpt-sample spec: model: gpt-3.5-turbo backend: openai noCache: false version: v0.2.7 enableAI: true secret: name: k8sgpt-sample-secret key: openai-api-key EOF æ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤ååœ¨ openai å‘½åç©ºé—´ä¸‹ä¼šè‡ªåŠ¨åˆ›å»º Deployment k8sgpt-deployment ã€‚\næµ‹è¯• ä½¿ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„é•œåƒåˆ›å»º podã€‚\nkubectl run test --image flomesh/pipy2 -n default ç„¶ååœ¨ openai å‘½åç©ºé—´ä¸‹ä¼šçœ‹åˆ°ä¸€ä¸ªåä¸º defaulttest çš„èµ„æºã€‚\nkubectl get result -n openai NAME AGE defaulttest 5m7s è¯¦ç»†ä¿¡æ¯ä¸­å¯ä»¥çœ‹åˆ°è¯Šæ–­å†…å®¹ä»¥åŠå‡ºç°é—®é¢˜çš„èµ„æºã€‚\nkubectl get result -n openai defaulttest -o yaml apiVersion: core.k8sgpt.ai/v1alpha1 kind: Result metadata: creationTimestamp: \u0026#34;2023-05-02T09:00:32Z\u0026#34; generation: 1 name: defaulttest namespace: openai resourceVersion: \u0026#34;1466\u0026#34; uid: 2ee27c26-61c1-4ef5-ae27-e1301a40cd56 spec: details: \u0026#34;The error message is indicating that Kubernetes is having trouble pulling the image \\\u0026#34;flomesh/pipy2\\\u0026#34; and is therefore backing off from trying to do so. \\n\\nThe solution to this issue would be to check that the image exists and that the spelling and syntax of the image name is correct. Additionally, check that the image is accessible from the Kubernetes cluster and that any required authentication or authorization is in place. If the issue persists, it may be necessary to troubleshoot the network connectivity between the Kubernetes cluster and the image repository.\u0026#34; error: - text: Back-off pulling image \u0026#34;flomesh/pipy2\u0026#34; kind: Pod name: default/test parentObject: test ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/k8sgpt-opeartor.png","permalink":"https://atbug.com/automatic-diagnosis-of-kubernetes-clusters-using-k8sgpt-operator/","tags":["AI","Kubernetes","SRE"],"title":"Kubernetes è‡ªåŠ¨åŒ–è¯Šæ–­å·¥å…·ï¼šk8sgpt-operator"},{"categories":["ç¬”è®°","äº‘åŸç”Ÿ"],"contents":"Kubernetes ä½œä¸ºä¸€é¡¹æ ¸å¿ƒæŠ€æœ¯å·²æˆä¸ºç°ä»£åº”ç”¨ç¨‹åºæ¶æ„çš„åŸºç¡€ï¼Œè¶Šæ¥è¶Šå¤šçš„ä¼ä¸šä½¿ç”¨ Kubernetes ä½œä¸ºå®¹å™¨ç¼–æ’ç³»ç»Ÿã€‚\nä¸‹é¢çš„æ•°æ®æ¥è‡ª 2020 CNCF Survey çš„åŸå§‹æ•°æ®ï¼Œå¯ä»¥çœ‹åˆ°ä½¿ç”¨ Kubernete çš„ä¼ä¸šå æ¯”è¾¾åˆ°äº† 80%ã€‚\nKubernetes çš„æµè¡Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªåŸå› ï¼š\nè‡ªåŠ¨åŒ–ï¼šKubernetes å®ç°äº†å®¹å™¨çš„éƒ¨ç½²ã€æ‰©å±•ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœæ¢å¤ã€æ»šåŠ¨æ›´æ–°ç­‰æ“ä½œçš„è‡ªåŠ¨åŒ–ï¼Œæå¤§åœ°ç®€åŒ–äº†åº”ç”¨ç¨‹åºçš„ç®¡ç†å’Œç»´æŠ¤å·¥ä½œã€‚è¿™ç§è‡ªåŠ¨åŒ–ä¹Ÿæå‡äº†åº”ç”¨ç¨‹åºçš„å¼¹æ€§å’Œå¯ç”¨æ€§ã€‚ å¯ç§»æ¤æ€§ï¼šKubernetes åŸºäºå®¹å™¨çš„æ¶æ„æ¨¡å‹ï¼Œä½¿å¾—åº”ç”¨æ— éœ€é‡æ–°ç¼–ç æˆ–æ›´æ–°é…ç½®å°±å¯ä»¥åœ¨ä»»ä½•äº‘å¹³å°ã€ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºä¸­è¿è¡Œã€‚ ç”Ÿæ€ç³»ç»Ÿï¼šKubernetes ä½œä¸ºä¸€ä¸ªæˆåŠŸåœ°å¼€æºé¡¹ç›®ï¼Œæ‹¥æœ‰å¼ºå¤§çš„ç¤¾åŒºæ”¯æŒå’Œç”Ÿæ€ç³»ç»Ÿï¼Œä½¿å…¶å¯ä»¥è·å¾—æ›´å¥½çš„åˆ›æ–°ã€ä¼˜åŒ–å’Œå®‰å…¨æ€§ä¿éšœã€‚ä»ç¤¾åŒºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å„ç§æ’ä»¶å’Œå·¥å…·ï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä¸°å¯Œçš„é€‰æ‹©å’Œæ‰©å±•æ€§ã€‚ ä»å• Kubernetes é›†ç¾¤åˆ°å¤š Kubernetes é›†ç¾¤ åˆéœ²ç«¯å€ª ä¼ä¸šä¸­çš„åº”ç”¨ç¨‹åºé€šå¸¸æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦ä¸åŒçš„ç¯å¢ƒæ¥è¿›è¡Œå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§éƒ¨ç½²ã€‚ä¸ºäº†é¿å…åº”ç”¨ç¨‹åºä¹‹é—´çš„å¹²æ‰°å’Œäº¤å‰ï¼Œé€šå¸¸éœ€è¦åœ¨ä¸åŒçš„ Kubernetes é›†ç¾¤ä¸­åˆ†åˆ«éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ç¨‹åºã€‚\nåœ¨åŒä¸€ä¸ªæ•°æ®ä¸­å¿ƒä¸åŒçš„ç¯å¢ƒéƒ¨ç½²ç‹¬ç«‹çš„ Kubernetes é›†ç¾¤ä¹‹åä¸åŒç¯å¢ƒä¸‹çš„é›†ç¾¤è§„æ¨¡ã€ç®¡ç†æ–¹å¼ã€å¯é æ€§å’Œå®‰å…¨æ€§å„æœ‰ä¸åŒï¼Œä»å¼€å‘ã€æµ‹è¯•åˆ°ç”Ÿäº§ï¼Œæˆæœ¬çš„æŠ•å…¥ä¹Ÿé€æ­¥åœ°æå‡ï¼Œæ¥ä¿è¯æ›´å¥½çš„æ€§èƒ½ã€æ›´é«˜çš„å¯é æ€§å’Œå®‰å…¨æ€§ã€‚\nè¿™ä¹Ÿæ˜¯å¤š Kubernetes é›†ç¾¤çš„ä¸€ç§å½¢å¼ï¼ˆæ³¨æ„è¿™é‡Œè¯´çš„æ˜¯ å¤š Kubernetes é›†ç¾¤ï¼‰ã€‚\nè¿…çŒ›å‘å±• éšç€å¯¹äº‘è®¡ç®—æ¥å—ç¨‹åº¦ä¸æ–­æé«˜ã€ä¼ä¸šè§„æ¨¡çš„æŒç»­å¢é•¿ï¼Œè¶Šæ¥è¶Šå¤šçš„ä¼ä¸šå¼€å§‹è€ƒè™‘é‡‡ç”¨æˆ–è€…å·²ç»é‡‡ç”¨å¤šäº‘å’Œæ··åˆäº‘çš„æ¶æ„ã€‚å¤šäº‘å’Œæ··åˆäº‘çš„é©±åŠ¨å› ç´ å¾ˆå¤šï¼Œæ€»ç»“ä¹‹ååˆ†æˆäº†ä¸¤ç±»ï¼šä¸»åŠ¨å› ç´ å’Œè¢«åŠ¨å› ç´ ã€‚\nä¸»åŠ¨å› ç´  é¿å…å‚å•†é”å®šï¼šé¿å…å‚å•†é”å®šï¼šä¼ä¸šé€šè¿‡é‡‡ç”¨å¤šäº‘æ··åˆäº‘ç­–ç•¥ï¼Œå¯ä»¥é¿å…è¿‡åº¦ä¾èµ–å•ä¸€äº‘æœåŠ¡æä¾›å•†ï¼Œä»è€Œå‡è½»ç”±å‚å•†é”å®šå¸¦æ¥çš„é£é™©ã€‚ æå‡æ€§èƒ½ã€é™ä½å»¶è¿Ÿï¼šä¼ä¸šæ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œå°†æœåŠ¡éƒ¨ç½²åœ¨åœ°ç†ä½ç½®æ›´æ¥è¿‘ç”¨æˆ·çš„æ•°æ®ä¸­å¿ƒã€‚ æ›´å¤§èŒƒå›´çš„ä¼¸ç¼©æ€§ï¼šåœ¨ä¸åŒçš„äº‘æœåŠ¡æä¾›å•†ä¹‹é—´å®ç°èµ„æºçš„å¼¹æ€§ä¼¸ç¼©ï¼Œä»è€Œæä¾›æ›´å¤§èŒƒå›´çš„ä¼¸ç¼©æ€§ä»¥æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ã€‚ æå‡å¯é æ€§ï¼šåœ¨ä¸åŒçš„äº‘æœåŠ¡æä¾›å•†å’Œç§æœ‰æ•°æ®ä¸­å¿ƒä¹‹é—´è¿›è¡Œåº”ç”¨éƒ¨ç½²ä¹‹åï¼Œå³ä½¿æŸä¸ªäº‘æœåŠ¡æä¾›å•†å‡ºç°æ•…éšœï¼Œä¼ä¸šçš„åº”ç”¨ä»å¯ç»§ç»­è¿è¡Œã€‚ æˆæœ¬å› ç´ ï¼šå¯ä»¥é€‰æ‹©æ€§åœ°ä½¿ç”¨å„ä¸ªäº‘æœåŠ¡æä¾›å•†æä¾›çš„æœåŠ¡ï¼Œä»¥ä¾¿åœ¨æˆæœ¬å’Œæ€§èƒ½ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ã€‚ è¢«åŠ¨å› ç´  æ•°æ®ä¸­å¿ƒèƒ½åŠ›é™åˆ¶ï¼šæ•°æ®ä¸­å¿ƒåŸºç¡€è®¾æ–½çš„è§„æ¨¡ã€æ€§èƒ½æ— æ³•æ»¡è¶³éœ€æ±‚ã€‚ ä¸Šäº‘ã€ä¸‹äº‘çš„è¿‡æ¸¡æœŸï¼šåœ¨ä¸Šäº‘æˆ–ä¸‹äº‘çš„è¿‡ç¨‹ä¸­ï¼Œå­˜åœ¨ç€å…¬æœ‰äº‘å’Œç§æœ‰äº‘å…±å­˜çš„ç°è±¡ï¼Œè¿‡æ¸¡æœŸå¯èƒ½ä¼šè¢«æ‹‰é•¿ã€‚ å•ä¸€äº‘è¦†ç›–åŒºåŸŸæœ‰é™ï¼šå°½ç®¡äº‘æœåŠ¡æä¾›å•†ä¸æ–­æ‰©å±•å…¶å…¨çƒæ•°æ®ä¸­å¿ƒçš„è¦†ç›–èŒƒå›´ï¼Œä½†ä»ç„¶å¯èƒ½å­˜åœ¨å•ä¸€äº‘æœåŠ¡æä¾›å•†æ— æ³•æ»¡è¶³ä¼ä¸šåœ¨ç‰¹å®šåœ°åŒºçš„éƒ¨ç½²éœ€æ±‚çš„æƒ…å†µã€‚ ä¸šåŠ¡éš”ç¦»ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¼ä¸šéœ€è¦å¯¹ä¸åŒä¸šåŠ¡è¿›è¡Œéš”ç¦»ï¼Œä»¥é™ä½é£é™©å’Œæé«˜å®‰å…¨æ€§ã€‚å°†åº”ç”¨éƒ¨ç½²åˆ°ä¸åŒçš„æ•°æ®ä¸­å¿ƒï¼Œæ¥ç¡®ä¿æ•æ„Ÿæ•°æ®å’Œå…³é”®åº”ç”¨çš„å®‰å…¨ã€‚ åˆè§„å’Œæ•°æ®éš”ç¦»ï¼šä¸åŒå›½å®¶å’Œåœ°åŒºå¯èƒ½æœ‰ä¸åŒçš„æ³•è§„è¦æ±‚ï¼Œè¿™äº›è¦æ±‚å¯èƒ½ä¼šé™åˆ¶ä¼ä¸šåœ¨ç‰¹å®šäº‘æœåŠ¡æä¾›å•†ä¸Šå­˜å‚¨å’Œå¤„ç†æ•°æ®ã€‚ å¤šäº‘æ··åˆäº‘ç­–ç•¥çš„å¼•å…¥ï¼Œç›¸åº”åœ°ï¼ŒKubernetes é›†ç¾¤çš„æ•°é‡ä¹Ÿå˜å¾—è¶Šæ¥è¶Šå¤šã€‚è™½ç„¶é›†ç¾¤çš„æ•°é‡åœ¨å¢åŠ ï¼Œä½†æ˜¯æœ¬è´¨ä¸å•é›†ç¾¤æ— å¼‚ï¼šæ¯ä¸ª Kubernetes é›†ç¾¤æœ‰è‡ªå·±çš„æ§åˆ¶å¹³é¢ï¼ˆapi-serverã€æ§åˆ¶å™¨ï¼‰å’Œä¸€ç»„å·¥ä½œèŠ‚ç‚¹ï¼Œå¯ä»¥ç‹¬ç«‹è¿›è¡Œåº”ç”¨ç¨‹åºçš„éƒ¨ç½²å’Œç®¡ç†ï¼ˆè¿™å°±æ˜¯ä¸ºä½•å‰é¢ç§°ä¹‹ä¸ºå¤š Kubernetes é›†ç¾¤ï¼‰ã€‚åœ¨â€œå¤šé›†ç¾¤â€ç¯å¢ƒä¸‹ï¼Œæ¯ä¸ªé›†ç¾¤æ˜¯ç‹¬ç«‹çš„ï¼Œå½“éœ€è¦ç®¡ç†çš„æ—¶å€™ï¼Œé‡‡ç”¨çš„æ˜¯â€œä¸€ä¸ªä¸€ä¸ªç®¡ç†â€çš„æ–¹å¼ã€‚\næŒ‘æˆ˜å¤šå¤š å¤š Kubernetes é›†ç¾¤å¯ä»¥åœ¨ä¸åŒçš„äº‘å¹³å°ã€ä¸åŒçš„æ•°æ®ä¸­å¿ƒã€ä¸åŒçš„ç½‘ç»œç¯å¢ƒå’Œä¸åŒçš„ç‰©ç†åŸºç¡€è®¾æ–½ä¸­éƒ¨ç½²ï¼Œä»¥æ»¡è¶³ä¸åŒçš„åº”ç”¨ç¨‹åºå’Œä¸šåŠ¡éœ€æ±‚ã€‚ä½†éšç€é›†ç¾¤æ•°é‡çš„å¢åŠ ï¼Œä¹Ÿé¢ä¸´ç€è¯¸å¤šæŒ‘æˆ˜ï¼š\né›†ç¾¤ç®¡ç†å¤æ‚æ€§å¢åŠ ï¼šä¸åŒçš„ Kubernetes é›†ç¾¤éƒ¨ç½²åœ¨ä¸åŒçš„äº‘æœåŠ¡å•†å¹³å°ä¸Šï¼Œæ‹¥æœ‰ä¸åŒçš„ç½‘ç»œæ¶æ„å’Œå®‰å…¨ç­–ç•¥ã€‚éšç€æ•°é‡çš„å¢åŠ ï¼Œé›†ç¾¤ç®¡ç†çš„å¤æ‚æ€§ä¹Ÿä¼šç›¸åº”å¢åŠ ã€‚è¿™åŒ…æ‹¬èµ„æºåˆ†é…ã€è®¿é—®æ§åˆ¶ã€ç½‘ç»œç®¡ç†ã€é›†ç¾¤å‡çº§å’Œç»´æŠ¤ç­‰æ–¹é¢ã€‚ åº”ç”¨ç®¡ç†æˆæœ¬å¢åŠ ï¼šä¼ä¸šéœ€è¦åœ¨å¤šä¸ª Kubernetes é›†ç¾¤ä¸Šéƒ¨ç½²å’Œç®¡ç†åº”ç”¨ç¨‹åºã€‚ è·¨é›†ç¾¤ç½‘ç»œå’ŒæœåŠ¡é€šä¿¡ï¼šKubernetes å¤©ç„¶çš„ç½‘ç»œéš”ç¦»ç‰¹æ€§ï¼Œåˆå› ä¸ºéƒ¨ç½²åœ¨ä¸åŒç½‘ç»œæ¶æ„çš„äº‘å¹³å°ä¸Šï¼Œéœ€è¦è§£å†³è·¨é›†ç¾¤ç½‘ç»œå’ŒæœåŠ¡é€šä¿¡çš„é—®é¢˜ã€‚è¿™åŒ…æ‹¬è·¨å¹³å°ç½‘ç»œäº’è”ã€è·¨é›†ç¾¤æœåŠ¡å‘ç°å’Œè·¯ç”±ç­‰é—®é¢˜ã€‚ ä»å¤š Kubernetes é›†ç¾¤åˆ° Kubernetes å¤šé›†ç¾¤ ä¸ºäº†åº”å¯¹ä¸Šé¢çš„ç§ç§æŒ‘æˆ˜ï¼Œå‡ºç°äº†å¦ä¸€ä¸ªæ¦‚å¿µ Kubernetes å¤šé›†ç¾¤ã€‚Kubernetes å¤šé›†ç¾¤å’Œå¤š Kubernetes é›†ç¾¤æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼Œä¸ºäº†ä¾¿äºåŒºåˆ†æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å…¶ç§°ä¸º Kubernetes è”é‚¦ã€‚\nKubernetes è”é‚¦æ˜¯å°†å¤šä¸ª Kubernetes é›†ç¾¤è¿æ¥åœ¨ä¸€èµ·ï¼Œä»¥ä¾¿ååŒå·¥ä½œå’Œå®ç°è·¨é›†ç¾¤èµ„æºå’Œåº”ç”¨çš„ç»Ÿä¸€ç®¡ç†ã€è·¨åœ°åŸŸå’Œè·¨äº‘çš„æ•…éšœåˆ‡æ¢ã€æ ¹æ®å®é™…éœ€æ±‚åŠ¨æ€åˆ†é…èµ„æºé™ä½æˆæœ¬ã€æå‡ä¸šåŠ¡çš„çµæ´»æ€§å’Œæ‰©å±•æ€§ã€‚\nè™½ç„¶å¯¹äºå¦‚ä½•è¿æ¥å¤šä¸ª Kubernetes é›†ç¾¤æ²¡æœ‰å®˜æ–¹çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å¾—ç›Šäºå¼ºå¤§çš„ç¤¾åŒºå’Œç”Ÿæ€ï¼Œå·²æœ‰ä¸å°‘å¼€æºå’Œå•†ä¸šåŒ–çš„è§£å†³æ–¹æ¡ˆã€‚\né›†ç¾¤ç®¡ç†å¤æ‚æ€§ ä½¿ç”¨é›†ä¸­å¼çš„å¤šé›†ç¾¤ç®¡ç†å¹³å°ï¼Œåœ¨ä¸€ä¸ªç»Ÿä¸€çš„ç•Œé¢ä¸­ç®¡ç†å¤šäº‘æ··åˆäº‘ä¸­çš„ Kubernetes é›†ç¾¤ï¼Œæä¾›é›†ç¾¤åˆ›å»ºã€é…ç½®ã€ç›‘æ§å’Œæ•…éšœæ’æŸ¥çš„åŠŸèƒ½ï¼Œä½¿é›†ç¾¤ç®¡ç†å˜å¾—æ›´åŠ ç®€å•å’Œé«˜æ•ˆï¼ŒåŒæ—¶æé«˜é›†ç¾¤çš„å¯é æ€§å’Œå¯ç”¨æ€§ã€‚\nåœ¨å·¥å…·æ–¹é¢æœ‰ KubeSphereã€Rancher ä»¥åŠä¼—å¤šå…¬æœ‰äº‘çš„æ–¹æ¡ˆ Google Anthosã€Azure Arcã€Red Hat Advanced Cluster Managementï¼ˆACMï¼‰ã€AliCloud ACK ç­‰ç­‰ã€‚\nåº”ç”¨ç®¡ç† ä½¿ç”¨è‡ªåŠ¨åŒ–çš„å¤šé›†ç¾¤åº”ç”¨ç¼–æ’å’Œç®¡ç†å¹³å°ï¼Œè§£å†³å¤šé›†ç¾¤ã€å¤šäº‘ç¯å¢ƒä¸‹åº”ç”¨ç¨‹åºçš„å¿«é€Ÿéƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†é—®é¢˜ï¼Œä¿è¯åº”ç”¨ç¨‹åºçš„å¯é æ€§ã€‚\né™¤äº†å‰é¢æåˆ°å¤šé›†ç¾¤ç®¡ç†å¹³å°æä¾›äº†åº”ç”¨ç®¡ç†èƒ½åŠ›ä»¥å¤–ï¼Œè¿˜æœ‰å¦‚ Kubernetes Federationï¼ˆå‰è€… 22 å¹´ 8 æœˆå·²å­˜æ¡£ï¼‰ã€Karmada ç­‰å¼€æºå¤šé›†ç¾¤åº”ç”¨ç®¡ç†å¹³å°ã€‚\nè·¨é›†ç¾¤ç½‘ç»œå’ŒæœåŠ¡é€šä¿¡ é™ä½å¤šé›†ç¾¤ç¯å¢ƒä¸­çš„ç½‘ç»œå¤æ‚æ€§ã€‚ä½¿ç”¨æœåŠ¡ç½‘æ ¼æŠ€æœ¯ï¼Œç®¡ç†è·¨å¤šä¸ªé›†ç¾¤çš„æœåŠ¡æµé‡ã€å®‰å…¨æ€§å’Œå¯è§‚æµ‹æ€§ï¼Œå®ç°è·¨é›†ç¾¤çš„æœåŠ¡å‘ç°å’Œé€šä¿¡ï¼›æˆ–è€…é‡‡ç”¨è·¨é›†ç¾¤çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆå®ç°ç½‘ç»œäº’é€šã€‚\næœåŠ¡ç½‘æ ¼æŠ€æœ¯æœ‰ Istioã€Linkerdã€Flomesh ç­‰ï¼Œç½‘ç»œè§£å†³æ–¹æ¡ˆæœ‰ Submarinerã€‚\næ€»ç»“ åœ¨å¤šäº‘ã€æ··åˆäº‘æˆä¸ºè¶‹åŠ¿çš„å½“ä¸‹ï¼ŒKubernetes å¤šé›†ç¾¤ä¹Ÿä¸æ–­åœ°è¢«æåŠå¹¶é€æ¸æˆä¸ºé‡è¦çš„è§£å†³æ–¹æ¡ˆã€‚Kubernetes å¤šé›†ç¾¤çš„è®¨è®ºå·²ä¸å†å±€é™äºé›†ç¾¤å’Œåº”ç”¨çš„ç®¡ç†ï¼Œè¿˜å¼•å…¥äº†è·¨é›†ç¾¤çš„æœåŠ¡é€šä¿¡ã€‚\nå¤šé›†ç¾¤å¯ä»¥ä¸ºä¼ä¸šæä¾›æ›´çµæ´»ã€æ›´å¯é çš„åº”ç”¨éƒ¨ç½²å’Œç®¡ç†èƒ½åŠ›ï¼Œä½¿ä¼ä¸šèƒ½å¤Ÿæ›´å¥½åœ°åˆ©ç”¨æ··åˆå¤šäº‘ç¯å¢ƒä¸­çš„èµ„æºï¼Œé™ä½è¿è¥æˆæœ¬ï¼Œæé«˜åº”ç”¨çš„å¯é æ€§ã€‚é™¤æ­¤ä»¥å¤–ï¼Œè¿˜å¯ä»¥åŠ©åŠ›ä¼ä¸šæ›´å¿«é€Ÿåœ°è¿›è¡Œåº”ç”¨è¿ç§»ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-irina-iriser-721993.jpg","permalink":"https://atbug.com/kubernetes-cluster-evolution-in-multi-hybrid-cloud/","tags":["å¤šé›†ç¾¤","æ··åˆå¤šäº‘","Kubernetes"],"title":"ä»å•é›†ç¾¤åˆ°å¤šé›†ç¾¤ï¼šKubernetesåœ¨å¤šäº‘æ··åˆäº‘ç¯å¢ƒçš„æ¼”è¿›"},{"categories":["ç¿»è¯‘"],"contents":"ä»Šå¤©è¯»åˆ°è¿™ç¯‡æ–‡ç« ï¼Œè§‰å¾—ä¸é”™å°±ç¿»è¯‘ä¸€ä¸‹ã€‚æ–‡ç« æ˜¯ç¿»è¯‘è‡ª Steef-Jan Wiggers The Commoditization of the Software Stack:How Application-first Cloud Services are Changing the Gameï¼Œå†…å®¹æ¥è‡ª Bilgin Ibryam åœ¨ QCon London ä¸Šçš„æ¼”è®²ã€‚Ibryam åœ¨åˆ†äº«ä¸­ä»åº”ç”¨å¼€å‘å’Œè¿ç»´ä¸¤ä¸ªä¸åŒçš„ç»´åº¦æ¥è®¨è®ºæ¶æ„çš„æ¼”è¿›ï¼šå†…éƒ¨æ¶æ„å’Œå¤–éƒ¨æ¶æ„ã€‚äºŒè€…ä»å•ä½“åº”ç”¨æ—¶æœŸçš„æ˜æ˜¾çš„ç•Œé™ï¼Œåˆ°å¦‚ä»Šç•Œé™æ„ˆæ¥æ„ˆæ¨¡ç³Šã€‚\næˆ‘è®¤ä¸ºéšç€æ¶æ„çš„æ¼”è¿›ï¼Œåº”ç”¨ç¨‹åºå‘ç”Ÿç€å·¨å¤§çš„å˜åŒ–ï¼Œèƒ½åŠ›ä»åº”ç”¨ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œä¸‹æ²‰åˆ°åŸºç¡€è®¾æ–½ä¸­ï¼Œç”šè‡³å˜æˆæ–°çš„åŸºç¡€è®¾æ–½ã€‚åŸºç¡€è®¾æ–½ï¼Œä¹Ÿä»ç‹­ä¹‰ä¸Šçš„ç‰©ç†è®¾æ–½ã€è®¡ç®—èµ„æºæ¼”å˜ä¸ºè½¯ä»¶å®šä¹‰çš„èƒ½åŠ›ï¼Œè¿™äº›èƒ½åŠ›ä¸æ–­åœ°è¢«äº§å“åŒ–ã€å•†å“åŒ–ã€‚æ–°ç”Ÿä»£çš„åŸºç¡€è®¾æ–½ï¼Œä»¥å„ç§è¿è¡Œæ—¶çš„æ–¹å¼æ¸¸ç¦»åœ¨åº”ç”¨ç¨‹åºä¹‹å¤–ï¼ŒäºŒè€…ä»ä¿æŒç€ä¸€å®šçš„è”ç³»ï¼šAPIã€‚\nä»¥ä¸‹æ˜¯åŸæ–‡çš„ç¿»è¯‘ã€‚\näº‘æœåŠ¡æ­£åœ¨ä¸æ–­æ¼”è¿›ï¼Œè¿™å½±å“ç€å¼€å‘è€…æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„æ–¹å¼ã€‚åœ¨ QCon London å¤§ä¼šä¸Šï¼Œæ¥è‡ª Diagrid çš„äº§å“ç»ç† Bilgin Ibryam æ¢è®¨äº†äº‘åŸç”ŸæŠ€æœ¯ï¼ˆå¦‚ Daprï¼‰ä¸é¢å‘å¼€å‘è€…çš„äº‘æœåŠ¡çš„äº¤é›†ã€‚\nIbryam é¦–å…ˆä»‹ç»äº†å¦‚ä½•çœ‹å¾…ä» å•ä½“åº”ç”¨ç¨‹åº åˆ° å¾®æœåŠ¡ çš„è½¬å˜ï¼Œä»¥åŠæ¥ä¸‹æ¥ä¼šå‡ºç°ä»€ä¹ˆã€‚æ­¤å¤–ï¼Œä»–è¿˜è°ˆåˆ°äº†äº‘æœåŠ¡ä»¥åŠå®ƒæ­£åœ¨ä»¥ä»€ä¹ˆæ ·çš„å½¢å¼å¡‘é€ æ¶æ„çš„æ¼”å˜ã€‚\næ¼”è®²æœŸé—´ï¼ŒIbryam è®²è¿°äº†åœ¨äº‘ä¹‹å‰æˆ–äº‘æ—©æœŸæ„å»ºåº”ç”¨ç¨‹åºçš„ä¸åŒé˜¶æ®µï¼ˆæ—¶é—´çº¿ï¼‰ï¼Œä»åŸºç¡€è®¾æ–½å’Œåº”ç”¨ç¨‹åºè¶‹åŠ¿çš„è§’åº¦æ¢è®¨äº†è®¡ç®—ä¸ºå…ˆçš„äº‘ã€ä»¥åŠåº”ç”¨ç¨‹åºä¸ºå…ˆçš„äº‘æ—¶ä»£ã€‚\nIbryam ä»äº‘ä¹‹å‰æˆ–äº‘æ—©æœŸå¼€å§‹è®¨è®ºï¼Œè¿™æ„å‘³ç€åº”ç”¨ç¨‹åºæ˜¯å•ä½“ x çš„ã€‚è¿™ä¸ªæ—¶ä»£æ˜¯åœ¨äº‘è®¡ç®—æˆä¸ºä¸»æµä¹‹å‰ï¼Œè€Œä¸”è¿˜æ²¡æœ‰å¾®æœåŠ¡ã€‚ç›¸åï¼Œå¼€å‘äººå‘˜å¿…é¡»ä½¿ç”¨å›´ç»•ä¸šåŠ¡é€»è¾‘çš„æ‰€æœ‰å†…å®¹ï¼Œä»å¼‚æ­¥äº¤äº’ï¼ˆå¦‚æ¶ˆæ¯ä¼ é€’ï¼‰åˆ°æ‰“åŒ…å’Œç¼“å­˜ã€‚æ­¤å¤–ï¼Œç”±ä¸¤ä¸ªå›¢é˜Ÿï¼ˆå¼€å‘äººå‘˜å’Œè¿ç»´äººå‘˜ï¼‰ç®¡ç†çš„åº”ç”¨ç¨‹åºå±‚å’ŒåŸºç¡€è®¾æ–½ä¹‹é—´ä¹Ÿå­˜åœ¨åŒºåˆ«ã€‚\næ¥ä¸‹æ¥ï¼ŒIbryam è®¨è®ºäº†äº‘è®¡ç®—æ—¶ä»£æ—©æœŸçš„å†…éƒ¨æ¶æ„ã€‚2010 å¹´åï¼Œåº”ç”¨å¼€å‘å¤å…´å¹¶é‡æ–°å¾—åˆ°å…³æ³¨ï¼Œè¿˜å‡ºç°äº†ä¸€äº›é‡è¦ä¸”è‡³ä»Šä»å…·æœ‰å½±å“åŠ›çš„è½¯ä»¶å¼€å‘è¶‹åŠ¿ã€‚é€šè¿‡ä½¿ç”¨ C4æ¨¡å‹ æˆ– 4+1æ¶æ„æ¨¡å‹è§†å›¾ å¯¹æ¶æ„è¿›è¡Œå¯è§†åŒ–å’Œæè¿°ï¼Œå¯ä»¥ä»ä¸åŒè§’åº¦æ¥è§‚å¯Ÿæ¶æ„ã€‚Ibryam é‡‡ç”¨äº†æ›´ä¸ºç›´æ¥çš„æ–¹æ³•ï¼Œå°†å…¶åˆ†ä¸ºä¸¤ä¸ªå±‚æ¬¡ï¼šå†…éƒ¨æ¶æ„å’Œå¤–éƒ¨æ¶æ„ã€‚å†…éƒ¨åº”ç”¨ç¨‹åºæ¶æ„æ˜¯å¼€å‘äººå‘˜åˆ›å»ºå¹¶å®Œå…¨æŒæ§çš„æ‰€æœ‰å†…å®¹ï¼Œä¾‹å¦‚åº”ç”¨ç¨‹åºä¸­çš„ä¸åŒå±‚ï¼Œæˆ–è€…å¦‚ä»–æ‰€è¯´ï¼Œæ‰€æœ‰æ”¾å…¥å®¹å™¨é•œåƒä¸­çš„å†…å®¹ã€‚ä»è¿ç»´ï¼ˆOpsï¼‰è§†å›¾æ¥çœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªé»‘ç›’ã€‚å¤–éƒ¨åº”ç”¨ç¨‹åºæ¶æ„æ˜¯åº”ç”¨ç¨‹åºä¸ä¹‹äº¤äº’çš„æ‰€æœ‰å†…å®¹çš„é›†åˆï¼Œä¾‹å¦‚æ¶ˆæ¯ä»£ç†ã€æ•°æ®åº“ç”šè‡³äº‘æœåŠ¡ã€‚Ops ä½¿å…¶å¯é ã€å¯è§‚æµ‹ç­‰ã€‚åŸºäºæ­¤ï¼Œä»–è®¨è®ºäº†ä¸€äº›å½±å“å•ä½“åº”ç”¨ç¨‹åºå¼€å‘çš„æ¶æ„è®¾è®¡æ–¹æ³•ï¼Œä¾‹å¦‚ é¢†åŸŸé©±åŠ¨è®¾è®¡ã€å…­è¾¹å½¢æ¶æ„ã€æ´‹è‘±æ¶æ„ å’Œ æ¸…æ´æ¶æ„ã€‚12è¦ç´ åº”ç”¨ç¨‹åº å’Œ å¾®æœåŠ¡ åŸåˆ™éµå¾ªè¿™äº›æ–¹æ³•ï¼Œå¯¼è‡´å•ä½“åº”ç”¨ç¨‹åºå‡ ä¹æˆä¸ºåæ¨¡å¼ã€‚\nåœ¨äº‘ä¹‹å‰å’Œäº‘æ—©æœŸä¹‹åï¼Œè®¡ç®—ä¼˜å…ˆçš„äº‘åº”è¿è€Œç”Ÿï¼Œä»å•ä½“åº”ç”¨ç¨‹åºå‘å¾®æœåŠ¡è½¬å˜ã€‚å†…éƒ¨åº”ç”¨ç¨‹åºæ¶æ„çš„å˜åŒ–å’Œäº‘çš„å‡ºç°å¯¼è‡´åº”ç”¨ç¨‹åºä¸å…¶åŸºç¡€è®¾æ–½ä¹‹é—´å‡ºç°äº†åˆ†ç¦»çš„é›†æˆã€‚\nåœ¨è°ˆåˆ°è®¡ç®—ä¼˜å…ˆæ—¶ï¼ŒIbryam è¯¦ç»†è®¨è®ºäº†åº”ç”¨ç¨‹åºçš„å†…éƒ¨æ¶æ„ä»¥åŠäº‘æä¾›çš„è®¡ç®—ã€‚å®ƒæ˜¯åº”ç”¨ç¨‹åºå’Œè®¡ç®—æœºä¹‹é—´çš„ä¸€ä¸ªåè®®ï¼ˆé›†æˆç»‘å®šï¼‰ï¼Œæ— è®ºæ˜¯å®¹å™¨ã€å‡½æ•°è¿˜æ˜¯æ— æœåŠ¡å™¨åº”ç”¨ç¨‹åºã€‚å®ƒå‘ç”Ÿåœ¨ä¸¤ç«¯çš„ API ä¹‹é—´ï¼ˆæ“ä½œè°ƒç”¨ï¼Œå¦‚èµ„æºéœ€æ±‚ã€éƒ¨ç½²ã€é…ç½®å’ŒæŒ‡æ ‡ï¼‰ã€‚é€šå¸¸ç”±è¿ç»´å›¢é˜Ÿè´Ÿè´£ã€‚\næ¥ä¸‹æ¥ï¼ŒIbryam è®¨è®ºäº†éšç€äº‘çš„å‡ºç°ï¼Œåº”ç”¨ç¨‹åºçš„å¤–éƒ¨æ¶æ„å¦‚ä½•å†æ¬¡å‘ç”Ÿå˜åŒ–ã€‚å†æ¬¡è®¨è®ºäº†åº”ç”¨ç¨‹åºç»‘å®šçš„æ¦‚å¿µï¼›ç„¶è€Œï¼Œç°åœ¨æ˜¯ä»¥äº‘æœåŠ¡ä½œä¸ºåº”ç”¨ç¨‹åºçš„é¡¶éƒ¨ï¼Œè€Œä¸æ˜¯ä½œä¸ºåŸºç¡€è®¾æ–½åœ¨å…¶ä¸‹ï¼Œè¿™æ˜¯å¼€å‘äººå‘˜çš„è´£ä»»ã€‚\nå‘äº‘æœåŠ¡çš„é›†æˆç»‘å®šå¯ä»¥ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå±‚é¢ï¼Œä¾‹å¦‚ åˆ†å¸ƒå¼åº”ç”¨è¿è¡Œæ—¶ï¼ˆDaprï¼‰ã€‚ä¸ºäº†åœ¨è¿™æ–¹é¢ä¸ Dapr è¿›è¡Œæ¯”è¾ƒï¼ŒIbryam æåˆ°äº† Google Cloud Event Arcã€AWS EventBridge å’Œ Azure Event Grid ä½œä¸ºäº‘ç‰¹å®šçš„æœåŠ¡ï¼Œä»¥åŠ Camel ä½œä¸ºè¯­è¨€æ— å…³çš„æœåŠ¡ã€‚è€Œ Dapr åˆ™æ˜¯ä¸¤è€…å…¼å¤‡çš„ã€‚\næœ€åï¼ŒIbryam è°ˆåˆ°äº†ä»¥åº”ç”¨ä¼˜å…ˆçš„äº‘ï¼Œä¾‹å¦‚ï¼Œç½‘ç»œæœåŠ¡å˜å¾—æ›´åŠ ä»¥åº”ç”¨ä¸ºä¸­å¿ƒï¼Œå¹¶ä¸”é›†æˆäº‘çš„è¯ç”Ÿï¼šé¦–å…ˆæ˜¯ä¸ºå¼€å‘äººå‘˜åˆ›å»ºçš„ä¸€ç³»åˆ—ç®¡ç†æœåŠ¡ã€‚\nåº”ç”¨ç¨‹åºä¼˜å…ˆçš„ç”Ÿæ€ç³»ç»Ÿå°†ä¸äº‹ä»¶å¤„ç†æœåŠ¡ï¼ˆä¾‹å¦‚ Azure Eventgridï¼‰ã€ä¸æœåŠ¡ï¼ˆä¾‹å¦‚ AWS Step Functionsï¼‰çš„çŠ¶æ€ç»‘å®šã€ä¸æœåŠ¡ï¼ˆä¾‹å¦‚ Vercel Edge Middlewareï¼‰çš„åŒæ­¥ç»‘å®šä»¥åŠä¸è®¡ç®—æœåŠ¡ï¼ˆä¾‹å¦‚ AWS ECSã€Azure Container Apps å’Œ Google Cloud Runï¼‰çš„è®¡ç®—ç»‘å®šå…·æœ‰å¼‚æ­¥ç»‘å®šã€‚é€šä¿¡å°†é€šè¿‡éµå¾ª OpenAPI è§„èŒƒ çš„ API è¿›è¡Œã€‚æœ€åï¼ŒIbryam ä»ä»–çš„è®²è¯ä¸­æå‡ºäº†ä»¥ä¸‹ä¸»è¦è§‚ç‚¹ï¼š\nä¸“æ³¨äºåŒºåˆ†ä¸šåŠ¡é€»è¾‘å¹¶é‡ç”¨æœªåŒºåˆ†çš„å•†å“åŒ–èƒ½åŠ›ã€‚ ä½¿ç”¨åŸºäºäº‹å®æ ‡å‡†çš„å¼€æ”¾è®¡ç®—å’Œå¼€æ”¾é›†æˆç»‘å®šï¼Œå®ç°å¯ç§»æ¤æ€§ã€‚ å¯ç§»æ¤æ€§ä¸æ˜¯å…³äºåº”ç”¨ç¨‹åºï¼Œè€Œæ˜¯å…³äºæ¨¡å¼ã€å®è·µã€å·¥å…·å’Œäººå‘˜ã€‚ å…³äºä½œè€… Steef-Jan Wiggers æ˜¯ InfoQ çš„é«˜çº§äº‘ç¼–è¾‘ä¹‹ä¸€ï¼Œç›®å‰åœ¨è·å…°çš„ HSO æ‹…ä»»æŠ€æœ¯é›†æˆæ¶æ„å¸ˆã€‚ä»–ç›®å‰çš„æŠ€æœ¯ä¸“é•¿é›†ä¸­åœ¨é›†æˆå¹³å°å®æ–½ã€Azure DevOps å’Œ Azure å¹³å°è§£å†³æ–¹æ¡ˆæ¶æ„ä¸Šã€‚Steef-Jan æ˜¯è·å…° Azure ç”¨æˆ·ç»„çš„è‘£äº‹ä¼šæˆå‘˜ï¼Œç»å¸¸åœ¨ä¼šè®®å’Œç”¨æˆ·ç»„ä¸­å‘è¨€ï¼Œä¸º InfoQ å’Œ Serverless Notes æ’°å†™æ–‡ç« ã€‚æ­¤å¤–ï¼Œå¾®è½¯å·²ç»è¿ç»­ 11 å¹´è®¤å¯ä»–ä¸º Microsoft Azure MVPã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-josh-hild-2801312.jpg","permalink":"https://atbug.com/translation-application-first-cloud-services/","tags":["äº‘åŸç”Ÿ"],"title":"è½¯ä»¶æ ˆçš„å•†å“åŒ–ï¼šåº”ç”¨ç¨‹åºä¸ºå…ˆçš„äº‘æœåŠ¡å¦‚ä½•æ”¹å˜æ¸¸æˆè§„åˆ™"},{"categories":["ç¬”è®°","äº‘åŸç”Ÿ"],"contents":"åœ¨ ä¸Šç¯‡æ–‡ç«  ç”¨äº†æ•´ç¯‡çš„å†…å®¹æ¥æè¿°ç½‘ç»œæ•°æ®åŒ…åœ¨ Kubernetes ç½‘ç»œä¸­çš„è½¨è¿¹ï¼Œæ–‡ç« æœ«å°¾ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§å‡è®¾ï¼šåŒä¸€ä¸ªå†…æ ¸ç©ºé—´ä¸­çš„ä¸¤ä¸ª socket å¯ä»¥ç›´æ¥ä¼ è¾“æ•°æ®ï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥çœæ‰å†…æ ¸ç½‘ç»œåè®®æ ˆå¤„ç†å¸¦æ¥çš„å»¶è¿Ÿï¼Ÿ\nä¸è®ºæ˜¯åŒ pod ä¸­çš„ä¸¤ä¸ªä¸åŒå®¹å™¨ï¼Œæˆ–è€…åŒèŠ‚ç‚¹çš„ä¸¤ä¸ª pod é—´çš„ç½‘ç»œé€šä¿¡ï¼Œå®é™…ä¸Šéƒ½å‘ç”Ÿåœ¨åŒä¸€ä¸ªå†…æ ¸ç©ºé—´ä¸­ï¼Œäº’ä¸ºå¯¹ç«¯çš„ä¸¤ä¸ª socket ä¹Ÿéƒ½ä½äºåŒä¸€ä¸ªå†…å­˜ä¸­ã€‚è€Œåœ¨ä¸Šç¯‡æ–‡ç« çš„å¼€å¤´ä¹Ÿæ€»ç»“äº†æ•°æ®åŒ…çš„ä¼ è¾“è½¨è¿¹å®é™…ä¸Šæ˜¯ socket çš„å¯»å€è¿‡ç¨‹ï¼Œå¯ä»¥è¿›ä¸€æ­¥å°†é—®é¢˜å±•å¼€ï¼šåŒä¸€èŠ‚ç‚¹ä¸Šçš„ä¸¤ä¸ª socket é—´çš„é€šä¿¡ï¼Œå¦‚æœå¯ä»¥ å¿«é€Ÿå®šä½åˆ°å¯¹ç«¯çš„ socket \u0026ndash; æ‰¾åˆ°å…¶åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·³è¿‡å†…æ ¸åè®®æ ˆçš„ç¯èŠ‚è¿›è€ŒåŠ é€Ÿæ•°æ®åŒ…çš„ä¼ è¾“ã€‚\näº’ä¸ºå¯¹ç«¯çš„ä¸¤ä¸ª socket ä¹Ÿå°±æ˜¯å»ºç«‹èµ·è¿æ¥çš„å®¢æˆ·ç«¯ socket å’ŒæœåŠ¡ç«¯ socketï¼Œä»–ä»¬å¯ä»¥é€šè¿‡ IP åœ°å€å’Œç«¯å£è¿›è¡Œå…³è”ã€‚å®¢æˆ·ç«¯ socket çš„æœ¬åœ°åœ°å€å’Œç«¯å£ï¼Œæ˜¯æœåŠ¡ç«¯ socket çš„è¿œç«¯åœ°å€å’Œç«¯å£ï¼›å®¢æˆ·ç«¯ socket çš„è¿œç«¯åœ°å€å’Œç«¯å£ï¼Œåˆ™æ˜¯æœåŠ¡ç«¯ socket çš„æœ¬åœ°åœ°å€å’Œç«¯å£ã€‚\nå½“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åœ¨å®Œæˆè¿æ¥çš„å»ºç«‹ä¹‹åï¼Œå¦‚æœå¯ä»¥ä½¿ç”¨æœ¬åœ°åœ°å€ + ç«¯å£å’Œè¿œç«¯åœ°å€ + ç«¯å£ç«¯å£çš„ç»„åˆ æŒ‡å‘ socketï¼Œä»…éœ€è°ƒæ¢æœ¬åœ°å’Œè¿œç«¯çš„åœ°å€ + ç«¯å£ï¼Œå³å¯å®šä½åˆ°å¯¹ç«¯çš„ socketï¼Œç„¶åå°†æ•°æ®ç›´æ¥å†™åˆ°å¯¹ç«¯ socketï¼ˆå®é™…æ˜¯å†™å…¥ socket çš„æ¥æ”¶é˜Ÿåˆ— RXQï¼Œè¿™é‡Œä¸åšå±•å¼€ï¼‰ï¼Œå°±å¯ä»¥é¿å¼€å†…æ ¸ç½‘ç»œæ ˆï¼ˆåŒ…æ‹¬ netfilter/iptablesï¼‰ç”šè‡³æ˜¯ NIC çš„å¤„ç†ã€‚\nå¦‚ä½•å®ç°ï¼Ÿçœ‹æ ‡é¢˜åº”è¯¥ä¹ŸçŒœå‡ºæ¥äº†ï¼Œè¿™é‡Œå€ŸåŠ© eBPF æŠ€æœ¯ã€‚\neBPF æ˜¯ä»€ä¹ˆï¼Ÿ Linux å†…æ ¸ä¸€ç›´æ˜¯å®ç°ç›‘æ§/å¯è§‚æµ‹æ€§ã€ç½‘ç»œå’Œå®‰å…¨åŠŸèƒ½çš„ç†æƒ³åœ°æ–¹ã€‚ä¸è¿‡å¾ˆå¤šæƒ…å†µä¸‹è¿™å¹¶éæ˜“äº‹ï¼Œå› ä¸ºè¿™äº›å·¥ä½œéœ€è¦ä¿®æ”¹å†…æ ¸æºç æˆ–åŠ è½½å†…æ ¸æ¨¡å—ï¼Œ æœ€ç»ˆå®ç°å½¢å¼æ˜¯åœ¨å·²æœ‰çš„å±‚å±‚æŠ½è±¡ä¹‹ä¸Šå åŠ æ–°çš„æŠ½è±¡ã€‚eBPF æ˜¯ä¸€é¡¹é©å‘½æ€§æŠ€æœ¯ï¼Œå®ƒèƒ½åœ¨å†…æ ¸ä¸­è¿è¡Œæ²™ç®±ç¨‹åºï¼ˆsandbox programsï¼‰ï¼Œ è€Œæ— éœ€ä¿®æ”¹å†…æ ¸æºç æˆ–è€…åŠ è½½å†…æ ¸æ¨¡å—ã€‚\nå°† Linux å†…æ ¸å˜æˆå¯ç¼–ç¨‹ä¹‹åï¼Œå°±èƒ½åŸºäºç°æœ‰çš„ï¼ˆè€Œéå¢åŠ æ–°çš„ï¼‰æŠ½è±¡å±‚æ¥æ‰“é€ æ›´åŠ æ™ºèƒ½ã€ åŠŸèƒ½æ›´åŠ ä¸°å¯Œçš„åŸºç¡€è®¾æ–½è½¯ä»¶ï¼Œè€Œä¸ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œä¹Ÿä¸ä¼šç‰ºç‰²æ‰§è¡Œæ•ˆç‡å’Œå®‰å…¨æ€§ã€‚\nåº”ç”¨åœºæ™¯ ä¸‹é¢æˆªå–äº† eBPF.io ç½‘ç«™çš„ä»‹ç»ã€‚\nåœ¨ ç½‘ç»œ æ–¹é¢ï¼Œåœ¨ä¸ç¦»å¼€å†…æ ¸ç©ºé—´çš„æƒ…å†µä¸‹ä½¿ç”¨ eBPF å¯ä»¥åŠ å¿«æ•°æ®åŒ…å¤„ç†é€Ÿåº¦ã€‚æ·»åŠ é¢å¤–çš„åè®®è§£æå™¨å¹¶è½»æ¾ç¼–å†™ä»»ä½•è½¬å‘é€»è¾‘ä»¥æ»¡è¶³ä¸æ–­å˜åŒ–çš„éœ€æ±‚ã€‚\nåœ¨ å¯è§‚æµ‹æ€§ æ–¹é¢ï¼Œä½¿ç”¨ eBPF å¯ä»¥è‡ªå®šä¹‰æŒ‡æ ‡çš„æ”¶é›†å’Œå†…æ ¸èšåˆï¼Œä»¥åŠä»ä¼—å¤šæ¥æºç”Ÿæˆå¯è§æ€§äº‹ä»¶å’Œæ•°æ®ç»“æ„ï¼Œè€Œæ— éœ€å¯¼å‡ºæ ·æœ¬ã€‚\nåœ¨ é“¾è·¯è·Ÿè¸ªä¸åˆ†æ æ–¹é¢ï¼Œå°† eBPF ç¨‹åºé™„åŠ åˆ°è·Ÿè¸ªç‚¹ä»¥åŠå†…æ ¸å’Œç”¨æˆ·åº”ç”¨ç¨‹åºæ¢æµ‹ç‚¹ï¼Œå¯ä»¥æä¾›å¼ºå¤§çš„æ£€æŸ¥èƒ½åŠ›å’Œç‹¬ç‰¹çš„æ´å¯ŸåŠ›æ¥è§£å†³ç³»ç»Ÿæ€§èƒ½é—®é¢˜ã€‚\nåœ¨ å®‰å…¨ æ–¹é¢ï¼Œå°†æŸ¥çœ‹å’Œç†è§£æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ä¸æ‰€æœ‰ç½‘ç»œçš„æ•°æ®åŒ…å’Œå¥—æ¥å­—çº§åˆ«è§†å›¾ç›¸ç»“åˆï¼Œæ¥åˆ›å»ºåœ¨æ›´å¤šä¸Šä¸‹æ–‡ä¸­è¿è¡Œå¹¶å…·æœ‰æ›´å¥½æ§åˆ¶çº§åˆ«çš„å®‰å…¨ç³»ç»Ÿã€‚\näº‹ä»¶é©±åŠ¨ eBPF ç¨‹åºæ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œå½“å†…æ ¸æˆ–åº”ç”¨ç¨‹åºé€šè¿‡æŸä¸ª hookï¼ˆé’©å­ï¼‰ ç‚¹æ—¶è¿è¡Œã€‚é¢„å®šä¹‰çš„é’©å­ç±»å‹åŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨ã€å‡½æ•°è¿›å…¥/é€€å‡ºã€å†…æ ¸è·Ÿè¸ªç‚¹ã€ç½‘ç»œäº‹ä»¶ç­‰ã€‚\nLinux çš„å†…æ ¸åœ¨ç³»ç»Ÿè°ƒç”¨å’Œç½‘ç»œæ ˆä¸Šæä¾›äº†ä¸€ç»„ BPF é’©å­ï¼Œé€šè¿‡è¿™äº›é’©å­å¯ä»¥è§¦å‘ BPF ç¨‹åºçš„æ‰§è¡Œï¼Œä¸‹é¢å°±ä»‹ç»å¸¸è§çš„å‡ ç§é’©å­ã€‚\nXDPï¼šè¿™æ˜¯ç½‘ç»œé©±åŠ¨ä¸­æ¥æ”¶ç½‘ç»œåŒ…æ—¶å°±å¯ä»¥è§¦å‘ BPF ç¨‹åºçš„é’©å­ï¼Œä¹Ÿæ˜¯æœ€æ—©çš„ç‚¹ã€‚ç”±äºæ­¤æ—¶è¿˜æ²¡æœ‰è¿›å…¥å†…æ ¸ç½‘ç»œåè®®æ ˆï¼Œä¹Ÿæœªæ‰§è¡Œé«˜æˆæœ¬çš„æ“ä½œï¼Œæ¯”å¦‚ä¸ºç½‘ç»œåŒ…åˆ†é… sk_buffï¼Œæ‰€ä»¥å®ƒéå¸¸é€‚åˆè¿è¡Œåˆ é™¤æ¶æ„æˆ–æ„å¤–æµé‡çš„è¿‡æ»¤ç¨‹åºï¼Œä»¥åŠå…¶ä»–å¸¸è§çš„ DDOS ä¿æŠ¤æœºåˆ¶ã€‚ Traffic Control Ingress/Egressï¼šé™„åŠ åˆ°æµé‡æ§åˆ¶ï¼ˆtraffic controlï¼Œç®€ç§° tcï¼‰ingress é’©å­ä¸Šçš„ BPF ç¨‹åºï¼Œå¯ä»¥è¢«é™„åŠ åˆ°ç½‘ç»œæ¥å£ä¸Šã€‚è¿™ç§é’©å­åœ¨ç½‘ç»œæ ˆçš„ L3 ä¹‹å‰æ‰§è¡Œï¼Œå¹¶å¯ä»¥è®¿é—®ç½‘ç»œåŒ…çš„å¤§éƒ¨åˆ†å…ƒæ•°æ®ã€‚å¯ä»¥å¤„ç†åŒèŠ‚ç‚¹çš„æ“ä½œï¼Œæ¯”å¦‚åº”ç”¨ L3/L4 çš„ç«¯ç‚¹ç­–ç•¥ã€è½¬å‘æµé‡åˆ°ç«¯ç‚¹ã€‚CNI é€šå¸¸ä½¿ç”¨è™šæ‹Ÿæœºä»¥å¤ªæ¥å£å¯¹ veth å°†å®¹å™¨è¿æ¥åˆ°ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´ã€‚ä½¿ç”¨é™„åŠ åˆ°ä¸»æœºç«¯ veth çš„ tc ingress é’©å­ï¼Œå¯ä»¥ç›‘æ§ç¦»å¼€å®¹å™¨çš„æ‰€æœ‰æµé‡ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥é™„åŠ åˆ°å®¹å™¨çš„ eth0 æ¥å£ä¸Šï¼‰ã€‚ä¹Ÿå¯ä»¥ç”¨äºå¤„ç†è·¨èŠ‚ç‚¹çš„æ“ä½œã€‚åŒæ—¶å°†å¦ä¸€ä¸ª BPF ç¨‹åºé™„åŠ åˆ° tc egress é’©å­ï¼ŒCilium å¯ä»¥ç›‘æ§æ‰€æœ‰è¿›å‡ºèŠ‚ç‚¹çš„æµé‡å¹¶æ‰§è¡Œç­–ç•¥ã€‚ ä¸Šé¢ä¸¤ç§å±äºç½‘ç»œäº‹ä»¶ç±»å‹çš„é’©å­ï¼Œä¸‹é¢ä»‹ç»åŒæ ·æ˜¯ç½‘ç»œç›¸å…³çš„ï¼Œå¥—æ¥å­—çš„ç³»ç»Ÿè°ƒç”¨ã€‚\nSocket operationsï¼šå¥—æ¥å­—æ“ä½œé’©å­é™„åŠ åˆ°ç‰¹å®šçš„ cgroup å¹¶åœ¨å¥—æ¥å­—çš„æ“ä½œä¸Šè¿è¡Œã€‚æ¯”å¦‚å°† BPF å¥—æ¥å­—æ“ä½œç¨‹åºé™„åŠ åˆ° cgroup/sock_opsï¼Œä½¿ç”¨å®ƒæ¥ç›‘æ§ socket çš„çŠ¶æ€å˜åŒ–ï¼ˆä» bpf_sock_ops è·å–ä¿¡æ¯ï¼‰ï¼Œç‰¹åˆ«æ˜¯ ESTABLISHED çŠ¶æ€ã€‚å½“å¥—æ¥å­—çŠ¶æ€å˜ä¸º ESTABLISHED æ—¶ï¼Œå¦‚æœ TCP å¥—æ¥å­—çš„å¯¹ç«¯ä¹Ÿåœ¨å½“å‰èŠ‚ç‚¹ï¼ˆä¹Ÿå¯èƒ½æ˜¯æœ¬åœ°ä»£ç†ï¼‰ï¼Œç„¶åè¿›è¡Œä¿¡æ¯çš„å­˜å‚¨ã€‚æˆ–è€…å°†ç¨‹åºé™„åŠ åˆ° cgroup/connect4 æ“ä½œï¼Œå¯ä»¥åœ¨ä½¿ç”¨ ipv4 åœ°å€åˆå§‹åŒ–è¿æ¥æ—¶æ‰§è¡Œç¨‹åºï¼Œå¯¹åœ°å€å’Œç«¯å£è¿›è¡Œä¿®æ”¹ã€‚ Socket sendï¼šè¿™ä¸ªé’©å­åœ¨å¥—æ¥å­—æ‰§è¡Œçš„æ¯ä¸ªå‘é€æ“ä½œä¸Šè¿è¡Œã€‚æ­¤æ—¶é’©å­å¯ä»¥æ£€æŸ¥æ¶ˆæ¯å¹¶ä¸¢å¼ƒæ¶ˆæ¯ã€å°†æ¶ˆæ¯å‘é€åˆ°å†…æ ¸ç½‘ç»œåè®®æ ˆï¼Œæˆ–è€…å°†æ¶ˆæ¯é‡å®šå‘åˆ°å¦ä¸€ä¸ªå¥—æ¥å­—ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…¶å®Œæˆ socket çš„å¿«é€Ÿå¯»å€ã€‚ Map eBPF ç¨‹åºçš„ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯å…±äº«æ”¶é›†çš„ä¿¡æ¯å’Œå­˜å‚¨çŠ¶æ€çš„èƒ½åŠ›ã€‚ä¸ºæ­¤ï¼ŒeBPF ç¨‹åºå¯ä»¥åˆ©ç”¨ eBPF Map çš„æ¦‚å¿µå­˜å‚¨å’Œæ£€ç´¢æ•°æ®ã€‚eBPF Map å¯ä»¥ä» eBPF ç¨‹åºè®¿é—®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨ä»ç”¨æˆ·ç©ºé—´ä¸­çš„åº”ç”¨ç¨‹åºè®¿é—®ã€‚\nMap æœ‰å¤šç§ç±»å‹ï¼šå“ˆå¸Œè¡¨ã€æ•°ç»„ã€LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰å“ˆå¸Œè¡¨ã€ç¯å½¢ç¼“å†²åŒºã€å †æ ˆè°ƒç”¨è·Ÿè¸ªç­‰ç­‰ã€‚\næ¯”å¦‚ä¸Šé¢é™„åŠ åˆ° socket å¥—æ¥å­—ä¸Šç”¨æ¥åœ¨æ¯æ¬¡å‘é€æ¶ˆæ¯æ—¶æ‰§è¡Œçš„ç¨‹åºï¼Œå®é™…ä¸Šæ˜¯é™„åŠ åœ¨ socket å“ˆå¸Œè¡¨ä¸Šï¼Œsocket å°±æ˜¯é”®å€¼å¯¹ä¸­çš„å€¼ã€‚\nè¾…åŠ©å‡½æ•° eBPF ç¨‹åºä¸èƒ½è°ƒç”¨ä»»æ„å†…æ ¸å‡½æ•°ã€‚å¦‚æœè¿™æ ·åšä¼šå°† eBPF ç¨‹åºç»‘å®šåˆ°ç‰¹å®šçš„å†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶ä¼šä½¿ç¨‹åºçš„å…¼å®¹æ€§å¤æ‚åŒ–ã€‚ç›¸åï¼ŒeBPF ç¨‹åºå¯ä»¥å¯¹è¾…åŠ©å‡½æ•°è¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œè¾…åŠ©å‡½æ•°æ˜¯å†…æ ¸æä¾›çš„ä¼—æ‰€å‘¨çŸ¥ä¸”ç¨³å®šçš„ APIã€‚\nè¿™äº› è¾…åŠ©å‡½æ•° æä¾›äº†ä¸åŒçš„åŠŸèƒ½ï¼š\nç”Ÿæˆéšæœºæ•° è·å–å½“å‰æ—¶é—´å’Œæ—¥æœŸ è®¿é—® eBPF Map è·å–è¿›ç¨‹/cgroup ä¸Šä¸‹æ–‡ æ“çºµç½‘ç»œæ•°æ®åŒ…å’Œè½¬å‘é€»è¾‘ å®ç° è®²å®Œ eBPF çš„å†…å®¹ï¼Œå¯¹å®ç°åº”è¯¥ä¼šæœ‰ä¸€ä¸ªå¤§æ¦‚çš„æ€è·¯äº†ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ª eBPF ç¨‹åºåˆ†åˆ«ç»´æŠ¤ socket map å’Œå°†æ¶ˆæ¯ç›´é€šå¯¹ç«¯çš„ socketã€‚è¿™é‡Œæ„Ÿè°¢ Idan Zach çš„ç¤ºä¾‹ä»£ç  ebpf-sockopsï¼Œæˆ‘å°†ä»£ç åšäº† ç®€å•çš„ä¿®æ”¹ï¼Œè®©å¯è¯»æ€§æ›´å¥½ä¸€ç‚¹ã€‚\nåŸæ¥ä»£ç ç”¨ä½¿ç”¨äº† 16777343 è¡¨ç¤ºåœ°å€ 127.0.0.1ï¼Œ4135 è¡¨ç¤ºç«¯å£ 10000ï¼ŒäºŒè€…æ˜¯ç½‘ç»œ å­—èŠ‚åºåˆ—è½¬æ¢åçš„å€¼ã€‚\nsocket map ç»´æŠ¤ï¼šsockops é™„åŠ åˆ° sock_ops çš„ç¨‹åºï¼šç›‘æ§ socket çŠ¶æ€ï¼Œå½“çŠ¶æ€ä¸º BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB æˆ–è€… BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB æ—¶ï¼Œä½¿ç”¨è¾…åŠ©å‡½æ•° bpf_sock_hash_update1 å°† socket ä½œä¸º value ä¿å­˜åˆ° socket map ä¸­ï¼Œkey ç”±æœ¬åœ°åœ°å€ + ç«¯å£å’Œè¿œç«¯åœ°å€ + ç«¯å£ç»„æˆã€‚\nå®é™…çš„å¤„ç†ä¸­ï¼Œéœ€è¦å¯¹å½“å‰çš„ socket ä¿¡æ¯è¿›è¡Œæ£€æŸ¥ï¼Œå°†ç›®æ ‡åœ°å€å’Œç«¯å£æˆ–è€…æœ¬åœ°åœ°å€å’Œç«¯å£æ˜¯ 127.0.0.1ã€10000 çš„ socket ä¿å­˜åœ¨ socket map ä¸­ã€‚\n__section(\u0026#34;sockops\u0026#34;) int bpf_sockmap(struct bpf_sock_ops *skops) { __u32 family, op; family = skops-\u0026gt;family; op = skops-\u0026gt;op; //printk(\u0026#34;\u0026lt;\u0026lt;\u0026lt; op %d, port = %d --\u0026gt; %d\\n\u0026#34;, op, skops-\u0026gt;local_port, skops-\u0026gt;remote_port); switch (op) { case BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB: case BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB: if (family == AF_INET6) bpf_sock_ops_ipv6(skops); else if (family == AF_INET) bpf_sock_ops_ipv4(skops); break; default: break; } return 0; } // 127.0.0.1 static const __u32 lo_ip = 127 + (1 \u0026lt;\u0026lt; 24); static inline void bpf_sock_ops_ipv4(struct bpf_sock_ops *skops) { struct sock_key key = {}; sk_extract4_key(skops, \u0026amp;key); if (key.dip4 == loopback_ip || key.sip4 == loopback_ip ) { if (key.dport == bpf_htons(SERVER_PORT) || key.sport == bpf_htons(SERVER_PORT)) { int ret = sock_hash_update(skops, \u0026amp;sock_ops_map, \u0026amp;key, BPF_NOEXIST); printk(\u0026#34;\u0026lt;\u0026lt;\u0026lt; ipv4 op = %d, port %d --\u0026gt; %d\\n\u0026#34;, skops-\u0026gt;op, key.sport, key.dport); if (ret != 0) printk(\u0026#34;*** FAILED %d ***\\n\u0026#34;, ret); } } } æ¶ˆæ¯ç›´é€šï¼šsk_msg é™„åŠ åˆ° socket map çš„ç¨‹åºï¼šåœ¨æ¯æ¬¡å‘é€æ¶ˆæ¯æ—¶è§¦å‘è¯¥ç¨‹åºï¼Œä½¿ç”¨å½“å‰ socket çš„è¿œç«¯åœ°å€ + ç«¯å£å’Œæœ¬åœ°åœ°å€ + ç«¯å£ä½œä¸º key ä» map ä¸­å®šä½å¯¹ç«¯çš„ socketã€‚å¦‚æœå®šä½æˆåŠŸï¼Œè¯´æ˜å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½äºåŒä¸€èŠ‚ç‚¹ä¸Šï¼Œä½¿ç”¨è¾…åŠ©å‡½æ•° bpf_msg_redirect_hash2 å°†æ•°æ®ç›´æ¥å†™å…¥åˆ°å¯¹ç«¯ socketã€‚\nè¿™é‡Œæ²¡æœ‰ç›´æ¥ä½¿ç”¨ bpf_msg_redirect_hashï¼Œè€Œæ˜¯é€šè¿‡è‡ªå®šä¹‰çš„ msg_redirect_hash æ¥è®¿é—®ã€‚å› ä¸ºå‰è€…æ— æ³•ç›´æ¥è®¿é—®ï¼Œå¦åˆ™æ ¡éªŒä¼šä¸é€šè¿‡ã€‚\nä¸ sockops ä¸€æ ·ï¼Œæ¶ˆæ¯çš„é‡å®šå‘ä¹Ÿæ˜¯æŒ‡é’ˆå¯¹ç›®æ ‡åœ°å€å’Œç«¯å£æˆ–è€…æœ¬åœ°åœ°å€å’Œç«¯å£æ˜¯ 127.0.0.1ã€10000 çš„æ¶ˆæ¯ã€‚\n__section(\u0026#34;sk_msg\u0026#34;) int bpf_redir(struct sk_msg_md *msg) { __u64 flags = BPF_F_INGRESS; struct sock_key key = {}; sk_msg_extract4_key(msg, \u0026amp;key); // See whether the source or destination IP is local host if (key.dip4 == loopback_ip || key.sip4 == loopback_ip ) { // See whether the source or destination port is 10000 if (key.dport == bpf_htons(SERVER_PORT) || key.sport == bpf_htons(SERVER_PORT)) { //int len1 = (__u64)msg-\u0026gt;data_end - (__u64)msg-\u0026gt;data; //printk(\u0026#34;\u0026lt;\u0026lt;\u0026lt; redir_proxy port %d --\u0026gt; %d (%d)\\n\u0026#34;, key.sport, key.dport, len1); msg_redirect_hash(msg, \u0026amp;sock_ops_map, \u0026amp;key, flags); } } return SK_PASS; } æµ‹è¯• ç¯å¢ƒ\nUbuntu 20.04 Kernel 5.15.0-1034 å®‰è£…ä¾èµ–ã€‚\nsudo apt update \u0026amp;\u0026amp; sudo apt install make clang llvm gcc-multilib linux-tools-$(uname -r) linux-cloud-tools-$(uname -r) linux-tools-generic å…‹éš†ä»£ç ã€‚\ngit clone https://github.com/addozhang/ebpf-sockops cd ebpf-sockops ç¼–è¯‘å¹¶åŠ è½½ BPF ç¨‹åºã€‚\nsudo ./load.sh å®‰è£… iperf3ã€‚\nsudo apt install iperf3 å¯åŠ¨ iperf3 æœåŠ¡ç«¯ã€‚\niperf3 -s -p 10000 è¿è¡Œ iperf3 å®¢æˆ·ç«¯ã€‚\niperf3 -c 127.0.0.1 -t 10 -l 64k -p 10000 è¿è¡Œ trace.sh è„šæœ¬æŸ¥çœ‹æ‰“å°çš„æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ° 4 æ¡æ—¥å¿—ï¼šåˆ›å»ºäº† 2 ä¸ªè¿æ¥ã€‚\n./trace.sh iperf3-7744 [001] d...1 838.985683: bpf_trace_printk: \u0026lt;\u0026lt;\u0026lt; ipv4 op = 4, port 45189 --\u0026gt; 4135 iperf3-7744 [001] d.s11 838.985733: bpf_trace_printk: \u0026lt;\u0026lt;\u0026lt; ipv4 op = 5, port 4135 --\u0026gt; 45189 iperf3-7744 [001] d...1 838.986033: bpf_trace_printk: \u0026lt;\u0026lt;\u0026lt; ipv4 op = 4, port 45701 --\u0026gt; 4135 iperf3-7744 [001] d.s11 838.986078: bpf_trace_printk: \u0026lt;\u0026lt;\u0026lt; ipv4 op = 5, port 4135 --\u0026gt; 45701 å¦‚ä½•ç¡®å®šè·³è¿‡äº†å†…æ ¸ç½‘ç»œæ ˆäº†ï¼Œä½¿ç”¨ tcpdump æŠ“åŒ…çœ‹ä¸€ä¸‹ã€‚ä»æŠ“åŒ…çš„ç»“æœæ¥çœ‹ï¼Œåªæœ‰æ¡æ‰‹å’ŒæŒ¥æ‰‹çš„æµé‡ï¼Œåç»­æ¶ˆæ¯çš„å‘é€å®Œå…¨è·³è¿‡äº†å†…æ ¸ç½‘ç»œæ ˆã€‚\nsudo tcpdump -i lo port 10000 -vvv tcpdump: listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes 13:23:31.761317 IP (tos 0x0, ttl 64, id 50214, offset 0, flags [DF], proto TCP (6), length 60) localhost.34224 \u0026gt; localhost.webmin: Flags [S], cksum 0xfe30 (incorrect -\u0026gt; 0x5ca1), seq 2753408235, win 65495, options [mss 65495,sackOK,TS val 166914980 ecr 0,nop,wscale 7], length 0 13:23:31.761333 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 60) localhost.webmin \u0026gt; localhost.34224: Flags [S.], cksum 0xfe30 (incorrect -\u0026gt; 0x169a), seq 3960628312, ack 2753408236, win 65483, options [mss 65495,sackOK,TS val 166914980 ecr 166914980,nop,wscale 7], length 0 13:23:31.761385 IP (tos 0x0, ttl 64, id 50215, offset 0, flags [DF], proto TCP (6), length 52) localhost.34224 \u0026gt; localhost.webmin: Flags [.], cksum 0xfe28 (incorrect -\u0026gt; 0x3d56), seq 1, ack 1, win 512, options [nop,nop,TS val 166914980 ecr 166914980], length 0 13:23:31.761678 IP (tos 0x0, ttl 64, id 59057, offset 0, flags [DF], proto TCP (6), length 60) localhost.34226 \u0026gt; localhost.webmin: Flags [S], cksum 0xfe30 (incorrect -\u0026gt; 0x4eb8), seq 3068504073, win 65495, options [mss 65495,sackOK,TS val 166914981 ecr 0,nop,wscale 7], length 0 13:23:31.761689 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 60) localhost.webmin \u0026gt; localhost.34226: Flags [S.], cksum 0xfe30 (incorrect -\u0026gt; 0x195d), seq 874449823, ack 3068504074, win 65483, options [mss 65495,sackOK,TS val 166914981 ecr 166914981,nop,wscale 7], length 0 13:23:31.761734 IP (tos 0x0, ttl 64, id 59058, offset 0, flags [DF], proto TCP (6), length 52) localhost.34226 \u0026gt; localhost.webmin: Flags [.], cksum 0xfe28 (incorrect -\u0026gt; 0x4019), seq 1, ack 1, win 512, options [nop,nop,TS val 166914981 ecr 166914981], length 0 13:23:41.762819 IP (tos 0x0, ttl 64, id 43056, offset 0, flags [DF], proto TCP (6), length 52) localhost.webmin \u0026gt; localhost.34226: Flags [F.], cksum 0xfe28 (incorrect -\u0026gt; 0x1907), seq 1, ack 1, win 512, options [nop,nop,TS val 166924982 ecr 166914981], length 0 13:23:41.763334 IP (tos 0x0, ttl 64, id 59059, offset 0, flags [DF], proto TCP (6), length 52) localhost.34226 \u0026gt; localhost.webmin: Flags [F.], cksum 0xfe28 (incorrect -\u0026gt; 0xf1f4), seq 1, ack 2, win 512, options [nop,nop,TS val 166924982 ecr 166924982], length 0 13:23:41.763348 IP (tos 0x0, ttl 64, id 43057, offset 0, flags [DF], proto TCP (6), length 52) localhost.webmin \u0026gt; localhost.34226: Flags [.], cksum 0xfe28 (incorrect -\u0026gt; 0xf1f4), seq 2, ack 2, win 512, options [nop,nop,TS val 166924982 ecr 166924982], length 0 13:23:41.763588 IP (tos 0x0, ttl 64, id 50216, offset 0, flags [DF], proto TCP (6), length 52) localhost.34224 \u0026gt; localhost.webmin: Flags [F.], cksum 0xfe28 (incorrect -\u0026gt; 0x1643), seq 1, ack 1, win 512, options [nop,nop,TS val 166924982 ecr 166914980], length 0 13:23:41.763940 IP (tos 0x0, ttl 64, id 14090, offset 0, flags [DF], proto TCP (6), length 52) localhost.webmin \u0026gt; localhost.34224: Flags [F.], cksum 0xfe28 (incorrect -\u0026gt; 0xef2e), seq 1, ack 2, win 512, options [nop,nop,TS val 166924983 ecr 166924982], length 0 13:23:41.763952 IP (tos 0x0, ttl 64, id 50217, offset 0, flags [DF], proto TCP (6), length 52) localhost.34224 \u0026gt; localhost.webmin: Flags [.], cksum 0xfe28 (incorrect -\u0026gt; 0xef2d), seq 2, ack 2, win 512, options [nop,nop,TS val 166924983 ecr 166924983], length 0 æ€»ç»“ é€šè¿‡ eBPF çš„å¼•å…¥ï¼Œæˆ‘ä»¬ç¼©çŸ­äº†åŒèŠ‚ç‚¹é€šä¿¡æ•°æ®åŒ…çš„ datapathï¼Œè·³è¿‡äº†å†…æ ¸ç½‘ç»œæ ˆç›´æ¥è¿æ¥ä¸¤ä¸ªå¯¹ç«¯çš„ socketã€‚\nè¿™ç§è®¾è®¡é€‚ç”¨äºåŒ pod ä¸¤ä¸ªåº”ç”¨çš„é€šä¿¡ä»¥åŠåŒèŠ‚ç‚¹ä¸Šä¸¤ä¸ª pod çš„é€šä¿¡ã€‚\nè¯¥è¾…åŠ©å‡½æ•°å°†å¼•ç”¨çš„ socket æ·»åŠ æˆ–è€…æ›´æ–°åˆ° sockethash map ä¸­ï¼Œç¨‹åºçš„è¾“å…¥ bpf_sock_ops ä½œä¸ºé”®å€¼å¯¹çš„å€¼ã€‚è¯¦ç»†ä¿¡æ¯å¯å‚è€ƒ https://man7.org/linux/man-pages/man7/bpf-helpers.7.html ä¸­çš„ bpf_sock_hash_updateã€‚\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nè¯¥è¾…åŠ©å‡½æ•°å°† msg è½¬å‘åˆ° socket map ä¸­ key å¯¹åº”çš„ socketã€‚\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-tiana-614484.jpg","permalink":"https://atbug.com/accelerate-network-packets-transmission/","tags":["eBPF","ç½‘ç»œ"],"title":"ä½¿ç”¨ eBPF æŠ€æœ¯å®ç°æ›´å¿«çš„ç½‘ç»œæ•°æ®åŒ…ä¼ è¾“"},{"categories":["ç¬”è®°"],"contents":"ç½‘ç»œå’Œæ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå¯¹æˆ‘æ¥è¯´æ˜¯æ—¢é™Œç”Ÿåˆæ»¡æ˜¯å¸å¼•ï¼Œå¸Œæœ›èƒ½å¤Ÿæ‹¨å¼€å±‚å±‚è¿·é›¾æ‰¾åˆ°èƒŒåçš„çœŸç›¸ã€‚\nåœ¨ ä¸Šä¸€ç¯‡æ–‡ç«  ä¸­æˆ‘æ·±å…¥æ¢è®¨äº† Kubernetes ç½‘ç»œæ¨¡å‹ï¼Œè¿™æ¬¡æˆ‘æƒ³æ›´æ·±å…¥ä¸€ç‚¹ï¼šäº†è§£æ•°æ®åŒ…åœ¨ Kubernetes ä¸­çš„ä¼ è¾“ï¼Œä¸ºå­¦ä¹  Kubernetes çš„ eBPF ç½‘ç»œåŠ é€Ÿåšå‡†å¤‡ï¼ŒåŠ æ·±å¯¹ç½‘ç»œå’Œæ“ä½œç³»ç»Ÿå†…æ ¸çš„ç†è§£ã€‚ æ–‡ä¸­å¯èƒ½æœ‰ç–æ¼ä¹‹å¤„ï¼Œè¿˜æœ›å¤§å®¶èµæ•™ã€‚\nåœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘å¯ä»¥ç”¨ä¸€å¥è¯æ¥æ€»ç»“æˆ‘çš„å­¦ä¹ æˆæœï¼šæ•°æ®åŒ…çš„æµè½¬å…¶å®å°±æ˜¯ä¸€ä¸ªç½‘ç»œå¥—æ¥å­—æè¿°ç¬¦ï¼ˆSocket File Descriptorï¼Œä¸­æ–‡æœ‰ç‚¹å†—é•¿ï¼Œä»¥ä¸‹ç®€ç§° socket fdï¼‰çš„å¯»å€è¿‡ç¨‹ã€‚ å®ƒä¸æ˜¯ç®€å•çš„æŒ‡ socket fd çš„å†…å­˜åœ°å€ï¼Œè¿˜åŒ…æ‹¬å®ƒçš„ç½‘ç»œåœ°å€ã€‚\nåœ¨ Unix å’Œç±» Unix ç³»ç»Ÿä¸­ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ¥æ“ä½œ socketã€‚\nåŸºç¡€çŸ¥è¯† æ•°æ®åŒ… æ—¢ç„¶è¦è®¨è®ºæ•°æ®åŒ…çš„æµè½¬ï¼Œå…ˆçœ‹çœ‹ä»€ä¹ˆæ˜¯æ•°æ®åŒ…ã€‚\nç½‘ç»œæ•°æ®åŒ…ï¼ˆnetwork packetï¼‰ï¼Œä¹Ÿç§°ä¸ºç½‘ç»œæ•°æ®æŠ¥ï¼ˆnetwork datagramï¼‰æˆ–ç½‘ç»œå¸§ï¼ˆNetwork frameï¼‰ï¼Œæ˜¯é€šè¿‡è®¡ç®—æœºç½‘ç»œä¼ è¾“çš„æ•°æ®å•ä½ã€‚æ‹¿æœ€å¸¸è§çš„ TCP æ•°æ®åŒ…æ¥çœ‹åŒ…å«å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š\nEthernet headerï¼šé“¾è·¯å±‚ä¿¡æ¯ï¼Œä¸»è¦åŒ…æ‹¬ç›®çš„ MAC åœ°å€å’Œæº MAC åœ°å€ï¼Œä»¥åŠæŠ¥æ–‡çš„æ ¼å¼ï¼Œè¿™é‡Œæ˜¯ IP åŒ…ã€‚ IP headerï¼šç½‘ç»œå±‚ä¿¡æ¯ï¼Œä¸»è¦åŒ…æ‹¬é•¿åº¦ã€æº IP åœ°å€å’Œç›®çš„ IP åœ°å€ä»¥åŠæŠ¥æ–‡çš„æ ¼å¼ï¼Œå½“ç„¶è¿™é‡Œå¿…é¡»æ˜¯ TCP åŒ…ã€‚ TCP headerï¼šä¼ è¾“å±‚ä¿¡æ¯ï¼ŒåŒ…æ‹¬æºç«¯å£å’Œç›®çš„ç«¯å£ã€‚ æ•°æ®ï¼šä¸€èˆ¬æ˜¯ç¬¬ 7 å±‚çš„æ•°æ®ï¼Œæ¯”å¦‚ HTTP ç­‰ã€‚ è¿™é‡Œæ²¡æœ‰ä»‹ç»çš„ checksum å’Œ FCS é€šå¸¸æ˜¯ç”¨æ¥æ£€æŸ¥æ•°æ®åŒ…åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯å¦è¢«ç¯¡æ”¹æˆ–è€…å‘ç”Ÿäº†é”™è¯¯ã€‚\nåº”ç”¨ç¨‹åºä½¿ç”¨ socket å‘ç½‘ç»œå‘é€æ•°æ®çš„è¿‡ç¨‹å¯ä»¥ç®€å•ç†è§£ä¸ºä½¿ç”¨å¤´ä¿¡æ¯å°è£…æ•°æ®çš„è¿‡ç¨‹ï¼šTCP æ•°æ®åŒ…ã€IP æ•°æ®åŒ…ã€Ethernet æ•°æ®åŒ…ï¼›åè¿‡æ¥ï¼Œä»ç½‘ç»œæ¥æ”¶ä»¥å¤ªç½‘æ•°æ®åŒ…åˆ°åº”ç”¨ç¨‹åºå¯ä»¥å¤„ç†çš„æ•°æ®ï¼Œå°±æ˜¯è§£åŒ…çš„è¿‡ç¨‹ã€‚å°åŒ…å’Œè§£åŒ…çš„è¿‡ç¨‹æ˜¯ç”±å†…æ ¸ç½‘ç»œåè®®æ ˆæ¥å®Œæˆçš„ã€‚\nä¸‹é¢åˆ†åˆ«è¯´ä¸€ä¸‹ socket å’Œå†…æ ¸ç½‘ç»œåè®®æ ˆçš„å¤„ç†ã€‚\nsocket å¥—æ¥å­— Socket æ˜¯ä¸€ç§åœ¨è®¡ç®—æœºç½‘ç»œä¸­ä½¿ç”¨çš„ç¼–ç¨‹æ¥å£ï¼Œä½äºç”¨æˆ·ç©ºé—´ï¼ˆç”¨æˆ·åº”ç”¨ç¨‹åºè¿è¡Œçš„ç©ºé—´ï¼‰å’Œå†…æ ¸ç½‘ç»œåè®®æ ˆï¼ˆå†…æ ¸ä¸­å¯¹æ•°æ®è¿›è¡Œå°åŒ…å’Œè§£åŒ…çš„ç»„ä»¶ï¼‰ä¹‹é—´ã€‚\nä½œä¸ºç¼–ç¨‹æ¥å£ï¼Œsocket æä¾›äº†å¦‚ä¸‹æ“ä½œï¼ˆåªåˆ—å‡ºéƒ¨åˆ†ï¼‰ï¼š\nsocket connect bind listen accept æ•°æ®ä¼ è¾“ send sendto sendmsg recv recvfrom recvmsg getsockname getpeername getsockopt ã€setsockopt è·å–æˆ–è®¾ç½® socket å±‚æˆ–åè®®å±‚é€‰é¡¹ close é€šè¿‡ä¸‹é¢çš„å›¾ï¼Œå¯ä»¥ç›´è§‚æ„Ÿå—å„ä¸ªæ“ä½œçš„ä½œç”¨ï¼š\nå¼€å§‹è®²è§£å†…æ ¸ç½‘ç»œåè®®æ ˆä¹‹å‰ï¼Œå…ˆè¯´ä¸‹æ•°æ®åŒ…åœ¨å†…å­˜ä¸­çš„æ•°æ®ç»“æ„ï¼šsk_buffã€‚\nsk_buff sk_buff æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºç®¡ç†ç½‘ç»œæ•°æ®åŒ…çš„æ•°æ®ç»“æ„ï¼Œå®ƒåŒ…å«äº†æ¥æ”¶å’Œå‘é€çš„ç½‘ç»œæ•°æ®åŒ…çš„å„ç§ä¿¡æ¯å’Œå±æ€§ï¼Œå¦‚æ•°æ®åŒ…çš„åè®®ã€æ•°æ®é•¿åº¦ã€æºå’Œç›®æ ‡åœ°å€ç­‰ã€‚sk_buff æ˜¯ä¸€ç§å¯ä»¥åœ¨ç½‘ç»œå±‚å’Œæ•°æ®é“¾è·¯å±‚ä¹‹é—´ä¼ é€’çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥è¢«ç”¨äºæ‰€æœ‰ç±»å‹çš„ç½‘ç»œåè®®æ ˆï¼Œä¾‹å¦‚ TCP/IPã€UDPã€ICMP ç­‰ã€‚\nsk_buff åœ¨ Linux å†…æ ¸ä¸­å¹¿æ³›åº”ç”¨äºç½‘ç»œåè®®æ ˆçš„å„ä¸ªå±‚çº§ï¼Œå¦‚æ•°æ®é“¾è·¯å±‚ã€ç½‘ç»œå±‚ã€ä¼ è¾“å±‚ç­‰ã€‚sk_buff æ•°æ®ç»“æ„çš„å­—æ®µå¾ˆå¤šï¼Œæœ‰ 4 ä¸ªé‡è¦çš„å­—æ®µä¸”éƒ½æ˜¯æŒ‡é’ˆç±»å‹ã€‚sk_buff åœ¨ä¸åŒå±‚çš„ä½¿ç”¨ï¼Œå°±æ˜¯é€šè¿‡ä¿®æ”¹è¿™äº›æŒ‡é’ˆæ¥å®Œæˆçš„ï¼šåŠ  header ï¼ˆå°åŒ…ï¼‰å’Œç§»é™¤ headerï¼ˆè§£åŒ…ï¼‰ã€‚\nè¿™ä¸ªè¿‡ç¨‹æ“ä½œåšçš„æ˜¯æŒ‡é’ˆï¼Œæ•°æ®æ˜¯é›¶æ‹·è´çš„ï¼Œå¯ä»¥æå¤§åœ°æå‡æ•ˆç‡ã€‚\nå†…æ ¸ç½‘ç»œåè®®æ ˆ è¿™é‡Œç”¨ä¸€å¼ å›¾å¹¶ç»“åˆå°åŒ…å’Œè§£åŒ…çš„è¿‡ç¨‹ï¼Œæ¥ç®€å•è¯´æ˜åº”ç”¨å‘é€æˆ–è€…æ¥æ”¶æ•°æ®æ—¶çš„æµç¨‹ã€‚\nå°åŒ… åº”ç”¨ç¨‹åºä½¿ç”¨ socket çš„ sendmsg æ“ä½œå‘é€æ•°æ®ï¼ˆè¿™é‡Œä¸æ·±å…¥è®²è§£ netfilterã€traffic controlã€queue disciplineï¼‰ï¼š\nå…ˆåˆ†é… sk_buff æ¥ä¸‹æ¥å¼€å§‹ç½‘ç»œåè®®æ ˆçš„å¤„ç† è®¾ç½®ä¼ è¾“å±‚ä¿¡æ¯ï¼ˆè¿™é‡Œæ˜¯ TCP å¤´ä¸­çš„æºå’Œç›®çš„ç«¯å£ï¼‰ æ ¹æ®ç›®æ ‡ IP æŸ¥æ‰¾è·¯ç”± è®¾ç½®ç½‘ç»œå±‚ä¿¡æ¯ï¼ˆæºå’Œç›®çš„ IP åœ°å€ç­‰ï¼‰ è°ƒç”¨ netfilterï¼ˆLOCAL_OUTï¼‰ è®¾ç½®æ¥å£ï¼ˆinterfaceï¼‰å’Œåè®®ï¼ˆprotocolï¼‰ è°ƒç”¨ netfilterï¼ˆPOST_ROUTINGï¼‰ å¦‚æœåŒ…è¿‡é•¿ï¼Œåˆ†æ®µä¼ è¾“ L2 å¯»å€ï¼Œå³æŸ¥æ‰¾å¯ä»¥æ‹¥æœ‰ç›®æ ‡ IP åœ°å€çš„è®¾å¤‡çš„ MAC åœ°å€ è®¾ç½®é“¾è·¯å±‚ä¿¡æ¯ï¼Œ è‡³æ­¤å†…æ ¸ç½‘ç»œåè®®æ ˆçš„æ“ä½œå®Œæˆ è°ƒç”¨ tcï¼ˆtraffic controlï¼‰egressï¼ˆå¯ä»¥å¯¹åŒ…è¿›è¡Œé‡å®šå‘ï¼‰ è¿›å…¥é˜Ÿåˆ— queue disciplineï¼ˆqdiscï¼‰ å†™å…¥ NICï¼ˆnetwork interface controlerï¼‰ å‘é€åˆ°ç½‘ç»œ è§£åŒ… NIC æ”¶åˆ°ç½‘ç»œå‘æ¥çš„æ•°æ®åŒ…ï¼ˆè¿™é‡Œä¸æ·±å…¥è®²è§£ direct memory accessã€netfilterã€traffic controlï¼‰ï¼š\nå°†æ•°æ®åŒ…å†™å¦‚ DMA ä¸­ï¼ˆDirect Memory Access ç›´æ¥å†…å­˜è®¿é—®ï¼Œä¸éœ€è¦ä¾èµ– CPUï¼Œç”± NIC ç›´æ¥å†™å…¥åˆ°å†…å­˜ä¸­ï¼‰ åˆ†é… sk_buffï¼Œå¹¶å¡«å……å…ƒæ•°æ®ï¼Œæ¯”å¦‚ protocol ä¸º Ethernet ç±»å‹ï¼Œæ¥æ”¶æ•°æ®åŒ…çš„ç½‘ç»œæ¥å£ç­‰ å°†é“¾è·¯å±‚ä¿¡æ¯ä¿å­˜åœ¨ sk_buff çš„ mac_header å­—æ®µä¸­ï¼Œå¹¶â€œç§»é™¤â€æ•°æ®åŒ…ä¸­çš„é“¾è·¯å±‚ä¿¡æ¯ï¼ˆç§»åŠ¨æŒ‡é’ˆï¼‰ æ¥ä¸‹æ¥å¼€å§‹ç½‘ç»œåè®®æ ˆçš„å¤„ç† å°†ç½‘ç»œå±‚ä¿¡æ¯ä¿å­˜åœ¨ network_header å­—æ®µä¸­ è°ƒç”¨ tc ingress â€œç§»é™¤â€ç½‘ç»œå±‚ä¿¡æ¯ å°†ä¼ è¾“å±‚ä¿¡æ¯ä¿å­˜åœ¨ transport_header å­—æ®µä¸­ è°ƒç”¨ netfilterï¼ˆPRE_ROUTINGï¼‰ æŸ¥æ‰¾è·¯ç”± åˆå¹¶å¤šä¸ªåˆ†åŒ… è°ƒç”¨ netfilterï¼ˆLOCAL_INï¼‰ â€œç§»é™¤â€ä¼ è¾“å±‚ä¿¡æ¯ æŸ¥æ‰¾ç›‘å¬ç›®æ ‡ç«¯å£çš„ socketï¼Œæˆ–è€…å‘é€ reset å°†æ•°æ®å†™å…¥ socket çš„æ¥æ”¶é˜Ÿåˆ—ä¸­ å‘ä¿¡å·é€šçŸ¥æœ‰æ•°æ®å†™å…¥é˜Ÿåˆ— è‡³æ­¤å†…æ ¸ç½‘ç»œåè®®æ ˆçš„æ“ä½œå®Œæˆ sk_buff ä» socket æ¥æ”¶é˜Ÿåˆ—ä¸­å‡ºé˜Ÿ å°†æ•°æ®å†™å…¥åº”ç”¨ç¨‹åºçš„ç¼“å†²åŒº é‡Šæ”¾ sk_buff Kubernetes çš„ç½‘ç»œæ¨¡å‹ å¦ä¸€éƒ¨åˆ†çš„åŸºç¡€çŸ¥è¯†å°±æ˜¯ Kubernetes çš„ç½‘ç»œæ¨¡å‹äº†ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„é‚£ç¯‡ æ·±å…¥æ¢ç´¢ Kubernetes ç½‘ç»œæ¨¡å‹å’Œç½‘ç»œé€šä¿¡ã€‚\nKubernetes ä¸­çš„æ•°æ®åŒ…æµè½¬ è¿™é‡Œç»§ç»­è®¨è®ºä¹‹å‰æ–‡ç« ä¸­çš„ä¸‰ç§é€šä¿¡åœºæ™¯ï¼Œpod é—´çš„é€šä¿¡ä½¿ç”¨ pod IP åœ°å€ã€‚å¦‚æœè¦è®¨è®ºé€šè¿‡ Service æ¥è®¿é—®ï¼Œåˆ™è¦åŠ å…¥ netfilter çš„è®¨è®ºç¯‡å¹…ä¼šå¢åŠ ä¸å°‘ã€‚\nåŒ pod å†…çš„å®¹å™¨é—´é€šä¿¡ pod å†…ä¸¤ä¸ªå®¹å™¨é—´çš„æ–¹å¼é€šå¸¸ä½¿ç”¨å›ç¯åœ°å€ 127.0.0.1ï¼Œåœ¨å°åŒ…çš„ #4 è·¯ç”±è¿‡ç¨‹ä¸­ç¡®å®šäº†ä½¿ç”¨å›ç¯ç½‘å¡ lo è¿›è¡Œä¼ è¾“ã€‚\nåŒèŠ‚ç‚¹ä¸Šçš„ pod é—´é€šä¿¡ curl å‘å‡ºçš„è¯·æ±‚åœ¨å°åŒ… #4 è¿‡ç¨‹ä¸­ç¡®å®šä½¿ç”¨ eth0 æ¥å£ã€‚ç„¶åé€šè¿‡ä¸ eth0 ç›¸è¿çš„éš§é“ veth1 åˆ°è¾¾èŠ‚ç‚¹çš„æ ¹ç½‘ç»œç©ºé—´ã€‚\nveth1 é€šè¿‡ç½‘æ¡¥ cni0 ä¸å…¶ä»– pod ç›¸è¿è™šæ‹Ÿä»¥å¤ªæ¥å£ vethX ç›¸è¿ã€‚åœ¨å°åŒ… #10 L2 å¯»å€ä¸­ï¼ŒARP è¯·æ±‚é€šè¿‡ç½‘æ¡¥å‘é€ç»™æ‰€æœ‰ç›¸è¿çš„æ¥å£æ˜¯å¦æ‹¥æœ‰åŸå§‹è¯·æ±‚ä¸­çš„ç›®çš„ IP åœ°å€ï¼ˆè¿™é‡Œæ˜¯ 10.42.1.9ï¼‰\næ‹¿åˆ°äº† veth0 çš„ MAC åœ°å€åï¼Œåœ¨å°åŒ… #11 ä¸­è®¾ç½®æ•°æ®åŒ…çš„é“¾è·¯å±‚ä¿¡æ¯ã€‚æ•°æ®åŒ…å‘å‡ºåï¼Œç»è¿‡ veth0 éš§é“è¿›å…¥ pod httpbin çš„ eth0 æ¥å£ä¸­ï¼Œç„¶åå¼€å§‹è§£åŒ…çš„è¿‡ç¨‹ã€‚\nè§£åŒ…çš„è¿‡ç¨‹æ²¡å•¥ç‰¹åˆ«ï¼Œç¡®å®šäº† httpbin ä½¿ç”¨çš„ socketã€‚\nä¸åŒèŠ‚ç‚¹çš„ pod é—´é€šä¿¡ è¿™é‡Œç¨å¾®ä¸åŒï¼Œå°±æ˜¯åœ¨é€šè¿‡ cni0 å‘é€ ARP è¯·æ±‚æ²¡æœ‰æ”¶åˆ°åº”ç­”ï¼Œä½¿ç”¨æ ¹å‘½åç©ºé—´ä¹Ÿå°±æ˜¯ä¸»æœºçš„è·¯ç”±è¡¨ï¼Œç¡®å®šäº†ç›®æ ‡ä¸»æœº IP åœ°å€åï¼Œç„¶åé€šè¿‡ä¸»æœºçš„ eth0 æ”¾ ARP è¯·æ±‚å¹¶æ”¶åˆ°ç›®æ ‡ä¸»æœºçš„å“åº”ã€‚å°†å…¶ MAC åœ°å€åœ¨å°åŒ… #11 ä¸­å†™å…¥ã€‚\næ•°æ®åŒ…å‘é€åˆ°ç›®æ ‡ä¸»æœºåï¼Œå¼€å§‹è§£åŒ…çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆè¿›å…¥ç›®æ ‡ podã€‚\nåœ¨é›†ç¾¤å±‚é¢æœ‰ä¸€å¼ è·¯ç”±è¡¨ï¼Œé‡Œé¢å­˜å‚¨ç€æ¯ä¸ªèŠ‚ç‚¹çš„ Pod IP ç½‘æ®µï¼ˆèŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤æ—¶ä¼šåˆ†é…ä¸€ä¸ª Pod ç½‘æ®µï¼ˆPod CIDRï¼‰ï¼Œæ¯”å¦‚åœ¨ k3s ä¸­é»˜è®¤çš„ Pod CIDR æ˜¯ 10.42.0.0/16ï¼ŒèŠ‚ç‚¹è·å–åˆ°çš„ç½‘æ®µæ˜¯ 10.42.0.0/24ã€10.42.1.0/24ã€10.42.2.0/24ï¼Œä¾æ¬¡ç±»æ¨ï¼‰ã€‚é€šè¿‡èŠ‚ç‚¹çš„ Pod IP ç½‘æ®µå¯ä»¥åˆ¤æ–­å‡ºè¯·æ±‚ IP çš„èŠ‚ç‚¹ï¼Œç„¶åè¯·æ±‚è¢«å‘é€åˆ°è¯¥èŠ‚ç‚¹ã€‚\næ€»ç»“ ç»Ÿè®¡ä¸€ä¸‹åœ¨ä¸‰ä¸ªåœºæ™¯ä¸­ï¼Œç»è¿‡å†…æ ¸ç½‘ç»œåè®®æ ˆçš„å¤„ç†æ¬¡æ•°éƒ½æ˜¯ä¸¤æ¬¡ï¼ˆåŒ…æ‹¬ netfilter çš„å¤„ç†ã€‚ï¼‰ï¼Œå³ä½¿æ˜¯åŒ pod æˆ–è€…åŒèŠ‚ç‚¹å†…ã€‚è€Œè¿™ä¸¤ç§æƒ…å†µå®é™…éƒ½å‘ç”Ÿåœ¨åŒä¸€ä¸ªå†…æ ¸ç©ºé—´ä¸­ã€‚\nå‡å¦‚åŒä¸€ä¸ªå†…æ ¸ç©ºé—´ä¸­çš„ä¸¤ä¸ª socket å¯ä»¥ç›´æ¥ä¼ è¾“æ•°æ®ï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥çœæ‰å†…æ ¸ç½‘ç»œåè®®æ ˆå¤„ç†å¸¦æ¥çš„å»¶è¿Ÿï¼Ÿ\nä¸‹ç¯‡ï¼šä½¿ç”¨ eBPF æŠ€æœ¯å®ç°æ›´å¿«çš„ç½‘ç»œæ•°æ®åŒ…ä¼ è¾“ ä¼šç»§ç»­åˆ†ææ–¹æ¡ˆçš„å¯è¡Œæ€§å’Œå®ç°ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-pixabay-63324.jpg","permalink":"https://atbug.com/tracing-network-packets-in-kubernetes/","tags":["Kubernetes","ç½‘ç»œ","CNI"],"title":"è¿½è¸ª Kubernetes ä¸­çš„æ•°æ®åŒ…"},{"categories":["ç¬”è®°"],"contents":"èƒŒæ™¯ è¿‡å»å‡ å¹´ï¼Œå…¬æœ‰äº‘å‡­å€Ÿç€æ›´é«˜æ‰©å±•æ€§ã€çµæ´»æ€§ã€å¯é æ€§å’Œå®‰å…¨æ€§ï¼Œå¸å¼•äº†å¤§é‡çš„ä¼ä¸šå°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°å…¬æœ‰äº‘ä¸Šã€‚éšç€ä¸šåŠ¡è§„æ¨¡çš„ä¸æ–­æ‰©å¼ ï¼Œä¼ä¸šå‡ºäºæŸäº›åŸå› ï¼Œå¦‚é¿å…å‚å•†é”å®šã€è¿½æ±‚æ›´ä½çš„å»¶è¿Ÿã€æ›´é«˜çš„å¯é æ€§ç­‰ï¼Œé€‰æ‹©å°†åº”ç”¨éƒ¨ç½²åœ¨æ›´å¤šçš„å…¬æœ‰äº‘ä¸Šï¼›ä¹Ÿæœ‰äº›ä¼ä¸šå‡ºäºæ•°æ®æ•æ„Ÿæ€§ç­‰åŸå› ï¼Œé€‰æ‹©å°†éƒ¨åˆ†åº”ç”¨éƒ¨ç½²æœ‰ç§æœ‰ç¯å¢ƒä¸­ã€‚åè€…ä¹Ÿæ›´åƒæ˜¯å°†ä¸Šäº‘çš„è¿‡ç¨‹æ‹‰é•¿ã€‚ä¸ç®¡æ˜¯å¤šäº‘è¿˜æ˜¯æ··åˆäº‘ï¼ŒåŸºç¡€è®¾æ–½éƒ½ä¸å¯é¿å…çš„å­˜åœ¨ç€å·®å¼‚ï¼Œä¼ä¸šä¸å¾—ä¸åœ¨é€‚é…åº•å±‚è®¾æ–½ä¸ŠæŠ•å…¥äº†å¤§é‡çš„äººåŠ›ç‰©åŠ›ã€‚\nKubernetes çš„å‡ºç°ï¼Œå®Œç¾åœ°è§£å†³äº†è¿™ä¸€é—®é¢˜ã€‚é™¤äº†å±è”½åŸºç¡€è®¾æ–½å±‚çš„å·®å¼‚è§£å†³äº†è·¨å¹³å°çš„é—®é¢˜ï¼Œè¿˜æä¾›è‡ªåŠ¨åŒ–çš„å®¹å™¨ç¼–æ’ã€æ›´é«˜çš„æ‰©å±•æ€§ã€å¼¹æ€§å’Œé«˜å¯ç”¨æ€§ï¼Œå…¶èƒŒåæ›´æ˜¯æœ‰ç€åºå¤§çš„ç¤¾åŒºçš„æ”¯æŒã€‚Kubernetes çš„é£é¡ï¼Œå¾—åˆ°äº†å¤§é‡ä¼ä¸šçš„é’çã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œä¼ä¸šä½¿ç”¨å¤šä¸ª Kubernetes é›†ç¾¤ç®¡ç†åº”ç”¨çš„æƒ…å†µè¶Šæ¥è¶Šæ™®éã€‚\nå¦‚ä½•åœ¨è·¨è¶Šå¤šä¸ªé›†ç¾¤ã€ç”šè‡³æ˜¯æ··åˆå¤šäº‘çš„ç¯å¢ƒä¸‹æ¥ç®¡ç†åº”ç”¨æˆäº†æ–°çš„éš¾é¢˜ã€‚Karmada çš„å‡ºç°æ­£æ˜¯è¦è§£å†³è¿™ä¸€é—®é¢˜ã€‚\nKarmada Karmada æ˜¯ CNCFï¼ˆCloud Native Computing Foundationï¼‰ä¸‹é¢çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæ—¨åœ¨ä¸º Kubernetes é›†ç¾¤æä¾›ä¸€ä¸ªå¹³å°æ¥ç®€åŒ–è·¨å¤šä¸ª Kubernetes é›†ç¾¤çš„åº”ç”¨ç¨‹åºéƒ¨ç½²å’Œç®¡ç†ï¼Œå¹¶æé«˜å¯ç”¨æ€§å’Œå¯æ‰©å±•æ€§ã€‚\nå€Ÿç”¨ä¸€ä¸‹å®˜ç½‘çš„æ¶æ„å›¾ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹åˆ° Karmada æä¾›äº†ä¸€ä¸ªé›†ä¸­å¼æ§åˆ¶å¹³é¢ï¼Œè´Ÿè´£èµ„æºå’Œç­–ç•¥çš„ç®¡ç†ï¼Œä»¥åŠèµ„æºçš„è°ƒåº¦ï¼›æ•°æ®å¹³é¢åˆ™æ˜¯å…¶ç®¡ç†çš„é›†ç¾¤ï¼ŒçœŸæ­£è¿è¡Œèµ„æºçš„é›†ç¾¤ã€‚\næ§åˆ¶å¹³é¢çš„ç»„ä»¶ä¸ Kubernetes çš„ç»„ä»¶ç±»ä¼¼ï¼Œä¹Ÿéƒ½æ˜¯è´Ÿè´£èµ„æºçš„è°ƒåº¦ã€‚ä¸åŒçš„æ˜¯ï¼ŒKubernetes çš„æ§åˆ¶å¹³é¢è´Ÿè´£å°†èµ„æºè°ƒåº¦åˆ°è®¡ç®—èŠ‚ç‚¹ï¼Œè€Œ Karmada çš„æ§åˆ¶å¹³é¢æ˜¯å°†èµ„æºè°ƒåº¦åˆ°æŸä¸ªé›†ç¾¤ã€‚\næ‹¿ Deployment çš„éƒ¨ç½²æ¥è¯´ï¼Œåœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œæ§åˆ¶å¹³é¢æ ¹æ®å½“å‰èŠ‚ç‚¹çš„èµ„æºæƒ…å†µé€‰æ‹©æŸä¸ªæˆ–æŸäº›èŠ‚ç‚¹æ¥è¿è¡Œ podã€‚åœ¨ Karmada å¤šé›†ç¾¤ä¸‹ï¼Œåˆ›å»ºäº† Deployment èµ„æºåï¼ŒKarmada æ§åˆ¶å¹³é¢æ ¹æ®ç­–ç•¥å°†å…¶è°ƒåº¦åˆ°ç›®æ ‡çš„é›†ç¾¤ï¼šåœ¨ç›®æ ‡é›†ç¾¤ä¸­åˆ›å»º Deployment èµ„æºï¼Œæ‰€æœ‰é›†ç¾¤ä¸­çš„å‰¯æœ¬æ•°ä¹‹å’Œï¼Œå°±æ˜¯æœŸæœ›çš„å‰¯æœ¬æ•°ã€‚\nä¸‹é¢é€šè¿‡ç¤ºä¾‹æ¥è¿›è¡Œè¯´æ˜ã€‚\nç¯å¢ƒæ­å»º å‰ç½®æ¡ä»¶ Docker k3d kubectl karmadactl 1 å°è™šæ‹Ÿæœºï¼ˆæœ€ä½é…ç½®ä¸ä½äº 4c8gï¼‰ æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ k3d åœ¨å®¹å™¨ä¸­åˆ›å»º 4 ä¸ª k3s é›†ç¾¤ï¼ˆæ§åˆ¶å¹³é¢é›†ç¾¤ control-plane å’Œæˆå‘˜ cluster-1ã€cluster-2ã€cluster-3ï¼‰ï¼Œè¿™äº›é›†ç¾¤é€šè¿‡æœ¬æœº IP åœ°å€å’Œç‹¬ç«‹çš„ç«¯å£è¿›è¡Œé€šä¿¡ã€‚\nåˆ›å»ºå¤šä¸ªé›†ç¾¤ åˆ›å»ºé›†ç¾¤å‰é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è·å–æœ¬åœ° IPï¼Œä¿å­˜åœ¨å˜é‡ä¸­ã€‚\nHOST_IP=$(if [ \u0026#34;$(uname)\u0026#34; == \u0026#34;Darwin\u0026#34; ]; then ipconfig getifaddr en0; else ip -o route get to 8.8.8.8 | sed -n \u0026#39;s/.*src \\([0-9.]\\+\\).*/\\1/p\u0026#39;; fi) ä½¿ç”¨ k3d çš„å‘½ä»¤åˆ›å»ºé›†ç¾¤ï¼Œé›†ç¾¤ apiserver çš„ç«¯å£åˆ†åˆ«ä¸º 6444ã€6445ã€6446ã€6447.\nAPI_PORT=6444 #6444 6445 6446 6447 for CLUSTER_NAME in control-plane cluster-1 cluster-2 cluster-3 do k3d cluster create ${CLUSTER_NAME} \\ --image docker.io/rancher/k3s:v1.23.8-k3s2 \\ --api-port \u0026#34;${HOST_IP}:${API_PORT}\u0026#34; \\ --servers-memory 2g \\ --k3s-arg \u0026#34;--disable=traefik@server:0\u0026#34; \\ --network multi-clusters \\ --timeout 120s \\ --wait ((API_PORT=API_PORT+1)) done åˆ›å»ºå®Œé›†ç¾¤ï¼Œä¸ºäº†ä¾¿äºé›†ç¾¤çš„è®¿é—®ï¼Œè®¾ç½®å¦‚ä¸‹å˜é‡æ¥è®¿é—®å¯¹åº”çš„é›†ç¾¤ã€‚\nk3d kubeconfig get control-plane \u0026gt; /tmp/cp.kubeconfig k3d kubeconfig get cluster-1 \u0026gt; /tmp/c1.kubeconfig k3d kubeconfig get cluster-2 \u0026gt; /tmp/c2.kubeconfig k3d kubeconfig get cluster-3 \u0026gt; /tmp/c3.kubeconfig #ä½¿ç”¨ k0=\u0026#34;kubectl --kubeconfig /tmp/cp.kubeconfig\u0026#34; k1=\u0026#34;kubectl --kubeconfig /tmp/c1.kubeconfig\u0026#34; k2=\u0026#34;kubectl --kubeconfig /tmp/c2.kubeconfig\u0026#34; k3=\u0026#34;kubectl --kubeconfig /tmp/c3.kubeconfig\u0026#34; å®‰è£… Karmada åœ¨æ§åˆ¶å¹³é¢é›†ç¾¤ä¸Šå®‰è£… Karmada è¿›è¡Œåˆå§‹åŒ–ã€‚\nsudo karmadactl --kubeconfig /tmp/cp.kubeconfig init å®Œæˆåˆå§‹åŒ–åï¼ŒåŒæ ·è®¾ç½®å˜é‡ kmd æ¥æ–¹ä¾¿è®¿é—® Karmada çš„æ§åˆ¶å¹³é¢ï¼ŒæŒ‡å®šä½¿ç”¨ Karmada apiserver çš„é…ç½®æ–‡ä»¶ï¼ˆè¯¥é…ç½®æ–‡ä»¶æ˜¯åœ¨åˆå§‹åŒ–æ—¶è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ‰€ä»¥ä¸Šé¢çš„å‘½ä»¤ç”¨ï¼‰ã€‚\nkmd=\u0026#34;kubectl --kubeconfig /etc/karmada/karmada-apiserver.config\u0026#34; åŠ å…¥é›†ç¾¤ æ¥ä¸‹æ¥å°†å…¶ä»–ä¸‰ä¸ªé›†ç¾¤åŠ å…¥åˆ°è”é‚¦ä¸­ï¼ˆk3d è‡ªåŠ¨åœ¨é›†ç¾¤åå‰åŠ ä¸Šäº†å‰ç¼€ k3d-ï¼‰ã€‚\nkarmadactl --kubeconfig /etc/karmada/karmada-apiserver.config join k3d-cluster-1 --cluster-kubeconfig=/tmp/c1.kubeconfig karmadactl --kubeconfig /etc/karmada/karmada-apiserver.config join k3d-cluster-2 --cluster-kubeconfig=/tmp/c2.kubeconfig karmadactl --kubeconfig /etc/karmada/karmada-apiserver.config join k3d-cluster-3 --cluster-kubeconfig=/tmp/c3.kubeconfig è¿”å›ä¸‹é¢çš„ä¿¡æ¯è¯´æ˜é›†ç¾¤åŠ å…¥æˆåŠŸã€‚\ncluster(k3d-cluster-1) is joined successfully cluster(k3d-cluster-2) is joined successfully cluster(k3d-cluster-3) is joined successfully è®¿é—® Karmada çš„æ§åˆ¶å¹³é¢æŸ¥çœ‹é›†ç¾¤åˆ—è¡¨ã€‚\n$kmd get cluster -o wide NAME VERSION MODE READY AGE APIENDPOINT k3d-cluster-1 v1.23.8+k3s2 Push True 24m https://10.0.0.8:6445 k3d-cluster-2 v1.23.8+k3s2 Push True 24m https://10.0.0.8:6446 k3d-cluster-3 v1.23.8+k3s2 Push True 23m https://10.0.0.8:6447 è‡³æ­¤å¤šé›†ç¾¤ç¯å¢ƒå·²ç»æ­å»ºå®Œæˆã€‚\næµ‹è¯• è¿™é‡Œé€‰æ‹©ä¸¤ç§åº”ç”¨ï¼šæœåŠ¡ç«¯åº”ç”¨å“åº” HTTP è¯·æ±‚ï¼Œè¿”å›å½“å‰ pod çš„åå­—ï¼›å®¢æˆ·ç«¯åº”ç”¨ï¼Œå¯ä»¥ç”¨æ¥å‘èµ· HTTP è¯·æ±‚ã€‚\néƒ¨ç½²æœåŠ¡ç«¯åº”ç”¨ é€šè¿‡ Karmada çš„æ§åˆ¶å¹³é¢åˆ›å»º 2 ä¸ªå‰¯æœ¬çš„ Deployment å’Œ Serviceã€‚\n$kmd apply -f - \u0026lt;\u0026lt;EOF apiVersion: apps/v1 kind: Deployment metadata: labels: app: pipy name: pipy namespace: default spec: replicas: 2 selector: matchLabels: app: pipy strategy: {} template: metadata: labels: app: pipy spec: containers: - image: flomesh/pipy name: pipy command: [\u0026#34;pipy\u0026#34;] args: [\u0026#34;-e\u0026#34;, \u0026#34;pipy().listen(8080).serveHTTP(() =\u0026gt; new Message(os.env[\u0026#39;HOSTNAME\u0026#39;] +\u0026#39;\\n\u0026#39;))\u0026#34;] --- apiVersion: v1 kind: Service metadata: labels: app: pipy name: pipy spec: ports: - port: 8080 protocol: TCP targetPort: 8080 selector: app: pipy EOF ç„¶åæŸ¥çœ‹ Deployment çš„ä¿¡æ¯ï¼Œå¹¶æ²¡æœ‰ä»»ä½•å‰¯æœ¬è¿è¡Œã€‚\n$kmd get deployment NAME READY UP-TO-DATE AVAILABLE AGE pipy 0/2 0 0 20s é€šè¿‡ describe å‘½ä»¤å‘ç°å¦‚ä¸‹è­¦å‘Šï¼Œæç¤ºæ²¡æœ‰åŒ¹é…èµ„æºçš„ç­–ç•¥ã€‚Karmada éœ€è¦æ ¹æ®èµ„æºçš„å¤šé›†ç¾¤è°ƒåº¦ç­–ç•¥ PropagationPolicy å°†å…¶è°ƒåº¦åˆ°ç›®æ ‡é›†ç¾¤ã€‚\nWarning ApplyPolicyFailed 47s resource-detector No policy match for resource Propagation ç­–ç•¥ åº”ç”¨ä¸‹é¢çš„ç­–ç•¥å°† Deployment å’Œ Service èµ„æºè°ƒåº¦åˆ°ä¸‰ä¸ªæˆå‘˜é›†ç¾¤ã€‚\n$kmd apply -f - \u0026lt;\u0026lt;EOF apiVersion: policy.karmada.io/v1alpha1 kind: PropagationPolicy metadata: name: pipy-propagation spec: resourceSelectors: - apiVersion: apps/v1 kind: Deployment name: pipy - apiVersion: v1 kind: Service name: pipy placement: clusterAffinity: clusterNames: - k3d-cluster-1 - k3d-cluster-2 - k3d-cluster-3 replicaScheduling: replicaDivisionPreference: Weighted replicaSchedulingType: Divided weightPreference: staticWeightList: - targetCluster: clusterNames: - k3d-cluster-1 weight: 10 - targetCluster: clusterNames: - k3d-cluster-2 weight: 10 - targetCluster: clusterNames: - k3d-cluster-3 weight: 10 EOF åœ¨é›†ç¾¤ cluster-1 å’Œ cluster-2 ä¸­å¯ä»¥çœ‹åˆ°æœ‰ pod åœ¨è¿è¡Œã€‚\n$k1 get deployment NAME READY UP-TO-DATE AVAILABLE AGE pipy 1/1 1 1 13s $k2 get deployment NAME READY UP-TO-DATE AVAILABLE AGE pipy 1/1 1 1 13s è€Œ cluster-3 ä¸Šåªæ‰¾åˆ°äº† deploymentï¼Œä½†æœŸæœ›å‰¯æœ¬æ•°ä¸º 0ã€‚è¿™æ˜¯å› ä¸ºåœ¨æ§åˆ¶å¹³é¢ä¸­åˆ›å»ºçš„ deployment åªè®¾ç½®äº†ä¸¤ä¸ªå‰¯æœ¬ã€‚\n$k3 get deployment NAME READY UP-TO-DATE AVAILABLE AGE pipy 0/0 0 0 16s åœ¨æ§åˆ¶å¹³é¢ä¸­å°†å‰¯æœ¬æ•°è°ƒæ•´ä¸º 3ã€‚\n$kmd scale deploy pipy --replicas 3 ç„¶ååœ¨ cluster-3 å°±å¯ä»¥çœ‹åˆ°ç¬¬ä¸‰ä¸ªå‰¯æœ¬ã€‚\n$k3 get po NAME READY STATUS RESTARTS AGE pipy-8ff5f5987-5nqqw 1/1 Running 0 54s éƒ¨ç½²å®¢æˆ·ç«¯åº”ç”¨ æ¥ä¸‹æ¥éƒ¨ç½²å®¢æˆ·ç«¯åº”ç”¨ã€‚\n$kmd apply -f - \u0026lt;\u0026lt;EOF apiVersion: apps/v1 kind: Deployment metadata: labels: app: curl name: curl namespace: default spec: replicas: 1 selector: matchLabels: app: curl strategy: {} template: metadata: creationTimestamp: null labels: app: curl spec: containers: - image: curlimages/curl name: curl command: [\u0026#34;sleep\u0026#34;, \u0026#34;365d\u0026#34;] EOF åŒæ ·é…ç½®å¤šé›†ç¾¤è°ƒåº¦ç­–ç•¥ï¼Œåªè°ƒåº¦åˆ°é›†ç¾¤ cluster-3ã€‚\n$kmd apply -f - \u0026lt;\u0026lt;EOF apiVersion: policy.karmada.io/v1alpha1 kind: PropagationPolicy metadata: name: curl-propagation spec: resourceSelectors: - apiVersion: apps/v1 kind: Deployment name: curl placement: clusterAffinity: clusterNames: - k3d-cluster-3 replicaScheduling: replicaDivisionPreference: Weighted replicaSchedulingType: Divided weightPreference: staticWeightList: - targetCluster: clusterNames: - k3d-cluster-3 weight: 1 EOF ä»è¯¥ pod ä¸­å‘èµ·è¯·æ±‚è®¿é—®åº”ç”¨çš„ 8080 ç«¯å£ï¼ŒæˆåŠŸæ”¶åˆ°å“åº”ã€‚å¤šæ¬¡è¯·æ±‚ï¼Œéƒ½ä¼šè·å¾—åŒæ ·çš„ç»“æœã€‚\ncurl_client=`$k3 get po -l app=curl -o jsonpath=\u0026#39;{.items[0].metadata.name}\u0026#39;` $k3 exec $curl_client -- curl -s http://pipy.default:8080 pipy-8ff5f5987-5nqqw æ€»ç»“ Karmada çš„å‡ºç°åœ¨ä¸æ”¹å˜éƒ¨ç½²æ–¹å¼çš„æƒ…å†µä¸‹è§£å†³äº†å¤šé›†ç¾¤ä¸­åº”ç”¨çš„ç®¡ç†éš¾é¢˜ï¼Œå®ç°äº†åº”ç”¨åœ¨å¤š Kubernetes é›†ç¾¤ä¸­çš„éƒ¨ç½²ã€åŒæ­¥å’Œè°ƒåº¦ã€‚æ–‡ä¸­æ²¡æœ‰å±•ç¤ºçš„è¿˜æœ‰å¯è§‚å¯Ÿæ€§ï¼ŒKarmada æ§åˆ¶å¹³é¢å¯ä»¥æ±‡æ€»æˆå‘˜é›†ç¾¤ä¸­çš„ç›‘æ§æ•°æ®å¹¶é›†ä¸­å±•ç¤ºã€‚\næ€è€ƒ å¯èƒ½ä½ ä¹Ÿå‘ç°äº†ï¼Œåœ¨æ¼”ç¤ºä¸­å®¢æˆ·ç«¯æ”¶åˆ°çš„å“åº”éƒ½æ˜¯æ¥è‡ªåŒé›†ç¾¤ä¸­çš„åº”ç”¨ã€‚\næ­¤æ—¶å‡å¦‚å°† deployment çš„å‰¯æœ¬æ•°ç¼©å‡åˆ° 2ï¼Œå¹¶å†æ¬¡è¯·æ±‚ã€‚ä½ ä¼šå‘ç°è¯·æ±‚å¤±è´¥ï¼Œè¯·æ±‚æ²¡æœ‰è¢«è°ƒåº¦åˆ°å…¶ä»–é›†ç¾¤ã€‚\nå¯è§ï¼Œè™½ç„¶åº”ç”¨çš„è·¨é›†ç¾¤ç®¡ç†ç”± Karmada å¸®æˆ‘ä»¬å®Œæˆäº†ï¼Œä½†æ˜¯æµé‡ä»æ— æ³•è·¨é›†ç¾¤ã€‚è¿™è¯´æ˜ä»€ä¹ˆï¼Ÿå½“ä½ çš„åº”ç”¨åœ¨åšå¤šé›†ç¾¤éƒ¨ç½²æ—¶ï¼Œç”±äºåº”ç”¨é—´å½¼æ­¤ä¾èµ–éœ€è¦åšè¿‘ä¹å…¨é‡çš„éƒ¨ç½²ï¼Œé‚£å½±å“å’Œæˆæœ¬å¯æƒ³è€ŒçŸ¥ã€‚\nåœ¨ä¸‹ä¸€ç¯‡ï¼Œæˆ‘å°†å¸¦å¤§å®¶æ¥å°è¯•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-trushotz-3635300-1.jpg","permalink":"https://atbug.com/deploy-application-on-multi-clusters-with-karmada/","tags":["Kubernetes","å¤šé›†ç¾¤","æ··åˆå¤šäº‘"],"title":"Karmadaï¼šæ··åˆå¤šäº‘ä¸‹çš„åº”ç”¨ç®¡ç†"},{"categories":["ç¬”è®°"],"contents":"ä¹‹å‰å†™è¿‡ä¸€ç¯‡ ä½¿ç”¨ Terraform éƒ¨ç½² Proxmox è™šæ‹Ÿæœºï¼Œé‚£æ˜¯ä¸€å° Core i7-8700 + 64G çš„ Homelab ä¸Šæ­å»ºçš„è™šæ‹Ÿæœºç¯å¢ƒï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä¸€ç›´ä»¥æ¥çš„å®éªŒç¯å¢ƒã€‚ç›´è‡³å»å¹´åŠ å…¥å¾®è½¯ MVP æ‹¿åˆ°äº† Azure çš„ creditï¼Œåœ¨éœ€è¦èµ„æºè¾ƒå¤šæˆ–è€…æ‹‰å–é•œåƒé¢‘ç¹çš„æƒ…å†µä¸‹æˆ‘ä¹Ÿä¼šé€‰æ‹©ä½¿ç”¨ Azure çš„è™šæ‹Ÿæœºï¼Œå°¤å…¶æ˜¯æœ€è¿‘ç»å¸¸åœ¨å¤šé›†ç¾¤çš„ç¯å¢ƒåšæµ‹è¯•ã€‚\nåœ¨ Azure ä¸Šåˆ›å»ºè™šæ‹Ÿæœºï¼Œæˆ‘ä¹Ÿä»ä¸€å¼€å§‹çš„ Web é¡µé¢ä¸“é¡¹ CLIï¼Œå†åˆ°ç°åœ¨å› ä¸ºéœ€è¦å¤æ‚é…ç½®æ—¶çš„ Terraformã€‚è¿™ç¯‡æ–‡ç« å°±åˆ†äº«ä¸‹å¦‚ä½•ä½¿ç”¨ Terraform é…ç½® Azure è™šæ‹Ÿæœºçš„åˆ›å»ºã€‚\nTerraform æ˜¯ä¸€ä¸ªåŸºç¡€è®¾æ–½å³ä»£ç çš„è½¯ä»¶å·¥å…·ã€‚ä½¿ç”¨ Terraform å¯ä»¥é€šè¿‡ç¼–å†™ä»£ç æ¥æè¿°åŸºç¡€è®¾æ–½ï¼ˆåŒ…æ‹¬è™šæ‹Ÿæœºã€è´Ÿè½½å‡è¡¡å™¨ã€æ•°æ®åº“ç­‰äº‘å’Œæœ¬åœ°èµ„æºï¼‰çš„æœŸæœ›çŠ¶æ€ï¼Œå®‰å…¨çµæ´»é«˜æ•ˆåœ°æ„å»ºã€æ›´æ”¹å’Œç‰ˆæœ¬åŒ–äº‘å’Œæœ¬åœ°èµ„æºã€‚\nå‰ç½®æ¡ä»¶ åœ¨å¼€å§‹ä¹‹å‰ï¼Œç¡®ä¿å·²ç»å…·å¤‡å¦‚ä¸‹æ¡ä»¶ï¼š\nAzure è´¦æˆ· Terraform CLI Azure CLI è®¤è¯ æ—¢ç„¶è¦åšè‡ªåŠ¨åŒ–ï¼Œç¬¬ä¸€æ­¥å°±è¦è§£å†³è®¤è¯çš„é—®é¢˜ï¼Œæ¯•ç«Ÿæ¯æ¬¡éƒ½è¿›è¡Œæ‰‹å·¥è®¤è¯æ˜¯ä¸ç°å®çš„ï¼Œä¸ç¬¦åˆæ‡’äººçš„ç‰¹å¾ã€‚\nTerraform çš„ Azure Provider æ”¯æŒ 5 ç§è®¤è¯æ–¹å¼ã€‚ç”±äºæˆ‘åªåœ¨æœ¬åœ°ä½¿ç”¨ï¼Œæ•…æœ¬æ–‡æ˜¯é€šè¿‡ Azure CLI çš„æ–¹å¼ è¿›è¡Œè®¤è¯ã€‚\næ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å¼€å¯è®¤è¯ï¼Œè®¤è¯ä¹‹å‰éœ€è®¿é—® https://portal.azure.com/#settings/directory è·å– tenant ä¿¡æ¯ã€‚\naz login --tenant xxxx æ‰§è¡Œå‘½ä»¤åä¼šè‡ªåŠ¨è·³è½¬åˆ°æµè§ˆå™¨ï¼Œå®Œæˆè®¤è¯æµç¨‹ã€‚\nè®¤è¯æˆåŠŸåï¼Œå¯é€šè¿‡å‘½ä»¤æŸ¥çœ‹è´¦æˆ·ä¿¡æ¯ã€‚\naz account show { \u0026#34;environmentName\u0026#34;: \u0026#34;AzureCloud\u0026#34;, \u0026#34;homeTenantId\u0026#34;: \u0026#34;00000000-0000-0000-0000-000000000000\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;00000000-0000-0000-0000-000000000000\u0026#34;, \u0026#34;isDefault\u0026#34;: true, \u0026#34;managedByTenants\u0026#34;: [], \u0026#34;name\u0026#34;: \u0026#34;Microsoft Azure èµåŠ©\u0026#34;, \u0026#34;state\u0026#34;: \u0026#34;Enabled\u0026#34;, \u0026#34;tenantId\u0026#34;: \u0026#34;00000000-0000-0000-0000-000000000000\u0026#34;, \u0026#34;user\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;mail@example.com\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;user\u0026#34; } } å¦‚æœæœ‰å¤šä¸ªè®¢é˜…ï¼Œéœ€è¦è®¾ç½®å½“å‰è´¦æˆ·ä½¿ç”¨çš„è®¢é˜…ã€‚\naz account set --subscription 00000000-0000-0000-0000-000000000000 ä»£ç  è„šæœ¬å·²ç»æäº¤åœ¨ GitHub ä¸Šï¼Œå¯ä»¥è®¿é—® https://github.com/addozhang/terraform-azure-sample è·å–ã€‚\nå°†ä»£ç å…‹éš†åˆ°æœ¬åœ°ã€‚\ngit clone https://github.com/addozhang/terraform-azure-sample.git è„šæœ¬åŒ…å«äº†ä¸¤éƒ¨åˆ†ï¼š\nresource-groupï¼šAzure ä¸Šçš„æ‰€æœ‰èµ„æºéƒ½æ˜¯åœ¨æŸä¸ªèµ„æºç»„ä¸‹åˆ›å»ºçš„ï¼Œåœ¨åˆ›å»ºè™šæ‹Ÿæœºä¹‹å‰éœ€è¦å…ˆåˆ›èµ„æºç»„ï¼Œæˆ–ä½¿ç”¨å·²æœ‰çš„èµ„æºç»„ã€‚åœ¨åˆ›å»ºèµ„æºç»„çš„åŒæ—¶ï¼Œä¹Ÿä¼šåˆ›å»ºè™šæ‹Ÿç½‘ç»œå’Œå­ç½‘ã€‚ virtual-machineï¼šé¡¾åæ€ä¹‰ï¼Œåˆ›å»ºè™šæ‹Ÿæœºèµ„æºã€‚ åˆ›å»ºèµ„æºç»„ è¿›å…¥åˆ°ç›®å½• resource-group ä¸­ï¼Œå…ˆæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥åˆå§‹åŒ– Terraform å’Œä¸‹è½½ Azure providerã€‚\nterraform init åœ¨ variables.tf æ–‡ä»¶ä¸­å®šä¹‰äº†å…¥å‚ï¼šèµ„æºç»„åå’Œä½ç½®ã€‚æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å¯ä»¥åˆ›å»ºèµ„æºç»„ï¼Œä¹Ÿå¯åœ¨åˆ›å»ºæ—¶é€šè¿‡å‚æ•°æ¥æŒ‡å®šåå­—å’Œä½ç½®ã€‚\næ‰§è¡Œå‘½ä»¤æ£€æŸ¥ Terraform ä»£ç ã€‚\nterraform validate æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥åº”ç”¨ä»£ç ã€‚\n# åœ¨ resource-group ç›®å½•ä¸­æ‰§è¡Œ terraform apply # æˆ–è€… terraform apply -var \u0026#34;name=demo\u0026#34; -var \u0026#34;location=eastasia\u0026#34; é€šè¿‡ terraform state list æŸ¥çœ‹åˆ›å»ºçš„èµ„æºã€‚æˆ–è€…é€šè¿‡ terrafor show æ¥æŸ¥çœ‹èµ„æºçš„è¯¦ç»†ä¿¡æ¯ã€‚\nterraform state list azurerm_resource_group.demo azurerm_subnet.demo azurerm_virtual_network.demo åˆ›å»ºè™šæ‹Ÿæœº è¿›å…¥åˆ°ç›®å½• virtual-machine ç›®å½•ï¼Œä¾ç„¶æ˜¯å…ˆè¿è¡Œå‘½ä»¤è¿›è¡Œåˆå§‹åŒ–ã€‚\nterraform init åˆ›å»ºè™šæ‹Ÿæœºçš„å‚æ•°å°±ä¼šå¤šä¸€äº›ï¼Œå…·ä½“å‚æ•°å®šä¹‰å¯ä»¥æŸ¥çœ‹ variables.tfï¼Œé€šè¿‡ terraform.tfvars æ–‡ä»¶å¯ä»¥è®¾ç½®å‚æ•°å€¼ï¼Œè¿™é‡Œ éœ€è¦æŒ‡å®šä½¿ç”¨çš„è®¢é˜… IDã€‚\næ‰§è¡Œä»£ç å’Œå‚æ•°æ£€æŸ¥ã€‚\nterraform validate æ‰§è¡Œå‘½ä»¤æ¥åˆ›å»ºè™šæ‹Ÿæœºã€‚\n# åœ¨ virtual-machine ç›®å½•ä¸­æ‰§è¡Œ terraform apply æ¯”å¦‚å°†è™šæ‹Ÿæœºçš„æ•°é‡ vm_count è®¾ç½®ä¸º 3ï¼Œæ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤ä¹‹åæŸ¥çœ‹èµ„æºã€‚\nterraform state list azurerm_linux_virtual_machine.demo[0] azurerm_linux_virtual_machine.demo[1] azurerm_linux_virtual_machine.demo[2] azurerm_network_interface.demo[0] azurerm_network_interface.demo[1] azurerm_network_interface.demo[2] azurerm_public_ip.demo[0] azurerm_public_ip.demo[1] azurerm_public_ip.demo[2] é€šè¿‡å‘½ä»¤ terraform show å¯ä»¥æŸ¥çœ‹èµ„æºçš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”å¦‚å…¬ç½‘çš„ IP åœ°å€ç­‰ç­‰ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/sunset-beach.jpg","permalink":"https://atbug.com/create-azure-virtual-machine-with-terraform/","tags":["Terraform"],"title":"ä½¿ç”¨ Terraform åˆ›å»º Azure è™šæ‹Ÿæœº"},{"categories":["ç¬”è®°"],"contents":"åœ¨ ä¸Šä¸€ç¯‡ æ–‡ç« ä¸­åˆ†äº«äº†åˆ†å¸ƒå¼è¿è¡Œæ—¶ Dapr çš„ä½¿ç”¨ï¼Œåœ¨ç¤ºä¾‹ä¸­å°†çŠ¶æ€å­˜å‚¨èƒ½åŠ›åˆ†ç¦»åˆ° Dapr è¿è¡Œæ—¶ä¸­ï¼Œåº”ç”¨é€šè¿‡ Dapr API æ¥ä½¿ç”¨è¯¥èƒ½åŠ›ã€‚è¿™ç¯‡æ–‡ç« å°†ä»‹ç»å¦‚ä½•é€šè¿‡ Ingress Controllerï¼ˆå…¥å£æ§åˆ¶å™¨ï¼‰æ¥è®¿é—® Dapr åº”ç”¨ã€‚\næ–¹æ¡ˆ å¦‚ä½•å…¬å¼€ Dapr åº”ç”¨çš„è®¿é—®ï¼Œæ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š\nåƒä¼ ç»Ÿç”¨æ³•ä¸€æ ·ï¼Œé…ç½®åº”ç”¨çš„ Service ä½œä¸ºåç«¯ï¼Œç”±å…¥å£æ§åˆ¶å™¨ç›´æ¥å°†æµé‡è½¬å‘åˆ°åº”ç”¨å®¹å™¨ï¼Œç®€å•è¯´å°±æ˜¯æ”¯æŒè‡ªåŠ¨é…ç½®çš„ L7 è´Ÿè½½å‡è¡¡å™¨ã€‚ ä¸ç›´æ¥è®¿é—®åº”ç”¨å®¹å™¨ï¼Œè€Œæ˜¯é€šè¿‡ Daprd è¿è¡Œæ—¶æ¥è®¿é—®ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦å°†å…¥å£æ§åˆ¶å™¨ä¹Ÿå£°æ˜ä¸º Dapr åº”ç”¨ï¼Œä¸ºå…¶æ³¨å…¥ Daprd è¿è¡Œæ—¶å®¹å™¨ã€‚æ­¤æ—¶åˆ›å»ºå…¥å£è§„åˆ™æŒ‡å‘çš„åç«¯ï¼Œåˆ™æ˜¯ Ingress çš„ Dapr Serviceã€‚ ä¸¤ç§æ–¹æ¡ˆå„æœ‰ä¼˜åŠ£ï¼Œå‰è€…æ¶æ„ç®€å•ï¼›åè€…è™½ç„¶å¼•å…¥ Daprd å®¹å™¨ï¼Œæ¶æ„å¤æ‚ï¼Œæ¶ˆè€—äº†æ›´å¤šçš„èµ„æºï¼Œä½†ä¹Ÿå› æ­¤å¯ä»¥ä½¿ç”¨ Dapr çš„æœåŠ¡æ²»ç†èƒ½åŠ›ï¼Œå¦‚è¶…æ—¶ã€é‡è¯•ã€è®¿é—®æ§åˆ¶ç­‰ç­‰ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬å°†é€šè¿‡ç¤ºä¾‹æ¥åˆ†åˆ«éªŒè¯ä¸¤ç§æ–¹æ¡ˆã€‚\næ¼”ç¤º å‰ç½®æ¡ä»¶ helm dapr cli å®‰è£…é›†ç¾¤ export INSTALL_K3S_VERSION=v1.23.8+k3s2 curl -sfL https://get.k3s.io | sh -s - --disable traefik --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config å®‰è£… Dapr dapr init --kubernetes --wait å®‰è£…å…¥å£æ§åˆ¶å™¨ è¿™é‡Œä½¿ç”¨ Flomesh çš„å…¥å£æ§åˆ¶å™¨ã€‚é€šè¿‡ valus.yaml ä¸ºå…¥å£æ§åˆ¶å™¨æ·»åŠ  dapr ç›¸å…³çš„æ³¨è§£ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ç”±äºé»˜è®¤æƒ…å†µä¸‹ Daprd è¿è¡Œæ—¶ç›‘å¬çš„ç«¯å£æ˜¯ç»‘å®šåœ¨å›ç¯åœ°å€ä¸Šçš„ï¼Œè€Œ Ingress å‘åç«¯è½¬å‘è¯·æ±‚æ—¶ä½¿ç”¨çš„æ˜¯ Pod IPï¼Œå› æ­¤éœ€è¦æ³¨è§£ dapr.io/sidecar-listen-addresses: \u0026quot;[::],0.0.0.0\u0026quot; è®© Daprd è¿è¡Œæ—¶å¯ä»¥æ¥æ”¶æ¥è‡ª Pod IP çš„è¯·æ±‚ã€‚\n# values.yaml fsm: ingress: podAnnotations: dapr.io/sidecar-listen-addresses: \u0026#34;[::],0.0.0.0\u0026#34; dapr.io/enabled: \u0026#34;true\u0026#34; dapr.io/app-id: \u0026#34;ingress\u0026#34; dapr.io/app-port: \u0026#34;8000\u0026#34; dapr.io/enable-api-logging: \u0026#34;true\u0026#34; dapr.io/config: \u0026#34;ingressconfig\u0026#34; helm repo add fsm https://charts.flomesh.io helm repo update helm install \\ --namespace flomesh \\ --create-namespace \\ --version=0.2.1-alpha.3 \\ -f values.yaml \\ fsm fsm/fsm éƒ¨ç½²ç¤ºä¾‹åº”ç”¨ ç¤ºä¾‹åº”ç”¨æˆ‘ä»¬ä½¿ç”¨ kennethreitz/httpbinï¼Œä¸ºå…¶æ·»åŠ  dapr ç›¸å…³çš„æ³¨è§£ã€‚\nkubectl create ns httpbin kubectl apply -n httpbin -f - \u0026lt;\u0026lt;EOF apiVersion: apps/v1 kind: Deployment metadata: labels: app: httpbin name: httpbin spec: replicas: 1 selector: matchLabels: app: httpbin strategy: {} template: metadata: annotations: dapr.io/enabled: \u0026#34;true\u0026#34; dapr.io/app-id: \u0026#34;httpbin\u0026#34; dapr.io/app-port: \u0026#34;80\u0026#34; dapr.io/enable-api-logging: \u0026#34;true\u0026#34; dapr.io/config: \u0026#34;httpbinconfig\u0026#34; labels: app: httpbin spec: containers: - image: kennethreitz/httpbin name: httpbin resources: {} --- apiVersion: v1 kind: Service metadata: labels: app: httpbin name: httpbin namespace: httpbin spec: ports: - port: 80 protocol: TCP targetPort: 80 selector: app: httpbin EOF æ–¹æ¡ˆ 1 å‚è€ƒ Flomesh Ingress çš„ æ–‡æ¡£ï¼Œåˆ›å»ºå…¥å£è§„åˆ™ä½¿ç”¨ Service httpbin ä½œä¸ºåç«¯ã€‚\nkubectl apply -n httpbin -f - \u0026lt;\u0026lt;EOF apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: httpbin annotations: pipy.ingress.kubernetes.io/rewrite-target-from: ^/httpbin/? pipy.ingress.kubernetes.io/rewrite-target-to: / spec: ingressClassName: pipy rules: - http: paths: - backend: service: name: httpbin port: number: 80 path: /httpbin pathType: Prefix EOF ä½¿ç”¨ä¸»æœº IP åœ°å€å’Œå…¥å£æ§åˆ¶å™¨çš„ 80 ç«¯å£æ¥è®¿é—® /httpbin/getï¼Œç”±äºä¸Šé¢é…ç½®äº†è·¯å¾„é‡å†™ï¼Œæœ€ç»ˆè¯·æ±‚ /get å°†ä¼šè¢«å‘é€åˆ°ç›®æ ‡ Podã€‚\ncurl HOST_IP:80/httpbin/get { \u0026#34;args\u0026#34;: {}, \u0026#34;headers\u0026#34;: { \u0026#34;Accept\u0026#34;: \u0026#34;*/*\u0026#34;, \u0026#34;Connection\u0026#34;: \u0026#34;keep-alive\u0026#34;, \u0026#34;Content-Length\u0026#34;: \u0026#34;0\u0026#34;, \u0026#34;Host\u0026#34;: \u0026#34;10.0.0.13:80\u0026#34;, \u0026#34;User-Agent\u0026#34;: \u0026#34;curl/7.86.0\u0026#34; }, \u0026#34;origin\u0026#34;: \u0026#34;10.42.0.18\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;http://10.0.0.13:80/get\u0026#34; } æ–¹æ¡ˆ 2 æ–¹æ¡ˆ 2 ä¹ŸåŒæ ·éœ€è¦é…ç½®å…¥å£è§„åˆ™ï¼Œåªæ˜¯è¿™æ¬¡åç«¯æœåŠ¡é…ç½®çš„å…¥å£æ§åˆ¶å™¨çš„ Dapr Serviceï¼Œé€šè¿‡ kubectl get svc -n flomesh å°±å¯ä»¥æ‰¾åˆ°åå­—å¸¦æœ‰ -dapr åç¼€çš„ Serviceã€‚\nkubectl apply -n flomesh -f - \u0026lt;\u0026lt;EOF apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: dapr annotations: pipy.ingress.kubernetes.io/rewrite-target-from: ^/dapr/? pipy.ingress.kubernetes.io/rewrite-target-to: / spec: ingressClassName: pipy rules: - http: paths: - backend: service: name: ingress-dapr port: number: 80 path: /dapr pathType: Prefix EOF ä»ç„¶æ˜¯è®¿é—® httpbin çš„è·¯å¾„ /getï¼Œä½†æ˜¯è®¿é—®æ–¹å¼è¦éµå¾ª Dapr æœåŠ¡è°ƒç”¨çš„ APIï¼šé€šè¿‡è¯·æ±‚å¤´æŒ‡å®š dapr-app-id ä¸º httpbin.httpbinã€‚ç”±äºå…¥å£æ§åˆ¶å™¨å’Œç›®æ ‡åº”ç”¨ä¸åœ¨åŒä¸€å‘½åç©ºé—´ä¸‹ï¼Œåœ¨åº”ç”¨ id éœ€è¦å¸¦ä¸Šå…¶å‘½åç©ºé—´ã€‚\nåŒæ ·æ˜¯æˆåŠŸè¿”å›ï¼Œä½†æ˜¯å¯ä»¥çœ‹åˆ°æœ€ç»ˆåº”ç”¨æ”¶åˆ°è¯·æ±‚å¤´éƒ¨ä¼šå¤šäº†ä¸€äº›ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯éƒ½æ˜¯æ¥è‡ª Daprd è¿è¡Œæ—¶ï¼Œæ¯”å¦‚ Dapr-Caller-App-Idã€\u0026quot;Dapr-Callee-App-Id æ ‡è¯†è¡¨ç¤ºè¯·æ±‚çš„å‘èµ·æ–¹å’Œæ¥æ”¶æ–¹ï¼›Forwarded æ ‡è¯†äº†å‘èµ·è¯·æ±‚çš„ä¸»æœºåã€‚å¦‚æœå¼€å¯äº† tracingï¼Œè¿˜ä¼šæœ‰é“¾è·¯ç›¸å…³çš„ä¿¡æ¯ï¼ˆæœ¬ç¤ºä¾‹ä¸­å¹¶æœªå¼€å¯ï¼‰ã€‚\ncurl HOST_IP:80/dapr/get -H \u0026#39;dapr-app-id:httpbin.httpbin\u0026#39; { \u0026#34;args\u0026#34;: {}, \u0026#34;headers\u0026#34;: { \u0026#34;Accept\u0026#34;: \u0026#34;*/*\u0026#34;, \u0026#34;Accept-Encoding\u0026#34;: \u0026#34;gzip\u0026#34;, \u0026#34;Connection\u0026#34;: \u0026#34;keep-alive\u0026#34;, \u0026#34;Dapr-App-Id\u0026#34;: \u0026#34;httpbin.httpbin\u0026#34;, \u0026#34;Dapr-Callee-App-Id\u0026#34;: \u0026#34;httpbin\u0026#34;, \u0026#34;Dapr-Caller-App-Id\u0026#34;: \u0026#34;ingress\u0026#34;, \u0026#34;Forwarded\u0026#34;: \u0026#34;for=10.42.0.18;by=10.42.0.18;host=fsm-ingress-pipy-864d8d9c76-4kb7r\u0026#34;, \u0026#34;Host\u0026#34;: \u0026#34;127.0.0.1:80\u0026#34;, \u0026#34;Proto\u0026#34;: \u0026#34;HTTP/1.1\u0026#34;, \u0026#34;Protomajor\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;Protominor\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;Referer\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;Traceparent\u0026#34;: \u0026#34;00-00000000000000000000000000000000-0000000000000000-00\u0026#34;, \u0026#34;User-Agent\u0026#34;: \u0026#34;curl/7.86.0\u0026#34;, \u0026#34;X-Forwarded-Host\u0026#34;: \u0026#34;fsm-ingress-pipy-864d8d9c76-4kb7r\u0026#34; }, \u0026#34;origin\u0026#34;: \u0026#34;10.42.0.18\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;http://fsm-ingress-pipy-864d8d9c76-4kb7r/get\u0026#34; } è®¿é—®æ§åˆ¶ æ–‡ç« å¼€å¤´æåˆ°ä½¿ç”¨ æ–¹æ¡ˆ 2 è™½ç„¶å¸¦æ¥äº†å»¶è¿Ÿå¢åŠ äº†å¤æ‚åº¦ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨ Dapr çš„æœåŠ¡æ²»ç†èƒ½åŠ›ã€‚è¿™é‡Œä»¥ Dapr çš„è®¿é—®æ§åˆ¶åŠŸèƒ½ ä¸ºä¾‹ã€‚\nä¸çŸ¥é“å¤§å®¶æ³¨æ„åˆ°æ²¡ï¼Œåœ¨éƒ¨ç½²å…¥å£æ§åˆ¶å™¨å’Œç¤ºä¾‹åº”ç”¨æ—¶ï¼Œæœ‰ä¸ªæ³¨è§£ dapr.io/config: xxxã€‚è¿™ä¸ªæ³¨è§£æ˜¯ä¸ºåº”ç”¨çš„ Daprd è¿è¡Œæ—¶æŒ‡å®šé…ç½®ï¼Œè¿è¡Œæ—¶å¯åŠ¨æ—¶ä¼šä»åä¸º xxx çš„ Configuration èµ„æºè¯»å–é…ç½®ã€‚\næ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ä¸º httpbin åº”ç”¨è®¾ç½®è®¿é—®æ§åˆ¶è§„åˆ™ï¼šé»˜è®¤æ‹’ç»æ‰€æœ‰è¯·æ±‚ï¼Œåªå…è®¸ flomesh å‘½åç©ºé—´ä¸‹çš„ id ä¸º ingress çš„åº”ç”¨é€šè¿‡ GET æ–¹å¼è®¿é—®è·¯å¾„ /getã€‚æ›´å¤šè®¿é—®æ§åˆ¶é…ç½®ï¼Œå¯ä»¥å‚è€ƒ Dapr è®¿é—®æ§åˆ¶å®˜æ–¹æ–‡æ¡£ã€‚\nkubectl apply -n httpbin -f - \u0026lt;\u0026lt;EOF apiVersion: dapr.io/v1alpha1 kind: Configuration metadata: name: httpbinconfig spec: accessControl: defaultAction: deny trustDomain: \u0026#34;public\u0026#34; policies: - appId: ingress defaultAction: deny trustDomain: \u0026#39;public\u0026#39; namespace: \u0026#34;flomesh\u0026#34; operations: - name: /get httpVerb: [\u0026#39;GET\u0026#39;] action: allow EOF åº”ç”¨é…ç½®ä¹‹åï¼Œéœ€è¦é‡å¯åº”ç”¨ã€‚\nkubectl rollout restart deploy httpbin -n httpbin ç­‰åˆ°é‡å¯å®Œæˆï¼Œå†è®¿é—® /get è·¯å¾„ï¼Œæ­£å¸¸å“åº”ã€‚\ncurl HOST_IP:80/dapr/get -H \u0026#39;dapr-app-id:httpbin.httpbin\u0026#39; { \u0026#34;args\u0026#34;: {}, \u0026#34;headers\u0026#34;: { \u0026#34;Accept\u0026#34;: \u0026#34;*/*\u0026#34;, \u0026#34;Accept-Encoding\u0026#34;: \u0026#34;gzip\u0026#34;, \u0026#34;Connection\u0026#34;: \u0026#34;keep-alive\u0026#34;, \u0026#34;Dapr-App-Id\u0026#34;: \u0026#34;httpbin.httpbin\u0026#34;, \u0026#34;Dapr-Callee-App-Id\u0026#34;: \u0026#34;httpbin\u0026#34;, \u0026#34;Dapr-Caller-App-Id\u0026#34;: \u0026#34;ingress\u0026#34;, \u0026#34;Forwarded\u0026#34;: \u0026#34;for=10.42.0.40;by=10.42.0.40;host=fsm-ingress-pipy-864d8d9c76-jctcx\u0026#34;, \u0026#34;Host\u0026#34;: \u0026#34;127.0.0.1:80\u0026#34;, \u0026#34;Proto\u0026#34;: \u0026#34;HTTP/1.1\u0026#34;, \u0026#34;Protomajor\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;Protominor\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;Referer\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;Traceparent\u0026#34;: \u0026#34;00-00000000000000000000000000000000-0000000000000000-00\u0026#34;, \u0026#34;User-Agent\u0026#34;: \u0026#34;curl/7.86.0\u0026#34;, \u0026#34;X-Forwarded-Host\u0026#34;: \u0026#34;fsm-ingress-pipy-864d8d9c76-jctcx\u0026#34; }, \u0026#34;origin\u0026#34;: \u0026#34;10.42.0.40\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;http://fsm-ingress-pipy-864d8d9c76-jctcx/get\u0026#34; } ä½†æ˜¯ï¼Œå¦‚æœæ˜¯è®¿é—®è·¯å¾„ /headersï¼Œä¼šæ”¶åˆ°ä¸‹é¢çš„å“åº”ï¼šè¢«ç¦æ­¢è®¿é—® /headersã€‚\ncurl HOST_IP:80/dapr/headers -H \u0026#39;dapr-app-id:httpbin.httpbin\u0026#39; { \u0026#34;errorCode\u0026#34;: \u0026#34;ERR_DIRECT_INVOKE\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;fail to invoke, id: httpbin.httpbin, err: rpc error: code = PermissionDenied desc = access control policy has denied access to appid: ingress operation: headers verb: GET\u0026#34; } æ€»ç»“ æ–‡ä¸­ä½¿ç”¨çš„ä¸¤ç§å…¥å£æ–¹æ¡ˆå„æœ‰ä¼˜ç¼ºç‚¹ï¼Œæ–¹æ¡ˆ 1 æ¶æ„ç®€å•ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¸¸ç”¨çš„æ–¹æ¡ˆï¼›æ–¹æ¡ˆ 2 ä¸­ç›¸å½“äºå°†å…¥å£æ§åˆ¶å™¨å£°æ˜ä¸º Dapr åº”ç”¨ï¼Œå®é™…ä¸Šæš´éœ²çš„æ˜¯ Dapr çš„ APIï¼Œåœ¨å®ç°ä¸Šæ›´åƒæ˜¯ä¸€ä¸ªå…¨å±€çš„åº”ç”¨è¿è¡Œæ—¶ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-gutsbyjan-n-15272406-2.jpg","permalink":"https://atbug.com/access-dapr-application-with-ingress-controller/","tags":["Dapr","Kubernetes","Ingress"],"title":"ä½¿ç”¨ Ingress è®¿é—® Dapr åº”ç”¨"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬æ–‡ç¿»è¯‘è‡ª Bilgin Lbryam çš„ Unbundling: The Natural Evolution of Tech Stacksï¼Œç¿»è¯‘éš¾å…æœ‰æ‰€ç–æ¼ï¼Œæœ‰å»ºè®®è¯·åé¦ˆã€‚\nâ€œunbundlingâ€ å¦‚ä½•ç¿»è¯‘ï¼Œæœ‰ç‚¹çº ç»“ï¼Œæˆ‘ä¸€åº¦å°†å…¶ç¿»è¯‘æˆâ€œè§£è€¦â€ï¼Œä½†è§£è€¦æ˜¯ â€œdecouplingâ€ çš„ç¿»è¯‘ã€‚è¿™é‡Œæˆ‘å°†å…¶ç¿»è¯‘æˆåˆ†æ‹†ï¼Œå¦‚æœä½ æœ‰æ›´å¥½çš„ç¿»è¯‘è¯·å‘ŠçŸ¥ã€‚\nè¯‘è€…æ³¨ ä½œè€…åº”è¯¥æ˜¯å»å¹´ 7 æœˆç¦»å¼€çº¢å¸½åŠ å…¥äº†åŸºäº Dapr çš„åˆ›ä¸šå…¬å¸ Diagridï¼Œæ›¾å†™è¿‡ Multi-Runtime Microservices Architecture ä»‹ç»å¤šè¿è¡Œæ—¶ï¼Œå¤šè¿è¡Œæ—¶å®é™…ä¸Šä¹Ÿæ˜¯åˆ†æ‹†çš„ä½“ç°ã€‚\nä½œè€…ä»å¤šç§æŠ€æœ¯å’Œå›¢é˜Ÿè§¦å‘ï¼Œä»‹ç»åœ¨æ¼”è¿›ä¸­åˆ†æ‹†çš„ä½“ç°ã€‚é™¤äº†æ–‡ä¸­æåˆ°ï¼Œæˆ‘è®¤ä¸ºå¯ä»¥åˆ†æ‹†çš„æ˜¯è®¡ç®—èµ„æºã€‚å°†è®¡ç®—èµ„æºæ‹†åˆ†ï¼šè™šæ‹Ÿæœºã€å¤šç§Ÿæˆ·ã€å¤šé›†ç¾¤ã€å¤šäº‘ã€æ··åˆäº‘ï¼Œä»¥é™ä½æˆæœ¬ã€é¿å…ä¾›åº”å•†ç»‘å®šã€æå‡æ€§èƒ½å’Œå¯é æ€§ã€‚åœ¨è®¡ç®—èµ„æºæ‹†åˆ†è¿‡ç¨‹ä¸­ï¼Œä¹Ÿè¡ç”Ÿå‡ºäº†ä¸ä¹‹é…å¥—çš„æŠ€æœ¯æ¥è§£å†³æ‹†åˆ†åå¸¦æ¥çš„ä¸ä¾¿ã€‚\néšç€ IT é¢†åŸŸçš„ä¸æ–­å‘å±•ï¼Œæ–°çš„è½¯ä»¶æ¶æ„ã€å¼€å‘æŠ€æœ¯å’Œå·¥å…·å±‚å‡ºä¸ç©·ã€‚åŒ…æ‹¬å¾®æœåŠ¡ã€å¾®å‰ç«¯ã€é›¶ä¿¡ä»»ã€æœåŠ¡ç½‘æ ¼å’Œæ•°æ®ç½‘æ ¼ï¼Œå¹¶å°†å…¶ç½‘æ ¼åŒ–ã€‚å°½ç®¡è¿™äº›æŠ€æœ¯å’Œæ–¹æ³•é—´å­˜åœ¨ç€æ˜æ˜¾çš„ä¸åŒï¼Œä½†å®ƒä»¬éƒ½è¢«ä¸€ä¸ªå…±åŒè¶‹åŠ¿è”ç³»åœ¨ä¸€èµ·ï¼šæŠ€æœ¯æ ˆå’Œå›¢é˜Ÿçš„åˆ†æ‹†ã€‚è¿™ç§è¶‹åŠ¿åŒ…æ‹¬å°†ç³»ç»Ÿåˆ†è§£æˆæ›´å°çš„ã€ç‹¬ç«‹çš„ç»„ä»¶ï¼Œå¹¶å°†å·¥ä½œç»„ç»‡æˆæ›´å°ã€æ›´ä¸“æ³¨çš„å›¢é˜Ÿï¼Œä»¥å®ç°æ›´é«˜çš„çµæ´»æ€§å’Œæ¨¡å—åŒ–ã€‚\nä»–ä»¬éƒ½æ˜¯å¦‚ä½•ä½“ç°åˆ†æ‹†çš„ï¼Ÿ\nå¾®æœåŠ¡ çš„å‡ºç°æ˜¯ä¸ºäº†åº”å¯¹å•ä½“æ¶æ„çš„å±€é™æ€§ï¼Œéšç€åº”ç”¨ç¨‹åºçš„å¢é•¿å•ä½“æ¶æ„çµæ´»æ€§ä¸è¶³ï¼Œå¹¶ä¸”æ‰©å±•å’Œç»´æŠ¤å›°éš¾ã€‚é€šè¿‡å°†å•ä½“åº”ç”¨ç¨‹åºåˆ†è§£ä¸ºæ›´å°çš„ã€ç‹¬ç«‹æœåŠ¡ï¼Œå°±å¯ä»¥ç‹¬ç«‹å¼€å‘ã€éƒ¨ç½²å’Œæ‰©å±•åº”ç”¨ç¨‹åºçš„æ¯ä¸€éƒ¨åˆ†ï¼Œä»è€Œç¼©çŸ­å¼€å‘å‘¨æœŸå¹¶æé«˜çµæ´»æ€§ã€‚ å…­è¾¹å½¢æ¶æ„ çš„å‡ºç°æ˜¯ä¸ºäº†é€šè¿‡å°†ç»„ä»¶è§£è€¦å¹¶æä¾›ä¸å®ƒä»¬äº¤äº’çš„æ ‡å‡†æ¥å£æ¥æé«˜ 3 å±‚åº”ç”¨ç¨‹åºçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ é¢†åŸŸé©±åŠ¨è®¾è®¡ (DDD) æ˜¯ä¸€ç§è½¯ä»¶å¼€å‘æ–¹æ³•ï¼Œå¯ä»¥å¸®åŠ©å°†æ•´ä½“åº”ç”¨ç¨‹åºåˆ†è§£æˆæ›´å°çš„ã€æ¾è€¦åˆçš„ã€ä»£è¡¨ä¸åŒçš„ä¸šåŠ¡é¢†åŸŸæˆ–ä¸Šä¸‹æ–‡çš„æ¨¡å—ã€‚ å¾®å‰ç«¯ æ¶æ„æ˜¯ä¸€ç§è®¾è®¡æ–¹æ³•ï¼Œæ˜¯å°†å¤§å‹å•ä½“å‰ç«¯åº”ç”¨ç¨‹åºåˆ†è§£ä¸ºè¾ƒå°çš„ã€ç‹¬ç«‹çš„ã€å¯ä»¥å•ç‹¬å¼€å‘å’Œéƒ¨ç½²çš„æ¨¡å—ã€‚ JAMstack é€šè¿‡å°†æ„æˆç”¨æˆ·ç•Œé¢çš„ HTMLã€CSS å’Œ JavaScript ä¸ä¸ºåº”ç”¨ç¨‹åºæä¾›æ”¯æŒçš„æœåŠ¡å™¨ç«¯ä»£ç å’Œæ•°æ®åº“åˆ†ç¦»ï¼Œå®ç°åº”ç”¨ç¨‹åºçš„å‰ç«¯å’Œåç«¯åˆ†ç¦»ã€‚ç”±äºç³»ç»Ÿçš„ä¸€éƒ¨åˆ†çš„å˜æ›´æ— éœ€å˜æ›´å…¶ä»–éƒ¨åˆ†ï¼Œä»è€Œå¯ä»¥æ›´è½»æ¾åœ°ç»´æŠ¤åº”ç”¨ã€‚ æœåŠ¡ç½‘æ ¼ å°†åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„ç½‘ç»œèŒè´£ï¼ˆä¾‹å¦‚è·¯ç”±ã€è´Ÿè½½å¹³è¡¡å’ŒæœåŠ¡å‘ç°ï¼‰ä¸åº”ç”¨ç¨‹åºæœ¬èº«åˆ†ç¦»ï¼Œä½¿å¼€å‘äººå‘˜å¯ä»¥ä¸“æ³¨äºæ„å»ºä¸šåŠ¡é€»è¾‘å’ŒåŠŸèƒ½ï¼Œè€Œæ— éœ€æ‹…å¿ƒåº•å±‚ç½‘ç»œåŸºç¡€è®¾æ–½ã€‚ ä¸å¾®æœåŠ¡ç±»ä¼¼ï¼Œæ•°æ®ç½‘æ ¼ å°†å¤§å‹å¤æ‚ç³»ç»Ÿåˆ†è§£ä¸ºæ›´å°çš„ç‹¬ç«‹ç»„ä»¶ã€‚å®ƒå°†æ•°æ®æ²»ç†å’Œç®¡ç†å®è·µåˆ†è§£ä¸ºæ›´å°çš„ã€ç‹¬ç«‹ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶å¯ä»¥è·¨ä¸åŒçš„æ•°æ®æºå’Œç³»ç»Ÿä¸€è‡´åœ°å®ç°å’Œæ‰§è¡Œã€‚ 2 ä¸ªæ¯”è¨å›¢é˜Ÿ æ¨¡å‹æ˜¯ä¸€ç§åœ¨ç»„ç»‡ä¸­ç»„ç»‡å›¢é˜Ÿå’Œå·¥ä½œçš„ç­–ç•¥ï¼Œå®ƒæå€¡æ›´å°çš„å›¢é˜Ÿèƒ½å¤Ÿæ›´å¿«åœ°å“åº”å˜åŒ–ã€æ²Ÿé€šå’Œåä½œï¼Œå¹¶å¯ä»¥æ›´å¿«åœ°åšå‡ºå†³ç­–å¹¶æ›´æœ‰æ•ˆåœ°è§£å†³é—®é¢˜ã€‚ æ¯ç§æŠ€æœ¯è¶‹åŠ¿çš„æœ€ç»ˆç»“æœéƒ½æ˜¯åˆ†æ‹†ã€‚å°†æŠ€æœ¯æ ˆåˆ†è§£ä¸ºç‹¬ç«‹çš„ç»„ä»¶ï¼Œå°†å›¢é˜Ÿåˆ†è§£ä¸ºæ›´å°ã€æ›´ä¸“æ³¨çš„å›¢é˜Ÿï¼Œè¿™äº›å›¢é˜Ÿå¯èƒ½ä¼šæ‰©å±•åˆ°æ‰€æœ‰å…¶ä»–é¢†åŸŸã€‚åœ¨å‰ç«¯ã€æ•°æ®ã€ç½‘ç»œã€å®‰å…¨ä¹‹åï¼Œä¸‹ä¸€ä¸ªæ‹†åˆ†é¢†åŸŸä½ è®¤ä¸ºä¼šæ˜¯ä»€ä¹ˆï¼Ÿ å’Œæˆ‘ä¸€èµ· è‡´åŠ›äº Dapr å’Œåˆ†æ‹†é›†æˆã€‚ ä¹Ÿå¯ä»¥åœ¨ @bibryam ä¸Šå…³æ³¨æˆ‘ï¼Œå¹¶å¤§å£°è¯´å‡ºå…³äº åˆ†æ‹† ä¸»é¢˜çš„ä»»ä½•æƒ³æ³•å’Œè¯„è®ºã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/evolution.jpeg","permalink":"https://atbug.com/the-unbundling-of-tech-stack-translation/","tags":["Service Mesh","äº‘åŸç”Ÿ","å¾®æœåŠ¡","æ¶æ„"],"title":"ã€è¯‘ã€‘åˆ†æ‹†ï¼šæŠ€æœ¯æ ˆçš„è‡ªç„¶æ¼”è¿›"},{"categories":["ç¬”è®°"],"contents":"Dapr åˆ†å¸ƒå¼åº”ç”¨è¿è¡Œæ—¶ Distributed Application Runtime çš„é¦–å­—æ¯ç¼©å†™ã€‚æœ‰å…³å¤šè¿è¡Œæ—¶ï¼Œå¯ä»¥çœ‹ä¸‹ Bilgin Ibryam çš„ Multi-Runtime Microservices Architectureï¼Œä¸æƒ³çœ‹è‹±æ–‡çš„å¯ä»¥çœ‹ä¸‹æˆ‘ä¹‹å‰çš„ç¿»è¯‘ã€‚\nDapr æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå·¥å…·åŒ…ï¼Œé€šè¿‡æä¾› API å®ç°åº”ç”¨ç¨‹åºä¸å¤–å›´ç»„ä»¶çš„è§£è€¦åˆï¼Œè®©å¼€å‘äººå‘˜æ›´åŠ èšç„¦äºä¸šåŠ¡é€»è¾‘çš„ç ”å‘ã€‚è§£è€¦ä¹Ÿæ˜¯ä¸ä¼ ç»Ÿ SDK çš„å¾ˆå¤§åŒºåˆ«ï¼Œèƒ½åŠ›ä¸å†æ˜¯é€šè¿‡åº”ç”¨ç¨‹åºä¸­åŠ å…¥åº“çš„æ–¹å¼æä¾›ï¼Œè€Œæ˜¯é€šè¿‡åº”ç”¨é™„è¿‘çš„è¾¹è½¦ï¼ˆsidecarï¼‰è¿è¡Œæ—¶æä¾›ï¼ˆsidecar ä¸æ˜¯å¹¿ä¸ºäººçŸ¥çš„æœåŠ¡ç½‘æ ¼ sidecar - pod ä¸­çš„å®¹å™¨ï¼Œè€Œæ˜¯å¹¿æ³›ä½¿ç”¨åœ¨ç³»ç»Ÿè½¯ä»¶è®¾è®¡ä¸­çš„ä¸€ç§æ¨¡å¼ï¼Œæ¯”å¦‚æ“ä½œç³»ç»Ÿçš„ initdã€æ—¥å¿—é‡‡é›†ç»„ä»¶ï¼Œç”šè‡³æ˜¯ Java ä¸­çš„å¤šçº¿ç¨‹ã€‚ï¼‰ã€‚å› æ­¤è¿™é‡Œè¯´çš„ Dapr sidecar å¯èƒ½æ˜¯ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä¹Ÿå¯èƒ½æ˜¯ pod ä¸­çš„ä¸€ä¸ªå®¹å™¨ã€‚\nåœ¨ Dapr ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾ˆå¤šå¸¸è§ SDK çš„èƒ½åŠ›ï¼š\nå¦‚ SpringCloudã€Netflix OSS çš„ æœåŠ¡è°ƒç”¨ï¼Œä»¥åŠè¶…æ—¶ã€ç†”æ–­ã€é‡è¯•ç­‰ å¼¹æ€§ç­–ç•¥ å¦‚ Spring Data KeyValue ä¸€æ ·æä¾› çŠ¶æ€å­˜å‚¨ çš„æŠ½è±¡ï¼Œç®€åŒ–å„ç§æŒä¹…å­˜å‚¨çš„è®¿é—® å¦‚ Kafkaã€NATSã€MQTT ç­‰æ¶ˆæ¯ä»£ç†ï¼Œæä¾› å‘å¸ƒ/è®¢é˜… æŠ½è±¡ä¾›æœåŠ¡é€šè¿‡æ¶ˆæ¯è¿›è¡Œé€šä¿¡ å¦‚ Kafkaã€MQTTã€RabbitMQ æä¾›ä»¥äº‹ä»¶è§¦å‘åº”ç”¨çš„æŠ½è±¡ï¼šç»‘å®š å¦‚ Redis ä¸€æ ·çš„ åˆ†å¸ƒå¼é” å¦‚ Consulã€Kubernetes ç­‰çš„ åç§°è§£æ \u0026hellip; ä»¥ä¸Šèƒ½åŠ›éƒ½æ˜¯é€šè¿‡ HTTP å’Œ gRPC API æš´éœ²ç»™åº”ç”¨ï¼Œè¿™äº› API åœ¨ Dapr ä¸­è¢«å«åš æ„å»ºå—ï¼ˆbuilding blocksï¼‰ï¼Œå¹¶ä¸”ä¹Ÿ ä»…æä¾›æŠ½è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ å¯ä»¥éšæ„æ›¿æ¢åº•å±‚å®ç°ï¼ˆDapr ä¸­ä¹Ÿå«åš ç»„ä»¶ï¼‰è€Œæ— éœ€ä¿®æ”¹ä»»ä½•åº”ç”¨ä»£ç ã€‚\næ¯”å¦‚ä½ çš„åº”ç”¨éœ€è¦åœ¨å­˜å‚¨ä¸­ä¿å­˜çŠ¶æ€ï¼Œåœ¨å¼€å‘æ—¶å¯ä»¥ä½¿ç”¨ å†…å­˜ ä½œä¸ºå­˜å‚¨ç»„ä»¶ï¼Œå…¶ä»–ç¯å¢ƒä¸­å¯ä»¥ä½¿ç”¨ Mysqlã€Redis ç­‰æŒä¹…åŒ–ç»„ä»¶ã€‚\næ¥ä¸‹æ¥ï¼Œå°±å€ŸåŠ©å®˜æ–¹çš„å…¥é—¨æŒ‡å—ä½“éªŒ Dapr çš„ã€‚Dapr æä¾›äº† å¤šç§å…¥é—¨æŒ‡å—ï¼Œè¿™é‡Œæˆ‘é€‰äº†å…¶ä¸­çš„ hello-kubernetesï¼Œä½†å®é™…æ“ä½œå¯èƒ½ä¸å®˜æ–¹æœ‰äº›è®¸å·®å¼‚ï¼Œä¹Ÿæ­£å¼è¿™äº›å·®å¼‚èƒ½è®©ï¼ˆå‘ï¼‰æˆ‘å¯¹ Dapr æœ‰æ›´å¤šçš„äº†è§£ã€‚\nç¯å¢ƒ å®‰è£… Dapr CLI Dapr CLI æ˜¯æ“ä½œ Dapr çš„å·¥å…·ï¼Œå¯¹å¯ä»¥ç”¨æ¥å®‰è£…ã€ç®¡ç† Dapr å®ä¾‹ï¼Œä»¥åŠè¿›è¡Œ debugã€‚å‚è€ƒå®˜æ–¹çš„ å®‰è£…æ–‡æ¡£ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ macOS é€‰æ‹© homebrew æ¥å®‰è£…ã€‚\nbrew install dapr-cli ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ 1.9.1ã€‚\ndapr version CLI version: 1.9.1 Runtime version: n/a åˆ›å»º Kubernetes é›†ç¾¤ ä½¿ç”¨ k3s v1.23.8+k3s2 ä½œä¸ºå®éªŒç¯å¢ƒé›†ç¾¤ã€‚\nexport INSTALL_K3S_VERSION=v1.23.8+k3s2 curl -sfL https://get.k3s.io | sh -s - --disable traefik --disable servicelb --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config å®‰è£… Dapr æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å°† Dapr å®‰è£…åˆ°é›†ç¾¤ä¸­ã€‚\ndapr init --kubernetes --wait æ£€æŸ¥ç»„ä»¶æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚åœ¨ Kubernetes ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬çš„å¾ˆå¤šå‘½ä»¤éƒ½è¦ä½¿ç”¨ --kubernetes æˆ–è€… -k å‚æ•°ã€‚\ndapr status -k NAME NAMESPACE HEALTHY STATUS REPLICAS VERSION AGE CREATED dapr-dashboard dapr-system True Running 1 0.11.0 47s 2023-02-11 08:30.25 dapr-sentry dapr-system True Running 1 1.9.6 47s 2023-02-11 08:30.25 dapr-sidecar-injector dapr-system True Running 1 1.9.6 47s 2023-02-11 08:30.25 dapr-operator dapr-system True Running 1 1.9.6 47s 2023-02-11 08:30.25 dapr-placement-server dapr-system True Running 1 1.9.6 47s 2023-02-11 08:30.25 ç¤ºä¾‹åº”ç”¨ ç¯å¢ƒéƒ¨ç½²å¥½ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¦ç”¨çš„ç¤ºä¾‹åº”ç”¨ã€‚\ngit clone https://github.com/dapr/quickstarts cd quickstarts/tutorials/hello-kubernetes ç¤ºä¾‹ä¸­åŒ…å«äº† 2 ä¸ªåº”ç”¨ pythonapp å’Œ nodeappï¼Œä»¥åŠ Redisã€‚\nnodeapp æä¾› HTTP ç«¯ç‚¹æ¥åˆ›å»ºå’ŒæŸ¥è¯¢è®¢å•ï¼Œè®¢å•ä¿¡æ¯ä¿å­˜åœ¨ Redis ä¸­ pythonapp ä¼šæŒç»­è®¿é—® nodeapp çš„ HTTP ç«¯ç‚¹æ¥åˆ›å»ºè®¢å• ç”¨åˆ°äº† Dapr çš„ä¸¤ä¸ªåŠŸèƒ½ï¼šæœåŠ¡è°ƒç”¨å’ŒçŠ¶æ€å­˜å‚¨ã€‚\nåˆ›å»ºåº”ç”¨å‘½åç©ºé—´ åº”ç”¨å°†éƒ¨ç½²åœ¨ dpar-test å‘½åç©ºé—´ä¸‹ã€‚\nkubectl create namespace dapr-test çŠ¶æ€å­˜å‚¨ çŠ¶æ€å­˜å‚¨ä½¿ç”¨ Redisï¼Œå…ˆéƒ¨ç½² Redis åˆ°å‘½åç©ºé—´ store ä¸‹ã€‚ç®€å•èµ·è§ï¼Œåªä½¿ç”¨å• master èŠ‚ç‚¹ï¼Œå¹¶è®¾ç½®å¯†ç  changemeã€‚\nhelm repo add bitnami https://charts.bitnami.com/bitnami helm repo update helm install redis bitnami/redis --namespace store --create-namespace \\ --set replica.replicaCount=0 \\ --set auth.password=changeme åˆ›å»ºç»„ä»¶ ç”±äº Redis è®¾ç½®äº†å¯†ç ï¼Œéœ€è¦ä¸º Dapr æä¾›è®¿é—® Redis çš„å¯†ç ï¼Œé€šè¿‡ Secret æ¥ä¼ é€’ã€‚Secret ä¿å­˜åœ¨ dapr-test ä¸‹ã€‚\nkubectl create secret generic redis -n dapr-test --from-literal=redis-password=changeme æ ¹æ® Redis store è§„èŒƒ åœ¨ dapr-test ä¸‹åˆ›å»ºç»„ä»¶ statetoreï¼š\nç»„ä»¶ç±»å‹ type ä¸º state.redis ç‰ˆæœ¬ version=v1 è®¿é—®åœ°å€ redisHost=redis-master.store:6379 Redis çš„è®¿é—®å¯†ç ä»ç§˜é’¥ redis çš„é”® redis-password è·å– auth.secretStore æŒ‡å®šç§˜é’¥å­˜å‚¨çš„ç±»å‹æ˜¯ Kubernetes kubectl apply -n dapr-test -f - \u0026lt;\u0026lt;EOF apiVersion: dapr.io/v1alpha1 kind: Component metadata: name: statestore spec: type: state.redis version: v1 metadata: - name: redisHost value: redis-master.store:6379 - name: redisPassword secretKeyRef: name: redis key: redis-password auth: secretStore: kubernetes EOF è®¿é—®çŠ¶æ€å­˜å‚¨ é€šè¿‡ Dapr API è®¿é—®çŠ¶æ€å­˜å‚¨ï¼Œè¯·æ±‚æ ¼å¼ï¼šPOST http://localhost:\u0026lt;daprPort\u0026gt;/v1.0/state/\u0026lt;storename\u0026gt;ã€‚\nä¸‹é¢æˆªå–äº† nodeapp ä¸­çš„éƒ¨åˆ†ä»£ç ï¼ŒstateStoreName å°±æ˜¯ä¸Šé¢åˆ›å»ºçš„ statestoreã€‚åº”ç”¨å’Œç»„ä»¶ä½äºåŒä¸€å‘½åç©ºé—´ä¸‹ï¼Œç›´æ¥åªç”¨ statestoreï¼›å¦åˆ™ï¼Œå°±è¦ä»£ç ç»„ä»¶æ‰€åœ¨çš„å‘½åç©ºé—´ storeName.storeNamespaceï¼ˆç”±äºä»£ç ä¸­ç¡¬ç¼–ç äº†ç»„ä»¶å statestoreï¼Œæ‰€ä»¥åœ¨åŒå‘½åç©ºé—´ä¸‹åˆ›å»ºç»„ä»¶ï¼‰ã€‚\nconst stateStoreName = `statestore`; const stateUrl = `http://localhost:${daprPort}/v1.0/state/${stateStoreName}`; const state = [{ key: \u0026#34;order\u0026#34;, value: data }]; const response = await fetch(stateUrl, { method: \u0026#34;POST\u0026#34;, body: JSON.stringify(state), headers: { \u0026#34;Content-Type\u0026#34;: \u0026#34;application/json\u0026#34; } }); æœåŠ¡è°ƒç”¨ è°ƒç”¨æ–¹ pythonapp çš„ä»£ç ã€‚\né€šè¿‡ sidecar daprd çš„åœ°å€ localhost å’Œç«¯å£ 3500 è®¿é—® HTTP APIã€‚ åœ¨è¯·æ±‚å¤´ä¸­é€šè¿‡ dapr-app-id æŒ‡å®šç›®æ ‡åº”ç”¨ id nodeappã€‚åº”ç”¨ id æ˜¯é€šè¿‡ Kubernetes æ³¨è§£ dapr.io/app-id æ¥è®¾ç½®çš„ï¼Œæ›´å¤šæ³¨è§£å¯å‚è€ƒ æ–‡æ¡£ã€‚ ç›®æ ‡æ–¹æ³•åé€šè¿‡è¯·æ±‚è·¯å¾„æ¥æŒ‡å®šï¼š/neworder dapr_port = os.getenv(\u0026#34;DAPR_HTTP_PORT\u0026#34;, 3500) dapr_url = \u0026#34;http://localhost:{}/neworder\u0026#34;.format(dapr_port) n = 0 while True: n += 1 message = {\u0026#34;data\u0026#34;: {\u0026#34;orderId\u0026#34;: n}} try: response = requests.post(dapr_url, json=message, timeout=5, headers = {\u0026#34;dapr-app-id\u0026#34;: \u0026#34;nodeapp\u0026#34;} ) if not response.ok: print(\u0026#34;HTTP %d =\u0026gt; %s\u0026#34; % (response.status_code, response.content.decode(\u0026#34;utf-8\u0026#34;)), flush=True) except Exception as e: print(e, flush=True) time.sleep(1) éƒ¨ç½²åº”ç”¨ kubectl apply -n dapr-test -f deploy/node.yaml kubectl wait --for=condition=ready pod -n dapr-test -l app=node --timeout=60s kubectl apply -n dapr-test -f deploy/python.yaml kubectl wait --for=condition=ready pod -n dapr-test -l app=python --timeout=60s æ£€æŸ¥ node å®¹å™¨çš„æ—¥å¿—ï¼Œå¯ä»¥æ¥æ”¶åˆ°äº†æ¥è‡ª pythonapp çš„è¯·æ±‚ï¼Œå¹¶æˆåŠŸæŒä¹…åŒ–å­˜å‚¨äº†è®¢å•ã€‚\nkubectl logs -f -n dapr-test -l app=node -c node Successfully persisted state for Order ID: 1 Got a new order! Order ID: 1 Successfully persisted state for Order ID: 2 Got a new order! Order ID: 2 Successfully persisted state for Order ID: 3 Got a new order! Order ID: 3 Successfully persisted state for Order ID: 4 Got a new order! Order ID: 4 Debug åŸæœ¬å®˜æ–¹çš„æŒ‡å—æ˜¯å°† Redis å’Œåº”ç”¨éƒ¨ç½²åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ä¸­ï¼ŒåŠ ä¸Š nodeapp ä¸­ç¡¬ç¼–ç äº†å­˜å‚¨ç»„ä»¶åã€‚è€Œæˆ‘å®éªŒçš„æ—¶å€™è®² Redis éƒ¨ç½²åœ¨äº†å¦ä¸€ä¸ªç©ºé—´ä¸‹ï¼Œæ£€æŸ¥ node å®¹å™¨æ—¥å¿—æ—¶çœ‹åˆ°çš„æ˜¯ï¼š\nGot a new order! Order ID: 1 Failed to persist state. daprd å®¹å™¨ä¸­ï¼Œåªæœ‰ä¸‹é¢çš„æ—¥å¿—ã€‚\ntime=\u0026#34;2023-02-11T02:55:38.166259509Z\u0026#34; level=info msg=\u0026#34;HTTP API Called: POST /v1.0/state/statestore\u0026#34; app_id=nodeapp instance=nodeapp-857cf6f985-jnmzw scope=dapr.runtime.http-info type=log useragent=\u0026#34;node-fetch/1.0 (+https://github.com/bitinn/node-fetch)\u0026#34; ver=1.9.6 é€šè¿‡ä¸º nodeapp çš„ pod æ·»åŠ æ³¨è§£ dapr.io/log-level=\u0026quot;debug\u0026quot; è®© daprd å®¹å™¨è¾“å‡º debug æ—¥å¿—ã€‚\ntime=\u0026#34;2023-02-11T03:05:07.663028821Z\u0026#34; level=debug msg=\u0026#34;{ERR_STATE_STORE_NOT_CONFIGURED state store is not configured}\u0026#34; app_id=nodeapp instance=nodeapp-59b754ff54-c4x4s scope=dapr.runtime.http type=log ver=1.9.6 æ›´å¤š Debug æ–¹å¼ï¼Œå‚è€ƒå®˜æ–¹çš„ Troubleshooting æ–‡æ¡£ã€‚\næ€»ç»“ Dapr æä¾›äº†ä¸ä¼ ç»Ÿ SDK æ–¹å¼å®Œæˆä¸åŒçš„æ–¹æ³•æ¥å®ç°ç³»ç»Ÿé›†æˆï¼Œè®©å¼€å‘è€…å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œæ— éœ€è€ƒè™‘åº•å±‚çš„å®ç°ï¼›å¯¹ç»„ç»‡æ¥è¯´ï¼Œåº”ç”¨å˜å¾—æ›´åŠ ä¾¿æºï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„äº‘ç¯å¢ƒã€‚\nä½†æ˜¯ Dapr æœ¬èº«æ— æ³•è·¨äº‘è·¨é›†ç¾¤ï¼Œç¤¾åŒºæ­£åœ¨è€ƒè™‘ä¸æœåŠ¡ç½‘æ ¼é›†æˆæ¥å®ç°æ··åˆå¤šäº‘ç¯å¢ƒä¸‹çš„æœåŠ¡è°ƒç”¨ï¼Œå¤§å®¶å¯ä»¥æœŸå¾…ä¸€ä¸‹ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-narcisa-aciko-1292464.jpg","permalink":"https://atbug.com/first-sight-of-dapr/","tags":["Dapr","Kubernetes"],"title":"åˆ†å¸ƒå¼åº”ç”¨è¿è¡Œæ—¶ Daprï¼šä¸‡ç‰©çš†å¯ API"},{"categories":["ç¬”è®°"],"contents":"å‡æœŸç»™å°æœ‹å‹è£…ä¸Šäº†å¨å¨è®¸ä¹…çš„ Minecraftï¼ˆæˆ‘çš„ä¸–ç•Œï¼‰ï¼Œä¸ºäº†ä½“éªŒå®‰è£…çš„æ˜¯ å¼€æºå¯åŠ¨å™¨ HMCLã€‚å…¶å®è¿™æ¸¸æˆæˆ‘ä¹Ÿå…³æ³¨æ¯”è¾ƒä¹…äº†ï¼Œä¸è¿‡æ„Ÿè§‰å¤ªè€—æ—¶é—´ã€‚ä½†è¢«å°æœ‹å‹æ‹‰ä¸Šä¸€èµ·ç©ï¼Œä¾¿ç ”ç©¶äº†ä¸‹è‡ªå»ºæœåŠ¡å™¨ã€‚GitHub å‘ç°å·²ç»æœ‰äººåšå¥½äº† Minecraft æœåŠ¡ç«¯å®¹å™¨é•œåƒï¼Œå…ˆæ˜¯åœ¨ HomeLab ä¸Šç”¨ Docker éƒ¨ç½²ï¼Œé€šè¿‡å¤šäººè¿çº¿å°±èƒ½ç©èµ·æ¥äº†ã€‚\nç”±äºä¸ä¼šç©å‡ ä¸‹è¢«å°æœ‹å‹ç»™æ‰“æ­»ï¼Œåæ¥æ‰å‘ç°è¿˜æœ‰â€œå’Œå¹³æ¨¡å¼â€ã€‚æ— èŠè½¬è€Œç ”ç©¶ä¸‹å¦‚ä½•åœ¨å…¬æœ‰äº‘ä¸Šéƒ¨ç½²ï¼š\næˆ‘çš„ HomeLab å¸¸å¹´è¿è¡Œï¼Œç”±äºæ²¡æœ‰é‡è¦çš„æ•°æ®ï¼Œä¸ç®¡æ˜¯å¯¹ç¡¬ä»¶ç¨³å®šæ€§å’Œæ•°æ®å¤‡ä»½éƒ½æ²¡æœ‰æŠ•å…¥ï¼Œæ‹…å¿ƒæ¸¸æˆæ•°æ®ä¸¢å¤±è¢«åŸ‹æ€¨ã€‚æ”¾åœ¨å…¬æœ‰äº‘ä¸Šä½¿ç”¨å…¬æœ‰äº‘çš„å¯¹è±¡å­˜å‚¨ï¼Œé¿å…æ•°æ®ä¸¢å¤± å¶å°”å¤–å‡ºæ—¶ç©çš„è¯ï¼Œè¿˜éœ€è¦ VPN è¿å›å®¶æ‰èƒ½ç© ä»–æœ‰æœ‹å‹ä¸€èµ·ç©æ—¶è¿˜èƒ½æ–¹ä¾¿è”æœº æœ€ä¸»è¦çš„åŸå› è¿˜æ˜¯å»å¹´åŠ å…¥å¾®è½¯ MVP æ—¶ï¼Œæœ‰é€ Azure çš„ creditï¼Œä¸ç”¨å®å±æµªè´¹ åŸºäºä¸Šé¢çš„åŸå› ï¼Œå†³å®šå°†æœåŠ¡å™¨éƒ¨ç½²åœ¨ Azure ä¸Šï¼Œå¼€ä¸€ä¸ª 8c16g çš„è™šæ‹Ÿæœºå¹¶å®‰è£… k3sã€‚æ•°æ®å‘¢ï¼Œé€šè¿‡ blog-csi-driver æŒä¹…åŒ–å­˜å‚¨åœ¨ Azure çš„ Blob Storage ä¸Šã€‚\nå¼€å§‹å§ï¼\nå®‰è£… k3s è¿è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œå®‰è£…ï¼Œ1.23 ç‰ˆæœ¬å³å¯ã€‚\nexport INSTALL_K3S_VERSION=v1.23.8+k3s2 curl -sfL https://get.k3s.io | sh -s - --disable traefik --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config k3s å®‰è£…ä¹‹åï¼Œéœ€è¦å®‰è£… blob storage çš„ CSI é©±åŠ¨ã€‚æ ¹æ® æ–‡æ¡£è¯´æ˜ é©±åŠ¨è¦ä½¿ç”¨ v0.9.0 ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œæ‰èƒ½ä½¿ç”¨ å­˜å‚¨è´¦æˆ· åšåŠ¨æ€é…ç½®ã€‚\nå®‰è£… CSI é©±åŠ¨ curl -skSL https://raw.githubusercontent.com/kubernetes-sigs/blob-csi-driver/v1.19.0/deploy/install-driver.sh | bash -s v1.19.0 blobfuse-proxy -- åˆ›å»º StorageClass å…ˆç™»å½•åˆ° Azure Portal åœ¨ å­˜å‚¨è´¦æˆ· ä¸­åˆ›å»ºè´¦æˆ·ï¼Œè®°å¾—åŒºåŸŸçš„é€‰æ‹©å’Œè™šæ‹Ÿæœºç›¸åŒï¼›ç½‘ç»œæƒé™ä¸­é€‰æ‹©åªå…è®¸è™šæ‹Ÿç½‘ç»œçš„è®¿é—®ã€‚åˆ›å»ºå®Œæˆåï¼Œåœ¨è´¦æˆ·çš„ è®¿é—®ç§˜é’¥ ä¸­å¯ä»¥è·å–åˆ° keyã€‚\næ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä½¿ç”¨å‰é¢çš„è´¦æˆ·åå’Œ key åˆ›å»º secertã€‚\nkubectl create secret generic azure-secret --from-literal azurestorageaccountname=[ACCOUNT HERE] --from-literal azurestorageaccountkey=[KEY HERE] --type=Opaque æ¥ä¸‹æ¥å°±æ˜¯ä½¿ç”¨è¯¥ secret åˆ›å»º StorageClassã€‚\nkubectl apply -f - \u0026lt;\u0026lt;EOF --- apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: blob-fuse provisioner: blob.csi.azure.com allowVolumeExpansion: true parameters: csi.storage.k8s.io/provisioner-secret-name: azure-secret csi.storage.k8s.io/provisioner-secret-namespace: default csi.storage.k8s.io/node-stage-secret-name: azure-secret csi.storage.k8s.io/node-stage-secret-namespace: default EOF åˆ›å»º PVC æœ‰äº† StorageClass ä¹‹åï¼Œå°±å¯ä»¥åˆ›å»º PersistentVolumeClaim äº†ï¼ŒæŒ‡å®šä½¿ç”¨ä¸Šé¢çš„ StorageClass blob-fuseã€‚\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: v1 kind: PersistentVolumeClaim metadata: name: minecraft-pvc spec: storageClassName: blob-fuse accessModes: - ReadWriteMany resources: requests: storage: 100Gi EOF éƒ¨ç½² Minecraft æœåŠ¡å™¨ ä½¿ç”¨ Deployment è¿›è¡Œéƒ¨ç½²ï¼Œå¹¶åˆ›å»º NodePort Serviceã€‚é•œåƒä½¿ç”¨ itzg/minecraft-server:java17ï¼Œç›¸å…³çš„é…ç½®å¯ä»¥å‚è€ƒ å®˜æ–¹çš„æ–‡æ¡£ï¼ˆæˆ‘æ€•å†è¢«æ‰“ï¼Œå¯ç”¨äº†å’Œå¹³æ¨¡å¼ï¼‰ã€‚\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: apps/v1 kind: Deployment metadata: creationTimestamp: null labels: app: minecraft name: minecraft spec: replicas: 1 selector: matchLabels: app: minecraft strategy: {} template: metadata: creationTimestamp: null labels: app: minecraft spec: containers: - image: itzg/minecraft-server:java17 name: minecraft-server env: - name: EULA value: \u0026#34;TRUE\u0026#34; - name: ONLINE_MODE value: \u0026#34;FALSE\u0026#34; - name: DIFFICULTY value: peaceful - name: MODE value: survival - name: PVP value: \u0026#34;false\u0026#34; - name: UID value: \u0026#34;0\u0026#34; - name: GID value: \u0026#34;0\u0026#34; - name: FORCE_GAMEMODE value: \u0026#34;false\u0026#34; - name: MEMORY value: 4G resources: {} ports: - containerPort: 25565 protocol: TCP volumeMounts: - name: persistent-storage mountPath: /data volumes: - name: persistent-storage persistentVolumeClaim: claimName: minecraft-pvc --- apiVersion: v1 kind: Service metadata: labels: app: minecraft name: minecraft spec: ports: - port: 25565 protocol: TCP targetPort: 25565 selector: app: minecraft type: NodePort EOF æµ‹è¯• å¯åŠ¨å®¢æˆ·ç«¯ï¼Œåœ¨å¤šäººæ¸¸æˆä¸­æ·»åŠ æœåŠ¡å™¨ï¼šåœ°å€æ˜¯è™šæ‹Ÿæœºçš„å…¬å…± IPï¼Œç«¯å£æ˜¯ Service çš„ NodePortã€‚\næ¥ä¸‹æ¥å°±å¯ä»¥æ„‰å¿«çš„ç©è€äº†ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/01/26/minecraft.png","permalink":"https://atbug.com/run-minecraft-on-kubernetes/","tags":["Kubernetes"],"title":"åœ¨ Kubernetes ä¸Šè¿è¡Œæˆ‘çš„ä¸–ç•Œ"},{"categories":["ç¬”è®°","æºç è§£æ"],"contents":"è¿™æ˜¯ Kubernetes ç½‘ç»œå­¦ä¹ çš„ç¬¬äº”ç¯‡ç¬”è®°ï¼Œä¹Ÿæ˜¯ä¹‹å‰è®¡åˆ’ä¸­çš„æœ€åä¸€ç¯‡ã€‚\næ·±å…¥æ¢ç´¢ Kubernetes ç½‘ç»œæ¨¡å‹å’Œç½‘ç»œé€šä¿¡ è®¤è¯†ä¸€ä¸‹å®¹å™¨ç½‘ç»œæ¥å£ CNI æºç åˆ†æï¼šä» kubeletã€å®¹å™¨è¿è¡Œæ—¶çœ‹ CNI çš„ä½¿ç”¨ ä» Flannel å­¦ä¹  Kubernetes VXLAN ç½‘ç»œ Kubernetes ç½‘ç»œå­¦ä¹ ä¹‹ Cilium ä¸ eBPFï¼ˆæœ¬ç¯‡ï¼‰ \u0026hellip; å¼€å§‹ä¹‹å‰è¯´ç‚¹é¢˜å¤–è¯ï¼Œè·ç¦»ä¸Šä¸€ç¯‡ Flannel CNI çš„å‘å¸ƒå·²ç»å¿«ä¸€ä¸ªæœˆäº†ã€‚è¿™ç¯‡æœ¬æƒ³è¶ç€åŠ¿å¤´åœ¨å»å¹´åº•å®Œæˆçš„ï¼Œæ­£å¥½åœ¨ä¸€ä¸ªæœˆå†…å®Œæˆè®¡åˆ’çš„æ‰€æœ‰å†…å®¹ã€‚ä½†ä¸Šç¯‡å‘å¸ƒåä¸ä¹…ï¼Œæˆ‘ä¸­æ‹›äº†èŠ±äº†ä¸€ä¸ªå¤šå‘¨çš„æ—¶é—´æ‰æ¢å¤ã€‚ç„¶è€Œï¼Œæ¢å¤åçš„çŠ¶æ€è®©æˆ‘æœ‰ç‚¹æ‡µï¼Œæ€»æ„Ÿè§‰å¾ˆéš¾é›†ä¸­ç²¾åŠ›ï¼Œå¾ˆå®¹æ˜“ç²¾ç¥æ¶£æ•£ã€‚å¯èƒ½æ¥è¿‘ç½‘ä¸Šæµä¼ çš„â€œè„‘é›¾â€å§ï¼Œè€Œä¸” Cilium ä¹Ÿæœ‰ç‚¹ç±»ä¼¼ä¸€å›¢è¿·é›¾ã€‚å†å åŠ ç½‘ç»œçŸ¥è¯†çš„ä¸è¶³ï¼ŒeBPF ä¹Ÿæœªä»æ¶‰è¶³ï¼Œå­¦ä¹ çš„è¿‡ç¨‹ä¸­æ–­æ–­ç»­ç»­ï¼Œæˆ‘æ›¾ç»ä¸€åº¦æ€€ç–‘è¿™ç¯‡ä¼šä¸ä¼šæµäº§ã€‚\næ–‡ç« ä¸­ä¸å…ä¼šæœ‰é—®é¢˜ï¼Œå¦‚æœæœ‰å‘ç°é—®é¢˜æˆ–è€…å»ºè®®ï¼Œæœ›ä¸åèµæ•™ã€‚\nèƒŒæ™¯ å»å¹´æ›¾ç»å†™è¿‡ä¸€ç¯‡æ–‡ç«  ã€Šä½¿ç”¨ Cilium å¢å¼º Kubernetes ç½‘ç»œå®‰å…¨ã€‹ æ¥è§¦è¿‡ Ciliumï¼Œå€ŸåŠ© Cilium çš„ç½‘ç»œç­–ç•¥ä»ç½‘ç»œå±‚é¢å¯¹ pod é—´çš„é€šä¿¡è¿›è¡Œé™åˆ¶ã€‚ä½†å½“æ—¶æˆ‘ä¸æ›¾æ·±å…¥å…¶å®ç°åŸç†ï¼Œå¯¹ Kubernetes ç½‘ç»œå’Œ CNI çš„äº†è§£ä¹Ÿä¸å¤Ÿæ·±å…¥ã€‚è¿™æ¬¡æˆ‘ä»¬é€šè¿‡å®é™…çš„ç¯å¢ƒæ¥æ¢å¯» Cilium çš„ç½‘ç»œã€‚\nè¿™ç¯‡æ–‡ç« ä½¿ç”¨çš„ Cilium ç‰ˆæœ¬æ˜¯ v1.12.3ï¼Œæ“ä½œç³»ç»Ÿæ˜¯ Ubuntu 20.04ï¼Œå†…æ ¸ç‰ˆæœ¬æ˜¯ 5.4.0-91-genericã€‚\nCilium ç®€ä»‹ Cilium æ˜¯ä¸€ä¸ªå¼€æºè½¯ä»¶ï¼Œç”¨äºæä¾›ã€ä¿æŠ¤å’Œè§‚å¯Ÿå®¹å™¨å·¥ä½œè´Ÿè½½ï¼ˆäº‘åŸç”Ÿï¼‰ä¹‹é—´çš„ç½‘ç»œè¿æ¥ï¼Œç”±é©å‘½æ€§çš„å†…æ ¸æŠ€æœ¯ eBPF æ¨åŠ¨ã€‚\neBPF æ˜¯ä»€ä¹ˆï¼Ÿ Linux å†…æ ¸ä¸€ç›´æ˜¯å®ç°ç›‘æ§/å¯è§‚æµ‹æ€§ã€ç½‘ç»œå’Œå®‰å…¨åŠŸèƒ½çš„ç†æƒ³åœ°æ–¹ã€‚ ä¸è¿‡å¾ˆå¤šæƒ…å†µä¸‹è¿™å¹¶éæ˜“äº‹ï¼Œå› ä¸ºè¿™äº›å·¥ä½œéœ€è¦ä¿®æ”¹å†…æ ¸æºç æˆ–åŠ è½½å†…æ ¸æ¨¡å—ï¼Œ æœ€ç»ˆå®ç°å½¢å¼æ˜¯åœ¨å·²æœ‰çš„å±‚å±‚æŠ½è±¡ä¹‹ä¸Šå åŠ æ–°çš„æŠ½è±¡ã€‚ eBPF æ˜¯ä¸€é¡¹é©å‘½æ€§æŠ€æœ¯ï¼Œå®ƒèƒ½åœ¨å†…æ ¸ä¸­è¿è¡Œæ²™ç®±ç¨‹åºï¼ˆsandbox programsï¼‰ï¼Œ è€Œæ— éœ€ä¿®æ”¹å†…æ ¸æºç æˆ–è€…åŠ è½½å†…æ ¸æ¨¡å—ã€‚\nå°† Linux å†…æ ¸å˜æˆå¯ç¼–ç¨‹ä¹‹åï¼Œå°±èƒ½åŸºäºç°æœ‰çš„ï¼ˆè€Œéå¢åŠ æ–°çš„ï¼‰æŠ½è±¡å±‚æ¥æ‰“é€ æ›´åŠ æ™ºèƒ½ã€ åŠŸèƒ½æ›´åŠ ä¸°å¯Œçš„åŸºç¡€è®¾æ–½è½¯ä»¶ï¼Œè€Œä¸ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œä¹Ÿä¸ä¼šç‰ºç‰²æ‰§è¡Œæ•ˆç‡å’Œå®‰å…¨æ€§ã€‚\nLinux çš„å†…æ ¸åœ¨ç½‘ç»œæ ˆä¸Šæä¾›äº†ä¸€ç»„ BPF é’©å­ï¼Œé€šè¿‡è¿™äº›é’©å­å¯ä»¥è§¦å‘ BPF ç¨‹åºçš„æ‰§è¡Œã€‚Cilium datapah ä½¿ç”¨è¿™äº›é’©å­åŠ è½½ BPF ç¨‹åºï¼Œåˆ›å»ºå‡ºæ›´é«˜çº§çš„ç½‘ç»œç»“æ„ã€‚\né€šè¿‡é˜…è¯» Cilium å‚è€ƒæ–‡æ¡£ eBPF Datapath å¾—çŸ¥ Cilium ä½¿ç”¨äº†ä¸‹é¢å‡ ç§é’©å­ï¼š\nXDPï¼šè¿™æ˜¯ç½‘ç»œé©±åŠ¨ä¸­æ¥æ”¶ç½‘ç»œåŒ…æ—¶å°±å¯ä»¥è§¦å‘ BPF ç¨‹åºçš„é’©å­ï¼Œä¹Ÿæ˜¯æœ€æ—©çš„ç‚¹ã€‚ç”±äºæ­¤æ—¶è¿˜æ²¡æœ‰æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œæ¯”å¦‚å°†ç½‘ç»œåŒ…å†™å…¥å†…å­˜ï¼Œæ‰€ä»¥å®ƒéå¸¸é€‚åˆè¿è¡Œåˆ é™¤æ¶æ„æˆ–æ„å¤–æµé‡çš„è¿‡æ»¤ç¨‹åºï¼Œä»¥åŠå…¶ä»–å¸¸è§çš„ DDOS ä¿æŠ¤æœºåˆ¶ã€‚ Traffic Control Ingress/Egressï¼šé™„åŠ åˆ°æµé‡æ§åˆ¶ï¼ˆtraffic controlï¼Œç®€ç§° tcï¼‰ingress é’©å­ä¸Šçš„ BPF ç¨‹åºï¼Œå¯ä»¥è¢«é™„åŠ åˆ°ç½‘ç»œæ¥å£ä¸Šã€‚è¿™ç§é’©å­åœ¨ç½‘ç»œæ ˆçš„ L3 ä¹‹å‰æ‰§è¡Œï¼Œå¹¶å¯ä»¥è®¿é—®ç½‘ç»œåŒ…çš„å¤§éƒ¨åˆ†å…ƒæ•°æ®ã€‚é€‚åˆå¤„ç†æœ¬èŠ‚ç‚¹çš„æ“ä½œï¼Œæ¯”å¦‚åº”ç”¨ L3/L4 çš„ç«¯ç‚¹ 1 ç­–ç•¥ã€è½¬å‘æµé‡åˆ°ç«¯ç‚¹ã€‚CNI é€šå¸¸ä½¿ç”¨è™šæ‹Ÿæœºä»¥å¤ªæ¥å£å¯¹ veth å°†å®¹å™¨è¿æ¥åˆ°ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´ã€‚ä½¿ç”¨é™„åŠ åˆ°ä¸»æœºç«¯ veth çš„ tc ingress é’©å­ï¼Œå¯ä»¥ç›‘æ§ç¦»å¼€å®¹å™¨çš„æ‰€æœ‰æµé‡ï¼Œå¹¶æ‰§è¡Œç­–ç•¥ã€‚åŒæ—¶å°†å¦ä¸€ä¸ª BPF ç¨‹åºé™„åŠ åˆ° tc egress é’©å­ï¼ŒCilium å¯ä»¥ç›‘æ§æ‰€æœ‰è¿›å‡ºèŠ‚ç‚¹çš„æµé‡å¹¶æ‰§è¡Œç­–ç•¥ . Socket operationsï¼šå¥—æ¥å­—æ“ä½œé’©å­é™„åŠ åˆ°ç‰¹å®šçš„ cgroup å¹¶åœ¨ TCP äº‹ä»¶ä¸Šè¿è¡Œã€‚Cilium å°† BPF å¥—æ¥å­—æ“ä½œç¨‹åºé™„åŠ åˆ°æ ¹ cgroupï¼Œå¹¶ä½¿ç”¨å®ƒæ¥ç›‘æ§ TCP çŠ¶æ€è½¬æ¢ï¼Œç‰¹åˆ«æ˜¯ ESTABLISHED çŠ¶æ€è½¬æ¢ã€‚å½“å¥—æ¥å­—çŠ¶æ€å˜ä¸º ESTABLISHED æ—¶ï¼Œå¦‚æœ TCP å¥—æ¥å­—çš„å¯¹ç«¯ä¹Ÿåœ¨å½“å‰èŠ‚ç‚¹ï¼ˆä¹Ÿå¯èƒ½æ˜¯æœ¬åœ°ä»£ç†ï¼‰ï¼Œåˆ™ä¼šé™„åŠ  Socket send/recv ç¨‹åºã€‚ Socket send/recvï¼šè¿™ä¸ªé’©å­åœ¨ TCP å¥—æ¥å­—æ‰§è¡Œçš„æ¯ä¸ªå‘é€æ“ä½œä¸Šè¿è¡Œã€‚æ­¤æ—¶é’©å­å¯ä»¥æ£€æŸ¥æ¶ˆæ¯å¹¶ä¸¢å¼ƒæ¶ˆæ¯ã€å°†æ¶ˆæ¯å‘é€åˆ° TCP å±‚ï¼Œæˆ–è€…å°†æ¶ˆæ¯é‡å®šå‘åˆ°å¦ä¸€ä¸ªå¥—æ¥å­—ã€‚Cilium ä½¿ç”¨å®ƒæ¥åŠ é€Ÿæ•°æ®è·¯å¾„é‡å®šå‘ã€‚ å› ä¸ºåé¢ä¼šç”¨åˆ°ï¼Œè¿™é‡Œç€é‡ä»‹ç»äº†è¿™å‡ ç§é’©å­ã€‚\nç¯å¢ƒæ­å»º å‰é¢å‡ ç¯‡æ–‡ç« ï¼Œæˆ‘éƒ½æ˜¯ä½¿ç”¨ k3s å¹¶æ‰‹åŠ¨å®‰è£… CNI æ’ä»¶æ¥æ­å»ºå®éªŒç¯å¢ƒã€‚è¿™æ¬¡ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ k8eï¼Œå› ä¸º k8e ä½¿ç”¨ Cilium ä½œä¸ºé»˜è®¤çš„ CNI å®ç°ã€‚\nè¿˜æ˜¯åœ¨æˆ‘çš„ homelab ä¸Šåšä¸ªåŒèŠ‚ç‚¹ï¼ˆubuntu-dev2: 192.168.1.12ã€ubuntu-dev3: 192.168.1.13ï¼‰çš„é›†ç¾¤ã€‚\nMaster èŠ‚ç‚¹ï¼š\ncurl -sfL https://getk8e.com/install.sh | API_SERVER_IP=192.168.1.12 K8E_TOKEN=ilovek8e INSTALL_K8E_EXEC=\u0026#34;server --cluster-init --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config\u0026#34; sh - Worker èŠ‚ç‚¹ï¼š\ncurl -sfL https://getk8e.com/install.sh | K8E_TOKEN=ilovek8e K8E_URL=https://192.168.1.12:6443 sh - éƒ¨ç½²ç¤ºä¾‹åº”ç”¨ï¼Œå°†å…¶è°ƒåº¦åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼š\nNODE1=ubuntu-dev2 NODE2=ubuntu-dev3 kubectl apply -n default -f - \u0026lt;\u0026lt;EOF apiVersion: v1 kind: Pod metadata: labels: app: curl name: curl spec: containers: - image: curlimages/curl name: curl command: [\u0026#34;sleep\u0026#34;, \u0026#34;365d\u0026#34;] nodeName: $NODE1 --- apiVersion: v1 kind: Pod metadata: labels: app: httpbin name: httpbin spec: containers: - image: kennethreitz/httpbin name: httpbin nodeName: $NODE2 EOF ä¸ºäº†ä½¿ç”¨æ–¹ä¾¿ï¼Œå°†ç¤ºä¾‹åº”ç”¨ã€cilium pod ç­‰ä¿¡æ¯è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼š\nNODE1=ubuntu-dev2 NODE2=ubuntu-dev3 cilium1=$(kubectl get po -n kube-system -l k8s-app=cilium --field-selector spec.nodeName=$NODE1 -o jsonpath=\u0026#39;{.items[0].metadata.name}\u0026#39;) cilium2=$(kubectl get po -n kube-system -l k8s-app=cilium --field-selector spec.nodeName=$NODE2 -o jsonpath=\u0026#39;{.items[0].metadata.name}\u0026#39;) Debug æµé‡ è¿˜æ˜¯ä»¥å‰çš„å¥—è·¯ï¼Œä»è¯·æ±‚å‘èµ·æ–¹å¼€å§‹ä¸€è·¯è¿½å¯»ç½‘ç»œåŒ…ã€‚è¿™æ¬¡ä½¿ç”¨ Service æ¥è¿›è¡Œè®¿é—®ï¼šcurl http://10.42.0.51:80/getã€‚\nkubectl get po httpbin -n default -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES httpbin 1/1 Running 0 3m 10.42.0.51 ubuntu-dev3 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; ç¬¬ 1 æ­¥ï¼šPod1 å‘é€è¯·æ±‚ æ£€æŸ¥ pod curl çš„è·¯ç”±è¡¨ï¼š\nkubectl exec curl -n default -- ip route get 10.42.0.51 10.42.0.51 via 10.42.1.247 dev eth0 src 10.42.1.80 å¯çŸ¥ç½‘ç»œåŒ…å°±å‘å¾€ä»¥å¤ªæ¥å£ eth0ï¼Œç„¶åä»ä½¿ç”¨ arp æŸ¥åˆ°å…¶ MAC åœ°å€ ae:36:76:3e:c3:03ï¼š\nkubectl exec curl -n default -- arp -n ? (10.42.1.247) at ae:36:76:3e:c3:03 [ether] on eth0 æŸ¥çœ‹æ¥å£ eth0 çš„ä¿¡æ¯ï¼š\nkubectl exec curl -n default -- ip link show eth0 42: eth0@if43: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN\u0026gt; mtu 1500 qdisc noqueue state UP qlen 1000 link/ether f6:00:50:f9:92:a1 brd ff:ff:ff:ff:ff:ff å‘ç°å…¶ MAC åœ°å€å¹¶ä¸æ˜¯ ae:36:76:3e:c3:03ï¼Œä»åå­—ä¸Šçš„ @if43 å¯ä»¥å¾—çŸ¥å…¶ veth å¯¹çš„ç´¢å¼•æ˜¯ 43ï¼Œæ¥ç€ ç™»å½•åˆ°èŠ‚ç‚¹ NODE1 æŸ¥è¯¢è¯¥ç´¢å¼•æ¥å£çš„ä¿¡æ¯ï¼š\nip link | grep -A1 ^43 43: lxc48c4aa0637ce@if42: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000 link/ether ae:36:76:3e:c3:03 brd ff:ff:ff:ff:ff:ff link-netns cni-407cd7d8-7c02-cfa7-bf93-22946f923ffd æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªæ¥å£ lxc48c4aa0637ce çš„ MAC æ­£å¥½å°±æ˜¯ ae:36:76:3e:c3:03ã€‚\næŒ‰ç…§ è¿‡å¾€çš„ç»éªŒï¼Œè¿™ä¸ªè™šæ‹Ÿçš„ä»¥å¤ªæ¥å£ lxc48c4aa0637ce æ˜¯ä¸ª è™šæ‹Ÿä»¥å¤ªç½‘å£ï¼Œä½äºä¸»æœºçš„æ ¹ç½‘ç»œå‘½åç©ºé—´ï¼Œä¸€æ–¹é¢ä¸å®¹å™¨çš„ä»¥å¤ªæ¥å£ eth0 é—´é€šè¿‡éš§é“ç›¸è¿ï¼Œå‘é€åˆ°ä»»ä½•ä¸€ç«¯çš„ç½‘ç»œåŒ…éƒ½ä¼šç›´è¾¾å¯¹ç«¯ï¼›å¦ä¸€æ–¹é¢åº”è¯¥ä¸ä¸»æœºå‘½åç©ºé—´ä¸Šçš„ç½‘æ¡¥ç›¸è¿ï¼Œä½†æ˜¯ä»ä¸Šé¢çš„ç»“æœä¸­å¹¶æœªæ‰¾åˆ°ç½‘æ¡¥çš„åå­—ã€‚\né€šè¿‡ ip link æŸ¥çœ‹ï¼š\n1: lo: \u0026lt;LOOPBACK,UP,LOWER_UP\u0026gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 2: eth0: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000 link/ether fa:cb:49:4a:28:21 brd ff:ff:ff:ff:ff:ff 3: cilium_net@cilium_host: \u0026lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000 link/ether 36:d5:5a:2a:ce:80 brd ff:ff:ff:ff:ff:ff 4: cilium_host@cilium_net: \u0026lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000 link/ether 12:82:fb:78:16:6a brd ff:ff:ff:ff:ff:ff 5: cilium_vxlan: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000 link/ether fa:42:4d:22:b7:d0 brd ff:ff:ff:ff:ff:ff 25: lxc_health@if24: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000 link/ether 3e:4f:b3:56:67:2b brd ff:ff:ff:ff:ff:ff link-netnsid 0 33: lxc113dd6a50a7a@if32: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000 link/ether 32:3a:5b:15:44:ff brd ff:ff:ff:ff:ff:ff link-netns cni-07cffbd8-83dd-dcc1-0b57-5c59c1c037e9 43: lxc48c4aa0637ce@if42: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000 link/ether ae:36:76:3e:c3:03 brd ff:ff:ff:ff:ff:ff link-netns cni-407cd7d8-7c02-cfa7-bf93-22946f923ffd æˆ‘ä»¬çœ‹åˆ°äº†å¤šä¸ªä»¥å¤ªæ¥å£ï¼šcilium_netã€cilium_hostã€cilium_vxlanã€cilium_health ä»¥åŠä¸å®¹å™¨ç½‘ç»œå‘½åç©ºé—´çš„ä»¥å¤ªæ¥å£çš„éš§é“å¯¹ç«¯ lxcxxxxã€‚\nç½‘ç»œåŒ…åˆ°äº† lxcxxx è¿™é‡Œå†æ€ä¹ˆèµ°ï¼Ÿæ¥ä¸‹æ¥å°±è½®åˆ° eBPF å‡ºåœºäº†ã€‚\næ³¨æ„ cilium_netã€cilium_host å’Œ cilium_health åœ¨æ–‡ä¸­ä¸ä¼šæ¶‰åŠï¼Œå› æ­¤ä¸åœ¨åé¢çš„å›¾ä¸­ä½“ç°ã€‚\nç¬¬ 2 æ­¥ï¼šPod1 LXC BPF Ingress è¿›å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„ cilium pod ä¹Ÿå°±æ˜¯å‰é¢è®¾ç½®çš„å˜é‡ $cilium1 ä¸­ä½¿ç”¨ bpftool å‘½ä»¤æ£€æŸ¥é™„åŠ è¯¥ veth ä¸Š BPF ç¨‹åºã€‚\nkubectl exec -n kube-system $cilium1 -c cilium-agent -- bpftool net show dev lxc48c4aa0637ce xdp: tc: lxc48c4aa0637ce(43) clsact/ingress bpf_lxc.o:[from-container] id 2901 flow_dissector: ä¹Ÿå¯ä»¥ç™»å½•åˆ°èŠ‚ç‚¹ $NODE1 ä¸Šä½¿ç”¨ tc å‘½ä»¤æ¥æŸ¥è¯¢ã€‚æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬æŒ‡å®šäº† ingressï¼Œåœ¨æ–‡ç« å¼€å¤´ datapath éƒ¨åˆ†ã€‚å› ä¸ºå®¹å™¨çš„ eth0 ä¸ä¸»æœºç½‘ç»œå‘½åç©ºé—´çš„ lxc ç»„æˆé€šé“ï¼Œå› æ­¤å®¹å™¨çš„å‡ºå£ï¼ˆEgressï¼‰æµé‡å°±æ˜¯ lxc çš„å…¥å£ Ingress æµé‡ã€‚åŒç†ï¼Œå®¹å™¨çš„å…¥å£æµé‡å°±æ˜¯ lxc çš„å‡ºå£æµé‡ã€‚\n#on NODE1 tc filter show dev lxc48c4aa0637ce ingress filter protocol all pref 1 bpf chain 0 filter protocol all pref 1 bpf chain 0 handle 0x1 bpf_lxc.o:[from-container] direct-action not_in_hw id 2901 tag d578585f7e71464b jited å¯ä»¥é€šè¿‡ç¨‹åº id 2901 æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚\nkubectl exec -n kube-system $cilium1 -c cilium-agent -- bpftool prog show id 2901 2901: sched_cls name handle_xgress tag d578585f7e71464b gpl loaded_at 2023-01-09T19:29:52+0000 uid 0 xlated 688B jited 589B memlock 4096B map_ids 572,86 btf_id 301 å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡ŒåŠ è½½äº† BPF ç¨‹åº bpf_lxc.o çš„ from-container éƒ¨åˆ†ã€‚åˆ° Cilium çš„æºç  bpf_lxc.c çš„ __section(\u0026quot;from-container\u0026quot;) éƒ¨åˆ†ï¼Œç¨‹åºå handle_xgressï¼š\nhandle_xgress #1 validate_ethertype(ctx, \u0026amp;proto) tail_handle_ipv4 #2 handle_ipv4_from_lxc #3 lookup_ip4_remote_endpoint =\u0026gt; ipcache_lookup4 #4 policy_can_access #5 if TUNNEL_MODE #6 encap_and_redirect_lxc ctx_redirect(ctx, ENCAP_IFINDEX, 0) if ENABLE_ROUTING ipv4_l3 return CTX_ACT_OK; (1)ï¼šç½‘ç»œåŒ…çš„å¤´ä¿¡æ¯å‘é€ç»™ handle_xgressï¼Œç„¶åæ£€æŸ¥å…¶ L3 çš„åè®®ã€‚\n(2)ï¼šæ‰€æœ‰ IPv4 çš„ç½‘ç»œåŒ…éƒ½äº¤ç”± tail_handle_ipv4 æ¥å¤„ç†ã€‚\n(3)ï¼šæ ¸å¿ƒçš„é€»è¾‘éƒ½åœ¨ handle_ipv4_from_lxcã€‚tail_handle_ipv4 æ˜¯å¦‚ä½•è·³è½¬åˆ° handle_ipv4_from_lxcï¼Œè¿™é‡Œç”¨åˆ°äº† Tails Call ã€‚Tails call å…è®¸æˆ‘ä»¬é…ç½®åœ¨æŸä¸ª BPF ç¨‹åºæ‰§è¡Œå®Œæˆå¹¶æ»¡è¶³æŸä¸ªæ¡ä»¶æ—¶æ‰§è¡ŒæŒ‡å®šçš„å¦ä¸€ä¸ªç¨‹åºï¼Œä¸”æ— éœ€è¿”å›åŸç¨‹åºã€‚è¿™é‡Œä¸åšå±•å¼€æœ‰å…´è¶£çš„å¯ä»¥å‚è€ƒ å®˜æ–¹çš„æ–‡æ¡£ã€‚\n(4)ï¼šæ¥ç€ä» eBPF map cilium_ipcache ä¸­æŸ¥è¯¢ç›®æ ‡ endpointï¼ŒæŸ¥è¯¢åˆ° tunnel endpoint 192.168.1.13 ï¼Œè¿™ä¸ªåœ°å€æ˜¯ç›®æ ‡æ‰€åœ¨çš„èŠ‚ç‚¹ IP åœ°å€ï¼Œç±»å‹æ˜¯ã€‚\nkubectl exec -n kube-system $cilium1 -c cilium-agent -- cilium map get cilium_ipcache | grep 10.42.0.51 10.42.0.51/32 identity=15773 encryptkey=0 tunnelendpoint=192.168.1.13 sync (5)ï¼špolicy_can_access è¿™é‡Œæ˜¯æ‰§è¡Œå‡ºå£ç­–ç•¥çš„æ£€æŸ¥ï¼Œæœ¬æ–‡ä¸æ¶‰åŠæ•…ä¸å±•å¼€ã€‚\n(6)ï¼šä¹‹åçš„å¤„ç†ä¼šæœ‰ä¸¤ç§æ¨¡å¼ï¼š\nç›´æ¥è·¯ç”±ï¼šäº¤ç”±å†…æ ¸ç½‘ç»œæ ˆè¿›è¡Œå¤„ç†ï¼Œæˆ–è€… underlaying SDN çš„æ”¯æŒã€‚ éš§é“ï¼šä¼šå°†ç½‘ç»œåŒ…å†æ¬¡å°è£…ï¼Œé€šè¿‡éš§é“ä¼ è¾“ï¼Œæ¯”å¦‚ vxlanã€‚ ä½¿ç”¨ä»£ç†ï¼šåœ¨ #5 ä¸­å¦‚æœ policy_can_access è¿”å›äº†ä»£ç†çš„ç«¯å£æ—¶ï¼ˆå¦‚æœç½‘ç»œç­–ç•¥ä½œç”¨åœ¨ L7ï¼Œç­–ç•¥ä¸­è‡ªåŠ¨æŒ‡å®šä»£ç†çš„ç«¯å£ï¼‰ï¼Œä¼šä½¿ç”¨ä»£ç†ï¼ˆNode levelï¼‰è¿›è¡Œè·¯ç”±ã€‚å…³äºè¿™éƒ¨åˆ†ï¼Œè¿˜æ˜¯å‚è€ƒå¦ä¸€ç¯‡æ–‡ç«  Cilium å¦‚ä½•å¤„ç† L7 æµé‡ï¼Œå¯¹å€ŸåŠ©ä»£ç†æ‰§è¡Œ 7 å±‚çš„æµé‡ç­–ç•¥è¿›è¡Œäº†æ·±å…¥çš„è§£è¯»ã€‚ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„ä¹Ÿæ˜¯éš§é“æ¨¡å¼ã€‚ç½‘ç»œåŒ…äº¤ç»™ encap_and_redirect_lxc å¤„ç†ï¼Œä½¿ç”¨ tunnel endpoint ä½œä¸ºéš§é“å¯¹ç«¯ã€‚æœ€ç»ˆè½¬å‘ç»™ ENCAP_IFINDEXï¼ˆè¿™ä¸ªå€¼æ˜¯æ¥å£çš„ç´¢å¼•å€¼ï¼Œç”± cilium-agent å¯åŠ¨æ—¶è·å–çš„ï¼‰ï¼Œå°±æ˜¯ä»¥å¤ªç½‘æ¥å£ cilium_vxlanã€‚\nç¬¬ 3 æ­¥ï¼šNODE 1 vxlan BPF Egress å…ˆçœ‹ä¸‹è¿™ä¸ªæ¥å£ä¸Šçš„ BPF ç¨‹åºã€‚\nkubectl exec -n kube-system $cilium1 -c cilium-agent -- bpftool net show dev cilium_vxlan xdp: tc: cilium_vxlan(5) clsact/ingress bpf_overlay.o:[from-overlay] id 2699 cilium_vxlan(5) clsact/egress bpf_overlay.o:[to-overlay] id 2707 flow_dissector: å®¹å™¨çš„å‡ºå£æµé‡å¯¹ cilium_vxlan æ¥è¯´ä¹Ÿæ˜¯ engressï¼Œå› æ­¤è¿™é‡Œçš„ç¨‹åºæ˜¯ to-overlayã€‚\nç¨‹åºä½äº bpf_overlay.c ä¸­ï¼Œè¿™ä¸ªç¨‹åºçš„å¤„ç†å¾ˆç®€å•ï¼Œå¦‚æœæ˜¯ IPv6 åè®®ä¼šå°†å°åŒ…ä½¿ç”¨ IPv6 çš„åœ°å€å°è£…ä¸€æ¬¡ã€‚è¿™é‡Œæ˜¯ IPv4 ï¼Œç›´æ¥è¿”å› CTX_ACT_OKã€‚å°†ç½‘ç»œåŒ…äº¤ç»™å†…æ ¸ç½‘ç»œæ ˆï¼Œè¿›å…¥ eth0 æ¥å£ã€‚\nç¬¬ 4 æ­¥ï¼šNODE1 NIC BPF Egress å…ˆçœ‹çœ‹ BPF ç¨‹åºã€‚\nkubectl exec -n kube-system $cilium1 -c cilium-agent -- bpftool net show dev eth0 xdp: tc: eth0(2) clsact/ingress bpf_netdev_eth0.o:[from-netdev] id 2823 eth0(2) clsact/egress bpf_netdev_eth0.o:[to-netdev] id 2832 flow_dissector: egress ç¨‹åº to-netdev ä½äº bpf_host.cã€‚å®é™…ä¸Šæ²¡åšé‡è¦çš„å¤„ç†ï¼Œåªæ˜¯è¿”å› CTX_ACT_OK äº¤ç»™å†…æ ¸ç½‘ç»œæ ˆç»§ç»­å¤„ç†ï¼šå°†ç½‘ç»œåŒ…å‘é€åˆ° vxlan éš§é“å‘é€åˆ°å¯¹ç«¯ï¼Œä¹Ÿå°±æ˜¯èŠ‚ç‚¹ 192.168.1.13 ã€‚ä¸­é—´æ•°æ®çš„ä¼ è¾“ï¼Œå®é™…ä¸Šç”¨çš„è¿˜æ˜¯ underlaying ç½‘ç»œï¼Œä»ä¸»æœºçš„ eth0 æ¥å£ç»è¿‡ underlaying ç½‘ç»œåˆ°è¾¾ç›®æ ‡ä¸»æœºçš„ eth0 æ¥å£ã€‚\nç¬¬ 5 æ­¥ï¼šNODE2 NIC BPF Ingress vxlan ç½‘ç»œåŒ…åˆ°è¾¾èŠ‚ç‚¹çš„ eth0 æ¥å£ï¼Œä¹Ÿä¼šè§¦å‘ BPF ç¨‹åºã€‚\nkubectl exec -n kube-system $cilium2 -c cilium-agent -- bpftool net show dev eth0 xdp: tc: eth0(2) clsact/ingress bpf_netdev_eth0.o:[from-netdev] id 4556 eth0(2) clsact/egress bpf_netdev_eth0.o:[to-netdev] id 4565 flow_dissector: è¿™æ¬¡è§¦å‘çš„æ˜¯ from-netdevï¼Œä½äº bpf_host.c ä¸­ã€‚\nfrom_netdev if vlan allow_vlan return CTX_ACT_OK å¯¹ vxlan tunnel æ¨¡å¼æ¥è¯´ï¼Œè¿™é‡Œçš„é€»è¾‘å¾ˆç®€å•ã€‚å½“åˆ¤æ–­ç½‘ç»œåŒ…æ˜¯ vxlan çš„å¹¶ç¡®è®¤å…è®¸ vlan åï¼Œç›´æ¥è¿”å› CTX_ACT_OK å°†å¤„ç†äº¤ç»™å†…æ ¸ç½‘ç»œæ ˆã€‚\nç¬¬ 6 æ­¥ï¼šNODE2 vxlan BPF Ingress ç½‘ç»œåŒ…é€šè¿‡å†…æ ¸ç½‘ç»œæ ˆæ¥åˆ°äº†æ¥å£ cilium_vxlanã€‚\nkubectl exec -n kube-system $cilium2 -c cilium-agent -- bpftool net show dev cilium_vxlan xdp: tc: cilium_vxlan(5) clsact/ingress bpf_overlay.o:[from-overlay] id 4468 cilium_vxlan(5) clsact/egress bpf_overlay.o:[to-overlay] id 4476 flow_dissector: ç¨‹åºä½äº bpf_overlay.c ä¸­ã€‚\nfrom_overlay validate_ethertype tail_handle_ipv4 handle_ipv4 lookup_ip4_endpoint 1# map_lookup_elem ipv4_local_delivery 2# tail_call_dynamic 3# (1)ï¼šlookup_ip4_endpoint ä¼šåœ¨ eBPF map cilium_lxc ä¸­æ£€æŸ¥ç›®æ ‡åœ°å€æ˜¯å¦åœ¨å½“å‰èŠ‚ç‚¹ä¸­ï¼ˆè¿™ä¸ª map åªä¿å­˜äº†å½“å‰èŠ‚ç‚¹ä¸­çš„ endpointï¼‰ã€‚\nkubectl exec -n kube-system $cilium2 -c cilium-agent -- cilium map get cilium_lxc | grep 10.42.0.51 10.42.0.51:0 id=2826 flags=0x0000 ifindex=29 mac=96:86:44:A6:37:EC nodemac=D2:AD:65:4D:D0:7B sync è¿™é‡ŒæŸ¥åˆ°ç›®æ ‡ endpoint çš„ä¿¡æ¯ï¼šidã€ä»¥å¤ªç½‘å£ç´¢å¼•ã€mac åœ°å€ã€‚åœ¨ NODE2 çš„èŠ‚ç‚¹ä¸Šï¼ŒæŸ¥çœ‹æ¥å£ä¿¡æ¯å‘ç°ï¼Œè¿™ä¸ªç½‘å£æ˜¯è™šæ‹Ÿä»¥å¤ªç½‘è®¾å¤‡ lxc65015af813d1ï¼Œæ­£å¥½æ˜¯ pod httpbin æ¥å£ eth0 çš„å¯¹ç«¯ã€‚\nip link | grep -B1 -i d2:ad 29: lxc65015af813d1@if28: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000 link/ether d2:ad:65:4d:d0:7b brd ff:ff:ff:ff:ff:ff link-netns cni-395674eb-172b-2234-a9ad-1db78b2a5beb kubectl exec -n default httpbin -- ip link 1: lo: \u0026lt;LOOPBACK,UP,LOWER_UP\u0026gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 28: eth0@if29: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000 link/ether 96:86:44:a6:37:ec brd ff:ff:ff:ff:ff:ff link-netnsid (2)ï¼šipv4_local_delivery çš„é€»è¾‘ä½äº l3.h ä¸­ï¼Œè¿™é‡Œä¼š tail-call é€šè¿‡ endpoint çš„ LXC IDï¼ˆ29ï¼‰å®šä½çš„ BPF ç¨‹åºã€‚\nç¬¬ 7 æ­¥ï¼šPod2 LXC BPF Egress æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å¹¶ä¸ä¼šæ‰¾åˆ°æƒ³æƒ³ä¸­çš„ egress to-containerï¼ˆä¸ from-containerï¼‰ã€‚\nkubectl exec -n kube-system $cilium2 -c cilium-agent -- bpftool net show | grep 29 lxc65015af813d1(29) clsact/ingress bpf_lxc.o:[from-container] id 4670 å‰é¢ç”¨çš„ BPF ç¨‹åºéƒ½æ˜¯é™„åŠ åˆ°æ¥å£ä¸Šçš„ï¼Œè€Œè¿™é‡Œæ˜¯ç›´æ¥æœ‰ vxlan é™„åŠ çš„ç¨‹åºç›´æ¥ tail call çš„ã€‚to-container å¯ä»¥åœ¨ bpf-lxc.c ä¸­æ‰¾åˆ°ã€‚\nhandle_to_container tail_ipv4_to_endpoint ipv4_policy #1 policy_can_access_ingress redirect_ep ctx_redirect (1)ï¼šipv4_policy ä¼šæ‰§è¡Œé…ç½®çš„ç­–ç•¥\n(2)ï¼šå¦‚æœç­–ç•¥é€šè¿‡ï¼Œä¼šè°ƒç”¨ redirect_ep å°†ç½‘ç»œåŒ…å‘é€åˆ°è™šæ‹Ÿä»¥å¤ªæ¥å£ lxc65015af813d1ï¼Œè¿›å…¥åˆ° veth åä¼šç›´è¾¾ä¸å…¶ç›¸è¿çš„å®¹å™¨ eth0 æ¥å£ã€‚\nç¬¬ 8 æ­¥ï¼šåˆ°è¾¾ Pod2 ç½‘ç»œåŒ…åˆ°è¾¾ pod2ï¼Œé™„ä¸Šä¸€å¼ å®Œæˆçš„å›¾ã€‚\næ€»ç»“ è¯´è¯´ä¸ªäººçœ‹æ³•å§ï¼Œæœ¬æ–‡è®¾è®¡çš„å†…å®¹è¿˜åªæ˜¯ Cilium çš„å†°å±±ä¸€è§’ï¼Œå¯¹äºå†…æ ¸çŸ¥è¯†å’Œ C è¯­è¨€æ¬ ç¼ºçš„æˆ‘æ¥è¯´ç ”ç©¶èµ·æ¥éå¸¸åƒåŠ›ã€‚Cilium é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å¾ˆå¤šçš„å†…å®¹ï¼Œä¹Ÿè¿˜æ²¡æœ‰æ·±å…¥å»ç ”ç©¶ã€‚ä¸å¾—ä¸æ„Ÿå¹ï¼ŒCilium çœŸæ˜¯å¤æ‚ï¼Œä»¥æˆ‘ç›®å‰çš„äº†è§£ï¼ŒCilium ç»´æŠ¤äº†ä¸€å¥—è‡ªå·±çš„æ•°æ®åœ¨ BPF map ä¸­ï¼Œæ¯”å¦‚ endpointã€èŠ‚ç‚¹ã€ç­–ç•¥ã€è·¯ç”±ã€è¿æ¥çŠ¶æ€ç­‰ç›¸å½“å¤šçš„æ•°æ®ï¼Œè¿™äº›éƒ½æ˜¯ä¿å­˜åœ¨å†…æ ¸ä¸­ï¼›å†å°±æ˜¯ BPF ç¨‹åºçš„å¼€å‘å’Œç»´æŠ¤æˆæœ¬ä¼šéšç€åŠŸèƒ½çš„å¤æ‚åº¦è€Œè†¨èƒ€ï¼Œå¾ˆéš¾æƒ³è±¡å¦‚æœç”¨ BPF ç¨‹åºå»å¼€å‘ L7 çš„åŠŸèƒ½ä¼šå¤šå¤æ‚ã€‚è¿™åº”è¯¥æ˜¯ä¸ºä»€ä¹ˆä¼šå€ŸåŠ©ä»£ç†å»å¤„ç† L7 çš„åœºæ™¯ã€‚\næœ€ååˆ†äº«ä¸‹å­¦ä¹  Cilium è¿‡ç¨‹ä¸­çš„ç»éªŒå§ã€‚\né¦–å…ˆæ˜¯ BPF ç¨‹åºçš„é˜…è¯»ï¼Œåœ¨é¡¹ç›®çš„ bpf çš„ä»£ç éƒ½æ˜¯é™æ€çš„ä»£ç ï¼Œé‡Œé¢åˆ†å¸ƒç€å¾ˆå¤šçš„ä¸é…ç½®ç›¸å…³çš„ if elseï¼Œè¿è¡Œæ—¶ä¼šæ ¹æ®é…ç½®è¿›è¡Œç¼–è¯‘ã€‚è¿™ç§æƒ…å†µä¸‹å¯ä»¥è¿›å…¥ Cilium podï¼Œåœ¨ç›®å½• /run/cilium/state/templates ä¸‹æœ‰åº”ç”¨é…ç½®åçš„æºæ–‡ä»¶ï¼Œä»£ç é‡ä¼šå°‘å¾ˆå¤šï¼›åœ¨ /run/cilium/state/globals/node_config ä¸‹æ˜¯å½“å‰ä½¿ç”¨çš„é…ç½®ï¼Œå¯ä»¥ç»“åˆè¿™äº›é…ç½®æ¥é˜…è¯»ä»£ç ã€‚\nè„šæ³¨\nCilium é€šè¿‡ä¸ºå®¹å™¨åˆ†é… IP åœ°å€ä½¿å…¶åœ¨ç½‘ç»œä¸Šå¯ç”¨ã€‚å¤šä¸ªå®¹å™¨å¯ä»¥å…±äº«åŒä¸€ä¸ª IP åœ°å€ï¼Œå°±åƒ ä¸€ä¸ª Kubernetes Pod ä¸­å¯ä»¥æœ‰å¤šä¸ªå®¹å™¨ï¼Œè¿™äº›å®¹å™¨ä¹‹é—´å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼Œä½¿ç”¨åŒä¸€ä¸ª IP åœ°å€ã€‚è¿™äº›å…±äº«åŒä¸€ä¸ªåœ°å€çš„å®¹å™¨ï¼ŒCilium å°†å…¶ç»„åˆèµ·æ¥ï¼Œæˆä¸º Endpointï¼ˆç«¯ç‚¹ï¼‰ã€‚\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2023/01/11/pexelsmarcosmiranda672597.jpg","permalink":"https://atbug.com/learn-cilium-and-ebpf/","tags":["Kubernetes","å®¹å™¨","Cilium","eBPF"],"title":"Kubernetes ç½‘ç»œå­¦ä¹ ä¹‹ Cilium ä¸ eBPF"},{"categories":["ç”Ÿæ´»"],"contents":"å¿«ï¼Œæ˜¯çœŸçš„å¿«ï¼Œæ„Ÿè§‰ ä¸ 2021 å†è§ å°±åœ¨å‡ å¤©å‰ï¼Œç„¶è€Œå›å¤´åˆæƒ³ä¸åˆ°åšäº†ä»€ä¹ˆï¼Œè¯¥æ€»ç»“ä»€ä¹ˆã€‚\næ˜¯çš„ï¼Œè¿™ç¯‡ä¸æŠ€æœ¯æ— å…³ã€‚\nå·¥ä½œ å»å¹´ï¼ˆæˆ‘ç°åœ¨å¯ä»¥ç§°å…¶ä¸ºå»å¹´ï¼‰æ¢äº†ç°åœ¨çš„å·¥ä½œï¼Œæ¢äº†æ–°çš„æ–¹å‘ï¼Œå¯¹äºæœªçŸ¥å½“åˆçš„å‡ ä¸ªæœˆå……æ»¡äº†æ–°é²œä¸å¿å¿‘ã€‚å¹´åˆåœ¨è€æ¿çš„å‡ æ¬¡æ­£å‘ â€œPUAâ€ ä¸‹ï¼Œå¯¹è¿™ä¸ªæ–¹å‘æ…¢æ…¢æœ‰äº†æ›´æ–°çš„è®¤è¯†ï¼Œå¹¶åšå®šçš„èµ°ä¸‹å»ã€‚\nè¿œç¨‹åŠå…¬åˆä¸€å¹´ï¼Œèµ°å‡ºæœ€åˆåŠå¹´çš„â€œèœœæœˆæœŸâ€ä¹‹åï¼Œå°¤å…¶ä¸ŠåŠå¹´çš„é‚£å‡ ä¸ªæœˆï¼Œå¿ƒä¸­å……æ»¡äº†é˜´éƒã€‚çŸ­çŸ­çš„å‡ ä¸ªæœˆï¼Œæœ‰ç‚¹å°†å±…å®¶åšåˆ°äº†æè‡´çš„å¼‚å‘³ï¼Œä»¥è‡³äºå¹´åº•ä¸¤ä¸ªæœˆçš„å±…å®¶å˜å¾—æ— æ„Ÿäº†ã€‚ä¹Ÿå¥½ï¼Œå¿«é€Ÿåœ°åº¦è¿‡äº†è¿œç¨‹åŠå…¬çš„â€œé˜µç—›æœŸâ€ã€‚\nå·¥ä½œä¸­ä»ç„¶æœ‰æŒ‘æˆ˜ï¼Œä½†æ›´å¤šçš„æ˜¯æ¥è‡ªè‡ªå·±ä¸æ›¾æ¥è§¦çš„çŸ¥è¯†é¢†åŸŸï¼Œæ— ä»–å”¯æœ‰ä¸æ–­åœ°æ¢ç´¢å­¦ä¹ ã€‚è¿™ä¸€å¹´ï¼Œä»å·¥ä½œä»åŒäº‹é‚£è¾¹éƒ½å­¦åˆ°äº†å¾ˆå¤šã€‚\nä½•å…¶æœ‰å¹¸ï¼Œç»§ç»­åšç€è‡ªå·±å–œæ¬¢çš„å·¥ä½œã€‚\nå­¦ä¹  é˜…è¯»æ–¹é¢ï¼Œä¹¦çœ‹çš„æ˜¯ä¸å¤Ÿå¤šï¼Œæ›´å¤šçš„æ˜¯ç¢ç‰‡åŒ–çš„é˜…è¯»æ—¶é—´ã€‚â€œå“ªé‡Œä¸ä¼šå­¦å“ªé‡Œâ€ï¼Œé‡åˆ°ä¸ä¼šçš„ä¸éœ€è¦å°´å°¬ï¼Œä¹Ÿæ­£å¼å¡«å……è®¤çŸ¥æ‹¼å›¾çš„æœºä¼šã€‚å­¦ä¹ ä¹‹åï¼Œå°†å…¶è®°å½•ä¸‹æ¥ã€‚å†™åšå®¢å†™å…¬ä¼—å·ï¼Œå®é™…ä¸Šæ˜¯æˆ‘å­¦ä¹ çš„ä¸€ç§æ–¹å¼ã€‚\nå…¬ä¼—å·ï¼Œè¿™æ˜¯æˆ‘åšæŒçš„ç¬¬äºŒå¹´ï¼Œå› ä¸ºæ˜¯è®°å½•å­¦ä¹ ï¼Œå†…å®¹ä¼šæ˜¾å¾—æ‚ä¹±ã€‚å¹´åˆæœ‰æœ‹å‹å»ºè®®ç¨å¾®è¿è¥ä¸€ä¸‹ï¼Œç¡®å®æœ‰è€ƒè™‘è¿‡ï¼Œä½†æœ€ç»ˆæ”¾å¼ƒã€‚ä¸æƒ³åœ¨è¿™ä¸Šé¢æµªè´¹æ—¶é—´ï¼Œä¸æƒ³æ”¹å˜å†™ä½œçš„åˆè¡·ï¼Œå”¯æœ‰æŒç»­å­¦ä¹ æ‰æ˜¯å†™ä¸‹å»çš„åŠ¨åŠ›ã€‚\nç»Ÿè®¡äº†ä¸‹ï¼Œ2020 å¹´æœ‰ 34 ç¯‡åŸåˆ› 5 ç¯‡ç¿»è¯‘ï¼Œè™½ç„¶æ•°é‡æ²¡æœ‰å»å¹´å¤šï¼Œä½†æ˜¯æœ‰åœ¨å°è¯•è¿›è¡Œæ€è€ƒå’Œæ²‰æ·€ã€‚å†…å®¹è™½ç„¶ä¸ä¼šå¾ˆå¤šï¼Œä½†æˆ‘å¸Œæœ›ç»§ç»­ä¿æŒä¸‹å»ï¼Œåªå‘åŸåˆ›ã€‚\nä½•å…¶æœ‰å¹¸ï¼Œè¿˜èƒ½ç»§ç»­å­¦ä¹ ã€‚\nç”Ÿæ´» æ˜å¤©ä¸å¥¹è¿›å…¥ç¬¬ 19 ä¸ªå¹´å¤´ï¼Œæ˜å¹´æˆ‘ä¹Ÿ 38 äº†ï¼Œå¼€å§‹è¶…è¿‡äººç”Ÿä¸€åŠçš„æ—¶é—´ï¼›çˆ¶æ¯é™ªåœ¨èº«è¾¹ï¼Œä¸ä½åœ¨ä¸€èµ·ä½†ä½å¾—è¶Šæ¥è¶Šè¿‘ï¼›å„¿å­ä¹Ÿä¸€å¤©å¤©é•¿å¤§ï¼Œå¯ä»¥ä¸€èµ·å¼€å§‹æ‰“æ¸¸æˆäº†ã€‚\nä»Šå¹´ä¸åŒ»é™¢æ‰“äº¤é“çš„æ¬¡æ•°æœ‰ç‚¹å¤šï¼Œæ‰€å¹¸éƒ½ä¸€åˆ‡éƒ½ç®—é¡ºåˆ©ï¼Œå¦ç„¶é¢å¯¹ã€‚\nä½•å…¶æœ‰å¹¸ï¼Œæœ‰ä½ ä»¬ç›¸ä¼´ã€‚\næ€»ç»“ è¿‡å»ä¸€å¹´ï¼Œè¿‡å¾—éå¸¸å¿«ï¼Œæœ‰å¾—æœ‰å¤±ï¼Œæœ‰æ±‚è€Œä¸å¾—ï¼Œæœ‰å¤±è€Œå¤å¾—ã€‚\nçæƒœçœ¼å‰ï¼Œçæƒœå½“ä¸‹ã€‚\nä½•å…¶æœ‰å¹¸ï¼Œ2023ï¼Œå®ƒæ¥äº†ã€‚\nå¸Œæœ›ä½ æ„¿æ„å¬ æˆ‘å¿ƒä¸­çš„æ—§æ—¥è¾‰ç…Œ\næˆ‘çš„ä¸–ç•Œæ²¡æœ‰å¤ªé˜³ å´ä¾ç„¶æ˜äº®\nç†æƒ³çš„ç§å­å®ƒéšé£é£˜è¡ä¸çŸ¥å»å‘ä½•æ–¹\nåœ¨ä¸ä¸ºäººçŸ¥çš„è§’è½é‡Œå¼€å‡ºäº†èŠ±\nä¸åœåœ°èµ° è¿œæ–¹æ²¡æœ‰å°½å¤´\nç›®å…‰æ‰€åŠ éƒ½æ˜¯å´­æ–°çš„è½®å»“\nå£°è‰²çŠ¬é©¬ å¯¹é”™åˆ«å†è¯„ä»·\nä¸å¿…å…³å¿ƒ æ˜å¤©ä¼šæ€æ ·\nä¸‡ç‰©ç”Ÿé•¿ çºµç«çƒ§å¹²ç†æƒ³\nå­¤å‹‡ä¸€è…” å°†æ¼†é»‘çš„å¤œç‚¹äº®\nä¹‰æ— åé¡¾ ç»§ç»­ä¹˜é£ç ´æµª\näººç¾¤æ•£åœº å¿«èƒŒä¸Šè¡Œå›Š\né»‘å±‹ä¹é˜Ÿã€Šé€†æ—…ã€‹\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/31/pexelslaleshaldarwish169976.jpg","permalink":"https://atbug.com/fare-well-2002/","tags":null,"title":"å†è§ï¼Œè¶…é€Ÿçš„ 2022"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬æ–‡ç¿»è¯‘è‡ª ContainerJournal çš„ 2022 å¹´åº¦æ–‡ç« ä¹‹ä¸€ ã€ŠImplementing Zero-Trust on Kubernetesã€‹ï¼Œä½œè€… Deepak Goel åœ¨æ–‡ä¸­åˆ†äº«äº† Kubernetes ä¸Šå®æ–½é›¶ä¿¡ä»»çš„ä¸‰ä¸ªæœ€ä½³å®è·µã€‚\nä½œä¸ºäº‘åŸç”Ÿç¤¾åŒºçš„åŸºçŸ³ï¼ŒKubernetes å¸®åŠ©ä¼ä¸šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ›´é«˜æ•ˆåœ°éƒ¨ç½²å’Œç®¡ç†å®¹å™¨ã€‚å°½ç®¡ Kubernetes æœ€åˆè®¾è®¡æ—¶æä¾›äº†åŸºæœ¬çš„ å®‰å…¨åŠŸèƒ½ï¼Œä½†å¹¿æ³›ä¸”è¿…é€Ÿçš„é‡‡ç”¨ä»¥åŠæ—¥ç›Šå¤æ‚çš„å¨èƒå½¢åŠ¿ä½¿ Kubernetes æ›´å®¹æ˜“å—åˆ°æ”»å‡»ã€‚å¼€å‘äººå‘˜å’Œå®‰å…¨ä¸“å®¶å½“ä¸‹çš„ä»»åŠ¡æ˜¯æ‰©å±• Kubernetes çš„å†…ç½®å®‰å…¨æ€§ï¼Œä»¥æœ‰æ•ˆé˜²èŒƒæ›´å¤æ‚ã€æ›´å¤šæ ·å’Œæ›´é¢‘ç¹çš„ç½‘ç»œæ”»å‡»ã€‚\nä»¥å¾€â€œä¿¡ä»»ä½†è¦éªŒè¯â€çš„æ–¹å¼å·²è¢«è¯æ˜å¯¹äº‘è®¡ç®—å¤æ‚çš„åˆ†å¸ƒå¼ç‰¹æ€§æ— æ•ˆï¼Œå› æ­¤ Kubernetes å¿…é¡»è½¬å‘â€œä»ä¸ä¿¡ä»»ï¼Œå§‹ç»ˆéªŒè¯â€çš„é›¶ä¿¡ä»»æ¨¡å‹æ€æƒ³ï¼Œä¸ºä¸šåŠ¡æä¾›æ›´å¤§çš„ä¿æŠ¤ã€‚\né›¶ä¿¡ä»»æ¨¡å‹çš„åŸºæœ¬æ¦‚å¿µ åŸºäºâ€œä»ä¸ä¿¡ä»»ï¼Œå§‹ç»ˆéªŒè¯â€çš„åŸåˆ™ï¼Œå¯ä»¥ç”¨ä¸‰ä¸ªåŸºæœ¬æ¦‚å¿µæ¥è§£é‡Šé›¶ä¿¡ä»»æ¨¡å‹ï¼š\nå®‰å…¨ç½‘ç»œï¼šå§‹ç»ˆè®¤ä¸ºç½‘ç»œæ˜¯æ•Œå¯¹çš„å’Œæœ‰å¨èƒçš„ã€‚ç½‘ç»œä¸Šçš„å†…éƒ¨å’Œå¤–éƒ¨æ•°æ®å’Œä¿¡æ¯ä¸æ–­æš´éœ²åœ¨å®‰å…¨å¨èƒä¹‹ä¸‹ã€‚ å®‰å…¨èµ„æºï¼šç½‘ç»œä¸Šå­˜åœ¨çš„ä»»ä½•ä¿¡æ¯æºï¼Œæ— è®ºä½äºä½•å¤„ï¼Œå¯¹å…¶éƒ½åº”æŒæ€€ç–‘æ€åº¦ã€‚ èº«ä»½éªŒè¯ï¼šé»˜è®¤æƒ…å†µä¸‹ä¸åº”ä¿¡ä»»æ¥è‡ªå†…éƒ¨æˆ–å¤–éƒ¨ç½‘ç»œçš„ç”¨æˆ·ã€è®¾å¤‡å’Œæµé‡ã€‚é›¶ä¿¡ä»»åº”è¯¥åŸºäºä½¿ç”¨æ­£ç¡®çš„èº«ä»½éªŒè¯å’Œæˆæƒçš„è®¿é—®æ§åˆ¶ã€‚ é›¶ä¿¡ä»»çš„ä¸‰ä¸ªæœ€ä½³å®è·µ Kubernetes æä¾›äº†çµæ´»æ€§ï¼Œæ—¢æ˜¯ä¼˜åŠ¿ä½†ä¹Ÿå¢åŠ äº†å¤æ‚æ€§ï¼Œä¸ºäº†åœ¨ä¸åŒçš„ç½‘ç»œç¯å¢ƒä¸­è¿è¡Œï¼Œä¸ºæœåŠ¡å’Œå·¥ä½œè´Ÿè½½å¼•å…¥äº†è®¸å¤šé…ç½®é€‰é¡¹ã€‚Kubernetes éƒ¨ç½²è€ƒè™‘ä»¥ä¸‹ä¸‰ä¸ªé›¶ä¿¡ä»»æ¨¡å‹çš„æœ€ä½³å®è·µï¼Œä»¥æå‡å®‰å…¨ä¿æŠ¤å’Œå·¥ä½œæ•ˆç‡ã€‚\nä¼˜åŒ–è½¯ä»¶é…ç½®å’Œè®¿é—®æƒé™ å›¢é˜Ÿéœ€è¦ä¸ºæœåŠ¡å’Œè·¨é›†ç¾¤æ“ä½œæä¾›ä¸€è‡´çš„é…ç½®ã€‚è™½ç„¶ Kubernetes æä¾›äº†å¤šç§é…ç½®é€‰é¡¹ï¼Œä½†è¿‡å¤šçš„é€‰é¡¹ä¼šå¢åŠ å®‰å…¨é—®é¢˜å‡ºç°çš„å‡ ç‡ã€‚ä½¿ç”¨é›¶ä¿¡ä»»æ¡†æ¶ï¼Œç»„ç»‡å¯ä»¥å¯¹æœåŠ¡è¿›è¡ŒæŒç»­éªŒè¯å¹¶å°†å…¶éƒ¨ç½²åˆ°å¤šä¸ªé›†ç¾¤ï¼Œè€Œä¸ä¼šå±åŠä»»ä½•å®‰å…¨æ€§ã€‚é€šè¿‡åœ¨æˆäºˆå®ƒä»¬å¯¹åº”ç”¨ç¨‹åºå’ŒæœåŠ¡çš„ä»»ä½•å®‰å…¨æƒé™ä¹‹å‰ä»”ç»†æ£€æŸ¥è¿™äº›é…ç½®ï¼Œç»„ç»‡å¯ä»¥åŠ å¼ºåˆ†å¸ƒå¼ Kubernetes é›†ç¾¤çš„å®‰å…¨æ€§ã€‚\nä½¿ç”¨é›¶ä¿¡ä»»æ¨¡å‹æé«˜ Kubernetes å®‰å…¨æ€§çš„å¦ä¸€ç§æ–¹æ³•æ˜¯åªä¸ºè½¯ä»¶æä¾›è¿è¡Œæ‰€éœ€çš„æƒé™å’ŒåŠŸèƒ½ã€‚è™½ç„¶ç¡®å®šè½¯ä»¶æ‰€éœ€çš„ç¡®åˆ‡æƒé™å’ŒåŠŸèƒ½å¹¶ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ï¼Œä½†æ›´å¥½åœ°äº†è§£è¿™äº›å…ƒç´ å¯ä»¥é™ä½å®‰å…¨é£é™©ã€‚å¯¹äºäº‘ç«¯çš„å®¹å™¨ç¼–æ’ç¯å¢ƒï¼Œç›¸æ¯”æœ¬åœ°ç¯å¢ƒï¼Œèµ‹äºˆæœ‰é™çš„æƒé™å’Œèƒ½åŠ›æ›´ä¸ºé‡è¦ã€‚Â è¯‘è€…æ³¨ï¼šæŒç»­éªŒè¯ã€æœ€å°æƒé™åŸåˆ™\nè®°å½•å’Œç›‘æ§æ•°æ® é‡è¦çš„æ˜¯æä¾›å¿…è¦çš„å®‰å…¨æ•°æ®ï¼Œä½¿å¼€å‘äººå‘˜å’Œå®‰å…¨ä¸“å®¶èƒ½å¤Ÿè¡¡é‡ã€é¢„æµ‹ã€é¿å…å’Œé˜²å¾¡æ½œåœ¨çš„å®‰å…¨é£é™©ã€‚ä¾‹å¦‚ï¼Œç»„ç»‡åº”è¯¥è®°å½•æœåŠ¡è¯†åˆ«çš„ç”¨æˆ· ID æˆ–ç»„ IDï¼Œå°¤å…¶æ˜¯åœ¨é›†ç¾¤ç¯å¢ƒã€‚è¿™å¯ç¡®ä¿ç»„ç»‡ä½¿ç”¨æ‰€éœ€çš„ ID æ¥å¸®åŠ©æœåŠ¡å’Œè½¯ä»¶å›¢é˜Ÿæ›´å¿«åœ°è¯†åˆ«åŒ¿åæ”»å‡»ã€‚æ—¥å¿—è®°å½•ä¹Ÿå°†æ˜¯åœ¨äº‘åŸç”Ÿç¯å¢ƒä¸­æä¾›å®‰å…¨å¯è¿½æº¯æ€§çš„ä¿¡æ¯çš„å…³é”®éƒ¨åˆ†ã€‚\næœ‰äº†è¶³å¤Ÿçš„å®‰å…¨æ•°æ®ï¼Œå›¢é˜Ÿè¿˜å¯ä»¥é‡æ–°æ€è€ƒå’Œä¼˜åŒ–ä»–ä»¬çš„å®‰å…¨å®è·µå’Œåº”ç”¨ç¨‹åºæ›´æ–°ï¼Œä»¥åº”å¯¹ä¸æ–­å˜åŒ–çš„æŠ€æœ¯ç¯å¢ƒï¼Œå¸®åŠ©ç¡®ä¿æŒç»­æŠµå¾¡æ”»å‡»ã€‚\nè¯‘è€…æ³¨ï¼šæä¾›æ•°æ®æ”¯æ’‘\nä¸“æ³¨äºäººå‘˜å’Œæµç¨‹ç®¡ç† é™¤äº†æ¥è‡ªå¤–éƒ¨ç½‘ç»œçš„ç”¨æˆ·å’Œè®¾å¤‡ä¹‹å¤–ï¼Œåˆä½œä¼™ä¼´ã€åˆ©ç›Šç›¸å…³è€…æˆ–ä»»ä½•æœ‰æƒè®¿é—®ç»„ç»‡çš„æ•°æ®åº“å’Œå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„äººéƒ½æ˜¯æ½œåœ¨çš„ Kubernetes å®‰å…¨å¨èƒã€‚å› æ­¤ï¼ŒåŸ¹è®­å†…éƒ¨äººå‘˜ä»¥é¿å…æ½œåœ¨çš„å†…éƒ¨å¨èƒè‡³å…³é‡è¦ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œç»„ç»‡å¯ä»¥ä»è®°å½•å’Œç›‘æ§å¹³å°æ•°æ®å¼€å§‹ï¼ŒåŒæ—¶è®©æ‰€æœ‰åˆ©ç›Šç›¸å…³è€…äº†è§£å¸‚åœºä¸Šæ™®éå­˜åœ¨çš„å„ç§æ”»å‡»ç­–ç•¥ã€‚\né™¤äº†é€‚å½“çš„åŸ¹è®­ä¹‹å¤–ï¼Œä¼˜åŒ–æ—¥å¸¸è¿è¥ä¸­çš„å®‰å…¨æµç¨‹æœ‰åŠ©äºæ”¯æ’‘é›¶ä¿¡ä»»æ¨¡å‹ï¼Œå¹¶æœ€å¤§é™åº¦åœ°å‡å°‘ç½‘ç»œæ”»å‡»å¯¹ä¼ä¸šäº‘ä¸ŠæœåŠ¡çš„å½±å“ã€‚ä¸€äº›æ¨èçš„å®‰å…¨æµç¨‹åŒ…æ‹¬ç§¯æå®¡æŸ¥ç½‘ç»œç®¡ç†ã€é˜²ç«å¢™æ¸…å•ä»¥åŠå®šæœŸæ£€æŸ¥å®¹å™¨å’Œè½¯ä»¶é•œåƒã€‚\nç”±äº air-gapped ä¸ºäº‘ä¸­çš„å¤æ‚éƒ¨ç½²æ¨¡å¼æä¾›äº†å†›äº‹çº§å®‰å…¨çº§åˆ«ï¼Œæˆ‘å»ºè®®ç»„ç»‡å°†è¿™äº›æ“ä½œæµç¨‹ä¸ air-gapped å®ç°ç›¸ç»“åˆï¼Œä¸º Kubernetes é¡¹ç›®æä¾›é¢å¤–çš„å®‰å…¨çº§åˆ«ã€‚Â è¯‘è€…æ³¨ï¼šäººå‘˜åŸ¹è®­ã€æµç¨‹çº¦æŸå¿…ä¸å¯å°‘\nç»“è®º åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²å’Œç®¡ç† Kubernetes æ—¶ï¼Œå®‰å…¨æ€§ä¸å†æ˜¯äº‹åçš„æƒ³æ³•ã€‚è¿è§„ã€ä¸­æ–­å’Œæ•°æ®ç›—çªƒæ˜¯ä¸¥é‡çš„ç½‘ç»œå®‰å…¨é—®é¢˜ï¼Œå¯èƒ½å¯¹ç»„ç»‡äº§ç”Ÿä¸åˆ©å½±å“ã€‚æ•°æ®å’Œä¿¡æ¯è®°å½•ã€å‘˜å·¥å®‰å…¨åŸ¹è®­å’Œæµç¨‹ä¼˜åŒ–ç­‰é›¶ä¿¡ä»»å®è·µæ˜¯ä¿æŠ¤ Kubernetes é¡¹ç›®å’Œ IT åŸºç¡€æ¶æ„çš„æœ‰æ•ˆä¸”å®ç”¨çš„æ–¹æ³•ã€‚é€šè¿‡å®æ–½è¿™äº›å®è·µï¼Œç»„ç»‡å¯ä»¥æ›´å¥½åœ°ä¿æŠ¤ Kubernetes éƒ¨ç½²ã€‚éµå¾ªè¿™ç§é›¶ä¿¡ä»»æ¨¡å‹å°†ä½¿å¼€å‘äººå‘˜å’Œè¿ç»´äººå‘˜æ— éœ€æ‹…å¿ƒé›†ç¾¤å’ŒåŸºç¡€è®¾æ–½å®‰å…¨é—®é¢˜ï¼ŒåŒæ—¶ä½¿å®‰å…¨å›¢é˜Ÿèƒ½å¤Ÿä¸“æ³¨äºå®‰å…¨æ€§ï¼Œè€Œä¸æ˜¯è¿·å¤±åœ¨ Kubernetes é…ç½®ä¸­ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/29/16722890416327.png","permalink":"https://atbug.com/implementing-zero-trust-on-kubernetes/","tags":["å®‰å…¨","Kubernetes","é›¶ä¿¡ä»»"],"title":"è¯‘ï¼šåœ¨ Kubernetes ä¸Šå®æ–½é›¶ä¿¡ä»»"},{"categories":["ç¬”è®°"],"contents":"è¿™æ˜¯ Kubernetes ç½‘ç»œå­¦ä¹ çš„ç¬¬å››ç¯‡ç¬”è®°ã€‚\næ·±å…¥æ¢ç´¢ Kubernetes ç½‘ç»œæ¨¡å‹å’Œç½‘ç»œé€šä¿¡ è®¤è¯†ä¸€ä¸‹å®¹å™¨ç½‘ç»œæ¥å£ CNI æºç åˆ†æï¼šä» kubeletã€å®¹å™¨è¿è¡Œæ—¶çœ‹ CNI çš„ä½¿ç”¨ ä» Flannel å­¦ä¹  Kubernetes VXLAN ç½‘ç»œï¼ˆæœ¬ç¯‡ï¼‰ Kubernetes ç½‘ç»œå­¦ä¹ ä¹‹ Cilium ä¸ eBPF \u0026hellip; Flannel ä»‹ç» Flannel æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ overlay ç½‘ç»œï¼ˆVXLANï¼‰ï¼Œæ˜¯ Kubernetes ç½‘ç»œ CNI çš„è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚Flannel åœ¨æ¯å°ä¸»æœºä¸Šè¿è¡Œä¸€ä¸ªç®€å•çš„è½»é‡çº§ agent flanneld æ¥ç›‘å¬é›†ç¾¤ä¸­èŠ‚ç‚¹çš„å˜æ›´ï¼Œå¹¶å¯¹åœ°å€ç©ºé—´è¿›è¡Œé¢„é…ç½®ã€‚Flannel è¿˜ä¼šåœ¨æ¯å°ä¸»æœºä¸Šå®‰è£… vtep flannel.1ï¼ˆVXLAN tunnel endpointsï¼‰ï¼Œä¸å…¶ä»–ä¸»æœºé€šè¿‡ VXLAN éš§é“ç›¸è¿ã€‚\nflanneld ç›‘å¬åœ¨ 8472 ç«¯å£ï¼Œé€šè¿‡ UDP ä¸å…¶ä»–èŠ‚ç‚¹çš„ vtep è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚åˆ°è¾¾ vtep çš„äºŒå±‚åŒ…ä¼šè¢«åŸå°ä¸åŠ¨åœ°é€šè¿‡ UDP çš„æ–¹å¼å‘é€åˆ°å¯¹ç«¯çš„ vtepï¼Œç„¶åæ‹†å‡ºäºŒå±‚åŒ…è¿›è¡Œå¤„ç†ã€‚ç®€å•è¯´å°±æ˜¯ç”¨å››å±‚çš„ UDP ä¼ è¾“äºŒå±‚çš„æ•°æ®å¸§ã€‚\nåœ¨ Kubernetes å‘è¡Œç‰ˆ K3S ä¸­å°† Flannel ä½œä¸ºé»˜è®¤çš„ CNI å®ç°ã€‚K3S é›†æˆäº† flannelï¼Œåœ¨å¯åŠ¨å flannel ä»¥ go routine çš„æ–¹å¼è¿è¡Œã€‚\nç¯å¢ƒæ­å»º Kubernetes é›†ç¾¤ä½¿ç”¨ k3s å‘è¡Œç‰ˆï¼Œä½†åœ¨å®‰è£…é›†ç¾¤çš„æ—¶å€™ï¼Œç¦ç”¨ k3s é›†æˆçš„ flannelï¼Œä½¿ç”¨ç‹¬ç«‹å®‰è£…çš„ flannel è¿›è¡ŒéªŒè¯ã€‚\nå®‰è£… CNI çš„ pluginï¼Œéœ€è¦åœ¨æ‰€æœ‰çš„ node èŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä¸‹è½½ CNI çš„å®˜æ–¹ binã€‚\nsudo mkdir -p /opt/cni/bin curl -sSL https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz | sudo tar -zxf - -C /opt/cni/bin å®‰è£… k3s çš„æ§åˆ¶å¹³é¢ã€‚\nexport INSTALL_K3S_VERSION=v1.23.8+k3s2 curl -sfL https://get.k3s.io | sh -s - --disable traefik --flannel-backend=none --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config å®‰è£… Flannelã€‚è¿™é‡Œæ³¨æ„ï¼ŒFlannel é»˜è®¤çš„ Pod CIDR æ˜¯ 10.244.0.0/16ï¼Œæˆ‘ä»¬å°†å…¶ä¿®æ”¹ä¸º k3s é»˜è®¤çš„ 10.42.0.0/16ã€‚\ncurl -s https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml | sed \u0026#39;s|10.244.0.0/16|10.42.0.0/16|g\u0026#39; | kubectl apply -f - æ·»åŠ å¦ä¸€ä¸ªèŠ‚ç‚¹åˆ°é›†ç¾¤ã€‚\nexport INSTALL_K3S_VERSION=v1.23.8+k3s2 export MASTER_IP=\u0026lt;MASTER_IP\u0026gt; export NODE_TOKEN=\u0026lt;TOKEN\u0026gt; curl -sfL https://get.k3s.io | K3S_URL=https://${MASTER_IP}:6443 K3S_TOKEN=${NODE_TOKEN} sh - æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ã€‚\nkubectl get node NAME STATUS ROLES AGE VERSION ubuntu-dev3 Ready \u0026lt;none\u0026gt; 13m v1.23.8+k3s2 ubuntu-dev2 Ready control-plane,master 17m v1.23.8+k3s2 è¿è¡Œä¸¤ä¸ª podï¼šcurl å’Œ httpbinï¼Œä¸ºäº†æ¢å¯»\nNODE1=ubuntu-dev2 NODE2=ubuntu-dev3 kubectl apply -n default -f - \u0026lt;\u0026lt;EOF apiVersion: v1 kind: Pod metadata: labels: app: curl name: curl spec: containers: - image: curlimages/curl name: curl command: [\u0026#34;sleep\u0026#34;, \u0026#34;365d\u0026#34;] nodeName: $NODE1 --- apiVersion: v1 kind: Pod metadata: labels: app: httpbin name: httpbin spec: containers: - image: kennethreitz/httpbin name: httpbin nodeName: $NODE2 EOF ç½‘ç»œé…ç½® æ¥ä¸‹æ¥ï¼Œä¸€èµ·çœ‹ä¸‹ CNI æ’ä»¶å¦‚ä½•é…ç½® pod ç½‘ç»œã€‚\nåˆå§‹åŒ– Flannel æ˜¯é€šè¿‡ Daemonset çš„æ–¹å¼éƒ¨ç½²çš„ï¼Œæ¯å°èŠ‚ç‚¹ä¸Šéƒ½ä¼šè¿è¡Œä¸€ä¸ª flannel çš„ podã€‚é€šè¿‡æŒ‚è½½æœ¬åœ°ç£ç›˜çš„æ–¹å¼ï¼Œåœ¨ Pod å¯åŠ¨æ—¶ä¼šé€šè¿‡åˆå§‹åŒ–å®¹å™¨å°†äºŒè¿›åˆ¶æ–‡ä»¶å’Œ CNI çš„é…ç½®å¤åˆ¶åˆ°æœ¬åœ°ç£ç›˜ä¸­ï¼Œåˆ†åˆ«ä½äº /opt/cni/bin/flannel å’Œ /etc/cni/net.d/10-flannel.conflistã€‚\né€šè¿‡æŸ¥çœ‹ kube-flannel.yml ä¸­çš„ ConfigMapï¼Œå¯ä»¥æ‰¾åˆ° CNI é…ç½®ï¼Œflannel é»˜è®¤å§”æ‰˜ï¼ˆè§ flannel-cni æºç  flannel_linux.go#L78ï¼‰ç»™ bridge æ’ä»¶ è¿›è¡Œç½‘ç»œé…ç½®ï¼Œç½‘ç»œåç§°ä¸º cbr0ï¼›IP åœ°å€çš„ç®¡ç†ï¼Œé»˜è®¤å§”æ‰˜ï¼ˆè§ flannel-cni æºç  flannel_linux.go#L40ï¼‰ host-local æ’ä»¶ å®Œæˆã€‚\n#cni-conf.json å¤åˆ¶åˆ° /etc/cni/net.d/10-flannel.conflist { \u0026#34;name\u0026#34;: \u0026#34;cbr0\u0026#34;, \u0026#34;cniVersion\u0026#34;: \u0026#34;0.3.1\u0026#34;, \u0026#34;plugins\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;flannel\u0026#34;, \u0026#34;delegate\u0026#34;: { \u0026#34;hairpinMode\u0026#34;: true, \u0026#34;isDefaultGateway\u0026#34;: true } }, { \u0026#34;type\u0026#34;: \u0026#34;portmap\u0026#34;, \u0026#34;capabilities\u0026#34;: { \u0026#34;portMappings\u0026#34;: true } } ] } è¿˜æœ‰ Flannel çš„ç½‘ç»œé…ç½®ï¼Œé…ç½®æœ‰æˆ‘ä»¬è®¾ç½®çš„ Pod CIDR 10.42.0.0/16 ä»¥åŠåç«¯ï¼ˆbackendï¼‰çš„ç±»å‹ vxlanã€‚è¿™ä¹Ÿæ˜¯ flannel é»˜è®¤çš„ç±»å‹ï¼Œæ­¤å¤–è¿˜æœ‰ å¤šç§åç«¯ç±»å‹ å¯é€‰ï¼Œå¦‚ host-gwã€wireguardã€udpã€Allocã€IPIPã€IPSecã€‚\n#net-conf.json æŒ‚è½½åˆ° pod çš„ /etc/kube-flannel/net-conf.json { \u0026#34;Network\u0026#34;: \u0026#34;10.42.0.0/16\u0026#34;, \u0026#34;Backend\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;vxlan\u0026#34; } } Flannel Pod è¿è¡Œå¯åŠ¨ flanneld è¿›ç¨‹ï¼ŒæŒ‡å®šäº†å‚æ•° --ip-masq å’Œ --kube-subnet-mgrï¼Œåè€…å¼€å¯äº† kube subnet manager æ¨¡å¼ã€‚\nè¿è¡Œ é›†ç¾¤åˆå§‹åŒ–æ—¶ä½¿ç”¨äº†é»˜è®¤çš„ Pod CIDR 10.42.0.0/16ï¼Œå½“æœ‰èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼Œé›†ç¾¤ä¼šä»è¯¥ç½‘æ®µä¸Šä¸ºèŠ‚ç‚¹åˆ†é… å±äºèŠ‚ç‚¹çš„ Pod CIDR 10.42.X.1/24ã€‚\nflannel åœ¨ kube subnet manager æ¨¡å¼ä¸‹ï¼Œè¿æ¥åˆ° apiserver ç›‘å¬èŠ‚ç‚¹æ›´æ–°çš„äº‹ä»¶ï¼Œä»èŠ‚ç‚¹ä¿¡æ¯ä¸­è·å–èŠ‚ç‚¹çš„ Pod CIDRã€‚\nkubectl get no ubuntu-dev2 -o jsonpath={.spec} | jq { \u0026#34;podCIDR\u0026#34;: \u0026#34;10.42.0.0/24\u0026#34;, \u0026#34;podCIDRs\u0026#34;: [ \u0026#34;10.42.0.0/24\u0026#34; ], \u0026#34;providerID\u0026#34;: \u0026#34;k3s://ubuntu-dev2\u0026#34; } ç„¶ååœ¨ä¸»æœºä¸Šå†™å­ç½‘é…ç½®æ–‡ä»¶ï¼Œä¸‹é¢å±•ç¤ºçš„æ˜¯å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹çš„å­ç½‘é…ç½®æ–‡ä»¶çš„å†…å®¹ã€‚å¦ä¸€ä¸ªèŠ‚ç‚¹çš„å†…å®¹å·®å¼‚åœ¨ FLANNEL_SUBNET=10.42.1.1/24ï¼Œä½¿ç”¨çš„æ˜¯å¯¹åº”èŠ‚ç‚¹çš„ Pod CIDRã€‚\n#node 192.168.1.12 cat /run/flannel/subnet.env FLANNEL_NETWORK=10.42.0.0/16 FLANNEL_SUBNET=10.42.0.1/24 FLANNEL_MTU=1450 FLANNEL_IPMASQ=true CNI æ’ä»¶æ‰§è¡Œ CNI æ’ä»¶çš„æ‰§è¡Œæ˜¯ç”±å®¹å™¨è¿è¡Œæ—¶è§¦å‘çš„ï¼Œå…·ä½“ç»†èŠ‚å¯ä»¥çœ‹ä¸Šä¸€ç¯‡ ã€Šæºç è§£æï¼šä» kubeletã€å®¹å™¨è¿è¡Œæ—¶çœ‹ CNI çš„ä½¿ç”¨ã€‹ã€‚\nflannel æ’ä»¶ flannel CNI æ’ä»¶ï¼ˆ/opt/cni/bin/flannelï¼‰æ‰§è¡Œçš„æ—¶å€™ï¼Œæ¥æ”¶ä¼ å…¥çš„ cni-conf.jsonï¼Œè¯»å–ä¸Šé¢åˆå§‹åŒ–å¥½çš„ subnet.env çš„é…ç½®ï¼Œè¾“å‡ºç»“æœï¼Œå§”æ‰˜ç»™ bridge è¿›è¡Œä¸‹ä¸€æ­¥ã€‚\ncat /var/lib/cni/flannel/e4239ab2706ed9191543a5c7f1ef06fc1f0a56346b0c3f2c742d52607ea271f0 | jq { \u0026#34;cniVersion\u0026#34;: \u0026#34;0.3.1\u0026#34;, \u0026#34;hairpinMode\u0026#34;: true, \u0026#34;ipMasq\u0026#34;: false, \u0026#34;ipam\u0026#34;: { \u0026#34;ranges\u0026#34;: [ [ { \u0026#34;subnet\u0026#34;: \u0026#34;10.42.0.0/24\u0026#34; } ] ], \u0026#34;routes\u0026#34;: [ { \u0026#34;dst\u0026#34;: \u0026#34;10.42.0.0/16\u0026#34; } ], \u0026#34;type\u0026#34;: \u0026#34;host-local\u0026#34; }, \u0026#34;isDefaultGateway\u0026#34;: true, \u0026#34;isGateway\u0026#34;: true, \u0026#34;mtu\u0026#34;: 1450, \u0026#34;name\u0026#34;: \u0026#34;cbr0\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;bridge\u0026#34; } bridge æ’ä»¶ bridge ä½¿ç”¨ä¸Šé¢çš„è¾“å‡ºè¿åŒå‚æ•°ä¸€èµ·ä½œä¸ºè¾“å…¥ï¼Œæ ¹æ®é…ç½®å®Œæˆå¦‚ä¸‹æ“ä½œï¼š\nåˆ›å»ºç½‘æ¡¥ cni0ï¼ˆèŠ‚ç‚¹çš„æ ¹ç½‘ç»œå‘½åç©ºé—´ï¼‰ åˆ›å»ºå®¹å™¨ç½‘ç»œæ¥å£ eth0ï¼ˆ pod ç½‘ç»œå‘½åç©ºé—´ï¼‰ åˆ›å»ºä¸»æœºä¸Šçš„è™šæ‹Ÿç½‘ç»œæ¥å£ vethXï¼ˆèŠ‚ç‚¹çš„æ ¹ç½‘ç»œå‘½åç©ºé—´ï¼‰ å°† vethX è¿æ¥åˆ°ç½‘æ¡¥ cni0 å§”æ‰˜ ipam æ’ä»¶åˆ†é… IP åœ°å€ã€DNSã€è·¯ç”± å°† IP åœ°å€ç»‘å®šåˆ° pod ç½‘ç»œå‘½åç©ºé—´çš„æ¥å£ eth0 ä¸Š æ£€æŸ¥ç½‘æ¡¥çŠ¶æ€ è®¾ç½®è·¯ç”± è®¾ç½® DNS æœ€åè¾“å‡ºå¦‚ä¸‹çš„ç»“æœï¼š\ncat /var/li/cni/results/cbr0-a34bb3dc268e99e6e1ef83c732f5619ca89924b646766d1ef352de90dbd1c750-eth0 | jq .result { \u0026#34;cniVersion\u0026#34;: \u0026#34;0.3.1\u0026#34;, \u0026#34;dns\u0026#34;: {}, \u0026#34;interfaces\u0026#34;: [ { \u0026#34;mac\u0026#34;: \u0026#34;6a:0f:94:28:9b:e7\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;cni0\u0026#34; }, { \u0026#34;mac\u0026#34;: \u0026#34;ca:b4:a9:83:0f:d4\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;veth38b50fb4\u0026#34; }, { \u0026#34;mac\u0026#34;: \u0026#34;0a:01:c5:6f:57:67\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;eth0\u0026#34;, \u0026#34;sandbox\u0026#34;: \u0026#34;/var/run/netns/cni-44bb41bd-7c41-4860-3c55-4323bc279628\u0026#34; } ], \u0026#34;ips\u0026#34;: [ { \u0026#34;address\u0026#34;: \u0026#34;10.42.0.5/24\u0026#34;, \u0026#34;gateway\u0026#34;: \u0026#34;10.42.0.1\u0026#34;, \u0026#34;interface\u0026#34;: 2, \u0026#34;version\u0026#34;: \u0026#34;4\u0026#34; } ], \u0026#34;routes\u0026#34;: [ { \u0026#34;dst\u0026#34;: \u0026#34;10.42.0.0/16\u0026#34; }, { \u0026#34;dst\u0026#34;: \u0026#34;0.0.0.0/0\u0026#34;, \u0026#34;gw\u0026#34;: \u0026#34;10.42.0.1\u0026#34; } ] } port-mapping æ’ä»¶ è¯¥æ’ä»¶ä¼šå°†æ¥è‡ªä¸»æœºä¸Šä¸€ä¸ªæˆ–å¤šä¸ªç«¯å£çš„æµé‡è½¬å‘åˆ°å®¹å™¨ã€‚\nDebug è®©æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä½¿ç”¨ tcpdump å¯¹æ¥å£ cni0 è¿›è¡ŒæŠ“åŒ…ã€‚\ntcpdump -i cni0 port 80 -vvv ä» pod curl ä¸­ä½¿ç”¨ pod httpbin çš„ IP åœ°å€ 10.42.1.2 å‘é€è¯·æ±‚ï¼š\nkubectl exec curl -n default -- curl -s 10.42.1.2/get cni0 ä»åœ¨ cni0 ä¸Šçš„æŠ“åŒ…ç»“æœæ¥çœ‹ï¼Œç¬¬ä¸‰å±‚çš„ IP åœ°å€å‡ä¸º Pod çš„ IP åœ°å€ï¼Œçœ‹èµ·æ¥å°±åƒæ˜¯ä¸¤ä¸ª pod éƒ½åœ¨åŒä¸€ä¸ªç½‘æ®µã€‚\nhost eth0 æ–‡ç« å¼€å¤´æåˆ° flanneld ç›‘å¬ udp 8472 ç«¯å£ã€‚\nnetstat -tupln | grep 8472 udp 0 0 0.0.0.0:8472 0.0.0.0:* - æˆ‘ä»¬ç›´æ¥åœ¨ä»¥å¤ªç½‘æ¥å£ä¸ŠæŠ“å– UDP çš„åŒ…ï¼š\ntcpdump -i eth0 port 8472 -vvv å†æ¬¡å‘é€è¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°æŠ“å–åˆ° UDP æ•°æ®åŒ…ï¼Œä¼ è¾“çš„è´Ÿè½½æ˜¯äºŒå±‚çš„å°åŒ…ã€‚\nOverlay ç½‘ç»œä¸‹çš„è·¨èŠ‚ç‚¹é€šä¿¡ åœ¨ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬ç ”ç©¶ pod é—´çš„é€šä¿¡æ—¶æåˆ°ä¸åŒ CNI æ’ä»¶çš„å¤„ç†æ–¹å¼ä¸åŒï¼Œè¿™æ¬¡æˆ‘ä»¬æ¢ç´¢äº† flannel æ’ä»¶çš„å·¥ä½œåŸç†ã€‚å¸Œæœ›é€šè¿‡ä¸‹é¢çš„å›¾å¯ä»¥å¯¹ overlay ç½‘ç»œå¤„ç†è·¨èŠ‚ç‚¹çš„ç½‘ç»œé€šä¿¡æœ‰ä¸ªæ¯”è¾ƒç›´è§‚çš„è®¤è¯†ã€‚\nå½“å‘é€åˆ° 10.42.1.2 æµé‡åˆ°è¾¾èŠ‚ç‚¹ A çš„ç½‘æ¡¥ cni0ï¼Œç”±äºç›®æ ‡ IP å¹¶ä¸å±äºå½“å‰é˜¶æ®µçš„ç½‘æ®µã€‚æ ¹æ®ç³»ç»Ÿçš„è·¯ç”±è§„åˆ™ï¼Œè¿›å…¥åˆ°æ¥å£ flannel.1ï¼Œä¹Ÿå°±æ˜¯ VXLAN çš„ vtepã€‚è¿™é‡Œçš„è·¯ç”±è§„åˆ™ä¹Ÿç”± flanneld æ¥ç»´æŠ¤ï¼Œå½“èŠ‚ç‚¹ä¸Šçº¿æˆ–è€…ä¸‹çº¿æ—¶ï¼Œéƒ½ä¼šæ›´æ–°è·¯ç”±è§„åˆ™ã€‚\n#192.168.1.12 Destination Gateway Genmask Flags Metric Ref Use Iface default _gateway 0.0.0.0 UG 0 0 0 eth0 10.42.0.0 0.0.0.0 255.255.255.0 U 0 0 0 cni0 10.42.1.0 10.42.1.0 255.255.255.0 UG 0 0 0 flannel.1 192.168.1.0 0.0.0.0 255.255.255.0 U 0 0 0 eth0 #192.168.1.13 Destination Gateway Genmask Flags Metric Ref Use Iface default _gateway 0.0.0.0 UG 0 0 0 eth0 10.42.0.0 10.42.0.0 255.255.255.0 UG 0 0 0 flannel.1 10.42.1.0 0.0.0.0 255.255.255.0 U 0 0 0 cni0 192.168.1.0 0.0.0.0 255.255.255.0 U 0 0 0 eth0 flannel.1 å°†åŸå§‹çš„ä»¥å¤ªå°åŒ…ä½¿ç”¨ UDP åè®®é‡æ–°å°è£…ï¼Œå°†å…¶å‘é€åˆ°ç›®æ ‡åœ°å€ 10.42.1.0 ï¼ˆç›®æ ‡çš„ MAC åœ°å€é€šè¿‡ ARP è·å–ï¼‰ã€‚å¯¹ç«¯çš„ vtep ä¹Ÿå°±æ˜¯ flannel.1 çš„ UDP ç«¯å£ 8472 æ”¶åˆ°æ¶ˆæ¯ï¼Œè§£å¸§å‡ºä»¥å¤ªå°åŒ…ï¼Œç„¶åå¯¹ä»¥å¤ªå°åŒ…è¿›è¡Œè·¯ç”±å¤„ç†ï¼Œå‘é€åˆ°æ¥å£ cni0ï¼Œæœ€ç»ˆåˆ°è¾¾ç›®æ ‡ pod ä¸­ã€‚\nå“åº”çš„æ•°æ®ä¼ è¾“ä¸è¯·æ±‚çš„å¤„ç†ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œåªæ˜¯æºåœ°å€å’Œç›®çš„åœ°å€è°ƒæ¢ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/14/pexelsdickscholten1096793.jpg","permalink":"https://atbug.com/cross-node-traffic-on-flannel-vxlan-network/","tags":["Kubernetes","ç½‘ç»œ","CNI"],"title":"ä» Flannel å­¦ä¹  Kubernetes overlay ç½‘ç»œ"},{"categories":["ç¬”è®°","æºç è§£æ"],"contents":"è¿™æ˜¯ Kubernetes ç½‘ç»œå­¦ä¹ çš„ç¬¬ä¸‰ç¯‡ç¬”è®°ã€‚\næ·±å…¥æ¢ç´¢ Kubernetes ç½‘ç»œæ¨¡å‹å’Œç½‘ç»œé€šä¿¡ è®¤è¯†ä¸€ä¸‹å®¹å™¨ç½‘ç»œæ¥å£ CNI æºç åˆ†æï¼šä» kubeletã€å®¹å™¨è¿è¡Œæ—¶çœ‹ CNI çš„ä½¿ç”¨ï¼ˆæœ¬ç¯‡ï¼‰ ä» Flannel å­¦ä¹  Kubernetes VXLAN ç½‘ç»œ Kubernetes ç½‘ç»œå­¦ä¹ ä¹‹ Cilium ä¸ eBPF \u0026hellip; åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œé€šè¿‡å¯¹ CNI è§„èŒƒçš„è§£è¯»äº†è§£äº†ç½‘ç»œé…ç½®çš„æ“ä½œå’Œç›¸å…³çš„æµç¨‹ã€‚åœ¨ç½‘ç»œçš„å‡ ä¸ªæ“ä½œä¸­é™¤äº† CNI_COMMAND å¤–ï¼Œæœ‰å¦å¤–ä¸‰ä¸ªå‚æ•°å‡ ä¹æ¯æ¬¡éƒ½è¦æä¾› CNI_CONTAINERIDã€CNI_IFNAME å’Œ CNI_NETNSï¼Œè¿™äº›å‚æ•°æ— å¤–ä¹éƒ½æ¥è‡ªå®¹å™¨è¿è¡Œæ—¶ã€‚è¿™ç¯‡å°†ç»“åˆ Kubernetes å’Œ Containerd æºç ï¼Œæ¥åˆ†æä¸€ä¸‹ CNI çš„ä½¿ç”¨ã€‚\nKubernetes çš„æºç æ¥è‡ªåˆ†æ”¯ release-1.24ï¼ŒContainerd çš„æ¥è‡ªåˆ†æ”¯ release/1.6ã€‚\nCNI çš„ä½¿ç”¨ åˆ›å»º Pod åœ¨ä¹‹å‰åšè¿‡çš„ kubelet æºç åˆ†æ ä¸­æ›¾æåˆ° Kubelet#syncLoop() ä¼šæŒç»­ç›‘æ§æ¥è‡ª æ–‡ä»¶ã€apiserverã€http çš„å˜æ›´ï¼Œæ¥æ›´æ–° pod çš„çŠ¶æ€ã€‚å†™é‚£ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œåˆ†æåˆ°è¿™é‡Œå°±ç»“æŸäº†ã€‚å› ä¸ºè¿™ä¹‹åçš„å·¥ä½œå°±äº¤ç»™å®¹å™¨è¿è¡Œæ—¶æ¥å®Œæˆ sandbox å’Œå„ç§å®¹å™¨çš„åˆ›å»ºå’Œè¿è¡Œï¼Œè§ kubeGenericRuntimeManager#SyncPod()ã€‚\nkubelet å°è£… sandbox å’Œå®¹å™¨åˆ›å»ºã€è¿è¡Œè¯·æ±‚ï¼Œè°ƒç”¨å®¹å™¨è¿è¡Œæ—¶çš„æ¥å£ï¼Œå°†å…·ä½“å·¥ä½œäº¤ç”±å®¹å™¨è¿è¡Œæ—¶æ¥å®Œæˆæ¥å®Œæˆï¼ˆå®¹å™¨è¿è¡Œæ—¶æ¥å£ Container Runtime Interfaceï¼Œç®€ç§° CRIï¼Œæ‰¾æ—¶é—´å†è¿›è¡Œç ”ç©¶ï¼‰ã€‚\nå‚è€ƒæºç  pkg/kubelet/kubelet.go:1985 pkg/kubelet/kuberuntime/kuberuntime_manager.go:711 Sandbox å®¹å™¨ è®°å¾—åœ¨ ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ ä¸­ï¼Œå½“æˆ‘ä»¬åœ¨èŠ‚ç‚¹ä¸ŠæŸ¥çœ‹å‘½åç©ºé—´æ—¶ï¼Œç½‘ç»œå‘½åç©ºé—´çš„è¿›ç¨‹æ˜¯ /pause ã€‚\nlsns -t net NS TYPE NPROCS PID USER NETNSID NSFS COMMAND 4026531992 net 126 1 root unassigned /lib/systemd/systemd --system --deserialize 31 4026532247 net 1 83224 uuidd unassigned /usr/sbin/uuidd --socket-activation 4026532317 net 4 129820 65535 0 /run/netns/cni-607c5530-b6d8-ba57-420e-a467d7b10c56 /pause Kubernetes åœ¨åˆ›å»º pod æ—¶ï¼Œä¼šå…ˆä¸€ä¸ª sandbox å®¹å™¨ï¼ˆä½¿ç”¨ pause é•œåƒï¼Œå¯åŠ¨æ—¶æ‰§è¡Œ /pause è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼‰ã€‚æˆ‘ä»¬çŸ¥é“ Kubernetes çš„ pod ä¸­æ˜¯å…è®¸å¤šå®¹å™¨çš„ï¼Œç”±è¿™ä¸ª sandbox å®¹å™¨æ¥åˆ›å»ºå’Œç»´æŒç½‘ç»œå‘½åç©ºé—´ï¼Œpod çš„å…¶ä»–å®¹å™¨ä¼šåŠ å…¥åˆ°è¯¥å‘½åç©ºé—´ä¸­ã€‚å› ä¸º pause é•œåƒè¶³å¤Ÿç®€å•ï¼Œä¸ä¼šå‡ºé”™å¯¼è‡´ç½‘ç»œç®¡ç†ç©ºé—´åœ¨å‡ºé”™æ—¶è¢«åˆ é™¤ã€‚sandbox å®¹å™¨å‘æŒ¥ç€è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œå®ƒåœ¨ PID è¿›ç¨‹ç©ºé—´çš„è¿›ç¨‹æ ‘ä¸­ä½œä¸º PID ä¸º 1 çš„è¿›ç¨‹ï¼Œå…¶ä»–å®¹å™¨è¿›ç¨‹éƒ½å°†å…¶ä½œä¸ºçˆ¶è¿›ç¨‹ã€‚å½“å…¶ä»–å®¹å™¨çš„è¿›ç¨‹æˆä¸ºå­¤å„¿è¿›ç¨‹æ—¶ï¼Œå¯ä»¥å¾—åˆ°æ¸…ç†ã€‚\nåˆ›å»º Sandbox å®¹å™¨ CRI çš„ RuntimeServiceServer å®šä¹‰äº†è¿è¡Œæ—¶å¯¹å¤–æä¾›çš„æœåŠ¡æ¥å£ï¼Œé™¤äº†ç®¡ç† sandboxã€å®¹å™¨ç›¸å…³çš„æ“ä½œå¤–ï¼Œè¿˜æœ‰ streaming ç›¸å…³çš„æ“ä½œï¼Œå³å¸¸ç”¨çš„ execã€attachã€portforwardã€‚streaming ç›¸å…³çš„å†…å®¹ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„ä¸€ç¯‡ ã€Šæºç è§£æ kubectl port-forward å·¥ä½œåŸç†ã€‹ã€‚\nè®©æˆ‘ä»¬æ¥çœ‹å®¹å™¨ç›¸å…³çš„éƒ¨åˆ†ã€‚\nContainerd çš„ criService å®ç°äº† RuntimeServiceServer çš„æ¥å£ã€‚åˆ›å»º sandbox å®¹å™¨çš„è¯·æ±‚é€šè¿‡ CRI çš„ UDSï¼ˆUnix domain socketï¼‰ æ¥å£ /runtime.v1.RuntimeService/RunPodSandboxï¼Œè¿›å…¥åˆ° criService çš„å¤„ç†æµç¨‹ä¸­ã€‚åœ¨ criService#RunPodSandbox()ï¼Œè´Ÿè´£åˆ›å»ºå’Œè¿è¡Œ sandbox å®¹å™¨ï¼Œå¹¶ä¿è¯å®¹å™¨çŠ¶æ€æ­£å¸¸ã€‚\nå®¹å™¨è¿è¡Œæ—¶é¦–å…ˆåˆå§‹åŒ–å®¹å™¨å¯¹è±¡ï¼Œäº§ç”Ÿå¿…è¦çš„å‚æ•° CNI_CONTAINERID ä¼šåˆ›å»º pod ç½‘ç»œå‘½åç©ºé—´ï¼Œäº§ç”Ÿå¿…è¦çš„å‚æ•° CNI_NETNS ç„¶åè°ƒç”¨ CNI çš„æ¥å£æ¥å¯¹ pod çš„ç½‘ç»œç©ºé—´è¿›è¡Œé…ç½®ï¼Œæ¯”å¦‚åˆ›å»ºç½‘ç»œæ¥å£ã€åˆ†é… IP åœ°å€ã€åˆ›å»º vethã€è®¾ç½®è·¯ç”±ç­‰ç­‰ä¸€ç³»åˆ—çš„æ“ä½œã€‚è¿™äº›æ“ä½œæ­£æ˜¯ç”±å…·ä½“çš„ç½‘ç»œæ’ä»¶å®ç°å®Œæˆï¼Œä¸åŒæ’ä»¶ä¹‹é—´çš„å®ç°å­˜åœ¨å·®å¼‚ã€‚äº†è§£äº†è§„èŒƒä¹‹åä¹‹åï¼Œç½‘ç»œçš„é…ç½®å°±ä¸éš¾äº†ï¼Œå…¶ä¸­ 2 å’Œ 3 å¯èƒ½æ‰§è¡Œå¤šæ¬¡ï¼š è¯»å–ç½‘ç»œé…ç½® æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶ æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ å‘å®¹å™¨è¿è¡Œæ—¶åé¦ˆç»“æœ æœ€åä¾¿æ˜¯åˆ›å»º sandbox å®¹å™¨ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸æ“ä½œç³»ç»Ÿçš„ç±»å‹ç›¸å…³ï¼Œä¼šè°ƒç”¨å¯¹åº”æ“ä½œç³»ç»Ÿçš„æ–¹æ³•æ¥å®Œæˆå®¹å™¨çš„åˆ›å»ºã€‚ ä»é›¶å¼€å§‹å­¦ä¹ å®¹å™¨ï¼Œæ¨èé˜…è¯» Ivan Velichko çš„ ã€ŠLearning Containers From The Bottom Upã€‹\nå‚è€ƒæºç ï¼š pkg/cri/server/sandbox_run.go:61 pkg/cri/server/sandbox_run.go:422 åˆ›å»ºå…¶ä»–å®¹å™¨ æ¥ä¸‹æ¥å°±æ˜¯åˆ›å»º pod å†…çš„å…¶ä»–å®¹å™¨ï¼šä¸´æ—¶ï¼ˆephemeralï¼‰ã€åˆå§‹åŒ–ï¼ˆinitï¼‰å’Œæ™®é€šå®¹å™¨ï¼Œåˆ›å»ºè¿™äº›å®¹å™¨çš„æ—¶å€™ï¼Œä¼šå°† sandbox å®¹å™¨çš„ã€‚ä¼šåŠ å…¥åˆ° sandox çš„ç½‘ç»œå‘½åç©ºé—´ä¸­ã€‚è¿™é‡Œä¸å±•å¼€ï¼Œè¯¦ç»†é€»è¾‘å¯å‚è€ƒ containerd çš„ containerStore#Create()ã€‚\nå‚è€ƒæºç  kubernetesï¼špkg/kubelet/kuberuntime/kuberuntime_manager.go:913 containerdï¼špkg/cri/server/container_create.go:51 æ€»ç»“ æ¥ç€ä¸Šç¯‡ CNI çš„è§„èŒƒä»‹ç»ï¼Œè¿™æ¬¡åˆä»‹ç»äº† CNI çš„ä½¿ç”¨ï¼Œä»¥åŠå¦‚ä½•ä¸å®¹å™¨è¿è¡Œæ—¶çš„äº¤äº’ã€Pod çš„åˆ›å»ºæµç¨‹ã€‚\nä¸åŒçš„ CNI æ’ä»¶ï¼Œå®ç°äº†ä¸ä¸€æ ·çš„ç½‘ç»œåŠŸèƒ½ã€‚ä¸‹ç¯‡ï¼Œå°†ä»¥ Flannel ä¸ºä¾‹æ¥äº†è§£ä¸‹ CNI çš„å®ç°ï¼Œä»¥åŠ Kubernetes VXLAN ç½‘ç»œã€‚\nä¸ºä»€ä¹ˆä»‹ç» flannelï¼Ÿå› ä¸ºæˆ‘å¸¸ç”¨çš„å¼€å‘ç¯å¢ƒä¹‹ä¸€ k3s é»˜è®¤å°±ç”¨çš„ flannel ç½‘ç»œã€‚å¦ä¸€ä¸ªå¼€å‘ç¯å¢ƒæ˜¯ k8e ï¼Œk8e é»˜è®¤ç”¨çš„æ˜¯ Ciliumï¼Œcilium çš„ cni ä¹Ÿæ˜¯ç³»åˆ—çš„æ–‡ç« ä¹‹ä¸€ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/08/pexelsthomgonzalez13019937.jpg","permalink":"https://atbug.com/how-kubelete-container-runtime-work-with-cni/","tags":["Kubernetes","å®¹å™¨","CNI","CRI"],"title":"æºç è§£æï¼šä» kubeletã€å®¹å™¨è¿è¡Œæ—¶çœ‹ CNI çš„ä½¿ç”¨"},{"categories":["ç¬”è®°"],"contents":"å†™åœ¨æœ€å‰ï¼Œå‘¨æœ«å†™åˆ°è¿™ç¯‡çš„æ—¶å€™æˆ‘å°±å‘ç°å¯èƒ½æ˜¯ç»™è‡ªå·±æŒ–äº†å¾ˆå¤§çš„å‘ï¼Œæ•´ä¸ª Kubernetes ç½‘å…³ç›¸å…³çš„å†…å®¹ä¼šéå¸¸å¤æ‚ä¸”åºå¤§ã€‚\næ·±å…¥æ¢ç´¢ Kubernetes ç½‘ç»œæ¨¡å‹å’Œç½‘ç»œé€šä¿¡ è®¤è¯†ä¸€ä¸‹å®¹å™¨ç½‘ç»œæ¥å£ CNIï¼ˆæœ¬ç¯‡ï¼‰ æºç åˆ†æï¼šä» kubeletã€å®¹å™¨è¿è¡Œæ—¶çœ‹ CNI çš„ä½¿ç”¨ ä» Flannel å­¦ä¹  Kubernetes VXLAN ç½‘ç»œ Kubernetes ç½‘ç»œå­¦ä¹ ä¹‹ Cilium ä¸ eBPF \u0026hellip; çœ‹è‡ªå·±èƒ½å­¦åˆ°å“ªä¸€æ­¥~\nåœ¨ ã€Šæ·±å…¥æ¢ç´¢ Kubernetes ç½‘ç»œæ¨¡å‹å’Œç½‘ç»œé€šä¿¡ã€‹ æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ç½‘ç»œå‘½åç©ºé—´ï¼ˆnetwork namespaceï¼‰ å¦‚ä½•åœ¨ Kubernetes ç½‘ç»œæ¨¡å‹ä¸­å·¥ä½œï¼Œé€šè¿‡ç¤ºä¾‹åˆ†æ pod é—´çš„æµé‡ä¼ è¾“è·¯å¾„ã€‚æ•´ä¸ªä¼ è¾“è¿‡ç¨‹éœ€è¦å„ç§ä¸åŒç»„ä»¶çš„å‚ä¸æ‰å®Œæˆï¼Œè€Œè¿™äº›ç»„ä»¶ä¸ pod ç›¸åŒçš„ç”Ÿå‘½å‘¨æœŸï¼Œè·Ÿéš pod çš„åˆ›å»ºå’Œé”€æ¯ã€‚å®¹å™¨çš„ç»´æŠ¤ç”± kubelet å§”æ‰˜ç»™å®¹å™¨è¿è¡Œæ—¶ï¼ˆcontainer runtimeï¼‰æ¥å®Œæˆï¼Œè€Œå®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´åˆ™æ˜¯ç”±å®¹å™¨è¿è¡Œæ—¶å§”æ‰˜ç½‘ç»œæ’ä»¶å…±åŒå®Œæˆã€‚\nåˆ›å»º podï¼ˆå®¹å™¨ï¼‰çš„ç½‘ç»œå‘½åç©ºé—´ åˆ›å»ºæ¥å£ åˆ›å»º veth å¯¹ è®¾ç½®å‘½åç©ºé—´ç½‘ç»œ è®¾ç½®é™æ€è·¯ç”± é…ç½®ä»¥å¤ªç½‘æ¡¥æ¥å™¨ åˆ†é… IP åœ°å€ åˆ›å»º NAT è§„åˆ™ \u0026hellip; ä¸Šç¯‡æˆ‘ä»¬ä¹Ÿæåˆ°ä¸åŒç½‘ç»œæ’ä»¶å¯¹ Kubernetes ç½‘ç»œæ¨¡å‹æœ‰ä¸åŒçš„å®ç°ï¼Œä¸»è¦é›†ä¸­åœ¨è·¨èŠ‚ç‚¹çš„ pod é—´é€šä¿¡çš„å®ç°ä¸Šã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„ç½‘ç»œæ’ä»¶ï¼Œè¿™å…¶ä¸­ç¦»ä¸å¼€ CNIï¼ˆcontainer network interfaceï¼‰ã€‚è¿™äº›ç½‘ç»œæ’ä»¶éƒ½å®ç°äº† CNI æ ‡å‡†ï¼Œå¯ä»¥ä¸å®¹å™¨ç¼–æ’ç³»ç»Ÿå’Œè¿è¡Œæ—¶è‰¯å¥½çš„é›†æˆã€‚\nCNI æ˜¯ä»€ä¹ˆ CNI æ˜¯ CNCF ä¸‹çš„ä¸€ä¸ªé¡¹ç›®ï¼Œé™¤äº†æä¾›äº†æœ€é‡è¦çš„ è§„èŒƒ ã€ç”¨æ¥ CNI ä¸åº”ç”¨é›†æˆçš„ åº“ã€å®è¡Œ CNI æ’ä»¶çš„ CLI cnitoolï¼Œä»¥åŠ å¯å¼•ç”¨çš„æ’ä»¶ã€‚æœ¬æ–‡å‘å¸ƒæ—¶ï¼Œæœ€æ–°ç‰ˆæœ¬ä¸º v1.1.2ã€‚\nCNI åªå…³æ³¨å®¹å™¨çš„ç½‘ç»œè¿æ¥ä»¥åŠåœ¨å®¹å™¨é”€æ¯æ—¶æ¸…ç†/é‡Šæ”¾åˆ†é…çš„èµ„æºï¼Œä¹Ÿæ­£å› ä¸ºè¿™ä¸ªï¼Œå³ä½¿å®¹å™¨å‘å±•è¿…é€Ÿï¼ŒCNI ä¹Ÿä¾ç„¶èƒ½ä¿è¯ç®€å•å¹¶è¢« å¹¿æ³›æ”¯æŒã€‚\nCNI è§„èŒƒ CNI çš„è§„èŒƒæ¶µç›–äº†ä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š\nç½‘ç»œé…ç½®æ–‡ä»¶æ ¼å¼ å®¹å™¨è¿è¡Œæ—¶ä¸ç½‘ç»œæ’ä»¶äº¤äº’çš„åè®® æ’ä»¶çš„æ‰§è¡Œæµç¨‹ å°†å§”æ‰˜å…¶ä»–æ’ä»¶çš„æ‰§è¡Œæµç¨‹ è¿”å›ç»™è¿è¡Œæ—¶çš„æ‰§è¡Œç»“æœæ•°æ®ç±»å‹ 1. ç½‘ç»œé…ç½®æ ¼å¼ è¿™é‡Œè´´å‡ºè§„èŒƒä¸­çš„é…ç½®ç¤ºä¾‹ï¼Œè§„èŒƒ ä¸­å®šä¹‰äº†ç½‘ç»œé…ç½®çš„æ ¼å¼ï¼ŒåŒ…æ‹¬å¿…é¡»å­—æ®µã€å¯é€‰å­—æ®µä»¥åŠå„ä¸ªå­—æ®µçš„åŠŸèƒ½ã€‚ç¤ºä¾‹ä½¿ç”¨å®šä¹‰äº†åä¸º dbnet çš„ç½‘ç»œï¼Œé…ç½®äº†æ’ä»¶ bridge å’Œ tuningï¼Œè¿™ä¸¤ä¸ªæ’ä»¶ã€‚\nCNI çš„æ’ä»¶ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ï¼š\næ¥å£æ’ä»¶ï¼ˆinterface pluginï¼‰ï¼šç”¨æ¥åˆ›å»ºç½‘ç»œæ¥å£ï¼Œæ¯”å¦‚ç¤ºä¾‹ä¸­çš„ bridgeã€‚ é“¾å¼æ’ä»¶ï¼ˆchainedï¼‰ï¼šç”¨æ¥è°ƒæ•´å·²åˆ›å»ºå¥½çš„ç½‘ç»œæ¥å£ï¼Œæ¯”å¦‚ç¤ºä¾‹ä¸­çš„ tuningã€‚ { \u0026#34;cniVersion\u0026#34;: \u0026#34;1.0.0\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;dbnet\u0026#34;, \u0026#34;plugins\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;bridge\u0026#34;, // plugin specific parameters \u0026#34;bridge\u0026#34;: \u0026#34;cni0\u0026#34;, \u0026#34;keyA\u0026#34;: [\u0026#34;some more\u0026#34;, \u0026#34;plugin specific\u0026#34;, \u0026#34;configuration\u0026#34;], \u0026#34;ipam\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;host-local\u0026#34;, // ipam specific \u0026#34;subnet\u0026#34;: \u0026#34;10.1.0.0/16\u0026#34;, \u0026#34;gateway\u0026#34;: \u0026#34;10.1.0.1\u0026#34;, \u0026#34;routes\u0026#34;: [ {\u0026#34;dst\u0026#34;: \u0026#34;0.0.0.0/0\u0026#34;} ] }, \u0026#34;dns\u0026#34;: { \u0026#34;nameservers\u0026#34;: [ \u0026#34;10.1.0.1\u0026#34; ] } }, { \u0026#34;type\u0026#34;: \u0026#34;tuning\u0026#34;, \u0026#34;capabilities\u0026#34;: { \u0026#34;mac\u0026#34;: true }, \u0026#34;sysctl\u0026#34;: { \u0026#34;net.core.somaxconn\u0026#34;: \u0026#34;500\u0026#34; } }, { \u0026#34;type\u0026#34;: \u0026#34;portmap\u0026#34;, \u0026#34;capabilities\u0026#34;: {\u0026#34;portMappings\u0026#34;: true} } ] } 2. å®¹å™¨è¿è¡Œæ—¶ä¸ç½‘ç»œæ’ä»¶äº¤äº’çš„åè®® CNI ä¸ºå®¹å™¨è¿è¡Œæ—¶æä¾› å››ä¸ªä¸åŒçš„æ“ä½œï¼š\nADD - å°†å®¹å™¨æ·»åŠ åˆ°ç½‘ç»œï¼Œæˆ–ä¿®æ”¹é…ç½® DEL - ä»ç½‘ç»œä¸­åˆ é™¤å®¹å™¨ï¼Œæˆ–å–æ¶ˆä¿®æ”¹ CHECK - æ£€æŸ¥å®¹å™¨ç½‘ç»œæ˜¯å¦æ­£å¸¸ï¼Œå¦‚æœå®¹å™¨çš„ç½‘ç»œå‡ºç°é—®é¢˜ï¼Œåˆ™è¿”å›é”™è¯¯ VERSION - æ˜¾ç¤ºæ’ä»¶çš„ç‰ˆæœ¬ è§„èŒƒå¯¹æ“ä½œçš„è¾“å…¥å’Œè¾“å‡ºå†…å®¹è¿›è¡Œäº†å®šä¹‰ã€‚ä¸»è¦å‡ ä¸ªæ ¸å¿ƒçš„å­—æ®µæœ‰ï¼š\nCNI_COMMANDï¼šä¸Šé¢çš„å››ä¸ªæ“ä½œä¹‹ä¸€ CNI_CONTAINERIDï¼šå®¹å™¨ ID CNI_NETNSï¼šå®¹å™¨çš„éš”ç¦»åŸŸï¼Œå¦‚æœç”¨çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œè¿™é‡Œçš„å€¼æ˜¯ç½‘ç»œå‘½åç©ºé—´çš„åœ°å€ CNI_IFNAMEï¼šè¦åœ¨å®¹å™¨ä¸­åˆ›å»ºçš„æ¥å£åï¼Œæ¯”å¦‚ eth0 CNI_ARGSï¼šæ‰§è¡Œå‚æ•°æ—¶ä¼ é€’çš„å‚æ•° CNI_PATHï¼šæ’ä»¶å¯æ‰§è¡Œæ–‡ä»¶çš„æœæ‹›è·¯å¾„ 3. æ’ä»¶çš„æ‰§è¡Œæµç¨‹ CNI å°†å®¹å™¨ä¸Šç½‘ç»œé…ç½®çš„ ADDã€DELETE å’Œ CHECK æ“ä½œï¼Œæˆä¸ºé™„åŠ ï¼ˆattachmentï¼‰ã€‚\nå®¹å™¨ç½‘ç»œé…ç½®çš„æ“ä½œï¼Œéœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ªæ’ä»¶çš„å…±åŒæ“ä½œæ¥å®Œæˆï¼Œå› æ­¤æ’ä»¶æœ‰ä¸€å®šçš„æ‰§è¡Œé¡ºåºã€‚æ¯”å¦‚å‰é¢çš„ç¤ºä¾‹é…ç½®ä¸­ï¼Œè¦å…ˆåˆ›å»ºæ¥å£ï¼Œæ‰èƒ½å¯¹æ¥å£è¿›è¡Œè°ƒä¼˜ã€‚\næ‹¿ ADD æ“ä½œä¸ºä¾‹ï¼Œé¦–å…ˆæ‰§è¡Œçš„ä¸€èˆ¬æ˜¯ interface pluginï¼Œç„¶ååœ¨æ‰§è¡Œ chained pluginã€‚ä»¥å‰ä¸€ä¸ªæ’ä»¶çš„ è¾“å‡º PrevResult ä¸ä¸‹ä¸€ä¸ªæ’ä»¶çš„é…ç½®ä¼šå…±åŒä½œä¸ºä¸‹ä¸€ä¸ªæ’ä»¶çš„ è¾“å…¥ã€‚ å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ’ä»¶ï¼Œä¼šå°†ç½‘ç»œé…ç½®ä½œä¸ºè¾“å…¥çš„ä¸€éƒ¨åˆ†ã€‚æ’ä»¶å¯ä»¥å°†å‰ä¸€ä¸ªæ’ä»¶çš„ PrevResult æœ€ä¸ºè‡ªå·±çš„è¾“å‡ºï¼Œä¹Ÿå¯ä»¥ç»“åˆè‡ªèº«çš„æ“ä½œå¯¹ PrevResult è¿›è¡Œæ›´æ–°ã€‚æœ€åä¸€ä¸ªæ’ä»¶çš„è¾“å‡º PrevResult ä½œä¸º CNI çš„æ‰§è¡Œç»“æœè¿”å›ç»™å®¹å™¨è¿è¡Œæ—¶ï¼Œå®¹å™¨è¿è¡Œæ—¶ä¼šä¿å­˜æ”¹ç»“æœå¹¶å°†å…¶ä½œä¸ºå…¶ä»–æ“ä½œçš„è¾“å…¥ã€‚\nDELETE çš„æ‰§è¡Œä¸ ADD çš„é¡ºåºæ­£å¥½ç›¸åï¼Œè¦å…ˆç§»é™¤æ¥å£ä¸Šçš„é…ç½®æˆ–è€…é‡Šæ”¾å·²ç»åˆ†é…çš„ IPï¼Œæœ€åæ‰èƒ½åˆ é™¤å®¹å™¨ç½‘ç»œæ¥å£ã€‚DELETE æ“ä½œçš„è¾“å…¥å°±æ˜¯å®¹å™¨è¿è¡Œæ—¶ä¿å­˜çš„ ADD æ“ä½œçš„ç»“æœã€‚\né™¤äº†å®šä¹‰å•æ¬¡æ“ä½œä¸­æ’ä»¶çš„æ‰§è¡Œé¡ºåºï¼ŒCNI è¿˜å¯¹æ“ä½œçš„å¹¶è¡Œæ“ä½œã€é‡å¤æ“ä½œç­‰è¿›è¡Œäº†è¯´æ˜ã€‚\n4. æ’ä»¶å§”æ‰˜ æœ‰ä¸€äº›æ“ä½œï¼Œæ— è®ºå‡ºäºä½•ç§åŸå› ï¼Œéƒ½ä¸èƒ½åˆç†åœ°ä½œä¸ºä¸€ä¸ªæ¾æ•£çš„é“¾æ¥æ’ä»¶æ¥å®ç°ã€‚ç›¸åï¼ŒCNI æ’ä»¶å¯èƒ½å¸Œæœ›å°†æŸäº›åŠŸèƒ½å§”æ‰˜ç»™å¦ä¸€ä¸ªæ’ä»¶ã€‚ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯ IP åœ°å€ç®¡ç†ï¼ˆIP Adress Managementï¼Œç®€ç§° IPAMï¼‰ï¼Œä¸»è¦æ˜¯ä¸ºå®¹å™¨æ¥å£åˆ†é…/å›æ”¶ IP åœ°å€ã€ç®¡ç†è·¯ç”±ç­‰ã€‚\nCNI å®šä¹‰äº†ç¬¬ä¸‰ç§æ’ä»¶ \u0026ndash; IPAM æ’ä»¶ã€‚CNI æ’ä»¶å¯ä»¥åœ¨æ°å½“çš„æ—¶æœºè°ƒç”¨ IPAM æ’ä»¶ï¼ŒIPAM æ’ä»¶ä¼šå°†æ‰§è¡Œçš„ç»“æœè¿”å›ç»™å§”æ‰˜æ–¹ã€‚IPAM æ’ä»¶ä¼šæ ¹æ®æŒ‡å®šçš„åè®®ï¼ˆå¦‚ dhcpï¼‰ã€æœ¬åœ°æ–‡ä»¶ä¸­çš„æ•°æ®ã€æˆ–è€…ç½‘ç»œé…ç½®æ–‡ä»¶ä¸­ ipam å­—æ®µçš„ä¿¡æ¯æ¥å®Œæˆæ“ä½œï¼šåˆ†é… IPã€è®¾ç½®ç½‘å…³ã€è·¯ç”±ç­‰ç­‰ã€‚\n\u0026#34;ipam\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;host-local\u0026#34;, // ipam specific \u0026#34;subnet\u0026#34;: \u0026#34;10.1.0.0/16\u0026#34;, \u0026#34;gateway\u0026#34;: \u0026#34;10.1.0.1\u0026#34;, \u0026#34;routes\u0026#34;: [ {\u0026#34;dst\u0026#34;: \u0026#34;0.0.0.0/0\u0026#34;} ] } 5. æ‰§è¡Œç»“æœ æ’ä»¶å¯ä»¥è¿”å›ä¸€ä¸‹ä¸‰ç§ç»“æœä¹‹ä¸€ï¼Œè§„èŒƒå¯¹ ç»“æœçš„æ ¼å¼ è¿›è¡Œäº†å®šä¹‰ã€‚\nSuccessï¼šåŒæ—¶ä¼šåŒ…å« PrevResult ä¿¡æ¯ï¼Œæ¯”å¦‚ ADD æ“ä½œåçš„ PrevResult è¿”å›ç»™å®¹å™¨è¿è¡Œæ—¶ã€‚ Errorï¼šåŒ…å«å¿…è¦çš„é”™è¯¯æç¤ºä¿¡æ¯ã€‚ Versionï¼šè¿™ä¸ªæ˜¯ VERSION æ“ä½œçš„è¿”å›ç»“æœã€‚ åº“ CNI çš„åº“æ˜¯æŒ‡ libcniï¼Œç”¨äº CNI å’Œåº”ç”¨ç¨‹åºé›†æˆï¼Œå®šä¹‰äº† CNI ç›¸å…³çš„æ¥å£å’Œé…ç½®ã€‚\ntype CNI interface { AddNetworkList(ctx context.Context, net *NetworkConfigList, rt *RuntimeConf) (types.Result, error) CheckNetworkList(ctx context.Context, net *NetworkConfigList, rt *RuntimeConf) error DelNetworkList(ctx context.Context, net *NetworkConfigList, rt *RuntimeConf) error GetNetworkListCachedResult(net *NetworkConfigList, rt *RuntimeConf) (types.Result, error) GetNetworkListCachedConfig(net *NetworkConfigList, rt *RuntimeConf) ([]byte, *RuntimeConf, error) AddNetwork(ctx context.Context, net *NetworkConfig, rt *RuntimeConf) (types.Result, error) CheckNetwork(ctx context.Context, net *NetworkConfig, rt *RuntimeConf) error DelNetwork(ctx context.Context, net *NetworkConfig, rt *RuntimeConf) error GetNetworkCachedResult(net *NetworkConfig, rt *RuntimeConf) (types.Result, error) GetNetworkCachedConfig(net *NetworkConfig, rt *RuntimeConf) ([]byte, *RuntimeConf, error) ValidateNetworkList(ctx context.Context, net *NetworkConfigList) ([]string, error) ValidateNetwork(ctx context.Context, net *NetworkConfig) ([]string, error) } ä»¥æ·»åŠ ç½‘ç»œçš„éƒ¨åˆ†ä»£ç ä¸ºä¾‹ï¼š\nfunc (c *CNIConfig) addNetwork(ctx context.Context, name, cniVersion string, net *NetworkConfig, prevResult types.Result, rt *RuntimeConf) (types.Result, error) { ... return invoke.ExecPluginWithResult(ctx, pluginPath, newConf.Bytes, c.args(\u0026#34;ADD\u0026#34;, rt), c.exec) } æ‰§è¡Œçš„é€»è¾‘ç®€å•æ¥è¯´å°±æ˜¯ï¼š\næŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶ åŠ è½½ç½‘ç»œé…ç½® æ‰§è¡Œ ADD æ“ä½œ ç»“æœå¤„ç† æ€»ç»“ è¿™ç¯‡å­¦ä¹ äº† CNI è§„èŒƒçš„å†…å®¹ã€ç½‘ç»œæ’ä»¶çš„æ‰§è¡Œæµç¨‹ï¼Œå¯¹ CNI æŠ½è±¡çš„ç½‘ç»œç®¡ç†æ¥å£æœ‰äº†å¤§è‡´çš„äº†è§£ã€‚\nä¸‹ä¸€ç¯‡å°†ç»“åˆæºç çš„åˆ†æï¼Œäº†è§£ kubeletã€å®¹å™¨è¿è¡Œæ—¶ã€CNI ç½‘ç»œæ’ä»¶ä¹‹é—´å¦‚ä½•è¿›è¡Œäº¤äº’ã€‚\nå‚è€ƒ https://www.tigera.io/learn/guides/kubernetes-networking/kubernetes-cni/ https://github.com/containernetworking/cni https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/06/pexelsquangnguyenvinh6346488.jpg","permalink":"https://atbug.com/deep-dive-cni-spec/","tags":["Kubernetes","CNI","ç½‘ç»œ","å®¹å™¨"],"title":"è®¤è¯†ä¸€ä¸‹å®¹å™¨ç½‘ç»œæ¥å£ CNI"},{"categories":["ç¬”è®°"],"contents":"è¿™æ˜¯ Kubernetes ç½‘ç»œå­¦ä¹ çš„ç¬¬ä¸€ç¯‡ç¬”è®°ã€‚\næ·±å…¥æ¢ç´¢ Kubernetes ç½‘ç»œæ¨¡å‹å’Œç½‘ç»œé€šä¿¡ï¼ˆæœ¬ç¯‡ï¼‰ è®¤è¯†ä¸€ä¸‹å®¹å™¨ç½‘ç»œæ¥å£ CNI æºç åˆ†æï¼šä» kubeletã€å®¹å™¨è¿è¡Œæ—¶çœ‹ CNI çš„ä½¿ç”¨ ä» Flannel å­¦ä¹  Kubernetes VXLAN ç½‘ç»œ Kubernetes ç½‘ç»œå­¦ä¹ ä¹‹ Cilium ä¸ eBPF Kubernetes å®šä¹‰äº†ä¸€ç§ç®€å•ã€ä¸€è‡´çš„ç½‘ç»œæ¨¡å‹ï¼ŒåŸºäºæ‰å¹³ç½‘ç»œç»“æ„çš„è®¾è®¡ï¼Œæ— éœ€å°†ä¸»æœºç«¯å£ä¸ç½‘ç»œç«¯å£è¿›è¡Œæ˜ å°„ä¾¿å¯ä»¥è¿›è¡Œé«˜æ•ˆåœ°é€šè®¯ï¼Œä¹Ÿæ— éœ€å…¶ä»–ç»„ä»¶è¿›è¡Œè½¬å‘ã€‚è¯¥æ¨¡å‹ä¹Ÿä½¿åº”ç”¨ç¨‹åºå¾ˆå®¹æ˜“ä»è™šæ‹Ÿæœºæˆ–è€…ä¸»æœºç‰©ç†æœºè¿ç§»åˆ° Kubernetes ç®¡ç†çš„ pod ä¸­ã€‚\nè¿™ç¯‡æ–‡ç« ä¸»è¦æ·±å…¥æ¢ç´¢ Kubernetes ç½‘ç»œæ¨¡å‹ï¼Œå¹¶äº†è§£å®¹å™¨ã€pod é—´å¦‚ä½•è¿›è¡Œé€šè®¯ã€‚å¯¹äºç½‘ç»œæ¨¡å‹çš„å®ç°å°†ä¼šåœ¨åé¢çš„æ–‡ç« ä»‹ç»ã€‚\nKubernetes ç½‘ç»œæ¨¡å‹ è¯¥æ¨¡å‹å®šä¹‰äº†ï¼š\næ¯ä¸ª pod éƒ½æœ‰è‡ªå·±çš„ IP åœ°å€ï¼Œè¿™ä¸ª IP åœ¨é›†ç¾¤èŒƒå›´å†…å¯è¾¾ Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å…±äº« pod IP åœ°å€ï¼ˆåŒ…æ‹¬ MAC åœ°å€ï¼‰ï¼Œå¹¶ä¸”å®¹å™¨ä¹‹å‰å¯ä»¥ç›¸äº’é€šä¿¡ï¼ˆä½¿ç”¨ localhostï¼‰ Pod å¯ä»¥ä½¿ç”¨ pod IP åœ°å€ä¸é›†ç¾¤ä¸­ä»»ä¸€èŠ‚ç‚¹ä¸Šçš„å…¶ä»– pod é€šä¿¡ï¼Œæ— éœ€ NAT Kubernetes çš„ç»„ä»¶ä¹‹é—´å¯ä»¥ç›¸äº’é€šä¿¡ï¼Œä¹Ÿå¯ä»¥ä¸ pod é€šä¿¡ ç½‘ç»œéš”ç¦»å¯ä»¥é€šè¿‡ç½‘ç»œç­–ç•¥å®ç° ä¸Šé¢çš„å®šä¹‰ä¸­æåˆ°äº†å‡ ä¸ªç›¸å…³çš„ç»„ä»¶ï¼š\nPodï¼šKubernetes ä¸­çš„ pod æœ‰ç‚¹ç±»ä¼¼è™šæ‹Ÿæœºæœ‰å”¯ä¸€çš„ IP åœ°å€ï¼ŒåŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„ pod å…±äº«ç½‘ç»œå’Œå­˜å‚¨ã€‚ Containerï¼špod æ˜¯ä¸€ç»„å®¹å™¨çš„é›†åˆï¼Œè¿™äº›å®¹å™¨å…±äº«åŒä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ã€‚pod å†…çš„å®¹å™¨å°±åƒè™šæ‹Ÿæœºä¸Šçš„è¿›ç¨‹ï¼Œè¿›ç¨‹ä¹‹é—´å¯ä»¥ä½¿ç”¨ localhost è¿›è¡Œé€šä¿¡ï¼›å®¹å™¨æœ‰è‡ªå·±ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿã€CPUã€å†…å­˜å’Œè¿›ç¨‹ç©ºé—´ã€‚éœ€è¦é€šè¿‡åˆ›å»º Pod æ¥åˆ›å»ºå®¹å™¨ã€‚ Nodeï¼špod è¿è¡Œåœ¨èŠ‚ç‚¹ä¸Šï¼Œé›†ç¾¤ä¸­åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ã€‚æ¯ä¸ª pod çš„ç½‘ç»œå‘½åç©ºé—´éƒ½ä¼šè¿æ¥åˆ°èŠ‚ç‚¹çš„å‘½åç©ºé—´ä¸Šï¼Œä»¥æ‰“é€šç½‘ç»œã€‚ è®²äº†è¿™ä¹ˆå¤šæ¬¡ç½‘ç»œå‘½åç©ºé—´ï¼Œé‚£å®ƒåˆ°åº•æ˜¯å¦‚ä½•è¿ä½œçš„å‘¢ï¼Ÿ\nç½‘ç»œå‘½åç©ºé—´å¦‚ä½•å·¥ä½œ åœ¨ Kubernetes çš„å‘è¡Œç‰ˆ k3s åˆ›å»ºä¸€ä¸ª podï¼Œè¿™ä¸ª pod æœ‰ä¸¤ä¸ªå®¹å™¨ï¼šå‘é€è¯·æ±‚çš„ curl å®¹å™¨å’Œæä¾› web æœåŠ¡çš„ httpbin å®¹å™¨ã€‚\nè™½ç„¶ä½¿ç”¨å‘è¡Œç‰ˆï¼Œä½†æ˜¯å…¶ä»ç„¶ä½¿ç”¨ Kubernetes ç½‘ç»œæ¨¡å‹ï¼Œå¹¶ä¸å¦¨ç¢æˆ‘ä»¬äº†è§£ç½‘ç»œæ¨¡å‹ã€‚\napiVersion: v1 kind: Pod metadata: name: multi-container-pod spec: containers: - image: curlimages/curl name: curl command: [\u0026#34;sleep\u0026#34;, \u0026#34;365d\u0026#34;] - image: kennethreitz/httpbin name: httpbin ç™»å½•åˆ°èŠ‚ç‚¹ä¸Šï¼Œé€šè¿‡ lsns -t net å½“å‰ä¸»æœºä¸Šçš„ç½‘ç»œå‘½åç©ºé—´ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ‰¾åˆ° httpbin çš„è¿›ç¨‹ã€‚æœ‰ä¸ªå‘½åç©ºé—´çš„å‘½ä»¤æ˜¯ /pauseï¼Œè¿™ä¸ª pause è¿›ç¨‹å®é™…ä¸Šæ˜¯æ¯ä¸ª pod ä¸­ ä¸å¯è§ çš„ sandbox å®¹å™¨è¿›ç¨‹ã€‚å…³äº sanbox å®¹å™¨çš„ä½œç”¨ï¼Œå°†ä¼šåœ¨ä¸‹ä¸€ç¯‡å®¹å™¨ç½‘ç»œå’Œ CNI ä¸­ä»‹ç»ã€‚\nlsns -t net NS TYPE NPROCS PID USER NETNSID NSFS COMMAND 4026531992 net 126 1 root unassigned /lib/systemd/systemd --system --deserialize 31 4026532247 net 1 83224 uuidd unassigned /usr/sbin/uuidd --socket-activation 4026532317 net 4 129820 65535 0 /run/netns/cni-607c5530-b6d8-ba57-420e-a467d7b10c56 /pause æ—¢ç„¶æ¯ä¸ªå®¹å™¨éƒ½æœ‰ç‹¬ç«‹çš„è¿›ç¨‹ç©ºé—´ï¼Œæˆ‘ä»¬æ¢ä¸‹å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹ç±»å‹çš„ç©ºé—´ï¼š\nlsns -t pid NS TYPE NPROCS PID USER COMMAND 4026531836 pid 127 1 root /lib/systemd/systemd --system --deserialize 31 4026532387 pid 1 129820 65535 /pause 4026532389 pid 1 129855 systemd-network sleep 365d 4026532391 pid 2 129889 root /usr/bin/python3 /usr/local/bin/gunicorn -b 0.0.0.0:80 httpbin:app -k gevent é€šè¿‡è¿›ç¨‹ PID 129889 å¯ä»¥æ‰¾åˆ°å…¶æ‰€å±çš„å‘½åç©ºé—´ï¼š\nip netns identify 129889 cni-607c5530-b6d8-ba57-420e-a467d7b10c56 ç„¶åå¯ä»¥åœ¨è¯¥å‘½åç©ºé—´ä¸‹ä½¿ç”¨ exec æ‰§è¡Œå‘½ä»¤ï¼š\nip netns exec cni-607c5530-b6d8-ba57-420e-a467d7b10c56 ip a 1: lo: \u0026lt;LOOPBACK,UP,LOWER_UP\u0026gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever 2: eth0@if17: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1450 qdisc noqueue state UP group default link/ether f2:c8:17:b6:5f:e5 brd ff:ff:ff:ff:ff:ff link-netnsid 0 inet 10.42.1.14/24 brd 10.42.1.255 scope global eth0 valid_lft forever preferred_lft forever inet6 fe80::f0c8:17ff:feb6:5fe5/64 scope link valid_lft forever preferred_lft forever ä»ç»“æœæ¥çœ‹ pod çš„ IP åœ°å€ 10.42.1.14 ç»‘å®šåœ¨æ¥å£ eth0 ä¸Šï¼Œè€Œ eth0 è¢«è¿æ¥åˆ° 17 å·æ¥å£ä¸Šã€‚\nåœ¨èŠ‚ç‚¹ä¸»æœºä¸Šï¼ŒæŸ¥çœ‹ 17 å·æ¥å£ä¿¡æ¯ã€‚veth7912056b æ˜¯ä¸»æœºæ ¹å‘½åç©ºé—´ä¸‹çš„è™šæ‹Ÿä»¥å¤ªæ¥å£ï¼ˆvitual ethernet deviceï¼‰ï¼Œæ˜¯è¿æ¥ pod ç½‘ç»œå’ŒèŠ‚ç‚¹ç½‘ç»œçš„ éš§é“ï¼Œå¯¹ç«¯æ˜¯ pod å‘½åç©ºé—´ä¸‹çš„æ¥å£ eth0ã€‚\nip link | grep -A1 ^17 17: veth7912056b@if2: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1450 qdisc noqueue master cni0 state UP mode DEFAULT group default link/ether d6:5e:54:7f:df:af brd ff:ff:ff:ff:ff:ff link-netns cni-607c5530-b6d8-ba57-420e-a467d7b10c56 ä¸Šé¢çš„ç»“æœçœ‹åˆ°ï¼Œè¯¥ veth è¿åˆ°äº†ä¸ªç½‘æ¡¥ï¼ˆnetwork bridgeï¼‰cni0 ä¸Šã€‚\nç½‘æ¡¥å·¥ä½œåœ¨æ•°æ®é“¾è·¯å±‚ï¼ˆOSI æ¨¡å‹çš„ç¬¬ 2 å±‚ï¼‰ï¼Œè¿æ¥å¤šä¸ªç½‘ç»œï¼ˆå¯å¤šä¸ªç½‘æ®µï¼‰ã€‚å½“è¯·æ±‚åˆ°è¾¾ç½‘æ¡¥ï¼Œç½‘æ¡¥ä¼šè¯¢é—®æ‰€æœ‰è¿æ¥çš„æ¥å£ï¼ˆè¿™é‡Œ pod é€šè¿‡ veth ä»¥ç½‘æ¡¥è¿æ¥ï¼‰æ˜¯å¦æ‹¥æœ‰åŸå§‹è¯·æ±‚ä¸­çš„ IP åœ°å€ã€‚å¦‚æœæœ‰æ¥å£å“åº”ï¼Œç½‘æ¡¥ä¼šå°†åŒ¹é…ä¿¡æ¯ï¼ˆIP -\u0026gt; vethï¼‰è®°å½•ï¼Œå¹¶å°†æ•°æ®è½¬å‘è¿‡å»ã€‚\né‚£å¦‚æœæ²¡æœ‰æ¥å£å“åº”æ€ä¹ˆåŠï¼Ÿå…·ä½“æµç¨‹å°±è¦çœ‹å„ä¸ªç½‘ç»œæ’ä»¶çš„å®ç°äº†ã€‚æˆ‘å‡†å¤‡åœ¨åé¢çš„æ–‡ç« ä¸­ä»‹ç»å¸¸ç”¨çš„ç½‘ç»œæ’ä»¶ï¼Œæ¯”å¦‚ Calicoã€Flannelã€Cilium ç­‰ã€‚\næ¥ä¸‹æ¥çœ‹ä¸‹ Kubernetes ä¸­çš„ç½‘ç»œé€šä¿¡å¦‚ä½•å®Œæˆï¼Œä¸€å…±æœ‰å‡ ç§ç±»å‹ï¼š\nåŒ pod å†…å®¹å™¨é—´é€šä¿¡ åŒèŠ‚ç‚¹ä¸Šçš„ pod é—´é€šä¿¡ ä¸åŒèŠ‚ç‚¹ä¸Šçš„ pod é—´é€šä¿¡ Kubernetes ç½‘ç»œå¦‚ä½•å·¥ä½œ åŒ pod å†…çš„å®¹å™¨é—´é€šä¿¡ åŒ pod å†…çš„å®¹å™¨é—´é€šä¿¡æœ€ç®€å•ï¼Œè¿™äº›å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼Œæ¯ä¸ªå‘½åç©ºé—´ä¸‹éƒ½æœ‰ lo å›ç¯æ¥å£ï¼Œå¯ä»¥é€šè¿‡ localhost æ¥å®Œæˆé€šä¿¡ã€‚\nåŒèŠ‚ç‚¹ä¸Šçš„ pod é—´é€šä¿¡ å½“æˆ‘ä»¬å°† curl å®¹å™¨å’Œ httpbin åˆ†åˆ«åœ¨ä¸¤ä¸ª pod ä¸­è¿è¡Œï¼Œè¿™ä¸¤ä¸ª pod æœ‰å¯èƒ½è°ƒåº¦åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚curl å‘å‡ºçš„è¯·æ±‚æ ¹æ®å®¹å™¨å†…çš„è·¯ç”±è¡¨åˆ°è¾¾äº† pod å†…çš„ eth0 æ¥å£ã€‚ç„¶åé€šè¿‡ä¸ eth0 ç›¸è¿çš„éš§é“ veth1 åˆ°è¾¾èŠ‚ç‚¹çš„æ ¹ç½‘ç»œç©ºé—´ã€‚\nveth1 é€šè¿‡ç½‘æ¡¥ cni0 ä¸å…¶ä»– pod ç›¸è¿è™šæ‹Ÿä»¥å¤ªæ¥å£ vethX ç›¸è¿ï¼Œç½‘æ¡¥ä¼šè¯¢é—®æ‰€æœ‰ç›¸è¿çš„æ¥å£æ˜¯å¦æ‹¥æœ‰åŸå§‹è¯·æ±‚ä¸­çš„ IP åœ°å€ï¼ˆæ¯”å¦‚è¿™é‡Œçš„ 10.42.1.9ï¼‰ã€‚æ”¶åˆ°å“åº”åï¼Œç½‘æ¡¥ä¼šè®°å½•æ˜ å°„ä¿¡æ¯ï¼ˆ10.42.1.9 =\u0026gt; veth0ï¼‰ï¼ŒåŒæ—¶å°†æ•°æ®è½¬å‘è¿‡å»ã€‚æœ€ç»ˆæ•°æ®ç»è¿‡ veth0 éš§é“è¿›å…¥ pod httpbin ä¸­ã€‚\nä¸åŒèŠ‚ç‚¹çš„ pod é—´é€šä¿¡ è·¨èŠ‚ç‚¹çš„ pod é—´é€šä¿¡ä¼šå¤æ‚ä¸€äº›ï¼Œä¸” ä¸åŒç½‘ç»œæ’ä»¶çš„å¤„ç†æ–¹å¼ä¸åŒï¼Œè¿™é‡Œé€‰æ‹©ä¸€ç§å®¹æ˜“ç†è§£çš„æ–¹å¼æ¥ç®€å•è¯´æ˜ä¸‹ã€‚\nå‰åŠéƒ¨åˆ†çš„æµç¨‹ä¸åŒèŠ‚ç‚¹ pod é—´é€šä¿¡ç±»ä¼¼ï¼Œå½“è¯·æ±‚åˆ°è¾¾ç½‘æ¡¥ï¼Œç½‘æ¡¥è¯¢é—®å“ªä¸ª pod æ‹¥æœ‰è¯¥ IP ä½†æ˜¯æ²¡æœ‰å¾—åˆ°å›åº”ã€‚æµç¨‹è¿›å…¥ä¸»æœºçš„è·¯ç”±å¯»å€è¿‡ç¨‹ï¼Œåˆ°æ›´é«˜çš„é›†ç¾¤å±‚é¢ã€‚\nåœ¨é›†ç¾¤å±‚é¢æœ‰ä¸€å¼ è·¯ç”±è¡¨ï¼Œé‡Œé¢å­˜å‚¨ç€æ¯ä¸ªèŠ‚ç‚¹çš„ Pod IP ç½‘æ®µï¼ˆèŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤æ—¶ä¼šåˆ†é…ä¸€ä¸ª Pod ç½‘æ®µï¼ˆPod CIDRï¼‰ï¼Œæ¯”å¦‚åœ¨ k3s ä¸­é»˜è®¤çš„ Pod CIDR æ˜¯ 10.42.0.0/16ï¼ŒèŠ‚ç‚¹è·å–åˆ°çš„ç½‘æ®µæ˜¯ 10.42.0.0/24ã€10.42.1.0/24ã€10.42.2.0/24ï¼Œä¾æ¬¡ç±»æ¨ï¼‰ã€‚é€šè¿‡èŠ‚ç‚¹çš„ Pod IP ç½‘æ®µå¯ä»¥åˆ¤æ–­å‡ºè¯·æ±‚ IP çš„èŠ‚ç‚¹ï¼Œç„¶åè¯·æ±‚è¢«å‘é€åˆ°è¯¥èŠ‚ç‚¹ã€‚\næ€»ç»“ ç°åœ¨åº”è¯¥å¯¹ Kubernetes çš„ç½‘ç»œé€šä¿¡æœ‰åˆæ­¥çš„äº†è§£äº†å§ã€‚\næ•´ä¸ªé€šä¿¡çš„è¿‡ç¨‹éœ€è¦å„ç§ç»„ä»¶çš„é…åˆï¼Œæ¯”å¦‚ Pod ç½‘ç»œå‘½åç©ºé—´ã€pod ä»¥å¤ªç½‘æ¥å£ eth0ã€è™šæ‹Ÿä»¥å¤ªç½‘æ¥å£ vethXã€ç½‘æ¡¥ï¼ˆnetwork bridgeï¼‰ cni0 ç­‰ã€‚å…¶ä¸­æœ‰äº›ç»„ä»¶ä¸ pod ä¸€ä¸€å¯¹åº”ï¼Œä¸ pod åŒç”Ÿå‘½å‘¨æœŸã€‚è™½ç„¶å¯ä»¥é€šè¿‡æ‰‹åŠ¨çš„æ–¹å¼åˆ›å»ºã€å…³è”å’Œåˆ é™¤ï¼Œä½†å¯¹äº pod è¿™ç§éæ°¸ä¹…æ€§çš„èµ„æºä¼šè¢«é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯ï¼Œå¤ªå¤šäººå·¥çš„å·¥ä½œä¹Ÿæ˜¯ä¸ç°å®çš„ã€‚\nå®é™…ä¸Šè¿™äº›å·¥ä½œéƒ½æ˜¯ç”±å®¹å™¨å§”æ‰˜ç»™ç½‘ç»œæ’ä»¶æ¥å®Œæˆçš„ï¼Œè€Œç½‘ç»œæ’ä»¶æ‰€éµå¾ªçš„è§„èŒƒ CNIï¼ˆContainer Network Interfaceï¼‰ã€‚\nç½‘ç»œæ’ä»¶éƒ½åšäº†ä»€ä¹ˆï¼Ÿ\nåˆ›å»º podï¼ˆå®¹å™¨ï¼‰çš„ç½‘ç»œå‘½åç©ºé—´ åˆ›å»ºæ¥å£ åˆ›å»º veth å¯¹ è®¾ç½®å‘½åç©ºé—´ç½‘ç»œ è®¾ç½®é™æ€è·¯ç”± é…ç½®ä»¥å¤ªç½‘æ¡¥æ¥å™¨ åˆ†é… IP åœ°å€ åˆ›å»º NAT è§„åˆ™ \u0026hellip; å‚è€ƒ https://www.tigera.io/learn/guides/kubernetes-networking/ https://kubernetes.io/docs/concepts/services-networking/ https://matthewpalmer.net/kubernetes-app-developer/articles/kubernetes-networking-guide-beginners.html https://learnk8s.io/kubernetes-network-packets ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/04/deepdiveintokuberntesnetwork.jpg","permalink":"https://atbug.com/deep-dive-k8s-network-mode-and-communication/","tags":["Kubernetes","ç½‘ç»œ","CNI"],"title":"æ·±å…¥æ¢ç´¢ Kubernetes ç½‘ç»œæ¨¡å‹å’Œç½‘ç»œé€šä¿¡"},{"categories":["äº‘åŸç”Ÿ"],"contents":"ä¸Šå‘¨åœ¨å†™ K8s å¤šé›†ç¾¤çš„æµé‡è°ƒåº¦ çš„ demo éƒ¨åˆ†æ—¶éœ€è¦ä¸åœåœ°åœ¨å¤šä¸ªé›†ç¾¤ä¸­å®‰è£…ç»„ä»¶ã€éƒ¨ç½²åº”ç”¨ï¼Œæˆ–è€…æ‰§è¡Œå„ç§å‘½ä»¤ã€‚å½“æ—¶æ˜¯é€šè¿‡ Linux shell è„šæœ¬å¹¶é€šè¿‡å·¥å…· kubectx è¿›è¡Œé›†ç¾¤çš„åˆ‡æ¢ï¼Œåƒè¿™æ ·ï¼š\næˆ–è€…è¿™æ ·ï¼š\næ“ä½œç¹çï¼Œå¾ˆæ˜¯ç—›è‹¦ã€‚\nä»Šå¤©å¶ç„¶é—´å‘ç°äº†ä¸€ä¸ª kubectl æ’ä»¶ kubectl foreach ï¼Œå¯ä»¥åœ¨å¤šä¸ªé›†ç¾¤ï¼ˆcontextsï¼‰ä¸Šæ‰§è¡Œ kubectl å‘½ä»¤ã€‚æ¯”å¦‚ kubectl foreach cluster-1 cluster-2 -- get po -n kube-system ã€‚\næ’ä»¶å®‰è£…å’Œä½¿ç”¨å¾ˆç®€å•ï¼Œé€šè¿‡ krew è¿›è¡Œå®‰è£…ï¼š\nkubectl krew install foreach ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼š\nkubectl foreach -h Usage: kubectl foreach [OPTIONS] [PATTERN]... -- [KUBECTL_ARGS...] Patterns can be used to match context names from kubeconfig: (empty): matches all contexts NAME: matches context with exact name /PATTERN/: matches context with regular expression ^NAME: remove context with exact name from the matched results ^/PATTERN/: remove contexts matching the regular expression from the results Options: -c=NUM Limit parallel executions (default: 0, unlimited) -I=VAL Replace VAL occurring in KUBECTL_ARGS with context name -q Disable and accept confirmation prompts ($KUBECTL_FOREACH_DISABLE_PROMPTS) -h/--help Print help Examples: # get nodes on contexts named a b c kubectl foreach a b c -- get nodes # get nodes on all contexts named c0..9 except c1 (note the escaping) kubectl foreach \u0026#39;/^c[0-9]/\u0026#39; ^c1\t-- get nodes # get nodes on all contexts that has \u0026#34;prod\u0026#34; but not \u0026#34;foo\u0026#34; kubectl foreach /prod/ ^/foo/ -- get nodes # use \u0026#39;kubectl tail\u0026#39; plugin to follow logs of pods in contexts named *test* kubectl foreach -I _ /test/ -- tail --context=_ -l app=foo æ¥ä¸‹æ¥æµ‹è¯•ä¸‹ï¼Œä½¿ç”¨ k3d åˆ›å»º 3 ä¸ªé›†ç¾¤ ï¼ˆk3d è²Œä¼¼ä¸æ”¯æŒåŒæ—¶åˆ›å»ºå¤šä¸ªé›†ç¾¤ï¼Œè¿˜æ˜¯éœ€è¦ for è„šæœ¬æ¥æ“ä½œï¼‰ï¼š\nfor CLUSTER_NAME in cluster-1 cluster-2 cluster-3 do k3d cluster create ${CLUSTER_NAME} \\ --image docker.io/rancher/k3s:v1.23.8-k3s2 \\ --servers-memory 4g \\ --k3s-arg \u0026#34;--disable=traefik@server:0\u0026#34; \\ --no-lb \\ --timeout 120s \\ --wait done é›†ç¾¤å®‰è£…å®Œæˆï¼š\nk3d cluster list NAME SERVERS AGENTS LOADBALANCER cluster-1 1/1 0/0 false cluster-2 1/1 0/0 false cluster-3 1/1 0/0 false æ³¨æ„ï¼Œk3d å®‰è£…çš„é›†ç¾¤çš„ context éƒ½å¸¦æœ‰å‰ç¼€ k3d- ï¼Œåœ¨ä½¿ç”¨ kubectl foreach çš„æ—¶å€™è¦æ³¨æ„ï¼š\nkubectx k3d-cluster-1 k3d-cluster-2 k3d-cluster-3 æ¯”å¦‚æŸ¥çœ‹å„ä¸ªé›†ç¾¤ä¸­çš„ kube-sysmte ä¸‹çš„ podï¼š\nkubectl foreach -q k3d-cluster-1 k3d-cluster-2 k3d-cluster-3 -- get po -n kube-system æˆ–è€…è¯•è¯•åˆ›å»º deploymentï¼Œè¿™æ¬¡æˆ‘ä»¬ä¸åˆ—å‡ºå®Œæ•´çš„ context nameï¼Œè€Œæ˜¯ä½¿ç”¨æ­£åˆ™ /cluster/ï¼š\nkubectl foreach -q /cluster/ -- create deploy pipy --image flomesh/pipy -n default Will run command in context(s): - k3d-cluster-1 - k3d-cluster-2 - k3d-cluster-3 k3d-cluster-1 | deployment.apps/pipy created k3d-cluster-3 | deployment.apps/pipy created k3d-cluster-2 | deployment.apps/pipy created ç„¶åæŸ¥çœ‹ä¸‹ podï¼š\nkubectl foreach -q /cluster/ -- get pod -n default Will run command in context(s): - k3d-cluster-1 - k3d-cluster-2 - k3d-cluster-3 k3d-cluster-1 | NAME READY STATUS RESTARTS AGE k3d-cluster-1 | pipy-df659b55f-bnr27 1/1 Running 0 25s k3d-cluster-3 | NAME READY STATUS RESTARTS AGE k3d-cluster-3 | pipy-df659b55f-p9j49 1/1 Running 0 25s k3d-cluster-2 | NAME READY STATUS RESTARTS AGE k3d-cluster-2 | pipy-df659b55f-9bjgf 1/1 Running 0 25s æŸ¥çœ‹æ—¥å¿—\nkubectl foreach -q /cluster/ -- logs -l app=pipy -n default --tail 3 Will run command in context(s): - k3d-cluster-1 - k3d-cluster-2 - k3d-cluster-3 k3d-cluster-2 | 2022-11-30 10:40:56.520 [INF] [listener] Listening on TCP port 8080 at 0.0.0.0 k3d-cluster-2 | 2022-11-30 10:40:56.520 [INF] [listener] Listening on TCP port 8081 at 0.0.0.0 k3d-cluster-2 | 2022-11-30 10:40:56.520 [INF] [listener] Listening on TCP port 8082 at 0.0.0.0 k3d-cluster-1 | 2022-11-30 10:40:56.551 [INF] [listener] Listening on TCP port 8080 at 0.0.0.0 k3d-cluster-1 | 2022-11-30 10:40:56.551 [INF] [listener] Listening on TCP port 8081 at 0.0.0.0 k3d-cluster-1 | 2022-11-30 10:40:56.551 [INF] [listener] Listening on TCP port 8082 at 0.0.0.0 k3d-cluster-3 | 2022-11-30 10:40:55.813 [INF] [listener] Listening on TCP port 8080 at 0.0.0.0 k3d-cluster-3 | 2022-11-30 10:40:55.813 [INF] [listener] Listening on TCP port 8081 at 0.0.0.0 k3d-cluster-3 | 2022-11-30 10:40:55.813 [INF] [listener] Listening on TCP port 8082 at 0.0.0.0 æ³¨æ„ï¼Œå¤šé›†ç¾¤çš„æ“ä½œè¦è°¨æ…ï¼Œå°¤å…¶æ˜¯ä½¿ç”¨æ­£åˆ™æ¥åŒ¹é… context nameï¼›è¿˜æœ‰ -q å‚æ•°ä¼šè·³è¿‡è¦æ“ä½œçš„é›†ç¾¤æé†’ï¼Œç›´æ¥æ‰§è¡Œå‘½ä»¤ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/11/30/toolsg7ceb2b2061280.jpg","permalink":"https://atbug.com/multi-clusters-operation-with-kubectl-foreach/","tags":["Kubernetes","å¤šé›†ç¾¤","å·¥å…·"],"title":"kubectl foreach åœ¨å¤šä¸ªé›†ç¾¤ä¸­æ‰§è¡Œ kubectl å‘½ä»¤"},{"categories":["äº‘åŸç”Ÿ"],"contents":"ç”±äºå„ç§åŸå› ï¼Œé‡‡ç”¨ Kubernetes çš„ä¼ä¸šå†…éƒ¨å­˜åœ¨ç€å‡ ä¸ªã€å‡ åç”šè‡³ä¸Šç™¾ä¸ªé›†ç¾¤ã€‚æ¯”å¦‚å¤„äºç ”å‘æµç¨‹ä¸Šçš„è€ƒè™‘ï¼Œä¸åŒç¯å¢ƒä¸‹éƒ½å­˜åœ¨ç‹¬ç«‹çš„é›†ç¾¤ï¼›ç›‘ç®¡å±‚é¢çš„è€ƒè™‘ï¼Œå°±åœ°å­˜å‚¨çš„ç”¨æˆ·æ•°æ®éœ€è¦æ­é…åº”ç”¨é›†ç¾¤ï¼›å•ä¸ªé›†ç¾¤çš„å®¹é‡é™åˆ¶ï¼Œæ— æ³•æ»¡è¶³ä¸šåŠ¡ä½“é‡ï¼›å¯ç”¨æ€§è¦æ±‚çš„å¤šäº‘ã€å¤šåœ°ã€å¤šä¸­å¿ƒï¼›Kubernetes åŸåœ°å‡çº§æˆæœ¬å¤§è¿›è€Œè€ƒè™‘æ–°å»ºé›†ç¾¤ï¼Œç­‰ç­‰å„ç§åŸå› ã€‚ç„¶è€Œï¼ŒKubernetes è®¾è®¡ä¹‹åˆå¹¶æ²¡æœ‰è€ƒè™‘å¤šé›†ç¾¤ã€‚\nè¿™äº›é›†ç¾¤å½¼æ­¤ä¹‹é—´çœ‹ä¼¼ç‹¬ç«‹ï¼Œä½†åˆæœ‰ç€åƒä¸ä¸‡ç¼•çš„å…³ç³»ã€‚æ¯”å¦‚é«˜å¯ç”¨æ€§çš„å¤šé›†ç¾¤ï¼Œå®ç°äº†é›†ç¾¤çº§çš„ç¾å¤‡ï¼Œä½†é›†ç¾¤ä¸­çš„æœåŠ¡å¦‚ä½•å®ç°è·¨é›†ç¾¤çš„æ•…éšœè¿ç§»ï¼Ÿ\næˆ‘ä»¬å…ˆçœ‹ä¸‹é›†ç¾¤å†…çš„åº”ç”¨å¦‚ä½•å¯¹é›†ç¾¤å¤–æä¾›æœåŠ¡ã€‚ç”±äº Kubernetes ç½‘ç»œéš”ç¦»ç‰¹æ€§ï¼Œå­˜åœ¨ç€å¤©ç„¶çš„ç½‘ç»œè¾¹ç•Œï¼Œéœ€è¦å€ŸåŠ©æŸäº›æ–¹æ¡ˆï¼ˆå¦‚ Ingressã€NodePortï¼‰æ¥å°†æœåŠ¡æš´éœ²åˆ°é›†ç¾¤å¤–ã€‚è™½ç„¶è§£å†³äº†è¿é€šæ€§çš„é—®é¢˜ï¼Œä½†æ˜¯æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°è¿˜æ— æ³•è§£å†³ã€‚\né€šå¸¸æˆ‘ä»¬å°† Service ä½œä¸º Kubernetes å¹³å°çš„æœåŠ¡æ³¨å†Œå’Œå‘ç°ï¼Œä»Šå¤©è¦ä»‹ç»çš„ Multi-Cluster Serviceï¼ˆå¤šé›†ç¾¤æœåŠ¡ APIï¼Œç®€ç§° MCS APIï¼‰ åˆ™å¯ä»¥çœ‹æˆæ˜¯ è·¨ Kubernetes é›†ç¾¤çš„æœåŠ¡æ³¨å†Œå‘ç°ã€‚\nMCS ä»‹ç» MCS API æ¥è‡ª Kubernetes Enhancement Proposal KEP-1645: Multi-Cluster Services API ç›®å‰è¿˜å¤„äºææ¡ˆé˜¶æ®µã€‚\nMCS çš„ç›®æ ‡æ˜¯æ—¢ç„¶å¤šé›†ç¾¤ä¸å¯é¿å…ï¼Œé‚£å°±å®šä¹‰ä¸€å¥— API æ¥å®ç°æœåŠ¡çš„è·¨é›†ç¾¤æ³¨å†Œå’Œå‘ç°ï¼Œå¹¶ä¸”è¿™å¥— API è¶³å¤Ÿè½»é‡çº§ï¼Œåšåˆ°èƒ½å¤Ÿåƒè®¿é—®æœ¬åœ°æœåŠ¡ä¸€æ ·è®¿é—®å…¶ä»–é›†ç¾¤çš„æœåŠ¡ã€‚\næ³¨æ„ MCS API åªæä¾› API å’Œå®ç°çš„è®¾è®¡æŒ‡å¯¼ï¼Œä¸æä¾›å…·ä½“çš„å®ç°ã€‚\næœ¯è¯­ clustersetï¼šé›†ç¾¤é›†ï¼Œé›†åˆå†…çš„é›†ç¾¤é—´å…±äº«æœåŠ¡ã€‚ mcs-controllerï¼šå¤šé›†ç¾¤æœåŠ¡æ§åˆ¶å™¨ï¼Œåœ¨å¤šé›†ç¾¤é—´å®ŒæˆæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ã€‚ cluster nameï¼šé›†ç¾¤çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨ä»¥æ ‡è¯†æ³¨å†Œçš„æœåŠ¡æ¥è‡ªå“ªä¸ªé›†ç¾¤ã€‚ CRD ServiceExport å®šä¹‰å¯¹é›†ç¾¤é›†ä¸­å…¶ä»–é›†ç¾¤æš´éœ²çš„æœåŠ¡ï¼Œä¸ Service ä¸€æ ·å¿…é¡»åˆ›å»ºåœ¨ä¸è´Ÿè½½ç›¸åŒçš„å‘½åç©ºé—´ä¸‹ï¼Œä¸”ä¸ Service åŒåã€‚ ServiceImport å®šä¹‰äº†å¯¼å…¥çš„å…¶ä»–é›†ç¾¤çš„ Serviceã€‚ type ServiceExport struct { metav1.TypeMeta `json:\u0026#34;,inline\u0026#34;` metav1.ObjectMeta `json:\u0026#34;metadata,omitempty\u0026#34;` Status ServiceExportStatus `json:\u0026#34;status,omitempty\u0026#34;` } type ServiceImport struct { metav1.TypeMeta `json:\u0026#34;,inline\u0026#34;` metav1.ObjectMeta `json:\u0026#34;metadata,omitempty\u0026#34;` Spec ServiceImportSpec `json:\u0026#34;spec,omitempty\u0026#34;` Status ServiceImportStatus `json:\u0026#34;status,omitempty\u0026#34;` } type ServiceImportSpec struct { Ports []ServicePort `json:\u0026#34;ports\u0026#34;` IPs []string `json:\u0026#34;ips,omitempty\u0026#34;` Type ServiceImportType `json:\u0026#34;type\u0026#34;` SessionAffinity corev1.ServiceAffinity `json:\u0026#34;sessionAffinity\u0026#34;` SessionAffinityConfig *corev1.SessionAffinityConfig `json:\u0026#34;sessionAffinityConfig\u0026#34;` } è·¨é›†ç¾¤æœåŠ¡æ³¨å†Œ å¦‚æœå¤šä¸ªé›†ç¾¤éƒ½ä»¥åŒæ ·çš„åå­—å’Œå‘½åç©ºé—´å¯¹å¤–å£°æ˜æœåŠ¡ï¼Œè¿™äº›æœåŠ¡å°†è¢«è§†ä½œå•ä¸€çš„ç»„åˆæœåŠ¡ã€‚ä¾‹å¦‚ 1 ä¸ªé›†ç¾¤é›†ä¸‹æœ‰ 4 ä¸ªé›†ç¾¤ï¼Œå…¶ä¸­ 1 ä¸ªé›†ç¾¤åœ¨å‘½åç©ºé—´ bar ä¸‹æœ‰ä¸ªåä¸º foo çš„ Serviceã€‚å…¶ä»–é›†ç¾¤è¦æƒ³ä½¿ç”¨è¯¥é›†ç¾¤çš„ Serviceï¼Œè¯¥é›†ç¾¤éœ€è¦å¯¹å¤–å£°æ˜è¯¥ Service æ˜¯å¯ä»¥è·¨é›†ç¾¤æä¾›æœåŠ¡ï¼Œå®Œæˆå¤šé›†ç¾¤æœåŠ¡çš„æ³¨å†Œã€‚\nå¤šé›†ç¾¤æœåŠ¡çš„æ³¨å†Œé€šè¿‡åœ¨ Service çš„åŒå‘½åç©ºé—´ä¸‹åˆ›å»ºåŒåçš„ ServiceExport èµ„æºæ¥å®Œæˆã€‚ServiceExport å¯ä»¥æ‰‹åŠ¨åˆ›å»ºï¼Œä¹Ÿå¯ä»¥å®ç°æ”¯æŒæœåŠ¡çš„è‡ªåŠ¨æ³¨å†Œï¼šæ ¹æ®æ ‡è¯†å°†é›†ç¾¤å†…æˆ–è€…æŒ‡å®šå‘½åç©ºé—´ä¸‹çš„æœåŠ¡è‡ªåŠ¨æ³¨å†Œã€‚\næ›´å¤šçš„è®¾è®¡ç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒ Service Exporting è®¾è®¡ç»†èŠ‚ã€‚\nè·¨é›†ç¾¤æœåŠ¡å‘ç° åœ¨ ServiceExport èµ„æºåˆ›å»ºå®Œæˆåï¼Œè¯¥æœåŠ¡ä¼šè¢«é›†ç¾¤é›†ä¸‹çš„å…¶ä»–é›†ç¾¤â€œå‘ç°â€ï¼šåŒåçš„å‘½åç©ºé—´ä¸‹å‡ºç°åŒåçš„ ServiceImport èµ„æºï¼Œå¹¶ä¸”è¯¥ ServiceImport ä¸æœåŠ¡æ³¨å†Œçš„ Endpoint ç›¸å…³è”ã€‚\nåŒæ ·ï¼Œå¦‚æœä¸€ä¸ªæœåŠ¡ä¸‹çº¿æˆ–è€…åœæ­¢è·¨é›†ç¾¤æœåŠ¡ï¼Œåˆ é™¤ ServiceExport èµ„æºåï¼Œå…¶ä»–é›†ç¾¤ä¸­çš„ ServiceImport ä¹Ÿä¼šç›¸åº”çš„åœ°è¢«é”€æ¯ã€‚ServiceImport çš„ç®¡ç†ï¼Œç”± MCS å®ç°ä¸­çš„ mcs-controller æ¥å®Œæˆã€‚\nå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå…³äº ServiceImport çš„ä½¿ç”¨ï¼Œè¯¥æ ‡å‡†ä¸­å¹¶æœªç•Œå®šå…·ä½“çš„å®ç°ç»†èŠ‚ã€‚ç”±äº Pod åœ¨ Kubernetes ä¸­æ˜¯éæ°¸ä¹…æ€§èµ„æºï¼Œæˆ‘ä»¬è®¿é—®åº”ç”¨çš„æ—¶å€™é€šå¸¸ä½¿ç”¨ Serviceã€‚å¤šé›†ç¾¤æœåŠ¡çš„ç†æƒ³æƒ…å†µï¼Œæ˜¯åœ¨ä½¿ç”¨ Service çš„æ—¶å€™èƒ½è‡ªåŠ¨ä½¿ç”¨å…¶ä»–é›†ç¾¤çš„ Endpointsï¼Œåšåˆ°å¯¹åº”ç”¨çš„æ— æ„ŸçŸ¥ã€‚\nä¸€ç§æ–¹æ¡ˆæ˜¯ä¿®æ”¹ Service API çš„å®ç°ï¼ˆæ¯”å¦‚ kube-proxyï¼‰ è¿›è¡Œæ¥ä½¿ç”¨ ServiceImportã€‚\nå¦ä¸€ç§æ–¹æ¡ˆåˆ™æ˜¯ä¸éœ€è¦ä¿®æ”¹ç°åœ¨ Service API çš„å®ç°ï¼Œç”± mcs-controller æ¥åˆ›å»ºå½±å­æœåŠ¡ï¼Œæ”¹æœåŠ¡ä¸æ–°åˆ›å»ºçš„ EndpointSlice å…³é”®å…³è”ï¼Œåè€…èšåˆäº†è¯¥è·¨æœåŠ¡çš„çš„æ‰€æœ‰ Endpointsã€‚ä¸€ä¸ª ServiceImport ä¸‹å¯èƒ½æœ‰æ¥è‡ªå¤šä¸ªé›†ç¾¤çš„ EndpointSliceï¼Œæ¯ä¸ª EndpointSlice ä¸Šæœ‰å„è‡ªé›†ç¾¤çš„æ ‡è¯†ã€‚\nåœ¨å®˜æ–¹çš„è®¾è®¡ç»†èŠ‚ä¸­å»ºè®®äº† ClusterIP å’Œ DNS çš„æ–¹æ¡ˆå¹¶æä¾›äº†ç»†èŠ‚ï¼Œä½†ä¸æ˜¯å”¯ä¸€çš„å®ç°æ–¹æ¡ˆã€‚\næ€»ç»“ MCS API å¸Œæœ›åœ¨ API çš„å±‚é¢æä¾›å¤šé›†ç¾¤æœåŠ¡çš„å®šä¹‰ï¼Œä½†ç”±äºå…¶å®ç°çš„å¤æ‚æ€§ï¼Œè¯¥ææ¡ˆçš„è¿›å±•ç¼“æ…¢ã€‚ä» 2020.2 æå‡ºæ–¹æ¡ˆï¼Œåˆ° 2020.8 æä¾› API çš„ alpha å®ç°ä¹‹åæ²¡æœ‰å¤šå°‘è¿›å±•ã€‚\nå³ä¾¿å¦‚æ­¤ï¼Œå¤šé›†ç¾¤æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°æœºåˆ¶å¯ä»¥ç»™åé¢çš„å®ç°å¸¦æ¥ä¸€å®šçš„å‚è€ƒä»·å€¼ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/11/27/sunsetg55251915a1280.jpg","permalink":"https://atbug.com/kubernetes-multi-cluster-api/","tags":["Kubernetes","å¤šé›†ç¾¤"],"title":"è®¤è¯†ä¸€ä¸‹ Kubernetes å¤šé›†ç¾¤æœåŠ¡ API"},{"categories":["ç”Ÿæ´»"],"contents":"é¦–å…ˆè¿™ç¯‡æ–‡ç« ä¸è®²ä»»ä½•æ”¿ç­–çš„ä¸œè¥¿ï¼Œæ²¡æœ‰å¯¹æ”¿ç­–å’Œäººå‘˜çš„åæ§½ã€‚ç›¸åï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­æ„Ÿå—åˆ°çš„éƒ½æ˜¯ç†è§£å’Œæ”¯æŒã€‚æ­£å¦‚æ ‡é¢˜æ‰€å†™å›å®¶çš„è¿‡ç¨‹æœ‰æ›²æŠ˜ï¼Œä½†å½±å“ä¸å¤§ï¼Œè€Œç»“æœè®©æˆ‘æœ‰ç‚¹æƒ³ç¬‘ï¼šå°±è¿™ï¼Ÿ\nä½œä¸ºä¸€åç¨‹åºå‘˜ï¼Œæœ‰å¿…è¦å¯¹é—®é¢˜åšä¸ªå¤ç›˜ï¼Œæ‘¸æ¸…æ•´ä¸ªæµç¨‹ï¼Œäº†è§£ä¸‹æ”¯æ’‘å’±ä»¬ç–«æƒ…é˜²æ§çš„éƒ¨åˆ†ç³»ç»Ÿæƒ…å†µï¼Œè¿›è€Œæ€è€ƒä¸‹æˆ‘ä»¬åœ¨æ•°å­—åŒ–æ”¹é€ è¿‡ç¨‹ä¸­å¯èƒ½æœ‰å“ªäº›ä¸è¶³ã€‚\nèƒŒæ™¯ ä¸Šä¸ªæœˆåº•æˆ‘å› å…¬å»ç¾å›½åº•ç‰¹å¾‹å‚åŠ äº† KubeCon + CloudNativeCon 2022 NA ï¼Œä»èµ°ä¹‹å‰çš„å„ç§å¿å¿‘ï¼Œåˆ°å‡ºå»ä¹‹åçš„å¦ç„¶ï¼Œä»¥åŠæœ€åé¡ºåˆ©çš„æ»¡è½½è€Œå½’ã€‚æ”¶è·å¾ˆå¤šï¼Œè¿™é‡Œæš‚ä¸”ä¸è¡¨ï¼Œåé¢æˆ‘å¯èƒ½ä¹ŸæŠ½æ—¶é—´å†™ä¸€ä¸‹ã€‚\nç›®å‰å›½å†…çš„å…¥å¢ƒé˜²ç–«æ”¿ç­–æ˜¯ 7 å¤©çš„é…’åº—é›†ä¸­éš”ç¦»ä»¥åŠ 3 å¤©çš„å±…å®¶å¥åº·ç›‘æµ‹ã€‚æˆ‘åœ¨ 11 æœˆ 2 æ—¥è½åœ°ä¸Šæµ·å¹¶é¡ºåˆ©å…¥ä½éš”ç¦»é…’åº—ï¼Œå¼€å§‹äº† 7 å¤©çš„éš”ç¦»ã€‚å®¶äººå¸®å¿™ä»å±…å§”ä¼šå’¨è¯¢äº†å¯ä»¥å›å¹¿å·å±…å®¶æ£€æµ‹ï¼Œå¾€è¿”æœºåœºä¸¤è¾¹éƒ½ä¼šæä¾›å°é—­è½¬è¿ã€‚å› æ­¤æˆ‘é€‰æ‹©äº†åœ¨ä¸Šæµ·éš”ç¦» 7 å¤©ï¼Œä¹Ÿæ—©æ—©é¢„å®šäº† 7 å¤©åå°±æ˜¯ 11 æœˆ 9 æ—¥è¿”ç©—çš„æœºç¥¨ã€‚åœ¨ 9 å·è§£ç¦»å‰ä¸€å¤©æä¾›å±…ä½æ‰€åœ¨åœ°çš„æ¥æ”¶è¯æ˜å³å¯ã€‚\nå„åœ°çš„æ”¿ç­–ä¸åŒï¼Œæœ‰çš„åŸå¸‚æ˜¯å¯ä»¥æä¾›ç›–ç« çš„è¯æ˜ï¼Œæœ‰äº›åŸå¸‚å·²ç»å®Œæˆäº†æ— çº¸åŒ–çš„æµç¨‹ã€‚è¿™å°±åƒæˆ‘ä»¬åšç³»ç»Ÿé›†æˆçš„æ—¶å€™ï¼Œè¦è€ƒè™‘é’ˆå¯¹ä¸åŒç³»ç»Ÿçš„æƒ…å†µé€‰æ‹©åˆé€‚çš„é›†æˆæ–¹æ¡ˆã€‚\nè¿‡ç¨‹ å¹¿å·æ­£æ˜¯å®Œæˆäº†æ•°å­—åŒ–çš„åŸå¸‚ä¹‹ä¸€ï¼ˆå…¶ä»–åŸå¸‚æˆ‘ä¹Ÿä¸äº†è§£ï¼‰ï¼Œåªè¦åœ¨å¾®ä¿¡å°ç¨‹åº ç²¤çœäº‹ ä¸Šæ‰¾åˆ° å…¥ç²¤å¥åº·ç”³æŠ¥ï¼ŒæŒ‰ç…§æç¤ºä¿¡æ¯å¦‚å®å¡«å†™å³å¯ã€‚æäº¤ä¹‹åï¼Œç”³æŠ¥ä¼šæ´¾å‘åˆ°ç›®çš„åœ°æ‰€åœ¨çš„å±…å§”ä¼šï¼Œå±…å§”ä¼šçš„å·¥ä½œäººå‘˜æ ¹æ®æƒ…å†µè¿›è¡Œå®¡æ‰¹å³å¯ã€‚\næŒ‰ç…§æˆ‘å’Œå·¥ä½œäººå‘˜çš„ç†è§£ï¼Œæµç¨‹å°±æ˜¯è¿™æ ·ï¼Œå¾ˆç®€å•å‘ã€‚ç„¶è€Œä¸ç„¶ï¼Œç³»ç»Ÿä¼šæœ‰æ‰€å·®å¼‚ã€‚\nä¸Šé¢æ˜¯æˆ‘ç»è¿‡ä¸¤æ¬¡æäº¤ç”³è¯·ï¼Œå¹¶è·Ÿå·¥ä½œäººå‘˜å¤šæ¬¡æ²Ÿé€šåâ€œæ‚Ÿâ€å‡ºçš„æµé‡ã€‚\nèµ·åˆåœ¨ç¬¬ 2 æ­¥å°±é‡åˆ°äº†é—®é¢˜ï¼Œæäº¤å¥åº·ç”³æŠ¥åå·¥ä½œäººå‘˜æ²¡æœ‰çœ‹åˆ°ç”³è¯·ï¼Œè€Œæ˜¯è¿‡äº†å‡ ä¸ªå°æ—¶å€™æ‰çœ‹åˆ°ã€‚\nå¦ä¸€ä¸ªé—®é¢˜å°±æ˜¯åœ¨ç¬¬ 4 æ­¥ï¼Œå·¥ä½œäººå‘˜å®¡æ‰¹å®Œå¥åº·ç”³æŠ¥å¹¶é€šçŸ¥æˆ‘ï¼Œæˆ‘åœ¨å°ç¨‹åºä¸­æŸ¥è¯¢çš„è¿˜æ˜¯å¾…å®¡æ‰¹çš„çŠ¶æ€ã€‚æ‰“å¤šæ–¹ç”µè¯æ— æœï¼Œå–æ¶ˆç”³è¯·é‡æ–°æäº¤ï¼Œç„¶åé‡æ–°ç»å†å‰é¢çš„ç­‰å¾…ï¼Œå¹¶æœ€ç»ˆåˆå¡åœ¨äº†ç¬¬ 4 æ­¥ã€‚äºæ˜¯ï¼Œæœ‰äº†ä¸‹é¢çš„å¯¹è¯ã€‚\nAï¼šâ€œä¹‹å‰å›å›½çš„äººå‘˜ï¼Œéƒ½æ˜¯è¿™ä¹ˆå¤„ç†çš„ã€‚â€ Bï¼šâ€œ\u0026hellip;\u0026hellip;â€ Aï¼šâ€œä½ æ˜¯ä¸æ˜¯è¿˜æäº¤äº†ä¸€ä¸ªå±…å®¶ç®¡ç†æ¡ä»¶å®¡æ ¸çš„ï¼Ÿâ€ Bï¼šâ€œé‚£æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œæˆ‘æ²¡æœ‰æäº¤ï¼ä»å“ªé‡Œæäº¤ï¼Ÿâ€ Aï¼šâ€œæˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œä½†æ˜¯é‡Œé¢æ˜¯ä½ çš„ä¿¡æ¯ï¼Œæˆ‘å®¡æ ¸ä½†æ˜¯å®¡æ ¸ä¸äº†ï¼Œå› ä¸ºé‡Œé¢çš„åœ°å€ä¸æ­£ç¡®ã€‚â€ Bï¼šâ€œèƒ½ä¸èƒ½ç»™æˆ‘ä¸ªæˆªå›¾çœ‹çœ‹ï¼Ÿâ€ (å†…å¿ƒï¼šå§æ§½ï¼Œè‚¯å®šæ˜¯ç³»ç»Ÿè‡ªåŠ¨ä¸‹å‘çš„)\näºæ˜¯å°±æœ‰äº†ä¸‹é¢è¿™å¼ å›¾ï¼Œä¸¤ä¸ªå¤§å¤§çš„ null æ˜ å…¥çœ¼å¸˜ã€‚æŒ‰ç…§æˆ‘çš„ç†è§£è¿™ç§å¼ºæµç¨‹çº¦æŸçš„ï¼Œé‡åˆ°è¿™ç§é—®é¢˜å¾ˆæ£˜æ‰‹ã€‚å¦‚æœä¸èƒ½ç´§æ€¥å‘å¸ƒä¿®å¤çš„è¯ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æ‰‹åŠ¨å»ä¿®æ”¹æ•°æ®åº“äº†ã€‚è¿™ç§æ—¶å€™ï¼Œä¸ç®¡å“ªç§æªæ–½çš„æˆæœ¬éƒ½å¹¶ä¸ä½ã€‚\næœä¸å…¶ç„¶ï¼Œæœ€ç»ˆå±…å§”å·¥ä½œäººå‘˜å‘ŠçŸ¥ç³»ç»Ÿé—®é¢˜æš‚æ—¶è§£å†³ä¸äº†ï¼Œè¿˜æ˜¯å¼€å…·äº†çº¸è´¨çš„è¯æ˜ï¼Œæ˜å¤©æˆ‘å¯ä»¥å›å®¶äº†ã€‚\næ€è€ƒ éœ€è¦å†æ¬¡æ„Ÿè°¢æ•´ä¸ªè¿‡ç¨‹ä¸­ä¸¤åœ°å·¥ä½œäººå‘˜ç»†å¿ƒä¸”è€å¿ƒçš„å¸®åŠ©ã€‚\nä½œä¸ºä¸€ä¸ªä»ä¸šäººå‘˜ï¼Œä¸å¾—ä¸æ€è€ƒä¸‹ç»å¸¸è¯´çš„â€œæ•°å­—åŒ–è½¬å‹â€ï¼ŒçœŸæ­£è¦åšçš„å…¶å®å¹¶ä¸ä»…ä»…åœ¨æŠ€æœ¯ä¸Šï¼Œåè€ŒæŠ€æœ¯ä¹‹å¤–çš„æ‰æ˜¯å†³å®šæœ€åèƒ½å¦è½åœ°çš„â€œæœ€å 1kmâ€ã€‚\nç³»ç»Ÿçš„æŠ€æœ¯ bug å¯ä»¥é€šè¿‡å…¶ä»–çš„æ‰‹æ®µæ¥å°½é‡é¿å…ï¼Œæ¯•ç«Ÿä¸å­˜åœ¨æ²¡æœ‰ bug çš„ç³»ç»Ÿã€‚ä½†æ˜¯å½“ä¸šåŠ¡æ•°å­—åŒ–ä¹‹åï¼Œç”±äºæŠ€æœ¯é—®é¢˜é˜»ç¢äº†æµç¨‹ï¼Œæœ‰æ²¡æœ‰è¡¥æ•‘çš„æªæ–½ã€èƒ½å¦å†ç”¨éæ•°å­—åŒ–çš„æ–¹å¼æ¥è§£å†³ã€‚ äººå‘˜ç¼ºä¹åŸ¹è®­ï¼Œç¼ºå°‘å¿…è¦çš„ç”¨æˆ·æ‰‹å†Œæˆ–è€…æ‰‹å†Œæ›´æ–°ä¸åŠæ—¶ã€‚æˆ‘ä¸æ€€ç–‘ä¸€çº¿äººå‘˜çš„èƒ½åŠ›ï¼Œç°åœ¨å±…å§”å·¥ä½œäººå‘˜å¹´è½»åŒ–ã€é«˜å­¦å†ï¼Œä»æœåŠ¡æ€åº¦å’Œä¸“ä¸šç¨‹åº¦ä¸Šéƒ½å¾ˆå¤§çš„æå‡ï¼ˆæˆ‘æ‰€æ¥è§¦åˆ°çš„ï¼Œå…¶ä»–åœ°æ–¹çš„ä¸æ¸…æ¥šï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹ç»™æˆ‘çš„æ„Ÿè§‰æ˜¯ç³»ç»Ÿæ›´æ–°äº†æµç¨‹ï¼Œä½†æ˜¯ä¸€çº¿äººå‘˜å¹¶ä¸æ¸…æ¥šï¼Œä¸”é‡åˆ°é—®é¢˜æ— ä»ä¸‹æ‰‹ã€‚ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/11/08/pexelsrobertonickson2559941.jpg","permalink":"https://atbug.com/thoughts-after-encountering-null/","tags":null,"title":"å› ä¸º null null éš”ç¦»ç»“æŸçš„æˆ‘å·®ç‚¹ä¸èƒ½å›å®¶"},{"categories":["ç¿»è¯‘"],"contents":"æœåŠ¡ç½‘æ ¼ä»¥å…¸å‹çš„ sidecar æ¨¡å‹ä¸ºäººç†ŸçŸ¥ï¼Œå°† sidecar å®¹å™¨ä¸åº”ç”¨å®¹å™¨éƒ¨ç½²åœ¨åŒä¸€ä¸ª Pod ä¸­ã€‚è™½è¯´ sidecar å¹¶éå¾ˆæ–°çš„æ¨¡å‹ï¼ˆæ“ä½œç³»ç»Ÿçš„ systemdã€initdã€cron è¿›ç¨‹ï¼›Java çš„å¤šçº¿ç¨‹ï¼‰ï¼Œä½†æ˜¯ä»¥è¿™ç§ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»çš„æ–¹å¼æ¥æä¾›æœåŠ¡æ²»ç†ç­‰åŸºç¡€èƒ½åŠ›çš„è®¾è®¡è¿˜æ˜¯è®©äººä¸€äº®ã€‚\néšç€ eBPF ç­‰æŠ€æœ¯çš„å¼•å…¥ï¼Œæœ€è¿‘å…³äºæœåŠ¡ç½‘æ ¼æ˜¯å¦éœ€è¦ sidecar ï¼ˆä¹Ÿå°±æ˜¯ sidecarlessï¼‰çš„è®¨è®ºæ¸å¢ã€‚\nç¬”è€…è®¤ä¸ºä»»ä½•é—®é¢˜éƒ½æœ‰å…¶èµ·å› ï¼Œé•¿ä¹…å›°æ‰°æœåŠ¡ç½‘æ ¼çš„ä¸å¤–ä¹æ€§èƒ½å’Œèµ„æºå ç”¨ã€‚è¿™ç¯‡æ–‡ç« ç¿»è¯‘è‡ª Buoyant çš„ Flynn æ–‡ç«  eBPF and the Service Mesh: Don\u0026rsquo;t Dismiss the Sidecar Yetã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©å¤§å®¶ç©¿é€è¿·é›¾çœ‹é€äº‹ç‰©çš„æœ¬è´¨ã€‚\næœ¬æ–‡è¦ç‚¹ eBPF æ˜¯ä¸€ä¸ªæ—¨åœ¨é€šè¿‡ï¼ˆè°¨æ…åœ°ï¼‰å…è®¸åœ¨å†…æ ¸ä¸­è¿è¡Œä¸€äº›ç”¨æˆ·ä»£ç æ¥æé«˜æ€§èƒ½çš„å·¥å…·ã€‚ åœ¨å¯é¢„è§çš„æœªæ¥ï¼ŒæœåŠ¡ç½‘æ ¼æ‰€éœ€çš„ç¬¬ 7 å±‚å¤„ç†åœ¨ eBPF ä¸­ä¸å¤ªå¯èƒ½å®ç°ï¼Œè¿™æ„å‘³ç€ç½‘æ ¼ä»ç„¶éœ€è¦ä»£ç†ã€‚ ä¸ sidecar ä»£ç†ç›¸æ¯”ï¼Œæ¯ä¸ªä¸»æœºä»£ç†å¢åŠ äº†æ“ä½œå¤æ‚æ€§å¹¶é™ä½äº†å®‰å…¨æ€§ã€‚ å¯ä»¥é€šè¿‡æ›´å°ã€æ›´å¿«çš„ Sidecar ä»£ç†æ¥è§£å†³æœ‰å…³ Sidecar ä»£ç†çš„å…¸å‹æ€§èƒ½é—®é¢˜ã€‚ ç›®å‰ï¼Œsidecar æ¨¡å‹å¯¹æœåŠ¡ç½‘æ ¼ä»æ˜¯æœ€æœ‰æ„ä¹‰çš„ã€‚ å…³äº eBPF çš„æ•…äº‹å·²ç»åœ¨äº‘åŸç”Ÿä¸–ç•Œä¸­æ³›æ»¥äº†ä¸€æ®µæ—¶é—´ï¼Œæœ‰æ—¶å°†å…¶æè¿°ä¸ºè‡ªåˆ‡ç‰‡é¢åŒ…ä»¥æ¥æœ€ä¼Ÿå¤§çš„äº‹ç‰©ï¼Œæœ‰æ—¶åˆ™å˜²ç¬‘å®ƒæ˜¯å¯¹ç°å®ä¸–ç•Œçš„æ— ç”¨å¹²æ‰°ã€‚å½“ç„¶ï¼Œç°å®è¦å¾®å¦™å¾—å¤šï¼Œå› æ­¤ä»”ç»†ç ”ç©¶ä¸€ä¸‹ eBPF èƒ½åšä»€ä¹ˆå’Œä¸èƒ½åšä»€ä¹ˆä¼¼ä¹æ˜¯æœ‰å¿…è¦çš„â€”â€”æŠ€æœ¯æ¯•ç«Ÿåªæ˜¯å·¥å…·ï¼Œä½¿ç”¨çš„å·¥å…·åº”è¯¥é€‚åˆæ‰‹å¤´çš„ä»»åŠ¡ã€‚\næœ€è¿‘ç»å¸¸å‡ºç°çš„ä¸€é¡¹ç‰¹æ®Šä»»åŠ¡æ˜¯æœåŠ¡ç½‘æ ¼æ‰€éœ€çš„å¤æ‚çš„ç¬¬ 7 å±‚å¤„ç†ã€‚å°†å…¶äº¤ç»™ eBPF å¯èƒ½å¯¹æœåŠ¡ç½‘æ ¼æ¥è¯´æ˜¯ä¸€ä¸ªå·¨å¤§çš„èƒœåˆ©ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ eBPF å¯èƒ½æ‰®æ¼”çš„è§’è‰²ã€‚\nç©¶ç«Ÿä»€ä¹ˆæ˜¯ eBPFï¼Ÿ è®©æˆ‘ä»¬å…ˆæŠŠè¿™ä¸ªåå­—å¼„æ¸…æ¥šï¼šâ€œeBPFâ€æœ€åˆæ˜¯â€œextended Berkeley Packet Filterâ€ï¼ˆæ‰©å±•çš„ä¼¯å…‹åˆ©åŒ…è¿‡æ»¤å™¨ï¼‰ï¼Œå°½ç®¡ç°åœ¨å®ƒ æ ¹æœ¬ä¸ä»£è¡¨ä»»ä½•ä¸œè¥¿ã€‚Berkeley æ•°æ®åŒ…è¿‡æ»¤å™¨å¯ä»¥è¿½æº¯åˆ°è¿‘ 30 å¹´å‰ï¼šå®ƒæ˜¯ä¸€ç§å…è®¸ç”¨æˆ·åº”ç”¨ç¨‹åºç›´æ¥åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­è¿è¡ŒæŸäº›ä»£ç ï¼ˆå¯ä»¥è‚¯å®šæ˜¯ç»è¿‡ä¸¥æ ¼å®¡æŸ¥å’Œé«˜åº¦çº¦æŸçš„ä»£ç ï¼‰çš„æŠ€æœ¯ã€‚BPF ä»…é™äºç½‘ç»œå †æ ˆï¼Œä½†å®ƒä»ç„¶ä½¿ä¸€äº›æƒŠäººçš„äº‹æƒ…æˆä¸ºå¯èƒ½ï¼š\nå…¸å‹çš„ä¾‹å­æ˜¯ï¼Œå®ƒå¯ä»¥ä½¿è¯•éªŒæ–°å‹é˜²ç«å¢™ä¹‹ç±»çš„ä¸œè¥¿å˜å¾—æ›´åŠ å®¹æ˜“ã€‚æ— éœ€ä¸æ–­åœ°é‡æ–°ç¼–è¯‘å†…æ ¸æ¨¡å—ï¼Œåªéœ€å¯¹ eBPF ä»£ç è¿›è¡Œç¼–è¾‘å¹¶é‡æ–°åŠ è½½ã€‚ åŒæ ·ï¼Œå®ƒå¯ä»¥ä¸ºè½»æ¾å¼€å‘ä¸€äº›éå¸¸å¼ºå¤§çš„ç½‘ç»œåˆ†ææ‰“å¼€å¤§é—¨ï¼ŒåŒ…æ‹¬é‚£äº›ä¸æƒ³åœ¨å†…æ ¸ä¸­è¿è¡Œçš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæƒ³ä½¿ç”¨æœºå™¨å­¦ä¹ å¯¹ä¼ å…¥æ•°æ®åŒ…è¿›è¡Œåˆ†ç±»ï¼Œå¯ä»¥ä½¿ç”¨ BPF æŠ“å–æ„Ÿå…´è¶£çš„æ•°æ®åŒ…å¹¶å°†å®ƒä»¬äº¤ç»™è¿è¡Œ ML æ¨¡å‹çš„åº”ç”¨ç¨‹åºã€‚ è¿˜æœ‰å…¶ä»–ä¾‹å­ï¼šè¿™åªæ˜¯ BPF å®ç°çš„ä¸¤ä»¶éå¸¸æ˜æ˜¾çš„äº‹æƒ… 1Â â€” eBPF é‡‡ç”¨äº†ç›¸åŒçš„æ¦‚å¿µå¹¶å°†å…¶æ‰©å±•åˆ°ç½‘ç»œä»¥å¤–çš„é¢†åŸŸã€‚ä½†æ˜¯æ‰€æœ‰è¿™äº›è®¨è®ºéƒ½æå‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼Œå³ä¸ºä»€ä¹ˆè¿™ç§äº‹æƒ…é¦–å…ˆéœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚\nç®€çŸ­çš„å›ç­”æ˜¯â€œéš”ç¦»â€ã€‚\néš”ç¦» è®¡ç®—â€”â€”å°¤å…¶æ˜¯äº‘åŸç”Ÿè®¡ç®—â€”â€”åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºç¡¬ä»¶åŒæ—¶ä¸ºå¤šä¸ªå®ä½“åšå¤šé¡¹äº‹æƒ…çš„èƒ½åŠ›ï¼Œå³ä½¿å…¶ä¸­ä¸€äº›å®ä½“å¯¹å…¶ä»–å®ä½“æ€€æœ‰æ•Œæ„ã€‚è¿™æ˜¯ ç«äº‰æ€§å¤šç§Ÿæˆ· ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨å¯ä»¥è°ƒè§£å¯¹å†…å­˜æœ¬èº«çš„è®¿é—®çš„ç¡¬ä»¶è¿›è¡Œç®¡ç†ã€‚ä¾‹å¦‚ï¼Œåœ¨ Linux ä¸­ï¼Œæ“ä½œç³»ç»Ÿä¸ºè‡ªå·±åˆ›å»ºä¸€ä¸ªå†…å­˜ç©ºé—´ï¼ˆå†…æ ¸ç©ºé—´ï¼‰ï¼Œå¹¶ä¸ºæ¯ä¸ªç”¨æˆ·ç¨‹åºåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ç©ºé—´ï¼ˆç”¨æˆ·ç©ºé—´ï¼‰ï¼Œå°½ç®¡æ¯ä¸ªç¨‹åºéƒ½æœ‰è‡ªå·±çš„ç©ºé—´ä½†ç»Ÿç§°ä¸ºç”¨æˆ·ç©ºé—´ã€‚æ“ä½œç³»ç»Ÿç„¶åä½¿ç”¨ç¡¬ä»¶æ¥é˜²æ­¢ä»»ä½•è·¨ç©ºé—´è®¿é—® 2ã€‚Â ä¿æŒç³»ç»Ÿå„éƒ¨åˆ†ä¹‹é—´çš„è¿™ç§éš”ç¦»å¯¹äºå®‰å…¨æ€§å’Œå¯é æ€§éƒ½æ˜¯éå¸¸å…³é”®çš„â€”â€”åŸºæœ¬ä¸Š æ‰€æœ‰ è®¡ç®—å®‰å…¨éƒ½ä¾èµ–äºå®ƒï¼Œäº‹å®ä¸Šï¼Œäº‘åŸç”Ÿä¸–ç•Œæ›´åŠ ä¾èµ–å®ƒï¼Œä¹Ÿè¦ä¿æŒå†…æ ¸å®¹å™¨ä¹‹é—´çš„éš”ç¦»ã€‚å› æ­¤ï¼Œå†…æ ¸å¼€å‘äººå‘˜å…±åŒèŠ±è´¹äº†æ•°åƒäººå¹´çš„æ—¶é—´æ¥å®¡æŸ¥å›´ç»•è¿™ç§éš”ç¦»çš„æ¯ä¸€æ¬¡äº¤äº’ï¼Œå¹¶ç¡®ä¿å†…æ ¸éƒ½èƒ½æ­£ç¡®å¤„ç†ã€‚è¿™æ˜¯ä¸€é¡¹æ£˜æ‰‹çš„ã€ç²¾ç»†çš„ã€è‰°è‹¦çš„å·¥ä½œï¼Œé—æ†¾çš„æ˜¯ï¼Œåœ¨å‘ç°é”™è¯¯ä¹‹å‰å¸¸å¸¸è¢«å¿½è§†ï¼Œè€Œä¸”å®ƒæ˜¯æ“ä½œç³»ç»Ÿå®é™…æ‰€åšå·¥ä½œçš„ é‡è¦ ç»„æˆéƒ¨åˆ† 3ã€‚\nè¿™é¡¹å·¥ä½œå¦‚æ­¤æ£˜æ‰‹å’Œç²¾ç»†çš„éƒ¨åˆ†åŸå› æ˜¯å†…æ ¸å’Œç”¨æˆ·ç¨‹åºä¸èƒ½å®Œå…¨éš”ç¦»ï¼šç”¨æˆ·ç¨‹åºæ˜¾ç„¶éœ€è¦è®¿é—®æŸäº›æ“ä½œç³»ç»ŸåŠŸèƒ½ã€‚ä»å†å²ä¸Šçœ‹ï¼Œè¿™æ˜¯ ç³»ç»Ÿè°ƒç”¨ çš„é¢†åŸŸã€‚\nç³»ç»Ÿè°ƒç”¨ ç³»ç»Ÿè°ƒç”¨æˆ– syscall æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸å‘ç”¨æˆ·ä»£ç å…¬å¼€ API çš„åŸå§‹æ–¹å¼ã€‚å¯¹å¤§é‡ç»†èŠ‚è¿›è¡Œäº†ä¿®é¥°ï¼Œç”¨æˆ·ä»£ç å°†è¯·æ±‚æ‰“åŒ…å¹¶å°†å…¶äº¤ç»™å†…æ ¸ã€‚å†…æ ¸ä»”ç»†æ£€æŸ¥ä»¥ç¡®ä¿å…¶éµå¾ªäº†æ‰€æœ‰è§„åˆ™ï¼Œå¹¶ä¸”â€”â€”å¦‚æœä¸€åˆ‡çœ‹èµ·æ¥æ­£å¸¸â€”â€”å†…æ ¸å°†ä»£è¡¨ç”¨æˆ·æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶æ ¹æ®éœ€è¦åœ¨å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´å¤åˆ¶æ•°æ®ã€‚å…³äºç³»ç»Ÿè°ƒç”¨çš„å…³é”®æ˜¯ï¼š\nå†…æ ¸æ§åˆ¶ç€ä¸€åˆ‡ã€‚ç”¨æˆ·ä»£ç å¯ä»¥æå‡ºè¯·æ±‚ï¼Œè€Œä¸æ˜¯è¦æ±‚ã€‚ æ£€æŸ¥ã€å¤åˆ¶æ•°æ®ç­‰éœ€è¦æ—¶é—´ã€‚è¿™ä½¿å¾—ç³»ç»Ÿè°ƒç”¨æ¯”è¿è¡Œæ™®é€šä»£ç æ…¢ï¼Œæ— è®ºæ˜¯ç”¨æˆ·ä»£ç è¿˜æ˜¯å†…æ ¸ä»£ç ï¼šæ˜¯è·¨è¶Šè¾¹ç•Œçš„è¡Œä¸ºè®©æ‰§è¡Œå˜æ…¢ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œäº‹æƒ…å˜å¾—è¶Šæ¥è¶Šå¿«ï¼Œä½†æ˜¯å¯¹äºç¹å¿™çš„ç³»ç»Ÿæ¥è¯´å¯¹æ¯ä¸ªç½‘ç»œæ•°æ®åŒ…è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ˜¯ä¸å¯èƒ½çš„ã€‚ è¿™å°±æ˜¯ eBPF çš„äº®ç‚¹ï¼šæ— éœ€å¯¹æ¯ä¸ªç½‘ç»œæ•°æ®åŒ…ï¼ˆæˆ–è·Ÿè¸ªç‚¹å’Œå…¶ä»–ï¼‰è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œåªéœ€å°†ä¸€äº›ç”¨æˆ·ä»£ç ç›´æ¥æ”¾å…¥å†…æ ¸ï¼ç„¶åå†…æ ¸å¯ä»¥å…¨é€Ÿè¿è¡Œå®ƒï¼Œåªæœ‰åœ¨çœŸæ­£éœ€è¦æ—¶æ‰å°†æ•°æ®åˆ†å‘ç»™ç”¨æˆ·ç©ºé—´ã€‚ï¼ˆæœ€è¿‘å¯¹ Linux ä¸­çš„ç”¨æˆ·/å†…æ ¸äº¤äº’è¿›è¡Œäº†ç›¸å½“å¤šç±»ä¼¼çš„æ€è€ƒï¼Œé€šå¸¸æ•ˆæœå¾ˆå¥½ã€‚[io_uring](https://www.scylladb.com/2020/05/05/how-io_uring-and-ebpf-will-revolutionize-programming-in-linux/) æ­£æ˜¯è¯¥é¢†åŸŸçš„å¦ä¸€ä¸ªä¾‹å­ã€‚ï¼‰\nå½“ç„¶ï¼Œåœ¨å†…æ ¸ä¸­è¿è¡Œç”¨æˆ·ä»£ç ç¡®å®å¾ˆå±é™©ï¼Œå› æ­¤å†…æ ¸èŠ±è´¹äº†å¤§é‡ç²¾åŠ›æ¥éªŒè¯ç”¨æˆ·ä»£ç çš„å®é™…ç”¨é€”ã€‚\neBPF éªŒè¯ å½“ç”¨æˆ·è¿›ç¨‹å¯åŠ¨æ—¶ï¼Œå†…æ ¸åŸºæœ¬ä¸Šä¼šè®¤ä¸ºå…¶æ²¡é—®é¢˜çš„å¹¶å¯åŠ¨è¿è¡Œå®ƒã€‚å†…æ ¸åœ¨å®ƒå‘¨å›´è®¾ç½®äº†å›´æ ï¼Œå¹¶ä¸”ä¼šç«‹å³æ€æ­»ä»»ä½•è¯•å›¾ç ´åè§„åˆ™çš„ç”¨æˆ·è¿›ç¨‹ï¼Œä½†æ˜¯ç”¨æˆ·ä»£ç åŸºæœ¬ä¸Šè¢«è®¤ä¸ºæ˜¯æœ‰æƒæ‰§è¡Œçš„ã€‚\nå¯¹äº eBPF ä»£ç ï¼Œæ²¡æœ‰è¿™æ ·çš„ç¤¼é‡ã€‚åœ¨å†…æ ¸æœ¬èº«ä¸­ï¼Œä¿æŠ¤æ€§å›´æ åŸºæœ¬ä¸Šä¸å­˜åœ¨ï¼Œå¹¶ä¸”ç›²ç›®åœ°è®¤ä¸ºç”¨æˆ·ä»£ç æ˜¯å¯ä»¥å®‰å…¨è¿è¡Œçš„ï¼Œè¿™ä¼šä¸ºæ¯ä¸ªå®‰å…¨æ¼æ´æ•å¼€å¤§é—¨ï¼ˆä»¥åŠå…è®¸é”™è¯¯ä½¿æ•´ä¸ªæœºå™¨å´©æºƒï¼‰ã€‚ç›¸åï¼ŒeBPF ä»£ç åªæœ‰åœ¨å†…æ ¸èƒ½å¤Ÿæœæ–­åœ°è¯æ˜å®ƒæ˜¯å®‰å…¨çš„æ—¶æ‰èƒ½è¿è¡Œã€‚\nè¯æ˜ä¸€ä¸ªç¨‹åºæ˜¯å®‰å…¨çš„ éå¸¸ å›°éš¾ 4ã€‚ä¸ºäº†ä½¿å®ƒæ›´æ˜“äºå¤„ç†ï¼Œå†…æ ¸æå¤§åœ°é™åˆ¶äº† eBPF ç¨‹åºå¯ä»¥åšä»€ä¹ˆã€‚ä¾‹å¦‚ï¼š\neBPF ç¨‹åºä¸å…è®¸é˜»å¡ã€‚ ä»–ä»¬ä¸å…è®¸æœ‰æ— é™å¾ªç¯ï¼ˆäº‹å®ä¸Šï¼Œç›´åˆ° æœ€è¿‘æ‰å…è®¸ä»–ä»¬æœ‰å¾ªç¯ï¼‰ã€‚ å®ƒä»¬ä¸å…è®¸è¶…è¿‡æŸä¸ªæœ€å¤§å°ºå¯¸ã€‚ éªŒè¯è€…å¿…é¡»èƒ½å¤Ÿè¯„ä¼°æ‰€æœ‰å¯èƒ½çš„æ‰§è¡Œè·¯å¾„ã€‚ éªŒè¯è€…å®Œå…¨æ˜¯ä¸¥è‹›çš„ï¼Œå¹¶æœ€ç»ˆåšå‡ºå†³å®šï¼šå®ƒå¿…é¡»å¦‚æ­¤ï¼Œä»¥ç»´æŒæˆ‘ä»¬æ•´ä¸ªäº‘åŸç”Ÿä¸–ç•Œæ‰€ä¾èµ–çš„éš”ç¦»ä¿è¯ã€‚å®ƒè¿˜å¿…é¡»åœ¨å£°æ˜ç¨‹åºä¸å®‰å…¨æ—¶æŠ¥é”™ï¼šå¦‚æœä¸èƒ½ å®Œå…¨ ç¡®å®šç¨‹åºæ˜¯å®‰å…¨çš„ï¼Œå®ƒå°±ä¼šæ‹’ç»ã€‚ä¸å¹¸çš„æ˜¯ï¼Œæœ‰ä¸€äº› eBPF ç¨‹åºæ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯éªŒè¯è€…ä¸å¤Ÿèªæ˜ï¼Œæ— æ³•é€šè¿‡â€”â€”å¦‚æœä½ å¤„äºé‚£ä¸ªä½ç½®ï¼Œä½ éœ€è¦é‡å†™ç¨‹åºç›´åˆ°éªŒè¯è€…å¯ä»¥æ¥å—ï¼Œæˆ–è€…ä½ å°†éœ€è¦ä¿®è¡¥éªŒè¯ç¨‹åºå¹¶æ„å»ºè‡ªå·±çš„å†…æ ¸ 5ã€‚\næœ€ç»ˆç»“æœæ˜¯ eBPF æ˜¯ä¸€ç§ é«˜åº¦ å—é™çš„è¯­è¨€ã€‚è¿™æ„å‘³ç€è™½ç„¶å¯¹æ¯ä¸ªä¼ å…¥çš„ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œç®€å•æ£€æŸ¥ç­‰äº‹æƒ…å¾ˆå®¹æ˜“ï¼Œä½†åœ¨å¤šä¸ªæ•°æ®åŒ…ä¹‹é—´ç¼“å†²æ•°æ®ç­‰çœ‹ä¼¼ç®€å•çš„äº‹æƒ…å´å¾ˆéš¾ã€‚åœ¨ eBPF ä¸­å®ç° HTTP/2 æˆ–ç»ˆæ­¢ TLS æ ¹æœ¬ä¸å¯èƒ½ï¼šå®ƒä»¬å¤ªå¤æ‚äº†ã€‚\næœ€åï¼Œæ‰€æœ‰è¿™äº›å¸¦æ¥äº†é—®é¢˜ï¼šå°† eBPF çš„ç½‘ç»œåŠŸèƒ½åº”ç”¨äºæœåŠ¡ç½‘æ ¼ä¼šæ˜¯ä»€ä¹ˆæ ·å­ã€‚\neBPF å’ŒæœåŠ¡ç½‘æ ¼ æœåŠ¡ç½‘æ ¼å¿…é¡»å¤„ç†äº‘åŸç”Ÿç½‘ç»œçš„æ‰€æœ‰å¤æ‚æ€§ã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬é€šå¸¸å¿…é¡»å‘èµ·å’Œç»ˆæ­¢ mTLSã€é‡è¯•å¤±è´¥çš„è¯·æ±‚ã€é€æ˜åœ°å°†è¿æ¥ä» HTTP/1 å‡çº§åˆ° HTTP/2ã€åŸºäºå·¥ä½œè´Ÿè½½èº«ä»½æ‰§è¡Œè®¿é—®ç­–ç•¥ã€è·¨è¶Šé›†ç¾¤è¾¹ç•Œå‘é€æµé‡ç­‰ç­‰ã€‚äº‘åŸç”Ÿä¸–ç•Œè¿˜ä¼šæœ‰æ›´å¤šçš„å¤æ‚æ€§ã€‚\nå¤§å¤šæ•°æœåŠ¡ç½‘æ ¼ä½¿ç”¨ è¾¹è½¦ æ¨¡å‹æ¥å®ç°ã€‚ç½‘æ ¼å°†åœ¨è‡ªå·±çš„å®¹å™¨ä¸­è¿è¡Œçš„ä»£ç†é™„åŠ åˆ°æ¯ä¸ªåº”ç”¨ç¨‹åº podï¼Œå¹¶ä¸”ä»£ç†æ‹¦æˆªè¿›å‡ºåº”ç”¨ç¨‹åº pod çš„ç½‘ç»œæµé‡ï¼Œæ‰§è¡Œç½‘æ ¼åŠŸèƒ½æ‰€éœ€çš„ä»»ä½•æ“ä½œã€‚è¿™æ„å‘³ç€ç½‘æ ¼å¯ä»¥å¤„ç†ä»»ä½•å·¥ä½œè´Ÿè½½å¹¶ä¸”ä¸éœ€è¦æ›´æ”¹åº”ç”¨ç¨‹åºï¼Œè¿™å¯¹å¼€å‘äººå‘˜æ¥è¯´æ˜¯ä¸€ä¸ªç›¸å½“å¤§çš„èƒœåˆ©ã€‚è¿™ä¹Ÿæ˜¯å¹³å°æ–¹é¢çš„èƒœåˆ©ï¼šä»–ä»¬ä¸å†éœ€è¦ä¾èµ–åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜æ¥å®ç° mTLSã€é‡è¯•ã€é»„é‡‘æŒ‡æ ‡ 6 ç­‰ï¼Œå› ä¸ºç½‘æ ¼åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æä¾›äº†æ‰€æœ‰è¿™äº›ä»¥åŠæ›´å¤šã€‚\nå¦ä¸€æ–¹é¢ï¼Œå°±åœ¨ä¸ä¹…å‰ï¼Œéƒ¨ç½²æ‰€æœ‰è¿™äº›ä»£ç†çš„æƒ³æ³•å®Œå…¨æ˜¯ç–¯ç‹‚çš„ï¼Œäººä»¬ä»ç„¶æ‹…å¿ƒè¿è¡Œé¢å¤–å®¹å™¨å¸¦æ¥çš„å¼€é”€ã€‚ä½†æ˜¯ Kubernetes ä½¿éƒ¨ç½²å˜å¾—å®¹æ˜“ï¼Œåªè¦ä¿æŒä»£ç†çš„è½»é‡çº§å’Œè¶³å¤Ÿå¿«ï¼Œå®ƒå°±å¯ä»¥å¾ˆå¥½åœ°å·¥ä½œã€‚ï¼ˆå½“ç„¶ï¼Œâ€œè½»é‡çº§å’Œå¿«é€Ÿâ€æ˜¯ä¸»è§‚çš„ã€‚è®¸å¤šç½‘æ ¼ä½¿ç”¨é€šç”¨ Envoy ä»£ç†ä½œä¸º sidecarï¼›Linkerd ä¼¼ä¹æ˜¯å”¯ä¸€ä½¿ç”¨ä¸“é—¨æ„å»ºçš„è½»é‡çº§ä»£ç†çš„ã€‚ç¬”è€…æ³¨ï¼šè¿˜æœ‰ Flomesh ä½¿ç”¨ å¯ç¼–ç¨‹çš„è½»é‡çº§ä»£ç† Pipyã€‚ï¼‰\né‚£ä¹ˆï¼Œä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥å°† sidecar ä¸­çš„åŠŸèƒ½ä¸‹æ²‰åˆ° eBPF ä¸­ï¼Œä»¥åŠè¿™æ ·åšæ˜¯å¦ä¼šæœ‰æ‰€å¸®åŠ©ã€‚åœ¨ OSI ç¬¬ 3 å±‚å’Œç¬¬ 4 å±‚â€”â€”IPã€TCP å’Œ UDPâ€”â€”æˆ‘ä»¬å·²ç»çœ‹åˆ° eBPF å–å¾—äº†ä¸€äº›æ˜æ˜¾çš„æˆåŠŸã€‚ä¾‹å¦‚ï¼ŒeBPF å¯ä»¥ä½¿å¤æ‚çš„åŠ¨æ€ IP è·¯ç”±å˜å¾—ç›¸å½“ç®€å•ã€‚å®ƒå¯ä»¥è¿›è¡Œéå¸¸æ™ºèƒ½çš„æ•°æ®åŒ…è¿‡æ»¤ï¼Œæˆ–è¿›è¡Œå¤æ‚çš„ç›‘æ§ï¼Œå¹¶ä¸”å¯ä»¥å¿«é€Ÿä¸”é«˜æ•ˆåœ°å®Œæˆæ‰€æœ‰è¿™äº›å·¥ä½œã€‚åœ¨ç½‘æ ¼éœ€è¦ä¸è¿™äº›å±‚çš„åŠŸèƒ½äº¤äº’çš„åœ°æ–¹ï¼ŒeBPF ä¼¼ä¹è‚¯å®šå¯ä»¥å¸®åŠ©ç½‘æ ¼å®ç°ã€‚\nç„¶è€Œï¼ŒOSI ç¬¬ 7 å±‚æƒ…å†µæœ‰æ‰€ä¸åŒã€‚eBPF çš„æ‰§è¡Œç¯å¢ƒå—åˆ°å¦‚æ­¤ä¸¥æ ¼çš„é™åˆ¶ï¼Œä»¥è‡³äº HTTP å’Œ mTLS çº§åˆ«çš„åè®® è¿œè¿œ è¶…å‡ºäº†å®ƒçš„èƒ½åŠ›ï¼Œè‡³å°‘åœ¨ä»Šå¤©æ˜¯è¿™æ ·ã€‚é‰´äº eBPF ä¸æ–­å‘å±•ï¼Œä¹Ÿè®¸æœªæ¥çš„æŸä¸ªç‰ˆæœ¬å¯ä»¥ç®¡ç†è¿™äº›åè®®ï¼Œä½†å€¼å¾—è®°ä½çš„æ˜¯ï¼Œç¼–å†™ eBPF æœ¬èº«å°±éå¸¸å›°éš¾ï¼Œè°ƒè¯•å¯èƒ½æ›´åŠ å›°éš¾ã€‚è®¸å¤šç¬¬ 7 å±‚åè®®æ˜¯å¤æ‚çš„é‡å…½ï¼Œåœ¨ç›¸å¯¹å®½å®¹çš„ç”¨æˆ·ç©ºé—´ç¯å¢ƒä¸­è¡¨ç°å¾—éå¸¸ç³Ÿç³•ã€‚å³ä½¿åœ¨ eBPF çš„å—é™ç¯å¢ƒä¸­å¯ä»¥é‡å†™å®ƒä»¬ï¼Œä½†ç›®å‰å°šä¸æ¸…æ¥šå¦å®ç”¨ã€‚\nå½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥åšçš„æ˜¯å°† eBPF ä¸ä»£ç†é…å¯¹ï¼šå°†æ ¸å¿ƒä½çº§åŠŸèƒ½æ”¾åœ¨ eBPF ä¸­ï¼Œç„¶åå°†å…¶ä¸ç”¨æˆ·ç©ºé—´ä»£ç é…å¯¹ä»¥ç®¡ç†å¤æ‚çš„åŠŸèƒ½ã€‚è¿™æ ·æˆ‘ä»¬å°±æœ‰å¯èƒ½åœ¨åº•å±‚è·å¾— eBPF æ€§èƒ½çš„ä¼˜åŠ¿ï¼ŒåŒæ—¶å°†çœŸæ­£ä»¤äººè®¨åŒçš„ä¸œè¥¿ç•™åœ¨ç”¨æˆ·ç©ºé—´ä¸­ã€‚è¿™å®é™…ä¸Šæ˜¯å½“ä»Šæ¯ä¸ªç°å­˜çš„â€œeBPF æœåŠ¡ç½‘æ ¼â€æ‰€åšçš„ï¼Œå°½ç®¡å®ƒé€šå¸¸æ²¡æœ‰è¢«å¹¿æ³›å®£ä¼ ã€‚\nè¿™å¼•å‘äº†æ–°çš„é—®é¢˜ï¼šè¿™æ ·çš„ä»£ç†åº”è¯¥åœ¨å“ªï¼Ÿ\nä¸»æœºçº§ä»£ç†ä¸è¾¹è½¦ ä¸å…¶åœ¨ sidecar æ¨¡å‹ä¸­é‚£æ ·åœ¨æ¯ä¸ªåº”ç”¨ç¨‹åº pod ä¸Šéƒ¨ç½²ä¸€ä¸ªä»£ç†ï¼Œä¸å¦‚è€ƒè™‘ä¸ºæ¯ä¸ªä¸»æœºï¼ˆæˆ–è€…ï¼Œç”¨ Kubernetes æ¥è¯´ï¼Œæ¯ä¸ªèŠ‚ç‚¹ï¼‰éƒ¨ç½²ä¸€ä¸ªä»£ç†ã€‚å®ƒä¸ºç®¡ç† IP è·¯ç”±çš„æ–¹å¼å¢åŠ äº†ä¸€ç‚¹å¤æ‚æ€§ï¼Œä½†ä¹ä¸€çœ‹ä¼¼ä¹æä¾›äº†ä¸€äº›ç»æµä¼˜åŠ¿ï¼Œå› ä¸ºéœ€è¦ä»£ç†å°‘äº†ã€‚\nç„¶è€Œï¼Œsidecar æ¯”ä¸»æœºçº§ä»£ç†æœ‰ä¸€äº›æ˜¾è‘—çš„å¥½å¤„ã€‚è¿™æ˜¯å› ä¸º sidecar å°±åƒåº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†ä¸€æ ·ï¼Œè€Œä¸æ˜¯ç‹¬ç«‹äºåº”ç”¨ç¨‹åºï¼š\nSidecar èµ„æºå ç”¨ä¸åº”ç”¨ç¨‹åºè´Ÿè½½æˆæ­£æ¯”ï¼Œå› æ­¤å¦‚æœåº”ç”¨ç¨‹åºæ²¡æœ‰åšå¤ªå¤šäº‹æƒ…ï¼Œsidecar çš„èµ„æºå ç”¨å°†ä¿æŒåœ¨è¾ƒä½æ°´å¹³ 7ã€‚å½“åº”ç”¨ç¨‹åºæ‰¿å—å¤§é‡è´Ÿè½½æ—¶ï¼ŒKubernetes çš„æ‰€æœ‰ç°æœ‰æœºåˆ¶ï¼ˆèµ„æºè¯·æ±‚å’Œé™åˆ¶ã€OOMKiller ç­‰ï¼‰éƒ½ä¼šå®Œå…¨æŒ‰ç…§ä¹ æƒ¯çš„æ–¹å¼å·¥ä½œã€‚ å¦‚æœ sidecar å‘ç”Ÿæ•…éšœï¼Œå®ƒåªä¼šå½±å“ä¸€ä¸ª podï¼Œå¹¶ä¸”ç°æœ‰çš„ Kubernetes çš„æœºåˆ¶ä¼šå“åº” pod æ•…éšœä½¿å…¶å†æ¬¡æ­£å¸¸å·¥ä½œã€‚ sidecar æ“ä½œä¸åº”ç”¨ç¨‹åº pod æ“ä½œåŸºæœ¬ç›¸åŒã€‚ä¾‹å¦‚ï¼Œé€šè¿‡æ­£å¸¸çš„ Kubernetes æ»šåŠ¨é‡å¯å‡çº§åˆ°æ–°ç‰ˆæœ¬çš„ sidecarã€‚ sidecar ä¸å®ƒçš„ pod å…·æœ‰å®Œå…¨ç›¸åŒçš„å®‰å…¨è¾¹ç•Œï¼šç›¸åŒçš„å®‰å…¨ä¸Šä¸‹æ–‡ã€ç›¸åŒçš„ IP åœ°å€ç­‰ã€‚ä¾‹å¦‚ï¼Œå®ƒåªéœ€è¦ä¸ºå®ƒçš„ pod åš mTLSï¼Œè¿™æ„å‘³ç€å®ƒåªéœ€è¦é‚£ä¸ªå•ä¸€ pod çš„å¯†é’¥æ•°æ®ã€‚å¦‚æœä»£ç†ä¸­å­˜åœ¨é”™è¯¯ï¼Œå®ƒåªèƒ½æ³„æ¼è¯¥å•ä¸ªå¯†é’¥ã€‚ å¯¹äºä¸»æœºçº§ä»£ç†ï¼Œæ‰€æœ‰è¿™äº›äº‹æƒ…éƒ½ä¼šæ¶ˆå¤±ã€‚è¯·è®°ä½ï¼Œåœ¨ Kubernetes ä¸­ï¼Œé›†ç¾¤è°ƒåº¦ç¨‹åºå†³å®šå°†å“ªäº› pod è°ƒåº¦åˆ°ç»™å®šèŠ‚ç‚¹ä¸Šï¼Œè¿™æ„å‘³ç€æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥è·å¾—ä¸€ç»„éšæœºçš„ podã€‚è¿™æ„å‘³ç€ç»™å®šçš„ä»£ç†å°†ä¸åº”ç”¨ç¨‹åº å®Œå…¨ è§£è€¦ï¼Œè¿™å¾ˆé‡è¦ï¼š\nå®é™…ä¸Šä¸å¯èƒ½æ¨æ–­å•ä¸ªä»£ç†çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œå› ä¸ºå®ƒå°†ç”±åˆ°åº”ç”¨ç¨‹åº pod éšæœºå­é›†çš„éšæœºçš„æµé‡å­é›†å†³å®šã€‚åè¿‡æ¥ï¼Œè¿™æ„å‘³ç€ä»£ç†æœ€ç»ˆä¼šå› ä¸ºä¸€äº›éš¾ä»¥ç†è§£çš„åŸå› è€Œå¤±è´¥ï¼Œè€Œç½‘æ ¼å›¢é˜Ÿå°†æ‰¿æ‹…è´£ä»»ã€‚ åº”ç”¨ç¨‹åºçªç„¶æ›´å®¹æ˜“å—åˆ° å˜ˆæ‚é‚»å±… çš„å½±å“ï¼Œå› ä¸ºç»™å®šä¸»æœºä¸Šè°ƒåº¦çš„æ¯ä¸ª pod çš„æµé‡éƒ½å¿…é¡»æµç»å•ä¸ªä»£ç†ã€‚ä¸€ä¸ªé«˜æµé‡çš„ pod å¯èƒ½ä¼šå®Œå…¨æ¶ˆè€—è¯¥èŠ‚ç‚¹çš„æ‰€æœ‰ä»£ç†èµ„æºï¼Œè®©æ‰€æœ‰å…¶ä»– pod éƒ½é¥¿æ­»ã€‚ä»£ç†å¯ä»¥å°è¯•ç¡®ä¿å…¬å¹³å¤„ç†ï¼Œä½†å¦‚æœé«˜æµé‡ Pod ä¹Ÿæ¶ˆè€—äº†æ‰€æœ‰èŠ‚ç‚¹çš„ CPUï¼Œè¿™ä¹Ÿä¼šå¤±è´¥ã€‚ å¦‚æœä»£ç†å¤±è´¥ï¼Œå®ƒä¼šå½±å“åº”ç”¨ç¨‹åº pod çš„éšæœºå­é›†â€”â€”å¹¶ä¸”è¯¥å­é›†å°†ä¸æ–­å˜åŒ–ã€‚åŒæ ·ï¼Œå°è¯•å‡çº§ä»£ç†å°†å½±å“ç±»ä¼¼éšæœºçš„ã€ä¸æ–­å˜åŒ–çš„åº”ç”¨ç¨‹åº pod å­é›†ã€‚ä»»ä½•æ•…éšœæˆ–ç»´æŠ¤ä»»åŠ¡éƒ½ä¼šçªç„¶äº§ç”Ÿä¸å¯é¢„çŸ¥çš„å‰¯ä½œç”¨ã€‚ ä»£ç†ç°åœ¨ä¼šè·¨è¶ŠèŠ‚ç‚¹ä¸Šè°ƒåº¦çš„æ¯ä¸ªåº”ç”¨ç¨‹åº pod çš„å®‰å…¨è¾¹ç•Œï¼Œè¿™æ¯”ä»…ä»…è€¦åˆåˆ°å•ä¸ª pod å¤æ‚å¾—å¤šã€‚ä¾‹å¦‚ï¼ŒmTLS éœ€è¦ä¸ºæ¯ä¸ªè°ƒåº¦çš„ pod ä¿å­˜å¯†é’¥ï¼Œè€Œä¸æ˜¯æ··æ·†å“ªä¸ªå¯†é’¥ä¸å“ªä¸ª pod ä¸€èµ·ä½¿ç”¨ã€‚ä»£ç†ä¸­çš„ä»»ä½•é”™è¯¯éƒ½æ˜¯æ›´å¯æ€•çš„äº‹æƒ…ã€‚ åŸºæœ¬ä¸Šï¼Œsidecar ä½¿ç”¨å®¹å™¨æ¨¡å‹æ¥å‘æŒ¥å…¶ä¼˜åŠ¿ï¼šå†…æ ¸å’Œ Kubernetes åŠªåŠ›åœ¨å®¹å™¨çº§åˆ«å¼ºåˆ¶æ‰§è¡Œéš”ç¦»å’Œå…¬å¹³ï¼Œä¸”æ­£å¸¸ã€‚ä¸»æœºçº§ä»£ç†è¶…å‡ºäº†è¯¥æ¨¡å‹ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¿…é¡»è‡ªå·±è§£å†³æ‰€æœ‰ç«äº‰æ€§å¤šç§Ÿæˆ·é—®é¢˜ã€‚\nä¸»æœºçº§ä»£ç†ç¡®å®æœ‰ä¼˜åŠ¿ã€‚é¦–å…ˆï¼Œåœ¨ sidecar ä¸–ç•Œä¸­ï¼Œä»ä¸€ä¸ª Pod åˆ°å¦ä¸€ä¸ª Pod æ€»æ˜¯ä¸¤æ¬¡é€šè¿‡ä»£ç†ï¼›åœ¨ä¸»æœºçš„ä¸–ç•Œä¸­ï¼Œæœ‰æ—¶å®ƒåªæœ‰ä¸€ä¸ªè·³è·ƒ 8ï¼Œè¿™å¯ä»¥å‡å°‘ä¸€ç‚¹å»¶è¿Ÿã€‚æ­¤å¤–ï¼Œæœ€ç»ˆå¯ä»¥è¿è¡Œæ›´å°‘çš„ä»£ç†ï¼Œå¦‚æœä»£ç†åœ¨ç©ºé—²æ—¶èµ„æºä½¿ç”¨ç‡å¾ˆé«˜ï¼Œåˆ™å¯ä»¥èŠ‚çœèµ„æºæ¶ˆè€—ã€‚ç„¶è€Œï¼Œä¸è¿è¥å’Œå®‰å…¨é—®é¢˜çš„æˆæœ¬ç›¸æ¯”ï¼Œè¿™äº›æ”¹è¿›ç›¸å½“å°ï¼Œè€Œä¸”å®ƒä»¬åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå¯ä»¥é€šè¿‡ä½¿ç”¨æ›´å°ã€æ›´å¿«ã€æ›´ç®€å•çš„ä»£ç†æ¥ç¼“è§£ã€‚\næˆ‘ä»¬æ˜¯å¦è¿˜å¯ä»¥é€šè¿‡æ”¹è¿›ä»£ç†ä»¥æ›´å¥½åœ°å¤„ç†ç«äº‰æ€§å¤šç§Ÿæˆ·æ¥ç¼“è§£è¿™äº›é—®é¢˜ï¼Ÿä¹Ÿè®¸ã€‚è¿™ç§æ–¹æ³•æœ‰ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š\nç«äº‰å¤šç§Ÿæˆ·æ˜¯ä¸€ä¸ªå®‰å…¨é—®é¢˜ï¼Œæœ€å¥½ä½¿ç”¨æ›´å°ã€æ›´ç®€å•ã€æ›´æ˜“äºè°ƒè¯•çš„ä»£ç æ¥å¤„ç†å®‰å…¨é—®é¢˜ã€‚æ·»åŠ å¤§é‡ä»£ç ä»¥æ›´å¥½åœ°å¤„ç†ç«äº‰æ€§å¤šç§Ÿæˆ·åŸºæœ¬ä¸Šä¸å®‰å…¨æœ€ä½³å®è·µæˆªç„¶ç›¸åã€‚ å³ä½¿å®‰å…¨é—®é¢˜å¯ä»¥å®Œå…¨è§£å†³ï¼Œæ“ä½œé—®é¢˜ä»ç„¶å­˜åœ¨ã€‚æ¯å½“æˆ‘ä»¬é€‰æ‹©è¿›è¡Œæ›´å¤æ‚çš„æ“ä½œæ—¶ï¼Œæˆ‘ä»¬éƒ½åº”è¯¥é—®ä¸ºä»€ä¹ˆï¼Œä»¥åŠè°å—ç›Šã€‚ æ€»ä½“è€Œè¨€ï¼Œè¿™äº›ç±»å‹çš„ä»£ç†æ›´æ–°å¯èƒ½éœ€è¦å¤§é‡å·¥ä½œ 9ï¼Œè¿™å¼•å‘äº†æœ‰å…³è¿›è¡Œè¿™é¡¹å·¥ä½œçš„ä»·å€¼çš„çœŸæ­£é—®é¢˜ã€‚\næŠŠä¸€åˆ‡éƒ½ç»•å›æ¥ï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æˆ‘ä»¬æœ€åˆçš„é—®é¢˜ï¼šå°†æœåŠ¡ç½‘æ ¼åŠŸèƒ½ä¸‹æ²‰åˆ° eBPF ä¼šæ˜¯ä»€ä¹ˆæ ·å­ï¼Ÿæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä»£ç†æ¥ç»´æŠ¤æˆ‘ä»¬éœ€è¦çš„ç¬¬ 7 å±‚åŠŸèƒ½ï¼Œå¹¶ä¸”æˆ‘ä»¬è¿›ä¸€æ­¥çŸ¥é“ sidecar ä»£ç†å¯ä»¥åœ¨æ“ä½œç³»ç»Ÿçš„éš”ç¦»ä¿æŠ¤èŒƒå›´å†…å·¥ä½œï¼Œå…¶ä¸­ä¸»æœºçº§çš„ä»£ç†å¿…é¡»è‡ªå·±ç®¡ç†æ‰€æœ‰å†…å®¹ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªå°åŒºåˆ«ï¼šä¸»æœºçº§ä»£ç†çš„æ½œåœ¨æ€§èƒ½ä¼˜åŠ¿æ ¹æœ¬ä¸ä¼šè¶…è¿‡é¢å¤–çš„å®‰å…¨é—®é¢˜å’Œæ“ä½œå¤æ‚æ€§ï¼Œå› æ­¤æ— è®ºæ˜¯å¦æ¶‰åŠ eBPFï¼Œæˆ‘ä»¬éƒ½å°† sidecar ä½œä¸ºæœ€å¯è¡Œçš„é€‰æ‹©ã€‚\nå±•æœ›æœªæ¥ æ˜¾è€Œæ˜“è§ï¼Œä»»ä½•æœåŠ¡ç½‘æ ¼çš„é¦–è¦ä»»åŠ¡éƒ½å¿…é¡»æ˜¯ç”¨æˆ·çš„æ“ä½œä½“éªŒã€‚æˆ‘ä»¬å¯ä»¥åœ¨å“ªé‡Œä½¿ç”¨ eBPF æ¥è·å¾—æ›´é«˜çš„æ€§èƒ½å’Œæ›´ä½çš„èµ„æºä½¿ç”¨ï¼Œå¤ªæ£’äº†ï¼ä½†æ˜¯æˆ‘ä»¬éœ€è¦æ³¨æ„ä¸è¦åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ç‰ºç‰²ç”¨æˆ·ä½“éªŒã€‚\neBPF æœ€ç»ˆä¼šèƒ½å¤Ÿè¦†ç›–æœåŠ¡ç½‘æ ¼çš„å…¨éƒ¨èŒƒå›´å—ï¼Ÿä¸å¤ªå¯èƒ½ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œéå¸¸ä¸æ¸…æ¥šåœ¨ eBPF ä¸­å®ç°æ‰€æœ‰éœ€è¦çš„ç¬¬ 7 å±‚å¤„ç†æ˜¯å¦å¯è¡Œï¼Œå³ä½¿åœ¨æŸäº›æ—¶å€™å®ƒç¡®å®æœ‰å¯èƒ½ã€‚åŒæ ·ï¼Œå¯èƒ½è¿˜æœ‰ä¸€äº›å…¶ä»–æœºåˆ¶å¯ä»¥å°†è¿™äº› L7 åŠŸèƒ½è½¬ç§»åˆ°å†…æ ¸ä¸­â€”â€”ä¸è¿‡ï¼Œä»å†å²ä¸Šçœ‹ï¼Œè¿™æ–¹é¢å¹¶æ²¡æœ‰å¾ˆå¤§çš„æ¨åŠ¨åŠ›ï¼Œä¹Ÿä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆçœŸæ­£ä½¿è¿™ç§èƒ½åŠ›å¼•äººæ³¨ç›®ã€‚ï¼ˆè¯·è®°ä½ï¼Œå°†åŠŸèƒ½ç§»å…¥å†…æ ¸æ„å‘³ç€ç§»é™¤æˆ‘ä»¬ä¸ºç¡®ä¿ç”¨æˆ·ç©ºé—´å®‰å…¨è€Œä¾èµ–çš„å›´æ ã€‚ï¼‰\né‚£ä¹ˆï¼Œåœ¨å¯é¢„è§çš„æœªæ¥ï¼ŒæœåŠ¡ç½‘æ ¼çš„æœ€ä½³å‰è¿›æ–¹å‘ä¼¼ä¹æ˜¯ç§¯æå¯»æ‰¾ä¾èµ– eBPF æ¥æé«˜æ€§èƒ½çš„åœ°æ–¹ï¼Œä½†æ¥å—ç”¨æˆ·ç©ºé—´ sidecar çš„éœ€æ±‚ä»£ç†ï¼Œå¹¶åŠ å€åŠªåŠ›ä½¿ä»£ç†å°½å¯èƒ½å°ã€å¿«é€Ÿå’Œç®€å•ã€‚\nè„šæ³¨ å…³äºä½œè€… Flynn æ˜¯ Buoyant çš„æŠ€æœ¯å¸ƒé“è€…ï¼Œä¸»è¦å…³æ³¨ Linkerd æœåŠ¡ç½‘æ ¼ã€Kubernetes å’Œäº‘åŸç”Ÿå¼€å‘ã€‚ä»–è¿˜æ˜¯ Emissary-ingress API ç½‘å…³çš„åŸä½œè€…å’Œç»´æŠ¤è€…ï¼Œå¹¶ä¸”åœ¨é€šä¿¡å’Œå®‰å…¨æ–¹é¢çš„è½¯ä»¶å·¥ç¨‹é¢†åŸŸæŠ•å…¥äº†æ•°åå¹´çš„æ—¶é—´ã€‚\næˆ–è€…ï¼Œè‡³å°‘ï¼Œè¦å®¹æ˜“å¾—å¤šã€‚\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nè‡³å°‘ï¼Œä¸æ˜¯æ²¡æœ‰èŠ‚ç›®ä¹‹é—´çš„é¢„å…ˆå®‰æ’ã€‚è¿™è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒå›´ã€‚\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nå…¶ä½™çš„å¤§éƒ¨åˆ†æ˜¯è°ƒåº¦ã€‚\u0026#160;\u0026#x21a9;\u0026#xfe0e;\näº‹å®ä¸Šï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸å¯èƒ½çš„ã€‚å¦‚æœä½ æƒ³æ¸…ç†ä½ çš„ CS è¯¾ç¨‹ä½œä¸šï¼Œé¦–å…ˆè¦è§£å†³çš„æ˜¯åœé¡¿é—®é¢˜ã€‚\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nå…¶ä¸­ä¸€ä»¶äº‹å¯èƒ½æ¯”å¦ä¸€ä»¶äº‹æ›´å®¹æ˜“ã€‚ç‰¹åˆ«æ˜¯å¦‚æœæ‚¨æƒ³è®©æ‚¨çš„éªŒè¯ç¨‹åºè¡¥ä¸è¢«ä¸Šæ¸¸æ¥å—ï¼\u0026#160;\u0026#x21a9;\u0026#xfe0e;\næµé‡ã€å»¶è¿Ÿã€é”™è¯¯å’Œé¥±å’Œåº¦ã€‚\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nå†æ¬¡å‡è®¾ï¼Œä¸€ä¸ªè¶³å¤Ÿè½»çš„è¾¹è½¦ã€‚\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nä¸è¿‡ï¼Œæœ‰æ—¶å®ƒä»ç„¶æ˜¯ä¸¤ä¸ªï¼Œæ‰€ä»¥è¿™æœ‰ç‚¹å–œå¿§å‚åŠã€‚\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªæœ‰è¶£çš„ twitter å¸–å­ è¯´è¦ä¸º Envoy åšåˆ°è¿™ä¸€ç‚¹æœ‰å¤šéš¾ã€‚\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/10/31/pexelspixabay163323.jpg","permalink":"https://atbug.com/translate-ebpf-service-mesh/","tags":["Service Mesh","eBPF","sidecar"],"title":"ã€è¯‘ã€‘eBPF å’ŒæœåŠ¡ç½‘æ ¼ï¼šè¿˜ä¸èƒ½ä¸¢æ‰ Sidecar"},{"categories":["äº‘åŸç”Ÿ"],"contents":"èƒŒæ™¯ åœ¨ã€ŠSMI ä¸ Gateway API çš„ GAMMA å€¡è®®æ„å‘³ç€ä»€ä¹ˆï¼Ÿã€‹çš„ä¸€æ–‡ä¸­ï¼Œä»‹ç»è¿‡ Kubernetes Gateway API å¤„ç†ä¸œè¥¿å‘ï¼ˆç½‘æ ¼ï¼‰æµé‡çš„å¯èƒ½æ€§ã€‚è®©æˆ‘ä»¬é‡æ–°çœ‹ä¸‹ Gateway API ä¸­å¯¹æµé‡å®šä¹‰ï¼ˆè·¯ç”±ï¼‰çš„å®šä¹‰ï¼Œä»¥ HTTP è·¯ç”±ä¸ºä¾‹ï¼š\napiVersion: gateway.networking.k8s.io/v1beta1 kind: HTTPRoute metadata: name: my-route namespace: gateway-api-example-ns2 spec: parentRefs: - kind: Gateway name: foo-gateway namespace: gateway-api-example-ns1 hostnames: - foo.example.com rules: - backendRefs: - name: foo-svc port: 8080 ä¸Šé¢çš„ YAML ä¸­ï¼Œä½¿ç”¨ parentRefs å­—æ®µå°†è·¯ç”±ç­–ç•¥é™„åŠ åˆ°äº†ç½‘å…³èµ„æº foo-gateway ä¸Šã€‚ç½‘å…³ foo-gateway ä¼šæ ¹æ®è¯·æ±‚å¤´éƒ¨çš„ HOST æ¥é€‰æ‹©åˆé€‚çš„ HTTPRouteï¼Œç„¶åå°†æµé‡ä»£ç†åˆ°ä¸Šæ¸¸ Service foo-svcã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å®šä¹‰äº†â€œç½‘å…³ -\u0026gt; è·¯ç”± -\u0026gt; åç«¯â€çš„æ˜ å°„ã€‚\né€šè¿‡å¯¹æµé‡çš„å®šä¹‰ä»¥åŠå¤„ç†æµé‡çš„èµ„æºçš„é€‰æ‹©ï¼Œå®ç° 7 å±‚ HTTP åè®®çš„åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡ã€‚ä½†åœ¨å®é™…çš„åœºæ™¯ä¸‹ï¼Œç®€å•çš„ä»£ç†è·¯ç”±ç­–ç•¥è¿˜å¹¶ä¸å¤Ÿï¼Œå¯èƒ½è¿˜éœ€è¦é…åˆæ²»ç†ç­–ç•¥æ¥æå‡æœåŠ¡çš„å¥å£®æ€§ï¼Œæ¯”å¦‚é™æµã€é‡è¯•ã€è¶…æ—¶ã€ç†”æ–­ã€è‡ªå®šä¹‰å¥åº·æ£€æŸ¥ç­‰ç­‰ã€‚\næˆ‘ä»¬çœ‹ä¸‹ Istio çš„è¶…æ—¶é…ç½®ï¼Œé¦–å…ˆä½¿ç”¨äº† reviews è¿›è¡Œæµé‡çš„åŒ¹é…ï¼Œç„¶åå†æ ¹æ®è·¯ç”±çš„ç­–ç•¥ uri å‰ç¼€ /review è¿›è¡Œè·¯ç”±åŒ¹é…ï¼Œå°†æµé‡ä»£ç†åˆ°ç›®çš„åœ° v2 çš„ reviewsã€‚ä¸æ­¤åŒæ—¶ï¼Œè¯¥è·¯ç”±çš„è¶…æ—¶ä¸º 0.5sã€‚\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - uri: prefix: \u0026#34;/review\u0026#34; route: - destination: host: reviews subset: v2 timeout: 0.5s åœ¨è¿™æ®µå®šä¹‰ä¸­è€¦åˆäº†æµé‡åŒ¹é…ã€è·¯ç”±åŒ¹é…ã€åç«¯æŒ‡å®šã€è¶…æ—¶ï¼Œå¦‚æœéœ€è¦é…ç½®é‡è¯•å‘¢ï¼Œå†åŠ ä¸ª retries å­—æ®µã€‚å¦‚æ­¤ä¸€æ¥ï¼Œçµæ´»æ€§å¤§å¤§æŠ˜æ‰£ã€‚\nç›®æ ‡ Kubernetes Gateway API çš„ ç­–ç•¥é™„ä»¶ï¼ˆPolicy Attachmentï¼‰ çš„è®¾è®¡ç›®æ ‡ï¼š\nç­–ç•¥å’Œèµ„æºå…³è”æ ‡å‡†åŒ– æ”¯æŒç­–ç•¥çš„é»˜è®¤å€¼å’Œè¦†ç›–å€¼ ä¸åŒèµ„æºä¸Šç­–ç•¥ç”Ÿæ•ˆçš„ä¼˜å…ˆçº§ ä¸ºèµ„æºæ–½åŠ ç­–ç•¥çš„æ—¶å€™ï¼Œæ—¢è¦è€ƒè™‘é€šç”¨æ€§ï¼ˆæ ‡å‡†åŒ–ï¼‰åˆè¦è€ƒè™‘çµæ´»æ€§ï¼ˆç­–ç•¥å€¼ä¼˜å…ˆçº§ï¼‰ã€‚\nè¿™é‡Œè¯´çš„èµ„æºå¯ä»¥æ˜¯ç½‘å…³ç›¸å…³çš„ä»»ä½•èµ„æºï¼Œæ¯”å¦‚ GatewayClassã€Gatewayã€è·¯ç”±ï¼ˆå¦‚ HTTPRouteã€TCPRoute ã€GRPCRouteï¼‰ã€Kubernetes æ ¸å¿ƒèµ„æºï¼ˆå¦‚ Namespaceã€Service ï¼‰ã€‚åé¢å‡ ç§èµ„æºè¿˜ä¼šåˆ†å‘½åç©ºé—´ï¼Œæ¯”å¦‚æ˜¯è¯·æ±‚å‘èµ·æ–¹ï¼ˆGatewayã€æœåŠ¡æ¶ˆè´¹æ–¹ï¼‰æˆ–è€…è¯·æ±‚æ¥æ”¶æ–¹ï¼ˆæœåŠ¡æä¾›æ–¹ï¼‰çš„å‘½åç©ºé—´ã€‚\nè¿™äº›èµ„æºçš„å½±å“èŒƒå›´å„æœ‰ä¸åŒï¼Œæˆ‘ä»¬æš‚ä¸”ç§°ä¸ºç²’åº¦ï¼Œæ¯”å¦‚ GatewayClass å½±å“æŸç±»ç½‘å…³å®ç°æ‰€æœ‰å®ä¾‹ä¸Šçš„æµé‡ï¼›Gateway èµ„æºåˆ™ç‰¹æŒ‡è¿›å…¥æŸä¸ªç½‘å…³å®ä¾‹çš„æµé‡ï¼›Namespace ç‰¹æŒ‡ç”±è¯¥å‘½åç©ºé—´ä¸‹çš„èµ„æºå‘å‡ºæˆ–è€…æ¥æ”¶çš„æµé‡ï¼›è·¯ç”±åˆ™ç‰¹æŒ‡å…·æœ‰æŸç§ç‰¹å¾çš„æµé‡ï¼Œå¹¶ä¸”è·¯ç”±çš„å®šä¹‰å¯ä»¥å®šä¹‰åœ¨å‘èµ·æ–¹çš„å‘½åç©ºé—´ï¼Œä¹Ÿå¯ä»¥å®šä¹‰åœ¨æ¥æ”¶æ–¹çš„å‘½åç©ºé—´ã€‚\nå¯è§è™½ç„¶ç­–ç•¥æ˜¯é™„åŠ åœ¨èµ„æºä¸Šï¼Œä½†ä½œç”¨çš„æœ€ç»ˆç›®æ ‡è¿˜æ˜¯æµé‡ï¼šå—åŒ—å‘æµé‡å’Œä¸œè¥¿å‘æµé‡ï¼Œåˆ†åˆ«å¯¹åº”å…¥å£ç­–ç•¥å’Œç½‘æ ¼ç­–ç•¥ã€‚\nå…¥å£ç­–ç•¥ ç½‘æ ¼ç­–ç•¥ è®¾è®¡ ç­–ç•¥ä¸èµ„æºå…³è”æ ‡å‡†åŒ– ç­–ç•¥ä¸èµ„æºå…³è”çš„è®¾è®¡å¼•å…¥äº† Target Reference API çš„æ¦‚å¿µï¼Œå³æ¯ä¸ªç­–ç•¥ä¸Šå¿…é¡»è¦æœ‰ä¸€ä¸ª targetRef å­—æ®µï¼Œé€šè¿‡è¯¥å­—æ®µå°†èµ„æºä¸ç­–ç•¥è¿›è¡Œå…³è”ï¼Œå®Œæˆè§£è€¦ã€‚\napiVersion: networking.example.net/v1alpha1 kind: TimeoutPolicy metadata: name: foo spec: default: connectionTimeout: 3 readTimeout: 5 targetRef: kind: HTTPRoute name: example targetRef å­—æ®µä¸€æ¬¡åªèƒ½æŒ‡å®šä¸€ä¸ªèµ„æºï¼Œä½†æ˜¯æ¯ä¸ªç­–ç•¥é…ç½®é…ç½®ä¸åŒç²’åº¦çš„èµ„æºã€‚æ¯”å¦‚ä¸Šé¢çš„é‡è¯•ç­–ç•¥ï¼Œé™„åŠ åœ¨åŒå‘½åç©ºé—´ä¸‹åä¸º example çš„ HTTPRoute ä¸Šã€‚å°†æ‰€æœ‰å…·æœ‰è¯¥ç‰¹å¾çš„æµé‡ï¼Œè¿æ¥è¶…æ—¶ä¸º 3ï¼Œè¯»å–è¶…æ—¶ä¸º 5ã€‚\ntargetRef å­—æ®µçš„ç»“æ„å›ºå®šçš„ï¼Œç”± Gateway API çš„ PolicyTargetReference è¿›è¡Œå®šä¹‰ï¼ŒåŒ…å«äº†èµ„æºçš„æœ€æœ€åŸºç¡€ä¿¡æ¯ã€‚\ntype PolicyTargetReference struct { Group Group `json:\u0026#34;group\u0026#34;` Kind Kind `json:\u0026#34;kind\u0026#34;` Name ObjectName `json:\u0026#34;name\u0026#34;` Namespace *Namespace `json:\u0026#34;namespace,omitempty\u0026#34;` } é»˜è®¤å€¼å’Œè¦†ç›–å€¼ é»˜è®¤å€¼ä½“ç°çš„æ˜¯ç¼ºçœçŠ¶æ€ä¸‹çš„ç­–ç•¥è®¾ç½®ï¼Œæ¯”å¦‚å‰é¢å…·æœ‰ HTTPRoute example æè¿°çš„ç‰¹å¾çš„æµé‡ï¼Œé€šè¿‡ spec.default é…ç½®äº†é»˜è®¤è¶…æ—¶æ—¶é—´ã€‚\nä¸‹é¢çš„ç­–ç•¥ï¼Œåˆ™ä½¿ç”¨ spec.override å¯¹æ‰€æœ‰è¿›å…¥ Gateway èµ„æº exampleï¼ˆç½‘å…³å®ä¾‹ï¼‰çš„æµé‡è¿æ¥è¶…æ—¶ä¸º 5ã€‚\né‚£æœ€ç»ˆå“ªä¸ªå€¼ä¼šç”Ÿæ•ˆå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£ï¼Œæ‰€æœ‰çš„è¦†ç›–å€¼çš„ä¼˜å…ˆçº§ä¼šé«˜äºé»˜è®¤å€¼ã€‚ä¹Ÿå°±æ˜¯ç¬¦åˆåŒ¹é…ç­–ç•¥æ¡ä»¶çš„æµé‡ï¼Œä¼šä¼˜å…ˆä½¿ç”¨è¦†ç›–å€¼ã€‚\napiVersion: networking.example.net/v1alpha1 kind: TimeoutPolicy metadata: name: foo spec: override: connectionTimeout: 5 targetRef: kind: Gateway name: example ç­–ç•¥çš„ä¼˜å…ˆçº§ é»˜è®¤å€¼å’Œè¦†ç›–å€¼çš„ä¼˜å…ˆçº§å·²ç»æœ‰äº†ï¼Œä¸Šé¢åœ¨ä»‹ç»èµ„æºçš„æ—¶å€™æåˆ°äº†èµ„æºçš„çº§åˆ«ï¼Œå¹¶ä¸”ç­–ç•¥ä¹Ÿå¯ä»¥é™„åŠ åˆ°ä¸é€šçš„èµ„æºä¸Šã€‚æ¯”å¦‚ä¸‹é¢çš„ç­–ç•¥å®šä¹‰äº†è¯»å–è¶…æ—¶çš„é»˜è®¤å€¼ä»¥åŠè¿æ¥è¶…æ—¶çš„è¦†ç›–å€¼ï¼Œé™„åŠ åˆ°äº† Service example ä¸Šï¼Œå®é™…ä½œç”¨çš„èµ„æºæ˜¯åç«¯ï¼ˆBackendï¼‰å·¥ä½œè´Ÿè½½ã€‚\napiVersion: networking.example.net/v1alpha1 kind: TimeoutPolicy metadata: name: foo spec: override: connectionTimeout: 1 default: readTimeout: 10 targetRef: kind: Service name: example æµé‡çš„è·¯å¾„æ˜¯ Gateway example -\u0026gt; HTTPRoute example -\u0026gt; Backend exampleï¼Œ\nå¯¹äº è¦†ç›–å€¼ï¼Œä¼˜å…ˆçº§ä¸èµ„æºçš„çº§åˆ«ç›¸åŒï¼›è€Œ é»˜è®¤å€¼ï¼Œåˆ™ä¸èµ„æºçš„çº§åˆ«æ­£å¥½ç›¸åã€‚å› æ­¤ï¼Œæœ€ç»ˆçš„ç”Ÿæ•ˆè®¾ç½®æ˜¯ï¼š\nconnectionTimeout: 5 # from gateway override readTimeout: 10 # from backend default ç°çŠ¶ ç›®å‰ Policy Attachment åªæ˜¯æä¾›äº†æ¦‚å¿µçš„è®¾è®¡ï¼Œè¿˜æœ‰å¾ˆå¤šæ–¹é¢æš‚æœªå®Œå–„ï¼Œè€Œä¸”å…·ä½“çš„å¤„ç†ç»†èŠ‚ä¹Ÿä¾èµ–å„ä¸ªå®ç°çš„è®¾è®¡ã€‚æ¯”å¦‚å¦‚ä½•ä¸ºå¤–éƒ¨èµ„æºï¼ˆæœåŠ¡ï¼‰é…ç½®ç­–ç•¥ã€åŒä¸€èµ„æºä¸Šçš„ç­–ç•¥ä¼˜å…ˆçº§ã€å¦‚ä½•ä¸ºå¤šç§èµ„æºé…ç½®ç›¸åŒçš„ç­–ç•¥ç­‰ç­‰ï¼ŒåŒæ—¶ Policy Attachment å¹¶æœªæä¾›å„ç§ç­–ç•¥çš„ APIã€‚\næˆªæ­¢æ–‡ç« å‘å‡ºæ—¶ï¼Œäº†è§£åˆ°çš„ Linkerd åœ¨ 1.12 ä¸­å‚è€ƒ Policy Attachment çš„è®¾è®¡å®ç°äº† AuthorizationPolicyï¼Œå¹¶è®¡åˆ’å¾… Gateway API ä¸­çš„è®¾è®¡ç¨³å®šååˆ‡æ¢åˆ° Gateway API çš„ CRDã€‚\nå¦‚æœä½ äº†è§£æœ‰å…¶ä»–çš„ Policy Attachment å®ç°ï¼Œå¯ä»¥åœ¨ä¸‹é¢ç•™è¨€ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/10/30/squashed.jpg","permalink":"https://atbug.com/explore-k8s-gateway-api-policy-attachment/","tags":["Kubernetes","ç½‘å…³","Service Mesh"],"title":"ä¸€æ–‡ææ‡‚ Kubernetes Gateway API çš„ Policy Attachment"},{"categories":["ç¬”è®°"],"contents":"ä¹‹å‰ä»‹ç»è¿‡ä¸€äº› Ingress ä½¿ç”¨ï¼Œæ¯”å¦‚ Ingress SSL é€ä¼ ã€Ingress çš„å¤šç§Ÿæˆ·ã€‚ä» Demo çœ‹èµ·æ¥æ˜¯åˆ›å»º Ingress ä¹‹åï¼Œå°±èƒ½ä»é›†ç¾¤å¤–è®¿é—®æœåŠ¡äº†ã€‚å®é™…ä¸Šé™¤äº† Ingress çš„ä½œç”¨ä»¥å¤–ï¼Œè¿˜æœ‰ Kubernetes Service å’Œè´Ÿè½½å‡è¡¡å™¨ï¼ˆLoad Balancerï¼‰å‚ä¸ï¼ˆå½“ Service ç±»å‹ä¸º LoadBalancer æ—¶ï¼‰ã€‚\nè¿™ç¯‡æ–‡ç« å°±æ¥ä»‹ç»äº† Kubernetes LoadBalancer Service å’Œä¸¤ä¸ªæ¯”è¾ƒå…¸å‹çš„è´Ÿè½½å‡è¡¡å™¨çš„å·¥ä½œåŸç†ã€‚\nLoadBalancer Service Service æ˜¯ Kubernetes ä¸­çš„èµ„æºç±»å‹ï¼Œç”¨æ¥å°†ä¸€ç»„ Pod çš„åº”ç”¨ä½œä¸ºç½‘ç»œæœåŠ¡å…¬å¼€ã€‚æ¯ä¸ª Pod éƒ½æœ‰è‡ªå·±çš„ IPï¼Œä½†æ˜¯è¿™ä¸ª IP çš„ç”Ÿå‘½å‘¨æœŸä¸ Pod ç”Ÿå‘½å‘¨æœŸä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯è¯´ Pod é”€æ¯åè¿™ä¸ª IP ä¹Ÿå°±æ— æ•ˆäº†ï¼ˆä¹Ÿå¯èƒ½è¢«åˆ†é…ç»™å…¶ä»–çš„ Pod ä½¿ç”¨ï¼‰ã€‚è€Œ Service çš„ IPï¼ˆClusterIPï¼‰ åˆ™æ˜¯åœ¨åˆ›å»ºä¹‹åä¾¿ä¸ä¼šæ”¹å˜ï¼ŒService ä¸ Pod ä¹‹å‰é€šè¿‡ userspace ä»£ç†ã€iptables å’Œ ipvs ä»£ç† ç­‰æ‰‹æ®µå…³è”ã€‚\nLoadBalancer æ˜¯ Service å››ç§ç±»å‹ä¸­çš„ä¸€ç§ï¼Œå…¶ä»–ä¸‰ç§æ˜¯ ClusterIPã€NodePortã€ExternalNameã€‚\nLoadBalancer çš„å·¥ä½œéœ€è¦æ­é…ç¬¬ä¸‰æ–¹çš„è´Ÿè½½å‡è¡¡å™¨æ¥å®Œæˆã€‚å½“æˆ‘ä»¬å®‰è£… Ingress æ§åˆ¶å™¨æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªç±»å‹ä¸º LoadBalancer çš„ Serviceã€‚æ–°åˆ›å»ºçš„ Service çš„ EXTERNAL-IP çŠ¶æ€æ˜¯ pendingï¼Œå‡å¦‚æ²¡æœ‰è´Ÿè½½å‡è¡¡å™¨çš„è¯ï¼Œä¼šä¸€ç›´å¤„äº pending çŠ¶æ€ï¼š\nNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE fsm-ingress-pipy-controller LoadBalancer 10.43.188.208 \u0026lt;pending\u0026gt; 80:30508/TCP 8s åœ¨ Demo ä¸­ç”¨çš„æ˜¯ K3sï¼ˆé»˜è®¤æä¾›äº†è´Ÿè½½å‡è¡¡å™¨ï¼‰ï¼Œè¿™ä¸ª Service ä¼šè·å¾— EXTERNAL-IPï¼Œ192.168.1.12 å’Œ 192.168.1.13 æ˜¯é›†ç¾¤ä¸­ä¸¤ä¸ªèŠ‚ç‚¹çš„ IPï¼Œå½“æˆ‘ä»¬ä½¿ç”¨è¯¥ IP åœ°å€è®¿é—®æ—¶ï¼Œæµé‡ä¼šè¿›å…¥åˆ° Ingress æ§åˆ¶å™¨çš„ podï¼Œç„¶åè·¯ç”±åˆ°é…ç½®å¯¹åº”çš„ pod ä¸­ã€‚\nNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) fsm-ingress-pipy-controller LoadBalancer 10.43.188.208 192.168.1.12,192.168.1.13 80:30508/TCP 47s å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ\nK3s æœåŠ¡ç«¯çš„ controller è¿è¡Œæ—¶ä¼šç›‘å¬é›†ç¾¤ä¸­ Service çš„å˜æ›´ï¼Œå¦‚æœ Service ç±»å‹æ˜¯ LoadBalancer ä¾¿ä¸ºå…¶åˆ›å»ºä¸€ä¸ª Daemonset ï¼Œä¼ å…¥ Service çš„ ClusterIPã€Protocolã€Port ç­‰ä¿¡æ¯ã€‚å‰©ä¸‹çš„å·¥ä½œå°±ç”±è¿™ä¸ª Daemonset æ¥å®Œæˆäº†ã€‚\nè€Œè¿™ä¸ª Daemonset ä½¿ç”¨çš„æ˜¯ klipper-lb çš„é•œåƒã€‚\nKlipper LB klipper-lb æ˜¯ K3s çš„ä¸€ä¸ªå¼€æºè´Ÿè½½å‡è¡¡å™¨çš„å®ç°ï¼Œå®ç°å¾ˆç®€å•ï¼šä½¿ç”¨ä¸»æœºç«¯å£ï¼ˆpod.spec.containers.ports.hostPort ä¸ Service çš„ç«¯å£å·ç›¸åŒï¼‰æ¥æ¥æ”¶æµé‡ï¼Œå¹¶ä½¿ç”¨ iptables å°†æ¥æ”¶çš„æµé‡è½¬å‘åˆ° Service çš„ ClusterIPã€‚\nPod å¯åŠ¨æ—¶ä½¿ç”¨é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥çš„ Service çš„ä¿¡æ¯ï¼Œåˆ›å»º iptables çš„ NAT è§„åˆ™ã€‚\nä»£ç é‡å¾ˆå°‘ï¼š\n#!/bin/sh set -e -x trap exit TERM INT for dest_ip in ${DEST_IPS} do if echo ${dest_ip} | grep -Eq \u0026#34;:\u0026#34; then if [ `cat /proc/sys/net/ipv6/conf/all/forwarding` != 1 ]; then exit 1 fi ip6tables -t nat -I PREROUTING ! -s ${dest_ip}/128 -p ${DEST_PROTO} --dport ${SRC_PORT} -j DNAT --to [${dest_ip}]:${DEST_PORT} ip6tables -t nat -I POSTROUTING -d ${dest_ip}/128 -p ${DEST_PROTO} -j MASQUERADE else if [ `cat /proc/sys/net/ipv4/ip_forward` != 1 ]; then exit 1 fi iptables -t nat -I PREROUTING ! -s ${dest_ip}/32 -p ${DEST_PROTO} --dport ${SRC_PORT} -j DNAT --to ${dest_ip}:${DEST_PORT} iptables -t nat -I POSTROUTING -d ${dest_ip}/32 -p ${DEST_PROTO} -j MASQUERADE fi done if [ ! -e /pause ]; then mkfifo /pause fi \u0026lt;/pause é‚£é™¤äº† klipper-lb ä»¥å¤–ï¼Œä»Šå¤©ä»‹ç»ä¸‹å¦ä¸€ç§è´Ÿè½½å‡è¡¡å™¨ metallbã€‚\nMetal LB MetalLB æ˜¯è£¸æœº Kubernetes é›†ç¾¤çš„è´Ÿè½½å‡è¡¡å™¨å®ç°ï¼Œä½¿ç”¨æ ‡å‡†è·¯ç”±åè®®ã€‚\næ³¨æ„ï¼šÂ MetalLB ç›®å‰è¿˜æ˜¯ beta é˜¶æ®µã€‚\nåœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ MetalLB ä½œä¸º LoadBalancerï¼ˆä¸Šï¼‰- Layer2 åœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ MetalLB ä½œä¸º LoadBalancerï¼ˆä¸‹ï¼‰- BGP å…³äº Metal LBï¼Œåœ¨ä¸Šé¢çš„æ–‡ç« ä»‹ç»è¿‡ã€‚å…¶æœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼Œè¿™é‡Œé€šè¿‡ BGP çš„å·¥ä½œæ¨¡å¼æ¥è¿›è¡Œè¯´æ˜ã€‚\nä¸ klipper-lb ä¸åŒçš„æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é¢„å…ˆé…ç½®å¥½å¯ç”¨çš„ IP åœ°å€æ®µã€‚å½“åˆ›å»º LoadBalancer ç±»å‹çš„ Service æ—¶ï¼Œmetallb ä¼šä»åœ°å€æ± ä¸­ä¸ºå…¶åˆ†é… IP åœ°å€ã€‚\nä»¥ Daemonset æ–¹å¼è¿è¡Œåœ¨å„ä¸ªèŠ‚ç‚¹çš„ speaker ç»„ä»¶ä¼šç›‘å¬ Service çš„å˜æ›´ï¼Œå¦‚æœè¯¥ Service å·²ç»åˆ†é…äº† IP åœ°å€ï¼ˆservice.status.loadBalancer.ingressï¼‰ï¼Œspeaker åœ¨å®Œæˆä¸€äº›åˆ—çš„æ ¡éªŒå·¥ä½œåä¼šå‘è·¯ç”±å™¨å£°æ˜è¯¥åœ°å€ã€‚\nè·¯ç”±æ¥æ”¶åˆ° speaker çš„å¹¿æ’­åï¼Œä¼šæ›´æ–°è·¯ç”±è¡¨ï¼šä½¿ç”¨ speaker çš„èŠ‚ç‚¹è¿›è¡Œè¯¥ IP çš„è·¯ç”±ã€‚\nå½“è¯·æ±‚è¯¥ IP åœ°å€æ—¶ï¼Œå› ä¸ºæ— æ³•æ‰¾åˆ° IP åœ°å€å¯¹åº”çš„ MAC åœ°å€ï¼ˆæ²¡æœ‰ ARP å¹¿æ’­ï¼‰ï¼Œä¾¿å°†è¯·æ±‚è½¬ç»™è·¯ç”±å™¨ã€‚è·¯ç”±å™¨æ ¹æ®è·¯ç”±è¡¨ä¸­çš„è®°å½•è¿›è¡Œè·¯ç”±ï¼Œè½¬å‘åˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Šã€‚åç»­çš„æµç¨‹ï¼Œå°±æ˜¯ iptables/kubeproxy çš„å·¥ä½œäº†ã€‚\nå¯èƒ½ä½ ä¹Ÿçœ‹å‡ºæ¥ï¼Œå¦‚æœç›®æ ‡ pod ä¸åœ¨è¯¥èŠ‚ç‚¹ä¸Š ï¼Œè¿˜ä¼šå†æœ‰ä¸€æ¬¡è½¬å‘ã€‚è¿™ç§æƒ…å†µå¯ä»¥é€šè¿‡è®¾ç½® Service çš„ externalTrafficPolicy æ¥é¿å…ã€‚\nå¦‚æœ service.sepc.externalTrafficPolicy è®¾ç½®ä¸º Localï¼Œåªæœ‰ Service çš„ Endpoints æ‰€åœ¨çš„èŠ‚ç‚¹ï¼Œæ‰ä¼šå‚ä¸å¹¿æ’­å’Œè·¯ç”±ï¼›å¦åˆ™ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ä¼šå‚ä¸å¹¿æ’­å’Œè·¯ç”±ã€‚\næ€»ç»“ ç”±äºç¯‡å¹…çš„åŸå› ï¼Œæœ¬æ–‡åªä»‹ç»äº†ä¸¤ç§ä¸åŒè´Ÿè½½å‡è¡¡å™¨çš„å·¥ä½œåŸç†ï¼Œæ²¡æœ‰æ·±å…¥æ¢ç´¢å…¶å®ç°ç»†èŠ‚ã€‚ä¸åŒäº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨çš„å®ç°å¯èƒ½å„ä¸ç›¸åŒï¼Œä¸åŒå®ç°é—´ä¹Ÿå„æœ‰ä¼˜ç¼ºç‚¹ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/09/30/redlighthouseg6a13100ad1280.jpg","permalink":"https://atbug.com/k8s-service-and-load-balancer/","tags":["Kubernetes","ç½‘ç»œ"],"title":"Kubernetes LoadBalancer Service ä¸è´Ÿè½½å‡è¡¡å™¨"},{"categories":["æ•™ç¨‹"],"contents":"é‡‘ä¸é›€å‘å¸ƒæ˜¯æœåŠ¡æ²»ç†ä¸­çš„é‡è¦åŠŸèƒ½ï¼Œåœ¨å‘å¸ƒæ—¶å¯ä»¥å¯æ§åœ°å°†éƒ¨åˆ†æµé‡å¯¼å…¥æ–°ç‰ˆæœ¬çš„æœåŠ¡ä¸­ï¼›å…¶ä½™çš„æµé‡åˆ™ç”±æ—§ç‰ˆæœ¬å¤„ç†ã€‚å‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€æ­¥å¢åŠ æ–°ç‰ˆæœ¬æœåŠ¡çš„æµé‡ã€‚é€šè¿‡æµ‹è¯•ï¼Œå¯ä»¥å†³å®šæ˜¯å›æ»šè¿˜æ˜¯å‡çº§æ‰€æœ‰å®ä¾‹ï¼Œåœç”¨æ—§ç‰ˆæœ¬ã€‚\næœ‰äº†é‡‘ä¸é›€å‘å¸ƒï¼Œä½¿ç”¨çœŸå®æµé‡å¯¹æœåŠ¡è¿›è¡Œæµ‹è¯•ï¼Œé€šè¿‡å¯¹æµé‡çš„æ§åˆ¶å¯ä»¥æœ‰æ•ˆçš„é™ä½æœåŠ¡å‘å¸ƒçš„é£é™©ã€‚\næœ¬æ–‡å°†ä»‹ç»å¦‚ä½•å°†ä½¿ç”¨ Argo Rollouts å’ŒæœåŠ¡ç½‘æ ¼ osm-edge æ¥è¿›è¡Œåº”ç”¨çš„è‡ªåŠ¨ã€å¯æ§çš„é‡‘ä¸é›€å‘å¸ƒï¼Œä¸æ¶‰åŠå·¥ä½œåŸç†çš„åˆ†æã€‚å¯¹å·¥ä½œåŸç†æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ç•™è¨€ï¼Œå¯ä»¥å†åšä¸€ç¯‡åŸç†çš„ä»‹ç»ã€‚\nArgo Rollouts Argo Rollouts åŒ…æ‹¬ä¸€ä¸ª Kubernetesæ§åˆ¶å™¨ å’Œä¸€ç»„ CRDï¼Œæä¾›å¦‚è“ç»¿è‰²ã€é‡‘ä¸é›€ã€é‡‘ä¸é›€åˆ†æã€ä½“éªŒç­‰é«˜çº§éƒ¨ç½²åŠŸèƒ½å’Œ Kubernetes çš„æ¸è¿›äº¤ä»˜åŠŸèƒ½ã€‚\nArgo Rollouts ä¸ å…¥å£æ§åˆ¶å™¨ å’ŒæœåŠ¡ç½‘æ ¼é›†æˆï¼Œåˆ©ç”¨å…¶æµé‡ç®¡ç†èƒ½åŠ›ï¼Œåœ¨å‘å¸ƒæœŸé—´é€æ­¥å°†æµé‡è½¬ç§»åˆ°æ–°ç‰ˆæœ¬ã€‚æ­¤å¤–ï¼ŒRollouts å¯ä»¥æŸ¥è¯¢å’Œè§£ææ¥è‡ªå„ç§æä¾›å•†çš„æŒ‡æ ‡ï¼Œä»¥éªŒè¯å…³é”® KPIï¼Œå¹¶åœ¨æ›´æ–°æœŸé—´æ¨åŠ¨è‡ªåŠ¨æ¨è¿›æˆ–å›æ»šã€‚\nArgo Rollouts æ”¯æŒæœåŠ¡ç½‘æ ¼æ ‡å‡† SMIï¼ˆService Mesh Interfaceï¼‰ çš„ TrafficSplit APIï¼Œé€šè¿‡ TrafficSplit API çš„ä½¿ç”¨æ¥æ§åˆ¶é‡‘ä¸é›€å‘å¸ƒæ—¶çš„æµé‡æ§åˆ¶ã€‚\næœåŠ¡ç½‘æ ¼ osm-edge æœåŠ¡ç½‘æ ¼æ˜¯å¤„ç†æœåŠ¡é—´ç½‘ç»œé€šä¿¡çš„åŸºç¡€è®¾æ–½ç»„ä»¶ï¼Œæ—¨åœ¨ä»å¹³å°å±‚é¢æä¾›å¯è§‚æ€§ã€å®‰å…¨ä»¥åŠå¯é æ€§ç‰¹æ€§ï¼Œä»¥è¿›ç¨‹å¤–çš„æ–¹å¼æä¾›åŸæœ¬ç”±éƒ¨åˆ†åº”ç”¨å±‚é€»è¾‘æ‰¿è½½çš„åŸºç¡€èƒ½åŠ›ï¼ŒçœŸæ­£å®ç°ä¸ä¸šåŠ¡é€»è¾‘çš„åˆ†ç¦»ã€‚\nosm-edge æ˜¯é¢å‘äº‘è¾¹ä¸€ä½“çš„è½»é‡åŒ–æœåŠ¡ç½‘æ ¼ï¼Œé‡‡ç”¨å®ç°äº†æœåŠ¡ç½‘æ ¼æ ‡å‡† SMIï¼ˆService Mesh Interfaceï¼‰ çš„Â osmï¼ˆOpen Service Meshï¼‰ ä½œä¸ºæ§åˆ¶å¹³é¢ï¼Œé‡‡ç”¨Â PipyÂ ä½œä¸ºæ•°æ®å¹³é¢ï¼Œé‡‡ç”¨ fsm é¡¹ç›®æä¾›çš„ Ingressã€Egressã€Gateway API å¤šé›†ç¾¤æœåŠ¡ç½‘æ ¼èƒ½åŠ›ï¼Œå…·æœ‰é«˜æ€§èƒ½ã€ä½èµ„æºã€ç®€å•ã€æ˜“ç”¨ã€æ˜“æ‰©å±•ã€å¹¿æ³›å…¼å®¹ï¼ˆæ”¯æŒ x86/arm64/é¾™èŠ¯/RISC-Vï¼‰çš„ç‰¹ç‚¹ã€‚\nç¯å¢ƒå‡†å¤‡ K3s export INSTALL_K3S_VERSION=v1.23.8+k3s2 curl -sfL https://get.k3s.io | sh -s - --disable traefik --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config å®‰è£…æœåŠ¡ç½‘æ ¼ æ¨èä½¿ç”¨ CLI è¿›è¡Œå®‰è£…ã€‚\nsystem=$(uname -s | tr [:upper:] [:lower:]) arch=$(dpkg --print-architecture) release=v1.1.2 curl -L https://github.com/flomesh-io/osm-edge/releases/download/${release}/osm-edge-${release}-${system}-${arch}.tar.gz | tar -vxzf - ./${system}-${arch}/osm version cp ./${system}-${arch}/osm /usr/local/bin/ CLI ä¸‹è½½ä¹‹åå°±å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œå®‰è£…äº†ï¼Œè¿™é‡Œé»˜è®¤å¼€å¯ å®½æ¾æµé‡ç­–ç•¥æ¨¡å¼ å¹¶å®‰è£… Ingressã€‚\nexport osm_namespace=osm-system export osm_mesh_name=osm osm install \\ --mesh-name \u0026#34;$osm_mesh_name\u0026#34; \\ --osm-namespace \u0026#34;$osm_namespace\u0026#34; \\ --set=osm.enablePermissiveTrafficPolicy=true \\ --set=fsm.enabled=true ç¡®è®¤ pod æ­£å¸¸å¯åŠ¨å¹¶è¿è¡Œã€‚\nkubectl get pods -n osm-system NAME READY STATUS RESTARTS AGE fsm-repo-d785b55d-r92r5 1/1 Running 0 2m20s osm-bootstrap-646497898f-cdjq4 1/1 Running 0 3m12s osm-controller-7bbdcf748b-jdhsw 2/2 Running 0 3m12s fsm-manager-7f9b665bd9-s8z6p 1/1 Running 0 3m12s fsm-bootstrap-57cb75d586-vvvzl 1/1 Running 0 3m01s osm-injector-86798c9ddb-gfqb4 1/1 Running 0 3m12s fsm-ingress-pipy-5bc7f4d6f6-7th6g 1/1 Running 0 3m12s fsm-cluster-connector-local-7464b77ffd-cphxf 1/1 Running 0 4m22s å®‰è£… Argo Rollouts kubectl create namespace argo-rollouts kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml Argo Rollouts ä¸­é»˜è®¤ä½¿ç”¨ SMI TrafficSplit çš„ v1alpha1 ç‰ˆæœ¬ï¼Œé€šè¿‡ä¸‹é¢çš„å‘½ä»¤æŒ‡å®šå…¶ä½¿ç”¨ v1alpha2 çš„ç‰ˆæœ¬ã€‚\nkubectl patch deployment argo-rollouts -n argo-rollouts --type=json -p=\u0026#39;[{\u0026#34;op\u0026#34;: \u0026#34;add\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/spec/template/spec/containers/0/args\u0026#34;, \u0026#34;value\u0026#34;: [\u0026#34;--traffic-split-api-version=v1alpha2\u0026#34;]}]\u0026#39; ç¡®è®¤ pod æ­£å¸¸å¯åŠ¨å¹¶è¿è¡Œã€‚\nkubectl get pods -n argo-rollouts NAME READY STATUS RESTARTS AGE argo-rollouts-58b9bc98f7-cj79l 1/1 Running 0 1m5s å®‰è£… kubectl argo æ’ä»¶ ä½¿ç”¨ kubectl argo æ’ä»¶å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå¯¹å‘å¸ƒè¿›è¡Œæ“ä½œã€‚\nåœ¨ macOS ä¸‹ï¼Œå…¶ä»–å¹³å°å‚è€ƒ å®˜æ–¹å®‰è£…æ–‡æ¡£ã€‚\nbrew install argoproj/tap/kubectl-argo-rollouts é€šè¿‡ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨ Argo Rollouts Dashboardï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://localhost:3100/rollouts å°±å¯è®¿é—® Dashboardã€‚\nkubectl argo rollouts dashboard æ¥ä¸‹æ¥å°±æ˜¯éƒ¨ç½²ç¤ºä¾‹åº”ç”¨ã€‚\néƒ¨ç½²åº”ç”¨ ç¤ºä¾‹åº”ç”¨ä½¿ç”¨å¸¸è§çš„ bookstore ç³»ç»Ÿï¼ŒåŒ…å«ä¸‹é¢å‡ ä¸ªç»„ä»¶ã€‚è¿™é‡Œåªå¯¹ bookstore åº”ç”¨è¿›è¡Œé‡‘ä¸é›€å‘å¸ƒï¼Œä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œé™¤äº† bookstore ä»¥å¤–çš„å‡ ä¸ªåº”ç”¨ç»§ç»­ä½¿ç”¨ Deployment çš„æ–¹å¼éƒ¨ç½²ï¼Œåªæœ‰ bookstore ä½¿ç”¨ Argo Rollouts çš„ Rollout CRDã€‚\nbookbuyerÂ æ˜¯ä¸€ä¸ª HTTP å®¢æˆ·ç«¯ï¼Œå®ƒå‘é€è¯·æ±‚ç»™Â bookstoreã€‚è¿™ä¸ªæµé‡æ˜¯ å…è®¸ çš„ã€‚ bookthiefÂ æ˜¯ä¸€ä¸ª HTTP å®¢æˆ·ç«¯ï¼Œå¾ˆåƒÂ bookbuyerï¼Œä¹Ÿä¼šå‘é€ HTTP è¯·æ±‚ç»™Â bookstoreã€‚è¿™ä¸ªæµé‡åº”è¯¥è¢« é˜»æ­¢ã€‚ bookstoreÂ æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œè´Ÿè´£å¯¹ HTTP è¯·æ±‚ç»™ä¸å“åº”ã€‚åŒæ—¶ï¼Œè¯¥æœåŠ¡å™¨ä¹Ÿæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå‘é€è¯·æ±‚ç»™Â bookwarehouseÂ æœåŠ¡ã€‚è¿™ä¸ªæµé‡æ˜¯è¢« å…è®¸ çš„ã€‚ bookwarehouseÂ æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œåº”è¯¥åªå¯¹Â bookstoreÂ åšå‡ºå“åº”ã€‚bookbuyerÂ å’ŒÂ bookthiefÂ éƒ½åº”è¯¥è¢«å…¶é˜»æ­¢ã€‚ mysqlÂ æ˜¯ä¸€ä¸ª MySQL æ•°æ®åº“ï¼Œåªæœ‰Â bookwarehouseÂ å¯ä»¥è®¿é—®ã€‚ è¿™é‡Œèˆå¼ƒäº† bookthief åº”ç”¨ã€‚\nåˆ›å»ºå‘½åç©ºé—´ åˆ›å»ºå‘½åç©ºé—´ rollouts-demo ï¼Œå¹¶çº³å…¥åˆ°ç½‘æ ¼ç®¡ç†ä¸­ã€‚\nkubectl create namespace rollouts-demo kubectl config set-context --current --namespace rollouts-demo osm namespace add rollouts-demo åˆ›å»º Service kubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: v1 kind: Service metadata: name: bookbuyer namespace: rollouts-demo labels: app: bookbuyer spec: ports: - port: 14001 name: bookbuyer-port selector: app: bookbuyer --- apiVersion: v1 kind: Service metadata: name: bookstore namespace: rollouts-demo labels: app: bookstore spec: ports: - port: 14001 name: bookstore-port selector: app: bookstore --- apiVersion: v1 kind: Service metadata: name: bookstore-v1 namespace: rollouts-demo labels: app: bookstore version: v1 spec: ports: - port: 14001 name: bookstore-port selector: app: bookstore --- apiVersion: v1 kind: Service metadata: name: bookstore-v2 namespace: rollouts-demo labels: app: bookstore version: v2 spec: ports: - port: 14001 name: bookstore-port selector: app: bookstore --- apiVersion: v1 kind: Service metadata: name: bookwarehouse namespace: rollouts-demo labels: app: bookwarehouse spec: ports: - port: 14001 name: bookwarehouse-port selector: app: bookwarehouse --- apiVersion: v1 kind: Service metadata: name: mysql namespace: rollouts-demo spec: ports: - port: 3306 targetPort: 3306 name: client appProtocol: tcp selector: app: mysql clusterIP: None EOF éƒ¨ç½² Deployment åº”ç”¨ kubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: apps/v1 kind: Deployment metadata: name: bookbuyer namespace: rollouts-demo spec: replicas: 1 selector: matchLabels: app: bookbuyer version: v1 template: metadata: labels: app: bookbuyer version: v1 spec: nodeSelector: kubernetes.io/os: linux containers: - name: bookbuyer image: flomesh/bookbuyer:latest imagePullPolicy: Always command: [\u0026#34;/bookbuyer\u0026#34;] env: - name: \u0026#34;BOOKSTORE_NAMESPACE\u0026#34; value: rollouts-demo - name: \u0026#34;BOOKSTORE_SVC\u0026#34; value: bookstore --- apiVersion: apps/v1 kind: Deployment metadata: name: bookwarehouse namespace: rollouts-demo spec: replicas: 1 selector: matchLabels: app: bookwarehouse template: metadata: labels: app: bookwarehouse version: v1 spec: nodeSelector: kubernetes.io/os: linux containers: - name: bookwarehouse image: flomesh/bookwarehouse:latest imagePullPolicy: Always command: [\u0026#34;/bookwarehouse\u0026#34;] --- apiVersion: apps/v1 kind: StatefulSet metadata: name: mysql namespace: rollouts-demo spec: serviceName: mysql replicas: 1 selector: matchLabels: app: mysql template: metadata: labels: app: mysql spec: nodeSelector: kubernetes.io/os: linux containers: - image: mariadb:10.7.4 name: mysql env: - name: MYSQL_ROOT_PASSWORD value: mypassword - name: MYSQL_DATABASE value: booksdemo ports: - containerPort: 3306 name: mysql volumeMounts: - mountPath: /mysql-data name: data readinessProbe: tcpSocket: port: 3306 initialDelaySeconds: 15 periodSeconds: 10 volumes: - name: data emptyDir: {} volumeClaimTemplates: - metadata: name: data spec: accessModes: [ \u0026#34;ReadWriteOnce\u0026#34; ] resources: requests: storage: 250M EOF éƒ¨ç½² bookstore Rollout æˆ‘ä»¬ä¸º bookstore çš„é‡‘ä¸é›€å‘å¸ƒè®¾ç½®äº†ä¸‰ä¸ªé˜¶æ®µï¼š10%ã€50%ã€90% æµé‡ï¼Œæ¯ä¸ªé˜¶æ®µåéƒ½ä¼šè¿›å…¥æš‚åœçŠ¶æ€ï¼ˆä¹Ÿå¯ä»¥è®¾ç½®æš‚åœæ—¶é—´ã€æ¡ä»¶ç­‰ç­‰ï¼‰ã€‚\nå‰é¢åˆ›å»º Service æ—¶ï¼Œæˆ‘ä»¬ä¸º bookstore åˆ›å»ºäº†å¦‚ä¸‹ä¸‰ä¸ªæœåŠ¡ï¼Œè¿™é‡Œæ­£å¥½ä¼šç”¨åˆ°ï¼š\næ ¹æœåŠ¡ bookstore ç¨³å®šç‰ˆæœåŠ¡ bookstore-v1 é‡‘ä¸é›€ç‰ˆæœ¬ bookstore-v2 kubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: argoproj.io/v1alpha1 kind: Rollout metadata: name: bookstore namespace: rollouts-demo spec: replicas: 1 strategy: canary: canaryService: bookstore-v2 stableService: bookstore-v1 trafficRouting: smi: rootService: bookstore steps: - setWeight: 10 - pause: {} - setWeight: 50 - pause: {} - setWeight: 90 - pause: {} revisionHistoryLimit: 2 selector: matchLabels: app: bookstore template: metadata: labels: app: bookstore spec: nodeSelector: kubernetes.io/os: linux containers: - name: bookstore image: addozhang/bookstore-v1:latest imagePullPolicy: Always ports: - containerPort: 14001 name: web command: [\u0026#34;/bookstore\u0026#34;] args: [\u0026#34;--port\u0026#34;, \u0026#34;14001\u0026#34;] env: - name: BOOKWAREHOUSE_NAMESPACE value: rollouts-demo EOF éƒ¨ç½²å®Œæˆåï¼Œæ­¤æ—¶ bookstore-v1 çš„ç‰ˆæœ¬ä¼šè¿è¡Œï¼Œå¹¶ä¸ä¼šéƒ¨ç½²æ–°çš„ç‰ˆæœ¬ï¼Œæ­¤æ—¶ä¸‰ä¸ª Service éƒ½ä¼šé€‰æ‹©åˆ°ç¨³å®šç‰ˆæœ¬çš„ podã€‚\nkubectl get endpoints -n rollouts-demo -l app=bookstore NAME ENDPOINTS AGE bookstore-v1 10.42.1.34:14001 54s bookstore 10.42.1.34:14001 54s bookstore-v2 10.42.1.34:14001 54s æŸ¥çœ‹ TrafficSplit çš„è®¾å®šï¼Œè®¿é—® bookstore çš„æ‰€æœ‰æµé‡éƒ½ä¼šè¿›å…¥ bookstore-v1 çš„ endpoint ä¸­ï¼š\nkubectl get trafficsplit bookstore -n rollouts-demo -o yaml apiVersion: split.smi-spec.io/v1alpha2 kind: TrafficSplit metadata: name: bookstore namespace: rollouts-demo spec: backends: - service: bookstore-v2 weight: 0 - service: bookstore-v1 weight: 100 service: bookstore æŸ¥çœ‹ Argo Rollouts Dashboardï¼Œå¯ä»¥çœ‹åˆ°åˆšåˆšåˆ›å»ºçš„ Rolloutã€‚\nç‚¹å¼€å¯ä»¥çœ‹åˆ°è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬å½“å‰çš„ revisionï¼Œå·²ç»æˆ‘ä»¬è®¾ç½®çš„å‘å¸ƒæ­¥éª¤ã€‚\nåˆ›å»º bookbuyer Ingress ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹è¿è¡Œæ•ˆæœï¼Œä¸º bookbuyer åˆ›å»º Ingressã€‚ç„¶åå°±å¯ä»¥é€šè¿‡ http://ingress_host:80 æ¥è®¿é—® bookbuyer åº”ç”¨äº†ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ http://ingress_host:80/reset æ¥é‡ç½®åº”ç”¨é¡µé¢çš„è®¡æ•°å™¨ï¼Œæ–¹ä¾¿ç°åº¦å‘å¸ƒçš„æ•ˆæœç¡®è®¤ã€‚\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: bookbuyer namespace: rollouts-demo spec: ingressClassName: pipy rules: - http: paths: - path: / pathType: Prefix backend: service: name: bookbuyer port: number: 14001 --- kind: IngressBackend apiVersion: policy.openservicemesh.io/v1alpha1 metadata: name: bookbuyer namespace: rollouts-demo spec: backends: - name: bookbuyer port: number: 14001 protocol: http sources: - kind: Service namespace: osm-system name: fsm-ingress-pipy-controller EOF å‘å¸ƒæµ‹è¯• ç¬”è€…çš„ ingress IP æ˜¯ 192.168.1.12ï¼Œå› æ­¤åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://192.168.1.12ã€‚æ­¤æ—¶ï¼Œæ‰€æœ‰çš„æµé‡éƒ½åˆ°äº† bookstore-v1ã€‚\næ‰§è¡Œåº”ç”¨å‡çº§ é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ï¼Œéƒ¨ç½² bookstore v2 ç‰ˆæœ¬å¼€å§‹é‡‘ä¸é›€å‘å¸ƒã€‚é™¤äº†å‘½ä»¤è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨ Dashboard çš„å‘å¸ƒè¯¦æƒ…é¡µé¢ä¸Šä¿®æ”¹å®¹å™¨çš„é•œåƒã€‚\nkubectl argo rollouts set image bookstore bookstore=addozhang/bookstore-v2:latest ç„¶åé€šè¿‡ä¸‹é¢çš„å‘½ä»¤å¯ä»¥æŸ¥çœ‹ç¨³å®šç‰ˆå’Œé‡‘ä¸é›€ç‰ˆæœ¬çš„å®ä¾‹çŠ¶æ€ã€‚\nkubectl argo rollouts get rollout bookstore é‡ç½® bookstore åº”ç”¨é¡µé¢çš„è®¡æ•°å™¨åï¼Œå¯ä»¥å‘ç° v1 å’Œ v2 æµé‡æ¥è¿‘ 9:1ã€‚\nDashboard çš„å‘å¸ƒè¯¦æƒ…é¡µä¸Šï¼Œä¼šæ˜¾ç¤º v2 ç‰ˆæœ¬çš„ revisionï¼Œå³ä¾§ steps åˆ—è¡¨ä¸­å¯ä»¥çœ‹åˆ°å½“å‰å¤„äºç¬¬ä¸€ä¸ª pause é˜¶æ®µã€‚\næ¨è¿›åˆ° 50% æµé‡ éªŒè¯å®Œæˆåï¼Œå°±å¯ä»¥å°†å‘å¸ƒæ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µã€‚å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œä¹Ÿå¯åœ¨ Dashboard è¯¦æƒ…é¡µä¸Šç‚¹å‡» PROMOTE æŒ‰é’®ã€‚\nkubectl argo rollouts promote bookstore rollout \u0026#39;bookstore\u0026#39; promoted è¿˜æ˜¯å…ˆæ¸…ç©ºåº”ç”¨é¡µé¢è®¡æ•°å™¨ï¼Œç„¶åæŸ¥çœ‹æ•ˆæœã€‚\næ¨è¿›åˆ° 100% æµé‡ æ¥ä¸‹æ¥ï¼Œå¯ä»¥ç»§ç»­æ¨èåˆ°ä¸‹ä¸€é˜¶æ®µ 90%ã€‚ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ç›´æ¥è¿›å…¥åˆ°æœ€åçš„é˜¶æ®µ 100%ï¼Œåœ¨ Dashboard è¯¦æƒ…é¡µä¸Šç‚¹å‡» PROMOTE-FULL ä¹Ÿå¯è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚\nkubectl argo rollouts promote bookstore --full rollout \u0026#39;bookstore\u0026#39; fully promoted å…¶ä»–æ“ä½œ åœ¨å‘å¸ƒçš„ä»»ä½•ä¸€ä¸ªé˜¶æ®µï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤æˆ–è€…é¡µé¢ä¸Šçš„æ“ä½œå›åˆ°ä¸Šä¸€ä¸ªé˜¶æ®µï¼Œæˆ–è€…é€€å‡ºå‘å¸ƒã€‚\n#å›åˆ°ä¸Šä¸€é˜¶æ®µ kubectl argo rollouts undo bookstore #é€€å‡ºå‘å¸ƒ kubectl argo rollouts abort bookstore æ€»ç»“ æœåŠ¡ç½‘æ ¼ä»¥è¿›ç¨‹å¤–æ— ä¾µå…¥çš„æ–¹å¼ä¸ºæœåŠ¡æä¾›äº†ä¸°å¯Œçš„æ²»ç†åŠŸèƒ½ï¼Œä»å¹³å°å±‚é¢æå‡ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§ã€å®‰å…¨ä»¥åŠå¯é æ€§ã€‚é‡‘ä¸é›€å‘å¸ƒæ˜¯æœåŠ¡ç½‘æ ¼çš„ä¸»è¦åº”ç”¨åœºæ™¯ä¹‹ä¸€ï¼Œå¤§å¤§å‡ä½äº†åº”ç”¨å‘å¸ƒå¸¦æ¥çš„é£é™©ï¼Œå°†ä¸ç¨³å®šæ€§é™åˆ¶åœ¨å¯æ§çš„èŒƒå›´å†…ã€‚\nåŒæ—¶ Argo Rollouts ä¹Ÿæä¾›äº†ä¸°å¯Œçš„è®¾ç½®ï¼Œæ¥æ§åˆ¶å‘å¸ƒçš„æµç¨‹ï¼Œæ»¡è¶³ä¸åŒçš„ä½¿ç”¨éœ€æ±‚ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/09/21/pexelsjeremybishop12088976.jpg","permalink":"https://atbug.com/canary-release-via-argo-rollouts-and-service-mesh/","tags":["Service Mesh","CICD","SMI"],"title":"ä½¿ç”¨ Argo Rollouts å’ŒæœåŠ¡ç½‘æ ¼å®ç°è‡ªåŠ¨å¯æ§çš„é‡‘ä¸é›€å‘å¸ƒ"},{"categories":["ç¬”è®°"],"contents":"æœ€è¿‘æ­£åœ¨è¯» ã€ŠSolving the Bottom Turtleã€‹ è¿™æœ¬ä¹¦ï¼Œè¿™ç¯‡æ˜¯å¯¹éƒ¨åˆ†å†…å®¹çš„æ€»ç»“å’Œæ€è€ƒï¼Œç”±äºå†…å®¹è¾ƒå¤šï¼Œä¼šåˆ†å‡ ç¯‡æ¥å‘ã€‚\nè¿™æœ¬ä¹¦çš„å‰¯æ ‡é¢˜æ˜¯ï¼š\na SPIFFE Way to Establish Trust in Your Infrastructure via Universal Identity. é€šè¿‡é€šç”¨èº«ä»½ä»¥ SPIFFE çš„æ–¹å¼åœ¨åŸºç¡€è®¾æ–½ä¸­å»ºç«‹ä¿¡ä»»ã€‚\nå¤§å®¶è®°ä½å…¶ä¸­çš„æœ‰å‡ ä¸ªå…³é”®è¯ï¼šé€šç”¨èº«ä»½ã€SPIFFE çš„æ–¹å¼ã€åŸºç¡€è®¾æ–½ã€å»ºç«‹ä¿¡ä»»ã€‚\nèƒŒæ™¯ é›¶ä¿¡ä»»æ˜¯ä¸€ç§å¼‚å¸¸ç«çƒ­çš„å®‰å…¨æ¨¡å‹ï¼Œåœ¨ä¹‹å‰ç¿»è¯‘çš„æ–‡ç« ä¸­ ã€Šé›¶ä¿¡ä»»å¯¹ Kubernetes æ„å‘³ç€ä»€ä¹ˆã€‹ï¼Œå¯¹ä»€ä¹ˆæ˜¯é›¶ä¿¡ä»»ã€ä¸ºä»€ä¹ˆè¦å®æ–½é›¶ä¿¡ä»»ï¼Œåšäº†åˆæ­¥çš„ä»‹ç»ã€‚\nè¿‡å»å‡ åå¹´æµè¡Œçš„è¾¹ç•Œå®‰å…¨æ¨¡å‹ï¼Œå·²ç»ä¸åœ¨é€‚åˆå¦‚ä»Šåˆ†å¸ƒå¼çš„å¾®æœåŠ¡æ¶æ„ã€å¤æ‚å¤šæ ·çš„ç³»ç»Ÿç¯å¢ƒä»¥åŠä¸å¯é¿å…çš„äººä¸ºå¤±è¯¯ã€‚ä»é›¶ä¿¡ä»»çš„åŸåˆ™æ¥çœ‹ï¼Œé€šè¿‡å®‰å…¨è¾¹ç•Œé˜²æŠ¤çš„äººã€ç³»ç»Ÿå’Œç½‘ç»œæµé‡æ˜¯ä¸å¯ä¿¡çš„ï¼Œå› ä¸ºâ€œä½ å¯èƒ½ä¸æ˜¯ä½ â€ï¼Œèº«ä»½ä¸å¯ä¿¡ã€‚\nå¯èƒ½æœ‰äººä¼šé—®ä¸æ˜¯æœ‰ç”¨æˆ·åå¯†ç ã€è¯ä¹¦ä¹ˆï¼Ÿè¿™äº›éƒ½å¯èƒ½å­˜åœ¨æ³„éœ²ï¼Œå°¤å…¶æ˜¯æ—¶é—´è¶Šé•¿æ³„éœ²çš„æ¦‚ç‡è¶Šé«˜ï¼ˆåœ¨å®‰å…¨é¢†åŸŸï¼Œåªæœ‰ 0 å’Œ 100ï¼Œæ‰€æœ‰åšä¸åˆ° 100% çš„å®‰å…¨ï¼Œéƒ½å°†å…¶è§†ä½œ 0ã€‚è¿™ä¹Ÿæ˜¯ç¬”è€…å¯¹é›¶ä¿¡ä»»çš„æµ…è–„ç†è§£ï¼‰ã€‚\né›¶ä¿¡ä»»æ¨¡å‹çš„æ ¸å¿ƒæ˜¯é‡å¡‘èº«ä»½çš„åˆ†é…å’ŒéªŒè¯æ–¹å¼ï¼Œèº«ä»½æ˜¯æ„å»ºé›¶ä¿¡ä»»æ¨¡å‹çš„åŸºçŸ³ã€‚\nèº«ä»½ ç°å®ä¸–ç•Œçš„èº«ä»½ åœ¨è¯´ç³»ç»Ÿèº«ä»½ä¹‹å‰ï¼Œå…ˆè¯´ä¸‹ç°å®ä¸­çš„èº«ä»½ã€‚å¤§å®¶éƒ½æœ‰èº«ä»½è¯ï¼ˆIdentity Cardï¼‰ï¼Œç”Ÿæ´»ä¸­ç”¨åˆ°èº«ä»½è¯çš„åœºæ™¯ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œå¾ˆå¤šçš„æœåŠ¡éƒ½ä¼šæŸ¥éªŒèº«ä»½è¯ã€‚ä¸ºä»€ä¹ˆèº«ä»½è¯å°±èƒ½éªŒè¯æŒæœ‰äººçš„èº«ä»½ï¼Œé¦–å…ˆèº«ä»½è¯æ˜¯ç”±æ”¿åºœæœºæ„é¢å‘çš„ï¼Œåœ¨é¢å‘å‰ä¼šæŸ¥éªŒè¿‡ç”³è¯·çš„äººä¿¡æ¯ï¼ˆè¯æ˜ä½ å°±æ˜¯ä½ ï¼‰ï¼Œè¿™ä¸ªå……åˆ†å¯ä¿¡çš„ï¼›èº«ä»½è¯æœ¬èº«åšäº†é˜²ä¼ªå¤„ç†ï¼Œæœ‰ç‰¹å®šçš„æŸ¥éªŒæ‰‹æ®µå¾ˆéš¾è¢«ä¼ªé€ ã€‚è¿™é‡Œæœ‰å‡ ä¸ªå®šä¹‰ï¼š\nä¸»ä½“ï¼šäºº èº«ä»½ï¼šå”¯ä¸€ IDã€‚å®é™…ä¸Šèº«ä»½è¯å·è¿™ä¸ªå”¯ä¸€ ID å°±æ˜¯ä¸ªäººçš„èº«ä»½ï¼Œè€Œå§“ååªæ˜¯ä»£ç§°ã€‚ èº«ä»½è¯æ˜æ–‡ä»¶ï¼šèº«ä»½è¯ï¼Œèº«ä»½è¯å·ã€å§“åã€æ€§åˆ«ã€ç…§ç‰‡ã€æœ‰æ•ˆæœŸç­‰ç­‰ï¼ˆç”³è¯·æ—¶è¿˜ä¼šå½•å…¥ç”Ÿç‰©è¯†åˆ«ä¿¡æ¯ï¼‰ã€‚ é¢å‘æœºæ„ï¼šæ”¿åºœæœºæ„ã€‚ å†è€…èº«ä»½è¯ä»…é™åœ¨å›½å†…ä½¿ç”¨ï¼Œåªæœ‰åœ¨å›½å†…è¢«ä¿¡ä»»ï¼Œè¿™ä¸ªåŒºåŸŸå°±æ˜¯å¦ä¸€ä¸ªå®šä¹‰â€œä¿¡ä»»åŸŸâ€ã€‚\nå‡ºå›½å°±è¦ä½¿ç”¨å¦ä¸€ç§è¯ä»¶æŠ¤ç…§ï¼ŒæŠ¤ç…§æ˜¯æŒ‰ç…§å›½é™…æ ‡å‡†åˆ¶ä½œå’Œé¢å‘çš„ï¼Œå¯ä»¥è¢«å…¶ä»–å›½å®¶æ¥å—ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ä¿¡ä»»åŸŸé—´äº’ä¿¡ã€‚è¿™äº›äº’ä¿¡çš„ä¿¡ä»»åŸŸï¼Œå°±ç»„æˆäº†ä¿¡ä»»è”ç›Ÿã€‚\nè¿™é‡Œä¸€å…±æåˆ°äº†å¦‚ä¸‹çš„å®šä¹‰ï¼š\nä¸»ä½“ èº«ä»½ èº«ä»½è¯æ˜æ–‡ä»¶ é¢å‘æœºæ„ ä¿¡ä»»åŸŸ ä¿¡ä»»è”ç›Ÿ æ•°å­—ä¸–ç•Œçš„èº«ä»½ æ•°å­—ä¸–ç•Œçš„èº«ä»½ä¹Ÿæœ‰ä¸ç°å®ä¸–ç•Œç±»ä¼¼çš„å®šä¹‰ã€‚\næ•°å­—èº«ä»½è¯æ˜æ˜¯æ•°å­—ä¸–ç•Œçš„ä¸»ä½“çš„èº«ä»½è¯æ˜æ–‡ä»¶ï¼Œå¸¸è§çš„æœ‰ï¼šX.509 è¯ä¹¦ã€ç­¾åçš„ JWT å’Œ Kerberos ä»¤ç‰Œç­‰ã€‚æ•°å­—èº«ä»½è¯æ˜å¯ä»¥ä½¿ç”¨å¯†ç æŠ€æœ¯è¿›è¡ŒéªŒè¯ã€‚è®¡ç®—ç³»ç»Ÿå¯ä»¥ä½¿ç”¨æ•°å­—èº«ä»½è¯æ˜é€šè¿‡éªŒè¯ï¼Œå°±åƒäººä½¿ç”¨èº«ä»½è¯å’ŒæŠ¤ç…§ä¸€æ ·ã€‚\nä¸ºå®ç°è¿™äº›æœ‰ä¸€ä¸ªéå¸¸æµè¡Œçš„æŠ€æœ¯ Public Key Infrastructure (PKI) ï¼Œå…¶å®šä¹‰äº†ä¸€ç³»åˆ—çš„ä¸ºåˆ›å»ºã€ç®¡ç†ã€åˆ†å‘ã€ä½¿ç”¨ã€å­˜å‚¨ã€æ’¤é”€æ•°å­—è¯ä¹¦å’Œç®¡ç†å…¬é’¥åŠ å¯†æ‰€éœ€è¦çš„è§’è‰²ã€ç­–ç•¥ã€ç¡¬ä»¶ã€è½¯ä»¶å’Œæµç¨‹ã€‚\næ¥ä¸‹æ¥ç®€å•ä»‹ç»ä¸‹ X.509ï¼Œæœ‰ç»éªŒçš„åŒå­¦å¯ä»¥ç›´æ¥è·³è¿‡ã€‚\nX.509 æ¦‚è¿° 1988 å¹´ X.509 ä½œä¸º PKI çš„æ ‡å‡†é¦–æ¬¡å‘å¸ƒï¼ŒX.509 å‡è®¾æœ‰ä¸€å¥—ä¸¥æ ¼çš„å±‚æ¬¡åŒ–çš„è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼ŒCertificate Authorityï¼‰ã€‚ç”³è¯·è€…è¦æä¾›è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼ŒCertificate Signing Requestã€‚ç”³è¯·è€…é€šè¿‡è‡ªå·±çš„ç§é’¥ç­¾ååˆ›å»ºçš„ï¼Œé‡Œé¢åŒ…å«äº†ç”³è¯·è€…çš„èº«ä»½ä¿¡æ¯ï¼Œè¿›è¡Œç”¨äºéªŒçœŸçš„å…¬é’¥ã€è¯·æ±‚è¯ä¹¦çš„åç§°ã€ä»¥åŠ CA å¯èƒ½è¦æ±‚çš„å…¶ä»–èº«ä»½ä¿¡æ¯ç­‰ï¼‰ã€‚ç„¶å CA å¯¹è¯¥ CSR è¿›è¡Œç­¾åè½¬æ¢æˆåˆæ ¼çš„è¯ä¹¦å‘å›ç”³è¯·æ–¹ã€‚\nCA å°†å—ä¿¡ä»»çš„æ ¹è¯ä¹¦ï¼ˆåŒ…å«äº†å…¬é’¥ï¼‰å‘ç»™æ‰€æœ‰æˆå‘˜ï¼Œæˆå‘˜ä½¿ç”¨æ ¹è¯ä¹¦ä¸­çš„å…¬é’¥å¯¹å…¶ä»–æˆå‘˜çš„è¯ä¹¦ï¼ˆæ•°å­—èº«ä»½è¯æ˜ï¼‰è¿›è¡ŒæŸ¥éªŒã€‚\nè¯ä¹¦çš„ç”Ÿå‘½å‘¨æœŸ å‰é¢è®²äº†è¯ä¹¦çš„é¢å‘æµç¨‹ï¼Œæ¯ä¸ªè¯ä¹¦åœ¨åˆ›å»ºçš„æ—¶å€™éƒ½ä¼šè®¾ç½®æœ‰æ•ˆæˆªæ­¢æ—¥æœŸï¼Œå¦‚æœè¿‡æœŸè¯ä¹¦å°±æ— æ•ˆäº†ã€‚\nè¯ä¹¦åœ¨è¿‡æœŸä¹‹å‰ï¼Œå¦‚æœç”³è¯·æ–¹å‡ºäº†é—®é¢˜ï¼Œè¯ä¹¦å˜æˆä¸å¯ä¿¡ä¼šè¢« CA åŠé”€ã€‚å°±åƒç”¨æˆ·åå¯†ç ä¸€æ ·ï¼Œæœ‰æ•ˆæ—¥æœŸè¶Šé•¿å‡ºé—®é¢˜çš„å‡ ç‡å°±è¶Šå¤§ã€‚å› æ­¤ä¸€ä¸ªæœ‰æ•ˆçš„åŠæ³•å°±æ˜¯ åœ¨æˆæœ¬å¯æ§çš„æƒ…å†µä¸‹ï¼Œå°½å¯èƒ½ç¼©çŸ­è¯ä¹¦çš„æœ‰æ•ˆæœŸã€‚ ç„¶åé€šè¿‡æ›´æ–°æ“ä½œï¼Œå‘æ”¾æ–°çš„è¯ä¹¦ã€‚\næ•°å­—èº«ä»½çš„ä½¿ç”¨ è®¤è¯ï¼šæœåŠ¡é€šè¿‡ X.509 è¯ä¹¦æˆ–è€… JWT å‘å…¶ä»–æœåŠ¡æä¾›èº«ä»½ä¿¡æ¯ã€‚ ä¿å¯†æ€§å’Œå®Œæ•´æ€§ï¼šä¿å¯†æ€§æ˜¯æŒ‡æ”»å‡»è€…æ— æ³•è·å–æ¶ˆæ¯çš„å†…å®¹ï¼›å®Œæ•´æ€§æŒ‡æ¶ˆæ¯ä¼ è¾“çš„è¿‡ç¨‹ä¸­æ— æ³•è¢«æ›´æ”¹ã€‚TLS æ˜¯å¹¿æ³›ä½¿ç”¨çš„åè®®ï¼Œç”¨æ¥é€šè¿‡è¯ä¹¦åœ¨ä¸å¯ä¿¡çš„ç½‘ç»œè¿æ¥ä¸Šæä¾›è®¤è¯ã€ä¿å¯†æ€§å’Œæ¶ˆæ¯å®Œæ•´æ€§ã€‚TLS çš„ç‰¹æ€§ä¹‹ä¸€æ˜¯å¯ä»¥ä½œä¸ºåŒå‘çš„ TLS è®¤è¯ï¼ˆmutual TLS authenticationï¼‰ã€‚ æˆæƒï¼šè®¤è¯å®Œæˆä¹‹åï¼Œä½¿ç”¨è®¤è¯è¿‡çš„æ•°å­—èº«ä»½åˆ¤æ–­æ˜¯å¦å¯ä»¥è®¿é—®æœåŠ¡ã€‚ å¯è§‚æµ‹æ€§ï¼šå”¯ä¸€çš„èº«ä»½å¯ä»¥å¸®åŠ©æå‡ç»„ç»‡å†…éƒ¨åŸºç¡€è®¾æ–½çš„å¯è§‚æµ‹æ€§ã€‚ è®¡é‡ï¼šæ¯”å¦‚å¾®æœåŠ¡æ¶æ„ä¸­å¸¸è§çš„é™æµï¼Œå¯ä»¥é€šè¿‡å”¯ä¸€èº«ä»½æ ‡è¯†æ¥ç®¡ç†è¯·æ±‚çš„é™é¢ã€‚ è¯´å®ŒåŸºç¡€çš„èº«ä»½ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ SPIFFE å’Œ SPIRE äº†ã€‚\nSPIFFE Secure Production Identity Framework for Everyone çš„ç¼©å†™ SPIFFEï¼Œæ˜¯ä¸€ä¸ªè½¯ä»¶èº«ä»½æ ‡è¯†çš„å¼€æºæ ‡å‡†ï¼ˆCNCF ä¸‹ï¼‰ï¼Œä¸ºäº†ä»¥ç»„ç»‡å’Œå¹³å°æ— å…³çš„æ–¹å¼å®ç°èº«ä»½æ ‡è¯†çš„äº’æ“ä½œæ€§ï¼ŒSPIFFE å®šä¹‰äº†ä»¥å…¨è‡ªåŠ¨æ–¹å¼è·å–å’ŒéªŒè¯åŠ å¯†èº«ä»½æ‰€éœ€çš„æ¥å£å’Œæ–‡æ¡£ã€‚ä¸ºæ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„é€šç”¨èº«ä»½çš„æ§åˆ¶å¹³é¢æä¾›äº†æ ‡å‡†çš„æ”¯æ’‘ã€‚è¿™ä¸ªæ§åˆ¶å¹³é¢å°±æ˜¯æˆ‘ä»¬æ–‡ç« å¼€å¤´æåˆ°çš„â€œåŸºç¡€è®¾æ–½â€ã€‚ä½œä¸ºåŸºç¡€è®¾æ–½ï¼Œéœ€è¦æ˜¯è¯­è¨€ã€æŠ€æœ¯æ ˆæ— å…³çš„ï¼Œå¹¶å¯ä»¥åšåˆ°å…¨è‡ªåŠ¨ã€‚\nSPIFFEï¼ˆé€‚ç”¨äºæ‰€æœ‰äººçš„å®‰å…¨ç”Ÿäº§èº«ä»½æ¡†æ¶ï¼‰ä»¥ç‰¹åˆ¶ X.509 è¯ä¹¦çš„å½¢å¼ä¸ºç°ä»£ç”Ÿäº§ç¯å¢ƒä¸­çš„æ¯ä¸ªå·¥ä½œè´Ÿè½½æä¾›å®‰å…¨èº«ä»½ã€‚SPIFFE æ¶ˆé™¤äº†å¯¹åº”ç”¨ç¨‹åºçº§èº«ä»½éªŒè¯å’Œå¤æ‚ç½‘ç»œçº§ ACL é…ç½®çš„éœ€æ±‚ã€‚\nå®æ–½ SPIFFE æœ‰ç€é‡è¦çš„å‰æï¼Œå‡è®¾é›¶ä¿¡ä»»ç½‘ç»œå®‰å…¨æ¨¡å‹ä¸­ï¼š\nç½‘ç»œé€šä¿¡æ˜¯ä¸å¯ä¿¡çš„ï¼Œå¯èƒ½è¢«æ”»ç ´ è¿è¡Œ SPIFFE å®ç°çš„ç»„ä»¶çš„ç¡¬ä»¶åŠå…¶è¿ç»´äººå‘˜æ˜¯å¯é çš„ æ¦‚å¿µ SPIFFE æ¡†æ¶åŒ…å«äº†å¦‚ä¸‹å‡ éƒ¨åˆ†ï¼š\nSPIFFE IDï¼š SVIDï¼ˆSPIFFE Veriï¬able Identity Documentï¼‰ Workload API Trust Bundle SPIFFE è”ç›Ÿ SPIFFE ID SPIFFE ID ä½¿ç”¨ URIï¼ˆç»Ÿä¸€èµ„æºæ ‡å¿—ç¬¦ï¼‰æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œè½¯ä»¶æœåŠ¡çš„å”¯ä¸€èº«ä»½æ ‡è¯†ã€‚ç”±å¤šä¸ªéƒ¨åˆ†ç»„æˆï¼š\nå‰ç¼€ spiffe:// ä¿¡ä»»åŸŸçš„åå­—ï¼Œæ¯”å¦‚ example.comï¼Œè¿˜å¯ä»¥é€šè¿‡å¤šçº§åŸŸåæ¥è¡¨ç¤ºç¯å¢ƒã€é›†ç¾¤ç­‰ä¿¡æ¯ stagging.example.comã€k8s-cluster.example.com å·¥ä½œè´Ÿè½½çš„åå­—æˆ–è€…èº«ä»½æ ‡è¯†ï¼Œæ¯”å¦‚ /payment/mysqlã€/payment/web-feã€`/9eebccd2-12bf-40a6-b262-65fe0487d4 æ¯”å¦‚ spiffe://example.com/bizops/hr/taxrun/withholding\nSVID SVID æ˜¯å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡èº«ä»½æ ‡è¯†åŠ å¯†çš„ã€å¯éªŒè¯çš„è¯æ˜æ–‡ä»¶ã€‚SVID ç”±æœºæ„ç­¾å‘ï¼ŒåŒ…å«äº†å•ä¸€ SPIFFE IDï¼Œä»¥åŠæœåŠ¡å±äºä¿¡ä»»åŸŸã€‚\nç›®å‰ SVID çš„æ ¼å¼æœ‰ä¸¤ç§ï¼šX.509 å’Œ JWTã€‚\nX.509 SVID SPIFFE ID ä½äºæ‰©å±•å­—æ®µ SANï¼ˆSubject Alternative Nameï¼‰ä¸­ã€‚ä½œä¸º SVIDï¼ŒSAN ä¸­åªèƒ½æœ‰ä¸€ä¸ªå€¼ï¼ˆå…¶ä»–åœºæ™¯ä¸­ï¼ŒSAN ä¸­å¯ä»¥æœ‰å¤šä¸ªå€¼ï¼‰ã€‚\nå»ºè®®å°½å¯èƒ½ä½¿ç”¨ X.509 SVID è€Œä¸æ˜¯ JWT-SVIDï¼Œå› ä¸ºå®‰å…¨æ€§æ›´é«˜ï¼Œå°¤å…¶æ˜¯ä¸ TLS ç»“åˆä½¿ç”¨ã€‚\nJWT-SVID JWT-SVID å°† SPIFFE ID ç¼–ç åœ¨ æ ‡å‡†çš„ JWT) ä¸­ã€‚åœ¨åº”ç”¨å±‚ï¼ŒJWT-SVID è¢«ç”¨ä½œ bearer ä»¤ç‰Œå‘å¯¹ç«¯æä¾›èº«ä»½æ ‡è¯†ã€‚\nä¸ X.509 SVID ä¸åŒï¼ŒJWT-SVID å­˜åœ¨ é‡æ”¾æ”»å‡» çš„é£é™©ï¼Œä»¤ç‰Œä¼šè¢«æœªç»æˆæƒçš„ä¸€æ–¹è·å–å¹¶å†’ç”¨ã€‚\nSPIFFE å®šä¹‰äº†ä¸‰ç§æœºåˆ¶æ¥é¿å…è¿™ç§é£é™©ï¼š\nJWT-SVID å¿…é¡»é€šè¿‡å®‰å…¨é€šé“ä¼ è¾“ aud å£°æ˜å¿…é¡»ä¸ä»¤ç‰Œé’ˆå¯¹æ–¹çš„ä¸¥æ ¼å­—ç¬¦ä¸²åŒ¹é… æ‰€æœ‰çš„ JWT-SVID å¿…é¡»åŒ…å«æœ‰æ•ˆæœŸ Workload API Workload API æ˜¯ä¸€ä¸ªæœ¬åœ°çš„ã€éè”ç½‘çš„ APIï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ª API æ— éœ€è®¤è¯ã€‚å·¥ä½œè´Ÿè½½æ— éœ€è°ƒç”¨ API æ—¶æ— éœ€æä¾›ä»»ä½•ä¿¡æ¯ï¼Œå°±åƒåœ¨æ“ä½œç³»ç»Ÿä¸­æ‰§è¡Œ whoami æ“ä½œç³»ç»Ÿä¼šè¿”å›ç”¨æˆ·åä¸€æ ·ï¼Œä½† workload API ä¼šè¿”å›æ›´å¤šçš„ä¿¡æ¯ã€‚å·¥ä½œè´Ÿè½½å¯ä»¥è®¿é—®å…¶è·å–å½“å‰çš„èº«ä»½è¯æ˜æ–‡ä»¶ã€ä¿¡ä»»åŒ…åŠå…¶ä»–ç›¸å…³ä¿¡æ¯ã€‚\nSPIFFE çš„å®ç°å¯ä»¥é€šè¿‡åˆ›é€ æ€§çš„æ–¹æ¡ˆï¼ˆæ¯”å¦‚æ“ä½œç³»ç»Ÿæä¾›çš„ç‰¹æ€§ï¼‰æ¥å¯¹è°ƒç”¨æ–¹ï¼ˆå·¥ä½œè´Ÿè½½ï¼‰è¿›è¡Œè¾¨è®¤ã€‚\nWorkload API ä½œä¸º gRPC æœåŠ¡å™¨æš´éœ²æä¾›æœåŠ¡ï¼Œå¹¶ä½¿ç”¨åŒå‘æµï¼ŒæœåŠ¡å™¨ç«¯çš„æ›´æ–°å¯ä»¥æ¨é€ç»™å·¥ä½œè´Ÿè½½ã€‚\nTrust Bundle SPIFFE ä¿¡ä»»åŒ…ï¼Œæ˜¯åŒ…å«äº†ä¿¡ä»»åŸŸå…¬é’¥çš„æ–‡ä»¶ã€‚æ¯ç§ç±»å‹çš„ SVID åœ¨ä¿¡ä»»åŒ…éƒ½æœ‰å…¶ç‰¹æœ‰çš„æ–¹å¼ï¼Œæ¯”å¦‚ X.509 SVID ä¸­ CA è¯ä¹¦ä¸­åŒ…å«äº†å…¬é’¥ã€‚\nä¿¡ä»»åŒ…ä¸­ä¸ä¼šåŒ…å«é™¤å…¬é’¥ä»¥å¤–çš„å…¶ä»–æ•æ„Ÿå†…å®¹ï¼Œå¯ä»¥è¢«éšæ„ä¼ æ’­ã€‚\nSPIFFE è”ç›Ÿ SPIFFE è”ç›Ÿæœ‰ç‚¹ç±»ä¼¼å‰é¢è®²çš„æŠ¤ç…§å¯ä»¥åœ¨å…¶ä»–å›½å®¶æ¥è¯†åˆ«èº«ä»½ã€‚\nSPIFFE è”ç›Ÿæ˜¯ä¸€ç§å¯ä»¥å…±äº« SPIFFE ä¿¡ä»»åŒ…çš„ç®€å•æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬å¸Œæœ›å…è®¸ä¸åŒä¿¡ä»»åŸŸä¸­çš„æœåŠ¡å¯ä»¥å®‰å…¨åœ°è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚é€šä¿¡çš„åŒæ–¹æ£€æŸ¥å¯¹æ–¹æä¾›æä¾›çš„ä¿¡ä»»åŒ…ï¼Œæ¥å†³å®šæ˜¯å¦è¿›è¡Œé€šä¿¡ã€‚è¿™æ˜¯åŸºäºåŒæ–¹å¯ä»¥äº’ç›¸æš´éœ²æˆ–è€…å…±äº«ä¿¡ä»»åŒ…ï¼Œè¿™ç§æœºåˆ¶è¢«ç§°ä¸ºåŒ…ç«¯ç‚¹ï¼ˆbundle endpointï¼‰ã€‚\nåŒ…ç«¯ç‚¹æ˜¯ä¸ªç®€å•çš„ã€ç”± TLS ä¿æŠ¤çš„ HTTP æœåŠ¡ã€‚SPIFFE çš„å®ç°é€šè¿‡æš´éœ²è¯¥ç«¯ç‚¹ï¼Œä½¿å¾—åŒ…çš„å†…å®¹å¯ä»¥è¢«è·å–åˆ°ã€‚\nSPIRE SPIRE æ˜¯ SPIFFE è¿è¡Œæ—¶ç¯å¢ƒï¼ˆSPIFFE Runtime Environmentï¼‰çš„é¦–å­—æ¯ï¼Œæ˜¯ä¸€ä¸ªç”Ÿäº§å°±ç»ªã€å¼€æºçš„ï¼ˆåŒåœ¨ CNCF ä¸‹ï¼‰ SPIFFE å®ç°ã€‚SPIRE å®ç°äº† SPIFFE äº”ä¸ªå®šä¹‰ã€‚\nSPIRE åŒ…å«äº†ä¸¤ä¸ªä¸»è¦ç»„ä»¶ï¼šæœåŠ¡ç«¯å’Œä»£ç†ã€‚æœåŠ¡ç«¯è´Ÿè´£éªŒè¯ä»£ç†å’Œç”Ÿæˆ SVIDï¼Œè€Œä»£ç†è´Ÿè´£æä¾› workload APIï¼Œå¹¶ä¸æœåŠ¡ç«¯è¿›è¡Œé€šä¿¡ã€‚\nè¿™ä¸¤ä¸ªç»„ä»¶çš„è®¾è®¡éƒ½æ”¯æŒæ’ä»¶ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰©å±•æ”¯æŒä¸åŒçš„é…ç½®å’Œå¹³å°ã€‚\nSPIRE æ¶æ„ æœåŠ¡ç«¯ SPIRE æœåŠ¡ç«¯ç®¡ç†å’Œé¢å‘ SPIFFE ä¿¡ä»»åŸŸä¸­çš„æ‰€æœ‰èº«ä»½æ ‡è¯†ï¼Œä½¿ç”¨æ•°æ®åº“ï¼ˆSQLiteï¼‰æ¥ä¿å­˜ä»£ç†å’Œå·¥ä½œè´Ÿè½½çš„ä¿¡æ¯ã€‚\næœåŠ¡ç«¯é€šè¿‡ä½¿ç”¨æ³¨å†Œæ¡ç›®æ¥è·çŸ¥å…¶ç®¡ç†çš„å·¥ä½œè´Ÿè½½ï¼Œæ³¨å†Œæ¡ç›®æ˜¯ä¸ºèŠ‚ç‚¹å’Œå·¥ä½œè´Ÿè½½åˆ†é… SPIFFE ID çš„çµæ´»è§„åˆ™ã€‚\næœåŠ¡ç«¯æä¾›äº† API å’Œ CLI ä¸¤ç§è®¿é—®æ–¹å¼ã€‚\næœåŠ¡ç«¯ä¸ºå·¥ä½œè´Ÿè½½ç­¾å‘ SVID æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å…¶ç”Ÿæˆçš„è‡ªç­¾å‘è¯ä¹¦ï¼ˆé»˜è®¤ï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸Šæ¸¸è¯ä¹¦é¢å‘æœºæ„æ’ä»¶æ¥é…ç½®ä½¿ç”¨ä¸Šæ¸¸è¯ä¹¦é¢å‘æœºæ„ï¼Œæ¥å®Œæˆè¯ä¹¦çš„ç­¾å‘ã€‚\nä»£ç† ä»£ç†åªæœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„åŠŸèƒ½ï¼šæä¾› workload APIã€‚ä¸ºäº†æä¾›è¿™ä¸ª APIï¼Œè¿˜è¦æ”¯æŒå·¥ä½œè´Ÿè½½èº«ä»½æ ‡è¯†çš„ç¡®å®šã€è°ƒç”¨å¹¶å°†è‡ªèº«å®‰å…¨åœ°æ¥å…¥ SPIRE æœåŠ¡ç«¯ã€‚\nSPIRE ä»£ç†ä¼šä» SPIRE æœåŠ¡ç«¯æ¥æ”¶ æœ¬åœ°ä¿¡ä»»åŸŸ ä»¥åŠ ä¼šç›´æ¥è°ƒç”¨å®ƒï¼ˆSIRE ä»£ç†ï¼‰çš„å·¥ä½œè´Ÿè½½ çš„ä¿¡æ¯ã€‚\nå½“åœ¨æŒ‡å®šä¿¡ä»»åŸŸå¢åŠ æ–°çš„å·¥ä½œè´Ÿè½½æ—¶ï¼Œä¼šåœ¨ SPIRE æœåŠ¡ç«¯åˆ›å»ºå’Œæ›´æ–°è®°å½•ï¼Œè¯¥å·¥ä½œè´Ÿè½½çš„ä¿¡æ¯ä¼šè‡ªåŠ¨åœ°ä¼ æ’­åˆ°æ­£ç¡®çš„ä»£ç†ã€‚\næ’ä»¶æ¶æ„ å‰é¢æåˆ°æœåŠ¡ç«¯å’Œä»£ç†éƒ½æ”¯æŒæ’ä»¶ï¼Œé€šè¿‡æ’ä»¶æ¥æ‰©å±•é€‚åº”æ–°çš„ èŠ‚ç‚¹è¯æ˜è€…ã€å·¥ä½œ è´Ÿè½½è¯æ˜è€…ï¼Œä»¥åŠä¸Šæ¸¸æœºæ„ã€‚\nSIVD ç®¡ç† èŠ‚ç‚¹è¯æ˜è¿‡ç¨‹ä¸­ä¼šä¸º SPIRE ä»£ç†ç”³è¯·åˆ°èº«ä»½æ ‡è¯†ï¼Œä»£ç†ä½¿ç”¨è¯¥æ ‡è¯†æ¥å®Œæˆ SPIRE æœåŠ¡ç«¯çš„è®¤è¯ã€‚é€šè¿‡è®¤è¯æ—¶å€™ï¼Œä»æœåŠ¡ç«¯è·å–è¢«æˆæƒç®¡ç†çš„æ‰€æœ‰å·¥ä½œè´Ÿè½½çš„ SVIDï¼ˆä¿å­˜åœ¨å†…å­˜ä¸­ï¼‰ã€‚\nè¯æ˜ è¯æ˜æ˜¯ä½¿ç”¨å¯ç”¨ä¿¡æ¯ä½œä¸ºè¯æ®ç¡®è®¤å·¥ä½œè´Ÿè½½èº«ä»½çš„è¿‡ç¨‹ã€‚åœ¨ SPIRE ä¸­æœ‰ä¸¤ç§è¯æ˜æ–¹å¼ï¼šèŠ‚ç‚¹è¯æ˜å’Œå·¥ä½œè´Ÿè½½è¯æ˜ã€‚\nèŠ‚ç‚¹è¯æ˜æ˜¯æ–­è¨€æè¿°èŠ‚ç‚¹å±æ€§ï¼ˆæ¯”å¦‚ AWS è‡ªåŠ¨æ‰©å±•ç»„çš„æˆå‘˜ï¼‰ï¼›å·¥ä½œè´Ÿè½½è¯æ˜æ˜¯æ–­è¨€æè¿°å·¥ä½œè´Ÿè½½çš„å±æ€§ï¼ˆæ¯”å¦‚ä½¿ç”¨çš„ Kubernetes Service Accountï¼Œæˆ–è€…äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„ï¼‰ã€‚\nè¿™äº›å±æ€§åœ¨ SPIRE ä¸­ç»Ÿç»Ÿç§°ä¸ºé€‰æ‹©å™¨ï¼ˆselectorï¼‰ã€‚SPIRE æä¾›äº†å¤§é‡çš„å¼€ç®±å³ç”¨çš„é€‰æ‹©å™¨ï¼Œæ¯”å¦‚æ”¯æŒé€»è¾‘ã€Kubernetesã€AWSã€GCPã€AZure ç­‰ç­‰çš„èŠ‚ç‚¹é€‰æ‹©å™¨ï¼›æ”¯æŒ Dockerã€Kubernetesã€Unix ç­‰çš„å·¥ä½œè´Ÿè½½é€‰æ‹©å™¨ã€‚\nSPIRE çš„æ’ä»¶æ¶æ„è®¾è®¡ï¼Œä¹Ÿæ”¯æŒæ›´å¤šé€‰æ‹©å™¨çš„æ‰©å±•ã€‚\nèŠ‚ç‚¹è¯æ˜ èŠ‚ç‚¹è¯æ˜å‘ç”Ÿåœ¨ä»£ç†ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œä»£ç†ä¸æœåŠ¡ç«¯é€šä¿¡è¿›è¡Œä¿¡æ¯äº¤æ¢ã€‚ä»£ç†å°†é€šè¿‡æ’ä»¶é‡‡é›†çš„ä¿¡æ¯ä¸ŠæŠ¥åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡å™¨ç«¯ä½¿ç”¨å¯¹ç­‰çš„æ’ä»¶è¿›è¡Œä¿¡æ¯çš„ç¡®è®¤ã€‚èŠ‚ç‚¹è¯æ˜æˆåŠŸåï¼ŒèŠ‚ç‚¹ä¼šæ‹¿åˆ°èº«ä»½è¯æ˜ï¼Œå¹¶ä½¿ç”¨èº«ä»½è¯æ˜ä¸æœåŠ¡ç«¯è¿›è¡Œåç»­çš„é€šä¿¡ã€‚\nå·¥ä½œè´Ÿè½½è¯æ˜ å·¥ä½œè´Ÿè½½è¯æ˜å‘ç”Ÿåœ¨å·¥ä½œè´Ÿè½½ä¸ SPIRE ä»£ç†çš„ workload API å»ºç«‹è¿æ¥æ—¶ã€‚è¯æ˜çš„è¿‡ç¨‹å®Œå…¨ç”± SPIRE ä»£ç†å®Œæˆï¼Œä»£ç†åˆ©ç”¨æ“ä½œç³»ç»Ÿç‰¹æ€§æ¥ç¡®è®¤æ˜¯å“ªä¸ªè¿›ç¨‹åˆ›å»ºçš„è¿æ¥ã€‚\næ¯”å¦‚åœ¨ Linux ä¸‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥è·å–è°ƒç”¨ socket çš„å¯¹ç«¯è¿›ç¨‹ IDã€ç”¨æˆ·æ ‡è¯†å’Œå…¨å±€å”¯ä¸€æ ‡è¯†ã€‚ä¸åŒæ“ä½œç³»ç»Ÿçš„å†…æ ¸å…ƒæ•°æ®ä¸åŒï¼Œæ‹¿åˆ°å·¥ä½œè´Ÿè½½çš„ ID ä¹‹åï¼Œä»£ç†å°† ID æä¾›ç»™å„ä¸ªæ’ä»¶ï¼Œä»é€‰æ‹©å™¨ä¸­è·å–è°ƒç”¨è€…çš„ä¿¡æ¯ã€‚\næ¯ä¸ªæ’ä»¶éƒ½ä¼šå¯¹è°ƒç”¨è€…è¿›è¡Œæ£€æŸ¥ã€‚æ¯”å¦‚ä¸€ä¸ªæ’ä»¶ä»ç³»ç»Ÿå†…æ ¸ä¸­è·ä¿¡æ¯ï¼Œç”Ÿæˆå–ç”¨æˆ·ã€ç»„ç­‰é€‰æ‹©å™¨ï¼›ä¸€ä¸ªæ’ä»¶åˆ™ä¼šä¸ Kubernetes äº¤äº’ï¼Œç”Ÿæˆå‘½åç©ºé—´ã€service account ç­‰é€‰æ‹©å™¨ï¼›å¦ä¸€ä¸ªä¸ Docker daemon è¿›è¡Œäº¤äº’ï¼Œç”Ÿæˆ Docker é•œåƒ IDã€æ ‡ç­¾å’Œå®¹å™¨ç¯å¢ƒå˜é‡çš„é€‰æ‹©å™¨ã€‚\næ³¨å†Œæ¡ç›® SPIRE é€šè¿‡æ³¨å†Œæ¡ç›®è·çŸ¥å·¥ä½œè´Ÿè½½çš„å„ç§ä¿¡æ¯ï¼Œæ¯”å¦‚å·¥ä½œè´Ÿè½½æ˜¯å¦åº”è¯¥æˆ–å…è®¸å‡ºç°åœ¨ç¯å¢ƒä¸­ã€åº”è¯¥è¿è¡Œçš„ä½ç½®ã€SPIFFE ID å’Œå…¶ä»–ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯æ˜¯é€šè¿‡ SPIRE API åˆ›å»ºå’Œç®¡ç†çš„ã€‚\næ¯ä¸ªæ³¨å†Œæ¡ç›®åŒ…å«äº† 3 ä¸ªæ ¸å¿ƒå±æ€§ï¼š\nParent IDï¼šå‘Šè¯‰ SPIRE å·¥ä½œè´Ÿè½½è¿è¡Œåœ¨å“ªé‡Œï¼Œè¿›ä¸€æ­¥æ„ŸçŸ¥å“ªäº›ä»£ç†æœ‰æƒè·å–å…¶ SVIDã€‚ SPIFFE IDï¼šå·¥ä½œè´Ÿè½½å¯ä»¥ä½¿ç”¨çš„ SPIFFE ID å¯ä»¥ç”¨æ¥è¾¨è¯†å·¥ä½œè´Ÿè½½çš„ä¿¡æ¯ï¼šä¹Ÿå°±æ˜¯é€‰æ‹©å™¨ä»è¯æ˜ä¸­è·å–åˆ°çš„ æ³¨å†Œæ¡ç›®å¯ä»¥æè¿°ä¸€ç»„èŠ‚ç‚¹æˆ–è€…ä¸€ä¸ªå·¥ä½œè´Ÿè½½ï¼Œé€šå¸¸åè€…é€šè¿‡ Parent ID æ¥å¼•ç”¨åè€…ã€‚\nèŠ‚ç‚¹æ¡ç›® æè¿°ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…ä¸€ç»„èŠ‚ç‚¹çš„æ³¨å†Œæ¡ç›®ä½¿ç”¨èŠ‚ç‚¹è¯æ˜ç”Ÿæˆçš„é€‰æ‹©å™¨æ¥åˆ†é… SPIFFE IDï¼Œåœ¨æ³¨å†Œå·¥ä½œè´Ÿè½½æ—¶å¯ä»¥å¼•ç”¨è¯¥ IDã€‚\nä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æ¡ç›®çš„é€‰æ‹©å™¨è¯æ˜ï¼Œå› æ­¤å¯ä»¥å­˜åœ¨äºå¤šä¸ªç»„ä¸­ã€‚\nSPIRE æœåŠ¡ç«¯ä¸€æ¬¡å¯ä»¥åŠ è½½å¤šä¸ªèŠ‚ç‚¹è¯æ˜å™¨ï¼Œè€Œä»£ç†ä¸€æ¬¡åªèƒ½åŠ è½½ä¸€ä¸ªã€‚\næ³¨å†Œæ¡ç›®çš„ Pareent ID æŒ‡å‘çš„æ˜¯ SPIRE æœåŠ¡ç«¯çš„ SPIFFE IDã€‚\nå·¥ä½œè´Ÿè½½æ¡ç›® å·¥ä½œè´Ÿè½½æ¡ç›®çš„ Parent ID æ˜¯èŠ‚ç‚¹ï¼ˆä¸€ä¸ªæˆ–è€…ä¸€ç»„ï¼‰çš„ SPIFFE IDã€‚ è¡¨ç¤ºå…¶å¯ä»¥è¿è¡Œåœ¨å“ªä¸ªæˆ–å“ªç»„èŠ‚ç‚¹ä¸Šã€‚è¯¥èŠ‚ç‚¹ä¸Šçš„ SPIRE ä»£ç†æ”¶åˆ°è¯¥å·¥ä½œè´Ÿè½½çš„æ¡ç›®ï¼ŒåŒ…å«äº†åœ¨é¢å‘ SIVD ä¹‹å‰å¿…é¡»è¦è¯æ˜çš„é€‰æ‹©å™¨ã€‚\nä¸èŠ‚ç‚¹è¯æ˜è¿‡ç¨‹ä¸åŒï¼ŒSPIRE ä»£ç†ä¸€æ¬¡å¯ä»¥åŠ è½½å¤šä¸ªå·¥ä½œè´Ÿè½½è¯æ˜å™¨æ’ä»¶ã€‚\nSPIFFE/SPIRE åº”ç”¨æ¦‚å¿µå¨èƒæ¨¡å‹ å®‰å…¨è¾¹ç•Œ å®‰å…¨è¾¹ç•Œé€šä¿—åœ°è®²ï¼Œå°±æ˜¯ä»ä¸å®‰å…¨çš„ä¸€æ–¹åˆ°å®‰å…¨çš„ä¸€æ–¹ï¼Œå¹¶ä¸”éƒ½æœ‰å…¶å„è‡ªçš„è¯æ˜æ–¹å¼ã€‚\nSPIFFE/SPIRE ä¸­å®šä¹‰äº† 3 ä¸ªå®‰å…¨è¾¹ç•Œï¼šå·¥ä½œè´Ÿè½½ä¸ä»£ç†ä¹‹é—´ã€ä»£ç†ä¸æœåŠ¡ç«¯ä¹‹é—´ã€ä¸åŒä¿¡ä»»åŸŸçš„æœåŠ¡ç«¯ä¹‹é—´ã€‚\nå·¥ä½œè´Ÿè½½å’Œå…¶ä»–ä¿¡ä»»åŸŸä¸­çš„æœåŠ¡ç«¯æ˜¯å®Œå…¨ä¸å¯ä¿¡çš„ï¼Œç½‘ç»œé€šä¿¡ä¹Ÿæ˜¯å®Œå…¨ä¸å¯ä¿¡çš„ã€‚\nå·¥ä½œè´Ÿè½½ä¸ä»£ç†çš„å®‰å…¨è¾¹ç•Œ ä»£ç†ä¸ä¼šä¿¡ä»»å·¥ä½œè´Ÿè½½çš„ä»»ä½•è¾“å…¥ï¼Œä»£ç†å¯¹å·¥ä½œè´Ÿè½½çš„æ£€æŸ¥éƒ½æ˜¯é€šè¿‡å¤–éƒ¨æ£€æŸ¥å®Œæˆçš„ã€‚æ¢å¥è¯è¯´ï¼Œæ‰€æœ‰å€¼å¯ä»¥è¢«å·¥ä½œè´Ÿè½½ä¿®æ”¹çš„é€‰æ‹©å™¨ï¼Œä¹Ÿæ˜¯ä¸å®‰å…¨çš„ã€‚\nä»£ç†ä¸æœåŠ¡ç«¯çš„å®‰å…¨è¾¹ç•Œ ä»£ç†æ¯”å·¥ä½œè´Ÿè½½å®‰å…¨ä¸€äº›ï¼Œä½†æ˜¯å®‰å…¨æ€§ä¸å¦‚æœåŠ¡ç«¯ã€‚SPIRE çš„ä¸€ä¸ªæ˜ç¡®è®¾è®¡ç›®æ ‡æ˜¯å®ƒåº”è¯¥åœ¨èŠ‚ç‚¹è¢«æ”»ç ´åå­˜æ´»ã€‚\nä»£ç†è´Ÿè´£æ ¹æ®å·¥ä½œè´Ÿè½½çš„è¡Œä¸ºæ¥åˆ›å»ºå’Œç®¡ç†æ ‡è¯†ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¿…è¦é™åˆ¶ä»£ç†çš„èƒ½åŠ›åœ¨å…¶èŒè´£èŒƒå›´å†…ï¼ˆæœ€å°‘æƒé™åŸåˆ™ï¼‰ã€‚\nä»£ç†åœ¨è·å–æ ‡è¯†å‰ï¼Œå¿…é¡»èƒ½æœ‰è¯æ˜å…¶å¯¹æ³¨å†Œæ¡ç›®çš„æ‰€æœ‰æƒã€‚\nåœ¨èŠ‚ç‚¹å°šæœªè¯æ˜è‡ªå·±è·å¾—æ ‡è¯†ä¹‹å‰ï¼Œä¸æœåŠ¡ç«¯çš„é€šä¿¡ä½¿ç”¨å•å‘ TLSï¼›è·å¾—èº«ä»½æ ‡è¯†å’Œæœ‰æ•ˆçš„ SVID ä¹‹åï¼Œä½¿ç”¨åŒå‘çš„ TLSã€‚\næœåŠ¡ç«¯ä¹‹é—´çš„è¾¹ç•Œ SPIRE æœåŠ¡ç«¯ä»…è¢«ä¿¡ä»»åœ¨å…¶ç›´æ¥ç®¡ç†çš„ä¿¡ä»»åŸŸå†…ç”Ÿæˆ SVIDã€‚\nå„ç»„ä»¶è¢«æ”»ç ´çš„å½±å“ å‡å¦‚ä»£ç†è¢«æ”»ç ´ï¼Œä¼šå½±å“å…¶ç®¡ç†çš„å·¥ä½œè´Ÿè½½ã€‚å¦‚æœå·¥ä½œè´Ÿè½½è·Ÿä»£ç†æ˜¯ 1:1 éƒ¨ç½²æ—¶ï¼ˆå‚è€ƒ Kubernetes Pod ä¸­çš„å¤š sidecarï¼‰ï¼Œåªä¼šå½±å“ä¸€ä¸ªå·¥ä½œè´Ÿè½½ã€‚ä½†æ˜¯ä»£ç†ç®¡ç†å¤šä¸ªå·¥ä½œè´Ÿè½½æ—¶ï¼Œå½±å“èŒƒå›´å˜å¤§ï¼ˆå‚è€ƒ Kubernetes ä¸­çš„ Daemonsetï¼Œæ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªå‰¯æœ¬ï¼‰ã€‚\nSPIRE æœåŠ¡ç«¯æ˜¯æ•´ä¸ªç³»ç»Ÿä¸­æœ€ä¸ºæ•æ„Ÿçš„ç»„ä»¶ï¼Œå¦‚æœè¢«æ”»ç ´ä¼šå½±å“åˆ°æ•´ä¸ªä¿¡ä»»åŸŸï¼Œå¼ºçƒˆå»ºè®®å°†å…¶éƒ¨ç½²åˆ°ä¸è¦ç®¡ç†çš„å·¥ä½œè´Ÿè½½ä¸åŒçš„ç¡¬ä»¶ä¸Šã€‚\næ¦‚å¿µå¨èƒæ¨¡å‹ vs ä¼ ç»Ÿè¾¹ç•Œå®‰å…¨æ¨¡å‹ è¿™ä¸ªæ¦‚å¿µå¨èƒæ¨¡å‹ï¼Œå®é™…ä¸Šæ˜¯å°†ä¼ ç»Ÿå®‰å…¨è¾¹ç•Œæ¨¡å‹ç²’åº¦è¿›è¡Œç»†åŒ–ï¼Œå°†éš”ç¦»åŒºç¼©å°å¹¶è¿›è¡Œè‡ªæ²»ã€‚ç¼©å¾—è¶Šå°ï¼Œå®‰å…¨æ€§è¶Šé«˜ï¼Œç ´é˜²æ—¶å½±å“çš„èŒƒå›´è¶Šå°ã€‚\næ€»ç»“ æœ¬ç¯‡ä¸»è¦ä»‹ç»äº†é›¶ä¿¡ä»»å®‰å…¨æ¨¡å‹ä¸­èº«ä»½å®šä¹‰ï¼Œä»¥åŠé€šç”¨èº«ä»½éªŒè¯çš„æ ‡å‡†å’Œå®ç° SPIFFE/SPIREã€‚\nå›åˆ°å¼€å¤´ä¹¦çš„å‰¯æ ‡é¢˜ä¸­çš„å‡ ä¸ªå…³é”®è¯ï¼šé€šç”¨èº«ä»½ã€SPIFFE çš„æ–¹å¼ã€åŸºç¡€è®¾æ–½ã€å»ºç«‹ä¿¡ä»»ã€‚SPIFFE æä¾›äº†è¦†ç›–äº†èº«ä»½ã€èº«ä»½è¯ä¹¦çš„ç±»å‹ä»¥åŠåˆ›å»ºã€ç®¡ç†å’Œé¢å‘æ–¹å¼çš„å®šä¹‰ï¼Œè´¯å½»äº†é›¶ä¿¡ä»»çš„å®‰å…¨æ¨¡å‹ï¼Œä¸ºæ„å»ºåŸºç¡€è®¾æ–½æä¾›äº†æ ‡å‡†æ¡†æ¶ã€‚SPIRE åˆ™æä¾›äº†åŸºç¡€è®¾æ–½çš„å®ç°ï¼Œä½¿ç”¨æœåŠ¡ç«¯ + ä»£ç†çš„åˆ†çº§ç­–ç•¥é‡‡ç”¨æ¦‚å¿µå¨èƒæ¨¡å‹ï¼Œå°½å¯èƒ½åœ°æå‡å®‰å…¨æ€§å’Œé™ä½å¨èƒå¸¦æ¥çš„å½±å“ã€‚\næ ‡å‡†å’Œå®ç°éƒ½æœ‰äº†ï¼Œå®é™…ä¸Šè½åœ°å®æ–½ä¹Ÿæ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ã€‚ä¹¦ä¸­ä¹Ÿæä¾›äº†è½åœ°è®¡åˆ’çš„è®¾è®¡æ–¹æ¡ˆä»¥åŠåˆ†äº«è½åœ°çš„ç»éªŒï¼Œåç»­ä¼šç»§ç»­ä¸ºå¤§å®¶è§£è¯»ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/09/15/16632173289239.jpg","permalink":"https://atbug.com/what-is-spiffe-and-spire/","tags":["é›¶ä¿¡ä»»","å®‰å…¨","Kubernetes"],"title":"é›¶ä¿¡ä»»å®‰å…¨ï¼šSPIFFE å’Œ SPIRE é€šç”¨èº«ä»½éªŒè¯çš„æ ‡å‡†å’Œå®ç°"},{"categories":["ç¿»è¯‘"],"contents":"è¿™ç¯‡æ˜¯ Buoyant çš„åˆ›å§‹äºº William Morgan æ–‡ç« ã€ŠWhat Does Zero Trust Mean for Kubernetes?ã€‹ çš„ç¿»è¯‘ï¼Œæ–‡ç« å¾ˆå¥½çš„è§£é‡Šäº†ä»€ä¹ˆæ˜¯é›¶ä¿¡ä»»ã€ä¸ºä»€ä¹ˆè¦å®æ–½é›¶ä¿¡ä»»ï¼Œä»¥åŠæœåŠ¡ç½‘æ ¼å¦‚ä½•ä»¥æœ€å°çš„ä»£ç å®ç°é›¶ä¿¡ä»»ã€‚\né›¶ä¿¡ä»»æ˜¯è¥é”€ç‚’ä½œï¼Œè¿˜æ˜¯æ–°çš„æœºä¼šï¼Œå„ä½çœ‹å®˜ä½ æ€ä¹ˆçœ‹ï¼Ÿ\nè¦ç‚¹\né›¶ä¿¡ä»»æ˜¯ä¸€ç§è¢«å¤§é‡ç‚’ä½œçš„å®‰å…¨æ¨¡å‹ï¼Œä½†å°½ç®¡å­˜åœ¨è¥é”€å™ªéŸ³ï¼Œä½†å®ƒå¯¹äºå…·æœ‰å®‰å…¨æ„è¯†çš„ç»„ç»‡å…·æœ‰ä¸€äº›å…·ä½“è€Œç›´æ¥çš„ä»·å€¼ã€‚ é›¶ä¿¡ä»»çš„æ ¸å¿ƒæ˜¯ï¼Œå°†æˆæƒä»â€œåœ¨è¾¹ç•ŒéªŒè¯ä¸€æ¬¡â€è½¬å˜ä¸ºâ€œéšæ—¶éšåœ°éªŒè¯â€ã€‚ ä¸ºæ­¤ï¼Œé›¶ä¿¡ä»»è¦æ±‚æˆ‘ä»¬é‡æ–°æ€è€ƒèº«ä»½çš„æ¦‚å¿µï¼Œå¹¶æ‘†è„±åŸºäºä½ç½®çš„èº«ä»½ï¼Œä¾‹å¦‚ IP åœ°å€ã€‚ Kubernetes é‡‡ç”¨è€…åœ¨ç½‘ç»œå±‚å®ç°é›¶ä¿¡ä»»æ—¶å…·æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ï¼Œè¿™è¦å½’åŠŸäºåŸºäº Sidecar çš„æœåŠ¡ç½‘æ ¼ï¼Œå®ƒæä¾›æ— éœ€æ›´æ”¹åº”ç”¨ç¨‹åºå°±å¯å®ç°çš„æœ€ç»†ç²’åº¦çš„èº«ä»½éªŒè¯å’Œæˆæƒã€‚ è™½ç„¶æœåŠ¡ç½‘æ ¼å¯ä»¥æä¾›å¸®åŠ©ï¼Œä½† Kubernetes å®‰å…¨æ€§ä»ç„¶æ˜¯ä¸€ä¸ªå¤æ‚è€Œå¾®å¦™çš„è¯é¢˜ï¼Œéœ€è¦ä»å¤šä¸ªå±‚æ¬¡è¿›è¡Œäº†è§£ã€‚ é›¶ä¿¡ä»»æ˜¯ä¸€ç§ä½äºç°ä»£å®‰å…¨å®è·µå‰æ²¿çš„å¼ºå¤§çš„å®‰å…¨æ¨¡å‹ã€‚è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå®¹æ˜“å¼•èµ·è½°åŠ¨å’Œç‚’ä½œçš„æœ¯è¯­ï¼Œå› æ­¤å¾ˆéš¾æ¶ˆé™¤å™ªéŸ³ã€‚é‚£ä¹ˆï¼Œç©¶ç«Ÿä»€ä¹ˆæ˜¯é›¶ä¿¡ä»»ï¼Œå¯¹äº Kubernetesï¼Œå®ƒç©¶ç«Ÿæ„å‘³ç€ä»€ä¹ˆï¼Ÿåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»å·¥ç¨‹çš„è§’åº¦æ¢è®¨ä»€ä¹ˆæ˜¯é›¶ä¿¡ä»»ï¼Œå¹¶æ„å»ºä¸€ä¸ªåŸºæœ¬æ¡†æ¶æ¥ç†è§£å®ƒå¯¹ Kubernetes è¿ç»´å’Œå®‰å…¨å›¢é˜Ÿç­‰çš„å½±å“ã€‚\nä»‹ç» å¦‚æœä½ æ­£åœ¨æ„å»ºç°ä»£äº‘è½¯ä»¶ï¼Œæ— è®ºæ˜¯é‡‡ç”¨ Kubernetes è¿˜æ˜¯å…¶ä»–è½¯ä»¶ï¼Œå¯èƒ½éƒ½å¬è¯´è¿‡â€œé›¶ä¿¡ä»»â€ä¸€è¯ã€‚é›¶ä¿¡ä»»çš„å®‰å…¨æ¨¡å¼å˜å¾—å¦‚æ­¤é‡è¦ï¼Œä»¥è‡³äºç¾å›½è”é‚¦æ”¿åºœå·²ç»æ³¨æ„åˆ°ï¼šç™½å®«æœ€è¿‘å‘å¸ƒäº†ä¸€ä»½è”é‚¦é›¶ä¿¡ä»»æˆ˜ç•¥çš„å¤‡å¿˜å½•ï¼Œè¦æ±‚æ‰€æœ‰ç¾å›½è”é‚¦æœºæ„åœ¨å¹´åº•å‰æ»¡è¶³ç‰¹å®šçš„é›¶ä¿¡ä»»å®‰å…¨æ ‡å‡†ã€‚2024è´¢å¹´ï¼›å›½é˜²éƒ¨åˆ›å»ºäº†é›¶ä¿¡ä»»å‚è€ƒæ¶æ„ï¼›ç¾å›½å›½å®¶å®‰å…¨å±€å‘å¸ƒäº†ä¸€ä»½Kubernetes å¼ºåŒ–æŒ‡å—ï¼Œä¸“é—¨æè¿°äº† Kubernetes ä¸­é›¶ä¿¡ä»»å®‰å…¨çš„æœ€ä½³å®è·µã€‚\néšç€è¿™ç§å™ªéŸ³ï¼Œé›¶ä¿¡ä»»æ— ç–‘å¸å¼•äº†å¾ˆå¤šè¥é”€å…³æ³¨ã€‚ä½†å°½ç®¡æœ‰å™ªéŸ³ï¼Œé›¶ä¿¡ä»»ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç©ºæ´çš„æœ¯è¯­â€”â€”å®ƒä»£è¡¨äº†å¯¹æœªæ¥å®‰å…¨çš„ä¸€äº›æ·±åˆ»å’Œå˜é©æ€§çš„æƒ³æ³•ã€‚é‚£ä¹ˆå…·ä½“æ¥è¯´ï¼Œä»€ä¹ˆæ˜¯é›¶ä¿¡ä»»ï¼Œä¸ºä»€ä¹ˆå®ƒçªç„¶å˜å¾—å¦‚æ­¤é‡è¦ï¼Ÿé›¶ä¿¡ä»»å¯¹ Kubernetes ç”¨æˆ·æ„å‘³ç€ä»€ä¹ˆï¼Ÿ\nä»€ä¹ˆæ˜¯é›¶ä¿¡ä»»ï¼Ÿ æ­£å¦‚æ‰€æ–™ï¼Œé›¶ä¿¡ä»»ä»æ ¹æœ¬ä¸Šè®²æ˜¯å…³äºä¿¡ä»»ã€‚å®ƒæ˜¯è§£å†³å®‰å…¨æ ¸å¿ƒé—®é¢˜ä¹‹ä¸€çš„æ¨¡å‹ï¼šæ˜¯å¦å…è®¸ X è®¿é—® Yï¼Ÿæ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æ˜¯å¦ç›¸ä¿¡ X å¯ä»¥è®¿é—® Yï¼Ÿ\nå½“ç„¶ï¼Œé›¶ä¿¡ä»»ä¸­çš„â€œé›¶â€æœ‰ç‚¹å¤¸å¼ ã€‚è¦ä½¿è½¯ä»¶æ­£å¸¸å·¥ä½œï¼Œæ˜¾ç„¶æŸäº›ä¸œè¥¿éœ€è¦ä¿¡ä»»å…¶ä»–ä¸œè¥¿ã€‚å› æ­¤ï¼Œé›¶ä¿¡ä»»å¹¶ä¸æ˜¯å®Œå…¨æ¶ˆé™¤ä¿¡ä»»ï¼Œè€Œæ˜¯å°†ä¿¡ä»»é™ä½åˆ°æœ€ä½é™åº¦ï¼ˆä¼—æ‰€å‘¨çŸ¥çš„æœ€å°ç‰¹æƒåŸåˆ™ï¼‰å¹¶ç¡®ä¿å®ƒåœ¨æ¯ä¸€ç‚¹éƒ½å¾—åˆ°æ‰§è¡Œã€‚\nè¿™å¬èµ·æ¥åƒæ˜¯å¸¸è¯†ã€‚ä½†ä¸æŠ€æœ¯ä¸­çš„è®¸å¤šæ–°æƒ³æ³•ä¸€æ ·ï¼Œç†è§£é›¶ä¿¡ä»»çš„æœ€ä½³æ–¹æ³•æ˜¯äº†è§£å®ƒçš„ååº”ã€‚é›¶ä¿¡ä»»æ‘’å¼ƒäº†è¾¹ç•Œå®‰å…¨çš„è§‚ç‚¹ã€‚åœ¨è¾¹ç•Œå®‰å…¨æ¨¡å‹ä¸­ï¼Œåœ¨æ•æ„Ÿç»„ä»¶å‘¨å›´å®æ–½â€œè£…ç”²â€ã€‚ä¾‹å¦‚ï¼Œæ•°æ®ä¸­å¿ƒå‘¨å›´å¯èƒ½æœ‰ä¸€ä¸ªé˜²ç«å¢™ï¼Œå…¶ä»»åŠ¡æ˜¯é˜»æ­¢é—®é¢˜æµé‡å’Œå‚ä¸è€…è¿›å…¥ã€‚è¿™ç§æ¨¡å‹ï¼Œæœ‰æ—¶è¢«ç§°ä¸ºåŸå ¡ç­–ç•¥ï¼Œå…·æœ‰ç›´è§‚çš„æ„ä¹‰ï¼šåŸå ¡çš„å¢™å£æ˜¯ä¸ºäº†å°†åäººæ‹’ä¹‹é—¨å¤–ã€‚å¦‚æœä½ åœ¨åŸå ¡é‡Œï¼Œé‚£ä¹ˆæ ¹æ®å®šä¹‰ï¼Œä½ å°±æ˜¯ä¸€ä¸ªå¥½äººã€‚\né›¶ä¿¡ä»»æ¨¡å‹è¡¨æ˜ï¼Œè¾¹ç•Œå®‰å…¨å·²ç»ä¸è¶³ã€‚æ ¹æ®é›¶ä¿¡ä»»åŸåˆ™ï¼Œå³ä½¿åœ¨å®‰å…¨è¾¹ç•Œå†…ï¼Œä»å¿…é¡»å°†ç”¨æˆ·ã€ç³»ç»Ÿå’Œç½‘ç»œæµé‡è§†ä¸ºä¸å—ä¿¡ä»»ã€‚å›½é˜²éƒ¨çš„å‚è€ƒæ¶æ„å¾ˆå¥½åœ°æ€»ç»“äº†è¿™ä¸€ç‚¹ï¼š\nâ€œåœ¨å®‰å…¨è¾¹ç•Œä¹‹å¤–æˆ–ä¹‹å†…è¿è¡Œçš„ä»»ä½•å‚ä¸è€…ã€ç³»ç»Ÿã€ç½‘ç»œæˆ–æœåŠ¡éƒ½æ˜¯ä¸å¯ä¿¡çš„ã€‚ç›¸åï¼Œæˆ‘ä»¬å¿…é¡»éªŒè¯ä»»ä½•è¯•å›¾å»ºç«‹è®¿é—®æƒé™çš„äº‹ç‰©ã€‚ä»è¾¹ç•ŒéªŒè¯ä¸€æ¬¡åˆ°å¯¹æ¯ä¸ªç”¨æˆ·ã€è®¾å¤‡ã€åº”ç”¨ç¨‹åºå’Œäº¤æ˜“çš„æŒç»­éªŒè¯ï¼Œè¿™æ˜¯æˆ‘ä»¬å¦‚ä½•ä¿æŠ¤åŸºç¡€è®¾æ–½ã€ç½‘ç»œå’Œæ•°æ®çš„å“²å­¦çš„å·¨å¤§èŒƒå¼è½¬å˜ã€‚â€\nå½“ç„¶ï¼Œé›¶ä¿¡ä»»å¹¶ä¸æ„å‘³ç€æŠ›å¼ƒé˜²ç«å¢™â€”â€”çºµæ·±é˜²å¾¡æ˜¯ä»»ä½•å®‰å…¨ç­–ç•¥çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚è¿™ä¹Ÿä¸æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å¿½ç•¥æ‰€æœ‰å…¶ä»–é‡è¦çš„å®‰å…¨ç»„ä»¶ï¼Œä¾‹å¦‚äº‹ä»¶è®°å½•å’Œä¾›åº”é“¾ç®¡ç†ã€‚é›¶ä¿¡ä»»åªè¦æ±‚æˆ‘ä»¬å°†ä¿¡ä»»æ£€æŸ¥ä»â€œä¸€æ¬¡åœ¨è¾¹ç•Œâ€è½¬ç§»åˆ°â€œæ¯æ¬¡ï¼Œæ— å¤„ä¸åœ¨â€ã€‚\nç„¶è€Œï¼Œä¸ºäº†æ­£ç¡®åœ°åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è€ƒè™‘ä¸€äº›å…³äºâ€œä¿¡ä»»â€æ„å‘³ç€ä»€ä¹ˆä»¥åŠæˆ‘ä»¬å¦‚ä½•æ•æ‰å®ƒçš„åŸºæœ¬å‡è®¾ã€‚\nèº«ä»½ é›¶ä¿¡ä»»æœ€ç›´æ¥çš„å½±å“ä¹‹ä¸€æ˜¯å®ƒæ”¹å˜äº†æˆ‘ä»¬æ€è€ƒå’Œåˆ†é…èº«ä»½çš„æ–¹å¼ï¼Œå°¤å…¶æ˜¯ç³»ç»Ÿèº«ä»½ã€‚\nåœ¨è¾¹ç•Œæ¨¡å‹ä¸­ï¼Œä½ç½®å®é™…ä¸Šå°±æ˜¯èº«ä»½ã€‚å¦‚æœåœ¨é˜²ç«å¢™å†…ï¼Œé‚£ä¹ˆæ˜¯å¯ä¿¡çš„ï¼›å¦‚æœä½ åœ¨å®ƒä¹‹å¤–ï¼Œå°±ä¸æ˜¯ã€‚å› æ­¤ï¼ŒåŸºäºè¾¹ç•Œçš„ç³»ç»Ÿå¯ä»¥å…è®¸åŸºäºå®¢æˆ·ç«¯ IP åœ°å€ç­‰ä¿¡æ¯è®¿é—®æ•æ„Ÿç³»ç»Ÿã€‚\nåœ¨é›¶ä¿¡ä»»ä¸–ç•Œä¸­ï¼Œè¿™å·²ç»ä¸å¤Ÿäº†ã€‚IP åœ°å€ä»…ç”¨äºæŒ‡ç¤ºä½ç½®ï¼Œå› æ­¤ä¸å†è¶³ä»¥ç¡®å®šæ˜¯å¦å¯ä»¥è®¿é—®ç‰¹å®šèµ„æºã€‚ç›¸åï¼Œæˆ‘ä»¬éœ€è¦å¦ä¸€ç§å½¢å¼çš„èº«ä»½ï¼šä»¥æŸç§å†…åœ¨æ–¹å¼ä¸å·¥ä½œè´Ÿè½½ã€ç”¨æˆ·æˆ–ç³»ç»Ÿç›¸å…³è”ã€‚è€Œä¸”è¿™ç§èº«ä»½éœ€è¦ä»¥æŸç§æ–¹å¼è¿›è¡ŒéªŒè¯ï¼Œè€Œè¿™ç§æ–¹å¼æœ¬èº«å¹¶ä¸éœ€è¦ä¿¡ä»»ç½‘ç»œã€‚\nè¿™æ˜¯ä¸€ä¸ªå…·æœ‰ä¸°å¯Œå«ä¹‰çš„å¤§è¦æ±‚ã€‚æä¾›ç½‘ç»œå®‰å…¨ä½†ä¾èµ–äº IP åœ°å€ç­‰ç½‘ç»œæ ‡è¯†ç¬¦ï¼ˆå¦‚ IPSec æˆ– Wireguardï¼‰çš„ç³»ç»Ÿä¸è¶³ä»¥å®ç°é›¶ä¿¡ä»»ã€‚\nç­–ç•¥ æœ‰äº†æ–°çš„èº«ä»½æ¨¡å‹ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦ä¸€ç§æ–¹æ³•æ¥æ•è·æ¯ä¸ªèº«ä»½çš„è®¿é—®ç±»å‹ã€‚åœ¨ä¸Šé¢çš„è¾¹ç•Œæ–¹æ¡ˆä¸­ï¼Œé€šå¸¸æˆäºˆä¸€ç³»åˆ— IP åœ°å€å¯¹æ•æ„Ÿèµ„æºçš„å®Œå…¨è®¿é—®æƒé™ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè®¾ç½® IP åœ°å€è¿‡æ»¤ï¼Œä»¥ç¡®ä¿ä»…å…è®¸é˜²ç«å¢™å†…çš„ IP åœ°å€è®¿é—®æ•æ„ŸæœåŠ¡ã€‚åœ¨é›¶ä¿¡ä»»çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åè€Œéœ€è¦æ‰§è¡Œå¿…è¦çš„æœ€ä½è®¿é—®çº§åˆ«ã€‚åŸºäºèº«ä»½ä»¥åŠä»»ä½•å…¶ä»–ç›¸å…³å› ç´ ï¼Œåº”å°½å¯èƒ½é™åˆ¶å¯¹èµ„æºçš„è®¿é—®ã€‚\nè™½ç„¶æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»£ç å¯ä»¥è‡ªå·±åšå‡ºè¿™äº›æˆæƒå†³ç­–ï¼Œä½†æˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨åœ¨åº”ç”¨ç¨‹åºä¹‹å¤–æŒ‡å®šçš„æŸç§å½¢å¼çš„ç­–ç•¥æ¥æ•è·å®ƒã€‚æ‹¥æœ‰æ˜ç¡®çš„ç­–ç•¥å…è®¸æˆ‘ä»¬åœ¨ä¸ä¿®æ”¹åº”ç”¨ç¨‹åºä»£ç çš„æƒ…å†µä¸‹å®¡æ ¸å’Œæ›´æ”¹è®¿é—®æƒé™ã€‚\nä¸ºäº†å®ç°æˆ‘ä»¬çš„é›¶ä¿¡ä»»ç›®æ ‡ï¼Œè¿™äº›ç­–ç•¥å¯èƒ½éå¸¸å¤æ‚ã€‚æˆ‘ä»¬å¯èƒ½æœ‰ä¸€ä¸ªç­–ç•¥ï¼Œå®ƒå°†å¯¹æœåŠ¡çš„è®¿é—®é™åˆ¶ä¸ºåªæœ‰é‚£äº›éœ€è¦è®¿é—®å®ƒçš„æœåŠ¡è°ƒç”¨æ–¹ï¼ˆå³ï¼Œåœ¨åŒæ–¹éƒ½ä½¿ç”¨å·¥ä½œè´Ÿè½½èº«ä»½ï¼‰ã€‚æˆ‘ä»¬å¯èƒ½ä¼šè¿›ä¸€æ­¥ç»†åŒ–ï¼Œåªå…è®¸è®¿é—®è¯¥æœåŠ¡ä¸Šçš„æŸäº›æ¥å£ï¼ˆHTTP è·¯ç”±ã€gRPC æ–¹æ³•ï¼‰ã€‚æ›´è¿›ä¸€æ­¥ï¼Œæ ¹æ®è¯·æ±‚çš„ç”¨æˆ·èº«ä»½é™åˆ¶è®¿é—®ã€‚åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œç›®æ ‡éƒ½æ˜¯æœ€ä½æƒé™â€”â€”åªæœ‰åœ¨éå¸¸å¿…è¦æ—¶æ‰èƒ½è®¿é—®ç³»ç»Ÿå’Œæ•°æ®ã€‚\næ‰§è¡Œ æœ€åï¼Œé›¶ä¿¡ä»»è¦æ±‚æˆ‘ä»¬åœ¨æœ€ç»†ç²’åº¦çš„çº§åˆ«ä¸ŠåŒæ—¶æ‰§è¡Œèº«ä»½éªŒè¯ï¼ˆç¡®è®¤èº«ä»½ï¼‰å’Œæˆæƒï¼ˆéªŒè¯ç­–ç•¥æ˜¯å¦å…è®¸è¯¥æ“ä½œï¼‰ã€‚æ¯ä¸ªæˆäºˆæ•°æ®æˆ–è®¡ç®—è®¿é—®æƒé™çš„ç³»ç»Ÿéƒ½åº”è¯¥è®¾ç½®ä»å¤–å›´åˆ°å•ä¸ªç»„ä»¶çš„å®‰å…¨è¾¹ç•Œã€‚\nä¸ç­–ç•¥ç±»ä¼¼ï¼Œè¿™ç§æ‰§è¡Œç†æƒ³æƒ…å†µä¸‹æ˜¯åœ¨æ•´ä¸ªå †æ ˆä¸­ç»Ÿä¸€å®Œæˆçš„ã€‚ä¸æ˜¯æ¯ä¸ªç»„ä»¶éƒ½ä½¿ç”¨è‡ªå·±çš„è‡ªå®šä¹‰æ‰§è¡Œä»£ç ï¼Œè€Œæ˜¯ä½¿ç”¨ç»Ÿä¸€çš„æ‰§è¡Œå±‚ï¼Œç»Ÿä¸€ä¹‹åæ–¹ä¾¿å®¡è®¡ï¼Œå¹¶å°†åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜çš„å…³æ³¨ç‚¹ä¸è¿è¥å’Œå®‰å…¨å›¢é˜Ÿçš„å…³æ³¨ç‚¹åˆ†ç¦»ã€‚\nKubernetes é›¶ä¿¡ä»» æˆ‘ä»¬å¿…é¡»ä»ç¬¬ä¸€åŸåˆ™é‡æ–°æ€è€ƒèº«ä»½ï¼Œä»¥ä»»æ„è¡¨è¾¾æ€§ç­–ç•¥çš„å½¢å¼æ¥å°†ä¿¡ä»»å…·è±¡åŒ–ï¼Œå¹¶å°†æ–°çš„æ‰§è¡Œæœºåˆ¶æ¸—é€åˆ°åŸºç¡€è®¾æ–½çš„å„ä¸ªå±‚é¢ã€‚é¢å¯¹è¿™äº›çš„è¦æ±‚ï¼Œæˆ‘ä»¬ä¸å¯é¿å…åœ°ç»å†çŸ­æš‚çš„ææ…Œã€‚å‰é¢æ˜¯ä¸æ˜¯æåˆ°éœ€è¦åœ¨ 2024 è´¢å¹´ä¹‹å‰å®ç°ï¼Ÿ\nå¥½æ¶ˆæ¯æ˜¯ï¼Œè‡³å°‘å¯¹äº Kubernetes ç”¨æˆ·æ¥è¯´ï¼Œé‡‡ç”¨é›¶ä¿¡ä»»çš„æŸäº›æ–¹é¢è¦å®¹æ˜“å¾—å¤šã€‚å°½ç®¡æœ‰ç¼ºé™·å’Œå¤æ‚æ€§ï¼ŒKubernetes æ˜¯ä¸€ä¸ªå…·æœ‰æ˜ç¡®èŒƒå›´ã€å®šä¹‰è‰¯å¥½çš„å®‰å…¨æ¨¡å‹å’Œæ˜ç¡®çš„æ‰©å±•æœºåˆ¶çš„å¹³å°ã€‚è¿™ä½¿å…¶æˆä¸ºé›¶ä¿¡ä»»å®æ–½çš„æˆåŠŸé¢†åŸŸã€‚\nåœ¨ Kubernetes ä¸­è§£å†³é›¶ä¿¡ä»»ç½‘ç»œçš„æœ€ç›´æ¥æ–¹æ³•ä¹‹ä¸€æ˜¯ä½¿ç”¨æœåŠ¡ç½‘æ ¼ã€‚æœåŠ¡ç½‘æ ¼åˆ©ç”¨äº† Kubernetes å¼ºå¤§çš„â€œsidecarâ€æ¦‚å¿µï¼Œå…¶ä¸­å¹³å°å®¹å™¨ï¼ˆè¯‘è€…æ³¨ï¼šæ­¤å¤„æŒ‡ sidecar ä»£ç†å®¹å™¨ï¼‰å¯ä»¥åœ¨éƒ¨ç½²æ—¶ä»¥åæœŸç»‘å®šæ“ä½œåŠŸèƒ½çš„å½¢å¼ï¼Œä¸åº”ç”¨ç¨‹åºå®¹å™¨åŠ¨æ€æ³¨å…¥åˆ°ä¸€èµ·ï¼Œã€‚\næœåŠ¡ç½‘æ ¼ä½¿ç”¨è¿™ç§ sidecar æ–¹æ³•åœ¨è¿è¡Œæ—¶å°†ä»£ç†æ·»åŠ åˆ°åº”ç”¨ç¨‹åº pod ä¸­ï¼Œå¹¶è¿æ¥è¿™äº›ä»£ç†ä»¥å¤„ç†æ‰€æœ‰ä¼ å…¥å’Œä¼ å‡ºæµé‡ã€‚è¿™å…è®¸æœåŠ¡ç½‘æ ¼ä»¥ä¸åº”ç”¨ç¨‹åºä»£ç è§£è€¦çš„æ–¹å¼äº¤ä»˜åŠŸèƒ½ã€‚åº”ç”¨ç¨‹åºå’Œå¹³å°ä¹‹é—´çš„å…³æ³¨ç‚¹åˆ†ç¦»æ˜¯æœåŠ¡ç½‘æ ¼ä¸»å¼ çš„æ ¸å¿ƒä»·å€¼ï¼šå½“ç„¶ï¼Œè¿™äº›åŠŸèƒ½å¯ä»¥ç›´æ¥åœ¨åº”ç”¨ç¨‹åºä¸­å®ç°ï¼Œä½†æ˜¯é€šè¿‡è§£è€¦ï¼Œæˆ‘ä»¬å…è®¸å®‰å…¨å›¢é˜Ÿå’Œå¼€å‘äººå‘˜ç›¸äº’ç‹¬ç«‹åœ°è¿­ä»£ï¼ŒåŒæ—¶ä»ç„¶åŠªåŠ›å®ç°å®‰å…¨ä½†åŠŸèƒ½é½å…¨çš„åº”ç”¨ç¨‹åºçš„å…±åŒç›®æ ‡ã€‚\nç”±äºæœåŠ¡ç½‘æ ¼å¤„ç†è¿›å‡ºåº”ç”¨ç¨‹åºä¹‹é—´çš„é»˜è®¤ç½‘ç»œï¼Œå› æ­¤å®ƒå¯ä»¥å¾ˆå¥½åœ°å¤„ç†é›¶ä¿¡ä»»é—®é¢˜ï¼š\nå·¥ä½œè´Ÿè½½èº«ä»½å¯ä»¥ä» Kubernetes ä¸­çš„ pod èº«ä»½è€Œä¸æ˜¯å…¶ IP åœ°å€ä¸­è·å–ã€‚ å¯ä»¥é€šè¿‡åœ¨åŒå‘ TLS ä¸­åŒ…è£…è¿æ¥æ¥æ‰§è¡Œèº«ä»½éªŒè¯ï¼Œè¿™æ˜¯ TLS çš„ä¸€ç§å˜ä½“ï¼Œå…¶ä½¿ç”¨åŠ å¯†ä¿¡æ¯åœ¨è¿æ¥çš„ä¸¤ç«¯è¿›è¡ŒéªŒè¯ã€‚ æˆæƒç­–ç•¥å¯ä»¥ç”¨ Kubernetes æœ¯è¯­è¡¨ç¤ºï¼Œä¾‹å¦‚ï¼Œé€šè¿‡è‡ªå®šä¹‰èµ„æºå®šä¹‰ (CRD)ï¼Œæ˜ç¡®ç­–ç•¥å¹¶å¹¶ä¸åº”ç”¨ç¨‹åºè§£è€¦ã€‚ æœ€é‡è¦çš„æ˜¯ï¼Œç­–ç•¥åœ¨è·¨æŠ€æœ¯æ ˆçš„å•ä¸ª pod çº§åˆ«ç»Ÿä¸€æ‰§è¡Œã€‚æ¯ä¸ª pod éƒ½æœ‰è‡ªå·±çš„èº«ä»½éªŒè¯å’Œæˆæƒï¼Œè¿™æ„å‘³ç€ç½‘ç»œæ°¸è¿œä¸å—ä¿¡ä»»ã€‚ æ‰€æœ‰è¿™äº›å…±åŒå®ç°äº†æˆ‘ä»¬çš„å¤§éƒ¨åˆ†é›¶ä¿¡ä»»ç›®æ ‡ï¼ˆè‡³å°‘å¯¹äº Kubernetes é›†ç¾¤è€Œè¨€ï¼ï¼‰ã€‚æˆ‘ä»¬ä½¿ç”¨å·¥ä½œè´Ÿè½½èº«ä»½è€Œä¸æ˜¯ç½‘ç»œèº«ä»½ï¼›åœ¨æœ€ç»†ç²’åº¦çº§åˆ«ï¼ˆpodï¼‰ä¸Šæ‰§è¡Œï¼Œä»¥åŠåœ¨æŠ€æœ¯æ ˆä¸­ä»¥ä¸€è‡´ä¸”ç»Ÿä¸€çš„æ–¹å¼åº”ç”¨èº«ä»½éªŒè¯å’Œæˆæƒçš„ï¼Œè€Œæ— éœ€æ›´æ”¹åº”ç”¨ç¨‹åºã€‚\nåœ¨åŸºæœ¬æ¡†æ¶å†…ï¼Œä¸åŒçš„æœåŠ¡ç½‘æ ¼å®ç°æä¾›äº†ä¸åŒçš„æƒè¡¡ã€‚ä¾‹å¦‚ï¼Œ Linkerdæ˜¯ä¸€ä¸ªå¼€æºã€Cloud Native Computing Foundation æ¯•ä¸šçš„æœåŠ¡ç½‘æ ¼é¡¹ç›®ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªä»¥ç®€å•æ€§ä¸ºç›®æ ‡å’Œé‡ç‚¹çš„å®ç°ï¼Œç›´æ¥ä» Kubernetes ServiceAccounts æå–å·¥ä½œè´Ÿè½½æ ‡è¯†æ¥è¾¾åˆ°â€œé›¶é…ç½®â€ï¼Œé»˜è®¤å¼€å¯åŒå‘ TLSã€‚åŒæ ·ï¼ŒLinkerd çš„åŸºäº Rust çš„å¾®ä»£ç†æä¾›äº†ä¸€ä¸ªæç®€çš„é›¶ä¿¡ä»»å®ç°ã€‚\nå½“ç„¶ï¼Œä»…ä»…åœ¨é›†ç¾¤ä¸­æ·»åŠ ä¸€ä¸ªæœåŠ¡ç½‘æ ¼å¹¶ä¸æ˜¯ä¸‡èƒ½çš„ã€‚å®‰è£…åï¼Œå¿…é¡»å®Œæˆå®šä¹‰ã€æ›´æ–°å’Œè¯„ä¼°æˆæƒç­–ç•¥çš„å·¥ä½œã€‚é›†ç¾¤è¿ç»´äººå‘˜å¿…é¡»å°å¿ƒç¡®ä¿æ‰€æœ‰æ–°åˆ›å»ºçš„ pod éƒ½ä¸å®ƒä»¬çš„ sidecar ç»„ä»¶é…å¯¹ã€‚å½“ç„¶ï¼ŒæœåŠ¡ç½‘æ ¼æœ¬èº«å¿…é¡»åƒé›†ç¾¤ä¸Šçš„ä»»ä½•è½¯ä»¶ä¸€æ ·è¿›è¡Œç»´æŠ¤ã€ç›‘æ§å’Œè¿­ä»£ã€‚ç„¶è€Œï¼Œä¸ç®¡æ˜¯ä¸æ˜¯çµä¸¹å¦™è¯ï¼ŒæœåŠ¡ç½‘æ ¼ç¡®å®æä¾›äº†ä»é›†ç¾¤ä¸­é»˜è®¤çš„æœªåŠ å¯†ã€æœªç»èº«ä»½éªŒè¯çš„æµé‡è½¬å˜ä¸ºå…·æœ‰å¼ºå¤§å·¥ä½œè´Ÿè½½èº«ä»½å’Œä¸°å¯Œæˆæƒç³»ç»Ÿçš„é»˜è®¤åŠ å¯†ã€ç»è¿‡èº«ä»½éªŒè¯çš„æµé‡â€”â€”è¿™æ˜¯æœç€é›¶ä¿¡ä»»è¿ˆå‡ºçš„ä¸€å¤§æ­¥ã€‚\næ€»ç»“ é›¶ä¿¡ä»»æ˜¯ä¸€ç§å¼ºå¤§çš„å®‰å…¨æ¨¡å‹ï¼Œå¤„äºç°ä»£å®‰å…¨å®è·µçš„å‰æ²¿ã€‚å¦‚æœå¯ä»¥æ¶ˆé™¤å›´ç»•å®ƒçš„è¥é”€å™ªéŸ³ï¼Œé‚£ä¹ˆé‡‡ç”¨é›¶ä¿¡ä»»æœ‰ä¸€äº›æ·±åˆ»è€Œé‡è¦çš„å¥½å¤„ã€‚è™½ç„¶é›¶ä¿¡ä»»éœ€è¦å¯¹èº«ä»½ç­‰æ ¸å¿ƒç†å¿µè¿›è¡Œä¸€äº›æ ¹æœ¬æ€§çš„æ”¹å˜ï¼Œä½†å¦‚æœ Kubernetes ç”¨æˆ·èƒ½å¤Ÿé‡‡ç”¨æœåŠ¡ç½‘æ ¼å¹¶ä»çº¯ç²¹åŸºäºè¾¹ç•Œçš„ç½‘ç»œå®‰å…¨è½¬å˜ä¸ºâ€œå¯¹æ¯ä¸ªç”¨æˆ·ã€è®¾å¤‡ã€åº”ç”¨ç¨‹åºå’Œäº¤æ˜“çš„æŒç»­éªŒè¯â€ï¼Œé‚£ä¹ˆä»–ä»¬è‡³å°‘æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ã€‚\nå…³äºä½œè€… William Morgan William Morganæ˜¯ Buoyant çš„è”åˆåˆ›å§‹äººå…¼é¦–å¸­æ‰§è¡Œå®˜ï¼ŒLinkerd çš„åˆ›å»ºè€…ã€‚åœ¨åŠ å…¥ Buoyant ä¹‹å‰ï¼Œä»–æ˜¯ Twitter çš„ä¸€ååŸºç¡€æ¶æ„å·¥ç¨‹å¸ˆï¼Œåœ¨é‚£é‡Œä»–å¸®åŠ©å°† Twitter ä»å•ä½“æ¶æ„è½¬å˜ä¸ºå¾®æœåŠ¡ã€‚ä»–æ˜¯ Powersetã€Microsoft å’Œ Adap.tv çš„è½¯ä»¶å·¥ç¨‹å¸ˆï¼Œä»¥åŠ MITRE çš„ç ”ç©¶ç§‘å­¦å®¶ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/09/08/pexelsannashvets4672717.jpg","permalink":"https://atbug.com/translate-zero-trust-for-k8s/","tags":["é›¶ä¿¡ä»»","Kubernetes","å®‰å…¨"],"title":"è¯‘ï¼šé›¶ä¿¡ä»»å¯¹ Kubernetes æ„å‘³ç€ä»€ä¹ˆ"},{"categories":["å®¹å™¨"],"contents":"\nDocker åœ¨åˆšåˆšå‘å¸ƒçš„ Docker Desktop 4.12.0 ä¸­ï¼ŒåŠ å…¥äº†å®éªŒç‰¹æ€§ï¼šè¿›ä¸€æ­¥é›†æˆ containerdï¼Œä½¿ç”¨ containerd æ¥ç®¡ç†å’Œå­˜å‚¨é•œåƒã€‚\nä¸ºä»€ä¹ˆè¯´æ˜¯â€œè¿›ä¸€æ­¥é›†æˆâ€ï¼Ÿè¿™å°±è¦ç¿»ç¿» Docker å’Œ containerd çš„å†å²äº†ã€‚\ncontainerd çš„è¯ç”Ÿ containerd æœ€æ—©å‡ºç°åœ¨ Docker Engine ä¸­ï¼Œåæ¥ä¸ºäº†å°† Docker Engine åšå¾—æ›´åŠ è½»é‡ã€å¿«é€Ÿå’Œå¥å£®ï¼Œåœ¨ 2016 å¹´ Docker å°† containerd ä» daemonï¼ˆdockerdï¼‰ ä¸­ç‹¬ç«‹å‡ºæ¥ï¼Œå¹¶å®Œæˆäº†ä¸ daemon çš„é›†æˆã€‚ç‹¬ç«‹å‡ºæ¥çš„ containerd å…¨é¢æ”¯æŒ OCIï¼ˆOpen Container Initiativeï¼‰èµ„æºçš„å¯åŠ¨å’Œç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ï¼Œä¹Ÿå› æ­¤ containerd å¯ä»¥æ”¯æŒ runcï¼ˆå‰èº«æ˜¯ Docker ä¸­çš„ libcontainerï¼Œåæ¥æèµ ç»™ LFï¼‰ä»¥å¤–çš„å…¶ä»– OCI å®ç°ã€‚2017 å¹´ Docker å°† containerd æçŒ®ç»™ CNCFï¼›2019 å¹´ 2 æœˆï¼Œcontainerd æ¯•ä¸šã€‚\ncontainerd ç‹¬ç«‹å‡ºæ¥ä¹‹åï¼Œå‘é€åˆ° Docker Engine çš„è¯·æ±‚ï¼š\nDocker daemon å®Œæˆé•œåƒç®¡ç†çš„æ“ä½œï¼ˆæ‹‰å–ã€æ›´æ–°é•œåƒï¼‰ daemon ä¼šä¸ºåˆ›å»ºå®¹å™¨è¿›è¡Œå‡†å¤‡å·¥ä½œï¼ˆåˆ›å»º OCI bundlesï¼‰ï¼šé•œåƒçš„ä¿¡æ¯å’Œè¿è¡Œæ—¶çš„ä¿¡æ¯ã€‚ daemon è°ƒç”¨ containerd çš„ APIã€‚ æ”¶åˆ°è¯·æ±‚çš„ containerd ä¸ä¼šç›´æ¥å»æ“ä½œå®¹å™¨ï¼ˆä¸ç›´æ¥ä½œä¸ºå®¹å™¨çš„çˆ¶è¿›ç¨‹ï¼Œé˜²æ­¢ containerd æŒ‚æ‰å½±å“å®¹å™¨ï¼‰ï¼Œè€Œæ˜¯å…ˆåˆ›å»ºä¸€ä¸ª container-shim è¿›ç¨‹ã€‚ container-shim è°ƒç”¨ runc cli æ¥è¿è¡Œå®¹å™¨ï¼Œå¹¶å¯åŠ¨ Unix domain socket æš´éœ² API æä¾›ç»™ containerdè¿›è¡Œå®¹å™¨çš„ç®¡ç†ã€‚ éšç€ containerd çš„ä¸æ–­æ¼”è¿›ï¼Œé™¤äº†å®¹å™¨åˆ›å»ºå’Œå®¹å™¨å£°æ˜å‘¨æœŸç®¡ç†ä»¥å¤–ï¼Œä» 1.1 å¼€å§‹ containerd åŠ å…¥äº† CRIï¼ˆContainer Runtime Interfaceï¼‰çš„æ”¯æŒã€‚\nCRI åœ¨ã€Šæºç è§£æ kubectl port-forward å·¥ä½œåŸç†ã€‹ ä¸­å±‚æåˆ° kubelet ä¼šè°ƒç”¨ rumtime service çš„ gRPC æ¥å£ï¼Œé™¤äº†ç”¨äº portforward æµçš„ stream serverä»¥å¤–ï¼Œå…¶å®è¿˜æœ‰å®ç° CRI æ¥å£ RuntimeService å’Œ ImageService çš„ RuntimeServiceServer å’Œ ImageServiceServerã€‚\nRuntimeServiceServer ç”¨äºæ¥æ”¶å¹¶å¤„ç†å®¹å™¨åŠå…¶ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„æ“ä½œï¼Œè€Œ ImageServiceServer åˆ™æ˜¯ç”¨æ¥å¤„ç†é•œåƒç›¸å…³çš„æ“ä½œã€‚containerd æä¾›äº†é•œåƒæ‹‰å–ã€åˆ é™¤ã€æ£€æŸ¥ã€å­˜å‚¨ç­‰åŠŸèƒ½ã€‚\næ—¢ç„¶ containerd å¯ä»¥è¿›è¡Œé•œåƒçš„ç®¡ç†ï¼Œè€Œä¸” Docker å·²ç»åœ¨ä½¿ç”¨ï¼ŒDocker ä¹Ÿæ²¡æœ‰å¿…è¦è‡ªå·±ç»§ç»­ç»´æŠ¤ä¸€å¥—ç›¸åŒçš„åŠŸèƒ½ã€‚\nåˆ‡æ¢åˆ° containerd çš„é•œåƒç®¡ç† åœ¨ Docker Desktop çš„è®¾ç½®ä¸­å¯åŠ¨ containerd ç®¡ç†é•œåƒåï¼Œè¿è¡Œ docker info ä¼šå‘ç°å­˜å‚¨çš„é©±åŠ¨ä»åŸæ¥çš„ overlay2 å˜æˆäº† containerd çš„ stargzã€‚\nåˆ‡æ¢å‰ï¼š\nåˆ‡æ¢åï¼š\næ—¢ç„¶ä½¿ç”¨äº† containerd çš„ snapshotters æ¥ç®¡ç†å­˜å‚¨ï¼ˆæŒ‚åœ¨å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œå°±å¯ä»¥æ”¯æŒå¤šç§ snapshottersï¼Œæ¯”å¦‚ stargz çš„å»¶è¿Ÿæ‹‰å–ã€‚\næ­¤å¤–ï¼Œå¾—ç›Šäº containerd åŸç”Ÿæ”¯æŒå¤šå¹³å°é•œåƒçš„å­˜å‚¨ï¼Œè¿˜æ˜¯å› ä¸º snapshotters çš„åŸå› ï¼Œå¯ä»¥ä½¿ç”¨ docker æ¥æ„å»ºå¤šå¹³å°çš„é•œåƒäº†ã€‚\n#åˆ‡æ¢å‰ docker buildx build -t demo --no-cache --platform linux/amd64,linux/arm64 . [+] Building 0.0s (0/0) error: multiple platforms feature is currently not supported for docker driver. Please switch to a different driver (eg. \u0026#34;docker buildx create --use\u0026#34;) åˆ‡æ¢åï¼š\nå›¾ç‰‡æ¥è‡ª docker å®˜æ–¹åšå®¢\næ€»ç»“ ä½¿ç”¨ containerd ä½œä¸º Docker çš„é•œåƒç®¡ç†ç›®å‰è¿˜å¤„äºå®éªŒæ€§é˜¶æ®µï¼Œå¿…å¯é¿å…ä¼šå­˜åœ¨é—®é¢˜ï¼Œä½¿ç”¨æ—¶è¯·è°¨æ…å¯¹å¾…ã€‚\néšç€ Docker Swarm åœ¨å®¹å™¨ç¼–æ’ä¹‹æˆ˜ä¸­çš„è½è´¥ï¼ŒKubernetes çš„è¯è¯­æƒä¹Ÿè¶Šæ¥è¶Šå¼ºã€‚åœ¨ Kubernetes 1.24.0 ä¸­ç§»é™¤äº† docker shim ä»£ç ï¼Œçœ‹èµ·æ¥æ›´åƒæ˜¯ containerd å–ä»£äº† Docker æ›¾ç»çš„åœ°ä½ï¼Œè€Œ Docker ä¹Ÿè¶Šæ¥è¶Šåå£°ä¸æ˜¾ã€‚ä»è¶‹åŠ¿æ¥çœ‹ï¼ŒDocker æœªæ¥å°†ä¼šå®Œå…¨é›†æˆ containerdã€‚\nå‚è€ƒ Extending Dockerâ€™s Integration with containerd Docker containerd integration Learning Containers From The Bottom Up ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/09/05/pexelsjuliussilver7533312.jpg","permalink":"https://atbug.com/docker-manipulate-image-via-containerd/","tags":["Docker","Containerd"],"title":"Docker å‘å…¨é¢é›†æˆ containerd åˆè¿ˆè¿›ä¸€æ­¥"},{"categories":["äº‘åŸç”Ÿ"],"contents":"kube-ovn ä»åå­—ä¸éš¾çœ‹å‡ºå…¶æ˜¯ä¸€æ¬¾äº‘åŸç”Ÿçš„ç½‘ç»œäº§å“ï¼Œå°† SDN ç­‰èƒ½åŠ›å¸¦å…¥äº‘åŸç”Ÿé¢†åŸŸã€‚è®© ovn/ovs çš„ä½¿ç”¨æ›´å®¹æ˜“ï¼Œå±è”½äº†å¤æ‚åº¦ï¼Œé™ä½äº†ä½¿ç”¨çš„éš¾åº¦ï¼Œå¹¶ä¸äº‘åŸç”Ÿè¿›è¡Œäº†ç»“åˆã€‚\nå€ŸåŠ© OVS/OVN åœ¨ SDN é¢†åŸŸæˆç†Ÿçš„èƒ½åŠ›ï¼ŒKube-OVN å°†ç½‘ç»œè™šæ‹ŸåŒ–çš„ä¸°å¯ŒåŠŸèƒ½å¸¦å…¥äº‘åŸç”Ÿé¢†åŸŸã€‚ç›®å‰å·²æ”¯æŒå­ç½‘ç®¡ç†ï¼Œ é™æ€ IP åˆ†é…ï¼Œåˆ†å¸ƒå¼/é›†ä¸­å¼ç½‘å…³ï¼ŒUnderlay/Overlay æ··åˆç½‘ç»œï¼Œ VPC å¤šç§Ÿæˆ·ç½‘ç»œï¼Œè·¨é›†ç¾¤äº’è”ç½‘ç»œï¼ŒQoS ç®¡ç†ï¼Œ å¤šç½‘å¡ç®¡ç†ï¼ŒACL ç½‘ç»œæ§åˆ¶ï¼Œæµé‡é•œåƒï¼ŒARM æ”¯æŒï¼Œ Windows æ”¯æŒç­‰è¯¸å¤šåŠŸèƒ½ã€‚\nå®‰è£… k3s å‚è€ƒå®˜æ–¹çš„å‡†å¤‡å·¥ä½œæ–‡æ¡£ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨ Ubuntu 20.04 ä»¥åŠ k3s v1.23.8+k3s2ã€‚\nåœ¨å®‰è£…ä¹‹å‰ç¡®ä¿ /etc/cni/net.d/ ç›®å½•å†…å®¹ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™æ¸…ç©ºå…¶ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ã€‚kube-ovn æœ¬èº«é€šè¿‡å®ç° cni æ¥ç®¡ç†ç½‘ç»œã€‚\nåœ¨å®‰è£… k3s éœ€è¦ç¦ç”¨ k3s é»˜è®¤çš„ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨å’Œflannel çš„åç«¯ï¼ˆé»˜è®¤æ˜¯ VXLANï¼‰ï¼š\nexport INSTALL_K3S_VERSION=v1.23.8+k3s1 curl -sfL https://get.k3s.io | sh -s - --flannel-backend=none --disable-network-policy --disable=traefik --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config ä¸ºäº†èŠ‚çœèµ„æºï¼Œæˆ‘ä¹Ÿç¦ç”¨äº† traefik Ingress æ§åˆ¶å™¨ã€‚\næ­¤æ—¶æ£€æŸ¥ pod ä¼šå‘ç°éƒ½å¤„äº Pending çŠ¶æ€ï¼Œè¿™æ˜¯å› ä¸ºè¿˜æ²¡å®‰è£… CNIã€‚\nkubectl get po -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system local-path-provisioner-6c79684f77-llvhk 0/1 Pending 0 11s kube-system metrics-server-7cd5fcb6b7-kxm5j 0/1 Pending 0 11s kube-system coredns-d76bd69b-jd6gm 0/1 Pending 0 11s æ£€æŸ¥ node æç¤º container runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initializedã€‚\næ¥ä¸‹æ¥å°±æ˜¯å®‰è£… kube-ovn äº†ã€‚\nå®‰è£… kube-ovn kube-ovn çš„å®‰è£…ä½¿ç”¨å®˜æ–¹æä¾›ä¸€é”®å®‰è£…è„šæœ¬ï¼š\nwget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/dist/images/install.sh æŸ¥çœ‹è„šæœ¬ä¸­çš„é…ç½®ï¼š\nREGISTRY=\u0026#34;kubeovn\u0026#34; # é•œåƒä»“åº“åœ°å€ VERSION=\u0026#34;v1.10.6\u0026#34; # é•œåƒç‰ˆæœ¬/Tag POD_CIDR=\u0026#34;10.16.0.0/16\u0026#34; # é»˜è®¤å­ç½‘ CIDR ä¸è¦å’Œ SVC/NODE/JOIN CIDR é‡å  SVC_CIDR=\u0026#34;10.96.0.0/12\u0026#34; # éœ€è¦å’Œ apiserver çš„ service-cluster-ip-range ä¿æŒä¸€è‡´ JOIN_CIDR=\u0026#34;100.64.0.0/16\u0026#34; # Pod å’Œä¸»æœºé€šä¿¡ç½‘ç»œ CIDRï¼Œä¸è¦å’Œ SVC/NODE/POD CIDR é‡å  LABEL=\u0026#34;node-role.kubernetes.io/master\u0026#34; # éƒ¨ç½² OVN DB èŠ‚ç‚¹çš„æ ‡ç­¾ IFACE=\u0026#34;\u0026#34; # å®¹å™¨ç½‘ç»œæ‰€ä½¿ç”¨çš„çš„å®¿ä¸»æœºç½‘å¡åï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨ Kubernetes ä¸­çš„ Node IP æ‰€åœ¨ç½‘å¡ TUNNEL_TYPE=\u0026#34;geneve\u0026#34; # éš§é“å°è£…åè®®ï¼Œå¯é€‰ geneve, vxlan æˆ– sttï¼Œstt éœ€è¦å•ç‹¬ç¼–è¯‘ ovs å†…æ ¸æ¨¡å— k3s çš„é»˜è®¤ POD å’Œ SVC CIDR åˆ†åˆ«æ˜¯ï¼š10.42.0.0/16 å’Œ 10.43.0.0/16ï¼Œå¯ä»¥åœ¨å®‰è£…æ—¶é€šè¿‡å‚æ•° --cluster-cidr å’Œ --service-cidr åˆ†åˆ«è¿›è¡Œè®¾ç½®ã€‚ä¸Šé¢ï¼Œå®‰è£… k3s æ—¶ä½¿ç”¨äº†çš„é»˜è®¤é…ç½®ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹ install.sh ä¸­çš„é…ç½®ã€‚\nPOD_CIDR=\u0026#34;10.42.0.0/16\u0026#34; POD_GATEWAY=\u0026#34;10.42.0.1\u0026#34; SVC_CIDR=\u0026#34;10.43.0.0/12\u0026#34; ä¿®æ”¹ä¹‹åï¼Œè¿è¡Œè„šæœ¬å®‰è£…ï¼š\nbash install.sh ç¡®è®¤æ‰€æœ‰ pod å¯åŠ¨å¹¶è¿è¡Œï¼š\nkubectl get po -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system ovs-ovn-trqk5 1/1 Running 0 2m37s kube-system kube-ovn-monitor-5f8f5dbfc-plfrq 1/1 Running 0 108s kube-system kube-ovn-controller-67bbd54575-2n87d 1/1 Running 0 108s kube-system ovn-central-644fbb8467-xtrjc 1/1 Running 0 2m37s kube-system kube-ovn-cni-glcfw 1/1 Running 0 108s kube-system kube-ovn-pinger-2k72d 1/1 Running 0 71s kube-system local-path-provisioner-6c79684f77-jh2zh 1/1 Running 0 71s kube-system coredns-d76bd69b-w28rg 1/1 Running 0 37s kube-system metrics-server-7cd5fcb6b7-8jgdm 1/1 Running 0 36s æ£€æŸ¥ kube-system ä¸‹çš„ DaemonSet ç±»å‹åº”ç”¨ï¼Œè¿è¡Œåœ¨å„ä¸ª node ä¸Šè´Ÿè´£ ovs/ovnã€CNI å’Œç½‘ç»œæ£€æŸ¥ pingã€‚\nkubectl get ds -n kube-system NAME DESIRED CURRENT READY UP-TO-DATE AVAILABLE NODE SELECTOR AGE ovs-ovn 1 1 1 1 1 kubernetes.io/os=linux 3m14s kube-ovn-cni 1 1 1 1 1 kubernetes.io/os=linux 2m25s kube-ovn-pinger 1 1 1 1 1 kubernetes.io/os=linux 2m25s è‡³æ­¤ kube-ovn å°±å®‰è£…å®Œæˆäº†ï¼Œä¸‹é¢ç®€å•ä½“éªŒä¸‹ kube-ovn çš„åŠŸèƒ½ã€‚\nä½“éªŒ å­ç½‘ å‰é¢ä»‹ç» kube-ovn å®‰è£…æ—¶æåˆ°äº†å­ç½‘ï¼Œå­ç½‘ æ˜¯ kube-ovn çš„æ ¸å¿ƒæ¦‚å¿µã€‚\nKube-OVN ä¼šä»¥å­ç½‘æ¥ç»„ç»‡ IP å’Œç½‘ç»œé…ç½®ï¼Œæ¯ä¸ª Namespace å¯ä»¥å½’å±äºç‰¹å®šçš„å­ç½‘ï¼Œ Namespace ä¸‹çš„ Pod ä¼šè‡ªåŠ¨ä»æ‰€å±çš„å­ç½‘ä¸­è·å– IP å¹¶å…±äº«å­ç½‘çš„ç½‘ç»œé…ç½®ï¼ˆCIDRï¼Œç½‘å…³ç±»å‹ï¼Œè®¿é—®æ§åˆ¶ï¼ŒNATæ§åˆ¶ç­‰ï¼‰ã€‚\næˆ‘ä»¬éƒ¨ç½²ä¸€ä¸ª podï¼Œå¯ä»¥çœ‹åˆ° k3s ä» kube-ovn çš„é»˜è®¤å­ç½‘ä¸­åˆ†é… IP åœ°å€ã€‚æ‰€æœ‰æ²¡æœ‰è®¾ç½®å­ç½‘çš„ namespace çš„ pod IP åœ°å€éƒ½ä½äºè¯¥ç½‘æ®µã€‚\nkubectl run pipy --image flomesh/pipy:latest -n default kubectl get po -o wide -n default NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pipy 1/1 Running 0 41s 10.42.0.10 ubuntu-dev1 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª namespace å’Œæ–°çš„å­ç½‘ï¼š\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: v1 kind: Namespace metadata: creationTimestamp: null name: another --- apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: another-subnet spec: protocol: IPv4 cidrBlock: 10.66.0.0/16 excludeIps: - 10.66.0.1 gateway: 10.66.0.1 gatewayType: distributed natOutgoing: true namespaces: - another EOF æ¥ä¸‹æ¥éªŒè¯ä¸€ä¸‹ï¼Œåœ¨ another namespace ä¸‹åˆ›å»ºæ–°çš„ podï¼š\nkubectl run curl --image rancher/curl --command sleep 1d -n another kubectl get po -o wide -n another NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES curl 1/1 Running 0 14s 10.66.0.11 ubuntu-dev1 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; å¯ä»¥çœ‹åˆ° pod curl ä»æ–°çš„å­ç½‘ä¸­è·å–äº† IP åœ°å€ï¼Œè¯•ç€è®¿é—®ä¹‹å‰åˆ›å»ºçš„ podï¼š\nkubectl exec -it curl -n another -- curl -i 10.42.0.10:8080 HTTP/1.1 200 OK content-length: 11 connection: keep-alive Hi, there! ä¸åŒçš„å­ç½‘æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿè¯•æƒ³è¿™æ ·çš„åœºæ™¯ï¼Œæœ‰ä¸¤ä¸ª namespace another å’Œ defaultã€‚è¦ç¦æ­¢ annother ä¸­çš„ pod å¯¹ default ä¸­pod çš„è®¿é—®ï¼Œç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„æ˜¯ Kubernetes çš„ Network Policyï¼Œæˆ–è€…å€ŸåŠ©å…¶ä»–çš„åº”ç”¨ï¼Œæ¯”å¦‚ä¹‹å‰ä»‹ç»çš„ ä½¿ç”¨ Cilium å¢å¼º Kubernetes ç½‘ç»œå®‰å…¨ï¼ˆä¹Ÿæ˜¯ç½‘ç»œå†…æ ¸å±‚çš„å®ç°ï¼‰ï¼Œæˆ–è€…æœåŠ¡ç½‘æ ¼çš„è®¿é—®æ§åˆ¶ã€‚\nä½†ç°åœ¨æ—¢ç„¶ç”¨ kube-ovnï¼Œå¯ä»¥ä½¿ç”¨ ovn çš„ ACL è§„åˆ™ã€‚\nå­ç½‘ ACL æ¥ä¸‹æ¥ï¼Œæ›´æ–°é»˜è®¤å­ç½‘çš„è®¾ç½®ï¼Œæ·»åŠ  ACL è§„åˆ™ï¼š\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: ovn-default spec: cidrBlock: 10.42.0.0/16 default: true excludeIps: - 10.42.0.1 gateway: 10.42.0.1 gatewayType: distributed natOutgoing: true protocol: IPv4 provider: ovn vpc: ovn-cluster acls: - action: drop direction: from-lport match: ip4.src == 10.66.0.0/16 \u0026amp;\u0026amp; ip priority: 1002 EOF è¿™æ®µ ACL è§„åˆ™è¡¨ç¤ºï¼šä¸¢å¼ƒï¼ˆaction: dropï¼‰æ¥è‡ªï¼ˆdirection: from-lportï¼‰10.66.0.0/16 ç½‘æ®µï¼ˆmatch: ip4.src == 10.66.0.0/16 \u0026amp;\u0026amp; ipï¼‰çš„åŒ…ï¼Œæ›´å¤šè§„åˆ™è¯´æ˜å‚è€ƒ ACL è§„åˆ™æ–‡æ¡£ã€‚\næ­¤æ—¶å†æ¬¡è®¿é—®ï¼Œä½†æ˜¯è¿™å›åŠ ä¸Šè¿æ¥è¶…æ—¶ï¼Œå› ä¸ºä¸æƒ³ç­‰å¤ªä¹…ï¼š\nkubectl exec -it curl -n another -- curl -i --connect-timeout 5 10.42.0.10:8080 curl: (28) Connection timed out after 5000 milliseconds command terminated with exit code 28 another namespace ä¸‹çš„ pod æ— æ³•è®¿é—®åˆ° default ä¸‹çš„ podï¼Œç¬¦åˆé¢„æœŸã€‚\næ€»ç»“ è¿™ç¯‡ä»…ä»…å±•ç¤ºäº† kube-ovn å¾ˆåŸºç¡€çš„åŠŸèƒ½ï¼ŒåŸºäº ovs/ovn çš„å¼ºå¤§èƒ½åŠ›ï¼Œkube-ovn è¿˜æä¾›äº†å…¶ä»–æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»å‚è€ƒå®˜æ–¹çš„ä½¿ç”¨æŒ‡å—ã€‚\nè²Œä¼¼åº”è¯¥è¦å¥½å¥½çœ‹çœ‹ ovs/ovn äº†ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/09/03/pexelseberhardgrossgasteiger673018.jpg","permalink":"https://atbug.com/run-kube-ovn-on-k3s/","tags":["Network","Kubernetes"],"title":"k3s ä¸Šçš„ kube-ovn è½»åº¦ä½“éªŒ"},{"categories":["äº‘åŸç”Ÿ"],"contents":"8 æœˆ 24 æ—¥ï¼Œå‘æ˜æœåŠ¡ç½‘æ ¼çš„å…¬å¸ Buoyant å‘å¸ƒäº† Linkerd 2.12ï¼Œè¿™æ˜¯æ—¶éš”è¿‘ä¸€å¹´çš„ç‰ˆæœ¬å‘å¸ƒã€‚ä¸çŸ¥é“å¤§å®¶çš„å¯¹æ–°ç‰ˆæœ¬æœŸå¾…å¦‚ä½•ï¼Œåœ¨æˆ‘æ¥çœ‹æ–°ç‰ˆæœ¬ä¸­çš„åŠŸèƒ½å¯¹äºä¸€å¹´çš„æ—¶é—´æ¥è¯´ç¡®å®ä¸ç®—å¤šï¼Œä½†æ˜¯æˆ‘æƒ³è¯´çš„æ˜¯ Linkerd è¿˜æ˜¯é‚£ä¸ª Linkerdï¼Œè¿˜æ˜¯ç§‰æŒç€ä¸€è´¯çš„ â€œKeep it simpleâ€ çš„è®¾è®¡ç†å¿µã€‚\næ–°ç‰ˆæœ¬çš„å†…å®¹ä¸ä¸€ä¸€ä»‹ç»ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„åŠŸèƒ½ï¼šper-route ç­–ç•¥ï¼Œç›¸æ¯”ä¸Šä¸ªç‰ˆæœ¬åŸºäºç«¯å£çš„ç­–ç•¥ï¼Œæ‰©å±•åˆ°äº† per-routeã€‚\nè€Œæˆ‘æƒ³è¯´çš„ç‰¹åˆ«ä¹‹å¤„ä¹Ÿå°±æ˜¯åœ¨ per-route å’Œç­–ç•¥ä¸Šã€‚\nper-route å’Œç­–ç•¥æœ‰ä½•ç‰¹åˆ«ä¹‹å¤„ï¼Ÿ åœ¨ã€ŠSMI ä¸ Gateway API çš„ GAMMA å€¡è®®æ„å‘³ç€ä»€ä¹ˆï¼Ÿã€‹ å±‚æœ‰è¿‡çŒœæƒ³ï¼šæœªæ¥æœåŠ¡ç½‘æ ¼çš„æ ‡å‡†æœ‰å¯èƒ½å…¨éƒ¨æˆ–è€…éƒ¨åˆ†ä»¥ Kubernetes åŸç”Ÿ API çš„æ–¹å¼å­˜åœ¨ã€‚\nâ€œç½‘å…³ APIï¼Œä¹‹äºé›†ç¾¤æ˜¯å…¥å£/å‡ºå£ç½‘å…³ï¼Œä¹‹äº Pod æ˜¯ inbound/outbound sidecarã€‚â€\nç°åœ¨æ¥çœ‹ï¼ŒLinkerd å…ˆè¿ˆå‡ºäº†è¿™ä¸€æ­¥ã€‚\nper-route è·¯ç”±ï¼ˆroutingï¼‰æ˜¯é€šè¿‡ç½‘ç»œå°†æµé‡ä»æºåœ°å€ä¼ è¾“åˆ°ç›®çš„åœ°çš„æ“ä½œã€‚ä¸åŒçš„æµé‡æœ‰ä¸åŒçš„æ“ä½œï¼ˆè·¯ç”±ï¼‰ï¼Œæµé‡è·¯ç”±çš„å‰ææ˜¯æµé‡çš„è¯†åˆ«ï¼Œé€šä¿—æ¥è®²å°±æ˜¯è¯·æ±‚çš„åŒ¹é…ã€‚å¯¹æœåŠ¡ç½‘æ ¼ä¸­å¸¸è§çš„ TCP æµé‡ï¼Œæœ‰æºåœ°å€ã€æºç«¯å£ã€ç›®çš„åœ°å€ã€ç›®çš„ç«¯å£ç­‰æ ‡è¯†ï¼›å¯¹äº HTTP æµé‡ï¼Œæ ‡è¯†åˆ™æ›´å¤šï¼šè·¯å¾„ã€æŠ¥å¤´ã€å‚æ•°ç­‰ç­‰ã€‚\nLinkerd é€šè¿‡ä¸€ä¸ª CRD ServiceProfile æä¾›äº† per-route çš„ æŒ‡æ ‡ã€é‡è¯•å’Œè¶…æ—¶è®¾ç½®ï¼Œè¯¥ CRD ä¸­å¯ä»¥é…ç½®åŒ¹é…è§„åˆ™æ¥è¿›è¡Œæµé‡çš„è¯†åˆ«ã€‚åœ¨æ–°çš„ per-route ç­–ç•¥ä¸­ï¼Œåˆ™åˆå¼•å…¥äº†æ–°çš„æµé‡è¯†åˆ«æœºåˆ¶ HTTPRoute ã€‚è¿™ä¸ª HTTPRoute å®é™…ä¸Šæ˜¯æ¥è‡ª Kubernetes Gateway APIï¼Œä»¥é•œåƒçš„æ–¹å¼ç»´æŠ¤åœ¨ policy.linkerd.io/v1alpha1 åŒ…ä¸­ã€‚\nè‡³äºä¸ºä½•è¦è‡ªå·±ç»´æŠ¤ HTTPRouteï¼Œåœ¨ Buoyant çš„å¦ä¸€ç¯‡åšå®¢ã€ŠLinkerd and the Gateway APIã€‹ ä¸­ä¹Ÿç»™å‡ºäº†ç­”æ¡ˆï¼šç›®å‰çš„ Gateway API è™½æ˜“å±•ç°å‡ºæˆä¸ºæ ‡å‡†çš„è®¾è®¡ï¼Œä½†è¿˜ä¸è¶³ä»¥æ»¡è¶³ç›®å‰çš„éœ€æ±‚ã€‚\nä¸ºä½•æ— æ³•æ»¡è¶³ç›®å‰çš„éœ€æ±‚ï¼Œè®©æˆ‘ä»¬ç»§ç»­æ¥çœ‹ç­–ç•¥ã€‚\nç­–ç•¥ 2.12 å¸¦æ¥çš„ per-route ç­–ç•¥æ˜¯æˆæƒç­–ç•¥ï¼ˆAuthorization Policyï¼‰ï¼Œé€šè¿‡ AuthorizationPolicy åŠå…¶ä»–å‡ ä¸ª CRD æ¥è¿›è¡Œé…ç½®ï¼Œä¸ HTTPRoute ä¸€èµ·ç»´æŠ¤åœ¨ policy.linkerd.io/v1alpha1 åŒ…ä¸­ã€‚ä»åŒ…åæ¥çœ‹ï¼Œpolicy.linkerd.io/v1alpha1 æ˜¯è€ƒè™‘åˆ°äº† Kubernetes Gateway API Policy Attachmentçš„è®¾è®¡ã€‚\nå›¾ç‰‡æ¥è‡ª Kubernetes Gateway API æ–‡æ¡£\nåœ¨æœåŠ¡ç½‘æ ¼çš„åŠŸèƒ½ä¸­æœ‰å¾ˆå¤šçš„ç­–ç•¥ï¼šè·¯ç”±ã€è®¤è¯/æˆæƒã€è¶…æ—¶ã€é‡è¯•ã€ç†”æ–­ã€é™æµã€æ•…éšœæ³¨å…¥ç­‰ç­‰ã€‚è€Œç›®å‰ Policy Attachment è¿˜åªæ˜¯æä¾›äº†æ¦‚å¿µè®¾è®¡ï¼Œå¯¹è¿™äº›ç­–ç•¥æ²¡æœ‰ä»»ä½•å…·ä½“çš„å®šä¹‰ã€‚å› æ­¤ Linkerd å°†å…¶ç»´æŠ¤åœ¨ policy.linkerd.io/v1alpha1 åŒ…ä¸­ï¼Œå¹¶ä¹è§‚åœ°ç›¸ä¿¡æœ‰ä¸€å¤©å…¶å¯ä»¥è¢« Kubernetes åŸç”Ÿçš„ CRD æ›¿ä»£ï¼Œä¸”åˆ‡æ¢çš„æˆæœ¬å¾®ä¸è¶³é“ã€‚\nåœ¨æ­¤æˆ‘ä¹ŸçŒœæƒ³ï¼ŒåŸæœ¬ ServiceProfile ä¸­çš„ç­–ç•¥ä¹Ÿä¼šè¢«åºŸå¼ƒï¼Œå¹¶è½¬ç§»åˆ°æ–°çš„åŒ…ä¸­ã€‚å› ä¸º ServiceProfile çš„è®¾è®¡æœ¬å°±ä¸å¤Ÿä¼˜é›…ï¼Œå°†æµé‡çš„æ ‡è¯†ä¸ç­–ç•¥è€¦åˆï¼ˆä¼°è®¡è¿™ä¹Ÿæ˜¯ Linkerd çš„ Keep it simple æ‰§å¿µï¼Œå°½é‡å°‘å®šä¹‰ CRDï¼‰ã€‚\næ— ç‹¬æœ‰å¶ æ¶æ„è®¾è®¡æ€»æ˜¯ä¼´éšç€å–èˆï¼Œåœ¨ç»“æ„åŒ–å’Œå¯æ‰©å±•æ€§é—´è¿›è¡Œç€å¹³è¡¡ã€‚Linkerd ç§‰æŒ Keep it simple çš„è®¾è®¡ç†å¿µï¼Œå°½é‡é¿å…å®šä¹‰è¿‡å¤šçš„ CRDï¼Œé™ä½å¤æ‚åº¦ã€‚ä¸åªæ˜¯è¿™æ¬¡çš„ HTTPRouteï¼Œå…¶æµé‡æ‹†åˆ†ä¸Šä½¿ç”¨äº†Service Mesh Interfaceï¼ˆSMIï¼‰çš„ TrafficSplit APIï¼ˆLinkerd æ”¯æŒ v1alpha2ï¼Œæœ€æ–°ä¸º v1alpha4ï¼‰ã€‚\nç®€åŒ–è®¾è®¡ï¼Œé™ä½å­¦ä¹ å’Œç»´æŠ¤çš„æˆæœ¬ï¼›é™ä½èµ„æºéœ€æ±‚ï¼Œé™ä½ä½¿ç”¨æˆæœ¬ï¼›æä¾›æœ€å°åŠŸèƒ½é›†ï¼Œâ€œå¤Ÿç”¨å°±å¥½â€ï¼Œå‡å°‘å†—ä½™åŠŸèƒ½å¸¦æ¥çš„æˆæœ¬æå‡ã€‚\næœåŠ¡ç½‘æ ¼é¢ä¸– 5 å¹´æ¥ï¼Œç”¨æˆ·é€æ¸æ„è¯†åˆ°â€œè½»ã€å¿«ã€æ˜“ç”¨â€å¯¹äºæœåŠ¡ç½‘æ ¼çš„é‡è¦æ€§ã€‚è¿™æ¡è·¯ä¸Š Linkerd å¹¶ä¸æ˜¯å­¤ç‹¬çš„ï¼Œå›½äº§çš„æœåŠ¡ç½‘æ ¼äº§å“ Flomesh å¼€æºçš„ osm-edge ä¹Ÿæ˜¯åŒæ ·çš„ç®€åŒ–è®¾è®¡ï¼Œè½»é‡çº§é«˜æ€§èƒ½çš„ sidecar ä»£ç†ï¼Œæ­¤å¤–è¿˜æœ‰ç€ï¼š\nå¼€æ”¾çš„æ§åˆ¶å¹³é¢è®¾è®¡ï¼Œé€šè¿‡æ‰©å±•æ”¯æŒæ›´å¤šçš„æœåŠ¡å‘ç°ã€‚ å¯ç¼–ç¨‹çš„sidecar ä»£ç† Pipyï¼ŒåŠŸèƒ½æ‰©å±•æ›´å®¹æ˜“ï¼›é™¤äº†ä½œä¸ºæœåŠ¡ç½‘æ ¼ä»£ç†ï¼Œè¿˜å¯ä»¥ç‹¬ç«‹ä½¿ç”¨ã€‚ åŸºäº SMI çš„å®ç°ã€‚SMI ä¸ Gateway API éƒ½æ˜¯åŒæ ·çš„æµé‡æ ‡è¯†ä¸ç­–ç•¥åˆ†ç¦»çš„è®¾è®¡ï¼Œç®€å•çš„å¯¹æ¯”å¯ä»¥çœ‹è¿™ç¯‡ã€‚ æ€»ç»“ è¿™ç¯‡æ–‡ç« æ˜¯ Linkerd 2.12 å‘è¡¨ä¹‹é™…çš„ä¸€äº›å¯å‘å’Œæ„Ÿæƒ³ï¼Œç‰ˆæœ¬å‘å¸ƒåªæ˜¯è¡¨é¢ï¼Œæ›´è¦æ¢å¯»è¡¨é¢ä¹‹å¤–çš„æ·±æ„ã€‚åˆ©ç”¨å‘¨æœ«çš„æ—¶é—´æ¥æŒ–æ˜ä¸€ä¸‹ï¼Œå†™ä¸‹è¿™ç¯‡ã€‚\nå†™ä½œçš„åŒæ—¶ï¼Œæœ‰ä¸€ä¸ªè¯æµ®å‡ºè„‘æµ·ï¼šè¿”ç’å½’çœŸã€‚ä¸‹ä¸€ç¯‡ï¼Œç›®å‰åªæƒ³åˆ°äº†æ ‡é¢˜ã€ŠæœåŠ¡ç½‘æ ¼ï¼šå°‘å³æ˜¯å¤šï¼ŒLess is moreã€‹ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/08/28/doorsg0b30f61201280.png","permalink":"https://atbug.com/thoughts-on-linkerd-release/","tags":["Service Mesh","Kubernetes"],"title":"å¦çœ¼æ—è§‚  Linkerd 2.12 çš„å‘å¸ƒï¼šæœåŠ¡ç½‘æ ¼æ ‡å‡†çš„æ›™å…‰ï¼Ÿ"},{"categories":["æºç è§£æ"],"contents":"æœ¬æ–‡çš„æºç åŸºäº Kubernetes v1.24.0ï¼Œå®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨ Containerd 1.5ï¼Œä»æºç æ¥åˆ†æ kubectl port-forward çš„å·¥ä½œåŸç†ã€‚\né€šè¿‡ port-forward æµç¨‹çš„åˆ†æï¼Œæ¢³ç†å‡º kubectl -\u0026gt; api-server -\u0026gt; kubelet -\u0026gt; å®¹å™¨è¿è¡Œæ—¶ çš„äº¤äº’ï¼Œäº†è§£ cri çš„å·¥ä½œæ–¹å¼ã€‚\nkubectl ç®€å•åˆ›å»ºä¸ª podï¼š\nkubectl run pipy --image flomesh/pipy:latest -n default åœ¨æ‰§è¡Œ kubectl forward æ—¶æ·»åŠ å‚æ•° -v 9 æ‰“å°æ—¥å¿—ã€‚\nkubectl port-forward pipy 8080 -v 9 ... I0807 21:45:58.457986 14495 round_trippers.go:466] curl -v -XPOST -H \u0026#34;User-Agent: kubectl/v1.24.3 (darwin/arm64) kubernetes/aef86a9\u0026#34; -H \u0026#34;X-Stream-Protocol-Version: portforward.k8s.io\u0026#34; \u0026#39;https://192.168.1.12:6443/api/v1/namespaces/default/pods/pipy/portforward\u0026#39; I0807 21:45:58.484013 14495 round_trippers.go:553] POST https://192.168.1.12:6443/api/v1/namespaces/default/pods/pipy/portforward 101 Switching Protocols in 26 milliseconds I0807 21:45:58.484029 14495 round_trippers.go:570] HTTP Statistics: DNSLookup 0 ms Dial 0 ms TLSHandshake 0 ms Duration 26 ms I0807 21:45:58.484035 14495 round_trippers.go:577] Response Headers: I0807 21:45:58.484040 14495 round_trippers.go:580] Upgrade: SPDY/3.1 I0807 21:45:58.484044 14495 round_trippers.go:580] X-Stream-Protocol-Version: portforward.k8s.io I0807 21:45:58.484047 14495 round_trippers.go:580] Date: Sun, 07 Aug 2022 13:45:58 GMT I0807 21:45:58.484051 14495 round_trippers.go:580] Connection: Upgrade Forwarding from 127.0.0.1:8080 -\u0026gt; 8080 Forwarding from [::1]:8080 -\u0026gt; 8080 ä»æ—¥å¿—å¯ä»¥çœ‹åˆ°è¯·æ±‚çš„åœ°å€ä¸º /api/v1/namespaces/default/pods/pipy/portforwardï¼Œå…¶ä¸­ portforward ä¸º pod èµ„æºçš„å­èµ„æºã€‚\nè¿™é‡Œä½¿ç”¨çš„åè®®æ˜¯ spdyã€‚\nkubectl æ­¤æ—¶ä¼šç›‘å¬æœ¬åœ°ç«¯å£ï¼ŒåŒæ—¶ä½¿ç”¨ pod å­èµ„æº portforward çš„ url åˆ›å»ºåˆ° api-server çš„è¿æ¥ã€‚\nå½“æœ¬åœ°ç«¯å£æœ‰è¿æ¥æ¥å…¥æ—¶ï¼Œkubectl ä¼šä¸æ–­åœ°åœ¨ä¸¤ä¸ªè¿æ¥é—´æ‹·è´æ•°æ®ã€‚\nå‚è€ƒæºç ï¼š staging/src/k8s.io/kubectl/pkg/cmd/portforward/portforward.go:389 staging/src/k8s.io/client-go/tools/portforward/portforward.go:242 staging/src/k8s.io/client-go/tools/portforward/portforward.go:330 api-server pod çš„ä¸‰ä¸ªå­èµ„æº execã€attach å’Œ portforwardï¼Œå¯¹è¿™ä¸‰ä¸ªèµ„æºçš„æ“ä½œéƒ½ä¼šä»£ç†æœ‰å¯¹åº” node çš„ kubetlet server è¿›è¡Œå¤„ç†ã€‚\napi-server åœ¨æ¥æ”¶åˆ°è®¿é—® pod å­èµ„æº portforward çš„è¯·æ±‚åï¼Œé€šè¿‡ pod åŠå…¶æ‰€åœ¨ node çš„ä¿¡æ¯ï¼Œè·å–è®¿é—®è¯¥ node ä¸Š kubelet server çš„ urlã€‚\nç„¶åå°†è®¿é—® pod çš„ portforward çš„è¯·æ±‚ï¼Œä»£ç†åˆ° kubelet serverã€‚\nå‚è€ƒæºç  pkg/registry/core/pod/rest/subresources.go:185 kubelet portforward è¯·æ±‚æ¥åˆ°äº† pod æ‰€åœ¨èŠ‚ç‚¹çš„ kubelet serverï¼Œåœ¨ kubelet server ä¸­ï¼Œæœ‰å‡ ä¸ªç”¨äºè°ƒè¯•çš„ endpointï¼Œportforward ä¾¿æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼š\n/run/{podNamespace}/{podID}/{containerName} /exec/{podNamespace}/{podID}/{containerName} /attach/{podNamespace}/{podID}/{containerName} /portforward/{podNamespace}/{podID} /containerLogs/{podNamespace}/{podID}/{containerName} /runningpods/ kubelet server æ”¶åˆ°è¯·æ±‚åï¼Œé¦–å…ˆä¼šé€šè¿‡ RuntimeServiceClient å‘é€ gRCP è¯·æ±‚åˆ°å®¹å™¨è¿è¡Œæ—¶çš„æ¥å£ï¼ˆ/runtime.v1alpha2.RuntimeService/PortForwardï¼‰è·å–å®¹å™¨è¿è¡Œæ—¶ streaming server å¤„ç† pordforward è¯·æ±‚çš„ urlã€‚\næ‹¿åˆ° portforward streaming çš„ url ä¹‹åï¼Œkubelet server å°†è¯·æ±‚ä»£ç†åˆ°è¯¥ urlã€‚\nå‚è€ƒæºç  pkg/kubelet/server/server.go:463 pkg/kubelet/server/server.go:873 pkg/kubelet/cri/streaming/portforward/portforward.go:46 pkg/kubelet/cri/streaming/server.go:111 cri è¿™é‡Œä»¥ Containerd ä¸ºä¾‹ã€‚\nContainerd åœ¨å¯åŠ¨æ—¶ä¼šå¯åŠ¨ runtime service å’Œ image serviceã€‚å‰è€…æ˜¯è´Ÿè´£å®¹å™¨ç›¸å…³çš„æ“ä½œï¼Œåè€…è´Ÿè´£é•œåƒç›¸å…³çš„æ“ä½œã€‚\nkubelet è·å–ç”¨äºç«¯å£è½¬å‘çš„ streaming urlï¼Œå°±æ˜¯è°ƒç”¨äº† runtime service çš„ gRPC æ¥å£å®Œæˆçš„ã€‚\né™¤äº†ä¸¤ä¸ª gRPC service ä»¥å¤–ï¼Œè¿˜åŠ è½½äº†ä¸€ç³»åˆ—æ’ä»¶ã€‚è¿™äº›æ’ä»¶ä¸­ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯ cri serviceã€‚\ncri service ä¼šå¯åŠ¨ streaming serverã€‚è¿™ä¸ª server ä¼šå“åº” /execã€/attach å’Œ /portforward çš„ stream è¯·æ±‚ã€‚\nportforward æ”¯æŒä¸¤ç§æ“ä½œç³»ç»Ÿ linux å’Œ windowsï¼šsandbox_portforward_linux.go å’Œ sandbox_portforward_windows.goã€‚\nåœ¨ linux ä¸Šï¼Œåœ¨ pod æ‰€åœ¨çš„ network namespace ä¸­ä½¿ç”¨åœ°å€ localhost åˆ›å»ºåˆ°ç›®æ ‡ç«¯å£çš„è¿æ¥ã€‚ç„¶ååœ¨ streaming server çš„è¿æ¥å’Œè¯¥è¿æ¥ä¹‹é—´æ‹·è´æ•°æ®ï¼Œå®Œæˆæ•°æ®çš„ä¼ é€’ã€‚\nåœ¨ windows ä¸Šï¼Œæ˜¯é€šè¿‡ wincat.exe ä½¿ç”¨åœ°å€ 127.0.0.1 åˆ›å»ºåˆ°ç›®æ ‡ç«¯å£çš„è¿æ¥ã€‚\nå‚è€ƒæºç  pkg/cri/streaming/server.go:149 pkg/cri/server/streaming.go:69 pkg/cri/server/service.go:138 pkg/cri/server/sandbox_portforward_linux.go:34 æ€»ç»“ ç»“åˆæºç åˆ†æå¯¹ port-foward å·¥ä½œåŸç†çš„æ¢³ç†ï¼Œç›¸ä¿¡å¯¹ cri çš„å·¥ä½œæ–¹å¼ä¹Ÿæœ‰äº†ä¸€å®šçš„äº†è§£ã€‚æœ¬æ–‡æ˜¯ä»¥å®¹å™¨è¿è¡Œæ—¶ Containerd ä¸ºä¾‹ï¼Œä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶è™½ç„¶å®ç°äº† criï¼Œä½†æ˜¯å®ç°çš„ç»†èŠ‚ä¸Šä¹Ÿä¼šæœ‰æ‰€å·®å¼‚ã€‚\næ¯”å¦‚åœ¨ port-forward çš„å®ç°ä¸Šï¼ŒKubernetes v1.23.0 ç‰ˆæœ¬ä¸­çš„ docker shimï¼ˆ1.24 ä¸­è¢«ç§»é™¤ï¼‰ ä¸­ï¼Œæ˜¯ä½¿ç”¨nsenter è¿›å…¥ pod æ‰€åœ¨çš„ network namespace ä¸­é€šè¿‡ socat å®Œæˆçš„ç«¯å£è½¬å‘ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/04/pexelscomputersourcecode.png","permalink":"https://atbug.com/how-kubectl-port-forward-works/","tags":["Kubernetes","Container","CRI"],"title":"æºç è§£æ kubectl port-forward å·¥ä½œåŸç†"},{"categories":["äº‘åŸç”Ÿ"],"contents":"å°±åœ¨ä¸Šå‘¨ Gateway API å‘å¸ƒç‰ˆæœ¬ 0.5.0ï¼Œå…¶ä¸­å‡ ä¸ªæœ€é‡è¦çš„ CRD Gatewayã€GatewayClass ä»¥åŠ HTTPRoute ç¬¬ä¸€æ¬¡å‡çº§åˆ°äº† beta ç‰ˆæœ¬ã€‚å‡çº§çš„è¯¦ç»†å†…å®¹è¿™é‡Œä¸åšè¯¦è°ˆï¼Œæˆ‘ä¹Ÿæƒ³è¯´è¯´çš„æ˜¯ä¸ç‰ˆæœ¬ä¸€åŒå‘å¸ƒçš„ï¼Œä¹Ÿæ˜¯å¾ˆå®¹æ˜“è¢«å¿½ç•¥çš„ç¤¾åŒºåˆä½œå€¡è®® GAMMAã€‚\nGAMMA æ˜¯ Gateway API Mesh Management and Administration çš„ç®€å†™ï¼Œè¿™ä¸ªè®¡åˆ’æ˜¯ Gateway API å­é¡¹ç›®ä¸­çš„ä¸€ä¸ªä¸“ç”¨å·¥ä½œæµã€‚è¿™ä¸ªå°ç»„çš„ç›®æ ‡æ˜¯è°ƒç ”ã€è®¾è®¡å’Œè·Ÿè¸ª Gateway API èµ„æºã€è¯­ä¹‰å’Œå…¶ä»–ä¸æœåŠ¡ç½‘æ ¼æŠ€æœ¯å’Œç”¨ä¾‹ç›¸å…³çš„ç»„ä»¶ã€‚æ­¤å¤–ï¼Œå°ç»„è¿˜åŠªåŠ›å€¡å¯¼æœåŠ¡ç½‘æ ¼é¡¹ç›®çš„ Gateway API å®ç°ä¹‹é—´çš„ä¸€è‡´æ€§ï¼Œæ— è®ºä½¿ç”¨ä½•ç§æŠ€æœ¯æ ˆæˆ–è€…ä»£ç†ã€‚\nå¯èƒ½ä½ ä¼šæœ‰ç–‘é—®å¦‚æ­¤ç®€å•ä¸€ä¸ªå€¡è®®ï¼Œæœ‰ä»€ä¹ˆç‰¹åˆ«ï¼Ÿæœ‰ä¸¤ç‚¹ï¼š\nè§„èŒƒçš„å‚ä¸ï¼šè¿™ä¸ªå€¡è®®ç”± SIG Networkï¼ˆGateway API æ‰€åœ¨çš„ Kubernetes SIGï¼‰ä¸æœåŠ¡ç½‘æ ¼ç¤¾åŒºå…±åŒå‘èµ·ï¼ŒæœåŠ¡ç½‘æ ¼ç¤¾åŒºæœ‰æ¥è‡ª Cilium Service Meshã€Consulã€Istioã€Kumaã€Linkerdã€SMIã€NGINX Service Mesh å’Œ Open Service Mesh çš„ä»£è¡¨ã€‚SMI ä¸å…¶ä»–å‡ ä¸ªä¸åŒï¼Œå®ƒæ˜¯æœåŠ¡ç½‘æ ¼çš„è§„èŒƒ APIï¼Œå¹¶éæ˜¯å®ç°ï¼ŒGateway API ä¹Ÿä¸€æ ·ã€‚ é¢å‘ä¸œè¥¿å‘æµé‡ï¼šå°ç»„çš„é¦–ä¸ªå·¥ä½œæ¢ç´¢ä½¿ç”¨ Gateway API å¤„ç†ä¸œè¥¿å‘æµé‡å·²ç»å¼€å§‹ã€‚ä¸œè¥¿å‘æµé‡ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡ç½‘æ ¼ä¸­æœåŠ¡åˆ°æœåŠ¡çš„æµé‡ã€‚ å¯è§ï¼ŒæœåŠ¡ç½‘æ ¼éƒ¨åˆ† API çš„ç»Ÿä¸€å°†è¿ˆè¿›ä¸€æ­¥ï¼Œä¸”æˆä¸º Kubernetes åŸç”Ÿ API çš„ä¸€å‘˜ã€‚å½“ç„¶ç°åœ¨è¿˜è¨€ä¹‹è¿‡æ—©ï¼Œè¿˜éœ€çœ‹å„ä¸ªå‚å•†çš„è·Ÿè¿›ç¨‹åº¦ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†åˆ«ä»è§„èŒƒï¼Œä»¥åŠå½“å‰çš„å®ç°ä¸¤ä¸ªè§’åº¦è¿›è¡Œåˆ†æã€‚\nè§„èŒƒ SMI ä¸ Gateway API ä¸€æ ·éƒ½æ˜¯è§„èŒƒï¼Œå‰è€…ç”¨äºæœåŠ¡ç½‘æ ¼ï¼Œè€Œåè€…ç”¨äºç½‘å…³ã€‚ä½†äºŒè€…åœ¨æµé‡è§„èŒƒçš„éƒ¨åˆ†å­˜åœ¨æ˜æ˜¾é‡å ï¼ˆè§ä¸‹å›¾ä¸­çº¢è‰²çš„éƒ¨åˆ†ï¼‰ï¼Œæµé‡è§„èŒƒå¯ä»¥å¯ä»¥ç†è§£ä¸ºæµé‡æ ‡è¯†ï¼ˆtraffic identifyï¼‰ã€‚æµé‡æ ‡è¯†ä½œä¸ºæµé‡ç®¡ç†çš„å…³é”®ï¼Œå°†æµé‡æ ‡è¯†ä¹‹åæ‰èƒ½è¿›è¡Œæµé‡è·¯ç”±ã€åˆ†æµã€é™æµç­‰æ“ä½œã€‚\nåœ¨ SMI issue 249 å‘èµ·äº†è®¨è®ºï¼Œå…³äº SMI èƒ½å¦ä½¿ç”¨ Gateway API çš„æµé‡è§„èŒƒï¼Œå°†ç²¾åŠ›é›†ä¸­åœ¨æœåŠ¡ç½‘æ ¼çš„è§„èŒƒä¸­ã€‚\nåªèƒ½è¯´ Gateway API ä½œä¸º Kubernetes çš„åŸç”Ÿ APIï¼Œæœ‰ç€æ›´å¼ºçš„è¯´æœåŠ›ï¼Œå…¶ä»–æœåŠ¡ç½‘æ ¼å‚å•†æ›´å®¹æ˜“æ¥çº³ã€‚\nå·²ç»å¯¹ SMI å’Œ Gateway API æœ‰äº†è§£çš„åŒå­¦ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡è§„èŒƒçš„ä»‹ç»ã€‚\næœåŠ¡ç½‘æ ¼çš„è§„èŒƒ SMI SMIï¼ˆService Mesh Interfaceï¼‰ é¦–æ¬¡ç™»åœºåœ¨ 2019 å¹´ï¼Œå¹¶äº 2020 å¹´åŠ å…¥ CNCFã€‚\nåœ¨å¼€æ”¾æœåŠ¡ç½‘æ ¼ Open Service Mesh å¦‚ä½•å¼€æ”¾ä¸€æ–‡ä¸­æ›¾ä»‹ç»è¿‡ SMIï¼Œæœ‰å…´è¶£çš„å¯ä»¥æµè§ˆå„ä¸ª API çš„è¯´æ˜åŠç¤ºä¾‹ã€‚\nSMI æ˜¯æœåŠ¡ç½‘æ ¼çš„è§„èŒƒï¼Œé‡ç‚¹å…³æ³¨åœ¨ Kubernetes ä¸Šè¿è¡Œçš„æœåŠ¡ç½‘æ ¼ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªå¯ä»¥ç”±å„ç§ä¾›åº”å•†ä½¿ç”¨çš„é€šç”¨æ ‡å‡†ã€‚å…è®¸æœ€ç»ˆç”¨æˆ·çš„æ ‡å‡†åŒ–å’ŒæœåŠ¡ç½‘æ ¼æŠ€æœ¯æä¾›å•†çš„åˆ›æ–°ã€‚SMI å®ç°äº†çµæ´»æ€§å’Œäº’æ“ä½œæ€§ï¼Œå¹¶æ¶µç›–äº†æœ€å¸¸è§çš„æœåŠ¡ç½‘æ ¼åŠŸèƒ½ã€‚\nSMI æä¾›äº† Kubernetes æœåŠ¡ç½‘æ ¼çš„æ ‡å‡†æ¥å£ã€å¸¸è§æœåŠ¡ç½‘æ ¼åœºæ™¯çš„åŸºæœ¬åŠŸèƒ½é›†ã€æ”¯æŒæœåŠ¡ç½‘æ ¼æ–°åŠŸèƒ½çš„çµæ´»æ€§ï¼Œä»¥åŠæœåŠ¡ç½‘æ ¼æŠ€æœ¯ç”Ÿæ€çš„åˆ›æ–°ç©ºé—´ã€‚\nSMI çš„ç›®æ ‡æ˜¯å°†æ¦‚å¿µä¸å®ç°éš”ç¦»å¼€æ¥ï¼Œåƒè½¯ä»¶å¼€å‘è¿‡å»ä¸€ç›´åšçš„é‚£æ ·ï¼Œå°†å¤æ‚çš„ä¸œè¥¿åˆ†å±‚æŠ½è±¡ã€‚\nSMI è§„èŒƒçš„æœ€æ–°ç‰ˆæœ¬æ˜¯ 0.6.0ï¼Œè¦†ç›–äº†å¸¸è§çš„æµé‡è®¿é—®æ§åˆ¶ã€é¥æµ‹ã€ç®¡ç†ç­‰åŸºç¡€æœåŠ¡ç½‘æ ¼èƒ½åŠ›ã€‚ä¸è§„èŒƒå¯¹åº”çš„æ˜¯ APIï¼Œå„ä¸ªç½‘æ ¼ä¾›åº”å•†åŸºäºè¯¥ API è¿›è¡Œå®ç°ã€‚\nKubernetes Gateway API Kubernetes Gateway APIæ˜¯ç”±SIG-NETWORK ç¤¾åŒºç®¡ç†çš„å¼€æºé¡¹ç›®ï¼Œæ˜¯ä¸€ç§è§„èŒƒï¼Œä¸æä¾›å®ç°ã€‚Gateway API è¢«è®¤ä¸ºæ˜¯ Kubernetes Ingress API çš„ç»§ä»»è€…ï¼Œåœ¨ 2019 å¹´çš„Ingress é©å‘½ä¸­é¦–æ¬¡è¢«æå‡ºï¼Œå¹¶åœ¨ 2020 å¹´ 11 æœˆå‘å¸ƒäº†ç¬¬ä¸€ä¸ªç‰ˆæœ¬ã€‚\nGateway API æ˜¯ä¸€ç³»åˆ—èµ„æºçš„é›†åˆï¼Œç›¸æ¯” Ingress APIï¼ŒGateway API æœ€å¤§çš„è¿›æ­¥å°±æ˜¯å°†æµé‡è§„èŒƒç‹¬ç«‹æˆ APIï¼Œå¤§å¤§æå‡äº†æ‰©å±•æ€§å’Œçµæ´»æ€§ã€‚ç›®å‰æä¾›äº† HTTPRouteã€TCPRouteã€UDPRoute å’Œ TLSRoute è§„èŒƒæ¥åŒ¹é…ç‰¹å®šåè®®çš„è§„åˆ™ã€‚\næµé‡è§„èŒƒç‹¬ç«‹ä¹‹åï¼Œç½‘å…³çš„å®ç°ã€åŸºç¡€è®¾æ–½çš„ç®¡ç†ä»¥åŠæµé‡è·¯ç”±çš„å®šä¹‰å¾—åˆ°äº†è§£è€¦åˆï¼Œè¿™å¾—ç›Šäº Gateway API é¢å‘è§’è‰²çš„ API è®¾è®¡ï¼š\nå‚å•†å®ç°äº†Gateway API å¹¶å®šä¹‰äº†è‡ªå·± GatewayClass ç±»å‹ï¼Œä¸€ç³»åˆ—çš„å®ç°å¯ä¾›é€‰æ‹©ã€‚ é›†ç¾¤ç®¡ç†å‘˜å®‰è£… Gateway API çš„å®ç°ï¼Œéƒ¨ç½²è·¨å‘½åç©ºé—´çš„å…±äº«ç½‘å…³å®ä¾‹ï¼Œæˆ–è€…å‘½åç©ºé—´ç‹¬äº«çš„ç½‘å…³å®ä¾‹ã€‚å¦‚ä¸‹å›¾ï¼Œé›†ç¾¤ç®¡ç†å‘˜éƒ¨ç½²äº†è·¨ store å’Œ site å‘½åç©ºé—´çš„ç½‘å…³ fooã€‚ å¼€å‘äººå‘˜åˆ›å»º HTTPRoute èµ„æºå°†æµé‡è·¯ç”±åˆ°æŒ‡å®šçš„åç«¯æœåŠ¡ã€‚ ç°æœ‰çš„æµé‡è§„èŒƒ è¿™é‡Œä¸»è¦è®¨è®ºçš„æ˜¯æœåŠ¡ç½‘æ ¼ä¸­æ‰€é¢å¯¹çš„ä¸œè¥¿å‘æµé‡ï¼Œéƒ¨åˆ†ä»£ç ç‰‡æ®µæ¥è‡ªæ¢ç´¢ä½¿ç”¨ Gateway API å¤„ç†ä¸œè¥¿å‘æµé‡ã€‚\nä»ä»£ç ç‰‡æ®µä¸éš¾çœ‹å‡ºï¼Œå‡ ä¹å„å®¶éƒ½æœ‰å„è‡ªç‰¹åˆ«çš„å®ç°ã€‚\nSMI TrafficSplit SMI çš„ TrafficSplit å®šä¹‰äº†æµé‡ä¸åç«¯æœåŠ¡ï¼ˆserviceï¼‰çš„æ˜ å°„å…³ç³»ï¼ˆè·¯ç”±ï¼‰ã€‚é€šè¿‡ service çš„ ClusterIP è¿›è¡Œæµé‡çš„åŒ¹é…ï¼Œç„¶åè¿›ä¸€æ­¥ä½¿ç”¨ HTTPRouteGroup å¯¹ HTTP æµé‡è¿›è¡ŒåŒ¹é…ã€‚å¹¶ä¸”ï¼ŒæœåŠ¡çš„æ˜ å°„é™åˆ¶åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹ã€‚\næ¯”å¦‚ä¸‹é¢ç¤ºä¾‹å°†è®¿é—® service website çš„å…¨éƒ¨ Firefox æµé‡è·¯ç”±åˆ° website-v2 æœåŠ¡ã€‚\nSMI çš„å®ç° osm ä¼šç©·ä¸¾å‡º spec.service ä¸ŠæŒ‡å®šçš„ service çš„æ‰€æœ‰ FQDNã€‚\nkind: TrafficSplit metadata: name: ab-test spec: service: website matches: - kind: HTTPRouteGroup name: ab-test backends: - service: website-v1 weight: 0 - service: website-v2 weight: 100 --- kind: HTTPRouteGroup metadata: name: ab-test matches: - name: firefox-users headers: user-agent: \u0026#34;.*Firefox.*\u0026#34; Istio VirtualService VirtualService ä¸­çš„æµé‡åŒ¹é…ä½¿ç”¨äº† hostsï¼Œè¿›ä¸€æ­¥é€šè¿‡ä¸€äº›åŸºäºåè®®çš„è§„åˆ™è¿›è¡ŒåŒ¹é…ã€‚ä¸åŒçš„æ˜¯ï¼Œåè®®è§„åˆ™çš„åŒ¹é…ä¸æ˜¯é€šè¿‡ç‹¬ç«‹çš„ CRD æ¥ç»´æŠ¤çš„ï¼Œè€Œæ˜¯è€¦åˆåœ¨ VirtualServiceä¸­ã€‚\nspec: hosts: - reviews.prod.svc.cluster.local # could also be just \u0026#34;reviews\u0026#34; http: - match: - uri: prefix: \u0026#34;/frontpage\u0026#34; route: - destination: host: frontpage.prod.svc.cluster.local Kuma TrafficRoute ä»é…ç½®ä¸Šå¯ä»¥çœ‹å‡ºæµé‡çš„åŒ¹é…æ˜¯é€šè¿‡ service çš„ ClusterIP å®ç°çš„ã€‚\nspec: sources: - match: kuma.io/service: backend_default_svc_80 destinations: - match: kuma.io/service: redis_default_svc_6379 conf: http: - match: â€¦ Cilium CiliumEnvoyConfig ä¸ Kuma ä¸€æ ·ï¼Œé€šè¿‡ service çš„ ClusterIP è¿›è¡Œæµé‡åŒ¹é…ã€‚ä½†ä¸åŒçš„æ˜¯ï¼Œæä¾›äº†è·¨å‘½åç©ºé—´çš„æµé‡è·¯ç”±ã€‚\nspec: services: - name: httpbin namespace: default listener: envoy-lb-listener backendServices: - name: echo namespace: default resources: â€¦ Consul ServiceRouter ä½¿ç”¨ ServiceRouter èµ„æºåï¼ˆwebï¼‰ä½œä¸º service åï¼Œç„¶åé€šè¿‡å…¶ ClusterIP è¿›è¡Œæµé‡åŒ¹é…ã€‚\napiVersion: consul.hashicorp.com/v1alpha1 kind: ServiceRouter metadata: name: web spec: routes: - match: http: pathPrefix: /admin destination: service: admin Linkerd ServiceProfile ServiceProfile å°†åå­—ä¸è¯·æ±‚çš„ Host å¤´è¿›è¡ŒåŒ¹é…ã€‚ç„¶å routes ä¸‹æŒ‚ä¸åŒçš„ endpoint å®šä¹‰ï¼ˆå¦‚ /adminã€/store ï¼‰ï¼Œåœ¨ endpoint çš„ç²’åº¦ä¸Šè¿›è¡Œ HTTP åè®®å±æ€§çš„åŒ¹é…ã€è¶…æ—¶ã€é‡è¯•ç­‰ç­–ç•¥çš„é…ç½®ã€‚\napiVersion: linkerd.io/v1alpha2 kind: ServiceProfile metadata: name: webapp.my-service-namespace.svc.cluster.local spec: routes: â€¦ æœªæ¥çš„è®¾è®¡ åœ¨çœ‹æœªæ¥çš„å¯èƒ½è®¾è®¡ä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹ Kubernetes Gateway API å¦‚ä½•å®Œæˆæµé‡åŒ¹é…çš„ï¼š\napiVersion: gateway.networking.k8s.io/v1beta1 kind: HTTPRoute metadata: name: my-route namespace: gateway-api-example-ns2 spec: parentRefs: - kind: Gateway name: foo-gateway namespace: gateway-api-example-ns1 hostnames: - foo.example.com rules: - backendRefs: - name: foo-svc port: 8080 ä» HTTPRoute çš„å®šä¹‰æ¥çœ‹ï¼Œå­˜åœ¨ç€ä¸¤ä¸ªæ˜ å°„ï¼ˆè¿™é‡Œçš„æ˜ å°„ï¼Œä¹Ÿå¯ä»¥çœ‹åšé™„ç€ç‚¹ï¼‰ï¼š\nä¸ç½‘å…³å®ç°ï¼ˆfoo-gateway.gateway-api-example-ns1ï¼‰çš„æ˜ å°„ï¼ˆé€šè¿‡ parentRefs å®ç°ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´å°†æµé‡åŒ¹é…è§„åˆ™å†™å…¥åˆ°å“ªä¸ªç½‘å…³å®ä¾‹ã€‚ ä¸æœåŠ¡ï¼ˆfoo-svc:8080ï¼‰çš„æ˜ å°„ï¼ˆé€šè¿‡ hostnames å®ç°ï¼‰ã€‚ é€šè¿‡ HTTPRoute ä¸Šçš„é™„ç€ç‚¹ï¼Œå°†é€šè¿‡ç½‘å…³å®ç°è¿›å…¥çš„æµé‡ï¼Œä¸åç«¯æœåŠ¡è¿›è¡Œå…³è”ã€‚å…ˆé€šè¿‡ spec.hostnames è¿›è¡Œæµé‡çš„åŒ¹é…ï¼Œç„¶åå†ç”± spec.rules ä¸­çš„åŒ¹é…è§„åˆ™å®Œæˆåè®®å±æ€§çš„åŒ¹é…ã€‚HTTP åè®®å¯ä»¥ä½¿ç”¨ methodã€pathã€å‚æ•°ã€è¯·æ±‚å¤´è¿›è¡ŒåŒ¹é…ï¼Œå®Œæˆ 7 å±‚çš„è·¯ç”±ã€‚\nä¸œè¥¿å‘æµé‡ åœ¨ä¸œè¥¿å‘æµé‡çš„åœºæ™¯ï¼Œéœ€è¦å®ç°ï¼š\nä¸ç½‘æ ¼å®ç°çš„æ˜ å°„ï¼Œå°†æµé‡åŒ¹é…è§„åˆ™å†™å…¥åˆ°æŸç§ç½‘æ ¼çš„ sidecar ä¸­ã€‚ ä¸æœåŠ¡çš„æ˜ å°„ï¼Œå¦‚ä½•å°†è¿›å…¥åˆ°ç½‘æ ¼ sidecar æµé‡ä¸ç›®æ ‡æœåŠ¡ï¼ˆç½‘æ ¼å†…çš„æœåŠ¡ï¼Œæˆ–è€…ç½‘æ ¼å¤–çš„æœåŠ¡ï¼‰è¿›è¡ŒåŒ¹é…ã€‚ å› æ­¤éœ€è¦ä¸€ç§è®¾è®¡æˆ–è€… CRD æ¥æ‰¿è½½å¦‚ä¸Šçš„å…³ç³»ï¼Œæˆªæ­¢å‘ç¨¿æ—¶ç›®å‰åœ¨æ¢ç´¢ä½¿ç”¨ Gateway API å¤„ç†ä¸œè¥¿å‘æµé‡ä¸­å·²ç»æœ‰ 5 ç§æ–¹å¼æ¥å®ç°ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥äº†è§£ä¸€ä¸‹ã€‚\næ€»ç»“ è¿˜æ˜¯é‚£å¥è¯ï¼Œæœ€ç»ˆä¼šä½¿ç”¨ä½•ç§æ–¹å¼ï¼Œéƒ½ä¸ºæ—¶å°šæ—©ã€‚\nä½†å·²çŸ¥çš„æ˜¯ï¼Œç›®å‰ç¤¾åŒºä¹Ÿæ„è¯†åˆ°æœåŠ¡ç½‘æ ¼æ˜¯å®ç°ä¸Šçš„åˆ†è£‚ï¼Œè€Œæœªæ¥æœåŠ¡ç½‘æ ¼çš„æ ‡å‡†æœ‰å¯èƒ½å…¨éƒ¨æˆ–è€…éƒ¨åˆ†ä»¥ Kubernetes åŸç”Ÿ API çš„æ–¹å¼å­˜åœ¨ã€‚å¦‚æœæ˜¯åè€…ï¼Œæˆ‘è®¤ä¸º SMI ä¼šæœ‰èµ°å‡ºæ¥çš„å¯èƒ½ã€‚æ­£å¦‚åœ¨å¼€æ”¾æœåŠ¡ç½‘æ ¼ Open Service Mesh å¦‚ä½•å¼€æ”¾ä¸­ï¼Œè°ˆåŠè¾ƒå¤šçš„æ ‡å‡†ä¸å¼€æ”¾å…³ä¹ç€ç”Ÿæ€çš„å‘å±•ã€åˆ›æ–°ã€æ‰©å±•æ€§å’Œçµæ´»æ€§ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/07/22/pexelsananddandekar1532771.jpg","permalink":"https://atbug.com/why-smi-collaborating-in-gateway-api-gamma/","tags":["Kubernetes","Service Mesh"],"title":"SMI ä¸ Gateway API çš„ GAMMA å€¡è®®æ„å‘³ç€ä»€ä¹ˆï¼Ÿ"},{"categories":["ç¬”è®°"],"contents":"GitHub Actions æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€â€œå…è´¹â€ çš„ CIï¼ˆæŒç»­é›†æˆï¼‰å·¥å…·ã€‚\nä¸ä¹‹å‰ä»‹ç»çš„ Tekton ç±»ä¼¼ï¼ŒGitHub Actions çš„æ ¸å¿ƒä¹Ÿæ˜¯ Pipeline as Code ä¹Ÿå°±æ˜¯æ‰€è°“çš„æµæ°´çº¿å³ä»£ç ã€‚äºŒè€…ä¸åŒçš„æ˜¯ï¼ŒGitHub Actions æœ¬èº«å°±æ˜¯ä¸€ä¸ª CI å¹³å°ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ä»£ç æ¥å®šä¹‰æµæ°´çº¿å¹¶åœ¨å¹³å°ä¸Šè¿è¡Œï¼›è€Œ Tekton æœ¬èº«æ˜¯ä¸€ä¸ªç”¨äºæ„å»º CI/CD å¹³å°çš„å¼€æºæ¡†æ¶ã€‚\nPipeline as Codeï¼Œæ—¢ç„¶ä¸ä»£ç æ‰¯ä¸Šäº†å…³ç³»ã€‚é‚£æµæ°´çº¿çš„å®šä¹‰å°±å¯ç¹å¯ç®€äº†ï¼Œå®Œå…¨çœ‹éœ€æ±‚ã€‚å°åˆ°ä¸€ä¸ª GitHub Pagesï¼Œå¤§åˆ°æµç¨‹å¤æ‚çš„é¡¹ç›®éƒ½å¯ä»¥ä½¿ç”¨ GitHub Actions æ¥æ„å»ºã€‚\næœ¬ç¯‡æ–‡ç« ä¸ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨ GitHub Actions çš„ï¼Œå¦‚æœè¿˜æœªç”¨è¿‡çš„åŒå­¦å¯ä»¥æµè§ˆä¸‹å®˜æ–¹çš„æ–‡æ¡£ã€‚ä»Šå¤©ä¸»è¦æ¥åˆ†äº«ä¸‹å¦‚ä½•åœ¨ Kubernetes ä¸Šçš„è‡ªæ‰˜ç®¡èµ„æºæ¥æ‰§è¡Œæµæ°´çº¿ä½œä¸šã€‚\n0x01 èƒŒæ™¯ åœ¨ä»‹ç» GitHub Actions çš„æ—¶å€™ï¼Œå…è´¹å¸¦ä¸Šäº†å¼•å·ï¼Œä¸ºä½•ï¼Ÿå…¶ä½œä¸ºä¸€ä¸ª CI å·¥å…·ï¼Œå…è®¸ç”¨æˆ·å®šä¹‰æµæ°´çº¿å¹¶åœ¨å¹³å°ä¸Šè¿è¡Œï¼Œéœ€è¦æ¶ˆè€—è®¡ç®—ã€å­˜å‚¨ã€ç½‘ç»œç­‰èµ„æºï¼Œè¿™äº›è¿è¡Œæµæ°´çº¿çš„æœºå™¨ç§°ä¸º Runnerã€‚GitHub ä¸ºä¸åŒç±»ï¼ˆç­‰ï¼‰å‹ï¼ˆçº§ï¼‰çš„ç”¨æˆ·æ¯æœˆæä¾›äº†ä¸åŒçš„å…è´¹é¢åº¦ï¼ˆé¢åº¦ç”¨å®Œåï¼Œæ¯åˆ†é’Ÿ 0.008 ç¾å…ƒã€‚ï¼‰ï¼Œè§ä¸‹å›¾ã€‚ä¸åŒç±»å‹çš„ä¸»æœºï¼Œåˆ†é’Ÿæ•°çš„æ¶ˆè€—å€æ•°ä¹Ÿä¸åŒï¼šLinux ä¸º 1ã€macOS ä¸º 10ã€Windows ä¸º 2ã€‚\næ‹¿å…è´¹ç”¨æˆ·æ¥çœ‹ï¼Œæ¯æœˆ 2000 åˆ†é’Ÿçœ‹ä¼¼ä¹Ÿä¸å°‘ã€‚æ¯”å¦‚ç¬”è€…ä¸ªäººå°±æ˜¯æ‹¿æ¥æ„å»ºä¸‹åšå®¢é™æ€é¡µé¢ï¼Œä»¥åŠå‡ ä¸ªç®€å•çš„åº”ç”¨ï¼Œæ¯ä¸ªæœˆä¹Ÿç”¨ä¸äº†å¤ªå¤šã€‚ä½†å¯¹äºä¼ä¸šæˆ–è€…ç»„ç»‡æ¥è¯´ï¼Œå°¤å…¶æ˜¯å½“æµæ°´çº¿çš„è§¦å‘é¢‘ç¹ï¼ˆæ¯æ¬¡ä»£ç æäº¤è§¦å‘ï¼‰ã€æˆ–è€…é¡¹ç›®çš„å•å…ƒæµ‹è¯•è€—æ—¶å¾ˆé•¿ï¼ˆbug å¼•èµ·çš„æˆ–è€…é¡¹ç›®æœ¬èº«çš„å¤æ‚åº¦æ‰€è‡´ï¼‰ï¼Œç§¯å°‘æˆå¤šä¹Ÿä¼šå˜æˆä¸€ç¬”ä¸å°çš„å¼€æ”¯ã€‚\né‚£æœ‰æ²¡æœ‰åŠæ³•ä½¿ç”¨è‡ªå·±çš„èµ„æºæ¥è¿è¡Œæµæ°´çº¿å‘¢ï¼Ÿæœ‰ã€‚GitHub Actions Runner åˆ†ä¸ºä¸¤ç§ï¼šGithub æ‰˜ç®¡çš„ Runner å’Œè‡ªæ‰˜ç®¡çš„ Runnerã€‚æˆ‘ä»¬å¯ä»¥å°†è‡ªå·±çš„èµ„æºä½œä¸ºè‡ªæ‰˜ç®¡çš„ Runner æ¥è¿è¡Œæµæ°´çº¿ï¼Œè€Œä¸”è¿˜å¯ä»¥å€ŸåŠ© Kubernetes çš„èƒ½åŠ›æ¥ç®¡ç†è¿™äº› Runnerã€‚\nåŒæ—¶ï¼Œè‡ªæ‰˜ç®¡ Runner ä¹Ÿé€‚åˆé‚£äº›å¯¹ CI æœ‰æ›´é«˜è¦æ±‚çš„ç”¨æˆ·ï¼Œæ¯”å¦‚æ›´é«˜æ€§èƒ½ã€æ›´å¤šç±»å‹çš„è®¡ç®—èµ„æºç­‰ç­‰ã€‚\n0x02 å‡†å¤‡å·¥ä½œ Kubernetes é›†ç¾¤ æˆ‘ä»¬ä½¿ç”¨ k3s å¿«é€Ÿåˆ›å»ºä¸€ä¸ªå•èŠ‚ç‚¹çš„é›†ç¾¤ã€‚\nexport INSTALL_K3S_VERSION=v1.22.11+k3s2 curl -sfL https://get.k3s.io | sh -s - --disable traefik --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config ä½¿ç”¨ Github Actions æ„å»ºçš„é¡¹ç›® è¿™é‡Œä½¿ç”¨ä¹‹å‰åšçš„ä¸€ä¸ª graalvm+maven çš„åŸºç¡€é•œåƒä»“åº“æ¥è¿›è¡Œæµ‹è¯•ï¼šhttps://github.com/addozhang/docker-graalvm-mavenã€‚\nGitHub Access Token å‚è€ƒæ–‡æ¡£ï¼Œåˆ›å»º Access Tokenã€‚\næ³¨æ„ï¼šé‰´äºæœ¬æ¼”ç¤ºçš„éœ€è¦ï¼Œåˆ†é…å®Œå…¨çš„ repo è®¿é—®æƒé™ã€‚\n0x03 åˆ›å»º Runner GitHub Actions Runner çš„ç¨‹åºæºç æ˜¯å¼€æºçš„ï¼ŒGitHub æ‰˜ç®¡çš„ Runner ä¹Ÿæ˜¯ä½¿ç”¨è¯¥ç¨‹åºè¿è¡Œçš„ã€‚\nRunner å¯ä»¥æ˜¯æŸä¸ªä»“åº“ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç”±ç»„ç»‡ä¸‹çš„æ‰€æœ‰ä»“åº“å…±äº«ã€‚é‰´äºè¿™é‡Œæ¼”ç¤ºç”¨çš„é¡¹ç›®ï¼Œæˆ‘ä»¬ä¸ºä¸Šé¢æåˆ°çš„é¡¹ç›®ä»“åº“åˆ›å»º Runnerã€‚\nRunner åœ¨å¯åŠ¨æ—¶ï¼Œä¼šé€šè¿‡ GitHub API å°†è‡ªå·±æ³¨å†Œåˆ° GitHub Actionsï¼›ç„¶åä¸æ–­å‘é€è¯·æ±‚åˆ° GitHub æŸ¥çœ‹æ˜¯å¦åˆ†é…äº†æµæ°´çº¿ä½œä¸šï¼Œå¦‚æœ‰åˆ™ä¼šæ‰§è¡Œæµæ°´çº¿ä½œä¸šï¼›Runner åœæ­¢è¿è¡Œæ—¶ï¼Œéœ€è¦è¿›è¡Œæ³¨é”€çš„æ“ä½œã€‚è¿™é‡Œçš„ä¸€ç³»åˆ—æ“ä½œï¼Œéƒ½ä¼šç”¨åˆ°ä¸Šé¢åˆ›å»ºçš„ Access Tokenã€‚\nè¦åœ¨ Kubernetes ä¸Šè¿è¡Œï¼Œæˆ‘ä»¬è¦å°† Runner åº”ç”¨ä»¥åŠä¸Šé¢çš„é€»è¾‘æ‰“æˆé•œåƒï¼Œå¹¶ä»¥ Deployment çš„æ–¹å¼éƒ¨ç½²åˆ° Kubernetes ä¸­ã€‚ç„¶åé€šè¿‡ workflow ä½œä¸š webhook æŸ¥çœ‹æ’é˜Ÿçš„ä½œä¸šæ•°æ¥å†³å®šæ˜¯å¦å¢åŠ æˆ–è€…å‡å°‘ Deployment çš„å‰¯æœ¬æ•°ã€‚\nå¬èµ·æ¥å°±æœ‰äº›å¤æ‚ï¼Œä½†ç¡®å®æ˜¯å®ç°çš„åŸºæœ¬æ–¹å¼ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª Kubernetes controller actions-runner-controller/actions-runner-controller æ¥å®ç°æ‰€æœ‰çš„æµç¨‹ã€‚\nactions-runner-controller æä¾›äº†ä¸‰ç§ CRDï¼š\nRunnerï¼šå¯ä»¥ç†è§£ä¸º Podï¼Œè¯¥ Runner åªèƒ½æ‰§è¡Œä¸€æ¬¡ä½œä¸šã€‚ RunnerDeploymentsï¼šå¯ä»¥ç†è§£ä¸º Deploymentï¼Œå¯ä»¥è®¾ç½®è¦åˆ›å»ºçš„ Runner æ•°é‡ã€‚Runner åœ¨æ‰§è¡Œå®Œä½œä¸šåä¼šé”€æ¯ï¼Œç„¶å Controller ä¼šåˆ›å»ºæ–°çš„ Runner ç­‰å¾…ä½œä¸šè°ƒåº¦ã€‚ RunnerSetsï¼šå¯ä»¥ç†è§£ä¸º StatefulSetï¼Œä¹Ÿæ˜¯åŸºäº StatefulSet æ¥åˆ›å»º Podï¼ˆå³ Runnerï¼‰ï¼Œæä¾› StatefulSet çš„ç‰¹æ€§ã€‚ æ›´å¤šç”¨æ³•ï¼Œå¯ä»¥å‚è€ƒ actions-runner-controller å®˜æ–¹æ–‡æ¡£ã€‚\néƒ¨ç½² Cert Manager actions-runner-controller çš„è¿è¡Œï¼Œéœ€è¦ä½¿ç”¨ cert-manangerã€‚é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥éƒ¨ç½²ï¼š\nkubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.8.2/cert-manager.yaml æ£€æŸ¥ pod æ˜¯å¦æˆåŠŸå¯åŠ¨ï¼š\nkubectl get pods -n cert-manager NAME READY STATUS RESTARTS AGE cert-manager-66b646d76-7b9fz 1/1 Running 0 18s cert-manager-cainjector-59dc9659c7-rzlrl 1/1 Running 0 18s cert-manager-webhook-7d8f555998-6zkqp 1/1 Running 0 18s å¯åŠ¨ Controller æ¥ä¸‹æ¥å°±æ˜¯å¯åŠ¨ controllerï¼Œæœ¬æ–‡å‘å¸ƒæ—¶çš„æœ€æ–°ç‰ˆæœ¬æ˜¯ v0.25.0ã€‚ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤éƒ¨ç½² controllerï¼š\nkubectl create -f https://github.com/actions-runner-controller/actions-runner-controller/releases/download/v0.25.0/actions-runner-controller.yaml æ³¨ï¼šè¿™é‡Œä½¿ç”¨çš„ create è€Œé applyã€‚ä½¿ç”¨ apply ä¼šæŠ¥ç±»ä¼¼ä¸‹é¢çš„é”™è¯¯ï¼š Error from server (Invalid): error when creating \u0026ldquo;https://github.com/actions-runner-controller/actions-runner-controller/releases/download/v0.25.0/actions-runner-controller.yaml\u0026quot;: CustomResourceDefinition.apiextensions.k8s.io \u0026ldquo;runnerdeployments.actions.summerwind.dev\u0026rdquo; is invalid: metadata.annotations: Too long: must have at most 262144 bytes\næ­¤æ—¶ï¼Œpod æ— æ³•å¯åŠ¨ï¼Œè¿˜éœ€è¦ä¸ºå…¶åˆ›å»º Secret æ¥æä¾› GitHub Access Tokenï¼š\nexport GITHUB_TOKEN=\u0026lt;TOKEN_HERE\u0026gt; kubectl create secret generic controller-manager \\ -n actions-runner-system \\ --from-literal=github_token=${GITHUB_TOKEN} ç°åœ¨å¯ä»¥çœ‹åˆ° pod å¯ä»¥æˆåŠŸè¿è¡Œï¼š\nkubectl get pods -n actions-runner-system NAME READY STATUS RESTARTS AGE controller-manager-58c598f64d-27xn6 2/2 Running 0 40s åˆ›å»º Runner æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º building-runner çš„ Runner CRã€‚\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: actions.summerwind.dev/v1alpha1 kind: Runner metadata: name: building-runner spec: repository: addozhang/docker-graalvm-maven env: [] EOF æ­¤æ—¶ï¼Œä¼šå‘ç° controller åˆ›å»ºäº†ä¸€ä¸ªåŒåçš„ podï¼š\nkubectl get pods -l actions-runner=\u0026#34;\u0026#34; -n actions-runner-system NAME READY STATUS RESTARTS AGE building-runner 2/2 Running 0 16s åœ¨ä»“åº“çš„ Settings/Actions/Runners ä¸­å¯ä»¥çœ‹åˆ°åŒåçš„ Runnerï¼Œå¤„äº idle çŠ¶æ€ã€‚\nå‡å¦‚æ­¤æ—¶å¯åŠ¨æµæ°´çº¿ä½œä¸šï¼Œä¼šå‘ç°ä½œä¸šå¹¶æ²¡æœ‰è°ƒåº¦è¯¥ Runner ä¸Šã€‚è¿™æ˜¯å› ä¸ºè¿˜æ²¡æœ‰å°†ä½œä¸š Runner çš„ label è®¾ç½®ä¸ºè¯¥ runner çš„ labelï¼šself-hostedã€Linuxã€ X64ã€‚\nä¿®æ”¹æµæ°´çº¿å®šä¹‰ï¼Œå°† runs-on æŒ‡å®šä¸º [self-hosted, linux, X64]ï¼š\nç„¶åå¯ä»¥æŸ¥çœ‹ä½œä¸šæˆåŠŸè°ƒåº¦åˆ°è¯¥ runner ä¸Šè¿è¡Œï¼š\nç°åœ¨å†å»çœ‹ pod çš„çŠ¶æ€ï¼Œå…¶ä¸­çš„ runner å®¹å™¨æ˜¯ Completedï¼š\nkubectl get pods -l actions-runner=\u0026#34;\u0026#34; -n actions-runner-system NAME READY STATUS RESTARTS AGE building-runner 1/2 Running 0 3m53s æ­¤æ—¶ï¼Œå†å»è§¦å‘æµæ°´çº¿æ‰§è¡Œï¼Œä½œä¸šä¼šä¸€ç›´ç­‰å¾…å¯ç”¨çš„ runner æ¥æ‰§è¡Œï¼š\nrunner æ— æ³•é‡å¤ä½¿ç”¨ï¼Œæ€ä¹ˆåŠï¼Ÿ\n0x04 å¯é‡ç”¨ Runner RunnerDeployment è¦æ´¾ä¸Šç”¨åœºäº†ï¼Œå‰é¢æåˆ°å¯ä»¥å°† RunnerDeployments ç†è§£ä¸º Deploymentï¼Œå¯ä»¥è®¾ç½®è¦åˆ›å»ºçš„ Runner æ•°é‡ã€‚Runner åœ¨æ‰§è¡Œå®Œä½œä¸šåä¼šé”€æ¯ï¼Œç„¶å Controller ä¼šåˆ›å»ºæ–°çš„ Runner ç­‰å¾…ä½œä¸šè°ƒåº¦ã€‚\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: actions.summerwind.dev/v1alpha1 kind: RunnerDeployment metadata: name: building-runner spec: template: spec: repository: addozhang/docker-graalvm-maven env: [] EOF ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤åˆ›å»º RunnerDeployment ä¹‹åï¼Œcontroller ä¼šåˆ›å»ºæ–°çš„ podï¼ˆrunnerï¼‰å¹¶å¾—åˆ°ä½œä¸šçš„è°ƒåº¦ï¼›å®Œæˆä½œä¸šçš„æ‰§è¡Œåï¼Œpod building-runner-9k4cj-ml46v è¢«é”€æ¯ï¼Œæ–°çš„ pod building-runner-9k4cj-f8twz è¢«åˆ›å»ºå¹¶ç­‰å¾…ä½œä¸šçš„è°ƒåº¦ï¼š\nkubectl get events --sort-by=\u0026#39;metadata.creationTimestamp\u0026#39; ... 3m7s Normal PodCreated runner/building-runner-9k4cj-ml46v Created pod \u0026#39;building-runner-9k4cj-ml46v\u0026#39; 3m6s Normal Scheduled pod/building-runner-9k4cj-ml46v Successfully assigned actions-runner-system/building-runner-9k4cj-ml46v to ubuntu-dev1 3m7s Normal RegistrationTokenUpdated runner/building-runner-9k4cj-ml46v Successfully update registration token 3m6s Normal Pulling pod/building-runner-9k4cj-ml46v Pulling image \u0026#34;summerwind/actions-runner:latest\u0026#34; 3m3s Normal Started pod/building-runner-9k4cj-ml46v Started container docker 3m3s Normal Pulled pod/building-runner-9k4cj-ml46v Successfully pulled image \u0026#34;summerwind/actions-runner:latest\u0026#34; in 3.06531539s 3m3s Normal Created pod/building-runner-9k4cj-ml46v Created container runner 3m3s Normal Started pod/building-runner-9k4cj-ml46v Started container runner 3m3s Normal Created pod/building-runner-9k4cj-ml46v Created container docker 3m3s Normal Pulled pod/building-runner-9k4cj-ml46v Container image \u0026#34;docker:dind\u0026#34; already present on machine 2m6s Normal RegistrationTokenUpdated runner/building-runner-9k4cj-f8twz Successfully update registration token 2m6s Normal PodCreated runner/building-runner-9k4cj-f8twz Created pod \u0026#39;building-runner-9k4cj-f8twz\u0026#39; 2m5s Normal Scheduled pod/building-runner-9k4cj-f8twz Successfully assigned actions-runner-system/building-runner-9k4cj-f8twz to ubuntu-dev1 2m5s Normal Pulling pod/building-runner-9k4cj-f8twz Pulling image \u0026#34;summerwind/actions-runner:latest\u0026#34; 2m5s Normal Killing pod/building-runner-9k4cj-ml46v Stopping container docker 2m3s Normal Pulled pod/building-runner-9k4cj-f8twz Successfully pulled image \u0026#34;summerwind/actions-runner:latest\u0026#34; in 2.50468863s 2m3s Normal Created pod/building-runner-9k4cj-f8twz Created container runner 2m3s Normal Started pod/building-runner-9k4cj-f8twz Started container runner 2m3s Normal Pulled pod/building-runner-9k4cj-f8twz Container image \u0026#34;docker:dind\u0026#34; already present on machine 2m3s Normal Created pod/building-runner-9k4cj-f8twz Created container docker 2m3s Normal Started pod/building-runner-9k4cj-f8twz Started container docker å‰é¢åˆ›å»º RunnerDeployment çš„æ—¶å€™æ²¡æœ‰æŒ‡å®šå‰¯æœ¬æ•°ï¼Œä¹Ÿå°±æ˜¯ runner çš„æ•°é‡ï¼Œcontroller åªåˆ›å»ºäº†ä¸€ä¸ª Runnerã€‚å‡è®¾è¿™ä¸ª RunnerDeployment æ˜¯æŸä¸ªç»„ç»‡ä¸‹å¤šä¸ªé¡¹ç›®å…±ç”¨çš„ï¼Œå¤šä¸ªé¡¹ç›®åŒæ—¶æ‰§è¡Œä½œä¸šä¼šæ€æ ·ï¼Ÿ\nè¿™é‡Œæˆ‘é‡æ–°è¿è¡Œ 3 ä¸ªå·²ç»å®Œæˆçš„ä½œä¸šï¼Œæ¨¡æ‹Ÿä½œä¸šçš„å¹¶å‘ï¼š\ncurl -X POST -H \u0026#34;Accept: application/vnd.github+json\u0026#34; -H \u0026#34;Authorization: token ${GITHUB_TOKEN}\u0026#34; https://api.github.com/repos/addozhang/docker-graalvm-maven/actions/runs/2643982502/rerun curl -X POST -H \u0026#34;Accept: application/vnd.github+json\u0026#34; -H \u0026#34;Authorization: token ${GITHUB_TOKEN}\u0026#34; https://api.github.com/repos/addozhang/docker-graalvm-maven/actions/runs/2643982274/rerun curl -X POST -H \u0026#34;Accept: application/vnd.github+json\u0026#34; -H \u0026#34;Authorization: token ${GITHUB_TOKEN}\u0026#34; https://api.github.com/repos/addozhang/docker-graalvm-maven/actions/runs/2643982274/rerun æˆ–è€… push å‡ ä¸ªç©ºçš„æäº¤åˆ°ä»“åº“ï¼ˆä¸æ¨èï¼Œä¼šæœ‰ commit å†å²ã€‚æµ‹è¯•é¡¹ç›®éšæ„ï¼‰ï¼š\ngit commit --allow-empty -m \u0026#34;trigger action\u0026#34; git push å» Actions åˆ—è¡¨ä¼šå‘ç°ï¼Œåªæœ‰ä¸€ä¸ªä½œä¸šåœ¨è¿è¡Œï¼Œå…¶ä»–ä¸¤ä¸ªéƒ½æ˜¯ queued çš„ç­‰å¾…çŠ¶æ€ã€‚å‰é¢çš„ä½œä¸šæ‰§è¡Œå®Œæˆåï¼Œåä¸€ä¸ªä½œä¸šæ‰ä¼šè¢«æ‰§è¡Œã€‚\nä¸æ”¯æŒå¹¶å‘ï¼Ÿæ—¢ç„¶æ˜¯ç±»ä¼¼ Deployment çš„æ–¹å¼è¿è¡Œ runnerï¼Œé‚£æ˜¯å¦æœ‰ç±»ä¼¼ HPAï¼ˆæ°´å¹³ pod è‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰çš„åŠŸèƒ½ï¼Ÿ\n0x05 è‡ªåŠ¨ä¼¸ç¼© actions-runner-controller åœ¨ 3 ä¸ª Runner çš„ CRD ä¹‹å¤–ï¼Œè¿˜æä¾›äº†ç±»ä¼¼ HPA çš„ CRD HorizontalRunnerAutoscalerï¼Œç®€ç§° HRAã€‚\nHRA å¯ä»¥æ ¹æ®æŒ‡æ ‡ PercentageRunnersBusy æˆ–è€… TotalNumberOfQueuedAndInProgressWorkflowRuns æ¥å¯¹ runner è¿›è¡Œæ‰©ç¼©å®¹ï¼Œæˆ–è€…åŸºäº GitHub Eventsï¼ˆwebhookï¼‰æ¥è¿›è¡Œæ‰©ç¼©å®¹ã€‚è¿™ä¸¤ç§éƒ½å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œå‰è€…æŒ‡æ ‡æ˜¯é€šè¿‡ GitHub API è½®è®­ç­‰å¾…çš„ä½œä¸šæ•°ï¼Œå®ç°ç®€å•ï¼Œä½†æ—¶æ•ˆæ€§å·®ï¼›åè€…åŸºäºäº‹ä»¶è§¦å‘æ—¶æ•ˆæ€§æ›´ä½³ï¼Œä½†æ˜¯å®ç°å¤æ‚ï¼Œéœ€è¦å¯¹å¤–æš´éœ²è®¿é—®ç«¯ç‚¹æ¥æ”¶ GitHub Eventã€‚\nè¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œä½¿ç”¨åŸºäºæŒ‡æ ‡çš„æ–¹å¼è¿›è¡Œæ‰©ç¼©å®¹ã€‚\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: actions.summerwind.dev/v1alpha1 kind: HorizontalRunnerAutoscaler metadata: name: building-runner-autoscaler spec: scaleDownDelaySecondsAfterScaleOut: 30 scaleTargetRef: name: building-runner minReplicas: 1 maxReplicas: 5 metrics: - type: PercentageRunnersBusy scaleUpThreshold: \u0026#39;0.75\u0026#39; scaleDownThreshold: \u0026#39;0.25\u0026#39; scaleUpFactor: \u0026#39;2\u0026#39; scaleDownFactor: \u0026#39;0.5\u0026#39; EOF è¿˜æ˜¯é€šè¿‡ API è§¦å‘ä½œä¸šæ¨¡æ‹Ÿå¹¶å‘æ‰§è¡Œï¼Œç”±äºè½®è®­é—´éš”æ¯”è¾ƒé•¿ï¼ˆé»˜è®¤ 1 åˆ†é’Ÿï¼‰ï¼Œè‡ªåŠ¨æ‰©å®¹éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼š\nkubectl get pods -l actions-runner=\u0026#34;\u0026#34; -n actions-runner-system NAME READY STATUS RESTARTS AGE building-runner-k6jlc-dk7gc 2/2 Running 0 1m34s building-runner-k6jlc-pbwnz 2/2 Running 0 54s building-runner-k6jlc-nlptp 2/2 Running 0 54s 0x06æ€»ç»“ GitHub Actions æ˜¯ä¸ªå¾ˆå¼ºå¤§çš„ CI å·¥å…·ï¼Œç»“åˆè‡ªæ‰˜ç®¡çš„ Runner å¯ä»¥åœ¨ä»˜å‡ºè¾ƒä½æˆæœ¬çš„åŸºç¡€ä¸Šæœ‰æ›´å¥½çš„ä½“éªŒã€‚æœ¬æ–‡ä¹Ÿåªæ˜¯ä»æ»¡è¶³éœ€æ±‚çš„å‡ºå‘ï¼Œå¯¹ â€œRunner on Kubernetesâ€ è¿›è¡Œäº†æ¢ç´¢ã€‚å¯¹ä¸€ä¸ªå·¥å…·ä»ä¼šç”¨åˆ°ç”¨å¥½ï¼Œè¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°ã€‚ä½†æ»¡è¶³å½“å‰éœ€æ±‚ï¼Œå·²æ˜¯è¶³çŸ£ã€‚\næœ‰å…´è¶£çš„åŒå­¦å¯ä»¥æ›´è¿›ä¸€æ­¥æ€è€ƒï¼š\nå¦‚ä½•é™åˆ¶ Runner è¿è¡Œæ—¶çš„èµ„æºå ç”¨ æŒä¹…åŒ–å¦‚ä½•å®ç°ï¼Œæ¯”å¦‚ Maven æ„å»ºæ—¶çš„æœ¬åœ°åº“ï¼ŒNodejs çš„ node_mudules å¦‚ä½•é¿å…é‡å¤ä¸‹è½½ è‡ªåŠ¨æ‰©ç¼©å®¹èƒ½å¦æ›´åŠ é«˜æ•ˆ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/07/10/runnersonk8s.png","permalink":"https://atbug.com/run-github-actions-runners-on-kubernetes/","tags":["Kubernetes","CICD"],"title":"åœ¨ Kubernetes ä¸Šæ‰§è¡Œ GitHub Actions æµæ°´çº¿ä½œä¸š"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬æ–‡ç¿»è¯‘è‡ª Jack Roper çš„æ–‡ç«  Kubernetes Best Practiceã€‚\nè¯‘è€…ï¼šæ–‡ç« ä¸­ä½œè€…ä»åº”ç”¨ç¨‹åºå¼€å‘ã€æ²»ç†å’Œé›†ç¾¤é…ç½®ä¸‰ä¸ªæ–¹é¢ç»™å‡ºäº†ä¸€äº› Kubernetes çš„æœ€ä½³å®è·µï¼ŒåŒæ—¶ç¿»è¯‘è¿‡ç¨‹ä¸­ä¹ŸåŠ å…¥äº†æˆ‘è¿‡å¾€çš„ä¸€äº›ä½¿ç”¨ç»éªŒã€‚æœ‰è¯¯çš„åœ°æ–¹ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶æŒ‡æ­£ã€‚\nåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä»‹ç»ä¸€äº›ä½¿ç”¨ Kubernetes (K8s) æ—¶çš„æœ€ä½³å®è·µã€‚\nä½œä¸ºæœ€æµè¡Œçš„å®¹å™¨ç¼–æ’ç³»ç»Ÿï¼ŒK8s æ˜¯ç°ä»£äº‘å·¥ç¨‹å¸ˆæŒæ¡çš„äº‹å®æ ‡å‡†ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œä¸ç®¡ä½¿ç”¨è¿˜æ˜¯ç»´æŠ¤ K8s å¤æ‚çš„ç³»ç»Ÿï¼Œå› æ­¤å¾ˆå¥½åœ°æŒæ¡å®ƒåº”è¯¥åšä»€ä¹ˆå’Œä¸åº”è¯¥åšä»€ä¹ˆï¼Œå¹¶çŸ¥é“ä»€ä¹ˆæ˜¯å¯èƒ½çš„ï¼Œå°†æ˜¯ä¸€ä¸ªå¥½çš„å¼€å±€ã€‚\nè¿™äº›å»ºè®®åŒ…å« 3 å¤§ç±»ä¸­çš„å¸¸è§é—®é¢˜ï¼Œå³åº”ç”¨ç¨‹åºå¼€å‘ã€æ²»ç†å’Œé›†ç¾¤é…ç½®ã€‚\næœ€ä½³å®è·µç›®å½• ä½¿ç”¨å‘½åç©ºé—´ ä½¿ç”¨å°±ç»ªå’Œå­˜æ´»æ¢é’ˆï¼ˆè¯‘è€…æ³¨ï¼šè¿˜æœ‰å¯åŠ¨æ¢é’ˆï¼‰ ä½¿ç”¨è‡ªåŠ¨ç¼©æ”¾ ä½¿ç”¨èµ„æºè¯·æ±‚å’Œçº¦æŸ ä½¿ç”¨ Deploymentã€DaemonSetã€ReplicaSet æˆ–è€… StatefulSet è·¨èŠ‚ç‚¹éƒ¨ç½² Pod ä½¿ç”¨å¤šèŠ‚ç‚¹ ä½¿ç”¨åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ åœ¨å¤–éƒ¨æ‰˜ç®¡Kubernetesé›†ç¾¤ï¼ˆä½¿ç”¨äº‘æœåŠ¡ï¼‰ å‡çº§Kubernetesç‰ˆæœ¬ ç›‘æ§é›†ç¾¤èµ„æºå’Œå®¡è®¡ç­–ç•¥æ—¥å¿— ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ ä½¿ç”¨åŸºäºGitçš„å·¥ä½œæµç¨‹ï¼ˆGitOpsï¼‰ ç¼©å°å®¹å™¨çš„å¤§å° ç”¨æ ‡ç­¾æ•´ç†å¯¹è±¡ï¼ˆè¯‘è€…æ³¨ï¼šæˆ–ç†è§£ä¸ºèµ„æºï¼‰ ä½¿ç”¨ç½‘ç»œç­–ç•¥ ä½¿ç”¨é˜²ç«å¢™ ä½¿ç”¨å‘½åç©ºé—´ K8s ä¸­çš„å‘½åç©ºé—´å¯¹äºç»„ç»‡å¯¹è±¡ã€åœ¨é›†ç¾¤ä¸­åˆ›å»ºé€»è¾‘åˆ†åŒºä»¥åŠå®‰å…¨æ–¹é¢çš„è€ƒè™‘è‡³å…³é‡è¦ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒK8s é›†ç¾¤ä¸­æœ‰ 3 ä¸ªå‘½åç©ºé—´ï¼Œdefaultã€kube-public å’Œ kube-systemã€‚\nRBAC å¯ç”¨äºæ§åˆ¶å¯¹ç‰¹å®šå‘½åç©ºé—´çš„è®¿é—®ï¼Œä»¥é™åˆ¶ç»„çš„è®¿é—®ä»¥æ§åˆ¶å¯èƒ½å‘ç”Ÿçš„ä»»ä½•é”™è¯¯çš„çˆ†ç‚¸åŠå¾„ï¼Œä¾‹å¦‚ï¼Œä¸€ç»„å¼€å‘äººå‘˜å¯èƒ½åªèƒ½è®¿é—®åä¸º dev çš„å‘½åç©ºé—´ï¼Œå¹¶ä¸”æ— æ³•è®¿é—® production å‘½åç©ºé—´ã€‚ å°†ä¸åŒå›¢é˜Ÿé™åˆ¶åœ¨ä¸åŒå‘½åç©ºé—´çš„èƒ½åŠ›å¯¹äºé¿å…é‡å¤å·¥ä½œæˆ–èµ„æºå†²çªå¯èƒ½å¾ˆæœ‰ä»·å€¼ã€‚\nè¿˜å¯ä»¥é’ˆå¯¹å‘½åç©ºé—´é…ç½® LimitRange å¯¹è±¡ï¼Œä»¥å®šä¹‰éƒ¨ç½²åœ¨å‘½åç©ºé—´ä¸­çš„å®¹å™¨çš„æ ‡å‡†å¤§å°ã€‚ResourceQuotas è¿˜å¯ç”¨äºé™åˆ¶å‘½åç©ºé—´å†…æ‰€æœ‰å®¹å™¨çš„æ€»èµ„æºæ¶ˆè€—ã€‚å¯ä»¥å¯¹å‘½åç©ºé—´ä½¿ç”¨ç½‘ç»œç­–ç•¥æ¥é™åˆ¶ pod ä¹‹é—´çš„æµé‡ã€‚\nä½¿ç”¨å°±ç»ªå’Œå­˜æ´»æ¢é’ˆ Readinessï¼ˆå°±ç»ªï¼‰å’Œ Livenessï¼ˆå­˜æ´»ï¼‰æ¢é’ˆæœ¬è´¨ä¸Šéƒ½æ˜¯å¥åº·æ£€æŸ¥çš„ç±»å‹ã€‚è¿™äº›æ˜¯åœ¨ K8s ä¸­ä½¿ç”¨çš„å¦ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µã€‚\nå°±ç»ªæ¢é’ˆç¡®ä¿ä»…å½“ pod å‡†å¤‡å¥½ä¸ºè¯·æ±‚æä¾›æœåŠ¡æ—¶ï¼Œæ‰ä¼šå°†å¯¹ pod çš„è¯·æ±‚å®šå‘åˆ°å®ƒã€‚å¦‚æœå®ƒè¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œé‚£ä¹ˆè¯·æ±‚å°†è¢«å®šå‘åˆ°å…¶ä»–åœ°æ–¹ã€‚ä¸ºæ¯ä¸ªå®¹å™¨å®šä¹‰å°±ç»ªæ¢é’ˆå¾ˆé‡è¦ï¼Œå› ä¸ºåœ¨ K8s ä¸­æ²¡æœ‰ä¸ºè¿™äº›è®¾ç½®é»˜è®¤å€¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ª pod éœ€è¦ 20 ç§’æ‰èƒ½å¯åŠ¨å¹¶ä¸”ç¼ºå°‘å°±ç»ªæ¢æµ‹ï¼Œé‚£ä¹ˆåœ¨å¯åŠ¨æœŸé—´å®šå‘åˆ°è¯¥ pod çš„ä»»ä½•æµé‡éƒ½ä¼šå¯¼è‡´å¤±è´¥ã€‚å°±ç»ªæ¢é’ˆåº”è¯¥æ˜¯ç‹¬ç«‹çš„ï¼Œå¹¶ä¸”ä¸è€ƒè™‘å¯¹å…¶ä»–æœåŠ¡çš„ä»»ä½•ä¾èµ–ï¼Œä¾‹å¦‚åç«¯æ•°æ®åº“æˆ–ç¼“å­˜æœåŠ¡ã€‚\nå­˜æ´»æ¢é’ˆè¯•åº”ç”¨ç¨‹åºæ˜¯å¦æ­£åœ¨è¿è¡Œä»¥å°†å…¶æ ‡è®°ä¸ºå¥åº·ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥æµ‹è¯• Web åº”ç”¨ç¨‹åºçš„ç‰¹å®šè·¯å¾„ä»¥ç¡®ä¿å…¶å“åº”ã€‚å¦‚æœä¸æ˜¯ï¼Œè¯¥ pod å°†ä¸ä¼šè¢«æ ‡è®°ä¸ºå¥åº·ï¼Œå¹¶ä¸”æ¢æµ‹å¤±è´¥å°†å¯¼è‡´ kubelet å¯åŠ¨ä¸€ä¸ªæ–°çš„ podï¼Œç„¶åå°†å†æ¬¡å¯¹å…¶è¿›è¡Œæµ‹è¯•ã€‚è¿™ç§ç±»å‹çš„æ¢æµ‹ç”¨ä½œæ¢å¤æœºåˆ¶ï¼Œä»¥é˜²è¿›ç¨‹æ— å“åº”ã€‚\nè¯‘è€…ï¼šåœ¨ Kubernetes 1.18 å¼•å…¥äº† StartUpï¼ˆå¯åŠ¨ï¼‰æ¢é’ˆã€‚å½“å®¹å™¨å¯åŠ¨æ—¶é—´è¾ƒé•¿ï¼ˆè¦èŠ±è¾ƒé•¿çš„æ—¶é—´å®Œæˆåˆå§‹åŒ–å·¥ä½œï¼‰ï¼Œæ­¤æ—¶åº”è¯¥ä½¿ç”¨å¯åŠ¨æ¢é’ˆã€‚å¦‚æœå¯åŠ¨æ¢é’ˆæ¢æµ‹ä¸æˆåŠŸï¼Œå…¶ä»–æ¢é’ˆåˆ™ä¸ä¼šç”Ÿæ•ˆã€‚\nè¯‘è€…ï¼šè¿˜æœ‰ä¸€ç‚¹å°½é‡ä¸º Pod å†…çš„æ‰€æœ‰å®¹å™¨éƒ½å®šä¹‰æ¢é’ˆã€‚\nä½¿ç”¨è‡ªåŠ¨ç¼©æ”¾ åœ¨é€‚å½“çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨è‡ªåŠ¨ç¼©æ”¾æ¥åŠ¨æ€è°ƒæ•´ pod çš„æ•°é‡ï¼ˆPod æ°´å¹³è‡ªåŠ¨ç¼©æ”¾å™¨ï¼ŒHPAï¼‰ã€pod æ¶ˆè€—çš„èµ„æºé‡ï¼ˆPod å‚ç›´è‡ªåŠ¨ç¼©æ”¾å™¨, VPAï¼‰æˆ–é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ•°é‡ï¼ˆé›†ç¾¤è‡ªåŠ¨ç¼©æ”¾å™¨ï¼ŒCAï¼‰ï¼Œå…·ä½“å–å†³äº å¯¹èµ„æºçš„éœ€æ±‚ã€‚\nPod æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å™¨è¿˜å¯ä»¥æ ¹æ® CPU éœ€æ±‚æ‰©å±•å¤åˆ¶æ§åˆ¶å™¨ã€å‰¯æœ¬é›†æˆ–æœ‰çŠ¶æ€é›†ã€‚\nä½¿ç”¨ç¼©æ”¾ä¹Ÿå¸¦æ¥äº†ä¸€äº›æŒ‘æˆ˜ï¼Œä¾‹å¦‚ä¸åœ¨å®¹å™¨çš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å­˜å‚¨æŒä¹…æ•°æ®ï¼Œå› ä¸ºè¿™ä¼šé˜»æ­¢æ°´å¹³è‡ªåŠ¨ç¼©æ”¾ã€‚ç›¸åï¼Œå¯ä»¥ä½¿ç”¨ PersistentVolumeã€‚\nå½“é›†ç¾¤ä¸Šå­˜åœ¨é«˜åº¦å¯å˜çš„å·¥ä½œè´Ÿè½½å¹¶ä¸”å¯èƒ½æ ¹æ®éœ€æ±‚åœ¨ä¸åŒæ—¶é—´éœ€è¦ä¸åŒæ•°é‡çš„èµ„æºæ—¶ï¼Œé›†ç¾¤è‡ªåŠ¨ç¼©æ”¾å™¨éå¸¸æœ‰ç”¨ã€‚ è‡ªåŠ¨åˆ é™¤æœªä½¿ç”¨çš„èŠ‚ç‚¹ä¹Ÿæ˜¯çœé’±çš„å¥½æ–¹æ³•ï¼\nè¯‘è€…ï¼šæ›´å¤šè‡ªåŠ¨ç¼©æ”¾çš„å†…å®¹ï¼Œå¯ä»¥æµè§ˆæˆ‘ä¹‹å‰ç¿»è¯‘çš„Kubernetes çš„è‡ªåŠ¨ä¼¸ç¼©ä½ ç”¨å¯¹äº†å—ï¼Ÿï¼›HPA é™¤äº†å¯ä»¥åŸºäº CPU æŒ‡æ ‡ä¼¸ç¼©ï¼Œè¿˜å¯ä»¥åŸºäºå†…å­˜ï¼Œæˆ–è€…è‡ªå®šä¹‰æŒ‡æ ‡ï¼Œå¯ä»¥æµè§ˆKubernetes HPA åŸºäº Prometheus è‡ªå®šä¹‰æŒ‡æ ‡çš„å¯æ§å¼¹æ€§ä¼¸ç¼©ã€‚\nä½¿ç”¨èµ„æºè¯·æ±‚å’Œçº¦æŸ åº”è®¾ç½®èµ„æºè¯·æ±‚å’Œçº¦æŸï¼ˆå¯åœ¨å®¹å™¨ä¸­ä½¿ç”¨çš„æœ€å°å’Œæœ€å¤§èµ„æºé‡ï¼‰ä»¥é¿å…å®¹å™¨åœ¨æœªåˆ†é…æ‰€éœ€èµ„æºçš„æƒ…å†µä¸‹å¯åŠ¨ï¼Œæˆ–é›†ç¾¤ç”¨å°½å¯ç”¨èµ„æºã€‚\nåœ¨æ²¡æœ‰é™åˆ¶çš„æƒ…å†µä¸‹ï¼ŒPod å¯ä»¥ä½¿ç”¨æ¯”æ‰€éœ€æ›´å¤šçš„èµ„æºï¼Œä»è€Œå¯¼è‡´å¯ç”¨èµ„æºæ€»é‡å‡å°‘ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´é›†ç¾¤ä¸Šçš„å…¶ä»–åº”ç”¨ç¨‹åºå‡ºç°é—®é¢˜ã€‚èŠ‚ç‚¹å¯èƒ½ä¼šå´©æºƒï¼Œå¹¶ä¸”è°ƒåº¦ç¨‹åºå¯èƒ½æ— æ³•æ­£ç¡®è°ƒåº¦æ–°çš„ podã€‚\nå¦‚æœæ²¡æœ‰è¯·æ±‚ï¼Œæ— æ³•ä¸ºåº”ç”¨ç¨‹åºåˆ†é…è¶³å¤Ÿçš„èµ„æºï¼Œå®ƒå¯èƒ½ä¼šåœ¨å°è¯•å¯åŠ¨æˆ–æ‰§è¡Œå¼‚å¸¸æ—¶å¤±è´¥ã€‚\nèµ„æºè¯·æ±‚å’Œé™åˆ¶ä»¥æ¯«æ ¸å’Œå…†å­—èŠ‚ä¸ºå•ä½å®šä¹‰å¯ç”¨çš„ CPU å’Œå†…å­˜ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœè¿›ç¨‹è¶…å‡ºå†…å­˜é™åˆ¶ï¼Œåˆ™è¯¥è¿›ç¨‹å°†ç»ˆæ­¢ï¼Œå› æ­¤åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½å¯èƒ½ä¸é€‚åˆè®¾ç½®æ­¤å€¼ã€‚å¦‚æœå®¹å™¨è¶…è¿‡ CPU é™åˆ¶ï¼Œåˆ™è¿›ç¨‹ä¼šå—åˆ°é™åˆ¶ã€‚\nä½¿ç”¨ Deploymentã€DaemonSetã€ReplicaSet æˆ–è€… StatefulSet è·¨èŠ‚ç‚¹éƒ¨ç½² Pod æ°¸è¿œä¸åº”è¯¥ç›´æ¥ä½¿ç”¨ Pod è¿è¡Œã€‚ç›¸åï¼Œä¸ºäº†æé«˜å®¹é”™æ€§ï¼ŒPod åº”è¯¥å§‹ç»ˆä½œä¸º Deploymentã€DaemonSetã€ReplicaSet æˆ– StatefulSet çš„ä¸€éƒ¨åˆ†ã€‚ç„¶åå¯ä»¥åœ¨éƒ¨ç½²ä¸­ä½¿ç”¨åäº²å’Œæ€§è§„åˆ™è·¨èŠ‚ç‚¹éƒ¨ç½² podï¼Œä»¥é¿å…æ‰€æœ‰ pod è°ƒåº¦åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå¦‚æœè¯¥èŠ‚ç‚¹å‘ç”Ÿæ•…éšœå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡åœæ­¢ã€‚\nä½¿ç”¨å¤šèŠ‚ç‚¹ å¦‚æœæƒ³æå‡å®¹é”™æ€§ï¼Œåœ¨å•ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ K8s å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚é›†ç¾¤ä¸­åº”è¯¥ä½¿ç”¨å¤šä¸ªèŠ‚ç‚¹ï¼Œä»¥ä¾¿å¯ä»¥åœ¨å®ƒä»¬ä¹‹é—´åˆ†æ•£å·¥ä½œè´Ÿè½½ã€‚\nä½¿ç”¨åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ åœ¨ K8s é›†ç¾¤ä¸­ä½¿ç”¨ RBAC å¯¹äºæ­£ç¡®ä¿æŠ¤ç³»ç»Ÿè‡³å…³é‡è¦ã€‚å¯ä»¥ä¸ºç”¨æˆ·ã€ç»„å’Œ service account åˆ†é…æƒé™ï¼Œä»¥åœ¨ç‰¹å®šå‘½åç©ºé—´ï¼ˆè§’è‰²ï¼‰æˆ–æ•´ä¸ªé›†ç¾¤ï¼ˆClusterRoleï¼‰ä¸Šæ‰§è¡Œå…è®¸çš„æ“ä½œã€‚æ¯ä¸ªè§’è‰²å¯ä»¥æœ‰å¤šä¸ªæƒé™ã€‚è¦å°†å®šä¹‰çš„è§’è‰²ç»‘å®šåˆ°ç”¨æˆ·ã€ç»„æˆ– service accountï¼Œä½¿ç”¨ RoleBinding æˆ– ClusterRoleBinding å¯¹è±¡ã€‚\nRBAC è§’è‰²æˆäºˆåº”è®¾ç½®ä¸ºä½¿ç”¨æœ€å°æƒé™åŸåˆ™ï¼Œå³ä»…æˆäºˆæ‰€éœ€çš„æƒé™ã€‚ä¾‹å¦‚ï¼Œç®¡ç†å‘˜ç»„å¯èƒ½æœ‰æƒè®¿é—®æ‰€æœ‰èµ„æºï¼Œè€Œè¿ç»´äººå‘˜ç»„å¯èƒ½èƒ½å¤Ÿéƒ¨ç½²ï¼Œä½†ä¸èƒ½è¯»å– secretã€‚\nåœ¨å¤–éƒ¨æ‰˜ç®¡Kubernetesé›†ç¾¤ï¼ˆä½¿ç”¨äº‘æœåŠ¡ï¼‰ åœ¨è‡ªå·±çš„ç¡¬ä»¶ä¸Šæ‰˜ç®¡ K8s é›†ç¾¤å¯èƒ½æ˜¯ä¸€é¡¹å¤æ‚çš„å·¥ä½œã€‚äº‘æœåŠ¡å°† K8s é›†ç¾¤ä½œä¸ºå¹³å°å³æœåŠ¡ (PaaS) æä¾›ï¼Œä¾‹å¦‚ Azure ä¸Šçš„ AKSï¼ˆAzure Kubernetes æœåŠ¡ï¼‰æˆ– Amazon Web Services ä¸Šçš„ EKSï¼ˆäºšé©¬é€Šå¼¹æ€§ Kubernetes æœåŠ¡ï¼‰ã€‚åˆ©ç”¨è¿™ä¸€ç‚¹æ„å‘³ç€åº•å±‚åŸºç¡€è®¾æ–½å°†ç”±äº‘æœåŠ¡å•†ç®¡ç†ï¼Œå¹¶ä¸”å¯ä»¥æ›´è½»æ¾åœ°å®Œæˆæœ‰å…³æ‰©å±•é›†ç¾¤çš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ·»åŠ å’Œåˆ é™¤èŠ‚ç‚¹ï¼Œè€Œè®©å·¥ç¨‹å¸ˆç®¡ç† K8s é›†ç¾¤ä¸Šè¿è¡Œçš„å†…å®¹æœ¬èº«ã€‚\nå‡çº§Kubernetesç‰ˆæœ¬ é™¤äº†å¼•å…¥æ–°åŠŸèƒ½å¤–ï¼Œæ–°çš„ K8s ç‰ˆæœ¬è¿˜åŒ…æ‹¬æ¼æ´å’Œå®‰å…¨ä¿®å¤ï¼Œè¿™ä½¿å¾—åœ¨é›†ç¾¤ä¸Šè¿è¡Œæœ€æ–°ç‰ˆæœ¬çš„ K8s éå¸¸é‡è¦ã€‚å¯¹æ—§ç‰ˆæœ¬çš„æ”¯æŒå¯èƒ½ä¸å¦‚æ–°ç‰ˆæœ¬å¥½ã€‚\nç„¶è€Œï¼Œè¿ç§»åˆ°æ–°ç‰ˆæœ¬æ—¶åº”è°¨æ…å¯¹å¾…ï¼Œå› ä¸ºæŸäº›åŠŸèƒ½å¯èƒ½ä¼šè¢«åºŸå¼ƒï¼Œä¹Ÿå¯èƒ½ä¼šæ·»åŠ æ–°åŠŸèƒ½ã€‚æ­¤å¤–ï¼Œåœ¨å‡çº§ä¹‹å‰ï¼Œåº”æ£€æŸ¥é›†ç¾¤ä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åºæ˜¯å¦ä¸è¾ƒæ–°çš„ç›®æ ‡ç‰ˆæœ¬å…¼å®¹ã€‚\nç›‘æ§é›†ç¾¤èµ„æºå’Œå®¡è®¡ç­–ç•¥æ—¥å¿— ç›‘æ§ K8s æ§åˆ¶å¹³é¢ä¸­çš„ç»„ä»¶å¯¹äºæ§åˆ¶èµ„æºæ¶ˆè€—éå¸¸é‡è¦ã€‚æ§åˆ¶å¹³é¢æ˜¯ K8s çš„æ ¸å¿ƒï¼Œè¿™äº›ç»„ä»¶ä¿æŒç³»ç»Ÿè¿è¡Œï¼Œå› æ­¤å¯¹äºæ­£ç¡® K8s æ“ä½œè‡³å…³é‡è¦ã€‚ Kubernetes APIã€kubeletã€etcdã€controller-managerã€kube-proxy å’Œ kube-dns ç»„æˆäº†æ§åˆ¶å¹³é¢ã€‚\næ§åˆ¶å¹³é¢ç»„ä»¶å¯ä»¥ä»¥æœ€å¸¸è§çš„ K8s ç›‘æ§å·¥å…· Prometheus å…¼å®¹çš„æ ¼å¼è¾“å‡ºæŒ‡æ ‡ã€‚\nåº”è¯¥ä½¿ç”¨è‡ªåŠ¨ç›‘æ§å·¥å…·è€Œä¸æ˜¯æ‰‹åŠ¨ç®¡ç†å‘Šè­¦ã€‚\nå¯ä»¥åœ¨å¯åŠ¨ kube-apiserver æ—¶æ‰“å¼€ K8s ä¸­çš„å®¡è®¡æ—¥å¿—è®°å½•ï¼Œä»¥ä¾¿ä½¿ç”¨é€‰æ‹©çš„å·¥å…·è¿›è¡Œæ›´æ·±å…¥çš„è°ƒæŸ¥ã€‚audit.log å°†è¯¦ç»†è®°å½•å‘ K8s API å‘å‡ºçš„æ‰€æœ‰è¯·æ±‚ï¼Œå¹¶åº”å®šæœŸæ£€æŸ¥é›†ç¾¤ä¸Šå¯èƒ½å­˜åœ¨çš„ä»»ä½•é—®é¢˜ã€‚Kubernetes é›†ç¾¤é»˜è®¤ç­–ç•¥åœ¨ audit-policy.yaml æ–‡ä»¶ä¸­å®šä¹‰ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚\nAzure Monitor ç­‰æ—¥å¿—èšåˆå·¥å…·å¯ç”¨äºå°†æ—¥å¿—ä» AKS å‘é€åˆ°æ—¥å¿—åˆ†æå·¥ä½œåŒºï¼Œä»¥ä¾¿å°†æ¥ä½¿ç”¨ Kusto æŸ¥è¯¢è¿›è¡Œå®¡è®¯ã€‚åœ¨ AWS Cloudwatch ä¸Šå¯ä»¥ä½¿ç”¨ã€‚ç¬¬ä¸‰æ–¹å·¥å…·è¿˜æä¾›æ›´æ·±å…¥çš„ç›‘æ§åŠŸèƒ½ï¼Œä¾‹å¦‚ Dynatrace å’Œ Datadogã€‚\næœ€åï¼Œåº”è¯¥ä¸ºæ—¥å¿—è®¾ç½®ä¸€ä¸ªä¿ç•™æœŸï¼Œé€šå¸¸ä¸º 30-45 å¤©å·¦å³ã€‚\nä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ K8s é…ç½®æ–‡ä»¶åº”è¯¥åœ¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ (VCS) ä¸­è¿›è¡Œç®¡ç†ã€‚è¿™å¸¦æ¥äº†å¾ˆå¤šå¥½å¤„ï¼ŒåŒ…æ‹¬æé«˜å®‰å…¨æ€§ã€å¯ç”¨æ›´æ”¹çš„å®¡è®¡è·Ÿè¸ªï¼Œå¹¶å°†æé«˜é›†ç¾¤çš„ç¨³å®šæ€§ã€‚åº”ä¸ºæ‰€åšçš„ä»»ä½•æ›´æ”¹è®¾ç½®å®¡æ‰¹ï¼Œä»¥ä¾¿å›¢é˜Ÿå¯ä»¥åœ¨å°†æ›´æ”¹æäº¤åˆ°ä¸»åˆ†æ”¯ä¹‹å‰å¯¹å…¶è¿›è¡Œè¯„å®¡ã€‚\nä½¿ç”¨åŸºäºGitçš„å·¥ä½œæµç¨‹ï¼ˆGitOpsï¼‰ K8s çš„æˆåŠŸéƒ¨ç½²éœ€è¦è€ƒè™‘å›¢é˜Ÿä½¿ç”¨çš„å·¥ä½œæµç¨‹ã€‚ä½¿ç”¨åŸºäº git çš„å·¥ä½œæµå¯ä»¥é€šè¿‡ä½¿ç”¨ CI/CDï¼ˆæŒç»­é›†æˆ / æŒç»­äº¤ä»˜ï¼‰ç®¡é“å®ç°è‡ªåŠ¨åŒ–ï¼Œè¿™å°†æé«˜åº”ç”¨ç¨‹åºéƒ¨ç½²æ•ˆç‡å’Œé€Ÿåº¦ã€‚CI/CD è¿˜å°†æä¾›éƒ¨ç½²çš„å®¡è®¡è·Ÿè¸ªã€‚Git åº”è¯¥æ˜¯æ‰€æœ‰è‡ªåŠ¨åŒ–çš„å•ä¸€äº‹å®æ¥æºï¼Œå¹¶å°†å®ç°å¯¹ K8s é›†ç¾¤çš„ç»Ÿä¸€ç®¡ç†ã€‚è¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸“ç”¨çš„åŸºç¡€æ¶æ„äº¤ä»˜å¹³å°ï¼Œä¾‹å¦‚ Spaceliftï¼Œå®ƒæœ€è¿‘å¼•å…¥äº† Kubernetes æ”¯æŒã€‚\nç¼©å°å®¹å™¨çš„å¤§å° è¾ƒå°çš„æ˜ åƒå¤§å°å°†æœ‰åŠ©äºåŠ å¿«æ„å»ºå’Œéƒ¨ç½²é€Ÿåº¦ï¼Œå¹¶å‡å°‘å®¹å™¨åœ¨ K8s é›†ç¾¤ä¸Šæ¶ˆè€—çš„èµ„æºé‡ã€‚åº”å°½å¯èƒ½åˆ é™¤ä¸å¿…è¦çš„è½¯ä»¶åŒ…ï¼Œå¹¶åº”ä¼˜å…ˆä½¿ç”¨è¯¸å¦‚ Alpine ä¹‹ç±»çš„å°å‹æ“ä½œç³»ç»Ÿåˆ†å‘æ˜ åƒã€‚è¾ƒå°çš„å›¾åƒå¯ä»¥æ¯”è¾ƒå¤§çš„å›¾åƒæ›´å¿«åœ°æ‹‰å–ï¼Œå¹¶ä¸”æ¶ˆè€—æ›´å°‘çš„å­˜å‚¨ç©ºé—´ã€‚\néµå¾ªè¿™ç§æ–¹æ³•è¿˜å°†æä¾›å®‰å…¨ä¼˜åŠ¿ï¼Œå› ä¸ºæ¶æ„è¡Œä¸ºè€…çš„æ½œåœ¨æ”»å‡»åª’ä»‹å°†ä¼šå‡å°‘ã€‚\nç”¨æ ‡ç­¾æ•´ç†å¯¹è±¡ K8s æ ‡ç­¾æ˜¯é™„åŠ åˆ°å¯¹è±¡ç”¨æ¥ç»„ç»‡é›†ç¾¤èµ„æºçš„é”®å€¼å¯¹ã€‚æ ‡ç­¾åº”è¯¥æ˜¯æœ‰æ„ä¹‰çš„å…ƒæ•°æ®ï¼Œæä¾›ä¸€ç§æœºåˆ¶æ¥è·Ÿè¸ª K8s ç³»ç»Ÿä¸­ä¸åŒç»„ä»¶çš„äº¤äº’æ–¹å¼ã€‚\nK8s å®˜æ–¹æ–‡æ¡£ä¸­æ¨èçš„ Pod æ ‡ç­¾åŒ…æ‹¬åç§°ã€å®ä¾‹ã€ç‰ˆæœ¬ã€ç»„ä»¶ã€éƒ¨åˆ†å’Œç®¡ç†è€…ã€‚\næ ‡ç­¾ä¹Ÿå¯ä»¥ä»¥ç±»ä¼¼äºåœ¨äº‘ç¯å¢ƒä¸­å¯¹èµ„æºä½¿ç”¨æ ‡ç­¾çš„æ–¹å¼ä½¿ç”¨ï¼Œä»¥è·Ÿè¸ªä¸ä¸šåŠ¡ç›¸å…³çš„äº‹ç‰©ï¼Œä¾‹å¦‚å¯¹è±¡æ‰€æœ‰æƒå’Œå¯¹è±¡åº”å±äºçš„ç¯å¢ƒã€‚\næ­¤å¤–ï¼Œè¿˜å»ºè®®ä½¿ç”¨æ ‡ç­¾æ¥è¯¦ç»†è¯´æ˜å®‰å…¨è¦æ±‚ï¼ŒåŒ…æ‹¬æœºå¯†æ€§å’Œåˆè§„æ€§ã€‚\nä½¿ç”¨ç½‘ç»œç­–ç•¥ åº”è¯¥ä½¿ç”¨ç½‘ç»œç­–ç•¥æ¥é™åˆ¶ K8s é›†ç¾¤ä¸­å¯¹è±¡ä¹‹é—´çš„æµé‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥åœ¨ç½‘ç»œä¸­ç›¸äº’é€šä¿¡ï¼Œå¦‚æœæ¶æ„è¡Œä¸ºè€…è·å¾—å¯¹å®¹å™¨çš„è®¿é—®æƒé™ï¼Œä»è€Œå…è®¸ä»–ä»¬éå†é›†ç¾¤ä¸­çš„å¯¹è±¡ï¼Œè¿™ä¼šå¸¦æ¥å®‰å…¨é£é™©ã€‚ç½‘ç»œç­–ç•¥å¯ä»¥åœ¨ IP å’Œç«¯å£çº§åˆ«æ§åˆ¶æµé‡ï¼Œç±»ä¼¼äºäº‘å¹³å°ä¸­çš„å®‰å…¨ç»„çš„æ¦‚å¿µï¼Œä»¥é™åˆ¶å¯¹èµ„æºçš„è®¿é—®ã€‚é€šå¸¸ï¼Œé»˜è®¤æƒ…å†µä¸‹åº”æ‹’ç»æ‰€æœ‰æµé‡ï¼Œç„¶ååº”åˆ¶å®šå…è®¸è§„åˆ™ä»¥å…è®¸æ‰€éœ€æµé‡ã€‚\nä½¿ç”¨é˜²ç«å¢™ é™¤äº†ä½¿ç”¨ç½‘ç»œç­–ç•¥æ¥é™åˆ¶ K8s é›†ç¾¤ä¸Šçš„å†…éƒ¨æµé‡å¤–ï¼Œè¿˜åº”è¯¥åœ¨ K8s é›†ç¾¤å‰é¢æ”¾ç½®é˜²ç«å¢™ï¼Œä»¥é™åˆ¶æ¥è‡ªå¤–éƒ¨ç¯å¢ƒå¯¹ API server çš„è¯·æ±‚ã€‚IP åœ°å€åº”åˆ—å…¥ç™½åå•å¹¶é™åˆ¶å¼€æ”¾ç«¯å£ã€‚\næ€»ç»“ åœ¨è®¾è®¡ã€è¿è¡Œå’Œç»´æŠ¤ Kubernetes é›†ç¾¤æ—¶éµå¾ªæœ¬æ–‡ä¸­åˆ—å‡ºçš„æœ€ä½³å®è·µå°†ä½¿ä½ åœ¨ç°ä»£åº”ç”¨ç¨‹åºä¹‹æ—…ä¸­èµ°ä¸ŠæˆåŠŸä¹‹è·¯ï¼\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/07/04/16569411884953.jpg","permalink":"https://atbug.com/translate-kubernetes-best-practices/","tags":["Kubernetes"],"title":"è¯‘ï¼šKubernetes æœ€ä½³å®è·µ"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬ç¯‡æ–‡ç« è¯‘è‡ª SUNKU RANGANATH çš„ 4 Types of Edge Computing - Broadly Categorizedã€‚æ–‡ç« é€šè¿‡ å¾€è¿”ç»ˆç«¯è®¾å¤‡å’Œæ•°æ®ä¸­å¿ƒçš„å»¶è¿Ÿ æ¥å¯¹è¾¹ç¼˜è®¡ç®—çš„ç±»å‹è¿›è¡Œå¤§è‡´çš„åˆ†ç±»ï¼Œé€šä¿—æ˜“æ‡‚ï¼Œæ–¹ä¾¿å¤§å®¶å¯¹è¾¹ç¼˜è®¡ç®—æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£ã€‚\nè¾¹ç¼˜è®¡ç®—è¢«è®¤ä¸ºæ˜¯åˆ†å¸ƒå¼è®¡ç®—çš„ä¸‹ä¸€ä¸ªå‰æ²¿ã€‚ ç„¶è€Œï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªäººéƒ½çŸ¥é“ä»€ä¹ˆæ˜¯è¾¹ç¼˜è®¡ç®—ä»¥åŠå­˜åœ¨å¤šç§ç±»å‹çš„è¾¹ç¼˜è®¡ç®—ã€‚\nç®€å•åœ°è¯´ï¼Œè¾¹ç¼˜è®¡ç®—é€šè¿‡å°†è®¡ç®—é è¿‘æœ€ç»ˆç”¨æˆ·ï¼Œå®ç°äº†è¿‡å¤šè®¾å¤‡ï¼ˆé€šå¸¸åœ¨ 5G ä¸­ç§°ä¸ºç”¨æˆ·è®¾å¤‡ UEï¼‰å’Œç”µä¿¡æ•°æ®ä¸­å¿ƒæ ¸å¿ƒä¹‹é—´çš„è¿æ¥ã€‚\nä¿ƒæˆè¾¹ç¼˜è®¡ç®—çš„å…³é”®å› ç´ æ˜¯ UE å’Œéœ€è¦é«˜åº¦åˆ†å¸ƒå¼æ¶æ„çš„è®¡ç®—æœåŠ¡å™¨ä¹‹é—´çš„å¾€è¿”é€šä¿¡æ‰€å¸¦æ¥çš„å»¶è¿Ÿã€‚\näº†è§£å„ç§ç±»å‹è¾¹ç¼˜è®¡ç®—çš„ä¸€ç§ç®€å•æ–¹æ³•æ˜¯åŸºäºå…¶é è¿‘ç»ˆç«¯è®¾å¤‡çš„ç¨‹åº¦ä»¥åŠä¸æ•°æ®ä¸­å¿ƒçš„å¾€è¿”å»¶è¿Ÿã€‚ å°†å»¶è¿Ÿä½œä¸ºä¸»è¦å› ç´ ï¼Œè¾¹ç¼˜è®¡ç®—å¯ä»¥å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š\nIoT è¾¹ç¼˜ æœ¬åœ°è¾¹ç¼˜ æ¥å…¥è¾¹ç¼˜ ç½‘ç»œè¾¹ç¼˜ IoT è¾¹ç¼˜ è¿™ç§è¾¹ç¼˜çš„å»¶è¿Ÿé¢„æœŸé€šå¸¸å°äº 1 æ¯«ç§’ã€‚\nè¿™å‡ ä¹æ¶µç›–äº†ä»»ä½•è¿æ¥åˆ°ç§æœ‰æˆ–å…¬å…±ç½‘ç»œï¼ˆå¦‚äº’è”ç½‘ï¼‰çš„è®¾å¤‡ã€‚è¯¥è®¾å¤‡å¯ä»¥æ˜¯èƒ½å¤Ÿå¤„ç†æ•°æ®çš„æ™ºèƒ½è®¾å¤‡ï¼Œä¾‹å¦‚ç§»åŠ¨ç”µè¯æˆ–ä¸­ç»§å‘¨å›´ç¯å¢ƒä¿¡æ¯çš„ç®€å•ä¼ æ„Ÿå™¨ã€‚\nåŒ…æ‹¬ä½†ä¸é™äºé›¶å”®äº­ã€æ‘„åƒå¤´ã€å·¥å‚ä¼ æ„Ÿå™¨ã€è”ç½‘æ±½è½¦ã€æ— äººæœºã€è”ç½‘è·¯ç¯ã€æ™ºèƒ½åœè½¦å’ªè¡¨ã€è¿œç¨‹æ‰‹æœ¯è®¾å¤‡ç­‰ã€‚\næœ¬åœ°è¾¹ç¼˜ è¿™ç§è¾¹ç¼˜çš„å»¶è¿Ÿé¢„æœŸé€šå¸¸å°äº 5 æ¯«ç§’ã€‚\näººä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥èšåˆæ¥è‡ªç‰©è”ç½‘è¾¹ç¼˜çš„ä¼—å¤šè®¾å¤‡çš„æ•°æ®ï¼Œä»¥ä¾¿ä½¿ç”¨æ•°æ®å­˜å‚¨ã€å¤„ç†ã€åˆ†æå’Œå“åº”ç›¸å…³è¯·æ±‚ã€‚æœ¬åœ°è¾¹ç¼˜é€šè¿‡å¸®åŠ©æœ¬åœ°åŒ–æ•°æ®å¤„ç†å¹¶å‡å°‘æ•°æ®å¤„ç†æ—¶é—´ï¼Œåœ¨ä¼ä¸šå†…éƒ¨æä¾›è®¡ç®—èµ„æºã€‚æ­¤è¾¹ç¼˜çš„è®¾å¤‡é€šå¸¸è¿æ¥åˆ°ç½‘ç»œè¾¹ç¼˜æˆ–æ•°æ®ä¸­å¿ƒä»¥è·å–è¿›ä¸€æ­¥çš„è¯·æ±‚ã€‚\nå¤§å‹ä¼ä¸šã€å·¥ä¸šåˆ¶é€ è½¦é—´ã€å¤§å‹é›¶å”®ä¸šåŠ¡ç­‰ä¼ä¸šå¯ä»¥ä»è¿™äº›ç±»å‹çš„éƒ¨ç½²ä¸­å—ç›Šï¼Œä»è€Œèƒ½å¤Ÿåœ¨æ¥è¿‘å…¶æ¥æºçš„åœ°æ–¹å¤„ç†æ•°æ®ï¼ŒåŒæ—¶ä»ç„¶æ‹¥æœ‰æ‹¥æœ‰å¿…è¦ç¡¬ä»¶çš„æ‰€æœ‰æƒã€‚\né€šç”¨å®¢æˆ·ç«¯è®¾å¤‡ (u-CPE) æ˜¯å…¶ä¸­ä¸€ä¸ªä¾‹å­ï¼Œå®ƒåœ¨æœ¬åœ°éƒ¨ç½²çš„å•ä¸ªè®¾å¤‡ä¸­æä¾›é˜²ç«å¢™ã€WAN ä¼˜åŒ–å™¨ã€è·¯ç”±å™¨çš„ç»„åˆã€‚\nç½‘ç»œè¦æ±‚é€šå¸¸ä½¿ç”¨è½¯ä»¶å®šä¹‰çš„å¹¿åŸŸç½‘ (SD-WAN) æ¥æ»¡è¶³ï¼Œå®ƒå…è®¸ä¼ä¸šåˆ©ç”¨ MPLS æˆ– LTE æˆ–å®½å¸¦äº’è”ç½‘æœåŠ¡çš„ç»„åˆã€‚\n5G å…è®¸èƒ½å¤Ÿåœ¨æœ¬åœ°å»ºç«‹å°å‹åŸºç«™ï¼Œå¹¶åœ¨è®¸å¯å’Œéè®¸å¯é¢‘è°±ä¸­è¿è¡Œã€‚\næ¥å…¥è¾¹ç¼˜ è¿™ç§è¾¹ç¼˜çš„å»¶è¿Ÿé¢„æœŸé€šå¸¸å°äº 10 - 40 æ¯«ç§’ã€‚\næ›¾ç»å¯ç”¨ä½œå›ºå®šåŠŸèƒ½è®¾å¤‡çš„ä¼ ç»Ÿæ— çº¿ç”µæ¥å…¥ç½‘ç»œ (RAN) ç°åœ¨å·²è¢«åˆ†è§£ä¸ºä½¿ç”¨ç°æˆçš„æœåŠ¡å™¨åœ¨è½¯ä»¶ä¸­ä½œä¸ºä¸€ç»„è™šæ‹ŸåŠŸèƒ½è¿è¡Œã€‚RANæ˜¯å°†æ— çº¿è®¾å¤‡è¿æ¥åˆ°ç”µä¿¡è¿è¥å•†ç½‘ç»œæ ¸å¿ƒçš„å…³é”®ç‚¹ã€‚\nè™šæ‹Ÿ RAN (vRAN) ç­‰æ¦‚å¿µä»¥åŠ Open-RAN å’Œ O-RAN ç­‰è¡Œä¸šè®¡åˆ’ä½¿ç•Œé¢èƒ½å¤Ÿç®¡ç†è¿™äº›è™šæ‹ŸåŒ–éƒ¨ç½²ï¼Œç±»ä¼¼äºç®¡ç†ä»»ä½•å…¶ä»–è¾¹ç¼˜è®¾å¤‡ã€‚è½¬å‘ RAN åŠŸèƒ½çš„äº‘åŸç”Ÿå®ä¾‹åŒ–ä½¿ç”¨åˆ©ç”¨ DevOps æ¨¡å‹çš„æŒç»­é›†æˆ (CI)/æŒç»­éƒ¨ç½² (CD) ç»“æ„æ¥ç®€åŒ–å¹¿æ³›çš„ RAN éƒ¨ç½²çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚\néƒ¨ç½²å’Œç®¡ç†è½¯ä»¶ RAN åŠŸèƒ½æ‰€éœ€çš„ä¸€ç»„åŸºç¡€è®¾æ–½å¯ä»¥å¹¿ä¹‰åœ°ç§°ä¸ºæ¥å…¥è¾¹ç¼˜ã€‚\nç½‘ç»œè¾¹ç¼˜ è¿™ç§è¾¹ç¼˜çš„å»¶è¿Ÿé¢„æœŸé€šå¸¸ä¹Ÿå°äº 10 - 40 æ¯«ç§’ã€‚\næ¥è‡ªå¤šä¸ª IoT è¾¹ç¼˜ã€æœ¬åœ°è¾¹ç¼˜å’Œæ¥å…¥è¾¹ç¼˜çš„æ•°æ®éœ€è¦èšåˆï¼Œä»¥æ»¡è¶³ç‰¹å®šåŒºåŸŸçš„éœ€æ±‚ï¼Œç„¶åæ‰èƒ½è¿æ¥åˆ°å¯ä»¥è·¨è¶Šå¤§é‡åŒºåŸŸçš„é›†ä¸­å¼æ•°æ®ä¸­å¿ƒã€‚\nè¿™ç§ç±»å‹çš„éƒ¨ç½²å¯ä»¥å¹¿ä¹‰åœ°ç§°ä¸ºâ€œç½‘ç»œè¾¹ç¼˜â€æˆ–ä¸æœåŠ¡æä¾›å•†çš„æ ¸å¿ƒæ•°æ®ä¸­å¿ƒç›¸å…³çš„è¿‘è¾¹ç¼˜ã€‚\nNext Generation Central Office (NGCO) æ¶æ„æ—¨åœ¨è§£å†³ç½‘ç»œè¾¹ç¼˜çš„è¦æ±‚ã€‚è¿™ç§è¾¹ç¼˜çš„å¦ä¸€ä¸ªä¾‹å­æ˜¯æœ‰çº¿å›ºå®šæ¥å…¥è¾¹ç¼˜ï¼Œå®ƒæä¾›å®½å¸¦æœåŠ¡ï¼Œå¦‚ IPTVã€VoIPã€äº’è”ç½‘æœåŠ¡ç­‰ã€‚\néšç€å›ºå®šç§»åŠ¨èåˆçš„å‡ºç°ï¼Œç”±äºæ¶æ„èåˆï¼Œè¯¥è¾¹ç¼˜çš„å„ç§è®¾å¤‡ç±»å‹ä¹‹é—´çš„ç•Œé™æ­£åœ¨å˜çª„ã€‚\næ€»ç»“ è¾¹ç¼˜è®¡ç®—æ­£ä»¥å„ç§éƒ¨ç½²æ¨¡å‹æˆä¸ºä¸»æµã€‚ä¸Šé¢åˆ†äº«çš„ 4 ç§ç±»å‹æä¾›äº†ä¸€ä¸ªç©ºé—´æˆ–åŸŸï¼Œäººä»¬å¯ä»¥åœ¨å…¶ä¸­æ“ä½œå¹¶ç»˜åˆ¶æ¥å£å’Œäº¤äº’ï¼Œä»¥ä¾¿èƒ½å¤Ÿè·¨è¾¹ç¼˜ç±»å‹è¿›è¡Œæ‰©å±•ã€‚å„ç§ç±»å‹çš„è¾¹ç¼˜è®¡ç®—ä¸­ä½¿ç”¨çš„æœ¯è¯­æ¯”ä¸Šé¢æ›´å¤šï¼Œä½†æ˜¯å½“è°ˆåˆ°å¾€è¿”å»¶è¿Ÿæ—¶ï¼Œå®ƒä»¬å¾ˆå¯èƒ½å±äºä¸Šè¿°æƒ…å†µã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/05/30/pexelspetrganaj4072563.jpg","permalink":"https://atbug.com/translate-4-types-edge-computing-by-latency/","tags":["è¾¹ç¼˜è®¡ç®—"],"title":"è¯‘ï¼šè¾¹ç¼˜è®¡ç®—çš„ 4 ç§ç±»å‹ï¼ˆå¤§è‡´åˆ†ç±»ï¼‰"},{"categories":["äº‘åŸç”Ÿ"],"contents":"åœ¨å¹³æ—¶çš„å·¥ä½œä¸­ï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰ç»å¸¸éœ€è¦æ„å»ºå®¹å™¨é•œåƒè¿›è¡Œæµ‹è¯•ï¼Œå¹¶ä¸”ä¸ä¸€å®šæ˜¯åœ¨æ„å»ºç¯å¢ƒä¸­ä½¿ç”¨é•œåƒã€‚è¿™æ—¶å€™å°±éœ€è¦å°†é•œåƒæ¨é€åˆ°é•œåƒä»“åº“åšä¸­è½¬ï¼Œç„¶ååœ¨åˆ«å¤„æ‹‰å–å¹¶è¿è¡Œå®¹å™¨ã€‚ä¹…è€Œä¹…ä¹‹ï¼Œå› ä¸ºå¿˜è®°æ¸…ç†é•œåƒä»“åº“ä¸­çš„â€œåƒåœ¾â€é•œåƒè¶Šæ¥è¶Šå¤šã€‚\nå½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç±»ä¼¼ Harbor è¿™ç§å¸¦æœ‰è‡ªåŠ¨æ¸…ç†åŠŸèƒ½é•œåƒä»“åº“ã€‚ä½†åªæ˜¯ä½œä¸ºä¸´æ—¶é•œåƒçš„ä¸­è½¬ï¼ŒHarbor è¿™ç§æœªå…å¤ªé‡äº†ã€‚\nä»Šå¤©è¦ä»‹ç»çš„ ttl.sh æ­£é€‚åˆå¤„ç†è¿™ç§åœºæ™¯ã€‚\nttl.sh ttl.sh æ˜¯ä¸€ä¸ªåŒ¿åçš„ä¸´æ—¶é•œåƒä»“åº“ï¼Œå…è´¹ä½¿ç”¨æ— éœ€ç™»å½•ï¼Œå¹¶ä¸”å·²ç»å¼€æºã€‚æ— éœ€ç™»å½•ï¼Œé•œåƒåç§°æœ¬èº«å°±æä¾›äº†ä¿å¯†æ€§ï¼Œæ¯”å¦‚ä½ å¯ä»¥ä½¿ç”¨ UUID æ¥ä½œä¸ºé•œåƒåç§°ï¼Œä½¿ç”¨åŒä¸€ä¸ª UUID æ¥æ¨é€å’Œæ‹‰å–é•œåƒã€‚\nä½¿ç”¨ ttl.sh çš„ä½¿ç”¨æ ¼å¤–ç®€å•ï¼Œè·Ÿå¹³æ—¶ä½¿ç”¨ Docker Hub æˆ–è€… Docker Registry æ²¡å·®åˆ«ï¼Œåªæ˜¯ tag çš„éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚\ndocker build æ„å»ºé•œåƒæ—¶é€šè¿‡ tag ä¸ºé•œåƒæŒ‡å®šæœ‰æ•ˆæœŸï¼Œæ¯”å¦‚ ttl.sh/b0a2c1c3-5751-4474-9dfe-6a9e17dfb927:1hã€‚æœ‰æ•ˆæœŸé»˜è®¤æ˜¯ 1 å°æ—¶ï¼Œæœ€é•¿æ˜¯ 24 å°æ—¶ã€‚æœ‰æ•ˆçš„ tag å¯ä»¥æ˜¯ 5mã€300sã€4hã€1dï¼Œå¦‚æœè¶…è¿‡ 24 å°æ—¶æœ‰æ•ˆæœŸä¼šè¢«è®¾ç½®ä¸º 24 å°æ—¶ï¼›å¦‚æœæ—¶é—´æ ¼å¼æ— æ•ˆï¼Œæœ‰æ•ˆæœŸè®¾ç½®ä¸ºé»˜è®¤çš„ 1 å°æ—¶ï¼› ä½¿ç”¨ docker push æ¨é€é•œåƒï¼› ä½¿ç”¨ docker pull æ‹‰å–é•œåƒã€‚ æ¯”å¦‚ï¼š\n# macOS ä¸‹é»˜è®¤ç”Ÿæˆå¤§å†™çš„ UUIDï¼Œéœ€è¦è½¬æˆå°å†™ï¼›Linux ä¸‹ç›´æ¥ä½¿ç”¨ uuidgen å³å¯ # docker é•œåƒä¸æ”¯æŒå¤§å†™é•œåƒå $ IMAGE_NAME=$(uuidgen | tr \u0026#34;[:upper:]\u0026#34; \u0026#34;[:lower:]\u0026#34;) $ docker build -t ttl.sh/${IMAGE_NAME}:5m . $ docker push ttl.sh/${IMAGE_NAME}:5m å®ç° ttl.sh çš„æºç å¼€æºåœ¨ GitHubï¼Œå®ç°ä¹Ÿä¸å¤æ‚ã€‚\nttl.sh åŸºäº Registry v2 çš„é•œåƒä»“åº“ï¼Œåˆ©ç”¨ Registry çš„ notification åŠŸèƒ½ï¼Œå°†é•œåƒçš„ push event å‘é€ç»™ Hooks web æœåŠ¡ã€‚\nHooks å°† event ä¸­çš„é•œåƒä¿¡æ¯è§£æå¹¶è®°å½•åœ¨ Redis ä¸­ï¼Œä¸»è¦æ˜¯è®°å½•é•œåƒçš„è¿‡æœŸæ—¶é—´ï¼›åŒæ—¶æœ‰ä¸ª Reaper çš„å®šæ—¶ä»»åŠ¡å®šæœŸä» Redis è·å–é•œåƒçš„ä¿¡æ¯ï¼Œè¿‡æœŸçš„é•œåƒä¼šè°ƒç”¨ Registry çš„ REST API è¿›è¡Œæ¸…ç†ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/05/29/shipgda90edbee1280.jpg","permalink":"https://atbug.com/store-ephemeral-image-in-ttl-registry/","tags":["Docker","é•œåƒ"],"title":"ttl.shï¼šä¸´æ—¶ Docker é•œåƒçš„åŒ¿åä»“åº“"},{"categories":["ç¬”è®°"],"contents":"è½¯ä»¶ä¾›åº”é“¾æ˜¯æŒ‡è¿›å…¥è½¯ä»¶ä¸­çš„æ‰€æœ‰å†…å®¹åŠå…¶æ¥æºï¼Œç®€å•åœ°å¯ä»¥ç†è§£æˆè½¯ä»¶çš„ä¾èµ–é¡¹ã€‚ä¾èµ–é¡¹æ˜¯è½¯ä»¶è¿è¡Œæ—¶æ‰€éœ€çš„é‡è¦å†…å®¹ï¼Œå¯ä»¥æ˜¯ä»£ç ã€äºŒè¿›åˆ¶æ–‡ä»¶æˆ–å…¶ä»–ç»„ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯è¿™äº›ç»„ä»¶çš„æ¥æºï¼Œæ¯”å¦‚å­˜å‚¨åº“æˆ–è€…åŒ…ç®¡ç†å™¨ä¹‹ç±»çš„ã€‚åŒ…æ‹¬ä»£ç çš„å·²çŸ¥æ¼æ´ã€å—æ”¯æŒçš„ç‰ˆæœ¬ã€è®¸å¯è¯ä¿¡æ¯ã€ä½œè€…ã€è´¡çŒ®æ—¶é—´ï¼Œä»¥åŠåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­çš„è¡Œä¸ºå’Œä»»ä½•æ—¶å€™æ¥è§¦åˆ°å®ƒçš„ä»»ä½•å†…å®¹ï¼Œæ¯”å¦‚ç”¨äºç¼–è¯‘ã€åˆ†å‘è½¯ä»¶çš„åŸºç¡€æ¶æ„ç»„ä»¶ã€‚\nCICD æµæ°´çº¿ä½œä¸ºåŸºç¡€æ¶æ„ç»„ä»¶ï¼Œæ‰¿æ‹…ç€è½¯ä»¶çš„æ„å»ºã€æµ‹è¯•ã€åˆ†å‘å’Œéƒ¨ç½²ã€‚ä½œä¸ºä¾›åº”é“¾çš„ä¸€ç¯ï¼Œå…¶ä¹Ÿæˆä¸ºæ¶æ„æ”»å‡»çš„ç›®æ ‡ã€‚CICD çš„è¡Œä¸ºä¿¡æ¯å¯ä»¥ä½œä¸ºå®‰å…¨å®¡æŸ¥çš„é‡è¦ä¾æ®ï¼Œæ¯”å¦‚æ„å»ºæ‰“åŒ…çš„ç¯å¢ƒã€æ“ä½œæµç¨‹ã€å¤„ç†ç»“æœç­‰ç­‰ã€‚\nä»Šå¤©ä»‹ç»çš„ Tekton Chainsï¼Œä¾¿æ˜¯è¿™æ ·çš„è¡Œä¸ºæ”¶é›†å·¥å…·ã€‚\nTekton Chains Chains æ˜¯ä¸€ä¸ª Kubernetes CRD æ§åˆ¶å™¨ï¼Œç”¨äºç®¡ç† Tekton ä¸­çš„ä¾›åº”é“¾å®‰å…¨ã€‚Chains ä½¿ Tekton èƒ½å¤Ÿåœ¨æŒç»­äº¤ä»˜ä¸­ï¼Œæ•è· PipelineRun å’Œ TaskRun è¿è¡Œçš„å…ƒæ•°æ®ç”¨äºå®‰å…¨å®¡è®¡ï¼Œå®ç°äºŒè¿›åˆ¶æº¯æºå’Œå¯éªŒè¯çš„æ„å»ºï¼Œæˆä¸ºæ„æˆä¿è¯ä¾›åº”é“¾å®‰å…¨çš„åŸºç¡€è®¾æ–½çš„ä¸€éƒ¨åˆ†ã€‚\nå½“å‰ Chainsï¼ˆv0.9.0ï¼‰æä¾›å¦‚ä¸‹åŠŸèƒ½ï¼š\nä½¿ç”¨ç”¨æˆ·æä¾›çš„åŠ å¯†å¯†é’¥ï¼Œå°† TaskRun çš„ç»“æœï¼ˆåŒ…å« TaskRun æœ¬èº«å’Œ OCI é•œåƒï¼‰é•œåƒè¿›è¡Œç­¾å æ”¯æŒç±»ä¼¼ in-toto çš„è¯æ˜æ ¼å¼ ä½¿ç”¨å¤šç§åŠ å¯†å¯†é’¥ç±»å‹å’ŒæœåŠ¡ï¼ˆx509ã€KMSï¼‰è¿›è¡Œç­¾å ç­¾åçš„å­˜å‚¨æ”¯æŒå¤šç§å®ç° æ¥ä¸‹æ¥çš„ Demoï¼Œæˆ‘ä»¬è¿˜æ˜¯ç»§ç»­ä½¿ç”¨ä¹‹å‰åœ¨ Tekton Pipeline å®æˆ˜ ç”¨çš„ Java é¡¹ç›® tekton-testï¼Œåœ¨ä»£ç ä¸­åŒæ ·è¿˜åŒ…å«äº† Pipeline å’Œ Task çš„å®šä¹‰ã€‚\nä¸ºäº†æ”¯æŒ Chainsï¼ŒåŸæœ‰ task å¢åŠ äº†æ–°çš„å‚æ•°ã€‚\nDemo ç¯å¢ƒå‡†å¤‡ ä½¿ç”¨ k3d å¿«é€Ÿæ­å»º k3s çš„é›†ç¾¤\nk3d cluster create tekton-test å®‰è£… Teketon Pipelines åŠ CLI\nkubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml brew install tektoncd-cli kubectl get po -n tekton-pipelines NAME READY STATUS RESTARTS AGE tekton-pipelines-webhook-7f5d9fc745-cr7th 1/1 Running 0 12m tekton-pipelines-controller-7c95d87d96-vvkgr 1/1 Running 0 12m å®‰è£… tekton chains\nkubectl apply --filename https://storage.googleapis.com/tekton-releases/chains/latest/release.yaml kubectl get po -n tekton-chains NAME READY STATUS RESTARTS AGE tekton-chains-controller-7d9fb75899-l9d4j 1/1 Running 0 9m8s å®‰è£…æµæ°´çº¿ï¼Œè¿™é‡Œè¿˜æ˜¯ä½¿ç”¨ tekton-test ä¸­çš„æµæ°´çº¿å®šä¹‰ï¼Œè¯¦ç»†çš„è¯´æ˜æŸ¥çœ‹Tekton Pipelines å®æˆ˜ ä¸­çš„è¯´æ˜ã€‚\ncd tekton-test/tekton #åˆ›å»ºsa kubectl apply -f serviceaccount.yaml # åˆ›å»º docker hub å‡­è¯ secretï¼Œè¿™é‡Œéœ€è¦å‘½ä»¤è¡Œå·¥å…· jq kubectl create secret docker-registry dockerhub --docker-server=https://index.docker.io/v1/ --docker-username=[USERNAME] --docker-password=[PASSWORD] --dry-run=client -o json | jq -r \u0026#39;.data.\u0026#34;.dockerconfigjson\u0026#34;\u0026#39; | base64 -d \u0026gt; /tmp/config.json \u0026amp;\u0026amp; kubectl create secret generic docker-config --from-file=/tmp/config.json -n tekton-pipelines \u0026amp;\u0026amp; rm -f /tmp/config.json #å®‰è£… git-clone task tkn hub install task git-clone #å®‰è£…é•œåƒæ„å»º task kubectl apply -f tasks/source-to-image.yaml #å®‰è£…éƒ¨ç½² task kubectl apply -f tasks/deploy-to-k8s.yaml #å®‰è£… pipeline kubectl apply -f pipeline/build-pipeline.yaml #æŸ¥çœ‹ task tkn t list NAME DESCRIPTION AGE git-clone These Tasks are Git... 2 minutes ago source-to-image 1 minute ago deploy-to-k8s 31 seconds ago #æŸ¥çœ‹ pipeline tkn p list NAME AGE LAST RUN STARTED DURATION STATUS build-pipeline 35 seconds ago --- --- --- --- é…ç½® 1. æ·»åŠ è®¤è¯å‡­è¯ Chains controller éœ€è¦ä½¿ç”¨è¿›è¡Œï¼š\nåœ¨é•œåƒç­¾åå®Œæˆåï¼Œå‘ OCI é•œåƒä»“åº“å‘é€ç­¾å åœ¨ä½¿ç”¨å¯†é’¥ç­¾åæ—¶ï¼Œä½¿ç”¨ Fulcio è·å–ç­¾åè¯ä¹¦ è¿™é‡Œæˆ‘ä»¬éœ€è¦é…ç½®ç”¨äºè®¿é—® Docker é•œåƒä»“åº“çš„å‡­è¯ï¼ŒChains controller ä½¿ç”¨æ‰§è¡Œ PipelineRun çš„ service account å°†é•œåƒç­¾åæ¨é€åˆ°é•œåƒä»“åº“ã€‚\nè¿™é‡Œç›´æ¥ä½¿ç”¨å‰é¢å®‰è£… pipeline æ—¶åˆ›å»ºçš„ secretï¼Œå¹¶æˆæƒ service account è®¿é—® secretã€‚\nkubectl patch serviceaccount tekton-build \\ -p \u0026#34;{\\\u0026#34;imagePullSecrets\\\u0026#34;: [{\\\u0026#34;name\\\u0026#34;: \\\u0026#34;docker-config\\\u0026#34;}]}\u0026#34; -n tekton-pipelines 2. ç­¾åå¯†é’¥ ä¸º Chains ç”Ÿæˆå¹¶é…ç½®ç”¨äºç­¾åçš„ç­¾åå¯†é’¥ï¼Œæ”¯æŒä¸‹é¢çš„ä»»ä½•ä¸€ç§æ–¹å¼ï¼š\nx509 Cosign KMS EXPERIMENTAL: Keyless signing æˆ‘ä»¬ä½¿ç”¨ cosign ï¼ˆå®‰è£…éå¸¸ç®€å•ï¼Œåœ¨ macOS ä¸Šæ‰§è¡Œ brew install cosignï¼‰åˆ›å»º secretï¼Œè¾“å…¥å¯†ç æ—¶ç›´æ¥å›è½¦ï¼Œä¸è®¾ç½®å¯†ç ã€‚\ncosign generate-key-pair k8s://tekton-chains/signing-secrets Enter password for private key: Enter password for private key again: Successfully created secret signing-secrets in namespace tekton-chains Public key written to cosign.pub ä¸‹é¢å°±æ˜¯åˆ›å»ºçš„åŒ…å«äº†å¯†é’¥çš„ secretã€‚\n3. é…ç½® Chains artifacts.taskrun.format=in-toto artifacts.taskrun.storage=tekton artifacts.taskrun.signer=x509 kubectl patch configmap chains-config -n tekton-chains -p=\u0026#39;{\u0026#34;data\u0026#34;:{\u0026#34;artifacts.taskrun.format\u0026#34;: \u0026#34;in-toto\u0026#34;}}\u0026#39; kubectl patch configmap chains-config -n tekton-chains -p=\u0026#39;{\u0026#34;data\u0026#34;:{\u0026#34;artifacts.taskrun.storage\u0026#34;: \u0026#34;tekton\u0026#34;}}\u0026#39; kubectl patch configmap chains-config -n tekton-chains -p=\u0026#39;{\u0026#34;data\u0026#34;:{\u0026#34;artifacts.taskrun.signer\u0026#34;: \u0026#34;x509\u0026#34;}}\u0026#39; éªŒè¯ åˆ›å»º PipelineRun å¼€å§‹æ‰§è¡Œ Pipelineã€‚\n#tekton-test æ ¹ç›®å½• kubectl apply -f ./tekton/run/run.yaml pipelinerun.tekton.dev/generic-pipeline-run created æ‰§è¡Œå®Œæˆåï¼Œæ£€æŸ¥ TaskRun çš„è¿è¡Œç»“æœã€‚\ntkn tr list NAME STARTED DURATION STATUS generic-pipeline-run-source-to-image 1 minute ago 1 minute Succeeded generic-pipeline-run-fetch-from-git 1 minute ago 11 seconds Succeeded kubectl get tr generic-pipeline-run-source-to-image -o json | jq -r .metadata.annotations { \u0026#34;chains.tekton.dev/cert-taskrun-5bf67bed-af59-4744-a6a7-487de359cbae\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;chains.tekton.dev/chain-taskrun-5bf67bed-af59-4744-a6a7-487de359cbae\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;chains.tekton.dev/payload-taskrun-5bf67bed-af59-4744-a6a7-487de359cbae\u0026#34;: \u0026#34;eyJfdHlwZSI6Imh0dHBzOi8vaW4tdG90by5pby9TdGF0ZW1lbnQvdjAuMSIsInByZWRpY2F0ZVR5cGUiOiJodHRwczovL3Nsc2EuZGV2L3Byb3ZlbmFuY2UvdjAuMiIsInN1YmplY3QiOlt7Im5hbWUiOiJpbmRleC5kb2NrZXIuaW8vYWRkb3poYW5nL3Rla3Rvbi10ZXN0IiwiZGlnZXN0Ijp7InNoYTI1NiI6ImFjYmQ5OWY4YmUwMDNlOGI3ZTc3NjY1ZWUwZTMzMmU5NmRhMmNiNTRiMzI3MTk4YWJiNDY3MWM4ZGIxZTk5OGEifX1dLCJwcmVkaWNhdGUiOnsiYnVpbGRlciI6eyJpZCI6Imh0dHBzOi8vdGVrdG9uLmRldi9jaGFpbnMvdjIifSwiYnVpbGRUeXBlIjoiaHR0cHM6Ly90ZWt0b24uZGV2L2F0dGVzdGF0aW9ucy9jaGFpbnNAdjIiLCJpbnZvY2F0aW9uIjp7ImNvbmZpZ1NvdXJjZSI6e30sInBhcmFtZXRlcnMiOnsiQ0hBSU5TLUdJVF9DT01NSVQiOiJ7c3RyaW5nIDQ2OTMxZmJjZjAzMDMyMGMzOTlmZjljMzA1MGQ2YjczMTI1OWFiZmMgW119IiwiQ0hBSU5TLUdJVF9VUkwiOiJ7c3RyaW5nIGh0dHBzOi8vZ2l0aHViLmNvbS9hZGRvemhhbmcvdGVrdG9uLXRlc3QuZ2l0IFtdfSIsIklNQUdFIjoie3N0cmluZyBhZGRvemhhbmcvdGVrdG9uLXRlc3QgW119IiwiaW1hZ2VUYWciOiJsYXRlc3QiLCJpbWFnZVVybCI6IntzdHJpbmcgYWRkb3poYW5nL3Rla3Rvbi10ZXN0IFtdfSIsInBhdGhUb0RvY2tlckZpbGUiOiJEb2NrZXJmaWxlIn19LCJidWlsZENvbmZpZyI6eyJzdGVwcyI6W3siZW50cnlQb2ludCI6Im12biIsImFyZ3VtZW50cyI6WyJjbGVhbiIsImluc3RhbGwiLCItRHNraXBUZXN0cyJdLCJlbnZpcm9ubWVudCI6eyJjb250YWluZXIiOiJtYXZlbiIsImltYWdlIjoiZG9ja2VyLmlvL2xpYnJhcnkvbWF2ZW5Ac2hhMjU2OjcyOTIyYWJjOTVkMzhlMDJmNzUwYjM0ODAwMjM5ZGMwZTJjMjk4ZTc0YmZkZDk3MDAxODM2N2YwZDkyODFkNWMifSwiYW5ub3RhdGlvbnMiOm51bGx9LHsiZW50cnlQb2ludCI6Ii9rYW5pa28vZXhlY3V0b3IiLCJhcmd1bWVudHMiOlsiLS1kb2NrZXJmaWxlPSQocGFyYW1zLnBhdGhUb0RvY2tlckZpbGUpIiwiLS1kZXN0aW5hdGlvbj0kKHBhcmFtcy5pbWFnZVVybCk6JChwYXJhbXMuaW1hZ2VUYWcpIiwiLS1jb250ZXh0PSQod29ya3NwYWNlcy5zb3VyY2UucGF0aCkiLCItLWRpZ2VzdC1maWxlPSQocmVzdWx0cy5JTUFHRV9ESUdFU1QucGF0aCkiXSwiZW52aXJvbm1lbnQiOnsiY29udGFpbmVyIjoiYnVpbGQtYW5kLXB1c2giLCJpbWFnZSI6Imdjci5pby9rYW5pa28tcHJvamVjdC9leGVjdXRvckBzaGEyNTY6ZmNjY2QyYWI5ZjM4OTJlMzNmYzdmMmU5NTBjOGU0ZmM2NjVlN2E0YzY2ZjZhOWQ3MGIzMDBkN2EyMTAzNTkyZiJ9LCJhbm5vdGF0aW9ucyI6bnVsbH0seyJlbnRyeVBvaW50Ijoic2V0IC1lXG5lY2hvICQocGFyYW1zLklNQUdFKSB8IHRlZSAkKHJlc3VsdHMuSU1BR0VfVVJMLnBhdGgpICAgICAgICBcbiIsImFyZ3VtZW50cyI6bnVsbCwiZW52aXJvbm1lbnQiOnsiY29udGFpbmVyIjoid3JpdGUtdXJsIiwiaW1hZ2UiOiJkb2NrZXIuaW8vbGlicmFyeS9iYXNoQHNoYTI1NjpiM2FiZTQyNTU3MDY2MThjNTUwZThkYjVlYzA4NzUzMjgzMzNhMTRkYmY2NjNlNmYxZTJiNjg3NWY0NTUyMWU1In0sImFubm90YXRpb25zIjpudWxsfV19LCJtZXRhZGF0YSI6eyJidWlsZFN0YXJ0ZWRPbiI6IjIwMjItMDUtMTRUMDU6NDI6MTFaIiwiYnVpbGRGaW5pc2hlZE9uIjoiMjAyMi0wNS0xNFQwNTo0Mjo0MloiLCJjb21wbGV0ZW5lc3MiOnsicGFyYW1ldGVycyI6ZmFsc2UsImVudmlyb25tZW50IjpmYWxzZSwibWF0ZXJpYWxzIjpmYWxzZX0sInJlcHJvZHVjaWJsZSI6ZmFsc2V9LCJtYXRlcmlhbHMiOlt7InVyaSI6ImdpdCtodHRwczovL2dpdGh1Yi5jb20vYWRkb3poYW5nL3Rla3Rvbi10ZXN0LmdpdC5naXQiLCJkaWdlc3QiOnsic2hhMSI6IjQ2OTMxZmJjZjAzMDMyMGMzOTlmZjljMzA1MGQ2YjczMTI1OWFiZmMifX1dfX0=\u0026#34;, \u0026#34;chains.tekton.dev/retries\u0026#34;: \u0026#34;0\u0026#34;, \u0026#34;chains.tekton.dev/signature-taskrun-5bf67bed-af59-4744-a6a7-487de359cbae\u0026#34;: \u0026#34;eyJwYXlsb2FkVHlwZSI6ImFwcGxpY2F0aW9uL3ZuZC5pbi10b3RvK2pzb24iLCJwYXlsb2FkIjoiZXlKZmRIbHdaU0k2SW1oMGRIQnpPaTh2YVc0dGRHOTBieTVwYnk5VGRHRjBaVzFsYm5RdmRqQXVNU0lzSW5CeVpXUnBZMkYwWlZSNWNHVWlPaUpvZEhSd2N6b3ZMM05zYzJFdVpHVjJMM0J5YjNabGJtRnVZMlV2ZGpBdU1pSXNJbk4xWW1wbFkzUWlPbHQ3SW01aGJXVWlPaUpwYm1SbGVDNWtiMk5yWlhJdWFXOHZZV1JrYjNwb1lXNW5MM1JsYTNSdmJpMTBaWE4wSWl3aVpHbG5aWE4wSWpwN0luTm9ZVEkxTmlJNkltRmpZbVE1T1dZNFltVXdNRE5sT0dJM1pUYzNOalkxWldVd1pUTXpNbVU1Tm1SaE1tTmlOVFJpTXpJM01UazRZV0ppTkRZM01XTTRaR0l4WlRrNU9HRWlmWDFkTENKd2NtVmthV05oZEdVaU9uc2lZblZwYkdSbGNpSTZleUpwWkNJNkltaDBkSEJ6T2k4dmRHVnJkRzl1TG1SbGRpOWphR0ZwYm5NdmRqSWlmU3dpWW5WcGJHUlVlWEJsSWpvaWFIUjBjSE02THk5MFpXdDBiMjR1WkdWMkwyRjBkR1Z6ZEdGMGFXOXVjeTlqYUdGcGJuTkFkaklpTENKcGJuWnZZMkYwYVc5dUlqcDdJbU52Ym1acFoxTnZkWEpqWlNJNmUzMHNJbkJoY21GdFpYUmxjbk1pT25zaVEwaEJTVTVUTFVkSlZGOURUMDFOU1ZRaU9pSjdjM1J5YVc1bklEUTJPVE14Wm1KalpqQXpNRE15TUdNek9UbG1aamxqTXpBMU1HUTJZamN6TVRJMU9XRmlabU1nVzExOUlpd2lRMGhCU1U1VExVZEpWRjlWVWt3aU9pSjdjM1J5YVc1bklHaDBkSEJ6T2k4dloybDBhSFZpTG1OdmJTOWhaR1J2ZW1oaGJtY3ZkR1ZyZEc5dUxYUmxjM1F1WjJsMElGdGRmU0lzSWtsTlFVZEZJam9pZTNOMGNtbHVaeUJoWkdSdmVtaGhibWN2ZEdWcmRHOXVMWFJsYzNRZ1cxMTlJaXdpYVcxaFoyVlVZV2NpT2lKc1lYUmxjM1FpTENKcGJXRm5aVlZ5YkNJNkludHpkSEpwYm1jZ1lXUmtiM3BvWVc1bkwzUmxhM1J2YmkxMFpYTjBJRnRkZlNJc0luQmhkR2hVYjBSdlkydGxja1pwYkdVaU9pSkViMk5yWlhKbWFXeGxJbjE5TENKaWRXbHNaRU52Ym1acFp5STZleUp6ZEdWd2N5STZXM3NpWlc1MGNubFFiMmx1ZENJNkltMTJiaUlzSW1GeVozVnRaVzUwY3lJNld5SmpiR1ZoYmlJc0ltbHVjM1JoYkd3aUxDSXRSSE5yYVhCVVpYTjBjeUpkTENKbGJuWnBjbTl1YldWdWRDSTZleUpqYjI1MFlXbHVaWElpT2lKdFlYWmxiaUlzSW1sdFlXZGxJam9pWkc5amEyVnlMbWx2TDJ4cFluSmhjbmt2YldGMlpXNUFjMmhoTWpVMk9qY3lPVEl5WVdKak9UVmtNemhsTURKbU56VXdZak0wT0RBd01qTTVaR013WlRKak1qazRaVGMwWW1aa1pEazNNREF4T0RNMk4yWXdaRGt5T0RGa05XTWlmU3dpWVc1dWIzUmhkR2x2Ym5NaU9tNTFiR3g5TEhzaVpXNTBjbmxRYjJsdWRDSTZJaTlyWVc1cGEyOHZaWGhsWTNWMGIzSWlMQ0poY21kMWJXVnVkSE1pT2xzaUxTMWtiMk5yWlhKbWFXeGxQU1FvY0dGeVlXMXpMbkJoZEdoVWIwUnZZMnRsY2tacGJHVXBJaXdpTFMxa1pYTjBhVzVoZEdsdmJqMGtLSEJoY21GdGN5NXBiV0ZuWlZWeWJDazZKQ2h3WVhKaGJYTXVhVzFoWjJWVVlXY3BJaXdpTFMxamIyNTBaWGgwUFNRb2QyOXlhM053WVdObGN5NXpiM1Z5WTJVdWNHRjBhQ2tpTENJdExXUnBaMlZ6ZEMxbWFXeGxQU1FvY21WemRXeDBjeTVKVFVGSFJWOUVTVWRGVTFRdWNHRjBhQ2tpWFN3aVpXNTJhWEp2Ym0xbGJuUWlPbnNpWTI5dWRHRnBibVZ5SWpvaVluVnBiR1F0WVc1a0xYQjFjMmdpTENKcGJXRm5aU0k2SW1kamNpNXBieTlyWVc1cGEyOHRjSEp2YW1WamRDOWxlR1ZqZFhSdmNrQnphR0V5TlRZNlptTmpZMlF5WVdJNVpqTTRPVEpsTXpObVl6ZG1NbVU1TlRCak9HVTBabU0yTmpWbE4yRTBZelkyWmpaaE9XUTNNR0l6TURCa04yRXlNVEF6TlRreVppSjlMQ0poYm01dmRHRjBhVzl1Y3lJNmJuVnNiSDBzZXlKbGJuUnllVkJ2YVc1MElqb2ljMlYwSUMxbFhHNWxZMmh2SUNRb2NHRnlZVzF6TGtsTlFVZEZLU0I4SUhSbFpTQWtLSEpsYzNWc2RITXVTVTFCUjBWZlZWSk1MbkJoZEdncElDQWdJQ0FnSUNCY2JpSXNJbUZ5WjNWdFpXNTBjeUk2Ym5Wc2JDd2laVzUyYVhKdmJtMWxiblFpT25zaVkyOXVkR0ZwYm1WeUlqb2lkM0pwZEdVdGRYSnNJaXdpYVcxaFoyVWlPaUprYjJOclpYSXVhVzh2YkdsaWNtRnllUzlpWVhOb1FITm9ZVEkxTmpwaU0yRmlaVFF5TlRVM01EWTJNVGhqTlRVd1pUaGtZalZsWXpBNE56VXpNamd6TXpOaE1UUmtZbVkyTmpObE5tWXhaVEppTmpnM05XWTBOVFV5TVdVMUluMHNJbUZ1Ym05MFlYUnBiMjV6SWpwdWRXeHNmVjE5TENKdFpYUmhaR0YwWVNJNmV5SmlkV2xzWkZOMFlYSjBaV1JQYmlJNklqSXdNakl0TURVdE1UUlVNRFU2TkRJNk1URmFJaXdpWW5WcGJHUkdhVzVwYzJobFpFOXVJam9pTWpBeU1pMHdOUzB4TkZRd05UbzBNam8wTWxvaUxDSmpiMjF3YkdWMFpXNWxjM01pT25zaWNHRnlZVzFsZEdWeWN5STZabUZzYzJVc0ltVnVkbWx5YjI1dFpXNTBJanBtWVd4elpTd2liV0YwWlhKcFlXeHpJanBtWVd4elpYMHNJbkpsY0hKdlpIVmphV0pzWlNJNlptRnNjMlY5TENKdFlYUmxjbWxoYkhNaU9sdDdJblZ5YVNJNkltZHBkQ3RvZEhSd2N6b3ZMMmRwZEdoMVlpNWpiMjB2WVdSa2IzcG9ZVzVuTDNSbGEzUnZiaTEwWlhOMExtZHBkQzVuYVhRaUxDSmthV2RsYzNRaU9uc2ljMmhoTVNJNklqUTJPVE14Wm1KalpqQXpNRE15TUdNek9UbG1aamxqTXpBMU1HUTJZamN6TVRJMU9XRmlabU1pZlgxZGZYMD0iLCJzaWduYXR1cmVzIjpbeyJrZXlpZCI6IlNIQTI1NjppRlk2RVhnWWt5enlabzgxU29MS1FPRy9CdjZyZnorZFYrMkZxNXFjY2NBIiwic2lnIjoiTUVVQ0lRREZ4bzE0bzVldDFRVkJKUklQK3liSlhmQ2VFTjJaK3ZFNWROQlpMQmhvSWdJZ0hwL3B4VDF0SDZleHF0d2x2UStML0prazhXVFMzbTJhL1BWN3AzeEdrTkE9In1dfQ==\u0026#34;, \u0026#34;kubectl.kubernetes.io/last-applied-configuration\u0026#34;: \u0026#34;{\\\u0026#34;apiVersion\\\u0026#34;:\\\u0026#34;tekton.dev/v1beta1\\\u0026#34;,\\\u0026#34;kind\\\u0026#34;:\\\u0026#34;PipelineRun\\\u0026#34;,\\\u0026#34;metadata\\\u0026#34;:{\\\u0026#34;annotations\\\u0026#34;:{},\\\u0026#34;generateName\\\u0026#34;:\\\u0026#34;generic-pr-\\\u0026#34;,\\\u0026#34;name\\\u0026#34;:\\\u0026#34;generic-pipeline-run\\\u0026#34;,\\\u0026#34;namespace\\\u0026#34;:\\\u0026#34;tekton-pipelines\\\u0026#34;},\\\u0026#34;spec\\\u0026#34;:{\\\u0026#34;params\\\u0026#34;:[{\\\u0026#34;name\\\u0026#34;:\\\u0026#34;git-revision\\\u0026#34;,\\\u0026#34;value\\\u0026#34;:\\\u0026#34;main\\\u0026#34;},{\\\u0026#34;name\\\u0026#34;:\\\u0026#34;git-url\\\u0026#34;,\\\u0026#34;value\\\u0026#34;:\\\u0026#34;https://github.com/addozhang/tekton-test.git\\\u0026#34;},{\\\u0026#34;name\\\u0026#34;:\\\u0026#34;imageUrl\\\u0026#34;,\\\u0026#34;value\\\u0026#34;:\\\u0026#34;addozhang/tekton-test\\\u0026#34;},{\\\u0026#34;name\\\u0026#34;:\\\u0026#34;imageTag\\\u0026#34;,\\\u0026#34;value\\\u0026#34;:\\\u0026#34;latest\\\u0026#34;}],\\\u0026#34;pipelineRef\\\u0026#34;:{\\\u0026#34;name\\\u0026#34;:\\\u0026#34;build-pipeline\\\u0026#34;},\\\u0026#34;serviceAccountName\\\u0026#34;:\\\u0026#34;tekton-build\\\u0026#34;,\\\u0026#34;workspaces\\\u0026#34;:[{\\\u0026#34;name\\\u0026#34;:\\\u0026#34;git-source\\\u0026#34;,\\\u0026#34;volumeClaimTemplate\\\u0026#34;:{\\\u0026#34;spec\\\u0026#34;:{\\\u0026#34;accessModes\\\u0026#34;:[\\\u0026#34;ReadWriteOnce\\\u0026#34;],\\\u0026#34;resources\\\u0026#34;:{\\\u0026#34;requests\\\u0026#34;:{\\\u0026#34;storage\\\u0026#34;:\\\u0026#34;1Gi\\\u0026#34;}}}}},{\\\u0026#34;name\\\u0026#34;:\\\u0026#34;docker-config\\\u0026#34;,\\\u0026#34;secret\\\u0026#34;:{\\\u0026#34;secretName\\\u0026#34;:\\\u0026#34;docker-config\\\u0026#34;}}]}}\\n\u0026#34;, \u0026#34;pipeline.tekton.dev/affinity-assistant\u0026#34;: \u0026#34;affinity-assistant-876633b0fe\u0026#34;, \u0026#34;pipeline.tekton.dev/release\u0026#34;: \u0026#34;422a468\u0026#34; } å°† payload çš„å†…å®¹è§£ç å¯ä»¥çœ‹åˆ° TaskRun çš„è¾“å…¥ã€è¾“å‡ºä»¥åŠ Task æœ¬èº«ä½¿ç”¨çš„é•œåƒç­‰ä¿¡æ¯ã€‚\n{ \u0026#34;_type\u0026#34;: \u0026#34;https://in-toto.io/Statement/v0.1\u0026#34;, \u0026#34;predicateType\u0026#34;: \u0026#34;https://slsa.dev/provenance/v0.2\u0026#34;, \u0026#34;subject\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;index.docker.io/addozhang/tekton-test\u0026#34;, \u0026#34;digest\u0026#34;: { \u0026#34;sha256\u0026#34;: \u0026#34;acbd99f8be003e8b7e77665ee0e332e96da2cb54b327198abb4671c8db1e998a\u0026#34; } } ], \u0026#34;predicate\u0026#34;: { \u0026#34;builder\u0026#34;: { \u0026#34;id\u0026#34;: \u0026#34;https://tekton.dev/chains/v2\u0026#34; }, \u0026#34;buildType\u0026#34;: \u0026#34;https://tekton.dev/attestations/chains@v2\u0026#34;, \u0026#34;invocation\u0026#34;: { \u0026#34;configSource\u0026#34;: {}, \u0026#34;parameters\u0026#34;: { \u0026#34;CHAINS-GIT_COMMIT\u0026#34;: \u0026#34;{string 46931fbcf030320c399ff9c3050d6b731259abfc []}\u0026#34;, \u0026#34;CHAINS-GIT_URL\u0026#34;: \u0026#34;{string https://github.com/addozhang/tekton-test.git []}\u0026#34;, \u0026#34;IMAGE\u0026#34;: \u0026#34;{string addozhang/tekton-test []}\u0026#34;, \u0026#34;imageTag\u0026#34;: \u0026#34;latest\u0026#34;, \u0026#34;imageUrl\u0026#34;: \u0026#34;{string addozhang/tekton-test []}\u0026#34;, \u0026#34;pathToDockerFile\u0026#34;: \u0026#34;Dockerfile\u0026#34; } }, \u0026#34;buildConfig\u0026#34;: { \u0026#34;steps\u0026#34;: [ { \u0026#34;entryPoint\u0026#34;: \u0026#34;mvn\u0026#34;, \u0026#34;arguments\u0026#34;: [ \u0026#34;clean\u0026#34;, \u0026#34;install\u0026#34;, \u0026#34;-DskipTests\u0026#34; ], \u0026#34;environment\u0026#34;: { \u0026#34;container\u0026#34;: \u0026#34;maven\u0026#34;, \u0026#34;image\u0026#34;: \u0026#34;docker.io/library/maven@sha256:72922abc95d38e02f750b34800239dc0e2c298e74bfdd970018367f0d9281d5c\u0026#34; }, \u0026#34;annotations\u0026#34;: null }, { \u0026#34;entryPoint\u0026#34;: \u0026#34;/kaniko/executor\u0026#34;, \u0026#34;arguments\u0026#34;: [ \u0026#34;--dockerfile=$(params.pathToDockerFile)\u0026#34;, \u0026#34;--destination=$(params.imageUrl):$(params.imageTag)\u0026#34;, \u0026#34;--context=$(workspaces.source.path)\u0026#34;, \u0026#34;--digest-file=$(results.IMAGE_DIGEST.path)\u0026#34; ], \u0026#34;environment\u0026#34;: { \u0026#34;container\u0026#34;: \u0026#34;build-and-push\u0026#34;, \u0026#34;image\u0026#34;: \u0026#34;gcr.io/kaniko-project/executor@sha256:fcccd2ab9f3892e33fc7f2e950c8e4fc665e7a4c66f6a9d70b300d7a2103592f\u0026#34; }, \u0026#34;annotations\u0026#34;: null }, { \u0026#34;entryPoint\u0026#34;: \u0026#34;set -e\\necho $(params.IMAGE) | tee $(results.IMAGE_URL.path) \\n\u0026#34;, \u0026#34;arguments\u0026#34;: null, \u0026#34;environment\u0026#34;: { \u0026#34;container\u0026#34;: \u0026#34;write-url\u0026#34;, \u0026#34;image\u0026#34;: \u0026#34;docker.io/library/bash@sha256:b3abe4255706618c550e8db5ec0875328333a14dbf663e6f1e2b6875f45521e5\u0026#34; }, \u0026#34;annotations\u0026#34;: null } ] }, \u0026#34;metadata\u0026#34;: { \u0026#34;buildStartedOn\u0026#34;: \u0026#34;2022-05-14T05:42:11Z\u0026#34;, \u0026#34;buildFinishedOn\u0026#34;: \u0026#34;2022-05-14T05:42:42Z\u0026#34;, \u0026#34;completeness\u0026#34;: { \u0026#34;parameters\u0026#34;: false, \u0026#34;environment\u0026#34;: false, \u0026#34;materials\u0026#34;: false }, \u0026#34;reproducible\u0026#34;: false }, \u0026#34;materials\u0026#34;: [ { \u0026#34;uri\u0026#34;: \u0026#34;git+https://github.com/addozhang/tekton-test.git.git\u0026#34;, \u0026#34;digest\u0026#34;: { \u0026#34;sha1\u0026#34;: \u0026#34;46931fbcf030320c399ff9c3050d6b731259abfc\u0026#34; } } ] } } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/05/14/pexelsjoeykyber119562.jpg","permalink":"https://atbug.com/tekton-chains-secure-supply-chain/","tags":["CICD","Tekton","Security","äº‘åŸç”Ÿ"],"title":"CICD çš„ä¾›åº”é“¾å®‰å…¨å·¥å…· Tekton Chains"},{"categories":["å·¥å…·"],"contents":"æœ¬äººç®—æ˜¯ä¸ª Alfred çš„é‡åº¦ä¾èµ–è€…äº†ï¼ˆä¸Šå›¾æ˜¯å»å¹´æ¢äº†æ–°ç”µè„‘åçš„ä½¿ç”¨æ•°æ®ï¼‰ï¼ŒAlfred ä¹Ÿç®— Mac ä¸Šçš„ç¬¬ä¸€æ¬¾ä»˜è´¹è½¯ä»¶ï¼Œä¹°çš„ mega ç‰ˆã€‚å®‰è£…çš„ workflow ä¼°è®¡æœ‰å‡ åä¸ªï¼Œä¸è¿‡å¸¸ç”¨çš„ä¼°è®¡æœ‰åå‡ ä¸ªå§ã€‚\nç”¨äº†å‡ å¹´ï¼Œä¸€ç›´éƒ½ç§‰æ‰¿ç€èƒ½ä¸é€ è½®å­å°±ä¸é€ çš„åŸåˆ™ï¼ŒåŸºæœ¬ä¹Ÿéƒ½èƒ½æ‰¾åˆ°æƒ³è¦çš„ workflowã€‚ä¸ºä»€ä¹ˆçªç„¶è¦å†™ä¸ª workflowï¼Œè¿™è¦ä» macOS 12.3 ç§»é™¤äº† Python2 è¯´èµ·ã€‚è‡ªä»å‡çº§äº† 12.3ï¼Œå¥½å¤š workflow éƒ½æ— æ³•æ­£å¸¸å·¥ä½œäº†ï¼Œå…¶ä¸­å°±æœ‰å¸¸ç”¨çš„ Safari å†å²æœç´¢ã€‚è‹¦ç­‰äº†ä¸€æ®µæ—¶é—´ï¼Œä¹Ÿä¸è§ä½œè€…æ›´æ–°ï¼Œä¸å¾—å·²è‡ªå·±ä¸‹åœºæ¥å†™ã€‚æ­£å¥½äº”ä¸€å‡æœŸæœ‰æ—¶é—´ï¼Œé¡ºä¾¿è¿œç¦»å·¥ä½œæ”¾ç©ºä¸€ä¸‹ã€‚\næœç´¢åçœ‹åˆ°äº†å¦‚ä½•ä½¿ç”¨ Go ç¼–å†™ workflow è¿™ç¯‡æ–‡ç« ï¼Œå°±å‡†å¤‡ç”¨ Go æ¥å†™ã€‚ç„¶åå°±æœ‰äº†æˆ‘çš„ç¬¬ä¸€ä¸ª workflowï¼šSafari Toolkitã€‚\nç°åœ¨æ˜¯å®ç°äº†åŸ workflow çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¯¹ Safari çš„è®¿é—®å†å²è¿›è¡Œæœç´¢ï¼šåŸºäº URL å’Œ Titleï¼Œç„¶åé€‰æ‹©æœç´¢ç»“æœåœ¨ Safari ä¸­æ‰“å¼€ã€‚\nåé¢è®¡åˆ’æŠ½æ—¶é—´å†åŠ ä¸Š tab çš„æœç´¢ï¼Œä¸è¿‡ç›®å‰æ„æ„¿ä¸å¼ºï¼ŒSearch Safari and Chrome Tabs å·²ç»è¶³å¤Ÿç”¨äº†ã€‚\nåˆšå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥ä»è¿™é‡Œä¸‹è½½è¯•ç”¨ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/05/03/20220503-at-213907.png","permalink":"https://atbug.com/create-an-alfred-workflow/","tags":["Aflred"],"title":"æ’¸ä¸€ä¸ª Alfred Workflow"},{"categories":["ç¬”è®°"],"contents":"ç›®å‰æˆ‘ä½¿ç”¨ Calibre è½¯ä»¶æ¥ç®¡ç†ç”µå­ä¹¦ï¼Œç”µå­ä¹¦å¤‡ä»½åœ¨ iCloud ä¸­ã€‚ä½†æ˜¯æ¯æ¬¡æ¨é€ç”µå­ä¹¦åˆ° Kindle éƒ½è¦æ‰“å¼€ç”µè„‘ï¼Œæ„Ÿè§‰ä¸å¤Ÿæ–¹ä¾¿ã€‚å¦‚æœèƒ½åœ¨æ‰‹æœºç«¯å°±å¯ä»¥æ“ä½œå²‚ä¸æ˜¯æ›´é¦™ã€‚\né‚å°†ç›®æ ‡ç„å‘äº† calibre-webï¼Œè¿™ä¸ªç±»ä¼¼ calibre çš„ web ç«¯ã€‚å¯ä»¥æµè§ˆã€ä¸‹è½½ Calibre æ•°æ®åº“ä¸­ä¿å­˜çš„ä¹¦ç±ï¼Œä¹Ÿæœ‰ Docker é•œåƒæä¾›ã€‚æˆ‘æœ‰ä¸€ä¸ª x86 çš„è™šæ‹Ÿæœºç”¨æ¥è¡¥å…¨ m1 çš„çŸ­æ¿ï¼Œå¯ä»¥ç”¨æ¥è¿è¡Œ calibre-web å®¹å™¨ã€‚\næ¥ä¸‹æ¥å°±æ˜¯æ•°æ®çš„æŒä¹…åŒ–äº†ã€‚ä¼—æ‰€å‘¨çŸ¥ iCloud ä¸€å¦‚ Apple çš„ç³»ç»Ÿä¸€æ ·å°é—­ï¼Œæ— æ³•åœ¨ Linux ä¸Šä½¿ç”¨ã€‚æƒ³èµ· Google Drive æœ‰ 15GB çš„å…ï¼ˆbaiï¼‰è´¹ï¼ˆpiaoï¼‰ç©ºé—´ï¼Œå¯ä»¥ç”¨æ¥å¤‡ä»½ç”µå­ä¹¦ã€‚è®°å¾— Rclone å¯ä»¥æ”¯æŒ Google Drive çš„åŒæ­¥ï¼ˆç½‘ç»œé—®é¢˜ä¸åœ¨è®¨è®ºèŒƒå›´ï¼‰ï¼Œè™½ç„¶åªæœ‰å•å‘åŒæ­¥ä½†æ­£å¥½æ»¡è¶³æˆ‘çš„éœ€æ±‚ã€‚\nä¸Šé¢å°±æ˜¯æœ€ç»ˆçš„ç†æƒ³è®¾è®¡äº†ï¼Œè¿™ç¯‡å…ˆè¿›è¡Œè™šæ‹Ÿæœºçš„å®‰è£…å®ç°æœ¬åœ°æ–‡ä»¶åˆ° Google Drive çš„åŒæ­¥ã€‚\nRclone Rclone æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œç¨‹åºï¼Œç”¨äºç®¡ç†äº‘å­˜å‚¨ä¸Šçš„æ–‡ä»¶ã€‚å®ƒæ˜¯ä¸€ä¸ªå¼€æºçš„è½¯ä»¶ï¼Œçµæ„Ÿæ¥è‡ª rsyncã€‚æ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿï¼Œä»¥åŠ x86ã€arm è®¡ç®—æ¶æ„ã€‚\nRclone æ”¯æŒçš„äº‘å­˜å‚¨æœ‰ 60 å¤šç§ï¼Œå…·ä½“åˆ—è¡¨å¯ä»¥å‚è€ƒè¿™é‡Œã€‚\nåŠ¨æ‰‹ Google API client_id Rclone è®¿é—® Google Driveï¼Œéœ€è¦é€šè¿‡ Google API æ¥å®Œæˆã€‚é¦–å…ˆæˆ‘ä»¬è¦ä¸ºåˆ›å»º Rclone åˆ›å»ºä¸€ä¸ª client_idï¼Œè¯¦ç»†æ­¥éª¤å‚è€ƒè¿™é‡Œã€‚\né…ç½® Rclone å‘½ä»¤è¡Œä¸­è¾“å…¥ rclone configï¼Œç„¶åæŒ‰ç…§è¯¦ç»†æ­¥éª¤ä¸€æ­¥æ­¥å®Œæˆé…ç½®ã€‚\nç”±äºåœ¨åˆ›å»º client_id æ—¶ï¼Œåº”ç”¨ç±»å‹é€‰çš„æ˜¯â€œæ¡Œé¢â€åº”ç”¨ã€‚åœ¨é…ç½® Rclone æ—¶ï¼Œéœ€è¦åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://127.0.0.1:53682/auth æ“ä½œå®Œæˆ Google Drive çš„è®¿é—®æˆæƒï¼Œè¿™åœ¨è™šæ‹Ÿæœºä¸­æ— æ³•å®Œæˆï¼Œä½†å¯ä»¥ä½¿ç”¨ä»£ç†çš„æ–¹å¼æ¥è§£å†³ã€‚\nä» release ä¸­ä¸‹è½½æœ€æ–°ç‰ˆçš„ Pipyï¼Œç„¶ååˆ›å»ºä¸€ä¸ªè„šæœ¬æ–‡ä»¶ï¼š\n#/tmp/proxy.js pipy() .listen(3682) .connect(\u0026#39;127.0.0.1:53682\u0026#39;) ç„¶åï¼Œå°±å¯ä»¥ä½¿ç”¨å‘½ä»¤ ./pipy /tmp/proxy.js å¯åŠ¨ä»£ç†ã€‚ç„¶åæˆ‘ä»¬é€šè¿‡è™šæ‹Ÿæœºçš„ IP åœ°å€å’Œç«¯å£ 3682ï¼Œåœ¨æµè§ˆå™¨ä¸­å®Œæˆæˆæƒã€‚æˆæƒåï¼Œæœ‰ä¸ªå›è°ƒçš„æ“ä½œåŒæ ·ä¿®æ”¹ IP åœ°å€å’Œç«¯å£æ¥å®Œæˆã€‚\nå…¶ä»–çš„æ­¥éª¤å°±æŒ‰ç…§æ–‡æ¡£ä¸­çš„æŒ‡ç¤ºå®Œæˆæ“ä½œã€‚ç„¶åæ‰§è¡Œå‘½ä»¤ rclone ls remoteï¼Œå¦‚æœè¿”å›äº† Google Drive çš„æ–‡ä»¶åˆ—è¡¨ï¼Œè¯´æ˜é…ç½®æˆåŠŸã€‚\né€šè¿‡ Rclone çš„ sync å‘½ä»¤å¯ä»¥å®ŒæˆåŒæ­¥ï¼Œæ¯”å¦‚å°†æœ¬åœ° /data/calibre-web çš„å†…å®¹åŒæ­¥åˆ° Google Drive çš„ calibre ç›®å½•ä¸­ã€‚\n$ rclone sync /data/calibre-web remote:calibre è‡ªåŠ¨åŒæ­¥ åœ¨æ¯æ¬¡ä¿®æ”¹æ–‡ä»¶å†…å®¹åéœ€è¦æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ sync æ“ä½œè¿›è¡ŒåŒæ­¥ï¼Œå¾ˆä¸æ–¹ä¾¿ã€‚é™¤äº†é€šè¿‡ crontab åœ¨å‘¨æœŸæ€§çš„åŒæ­¥å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ç›‘æ§æ–‡ä»¶æ“ä½œæ¥å®ç°è‡ªåŠ¨çš„åŒæ­¥ã€‚\nç½‘ä¸Šå°±æœ‰äººæä¾›äº†è‡ªåŠ¨åŒæ­¥çš„è„šæœ¬ï¼Œä½¿ç”¨ inotifywait æ¥ç›‘æ§æ–‡ä»¶çš„ä¿®æ”¹æ¥è¿›è¡ŒåŒæ­¥ã€‚\nå°†è„šæœ¬å†…å®¹ä¿å­˜ä¸º sync.shï¼Œä¿®æ”¹å…¶ä¸­çš„å‡ ä¸ªå‚æ•°å³å¯ã€‚è®°å¾—æ‰§è¡Œè„šæœ¬å‰ï¼Œéœ€è¦å…ˆå®‰è£… inotify-toole å’Œ libnotify-binã€‚\n$ sudo apt install libnotify-bin inotify-tools #!/bin/bash ## One-way, immediate, continuous, recursive, directory synchronization ## to a remote Rclone URL. ( S3, SFTP, FTP, WebDAV, Dropbox, etc. ) ## Optional desktop notifications on sync events or errors. ## Useful only for syncing a SMALL number of files (\u0026lt; 8192). ## (See note in `man inotifywait` under `--recursive` about raising this limit.) ## Think use-case: Synchronize Traefik TLS certificates file (acme.json) ## Think use-case: Synchronize Keepass (.kdbx) database file immediately on save. ## Think use-case: Live edit source code and push to remote server ## This is NOT a backup tool! ## It will not help you if you delete your files or if they become corrupted. ## Setup: Install `rclone` from package manager. ## Run: `rclone config` to setup the remote, including the full remote ## subdirectory path to sync to. ## MAKE SURE that the remote (sub)directory is EMPTY ## or else ALL CONTENTS WILL BE DELETED by rclone when it syncs. ## If unsure, add `--dry-run` to the RCLONE_CMD variable below, ## to simulate what would be copied/deleted. ## Copy this script any place, and make it executable: `chown +x sync.sh` ## Edit all the variables below, before running the script. ## Run: `./sync.sh systemd_setup` to create and enable systemd service. ## Run: `journalctl --user --unit rclone_sync.${RCLONE_REMOTE}` to view the logs. ## Edit the variables below, according to your own environment: # RCLONE_SYNC_PATH: The path to COPY FROM (files are not synced TO here): RCLONE_SYNC_PATH=\u0026#34;/data/calibre-web\u0026#34; # RCLONE_REMOTE: The rclone remote name to synchronize with. # Identical to one of the remote names listed via `rclone listremotes`. # Make sure to include the final `:` in the remote name, which # indicates to sync/delete from the same (sub)directory as defined in the URL. # (ALL CONTENTS of the remote are continuously DELETED # and replaced with the contents from RCLONE_SYNC_PATH) RCLONE_REMOTE=\u0026#34;remote:calibre\u0026#34; # RCLONE_CMD: The sync command and arguments: RCLONE_CMD=\u0026#34;rclone -v sync ${RCLONE_SYNC_PATH} ${RCLONE_REMOTE}\u0026#34; # WATCH_EVENTS: The file events that inotifywait should watch for: WATCH_EVENTS=\u0026#34;modify,delete,create,move\u0026#34; # SYNC_DELAY: Wait this many seconds after an event, before synchronizing: SYNC_DELAY=5 # SYNC_INTERVAL: Wait this many seconds between forced synchronizations: SYNC_INTERVAL=3600 # NOTIFY_ENABLE: Enable Desktop notifications NOTIFY_ENABLE=true # SYNC_SCRIPT: dynamic reference to the current script path SYNC_SCRIPT=$(realpath $0) notify() { MESSAGE=$1 if test ${NOTIFY_ENABLE} = \u0026#34;true\u0026#34;; then notify-send \u0026#34;rclone ${RCLONE_REMOTE}\u0026#34; \u0026#34;${MESSAGE}\u0026#34; fi } rclone_sync() { set -x # Do initial sync immediately: notify \u0026#34;Startup\u0026#34; ${RCLONE_CMD} # Watch for file events and do continuous immediate syncing # and regular interval syncing: while [[ true ]] ; do inotifywait --recursive --timeout ${SYNC_INTERVAL} -e ${WATCH_EVENTS} \\ ${RCLONE_SYNC_PATH} 2\u0026gt;/dev/null if [ $? -eq 0 ]; then # File change detected, sync the files after waiting a few seconds: sleep ${SYNC_DELAY} \u0026amp;\u0026amp; ${RCLONE_CMD} \u0026amp;\u0026amp; \\ notify \u0026#34;Synchronized new file changes\u0026#34; elif [ $? -eq 1 ]; then # inotify error occured notify \u0026#34;inotifywait error exit code 1\u0026#34; sleep 10 elif [ $? -eq 2 ]; then # Do the sync now even though no changes were detected: ${RCLONE_CMD} fi done } systemd_setup() { set -x if loginctl show-user ${USER} | grep \u0026#34;Linger=no\u0026#34;; then echo \u0026#34;User account does not allow systemd Linger.\u0026#34; echo \u0026#34;To enable lingering, run as root: loginctl enable-linger $USER\u0026#34; echo \u0026#34;Then try running this command again.\u0026#34; exit 1 fi mkdir -p ${HOME}/.config/systemd/user SERVICE_FILE=${HOME}/.config/systemd/user/rclone_sync.${RCLONE_REMOTE}.service if test -f ${SERVICE_FILE}; then echo \u0026#34;Unit file already exists: ${SERVICE_FILE} - Not overwriting.\u0026#34; else cat \u0026lt;\u0026lt;EOF \u0026gt; ${SERVICE_FILE} [Unit] Description=rclone_sync ${RCLONE_REMOTE} [Service] ExecStart=${SYNC_SCRIPT} [Install] WantedBy=default.target EOF fi systemctl --user daemon-reload systemctl --user enable --now rclone_sync.${RCLONE_REMOTE} systemctl --user status rclone_sync.${RCLONE_REMOTE} echo \u0026#34;You can watch the logs with this command:\u0026#34; echo \u0026#34; journalctl --user --unit rclone_sync.${RCLONE_REMOTE}\u0026#34; } if test $# = 0; then rclone_sync else CMD=$1; shift; ${CMD} $@ fi ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/05/01/pexelsmarkusspiske330771.jpg","permalink":"https://atbug.com/sync-local-file-to-google-drive-with-rclone/","tags":null,"title":"ä½¿ç”¨ Rclone åŒæ­¥æ–‡ä»¶åˆ° Google Drive"},{"categories":["æ•™ç¨‹"],"contents":"è¿™ç¯‡æ–‡ç« ä¸»è¦ä½¿ç”¨\u0026quot;æ ¸å¼¹çº§\u0026quot;å‘½ä»¤git-filter-branch, å¯¹ä»£ç ä»“åº“è¿›è¡Œæ•´ç†. è¿™é‡Œçš„æ•´ç†åŒ…æ‹¬å­ç›®å½•é‡å‘½å, å­ç›®å½•ç‹¬ç«‹ä¸ºæ–°é¡¹ç›®(ä¿ç•™æˆ–è€…ä¸ä¿ç•™åŸæ¥çš„ç»“æ„)ç­‰. æ•´ç†ä¹‹å, åŸæ¥çš„æäº¤ä¿¡æ¯éƒ½ä¼šå®Œå¥½çš„ä¿å­˜ä¸‹æ¥, æ–¹ä¾¿è¿½æº¯.\né‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼š\nå¼ºçƒˆå»ºè®®ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™åšå¥½å¤‡ä»½, åˆ‡è®°!!! å¼ºçƒˆå»ºè®®ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™åšå¥½å¤‡ä»½, åˆ‡è®°!!! å¼ºçƒˆå»ºè®®ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™åšå¥½å¤‡ä»½, åˆ‡è®°!!!\næ¯å¤„ç†å®Œä¸€ä¸ªåˆ†æ”¯, éƒ½éœ€è¦æ‰§è¡Œå¦‚ä¸‹æ“ä½œ, å¹¶é‡æ–°å…‹éš†é¡¹ç›®å¹¶å¤„ç†ä¸‹ä¸€ä¸ªåˆ†æ”¯\ngit remote remove origin git remote add origin xxxxxx.git git push -u origin BRANCH-NAME git push --tags å°†å­æ–‡ä»¶å¤¹ç‹¬ç«‹ä¸ºæ–°çš„ä»“åº“ git filter-branch --prune-empty --tag-name-filter cat --subdirectory-filter FOLDER-NAME BRANCH-NAME æ¼”ç¤º:\nåŸç»“æ„: root â”œâ”€â”€ delete â””â”€â”€ new â””â”€â”€ test.sql å¤„ç†å: new â””â”€â”€ test.sql ä¿ç•™åŸæ¥çš„ç›®å½•ç»“æ„, æ¸…ç†æ‰å…¶ä»–çš„å­ç›®å½•, ä¹Ÿå¯å°†è¦ä¿ç•™çš„ç›®å½•é‡å‘½å. git filter-branch --prune-empty --tag-name-filter cat --tree-filter \u0026#39;ls | grep -v FOLDER-NAME | xargs rm -rf \u0026amp;\u0026amp; mv FOLDER-NAME NEW-FOLDER-NAME\u0026#39; BRANCH-NAME æ¼”ç¤º:\nåŸç»“æ„: root â”œâ”€â”€ delete â””â”€â”€ new â””â”€â”€ test.sql å¤„ç†å: root â””â”€â”€ new â””â”€â”€ test.sql å°†é¡¹ç›®ä¸­çš„æ–‡ä»¶ç§»å…¥æ–°å»ºçš„å­ç›®å½• #linux only git filter-branch --prune-empty --tag-name-filter cat --tree-filter \u0026#39;mkdir FOLDER-NAME \u0026amp;\u0026amp; (ls | grep -v FOLDER-NAME | xargs mv -t FOLDER-NAME) \u0026#39; BRANCH-NAME æ¼”ç¤º:\nåŸç»“æ„: root â”œâ”€â”€ test1.sql â””â”€â”€ test2.sql å¤„ç†å: root â””â”€â”€ new â”œâ”€â”€ test1.sql â””â”€â”€ test2.sql ä¿ç•™é¡¹ç›®çš„å¤šä¸ªç›®å½•å¹¶é‡å‘½å git filter-branch --prune-empty --tag-name-filter cat --tree-filter \u0026#39;(ls | egrep -v \u0026#34;(FOLDER-NAME1|FOLDER-NAME2)\u0026#34; | xargs rm -rf) \u0026amp;\u0026amp; mv FOLDER-NAME1 NEW-FOLDER-NAME1 \u0026amp;\u0026amp; mv mv FOLDER-NAME2 NEW-FOLDER-NAME2\u0026#39; BRANCH-NAME æ¼”ç¤º:\nåŸç»“æ„: root â”œâ”€â”€ old1 â”‚Â â””â”€â”€ test1.sql â””â”€â”€ old2 â””â”€â”€ test2.sql å¤„ç†å: root â”œâ”€â”€ new1 â”‚Â â””â”€â”€ test1.sql â””â”€â”€ new2 â””â”€â”€ test2.sql è¿å‡ºå¤šå±‚ç›®å½• git filter-branch --prune-empty --tag-name-filter cat --tree-filter \u0026#39;if [ -d \u0026#34;FOLDER-NAME/SUB-FOLDER-NAME\u0026#34; ]; then mv FOLDER-NAME/SUB-FOLDER-NAME . ;fi \u0026amp;\u0026amp; (ls | grep -v FOLDER-NAME | xargs rm -rf )\u0026#39; BRANCH-NAME æ¼”ç¤º:\nåŸç»“æ„: root â””â”€â”€ sub â””â”€â”€ base â””â”€â”€ base.sql å¤„ç†å: root â””â”€â”€ base â””â”€â”€ base.sql ä¿®æ”¹authorçš„ä¿¡æ¯, å¦‚é‚®ç®±å’Œåå­— è¿™ä¸ªæ“ä½œéœ€è¦åœ¨å„ä¸ªåˆ†æ”¯ä¸Šéƒ½è¿è¡Œä¸€é. å¯¹commitçš„ä¿®æ”¹, å°±æ”¹å˜revision id. éœ€è¦ä½¿ç”¨git push --forceå¼ºåˆ¶è¦†ç›–ä»“åº“, å› æ­¤tagä¿¡æ¯ä¹Ÿä¼šè¢«é‡å†™, éœ€è¦è¿è¡Œgit push --tags --force\n#å¯¹authorçš„ä¿¡æ¯è¿›è¡Œä¿®æ”¹: GIT_AUTHOR_NAME, GIT_COMMITTER_EMAIL git filter-branch --tag-name-filter cat --env-filter \u0026#39; if test \u0026#34;$GIT_AUTHOR_EMAIL\u0026#34; = \u0026#34;root@localhost\u0026#34; then GIT_AUTHOR_EMAIL=john@example.com fi if test \u0026#34;$GIT_COMMITTER_EMAIL\u0026#34; = \u0026#34;root@localhost\u0026#34; then GIT_COMMITTER_EMAIL=john@example.com fi \u0026#39; -- --all å‚è€ƒ:\nSplitting a subfolder out into a new repository Stack overflow ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/04/30/pexelstigerlily4483775.jpg","permalink":"https://atbug.com/split-git-repository-without-commit-lost/","tags":["Git"],"title":"Gitä»£ç ä»“åº“æ— æŸæ•´ç†ï¼šç›®å½•æ‹†åˆ†å’Œé‡å‘½å"},{"categories":["äº‘åŸç”Ÿ"],"contents":"TL;DR æœ¬æ–‡ä»æœåŠ¡ç½‘æ ¼å‘å±•ç°çŠ¶ã€åˆ° Open Service Mesh æºç ï¼Œåˆ†æå¼€æ”¾æœåŠ¡ç½‘æ ¼ä¸­çš„å¼€æ”¾æ˜¯ä»€ä¹ˆä»¥åŠå¦‚ä½•å¼€æ”¾ã€‚ç¬”è€…æ€»ç»“å…¶å¼€æ”¾ä½“ç°åœ¨ä»¥ä¸‹å‡ ç‚¹ï¼š\nèµ„æºæä¾›è€…ï¼ˆProviderï¼‰æ¥å£å’Œèµ„æºçš„é‡æ–°å°è£…ï¼šé€šè¿‡èµ„æºæä¾›è€…æ¥å£æŠ½è±¡è®¡ç®—å¹³å°çš„èµ„æºï¼Œå¹¶å°è£…æˆå¹³å°ã€ä»£ç†æ— å…³çš„ç»“æ„åŒ–ç±»å‹ï¼Œå¹¶ç”±ç»Ÿä¸€çš„æ¥å£ MeshCataloger å¯¹å¤–æä¾›è®¿é—®ã€‚è™½ç„¶ç›®å‰åªæœ‰ Kubernetes ç›¸å…³èµ„æºçš„ Provider å®ç°ï¼Œä½†æ˜¯é€šè¿‡æŠ½è±¡å‡ºçš„æ¥å£ï¼Œå¯ä»¥å…¼å®¹å…¶ä»–å¹³å°ï¼Œæ¯”å¦‚è™šæ‹Ÿæœºã€ç‰©ç†æœºã€‚ æœåŠ¡ç½‘æ ¼èƒ½åŠ›æ¥å£ï¼šå¯¹æœåŠ¡ç½‘æ ¼èƒ½åŠ›çš„æŠ½è±¡ï¼Œå®šä¹‰æœåŠ¡ç½‘æ ¼çš„åŸºç¡€åŠŸèƒ½é›†ã€‚ ä»£ç†æ§åˆ¶é¢æ¥å£ï¼šè¿™ä¸€å±‚ä¸åå‘ä»£ç†ï¼Œä¹Ÿå°±æ˜¯ sidecar çš„å®ç°ç›¸å…³ã€‚å®é™…ä¸Šæ˜¯åå‘ä»£ç†æ‰€æä¾›çš„æ¥å£ï¼Œé€šè¿‡å¯¹æ¥å£çš„å®ç°ï¼ŒåŠ ä¸Š MeshCataloger å¯¹èµ„æºçš„è®¿é—®ï¼Œç”Ÿæˆå¹¶ä¸‹å‘ä»£ç†æ‰€éœ€çš„é…ç½®ã€‚ èƒŒæ™¯ æœåŠ¡ç½‘æ ¼æ˜¯ä»€ä¹ˆ æœåŠ¡ç½‘æ ¼æ˜¯åœ¨ 2017å¹´ç”± Buoyant çš„ Willian Morgan åœ¨ Whatâ€™s a service mesh? And why do I need one? ç»™å‡ºäº†è§£é‡Šã€‚\næœåŠ¡ç½‘æ ¼æ˜¯å¤„ç†æœåŠ¡é—´ç½‘ç»œé€šä¿¡çš„åŸºç¡€è®¾æ–½ç»„ä»¶ï¼Œæ—¨åœ¨ä»å¹³å°å±‚é¢æä¾›å¯è§‚æ€§ã€å®‰å…¨ä»¥åŠå¯é æ€§ç‰¹æ€§ï¼Œä»¥è¿›ç¨‹å¤–çš„æ–¹å¼æä¾›åŸæœ¬ç”±éƒ¨åˆ†åº”ç”¨å±‚é€»è¾‘æ‰¿è½½çš„åŸºç¡€èƒ½åŠ›ï¼ŒçœŸæ­£å®ç°ä¸ä¸šåŠ¡é€»è¾‘çš„åˆ†ç¦»ã€‚å…¸å‹çš„å®ç°æ˜¯ä¸åº”ç”¨ç¨‹åºä¸€èµ·éƒ¨ç½²çš„å¯æ‰©å±•ç½‘ç»œä»£ç†ï¼ˆé€šå¸¸ç§°ä¸º sidecar æ¨¡å‹ï¼‰ï¼Œæ¥ä»£ç†æœåŠ¡é—´çš„ç½‘ç»œé€šä¿¡ï¼Œä¹Ÿæ˜¯æœåŠ¡ç½‘æ ¼ç‰¹æ€§çš„æ¥å…¥ç‚¹ã€‚è¿™äº›ä»£ç†å°±ç»„æˆäº†æœåŠ¡ç½‘æ ¼çš„æ•°æ®å¹³é¢ï¼Œå¹¶ç”±æ§åˆ¶å¹³é¢è¿›è¡Œç»Ÿä¸€çš„ç®¡ç†ã€‚\nå›¾ç‰‡æ¥è‡ª Pattern: Service Mesh\næœåŠ¡ç½‘æ ¼ç°çŠ¶ è¿‡å»å‡ å¹´ Istio æœ‰ç€æˆä¸ºæœåŠ¡ç½‘æ ¼äº‹å®æ ‡å‡†çš„è¶‹åŠ¿ï¼Œä½†æ—¶è‡³ä»Šæ—¥ï¼Œå„ç§å„æ ·çš„æœåŠ¡ç½‘æ ¼äº§å“å¦‚é›¨åæ˜¥ç¬‹èˆ¬å±‚å‡ºä¸ç©·ã€‚CNCF å‘å¸ƒçš„ 2021 Cloud Native survey results ä¸­ä¸éš¾çœ‹å‡ºï¼Œè¿™äº›ç½‘æ ¼äº§å“ä¹Ÿæ…¢æ…¢è¢«å¸‚åœºæ‰€æ¥å—ï¼Œå¹¶å¤§æœ‰è¶…è¶Š Istio çš„æ€åŠ¿ï¼ˆéƒ¨åˆ†åœ°åŒºï¼‰ã€‚\næ‰“å¼€ CNCF çš„æœåŠ¡ç½‘æ ¼å…¨æ™¯å›¾ï¼Œä¼šå‘ç°æœ‰ä¸å°‘æœåŠ¡ç½‘æ ¼çš„äº§å“ã€‚å®é™…ä¸Šè¿˜æœ‰å¾ˆå¤šäº§å“æ²¡æœ‰åˆ—å‡ºï¼Œæ¯”å¦‚ HashiCorp Consul Connectã€OpenShift Service Meshã€Nginx Service Meshã€Kong Meshã€SOFAMesh ç­‰ç­‰ï¼Œå½“ç„¶è¿˜æœ‰æˆ‘å¸çš„ Flomeshã€‚æ­¤å¤–è¿˜æœ‰ä¸€äº›äº‘å‚å•†åŸºäºå¼€æºçš„ç½‘æ ¼äº§å“ã€‚\nè¿™äº›äº§å“æœ‰äº›ä½¿ç”¨ç›¸åŒçš„æ•°æ®å¹³é¢ï¼Œä¹Ÿæœ‰äº›ä¸åŒï¼Œä½†æ§åˆ¶å¹³é¢å„ä¸ç›¸åŒã€‚ä¼—å¤šäº§å“ä¸ºå¤§å®¶æä¾›äº†æ›´å¤šé€‰æ‹©çš„åŒæ—¶ï¼Œä¹Ÿç”±äºå„ä¸ªäº§å“é—´æœ‰ç€å¾ˆå¼ºçš„éš”ç¦»æ€§ï¼Œé˜»ç¢äº†ç”Ÿæ€ç³»ç»Ÿçš„å‘å±•ã€‚è¿™å¯¼è‡´å¾ˆéš¾ä»ä¸€ä¸ªå®ç°åˆ‡æ¢åˆ°å¦ä¸€ä¸ªï¼Œä»æ§åˆ¶é¢åˆ°åˆ°æ•°æ®é¢ï¼Œä»¥åŠä¸ºå…¶å¼€å‘çš„ç®¡ç†åå°éƒ½æœ‰é‡æ–°å¼€å‘çš„æˆæœ¬ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ç”¨æˆ·ä½¿ç”¨ä¹ æƒ¯çš„æ”¹å˜ï¼Œæ— æ³•åšåˆ°é€æ˜æ— æ„ŸçŸ¥ã€‚\né’ˆå¯¹è¿™ç§è¯‰æ±‚ï¼ŒæŒ‰ç…§â€œæƒ¯ä¾‹â€å°±æ˜¯å€ŸåŠ©æ ‡å‡†æ¥å£æ¥è¿›è¡ŒæŠ½è±¡ï¼Œæä¾›å®ç°çš„äº’é€šæ€§ã€‚æ¯”å¦‚å®¹å™¨ç½‘ç»œã€è¿è¡Œæ—¶ã€å­˜å‚¨æœ‰ CNIã€CRIã€CSI æ¥å£ï¼ŒæœåŠ¡ç½‘æ ¼ä¹Ÿæœ‰å…¶æŠ½è±¡æ¥å£ Service Mesh Interfaceï¼ˆç®€ç§°SMIï¼‰ï¼Œä»¥åŠå…¶å®ç°ä¹Ÿå°±æ˜¯ä»Šå¤©çš„ä¸»è§’ Open Service Meshï¼ˆç®€ç§°OSMï¼‰ã€‚\nSMI ä¸ OSM ç®€ä»‹ åœ¨ CNCF çš„æœåŠ¡ç½‘æ ¼å…¨æ™¯å›¾ä¸­å¯ä»¥çœ‹åˆ° SMI å’Œ OSMã€‚\nSMI æ˜¯ä»€ä¹ˆ SMI æ˜¯æœåŠ¡ç½‘æ ¼çš„è§„èŒƒï¼Œé‡ç‚¹å…³æ³¨åœ¨ Kubernetes ä¸Šè¿è¡Œçš„æœåŠ¡ç½‘æ ¼ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªå¯ä»¥ç”±å„ç§ä¾›åº”å•†ä½¿ç”¨çš„é€šç”¨æ ‡å‡†ã€‚å…è®¸æœ€ç»ˆç”¨æˆ·çš„æ ‡å‡†åŒ–å’ŒæœåŠ¡ç½‘æ ¼æŠ€æœ¯æä¾›å•†çš„åˆ›æ–°ã€‚SMI å®ç°äº†çµæ´»æ€§å’Œäº’æ“ä½œæ€§ï¼Œå¹¶æ¶µç›–äº†æœ€å¸¸è§çš„æœåŠ¡ç½‘æ ¼åŠŸèƒ½ã€‚\nSMI æä¾›äº† Kubernetes æœåŠ¡ç½‘æ ¼çš„æ ‡å‡†æ¥å£ã€å¸¸è§æœåŠ¡ç½‘æ ¼åœºæ™¯çš„åŸºæœ¬åŠŸèƒ½é›†ã€æ”¯æŒæœåŠ¡ç½‘æ ¼æ–°åŠŸèƒ½çš„çµæ´»æ€§ï¼Œä»¥åŠæœåŠ¡ç½‘æ ¼æŠ€æœ¯ç”Ÿæ€çš„åˆ›æ–°ç©ºé—´ã€‚\nSMI çš„ç›®æ ‡æ˜¯å°†æ¦‚å¿µä¸å®ç°éš”ç¦»å¼€æ¥ï¼Œåƒè½¯ä»¶å¼€å‘è¿‡å»ä¸€ç›´åšçš„é‚£æ ·ï¼Œå°†å¤æ‚çš„ä¸œè¥¿åˆ†å±‚æŠ½è±¡ã€‚\nSMI è§„èŒƒçš„æœ€æ–°ç‰ˆæœ¬æ˜¯ 0.6.0ï¼Œè¦†ç›–äº†å¸¸è§çš„æµé‡è®¿é—®æ§åˆ¶ã€é¥æµ‹ã€ç®¡ç†ç­‰åŸºç¡€æœåŠ¡ç½‘æ ¼èƒ½åŠ›ã€‚ä¸è§„èŒƒå¯¹åº”çš„æ˜¯ APIï¼Œå„ä¸ªç½‘æ ¼ä¾›åº”å•†åŸºäºè¯¥ API è¿›è¡Œå®ç°ã€‚\nOSM æ˜¯ä»€ä¹ˆ OSM æ˜¯ä¸€ä¸ªè½»é‡çº§å¯æ‰©å±•çš„äº‘åŸç”ŸæœåŠ¡ç½‘æ ¼ï¼Œæ˜¯ç®€å•ã€å®Œæ•´ä¸”ç‹¬ç«‹çš„æœåŠ¡ç½‘æ ¼è§£å†³æ–¹æ¡ˆï¼Œå®ƒå…è®¸ç”¨æˆ·ç»Ÿä¸€ç®¡ç†ã€ä¿æŠ¤å¹¶è·å¾—é’ˆå¯¹é«˜åº¦åŠ¨æ€å¾®æœåŠ¡ç¯å¢ƒçš„å¼€ç®±å³ç”¨çš„å¯è§‚å¯Ÿæ€§åŠŸèƒ½ã€‚OSM è¿è¡Œåœ¨ Kubernetes ä¹‹ä¸Šæ§åˆ¶å¹³é¢å®ç°äº† xDS API å¹¶é…ç½®äº† SMI APIï¼Œä¸ºåº”ç”¨ç¨‹åºæ³¨å…¥ Envoy sidecar å®¹å™¨ä½œä¸ºä»£ç†ï¼Œé€šè¿‡ SMI Spec æ¥å¼•ç”¨ç½‘æ ¼ä¸­çš„æœåŠ¡ã€‚\nè™½ç„¶é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ Envoy ä½œä¸ºæ•°æ®å¹³é¢ï¼Œä½†æ˜¯è®¾è®¡ä¸Šæä¾›æ¥å£çš„æŠ½è±¡ï¼Œæ”¯æŒå…¼å®¹ xDS çš„ä»£ç†ï¼Œç”šè‡³å…¶ä»–çš„ä»£ç†ã€‚\nSMI è§„èŒƒ SMI è§„èŒƒä¸ºå¸¸è§æœåŠ¡ç½‘æ ¼èƒ½åŠ›æä¾›äº†ä¸€å¥—è§„èŒƒï¼š\næµé‡ç­–ç•¥ï¼šè·¨æœåŠ¡åº”ç”¨èº«ä»½å’Œä¼ è¾“åŠ å¯†ç­‰ç­–ç•¥ã€‚ æµé‡é¥æµ‹ï¼šæ•è·å…³é”®æŒ‡æ ‡ï¼Œå¦‚é”™è¯¯ç‡å’Œå»¶è¿Ÿã€‚ æµé‡ç®¡ç†ï¼šåœ¨ä¸åŒæœåŠ¡ä¹‹å‰è½¬ç§»æµé‡ã€‚ æµé‡ç­–ç•¥ è¿™ä¸ªè§„èŒƒæ˜¯ç”¨æ¥æŒ‡å®šåº”ç”¨çš„æµé‡è¡¨ç°å½¢å¼ï¼Œå¹¶ä¸è®¿é—®æ§åˆ¶ç­–ç•¥ç»“åˆæ¥å®šä¹‰ç‰¹å®šæµé‡åœ¨æœåŠ¡ç½‘æ ¼ä¸­çš„è¡Œä¸ºã€‚\næ¯”å¦‚ä¸‹é¢çš„å®šä¹‰ä¸­ï¼Œ/metrics ç«¯ç‚¹ä»…å¯¹å¤–æä¾› GET æ–¹å¼è®¿é—®ï¼Œæ¯”å¦‚ Prometheusã€‚è€Œå…¶ä»–ç«¯ç‚¹ï¼Œæ”¯æŒæ‰€æœ‰æ–¹å¼ã€‚\nkind: TCPRoute metadata: name: the-routes spec: matches: ports: - 8080 --- kind: HTTPRouteGroup metadata: name: the-routes spec: matches: - name: metrics pathRegex: \u0026#34;/metrics\u0026#34; methods: - GET - name: everything pathRegex: \u0026#34;.*\u0026#34; methods: [\u0026#34;*\u0026#34;] ä¸‹é¢çš„å®šä¹‰ï¼Œåˆ™åœ¨å‰é¢çš„åŸºç¡€ä¸Šï¼Œå…è®¸ Prometheusï¼ˆä½¿ç”¨ prometheus ServiceAccount éƒ¨ç½²ï¼‰è®¿é—®æ‰€æœ‰ service-a ServiceAccount çš„åº”ç”¨çš„ /metrics ç«¯ç‚¹ã€‚\nkind: TrafficTarget metadata: name: path-specific namespace: default spec: destination: kind: ServiceAccount name: service-a namespace: default rules: - kind: TCPRoute name: the-routes - kind: HTTPRouteGroup name: the-routes matches: - metrics sources: - kind: ServiceAccount name: prometheus namespace: default æµé‡ç®¡ç† è®¿é—®æ§åˆ¶ä»¥å¤–çš„æµé‡ç®¡ç†ï¼Œæ›´å¤šæ˜¯ä½“ç°åœ¨æµé‡çš„æ‹†åˆ†ä¸Šã€‚æµé‡æ‹†åˆ† TrafficSplit ç”¨äºå®ç°å°†æµé‡æŒ‰ç™¾åˆ†æ¯”æ‹†åˆ†åˆ°åŒä¸€åº”ç”¨ç¨‹åºçš„ä¸åŒç‰ˆæœ¬ã€‚\nä¸‹é¢çš„å®šä¹‰ä¸­ï¼Œå°†æ¥è‡ªFirefox è¯·æ±‚å…¨éƒ½è·¯ç”±åˆ° website çš„ v2 ç‰ˆæœ¬ï¼Œå®ç°é‡‘ä¸é›€å‘å¸ƒã€‚åœ¨å®é™…åœºæ™¯ä¸­çš„æ“ä½œæµç¨‹ï¼Œå‚è€ƒ SMI çš„ç¤ºä¾‹ã€‚\nkind: TrafficSplit metadata: name: ab-test spec: service: website matches: - kind: HTTPRouteGroup name: ab-test backends: - service: website-v1 weight: 0 - service: website-v2 weight: 100 --- kind: HTTPRouteGroup metadata: name: ab-test matches: - name: firefox-users headers: user-agent: \u0026#34;.*Firefox.*\u0026#34; æµé‡é¥æµ‹ æµé‡é¥æµ‹è¿˜æ˜¯å¤„äºå¾ˆæ—©æœŸçš„ç‰ˆæœ¬ v1alpha1ã€‚\nè¯¥è§„èŒƒæè¿°äº†ä¸€ç§èµ„æºï¼Œè¯¥èµ„æºä¸ºå·¥å…·æä¾›äº†ä¸€ä¸ªé€šç”¨é›†æˆç‚¹ï¼Œè¿™äº›å·¥å…·å¯ä»¥é€šè¿‡ä½¿ç”¨ä¸ HTTP æµé‡ç›¸å…³çš„æŒ‡æ ‡è€Œå—ç›Šã€‚å¯¹äºå³æ—¶æŒ‡æ ‡å®ƒéµå¾ª metrics.k8s.io çš„æ¨¡å¼ï¼Œè¿™äº›æŒ‡æ ‡å¯è¢« CLI å·¥å…·ã€HPA æ‰©å±•æˆ–è‡ªåŠ¨åŒ–é‡‘ä¸é›€æ›´æ–°ä½¿ç”¨ã€‚\næ¯”å¦‚ä¸‹é¢å®šä¹‰äº†ä» Pod foo-775b9cbd88-ntxsl åˆ° Pod baz-577db7d977-lsk2q çš„å»¶è¿Ÿä»¥åŠæˆåŠŸç‡æŒ‡æ ‡ã€‚\nkind: TrafficMetrics # See ObjectReference v1 core for full spec resource: name: foo-775b9cbd88-ntxsl namespace: foobar kind: Pod edge: direction: to side: client resource: name: baz-577db7d977-lsk2q namespace: foobar kind: Pod timestamp: 2019-04-08T22:25:55Z window: 30s metrics: - name: p99_response_latency unit: seconds value: 10m - name: p90_response_latency unit: seconds value: 10m - name: p50_response_latency unit: seconds value: 10m - name: success_count value: 100 - name: failure_count value: 100 OSM çš„è®¾è®¡ OSM çš„æ§åˆ¶å±‚é¢åŒ…å«äº†äº”ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š\nProxy Control Planeï¼šä»£ç†æ§åˆ¶é¢åœ¨æ“ä½œæœåŠ¡ç½‘æ ¼ä¸­èµ·ç€å…³é”®ä½œç”¨ï¼Œæ‰€æœ‰ä»¥ sidecar æ–¹å¼è¿è¡Œçš„ä»£ç†ï¼Œéƒ½ä¼šä¸å…¶å»ºç«‹è¿æ¥ï¼Œå¹¶ä¸æ–­åœ°æ¥å—é…ç½®çš„æ›´æ–°ã€‚è¿™ä¸ªç»„ä»¶å®ç°åå‘ä»£ç†æ‰€éœ€çš„æ¥å£ã€‚ç›®å‰ OSM ä½¿ç”¨ Envoy ä½œä¸ºå…¶é»˜è®¤çš„ä»£ç†å®ç°ï¼Œå› æ­¤è¿™ä¸ªç»„ä»¶å®ç°äº† Envoy çš„ xDS APIã€‚ Certificate Mangerï¼šè¯ä¹¦ç®¡ç†å™¨ç»„ä»¶ä¸ºç½‘æ ¼ä¸­çš„æœåŠ¡æä¾› TLS è¯ä¹¦ï¼Œè¿™äº›è¯ä¹¦ç”¨äºä½¿ç”¨ mTLS å»ºç«‹å’ŒåŠ å¯†æœåŠ¡ä¹‹é—´çš„è¿æ¥ã€‚ Endpoints Providersï¼šç«¯ç‚¹æä¾›è€…æ˜¯ä¸è®¡ç®—å¹³å°ï¼ˆKubernetes é›†ç¾¤ã€äº‘ä¸»æœºã€æœ¬åœ°æœºå™¨ï¼‰äº¤äº’çš„ä¸€ç³»åˆ—ç»„ä»¶çš„ç»Ÿç§°ã€‚ç«¯ç‚¹æä¾›è€…å°†æœåŠ¡åè§£æä¸º IP åœ°å€ã€‚ Mesh Specificationï¼šç½‘æ ¼è§„èŒƒæ˜¯ç°æœ‰SMI è§„èŒƒç»„ä»¶çš„å°è£…ã€‚è¯¥ç»„ä»¶æŠ½è±¡äº†ä¸º YAML å®šä¹‰çš„ç‰¹å®šå­˜å‚¨ã€‚è¿™ä¸ªæ¨¡å—å®é™…ä¸Šæ˜¯SMI Spec çš„ Kubernetes informersçš„å°è£…ã€‚ Mesh Catalogï¼šæ˜¯ OSM çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒå°†å…¶ä»–ç»„ä»¶çš„è¾“å‡ºç»„è£…æˆæ–°çš„ç»“æ„ã€‚æ–°çš„ç»“æ„å¯ä»¥è½¬æ¢ä¸ºä»£ç†é…ç½®å¹¶é€šè¿‡ä»£ç†æ§åˆ¶é¢åˆ†å‘ç»™æ‰€æœ‰çš„ä»£ç†ã€‚ è¿™å‡ ä¸ªæŠ½è±¡çš„ç»„ä»¶ï¼Œéƒ½æœ‰æ¥å£ä¸å…¶ä¸€ä¸€å¯¹åº”ï¼Œ\nProxy Control Planeï¼šEnvoy AggregatedDiscoveryServiceServer Certificate Mangerï¼šcertificate.Manager Endpoints Providersï¼šendpoint.Provider Mesh Specificationï¼šsmi.MeshSpec Mesh Catalogï¼šcatalog.MeshCataloger æºç åˆ†æ ä»£ç†æ§åˆ¶å¹³é¢æ¥å£ åŸºäº Evnoy ä»£ç†çš„æœåŠ¡ç½‘æ ¼å®ç°ï¼Œä»£ç†æ§åˆ¶é¢éƒ½è¦å®ç° AggregatedDiscoveryServiceServer æ¥å£ã€‚ç›®å‰ OSM å®ç°çš„æ˜¯ V3 ç‰ˆæœ¬çš„æ¥å£ã€‚æ·±å…¥åˆ°ä»£ç ä¸­ï¼ŒOSM çš„ ads.Server å®ç°äº† AggregatedDiscoveryServiceServer æ¥å£ã€‚\nä» ads.Server çš„å®šä¹‰ä¸­å¯ä»¥çœ‹åˆ°å…¶ä»–ç»„ä»¶æ¥å£ catalog.MeshCatalogerã€certificate.Manager çš„èº«å½±ã€‚\n// Server implements the Envoy xDS Aggregate Discovery Services type Server struct { catalog catalog.MeshCataloger proxyRegistry *registry.ProxyRegistry xdsHandlers map[envoy.TypeURI]func(catalog.MeshCataloger, *envoy.Proxy, *xds_discovery.DiscoveryRequest, configurator.Configurator, certificate.Manager, *registry.ProxyRegistry) ([]types.Resource, error) xdsLog map[certificate.CommonName]map[envoy.TypeURI][]time.Time xdsMapLogMutex sync.Mutex osmNamespace string cfg configurator.Configurator certManager certificate.Manager ready bool workqueues *workerpool.WorkerPool kubecontroller k8s.Controller // --- // SnapshotCache implementation structrues below cacheEnabled bool ch cachev3.SnapshotCache srv serverv3.Server // When snapshot cache is enabled, we (currently) don\u0026#39;t keep track of proxy information, however different // config versions have to be provided to the cache as we keep adding snapshots. The following map // tracks at which version we are at given a proxy UUID configVerMutex sync.Mutex configVersion map[string]uint64 msgBroker *messaging.Broker } æ­¤å¤„ï¼Œä¸å¾—ä¸æä¸€ä¸‹ messaging.Brokerï¼ŒOSM æ§åˆ¶å¹³é¢çš„â€œæ¶ˆæ¯æ€»çº¿â€ã€‚é›†ç¾¤ä¸­ï¼Œä»»ä½•èµ„æºï¼ˆK8s åŸç”Ÿèµ„æºã€OSM å®šä¹‰èµ„æºã€SMI èµ„æºï¼‰çš„å˜æ›´ï¼Œéƒ½ä¼šä»¥äº‹ä»¶çš„æ–¹å¼å‘å¸ƒåˆ°æ¶ˆæ¯æ€»çº¿ã€‚\nç‰¹å®šäº‹ä»¶æ¶ˆæ¯çš„è®¢é˜…æ–¹åœ¨æ¥æ”¶åˆ°äº‹ä»¶åå°±ä¼šæ‰§è¡Œç‰¹å®šçš„é€»è¾‘ã€‚\nè¿™é‡Œ ads.Server åœ¨å¯åŠ¨ grpc æœåŠ¡åï¼Œä¾¿ä¼šè®¢é˜… ProxyUpdate äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶ä¼šè§¦å‘å¯¹åº”çš„é€»è¾‘ï¼šé€šè¿‡ catalog.MeshCataloger çš„å®ç°è·å–ç»“æ„åŒ–çš„æ•°æ®ï¼Œè¿›è€Œè½¬æ¢æˆä»£ç†çš„é…ç½®å¹¶å‘é€ç»™ä»£ç†ã€‚\nåœ¨ OSM ä¸­ ProxyUpdate äº‹ä»¶æ˜¯ä¸€äº›äº‹ä»¶çš„é›†åˆï¼Œè¿™äº›äº‹ä»¶æœ€ç»ˆéƒ½ä¼šè¢«**â€œå½“ä½œâ€** ProxyUpdate äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚\nç½‘æ ¼ç›®å½•æ¥å£ Mesh Catalog çš„æ¥å£ catalog.MeshCatalogerï¼Œå®šä¹‰äº†ä¸€äº›ç”¨äºç”Ÿæˆç»“æ„åŒ–æ•°æ®çš„æ–¹æ³•ã€‚è¿™äº›ç»“æ„åŒ–çš„æ•°æ®ï¼Œæ˜¯åœ¨ K8s åŸç”Ÿèµ„æºã€SMI è‡ªå®šä¹‰èµ„æºçš„åŸºç¡€ä¸Šçš„å°è£…ã€‚ä½œä¸ºåº•å±‚èµ„æºå’Œä»£ç†æ§åˆ¶é¢çš„ä¸­é—´å±‚ï¼Œå¯¹ä¸Šéš”ç¦»äº†åº•å±‚èµ„æºçš„å®ç°ï¼Œå¯¹ä¸‹ç»Ÿä¸€äº†èµ„æºçš„å¯¹å¤–æš´éœ²å½¢å¼ã€‚\n// MeshCataloger is the mechanism by which the Service Mesh controller discovers all Envoy proxies connected to the catalog. type MeshCataloger interface { // ListOutboundServicesForIdentity list the services the given service identity is allowed to initiate outbound connections to ListOutboundServicesForIdentity(identity.ServiceIdentity) []service.MeshService // ListOutboundServicesForMulticlusterGateway lists the upstream services for the multicluster gateway ListOutboundServicesForMulticlusterGateway() []service.MeshService // ListInboundServiceIdentities lists the downstream service identities that are allowed to connect to the given service identity ListInboundServiceIdentities(identity.ServiceIdentity) []identity.ServiceIdentity // ListOutboundServiceIdentities lists the upstream service identities the given service identity are allowed to connect to ListOutboundServiceIdentities(identity.ServiceIdentity) []identity.ServiceIdentity // ListServiceIdentitiesForService lists the service identities associated with the given service ListServiceIdentitiesForService(service.MeshService) []identity.ServiceIdentity // ListAllowedUpstreamEndpointsForService returns the list of endpoints over which the downstream client identity // is allowed access the upstream service ListAllowedUpstreamEndpointsForService(identity.ServiceIdentity, service.MeshService) []endpoint.Endpoint // GetIngressTrafficPolicy returns the ingress traffic policy for the given mesh service GetIngressTrafficPolicy(service.MeshService) (*trafficpolicy.IngressTrafficPolicy, error) // ListInboundTrafficTargetsWithRoutes returns a list traffic target objects composed of its routes for the given destination service identity ListInboundTrafficTargetsWithRoutes(identity.ServiceIdentity) ([]trafficpolicy.TrafficTargetWithRoutes, error) // GetEgressTrafficPolicy returns the Egress traffic policy associated with the given service identity. GetEgressTrafficPolicy(identity.ServiceIdentity) (*trafficpolicy.EgressTrafficPolicy, error) // GetKubeController returns the kube controller instance handling the current cluster GetKubeController() k8s.Controller // GetOutboundMeshTrafficPolicy returns the outbound mesh traffic policy for the given downstream identity GetOutboundMeshTrafficPolicy(identity.ServiceIdentity) *trafficpolicy.OutboundMeshTrafficPolicy // GetInboundMeshTrafficPolicy returns the inbound mesh traffic policy for the given upstream identity and services GetInboundMeshTrafficPolicy(identity.ServiceIdentity, []service.MeshService) *trafficpolicy.InboundMeshTrafficPolicy } æ¥å£çš„å®ç° catalog.MeshCatalogï¼Œä¹Ÿæ˜¯é€šè¿‡å‡ ä¸ªæ¥å£è·å–åº•å±‚çš„èµ„æºï¼š\nendpoint.Providerï¼šendpoint.Endpoint æŠ½è±¡èµ„æºçš„æä¾›è€…ï¼Œåœ¨ç›®å‰ OSM ç‰ˆæœ¬ä¸­æä¾›è·å– Kubernetes Endpoint çš„å®ç°ã€‚ service.Providerï¼šservice.MeshService æŠ½è±¡èµ„æºçš„æä¾›è€…ï¼Œç›®å‰åŒæ ·æ˜¯æä¾›è·å– Kubernetes Service çš„å®ç°ã€‚ smi.MeshSpecï¼šæ•…åæ€ä¹‰é’ˆå¯¹æ˜¯ SMI è‡ªå®šä¹‰èµ„æºï¼Œç›´æ¥ä½¿ç”¨ SMI çš„å®šä¹‰ï¼Œå¹¶æ²¡æœ‰é‡æ–°æŠ½è±¡å°è£…ã€‚ k8s.Controllerï¼šç”¨äºè·å– Kubernetes åŸç”Ÿèµ„æºï¼Œæ¯”å¦‚ ServiceAcountã€Namespaceã€Pods ç­‰ã€‚ policy.Controllerï¼šç”¨äºè·å– OSM çš„ Egress å’Œ IngressBackend èµ„æºã€‚ // MeshCatalog is the struct for the service catalog type MeshCatalog struct { endpointsProviders []endpoint.Provider serviceProviders []service.Provider meshSpec smi.MeshSpec certManager certificate.Manager configurator configurator.Configurator // This is the kubernetes client that operates async caches to avoid issuing synchronous // calls through kubeClient and instead relies on background cache synchronization and local // lookups kubeController k8s.Controller // policyController implements the functionality related to the resources part of the policy.openrservicemesh.io // API group, such as egress. policyController policy.Controller } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/04/13/pexelsbradyknoll5409751.jpg","permalink":"https://atbug.com/how-open-presented-in-open-service-mesh/","tags":["Kubernetes","Service Mesh"],"title":"å¼€æ”¾æœåŠ¡ç½‘æ ¼ Open Service Mesh å¦‚ä½•å¼€æ”¾ï¼Ÿ"},{"categories":["æ•™ç¨‹"],"contents":"ä½¿ç”¨ Kubernetes æ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°ä¸€äº›æ£˜æ‰‹çš„ç½‘ç»œé—®é¢˜éœ€è¦å¯¹ Pod å†…çš„æµé‡è¿›è¡ŒæŠ“åŒ…åˆ†æã€‚ç„¶è€Œæ‰€ä½¿ç”¨çš„é•œåƒä¸€èˆ¬ä¸ä¼šå¸¦æœ‰ tcpdump å‘½ä»¤ï¼Œè¿‡å»å¸¸ç”¨çš„åšæ³•ç®€å•ç›´æ¥æš´åŠ›ï¼šç™»å½•åˆ°èŠ‚ç‚¹æ‰€åœ¨èŠ‚ç‚¹ï¼Œä½¿ç”¨ root è´¦å·è¿›å…¥å®¹å™¨ï¼Œç„¶åå®‰è£… tcpdumpã€‚æŠ“åˆ°çš„åŒ…æœ‰æ—¶è¿˜éœ€è¦æ‹‰å›æœ¬åœ°ï¼Œä½¿ç”¨ Wireshark è¿›è¡Œåˆ†æã€‚è€Œä¸”æ•´ä¸ªè¿‡ç¨‹éå¸¸ç¹çï¼Œè·¨è¶Šå‡ ä¸ªç¯å¢ƒã€‚\næ­£å¥½å‰å‡ å¤©ä¹Ÿåšäº†ä¸€æ¬¡æŠ“åŒ…é—®é¢˜æ’æŸ¥ï¼Œè¿™æ¬¡å°±ä»‹ç»ä¸€ä¸‹å¿«é€Ÿè¿›è¡Œç½‘ç»œæŠ“åŒ…çš„å‡ ç§æ–¹æ³•ã€‚\nTL;DR å‡ ç§æ–¹æ³•å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œä¸”éƒ½ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚å‡å¦‚å¿…é¡»ä½¿ç”¨ï¼Œä¸ªäººå€¾å‘äº kubectl debug ä¸´æ—¶å®¹å™¨çš„æ–¹æ¡ˆï¼Œä½†è¿™ä¸ªæ–¹æ¡ˆä¹Ÿæœ‰ä¸è¶³ã€‚\nä½¿ç”¨é¢å¤–å®¹å™¨ï¼šè¿™ç§æ–¹æ¡ˆä¸ºäº† Pod æ·»åŠ ä¸€ä¸ªé¢å¤–çš„å®¹å™¨ï¼Œä½¿ç”¨äº†é™æ€ç¼–è¯‘çš„ tcpdump è¿›è¡ŒæŠ“å–ï¼Œå€ŸåŠ©äº†å¤šå®¹å™¨å…±äº«ç½‘ç»œç©ºé—´çš„ç‰¹æ€§ï¼Œé€‚åˆ distroless å®¹å™¨ã€‚ç¼ºç‚¹æ˜¯éœ€è¦ä¿®æ”¹åŸæ¥çš„ Podï¼Œè°ƒå¼å®¹å™¨é‡å¯ä¼šå¼•èµ· Pod é‡å¯ã€‚ kubectl plugin ksniffï¼šä¸€ä¸ª kubectl æ’ä»¶ã€‚æ”¯æŒç‰¹æƒå’Œéç‰¹æƒå®¹å™¨ï¼Œå¯ä»¥å°†æ•è·å†…å®¹é‡å®šå‘åˆ° wireshark æˆ–è€… tsharkã€‚éç‰¹æƒå®¹å™¨çš„å®ç°ä¼šç¨å¾®å¤æ‚ã€‚ kubectl debug ä¸´æ—¶å®¹å™¨ï¼šè¯¥æ–¹æ¡ˆå¯¹äº distroless å®¹å™¨æœ‰å¾ˆå¥½çš„æ”¯æŒï¼Œä¸´æ—¶å®¹å™¨é€€å‡ºåä¹Ÿä¸ä¼šå¯¼è‡´ Pod é‡å¯ã€‚ç¼ºç‚¹æ˜¯ 1.23 çš„ç‰ˆæœ¬ä¸´æ—¶å®¹å™¨æ‰è¿›å…¥ beta é˜¶æ®µï¼›è€Œä¸”ç¬”è€…åœ¨å°†æ•è·çš„æ•°æ®é‡å®šå‘åˆ°æœ¬åœ°çš„ Wireshark æ—¶ä¼šæŠ¥æ•°æ®æ ¼å¼ä¸æ”¯æŒçš„é”™è¯¯ã€‚ ç¯å¢ƒ ä½¿ç”¨ k3d åˆ›å»º k3s é›†ç¾¤ï¼Œè¿™é‡Œç‰ˆæœ¬é€‰æ‹© 1.23:\n$ k3d cluster create test --image rancher/k3s:v1.23.4-k3s1 æŠ“åŒ…çš„å¯¹è±¡ä½¿ç”¨ Pipy è¿è¡Œçš„ä¸€ä¸ª echo æœåŠ¡ï¼ˆè¿”å›è¯·æ±‚çš„ body å†…å®¹ï¼‰ï¼š\n$ kubectl run echo --image addozhang/echo-server --image-pull-policy IfNotPresent ä¸ºäº†æ–¹ä¾¿è®¿é—®ï¼Œåˆ›å»ºä¸€ä¸ª NodePort Serviceï¼š\n$ kubectl expose pod echo --name echo --port 8080 --type NodePort æŒ‚è½½å®¹å™¨ åœ¨ä¹‹å‰çš„æ–‡ç« æˆ‘ä»¬ä»‹ç»è°ƒè¯• distroless å®¹å™¨çš„å‡ ç§æ–¹æ³•æ—¶æ›¾ç”¨è¿‡ä¿®æ”¹ Pod æ·»åŠ é¢å¤–å®¹å™¨çš„æ–¹å¼ï¼Œæ–°çš„å®¹å™¨ä½¿ç”¨é•œåƒ addozhang/static-dump é•œåƒã€‚è¿™ä¸ªé•œåƒä¸­åŠ å…¥äº†é™æ€ç¼–è¯‘çš„ tcpdumpã€‚\nä¿®æ”¹åçš„ Podï¼š\napiVersion: v1 kind: Pod metadata: labels: run: echo name: echo spec: containers: - image: addozhang/echo-server imagePullPolicy: IfNotPresent name: echo resources: {} - image: addozhang/static-dump imagePullPolicy: IfNotPresent name: sniff command: [\u0026#39;sleep\u0026#39;, \u0026#39;1d\u0026#39;] dnsPolicy: ClusterFirst restartPolicy: Always status: {} é‡æ–°éƒ¨ç½²åï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤å°†æŠ“å–ç½‘ç»œåŒ…å¹¶é‡å®šå‘åˆ°æœ¬åœ°çš„ Wiresharkï¼š\n$ kubectl exec -i echo -c sniff -- /static-tcpdump -i eth0 -U -w - | wireshark -k -i - kubectl plugin ksniff ksniff æ˜¯ä¸€ä¸ª kubectl æ’ä»¶ï¼Œåˆ©ç”¨ tcpdump å’Œ Wireshark å¯¹ Pod ä¸­çš„ç½‘ç»œåŒ…å®ç°è¿œç¨‹æŠ“å–ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•æ—¢å¯ä»¥å€ŸåŠ© Wireshark çš„å¼ºå¤§åŠŸèƒ½ï¼Œåˆèƒ½é™ä½å¯¹ Pod çš„å½±å“ã€‚\nksniff çš„å®ç°æ˜¯ä¸Šä¼ ä¸€ä¸ªé™æ€ç¼–è¯‘çš„tcpdump åˆ° Pod ä¸­ï¼Œç„¶åå°† tcpdump çš„è¾“å‡ºé‡å®šå‘åˆ°æœ¬åœ°çš„ Wireshark è¿›è¡Œè°ƒè¯•ã€‚\næ ¸å¿ƒå¯ä»¥ç†è§£æˆ tcpdump -w - | wireshark -k -i -ï¼Œä¸å‰é¢ä½¿ç”¨ debug å®¹å™¨çš„æ–¹æ¡ˆç±»ä¼¼ã€‚\nå®‰è£… é€šè¿‡ krew å®‰è£…ï¼š\n$ kubectl krew install sniff æˆ–è€…ä¸‹è½½å‘å¸ƒåŒ…ï¼Œæ‰‹åŠ¨å®‰è£…ï¼š\n$ unzip ksniff.zip $ make install ç‰¹æƒæ¨¡å¼å®¹å™¨ ä½¿ç”¨è¯´æ˜å‚è€ƒ ksniff å®˜æ–¹è¯´æ˜ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œé»˜è®¤å°±ä¼šé‡å®šå‘åˆ° Wiresharkï¼Œä¸éœ€è¦æ˜¾ç¤ºåœ°æŒ‡å®šï¼š\n$ kubectl sniff echo -n default -f \u0026#34;port 8080\u0026#34; é™¤äº†ä½¿ç”¨ Wiresharkï¼Œå¯ä»¥ä½¿ç”¨å…¶å‘½ä»¤è¡Œæ¨¡å¼çš„ tsharkï¼š\n$ kubectl sniff echo -n default -f \u0026#34;port 8080\u0026#34; -o - | tshark -r - éç‰¹æƒæ¨¡å¼å®¹å™¨ å¯¹äºæ— ç‰¹æƒçš„å®¹å™¨ï¼Œå°±æ— æ³•ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•äº†ï¼Œä¼šæ”¶åˆ°å¦‚ä¸‹çš„é”™è¯¯æç¤ºï¼š\nINFO[0000] command: \u0026#39;[/tmp/static-tcpdump -i any -U -w - port 8080]\u0026#39; executing successfully exitCode: \u0026#39;1\u0026#39;, stdErr :\u0026#39;static-tcpdump: any: You don\u0026#39;t have permission to capture on that device (socket: Operation not permitted) ä¸è¿‡ï¼ŒKsniff å¯¹æ­¤ç±»å®¹å™¨ä¹Ÿæä¾›äº†æ”¯æŒã€‚é€šè¿‡æ·»åŠ  -p å‚æ•°ï¼Œksniff ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯ä»¥è®¿é—®èŠ‚ç‚¹ä¸Š Docker Daemon çš„ podï¼Œç„¶åå°†å®¹å™¨é™„åŠ åˆ°ç›®æ ‡å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œå¹¶æ‰§è¡ŒæŠ¥æ–‡æ•è·ã€‚\næ³¨æ„ï¼Œç¬”è€…ä½¿ç”¨çš„æ˜¯ k3s çš„ç¯å¢ƒï¼Œæ‰§è¡Œå‘½ä»¤æ—¶éœ€è¦é€šè¿‡å‚æ•°æŒ‡å®š Docker Daemon çš„ socket åœ°å€ --socket /run/k3s/containerd/containerd.sock\n$ kubectl sniff echo -n default -f \u0026#34;port 8080\u0026#34; --socket /run/k3s/containerd/containerd.sock -p | wireshark -k -i - kubectl debug ä¸´æ—¶å®¹å™¨ æ¥ä¸‹æ¥ä¹Ÿæ˜¯ä¹‹å‰ä»‹ç»è¿‡çš„ kubectl debug ï¼Œä¹Ÿå°±æ˜¯ä¸º Pod æ·»åŠ ä¸´æ—¶å®¹å™¨ã€‚\nåŒæ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ç§æ–¹æ³•å¯¹ Pod çš„ç½‘ç»œè¿›è¡ŒæŠ“åŒ…ï¼Œä¸´æ—¶å®¹å™¨æˆ‘ä»¬ä½¿ç”¨ addozhang/static-dump é•œåƒã€‚\n$ kubectl debug -i echo --image addozhang/static-dump --target echo -- /static-tcpdump -i eth0 å¤§å®¶èƒ½å‘ç°è¿™é‡Œå°†æ•è·çš„å†…å®¹ç›´æ¥è¾“å‡ºåœ¨æ ‡å‡†è¾“å‡ºä¸­äº†ï¼Œè€Œä¸æ˜¯é‡å®šå‘åˆ°æœ¬åœ°çš„ Wiresharkã€‚\nåŸæœ¬ä¸´æ—¶å®¹å™¨åº”è¯¥æ˜¯å…¶ä¸­æœ€æ¥è¿‘å®Œç¾çš„æ–¹æ¡ˆï¼šä¸éœ€ä¸Šä¼ ä»»ä½•æ–‡ä»¶ç›®æ ‡å®¹å™¨ã€æ— éœ€ä¿®æ”¹ Podã€æ— éœ€é‡å¯ã€æ— éœ€ç‰¹æƒã€æ”¯æŒ distroless å®¹å™¨ã€‚ç„¶è€Œï¼Œå½“å°è¯•é‡å®šå‘åˆ° Wireshark æˆ–è€… tshark çš„æ—¶å€™ï¼Œä¼šé‡åˆ° Data written to the pipe is neither in a supported pcap format nor in pcapng format. é—®é¢˜ã€‚\næœ€åç»è¿‡ä¸€ç•ªæŠ˜è…¾ï¼Œä¹Ÿæœªèƒ½è§£å†³è¯¥é—®é¢˜ã€‚æœ‰è§£å†³äº†é—®é¢˜çš„æœ‹å‹ï¼Œä¹Ÿéº»çƒ¦è¯„è®ºå‘ŠçŸ¥ä¸€ä¸‹ã€‚æ„Ÿè°¢ï¼\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/04/03/pexelslucafinardi7277575.jpg","permalink":"https://atbug.com/how-to-sniff-packet-in-kubernetes-pod/","tags":["Kubernetes","distroless"],"title":"å¦‚ä½•åœ¨ Kubernetes Pod å†…è¿›è¡Œç½‘ç»œæŠ“åŒ…"},{"categories":["ç¬”è®°"],"contents":"è¿™æ˜¯ä¸€ç¯‡å‘è¡¨äº 2016 å¹´çš„è®ºæ–‡ï¼Œæ˜¯ BeyondCorp ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡ã€‚è™½ç„¶è¿‡å»å¤šå¹´ï¼Œä½†æ˜¯åœ¨æµé‡çš„ç²¾ç»†åŒ–æ§åˆ¶æ–¹é¢ä»ç„¶å€¼å¾—å­¦ä¹ ã€‚\nBeyondCorp æ˜¯ Google å¯¹é›¶ä¿¡ä»»æ¨¡å‹çš„å®ç°ã€‚å®ƒå»ºç«‹åœ¨ Google åå¹´ç»éªŒçš„åŸºç¡€ä¸Šï¼Œå¹¶ç»“åˆäº†ç¤¾åŒºçš„æƒ³æ³•å’Œæœ€ä½³å®è·µã€‚é€šè¿‡å°†è®¿é—®æ§åˆ¶ä»ç½‘ç»œè¾¹ç•Œè½¬ç§»åˆ°ä¸ªäººç”¨æˆ·ï¼ŒBeyondCorp å‡ ä¹å¯ä»¥åœ¨ä»»ä½•ä½ç½®è¿›è¡Œå®‰å…¨å·¥ä½œï¼Œè€Œæ— éœ€ä¼ ç»Ÿçš„ VPNã€‚\nThe Access Proxy è¯¦ç»†æè¿°äº† BeyondCorp å‰ç«¯åŸºç¡€è®¾æ–½çš„å®ç°ï¼Œä»‹ç»äº†åœ¨å®ç° Access Proxyï¼ˆä»¥ä¸‹ç®€ç§° APï¼‰æ—¶çš„æŒ‘æˆ˜ä¸å®è·µæ•™è®­ï¼Œå¹¶ç»™å‡ºäº†æœ€ä½³å®è·µã€‚\nAP æ˜¯åœ¨è´Ÿè½½å‡è¡¡åå‘ä»£ç†çš„åŸºç¡€ä¸Šå¢åŠ äº†å®‰å…¨çš„å¤„ç†ï¼Œå¢åŠ äº†éªŒè¯ã€æˆæƒã€é›†ä¸­æ—¥å¿—è®°å½•ï¼Œä»¥åŠè‡ªæœåŠ¡é…ç½®ã€‚æ•´ä¸ªè®¾è®¡ä¸Šï¼Œå……åˆ†åˆ©ç”¨äº†å¯¹æµé‡çš„ç²¾ç»†åŒ–æ§åˆ¶ã€‚\nè®¤è¯ åœ¨ä¼ ç»Ÿä»£ç†çš„ TLS å¤–ï¼Œå¼•å…¥è®¤è¯åŠŸèƒ½ã€‚è¯¥åŠŸèƒ½çš„æ ¸å¿ƒä¹‹ä¸€æ˜¯è¯·æ±‚æ–¹è¯†åˆ«ï¼ŒéªŒè¯ç”¨æˆ·èº«ä»½ã€‚å¹¶æ”¯æŒä¸€ç³»åˆ—çš„èº«ä»½éªŒè¯é€‰é¡¹ã€‚\næ­¤å¤–ï¼Œè®¤è¯è¿˜éœ€è¦å¯¹åç«¯æœåŠ¡â€œéšè—â€èº«ä»½éªŒè¯å‡­è¯ï¼Œä¹Ÿä¸ä¼šå¯¹åç«¯æœåŠ¡è‡ªèº«çš„éªŒè¯æµç¨‹ã€‚\nå¤šå¹³å°çš„è®¤è¯ ä½¿ç”¨äº†ä¸€è‡´çš„ã€ä¸å¯å¤åˆ¶çš„ã€å”¯ä¸€è®¾å¤‡æ ‡è¯†ç¬¦å’Œç”¨äºè·Ÿè¸ªè®¾å¤‡æœ€æ–°çŠ¶æ€çš„å­˜å‚¨ï¼Œå®ç°å¯¹è®¾å¤‡çš„ä¿¡ä»»å–ä»£å¯¹ç½‘ç»œçš„ä¿¡ä»»ã€‚\nå¯¹äºä¸åŒçš„å¹³å°ï¼Œå……åˆ†åˆ©ç”¨å„å¹³å°æ ‡è¯†ã€‚æ¯”å¦‚ PC å’Œç¬”è®°æœ¬æ“ä½œç³»ç»Ÿçš„è®¾å¤‡è¯ä¹¦ï¼Œç§»åŠ¨è®¾å¤‡ç³»ç»Ÿçš„è®¾å¤‡æ ‡è¯†ã€‚\næˆæƒ æˆæƒçš„å¼•å…¥ä¸è®¤è¯åŠŸèƒ½ä¸€æ ·ï¼Œå°†åŸºç¡€åŠŸèƒ½ä¸åç«¯æœåŠ¡åˆ†ç¦»ï¼Œè§£æ”¾äº†åç«¯æœåŠ¡ã€‚ä½†æ˜¯ç”±äºå¤æ‚åº¦é™åˆ¶ï¼Œåªèƒ½æ‰§è¡Œç²—ç²’åº¦çš„ç­–ç•¥ï¼Œè¿˜éœ€ä¸åç«¯æœåŠ¡çš„ç»†ç²’åº¦ç­–ç•¥ç»“åˆä½¿ç”¨ã€‚\næ­¤å¤–ï¼Œè¿˜éœ€è§£å†³ä»£ç†ä¸åç«¯çš„åŒå‘è®¤è¯é—®é¢˜ï¼Œæ¯•ç«Ÿä»ZTNï¼ˆZero Trust Network é›¶ä¿¡ä»»ç½‘ç»œï¼‰çš„è§’åº¦çœ‹å†…éƒ¨ç½‘ç»œåŒæ ·ä¸å¯ä¿¡ã€‚é€šè¿‡åŒå‘è®¤è¯ç¡®ä¿æ•°æ®ï¼ˆå…ƒæ•°æ®ï¼Œé€šå¸¸æ˜¯è¯·æ±‚å¤´ï¼‰ä¸å¯æ¬ºéª—çš„åŒæ—¶ï¼Œè¿˜æœ‰é¢å¤–çš„æ”¶ç›Šï¼šé€šè¿‡å¢åŠ å…ƒæ•°æ®è½»æ¾åœ°æ‰©å±• AP çš„èƒ½åŠ›ï¼Œæ–°å¢çš„å…ƒæ•°æ®ä¹Ÿè¢«åç«¯æ¥å—å¹¶ä½¿ç”¨ã€‚\nå®ç°ä¸­å¿ƒåŒ–æˆæƒçš„å‰ææ˜¯ä¸€ä¸ª ACLï¼ˆAccess Control List è®¿é—®æ§åˆ¶è¡¨ï¼‰å¼•æ“å’Œç”¨äºè¡¨è¾¾ ACL çš„ DSLï¼ˆDomain Specific Language é¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰ã€‚\né›†ä¸­æ—¥å¿—è®°å½• é‰´äº AP çš„å®šä½éå¸¸é€‚åˆè¿›è¡Œæ•°æ®çš„è®°å½•ï¼Œç”¨äºäº‹ä»¶å“åº”å’Œå–è¯åˆ†æã€‚å¯ä»¥è®°å½•è¯·æ±‚å¤´ã€å“åº”ç¼–ç ä»¥åŠç”¨è°ƒè¯•æˆ–é‡å»ºè®¿é—®å†³ç­–å’ŒACL è¯„ä¼°æµç¨‹çš„å…ƒæ•°æ®ã€‚\nè¿ç»´æ‰©å±•æ€§ æä¾›è‡ªæœåŠ¡é…ç½®é™ä½å›¢é˜Ÿä»‹å…¥çš„æˆæœ¬ï¼Œå‰ææ˜¯å°†é…ç½®ç»“æ„åŒ–ï¼ŒåŒæ—¶å®ç°é…ç½®çš„æ‰€æœ‰æƒç®¡ç†ã€‚\næ­¤å¤–è¿˜æä¾›å“åº”çš„åŸ¹è®­å’Œå……åˆ†çš„æ–‡æ¡£ã€‚\nå…¶ä»– ä¸Šé¢åˆ—å‡ºäº† AP æä¾›çš„é™¤ä»£ç†ä»¥å¤–çš„åŠŸèƒ½ï¼Œè¿˜æœ‰ä¸€äº›æœ€ä½³å®è·µå’Œç»éªŒåˆ†äº«ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„è„‘å›¾ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/03/20/pexelssorashimazaki5935792.jpg","permalink":"https://atbug.com/the-access-proxy-notes/","tags":["Proxy","Security"],"title":"ã€ŠBeyondCorp Part III: The Access Proxyã€‹è§£è¯»"},{"categories":["äº‘åŸç”Ÿ"],"contents":"åœ¨ä¸Šä¸€ç¯‡ã€Šåœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ MetalLB ä½œä¸º LoadBalancerï¼ˆä¸Šï¼‰- Layer2ã€‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ MetalLB çš„ Layer2 æ¨¡å¼ä½œä¸º LoadBalancer çš„å®ç°ï¼Œå°† Kubernetes é›†ç¾¤ä¸­çš„æœåŠ¡æš´éœ²åˆ°é›†ç¾¤å¤–ã€‚\nè¿˜è®°å¾—æˆ‘ä»¬åœ¨ Configmap ä¸­ä¸º MetalLB åˆ†é…çš„ IP åœ°å€æ± ä¹ˆï¼Ÿ\napiVersion: v1 kind: ConfigMap metadata: namespace: metallb-system name: config data: config: | address-pools: - name: default protocol: layer2 addresses: - 192.168.1.30-192.168.1.49 è¿™é‡Œåˆ†é…çš„ 192.168.1.30-192.168.1.49 IP æ®µæ­£å¥½æ˜¯åœ¨ç¬”è€…çš„å®¶åº­ç½‘ç»œä¸­ï¼Œå½“æˆ‘ä»¬ç”¨ 192.168.1.30 å¯ä»¥æˆåŠŸè®¿é—®æœåŠ¡ã€‚\nä¹‹å‰æœ‰æè¿‡ Layer2 çš„ç¼ºç‚¹æ—¶è¿˜æ¼äº†ä¸€ç‚¹ï¼Œé™¤äº†æ•…éšœè½¬ç§»è¿‡ç¨‹ä¸­å¯¹å¯ç”¨æ€§æœ‰å½±å“ä¸”å­˜åœ¨å•ç‚¹ç½‘ç»œç“¶é¢ˆï¼Œè¿˜æœ‰å°±æ˜¯å®¢æˆ·ç«¯éœ€è¦ä¸åœ°å€æ± ä½äºåŒä¸€ä¸ªå­ç½‘ï¼ˆå‡å¦‚å°†åœ°å€æ± æ”¹ä¸º 192.168.0.30-192.168.0.49ï¼ŒæœåŠ¡å°†æ— æ³•è®¿é—®ï¼‰ã€‚ä¸è¿‡åœ¨å®éªŒç¯å¢ƒæˆ–è€…åƒç¬”è€…è¿™æ ·çš„ homelab ç¯å¢ƒæ¥è¯´ï¼Œå‰ä¸¤ä¸ªéƒ½ä¸ç®—æ˜¯é—®é¢˜ï¼Œåä¸€ä¸ªåˆ™åœ¨ç½‘ç»œé…ç½®æ—¶ç¨å¾®éº»çƒ¦ä¸€äº›ã€‚\nè™½ç„¶ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œä½†æ˜¯ Layer2 æ¨¡å¼æœ‰æ›´å¼ºçš„é€šç”¨æ€§ï¼Œä¸åƒ BGP æ¨¡å¼éœ€è¦æ”¯æŒ BGP çš„è·¯ç”±ã€‚ä½†æ˜¯è¿™äº›éƒ½æŒ¡ä¸ä½ç¬”è€…çš„æ¢ï¼ˆå¼ºï¼‰ç´¢ï¼ˆè¿«ï¼‰æ¬²ï¼ˆç—‡ï¼‰ï¼Œå› ä¸ºè¿˜æœ‰ä¸€ä¸ª OpenWrt è½¯è·¯ç”±è¿è¡Œåœ¨æˆ‘çš„ Proxmox è™šæ‹Ÿæœºä¸­ã€‚è¿™ä¸ª OpenWrt ä»¥è½¯è·¯ç”±çš„æ–¹å¼ï¼Œé€šè¿‡ 192.168.1.2 å¯¹å¤–æä¾›è·¯ç”±æœåŠ¡ï¼Œé€šè¿‡å®‰è£…è·¯ç”±è½¯ä»¶å¥—ä»¶æ¥æ”¯æŒ BGPã€‚\næ­£å¼å¼€å§‹ä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹ä»€ä¹ˆæ˜¯ BPG ä»¥åŠç›¸å…³çš„æœ¯è¯­ã€‚å·²ç»äº†è§£ï¼Œæˆ–è€…è§‰å¾—å¤ªæŠ½è±¡çš„åŒå­¦å¯ä»¥ç›´æ¥è·³è¿‡ï¼Œå¾…çœ‹å®Œdemoçš„å†å›å¤´çœ‹ã€‚\nä»€ä¹ˆæ˜¯ BGP BGP æ˜¯è¾¹ç•Œç½‘å…³åè®®ï¼ˆBorder Gateway Protocolï¼‰çš„ç¼©å†™ã€‚\nè¾¹ç•Œç½‘å…³åè®®æ˜¯äº’è”ç½‘ä¸Šä¸€ä¸ªæ ¸å¿ƒçš„å»ä¸­å¿ƒåŒ–è‡ªæ²»è·¯ç”±åè®®ã€‚å®ƒé€šè¿‡ç»´æŠ¤IPè·¯ç”±è¡¨æˆ–â€œå‰ç¼€â€è¡¨æ¥å®ç°è‡ªæ²»ç³»ç»Ÿï¼ˆASï¼‰ä¹‹é—´çš„å¯è¾¾æ€§ï¼Œå±äºçŸ¢é‡è·¯ç”±åè®®ã€‚BGPä¸ä½¿ç”¨ä¼ ç»Ÿçš„å†…éƒ¨ç½‘å…³åè®®ï¼ˆIGPï¼‰çš„æŒ‡æ ‡ï¼Œè€Œä½¿ç”¨åŸºäºè·¯å¾„ã€ç½‘ç»œç­–ç•¥æˆ–è§„åˆ™é›†æ¥å†³å®šè·¯ç”±ã€‚å› æ­¤ï¼Œå®ƒæ›´é€‚åˆè¢«ç§°ä¸ºçŸ¢é‡æ€§åè®®ï¼Œè€Œä¸æ˜¯è·¯ç”±åè®®ã€‚\nBGPçš„é‚»å±…å…³ç³»ï¼ˆæˆ–ç§°é€šä¿¡å¯¹ç«¯/å¯¹ç­‰å®ä½“ï¼Œpeerï¼‰æ˜¯é€šè¿‡äººå·¥é…ç½®å®ç°çš„ï¼Œå¯¹ç­‰å®ä½“ä¹‹é—´é€šè¿‡TCPç«¯å£179å»ºç«‹ä¼šè¯äº¤æ¢æ•°æ®ã€‚BGPè·¯ç”±å™¨ä¼šå‘¨æœŸåœ°å‘é€19å­—èŠ‚çš„ä¿æŒå­˜æ´»ï¼ˆkeep-aliveï¼‰æ¶ˆæ¯æ¥ç»´æŠ¤è¿æ¥ï¼ˆé»˜è®¤å‘¨æœŸä¸º60ç§’ï¼‰ã€‚åœ¨å„ç§è·¯ç”±åè®®ä¸­ï¼Œåªæœ‰BGPä½¿ç”¨TCPä½œä¸ºä¼ è¾“å±‚åè®®ã€‚\nåŒä¸€ä¸ªASè‡ªæ²»ç³»ç»Ÿä¸­çš„ä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹ç­‰å®ä½“ä¹‹é—´è¿è¡Œçš„BGPè¢«ç§°ä¸ºiBGPï¼ˆInternal/Interior BGPï¼‰ã€‚å½’å±ä¸åŒçš„ASçš„å¯¹ç­‰å®ä½“ä¹‹é—´è¿è¡Œçš„BGPç§°ä¸ºeBGPï¼ˆExternal/Exterior BGPï¼‰ã€‚åœ¨ASè¾¹ç•Œä¸Šä¸å…¶ä»–ASäº¤æ¢ä¿¡æ¯çš„è·¯ç”±å™¨è¢«ç§°ä½œè¾¹ç•Œè·¯ç”±å™¨ï¼ˆborder/edge routerï¼‰ï¼Œè¾¹ç•Œè·¯ç”±å™¨ä¹‹é—´äº’ä¸ºeBGPå¯¹ç«¯ã€‚åœ¨Cisco IOSä¸­ï¼ŒiBGPé€šå‘Šçš„è·¯ç”±è·ç¦»ä¸º200ï¼Œä¼˜å…ˆçº§æ¯”eBGPå’Œä»»ä½•å†…éƒ¨ç½‘å…³åè®®ï¼ˆIGPï¼‰é€šå‘Šçš„è·¯ç”±éƒ½ä½ã€‚å…¶ä»–çš„è·¯ç”±å™¨å®ç°ä¸­ï¼Œä¼˜å…ˆçº§é¡ºåºä¹Ÿæ˜¯eBGPé«˜äºIGPï¼Œè€ŒIGPåˆé«˜äºiBGPã€‚\niBGPå’ŒeBGPçš„åŒºåˆ«ä¸»è¦åœ¨äºè½¬å‘è·¯ç”±ä¿¡æ¯çš„è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œä»eBGP peerè·å¾—çš„è·¯ç”±ä¿¡æ¯ä¼šåˆ†å‘ç»™æ‰€æœ‰iBGP peerå’ŒeBGP peerï¼Œä½†ä»iBGP peerè·å¾—çš„è·¯ç”±ä¿¡æ¯ä»…ä¼šåˆ†å‘ç»™æ‰€æœ‰eBGP peerã€‚æ‰€æœ‰çš„iBGP peerä¹‹é—´éœ€è¦å…¨äº’è”ã€‚\nè¿™é‡Œæåˆ°äº†ä¸‰ä¸ªåè¯ï¼šè‡ªæ²»ç³»ç»Ÿï¼ˆASï¼‰ã€å†…éƒ¨ç½‘å…³åè®®ï¼ˆIGPï¼‰å’Œå¤–éƒ¨ç½‘å…³åè®®ï¼ˆEGPï¼‰ã€‚\nè‡ªæ²»ç³»ç»Ÿ AS æˆ‘ä»¬çœ‹ä¸‹æ¥è‡ªç»´åŸºç™¾ç§‘çš„ä»‹ç»ï¼š\nè‡ªåˆ¶ç³»ç»Ÿï¼ˆAutonomous systemï¼Œç¼©å†™ ASï¼‰ï¼Œæ˜¯æŒ‡åœ¨äº’è”ç½‘ä¸­ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªå®ä½“ç®¡è¾–ä¸‹çš„æ‰€æœ‰IP ç½‘ç»œå’Œè·¯ç”±å™¨çš„ç»„åˆï¼Œå®ƒä»¬å¯¹äº’è”ç½‘æ‰§è¡Œå…±åŒçš„è·¯ç”±ç­–ç•¥ã€‚è‡ªæ²»ç³»ç»Ÿç¼–å·éƒ½æ˜¯16ä½é•¿çš„æ•´æ•°ï¼Œè¿™æœ€å¤šèƒ½è¢«åˆ†é…ç»™65536ä¸ªè‡ªæ²»ç³»ç»Ÿã€‚è‡ªæ²»ç³»ç»Ÿç¼–å·è¢«åˆ†æˆä¸¤ä¸ªèŒƒå›´ã€‚ç¬¬ä¸€ä¸ªèŒƒå›´æ˜¯å…¬å¼€çš„ASNï¼Œä»1åˆ°64511ï¼Œå®ƒä»¬å¯åœ¨äº’è”ç½‘ä¸Šä½¿ç”¨ï¼›ç¬¬äºŒä¸ªèŒƒå›´æ˜¯è¢«ç§°ä¸ºç§æœ‰ç¼–å·çš„ä»64512åˆ°65535çš„é‚£äº›ï¼Œå®ƒä»¬ä»…èƒ½åœ¨ä¸€ä¸ªç»„ç»‡è‡ªå·±çš„ç½‘ç»œå†…ä½¿ç”¨ã€‚\nç®€å•ç†è§£ï¼Œç”µä¿¡ã€ç§»åŠ¨ã€è”é€šéƒ½æœ‰è‡ªå·±çš„ AS ç¼–å·ï¼Œä¸”ä¸åªä¸€ä¸ªï¼Œæœ‰å…´è¶£çš„å¯ä»¥æŸ¥çœ‹ç»´åŸºç™¾ç§‘ä¸­çš„ä¸­å›½äº’è”ç½‘éª¨å¹²ç½‘æ¡ç›®ã€‚\né™¤äº†äº’è”ç½‘å…¬å¼€çš„ ASN ä»¥å¤–ï¼Œç§æœ‰çš„ç¼–å·å¯ä»¥åœ¨å†…éƒ¨ä½¿ç”¨ã€‚æ¯”å¦‚æˆ‘å¯ä»¥æˆ‘çš„å®¶åº­ç½‘ç»œä¸­ä½¿ç”¨ç§æœ‰ç¼–å·åˆ›å»ºå‡ ä¸ª ASã€‚\nå†…éƒ¨è·¯ç”±åè®® IGP å¼•ç”¨ç™¾ç§‘ä¸­çš„å†…å®¹ï¼Œä¸æ˜¯æœ¬ç¯‡çš„é‡ç‚¹å› æ­¤ä¸åšè¿‡å¤šä»‹ç»ã€‚\nå†…éƒ¨è·¯ç”±åè®®ï¼ˆInterior Gateway Protocol ç¼©å†™ä¸º IGPï¼‰æ˜¯æŒ‡åœ¨ä¸€ä¸ªè‡ªæ²»ç³»ç»Ÿï¼ˆASï¼‰å†…éƒ¨æ‰€ä½¿ç”¨çš„ä¸€ç§è·¯ç”±åè®®ã€‚\nå¤–éƒ¨ç½‘å…³åè®® EGP å¤–éƒ¨ç½‘å…³åè®®ï¼ˆExterior Gateway Protocolï¼Œé”™å†™ EGPï¼‰æ˜¯ä¸€ä¸ªå·²ç»è¿‡æ—¶äº’è”ç½‘è·¯ç”±åè®®ã€‚å·²ç”± BPG å–ä»£ã€‚\nBPG çš„ç”±æ¥ BPG æ˜¯ä¸ºäº†æ›¿æ¢ EGP è€Œåˆ›å»ºçš„ï¼Œè€Œé™¤äº†åº”ç”¨äº AS å¤–éƒ¨ï¼Œä¹Ÿå¯ä»¥åº”ç”¨åœ¨ AS å†…éƒ¨ã€‚å› æ­¤åˆåˆ†ä¸º EBGP å’Œ IBGPã€‚\nè¯´äº†è¿™ä¹ˆå¤šå¯èƒ½æœ‰äº›æŠ½è±¡ï¼Œç›´æ¥ä¸Š demo å§ã€‚\nDemo ç¯å¢ƒè¿˜æ˜¯ä½¿ç”¨ä¹‹å‰çš„ï¼ŒæŒ‰ç…§é¢„å…ˆè®¾æƒ³æˆ‘ä»¬å¸Œæœ›åˆ›å»ºä¸¤ä¸ª ASï¼š65000 å’Œ 65001ã€‚å‰è€…ä½œä¸ºè·¯ç”±å™¨å’Œå®¢æˆ·ç«¯æ‰€åœ¨çš„ ASï¼Œè€Œåè€…æ˜¯æˆ‘ä»¬é›†ç¾¤æœåŠ¡ LoadBalancer IP æ‰€åœ¨çš„ ASã€‚\næˆ‘ä»¬è¦å…ˆè®© OpenWrt æ”¯æŒ BGPã€‚\nOpenWrt æ”¯æŒ BGP ä¸ºäº†è®© OpenWrt æ”¯æŒ BGPï¼Œè¿™é‡Œè¦ç”¨åˆ°è·¯ç”±è½¯ä»¶å¥—ä»¶ Quaggaã€‚Quagga æä¾›äº† OSPFv2ã€OSPFv3ã€RIP v1 v2ã€RIPng å’Œ BGP-4 çš„å®ç°ã€‚\nQuagga æ¶æ„ç”±æ ¸å¿ƒå®ˆæŠ¤è¿›ç¨‹å’Œ zebra ç»„æˆï¼Œåè€…ä½œä¸ºåº•å±‚ Unix å†…æ ¸çš„æŠ½è±¡å±‚ï¼Œå¹¶é€šè¿‡ Unix æˆ–è€… TCP å‘ Quagga å®¢æˆ·ç«¯æä¾› Zserv APIã€‚æ­£æ˜¯è¿™äº› Zserv å®¢æˆ·ç«¯å®ç°äº†è·¯ç”±åè®®ï¼Œå¹¶å°†è·¯ç”±çš„æ›´æ–°å‘é€ç»™ zebra å®ˆæŠ¤è¿›ç¨‹ã€‚å½“å‰ Zserv çš„å®ç°æ˜¯ï¼š\nQuagga çš„å®ˆæŠ¤è¿›ç¨‹å¯ä»¥é€šè¿‡ç½‘ç»œå¯è®¿é—®çš„ CLIï¼ˆç®€ç§° vtyï¼‰è¿›è¡Œé…ç½®ã€‚ CLI éµå¾ªä¸å…¶ä»–è·¯ç”±è½¯ä»¶ç±»ä¼¼çš„é£æ ¼ã€‚è¿˜é¢å¤–æä¾›äº†ä¸€ä¸ªå·¥å…· vtyshï¼Œå……å½“äº†æ‰€æœ‰å®ˆæŠ¤è¿›ç¨‹çš„èšåˆå‰ç«¯ï¼Œå…è®¸åœ¨ä¸€ä¸ªåœ°æ–¹ç®¡ç†æ‰€æœ‰ Quagga å®ˆæŠ¤è¿›ç¨‹çš„æ‰€æœ‰åŠŸèƒ½ã€‚\næ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯å®Œæˆå®‰è£…ï¼š\n$ opkg update \u0026amp;\u0026amp; opkg install quagga quagga-zebra quagga-bgpd quagga-vtysh æˆåŠŸå®‰è£…ä¹‹åï¼Œä¼šè‡ªåŠ¨å¯åŠ¨å¹¶ç›‘å¬ç«¯å£ï¼š\n$ netstat -lantp | grep -e \u0026#39;zebra\\|bgpd\u0026#39; tcp 0 0 0.0.0.0:2601 0.0.0.0:* LISTEN 2984/zebra tcp 0 0 0.0.0.0:2605 0.0.0.0:* LISTEN 3000/bgpd tcp 0 0 :::2601 :::* LISTEN 2984/zebra tcp 0 0 :::2605 :::* LISTEN 3000/bgpd è¿™é‡Œå¹¶æ²¡æœ‰çœ‹åˆ° bpgd ç”¨äºæ¥æ”¶è·¯ç”±ä¿¡æ¯è€Œç›‘å¬çš„ 179 ç«¯å£ï¼Œè¿™æ˜¯å› ä¸ºè¯¥è·¯ç”±è¿˜æ²¡æœ‰åˆ†é… ASã€‚ä¸ç€æ€¥ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨å‘½ä»¤ vtyshè¿›å…¥ vty è¿›è¡Œé…ç½®ï¼š\n$ vtysh OpenWrt# conf t OpenWrt(config)# router bgp 65000 OpenWrt(config-router)# neighbor 192.168.1.5 remote-as 65001 OpenWrt(config-router)# neighbor 192.168.1.5 description ubuntu-dev1 OpenWrt(config-router)# neighbor 192.168.1.6 remote-as 65001 OpenWrt(config-router)# neighbor 192.168.1.6 description ubuntu-dev2 OpenWrt(config-router)# exit OpenWrt(config)# exit åœ¨ vty ä¸­ä½¿ç”¨ show ip bgp summary å‘½ä»¤æŸ¥çœ‹ï¼š\nOpenWrt# show ip bgp summary BGP router identifier 192.168.1.2, local AS number 65000 RIB entries 0, using 0 bytes of memory Peers 2, using 18 KiB of memory Neighbor V AS MsgRcvd MsgSent TblVer InQ OutQ Up/Down State/PfxRcd 192.168.1.5 4 65001 0 0 0 0 0 never Active 192.168.1.6 4 65001 0 0 0 0 0 never Active Total number of neighbors 2 Total num. Established sessions 0 Total num. of routes received 0 æ­¤æ—¶æˆ‘ä»¬å†å»æŸ¥çœ‹ç«¯å£ç›‘å¬ï¼Œå°±å¯ä»¥çœ‹åˆ° bgpd å·²ç»åœ¨ç›‘å¬ 179 ç«¯å£äº†ï¼š\n$ netstat -lantp | grep -e \u0026#39;zebra\\|bgpd\u0026#39; tcp 0 0 0.0.0.0:179 0.0.0.0:* LISTEN 3000/bgpd tcp 0 0 0.0.0.0:2601 0.0.0.0:* LISTEN 2984/zebra tcp 0 0 0.0.0.0:2605 0.0.0.0:* LISTEN 3000/bgpd tcp 0 0 :::179 :::* LISTEN 3000/bgpd tcp 0 0 :::2601 :::* LISTEN 2984/zebra tcp 0 0 :::2605 :::* LISTEN 3000/bgpd BGP çš„è·¯ç”±è®¾ç½®å¥½ä¹‹åï¼Œå°±æ˜¯ MetalLB çš„éƒ¨åˆ†äº†ã€‚\nMetalLB BGP æ¨¡å¼ æˆ‘ä»¬æ›´æ–°ä¸€ä¸‹ configmapï¼š\napiVersion: v1 kind: ConfigMap metadata: namespace: metallb-system name: config data: config: | peers: - peer-address: 192.168.1.2 peer-asn: 65000 my-asn: 65001 address-pools: - name: default protocol: bgp addresses: - 192.168.0.30-192.168.0.49 æ›´æ–°ä¹‹åï¼Œä½ ä¼šå‘ç° Service çš„ EXTERNAL-IP å¹¶æ²¡æœ‰é‡æ–°åˆ†é…ï¼ŒMetalLB çš„æ§åˆ¶å™¨å¹¶æ²¡æœ‰è‡ªåŠ¨ç”Ÿæ•ˆé…ç½®ã€‚æˆ‘ä»¬åˆ é™¤æ§åˆ¶å™¨ pod è¿›è¡Œé‡å¯ï¼š\n$ kubectl delete po -n metallb-system -l app=metallb,component=controller pod \u0026#34;controller-66445f859d-vss2t\u0026#34; deleted æ­¤æ—¶å¯ä»¥çœ‹åˆ° Service åˆ†é…åˆ°äº†æ–°çš„ IPï¼š\n$ kubectl get svc -n default NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 25m nginx-lb LoadBalancer 10.43.188.185 192.168.0.30 8080:30381/TCP 21m nginx2-lb LoadBalancer 10.43.208.169 192.168.0.31 8080:32319/TCP 21m æ£€æŸ¥ speaker POD çš„æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°ä¸ peer 192.168.1.2 ä¹‹é—´çš„é€šä¿¡å·²ç»å¼€å§‹ï¼Œå¹¶å¯¹å¤–å‘å¸ƒäº† IP åœ°å€çš„å…¬å‘Šï¼š\n{\u0026#34;caller\u0026#34;:\u0026#34;level.go:63\u0026#34;,\u0026#34;configmap\u0026#34;:\u0026#34;metallb-system/config\u0026#34;,\u0026#34;event\u0026#34;:\u0026#34;peerAdded\u0026#34;,\u0026#34;level\u0026#34;:\u0026#34;info\u0026#34;,\u0026#34;msg\u0026#34;:\u0026#34;peer configured, starting BGP session\u0026#34;,\u0026#34;peer\u0026#34;:\u0026#34;192.168.1.2\u0026#34;,\u0026#34;ts\u0026#34;:\u0026#34;2022-03-06T22:56:17.336335657Z\u0026#34;} {\u0026#34;caller\u0026#34;:\u0026#34;level.go:63\u0026#34;,\u0026#34;configmap\u0026#34;:\u0026#34;metallb-system/config\u0026#34;,\u0026#34;event\u0026#34;:\u0026#34;configLoaded\u0026#34;,\u0026#34;level\u0026#34;:\u0026#34;info\u0026#34;,\u0026#34;msg\u0026#34;:\u0026#34;config (re)loaded\u0026#34;,\u0026#34;ts\u0026#34;:\u0026#34;2022-03-06T22:56:17.336366122Z\u0026#34;} struct { Version uint8; ASN16 uint16; HoldTime uint16; RouterID uint32; OptsLen uint8 }{Version:0x4, ASN16:0xfde8, HoldTime:0xb4, RouterID:0xc0a80102, OptsLen:0x1e} {\u0026#34;caller\u0026#34;:\u0026#34;level.go:63\u0026#34;,\u0026#34;event\u0026#34;:\u0026#34;sessionUp\u0026#34;,\u0026#34;level\u0026#34;:\u0026#34;info\u0026#34;,\u0026#34;localASN\u0026#34;:65001,\u0026#34;msg\u0026#34;:\u0026#34;BGP session established\u0026#34;,\u0026#34;peer\u0026#34;:\u0026#34;192.168.1.2:179\u0026#34;,\u0026#34;peerASN\u0026#34;:65000,\u0026#34;ts\u0026#34;:\u0026#34;2022-03-06T22:56:17.337341549Z\u0026#34;} {\u0026#34;caller\u0026#34;:\u0026#34;level.go:63\u0026#34;,\u0026#34;event\u0026#34;:\u0026#34;updatedAdvertisements\u0026#34;,\u0026#34;ips\u0026#34;:[\u0026#34;192.168.0.30\u0026#34;],\u0026#34;level\u0026#34;:\u0026#34;info\u0026#34;,\u0026#34;msg\u0026#34;:\u0026#34;making advertisements using BGP\u0026#34;,\u0026#34;numAds\u0026#34;:1,\u0026#34;pool\u0026#34;:\u0026#34;default\u0026#34;,\u0026#34;protocol\u0026#34;:\u0026#34;bgp\u0026#34;,\u0026#34;service\u0026#34;:\u0026#34;default/nginx-lb\u0026#34;,\u0026#34;ts\u0026#34;:\u0026#34;2022-03-06T22:56:17.341939983Z\u0026#34;} {\u0026#34;caller\u0026#34;:\u0026#34;level.go:63\u0026#34;,\u0026#34;event\u0026#34;:\u0026#34;serviceAnnounced\u0026#34;,\u0026#34;ips\u0026#34;:[\u0026#34;192.168.0.30\u0026#34;],\u0026#34;level\u0026#34;:\u0026#34;info\u0026#34;,\u0026#34;msg\u0026#34;:\u0026#34;service has IP, announcing\u0026#34;,\u0026#34;pool\u0026#34;:\u0026#34;default\u0026#34;,\u0026#34;protocol\u0026#34;:\u0026#34;bgp\u0026#34;,\u0026#34;service\u0026#34;:\u0026#34;default/nginx-lb\u0026#34;,\u0026#34;ts\u0026#34;:\u0026#34;2022-03-06T22:56:17.341987657Z\u0026#34;} {\u0026#34;caller\u0026#34;:\u0026#34;level.go:63\u0026#34;,\u0026#34;event\u0026#34;:\u0026#34;updatedAdvertisements\u0026#34;,\u0026#34;ips\u0026#34;:[\u0026#34;192.168.0.31\u0026#34;],\u0026#34;level\u0026#34;:\u0026#34;info\u0026#34;,\u0026#34;msg\u0026#34;:\u0026#34;making advertisements using BGP\u0026#34;,\u0026#34;numAds\u0026#34;:1,\u0026#34;pool\u0026#34;:\u0026#34;default\u0026#34;,\u0026#34;protocol\u0026#34;:\u0026#34;bgp\u0026#34;,\u0026#34;service\u0026#34;:\u0026#34;default/nginx2-lb\u0026#34;,\u0026#34;ts\u0026#34;:\u0026#34;2022-03-06T22:56:17.342041554Z\u0026#34;} {\u0026#34;caller\u0026#34;:\u0026#34;level.go:63\u0026#34;,\u0026#34;event\u0026#34;:\u0026#34;serviceAnnounced\u0026#34;,\u0026#34;ips\u0026#34;:[\u0026#34;192.168.0.31\u0026#34;],\u0026#34;level\u0026#34;:\u0026#34;info\u0026#34;,\u0026#34;msg\u0026#34;:\u0026#34;service has IP, announcing\u0026#34;,\u0026#34;pool\u0026#34;:\u0026#34;default\u0026#34;,\u0026#34;protocol\u0026#34;:\u0026#34;bgp\u0026#34;,\u0026#34;service\u0026#34;:\u0026#34;default/nginx2-lb\u0026#34;,\u0026#34;ts\u0026#34;:\u0026#34;2022-03-06T22:56:17.342056076Z\u0026#34;} ç„¶åå¯ä»¥åœ¨ vty ä¸­æŸ¥çœ‹è·¯ç”±è¡¨ï¼š\nOpenWrt# show ip route Codes: K - kernel route, C - connected, S - static, R - RIP, O - OSPF, I - IS-IS, B - BGP, P - PIM, A - Babel, N - NHRP, \u0026gt; - selected route, * - FIB route K\u0026gt;* 0.0.0.0/0 via 192.168.1.1, br-lan C\u0026gt;* 127.0.0.0/8 is directly connected, lo B\u0026gt;* 192.168.0.30/32 [20/0] via 192.168.1.5, br-lan, 00:00:06 B\u0026gt;* 192.168.0.31/32 [20/0] via 192.168.1.5, br-lan, 00:00:06 C\u0026gt;* 192.168.1.0/24 is directly connected, br-lan ä»è¡¨ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ° 192.168.0.30/32 å’Œ 192.168.0.31/32 ä¸¤æ¡ BGP çš„è·¯ç”±ã€‚\næµ‹è¯• æˆ‘ä»¬ä½¿ç”¨æ–°çš„ IP è®¿é—®æœåŠ¡ï¼š\n$ curl -I 192.168.0.30:8080 HTTP/1.1 200 OK Server: nginx/1.21.6 Date: Sun, 06 Mar 2022 23:10:33 GMT Content-Type: text/html Content-Length: 615 Last-Modified: Tue, 25 Jan 2022 15:03:52 GMT Connection: keep-alive ETag: \u0026#34;61f01158-267\u0026#34; Accept-Ranges: bytes æ€»ç»“ è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»è¯•è¿‡äº† MetalLB çš„ä¸¤ç§æ¨¡å¼ï¼šLayer2 æœ‰å¾ˆå¼ºçš„é€šç”¨æ€§ï¼Œä¸éœ€è¦å…¶ä»–ä»»ä½•çš„ä¾èµ–ï¼Œä½†æ˜¯ç¼ºç‚¹ä¹Ÿæ˜æ˜¾ï¼›BGP æ¨¡å¼é™¤äº†ä¾èµ–æ”¯æŒ BGP çš„è·¯ç”±ï¼Œå…¶ä»–æ–¹é¢åˆ™æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œå¹¶ä¸”æ²¡æœ‰å¯ç”¨æ€§çš„é—®é¢˜ã€‚\nBGP åº”è¯¥æ˜¯ LoadBalancer çš„ç»ˆææ¨¡å¼ï¼Œä½†æ˜¯ Layer2 ä¹Ÿä¸æ˜¯æ¯«æ— ç”¨å¤„ã€‚å¤§å®¶è¿˜æ˜¯è¦çœ‹ä½¿ç”¨çš„åœºæ™¯æ¥ç†æ€§çš„é€‰æ‹©ï¼Œæ¯”å¦‚ homelab ä¸­ä½¿ç”¨æˆ‘ä¼šé€‰æ‹© Layer2 æ¨¡å¼ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/03/07/pexelsarchiebinamira913215.jpg","permalink":"https://atbug.com/load-balancer-service-with-metallb-bgp-mode/","tags":["Network","Kubernetes","OpenWrt"],"title":"åœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ MetalLB ä½œä¸º LoadBalancerï¼ˆä¸‹ï¼‰- BGP"},{"categories":["äº‘åŸç”Ÿ"],"contents":"è¿™æ˜¯ç³»åˆ—æ–‡ç« çš„ä¸Šç¯‡ï¼Œä¸‹ç¯‡ã€Šåœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ MetalLB ä½œä¸º LoadBalancerï¼ˆä¸‹ï¼‰- BGPã€‹ã€‚\nTL;DR ç½‘ç»œæ–¹é¢çš„çŸ¥è¯†åˆå¤šåˆæ‚ï¼Œå¾ˆå¤šåˆæ˜¯ç³»ç»Ÿå†…æ ¸çš„éƒ¨åˆ†ã€‚åŸæœ¬è‡ªå·±ä¸æ˜¯åšç½‘ç»œæ–¹é¢çš„ï¼Œç³»ç»Ÿå†…æ ¸çŸ¥è¯†ä¹Ÿè–„å¼±ã€‚ä½†æ°æ°æ˜¯è¿™äº›é™Œç”Ÿçš„å†…å®¹æ»¡æ»¡çš„è¯±æƒ‘ï¼ŒåŠ ä¸Šç°åœ¨çš„å·¥ä½œè·Ÿç½‘ç»œå…³è”æ›´å¤šäº†ï¼Œé€®ä½æœºä¼šå°±å­¦ä¹ ä¸‹ã€‚\nè¿™ç¯‡ä»¥ Kubernetes LoadBalancer ä¸ºèµ·ç‚¹ï¼Œä½¿ç”¨ MetalLB å»å®ç°é›†ç¾¤çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œåœ¨æ¢ç©¶å…¶å·¥ä½œåŸç†çš„åŒæ—¶äº†è§£ä¸€äº›ç½‘ç»œçš„çŸ¥è¯†ã€‚\nç”±äº MetalLB çš„å†…å®¹æœ‰ç‚¹å¤šï¼Œä¸€æ­¥æ­¥æ¥ï¼Œä»Šå¤©è¿™ç¯‡ä»…ä»‹ç»å…¶ä¸­ç®€å•åˆå®¹æ˜“ç†è§£çš„éƒ¨åˆ†ï¼Œä¸å‡ºæ„å¤–è¿˜ä¼šæœ‰ä¸‹ç¯‡ï¼ˆå¤ªå¤æ‚ï¼Œç­‰æˆ‘ææ˜ç™½å…ˆ :Dï¼‰ã€‚\nLoadBalancer ç±»å‹ Service ç”±äº Kubernets ä¸­ Pod çš„ IP åœ°å€ä¸å›ºå®šï¼Œé‡å¯å IP ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ— æ³•ä½œä¸ºé€šä¿¡çš„åœ°å€ã€‚Kubernets æä¾›äº† Service æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯¹å¤–æš´éœ²ã€‚\nKubernetes ä¸ºä¸€ç»„ Pod æä¾›ç›¸åŒçš„ DNS åå’Œè™šæ‹Ÿ IPï¼ŒåŒæ—¶è¿˜æä¾›äº†è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ã€‚è¿™é‡Œ Pod çš„åˆ†ç»„é€šè¿‡ç»™ Pod æ‰“æ ‡ç­¾ï¼ˆLabel ï¼‰æ¥å®Œæˆï¼Œå®šä¹‰ Service æ—¶ä¼šå£°æ˜æ ‡ç­¾é€‰æ‹©å™¨ï¼ˆselectorï¼‰å°† Service ä¸ è¿™ç»„ Pod å…³è”èµ·æ¥ã€‚\næ ¹æ®ä½¿ç”¨åœºæ™¯çš„ä¸åŒï¼ŒService åˆåˆ†ä¸º 4 ç§ç±»å‹ï¼šClusterIPã€NodePortã€LoadBalancer å’Œ ExternalNameï¼Œé»˜è®¤æ˜¯ ClusterIPã€‚è¿™é‡Œä¸ä¸€ä¸€è¯¦ç»†ä»‹ç»ï¼Œæœ‰å…´è¶£çš„æŸ¥çœ‹ Service å®˜æ–¹æ–‡æ¡£ã€‚\né™¤äº†ä»Šå¤©çš„ä¸»è§’ LoadBalancer å¤–ï¼Œå…¶ä»– 3 ç§éƒ½æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ç±»å‹ã€‚LoadBalancer å®˜æ–¹çš„è§£é‡Šæ˜¯ï¼š\nä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨æš´éœ²æœåŠ¡ã€‚ å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å¯ä»¥å°†æµé‡è·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„ NodePort æœåŠ¡å’Œ ClusterIP æœåŠ¡ä¸Šã€‚\nçœ‹åˆ°â€œäº‘æä¾›å•†æä¾›â€å‡ ä¸ªå­—æ—¶å¾€å¾€æœ›è€Œå´æ­¥ï¼Œæœ‰æ—¶åˆéœ€è¦ LoadBalancer å¯¹å¤–æš´éœ²æœåŠ¡åšäº›éªŒè¯å·¥ä½œï¼ˆè™½ç„¶é™¤äº† 7 å±‚çš„ Ingress ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ NodePort ç±»å‹çš„ Serviceï¼‰ï¼Œè€Œ Kubernetes å®˜æ–¹å¹¶æ²¡æœ‰æä¾›å®ç°ã€‚æ¯”å¦‚ä¸‹é¢è¦ä»‹ç»çš„ MetalLB å°±æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚\nMetalLB ä»‹ç» MetalLB æ˜¯è£¸æœº Kubernetes é›†ç¾¤çš„è´Ÿè½½å‡è¡¡å™¨å®ç°ï¼Œä½¿ç”¨æ ‡å‡†è·¯ç”±åè®®ã€‚\næ³¨æ„ï¼š MetalLB ç›®å‰è¿˜æ˜¯ beta é˜¶æ®µã€‚\nå‰æ–‡æåˆ° Kubernetes å®˜æ–¹å¹¶æ²¡æœ‰æä¾› LoadBalancer çš„å®ç°ã€‚å„å®¶äº‘å‚å•†æœ‰æä¾›å®ç°ï¼Œä½†å‡å¦‚ä¸æ˜¯è¿è¡Œåœ¨è¿™äº›äº‘ç¯å¢ƒä¸Šï¼Œåˆ›å»ºçš„ LoadBalancer Service ä¼šä¸€ç›´å¤„äº Pending çŠ¶æ€ï¼ˆè§ä¸‹æ–‡ Demo éƒ¨åˆ†ï¼‰ã€‚\nMetalLB æä¾›äº†ä¸¤ä¸ªåŠŸèƒ½ï¼š\nåœ°å€åˆ†é…ï¼šå½“åˆ›å»º LoadBalancer Service æ—¶ï¼ŒMetalLB ä¼šä¸ºå…¶åˆ†é… IP åœ°å€ã€‚è¿™ä¸ª IP åœ°å€æ˜¯ä»é¢„å…ˆé…ç½®çš„ IP åœ°å€åº“è·å–çš„ã€‚åŒæ ·ï¼Œå½“ Service åˆ é™¤åï¼Œå·²åˆ†é…çš„ IP åœ°å€ä¼šé‡æ–°å›åˆ°åœ°å€åº“ã€‚ å¯¹å¤–å¹¿æ’­ï¼šåˆ†é…äº† IP åœ°å€ä¹‹åï¼Œéœ€è¦è®©é›†ç¾¤å¤–çš„ç½‘ç»œçŸ¥é“è¿™ä¸ªåœ°å€çš„å­˜åœ¨ã€‚MetalLB ä½¿ç”¨äº†æ ‡å‡†è·¯ç”±åè®®å®ç°ï¼šARPã€NDP æˆ–è€… BGPã€‚ å¹¿æ’­çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œç¬¬ä¸€ç§æ˜¯ Layer 2 æ¨¡å¼ï¼Œä½¿ç”¨ ARPï¼ˆipv4ï¼‰/NDPï¼ˆipv6ï¼‰ åè®®ï¼›ç¬¬äºŒç§æ˜¯ BPGã€‚\nä»Šå¤©ä¸»è¦ä»‹ç»ç®€å•çš„ Layer 2 æ¨¡å¼ï¼Œé¡¾åæ€ä¹‰æ˜¯ OSI äºŒå±‚çš„å®ç°ã€‚\nå…·ä½“å®ç°åŸç†ï¼Œçœ‹å®Œ Demo å†åšåˆ†æï¼Œç­‰ä¸åŠçš„åŒå­¦è¯·ç›´æ¥è·³åˆ°æœ€åã€‚\nè¿è¡Œæ—¶ MetalLB è¿è¡Œæ—¶æœ‰ä¸¤ç§å·¥ä½œè´Ÿè½½ï¼š\nControllerï¼šDeploymentï¼Œç”¨äºç›‘å¬ Service çš„å˜æ›´ï¼Œåˆ†é…/å›æ”¶ IP åœ°å€ã€‚ Speakerï¼šDaemonSetï¼Œå¯¹å¤–å¹¿æ’­ Service çš„ IP åœ°å€ã€‚ Demo å®‰è£…ä¹‹å‰ä»‹ç»ä¸‹ç½‘ç»œç¯å¢ƒï¼ŒKubernetes ä½¿ç”¨ K8s å®‰è£…åœ¨ Proxmox çš„è™šæ‹Ÿæœºä¸Šã€‚\nå®‰è£… K3s å®‰è£… K3sï¼Œè¿™é‡Œéœ€è¦é€šè¿‡ --disable servicelb ç¦ç”¨ k3s é»˜è®¤çš„ servicelbã€‚\nå‚è€ƒ K3s æ–‡æ¡£ï¼Œé»˜è®¤æƒ…å†µä¸‹ K3s ä½¿ç”¨ Traefik ingress æ§åˆ¶å™¨ å’Œ Klipper Service è´Ÿè½½å‡è¡¡å™¨æ¥å¯¹å¤–æš´éœ²æœåŠ¡ã€‚\ncurl -sfL https://get.k3s.io | sh -s - --disable traefik --disable servicelb --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config åˆ›å»ºå·¥ä½œè´Ÿè½½ ä½¿ç”¨ nginx é•œåƒï¼Œåˆ›å»ºä¸¤ä¸ªå·¥ä½œè´Ÿè½½ï¼š\nkubectl create deploy nginx --image nginx:latest --port 80 -n default kubectl create deploy nginx2 --image nginx:latest --port 80 -n default åŒæ—¶ä¸ºä¸¤ä¸ª Deployment åˆ›å»º Serviceï¼Œè¿™é‡Œç±»å‹é€‰æ‹© LoadBalancerï¼š\nkubectl expose deployment nginx --name nginx-lb --port 8080 --target-port 80 --type LoadBalancer -n default kubectl expose deployment nginx2 --name nginx2-lb --port 8080 --target-port 80 --type LoadBalancer -n default æ£€æŸ¥ Service å‘ç°çŠ¶æ€éƒ½æ˜¯ Pending çš„ï¼Œè¿™æ˜¯å› ä¸ºå®‰è£… K3s çš„æ—¶å€™æˆ‘ä»¬ç¦ç”¨äº† LoadBalancer çš„å®ç°ï¼š\nkubectl get svc -n default NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 14m nginx-lb LoadBalancer 10.43.108.233 \u0026lt;pending\u0026gt; 8080:31655/TCP 35s nginx2-lb LoadBalancer 10.43.26.30 \u0026lt;pending\u0026gt; 8080:31274/TCP 16s è¿™æ—¶å°±éœ€è¦ MetalLB ç™»åœºäº†ã€‚\nå®‰è£… MetalLB ä½¿ç”¨å®˜æ–¹æä¾› manifest æ¥å®‰è£…ï¼Œç›®å‰æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ 0.12.1ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥å…¶ä»–å®‰è£…æ–¹å¼ä¾›é€‰æ‹©ï¼Œæ¯”å¦‚ Helmã€Kustomize æˆ–è€… MetalLB Operatorã€‚\nkubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml kubectl get po -n metallb-system NAME READY STATUS RESTARTS AGE speaker-98t5t 1/1 Running 0 22s controller-66445f859d-gt9tn 1/1 Running 0 22s æ­¤æ—¶å†æ£€æŸ¥ LoadBalancer Service çš„çŠ¶æ€ä»ç„¶æ˜¯ Pending çš„ï¼Œå—¯ï¼Ÿå› ä¸ºï¼ŒMetalLB è¦ä¸º Service åˆ†é… IP åœ°å€ï¼Œä½† IP åœ°å€ä¸æ˜¯å‡­ç©ºæ¥çš„ï¼Œè€Œæ˜¯éœ€è¦é¢„å…ˆæä¾›ä¸€ä¸ªåœ°å€åº“ã€‚\nè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Layer 2 æ¨¡å¼ï¼Œé€šè¿‡ Configmap ä¸ºå…¶æä¾›ä¸€ä¸ª IP æ®µï¼š\napiVersion: v1 kind: ConfigMap metadata: namespace: metallb-system name: config data: config: | address-pools: - name: default protocol: layer2 addresses: - 192.168.1.30-192.168.1.49 æ­¤æ—¶å†æŸ¥çœ‹ Service çš„çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ° MetalLB ä¸ºä¸¤ä¸ª Service åˆ†é…äº† IP åœ°å€ 192.168.1.30ã€192.168.1.31ï¼š\nkubectl get svc -n default NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 28m nginx-lb LoadBalancer 10.43.201.249 192.168.1.30 8080:30089/TCP 14m nginx2-lb LoadBalancer 10.43.152.236 192.168.1.31 8080:31878/TCP 14m å¯ä»¥è¯·æ±‚æµ‹è¯•ä¸‹ï¼š\ncurl -I 192.168.1.30:8080 HTTP/1.1 200 OK Server: nginx/1.21.6 Date: Wed, 02 Mar 2022 15:31:15 GMT Content-Type: text/html Content-Length: 615 Last-Modified: Tue, 25 Jan 2022 15:03:52 GMT Connection: keep-alive ETag: \u0026#34;61f01158-267\u0026#34; Accept-Ranges: bytes curl -I 192.168.1.31:8080 HTTP/1.1 200 OK Server: nginx/1.21.6 Date: Wed, 02 Mar 2022 15:31:18 GMT Content-Type: text/html Content-Length: 615 Last-Modified: Tue, 25 Jan 2022 15:03:52 GMT Connection: keep-alive ETag: \u0026#34;61f01158-267\u0026#34; Accept-Ranges: bytes macOS æœ¬åœ°ä½¿ç”¨ arp -a æŸ¥çœ‹ ARP è¡¨å¯ä»¥æ‰¾åˆ°è¿™ä¸¤ä¸ª IP åŠ mac åœ°å€ï¼Œå¯ä»¥çœ‹å‡ºä¸¤ä¸ª IP éƒ½ç»‘å®šåœ¨åŒä¸€ä¸ªç½‘å¡ä¸Šï¼Œæ­¤å¤–è¿˜æœ‰è™šæ‹Ÿæœºçš„ IP åœ°å€ã€‚ä¹Ÿå°±æ˜¯è¯´ 3 ä¸ª IP ç»‘å®šåœ¨è¯¥è™šæ‹Ÿæœºçš„ en0 ä¸Šï¼š\nè€Œå»è™šæ‹Ÿæœºï¼ˆèŠ‚ç‚¹ï¼‰æŸ¥çœ‹ç½‘å¡ï¼ˆè¿™é‡Œåªèƒ½çœ‹åˆ°ç³»ç»Ÿç»‘å®šçš„ IPï¼‰ï¼š\nLayer 2 å·¥ä½œåŸç† Layer 2 ä¸­çš„ Speaker å·¥ä½œè´Ÿè½½æ˜¯ DeamonSet ç±»å‹ï¼Œåœ¨æ¯å°èŠ‚ç‚¹ä¸Šéƒ½è°ƒåº¦ä¸€ä¸ª Podã€‚é¦–å…ˆï¼Œå‡ ä¸ª Pod ä¼šå…ˆè¿›è¡Œé€‰ä¸¾ï¼Œé€‰ä¸¾å‡º Leaderã€‚Leader è·å–æ‰€æœ‰ LoadBalancer ç±»å‹çš„ Serviceï¼Œå°†å·²åˆ†é…çš„ IP åœ°å€ç»‘å®šåˆ°å½“å‰ä¸»æœºåˆ°ç½‘å¡ä¸Šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰ LoadBalancer ç±»å‹çš„ Service çš„ IP åŒä¸€æ—¶é—´éƒ½æ˜¯ç»‘å®šåœ¨åŒä¸€å°èŠ‚ç‚¹çš„ç½‘å¡ä¸Šã€‚\nå½“å¤–éƒ¨ä¸»æœºæœ‰è¯·æ±‚è¦å‘å¾€é›†ç¾¤å†…çš„æŸä¸ª Serviceï¼Œéœ€è¦å…ˆç¡®å®šç›®æ ‡ä¸»æœºç½‘å¡çš„ mac åœ°å€ï¼ˆè‡³äºä¸ºä»€ä¹ˆï¼Œå‚è€ƒç»´åŸºç™¾ç§‘ï¼‰ã€‚è¿™æ˜¯é€šè¿‡å‘é€ ARP è¯·æ±‚ï¼ŒLeader èŠ‚ç‚¹çš„ä¼šä»¥å…¶ mac åœ°å€ä½œä¸ºå“åº”ã€‚å¤–éƒ¨ä¸»æœºä¼šåœ¨æœ¬åœ° ARP è¡¨ä¸­ç¼“å­˜ä¸‹æ¥ï¼Œä¸‹æ¬¡ä¼šç›´æ¥ä» ARP è¡¨ä¸­è·å–ã€‚\nè¯·æ±‚åˆ°è¾¾èŠ‚ç‚¹åï¼ŒèŠ‚ç‚¹å†é€šè¿‡ kube-proxy å°†è¯·æ±‚è´Ÿè½½å‡è¡¡ç›®æ ‡ Podã€‚æ‰€ä»¥è¯´ï¼Œå‡å¦‚Service æ˜¯å¤š Pod è¿™é‡Œæœ‰å¯èƒ½ä¼šå†è·³å»å¦ä¸€å°ä¸»æœºã€‚\nä¼˜ç¼ºç‚¹ ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼Œå®ç°èµ·æ¥ç®€å•ï¼ˆç›¸å¯¹äºå¦ä¸€ç§ BGP æ¨¡å¼ä¸‹è·¯ç”±å™¨è¦æ”¯æŒ BPGï¼‰ã€‚å°±åƒç¬”è€…çš„ç¯å¢ƒä¸€æ ·ï¼Œåªè¦ä¿è¯ IP åœ°å€åº“ä¸é›†ç¾¤æ˜¯åŒä¸€ä¸ªç½‘æ®µå³å¯ã€‚\nå½“ç„¶ç¼ºç‚¹æ›´åŠ æ˜æ˜¾äº†ï¼ŒLeader èŠ‚ç‚¹çš„å¸¦å®½ä¼šæˆä¸ºç“¶é¢ˆï¼›ä¸æ­¤åŒæ—¶ï¼Œå¯ç”¨æ€§æ¬ ä½³ï¼Œæ•…éšœè½¬ç§»éœ€è¦ 10 ç§’é’Ÿçš„æ—¶é—´ï¼ˆæ¯ä¸ª speaker è¿›ç¨‹æœ‰ä¸ª 10s çš„å¾ªç¯ï¼‰ã€‚\nå‚è€ƒ åœ°å€è§£æåè®® MetalLB æ¦‚å¿µ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/03/03/pexelstirachardkumtanom347145.jpg","permalink":"https://atbug.com/load-balancer-service-with-metallb/","tags":["Network","Kubernetes"],"title":"åœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ MetalLB ä½œä¸º LoadBalancerï¼ˆä¸Šï¼‰- Layer2"},{"categories":["äº‘åŸç”Ÿ"],"contents":"TL;DR åœ¨æœ¬ç¯‡ï¼Œæˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨äº† Kubernetes åŸç”Ÿçš„ç½‘ç»œç­–ç•¥å’Œ Cilium çš„ç½‘ç»œç­–ç•¥å®ç°äº† Pod ç½‘ç»œå±‚é¢çš„éš”ç¦»ã€‚ä¸åŒçš„æ˜¯ï¼Œå‰è€…åªæä¾›äº†åŸºäº L3/4 çš„ç½‘ç»œç­–ç•¥ï¼›åè€…æ”¯æŒ L3/4ã€L7 çš„ç½‘ç»œç­–ç•¥ã€‚\né€šè¿‡ç½‘ç»œç­–ç•¥æ¥æå‡ç½‘ç»œå®‰å…¨ï¼Œå¯ä»¥æå¤§é™ä½äº†å®ç°å’Œç»´æŠ¤çš„æˆæœ¬ï¼ŒåŒæ—¶å¯¹ç³»ç»Ÿå‡ ä¹æ²¡æœ‰å½±å“ã€‚\nå°¤å…¶æ˜¯åŸºäº eBPF æŠ€æœ¯çš„ Ciliumï¼Œè§£å†³äº†å†…æ ¸æ‰©å±•æ€§ä¸è¶³çš„é—®é¢˜ï¼Œä»å†…æ ¸å±‚é¢ä¸ºå·¥ä½œè´Ÿè½½æä¾›å®‰å…¨å¯é ã€å¯è§‚æµ‹çš„ç½‘ç»œè¿æ¥ã€‚\nç›®å½• TL;DR ç›®å½• èƒŒæ™¯ ç¤ºä¾‹åº”ç”¨ Kubernetes ç½‘ç»œç­–ç•¥ æµ‹è¯• æ€è€ƒ Cilium ç½‘ç»œç­–ç•¥ Cilium ç®€ä»‹ æµ‹è¯• èƒŒæ™¯ ä¸ºä»€ä¹ˆè¯´ Kubernetes ç½‘ç»œå­˜åœ¨å®‰å…¨éšæ‚£ï¼Ÿé›†ç¾¤ä¸­çš„ Pod é»˜è®¤æ˜¯æœªéš”ç¦»çš„ï¼Œä¹Ÿå°±æ˜¯ Pod ä¹‹é—´çš„ç½‘ç»œæ˜¯äº’é€šçš„ï¼Œå¯ä»¥äº’ç›¸é€šä¿¡çš„ã€‚\nè¿™é‡Œå°±ä¼šæœ‰é—®é¢˜ï¼Œæ¯”å¦‚ç”±äºæ•°æ®æ•æ„ŸæœåŠ¡ B åªå…è®¸ç‰¹å®šçš„æœåŠ¡ A æ‰èƒ½è®¿é—®ï¼Œè€ŒæœåŠ¡ C æ— æ³•è®¿é—® Bã€‚è¦ç¦æ­¢æœåŠ¡ C å¯¹æœåŠ¡ B çš„è®¿é—®ï¼Œå¯ä»¥æœ‰å‡ ç§æ–¹æ¡ˆï¼š\nåœ¨ SDK ä¸­æä¾›é€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œå®ç°ç™½åå•çš„åŠŸèƒ½ã€‚é¦–å…ˆè¯·æ±‚è¦å¸¦æœ‰æ¥æºçš„æ ‡è¯†ï¼Œç„¶åæœåŠ¡ç«¯å¯ä»¥æ¥æ”¶è§„åˆ™è®¾ç½®æ”¾è¡Œç‰¹å®šæ ‡è¯†çš„è¯·æ±‚ï¼Œæ‹’ç»å…¶ä»–çš„è¯·æ±‚ã€‚ äº‘åŸç”Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨æœåŠ¡ç½‘æ ¼çš„ RBACã€mTLS åŠŸèƒ½ã€‚RBAC å®ç°åŸç†ä¸åº”ç”¨å±‚çš„ SDK æ–¹æ¡ˆç±»ä¼¼ï¼Œä½†æ˜¯å±äºåŸºç¡€è®¾æ–½å±‚çš„æŠ½è±¡é€šç”¨æ–¹æ¡ˆï¼›mTLS åˆ™ä¼šæ›´åŠ å¤æ‚ä¸€äº›ï¼Œåœ¨è¿æ¥æ¡æ‰‹é˜¶æ®µè¿›è¡Œèº«ä»½éªŒè¯ï¼Œæ¶‰åŠè¯ä¹¦çš„ç­¾å‘ã€éªŒè¯ç­‰æ“ä½œã€‚ ä»¥ä¸Šä¸¤ç§æ–¹æ¡ˆå„æœ‰åˆ©å¼Šï¼š\nSDK çš„æ–¹æ¡ˆå®ç°ç®€å•ï¼Œä½†æ˜¯è§„æ¨¡è¾ƒå¤§çš„ç³»ç»Ÿä¼šé¢ä¸´å‡çº§æ¨å¹¿å›°éš¾ã€å¤šè¯­è¨€æ”¯æŒæˆæœ¬é«˜ç­‰é—®é¢˜ã€‚ æœåŠ¡ç½‘æ ¼çš„æ–¹æ¡ˆæ˜¯åŸºç¡€è®¾æ–½å±‚çš„é€šç”¨æ–¹æ¡ˆï¼Œå¤©ç”Ÿæ”¯æŒå¤šè¯­è¨€ã€‚ä½†æ˜¯å¯¹äºæœªè½åœ°ç½‘æ ¼çš„ç”¨æˆ·æ¥è¯´ï¼Œæ¶æ„å˜åŒ–å¤§ï¼Œæˆæœ¬é«˜ã€‚å¦‚æœå•çº¯ä¸ºäº†è§£å†³å®‰å…¨é—®é¢˜ï¼Œä½¿ç”¨ç½‘æ ¼æ–¹æ¡ˆæ€§ä»·æ¯”åˆå¾ˆä½ï¼Œä¸”ä¸è¯´ç°æœ‰ç½‘æ ¼å®ç°ç­‰è½åœ°éš¾åº¦å¤§åŠåæœŸçš„ä½¿ç”¨ç»´æŠ¤æˆæœ¬é«˜ã€‚ ç»§ç»­å‘åŸºç¡€è®¾æ–½ä¸‹å±‚æ‰¾æ–¹æ¡ˆï¼Œä»ç½‘ç»œå±‚å…¥æ‰‹ã€‚Kubernetes æä¾›äº†çš„ç½‘ç»œç­–ç•¥ NetworkPolicyï¼Œåˆ™å¯ä»¥å®ç°â€œç½‘ç»œå±‚é¢çš„éš”ç¦»â€ã€‚\nç¤ºä¾‹åº”ç”¨ åœ¨è¿›ä¸€æ­¥æ¼”ç¤º NetworkPolicy çš„æ–¹æ¡ˆä¹‹å‰ï¼Œå…ˆä»‹ç»ç”¨äºæ¼”ç¤ºçš„ç¤ºä¾‹åº”ç”¨ã€‚æˆ‘ä»¬ä½¿ç”¨ Cilium åœ¨äº’åŠ¨æ•™ç¨‹ Cilium getting started ä¸­ä½¿ç”¨çš„â€œæ˜Ÿçƒå¤§æˆ˜â€åœºæ™¯ã€‚\nè¿™é‡Œæœ‰ä¸‰ä¸ªåº”ç”¨ï¼Œæ˜Ÿæˆ˜è¿·ä¼°è®¡ä¸ä¼šé™Œç”Ÿï¼š\næ­»æ˜Ÿ deathstarï¼šåœ¨ 80 ç«¯å£æä¾› web æœåŠ¡ï¼Œæœ‰ 2 ä¸ª å‰¯æœ¬ï¼Œé€šè¿‡ Kubernetes Service çš„è´Ÿè½½å‡è¡¡ä¸ºå¸å›½æˆ˜æœºå¯¹å¤–æä¾›â€ç™»é™†â€œæœåŠ¡ã€‚ é’›æˆ˜æœº tiefighterï¼šæ‰§è¡Œç™»é™†è¯·æ±‚ã€‚ Xç¿¼æˆ˜æœº xwingï¼šæ‰§è¡Œç™»é™†è¯·æ±‚ã€‚ å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Label å¯¹ä¸‰ä¸ªåº”ç”¨è¿›è¡Œäº†æ ‡è¯†ï¼šorg å’Œ classã€‚åœ¨æ‰§è¡Œç½‘ç»œç­–ç•¥æ—¶ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨è¿™ä¸¤ä¸ªæ ‡ç­¾è¯†åˆ«è´Ÿè½½ã€‚\n# app.yaml --- apiVersion: v1 kind: Service metadata: name: deathstar labels: app.kubernetes.io/name: deathstar spec: type: ClusterIP ports: - port: 80 selector: org: empire class: deathstar --- apiVersion: apps/v1 kind: Deployment metadata: name: deathstar labels: app.kubernetes.io/name: deathstar spec: replicas: 2 selector: matchLabels: org: empire class: deathstar template: metadata: labels: org: empire class: deathstar app.kubernetes.io/name: deathstar spec: containers: - name: deathstar image: docker.io/cilium/starwars --- apiVersion: v1 kind: Pod metadata: name: tiefighter labels: org: empire class: tiefighter app.kubernetes.io/name: tiefighter spec: containers: - name: spaceship image: docker.io/tgraf/netperf --- apiVersion: v1 kind: Pod metadata: name: xwing labels: app.kubernetes.io/name: xwing org: alliance class: xwing spec: containers: - name: spaceship image: docker.io/tgraf/netperf Kubernetes ç½‘ç»œç­–ç•¥ å¯ä»¥é€šè¿‡å®˜æ–¹æ–‡æ¡£è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥æ”¾å‡ºé…ç½®ï¼š\n# native/networkpolicy.yaml apiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: policy namespace: default spec: podSelector: matchLabels: org: empire class: deathstar policyTypes: - Ingress ingress: - from: - podSelector: matchLabels: org: empire ports: - protocol: TCP port: 80 podSelector ï¼šè¡¨ç¤ºè¦åº”ç”¨ç½‘ç»œç­–ç•¥çš„å·¥ä½œè´Ÿè½½å‡è¡¡ï¼Œé€šè¿‡ label é€‰æ‹©åˆ°äº† deathstar çš„ 2 ä¸ª Podã€‚ policyTypes ï¼šè¡¨ç¤ºæµé‡çš„ç±»å‹ï¼Œå¯ä»¥æ˜¯ Ingress æˆ– Egress æˆ–ä¸¤è€…å…¼å…·ã€‚è¿™é‡Œä½¿ç”¨ Ingressï¼Œè¡¨ç¤ºå¯¹é€‰æ‹©çš„ deathstar Pod çš„å…¥ç«™æµé‡æ‰§è¡Œè§„åˆ™ã€‚ ingress.fromï¼šè¡¨ç¤ºæµé‡çš„æ¥æºå·¥ä½œè´Ÿè½½ï¼Œä¹Ÿæ˜¯ä½¿ç”¨ podSelector å’Œ Label è¿›è¡Œé€‰æ‹©ï¼Œè¿™é‡Œé€‰ä¸­äº† org=empire ä¹Ÿå°±æ˜¯æ‰€æœ‰â€œå¸å›½çš„æˆ˜æœºâ€ã€‚ ingress.portsï¼šè¡¨ç¤ºæµé‡çš„è¿›å…¥ç«¯å£ï¼Œè¿™é‡Œåˆ—å‡ºäº† deathstar çš„æœåŠ¡ç«¯å£ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æµ‹è¯•ä¸‹ã€‚\næµ‹è¯• å…ˆå‡†å¤‡ç¯å¢ƒï¼Œæˆ‘ä»¬ä½¿ç”¨ K3s ä½œä¸º Kubernetes ç¯å¢ƒã€‚ä½†ç”±äº K3s é»˜è®¤çš„ CNI æ’ä»¶ Flannel ä¸æ”¯æŒç½‘ç»œç­–ç•¥ï¼Œæˆ‘ä»¬éœ€è¦æ¢ä¸ªæ’ä»¶ï¼Œè¿™é‡Œé€‰æ‹© Calicoï¼Œå³ K3s + Calico çš„æ–¹æ¡ˆã€‚\nå…ˆåˆ›å»ºä¸€ä¸ªå•èŠ‚ç‚¹çš„é›†ç¾¤ï¼š\ncurl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE=\u0026#34;644\u0026#34; INSTALL_K3S_EXEC=\u0026#34;--flannel-backend=none --cluster-cidr=10.42.0.0/16 --disable-network-policy --disable=traefik\u0026#34; sh - æ­¤æ—¶ï¼Œæ‰€æœ‰çš„ Pod éƒ½å¤„äº Pending çŠ¶æ€ï¼Œå› ä¸ºè¿˜éœ€è¦å®‰è£… Calicoï¼š\nkubectl apply -f https://projectcalico.docs.tigera.io/manifests/calico.yaml å¾… Calico æˆåŠŸè¿è¡Œåï¼Œæ‰€æœ‰çš„ Pod ä¹Ÿä¼šæˆåŠŸè¿è¡Œã€‚\næ¥ä¸‹æ¥å°±æ˜¯éƒ¨ç½²åº”ç”¨ï¼š\nkubectl apply -f app.yaml æ‰§è¡Œç­–ç•¥å‰ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤çœ‹çœ‹â€œæˆ˜æœºèƒ½å¦ç™»é™†æ­»æ˜Ÿâ€ï¼š\nkubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing Ship landed kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing Ship landed ä»ç»“æœæ¥çœ‹ï¼Œä¸¤ç§ â€æˆ˜æœºâ€œï¼ˆPod è´Ÿè½½ï¼‰éƒ½å¯ä»¥è®¿é—® deathstar æœåŠ¡ã€‚\næ­¤æ—¶æ‰§è¡Œç½‘ç»œç­–ç•¥ï¼š\nkubectl apply -f native/networkpolicy.yaml å†æ¬¡å°è¯•â€ç™»é™†â€œï¼Œxwing çš„ç™»é™†è¯·æ±‚ä¼šåœåœ¨é‚£ï¼ˆéœ€è¦ä½¿ç”¨ ctrl+c é€€å‡ºï¼Œæˆ–è€…è¯·æ±‚æ—¶åŠ ä¸Š --connect-timeout 2ï¼‰ã€‚\næ€è€ƒ ä½¿ç”¨ Kubernetes ç½‘ç»œç­–ç•¥å®ç°äº†æˆ‘ä»¬æƒ³è¦çš„ï¼Œä»ç½‘ç»œå±‚é¢ä¸ºæœåŠ¡å¢åŠ äº†ç™½åå•çš„åŠŸèƒ½ï¼Œè¿™ç§æ–¹æ¡ˆæ²¡æœ‰æ”¹é€ æˆæœ¬ï¼Œå¯¹ç³»ç»Ÿä¹Ÿå‡ ä¹æ— å½±å“ã€‚\nCilium è¿˜æ²¡å‡ºåœºå°±ç»“æŸäº†ï¼Ÿæˆ‘ä»¬ç»§ç»­çœ‹ï¼š\næœ‰æ—¶æˆ‘ä»¬çš„æœåŠ¡ä¼šå¯¹å¤–æš´éœ²ä¸€äº›ç®¡ç†ç«¯ç‚¹ï¼Œç”±ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œä¸€äº›ç®¡ç†ä¸Šçš„æ“ä½œï¼Œæ¯”å¦‚çƒ­æ›´æ–°ã€é‡å¯ç­‰ã€‚è¿™äº›ç«¯ç‚¹æ˜¯ä¸å…è®¸æ™®é€šæœåŠ¡æ¥è°ƒç”¨ï¼Œå¦åˆ™ä¼šé€ æˆä¸¥é‡çš„åæœã€‚\næ¯”å¦‚ç¤ºä¾‹ä¸­ï¼Œtiefighter è®¿é—®äº† deathstar çš„ç®¡ç†ç«¯ç‚¹ /exhaust-portï¼š\nkubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port Panic: deathstar exploded goroutine 1 [running]: main.HandleGarbage(0x2080c3f50, 0x2, 0x4, 0x425c0, 0x5, 0xa) /code/src/github.com/empire/deathstar/ temp/main.go:9 +0x64 main.main() /code/src/github.com/empire/deathstar/ temp/main.go:5 +0x85 å‡ºç°äº† Panic é”™è¯¯ï¼Œæ£€æŸ¥ Pod ä½ ä¼šå‘ç° dealthstar æŒ‚äº†ã€‚\nKubernetes çš„ç½‘ç»œç­–ç•¥ä»…èƒ½å·¥ä½œåœ¨ L3/4 å±‚ï¼Œå¯¹ L7 å±‚å°±æ— èƒ½ä¸ºåŠ›äº†ã€‚\nè¿˜æ˜¯è¦è¯·å‡º Ciliumã€‚\nCilium ç½‘ç»œç­–ç•¥ ç”±äº Cilium æ¶‰åŠäº† Linux å†…æ ¸ã€ç½‘ç»œç­‰ä¼—å¤šçŸ¥è¯†ç‚¹ï¼Œè¦è®²æ¸…å®ç°åŸç†ç¯‡å¹…æå¤§ã€‚æ•…è¿™é‡Œä»…æ‘˜å–äº†å®˜ç½‘çš„ä»‹ç»ï¼ŒåæœŸå¸Œæœ›æœ‰æ—¶é—´å†å†™ä¸€ç¯‡å…³äºå®ç°çš„ã€‚\nCilium ç®€ä»‹ Cilium æ˜¯ä¸€ä¸ªå¼€æºè½¯ä»¶ï¼Œç”¨äºæä¾›ã€ä¿æŠ¤å’Œè§‚å¯Ÿå®¹å™¨å·¥ä½œè´Ÿè½½ï¼ˆäº‘åŸç”Ÿï¼‰ä¹‹é—´çš„ç½‘ç»œè¿æ¥ï¼Œç”±é©å‘½æ€§çš„å†…æ ¸æŠ€æœ¯ eBPF æ¨åŠ¨ã€‚\neBPF æ˜¯ä»€ä¹ˆï¼Ÿ\nLinux å†…æ ¸ä¸€ç›´æ˜¯å®ç°ç›‘æ§/å¯è§‚æµ‹æ€§ã€ç½‘ç»œå’Œå®‰å…¨åŠŸèƒ½çš„ç†æƒ³åœ°æ–¹ã€‚ ä¸è¿‡å¾ˆå¤šæƒ…å†µä¸‹è¿™å¹¶éæ˜“äº‹ï¼Œå› ä¸ºè¿™äº›å·¥ä½œéœ€è¦ä¿®æ”¹å†…æ ¸æºç æˆ–åŠ è½½å†…æ ¸æ¨¡å—ï¼Œ æœ€ç»ˆå®ç°å½¢å¼æ˜¯åœ¨å·²æœ‰çš„å±‚å±‚æŠ½è±¡ä¹‹ä¸Šå åŠ æ–°çš„æŠ½è±¡ã€‚ eBPF æ˜¯ä¸€é¡¹é©å‘½æ€§æŠ€æœ¯ï¼Œå®ƒèƒ½åœ¨å†…æ ¸ä¸­è¿è¡Œæ²™ç®±ç¨‹åºï¼ˆsandbox programsï¼‰ï¼Œ è€Œæ— éœ€ä¿®æ”¹å†…æ ¸æºç æˆ–è€…åŠ è½½å†…æ ¸æ¨¡å—ã€‚\nå°† Linux å†…æ ¸å˜æˆå¯ç¼–ç¨‹ä¹‹åï¼Œå°±èƒ½åŸºäºç°æœ‰çš„ï¼ˆè€Œéå¢åŠ æ–°çš„ï¼‰æŠ½è±¡å±‚æ¥æ‰“é€ æ›´åŠ æ™ºèƒ½ã€ åŠŸèƒ½æ›´åŠ ä¸°å¯Œçš„åŸºç¡€è®¾æ–½è½¯ä»¶ï¼Œè€Œä¸ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œä¹Ÿä¸ä¼šç‰ºç‰²æ‰§è¡Œæ•ˆç‡å’Œå®‰å…¨æ€§ã€‚\næˆ‘ä»¬æ¥çœ‹ä¸‹ Cilium çš„ç½‘ç»œç­–ç•¥ï¼š\n# cilium/networkpolicy-L4.yaml apiVersion: \u0026#34;cilium.io/v2\u0026#34; kind: CiliumNetworkPolicy metadata: name: \u0026#34;rule1\u0026#34; spec: description: \u0026#34;L7 policy to restrict access to specific HTTP call\u0026#34; endpointSelector: matchLabels: org: empire class: deathstar ingress: - fromEndpoints: - matchLabels: org: empire toPorts: - ports: - port: \u0026#34;80\u0026#34; protocol: TCP ä¸ Kubernetes çš„åŸç”Ÿç½‘ç»œç­–ç•¥å·®å¼‚ä¸å¤§ï¼Œå‚è€ƒå‰é¢çš„ä»‹ç»ä¹Ÿéƒ½çœ‹æ‡‚ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥æµ‹è¯•ã€‚\næµ‹è¯• ç”±äº Cilium æœ¬èº«å°±å®ç°äº† CNIï¼Œæ‰€ä»¥ä¹‹å‰çš„é›†ç¾¤å°±ä¸èƒ½ç”¨äº†ï¼Œå…ˆå¸è½½é›†ç¾¤ï¼š\nk3s-uninstall.sh # ï¼ï¼ï¼åˆ‡è®°è¦æ¸…ç†ä¹‹å‰çš„ cni æ’ä»¶ sudo rm -rf /etc/cni/net.d è¿˜æ˜¯ä½¿ç”¨åŒæ ·çš„å‘½ä»¤åˆ›å»ºå•èŠ‚ç‚¹çš„é›†ç¾¤ï¼š\ncurl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE=\u0026#34;644\u0026#34; INSTALL_K3S_EXEC=\u0026#34;--flannel-backend=none --cluster-cidr=10.42.0.0/16 --disable-network-policy --disable=traefik\u0026#34; sh - # cilium ä¼šä½¿ç”¨è¯¥å˜é‡ export KUBECONFIG=/etc/rancher/k3s/k3s.yaml æ¥ä¸‹æ¥å®‰è£… Cilium CLIï¼š\ncurl -L --remote-name-all https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz{,.sha256sum} sha256sum --check cilium-linux-amd64.tar.gz.sha256sum sudo tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin rm cilium-linux-amd64.tar.gz{,.sha256sum} cilium version cilium-cli: v0.10.2 compiled with go1.17.6 on linux/amd64 cilium image (default): v1.11.1 cilium image (stable): v1.11.1 cilium image (running): unknown. Unable to obtain cilium version, no cilium pods found in namespace \u0026#34;kube-system\u0026#34; å®‰è£… Cilium åˆ°é›†ç¾¤ï¼š\ncilium install å¾… Cilium æˆåŠŸè¿è¡Œï¼š\ncilium status /Â¯Â¯\\ /Â¯Â¯\\__/Â¯Â¯\\ Cilium: OK \\__/Â¯Â¯\\__/ Operator: OK /Â¯Â¯\\__/Â¯Â¯\\ Hubble: disabled \\__/Â¯Â¯\\__/ ClusterMesh: disabled \\__/ Deployment cilium-operator Desired: 1, Ready: 1/1, Available: 1/1 DaemonSet cilium Desired: 1, Ready: 1/1, Available: 1/1 Containers: cilium Running: 1 cilium-operator Running: 1 Cluster Pods: 3/3 managed by Cilium Image versions cilium-operator quay.io/cilium/operator-generic:v1.11.1@sha256:977240a4783c7be821e215ead515da3093a10f4a7baea9f803511a2c2b44a235: 1 cilium quay.io/cilium/cilium:v1.11.1@sha256:251ff274acf22fd2067b29a31e9fda94253d2961c061577203621583d7e85bd2: 1 éƒ¨ç½²åº”ç”¨ï¼š\nkubectl apply -f app.yaml å¾…åº”ç”¨å¯åŠ¨åæµ‹è¯•æœåŠ¡è°ƒç”¨ï¼š\nkubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing Ship landed kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing Ship landed æ‰§è¡Œ L4 ç½‘ç»œç­–ç•¥ï¼š\nkubectl apply -f cilium/networkpolicy-L4.yaml å†æ¬¡å°è¯•â€œç™»é™†â€æ­»æ˜Ÿï¼Œxwing æˆ˜æœºåŒæ ·æ— æ³•ç™»é™†ï¼Œè¯´æ˜ L4 å±‚çš„è§„åˆ™ç”Ÿæ•ˆã€‚\næˆ‘ä»¬å†å°è¯• L7 å±‚çš„è§„åˆ™ï¼š\n# cilium/networkpolicy-L7.yaml apiVersion: \u0026#34;cilium.io/v2\u0026#34; kind: CiliumNetworkPolicy metadata: name: \u0026#34;rule1\u0026#34; spec: description: \u0026#34;L7 policy to restrict access to specific HTTP call\u0026#34; endpointSelector: matchLabels: org: empire class: deathstar ingress: - fromEndpoints: - matchLabels: org: empire toPorts: - ports: - port: \u0026#34;80\u0026#34; protocol: TCP rules: http: - method: \u0026#34;POST\u0026#34; path: \u0026#34;/v1/request-landing\u0026#34; æ‰§è¡Œè§„åˆ™ï¼š\nkubectl apply -f cilium/networkpolicy-L7.yaml è¿™å›ï¼Œä½¿ç”¨ tiefighter è°ƒç”¨æ­»æ˜Ÿçš„ç®¡ç†æ¥å£ï¼š\nkubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port Access denied # ç™»é™†æ¥å£å·¥ä½œæ­£å¸¸ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing Ship landed è¿™å›è¿”å›äº† Access deniedï¼Œè¯´æ˜ L7 å±‚çš„è§„åˆ™ç”Ÿæ•ˆäº†ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/02/13/pexelstimamiroshnichenko5380664.jpg","permalink":"https://atbug.com/enhance-kubernetes-network-security-with-cilium/","tags":["Cilium","Kubernetes","eBPF"],"title":"ä½¿ç”¨ Cilium å¢å¼º Kubernetes ç½‘ç»œå®‰å…¨"},{"categories":["äº‘åŸç”Ÿ"],"contents":"TL;DR æœ¬æ–‡ä»‹ç»å¹¶å®‰è£…ä½“éªŒäº†æç®€ Kubernetes å‘è¡Œç‰ˆï¼Œä¹Ÿé¡ºä¾¿åˆ†æå­¦ä¹ ä¸‹ç¼–è¯‘çš„æµç¨‹ã€‚\nèƒŒæ™¯ k8e æœ¬æ„ä¸º kuber easyï¼Œæ˜¯ä¸€ä¸ª Kubernetes çš„æç®€å‘è¡Œç‰ˆï¼Œæ„å›¾è®©äº‘åŸç”Ÿè½åœ°éƒ¨ç½² Kubernetes æ›´è½»æ¾ã€‚k8e æ˜¯åŸºäºå¦ä¸€ä¸ªå‘è¡Œç‰ˆ k3s ï¼Œç»è¿‡è£å‰ªï¼ˆå»æ‰äº† Edge/IoT ç›¸å…³åŠŸèƒ½ã€traefikç­‰ï¼‰ã€æ‰©å±•ï¼ˆåŠ å…¥ ingressã€sidecar å®ç°ã€ciliumç­‰ï¼‰è€Œæ¥ã€‚\nk8e å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š\nå•äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé›†æˆäº† k8s çš„å„ç§ç»„ä»¶ã€containerdã€runcã€kubectlã€nerdctl ç­‰ ä½¿ç”¨ cilium ä½œä¸º cni çš„å®ç°ï¼Œæ–¹ä¾¿ eBPF çš„å¿«é€Ÿè½åœ° æ”¯æŒåŸºäº Pipy çš„ ingressã€sidecar proxyï¼Œå®ç°åº”ç”¨æµé‡ä¸€ç«™å¼ç®¡ç† åªç»´æŠ¤ä¸€ä¸ª k8s ç‰ˆæœ¬ï¼Œç›®å‰æ˜¯ 1.21 æŒ‰ç…§ç§æœ‰äº‘çš„ç»éªŒå¢åŠ ã€ä¼˜åŒ–ä»£ç  å¾—ç›Šäºè¿™äº›ç‰¹æ€§ï¼Œk8e éå¸¸é€‚åˆCIã€å¼€å‘å’Œä¼ä¸šçº§éƒ¨ç½²ï¼Œå•æœºç‰ˆçš„é›†ç¾¤é€‚åˆæŠ€æœ¯éªŒè¯ç¯å¢ƒã€‚\nå®‰è£…æµ‹è¯• å¯ä»¥ä» GitHub ä¸Šä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ‰‹åŠ¨ç¼–è¯‘ï¼ˆåé¢å¯¹ç¼–è¯‘çš„æµç¨‹è¿›è¡Œäº†ç®€å•çš„åˆ†æï¼‰ã€‚\nsudo k8e check-config sudo k8e server \u0026amp; # Kubeconfig is written to /etc/k8e/k8e.yaml export KUBECONFIG=/etc/k8e/k8e.yaml # On a different node run the below. NODE_TOKEN comes from # /var/lib/k8e/server/node-token on your server sudo k8e agent --server https://myserver:6443 --token ${NODE_TOKEN} # query all node from k8s cluster sudo k8e kubectl get nodes å› ä¸ºæ²¡æœ‰æä¾›é»˜è®¤çš„ cni å®ç°ï¼Œæ­¤æ—¶ pod éƒ½å¤„äº Pending çŠ¶æ€ã€‚éœ€è¦æ‰‹åŠ¨å®‰è£… ciliumï¼š\né€šè¿‡ k8e check-config å¯ä»¥æ‰¾åˆ° builddata ç›®å½•ï¼š/var/lib/k8e/data/5a7ced03412504a18bf3f49cbee5dafca7187d86ef8fdaa789448d53d7fbb823\n/var/lib/k8e/data/5a7ced03412504a18bf3f49cbee5dafca7187d86ef8fdaa789448d53d7fbb823/bin/cilium install cilium å®‰è£…æˆåŠŸå Pod æˆåŠŸè¿è¡Œï¼Œå¯ä»¥æŸ¥çœ‹ cilium çŠ¶æ€ï¼š\n/var/lib/k8e/data/5a7ced03412504a18bf3f49cbee5dafca7187d86ef8fdaa789448d53d7fbb823/bin/cilium status /Â¯Â¯\\ /Â¯Â¯\\__/Â¯Â¯\\ Cilium: OK \\__/Â¯Â¯\\__/ Operator: OK /Â¯Â¯\\__/Â¯Â¯\\ Hubble: disabled \\__/Â¯Â¯\\__/ ClusterMesh: disabled \\__/ DaemonSet cilium Desired: 1, Ready: 1/1, Available: 1/1 Deployment cilium-operator Desired: 1, Ready: 1/1, Available: 1/1 Containers: cilium Running: 1 cilium-operator Running: 1 Cluster Pods: 3/3 managed by Cilium Image versions cilium quay.io/cilium/cilium:v1.10.5: 1 cilium-operator quay.io/cilium/operator-generic:v1.10.5: 1 æˆ–è€…æ‰§è¡Œ cilium connectivity test è¿›è¡Œæ£€æŸ¥ç½‘ç»œã€‚\nä¸Šé¢æ˜¯ä½œä¸ºå¼€å‘éªŒè¯ç¯å¢ƒçš„éƒ¨ç½²ï¼Œè‹¥è¦éƒ¨ç½²æ ‡å‡† Kubernetesï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚\nç¼–è¯‘æµç¨‹åˆ†æ k8e çš„ç¼–è¯‘éƒ¨ç½²ç®€å•çš„ä¸¤æ¡å‘½ä»¤å°±èƒ½å®Œæˆï¼š\nmake generate make æ‰§è¡Œ make generate ä¸‹è½½å†…ç½®çš„å‡ ä¸ªå·¥å…·ï¼šruncã€nerdctlã€ciliumï¼Œä¿å­˜åœ¨ bin ç›®å½•ä¸­ã€‚\n.DEFAULT_GOAL æ˜¯ ciï¼Œæ‰§è¡Œ make åˆ™ä¼šæ‰§è¡Œ target ci ã€‚\nDapper åœ¨ makefile çš„ç¬¬ä¸€è¡Œæ˜¯ TARGETS := $(shell ls hack | grep -v \\\\.sh | grep -v package-airgap| grep -v clean) å®šä¹‰äº†å˜é‡ TARGETSï¼Œç„¶å $(TARGETS): .dapper ä¸ºå‡ ä¸ª target æŒ‡å®šå‰ç½®æ¡ä»¶ã€‚å…¶ä¸­å°±æœ‰ ciï¼Œå› æ­¤åœ¨æ‰§è¡Œ ci ä¹‹å‰ä¼šå…ˆæ‰§è¡Œ target .dapperã€‚\ntarget .dapper ç”¨äºä¸‹è½½ rancher dapperã€‚dapper æ˜¯ Docker çš„æ„å»ºå°è£…å™¨ï¼Œæ‰§è¡Œæ—¶ä¼šä½¿ç”¨ä½äºæºç æ ¹ç›®å½• Dockerfile.dapper æ„å»ºé•œåƒï¼Œå¹¶ä»¥æ­¤ä½œä¸ºä»£ç æ„å»ºç¯å¢ƒã€‚\nåœ¨ Dockerfile.dapper ä¸­ï¼Œä¼šå‡†å¤‡æ„å»ºç¯å¢ƒï¼Œä»¥åŠå‡ ä¸ªéœ€è¦å…³æ³¨çš„è®¾ç½®ï¼š\nWORKDIRï¼š/go/src/github.com/xiaods/k8e/ï¼Œä¹Ÿå°±æ˜¯å®¹å™¨çš„å·¥ä½œç›®å½•ã€‚dapper å¯åŠ¨æ—¶ä¼šå°†æºç å†…å®¹æ‹·è´åˆ°å®¹å™¨ä¸­ ENTRYPOINTï¼š[\u0026quot;./hack/entry.sh\u0026quot;]ï¼Œå®¹å™¨å¯åŠ¨çš„ entrypointã€‚ CMDï¼š[\u0026quot;ci\u0026quot;]ï¼Œå®¹å™¨è¿è¡Œæ—¶çš„é»˜è®¤ CMD ENV DAPPER_SOURCEï¼š/go/src/github.com/xiaods/k8e/ DAPPER_OUTPUTï¼š./bin ./dist ./build/outï¼Œæ„å»ºå®Œæˆåï¼Œä¼šæ‰§è¡Œ docker cp ${DAPPER_SOURCE}/${DAPPER_OUTPUT} . å°†å®¹å™¨ä¸­çš„å†…å®¹æ‹·è´åˆ°å®¹å™¨å¤–ã€‚ \u0026hellip; dapper ä¸‹è½½å®Œæˆåä¼šæ‰§è¡Œ ci çš„å‘½ä»¤ï¼š./.dapper ciï¼Œæ ¹æ® Dockerfile.dapper çš„é…ç½®ï¼Œå¯åŠ¨åä¼šæ‰§è¡Œ ./hack/entry.sh ciã€‚\nCI CI çš„æµç¨‹ä¸ k3s çš„æµç¨‹ç›¸æ¯”ç²¾ç®€äº†å¾ˆå¤šã€‚åœ¨ ./hack/ci ä¸­ï¼Œä¼šä¾æ¬¡æ‰§è¡Œï¼š\n./hack/validateï¼šä»£ç æ ¼å¼åŒ–ã€æ ¡éªŒ ./hack/buildï¼šä»£ç ç¼–è¯‘ ./hack/packageï¼šå°†å‰é¢ä¸‹è½½ã€ç¼–è¯‘çš„ bin/ ç›®å½•ä¸‹çš„äºŒè¿›åˆ¶ä¸€åŒæ‰“åŒ…åˆ°åŒä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼ˆä½¿ç”¨ go-bindataï¼‰ã€‚ ./hack/binary_size_check.shï¼šäºŒè¿›åˆ¶æ–‡ä»¶å¤§å°çš„æ£€æŸ¥ï¼Œæ˜¯å¦è¶…è¿‡ 81 Mï¼ˆk3s çš„æ˜¯64Mï¼Œç”±äºåŠ å…¥äº† cilium ç­‰ cliï¼Œä½“ç§¯ä¼šæœ‰å¢åŠ ï¼‰ã€‚ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/02/12/pexelsstanswinnen6465964.jpg","permalink":"https://atbug.com/explore-simple-kubernetes-distribution/","tags":["Kubernetes","Docker"],"title":"æ¢ç§˜ k8eï¼šæç®€ Kubernetes å‘è¡Œç‰ˆ"},{"categories":["ç¬”è®°"],"contents":"SDKMAN æ˜¯ä¸€æ¬¾ç®¡ç†å¤šç‰ˆæœ¬ SDK çš„å·¥å…·ï¼Œå¯ä»¥å®ç°åœ¨å¤šä¸ªç‰ˆæœ¬é—´çš„å¿«é€Ÿåˆ‡æ¢ã€‚å®‰è£…å’Œä½¿ç”¨éå¸¸ç®€å•ï¼š\ncurl -s \u0026#34;https://get.sdkman.io\u0026#34; | bash sdk install java x.y.z ä½†åœ¨ m1ï¼ˆApple Siliconï¼‰çš„ mac ä¸Šï¼Œä¸çŸ¥é“æ³¨æ„åˆ°æ²¡ï¼Œåˆ—å‡ºçš„å¯é€‰ Java SDK å°‘äº†å¾ˆå¤šã€‚\nsdk list java ================================================================================ Available Java Versions for macOS ARM 64bit ================================================================================ Vendor | Use | Version | Dist | Status | Identifier -------------------------------------------------------------------------------- Corretto | | 17.0.2.8.1 | amzn | | 17.0.2.8.1-amzn | | 17.0.1.12.1 | amzn | | 17.0.1.12.1-amzn | | 17.0.0.35.2 | amzn | | 17.0.0.35.2-amzn Java.net | | 19.ea.5 | open | | 19.ea.5-open | | 19.ea.1.lm | open | | 19.ea.1.lm-open | | 18.ea.31 | open | | 18.ea.31-open | | 17.0.2 | open | | 17.0.2-open | | 17.0.1 | open | | 17.0.1-open Liberica | | 17.0.2.fx | librca | | 17.0.2.fx-librca | | 17.0.2 | librca | | 17.0.2-librca | | 17.0.1.fx | librca | | 17.0.1.fx-librca | \u0026gt;\u0026gt;\u0026gt; | 17.0.1 | librca | installed | 17.0.1-librca | | 11.0.14 | librca | | 11.0.14-librca | | 11.0.13 | librca | | 11.0.13-librca | | 8.0.322 | librca | | 8.0.322-librca | | 8.0.312 | librca | installed | 8.0.312-librca Microsoft | | 17.0.1 | ms | | 17.0.1-ms Oracle | | 17.0.2 | oracle | | 17.0.2-oracle | | 17.0.1 | oracle | | 17.0.1-oracle SapMachine | | 17.0.2 | sapmchn | | 17.0.2-sapmchn | | 17.0.1 | sapmchn | | 17.0.1-sapmchn Temurin | | 17.0.1 | tem | | 17.0.1-tem Zulu | | 17.0.2 | zulu | | 17.0.2-zulu | | 17.0.2.fx | zulu | | 17.0.2.fx-zulu | | 17.0.1 | zulu | | 17.0.1-zulu | | 17.0.1.fx | zulu | | 17.0.1.fx-zulu | | 11.0.14 | zulu | | 11.0.14-zulu | | 11.0.13 | zulu | | 11.0.13-zulu | | 8.0.322 | zulu | | 8.0.322-zulu | | 8.0.312 | zulu | | 8.0.312-zulu ================================================================================ ä»”ç»†çœ‹çš„è¯ï¼Œç¬¬ä¸€è¡Œ â€œAvailable Java Versions for macOS ARM 64bitâ€ è¯´æ˜åªåˆ—å‡ºäº†æ”¯æŒ arm64 çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”åˆ—è¡¨é‡Œä¹Ÿæ²¡æœ‰ Graalvmã€‚\nå¦‚æœè¦å®‰è£… Graalvmï¼Œä¸€ç§æ–¹æ³•æ˜¯å‚è€ƒå®˜æ–¹å®‰è£…æ–‡æ¡£ï¼Œç¨å¾®å¤æ‚å¹¶ä¸”å¤šç‰ˆæœ¬çš„æ”¯æŒä¼šéº»çƒ¦ä¸€äº›ï¼›å¦ä¸€ç§æ–¹æ³•æ˜¯ç»§ç»­ä½¿ç”¨ sdkmanã€‚\næ‰“å¼€ ~/.sdkman/etc/config å¯ä»¥çœ‹åˆ° rosetta2 çš„å…¼å®¹é€‰é¡¹ sdkman_rosetta2_compatibleï¼Œå°†å€¼ä» false æ”¹ä¸º trueï¼š\nsdkman_auto_answer=false sdkman_auto_complete=true sdkman_auto_env=false sdkman_beta_channel=false sdkman_colour_enable=true sdkman_curl_connect_timeout=7 sdkman_curl_max_time=10 sdkman_debug_mode=false sdkman_insecure_ssl=false sdkman_rosetta2_compatible=true sdkman_selfupdate_enable=true å…³é—­å¹¶é‡æ–°æ‰“å¼€å‘½ä»¤è¡Œçª—å£ï¼Œæˆ–è€…æ‰§è¡Œ source ~/.zshrc ï¼ˆè¿™é‡Œæ˜¯ zshï¼Œå…¶ä»– shell ä¹Ÿæ˜¯ç±»ä¼¼çš„æ–¹å¼ï¼‰ã€‚\né‡æ–°æ‰§è¡Œ sdk list javaï¼Œå°±å¯ä»¥çœ‹åˆ°è¿™æ¬¡çš„åˆ—è¡¨å°±å¾ˆå…¨äº†ï¼Œæƒ³è¦çš„ GraalVM å°±åœ¨ç»“æœä¸­ï¼š\nsdk list java ================================================================================ Available Java Versions for macOS 64bit ================================================================================ Vendor | Use | Version | Dist | Status | Identifier -------------------------------------------------------------------------------- Corretto | | 17.0.2.8.1 | amzn | | 17.0.2.8.1-amzn | | 17.0.1.12.1 | amzn | | 17.0.1.12.1-amzn | | 17.0.0.35.2 | amzn | | 17.0.0.35.2-amzn | | 11.0.14.9.1 | amzn | | 11.0.14.9.1-amzn | | 11.0.13.8.1 | amzn | | 11.0.13.8.1-amzn | | 8.322.06.1 | amzn | | 8.322.06.1-amzn | | 8.312.07.1 | amzn | | 8.312.07.1-amzn GraalVM | | 22.0.0.2.r17 | grl | | 22.0.0.2.r17-grl | | 22.0.0.2.r11 | grl | | 22.0.0.2.r11-grl | | 21.3.1.r17 | grl | | 21.3.1.r17-grl | | 21.3.1.r11 | grl | | 21.3.1.r11-grl | | 21.3.0.r17 | grl | | 21.3.0.r17-grl | | 21.3.0.r11 | grl | | 21.3.0.r11-grl | | 21.2.0.r16 | grl | | 21.2.0.r16-grl | | 21.2.0.r11 | grl | | 21.2.0.r11-grl | | 20.3.5.r11 | grl | | 20.3.5.r11-grl | | 20.3.4.r11 | grl | | 20.3.4.r11-grl | | 20.3.3.r11 | grl | | 20.3.3.r11-grl | | 19.3.6.r11 | grl | | 19.3.6.r11-grl Java.net | | 19.ea.5 | open | | 19.ea.5-open | | 19.ea.1.lm | open | | 19.ea.1.lm-open | | 18.ea.31 | open | | 18.ea.31-open | | 17.ea.3.pma | open | | 17.ea.3.pma-open | | 21.2.0.r16 | grl | | 21.2.0.r16-grl | | 21.2.0.r11 | grl | | 21.2.0.r11-grl | | 20.3.5.r11 | grl | | 20.3.5.r11-grl | | 20.3.4.r11 | grl | | 20.3.4.r11-grl | | 20.3.3.r11 | grl | | 20.3.3.r11-grl | | 19.3.6.r11 | grl | | 19.3.6.r11-grl Java.net | | 19.ea.5 | open | | 19.ea.5-open | | 19.ea.1.lm | open | | 19.ea.1.lm-open | | 18.ea.31 | open | | 18.ea.31-open | | 17.ea.3.pma | open | | 17.ea.3.pma-open | | 17.0.2 | open | | 17.0.2-open | | 17.0.1 | open | | 17.0.1-open | | 11.0.2 | open | | 11.0.2-open Liberica | | 17.0.2.fx | librca | | 17.0.2.fx-librca | | 17.0.2 | librca | | 17.0.2-librca | | 17.0.1.fx | librca | | 17.0.1.fx-librca | \u0026gt;\u0026gt;\u0026gt; | 17.0.1 | librca | installed | 17.0.1-librca | | 11.0.14.fx | librca | | 11.0.14.fx-librca | | 11.0.14 | librca | | 11.0.14-librca | | 11.0.13.fx | librca | | 11.0.13.fx-librca | | 11.0.13 | librca | | 11.0.13-librca | | 8.0.322.fx | librca | | 8.0.322.fx-librca | | 8.0.322 | librca | | 8.0.322-librca | | 8.0.312.fx | librca | | 8.0.312.fx-librca | | 8.0.312 | librca | installed | 8.0.312-librca Liberica NIK | | 21.3.0.r17 | nik | | 21.3.0.r17-nik | | 21.3.0.r11 | nik | | 21.3.0.r11-nik | | 21.2 | nik | | 21.2-nik Microsoft | | 17.0.1 | ms | | 17.0.1-ms | | 11.0.13 | ms | | 11.0.13-ms Oracle | | 17.0.2 | oracle | | 17.0.2-oracle | | 17.0.1 | oracle | | 17.0.1-oracle SapMachine | | 17.0.2 | sapmchn | | 17.0.2-sapmchn | | 17.0.1 | sapmchn | | 17.0.1-sapmchn | | 11.0.14 | sapmchn | | 11.0.14-sapmchn | | 11.0.13 | sapmchn | | 11.0.13-sapmchn Semeru | | 17.0.1 | sem | | 17.0.1-sem | | 11.0.13 | sem | | 11.0.13-sem | | 8.0.312 | sem | | 8.0.312-sem Temurin | | 17.0.1 | tem | | 17.0.1-tem | | 11.0.14 | tem | | 11.0.14-tem | | 11.0.13 | tem | | 11.0.13-tem | | 8.0.322 | tem | | 8.0.322-tem | | 8.0.312 | tem | | 8.0.312-tem Trava | | 11.0.9 | trava | | 11.0.9-trava | | 8.0.232 | trava | | 8.0.232-trava Zulu | | 17.0.2 | zulu | | 17.0.2-zulu | | 17.0.2.fx | zulu | | 17.0.2.fx-zulu | | 17.0.1 | zulu | | 17.0.1-zulu | | 17.0.1.fx | zulu | | 17.0.1.fx-zulu | | 11.0.14 | zulu | | 11.0.14-zulu | | 11.0.14.fx | zulu | | 11.0.14.fx-zulu | | 11.0.13 | zulu | | 11.0.13-zulu | | 11.0.13.fx | zulu | | 11.0.13.fx-zulu | | 8.0.322 | zulu | | 8.0.322-zulu | | 8.0.322.fx | zulu | | 8.0.322.fx-zulu | | 8.0.312 | zulu | | 8.0.312-zulu | | 8.0.312.fx | zulu | | 8.0.312.fx-zulu | | 7.0.332 | zulu | | 7.0.332-zulu | | 7.0.322 | zulu | | 7.0.322-zulu ================================================================================ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-andrea-piacquadio-3822859.jpg","permalink":"https://atbug.com/install-graalvm-on-m1-mac-with-sdkman/","tags":["macOS","Java","Graalvm"],"title":"ä½¿ç”¨ sdkman åœ¨ M1 Mac ä¸Š å®‰è£… graalvm jdk"},{"categories":["ç¿»è¯‘","äº‘åŸç”Ÿ"],"contents":"è¯‘è€…æ³¨ï¼š\nè¿™ç¯‡æ–‡ç« å¾ˆå…¨é¢çš„ç½—åˆ—å‡ºäº† Kubernetes ä¸­æ¶‰åŠçš„ç½‘ç»œçŸ¥è¯†ï¼Œä» Linux å†…æ ¸çš„ç½‘ç»œå†…å®¹ï¼Œåˆ°å®¹å™¨ã€Kubernetesï¼Œä¸€ä¸€è¿›è¡Œäº†è¯¦ç»†çš„è¯´æ˜ã€‚\nâ€‹æ–‡ç« ç¯‡å¹…æœ‰ç‚¹é•¿ï¼Œä¸å¾—ä¸è¯´ï¼Œç½‘ç»œæ˜¯å¾ˆå¤æ‚å¾ˆéº»çƒ¦çš„ä¸€å±‚ï¼Œä½†æ°æ°è¿™å±‚å¤šå¹´æ¥å˜åŒ–ä¸å¤§ã€‚å¸Œæœ›ç¿»è¯‘çš„å†…å®¹å¯¹å¤§å®¶èƒ½æœ‰æ‰€å¸®åŠ©ï¼Œæœ‰è¯¯çš„åœ°æ–¹ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶æŒ‡æ­£ã€‚\næœ¬æ–‡ç¿»è¯‘è·å¾— Learnk8s çš„æˆæƒï¼ŒåŸæ–‡ Tracing the path of network traffic in Kubernetes ä½œè€… Kristijan Mitevskiã€‚\nTL;DRï¼š æœ¬æ–‡å°†ä»£ç†äº†è§£ Kubernetes é›†ç¾¤å†…å¤–çš„æ•°æ®æµè½¬ã€‚ä»æœ€åˆçš„ Web è¯·æ±‚å¼€å§‹ï¼Œä¸€ç›´åˆ°æ‰˜ç®¡åº”ç”¨ç¨‹åºçš„å®¹å™¨ã€‚\nç›®å½• ç›®å½• Kubernetes ç½‘ç»œè¦æ±‚ Linux ç½‘ç»œå‘½åç©ºé—´å¦‚ä½•åœ¨ pod ä¸­å·¥ä½œ Pause å®¹å™¨åˆ›å»º Pod ä¸­çš„ç½‘ç»œå‘½åç©ºé—´ ä¸º Pod åˆ†é…äº† IP åœ°å€ æ£€æŸ¥é›†ç¾¤ä¸­ pod åˆ° pod çš„æµé‡ Pod å‘½åç©ºé—´è¿æ¥åˆ°ä»¥å¤ªç½‘æ¡¥æ¥å™¨ è·Ÿè¸ªåŒä¸€èŠ‚ç‚¹ä¸Š pod é—´çš„æµé‡ è·Ÿè¸ªä¸åŒèŠ‚ç‚¹ä¸Š pod é—´çš„é€šä¿¡ ä½è¿ç®—çš„å·¥ä½œåŸç† å®¹å™¨ç½‘ç»œæ¥å£ - CNI æ£€æŸ¥ pod åˆ°æœåŠ¡çš„æµé‡ ä½¿ç”¨ Netfilter å’Œ Iptables æ‹¦æˆªå’Œé‡å†™æµé‡ æ£€æŸ¥æœåŠ¡çš„å“åº” å›é¡¾ Kubernetes ç½‘ç»œè¦æ±‚ åœ¨æ·±å…¥äº†è§£ Kubernetes ä¸­çš„æ•°æ®æµè½¬ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¾„æ¸…ä¸‹ Kubernetes ç½‘ç»œçš„è¦æ±‚ã€‚\nKubernetes ç½‘ç»œæ¨¡å‹å®šä¹‰äº†ä¸€å¥—åŸºæœ¬è§„åˆ™ï¼š\né›†ç¾¤ä¸­çš„ pod åº”è¯¥èƒ½å¤Ÿä¸ä»»ä½•å…¶ä»– pod è‡ªç”±é€šä¿¡ï¼Œè€Œæ— éœ€ä½¿ç”¨ç½‘ç»œåœ°å€è½¬æ¢ï¼ˆNATï¼‰ã€‚ åœ¨ä¸ä½¿ç”¨ NAT çš„æƒ…å†µä¸‹ï¼Œé›†ç¾¤èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ä»»æ„ç¨‹åºéƒ½åº”è¯¥èƒ½å¤Ÿä¸åŒä¸€èŠ‚ç‚¹ä¸Šçš„ä»»æ„ pod é€šä¿¡ã€‚ æ¯ä¸ª pod éƒ½æœ‰è‡ªå·±çš„ IP åœ°å€ï¼ˆIP-per Podï¼‰ï¼Œå…¶ä»– pod éƒ½å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªåœ°å€è¿›è¡Œè®¿é—®ã€‚ è¿™äº›è¦æ±‚ä¸ä¼šå°†å®ç°é™åˆ¶åœ¨å•ä¸€æ–¹æ¡ˆä¸Šã€‚\nç›¸åï¼Œä»–ä»¬æ¦‚æ‹¬äº†é›†ç¾¤ç½‘ç»œçš„ç‰¹æ€§ã€‚\nåœ¨æ»¡è¶³è¿™äº›é™åˆ¶æ—¶ï¼Œå¿…é¡»è§£å†³å¦‚ä¸‹æŒ‘æˆ˜ï¼š\nå¦‚ä½•ä¿è¯åŒä¸€ pod ä¸­çš„å®¹å™¨é—´çš„è®¿é—®å°±åƒåœ¨åŒä¸€ä¸»æœºä¸Šä¸€æ ·ï¼Ÿ Pod èƒ½å¦è®¿é—®é›†ç¾¤ä¸­çš„å…¶ä»– podï¼Ÿ Pod èƒ½å¦è®¿é—®æœåŠ¡ï¼ˆserviceï¼‰ï¼Ÿä»¥åŠæœåŠ¡å¯ä»¥è´Ÿè½½å‡è¡¡è¯·æ±‚å—ï¼Ÿ Pod å¯ä»¥æ¥æ”¶æ¥è‡ªé›†ç¾¤å¤–çš„æµé‡å—ï¼Ÿ æœ¬æ–‡å°†ä¸“æ³¨äºå‰ä¸‰ç‚¹ï¼Œä» pod å†…éƒ¨ç½‘ç»œæˆ–è€…å®¹å™¨é—´çš„é€šä¿¡è¯´èµ·ã€‚\nLinux ç½‘ç»œå‘½åç©ºé—´å¦‚ä½•åœ¨ pod ä¸­å·¥ä½œ æˆ‘ä»¬æƒ³è±¡ä¸‹ï¼Œæœ‰ä¸€ä¸ªæ‰¿è½½åº”ç”¨ç¨‹åºçš„ä¸»å®¹å™¨å’Œå¦ä¸€ä¸ªä¸å®ƒä¸€èµ·è¿è¡Œçš„å®¹å™¨ã€‚\nåœ¨ç¤ºä¾‹ Pod ä¸­æœ‰ä¸€ä¸ª Nginx å®¹å™¨å’Œ busybox å®¹å™¨ï¼š\napiVersion: v1 kind: Pod metadata: name: multi-container-pod spec: containers: - name: container-1 image: busybox command: [\u0026#39;/bin/sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;sleep 1d\u0026#39;] - name: container-2 image: nginx åœ¨éƒ¨ç½²æ—¶ï¼Œä¼šå‡ºç°å¦‚ä¸‹æƒ…å†µï¼š\nPod åœ¨èŠ‚ç‚¹ä¸Šå¾—åˆ°è‡ªå·±çš„ç½‘ç»œå‘½åç©ºé—´ã€‚ Pod åˆ†é…åˆ°ä¸€ä¸ª IP åœ°å€ï¼Œä¸¤ä¸ªå®¹å™¨é—´å…±äº«ç«¯å£ã€‚ ä¸¤ä¸ªå®¹å™¨å…±äº«åŒä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼Œåœ¨æœ¬åœ°äº’ç›¸å¯è§ã€‚ ç½‘ç»œé…ç½®åœ¨åå°å¾ˆå¿«å®Œæˆã€‚\nç„¶åï¼Œæˆ‘ä»¬é€€åä¸€æ­¥ï¼Œæ˜¯è¿™ç†è§£ä¸ºä»€ä¹ˆä¸Šé¢æ˜¯å®¹å™¨è¿è¡Œæ‰€å¿…é¡»çš„ã€‚\nåœ¨ Linux ä¸­ï¼Œç½‘ç»œå‘½åç©ºé—´æ˜¯ç‹¬ç«‹çš„ã€éš”ç¦»çš„é€»è¾‘ç©ºé—´ã€‚\nå¯ä»¥å°†ç½‘ç»œå‘½åç©ºé—´çœ‹æˆå°†ç‰©ç†ç½‘ç»œæ¥å£åˆ†å‰²æˆæ›´å°çš„ç‹¬ç«‹éƒ¨åˆ†ã€‚\næ¯éƒ¨åˆ†éƒ½å¯ä»¥å•ç‹¬é…ç½®ï¼Œå¹¶ä½¿ç”¨è‡ªå·±çš„ç½‘ç»œè§„åˆ™å’Œèµ„æºã€‚\nè¿™äº›å¯ä»¥åŒ…æ‹¬é˜²ç«å¢™è§„åˆ™ã€æ¥å£ï¼ˆè™šæ‹Ÿæˆ–ç‰©ç†ï¼‰ã€è·¯ç”±å’Œå…¶ä»–æ‰€æœ‰ä¸ç½‘ç»œç›¸å…³çš„å†…å®¹ã€‚\nç‰©ç†æ¥å£æŒæœ‰æ ¹å‘½åç©ºé—´ã€‚\nå¯ä»¥ä½¿ç”¨ Linux ç½‘ç»œå‘½åç©ºé—´åˆ›å»ºéš”ç¦»çš„ç½‘ç»œã€‚æ¯ä¸ªç½‘ç»œéƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œé™¤éè¿›è¡Œé…ç½®å¦åˆ™ä¸ä¼šä¸å…¶ä»–å‘½åç©ºé—´é€šä¿¡ã€‚\nç‰©ç†æ¥å£å¿…é¡»å¤„ç†æœ€åçš„æ‰€æœ‰çœŸå®æ•°æ®åŒ…ï¼Œå› æ­¤æ‰€æœ‰çš„è™šæ‹Ÿæ¥å£éƒ½æ˜¯ä»ä¸­åˆ›å»ºçš„ã€‚\nç½‘ç»œå‘½åç©ºé—´å¯ä»¥é€šè¿‡ ip-netns ç®¡ç†å·¥å…· æ¥ç®¡ç†ï¼Œå¯ä»¥ä½¿ç”¨ ip netns list åˆ—å‡ºä¸»æœºä¸Šçš„å‘½åç©ºé—´ã€‚\nè¯·æ³¨æ„ï¼Œåˆ›å»ºçš„ç½‘ç»œå‘½åç©ºé—´å°†ä¼šå‡ºç°åœ¨ /var/run/netns ç›®å½•ä¸‹ï¼Œä½† Docker å¹¶æ²¡æœ‰éµå¾ªè¿™ä¸€ç‚¹ã€‚\nä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ Kubernetes èŠ‚ç‚¹çš„å‘½åç©ºé—´ï¼š\n$ ip netns list cni-0f226515-e28b-df13-9f16-dd79456825ac (id: 3) cni-4e4dfaac-89a6-2034-6098-dd8b2ee51dcd (id: 4) cni-7e94f0cc-9ee8-6a46-178a-55c73ce58f2e (id: 2) cni-7619c818-5b66-5d45-91c1-1c516f559291 (id: 1) cni-3004ec2c-9ac2-2928-b556-82c7fb37a4d8 (id: 0) æ³¨æ„ cni- å‰ç¼€æ„å‘³ç€å‘½åç©ºé—´çš„åˆ›å»ºç”± CNI æ¥å®Œæˆã€‚\nå½“åˆ›å»º pod å¹¶åˆ†é…ç»™èŠ‚ç‚¹æ—¶ï¼ŒCNI ä¼šï¼š\nä¸ºå…¶åˆ›å»ºç½‘ç»œå‘½åç©ºé—´ã€‚ åˆ†é… IP åœ°å€ã€‚ å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œã€‚ å¦‚æœ pod åƒä¸Šé¢çš„ç¤ºä¾‹ä¸€æ ·åŒ…å«å¤šä¸ªå®¹å™¨ï¼Œåˆ™æ‰€æœ‰å®¹å™¨éƒ½è¢«ç½®äºåŒä¸€ä¸ªå‘½åç©ºé—´ä¸­ã€‚\nåˆ›å»º pod æ—¶ï¼ŒCNI ä¸ºå®¹å™¨åˆ›å»ºç½‘ç»œå‘½åç©ºé—´\nç„¶ååˆ†é… IP åœ°å€\næœ€åå°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œçš„å…¶ä½™éƒ¨åˆ†\né‚£ä¹ˆå½“åˆ—å‡ºèŠ‚ç‚¹ä¸Šçš„å®¹å™¨æ—¶ä¼šçœ‹åˆ°ä»€ä¹ˆï¼Ÿ\nå¯ä»¥ SSH åˆ° Kubernetes èŠ‚ç‚¹æ¥æŸ¥çœ‹å‘½åç©ºé—´ï¼š\n$ lsns -t net NS TYPE NPROCS PID USER NETNSID NSFS COMMAND 4026531992 net 171 1 root unassigned /run/docker/netns/default /sbin/init noembed norestore 4026532286 net 2 4808 65535 0 /run/docker/netns/56c020051c3b /pause 4026532414 net 5 5489 65535 1 /run/docker/netns/7db647b9b187 /pause lsns å‘½ä»¤ä¼šåˆ—å‡ºä¸»æœºä¸Šæ‰€æœ‰çš„å‘½åç©ºé—´ã€‚\nè®°ä½ Linux ä¸­æœ‰å¤šç§å‘½åç©ºé—´ç±»å‹ã€‚\nNginx å®¹å™¨åœ¨å“ªï¼Ÿ\né‚£ä¹ˆ pause å®¹å™¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ\nPause å®¹å™¨åˆ›å»º Pod ä¸­çš„ç½‘ç»œå‘½åç©ºé—´ ä»èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰è¿›ç¨‹ä¸­æ‰¾å‡º Nginx å®¹å™¨ï¼š\n$ lsns NS TYPE NPROCS PID USER COMMAND # truncated output 4026532414 net 5 5489 65535 /pause 4026532513 mnt 1 5599 root sleep 1d 4026532514 uts 1 5599 root sleep 1d 4026532515 pid 1 5599 root sleep 1d 4026532516 mnt 3 5777 root nginx: master process nginx -g daemon off; 4026532517 uts 3 5777 root nginx: master process nginx -g daemon off; 4026532518 pid 3 5777 root nginx: master process nginx -g daemon off; è¯¥å®¹å™¨å‡ºç°åœ¨äº†æŒ‚åœ¨ï¼ˆmount mntï¼‰ã€Unix åˆ†æ—¶ç³»ç»Ÿï¼ˆUnix time-sharing utsï¼‰å’Œ PIDï¼ˆpidï¼‰å‘½åç©ºé—´ä¸­ï¼Œä½†æ˜¯å¹¶ä¸åœ¨ç½‘ç»œå‘½åç©ºé—´ï¼ˆnetï¼‰ä¸­ã€‚\nä¸å¹¸çš„æ˜¯ï¼Œlsns åªæ˜¾ç¤ºäº†æ¯ä¸ªè¿›ç¨‹æœ€ä½çš„ PIDï¼Œä¸è¿‡å¯ä»¥æ ¹æ®è¿›ç¨‹ ID è¿›ä¸€æ­¥è¿‡æ»¤ã€‚\nå¯ä»¥é€šè¿‡ä»¥ä¸‹å†…å®¹æ£€ç´¢Nginx å®¹å™¨çš„æ‰€æœ‰å‘½åç©ºé—´ï¼š\n$ sudo lsns -p 5777 NS TYPE NPROCS PID USER COMMAND 4026531835 cgroup 178 1 root /sbin/init noembed norestore 4026531837 user 178 1 root /sbin/init noembed norestore 4026532411 ipc 5 5489 65535 /pause 4026532414 net 5 5489 65535 /pause 4026532516 mnt 3 5777 root nginx: master process nginx -g daemon off; 4026532517 uts 3 5777 root nginx: master process nginx -g daemon off; 4026532518 pid 3 5777 root nginx: master process nginx -g daemon off; pause è¿›ç¨‹å†æ¬¡å‡ºç°ï¼Œè¿™æ¬¡å®ƒåŠ«æŒäº†ç½‘ç»œå‘½åç©ºé—´ã€‚\né‚£æ˜¯ä»€ä¹ˆï¼Ÿ\né›†ç¾¤ä¸­çš„æ¯ä¸ª pod éƒ½æœ‰ä¸€ä¸ªåœ¨åå°è¿è¡Œçš„éšè—å®¹å™¨ï¼Œè¢«ç§°ä¸º pauseã€‚\nåˆ—å‡ºèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å®¹å™¨å¹¶è¿‡æ»¤å‡º pause å®¹å™¨ï¼š\n$ docker ps | grep pause fa9666c1d9c6 k8s.gcr.io/pause:3.4.1 \u0026#34;/pause\u0026#34; k8s_POD_kube-dns-599484b884-sv2jsâ€¦ 44218e010aeb k8s.gcr.io/pause:3.4.1 \u0026#34;/pause\u0026#34; k8s_POD_blackbox-exporter-55c457dâ€¦ 5fb4b5942c66 k8s.gcr.io/pause:3.4.1 \u0026#34;/pause\u0026#34; k8s_POD_kube-dns-599484b884-cq99xâ€¦ 8007db79dcf2 k8s.gcr.io/pause:3.4.1 \u0026#34;/pause\u0026#34; k8s_POD_konnectivity-agent-84f87câ€¦ å°†çœ‹åˆ°å¯¹äºèŠ‚ç‚¹åˆ†é…åˆ°çš„æ¯ä¸ª podï¼Œéƒ½æœ‰ä¸€ä¸ªåŒ¹é…çš„ pause å®¹å™¨ã€‚\nè¯¥ pause å®¹å™¨è´Ÿè´£åˆ›å»ºå’Œç»´æŒç½‘ç»œå‘½åç©ºé—´ã€‚\nå®ƒåŒ…å«çš„ä»£ç æå°‘ï¼Œéƒ¨ç½²åç«‹å³è¿›å…¥ç¡çœ çŠ¶æ€ã€‚\nç„¶è€Œï¼Œå®ƒåœ¨ Kubernetes ç”Ÿæ€ä¸­çš„é¦–å½“å…¶å†²ï¼Œå‘æŒ¥ç€è‡³å…³é‡è¦çš„ä½œç”¨ã€‚ã€‚\nåˆ›å»º pod æ—¶ï¼ŒCNI ä¼šåˆ›å»ºä¸€ä¸ªå¸¦æœ‰ç¡çœ å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´\nPod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½ä¼šåŠ å…¥åˆ°å®ƒåˆ›å»ºçš„ç½‘ç»œå‘½åç©ºé—´ä¸­\næ­¤æ—¶ CNI åˆ†é… IP åœ°å€å¹¶å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œ\nè¿›å…¥ç¡çœ çŠ¶æ€çš„å®¹å™¨æœ‰ä»€ä¹ˆç”¨ï¼Ÿ\nè¦äº†è§£å®ƒçš„å®ç”¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡ä¸‹å¦‚ç¤ºä¾‹ä¸€æ ·æœ‰ä¸¤ä¸ªå®¹å™¨çš„ podï¼Œä½†æ²¡æœ‰ pause å®¹å™¨ã€‚\nå®¹å™¨å¯åŠ¨ï¼ŒCNIï¼š\nä¸º Nginx å®¹å™¨åˆ›å»ºä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ã€‚ æŠŠ busybox å®¹å™¨åŠ å…¥åˆ°å‰é¢åˆ›å»ºçš„ç½‘ç»œå‘½åç©ºé—´ä¸­ã€‚ ä¸º pod åˆ†é… IP åœ°å€ã€‚ å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œã€‚ å‡å¦‚ Nginx å®¹å™¨å´©æºƒäº†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ\nCNI å°†ä¸å¾—ä¸å†æ¬¡å®Œæˆæ‰€æœ‰æµç¨‹ï¼Œä¸¤ä¸ªå®¹å™¨çš„ç½‘ç»œéƒ½ä¼šä¸­æ–­ã€‚\nç”±äº sleep å®¹å™¨ä¸å¤ªå¯èƒ½æœ‰ä»»ä½• bugï¼Œå› æ­¤åˆ›å»ºç½‘ç»œå‘½åç©ºé—´é€šå¸¸æ˜¯ä¸€ä¸ªæ›´ä¿é™©ã€æ›´å¥å£®çš„é€‰æ‹©ã€‚\nå¦‚æœ pod ä¸­çš„ä¸€ä¸ªå®¹å™¨å´©æºƒï¼Œå…¶ä½™çš„ä»å¯ä»¥å¤„ç†ç½‘ç»œè¯·æ±‚ã€‚\nä¸º Pod åˆ†é…äº† IP åœ°å€ å‰é¢æåˆ° pod å’Œæ‰€æœ‰å®¹å™¨è·å¾—äº†åŒæ ·çš„ IPã€‚\nè¿™æ˜¯æ€ä¹ˆé…ç½®çš„ï¼Ÿ\nåœ¨ pod ç½‘ç»œå‘½åç©ºé—´ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ¥å£å¹¶åˆ†é… IP åœ°å€ã€‚\næˆ‘ä»¬æ¥éªŒè¯ä¸‹ã€‚\né¦–å…ˆï¼Œæ‰¾åˆ° pod çš„ IP åœ°å€ï¼š\n$ kubectl get pod multi-container-pod -o jsonpath={.status.podIP} 10.244.4.40 æ¥ä¸‹æ¥ï¼Œæ‰¾åˆ°ç›¸å…³çš„ç½‘ç»œå‘½åç©ºé—´ã€‚\nç”±äºç½‘ç»œå‘½åç©ºé—´æ˜¯ä»ç‰©ç†æ¥å£åˆ›å»ºçš„ï¼Œéœ€è¦è®¿é—®é›†ç¾¤èŠ‚ç‚¹ã€‚\nå¦‚æœä½ è¿è¡Œçš„æ˜¯ minikubeï¼Œå¯ä»¥é€šè¿‡ minikube ssh è®¿é—®èŠ‚ç‚¹ã€‚å¦‚æœåœ¨äº‘æä¾›å•†ä¸­è¿è¡Œï¼Œåº”è¯¥æœ‰æŸç§æ–¹æ³•é€šè¿‡ SSH è®¿é—®èŠ‚ç‚¹ã€‚\nè¿›å…¥åï¼Œå¯ä»¥æ‰¾åˆ°åˆ›å»ºçš„æœ€æ–°çš„ç½‘ç»œå‘½åç©ºé—´ï¼š\n$ ls -lt /var/run/netns total 0 -r--r--r-- 1 root root 0 Sep 25 13:34 cni-0f226515-e28b-df13-9f16-dd79456825ac -r--r--r-- 1 root root 0 Sep 24 09:39 cni-4e4dfaac-89a6-2034-6098-dd8b2ee51dcd -r--r--r-- 1 root root 0 Sep 24 09:39 cni-7e94f0cc-9ee8-6a46-178a-55c73ce58f2e -r--r--r-- 1 root root 0 Sep 24 09:39 cni-7619c818-5b66-5d45-91c1-1c516f559291 -r--r--r-- 1 root root 0 Sep 24 09:39 cni-3004ec2c-9ac2-2928-b556-82c7fb37a4d8 æœ¬ç¤ºä¾‹ä¸­ï¼Œå®ƒæ˜¯ cni-0f226515-e28b-df13-9f16-dd79456825acã€‚æ­¤æ—¶ï¼Œå¯ä»¥åœ¨è¯¥å‘½åç©ºé—´æ€»æ‰§è¡Œ exec å‘½ä»¤ï¼š\n$ ip netns exec cni-0f226515-e28b-df13-9f16-dd79456825ac ip a # output truncated 3: eth0@if12: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1450 qdisc noqueue state UP group default link/ether 16:a4:f8:4f:56:77 brd ff:ff:ff:ff:ff:ff link-netnsid 0 inet 10.244.4.40/32 brd 10.244.4.40 scope global eth0 valid_lft forever preferred_lft forever inet6 fe80::14a4:f8ff:fe4f:5677/64 scope link valid_lft forever preferred_lft forever 10.244.4.40 å°±æ˜¯ pod çš„ IP åœ°å€ã€‚\né€šè¿‡æŸ¥æ‰¾ @if12 ä¸­çš„ 12 æ‰¾åˆ°ç½‘ç»œæ¥å£ã€‚\n$ ip link | grep -A1 ^12 12: vethweplb3f36a0@if16: mtu 1376 qdisc noqueue master weave state UP mode DEFAULT group default link/ether 72:1c:73:d9:d9:f6 brd ff:ff:ff:ff:ff:ff link-netnsid 1 è¿˜å¯ä»¥éªŒè¯ Nginx å®¹å™¨æ˜¯å¦ä»è¯¥å‘½åç©ºé—´ä¸­ç›‘å¬ HTTP æµé‡ï¼š\n$ ip netns exec cni-0f226515-e28b-df13-9f16-dd79456825ac netstat -lnp Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 692698/nginx: master tcp6 0 0 :::80 :::* LISTEN 692698/nginx: master å¦‚æœæ— æ³•é€šè¿‡ SSH è®¿é—®é›†ç¾¤çš„èŠ‚ç‚¹ï¼Œå¯ä»¥è¯•è¯• kubectl exec è¿›å…¥åˆ° busybox å®¹å™¨ï¼Œç„¶åä½¿ç”¨ ip å’Œ netstat å‘½ä»¤ã€‚\nå¤ªæ£’äº†ï¼\nç°åœ¨æˆ‘ä»¬å·²ç»ä»‹ç»äº†å®¹å™¨é—´çš„é€šä¿¡ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹ Pod ä¸ Pod ç›´æ¥å¦‚ä½•å»ºç«‹é€šä¿¡ã€‚\næ£€æŸ¥é›†ç¾¤ä¸­ pod åˆ° pod çš„æµé‡ å½“è¯´èµ· pod é—´é€šä¿¡æ—¶ï¼Œä¼šæœ‰ä¸¤ç§å¯èƒ½ï¼š\nPod æµé‡æµå‘åŒä¸€èŠ‚ç‚¹ä¸Šçš„ podã€‚ Pod æµé‡æµé‡å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„ podã€‚ ä¸ºäº†ä½¿æ•´ä¸ªè®¾ç½®æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦ä¹‹å‰è®¨è®ºè¿‡çš„è™šæ‹Ÿæ¥å£å’Œä»¥å¤ªç½‘æ¡¥æ¥ã€‚\nåœ¨ç»§ç»­ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè®¨è®ºä¸‹ä»–ä»¬çš„åŠŸèƒ½ä»¥åŠä¸ºä»€ä¹ˆä»–ä»¬æ—¶å¿…éœ€çš„ã€‚\nè¦å®Œæˆ pod ä¸å…¶ä»– pod çš„é€šä¿¡ï¼Œå®ƒå¿…é¡»å…ˆè®¿é—®èŠ‚ç‚¹çš„æ ¹å‘½åç©ºé—´ã€‚\nè¿™æ˜¯ä½¿ç”¨è¿æ¥ pod å’Œæ ¹å‘½åç©ºé—´çš„è™šæ‹Ÿä»¥å¤ªç½‘å¯¹æ¥å®ç°çš„ã€‚\nè¿™äº›è™šæ‹Ÿæ¥å£è®¾å¤‡ï¼ˆveth ä¸­çš„ vï¼‰è¿æ¥å¹¶å……å½“ä¸¤ä¸ªå‘½åç©ºé—´é—´çš„éš§é“ã€‚\nä½¿ç”¨æ­¤ veth è®¾å¤‡ï¼Œå°†ä¸€ç«¯è¿æ¥åˆ° pod çš„å‘½åç©ºé—´ï¼Œå¦ä¸€ç«¯è¿æ¥åˆ°æ ¹å‘½åç©ºé—´ã€‚\nè¿™äº› CNI å¯ä»¥æ›¿ä½ åšï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æ“ä½œï¼š\n$ ip link add veth1 netns pod-namespace type veth peer veth2 netns root ç°åœ¨ pod çš„å‘½åç©ºé—´æœ‰äº†å¯ä»¥è®¿é—®æ ¹å‘½åç©ºé—´çš„éš§é“ã€‚\nèŠ‚ç‚¹ä¸Šæ¯ä¸ªæ–°å»ºçš„ pod éƒ½ä¼šè®¾ç½®å¦‚ä¸‹æ‰€ç¤ºçš„ veth å¯¹ã€‚\nåˆ›å»ºæ¥å£å¯¹æ—¶å…¶ä¸­ä¸€éƒ¨åˆ†ã€‚\nå…¶ä»–çš„å°±æ˜¯ä¸ºä»¥å¤ªç½‘è®¾å¤‡åˆ†é…åœ°å€ï¼Œå¹¶åˆ›å»ºé»˜è®¤è·¯ç”±ã€‚\næ¥çœ‹ä¸‹å¦‚ä½•åœ¨ pod çš„å‘½åç©ºé—´ä¸­è®¾ç½® veth1 æ¥å£ï¼š\n$ ip netns exec cni-0f226515-e28b-df13-9f16-dd79456825ac ip addr add 10.244.4.40/24 dev veth1 $ ip netns exec cni-0f226515-e28b-df13-9f16-dd79456825ac ip link set veth1 up $ ip netns exec cni-0f226515-e28b-df13-9f16-dd79456825ac ip route add default via 10.244.4.40 åœ¨èŠ‚ç‚¹ä¾§ï¼Œæˆ‘ä»¬åˆ›å»ºå¦ä¸€ä¸ª veth2 å¯¹ï¼š\n$ ip addr add 169.254.132.141/16 dev veth2 $ ip link set veth2 up å¯ä»¥åƒä»¥å‰ä¸€æ ·æ£€æŸ¥ç°æœ‰çš„ veth å¯¹ã€‚\nåœ¨ pod çš„å‘½åç©ºé—´ä¸­ï¼Œæ£€æŸ¥ eth0 æ¥å£çš„åç¼€ã€‚\n$ ip netns exec cni-0f226515-e28b-df13-9f16-dd79456825ac ip link show type veth 3: eth0@if12: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default link/ether 16:a4:f8:4f:56:77 brd ff:ff:ff:ff:ff:ff link-netnsid 0 è¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ grep -A1 ^12 è¿›è¡ŒæŸ¥æ‰¾ï¼ˆæˆ–è€…æ»šåŠ¨åˆ°ç›®æ ‡æ‰€åœ¨ï¼‰ï¼š\n$ ip link show type veth # output truncated 12: cali97e50e215bd@if3: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-0f226515-e28b-df13-9f16-dd79456825ac ä¹Ÿå¯ä»¥ä½¿ç”¨ ip -n cni-0f226515-e28b-df13-9f16-dd79456825ac link show type veth å‘½ä»¤ã€‚\næ³¨æ„ 3: eth0@if12 å’Œ 12: cali97e50e215bd@if3 æ¥å£ä¸Šçš„ç¬¦å·ã€‚\nåœ¨ pod å‘½åç©ºé—´ä¸­ï¼Œeth0 æ¥å£è¿æ¥åˆ°æ ¹å‘½åç©ºé—´ä¸­ç¼–å·ä¸º 12 çš„æ¥å£ã€‚å› æ­¤æ˜¯ @if12ã€‚\nåœ¨ veth å¯¹çš„å¦ä¸€ç«¯ï¼Œæ ¹å‘½åç©ºé—´è¿æ¥åˆ° pod å‘½åç©ºé—´çš„ 3 å·æ¥å£ã€‚\næ¥ä¸‹æ¥æ˜¯è¿æ¥ veth å¯¹ä¸¤ç«¯çš„æ¡¥æ¥å™¨ï¼ˆbridgeï¼‰ã€‚\nPod å‘½åç©ºé—´è¿æ¥åˆ°ä»¥å¤ªç½‘æ¡¥æ¥å™¨ æ¡¥æ¥å™¨å°†ä½äºæ ¹å‘½åç©ºé—´ä¸­çš„è™šæ‹Ÿæ¥å£çš„æ¯ä¸€ç«¯â€œç»‘å®šâ€ã€‚\nè¯¥æ¡¥æ¥å™¨å°†å…è®¸æµé‡åœ¨è™šæ‹Ÿå¯¹ä¹‹é—´æµåŠ¨ï¼Œå¹¶é€šè¿‡å…¬å…±æ ¹å‘½åç©ºé—´ã€‚\nç†è®ºæ—¶é—´ã€‚\nä»¥å¤ªç½‘æ¡¥æ¥å™¨ä½äºOSI ç½‘ç»œæ¨¡å‹çš„ç¬¬äºŒå±‚ã€‚\nå¯ä»¥å°†æ¡¥æ¥å™¨çœ‹ä½œä¸€ä¸ªè™šæ‹Ÿäº¤æ¢æœºï¼Œæ¥å—æ¥è‡ªä¸åŒå‘½åç©ºé—´å’Œæ¥å£çš„è¿æ¥ã€‚\nä»¥å¤ªç½‘æ¡¥æ¥å™¨å…è®¸è¿æ¥åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„å¤šä¸ªå¯ç”¨ç½‘ç»œã€‚\nå› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨è¯¥è®¾ç½®è¿æ¥ä¸¤ä¸ªæ¥å£ï¼šä» pod å‘½åç©ºé—´çš„ veth è¿æ¥åˆ°åŒä¸€èŠ‚ç‚¹ä¸Šå¦ä¸€ä¸ª pod çš„ vethã€‚\næˆ‘ä»¬ç»§ç»­çœ‹ä¸‹ä»¥å¤ªç½‘æ¡¥æ¥å™¨å’Œ veth å¯¹çš„ä½œç”¨ã€‚\nè·Ÿè¸ªåŒä¸€èŠ‚ç‚¹ä¸Š pod é—´çš„æµé‡ å‡è®¾åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šæœ‰ä¸¤ä¸ª podï¼ŒPod-A æƒ³å‘ Pod-B å‘é€æ¶ˆæ¯ã€‚\nç”±äºç›®æ ‡ä¸æ˜¯åŒå‘½åç©ºé—´çš„å®¹å™¨ï¼ŒPod-A å‘å…¶é»˜è®¤æ¥å£ eth0 å‘é€æ•°æ®åŒ…ã€‚è¿™ä¸ªæ¥å£ä¸ veth å¯¹çš„ä¸€ç«¯ç»‘å®šï¼Œä½œä¸ºéš§é“ã€‚å› æ­¤æ•°æ®åŒ…å°†è¢«è½¬å‘åˆ°èŠ‚ç‚¹çš„æ ¹å‘½åç©ºé—´ã€‚\nä»¥å¤ªç½‘æ¡¥æ¥å™¨ä½œä¸ºè™šæ‹Ÿäº¤æ¢æœºï¼Œå¿…é¡»ä»¥æŸç§æ–¹å¼å°†ç›®æ ‡ pod IPï¼ˆPod-Bï¼‰è§£æä¸ºå…¶ MAC åœ°å€ã€‚\nè½®åˆ°ARP åè®®ä¸Šåœºäº†ã€‚å½“å¸§åˆ°è¾¾æ¡¥æ¥å™¨æ—¶ï¼Œä¼šå‘æ‰€æœ‰è¿æ¥çš„è®¾å¤‡å‘é€ ARP å¹¿æ’­ã€‚æ¡¥æ¥å™¨å–Šé“è°æœ‰ Pod-B çš„ IP åœ°å€ã€‚\næ”¶åˆ°å¸¦æœ‰è¿æ¥ Pod-B æ¥å£çš„ MAC åœ°å€çš„å›å¤ï¼Œç„¶åæ­¤ä¿¡æ¯å­˜å‚¨åœ¨æ¡¥æ¥å™¨ ARP ç¼“å­˜ï¼ˆæŸ¥æ‰¾è¡¨ï¼‰ä¸­ã€‚\nIP å’Œ MAC åœ°å€çš„æ˜ å°„å­˜å‚¨å®Œæˆåï¼Œæ¡¥æ¥å™¨åœ¨è¡¨ä¸­æŸ¥æ‰¾ï¼Œå¹¶å°†æ•°æ®åŒ…è½¬å‘åˆ°æ­£ç¡®çš„çŸ­ç‚¹ã€‚æ•°æ®åŒ…åˆ°è¾¾æ ¹å‘½åç©ºé—´ä¸­ Pod- B çš„ vethï¼Œç„¶åä»é‚£å¿«é€Ÿåˆ°è¾¾ Pod-B å‘½åç©ºé—´å†…çš„ eth0 æ¥å£ã€‚\næœ‰äº†è¿™ä¸ªï¼ŒPod-A å’Œ Pod-B ä¹‹é—´çš„é€šä¿¡å–å¾—äº†æˆåŠŸã€‚\nè·Ÿè¸ªä¸åŒèŠ‚ç‚¹ä¸Š pod é—´çš„é€šä¿¡ å¯¹äºéœ€è¦è·¨ä¸åŒèŠ‚ç‚¹é€šä¿¡çš„ podï¼Œéœ€è¦é¢å¤–çš„é€šä¿¡è·³è½¬ã€‚\nå‰å‡ ä¸ªæ­¥éª¤ä¿æŒä¸å˜ï¼Œç›´åˆ°æ•°æ®åŒ…åˆ°è¾¾æ ¹å‘½åç©ºé—´å¹¶éœ€è¦å‘é€åˆ° Pod- Bã€‚\nå½“ç›®æ ‡åœ°å€ä¸åœ¨æœ¬åœ°ç½‘ç»œä¸­ï¼Œæ•°æ®åŒ…å°†è¢«è½¬å‘åˆ°æœ¬èŠ‚ç‚¹çš„é»˜è®¤ç½‘å…³ã€‚èŠ‚ç‚¹ä¸Šé€€å‡ºæˆ–é»˜è®¤ç½‘å…³é€šå¸¸ä½äº eth0 æ¥å£ä¸Š \u0026ndash; å°†èŠ‚ç‚¹è¿æ¥åˆ°ç½‘ç»œçš„ç‰©ç†æ¥å£ã€‚\nè¿™æ¬¡å¹¶ä¸ä¼šå‘ç”Ÿ ARP è§£æï¼Œå› ä¸ºæºå’Œç›®æ ‡ IP åœ¨ä¸åŒç½‘ç»œä¸Šã€‚\næ£€æŸ¥ä½¿ç”¨ä½è¿ç®—ï¼ˆBitwiseï¼‰æ“ä½œå®Œæˆã€‚\nå½“ç›®æ ‡ IP ä¸åœ¨å½“å‰ç½‘ç»œä¸Šæ—¶ï¼Œæ•°æ®åŒ…å°†è¢«è½¬å‘åˆ°èŠ‚ç‚¹çš„é»˜è®¤ç½‘å…³ã€‚\nä½è¿ç®—çš„å·¥ä½œåŸç† åœ¨ç¡®å®šæ•°æ®åŒ…çš„è½¬å‘ä½ç½®æ—¶ï¼ŒæºèŠ‚ç‚¹å¿…é¡»æ‰§è¡Œä½è¿ç®—ã€‚\nè¿™ä¹Ÿè¢«ç§°ä¸ºä¸æ“ä½œã€‚\nä½œä¸ºå¤ä¹ ï¼Œä½ä¸æ“ä½œäº§ç”Ÿå¦‚ä¸‹ç»“æœï¼š\n0 AND 0 = 0 0 AND 1 = 0 1 AND 0 = 0 1 AND 1 = 1 é™¤äº† 1 ä¸ 1 ä»¥å¤–çš„éƒ½æ˜¯ falseã€‚\nå¦‚æœæºèŠ‚ç‚¹çš„ IP ä¸º 192.168.1.1ï¼Œå­ç½‘æ©ç ä¸º /24ï¼Œç›®æ ‡ IP ä¸º 172.16.1.1/16ï¼Œåˆ™æŒ‰ä½ä¸æ“ä½œå°†ç¡®è®¤ä»–ä»¬ä¸åœ¨åŒä¸€ç½‘ç»œä¸Šã€‚\nè¿™æ„å‘³ç€ç›®æ ‡ IP ä¸æ•°æ®åŒ…çš„æºåœ¨ä¸åŒçš„ç½‘ç»œä¸Šï¼Œå› æ­¤æ•°æ®åŒ…å°†åœ¨é»˜è®¤ç½‘å…³ä¸­è½¬å‘ã€‚\næ•°å­¦æ—¶é—´ã€‚\næˆ‘ä»¬å¿…é¡»ä»äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„ 32 ä½åœ°å€æ‰§è¡Œä¸æ“ä½œå¼€å§‹ã€‚\nå…ˆæ‰¾å‡ºæºå’Œç›®æ ‡ IP çš„ç½‘ç»œã€‚\n| Type | Binary | Converted | | ---------------- | ----------------------------------- | ------------------ | | Src. IP Address | 11000000.10101000.00000001.00000001 | 192.168.1.1 | | Src. Subnet Mask | 11111111.11111111.11111111.00000000 | 255.255.255.0(/24) | | Src. Network | 11000000.10101000.00000001.00000000 | 192.168.1.0 | | | | | | Dst. IP Address | 10101100.00010000.00000001.00000001 | 172.16.1.1 | | Dst. Subnet Mask | 11111111.11111111.00000000.00000000 | 255.255.0.0(/16) | | Dst. Network | 10101100.00010000.00000000.00000000 | 172.16.0.0 | ä½è¿ç®—æ“ä½œåï¼Œéœ€è¦å°†ç›®æ ‡ IP ä¸æ•°æ®åŒ…æºèŠ‚ç‚¹çš„å­ç½‘è¿›è¡Œæ¯”è¾ƒã€‚\n| Type | Binary | Converted | | ---------------- | ----------------------------------- | ------------------ | | Dst. IP Address | 10101100.00010000.00000001.00000001 | 172.16.1.1 | | Src. Subnet Mask | 11111111.11111111.11111111.00000000 | 255.255.255.0(/24) | | Network Result | 10101100.00010000.00000001.00000000 | 172.16.1.0 è¿›è¡Œä½æ¯”è¾ƒåï¼ŒARP ä¼šæ£€æŸ¥å…¶æŸ¥è¯¢è¡¨æ¥æŸ¥æ‰¾é»˜è®¤ç½‘å…³çš„ MAC åœ°å€ã€‚\nå¦‚æœæœ‰æ¡ç›®ï¼Œå°†ç«‹å³è½¬å‘æ•°æ®åŒ…ã€‚\nå¦åˆ™ï¼Œå…ˆè¿›è¡Œå¹¿æ’­ä»¥ç¡®å®šç½‘å…³çš„ MAC åœ°å€ã€‚\næ•°æ®åŒ…ç°åœ¨è·¯ç”±åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹çš„é»˜è®¤æ¥å£ï¼Œæˆ‘ä»¬å«å®ƒ Node-Bã€‚\nä»¥ç›¸åçš„é¡ºåºã€‚æ•°æ®åŒ…ç°åœ¨ä½ä¸ Node-B çš„æ ¹å‘½åç©ºé—´ï¼Œå¹¶åˆ°è¾¾æ¡¥æ¥å™¨ï¼Œè¿™é‡Œä¼šè¿›è¡Œ ARP è§£æã€‚\næ”¶åˆ°å¸¦æœ‰è¿æ¥ Pod-B çš„æ¥å£ MACåœ°å€çš„å›å¤ã€‚\nè¿™æ¬¡æ¡¥æ¥å™¨é€šè¿‡ Pod-B çš„ veth è®¾å¤‡å°†å¸§è½¬å‘ï¼Œå¹¶åˆ°è¾¾ Pod-B è‡ªå·±çš„å‘½åç©ºé—´ã€‚\næ­¤æ—¶åº”è¯¥å·²ç»ç†Ÿæ‚‰äº† pod ä¹‹é—´çš„æµé‡å¦‚ä½•æµè½¬ï¼Œæ¥ä¸‹æ¥å†æ¢ç´¢ä¸‹ CNI å¦‚ä½•åˆ›å»ºä¸Šè¿°å†…å®¹ã€‚\nå®¹å™¨ç½‘ç»œæ¥å£ - CNI å®¹å™¨ç½‘ç»œæ¥å£ï¼ˆCNIï¼‰å…³æ³¨å½“å‰èŠ‚ç‚¹çš„ç½‘ç»œã€‚\nå¯ä»¥å°† CNI çœ‹ä½œç½‘ç»œæ’ä»¶åœ¨è§£å†³ Kubernetes æŸäº› éœ€æ±‚æ—¶è¦éµå¾ªçš„ä¸€å¥—è§„åˆ™ã€‚\nç„¶è€Œï¼Œå®ƒä¸ä»…ä»…ä¸ Kubernetes æˆ–è€…ç‰¹å®šç½‘ç»œæ’ä»¶å…³è”ã€‚\nå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ CNIï¼š\nCalico Cilium Flannel Weave Net å…¶ä»–ç½‘ç»œæ’ä»¶ ä»–ä»¬éƒ½å®ç°ç›¸åŒçš„ CNI æ ‡å‡†ã€‚\nå¦‚æœæ²¡æœ‰ CNIï¼Œä½ éœ€è¦æ‰‹åŠ¨å®Œæˆå¦‚ä¸‹æ“ä½œï¼š\nåˆ›å»º podï¼ˆå®¹å™¨ï¼‰çš„ç½‘ç»œå‘½åç©ºé—´ åˆ›å»ºæ¥å£ åˆ›å»º veth å¯¹ è®¾ç½®å‘½åç©ºé—´ç½‘ç»œ è®¾ç½®é™æ€è·¯ç”± é…ç½®ä»¥å¤ªç½‘æ¡¥æ¥å™¨ åˆ†é… IP åœ°å€ åˆ›å»º NAT è§„åˆ™ è¿˜æœ‰å¤ªå¤šå…¶ä»–éœ€è¦æ‰‹åŠ¨å®Œæˆçš„å·¥ä½œã€‚\næ›´ä¸ç”¨è¯´åˆ é™¤æˆ–é‡æ–°å¯åŠ¨ pod æ—¶åˆ é™¤æˆ–è°ƒæ•´ä¸Šè¿°æ‰€æœ‰å†…å®¹äº†ã€‚\nCNI å¿…é¡»æ”¯æŒå››ä¸ªä¸åŒçš„æ“ä½œï¼š\nADD - å°†å®¹å™¨æ·»åŠ åˆ°ç½‘ç»œ DEL - ä»ç½‘ç»œä¸­åˆ é™¤å®¹å™¨ CHECK - å¦‚æœå®¹å™¨çš„ç½‘ç»œå‡ºç°é—®é¢˜ï¼Œåˆ™è¿”å›é”™è¯¯ VERSION - æ˜¾ç¤ºæ’ä»¶çš„ç‰ˆæœ¬ è®©æˆ‘ä»¬åœ¨å®è·µä¸­çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚\nå½“ pod åˆ†é…åˆ°ç‰¹å®šèŠ‚ç‚¹æ—¶ï¼Œkubelet æœ¬èº«ä¸ä¼šåˆå§‹åŒ–ç½‘ç»œã€‚\nç›¸åï¼Œå®ƒå°†ä»»åŠ¡äº¤ç»™äº† CNIã€‚\nç„¶åï¼Œå®ƒæŒ‡å®šäº†é…ç½®ï¼Œå¹¶ä»¥ JSON æ ¼å¼å°†å…¶å‘é€ç»™ CNI æ’ä»¶ã€‚\nå¯ä»¥åœ¨èŠ‚ç‚¹çš„ /etc/cni/net.d ç›®å½•ä¸­ï¼Œæ‰¾åˆ°å½“å‰ CNI çš„é…ç½®æ–‡ä»¶ï¼š\n$ cat 10-calico.conflist { \u0026#34;name\u0026#34;: \u0026#34;k8s-pod-network\u0026#34;, \u0026#34;cniVersion\u0026#34;: \u0026#34;0.3.1\u0026#34;, \u0026#34;plugins\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;calico\u0026#34;, \u0026#34;datastore_type\u0026#34;: \u0026#34;kubernetes\u0026#34;, \u0026#34;mtu\u0026#34;: 0, \u0026#34;nodename_file_optional\u0026#34;: false, \u0026#34;log_level\u0026#34;: \u0026#34;Info\u0026#34;, \u0026#34;log_file_path\u0026#34;: \u0026#34;/var/log/calico/cni/cni.log\u0026#34;, \u0026#34;ipam\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;calico-ipam\u0026#34;, \u0026#34;assign_ipv4\u0026#34; : \u0026#34;true\u0026#34;, \u0026#34;assign_ipv6\u0026#34; : \u0026#34;false\u0026#34;}, \u0026#34;container_settings\u0026#34;: { \u0026#34;allow_ip_forwarding\u0026#34;: false }, \u0026#34;policy\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;k8s\u0026#34; }, \u0026#34;kubernetes\u0026#34;: { \u0026#34;k8s_api_root\u0026#34;:\u0026#34;https://10.96.0.1:443\u0026#34;, \u0026#34;kubeconfig\u0026#34;: \u0026#34;/etc/cni/net.d/calico-kubeconfig\u0026#34; } }, { \u0026#34;type\u0026#34;: \u0026#34;bandwidth\u0026#34;, \u0026#34;capabilities\u0026#34;: {\u0026#34;bandwidth\u0026#34;: true} }, {\u0026#34;type\u0026#34;: \u0026#34;portmap\u0026#34;, \u0026#34;snat\u0026#34;: true, \u0026#34;capabilities\u0026#34;: {\u0026#34;portMappings\u0026#34;: true}} ] } æ¯ä¸ªæ’ä»¶éƒ½ä½¿ç”¨ä¸åŒç±»å‹çš„é…ç½®æ¥è®¾ç½®ç½‘ç»œã€‚\nä¾‹å¦‚ï¼ŒCalico ä½¿ç”¨ BGP è·¯ç”±åè®®é…å¯¹çš„ç¬¬ 3 å±‚ç½‘ç»œæ¥è¿æ¥ podã€‚\nCilium åœ¨ç¬¬ 3 åˆ° 7 å±‚ä½¿ç”¨ eBPF é…ç½®è¦†ç›–ç½‘ç»œã€‚\nä¸ Calico ä¸€èµ·ï¼ŒCilium æ”¯æŒè®¾ç½®ç½‘ç»œç­–ç•¥æ¥é™åˆ¶æµé‡ã€‚\né‚£è¯¥å¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿ\nè¿™å–å†³äºã€‚\nCNI ä¸»è¦æœ‰ä¸¤ç»„ã€‚\nç¬¬ä¸€ç»„ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°ä½¿ç”¨åŸºæœ¬ç½‘ç»œè®¾ç½®ï¼ˆä¹Ÿç§°ä¸ºæ‰å¹³ç½‘ç»œï¼‰çš„CNIï¼Œå¹¶å°†é›†ç¾¤ IP æ±  ä¸­çš„IP åœ°å€åˆ†é…ç»™ podã€‚\nè¿™å¯èƒ½ä¼šå› ä¸ºå¿«é€Ÿç”¨å°½å¯ç”¨çš„ IP åœ°å€è€Œæˆä¸ºè´Ÿæ‹…ã€‚\nç›¸åï¼Œå¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨è¦†ç›–ç½‘ç»œã€‚\nç®€è€Œè¨€ä¹‹ï¼Œè¦†ç›–ç½‘ç»œæ˜¯ä¸»ï¼ˆåº•å±‚ï¼‰ç½‘ç»œä¹‹ä¸Šçš„è¾…åŠ©ç½‘ç»œã€‚\nè¦†ç›–ç½‘ç»œçš„å·¥ä½œåŸç†æ˜¯å°è£…æ¥è‡ªåº•å±‚ç½‘ç»œçš„æ‰€æœ‰æ•°æ®åŒ…ï¼Œè¿™äº›æ•°æ®åŒ…æŒ‡å‘å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„ podã€‚\nè¦†ç›–ç½‘ç»œçš„ä¸€é¡¹æµè¡ŒæŠ€æœ¯æ˜¯ VXLANï¼Œå®ƒå…è®¸åœ¨ L3 ç½‘ç»œä¸Šéš§é“ä¼ è¾“ L2 åŸŸã€‚\né‚£ä¹ˆå“ªç§æ›´å¥½ï¼Ÿ\næ²¡æœ‰å”¯ä¸€çš„ç­”æ¡ˆï¼Œé€šå¸¸å–å†³äºä½ çš„éœ€æ±‚ã€‚\nä½ æ˜¯åœ¨æ„å»ºä¸€ä¸ªæ‹¥æœ‰æ•°ä¸‡ä¸ªèŠ‚ç‚¹çš„å¤§é›†ç¾¤å—ï¼Ÿ\nå¯èƒ½è¦†ç›–ç½‘ç»œæ›´å¥½ã€‚\nä½ æ˜¯å¦åœ¨æ„æ›´ç®€å•çš„è®¾ç½®å’Œåœ¨åµŒå¥—ç½‘ç»œä¸­ä¸å¤±å»æ£€æŸ¥ç½‘ç»œæµé‡çš„èƒ½åŠ›ã€‚\næ‰å¹³ç½‘ç»œæ›´é€‚åˆä½ ã€‚\nç°åœ¨å·²ç»è®¨è®ºäº† CNIï¼Œè®©æˆ‘ä»¬ç»§ç»­æ¢ç´¢ Pod åˆ°æœåŠ¡ï¼ˆserviceï¼‰çš„é€šä¿¡æ˜¯å¦‚ä½•å®Œæˆçš„ã€‚\næ£€æŸ¥ pod åˆ°æœåŠ¡çš„æµé‡ ç”±äº Kubernetes ç¯å¢ƒä¸‹ pod çš„åŠ¨æ€ç‰¹æ€§ï¼Œåˆ†é…ç»™ pod çš„ IP åœ°å€ä¸æ˜¯é™æ€çš„ã€‚\nè¿™äº› IP åœ°å€æ˜¯çŸ­æš‚çš„ï¼Œæ¯æ¬¡åˆ›å»ºæˆ–è€…åˆ é™¤ pod æ—¶éƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚\næœåŠ¡è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸ºè¿æ¥åˆ°ä¸€ç»„ pod æä¾›äº†ç¨³å®šçš„æœºåˆ¶ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨ Kubernetes ä¸­åˆ›å»ºæœåŠ¡æ—¶ï¼Œä¼šä¸ºå…¶é¢„å®šå¹¶åˆ†é…è™šæ‹Ÿ IP ã€‚\nä½¿ç”¨é€‰æ‹©å™¨å°†æœåŠ¡äºç›®æ ‡ pod è¿›è¡Œç®¡ç†ã€‚\nå½“åˆ é™¤ pod å¹¶æ·»åŠ æ–° pod æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ\nè¯¥æœåŠ¡çš„è™šæ‹Ÿ IP ä¿æŒä¸å˜ã€‚\nç„¶è€Œï¼Œæ— éœ€æ•¢äºï¼Œæµé‡å°†åˆ°è¾¾æ–°åˆ›å»ºçš„ podã€‚\næ¢å¥è¯è¯´ï¼ŒKubernetes ä¸­çš„æœåŠ¡ç±»ä¼¼äºè´Ÿè½½å‡è¡¡å™¨ã€‚\nä½†ä»–ä»¬æ—¶å¦‚ä½•å·¥ä½œçš„ï¼Ÿ\nä½¿ç”¨ Netfilter å’Œ Iptables æ‹¦æˆªå’Œé‡å†™æµé‡ Kubernetes ä¸­çš„æœåŠ¡åŸºäºä¸¤ä¸ª Linux å†…æ ¸ç»„ä»¶ï¼š\nNetfilter Iptables Netfilter æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œå…è®¸é…ç½®æ•°æ®åŒ…è¿‡æ»¤ã€åˆ›å»º NATæˆ–ç«¯å£ç¿»è¯‘è§„åˆ™ï¼Œå¹¶ç®¡ç†ç½‘ç»œä¸­çš„æµé‡ã€‚\næ­¤å¤–ï¼Œå®ƒè¿˜å±è”½å’Œé˜»æ­¢ä¸è¯·è‡ªæ¥çš„è¿æ¥è®¿é—®æœåŠ¡ã€‚\nå¦ä¸€æ–¹é¢ï¼ŒIptables æ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´ç¨‹åºï¼Œå…è®¸ä½ é…ç½® Linux å†…æ ¸é˜²ç«å¢™çš„ IP æ•°æ®åŒ…è¿‡æ»¤å™¨è§„åˆ™ã€‚\niptables ä½¿ç”¨ä¸åŒçš„ Netfilter æ¨¡å—å®ç°ã€‚\nä½ å¯ä»¥ä½¿ç”¨ iptables CLI å®æ—¶æ›´æ”¹è¿‡æ»¤è§„åˆ™ï¼Œå¹¶å°†å…¶æ’å…¥ netfilters çš„æŒ‚ç‚¹ã€‚\nè¿‡æ»¤å™¨ç»„ç»‡åœ¨ä¸åŒçš„è¡¨ä¸­ï¼Œå…¶ä¸­åŒ…å«å¤„ç†ç½‘ç»œæµé‡æ•°æ®åŒ…çš„é“¾ã€‚\næ¯ä¸ªåè®®éƒ½ä½¿ç”¨ä¸åŒçš„å†…æ ¸æ¨¡å—å’Œç¨‹åºã€‚\nå½“æåˆ° iptables æ—¶ï¼Œé€šå¸¸è¯´çš„æ˜¯ IPV4ã€‚å¯¹äº IPV6 çš„è§„åˆ™ï¼ŒCLI æ˜¯ ip6tablesã€‚\nIptables æœ‰äº”ç§ç±»å‹çš„é“¾ï¼Œæ¯ç§é“¾éƒ½ç›´æ¥æ˜ å°„åˆ° Netfilter é’©å­ã€‚\nä» iptables è§’åº¦çœ‹æ˜¯ï¼š\nPRE_ROUTING INPUT FORWARD OUTPUT POST_ROUTING å¯¹åº”æ˜ å°„åˆ° Netfilter é’©å­ï¼š\nNF_IP_PRE_ROUTING NF_IP_LOCAL_IN NF_IP_FORWARD NF_IP_LOCAL_OUT NF_IP_POST_ROUTING å½“æ•°æ®åŒ…åˆ°è¾¾æ—¶ï¼Œæ ¹æ®æ‰€å¤„çš„é˜¶æ®µï¼Œä¼šâ€œå‡ºå‘â€ Netfilter é’©å­ï¼Œè¯¥é’©å­åº”ç”¨ç‰¹å®šçš„ iptables è¿‡æ»¤ã€‚\nå“å‘€ï¼Œçœ‹èµ·æ¥å¾ˆå¤æ‚ï¼\nä¸è¿‡ä¸éœ€è¦æ‹…å¿ƒã€‚\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨ Kubernetesï¼Œä¸Šé¢çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯é€šè¿‡ä½¿ç”¨æœåŠ¡æ¥æŠ½è±¡çš„ï¼Œä¸€ä¸ªç®€å•çš„ YAML å®šä¹‰å°±å¯ä»¥è‡ªåŠ¨å®Œæˆè¿™äº›è§„åˆ™çš„è®¾ç½®ã€‚\nå¦‚æœå¯¹è¿™äº› iptables è§„åˆ™æ„Ÿå…´è¶£ï¼Œå¯ä»¥ç™»é™†åˆ°èŠ‚ç‚¹å¹¶è¿è¡Œï¼š\niptables-save ä¹Ÿå¯ä»¥ä½¿ç”¨å¯è§†åŒ–å·¥å…·æµè§ˆèŠ‚ç‚¹ä¸Šçš„ iptables é“¾ã€‚\nè®°ä½ï¼Œå¯èƒ½ä¼šæœ‰æ•°ç™¾æ¡è§„åˆ™ã€‚æƒ³è±¡ä¸‹æ‰‹åŠ¨åˆ›å»ºçš„éš¾åº¦ã€‚\næˆ‘ä»¬å·²ç»è§£é‡Šäº†ç›¸åŒå’Œä¸åŒèŠ‚ç‚¹ä¸Šçš„ pod é—´å¦‚ä½•é€šä¿¡ã€‚\nåœ¨ Pod-to-Service ä¸­ï¼Œé€šä¿¡çš„å‰åŠéƒ¨åˆ†ä¿æŒä¸å˜ã€‚\nå½“ Pod-A å‘å‡ºè¯·æ±‚æ—¶ï¼Œå¸Œæœ›åˆ°è¾¾ Pod-Bï¼ˆè¿™ç§æƒ…å†µä¸‹ï¼ŒPod-B ä½ä¸æœåŠ¡ä¹‹åï¼‰ï¼Œè½¬ç§»çš„è¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿå…¶ä»–å˜åŒ–ã€‚\nåŸå§‹è¯·æ±‚ä» Pod-A å‘½åç©ºé—´ä¸­çš„ eth0 æ¥å£å‡ºæ¥ã€‚\nä»é‚£é‡Œç©¿è¿‡ veth å¯¹ï¼Œåˆ°è¾¾æ ¹å‘½åç©ºé—´çš„ä»¥å¤ªç½‘æ¡¥ã€‚\nä¸€æ—¦åˆ°è¾¾æ¡¥æ¥å™¨ï¼Œæ•°æ®åŒ…ç«‹å³é€šè¿‡é»˜è®¤ç½‘å…³è½¬å‘ã€‚\nä¸ Pod-to-Pod éƒ¨åˆ†ä¸€æ ·ï¼Œä¸»æœºè¿›è¡Œä½æ¯”è¾ƒï¼Œç”±äºæœåŠ¡çš„ vIP ä¸æ˜¯èŠ‚ç‚¹ CIDR çš„ä¸€éƒ¨åˆ†ï¼Œæ•°æ®åŒ…å°†ç«‹å³é€šè¿‡é»˜è®¤ç½‘å…³è½¬å‘å‡ºå»ã€‚\nå¦‚æœæŸ¥æ‰¾è¡¨ä¸­å°šæ²¡æœ‰é»˜è®¤ç½‘å…³çš„ MAC åœ°å€ï¼Œåˆ™ä¼šè¿›è¡Œç›¸åŒçš„ ARP è§£æã€‚\nç°åœ¨é­”æ³•å‘ç”Ÿäº†ã€‚\nåœ¨æ•°æ®åŒ…ç»è¿‡èŠ‚ç‚¹çš„è·¯ç”±å¤„ç†ä¹‹å‰ï¼ŒNetfilter é’©å­ NF_IP_PRE_ROUTING è¢«è§¦å‘å¹¶åº”ç”¨ä¸€æ¡ iptables è§„åˆ™ã€‚è§„åˆ™è¿›è¡Œäº† DNAT è½¬æ¢ï¼Œé‡å†™äº† POD-A æ•°æ®åŒ…çš„ç›®æ ‡ IP åœ°å€ã€‚\nåŸæ¥æœåŠ¡ vIP åœ°å€è¢«é‡å†™ç§° POD-B çš„IP åœ°å€ã€‚\nä»é‚£é‡Œï¼Œè·¯ç”±å°±åƒ Pod-to-Pod ç›´æ¥é€šä¿¡ä¸€æ ·ã€‚\nç„¶è€Œï¼Œåœ¨æ‰€æœ‰è¿™äº›é€šä¿¡ä¹‹é—´ï¼Œä½¿ç”¨äº†ç¬¬ä¸‰ä¸ªåŠŸèƒ½ã€‚\nè¿™ä¸ªåŠŸèƒ½è¢«ç§°ä¸º conntrackï¼Œæˆ–è¿æ¥è·Ÿè¸ªã€‚\nConntrack å°†æ•°æ®åŒ…ä¸è¿æ¥å…³è”èµ·æ¥ï¼Œå¹¶åœ¨ Pod-B å‘é€å›å“åº”æ—¶è·Ÿè¸ªå…¶æ¥æºã€‚\nNAT ä¸¥é‡ä¾èµ– contrack å·¥ä½œã€‚\nå¦‚æœæ²¡æœ‰è¿æ¥è·Ÿè¸ªï¼Œå®ƒå°†ä¸çŸ¥é“å°†åŒ…å«å“åº”çš„æ•°æ®åŒ…å‘é€å›å“ªé‡Œã€‚\nä½¿ç”¨ conntrack æ—¶ï¼Œæ•°æ®åŒ…çš„è¿”å›è·¯å¾„å¯ä»¥è½»æ¾è®¾ç½®ç›¸åŒçš„æºæˆ–ç›®æ ‡ NAT æ›´æ”¹ã€‚\nå¦ä¸€åŠä½¿ç”¨ç›¸åçš„é¡ºåºæ‰§è¡Œã€‚\nPod-B æ¥æ”¶å¹¶å¤„ç†äº†è¯·æ±‚ï¼Œç°åœ¨å°†æ•°æ®å‘é€å› Pod-Aã€‚\næ­¤æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ\næ£€æŸ¥æœåŠ¡çš„å“åº” ç°åœ¨ Pod-B å‘é€å“åº”ï¼Œå°†å…¶ IP åœ°å€è®¾ç½®ä¸ºæºåœ°å€ï¼ŒPod-A IP åœ°å€è®¾ç½®ä¸ºç›®æ ‡åœ°å€ã€‚\nå½“æ•°æ®åŒ…åˆ°è¾¾ Pod-A æ‰€åœ¨èŠ‚ç‚¹çš„æ¥å£æ—¶ï¼Œå°±ä¼šå‘ç”Ÿå¦ä¸€ä¸ª NAT\nè¿™æ¬¡ï¼Œä½¿ç”¨ conntrack æ›´æ”¹æº IP åœ°å€ï¼Œiptables è§„åˆ™æ‰§è¡Œ SNAT å°† Pod-B IP åœ°å€æ›¿æ¢ä¸ºåŸå§‹æœåŠ¡çš„ VIP åœ°å€ã€‚\nä» Pod-A æ¥çœ‹åƒæ˜¯æœåŠ¡å‘å›çš„å“åº”ï¼Œè€Œä¸æ˜¯ Pod-Bã€‚\nå…¶ä»–éƒ¨åˆ†éƒ½ä¸€æ ·ï¼›ä¸€æ—¦ SNAT å®Œæˆï¼Œæ•°æ®åŒ…åˆ°è¾¾æ ¹å‘½åç©ºé—´ä¸­çš„ä»¥å¤ªç½‘æ¡¥æ¥å™¨ï¼Œå¹¶é€šè¿‡ veth å¯¹è½¬å‘åˆ° Pod-Aã€‚\nå›é¡¾ è®©æˆ‘ä»¬æ¥æ€»ç»“ä¸‹ä½ åœ¨æœ¬æ–‡ä¸­å­¦åˆ°çš„ä¸œè¥¿ï¼š\nå®¹å™¨å¦‚ä½•åœ¨æœ¬åœ°æˆ– pod å†…é€šä¿¡ã€‚ å½“ pod ä½äºç›¸åŒå’Œä¸åŒçš„èŠ‚ç‚¹ä¸Šæ—¶ï¼ŒPod-to- Pod å¦‚ä½•é€šä¿¡ã€‚ Pod-to-Service - å½“ pod å‘ Kubernetes æœåŠ¡èƒŒåçš„ pod å‘é€æµé‡æ—¶ã€‚ Kubernetes ç½‘ç»œå·¥å…·ç®±ä¸­æœ‰æ•ˆé€šä¿¡æ‰€éœ€çš„å‘½åç©ºé—´ã€vethã€iptablesã€é“¾ã€Netfilterã€CNIã€è¦†ç›–ç½‘ç»œä»¥åŠæ‰€æœ‰å…¶ä»–å†…å®¹ã€‚ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-vlada-karpovich-4450071.jpg","permalink":"https://atbug.com/tracing-path-of-kubernetes-network-packets/","tags":["Container","Kubernetes"],"title":"è¿½è¸ª Kubernetes ä¸­çš„ç½‘ç»œæµé‡"},{"categories":["äº‘åŸç”Ÿ"],"contents":"åœ¨ã€ŠKubernetes çš„è‡ªåŠ¨ä¼¸ç¼©ä½ ç”¨å¯¹äº†å—ï¼Ÿã€‹ ä¸€æ–‡ä¸­è¯¦ç»†è¯´æ˜äº†å¦‚ä½•ä½¿ç”¨ Kubernetes çš„è‡ªåŠ¨ä¼¸ç¼©ã€‚åœ¨ Kubernetes ä¸­å¼¹æ€§ä¼¸ç¼©ä¸»è¦æœ‰ä¸‰ç§ï¼šHPAã€VPAã€CAã€‚æœ¬æ–‡ä¸å†è¯¦ç»†è¯´æ˜ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹é‚£ç¯‡æ–‡ç« ã€‚è¿™é‡Œä¸»è¦æ¥è¯´ä¸‹ Pod æ°´å¹³ç¼©æ”¾ HPAã€‚\néšç€ Kubernetes v1.23 çš„å‘å¸ƒï¼ŒHPA çš„ API æ¥åˆ°äº†ç¨³å®šç‰ˆ autoscaling/v2ï¼š\nåŸºäºè‡ªå®šä¹‰æŒ‡æ ‡çš„ä¼¸ç¼© åŸºäºå¤šé¡¹æŒ‡æ ‡çš„ä¼¸ç¼© å¯é…ç½®çš„ä¼¸ç¼©è¡Œä¸º ä»æœ€åˆçš„ v1 ç‰ˆæœ¬ HPA åªæ”¯æŒ CPUã€å†…å­˜åˆ©ç”¨ç‡çš„ä¼¸ç¼©ï¼Œåˆ°åæ¥çš„è‡ªå®šä¹‰æŒ‡æ ‡ã€èšåˆå±‚ API çš„æ”¯æŒï¼Œåˆ°äº† v1.18 ç‰ˆæœ¬åˆåŠ å…¥äº†é…ç½®ä¼¸ç¼©è¡Œä¸ºçš„æ”¯æŒï¼ŒHPA ä¹Ÿè¶Šæ¥è¶Šå¥½ç”¨ã€å¯é ã€‚\nä¾é  CPU æˆ–è€…å†…å­˜æŒ‡æ ‡çš„æ‰©å®¹å¹¶éä½¿ç”¨æ‰€æœ‰ç³»ç»Ÿï¼Œçœ‹èµ·æ¥ä¹Ÿæ²¡é‚£ä¹ˆå¯é ã€‚å¯¹å¤§éƒ¨åˆ†çš„ web åç«¯ç³»ç»Ÿæ¥è¯´ï¼ŒåŸºäº RPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰çš„å¼¹æ€§ä¼¸ç¼©æ¥å¤„ç†çªå‘çš„æµé‡åˆ™ä¼šæ›´åŠ é è°±ã€‚\nPrometheus ä¹Ÿæ˜¯å½“ä¸‹æµè¡Œå¼€æºç›‘æ§ç³»ç»Ÿï¼Œé€šè¿‡ Prometheus å¯ä»¥è·å–åˆ°ç³»ç»Ÿçš„å®æ—¶æµé‡è´Ÿè½½æŒ‡æ ‡ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥å°è¯•ä¸‹åŸºäº Prometheus çš„è‡ªå®šä¹‰æŒ‡æ ‡è¿›è¡Œå¼¹æ€§ä¼¸ç¼©ã€‚\næ³¨ï¼šç›®å‰ HPA çš„ç¼©å®¹0 ï¼ˆscale to 0ï¼‰ï¼Œåˆ™éœ€è¦åœ¨ feature gate æ‰“å¼€ alpha ç‰ˆæœ¬çš„ HPAScaleToZero ä»¥åŠé…ç½®ä¸€ä¸ªå¯¹è±¡æˆ–è€…å¤–éƒ¨æŒ‡æ ‡ã€‚å³ä½¿æ˜¯æ‰“å¼€äº†ï¼Œä» 0 åˆ° 1 çš„æ‰©å®¹éœ€è¦è°ƒåº¦ã€IP åˆ†é…ã€é•œåƒæ‹‰å–ç­‰è¿‡ç¨‹ï¼Œå­˜åœ¨ä¸€å®šçš„å¼€é”€ã€‚å¦‚æœé™ä½è¿™éƒ¨åˆ†å¼€é”€ï¼Œè¿™é‡Œå…ˆå–ä¸ªå…³å­ï¼Œåç»­çš„æ–‡ç« è¿›è¡Œè¡¥å……ã€‚\næ–‡ç« ä¸­ä½¿ç”¨çš„æ‰€æœ‰ä»£ç éƒ½å¯ä»¥ä»è¿™é‡Œä¸‹è½½ã€‚\næ•´ä½“æ¶æ„ HPA è¦è·å– Prometheus çš„æŒ‡æ ‡æ•°æ®ï¼Œè¿™é‡Œå¼•å…¥ Prometheus Adapter ç»„ä»¶ã€‚Prometheus Adapter å®ç°äº† resource metricsã€custom metrics å’Œ external metrics APIs APIï¼Œæ”¯æŒ autoscaling/v2 çš„ HPAã€‚\nè·å–åˆ°æŒ‡æ ‡æ•°æ®åï¼Œæ ¹æ®é¢„å®šä¹‰çš„è§„åˆ™å¯¹å·¥ä½œè´Ÿè½½çš„ç¤ºä¾‹æ•°è¿›è¡Œè°ƒæ•´ã€‚\nç¯å¢ƒæ­å»º K3s æˆ‘ä»¬ä½¿ç”¨æœ€æ–° 1.23 ç‰ˆæœ¬çš„ K3s ä½œä¸º Kubernetes ç¯å¢ƒã€‚\nexport INSTALL_K3S_VERSION=v1.23.1+k3s2 curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644 --write-kubeconfig ~/.kube/config ç¤ºä¾‹åº”ç”¨ æˆ‘ä»¬å‡†å¤‡ä¸€ä¸ªç®€å•çš„ web åº”ç”¨ï¼Œå¯ä»¥è®°å½•è¯·æ±‚æ¬¡æ•°å¹¶é€šè¿‡ /metrics ç«¯ç‚¹è¾“å‡º Prometheus æ ¼å¼çš„æŒ‡æ ‡ http_requests_totalã€‚\nfunc main() { metrics := prometheus.NewCounterVec( prometheus.CounterOpts{ Name: \u0026#34;http_requests_total\u0026#34;, Help: \u0026#34;Number of total http requests\u0026#34;, }, []string{\u0026#34;status\u0026#34;}, ) prometheus.MustRegister(metrics) http.HandleFunc(\u0026#34;/\u0026#34;, func(w http.ResponseWriter, r *http.Request) { path := r.URL.Path statusCode := 200 switch path { case \u0026#34;/metrics\u0026#34;: promhttp.Handler().ServeHTTP(w, r) default: w.WriteHeader(statusCode) w.Write([]byte(\u0026#34;Hello World!\u0026#34;)) } metrics.WithLabelValues(strconv.Itoa(statusCode)).Inc() }) http.ListenAndServe(\u0026#34;:3000\u0026#34;, nil) } å°†åº”ç”¨éƒ¨ç½²åˆ°é›†ç¾¤ï¼š\nkubectl apply -f kubernetes/sample-httpserver-deployment.yaml Prometheus ä½¿ç”¨ Helm å®‰è£… Prometheusï¼Œå…ˆæ·»åŠ  prometheus çš„ chart ä»“åº“ï¼š\nhelm repo add prometheus-community https://prometheus-community.github.io/helm-charts è¿™é‡Œçš„æµ‹è¯•åªéœ€è¦ç”¨åˆ° prometheus-serverï¼Œå®‰è£…æ—¶ç¦ç”¨å…¶ä»–ç»„ä»¶ã€‚åŒæ—¶ä¸ºäº†æ¼”ç¤ºæ•ˆæœçš„å®æ•ˆæ€§ï¼Œå°†æŒ‡æ ‡çš„æ‹‰å–é—´éš”è®¾ç½®ä¸º 10sã€‚\n# install prometheus with some components disabled # set scrape interval to 10s helm install prometheus prometheus-community/prometheus -n default --set alertmanager.enabled=false,pushgateway.enabled=false,nodeExporter.enabled=false,kubeStateMetrics.enabled=false,server.global.scrape_interval=10s é€šè¿‡ç«¯å£è½¬å‘ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—® web é¡µé¢ã€‚\n# port forward kubectl port-forward svc/prometheus-server 9090:80 -n prometheus è¿™é‡ŒæŸ¥è¯¢ Pod çš„ RPS ä½¿ç”¨ sum(rate(http_requests_total[30s])) by (pod) è¯­å¥æŸ¥è¯¢ï¼š\nPrometheus Adapter åŒæ ·ä½¿ç”¨ Helm å®‰è£… Produmetheus Adapterï¼Œè¿™é‡Œè¦è¿›è¡Œé¢å¤–çš„é…ç½®ã€‚\nhelm install prometheus-adapter prometheus-community/prometheus-adapter -n default -f kubernetes/values-adapter.yaml éœ€è¦é…ç½® Prometheus Server çš„è¿æ¥ï¼Œä»¥åŠå¦‚ä½•æå–å’Œè½¬æ¢æŒ‡æ ‡çš„è§„åˆ™ï¼Œä»¥ä¾¿ Adapter èƒ½å¤Ÿè·å–æ‰€éœ€çš„è‡ªå®šä¹‰æŒ‡æ ‡æ•°æ®ï¼š\nrules: default: false custom: - seriesQuery: \u0026#39;{__name__=~\u0026#34;^http_requests.*_total$\u0026#34;,container!=\u0026#34;POD\u0026#34;,namespace!=\u0026#34;\u0026#34;,pod!=\u0026#34;\u0026#34;}\u0026#39; resources: overrides: namespace: { resource: \u0026#34;namespace\u0026#34; } pod: { resource: \u0026#34;pod\u0026#34; } name: matches: \u0026#34;(.*)_total\u0026#34; as: \u0026#34;${1}_qps\u0026#34; metricsQuery: sum(rate(\u0026lt;\u0026lt;.Series\u0026gt;\u0026gt;{\u0026lt;\u0026lt;.LabelMatchers\u0026gt;\u0026gt;}[30s])) by (\u0026lt;\u0026lt;.GroupBy\u0026gt;\u0026gt;) å¯ä»¥å‚è€ƒè¯¦ç»†çš„ Adapter é…ç½®ã€‚\nå¾… promethues-adapter pod æˆåŠŸè¿è¡Œåï¼Œå¯ä»¥æ‰§è¡Œ custom.metrics.k8s.io è¯·æ±‚ï¼š\nkubectl get --raw \u0026#39;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/http_requests_qps\u0026#39; | jq . { \u0026#34;kind\u0026#34;: \u0026#34;MetricValueList\u0026#34;, \u0026#34;apiVersion\u0026#34;: \u0026#34;custom.metrics.k8s.io/v1beta1\u0026#34;, \u0026#34;metadata\u0026#34;: { \u0026#34;selfLink\u0026#34;: \u0026#34;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/http_requests_qps\u0026#34; }, \u0026#34;items\u0026#34;: [ { \u0026#34;describedObject\u0026#34;: { \u0026#34;kind\u0026#34;: \u0026#34;Pod\u0026#34;, \u0026#34;namespace\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;sample-httpserver-64c495844f-b58pl\u0026#34;, \u0026#34;apiVersion\u0026#34;: \u0026#34;/v1\u0026#34; }, \u0026#34;metricName\u0026#34;: \u0026#34;http_requests_qps\u0026#34;, \u0026#34;timestamp\u0026#34;: \u0026#34;2022-01-18T03:32:51Z\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;100m\u0026#34;, \u0026#34;selector\u0026#34;: null } ] } æ³¨æ„ï¼šè¿™é‡Œçš„ value: 100mï¼Œå€¼çš„åç¼€â€œmâ€ æ ‡è¯† milli-requests per secondsï¼Œæ‰€ä»¥è¿™é‡Œçš„ 100m çš„æ„æ€æ˜¯ 0.1/s æ¯ç§’0.1 ä¸ªè¯·æ±‚ã€‚\nHPA æœ€åå°±æ˜¯ HPA çš„é…ç½®äº†ï¼š\næœ€å°æœ€å¤§çš„å‰¯æœ¬æ•°åˆ†åˆ«è®¾ç½® 1ã€10 ä¸ºäº†æµ‹è¯•æ•ˆæœçš„å®æ•ˆæ€§ï¼Œè®¾ç½®æ‰©ç¼©å®¹çš„è¡Œä¸º behavior æŒ‡å®šæŒ‡æ ‡ http_requests_qpsã€ç±»å‹ Pods ä»¥åŠç›®æ ‡å€¼ 50000mï¼šè¡¨ç¤ºå¹³å‡æ¯ä¸ª pod çš„ RPS 50 ã€‚æ¯”å¦‚ä»¥ 300 çš„ RPS è®¿é—®ï¼Œå‰¯æœ¬æ•°å°±æ˜¯ 300/50=6 ã€‚ kind: HorizontalPodAutoscaler apiVersion: autoscaling/v2 metadata: name: sample-httpserver spec: scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: sample-httpserver minReplicas: 1 maxReplicas: 10 behavior: scaleDown: stabilizationWindowSeconds: 30 policies: - type: Percent value: 100 periodSeconds: 15 scaleUp: stabilizationWindowSeconds: 0 policies: - type: Percent value: 100 periodSeconds: 15 metrics: - type: Pods pods: metric: name: http_requests_qps target: type: AverageValue averageValue: 50000m æµ‹è¯• æµ‹è¯•å·¥å…·é€‰ç”¨ vegetaï¼Œå› ä¸ºå…¶å¯ä»¥æŒ‡å®š RPSã€‚\nå…ˆä¸ºåº”ç”¨åˆ›å»º NodePort serviceï¼š\nkubectl expose deploy sample-httpserver --name sample-httpserver-host --type NodePort --target-port 3000 kubectl get svc sample-httpserver-host NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE sample-httpserver-host NodePort 10.43.66.206 \u0026lt;none\u0026gt; 3000:31617/TCP 12h åˆ†åˆ«ä½¿ç”¨ 240ã€120ã€40 çš„ RPS å‘èµ·è¯·æ±‚ï¼š\n# 240 echo \u0026#34;GET http://192.168.1.92:31617\u0026#34; | vegeta attack -duration 60s -connections 10 -rate 240 | vegeta report # 120 echo \u0026#34;GET http://192.168.1.92:31617\u0026#34; | vegeta attack -duration 60s -connections 10 -rate 120 | vegeta report # 40 echo \u0026#34;GET http://192.168.1.92:31617\u0026#34; | vegeta attack -duration 60s -connections 10 -rate 40 | vegeta report ä» Prometheus çš„ web ç•Œé¢ä¸Šè§‚å¯Ÿè¯·æ±‚é‡ä¸ç¤ºä¾‹æ•°çš„å˜åŒ–ï¼š\nkubectl describe hpa sample-httpserver Warning: autoscaling/v2beta2 HorizontalPodAutoscaler is deprecated in v1.23+, unavailable in v1.26+; use autoscaling/v2 HorizontalPodAutoscaler Name: sample-httpserver Namespace: default Labels: \u0026lt;none\u0026gt; Annotations: \u0026lt;none\u0026gt; CreationTimestamp: Mon, 17 Jan 2022 23:18:46 +0800 Reference: Deployment/sample-httpserver Metrics: ( current / target ) \u0026#34;http_requests_qps\u0026#34; on pods: 100m / 50 Min replicas: 1 Max replicas: 10 Behavior: Scale Up: Stabilization Window: 0 seconds Select Policy: Max Policies: - Type: Percent Value: 100 Period: 15 seconds Scale Down: Stabilization Window: 30 seconds Select Policy: Max Policies: - Type: Percent Value: 100 Period: 15 seconds Deployment pods: 1 current / 1 desired Conditions: Type Status Reason Message ---- ------ ------ ------- AbleToScale True ReadyForNewScale recommended size matches current size ScalingActive True ValidMetricFound the HPA was able to successfully calculate a replica count from pods metric http_requests_qps ScalingLimited False DesiredWithinRange the desired count is within the acceptable range Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal SuccessfulRescale 25m horizontal-pod-autoscaler New size: 6; reason: pods metric http_requests_qps above target Normal SuccessfulRescale 19m horizontal-pod-autoscaler New size: 4; reason: All metrics below target Normal SuccessfulRescale 12m (x2 over 9h) horizontal-pod-autoscaler New size: 4; reason: pods metric http_requests_qps above target Normal SuccessfulRescale 11m horizontal-pod-autoscaler New size: 5; reason: pods metric http_requests_qps above target Normal SuccessfulRescale 9m40s (x2 over 12m) horizontal-pod-autoscaler New size: 2; reason: pods metric http_requests_qps above target Normal SuccessfulRescale 9m24s (x4 over 10h) horizontal-pod-autoscaler New size: 3; reason: pods metric http_requests_qps above target Normal SuccessfulRescale 7m54s (x3 over 9h) horizontal-pod-autoscaler New size: 2; reason: All metrics below target Normal SuccessfulRescale 7m39s (x4 over 9h) horizontal-pod-autoscaler New size: 1; reason: All metrics below target æ€»ç»“ åŸºäºè‡ªå®šä¹‰æŒ‡æ ‡æ¯”å¦‚æ¯ç§’è¯·æ±‚é‡è¿›è¡Œåº”ç”¨çš„æ°´å¹³æ‰©å®¹ç›¸æ¯” CPU/å†…å­˜ ä½œä¸ºä¾æ®æ›´åŠ é è°±ï¼Œé€‚ç”¨äºå¤§éƒ¨åˆ†çš„ web ç³»ç»Ÿã€‚åœ¨çªå‘æµé‡æ—¶å¯ä»¥è¿›è¡Œå¿«é€Ÿæ‰©å®¹ï¼Œé€šè¿‡å¯¹ä¼¸ç¼©è¡Œä¸ºçš„æ§åˆ¶ï¼Œå¯ä»¥å‡å°‘å‰¯æœ¬æ•°çš„æŠ–åŠ¨ã€‚Promeheus ä½œä¸ºæµè¡Œåº”ç”¨çš„ç›‘æ§ç³»ç»Ÿï¼Œåœ¨ Adapter å’Œ Aggregate API çš„æ”¯æŒä¸‹ï¼Œå¯ä»¥ä½œä¸ºä¼¸ç¼©çš„æŒ‡æ ‡ã€‚\nç›®å‰ HPA çš„ scale to 0 è¿˜åœ¨ alpha çš„é˜¶æ®µï¼Œè¿˜éœ€è¦å…³æ³¨å‰¯æœ¬ä» 0 åˆ° N çš„å®æ•ˆæ€§ã€‚å¦‚æœæœ€å°å‰¯æœ¬æ•°å¤§äº0 ï¼Œå¯¹æŸäº›æœåŠ¡æ¥è¯´åˆä¼šå ç”¨èµ„æºã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šä¸ºå°è¯•è§£å†³ 0 åˆ° N çš„æ€§èƒ½ï¼Œä»¥åŠèµ„æºå ç”¨çš„é—®é¢˜ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-milada-vigerova-5984860.jpg","permalink":"https://atbug.com/kubernetes-pod-autoscale-on-prometheus-metrics/","tags":["Kubernetes","Prometheus","äº‘åŸç”Ÿ","DevOps"],"title":"Kubernetes HPA åŸºäº Prometheus è‡ªå®šä¹‰æŒ‡æ ‡çš„å¯æ§å¼¹æ€§ä¼¸ç¼©"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬æ–‡ç¿»è¯‘è‡ª Vivian Hu çš„ ã€ŠeBPF and Wasm: Exploring the Future of the Service Mesh Data Planeã€‹ã€‚\nåœ¨ 2021 å¹´ 12 æœˆ 2 æ—¥ï¼ŒCilium é¡¹ç›®å®£å¸ƒäº† Cilium Service Mesh é¡¹ç›®çš„æµ‹è¯•ç‰ˆã€‚åœ¨ 2020 å¹´ 8 æœˆ Google Cloud å®£å¸ƒåŸºäº eBPF çš„ Google Kubernetes æœåŠ¡ï¼ˆGKSï¼‰çš„æ•°æ®å¹³é¢ V2 çš„ä¸€å¹´åï¼ŒCilium Service Mesh å¸¦æ¥äº† â€œæ— è¾¹è½¦æœåŠ¡ç½‘æ ¼â€ï¼ˆsidecarless service meshï¼‰çš„æƒ³æ³•ã€‚å®ƒæ‰©å±•äº† Cilium eBPF äº§å“æ¥å¤„ç†æœåŠ¡ç½‘æ ¼ä¸­çš„å¤§éƒ¨åˆ†è¾¹è½¦ä»£ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ 7 å±‚è·¯ç”±å’Œè´Ÿè½½å‡è¡¡ã€TLS ç»ˆæ­¢ã€è®¿é—®ç­–ç•¥ã€å¥åº·æ£€æŸ¥ã€æ—¥å¿—å’Œè·Ÿè¸ªï¼Œä»¥åŠå†…ç½®çš„ Kubernetes Ingressã€‚\nCilium çš„åˆ›å§‹äºº Isovalent åœ¨ä¸€ç¯‡åä¸º â€œHow eBPF will solve Service Mesh - Goodbye Sidecarsâ€ çš„æ–‡ç« ä¸­è§£é‡Šäº† eBPF å¦‚ä½•æ›¿ä»£è¾¹è½¦ä»£ç†ã€‚\nå®ƒå°†æˆ‘ä»¬ä»è¾¹è½¦æ¨¡å‹ä¸­è§£æ”¾å¤„ç†ï¼Œå¹¶å…è®¸æˆ‘ä»¬å°†ç°æœ‰çš„ä»£ç†æŠ€æœ¯é›†æˆåˆ°ç°æœ‰çš„å†…æ ¸å‘½åç©ºé—´æ¦‚å¿µä¸­ï¼Œä½¿å…¶æˆä¸ºæ—¥å¸¸ä½¿ç”¨çš„ä¼˜é›…å®¹å™¨æŠ½è±¡çš„ä¸€éƒ¨åˆ†ã€‚\nç®€è€Œè¨€ä¹‹ï¼ŒeBPF æ‰¿è¯ºä¼šè§£å†³æœåŠ¡ç½‘æ ¼ä¸­çš„é‡è¦ç—›ç‚¹ \u0026ndash; å½“æœ‰è®¸å¤šç»†ç²’åº¦å¾®æœåŠ¡æ—¶çš„æ€§èƒ½æŸè€—ã€‚ç„¶è€Œï¼Œä½¿ç”¨ eBPF æ›¿æ¢è¾¹è½¦ä»£ç†è¿™ç§æ–°é¢–çš„æƒ³æ³•ï¼Œä¹Ÿå­˜åœ¨ç€äº‰è®®ã€‚\næœåŠ¡ç½‘æ ¼ä¸­çš„æ•°æ®å¹³é¢æ˜¯æŒ‡ç®¡ç†æ•°æ®æµé‡å¦‚ä½•è·¯ç”±å’ŒæœåŠ¡ä¹‹é—´çš„æµè½¬çš„åŸºç¡€è®¾æ–½æœåŠ¡ã€‚ç›®å‰ï¼Œè¿™æ˜¯é€šè¿‡ä½¿ç”¨æœåŠ¡ä»£ç†å®ç°çš„ã€‚è¿™ç§è®¾è®¡æ¨¡å¼ä¹Ÿé€šå¸¸è¢«ç§°ä¸ºè¾¹è½¦æ¨¡å¼ã€‚è¾¹è½¦å…è®¸å…¶é™„åŠ çš„å¾®æœåŠ¡é€æ˜åœ°å‘æœåŠ¡ç½‘æ ¼ä¸­çš„å…¶ä»–ç»„ä»¶å‘é€å’Œæ¥æ”¶è¯·æ±‚ã€‚\nè¾¹è½¦é€šå¸¸åŒ…å«äº† 7 å±‚ä»£ç†ï¼Œæ¯”å¦‚ Envoyã€Linkerd æˆ–è€… MOSNã€‚è¯¥ä»£ç†å¤„ç†æµé‡çš„è·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€å¥åº·æ£€æŸ¥ã€èº«ä»½éªŒè¯ã€æˆæƒã€åŠ å¯†ã€æ—¥å¿—ã€è·Ÿè¸ªå’Œç»Ÿè®¡æ•°æ®æ”¶é›†ã€‚è¾¹è½¦è¿˜å¯ä»¥åŒ…å«ä¸€ä¸ªåŸºäº SDK çš„åº”ç”¨ç¨‹åºæ¡†æ¶ï¼ˆæ¯”å¦‚ Daprï¼‰ä»¥æä¾›ç½‘ç»œä»£ç†ä»¥å¤–çš„åº”ç”¨ç¨‹åºæœåŠ¡ã€‚æ­¤ç±»æœåŠ¡çš„ç¤ºä¾‹è¿˜åŒ…å«äº†æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°ã€èµ„æºç»‘å®šã€åŸºäºåç§°çš„æœåŠ¡è°ƒç”¨ã€çŠ¶æ€ç®¡ç†ã€actor æ¡†æ¶ å’Œå¯†é’¥å­˜å‚¨ã€‚\nè¾¹è½¦ä»£ç†é€šå¸¸åœ¨ Kubernetes Pod æˆ–è€…å®¹å™¨ä¸­è¿è¡Œã€‚å¾®æœåŠ¡åº”ç”¨ä¹ŸåŒæ ·è¿è¡Œåœ¨å®¹å™¨å†…ï¼Œå¹¶é€šè¿‡ç½‘ç»œæ¥å£è¿æ¥åˆ°è¾¹è½¦ã€‚ç„¶è€Œï¼Œè¿™äº›å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªé‡è¦é—®é¢˜å°±æ˜¯èµ„æºæ¶ˆè€—ã€‚è¾¹è½¦æœåŠ¡éšç€å¾®æœåŠ¡çš„æ•°é‡å‡ ä½•çº§å¢é•¿ã€‚å½“åº”ç”¨ç¨‹åºæœ‰æ•°ç™¾ä¸ªäº’è”å’Œè´Ÿè½½å‡è¡¡çš„å¾®æœåŠ¡æ—¶ï¼Œå¼€é”€å˜å¾—éš¾ä»¥æ¥å—ã€‚æœåŠ¡ç½‘æ ¼ä»£ç†å•†å¼€å§‹äº†æ€§èƒ½ä¸Šçš„ç«äº‰ã€‚æ­£å¦‚ Infoq ä¹‹å‰æŠ¥é“çš„é‚£æ ·ï¼ŒLinkerd å°†å…¶ Go å†™çš„ä»£ç†ç”¨ Rust é‡å†™äº†ï¼Œå¹¶è·å¾—äº†æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚\nå¹¶ä¸å¥‡æ€ªï¼Œç°æœ‰çš„æœåŠ¡ç½‘æ ¼æä¾›å•†ä¸ç›¸ä¿¡ eBPF æ˜¯è§£å†³æ‰€æœ‰é—®é¢˜çš„åœ£æ¯ã€‚Solo.io çš„ Idit Levine ç­‰äººé’ˆå¯¹ Cilium çš„è¿™ç¯‡å…¬å‘Šæ’°å†™äº†ä¸€ç¯‡æ–‡ç«  â€œeBPF for Service Mesh? Yes, But Envoy Proxy is Here to Stayâ€ã€‚\nåœ¨ Solo.ioï¼Œæˆ‘ä»¬è®¤ä¸º eBPF æ˜¯ä¼˜åŒ–æœåŠ¡ç½‘æ ¼çš„å¾ˆå¥½çš„æ–¹å¼ï¼Œå¹¶å°† Envoy ä»£ç†è§†ä¸ºæ•°æ®å¹³é¢çš„åŸºçŸ³ã€‚\nSolo.io ä½œè€…æå‡ºçš„è§‚ç‚¹æ˜¯ï¼šè¾¹è½¦ä»£ç†ç°åœ¨æ‰€åšçš„ä¸ä»…ä»…æ˜¯ç®€å•çš„ç½‘ç»œæµé‡ç®¡ç†ã€‚å½“ä»Šçš„æœåŠ¡ç½‘æ ¼éƒ¨ç½²ä¸­æœ‰ç€å¤æ‚çš„éœ€æ±‚ï¼Œè¿œè¶…è¿‡ eBPF æ”¯æŒçš„æœ‰é™ç¼–ç¨‹æ¨¡å‹ï¼Œå…¶ä¸ç¬¦åˆå›¾çµå®Œå¤‡æ€§ä¸”å—åˆ°å†…æ ¸å®‰å…¨çš„è¯¸å¤šé™åˆ¶ã€‚Cilium eBPF äº§å“å¯ä»¥å¤„ç†è¾¹è½¦ä»£ç†è®¸å¤šä½†å¹¶ä¸æ˜¯å…¨éƒ¨çš„ä»»åŠ¡ã€‚æ­¤å¤–ï¼ŒSolo.io çš„ä½œè€…è¿˜æŒ‡å‡ºï¼ŒeBPF çš„èŠ‚ç‚¹çº§ä»£ç†ä¸ä¼ ç»Ÿçš„ Pod çº§è¾¹è½¦ä»£ç†ç›¸æ¯”ç¼ºä¹çµæ´»æ€§ï¼Œåè€Œå¢åŠ äº†æ•´ä½“å¼€é”€ã€‚eBPF ç¼ºé™·åœ¨å¼€å‘äººå‘˜å¿…é¡»ç¼–å†™å¹¶éƒ¨ç½²åˆ°æœåŠ¡ç½‘æ ¼ä»£ç†ä¸­çš„æµé‡è·¯ç”±ã€è´Ÿè½½å‡è¡¡å’Œæˆæƒçš„ç‰¹å®šåº”ç”¨ç¨‹åºé€»è¾‘ä¸­ä½“ç°å¾—å°¤ä¸ºæ˜æ˜¾ã€‚\nTerate.io çš„å¼€å‘äººå‘˜åœ¨å›åº”åä¸º The Debate in the Community about Istio and Service Mesh çš„ Cilium å…¬å‘Šä¸­ä¹Ÿæå‡ºäº†ç±»ä¼¼çš„è§‚ç‚¹ã€‚ä»–ä»¬æŒ‡å‡ºï¼Œå½“å‰è¾¹è½¦ä»£ç†çš„æ€§èƒ½æ˜¯åˆç†çš„ï¼Œå¼€æºç¤¾åŒºä¹Ÿå·²ç»æœ‰äº†è¿›ä¸€æ­¥æé«˜æ€§èƒ½çš„æ–¹æ³•ã€‚ä¸æ­¤åŒæ—¶ï¼Œå¼€å‘äººå‘˜å¾ˆéš¾åœ¨ eBPF ç­‰æ–°é¢–ä½†å›¾çµä¸å®Œæ•´çš„æŠ€æœ¯ä¸­æ„å»ºåº”ç”¨ç¨‹åºç‰¹å®šçš„æ•°æ®å¹³é¢é€»è¾‘ã€‚\nIstio æ¶æ„ç¨³å®šä¸”ç”Ÿäº§å°±ç»ªï¼Œç”Ÿæ€ç³»ç»Ÿæ­£åœ¨å‘å±•æœŸã€‚\neBPF çš„è®¸å¤šé—®é¢˜ä¸å…¶æ˜¯ä¸€ç§å†…æ ¸æŠ€æœ¯åˆ†ä¸å¼€ï¼Œå¿…å®šæ”¶åˆ°å®‰å…¨é™åˆ¶ã€‚æœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥åœ¨ä¸ä½¿ç”¨ç©ºé—´æŠ€æœ¯é™ä½æ€§èƒ½çš„æƒ…å†µä¸‹å°†å¤æ‚çš„åº”ç”¨ç¨‹åºç‰¹å®šçš„ä»£ç†é€»è¾‘é›†æˆåˆ°æ•°æ®å¹³é¢ä¸­ï¼Ÿäº‹å®è¯æ˜ï¼ŒWebAssemblyï¼ˆWasmï¼‰å¯èƒ½ä¼šæ˜¯ä¸ªé€‰æ‹©ã€‚Wasm è¿è¡Œæ—¶å¯ä»¥ä»¥è¿‘ä¼¼åŸç”Ÿæ€§èƒ½å®‰å…¨åœ°éš”ç¦»å’Œæ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç ã€‚\nEnvoy Proxy ç‡å…ˆä½¿ç”¨ Wasm ä½œä¸ºæ‰©å±•æœºåˆ¶å¯¹æ•°æ®å¹³é¢çš„ç¼–ç¨‹ã€‚å¼€å‘äººå‘˜å¯ä»¥ç”¨Cã€C++ã€Rustã€AssemblyScriptã€Swift å’Œ TinyGO ç­‰è¯­è¨€ç¼–å†™åº”ç”¨ç¨‹åºç‰¹å®šçš„ä»£ç†é€»è¾‘ï¼Œå¹¶å°†æ¨¡å—ç¼–è¯‘ä¸º Wasmã€‚é€šè¿‡proxy-Wasm æ ‡å‡†ï¼Œä»£ç†å¯ä»¥åœ¨ä¾‹å¦‚ Wasmtime å’Œ WasmEdge çš„é«˜æ€§èƒ½è¿è¡Œæ—¶æ‰§è¡Œè¿™äº› Wasm æ’ä»¶ã€‚ç›®å‰ï¼ŒEnvoy ä»£ç†ã€Istio ä»£ç†ã€MOSN å’Œ OpenResty æ”¯æŒ proxy-Wasmã€‚\næ­¤å¤–ï¼ŒWasm å¯ä»¥å……å½“é€šç”¨åº”ç”¨ç¨‹åºå®¹å™¨ã€‚å®ƒåœ¨æœåŠ¡ç½‘æ ¼æ•°æ®å¹³é¢ä¸Šçš„åº”ç”¨ä¸ä»…é™äºè¾¹è½¦ä»£ç†ã€‚é™„åŠ åˆ°è¾¹è½¦çš„å¾®æœåŠ¡ä¹Ÿå¯ä»¥è¿è¡Œåœ¨è½»é‡çº§ Wasm è¿è¡Œæ—¶ä¸­ã€‚WasmEdge WebAssembly è¿è¡Œæ—¶æ˜¯ä¸€ä¸ªå®‰å…¨ã€è½»é‡çº§ã€å¿«é€Ÿã€ä¾¿æºå¼å’Œå¤šè¯­è¨€è¿è¡Œæ—¶ï¼ŒKubernetes å¯ä»¥ç›´æ¥å°†å…¶ä½œä¸ºå®¹å™¨è¿›è¡Œç®¡ç†ã€‚åˆ° 2012 å¹´ 12 æœˆï¼ŒWasmEdge è´¡çŒ®è€…ç¤¾åŒºéªŒè¯äº†åŸºäº WasEdge çš„å¾®æœåŠ¡å¯ä»¥ä¸ Dapr å’Œ Linkerd è¾¹è½¦ä¸€åŒå·¥ä½œï¼Œä½œä¸ºå¸¦æœ‰ guest æ“ä½œç³»ç»Ÿå’Œå®Œæ•´è½¯ä»¶å¯¹æˆ˜çš„é‡é‡çº§ Linux å®¹å™¨çš„æ›¿ä»£å“ã€‚ä¸ Linux å®¹å™¨åº”ç”¨ç¨‹åºç›¸æ¯”ï¼ŒWebAssembly å¾®æœåŠ¡æ¶ˆè€—äº† 1% çš„èµ„æºï¼Œå†·å¯åŠ¨æ—¶é—´ä¹Ÿåªç”¨äº† 1%ã€‚\neBPF å’Œ Wasm æ˜¯æœåŠ¡ç½‘æ ¼åº”ç”¨çš„æ–°æ–¹å‘ï¼Œä»¥ä¾¿åœ¨æ•°æ®å¹³é¢ä¸Šå®ç°é«˜æ€§èƒ½ã€‚ä»–ä»¬ä»ç„¶æ˜¯æ–°å…´æŠ€æœ¯ï¼Œä½†å¯èƒ½ä¼šæˆä¸ºå¾®æœåŠ¡ç”Ÿæ€ç³»ç»Ÿ Linux å®¹å™¨çš„æ›¿ä»£å“æˆ–è€…è¡¥å……ã€‚\nå…³äºä½œè€…ï¼š\nVivian Huï¼šVivian æ˜¯äºšæ´²çš„å¼€æºçˆ±å¥½è€…å’Œå¼€å‘äººå‘˜å€¡å¯¼è€…ï¼ŒSecond State çš„äº§å“ç»ç†ã€‚å¥¹éå¸¸å…³å¿ƒé€šè¿‡æ›´å¥½çš„å·¥å…·ã€æ–‡æ¡£å’Œæ•™ç¨‹æ¥æ”¹å–„å¼€å‘äººå‘˜ä½“éªŒå’Œç”Ÿäº§åŠ›ã€‚Vivian åœ¨ WebAssembly.today ä¸Šä¸º WebAssemblyã€Rust å’Œæ— æœåŠ¡å™¨ç¼–å†™æ¯å‘¨æ—¶äº‹é€šè®¯ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-mikhail-nilov-7709020.jpg","permalink":"https://atbug.com/ebpf-wasm-service-mesh/","tags":["Service Mesh","eBPF"],"title":"eBPF å’Œ Wasmï¼šæ¢ç´¢æœåŠ¡ç½‘æ ¼æ•°æ®å¹³é¢çš„æœªæ¥"},{"categories":["ç¬”è®°"],"contents":"è‡ªä»ç”¨ä¸Š m1 çš„ç”µè„‘ï¼Œæœ¬åœ°å¼€å‘ç¯å¢ƒå¶å°”ä¼šé‡åˆ°å…¼å®¹æ€§çš„é—®é¢˜ã€‚æ¯”å¦‚ä¹‹å‰å°è¯•ç”¨ Colima åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œå®¹å™¨è¿è¡Œæ—¶å’Œ Kubernetesï¼Œå…¶å®é™…ä½¿ç”¨çš„è¿˜æ˜¯ aarch64 è™šæ‹Ÿæœºï¼Œå®é™…ä½¿ç”¨è¿˜æ˜¯ä¼šæœ‰äº›å·®å¼‚ã€‚\næ‰‹ä¸Šæœ‰å°ä¹‹å‰ç”¨çš„é»‘è‹¹æœå°ä¸»æœºï¼Œåƒç°å‡ ä¸ªæœˆäº†ï¼Œå®å±æµªè´¹ã€‚æ­£å¥½å…ƒæ—¦å‡æœŸï¼Œæœ‰æ—¶é—´æŠ˜è…¾ä¸€ä¸‹ã€‚\nCPU: Intel 8700 6C12T MEM: 64G DDR4 DISK: 1T SSD æŠ˜è…¾çš„ç›®çš„ï¼š\nå°†å¹³å°è™šæ‹ŸåŒ– æä¾›å¤šå¥—å®éªŒç¯å¢ƒ å¿«é€Ÿåˆ›å»ºé”€æ¯å®éªŒç¯å¢ƒ ä½“éªŒåŸºç¡€è®¾æ–½å³ä»£ç  IaaS ä¸»è¦ç”¨åˆ°çš„å·¥å…·ï¼š\nè™šæ‹ŸåŒ–å·¥å…· Proxmox VE Terraformï¼šå¼€æºçš„åŸºç¡€è®¾æ–½å³ä»£ç å·¥å…· terraform-provider-proxmoxï¼šTerraform Proxmox Providerï¼Œé€šè¿‡ Proxmox VE çš„ REST API åœ¨åˆ›å»ºè™šæ‹Ÿæœºã€‚ å®‰è£… Proxmox è™šæ‹ŸåŒ–å·¥å…· ä»å®˜ç½‘ ä¸‹è½½ ISO é•œåƒï¼Œå†™å…¥åˆ° U ç›˜ä¸­ã€‚macOSä¸Šæ¨èä½¿ç”¨ balenaEtcher å†™ç›˜ã€‚\nç”µè„‘ä¸Šæ’å…¥ U ç›˜å¹¶ä» U ç›˜å¯åŠ¨ï¼ŒæŒ‰ç…§æ­¥éª¤ä¸€æ­¥æ­¥å®Œæˆè®¾ç½®ã€‚\nå®˜æ–¹çš„ wiki å®‰è£…æ­¥éª¤å¾ˆè¯¦ç»†ã€‚\nå®‰è£…å®Œæˆä¹‹åå°±å¯ä»¥åˆ›å»ºè™šæ‹Ÿæœºäº†ï¼Œå¯ä»¥ç”¨å‘½ä»¤è¡Œ qm create æˆ–è€… https://localhost:8006 Web UIæ¥åˆ›å»ºã€‚\nè¿™æ ·æ¯•ç«Ÿè¿˜æ˜¯æœ‰ç‚¹éº»çƒ¦ï¼Œæ¯æ¬¡éƒ½è¦æ‰§è¡Œå¾ˆå¤šæ“ä½œã€‚è™½è¯´å¯ä»¥ç¼–å†™è„šæœ¬ï¼Œä½†æ˜¯é€šç”¨å‹ä¸å¤Ÿå¥½ã€‚å› æ­¤æˆ‘ä»¬é€‰æ‹© Terraformï¼Œå®ç°åŸºç¡€è®¾æ–½å³ä»£ç ã€‚\nåˆ›å»º Ubuntu Cloud-Init Template è¿™é‡Œé€‰ç”¨ Cloud-Init çš„æ–¹å¼ï¼Œä» cloud-init template æ¥å…‹éš†è™šæ‹Ÿæœºã€‚cloud-init çš„è™šæ‹Ÿæœºå¯ä»¥å®Œæˆä¸€äº›é«˜çº§å®šåˆ¶çš„åˆå§‹åŒ–å·¥ä½œï¼Œæœ‰å…´è¶£çš„å‚è€ƒ Cloud Init æ–‡æ¡£ã€‚\nç™»é™†åˆ° Proxmox VE å®¿ä¸»æœºï¼Œä½¿ç”¨ Ubuntu 20.04 cloud init image æ¥åˆ›å»ºæ¨¡æ¿ï¼Œä»å®˜ç½‘ä¸‹è½½ï¼š\nwget https://cloud-images.ubuntu.com/releases/focal/release/ubuntu-20.04-server-cloudimg-amd64.img æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼š\nqm create 9000 --name \u0026#34;ubuntu-2004-cloudinit-template\u0026#34; --memory 1024 --cores 1 --net0 virtio,bridge=vmbr0 qm importdisk 9000 ubuntu-20.04-server-cloudimg-amd64.img local-lvm qm set 9000 --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-9000-disk-0 qm set 9000 --boot c --bootdisk scsi0 qm set 9000 --ide2 local-lvm:cloudinit qm set 9000 --serial0 socket --vga serial0 qm set 9000 --agent enabled=1 å°†åˆšåˆ›å»ºå¥½çš„è™šæ‹Ÿæœºè½¬æ¢æˆæ¨¡æ¿ï¼š\nqm template 9000 æ¨¡æ¿ä¸æ™®é€šçš„è™šæ‹Ÿæœºä¼šæœ‰äº›è®¸çš„ä¸åŒï¼Œä½¿ç”¨æ¨¡æ¿æˆ‘ä»¬å¯ä»¥å¿«é€Ÿåˆ›å»ºè™šæ‹Ÿæœºã€‚è¿™é‡Œæˆ‘ä»¬ä¸ä¼šç”¨ UIæ¥åˆ›å»ºã€‚\nåˆ›å»º Proxmox ç”¨æˆ·åŠ API Token ä½¿ç”¨ Proxmox VE çš„ REST API éœ€è¦æƒé™æ ¡éªŒï¼Œæœ‰ç”¨æˆ·åå¯†ç æˆ–è€… API Token ä¸¤ç§æ–¹å¼ã€‚æˆ‘ä»¬é€‰ç”¨åè€…ï¼Œç™»é™†åˆ° Proxmox å®¿ä¸»æœºï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤åˆ›å»ºè§’è‰²ã€ç”¨æˆ·ä»¥åŠ API Tokenï¼š\npveum role add TerraformProv -privs \u0026#34;VM.Allocate VM.Clone VM.Config.CDROM VM.Config.CPU VM.Config.Cloudinit VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Monitor VM.Audit VM.PowerMgmt Datastore.AllocateSpace Datastore.Audit\u0026#34; pveum user add terraform-prov@pve pveum aclmod / -user terraform-prov@pve -role TerraformProv pveum user token add terraform-prov@pve terraform-token --privsep=0 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ key â”‚ value â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¡ â”‚ full-tokenid â”‚ terraform-prov@pve!terraform-token â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ info â”‚ {\u0026#34;privsep\u0026#34;:\u0026#34;0\u0026#34;} â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ value â”‚ 9748c040-a283-4c72-a48b-9ce784778eed â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ è¿™é‡Œæˆ‘ä»¬ä¼šç”¨åˆ° token çš„full-tokenid å’Œ valueã€‚\nTerraform æœ‰äº† token å’Œ cloud-init æ¨¡æ¿åï¼Œå°±æ˜¯å®šä¹‰è™šæ‹Ÿæœºäº†ã€‚\nå®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ terraformã€‚\nbrew install terraform åœ¨ç©ºç›®å½•ä¸­åˆ›å»º ubuntu.tf æ–‡ä»¶ï¼Œå¹¶æŒ‰æ­¥éª¤è¿›è¡Œé…ç½®ï¼š\né…ç½®è¦ä½¿ç”¨çš„ providerï¼š terraform { required_providers { proxmox = { source = \u0026#34;telmate/proxmox\u0026#34; } } } é…ç½® provider éœ€è¦æä¾› pm_api_urlã€pm_api_token_id å’Œ pm_api_token_secretï¼š\nprovider \u0026#34;proxmox\u0026#34; { pm_tls_insecure = true pm_api_url = \u0026#34;https://192.168.1.4:8006/api2/json\u0026#34; pm_api_token_id = \u0026#34;terraform-prov@pve!terraform-token\u0026#34; pm_api_token_secret = \u0026#34;9748c040-a283-4c72-a48b-9ce784778eed\u0026#34; } é…ç½®è™šæ‹Ÿæœºèµ„æº å¯ä»¥å‚è€ƒprovider çš„é…ç½®è¯´æ˜ï¼š\nresource \u0026#34;proxmox_vm_qemu\u0026#34; \u0026#34;proxmox-ubuntu\u0026#34; { count = 1 name = \u0026#34;ubuntu-${count.index + 1}\u0026#34; desc = \u0026#34;Ubuntu develop environment\u0026#34; # èŠ‚ç‚¹å target_node = \u0026#34;pve\u0026#34; # cloud-init template clone = \u0026#34;ubuntu-2004-cloudinit-template\u0026#34; # å…³æœº guest agent agent = 0 os_type = \u0026#34;ubuntu\u0026#34; onboot = true # CPU cores = 4 sockets = 1 cpu = \u0026#34;host\u0026#34; # å†…å­˜ memory = 16384 scsihw = \u0026#34;virtio-scsi-pci\u0026#34; bootdisk = \u0026#34;scsi0\u0026#34; # ç¡¬ç›˜è®¾ç½®ï¼Œå› è®¡ç®—çš„æ–¹å¼ 101580M ä»£æ›¿ 100G disk { slot = 0 size = \u0026#34;101580M\u0026#34; type = \u0026#34;scsi\u0026#34; storage = \u0026#34;local-lvm\u0026#34; iothread = 1 } # ç½‘ç»œ network { model = \u0026#34;virtio\u0026#34; bridge = \u0026#34;vmbr0\u0026#34; } lifecycle { ignore_changes = [ network, ] } # è®°ä½è¿™é‡Œè¦ä½¿ç”¨IP CIDRã€‚å› ä¸ºåªåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºçš„ IP æ˜¯ 192.168.1.91ã€‚å¦‚æœè¦åˆ›å»ºå¤šä¸ªè™šæ‹Ÿæœºçš„è¯ï¼ŒIP å°†ä¼šæ˜¯ .91ã€.92ã€.93 ã€‚ ipconfig0 = \u0026#34;ip=192.168.1.9${count.index + 1}/24,gw=192.168.1.2\u0026#34; # ç”¨æˆ·åå’Œ SSH key ciuser = \u0026#34;addo\u0026#34; sshkeys = \u0026lt;\u0026lt;EOF SSH KEYS HERE EOF } åˆ›å»ºè™šæ‹Ÿæœº ç¬¬ä¸€æ¬¡éœ€è¦å…ˆæ‰§è¡Œ init å‘½ä»¤è¿›è¡Œåˆå§‹åŒ–ï¼š\nterraform init å¯ä»¥ä½¿ç”¨ terraform fmt å’Œ terraform validate å¯¹é…ç½®æ–‡ä»¶è¿›è¡Œæ ¼å¼åŒ–å’Œæ ¡éªŒã€‚\nç„¶åæ‰§è¡Œ terraform apply å¹¶è¾“å…¥ yes å¼€å§‹åˆ›å»ºè™šæ‹Ÿæœºï¼Œ\nproxmox_vm_qemu.proxmox-ubuntu[0]: Creating... proxmox_vm_qemu.proxmox-ubuntu[0]: Still creating... [10s elapsed] proxmox_vm_qemu.proxmox-ubuntu[0]: Still creating... [20s elapsed] proxmox_vm_qemu.proxmox-ubuntu[0]: Still creating... [30s elapsed] proxmox_vm_qemu.proxmox-ubuntu[0]: Still creating... [40s elapsed] proxmox_vm_qemu.proxmox-ubuntu[0]: Creation complete after 42s [id=pve/qemu/100] è¿™æ ·è™šæ‹Ÿæœºå°±åˆ›å»ºæˆåŠŸäº†ï¼Œä½¿ç”¨å‰é¢é…ç½®çš„ç§é’¥å’Œ IP åœ°å€å°±å¯ä»¥ ssh åˆ°è™šæ‹Ÿæœºä¸­ã€‚\né”€æ¯è™šæ‹Ÿæœº è™šæ‹Ÿæœºçš„é”€æ¯ä¹Ÿå¾ˆç®€å•ï¼Œæ‰§è¡Œ terraform destroy å¹¶è¾“å…¥ yes å³å¯ã€‚\næ€»ç»“ æœ‰äº† Terraform å’Œ Proxmox VE åï¼Œå°±å¯ä»¥æ„‰å¿«çš„ä½¿ç”¨å¹²å‡€çš„å®éªŒç¯å¢ƒäº†ã€‚ä½†æ˜¯å¹²å‡€åˆ°ä¸€äº›å¼€å‘ä¸­å¸¸ç”¨è½¯ä»¶éƒ½æ²¡æœ‰ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿä¸æ–¹ä¾¿ã€‚\nåç»­è€ƒè™‘é€šè¿‡ cloud-init æ¥å¯¹è™šæ‹Ÿæœºè¿›è¡Œé«˜çº§å®šåˆ¶ï¼Œæ¯”å¦‚å®¹å™¨ç¯å¢ƒå’Œ K3s ç­‰ç­‰ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-tatiana-syrikova-3933258.jpg","permalink":"https://atbug.com/deploy-vm-on-proxmox-with-terraform/","tags":["IaaS","Tool"],"title":"å¿«é€Ÿæ­å»ºå®éªŒç¯å¢ƒï¼šä½¿ç”¨ Terraform éƒ¨ç½² Proxmox è™šæ‹Ÿæœº"},{"categories":["ç”Ÿæ´»"],"contents":"æ²¡é”™ï¼Œè¿™æ˜¯ä¸€ç¯‡ 2021 å¹´çš„ç›˜ç‚¹ã€‚\n2021 å¹´é©¬ä¸Šç»“æŸï¼Œç¿»çœ‹å¹•å¸ƒï¼Œçœ‹åˆ°äº†å¹´åˆç»™è‡ªå·±å®šä¸‹çš„ç›®æ ‡ã€‚è®°æ€§ä¸å¥½ï¼Œå¥½åƒæŠŠè¿™ä¸ªäº‹æƒ…ç»™å¿˜è®°äº†ã€‚\nå·¥ä½œ å·¥ä½œè¿™ä¹ˆå¤šå¹´ï¼Œå·²ç„¶è·¨è¿‡çš„ 35 å²è¿™ä¸ªåã€‚æ²¡æœ‰æƒ³è±¡ä¸­çš„å›°éš¾ï¼Œå”¯æœ‰ä¸€è·¯çš„åšæŒã€‚\nèŒä¸šç”Ÿæ¶¯ è‡ªå·±ä¸€ç›´åšæŒèµ°æŠ€æœ¯è·¯çº¿ï¼Œä¸æ„¿èµ°ä¸Šç®¡ç†è¿™æ¡è·¯ã€‚å°±åƒæœ‰äº›äº‹æƒ…ï¼Œä¸æ˜¯ä¸ä¼šä¹Ÿä¸æ˜¯ä¸èƒ½ï¼Œè€Œæ˜¯ä¸æ„¿ã€‚å¯èƒ½æ˜¯è‡ªå·±æ€§æ ¼ä½¿ç„¶ï¼Œä¹Ÿå”¯æœ‰æŠ€æœ¯ä¸€æ¡è·¯å¯èµ°ï¼Œæ‰€ä»¥åªæœ‰åšæŒï¼Œå°¤å…¶æ˜¯è‡ªå·±ä¹Ÿå–œæ¬¢æææŠ€æœ¯ã€‚\nè¿‡å»çš„è‡ªå·±åŸ‹å¤´å†™ä»£ç ã€å­¦ä¹ ï¼Œé²œæœ‰ä¸å¤–ç•Œçš„æ²Ÿé€šã€‚æ­£å¥½å€Ÿç€å»å¹´å·¥ä½œçš„äº‹æƒ…èµ°å‡ºå»ï¼Œå‚ä¸ç¤¾åŒºã€‚è§è¯†åˆ°äº†æŠ€æœ¯äººçš„ç®€å•ç›´æ¥ï¼Œä¹Ÿç»“äº¤åˆ°äº†å¿—åŒé“åˆçš„æœ‹å‹ã€‚\næ­£èŒ å¹´åˆå¤ªå¤ªè·Ÿæˆ‘è¯´ï¼Œæœ¬å‘½å¹´å°‘æŠ˜è…¾ï¼Œå·¥ä½œç¨³å®šç‚¹å°±è¡Œï¼Œä¸æ±‚å…¶ä»–ã€‚ä½†è¿˜æ˜¯åœ¨å¹´ä¸­çš„æ—¶å€™æ¢äº†å·¥ä½œï¼Œæ„Ÿè°¢ä¸Šå®¶å…¬å¸çš„å„ç§ç»å†è®©è‡ªå·±æˆé•¿å¾ˆå¤šï¼Œä¸å¿—åŒé“åˆçš„äººä¸€èµ·åšäº›æœ‰è¶£çš„äº‹æƒ…ã€‚\næœ‰å¹¸åŠ å…¥åˆ°ç°åœ¨çš„å…¬å¸ï¼Œè®¤è¯†åˆ°ä¸€ç¾¤æ›´ç®€å•çš„äººï¼šç®€å•çš„ä¸Šå¸ã€ç®€å•çš„åŒäº‹ï¼Œç®€å•åœ°åšç€ä¸ç®€å•çš„äº‹æƒ…ã€‚çŸ­çŸ­å‡ ä¸ªæœˆï¼Œè‡ªå·±å­¦ä¹ äº†å¾ˆå¤šã€‚è¿™ä¹Ÿæ­£æ˜¯æˆ‘æƒ³è¦çš„ï¼šæœ‰æœºä¼šä¸æ–­åœ°å­¦ä¹ å’ŒæŒ‘æˆ˜ã€‚\nç°åœ¨çš„å…¬å¸æ˜¯è¿œç¨‹åŠå…¬çš„æ¨¡å¼ï¼Œè‡ªå·±æŒæ§å·¥ä½œçš„æ—¶é—´ï¼Œä¸å®¶äººç›¸å¤„çš„æ—¶é—´ä¹Ÿå¤šäº†ï¼ˆè™½ç„¶å¾ˆå¤šæ—¶é—´ä¹Ÿæ˜¯åœ¨å·¥ä½œï¼‰ã€‚åˆšå¼€å§‹è¿˜ä¼šæœ‰äº›æ–°é²œï¼Œæ…¢æ…¢åœ°å·¥ä½œå’Œç”Ÿæ´»çš„ç•Œé™è¶Šæ¥è¶Šæ¨¡ç³Šã€‚ä¸è¿‡æ—¢ç„¶æ„è¯†åˆ°é—®é¢˜ï¼Œå¯ä»¥æ…¢æ…¢çš„è°ƒæ•´ã€‚\nå­¦ä¹  ä¹¦çœ‹çš„ä¸å¤šï¼Œä»…ä»…å‡ æœ¬ã€‚ä½†æ”¶ç›Šè‰¯å¤šï¼Œæ¯”å¦‚ã€Šå¾®ä¹ æƒ¯ã€‹ã€ã€Šæ·±åº¦å·¥ä½œã€‹ã€ã€Šé£è½®æ•ˆåº”ã€‹è¿˜æ˜¯æ¯”è¾ƒæ¨èã€‚å‡†å¤‡æœ‰æ—¶é—´é‡è¯»ã€Šæ·±åº¦å·¥ä½œã€‹ï¼Œé…åˆç°åœ¨çš„è¿œç¨‹å·¥ä½œæ„Ÿè§‰ä¼šæ›´é€‚åˆå®æ–½ã€‚\næŠ€æœ¯æ–¹é¢åˆ™æ˜¯å¼€æ‹“çŸ¥è¯†é¢ï¼Œå…³æ³¨ä¸€äº›æŠ€æœ¯åšå®¢ã€ç½‘ç«™ã€‚å°¤å…¶æ˜¯ 3 æœˆåº•å¼€å§‹å†³å®šå¥½å¥½æ›´æ–°å…¬ä¼—å·ã€‚å…¶å®ä¹‹å‰æ–­æ–­ç»­ç»­æœ‰åœ¨å†™åšå®¢ï¼Œå¹³æ—¶å·¥ä½œä¹Ÿéƒ½è®°ç¬”è®°çš„ä¹ æƒ¯ã€‚æœ¬æ¥æƒ³çš„å¥½ï¼Œå°†ç¬”è®°å¥½å¥½æ•´ç†ä¸€ä¸‹å‘åœ¨å…¬ä¼—å·ä¸Šã€‚\nä½†å®é™…ä¸Šæ‰‹æ‰ä¼šå‘ç°ï¼Œæœ‰æ—¶å†™ä¸€ç¯‡æ–‡ç« ä¸ç®¡æ˜¯ç¿»è¯‘ï¼Œè¿˜æ˜¯æŠ€æœ¯æ¢ç´¢ç±»çš„éƒ½ä¼šç”¨ä¸Šå‡ ä¸ªå°æ—¶çš„æ—¶é—´ã€‚æ¯”å¦‚ç”»ä¸ªå¤æ‚ç‚¹çš„å›¾ï¼Œä¹Ÿå¥½è€—è´¹å‡ ååˆ†é’Ÿä¸€ä¸ªå°æ—¶ã€‚å‡ ä¸ªå°æ—¶çš„æˆå—æ—¶é—´ï¼Œå¯¹äºå·¥ä½œçš„äººæ¥è¯´å¤ªè¿‡å®è´µã€‚\nåˆ°ä»Šå¤©åº”è¯¥æœ‰å‘è¿‡ 50 å¤šç¯‡ï¼ˆå…¶ä¸­ 8ã€9 æœˆä»½åˆšæ¥è§¦æ–°å·¥ä½œï¼Œå†™çš„ç¡®å®å°‘ï¼‰ï¼Œä¹Ÿç®—æ˜¯æ²¡æœ‰æ‰“è„¸ï¼Œå¦‚ä»Šä¹Ÿæœ‰äº†1000 å¤šçš„å…³æ³¨ã€‚è™½ç„¶å†™äº†è¿™ä¹ˆå¤šï¼Œä½†æ˜¯å›å¤´çœ‹ä¸‹ï¼Œæœ‰ç‚¹ç¹æ‚ï¼Œä¸å¤Ÿç³»ç»Ÿã€‚\nè¿˜æœ‰é¡ºæ‰‹å®Œæˆäº† CKA çš„è€ƒè¯•ã€‚\nç”Ÿæ´» æˆ‘å°†ç”Ÿæ´»æ”¾åˆ°äº†æœ€åï¼Œä¸æ˜¯è¯´ä¸é‡è§†ç”Ÿæ´»ï¼Œè€Œæ˜¯å¸Œæœ›ç”Ÿæ´»å¹³å¹³æ·¡æ·¡å°±å¥½ã€‚\nå®¶äººåœ¨å·¥ä½œå’Œç”Ÿæ´»ä¸Šæ€»æ˜¯ç»™äºˆæˆ‘è«å¤§çš„æ”¯æŒï¼Œæ„Ÿè°¢ä»–ä»¬çš„ä»˜å‡ºã€‚\nç”µå­äº§å“è™½ç„¶ä¹Ÿæœ‰åœ¨ç©ï¼Œä½†æ˜¯ç©çš„å°‘äº†ã€‚åŸºæœ¬å°±æ˜¯ä¹°ä¹°ä¹°ã€å–å–å–çš„èŠ‚å¥ï¼Œæ²¡æœ‰å¤ªå¤šçš„æ—¶é—´æŠ•å…¥åœ¨ä¸Šé¢ã€‚\nä¹Ÿå› ä¸ºæ¢å·¥ä½œçš„é—´éš™ï¼Œæ‰æœ‰äº†åŒ—ç–†ä¹‹è¡Œï¼Œæœ‰å¹¸é¢†ç•¥äº†åŒ—ç–†çš„é£å…‰ã€‚å¸Œæœ›æœ‰æœºä¼šå†èµ°ä¼Šæ˜­å’Œç‹¬åº“ã€‚\nä¸´è¿‘å¹´åº•ï¼Œä¹Ÿä¸‹å®šå†³å¿ƒäº†ç»“ä¸€ä»¶å¿ƒäº‹ï¼ŒåŠå¹´åå†çœ‹ã€‚\næ€»ç»“ æƒ³æƒ³è¿‡å»ä¸€å¹´å‘ç”Ÿçš„ç§ç§ï¼Œæœ‰äº‹ä¸æ„¿è¿ã€æœ‰æ„æ–™ä¹‹å¤–ã€è¿˜æœ‰æŸ³æš—èŠ±æ˜ã€‚\nè¿™è®©æˆ‘æƒ³èµ·é˜¿ç”˜æ­£ä¼ é‡Œé‚£ä¸€æ®µï¼šäººç”Ÿå°±åƒä¸€ç›’å„å¼å„æ ·çš„å·§å…‹åŠ›ï¼Œä½ æ°¸è¿œä¸çŸ¥é“ä¸‹ä¸€å—å°†ä¼šæ˜¯å“ªç§ã€‚\näººç”Ÿæœ€éš¾å¾—å¯ä»¥åšè‡ªå·±å–œæ¬¢çš„äº‹æƒ…ï¼Œè¿½æ±‚è‡ªå·±å–œæ¬¢çš„äº‹ç‰©ã€‚è™½åŠ›æœ‰æœªé€®ï¼Œä½†ä»å¯ä¸ºä¹‹è€ŒåŠªåŠ›ã€‚\nâ€œå›ä¹‹èœœç³–ï¼Œå¾ä¹‹ç ’éœœâ€ï¼Œé€‰æ‹©è‡ªå·±å–œæ¬¢å°±å¥½ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/farewell-2021/","tags":["ç”Ÿæ´»"],"title":"å†è§ï¼Œ2021"},{"categories":["ç¬”è®°"],"contents":"Colima æ˜¯ä¸€ä¸ªä»¥æœ€å°åŒ–è®¾ç½®æ¥åœ¨MacOSä¸Šè¿è¡Œå®¹å™¨è¿è¡Œæ—¶å’Œ Kubernetes çš„å·¥å…·ã€‚æ”¯æŒ m1ï¼ˆæ–‡æœ«è®¨è®ºï¼‰ï¼ŒåŒæ ·ä¹Ÿæ”¯æŒ Linuxã€‚\nColima çš„åå­—å–è‡ª Container on Limaã€‚Lima æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºå·¥å…·ï¼Œå¯ä»¥å®ç°è‡ªåŠ¨çš„æ–‡ä»¶å…±äº«ã€ç«¯å£è½¬å‘ä»¥åŠ containerdã€‚\nColima å®é™…ä¸Šæ˜¯é€šè¿‡ Lima å¯åŠ¨äº†åä¸º colima çš„è™šæ‹Ÿæœºï¼Œä½¿ç”¨è™šæ‹Ÿæœºä¸­çš„ containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ã€‚\nä½¿ç”¨ Colima çš„ä½¿ç”¨å¾ˆç®€å•ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥åˆ›å»ºè™šæ‹Ÿæœºï¼Œé»˜è®¤æ˜¯ Docker çš„è¿è¡Œæ—¶ã€‚\nåˆæ¬¡è¿è¡Œéœ€è¦ä¸‹è½½è™šæ‹Ÿæœºé•œåƒåˆ›å»ºè™šæ‹Ÿæœºï¼Œè€—æ—¶å› ç½‘ç»œæƒ…å†µæœ‰æ‰€å·®å¼‚ã€‚ä¹‹åï¼Œå¯åŠ¨è™šæ‹Ÿæœºå°±åªéœ€è¦ 30s å·¦å³çš„æ—¶é—´ã€‚\ncolima start INFO[0000] starting colima INFO[0000] creating and starting ... context=vm INFO[0119] provisioning ... context=docker INFO[0119] provisioning in VM ... context=docker INFO[0133] restarting VM to complete setup ... context=docker INFO[0133] stopping ... context=vm INFO[0136] starting ... context=vm INFO[0158] starting ... context=docker INFO[0159] done æ­¤æ—¶ï¼Œåœ¨å®¿ä¸»æœºä¸Šå°±å¯ä»¥ä½¿ç”¨ Docker ç›¸å…³çš„å‘½ä»¤äº†ï¼š\ndocker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES docker pull busybox docker images REPOSITORY TAG IMAGE ID CREATED SIZE busybox latest b34806a1af7a 2 weeks ago 1.41MB ä¹Ÿå¯ä»¥ä½¿ç”¨ Lima çš„å‘½ä»¤è¡Œ limactå·¥å…·æŸ¥çœ‹è™šæ‹Ÿæœºçš„æƒ…å†µï¼š\nlimactl list NAME STATUS SSH ARCH CPUS MEMORY DISK DIR colima Running 127.0.0.1:64505 aarch64 2 2GiB 60GiB /Users/addo/.lima/colima æŸ¥çœ‹æ“ä½œç³»ç»Ÿä¿¡æ¯ï¼š\nuname -a Darwin Addos-Macbook-Pro.local 21.2.0 Darwin Kernel Version 21.2.0: Sun Nov 28 20:28:41 PST 2021; root:xnu-8019.61.5~1/RELEASE_ARM64_T6000 arm64 limactl shell colima uname -a Linux lima-colima 5.13.0-22-generic #22-Ubuntu SMP Fri Nov 5 13:22:27 UTC 2021 aarch64 aarch64 aarch64 GNU/Linux æˆ–è€…ä½¿ç”¨ Colima çš„ ssh å‘½ä»¤è¿›å…¥è™šæ‹Ÿæœºï¼š\n# on host colima ssh # in vm uname -a Linux lima-colima 5.13.0-22-generic #22-Ubuntu SMP Fri Nov 5 13:22:27 UTC 2021 aarch64 aarch64 aarch64 GNU/Linux å…¶ä»–è¿è¡Œæ—¶ ä¹Ÿå¯ä»¥åœ¨åˆ›å»ºçš„æ—¶å€™é€šè¿‡ --runtime containerd å‚æ•°æŒ‡å®šä½¿ç”¨ Containerd ä½œä¸ºè¿è¡Œæ—¶ã€‚æ­¤æ—¶å°±éœ€è¦ä½¿ç”¨ colima nerdctl æ¥ä½¿ç”¨ nerdctl ä¸ Containerd è¿›è¡Œäº¤äº’ã€‚\ncolima start --runtime containerd åŒæ ·ï¼Œè¿˜å¯ä»¥åˆ›å»ºä¸€ä¸ª k3s ä½œä¸º Kubernetes è¿è¡Œæ—¶ï¼š\ncolima start --with-kubernetes Demo æˆ‘ä»¬å°è¯•å¯åŠ¨ä¸€ä¸ª nginx å®¹å™¨ï¼š\ndocker run --rm -d --name nginx -p 8080:80 nginx:latest docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 20d6c56e038b nginx:latest \u0026#34;/docker-entrypoint.â€¦\u0026#34; 9 seconds ago Up 8 seconds 0.0.0.0:8080-\u0026gt;80/tcp, :::8080-\u0026gt;80/tcp nginx Colima ä¼šè‡ªåŠ¨é…ç½®ç«¯å£è½¬å‘ï¼š\ncurl -I http://localhost:8080 HTTP/1.1 200 OK Server: nginx/1.21.4 Date: Sun, 26 Dec 2021 04:17:22 GMT Content-Type: text/html Content-Length: 615 Last-Modified: Tue, 02 Nov 2021 14:49:22 GMT Connection: keep-alive ETag: \u0026#34;61814ff2-267\u0026#34; Accept-Ranges: bytes è™šæ‹Ÿæœºé…ç½® Colima å¯åŠ¨çš„è™šæ‹Ÿæœºé»˜è®¤æ˜¯ 2CPUã€2GiB å†…å­˜ å’Œ 60GiB å­˜å‚¨ã€‚å¯ä»¥åœ¨åˆ›å»ºæ—¶é€šè¿‡ --cpu ã€--memory å’Œ --disk æ¥åˆ†é…æ›´å¤šèµ„æºã€‚\ncolima start --cpu 4 --memory 16 ä¹Ÿå¯ä»¥ä¿®æ”¹å½“å‰è™šæ‹Ÿæœºçš„é…ç½®ï¼š\ncolima stop colima start --cpu 4 --memory 16 åŒç±»å·¥å…·æ¯”è¾ƒ å…¶å®æœ‰ä¸å°‘ç±»ä¼¼çš„å·¥å…·ï¼Œæ¯”å¦‚ kindã€k3d å’Œ minikube ä¸‰ç§éƒ½æ˜¯ç”¨æ¥åˆ›å»º Kubernetes ç¯å¢ƒã€‚æˆ‘ä¸ªäººæ­¤å‰ç”¨çš„ k3d å°±æ¯”è¾ƒå¤šã€‚\nå¯¹äº Docker å®¹å™¨ç¯å¢ƒï¼Œè¿™ä¸‰ä¸ªå…¶å®éƒ½æ²¡æœ‰æä¾›ã€‚minikube çš„è™šæ‹Ÿæœºä¸­ä¹Ÿæœ‰å®¹å™¨è¿è¡Œæ—¶ï¼Œä½†æ˜¯æ— æ³•å•çº¯å®‰è£… Docker ç¯å¢ƒã€‚\nå¯¹äº Kubernetes ç¯å¢ƒæ¥è¯´ï¼Œè¿™å‡ ç§éƒ½é€‚åˆï¼Œç›¸æ¯” Colima æ¥è¯´è¿˜æ”¯æŒåˆ›å»ºå¤šä¸ªé›†ç¾¤ï¼ˆå½“å‰ Colima æœ€æ–°ç‰ˆæœ¬æ˜¯ 0.2.2ï¼Œå¤šé›†ç¾¤çš„æ”¯æŒä¹Ÿåœ¨å¼€å‘ä¸­ã€‚ä¼°è®¡ 0.3.0 ä¼šæä¾›ï¼Œæ¯•ç«Ÿåˆ›å»ºå¤šä¸ªè™šæ‹Ÿæœºå°±èƒ½å®ç°ï¼‰ã€‚ä½†ä½¿ç”¨ Colima çš„è¯ï¼ŒKubernetes å’Œ Docker å¯ä»¥å…±äº«é•œåƒï¼ˆæœ¬åœ°é•œåƒï¼‰å’Œè¿è¡Œæ—¶ã€‚\nä¸è¶³ å¤šé›†ç¾¤çš„æ”¯æŒ å‰é¢æåˆ°ï¼Œç›®å‰è¿˜ä¸æ”¯æŒåˆ›å»ºå¤šä¸ª Kubernetes é›†ç¾¤ï¼Œä¼°è®¡ 0.3.0 ä¼šæä¾›ã€‚\nm1 çš„æ”¯æŒ è¿™é‡Œè¿˜æ˜¯è¦è¯´ä¸‹ m1ï¼Œæˆ‘ç°åœ¨ä¸»è¦ç”¨ m1 çš„ç”µè„‘ï¼Œæœ¬åœ°çš„å®¹å™¨è¿è¡Œæ—¶ç”¨çš„ Docker Desktopã€‚\nå‰é¢æˆ‘ä»¬æœ‰ç•™æ„åˆ°è™šæ‹Ÿæœºä½¿ç”¨çš„æ˜¯ aarch64 æ¶æ„ç³»ç»Ÿï¼Œå¯¹äºæŸäº›ä¸æ”¯æŒ arm64 çš„é•œåƒè¿˜æ˜¯æ— æ³•è¿è¡Œã€‚æ¯•ç«Ÿ Lima æ˜¯åŸç”Ÿæ”¯æŒ m1ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ Rosetta è½¬è¯‘çš„ Docker Desktopã€‚\næœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å°è¯•ç”¨ Rosetta è½¬è¯‘ Limaã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/containers-runtime-on-macos-with-colima/","tags":["Kubernetes","Docker","macOS"],"title":"Colimaï¼šMacOS ä¸Šçš„æç®€å®¹å™¨è¿è¡Œæ—¶å’Œ Kubernetesï¼ˆæ”¯æŒ m1ï¼‰"},{"categories":["ç¿»è¯‘"],"contents":"è¯‘è€…æ³¨ï¼š æœ¬æ–‡ç¯‡å¹…è¾ƒé•¿ï¼Œæœ‰åŠ©äºäº†è§£ FaaS å’Œ OpenFaaSã€‚ä½œè€…åˆ†åˆ«ä»å¼€å‘äººå‘˜å’Œè¿ç»´äººå‘˜çš„è§†è§’æ¥äº†è§£ OpenFaaSï¼Œå¯¹äº†è§£æ–°çš„æŠ€æœ¯æ˜¯ä¸ªå¾ˆå¥½çš„æ–¹å¼ã€‚\næœ¬æ–‡ç¿»è¯‘è‡ª Ivan Velichko çš„ OpenFaaS - Run Containerized Functions On Your Own Termsã€‚\né•¿æœŸä»¥æ¥ï¼Œæ— æœåŠ¡å™¨ï¼ˆserverlessï¼‰ å¯¹æˆ‘æ¥è¯´æ— éå°±æ˜¯ AWS Lambda çš„ä»£åè¯ã€‚Lambda æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„é€”å¾„ï¼Œå¯ä»¥å°†ä»»æ„ä»£ç é™„åŠ åˆ°å¹³å°äº‹ä»¶ï¼ˆäº‘å®ä¾‹çš„çŠ¶æ€å˜æ›´ã€DynamoDB è®°å½•çš„æ›´æ–°æˆ–æ–°çš„ SNS æ¶ˆæ¯ï¼‰ä¸­ã€‚ä½†æ˜¯ï¼Œæˆ‘æ—¶ä¸æ—¶ä¼šæƒ³åˆ°æŸä¸ªé€»è¾‘ï¼Œä½†å…¶åˆæ²¡å¤§åˆ°è¶³ä»¥æœ‰è‡ªå·±çš„æœåŠ¡ï¼ŒåŒæ—¶æœ‰ä¸é€‚åˆä»»ä½•ç°æœ‰æœåŠ¡çš„èŒƒå›´ã€‚å› æ­¤ï¼Œæˆ‘ç»å¸¸å°†å…¶æ”¾å…¥å‡½æ•°ä¸­ï¼Œä»¥ä¾¿æ—¥åä½¿ç”¨ CLI å‘½ä»¤æˆ–è€… HTTP è°ƒç”¨æ¥è°ƒç”¨å®ƒã€‚\nå‡ å¹´å‰ï¼Œæˆ‘æ¥å¼€äº† AWSï¼Œè‡ªé‚£ä»¥åï¼Œæˆ‘ä¸€ç›´æ€€å¿µéƒ¨ç½²æ— æœåŠ¡å™¨åŠŸèƒ½çš„ä¾¿åˆ©æ€§ã€‚å› æ­¤ï¼Œå½“æˆ‘å¾—çŸ¥ OpenFaaS é¡¹ç›®æ—¶æƒŠå–œä¸‡åˆ†ã€‚å®ƒå°†åœ¨ Kubernetes é›†ç¾¤ä¸Šéƒ¨ç½²å‡½æ•°å˜å¾—ç®€å•ï¼Œç”šè‡³ä»…éœ€è¦ Containerd å°±å¯ä»¥éƒ¨ç½²åˆ°è™šæ‹Ÿæœºä¸Šã€‚\næœ‰å…´è¶£ï¼Ÿé‚£ä¹ˆç»§ç»­ï¼\næ— æœåŠ¡å™¨ä¸ FaaS æ— æœåŠ¡å™¨ å·²æˆä¸ºä¸€ä¸ªæµè¡Œè¯ï¼Œç›®å‰å…¶å®é™…å«ä¹‰æ‰”ä¸å¤Ÿæ¸…æ™°ã€‚\nè®¸å¤šç°ä»£å¹³å°è¢«è§†ä¸º æ— æœåŠ¡å™¨ å¹³å°ã€‚åœ¨ AWS Fargate æˆ– GCP Cloud Run ä¸Šéƒ¨ç½²å®¹å™¨åŒ–æœåŠ¡ï¼Ÿæ— æœåŠ¡å™¨ï¼åœ¨ Heroku ä¸Šè¿è¡Œåº”ç”¨ç¨‹åºï¼Ÿä¹Ÿå¯èƒ½æ˜¯æ— æœåŠ¡å™¨çš„ã€‚\nåŒæ—¶ï¼Œæˆ‘æ›´å–œæ¬¢å°† FaaS è§†ä¸ºä¸€ç§å…·ä½“çš„è®¾è®¡æ¨¡å¼ã€‚æŒ‰ç…§ FaaS èŒƒå¼ï¼Œå¯ä»¥éƒ¨ç½²ä»£ç ç‰‡æ®µï¼ˆå“åº”æŸäº›å¤–éƒ¨æ—¶é—´æ‰§è¡Œçš„å‡½æ•°ï¼‰ã€‚è¿™äº›å‡½æ•°ä¸äº‹ä»¶é©±åŠ¨ç¨‹åºä¸­çš„å›è°ƒç±»ä¼¼ï¼Œä½†æ˜¯æ˜¯è¿è¡Œåœ¨å…¶ä»–äººçš„çš„æœåŠ¡å™¨ä¸Šã€‚ç”±äºæ“ä½œçš„æ˜¯å‡½æ•°è€Œä¸æ˜¯æœåŠ¡å™¨ï¼Œé¡¾åæ€ä¹‰ FaaS æ˜¯æ— æœåŠ¡å™¨çš„ã€‚\nsource\nOpenFaaS é¡¹ç›®æ—¨åœ¨å°† Kubernetes é›†ç¾¤æˆ–è€…ç‹¬ç«‹çš„è™šæ‹Ÿæœºç­‰ä½çº§åŸºç¡€è®¾æ–½è½¬åŒ–ä¸ºç®¡ç†æ— æœåŠ¡å™¨å‡½æ•°çš„é«˜çº§å¹³å°ã€‚\nç«™åœ¨å¼€å‘äººå‘˜çš„è§’åº¦ï¼Œè¿™æ ·ä¸€ä¸ªå¹³å°çœ‹èµ·æ¥æ˜¯çœŸçš„æ— æœåŠ¡å™¨çš„ \u0026ndash; ä½ åªéœ€è¦çŸ¥é“ç‰¹å®šçš„ CLI/UI/API æ¥å¤„ç† å‡½æ•° æŠ½è±¡ã€‚ä½†ç«™åœ¨è¿ç»´çš„è§’åº¦ï¼Œéœ€è¦äº†è§£ OpenFaaS å¦‚ä½•ä½¿ç”¨ æœåŠ¡å™¨ æ¥è¿è¡Œè¿™äº›å‡½æ•°ã€‚\nå°±æˆ‘è€Œè¨€ï¼Œæˆ‘ç»å¸¸æ—¢æ˜¯å¼€å‘åˆæ˜¯è¿ç»´ï¼Œä¸‹é¢æˆ‘å°†å°è¯•ä»äºŒè€…å±•å¼€è¯´æ˜ã€‚ç„¶è€Œï¼Œæˆ‘è®¤ä¸ºåœ¨è¯„ä¼° UX æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æ˜ç¡®åŒºåˆ†å®ƒä»¬ã€‚\nå¼€å‘äººå‘˜çœ¼ä¸­çš„ OpenFaaS OpenFaaS åˆ›å»ºäº 2016 å¹´ï¼Œç°åœ¨ç½‘ä¸Šä¹Ÿæœ‰å¤§é‡çš„æ•™ç¨‹ã€‚è¿™é‡Œä¸ä¼šé‡å¤ä»‹ç»ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥äº†è§£ï¼š\nHow to deploy OpenFaaS Create Functions Build Functions Writing a Node.js function - step-by-step guide ç›¸åï¼Œæˆ‘å°†æè¿°æˆ‘æ‰€ç†è§£çš„ OpenFaaSã€‚æˆ‘å¸Œæœ›æœ‰åŠ©äºä¸€äº›éœ€è¦è¯„ä¼°è¯¥æŠ€æœ¯æ˜¯å¦è§£å†³å…¶é—®é¢˜çš„äººï¼Œä»¥åŠé‚£äº›å¸Œæœ›æ›´æœ‰æ•ˆåœ°ä½¿ç”¨è¯¥æŠ€æœ¯çš„äººã€‚\nå‡½æ•°è¿è¡Œæ—¶ åœ¨è¿›å…¥æ­£å¼ç¼–ç ä¹‹å‰ï¼Œæœ‰å¿…è¦äº†è§£ä¸‹å…¶æœªæ¥çš„æ‰§è¡Œç¯å¢ƒï¼ˆåˆåè¿è¡Œæ—¶ï¼‰ã€‚æˆ–è€…ï¼Œç®€å•è¯´ï¼š\nå¦‚ä½•å¯åŠ¨å‡½æ•° å¦‚ä½•ç»„ç»‡ I/O æ“ä½œ å¦‚ä½•é‡ç½® / ç»ˆæ­¢å‡½æ•° å¦‚ä½•éš”ç¦»å‡½æ•°å’Œè°ƒç”¨ OpenFaaS è‡ªå¸¦å¤šä¸ªè¿è¡Œæ—¶æ¨¡å¼ï¼Œè¿™äº›æ¨¡å¼é’ˆå¯¹ä¸åŒçš„åœºæ™¯å®šåˆ¶ã€‚å› æ­¤ï¼Œä¸åŒçš„åœºæ™¯ä¸‹ä¸Šè¿°é—®é¢˜çš„ç­”æ¡ˆä¼šç•¥æœ‰ä¸åŒã€‚\nOpenFaaS å‡½æ•°åœ¨å®¹å™¨ä¸­è¿è¡Œï¼Œå¹¶ä¸”æ¯ä¸ªå®¹å™¨å¿…é¡»éµå®ˆç®€å•çš„çº¦å®š ï¼šå®ƒä½œä¸ºç›‘å¬åœ¨é¢„è®¾ç«¯å£ï¼ˆé»˜è®¤ä¸º 8080ï¼‰ä¸Šçš„ HTTP æœåŠ¡å™¨ï¼Œä¸´æ—¶å­˜å‚¨å¹¶ä¸”æ˜¯æ— çŠ¶æ€çš„ã€‚\nç„¶è€Œï¼ŒOpenFaaS é€šè¿‡ å‡½æ•° watchdogï¼ˆè¯‘è€…æ³¨ï¼šwatchdog ä¸åšç¿»è¯‘ï¼‰æ¨¡å¼é¿å…äº†ç”¨æˆ·ç¼–å†™æ­¤ç±»æœåŠ¡å™¨ã€‚å‡½æ•° watchdog æ˜¯ä¸€ç§è½»é‡çº§ HTTP æœåŠ¡å™¨ï¼Œå¯ä»¥æ„ŸçŸ¥å¦‚ä½•æ‰§è¡Œå®é™…å‡½æ•°ä¸šåŠ¡é€»è¾‘ã€‚å› æ­¤ï¼Œå®‰è£…åœ¨å®¹å™¨ä¸­çš„æ‰€æœ‰å†…å®¹åŠ ä¸Šä½œä¸ºå…¥å£ç‚¹çš„ watchdogï¼Œå°±æ„æˆäº†å‡½æ•°çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚\nç»å…¸ watchdog ä»æœ€ç®€å•çš„å¼€å§‹ï¼Œæˆ–è€…åˆæ˜¯è¢«ç§°ä¸ºç»å…¸ watchdogï¼š\nè¿™ç§æ¨¡å¼ä¸‹ï¼Œwatchdog å¯åŠ¨äº†ç›‘å¬åœ¨ 8080 ç«¯å£çš„è½»é‡çº§ HTTP æœåŠ¡å™¨ï¼Œæ¯ä¸ªè¿›æ¥çš„è¯·æ±‚éƒ½ä¼šï¼š\nè¯»å–è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“ fork æˆ–è€… exec åŒ…å«å®é™…å‡½æ•°çš„å¯æ‰§è¡Œæ–‡ä»¶ å°†è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“å†™å…¥åˆ°å‡½æ•°è¿›ç¨‹çš„ stdin ç­‰å¾…å‡½æ•°è¿›ç¨‹çš„é€€å‡ºï¼ˆæˆ–è€…è¶…å¸‚ï¼‰ è¯»å–å‡½æ•°è¿›ç¨‹çš„ stdout å’Œ stderr åœ¨ HTTP å“åº”ä¸­å°†å»è¯»çš„å­—èŠ‚å‘é€å›è°ƒç”¨æ–¹ ä¸Šè¿°é€»è¾‘ç±»ä¼¼äºä¼ ç»Ÿçš„ é€šç”¨ç½‘å…³æ¥å£ï¼ˆCGIï¼‰ã€‚ä¸€æ–¹é¢ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨éƒ½å¯åŠ¨å•ç‹¬çš„è¿›ç¨‹çœ‹èµ·æ¥ä¸å¤Ÿé«˜æ•ˆï¼Œè€Œå¦ä¸€æ–¹é¢ï¼Œå®ƒç¡®å®è¶…çº§æ–¹ä¾¿ï¼Œå› ä¸º ä»»ä½•ä½¿ç”¨ stdio æµè¿›è¡Œ I/O å¤„ç†çš„ç¨‹åºï¼ˆåŒ…æ‹¬æœ€å–œæ¬¢çš„ CLI å·¥å…·ï¼‰éƒ½å¯ä»¥éƒ¨ç½²ä¸º OpenFaaS å‡½æ•°ã€‚\næèµ·éš”ç¦»ï¼Œæˆ‘ä»¬æœ‰å¿…è¦åŒºåˆ†ä¸‹å‡½æ•°å’Œè°ƒç”¨ï¼š\nOpenFaaS ä¸­çš„ä¸åŒå‡½æ•°å§‹ç»ˆåˆ†å¸ƒåœ¨ä¸åŒçš„å®¹å™¨ä¸­ ä¸€ä¸ªå‡½æ•°å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ â€”â€” å–å†³äºç¼©æ”¾é€‰é¡¹ åŒä¸€å‡½æ•°çš„ç‹¬ç«‹è°ƒç”¨å¯èƒ½ä¼šæœ€ç»ˆè¿›å…¥åŒä¸€ä¸ªå®¹å™¨ åŒä¸€å‡½æ•°çš„ç‹¬ç«‹è°ƒç”¨å°†å§‹ç»ˆä½¿ç”¨ä¸åŒçš„è¿›ç¨‹è¿›è¡Œ åå‘ä»£ç† watchdog æ³¨æ„ï¼šä½¿ç”¨ OpenFaaS å®˜æ–¹æœ¯è¯­ï¼Œæœ¬èŠ‚è®¨è®ºåœ¨ HTTP æ¨¡å¼ä¸‹è¿è¡Œçš„ of-watchdogã€‚ä½†æˆ‘ä¸ªäººè®¤ä¸ºç§°ä¹‹ä¸ºåå‘ä»£ç† watchdog æ›´åŠ å½¢è±¡ã€‚\nå¦‚æœ ç»å…¸ è¿è¡Œæ—¶ç±»ä¼¼äº CGIï¼Œé‚£ä¹ˆè¿™ä¸ªè¿è¡Œæ—¶æ¨¡å¼ç±»ä¼¼äºåæ¥çš„ FastCGIã€‚è¿è¡Œæ—¶å¸Œæœ›åœ¨ watchdog åé¢æœ‰ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„ HTTP æœåŠ¡å™¨ï¼Œè€Œä¸æ˜¯æ¯æ¬¡å‡½æ•°è°ƒç”¨æ—¶åˆ›å»ºæ–°çš„è¿›ç¨‹ã€‚è¿™æœ¬è´¨ä¸Šæ˜¯ å°† watchdog ç»„ä»¶å˜æˆåå‘ä»£ç†ï¼š\nå½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œåå‘ä»£ç† watchdog ä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªç›‘å¬åœ¨ 8080 ç«¯å£çš„è½»é‡çº§ HTTP æœåŠ¡å™¨ã€‚ç„¶è€Œï¼Œä¸ ç»å…¸ watchdog ä¸åŒçš„æ˜¯åå‘ä»£ç†watchdog åªåˆ›å»ºä¸€æ¬¡å‡½æ•°çš„è¿›ç¨‹ï¼Œå¹¶å°†å…¶å½“æˆï¼ˆé•¿æœŸè¿è¡Œçš„ï¼‰ä¸Šæ¸¸æœåŠ¡å™¨ã€‚ç„¶åï¼Œå‡½æ•°è°ƒç”¨è½¬å˜æˆåˆ°è¯¥ä¸Šæ¸¸çš„ HTTP è¯·æ±‚ã€‚\nç„¶è€Œï¼Œåå‘ä»£ç†æ¨¡å¼å¹¶ä¸ä¸ºäº†å–ä»£ç»å…¸æ¨¡å¼ã€‚ç»å…¸æ¨¡å¼çš„å¼ºé¡¹åœ¨äºå…¶å‡½æ•°çš„ç¼–å†™éå¸¸ç®€å•ã€‚è¿™ä¹Ÿæ˜¯æ²¡æœ‰ HTTP æœåŠ¡å™¨çš„ä»£ç çš„å”¯ä¸€é€‰æ‹©ã€‚æ¯”å¦‚ä½¿ç”¨ Cobolã€bash æˆ–è€… PowerShell è„šæœ¬ç­‰ç­‰ç¼–å†™çš„å‡½æ•°ã€‚\nä½•æ—¶è¯¥ä½¿ç”¨åå‘ä»£ç†è¿è¡Œæ—¶æ¨¡å¼ï¼š\nå‡½æ•°éœ€è¦åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´ä¿æŒçŠ¶æ€ï¼š ç¼“å­˜ æŒä¹…è¿æ¥ï¼ˆä¾‹å¦‚ï¼Œä¿æŒä»å‡½æ•°åˆ°æ•°æ®åº“çš„è¿æ¥æ‰“å¼€ï¼‰ æœ‰çŠ¶æ€å‡½æ•° ğŸ¥´ æ¯ä¸ªå‡½æ•°å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹å¯èƒ½å¼€é”€å¾ˆå¤§ï¼Œä¸ºæ¯ä¸ªè°ƒç”¨å¸¦æ¥äº†å»¶è¿Ÿ ä½ æƒ³è¿è¡Œä¸€ä¸ªï¼ˆå¾®ï¼‰æœåŠ¡ä½œä¸ºå‡½æ•° ğŸ¤” æ ¹æ® OpenFaaS çš„åˆ›å»ºè€… Alex Ellis çš„è§£é‡Šï¼ŒFaaSï¼Œç‰¹åˆ«æ˜¯ OpenFaaSï¼Œå¯ä»¥è¢«è§†ä¸ºåœ¨ä¸ä¾èµ–æœåŠ¡å™¨æŠ½è±¡çš„æƒ…å†µä¸‹ éƒ¨ç½²å¾®æœåŠ¡çš„ç®€åŒ–æ–¹å¼ã€‚å³ FaaS æ˜¯æ— æœåŠ¡å™¨æ¶æ„çš„è§„èŒƒç¤ºä¾‹ã€‚\nå› æ­¤ï¼Œä½¿ç”¨åå‘ä»£ç†çš„æ–¹å¼ï¼Œå‡½æ•°å¯ä»¥è¢«çœ‹ä½œæ˜¯éƒ¨ç½²å¾®æœåŠ¡çš„å›ºæ‰§çš„æ–¹å¼ã€‚æ–¹ä¾¿ã€å¿«é€Ÿã€ç®€å•ã€‚ä½†ä½¿ç”¨æœ‰çŠ¶æ€å‡½æ•°æ—¶ï¼Œè¦ç•™æ„ç”±äºå¤šä¸ªè°ƒç”¨å¯èƒ½åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ç»“æŸè€Œå¯¼è‡´çš„è­¦å‘Šï¼š\nåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ç»“æŸçš„å¹¶å‘è°ƒç”¨å¯èƒ½ä¼šè§¦å‘ä»£ç ä¸­çš„ç«äº‰æ¡ä»¶ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªå¸¦æœ‰å…¨å±€å˜é‡çš„ Go å‡½æ•°ï¼Œè€Œå…¨å±€å˜é‡æ²¡æœ‰é”çš„ä¿æŠ¤ï¼‰ã€‚ åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ç»“æŸçš„åç»­è°ƒç”¨å¯èƒ½ä¼šå¯¼è‡´äº¤å‰è°ƒç”¨æ•°æ®æ³„éœ²ï¼ˆå½“ç„¶ï¼Œå°±åƒä¼ ç»Ÿå¾®æœåŠ¡ä¸€æ ·ï¼‰ã€‚ ç”±äºè¯¥è¿›ç¨‹åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´è¢«å¤ç”¨ï¼Œå› æ­¤ä»£ç ä¸­çš„ä»»ä½•å†…å­˜æ³„æ¼éƒ½ä¸ä¼šè¢«ç¼“è§£ã€‚ å…¶ä»–è¿è¡Œæ—¶æ¨¡å¼ ç»å…¸è¿è¡Œæ—¶æ¨¡å¼åœ¨å°†å‡½æ•°ç»“æœå‘é€å›è°ƒç”¨æ–¹ä¹‹å‰ç¼“å†²äº†å‡½æ•°çš„æ•´ä¸ªå“åº”ã€‚ä½†å¦‚æœå“åº”çš„å¤§å°è¶…å‡ºäº†å®¹å™¨çš„å†…å­˜æ€ä¹ˆåŠï¼ŸOpenFaaS æä¾›äº†å¦ä¸€ç§è¿è¡Œæ—¶æ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä»ç„¶ä¸ºæ¯ä¸ªè°ƒç”¨åˆ›å»ºè¿›ç¨‹ï¼Œä½†æ·»åŠ äº†å“åº”æµã€‚\nå¦ä¸€ä¸ªåˆå»çš„åœºæ™¯æ˜¯ä»å‡½æ•°ä¸­æä¾›é™æ€æ–‡ä»¶æœåŠ¡ã€‚OpenFaaS ä¹Ÿæœ‰è§£å†³æ–¹æ¡ˆã€‚\nè¿™å¯èƒ½æ˜¯æ‰€æœ‰çš„å†…ç½®è¿è¡Œæ—¶æ¨¡å¼ã€‚ä½†å¦‚æœä»æœªæ»¡è¶³éœ€æ±‚ï¼ŒOpenFaaS æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼çœ‹ä¸‹ç°æœ‰çš„watchdogï¼ˆ1Â \u0026amp;Â 2ï¼‰ï¼Œç®€æ´æ˜äº†ã€‚å› æ­¤ï¼Œå¯ä»¥éšæ—¶æäº¤ PR æˆ–è€… issueï¼Œè®©æ•´ä¸ªç¤¾åŒºå› ä½ çš„è´¡çŒ®æ”¶ç›Šã€‚\nç¼–å†™å‡½æ•° æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»äº†è§£å‡½æ•°å¦‚ä½•åœ¨é…å¤‡äº†å‡½æ•° watchdog çš„å®¹å™¨ä¸­è¿è¡Œã€‚é‚£ä¹ˆæœ€å°çš„å‡½æ•°æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ\nä¸‹é¢çš„ç¤ºä¾‹å°†ç®€å•çš„ shell è„šæœ¬å°è£…åˆ° OpenFaaS å‡½æ•°ä¸­ï¼š\n######################################################## # WARNING: Not for Production - No Security Hardening! # ######################################################## # This FROM is just to get the watchdog executable. FROM ghcr.io/openfaas/classic-watchdog:0.2.0 as watchdog # FROM this line the actual runtime definion starts. FROM alpine:latest # Mandatory step - put the watchdog. COPY --from=watchdog /fwatchdog /usr/bin/fwatchdog # Optionally - install extra packages, libs, tools, etc. # Function\u0026#39;s payload - script echoing its STDIN, a bit transformed. RUN echo \u0026#39;#!/bin/sh\u0026#39; \u0026gt; /echo.sh RUN echo \u0026#39;cat | rev | tr \u0026#34;[:lower:]\u0026#34; \u0026#34;[:upper:]\u0026#34;\u0026#39; \u0026gt;\u0026gt; /echo.sh RUN chmod +x /echo.sh # Point the watchdog to the actual thingy to run. ENV fprocess=\u0026#34;/echo.sh\u0026#34; # Start the watchdog server. CMD [\u0026#34;fwatchdog\u0026#34;] å½“æ„å»ºã€éƒ¨ç½²å’Œè°ƒç”¨æ—¶ï¼Œä¸Šé¢çš„å‡½æ•°ä½œä¸º å›æ˜¾æœåŠ¡å™¨ï¼Œå€’è½¬å¹¶å¤§å†™å…¶è¾“å…¥ã€‚\nç¨å¾®é«˜çº§ç‚¹çš„ä¾‹å­ï¼šä¸€ä¸ª Node.js Hello World è„šæœ¬ä½œä¸ºå‡½æ•°ï¼š\n######################################################## # WARNING: Not for Production - No Security Hardening! # ######################################################## FROM ghcr.io/openfaas/classic-watchdog:0.2.0 as watchdog FROM node:17-alpine COPY --from=watchdog /fwatchdog /usr/bin/fwatchdog RUN echo \u0026#39;console.log(\u0026#34;Hello World!\u0026#34;)\u0026#39; \u0026gt; index.js ENV fprocess=\u0026#34;node index.js\u0026#34; CMD [\u0026#34;fwatchdog\u0026#34;] å› æ­¤ï¼Œè¦ç¼–å†™ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œåªéœ€è¦åœ¨ Dockerfile ä¸­åŠ å…¥ï¼š\nå®é™…è„šæœ¬ï¼ˆæˆ–å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ å®ƒçš„æ‰€æœ‰ä¾èµ–é¡¹â€”â€”è½¯ä»¶åŒ…ã€æ“ä½œç³»ç»Ÿåº“ç­‰ é¦–é€‰çš„ watchdog ç„¶åå°† watchdog æŒ‡å‘è¯¥è„šæœ¬ï¼ˆæˆ–å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ï¼Œå¹¶å°† watchdog ä½œä¸ºå…¥å£ã€‚æœ‰ç‚¹é…·ï¼Œå› ä¸ºï¼š\nå¯ä»¥å®Œå…¨æ§åˆ¶å‡½æ•°æœªæ¥çš„è¿è¡Œæ—¶ å¯ä»¥éƒ¨ç½²ä»»ä½•å¯ä»¥åœ¨å®¹å™¨ä¸­ä½œä¸ºå‡½æ•°è¿è¡Œçš„ä¸œè¥¿ ä½†ä¸Šè¿°æ–¹æ³•æœ‰ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹ \u0026ndash; ä¸€ä¸ªç”Ÿäº§å°±ç»ªçš„ Dockerfile å¯èƒ½æœ‰ä¸Šç™¾è¡Œã€‚å¦‚æœæˆ‘åªæƒ³è¿è¡Œä¸€ä¸ªç®€å•çš„ Node.js/Python è„šæœ¬æˆ–è€…ä¸€ä¸ªå°çš„ Go ç¨‹åºä½œä¸ºå‡½æ•°ï¼Œè¦æ€ä¹ˆå¤„ç† Dockerfileï¼Ÿå°±ä¸èƒ½æœ‰ä¸€ä¸ªå ä½ç¬¦æ¥ç²˜è´´ä»£ç ç‰‡æ®µï¼Ÿ\nåŠŸèƒ½æ¨¡æ¿ OpenFaaS çš„ç¾å¦™ä¹‹å¤„åœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥ä¸¤è€…å…¼è€Œæœ‰ä¹‹ â€”â€” ä½¿ç”¨ Dockerfile è¿›è¡Œä½çº§ä¿®è¡¥æˆ–ç›®æ ‡è¯­è¨€ç¼–å†™é«˜çº§è„šæœ¬ï¼å¾—ç›Šäºä¸°å¯Œçš„åŠŸèƒ½æ¨¡æ¿åº“ï¼\n$ faas-cli template store list NAME SOURCE DESCRIPTION csharp openfaas Classic C# template dockerfile openfaas Classic Dockerfile template go openfaas Classic Golang template java8 openfaas Java 8 template ... node14 openfaas HTTP-based Node 14 template node12 openfaas HTTP-based Node 12 template node openfaas Classic NodeJS 8 template php7 openfaas Classic PHP 7 template python openfaas Classic Python 2.7 template python3 openfaas Classic Python 3.6 template ... python3-flask openfaas Python 3.7 Flask template python3-http openfaas Python 3.7 with Flask and HTTP ... golang-http openfaas Golang HTTP template ... ä¸Šè¿°åŠŸèƒ½æ¨¡æ¿ç”± OpenFaaS ä½œè€…å’Œç¤¾åŒºç²¾å¿ƒåªåšã€‚å…¸å‹çš„æ¨¡æ¿é™„å¸¦ä¸€ä¸ªå¤æ‚çš„ Dockerfileï¼ŒæŒ‡å‘è™šæ‹Ÿå¤„ç†ç¨‹åºå‡½æ•°ã€‚å½“å¼•å¯¼æ–°å‡½æ•°æ—¶ï¼Œé€šè¿‡ faas-cli new å‘½ä»¤æ¥ä½¿ç”¨è¿™äº›æ¨¡æ¿ã€‚ä¾‹å¦‚ï¼š\n$ faas-cli new --lang python my-fn Folder: my-fn created. Function created in folder: my-fn Stack file written: my-fn.yml $ cat my-fn/handler.py def handle(req): \u0026#34;\u0026#34;\u0026#34; PUT YOUR BUSINESS LOGIC HERE \u0026#34;\u0026#34;\u0026#34; return req å› æ­¤ï¼Œå¯¹äºæ¨¡æ¿ï¼Œç¼–å†™å‡½æ•°çš„å·¥ä½œå¯ä»¥å½’ç»“ä¸ºç®€å•åœ°å°†ä¸šåŠ¡é€»è¾‘æ”¾å…¥å“åº”çš„å¤„ç†ç¨‹åºæ–‡ä»¶ä¸­ã€‚\nä½¿ç”¨æ¨¡æ¿æ—¶ï¼Œäº†è§£ä½¿ç”¨é‚£ç§ watchdog å’Œ æ¨¡å¼ å¾ˆé‡è¦ï¼š\nä½¿ç”¨ç»å…¸çš„ç±»ä¼¼ CGI çš„ watchdogï¼Œå¤„ç†ç¨‹åºé€šå¸¸è¢«ç¼–å†™ä¸ºæ¥å—å’Œè¿”å›çº¯å­—ç¬¦ä¸²çš„å‡½æ•°ï¼ˆä¾‹å¦‚ï¼špython3ã€php7ï¼‰ åœ¨ HTTP æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ of-watchdogæ—¶ï¼Œå¤„ç†ç¨‹åºçœ‹èµ·æ¥æ›´åƒ HTTP å¤„ç†ç¨‹åºæ¥å—è¯·æ±‚å¹¶è¿”å›å“åº”ç»“æ„ï¼ˆä¾‹å¦‚ï¼špython3-httpï¼Œnode17ï¼‰ã€‚ å‡½æ•°å•†åº— ä½ çš„æœ€ä½³å‡½æ•°æ˜¯ä»€ä¹ˆï¼Ÿå¯¹ï¼Œä½ ä¸éœ€è¦å†™ã€‚OpenFaaS æ¥å—è¿™ç§æƒ³æ³•ï¼Œå¹¶å¸¦æ¥äº†å‡½æ•°å•†åº—ï¼ˆç»è¿‡ç¤¾åŒºæµ‹è¯•å¹¶æ ¹æ®è¿‡å¾€ç»éªŒé€‰æ‹©çš„ OpenFaaS å‡½æ•°ç²¾é€‰ç´¢å¼•ï¼‰ã€‚\nè¯¥å•†åº—åŒ…å«ä¸€äº›æœ‰è¶£çš„å‡½æ•°ï¼Œå¯ä»¥ä¸€é”®éƒ¨ç½²åˆ°ç°æœ‰çš„ OpenFaaS ä¸­ï¼š\n$ faas-cli store list FUNCTION DESCRIPTION NodeInfo Get info about the machine that you\u0026#39;r... alpine An Alpine Linux shell, set the \u0026#34;fproc... env Print the environment variables prese... sleep Simulate a 2s duration or pass an X-S... shasum Generate a shasum for the given input Figlet Generate ASCII logos with the figlet CLI curl Use curl for network diagnostics, pas... SentimentAnalysis Python function provides a rating on ... hey HTTP load generator, ApacheBench (ab)... nslookup Query the nameserver for the IP addre... SSL/TLS cert info Returns SSL/TLS certificate informati... Colorization Turn black and white photos to color ... Inception This is a forked version of the work ... Have I Been Pwned The Have I Been Pwned function lets y... Face Detection with Pigo Detect faces in images using the Pigo... Tesseract OCR This function brings OCR - Optical Ch... Dockerhub Stats Golang function gives the count of re... QR Code Generator - Go QR Code generator using Go Nmap Security Scanner Tool for network discovery and securi... ASCII Cows Generate a random ASCII cow YouTube Video Downloader Download YouTube videos as a function OpenFaaS Text-to-Speech Generate an MP3 of text using Google\u0026#39;... Docker Image Manifest Query Query an image on the Docker Hub for ... face-detect with OpenCV Detect faces in images. Send a URL as... Face blur by Endre Simo Blur out faces detected in JPEGs. Inv... Left-Pad left-pad on OpenFaaS normalisecolor Automatically fix white-balance in ph... mememachine Turn any image into a meme. Business Strategy Generator Generates a Business Strategy (using ... Image EXIF Reader Reads EXIF information from an URL or... Open NSFW Model Score images for NSFW (nudity) content. Identicon Generator Create an identicon from a provided s... è¿™äº›å‡½æ•°å®é™…ä¸Šæ˜¯å­˜å‚¨åœ¨ Docker Hub æˆ–è€… Quay ç­‰å…¬å…±åº“çš„å®¹å™¨é•œåƒï¼Œå¯ä»¥è‡ªç”±å¤ç”¨ã€‚\nåœºæ™¯ç¤ºä¾‹ï¼š\nä½¿ç”¨ env å‡½æ•°è°ƒè¯•å‡½æ•°æ¥æ”¶çš„HTTPæ ‡å¤´ ä½¿ç”¨ curl å‡½æ•°ä» OpenFaaS éƒ¨ç½²å†…éƒ¨æµ‹è¯•è¿æ¥ ä»è¿è¡Œå¤šä¸ªå‰¯æœ¬çš„å‡½æ•°ä¸­ä½¿ç”¨ hey æ¥å¢åŠ è´Ÿè½½ å‡½æ•°çš„æ„å»ºå’Œéƒ¨ç½² ç”±äºå‡½æ•°æ˜¯åœ¨å®¹å™¨ä¸­è¿è¡Œçš„ï¼Œå› æ­¤éœ€è¦æœ‰äººä¸ºè¿™äº›å®¹å™¨æ„å»ºé•œåƒã€‚æ— è®ºä½ å–œä¸å–œæ¬¢ï¼Œè¿™éƒ½æ˜¯å¼€å‘äººå‘˜çš„äº‹æƒ…ã€‚OpenFaaS æä¾›äº†æ–¹ä¾¿çš„ faas-cli build å‘½ä»¤ï¼Œä½†æ²¡æœ‰æœåŠ¡å™¨ç«¯æ„å»ºã€‚å› æ­¤ï¼Œè¦ä¹ˆéœ€è¦ï¼ˆåœ¨å®‰è£… Docker çš„æœºå™¨ä¸Šï¼‰æ‰‹åŠ¨è¿è¡Œ faas-cli buildï¼Œè¦ä¹ˆä½¿ç”¨ CI/CD å®Œæˆã€‚\næ¥ä¸‹æ¥ï¼Œæ„å»ºå¥½çš„é•œåƒéœ€è¦é€šè¿‡ faas-cli push åˆ°ä»“åº“ã€‚æ˜¾ç„¶ï¼Œè¿™ç§ä»“åº“ä¹Ÿåº”è¯¥å¯ä»¥ä» OpenFaaS æœåŠ¡å™¨ç«¯è®¿é—®ã€‚å¦åˆ™ï¼Œä½¿ ç”¨faas-cli deploy éƒ¨ç½²å‡½æ•°æ—¶ä¼šå¤±è´¥ã€‚\nå¼€å‘äººå‘˜çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š\nè°ƒç”¨å‡½æ•° å‡½æ•°éƒ¨ç½²åï¼Œå¯ä»¥é€šè¿‡å‘ $API_HOST:$API_PORT/function/\u0026lt;fn-name\u0026gt; ç«¯ç‚¹å‘é€ GETã€POSTã€PUT æˆ–è€… DELET HTTP è¯·æ±‚æ¥è°ƒç”¨å®ƒã€‚å¸¸è§çš„è°ƒç”¨æ–¹å¼æœ‰ï¼š\nå„ç§é’©å­ï¼ˆwebhookï¼‰ faas-cli invoke event connectorsï¼ å‰ä¸¤ä¸ªé€‰é¡¹ç›¸å½“ç®€å•ã€‚ä½¿ç”¨å‡½æ•°ä½œä¸ºä½œä¸º webhook å¤„ç†å™¨ï¼ˆGitHubã€IFTTT ç­‰ï¼‰å¾ˆæ–¹ä¾¿ï¼Œæ¯ä¸ªå‡½æ•°å¼€å‘äººå‘˜éƒ½å·²ç»å®‰è£…äº† faas-cliï¼Œå› æ­¤å¯ä»¥æˆä¸ºæ—¥å¸¸è„šæœ¬ç¼–å†™çš„ç»„æˆéƒ¨åˆ†ã€‚\né‚£ä»€ä¹ˆæ˜¯äº‹ä»¶è¿æ¥å™¨ï¼Ÿ åœ¨æœ¬æ–‡å¼€å¤´æ˜¯æˆ‘å¯¹ AWS Lambda ä¸ AWS å¹³å°äº‹ä»¶ç´§å¯†é›†æˆçš„æ¸©æš–å›å¿†ã€‚è¯·è®°ä½ï¼Œå¯ä»¥åœ¨å“åº”æ–° SQS/SNS æ¶ˆæ¯ã€æ–°çš„ Kinesis è®°å½•ã€EC2 å®ä¾‹ç”Ÿå‘½å‘¨æœŸç­‰äº‹ä»¶æ—¶è°ƒç”¨ Lambdaã€‚OpenFaaS å‡½æ•°æ˜¯å¦å­˜åœ¨ç±»ä¼¼çš„ä¸œè¥¿å‘¢ï¼Ÿ\næ˜¾ç„¶ï¼ŒOpenFaaS æ— æ³•å¼€ç®±å³ç”¨åœ°ä¸ä»»ä½•ç”Ÿæ€ç³»ç»Ÿé›†æˆã€‚ç„¶è€Œï¼Œå®ƒæä¾›äº†ä¸€ç§åä¸ºäº‹ä»¶è¿æ¥å™¨æ¨¡å¼çš„é€šç”¨è§£å†³æ–¹æ¡ˆã€‚\nå®˜æ–¹æ”¯æŒçš„è¿æ¥å™¨ï¼š\nCron connector MQTT connector NATS connector Kafka connectorÂ (éœ€è¦ä¸“ä¸šç‰ˆè®¢é˜…) OpenFaaS è¿˜æä¾›äº†å¾ˆå°çš„è¿æ¥å™¨-sdkåº“æ¥ç®€åŒ–è¿æ¥å™¨çš„å¼€å‘ã€‚\nè¿ç»´çœ¼ä¸­çš„ OpenFaaS å¼€å‘çœ¼ä¸­çš„ OpenFaaS æ˜¯ä¸ªé»‘ç›’ï¼Œæä¾›ç®€å•çš„ API æ¥éƒ¨ç½²å’Œè°ƒç”¨å‡½æ•°ã€‚ç„¶è€Œï¼Œä½œä¸ºè¿ç»´å¯èƒ½ä¼šä»äº†è§£ ä¸€ç‚¹ OpenFaaS å†…éƒ¨åŸç†ä¸­å—ç›Šã€‚\nOpenFaaS é€šç”¨æ¶æ„ OpenFaaS æœ‰ä¸€ä¸ªç®€å•ä½†å¼ºå¤§çš„æ¶æ„ï¼Œå…è®¸ä½¿ç”¨ä¸åŒçš„åŸºç¡€è®¾æ–½ä½œä¸ºåç«¯ã€‚å¦‚æœå·²ç»æœ‰äº† Kubernetes é›†ç¾¤ï¼Œå¯ä»¥é€šè¿‡åœ¨ä¸Šé¢éƒ¨ç½² OpenFaaS è½»æ¾å°†å…¶å˜æˆ FaaS è§£å†³æ–¹æ¡ˆã€‚ä½†æ˜¯å¦‚æœæ—§çš„è™šæ‹Ÿï¼ˆæˆ–ç‰©ç†ï¼‰æœºï¼Œä»ç„¶å¯ä»¥åœ¨ä¸Šé¢å®‰è£… OpenFaaSï¼Œå¹¶è·å¾—å·®ä¸å¤šåŠŸèƒ½çš„æ›´å°çš„ FaaS è§£å†³æ–¹æ¡ˆã€‚\nä¸Šé¢çš„æ¶æ„ä¸­å”¯ä¸€é¢å‘ç”¨æˆ·çš„ç»„ä»¶æ˜¯ API ç½‘å…³ã€‚OpenFaaS çš„ API ç½‘å…³ï¼š\næš´éœ² API æ¥ç®¡ç†å’Œè°ƒç”¨å‡½æ•° æä¾›å†…ç½®çš„ UI æ¥ç®¡ç†å‡½æ•° å¤„ç†å‡½æ•°çš„è‡ªåŠ¨ç¼©æ”¾ é¢„è®¡åé¢ä¼šæœ‰å…¼å®¹çš„ OpenFaaS æä¾›å•† å› æ­¤ï¼Œå½“å¼€å‘äººå‘˜è¿è¡Œ faas-cli deployã€faas-cli list æˆ–ä½¿ç”¨ curl $API_URL/function/foobar è°ƒç”¨å‡½æ•°ç­‰å†…å®¹æ—¶ï¼Œè¯·æ±‚å°†å‘é€åˆ°ä¸Šè¿°çš„ API ç½‘å…³ã€‚\nä¸Šå›¾ä¸­çš„å¦ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†æ˜¯ faas-providerã€‚å®ƒä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„ç»„ä»¶ï¼Œè€Œæ›´åƒæ˜¯æ¥å£ã€‚ä»»ä½•å®ç°ï¼ˆéå¸¸ç®€æ´ï¼‰çš„æä¾›å•† API çš„è½¯ä»¶éƒ½å¯ä»¥æˆä¸ºæä¾›å•†ã€‚OpenFaaS æä¾›å•†ï¼š\nç®¡ç†åŠŸèƒ½ï¼ˆéƒ¨ç½²ã€åˆ—è¡¨ã€ç¼©æ”¾ã€åˆ é™¤ï¼‰ è°ƒç”¨å‡½æ•° æš´éœ²ä¸€äº›ç³»ç»Ÿä¿¡æ¯ ä¸¤ä¸ªæœ€æ³¨æ˜çš„æä¾›å•†æ˜¯ faas-netesï¼ˆKubernetes ä¸Šçš„ OpenFaaSï¼‰å’Œ faasdï¼ˆContainerd ä¸Šçš„ OpenFaaSï¼‰ã€‚ä¸‹é¢ï¼Œå°†ä»‹ç»ä»–ä»¬çš„å®ç°ã€‚\nKubernetes ä¸Šçš„ OpenFaaSï¼ˆfaas-netsï¼‰ å½“éƒ¨ç½²åœ¨ Kubernetes ä¸Šæ—¶ï¼ŒOpenFaaS åˆ©ç”¨äº†è¯¥å¹³å°å¼€ç®±å³ç”¨çš„å¼ºå¤§åŸè¯­ã€‚\nå…³é”®è¦ç‚¹ï¼š\nAPI ç½‘å…³æˆä¸ºæ ‡å‡†ï¼ˆéƒ¨ç½²+æœåŠ¡ï¼‰å¯¹ã€‚å› æ­¤ï¼Œå¯ä»¥éšå¿ƒæ‰€æ¬²åœ°æ‰©å±•å®ƒã€‚ä¹Ÿå¯ä»¥éšå¿ƒæ‰€æ¬²åœ°æŠŠå®ƒæš´éœ²å‡ºæ¥ æ¯ä¸ªå‡½æ•°ä¹Ÿæˆä¸ºï¼ˆéƒ¨ç½²+æœåŠ¡ï¼‰å¯¹ã€‚å¯èƒ½ä¸ä¼šç›´æ¥å¤„ç†å‡½æ•°ï¼Œä½†å¯¹äº faas-netesï¼Œç¼©æ”¾å˜å¾—å°±åƒè°ƒæ•´ç›¸åº”çš„å‰¯æœ¬æ•°ä¸€æ ·ç®€å• é«˜å¯ç”¨æ€§å’Œå¼€ç®±å³ç”¨çš„æ°´å¹³ç¼©æ”¾ - åŒä¸€åŠŸèƒ½çš„ pod å¯ä»¥ï¼ˆè€Œä¸”åº”è¯¥ï¼‰è·¨å¤šä¸ªé›†ç¾¤èŠ‚ç‚¹è¿è¡Œã€‚ Kubernetes ä½œä¸ºä¸€ä¸ªæ•°æ®åº“å·¥ä½œï¼›ä¾‹å¦‚ï¼Œå½“è¿è¡Œ faas-cli list ç­‰å‘½ä»¤æ¥è·å–å½“å‰éƒ¨ç½²çš„å‡½æ•°åˆ—è¡¨æ—¶ï¼Œfaas-netes åªä¼šå°†å…¶è½¬æ¢ä¸ºç›¸åº”çš„ Kubernetes API æŸ¥è¯¢ Containerd ä¸Šçš„ OpenFaaSï¼ˆfaasdï¼‰ å¯¹äºæ²¡æœ‰ä½¿ç”¨ Kubernetes é›†ç¾¤çš„äººæ¥è¯´ï¼ŒOpenFaaS æä¾›äº†åä¸º faasd çš„æ›¿ä»£è½»é‡çº§æä¾›å•†ã€‚å®ƒå¯ä»¥å®‰è£…åœ¨ï¼ˆè™šæ‹Ÿæˆ–ç‰©ç†ï¼‰æœåŠ¡å™¨ä¸Šï¼Œï¼Œå¹¶åˆ©ç”¨ containerd æ¥ç®¡ç†å®¹å™¨ã€‚æ­£å¦‚æˆ‘ä¹‹å‰å†™çš„é‚£æ ·ï¼Œå®¹å™¨æ˜¯ä¸€ä¸ªåœ¨ Docker å’Œ Kubernetes ä¸‹ä½¿ç”¨çš„è¾ƒä½çº§åˆ«çš„å®¹å™¨ç®¡ç†å™¨ã€‚ç»“åˆ CNI æ’ä»¶ï¼Œå®ƒæˆä¸ºç¼–å†™å®¹å™¨è°ƒåº¦å™¨çš„æ„å»ºç»„ä»¶ï¼ŒOpenFaaS çš„ faasd æ˜¯ä¸ªå¾ˆå¥½çš„è®²ç©¶æ¡ˆä¾‹ï¼š\nå…³é”®è¦ç‚¹ï¼š\nè¢«è®¾è®¡ä¸ºåœ¨ IoT è®¾å¤‡ä¸Šæˆ– VM ä¸­è¿è¡Œ ä½¿ç”¨ containerd çš„åŸç”ŸÂ pauseÂ ï¼ˆé€šè¿‡cgroup freezersï¼‰å’Œè¶…å¿«é€Ÿå‡½æ•°å†·å¯åŠ¨å¿«é€Ÿæ‰©å±•åˆ°é›¶ å®ƒå¯ä»¥åœ¨æ¯å°æœåŠ¡å™¨ä¸Šè¿è¡Œæ¯” faas-netes å¤šåå€çš„å‡½æ•°ï¼Œå¹¶ä¸”å¯ä»¥æœ‰æ•ˆåœ°ä½¿ç”¨æ›´ä¾¿å®œçš„ç¡¬ä»¶ï¼ŒåŒ…æ‹¬æ ‘è“æ´¾ containerd å’Œ faasd ä½œä¸º systemd æœåŠ¡è¿›è¡Œç®¡ç†ï¼Œå› æ­¤ä¼šè‡ªåŠ¨å¤„ç†æ—¥å¿—ã€é‡å¯ç­‰ æ²¡æœ‰ Kubernetes DNSï¼Œä½† faasd ç¡®ä¿ DNS åœ¨å‡½æ•°ä¹‹é—´å…±äº«ä»¥ç®€åŒ–äº’æ“ä½œ containerd æ‰®æ¼”ç€æ•°æ®åº“çš„è§’è‰²ï¼ˆæ¯”å¦‚Â faas-cli listÂ å˜æˆäº†ç±»ä¼¼Â ctr container listçš„æ“ä½œÂ ï¼‰ï¼Œæ‰€ä»¥å¦‚æœæœåŠ¡å™¨æŒ‚äº†ï¼Œæ‰€æœ‰çŠ¶æ€å°±ä¼šä¸¢å¤±ï¼Œæ¯ä¸ªå‡½æ•°éƒ½éœ€è¦é‡æ–°éƒ¨ç½² æ²¡æœ‰å¼€ç®±å³ç”¨çš„é«˜å¯ç”¨æ€§æˆ–æ°´å¹³æ‰©å±•ï¼ˆå‚è§ issue/225ï¼‰ æ€»ç»“ å¯¹ä½ æ‰€ä½¿ç”¨çš„è½¯ä»¶æœ‰ä¸ªå¥½çš„å¿ƒæ™ºæ¨¡å‹æ˜¯æ˜¯æœ‰ç›Šçš„ï¼Œå®ƒå¯ä»¥æé«˜å¼€å‘æ•ˆç‡ï¼Œé˜²æ­¢å•ä¾‹åœºæ™¯çš„å‘ç”Ÿï¼Œå¹¶ç®€åŒ–äº†æ•…éšœæ’æŸ¥ã€‚\nä»¥ OpenFaaS ä¸ºä¾‹ï¼ŒåŒºåˆ†å¼€å‘äººå‘˜å’Œè¿ç»´äººå‘˜å¯¹ç³»ç»Ÿçš„çœ‹æ³•å¯èƒ½æ˜¯ä¸ªå¾ˆå¥½çš„æ€è·¯ã€‚ä»å¼€å‘äººå‘˜è§’åº¦æ¥çœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„æ— æœåŠ¡å™¨è§£å†³æ–¹æ¡ˆï¼Œä¸»è¦å…³æ³¨ FaaS åœºæ™¯ã€‚è¯¥è§£å†³æ–¹æ¡ˆç”±ä¸€ä¸ªç”¨äºç®¡ç†å’Œè°ƒç”¨å‡½æ•°çš„ç®€æ´ APIã€ä¸€ä¸ªæ¶µç›–å¼€å‘äººå‘˜å·¥ä½œæµçš„å‘½ä»¤è¡Œå·¥å…·ä»¥åŠä¸€ä¸ªå‡½æ•°æ¨¡æ¿åº“ç»„æˆã€‚æ— æœåŠ¡å™¨å‡½æ•°ä»¥ä¸åŒçš„è¿è¡Œæ—¶æ¨¡å¼ï¼ˆç±» CGIã€åå‘ä»£ç†ï¼‰åœ¨å®¹å™¨ä¸­è¿è¡Œï¼Œå¹¶æä¾›ä¸åŒçš„éš”ç¦»å’ŒçŠ¶æ€ä¿éšœã€‚\nä»è¿ç»´äººå‘˜çš„è§’åº¦æ¥çœ‹ï¼ŒOpenFaaS æ˜¯ä¸€ä¸ªå…·æœ‰çµæ´»æ¶æ„çš„æ¨¡å—åŒ–ç³»ç»Ÿï¼Œå¯ä»¥éƒ¨ç½²åœ¨ä¸åŒç±»å‹çš„åŸºç¡€è®¾æ–½ä¹‹ä¸Šï¼šä»æ ‘è“æ´¾åˆ°è£¸æœºæˆ–è™šæ‹Ÿæœºã€ä»¥åŠæˆç†Ÿçš„ Kubernetesã€OpenShift æˆ– Docker Swarm é›†ç¾¤ã€‚å½“ç„¶ï¼Œæ¯ç§é€‰æ‹©éƒ½æœ‰å…¶ä¼˜ç¼ºç‚¹ï¼Œéœ€è¦è¯¦ç»†è¯„ä¼°å–èˆã€‚ä½†å³ä½¿ç°æœ‰é€‰é¡¹éƒ½ä¸åˆé€‚ï¼Œç®€å•çš„ faas-provider æŠ½è±¡å…è®¸å¼€å‘è‡ªå·±çš„åç«¯æ¥è¿è¡Œæ— æœåŠ¡å™¨åŠŸèƒ½ã€‚\nä¸Šè¿°å†…å®¹ä¸»è¦é›†ä¸­åœ¨ OpenFaaS åŸºç¡€çŸ¥è¯†ä¸Šã€‚ä½†æ˜¯ OpenFaaS ä¹Ÿæœ‰ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚é€šè¿‡ä»¥ä¸‹é“¾æ¥è¿›ä¸€æ­¥äº†è§£ï¼š\nä½¿ç”¨ NATS æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿçš„å¼‚æ­¥å‡½æ•°è°ƒç”¨ ä½¿ç”¨ Prometheus å’Œ AlertManager è‡ªåŠ¨ç¼©æ”¾åŠŸèƒ½ å‡½æ•°è°ƒç”¨é™åˆ¶ ä½¿ç”¨ docker-compose é€šè¿‡ faasd è¿è¡Œæœ‰çŠ¶æ€çš„å·¥ä½œè´Ÿè½½ èµ„æº OpenFaaS å®˜æ–¹æ–‡æ¡£ ä¸€å †æ¸…æ™°çš„ OpenFaaS ç”¨ä¾‹ ä½¿ç”¨ OpenFaaS å°†ä»»ä½• CLI è½¬æ¢ä¸ºå‡½æ•° faasd ä»‹ç»ã€åŠ¨æœºã€ä¸»è¦ç”¨ä¾‹ ğŸ“–é¢å‘å…¶ä»–äººçš„æ— æœåŠ¡å™¨- å°½ç®¡æœ‰é€šç”¨åç§°ï¼Œä½†å®ƒæ˜¯ faasd çš„ä¸€ä¸ªéå¸¸è¯¦ç»†çš„æŒ‡å— ä½œè€…ä»‹ç»ï¼š Ivan Velichko Software Engineer at heart, SRE at day job, Tech Storyteller at night.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/openfaas-case-study-zh/","tags":["Serverless","Kubernetes","Container","äº‘åŸç”Ÿ"],"title":"OpenFaaS - ä»¥è‡ªå·±çš„æ–¹å¼è¿è¡Œå®¹å™¨åŒ–å‡½æ•°"},{"categories":["äº‘åŸç”Ÿ"],"contents":"è·ç¦»ä¸Šä¸ªç‰ˆæœ¬ ç”¨ Pipy å®ç° OPAï¼Œå·²ç»è¿‡å»å¿«åŠå¹´äº†ã€‚å½“åˆä½¿ç”¨Pipy å®ç°äº†å¯ä¿¡é•œåƒä»“åº“çš„æ£€æŸ¥ï¼Œé‚£æ—¶çš„ç‰ˆæœ¬å®ç°èµ·æ¥ä¼šç¨å¾®å¤æ‚ï¼Œä»ç­–ç•¥ä»“åº“åˆ°è¯ä¹¦åˆ›å»ºåˆ°Admission Webhook çš„åˆ›å»ºéƒ½éœ€è¦å¤§é‡çš„äººå·¥æ“ä½œï¼Œé…ç½®å’Œé€»è¾‘ä¹Ÿè¿˜æ˜¯è€¦åˆåœ¨ä¸€èµ·ã€‚\nè¿™ä¸ªç‰ˆæœ¬å®‰è£…å’Œä½¿ç”¨èµ·æ¥ä¼šæ›´åŠ ç®€å•ã€‚\nå½“åˆæˆ‘ç”¨â€œä¸åŠ¡æ­£ä¸šâ€æ¥å½¢å®¹ Pipy å®ç°å‡†å…¥æ§åˆ¶ï¼Œç­‰çœ‹å®Œè¿™ç¯‡æ–‡ç« ï¼Œæ¬¢è¿ç•™è¨€è¯´è¯´ä½ çš„çœ‹æ³•ã€‚\næ¶æ„ è¿˜æ˜¯ç»§ç»­ä¸Šæ¬¡çš„åœºæ™¯ï¼Œåœ¨ Pod åˆ›å»ºæ—¶å¯¹ Pod ä½¿ç”¨çš„é•œåƒæ‰€åœ¨ä»“åº“è¿›è¡Œæ£€æŸ¥ï¼Œä»¥åŠæ£€æŸ¥é•œåƒçš„ tag æ˜¯å¦åˆæ³•ã€‚\nè¿™é‡Œå€ŸåŠ© Pipy Repo çš„èƒ½åŠ›ï¼Œå°†ä»£è¡¨ç­–ç•¥çš„è„šæœ¬å’Œé…ç½®äº¤ç”± Repo è¿›è¡Œç®¡ç†ï¼›Pipy å®ä¾‹å®æ—¶ä» Pipy Repo åŒæ­¥ç­–ç•¥ï¼Œå¹¶è¿›è¡ŒåŠ¨æ€åŠ è½½ã€‚\nåŒæ—¶ Pipy Repo å¯¹å¤–æä¾› REST API æ¥ç®¡ç†ç­–ç•¥ï¼Œå¯¹ç­–ç•¥çš„ä¿®æ”¹æ›´å®¹æ˜“ã€‚ä¹Ÿæ–¹ä¾¿ä¸ä¼ä¸šç°æœ‰ç®¡ç†åå°è¿›è¡Œå¯¹æ¥ã€‚\nä¸‹é¢å°±å¼€å§‹éƒ¨ç½²éªŒè¯ï¼Œè¿™é‡Œæ‰€ä½¿ç”¨çš„æ‰€æœ‰ä»£ç éƒ½å·²æäº¤åˆ° GitHub ä»“åº“ï¼šhttps://github.com/flomesh-io/demo-policy-as-codeã€‚\nè¿è¡Œ git clone https://github.com/flomesh-io/demo-policy-as-code.git cd demo-policy-as-code å‡†å¤‡ ç¯å¢ƒ ä½¿ç”¨ Kubernetes å‘è¡Œç‰ˆ K3s ä½œä¸ºé›†ç¾¤ç¯å¢ƒï¼Œé›†ç¾¤çš„æ­å»ºä¸åšè¿‡å¤šè¯´æ˜ã€‚æˆ‘ç”¨ k3dï¼š\nk3d cluster create policy-as-code -p \u0026#34;6060:30060@server:0\u0026#34; æ³¨ï¼šK3d æ˜¯åœ¨å®¹å™¨ä¸­è¿è¡Œ K3sï¼Œè¿™é‡Œåšäº†å°†å®¹å™¨çš„ 30060 ç«¯å£æ˜ å°„åˆ°æœ¬åœ°çš„ 6060 ç«¯å£ï¼Œåé¢ä¼šè¯¦ç»†è§£é‡Šã€‚\néƒ¨ç½²ç­–ç•¥æœåŠ¡å™¨ æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤éƒ¨ç½²ç­–ç•¥æœåŠ¡å™¨ Repoï¼š\nkubectl apply -f repo/pipy-repo.yaml ç¡®ä¿ Pod æ­£å¸¸è¿è¡Œï¼š\nkubectl get po -n pipy NAME READY STATUS RESTARTS AGE pipy-repo-697bbd9f4b-94pld 1/1 Running 0 10s å‘å¸ƒç­–ç•¥ è¦ä½¿ç”¨çš„ç­–ç•¥ï¼ˆè„šæœ¬å’Œé…ç½®ï¼‰ä½äº ./repo/scripts ç›®å½•ä¸­ã€‚å‰é¢æåˆ° Repo æä¾›äº† REST API æ¥ç®¡ç† codebaseï¼ˆç­–ç•¥ï¼‰ã€‚\nè¿™é‡Œæä¾›äº†è„šæœ¬ init-codebase.shï¼Œé€šè¿‡ curl å‘½ä»¤å°†ç­–ç•¥å‘å¸ƒåˆ°ç­–ç•¥æœåŠ¡å™¨ã€‚\n./init-codebase.sh éƒ¨ç½²ç­–ç•¥å¼•æ“ è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨ helm chart å®Œæˆè¯ä¹¦çš„åˆ›å»ºã€æœåŠ¡çš„éƒ¨ç½²ä»¥åŠ Admission WebHook çš„æ³¨å†Œã€‚\nhelm install policy-as-code ./policy-as-code -n default ç¡®ä¿ Pod æ­£å¸¸è¿è¡Œï¼š\nkubectl get po -n pipy NAME READY STATUS RESTARTS AGE pipy-repo-697bbd9f4b-94pld 1/1 Running 0 2m policy-as-code-5867f9cdb9-9vwks 1/1 Running 0 8s æµ‹è¯• åœ¨ ./test ç›®å½•ä¸­æœ‰ä¸‰ä¸ª yaml æ–‡ä»¶ç”¨äºæµ‹è¯•ã€‚\néæ³•çš„é•œåƒä»“åº“ï¼š\nkubectl apply -f test/bad.yaml Error from server (192.168.64.1:5000/hello-world:linux repo not start with any repo [docker.io, k8s.gcr.io]): error when creating \u0026#34;test/bad.yaml\u0026#34;: admission webhook \u0026#34;validating-webhook.pipy.flomesh-io.cn\u0026#34; denied the request: 192.168.64.1:5000/hello-world:linux repo not start with any repo [docker.io, k8s.gcr.io] éæ³•çš„é•œåƒ tagï¼š\nkubectl apply -f test/bad2.yaml Error from server (docker.io/library/hello-world:latest tag end with :latest): error when creating \u0026#34;test/bad2.yaml\u0026#34;: admission webhook \u0026#34;validating-webhook.pipy.flomesh-io.cn\u0026#34; denied the request: docker.io/library/hello-world:latest tag end with :latest åˆæ³•çš„é•œåƒ\nkubectl apply -f test/ok.yaml pod/hello-world-success created å°±è¿™ä¹ˆç»“æŸäº†ï¼Ÿå½“ç„¶æ²¡æœ‰ï¼Œæˆ‘ä»¬è¿˜è¦å¯¹ç­–ç•¥è¿›è¡ŒåŠ¨æ€çš„è°ƒæ•´ã€‚\nç»§ç»­ä¸‹é¢çš„æµ‹è¯•ä¹‹å‰ï¼Œæ‰§è¡Œ kubectl delete -f test/ok.yaml æ¸…ç†åˆšæ‰åˆ›å»ºçš„ Podã€‚\nä¿®æ”¹ç­–ç•¥ ä¿®æ”¹ ./repo/scripts/config.jsonæ–‡ä»¶ï¼Œæ¸…ç©º invalidTagSuffixes æ•°ç»„ä¸­çš„å†…å®¹ã€‚\n{ \u0026#34;validRepoPrefixes\u0026#34;: [ \u0026#34;docker.io\u0026#34;, \u0026#34;k8s.gcr.io\u0026#34; ], \u0026#34;invalidTagSuffixes\u0026#34;: [] } **æ³¨æ„ï¼š**è¿™é‡Œéœ€è¦æ‰§è¡Œè„šæœ¬ ./init-codebase.sh æ›´æ–°ç­–ç•¥ã€‚\næ­¤æ—¶ï¼Œå†æ¬¡å°è¯• apply test/bad2.yamlã€‚ä½ ä¼šå‘ç°ï¼Œè¿™æ¬¡ Pod åˆ›å»ºæˆåŠŸäº†ã€‚\nkubectl apply -f test/bad2.yaml pod/hello-world-bad-tag created æˆ‘ä»¬æ²¡æœ‰ä¿®æ”¹ä»»ä½•é€»è¾‘ä»£ç ï¼Œä»…ä»…ä¿®æ”¹äº†é…ç½®å°±å®Œæˆäº†å¯¹ Pod é•œåƒæ£€æŸ¥é€»è¾‘çš„è°ƒæ•´ã€‚å¯èƒ½æœ‰äººä¼šé—®ï¼Œå‘½ä»¤è¡Œå¤ªéº»çƒ¦è°ƒè¯•ä¸æ–¹ä¾¿ï¼Œæœ‰æ²¡æœ‰æ›´ç›´è§‚çš„æ–¹å¼ï¼Ÿ\nç­”æ¡ˆæ˜¯ï¼šæœ‰ï¼\nå›¾å½¢ç”¨æˆ·ç•Œé¢ Pipy Repo æä¾›äº†å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼Œæ–¹ä¾¿è„šæœ¬çš„å¼€å‘å’Œè°ƒè¯•ã€‚è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒå¿«é€Ÿå…¥é—¨ Pipy Repoï¼Œäº†è§£å›¾å½¢ç”¨æˆ·ç•Œé¢çš„ä½¿ç”¨ã€‚\nè¿˜è®°å¾—å¼€å¤´çš„åœ°æ–¹æˆ‘ä»¬ä¸º K3d å®¹å™¨åšäº†ç«¯å£æ˜ å°„ï¼š6060=\u0026gt;30060ï¼Œç»†å¿ƒçš„ä½ ä¹Ÿå¯èƒ½å‘ç°æˆ‘ä»¬ä¸º Pipy Repo åˆ›å»ºäº† NodePort Servceï¼Œnode port ç«¯å£ä¸º 30060ã€‚\næ­¤æ—¶ï¼Œæœ¬åœ°å¯åŠ¨ä¸€ä¸ª Pipyï¼š\n#k3d pipy http://localhost:6060 --admin-port=6061 #ä¸»æœºç›´æ¥éƒ¨ç½² k3s è¯·ä½¿ç”¨è¿™æ¡å‘½ä»¤ pipy http://localhost:30060 --admin-port=6061 åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://localhost:6060ï¼Œä½ ä¼šçœ‹åˆ°ï¼š\nç‚¹å‡»ä¸‹é¢æˆ‘ä»¬åˆ›å»ºçš„ codebase /image-verifyï¼Œåœ¨å·¦ä¾§æ–‡ä»¶ç›®å½•ä¸­å¯ä»¥æ‰¾åˆ°æˆ‘ä»¬ä¿®æ”¹åçš„ config.json:\nåœ¨ç¼–è¾‘å™¨ä¸­ç¼–è¾‘ï¼Œæ”¹å›åŸæ¥çš„é…ç½®ï¼Œç„¶åç‚¹å‡» 2 å’Œ 3 ä¸¤ä¸ªæŒ‰é’®\nå†æ¬¡æµ‹è¯• #æ¸…ç† kubectl delete -f test/bad2.yaml kubectl apply -f test/bad2.yaml Error from server (docker.io/library/hello-world:latest tag end with :latest): error when creating \u0026#34;test/bad2.yaml\u0026#34;: admission webhook \u0026#34;validating-webhook.pipy.flomesh-io.cn\u0026#34; denied the request: docker.io/library/hello-world:latest tag end with :latest å¯ä»¥çœ‹åˆ°ï¼Œä¿®æ”¹çš„ç»“æœä½“ç°åœ¨é”™è¯¯ä¿¡æ¯é‡Œäº†ã€‚\næ€»ç»“ Open Policy Agent (OPA) ä¸ºç­–ç•¥å¼•æ“å¸¦æ¥äº†æ–°çš„å¤©åœ°ï¼Œä½†æ˜¯ä½¿ç”¨ Rego è¯­è¨€ç¼–å†™ç­–ç•¥ä¸ºä½¿ç”¨å¸¦æ¥äº†é—¨æ§›ã€‚Pipy ä»¥å…¶æµé‡ç¼–ç¨‹ã€æ˜“æ‰©å±•çš„ç‰¹æ€§ç»“åˆ Repo çš„ codebase ç®¡ç†ï¼Œå¯ä»¥è½»æ¾å®ç°ç­–ç•¥å³ä»£ç ã€‚åŒæ—¶ï¼Œèµ„æºæ¶ˆè€—æ›´å°‘ï¼Œæ€§èƒ½æ›´é«˜ï¼ˆä»£ç†åœºæ™¯çš„ç‰¹ç‚¹ï¼‰ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/policy-as-code-with-pipy/","tags":["Kubernetes","OPA","Pipy","äº‘åŸç”Ÿ"],"title":"ç­–ç•¥å³ä»£ç ï¼šä¸ºäº† OpenPolicyAgent å­¦ Regoï¼Ÿè¯•è¯• Javascript"},{"categories":["äº‘åŸç”Ÿ"],"contents":"éšç€ IT æŠ€æœ¯çš„å‘å±•ï¼ŒAIã€åŒºå—é“¾å’Œå¤§æ•°æ®ç­‰æŠ€æœ¯æå‡äº†å¯¹åº”ç”¨æ¯«ç§’çº§æ‰©å±•çš„éœ€æ±‚ï¼Œå¼€å‘äººå‘˜ä¹Ÿé¢ä¸´ç€çš„åŠŸèƒ½å¿«é€Ÿæ¨å‡ºçš„å‹åŠ›ã€‚æ··åˆäº‘æ˜¯æ–°å¸¸æ€ï¼Œæ•°å­—åŒ–è½¬å‹æ˜¯ä¿æŒç«äº‰åŠ›çš„å¿…è¦æ¡ä»¶ï¼Œè™šæ‹ŸåŒ–æˆä¸ºè¿™äº›æŒ‘æˆ˜çš„åŸºæœ¬æŠ€æœ¯ã€‚\nåœ¨è™šæ‹ŸåŒ–çš„ä¸–ç•Œï¼Œæœ‰ä¸¤ä¸ªè¯è€³ç†Ÿèƒ½è¯¦ï¼šè™šæ‹Ÿæœºå’Œå®¹å™¨ã€‚å‰è€…æ˜¯å¯¹ç¡¬ä»¶çš„è™šæ‹ŸåŒ–ï¼Œåè€…åˆ™æ›´åƒæ˜¯æ“ä½œç³»ç»Ÿçš„è™šæ‹ŸåŒ–ã€‚ä¸¤è€…éƒ½æä¾›äº†æ²™ç®±çš„èƒ½åŠ›ï¼šè™šæ‹Ÿæœºé€šè¿‡ç¡¬ä»¶çº§æŠ½è±¡æä¾›ï¼Œè€Œå®¹å™¨åˆ™ä½¿ç”¨å…¬å…±å†…æ ¸æä¾›è¿›ç¨‹çº§çš„éš”ç¦»ã€‚æœ‰å¾ˆå¤šäººå°†å®¹å™¨çœ‹æˆæ˜¯â€œè½»é‡åŒ–çš„è™šæ‹Ÿæœºâ€ï¼Œé€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬è®¤ä¸ºå®¹å™¨æ˜¯å®‰å…¨çš„ï¼Œé‚£åˆ°åº•æ˜¯ä¸æ˜¯è·Ÿæˆ‘ä»¬æƒ³è±¡çš„ä¸€æ ·ï¼Ÿ\nå®¹å™¨ï¼šè½»é‡åŒ–çš„è™šæ‹Ÿæœºï¼Ÿ å®¹å™¨æ˜¯æ‰“åŒ…ã€å…±äº«å’Œéƒ¨ç½²åº”ç”¨çš„ç°ä»£åŒ–æ–¹å¼ï¼Œå¸®åŠ©ä¼ä¸šå®ç°å¿«é€Ÿã€æ ‡å‡†ã€çµæ´»åœ°å®ŒæˆæœåŠ¡äº¤äº’ã€‚å®¹å™¨åŒ–æ˜¯å»ºç«‹åœ¨ Linux çš„å‘½åç©ºé—´ï¼ˆnamespaceï¼‰å’Œæ§åˆ¶ç»„ï¼ˆcgroupï¼‰ çš„è®¾è®¡ä¹‹ä¸Šã€‚\nå‘½åç©ºé—´åˆ›å»ºä¸€ä¸ªå‡ ä¹éš”ç¦»çš„ç”¨æˆ·ç©ºé—´ï¼Œå¹¶ä¸ºåº”ç”¨æä¾›ä¸“ç”¨çš„ç³»ç»Ÿèµ„æºï¼Œå¦‚æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œå †æ ˆã€è¿›ç¨‹IDå’Œç”¨æˆ·IDã€‚éšç€ç”¨æˆ·å‘½åç©ºé—´çš„å¼•å…¥ï¼Œå†…æ ¸ç‰ˆæœ¬ 3.8 æä¾›äº†å¯¹å®¹å™¨åŠŸèƒ½çš„æ”¯æŒï¼šMountï¼ˆmntï¼‰ã€è¿›ç¨‹ IDï¼ˆpidï¼‰ã€Networkï¼ˆnetï¼‰ã€è¿›ç¨‹é—´é€šä¿¡ï¼ˆipcï¼‰ã€UTSã€ç”¨æˆ· IDï¼ˆuserï¼‰6 ä¸ªå‘½åç©ºé—´ï¼ˆå¦‚ä»Šå·²è¾¾ 8 ä¸ªï¼Œåç»­åŠ å…¥äº† cgroup å’Œ time å‘½åç©ºé—´ï¼‰ã€‚\ncgroup åˆ™å®æ–½å¯¹åº”ç”¨çš„èµ„æºé™åˆ¶ã€ä¼˜å…ˆçº§ã€è®°è´¦å’Œæ§åˆ¶ã€‚cgroupå¯ä»¥æ§åˆ¶ CPUã€å†…å­˜ã€è®¾å¤‡å’Œç½‘ç»œç­‰èµ„æºã€‚\nåŒæ—¶ä½¿ç”¨ namespace å’Œ cgroup ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ä¸€å°ä¸»æœºä¸Šå®‰å…¨åœ°è¿è¡Œå¤šä¸ªåº”ç”¨ï¼Œå¹¶ä¸”æ¯ä¸ªåº”ç”¨éƒ½ä½äºéš”ç¦»çš„ç¯å¢ƒä¸­ã€‚\nè™šæ‹Ÿæœºæä¾›æ›´å¼ºå¤§çš„éš”ç¦» è™½ç„¶å®¹å™¨å¾ˆæ£’ï¼Œè¶³å¤Ÿè½»é‡çº§ã€‚ä½†é€šè¿‡ä¸Šé¢çš„æè¿°ï¼ŒåŒä¸€ä¸ªä¸»æœºä¸Šçš„å¤šä¸ªå®¹å™¨å…¶å®æ˜¯å…±äº«åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œåªæ˜¯åšåˆ°äº†æ“ä½œç³»ç»Ÿçº§çš„è™šæ‹ŸåŒ–ã€‚è™½ç„¶å‘½åç©ºé—´æä¾›äº†é«˜åº¦çš„éš”ç¦»ï¼Œä½†ä»ç„¶æœ‰å®¹å™¨å¯ä»¥è®¿é—®çš„èµ„æºï¼Œè¿™äº›èµ„æºå¹¶æ²¡æœ‰æä¾›å‘½åç©ºé—´ã€‚è¿™äº›èµ„æºæ˜¯ä¸»æœºä¸Šæ‰€æœ‰å®¹å™¨å…±æœ‰çš„ï¼Œæ¯”å¦‚å†…æ ¸ Keyringã€/procã€ç³»ç»Ÿæ—¶é—´ã€å†…æ ¸æ¨¡å—ã€ç¡¬ä»¶ã€‚\næˆ‘ä»¬éƒ½çŸ¥é“æ²¡æœ‰ 100% å®‰å…¨çš„è½¯ä»¶ï¼Œå®¹å™¨åŒ–çš„åº”ç”¨ä¹Ÿä¸€æ ·ï¼Œä»åº”ç”¨æºç åˆ°ä¾èµ–åº“åˆ°å®¹å™¨ base é•œåƒï¼Œç”šè‡³å®¹å™¨å¼•æ“æœ¬èº«éƒ½å¯èƒ½å­˜åœ¨å®‰å…¨æ¼æ´ã€‚å‘ç”Ÿå®¹å™¨é€ƒé€¸çš„é£é™©è¿œé«˜äºè™šæ‹Ÿæœºï¼Œé»‘å®¢å¯ä»¥åˆ©ç”¨è¿™äº›é€ƒé€¸æ¼æ´ï¼Œæ“ä½œå®¹å™¨çš„å¤–éƒ¨èµ„æºä¹Ÿå°±æ˜¯å®¿ä¸»æœºä¸Šçš„èµ„æºã€‚é™¤äº†æ¼æ´ï¼Œæœ‰æ—¶ä½¿ç”¨çš„ä¸å½“ä¹Ÿä¼šå¸¦æ¥å®‰å…¨é£é™©ï¼Œæ¯”å¦‚ä¸ºå®¹å™¨åˆ†é…äº†è¿‡é«˜çš„æƒé™ï¼ˆCAP_SYS_ADMIN åŠŸèƒ½ã€ç‰¹æƒæƒé™ï¼‰ï¼Œéƒ½å¯èƒ½å¯¼è‡´å®¹å™¨é€ƒé€¸ã€‚\nè€Œè™šæ‹Ÿæœºä¾é ç¡¬ä»¶çº§çš„è™šæ‹ŸåŒ–ï¼Œå®ç°çš„ç¡¬ä»¶éš”ç¦»æ¯”å‘½åç©ºé—´éš”ç¦»æä¾›äº†æ›´å¼ºå¤§çš„å®‰å…¨è¾¹ç•Œã€‚ä¸å®¹å™¨ç›¸æ¯”ï¼Œè™šæ‹Ÿæœºæä¾›äº†æ›´é«˜ç¨‹åº¦çš„éš”ç¦»ï¼Œåªå› å…¶æœ‰è‡ªå·±çš„å†…æ ¸ã€‚\nç”±æ­¤å¯è§ï¼Œå®¹å™¨å¹¶ä¸æ˜¯çœŸæ­£çš„â€œæ²™ç›’â€ï¼Œä¹Ÿå¹¶ä¸æ˜¯è½»é‡åŒ–çš„è™šæ‹Ÿæœºã€‚æœ‰æ²¡æœ‰å¯èƒ½ä¸ºå®¹å™¨å¢åŠ ä¸€ä¸ªæ›´å®‰å…¨çš„è¾¹ç•Œï¼Œå°½å¯èƒ½çš„ä¸ä¸»æœºæ“ä½œç³»ç»Ÿéš”ç¦»ï¼Œåšåˆ°ç±»ä¼¼è™šæ‹Ÿæœºçš„å¼ºéš”ç¦»ï¼Œä½¿å…¶æˆä¸ºçœŸæ­£çš„â€œæ²™ç›’â€ï¼Ÿ\næ²™ç›’åŒ–å®¹å™¨ ç­”æ¡ˆæ˜¯æœ‰ï¼Œå°±æ˜¯æ²™ç›’å®¹å™¨ã€‚è¿™ç§å®¹å™¨å°±åƒè™šæ‹Ÿæœºä¸€æ ·æœ‰è‡ªå·±çš„å†…æ ¸ï¼Œè¿™å±‚å†…æ ¸æˆä¸ºç”¨æˆ·ç©ºé—´å†…æ ¸ã€‚è¿™å±‚å†…æ ¸è¦ä¿æŒå®¹å™¨çš„è½»é‡çº§ï¼Œä½¿ç”¨ç°ä»£ç¼–ç¨‹æŠ€æœ¯ç¼–å†™ï¼Œæœ¬èº«éå¸¸è½»ï¼Œä»…ç”¨äºä½œä¸ºå®¹å™¨å’Œä¸»æœºä¹‹é—´çš„å¼ºéš”ç¦»å±‚ã€‚\nå¹¶ä¸”è¿˜è¦æ”¯æŒ OCI å’Œ CRI è§„èŒƒï¼Œå¯ä»¥ä¸ Docker å’Œ Kubernetes ç­‰å®¹å™¨å·¥å…·å¾ˆå¥½çš„é›†æˆã€‚\nè¿™é‡Œç®€å•ä»‹ç»ä¸‹ gVisor å’Œ Kata Containersã€‚\ngVisor gVisor æ˜¯ä½¿ç”¨ Go ç¼–å†™çš„åº”ç”¨å†…æ ¸ï¼Œå®ç°äº† Linux æ“ä½œç³»ç»Ÿçš„å¤§éƒ¨åˆ†æ¥å£ã€‚å…¶åŒ…å«äº†ä¸€ä¸ªå«åš runsc çš„ OCI è¿è¡Œæ—¶ï¼Œæä¾›äº†åº”ç”¨å’Œå®¿ä¸»æœºå†…æ ¸é—´çš„éš”ç¦»å±‚ã€‚runsc ä¹Ÿå®ç°äº†ä¸ Docker å’Œ Kubernetes çš„é›†æˆï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„è¿è¡Œæ²™ç›’å®¹å™¨ã€‚\ngVisor ä¸ºæ¯ä¸ªå®¹å™¨æä¾›äº†ç‹¬ç«‹çš„æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚åº”ç”¨ä¸ gVisor å†…æ ¸æä¾›çš„è™šæ‹Ÿç¯å¢ƒè¿›è¡Œäº¤äº’ï¼Œä¸æ˜¯ç›´æ¥è®¿é—®å®¿ä¸»æœºçš„å†…æ ¸ã€‚gVisor è¿˜é™åˆ¶å’Œç®¡ç†æ–‡ä»¶å’Œç½‘ç»œæ“ä½œï¼Œç¡®ä¿å®¹å™¨åŒ–åº”ç”¨å’Œä¸»æœºæ“ä½œç³»ç»Ÿä¹‹é—´æœ‰ä¸¤ä¸ªéš”ç¦»å±‚ã€‚é€šè¿‡å‡å°‘å’Œé™åˆ¶åº”ç”¨ä¸ä¸»æœºå†…æ ¸çš„äº¤äº’ï¼Œå°½å¯èƒ½å‡å°æ”»å‡»è€…ç»•è¿‡å®¹å™¨éš”ç¦»æœºåˆ¶çš„æ”»å‡»é¢ã€‚\nä¸å¤§éƒ¨åˆ†å†…æ ¸ä¸åŒï¼ŒgVisor ä¸éœ€è¦å›ºå®šçš„ç‰©ç†èµ„æºï¼›ç›¸åï¼Œå…¶åˆ©ç”¨ç°æœ‰çš„ä¸»æœºå†…æ ¸åŠŸèƒ½ï¼Œå¹¶ä½œä¸ºä¸€ä¸ªæ­£å¸¸è¿›ç¨‹è¿è¡Œã€‚æ¢å¥è¯è¯´ï¼ŒgVisor ä»¥ Linux çš„æ–¹å¼å®ç°äº† Linuxã€‚\ngVisor æ²™ç›’ç”±å¤šä¸ªè¿›ç¨‹ç»„æˆï¼Œè¿™äº›è¿›ç¨‹å…±åŒæ„æˆäº†å¯ä»¥è¿è¡Œä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„ç¯å¢ƒã€‚\næ¯ä¸ªæ²™ç›’éƒ½æœ‰å…¶ç‹¬ç«‹çš„å®ä¾‹ï¼š\nSentryï¼šè¿è¡Œå®¹å™¨çš„å†…æ ¸ï¼Œæ‹¦æˆªå¹¶å“åº”åº”ç”¨çš„ç³»ç»Ÿè°ƒç”¨ã€‚ æ²™ç›’ä¸­çš„æ¯ä¸ªå®¹å™¨éƒ½æœ‰å…¶ç‹¬ç«‹çš„å®ä¾‹ï¼š\nGoferï¼šæä¾›å®¹å™¨æ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®ã€‚ Kata Containers Kata Containers ä¸å®¹å™¨ä¸€æ ·è½»é‡çº§ä¸”å¿«ï¼Œå¹¶ä¸å®¹å™¨ç®¡ç†å±‚é›†æˆ\u0026ndash; åŒ…æ‹¬ Docker å’Œ Kubernetes ç­‰æµè¡Œçš„å®¹å™¨ç¼–æ’å·¥å…· \u0026ndash; åŒæ—¶è¿˜æä¾›äº†ä¸è™šæ‹Ÿæœºä¸€æ ·çš„å®‰å…¨ã€‚\nKata Containers ä¸ OCIã€å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰å’Œå®¹å™¨ç½‘ç»œæ¥å£ï¼ˆCNIï¼‰å®Œå…¨é›†æˆã€‚å®ƒæ”¯æŒå„ç§ç±»å‹çš„ç½‘ç»œæ¨¡å‹ï¼ˆä¾‹å¦‚ï¼Œpassthroughã€MacVTapã€æ¡¥æ¥ã€tc é•œåƒï¼‰å’Œå¯é…ç½®çš„è®¿å®¢å†…æ ¸ï¼Œä»¥ä¾¿éœ€è¦ç‰¹æ®Šç½‘ç»œæ¨¡å‹æˆ–å†…æ ¸ç‰ˆæœ¬çš„åº”ç”¨éƒ½å¯ä»¥åœ¨ä¸Šé¢è¿è¡Œã€‚ä¸Šå›¾æ˜¾ç¤ºäº† Kata VM ä¸­çš„å®¹å™¨å¦‚ä½•ä¸ç°æœ‰ç¼–æ’å¹³å°äº¤äº’ã€‚\nKata åœ¨ä¸»æœºä¸Šæœ‰ä¸€ä¸ª kata è¿è¡Œæ—¶æ¥å¯åŠ¨å’Œé…ç½®æ–°å®¹å™¨ã€‚å¯¹äº Kata VM ä¸­çš„æ¯ä¸ªå®¹å™¨ï¼Œä¸»æœºä¸Šéƒ½æœ‰ä¸€ä¸ªç›¸åº”çš„ Kata Shimã€‚Kata Shim æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ docker æˆ– kubectlï¼‰çš„ API è¯·æ±‚ï¼Œå¹¶é€šè¿‡ VSock å°†è¯·æ±‚è½¬å‘ç»™ Kata VM å†…çš„ä»£ç†ã€‚Kata å®¹å™¨è¿›ä¸€æ­¥è¿›è¡Œäº†å‡ é¡¹ä¼˜åŒ–ï¼Œä»¥å‡å°‘ VM å¯åŠ¨æ—¶é—´ã€‚\nKata Containers ç”±ä¸¤ä¸ªå¼€æºé¡¹ç›®åˆå¹¶è€Œæ¥ï¼šIntel çš„ Clear containers å’Œ Hyper runVã€‚å‰è€…æ³¨é‡æ€§èƒ½ï¼ˆå¼•å¯¼æ—¶é—´å°äº 100msï¼‰å’Œå®‰å…¨ï¼›è€Œåè€…é€šè¿‡æ”¯æŒä¸åŒçš„ CPU æ¶æ„å’Œç®¡ç†ç³»ç»Ÿï¼Œå°†æŠ€æœ¯æ— å…³æ”¾åœ¨é¦–ä½ã€‚Kata Containers å¯ä»¥è¯´é›†äºŒè€…ä¹‹å¤§æˆã€‚\nä¸ä¼ ç»Ÿçš„å®¹å™¨ç›¸æ¯”ï¼ŒKata Container åšåˆ°äº†è™šæ‹Ÿæœºçš„éš”ç¦»ï¼Œé›†è™šæ‹Ÿæœºçš„å®‰å…¨æ€§å’Œå®¹å™¨çš„æ€§èƒ½äºä¸€èº«ã€‚\næ€»ç»“ ä¸æ™®é€šå®¹å™¨ç›¸æ¯”ï¼Œæ²™ç›’å®¹å™¨æä¾›äº†æ›´å¼ºçš„éš”ç¦»æ€§ï¼Œè¿™ç§å¼ºéš”ç¦»æä¾›äº†æ›´é«˜çš„å®‰å…¨æ€§ã€‚åŒæ—¶è¿™ç±»å®¹å™¨æŠ€æœ¯æ”¯æŒ OCI å’Œ CRI è§„èŒƒï¼Œå¯ä»¥ä¸ç°æœ‰çš„å®¹å™¨å·¥å…·ä»¥åŠ Kubernetes å¾ˆå¥½çš„é›†æˆã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/sandboxed-container/","tags":["Docker","Container"],"title":"æ²™ç›’åŒ–å®¹å™¨ï¼šæ˜¯å®¹å™¨è¿˜æ˜¯è™šæ‹Ÿæœº"},{"categories":["ç¬”è®°"],"contents":"æ­¤æ–‡æ˜¯å‰æ®µæ—¶é—´ç¬”è®°çš„æ•´ç†ï¼Œä¹‹å‰è‡ªå·±å¯¹è¿™æ–¹é¢çš„å…³æ³¨ä¸å¤Ÿï¼Œå› æ­¤åšä¸‹è®°å½•ã€‚\næœ‰å¤ªå¤šçš„æ–‡ç« ä»‹ç»å¦‚ä½•è¿è¡Œå®¹å™¨ï¼Œç„¶è€Œå¦‚ä½•åœæ­¢å®¹å™¨çš„æ–‡ç« ç›¸å¯¹å°‘å¾ˆå¤šã€‚\næ ¹æ®è¿è¡Œçš„åº”ç”¨ç±»å‹ï¼Œåº”ç”¨çš„åœæ­¢è¿‡ç¨‹éå¸¸é‡è¦ã€‚å¦‚æœåº”ç”¨è¦å†™æ–‡ä»¶ï¼Œåœæ­¢å‰è¦ä¿è¯æ­£ç¡®åˆ·æ–°æ•°æ®å¹¶å…³é—­æ–‡ä»¶ï¼›å¦‚æœæ˜¯ HTTP æœåŠ¡ï¼Œè¦ç¡®ä¿åœæ­¢å‰å¤„ç†æ‰€æœ‰æœªå®Œæˆçš„è¯·æ±‚ã€‚\nä¿¡å· ä¿¡å·æ˜¯ Linux å†…æ ¸ä¸è¿›ç¨‹ä»¥åŠè¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æ–¹å¼ã€‚é’ˆå¯¹æ¯ä¸ªä¿¡å·è¿›ç¨‹éƒ½æœ‰ä¸ªé»˜è®¤çš„åŠ¨ä½œï¼Œä¸è¿‡è¿›ç¨‹å¯ä»¥é€šè¿‡å®šä¹‰ä¿¡å·å¤„ç†ç¨‹åºæ¥è¦†ç›–é»˜è®¤çš„åŠ¨ä½œï¼Œé™¤äº† SIGSTOP å’Œ SIGKILLã€‚äºŒè€…éƒ½ä¸èƒ½è¢«æ•è·æˆ–é‡å†™ï¼Œå‰è€…ç”¨æ¥å°†è¿›ç¨‹æš‚åœåœ¨å½“å‰çŠ¶æ€ï¼Œè€Œåè€…åˆ™æ˜¯ä»å†…æ ¸å±‚é¢ç«‹å³æ€æ‰è¿›ç¨‹ã€‚\næœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„è¿›ç¨‹ SIGTERM å’Œ SIGKILLã€‚SIGTERM æ˜¯ä¼˜é›…åœ°å…³é—­å‘½ä»¤ï¼ŒSIGKILL åˆ™æ˜¯æš´åŠ›çš„å…³é—­å‘½ä»¤ã€‚æ¯”å¦‚ Dockerï¼Œå®¹å™¨ä¼šå…ˆæ”¶åˆ° SIGTERM ä¿¡å·ï¼Œ10s åä¼šæ”¶åˆ° SIGKILL ä¿¡å·ã€‚\nè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ä¿¡å·ï¼Œåªæ˜¯é™å®šäºç‰¹å®šçš„ä¸Šä¸‹æ–‡ã€‚\nä¸­æ–­ ç¡¬ä»¶çš„ä¸­æ–­å°±åƒæ“ä½œç³»ç»Ÿçš„ä¿¡å·ã€‚é€šå¸¸å‘ç”Ÿåœ¨ç¡¬ä»¶æƒ³è¦å‘æ“ä½œç³»ç»Ÿæ³¨å†Œäº‹ä»¶æ—¶ã€‚æ“ä½œç³»ç»Ÿå¿…é¡»ç«‹å³åœæ­¢è¿è¡Œï¼Œå¹¶å¤„ç†ä¸­æ–­ã€‚\næ¯”è¾ƒå¸¸è§çš„ä¸­æ–­ä¾‹å­å°±æ˜¯é”®ç›˜ä¸­æ–­ï¼Œæ¯”å¦‚æŒ‰ä¸‹ ctrl+z æˆ–è€… ctrl+cã€‚Linux å°†å…¶åˆ†åˆ«è½¬æ¢æˆ SIGTSTP å’Œ SIGINTã€‚ç¡¬ä»¶ä¸­æ–­è¿‡å»é€šå¸¸ç”¨æ¥å¤„ç†é”®ç›˜å’Œé¼ æ ‡è¾“å…¥ï¼Œä½†å¦‚ä»Šè¢«ç”¨ä½œæ“ä½œç³»ç»Ÿè½¯ä»¶é©±åŠ¨å±‚é¢çš„ä¿¡å·è½®è®­ã€‚\nDocker å‰é¢è¯´äº†è¿™ä¹ˆå¤šç»ˆäºæ¥åˆ° Dockerï¼Œå®¹å™¨çš„ç‹¬ç‰¹ä¹‹å¤„åœ¨äºé€šå¸¸åªè¿è¡Œä¸€ä¸ªè¿›ç¨‹ã€‚å³ä½¿æ˜¯å•è¿›ç¨‹ï¼Œå®¹å™¨å†… PID ä¸º 1 çš„è¿›ç¨‹ä¹Ÿå…·æœ‰ init ç³»ç»Ÿçš„ç‰¹æ®Šè§„åˆ™å’ŒèŒè´£ã€‚\nPID 1 åœ¨ Linux ä¸­éå¸¸é‡è¦ï¼Œé€šå¸¸æ˜¯ init è¿›ç¨‹ã€‚é€šå¸¸è¿›ç¨‹åœ¨æ”¶åˆ° SIGTERM ä¿¡å·åï¼Œå‡å¦‚ä¸å¯¹ä¿¡å·è¿›ç¨‹å¤„ç†ï¼Œä¼šå¿«é€Ÿé€€å‡ºã€‚ä½† PID 1 çš„è¿›ç¨‹æ”¶åˆ° SIGTERM ä¹‹åå‡å¦‚ä¸å¯¹ä¿¡å·è¿›è¡Œå¤„ç†åˆ™ä»€ä¹ˆéƒ½ä¸ä¼šåšã€‚\nå®¹å™¨å†… PID 1 é€šå¸¸æœ‰ä¸¤ç§æƒ…å†µï¼š shell è¿›ç¨‹ PID ä¸º 1 å’Œä½ çš„è¿›ç¨‹ PID ä¸º 1ã€‚åˆ†åˆ«å¯¹åº”ç€ shell å’Œ exec æ ¼å¼çš„å‘½ä»¤ã€‚\nshell æ ¼å¼ Dockerfile æœ‰ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯å¦‚æœä¸ä½¿ç”¨ JSON æ ¼å¼ æ¥æŒ‡å®šå®¹å™¨å‘½ä»¤ï¼Œä¼šé€šè¿‡ shell ä»¥ fork çš„å½¢å¼æ¥æ‰§è¡Œå‘½ä»¤ï¼Œä¹Ÿå°±æ˜¯ /bin/sh -cã€‚\ndocker runï¼ˆå®¿ä¸»æœºä¸Šï¼‰ /bin/sh -cï¼ˆPID 1ï¼Œå®¹å™¨å†…ï¼‰ /loop.sh ï¼ˆPID 2ï¼Œå®¹å™¨å†…ï¼‰ è¿™ç§æ ¼å¼çš„å‘½ä»¤ç‰¹ç‚¹æ˜¯ä¸ä¼šå‘ä¸šåŠ¡è¿›ç¨‹å‘é€ä¿¡å·ã€‚æ¯”å¦‚å‘é€ç»™ shell çš„ SIGTERM ä¿¡å·ä¸ä¼šè½¬å‘ç»™å­è¿›ç¨‹ï¼Œè€Œæ˜¯ç­‰å¾…å­è¿›ç¨‹çš„é€€å‡ºã€‚å”¯ä¸€æ€æ­»å®¹å™¨çš„æ–¹å¼å°±æ˜¯å‘é€ SIGKILL ä¿¡å·ï¼Œæˆ–è€…ç¢°å·§å­è¿›ç¨‹è‡ªå·±å´©æºƒã€‚\næ‰€ä»¥åº”è¯¥å°½é‡é¿å…ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œ\nexec æ ¼å¼ è¿™ä¸ªå°±æ˜¯ Dockerfile çš„æ¨èè¯­æ³•äº†ï¼Œä½ çš„è¿›ç¨‹ä¼šç«‹å³å¯åŠ¨å¹¶ä½œä¸ºå®¹å™¨çš„åˆå§‹åŒ–è¿›ç¨‹ï¼Œç„¶åå°±æœ‰äº†ä¸‹é¢çš„è¿›ç¨‹æ ‘ï¼š\ndocker runï¼ˆå®¿ä¸»æœºä¸Šï¼‰ /loop.shï¼ˆPID 1ï¼Œå®¹å™¨å†…ï¼‰ è¯´äº†è¿™ä¹ˆå¤šï¼Œå¾ˆå¤šäººè§‰å¾—ä¸å¤Ÿç›´è§‚ã€‚æˆ‘ä»¬ä¼šç”¨ç¤ºä¾‹åº”ç”¨æ¥è¿›è¡Œè¯´æ˜ï¼Œä½†åœ¨è¿™ä¹‹å‰ç®€å•è¯´ä¸‹å¦‚ä½•å‘é€ä¿¡å·æ¥åœæ­¢å®¹å™¨ã€‚\nå‘é€ä¿¡å· æœ‰å‡ ç§æ–¹å¼æ¥åœæ­¢å®¹å™¨ã€‚\ndocker stop é»˜è®¤æƒ…å†µä¸‹ docker stop å‘½ä»¤ä¼šå‘å®¹å™¨å‘é€ SIGTERM ä¿¡å·ï¼Œç„¶åç­‰å¾… 10sï¼Œå¦‚æœå®¹å™¨æ²¡åœæ­¢å†å‘é€ SIGKILL ä¿¡å·ã€‚\nåœ¨ Dockerfile ä¸­ï¼Œå¯ä»¥é€šè¿‡ STOPSIGNAL æŒ‡ä»¤æ¥è®¾ç½®é»˜è®¤çš„é€€å‡ºä¿¡å·ï¼Œæ¯”å¦‚ STOPSIGNAL SIGKILL å°†é€€å‡ºä¿¡å·è®¾ç½®ä¸º SIGKILLã€‚æˆ–è€…åœ¨ docker run æ˜¯é€šè¿‡ --stop-signal å‚æ•°æ¥è¦†ç›–é•œåƒä¸­çš„ STOPSIGNAL è®¾ç½®ã€‚\ndocker kill é»˜è®¤æƒ…å†µä¸‹ docker kill ä¼šç›´æ¥æ€æ­»å®¹å™¨ï¼Œä¸ç»™å®¹å™¨ä»»ä½•æœºä¼šè¿›è¡Œä¼˜é›…åœæ­¢ï¼Œè¿™é‡Œå‘å‡ºçš„å°±æ˜¯ SIGKILL ä¿¡å·ã€‚\nå½“ç„¶ docker kill å¯ä»¥é€šè¿‡ --signal æ¥æŒ‡å®šè¦å‘é€çš„ä¿¡å·ï¼Œç±»ä¼¼ Linux çš„ kill å‘½ä»¤ï¼š\ndocker kill ----signal=SIGTERM foo docker rm -f é€šå¸¸æƒ…å†µä¸‹ docker rm ç”¨æ¥åˆ é™¤å·²ç»åœæ­¢çš„å®¹å™¨ï¼Œä½†æ˜¯åŠ ä¸Š --forceï¼ˆç®€å†™ -fï¼‰ä¼šå¼ºåˆ¶åˆ é™¤æ­£åœ¨è¿è¡Œçš„å®¹å™¨ã€‚åŒæ ·ï¼Œä¹Ÿä¸ä¼šç»™å®¹å™¨ä»»ä½•ä¼˜åŒ–åœæ­¢çš„æœºä¼šã€‚\nä¿¡å·å¤„ç† æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç®€å•çš„åº”ç”¨å¯¹ shell å’Œ exec ä¸¤ç§æ ¼å¼åšä¸‹å¯¹æ¯”ã€‚åœ¨è¿™ä¸ªåº”ç”¨ä¸­ï¼Œå¯¹ SIGTERM è¿›è¡Œå¤„ç†ï¼šæ”¶åˆ°ä¿¡å·åé€€å‡ºã€‚\n#!/usr/bin/env sh trap \u0026#39;exit 0\u0026#39; SIGTERM while true; do :; done æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ä¸¤ç§ä¸åŒæ ¼å¼çš„ CMD æ¥æ„å»ºé•œåƒã€‚\nshell æ ¼å¼ ä½¿ç”¨ä¸‹é¢çš„ Dockerfile æ¥æ„å»ºé•œåƒ termã€‚\nFROM alpine:3.15.0 COPY loop.sh / CMD /loop.sh æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ„å»ºé•œåƒã€å¯åŠ¨å®¹å™¨ã€åœæ­¢å®¹å™¨ã€‚\ndocker build -t term . docker run --name term -d term docker stop term æ­¤æ—¶ä½ ä¼šå‘ç°å®¹å™¨å¹¶æ²¡æœ‰ç«‹åˆ»åœæ­¢ï¼Œè€Œæ˜¯å¤§çº¦ 10s ä¹‹åæ‰è¢«åœæ­¢ã€‚å¯ä»¥é€šè¿‡å‘½ä»¤æŸ¥çœ‹å®¹å™¨çš„é€€å‡ºçŠ¶æ€ï¼š\ndocker inspect -f \u0026#39;{{.State.ExitCode}}\u0026#39; term 137 137 = 128 + 9 è¯´æ˜å®¹å™¨çš„é€€å‡ºä¿¡å·æ˜¯ SIGKILLã€‚\nexec æ ¼å¼ è°ƒæ•´ä¸‹ Dockerfileï¼Œå°† CMD ä¿®æ”¹ä¸ºæ¨èçš„ JSON æ ¼å¼ï¼š\nFROM ubuntu:trusty COPY loop.sh / CMD [\u0026#34;/loop.sh\u0026#34;] æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ„å»ºé•œåƒã€å¯åŠ¨å®¹å™¨ã€åœæ­¢å®¹å™¨ã€‚ï¼ˆéœ€è¦å…ˆæ‰§è¡Œ docker rm term åˆ é™¤ä¹‹å‰åœæ­¢çš„å®¹å™¨ï¼‰\ndocker build -t term . docker run --name term -d term docker stop term æ­¤æ—¶å®¹å™¨ä¼šç«‹åˆ»é€€å‡ºã€‚æŸ¥çœ‹å®¹å™¨çš„é€€å‡ºçŠ¶æ€ï¼š\ndocker inspect -f \u0026#39;{{.State.ExitCode}}\u0026#39; term 0 æ€»ç»“ docker rm -f å’Œ docker kill å¹²æ‰å®¹å™¨å¾ˆå®¹å™¨ï¼Œä½†æ˜¯ä¸ºäº†å®ç°å®¹å™¨çš„ä¼˜é›…é€€å‡ºï¼Œåº”è¯¥ä½¿ç”¨ docker stop å‘½ä»¤ï¼ŒåŒæ—¶ Dockerfile ä¸­åº”å°½é‡é¿å…ä½¿ç”¨ shell æ ¼å¼è®¾ç½® ENTRYPONT æˆ–è€… CMDã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/gracefully-stopping-docker-containers-with-correct-command/","tags":["Docker"],"title":"ä» Docker çš„ä¿¡å·æœºåˆ¶çœ‹å®¹å™¨çš„ä¼˜é›…åœæ­¢"},{"categories":["ç¬”è®°"],"contents":"å°†åº”ç”¨éƒ¨ç½²åˆ° Kubernetes æ—¶é€šå¸¸ä¼šä½¿ç”¨ Deploymentã€Serviceã€Ingressï¼Œæ•´ä¸ªåº”ç”¨ä»éƒ¨ç½²åˆ°æ­£å¸¸è¿è¡Œï¼Œç»å†çš„æµç¨‹å¾ˆé•¿ã€‚ä» kubectl apply YAML æ–‡ä»¶ï¼Œç»è¿‡ apiserverã€controller managerã€schedulerã€kubeletã€ä»¥åŠ CRIã€CNI ç­‰ä¼—å¤šç»„ä»¶çš„ååŒå·¥ä½œã€‚\næ¼«é•¿çš„â€œè¡Œç¨‹â€ï¼ŒPod ä¹Ÿç»å†å„ç§æ­£å¸¸å’Œä¸æ­£å¸¸çš„çŠ¶æ€å˜åŒ–ï¼Œå³ä½¿æ­£å¸¸è¿è¡Œä¹Ÿä¼šå‡ºç°æœåŠ¡æ— æ³•è®¿é—®çš„é—®é¢˜ã€‚å¯¹äºåˆšå¼€å§‹åœ¨ Kubernetes å¹³å°å¼€å±•å·¥ä½œçš„åŒå­¦æ¥è¯´ï¼Œæ•…éšœçš„æ’æŸ¥ç¡®å®æ£˜æ‰‹ã€‚ä¹‹å‰å·¥ä½œçš„æ—¶å€™ï¼Œç»å¸¸è¦ååŠ©æ’æŸ¥å„ç§é—®é¢˜ã€‚å»å¹´åœ¨ Learnk8s ä¸Šçœ‹åˆ°äº†å…³äº Deployment æ•…éšœæ’æŸ¥çš„è§†å›¾ï¼Œæˆ‘è¿˜å‚è€ƒåšäº†å½“æ—¶æ•´ä¸ªå¹³å°çš„æ•…éšœæ’æŸ¥è§†å›¾ï¼ŒåŒ…æ‹¬äº†ä»é¡¹ç›®æºç ã€CICD æµæ°´çº¿ã€éƒ¨ç½²æ•´ä¸ªæµç¨‹çš„æ•…éšœæ’æŸ¥å‚è€ƒã€‚\nç°åœ¨ Learnk8s çš„ Deployment æ’æŸ¥æŒ‡å—æ›´æ–°äº†ï¼Œä¹Ÿæœ‰äº†ä¸­æ–‡ç‰ˆæœ¬ã€‚\nå¹´ä¸­ç¿»è¯‘ Learnk8s çš„æ–‡ç« ã€ŠKubernetes çš„è‡ªåŠ¨ä¼¸ç¼©ä½ ç”¨å¯¹äº†å—ï¼Ÿã€‹ æ—¶ï¼Œä¸ Daniele Polencic æ²Ÿé€šæ—¶è¢«é—®åŠæ˜¯å¦èƒ½ç¿»è¯‘æ•…éšœæ’æŸ¥çš„å¯è§†åŒ–æŒ‡å—ã€‚\nå¹´ä¸­çš„æ—¶å€™å°±ç¿»è¯‘å®Œäº†ï¼Œä»Šå¤©ç”µæŠ¥ä¸Šè¢«å‘ŠçŸ¥æ–‡ç«  A visual guide on troubleshooting Kubernetes deploymentså·²æ›´æ–°ï¼Œæ’æŸ¥è§†å›¾è¾ƒä¸Šä¸€ç‰ˆæœ‰äº†éƒ¨åˆ†çš„è°ƒæ•´ã€‚\nåŸæ–‡ï¼šhttps://learnk8s.io/troubleshooting-deployments\nä¸­æ–‡ç‰ˆPDFï¼šhttps://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.zh_cn.v2.pdf\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/troubleshooting-kubernetes-deployment-zh-v2/","tags":["Kubernetes","äº‘åŸç”Ÿ"],"title":"Kubernetes Deployment çš„æ•…éšœæ’æŸ¥å¯è§†åŒ–æŒ‡å—ï¼ˆ2021 ä¸­æ–‡ç‰ˆï¼‰"},{"categories":["ç¬”è®°"],"contents":"æœ€è¿‘æ¢ä¸Šäº† MacBook Pro 2021ï¼Œä¹Ÿæ…¢æ…¢å°†å·¥ä½œè½¬åˆ°æ–°çš„ç”µè„‘ä¸Šã€‚ç»“æŸäº†ä¸€å¹´å¤šçš„é»‘ç™½é…ï¼Œä¹‹å‰å·¥ä½œä¸»åŠ›æœºæ˜¯æˆ‘çš„é»‘è‹¹æœï¼Œé…ç½®ä»¥åŠ OpenCore çš„å¼•å¯¼æ”¾åœ¨è¿™é‡Œäº†ã€‚\nä¸ºäº†ç¨³å®šæ€§ï¼Œç³»ç»Ÿä¸€ç›´åœç•™åœ¨äº† 10.15.4ã€‚æ–°çš„ç”µè„‘æ‹¿åˆ°æ‰‹å°±æ˜¯ 12.0.1ï¼Œä¹‹å‰ä¹Ÿå°±åœ¨æˆ‘å¦ä¸€å° 2016 æ¬¾çš„ macbook pro ä¸Šç”¨è¿‡å‡ ä¸ªå‘¨çš„ 12.0.0ã€‚\næ–°çš„ç³»ç»ŸåŠ ä¸Šæ–°çš„æ¶æ„ï¼Œä¸å…æœ‰æœ‰äº› bugï¼Œä»Šå¤©å°±è¯´ä¸‹æˆ‘æ‰€é‡åˆ°çš„ä¸¤ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„ã€‚\n1. å®‰å…¨ç›¸å…³ EXC_BAD_ACCESS (SIGKILL (Code Signature Invalid))\nå…¬å¸çš„æ ¸å¿ƒäº§å“æ˜¯ç”¨ c++ å¼€å‘çš„ï¼Œç¼–è¯‘ä¹‹åæˆ‘éƒ½ä¹ æƒ¯æ€§çš„æ”¾åˆ° /usr/local/bin ç›®å½•ä¸­ã€‚åœ¨æ–°ç³»ç»Ÿä¸­ï¼Œå°±å‡ºç°äº†ä¸Šé¢çš„é”™è¯¯ï¼ˆä»æ§åˆ¶å°è·å–ï¼‰ï¼Œè¿è¡Œçš„æ—¶å€™è¿›ç¨‹ç›´æ¥è¢« killã€‚\nç½‘ä¸ŠæŸ¥äº†ä¸‹ï¼Œè¯´ä¸ kernel cache æœ‰å…³ï¼Œé‡å¯å¯è§£å†³ã€‚\nThis was caused by kernel caching of previously signed binaries and my replacing those binaries with newly compiled binaries which weren\u0026rsquo;t part of a signed package.\nBy deleting the existing binaries, rebooting the Mac to clear the kernel cache, and then recopying the new binaries into place, I sorted the issue.\nä½†æ˜¯æ¯æ¬¡éƒ½è¦é‡å¯æœ‰ç‚¹éº»çƒ¦ï¼Œé€šè¿‡ä¸æ—§ç”µè„‘ä¸­ç›®å½•å¯¹æ¯”ï¼Œæœ€åå°†äºŒè¿›åˆ¶æ–‡ä»¶ç›´æ¥å¤åˆ¶åˆ° /opt/homebrew/bin è§£å†³ï¼Œè¿™ä¸ªç›®å½•çš„ ownership ä¸æ˜¯ root çš„ã€‚\nå¦‚æœé—®é¢˜è¿˜ä¼šå‡ºç°ï¼Œå¯ä»¥åšä¸€ä¸ªè½¯é“¾æ¥å°†äºŒè¿›åˆ¶æ–‡ä»¶é“¾æ¥åˆ° /opt/homebrew/bin ä¸‹ã€‚\n2. Clang ç‰ˆæœ¬ è¿™ä¸ªé—®é¢˜ä¹Ÿæ˜¯æ’æŸ¥äº†ç‰ˆæœ¬ï¼Œè¿˜æ˜¯ä½¿ç”¨å…¬å¸äº§å“çš„æ—¶å€™é‡åˆ°çš„ã€‚å½“å¤„ç†çš„ JSON ä¸­åŒ…å«æ•°ç»„ï¼Œæ¯”å¦‚ {\u0026quot;a\u0026quot;: []}ï¼Œåº”ç”¨å¯åŠ¨å¤±è´¥ã€‚ä»æ§åˆ¶å°æ¥çœ‹ï¼Œé”™è¯¯ç æ˜¯ EXC_BAD_ACCESS (SIGSEGV)ï¼ŒæŠ¥é”™çš„å †æ ˆæ­£å¥½æ˜¯åœ¨å¤„ç† JSON arrayã€‚\næœ‰é—®é¢˜çš„ç‰ˆæœ¬ï¼š\nApple clang version 13.0.0 (clang-1300.0.29.3) Target: arm64-apple-darwin21.1.0 Thread model: posix InstalledDir: /Library/Developer/CommandLineTools/usr/bin æ­£å¸¸çš„ç‰ˆæœ¬ï¼š\nApple clang version 12.0.0 (clang-1200.0.32.29) Target: arm64-apple-darwin20.1.0 Thread model: posix InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin æœ€ååœ¨æ„å»ºçš„æ—¶å€™ï¼Œå°† CMAKE_BUILD_TYPE è®¾ç½®ä¸º Debug ä¸´æ—¶è§£å†³ã€‚Debug æ¨¡å¼ä¸‹ç¼–è¯‘å™¨ä¸åšä»»ä½•ä¼˜åŒ–ã€‚\næœŸå¾…ç³»ç»Ÿå‡çº§èƒ½å¤Ÿä¿®å¤ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/bug-with-m1-pro-and-monterey/","tags":["macOS"],"title":"Monterey 12.0.1 ä¸Šçš„ bug"},{"categories":["ç¬”è®°"],"contents":"TL;DR æœ¬æ–‡å†…å®¹ï¼š\nä»‹ç» distroless é•œåƒã€ä½œç”¨ä»¥åŠç®€å•çš„ä½¿ç”¨ å¦‚ä½•é’ˆå¯¹ distroless å®¹å™¨çš„è¿›è¡Œè°ƒè¯• ä¸´æ—¶å®¹å™¨(v.1.18+)çš„ä½¿ç”¨ Distroless é•œåƒ Distroless å®¹å™¨ï¼Œé¡¾åæ€ä¹‰ä½¿ç”¨ Distroless é•œåƒä½œä¸ºåŸºç¡€é•œåƒè¿è¡Œçš„å®¹å™¨ã€‚\n\u0026ldquo;Distroless\u0026rdquo; é•œåƒåªåŒ…å«äº†ä½ çš„åº”ç”¨ç¨‹åºä»¥åŠå…¶è¿è¡Œæ—¶æ‰€éœ€è¦çš„ä¾èµ–ã€‚ä¸åŒ…å«ä½ èƒ½åœ¨æ ‡å‡† Linxu å‘è¡Œç‰ˆé‡Œçš„å¯ä»¥æ‰¾åˆ°çš„åŒ…ç®¡ç†å™¨ã€shells æˆ–è€…å…¶ä»–ç¨‹åºã€‚\nGoogleContainerTools/distroless é’ˆå¯¹ä¸åŒè¯­è¨€æä¾›äº† distroless é•œåƒï¼š\ngcr.io/distroless/static-debian11 gcr.io/distroless/base-debian11 gcr.io/distroless/java-debian11 gcr.io/distroless/cc-debian11 gcr.io/distroless/nodejs-debian11 gcr.io/distroless/python3-debian11 Distroless é•œåƒæœ‰ä»€ä¹ˆç”¨ï¼Ÿ é‚£äº›å¯èƒ½æ˜¯æ„å»ºé•œåƒæ—¶éœ€è¦çš„ï¼Œä½†å¤§éƒ¨åˆ†å¹¶ä¸æ˜¯è¿è¡Œæ—¶éœ€è¦çš„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸Šç¯‡æ–‡ç« ä»‹ç» Buildpacks æ—¶è¯´çš„ä¸€ä¸ª builder çš„ stack é•œåƒåŒ…å«æ„å»ºæ—¶åŸºç¡€é•œåƒå’Œè¿è¡Œæ—¶åŸºç¡€é•œåƒï¼Œè¿™æ ·å¯ä»¥åšåˆ°é•œåƒçš„æœ€å°åŒ–ã€‚\nå…¶å®æ§åˆ¶ä½“ç§¯å¹¶ä¸æ˜¯ distroless é•œåƒçš„ä¸»è¦ä½œç”¨ã€‚å°†è¿è¡Œæ—¶å®¹å™¨ä¸­çš„å†…å®¹é™åˆ¶ä¸ºåº”ç”¨ç¨‹åºæ‰€éœ€çš„ä¾èµ–ï¼Œæ­¤å¤–ä¸åº”è¯¥å®‰è£…ä»»ä½•ä¸œè¥¿ã€‚è¿™ç§æ–¹å¼å¯èƒ½æå¤§çš„æå‡å®¹å™¨çš„å®‰å…¨æ€§ï¼Œä¹Ÿæ˜¯ distroless é•œåƒçš„æœ€é‡è¦ä½œç”¨ã€‚\nè¿™é‡Œå¹¶ä¸ä¼šå†æ·±å…¥æ¢ç©¶ distroless é•œåƒï¼Œè€Œæ˜¯å¦‚ä½•è°ƒè¯• distroless å®¹å™¨\næ²¡æœ‰äº†åŒ…ç®¡ç†å™¨ï¼Œé•œåƒæ„å»ºå®Œæˆåå°±ä¸èƒ½å†ä½¿ç”¨ç±»ä¼¼ aptã€yum çš„åŒ…ç®¡ç†å·¥å…·ï¼›æ²¡æœ‰äº† shellï¼Œå®¹å™¨è¿è¡Œåæ— æ³•å†è¿›å…¥å®¹å™¨ã€‚\nâ€œå°±åƒä¸€ä¸ªæ²¡æœ‰ä»»ä½•é—¨çš„æˆ¿é—´ï¼Œä¹Ÿæ— æ³•å®‰è£…é—¨ã€‚â€ Distroless é•œåƒåœ¨æå‡å®¹å™¨å®‰å…¨æ€§çš„åŒæ—¶ï¼Œä¹Ÿä¸ºè°ƒè¯•å¢åŠ äº†éš¾åº¦ã€‚\nä½¿ç”¨ distroless é•œåƒ å†™ä¸ªå¾ˆç®€å•çš„ golang åº”ç”¨ï¼š\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; ) func defaultHandler(w http.ResponseWriter, r *http.Request) { fmt.Fprintf(w, \u0026#34;Hello world!\u0026#34;) } func main() { http.HandleFunc(\u0026#34;/\u0026#34;, defaultHandler) http.ListenAndServe(\u0026#34;:8080\u0026#34;, nil) } æ¯”å¦‚ä½¿ç”¨ gcr.io/distroless/base-debian11 ä½œä¸º golang åº”ç”¨çš„åŸºç¡€é•œåƒï¼š\nFROM golang:1.12 as build-env WORKDIR /go/src/app COPY . /go/src/app RUN go get -d -v ./... RUN go build -o /go/bin/app FROM gcr.io/distroless/base-debian11 COPY --from=build-env /go/bin/app / CMD [\u0026#34;/app\u0026#34;] ä½¿ç”¨é•œåƒåˆ›å»º deployment\n$ kubectl create deploy golang-distroless --image addozhang/golang-distroless-example:latest $ kubectl get po NAME READY STATUS RESTARTS AGE golang-distroless-784bb4875-srmmr 1/1 Running 0 3m2s å°è¯•è¿›å…¥å®¹å™¨ï¼š\n$ kubectl exec -it golang-distroless-784bb4875-srmmr -- sh error: Internal error occurred: error executing command in container: failed to exec in container: failed to start exec \u0026#34;b76e800eafa85d39f909f39fcee4a4ba9fc2f37d5f674aa6620690b8e2939203\u0026#34;: OCI runtime exec failed: exec failed: container_linux.go:380: starting container process caused: exec: \u0026#34;sh\u0026#34;: executable file not found in $PATH: unknown å¦‚ä½•è°ƒè¯• Distroless å®¹å™¨ 1. ä½¿ç”¨ distroless debug é•œåƒ GoogleContainerTools ä¸ºæ¯ä¸ª distroless é•œåƒéƒ½æä¾›äº† debug tagï¼Œé€‚åˆåœ¨å¼€å‘é˜¶æ®µè¿›è¡Œè°ƒè¯•ã€‚å¦‚ä½•ä½¿ç”¨ï¼Ÿæ›¿æ¢å®¹å™¨çš„ base é•œåƒï¼š\nFROM golang:1.12 as build-env WORKDIR /go/src/app COPY . /go/src/app RUN go get -d -v ./... RUN go build -o /go/bin/app FROM gcr.io/distroless/base-debian11:debug # use debug tag here COPY --from=build-env /go/bin/app / CMD [\u0026#34;/app\u0026#34;] é‡æ–°æ„å»ºé•œåƒå¹¶éƒ¨ç½²ï¼Œå¾—ç›Šäºdebugé•œåƒä¸­æä¾›äº† busybox shell è®©æˆ‘ä»¬å¯ä»¥ exec åˆ°å®¹å™¨ä¸­ã€‚\n2. debug å®¹å™¨ä¸å…±äº«è¿›ç¨‹å‘½åç©ºé—´ åŒä¸€ä¸ª pod ä¸­å¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œé€šè¿‡è®¾ç½® pod.spec.shareProcessNamespace ä¸º trueï¼Œæ¥è®©åŒä¸€ä¸ª Pod ä¸­çš„å¤šå®¹å™¨å…±äº«åŒä¸€ä¸ªè¿›ç¨‹å‘½åç©ºé—´ã€‚\nShare a single process namespace between all of the containers in a pod. When this is set containers will be able to view and signal processes from other containers in the same pod, and the first process in each container will not be assigned PID 1. HostPID and ShareProcessNamespace cannot both be set. Optional: Default to false.\næ·»åŠ ä¸€ä¸ªä½¿ç”¨ ubuntu é•œåƒçš„ debug å®¹å™¨ï¼Œè¿™é‡Œä¸ºäº†æµ‹è¯•ï¼ˆåé¢è§£é‡Šï¼‰æˆ‘ä»¬ä¸ºåŸå®¹å™¨æ·»åŠ  securityContext.runAsUser: 1000ï¼Œæ¨¡æ‹Ÿä¸¤ä¸ªå®¹å™¨ä½¿ç”¨ä¸åŒçš„ UID è¿è¡Œï¼š\napiVersion: apps/v1 kind: Deployment metadata: creationTimestamp: null labels: app: golang-distroless name: golang-distroless spec: replicas: 1 selector: matchLabels: app: golang-distroless strategy: {} template: metadata: creationTimestamp: null labels: app: golang-distroless spec: shareProcessNamespace: true containers: - image: addozhang/golang-distroless-example:latest name: golang-distroless-example securityContext: runAsUser: 1000 resources: {} - image: ubuntu name: debug args: [\u0026#39;sleep\u0026#39;, \u0026#39;1d\u0026#39;] securityContext: capabilities: add: - SYS_PTRACE resources: {} status: {} æ›´æ–° deployment ä¹‹åï¼š\n$ kubectl get po NAME READY STATUS RESTARTS AGE golang-distroless-85c4896c45-rkjwn 2/2 Running 0 3m12s $ kubectl get po -o json | jq -r \u0026#39;.items[].spec.containers[].name\u0026#39; golang-distroless-example debug ç„¶åé€šè¿‡ debug å®¹å™¨æ¥è¿›å…¥åˆ° pod ä¸­ï¼š\n$ kubectl exec -it golang-distroless-85c4896c45-rkjwn -c debug -- sh ç„¶ååœ¨å®¹å™¨ä¸­æ‰§è¡Œï¼š\n$ ps -ef UID PID PPID C STIME TTY TIME CMD root 1 0 0 14:54 ? 00:00:00 /pause # infra å®¹å™¨ 1000 7 0 0 14:54 ? 00:00:00 /app # åŸå®¹å™¨ï¼ŒUID ä¸º 1000 root 19 0 0 14:55 ? 00:00:00 sleep 1d # debug å®¹å™¨ root 25 0 0 14:55 pts/0 00:00:00 sh root 32 25 0 14:55 pts/0 00:00:00 ps -ef å°è¯•è®¿é—® è¿›ç¨‹ 7 çš„è¿›ç¨‹ç©ºé—´ï¼š\n$ cat /proc/7/environ $ cat: /proc/7/environ: Permission denied æˆ‘ä»¬éœ€è¦ä¸º debug å®¹å™¨åŠ ä¸Šï¼š\nsecurityContext: capabilities: add: - SYS_PTRACE ä¹‹åå†è®¿é—®å°±æ­£å¸¸äº†ï¼š\n$ cat /proc/7/environ PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binHOSTNAME=golang-distroless-58b6c5f455-v9zkvSSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crtKUBERNETES_PORT_443_TCP=tcp://10.43.0.1:443KUBERNETES_PORT_443_TCP_PROTO=tcpKUBERNETES_PORT_443_TCP_PORT=443KUBERNETES_PORT_443_TCP_ADDR=10.43.0.1KUBERNETES_SERVICE_HOST=10.43.0.1KUBERNETES_SERVICE_PORT=443KUBERNETES_SERVICE_PORT_HTTPS=443KUBERNETES_PORT=tcp://10.43.0.1:443HOME=/root åŒæ ·æˆ‘ä»¬ä¹Ÿå¯ä»¥è®¿é—®è¿›ç¨‹çš„æ–‡ä»¶ç³»ç»Ÿï¼š\n$ cd /proc/7/root $ ls app bin boot dev etc home lib lib64 proc root run sbin sys tmp usr var æ— éœ€ä¿®æ”¹å®¹å™¨çš„åŸºç¡€é•œåƒï¼Œä½¿ç”¨ pod.spec.shareProcessNamespace: true é…åˆå®‰å…¨é…ç½®ä¸­å¢åŠ  SYS_PTRACE ç‰¹æ€§ï¼Œä¸º debug å®¹å™¨èµ‹äºˆå®Œæ•´çš„ shell è®¿é—®æ¥è°ƒè¯•åº”ç”¨ã€‚ä½†æ˜¯ä¿®æ”¹ YAML å’Œå®‰å…¨é…ç½®åªé€‚åˆåœ¨æµ‹è¯•ç¯å¢ƒä½¿ç”¨ï¼Œåˆ°äº†ç”Ÿäº§ç¯å¢ƒè¿™äº›éƒ½æ˜¯ä¸å…è®¸çš„ã€‚\næˆ‘ä»¬å°±éœ€è¦ç”¨åˆ° kubectl debug äº†ã€‚\n3. Kubectl debug é’ˆå¯¹ä¸åŒçš„èµ„æº kubectl debug å¯ä»¥è¿›è¡Œä¸åŒæ“ä½œï¼š\nè´Ÿè½½ï¼šåˆ›å»ºä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ Pod çš„æ‹·è´ï¼Œå¹¶å¯ä»¥ä¿®æ”¹éƒ¨åˆ†å±æ€§ã€‚æ¯”å¦‚åœ¨æ‹·è´ä¸­ä½¿ç”¨æ–°ç‰ˆæœ¬çš„tagã€‚ è´Ÿè½½ï¼šä¸ºè¿è¡Œä¸­çš„ Pod å¢åŠ ä¸€ä¸ªä¸´æ—¶å®¹å™¨ï¼ˆä¸‹é¢ä»‹ç»ï¼‰ï¼Œä½¿ç”¨ä¸´æ—¶å®¹å™¨ä¸­çš„å·¥å…·è°ƒè¯•ï¼Œæ— éœ€é‡å¯ Podã€‚ èŠ‚ç‚¹ï¼šåœ¨èŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ª Pod è¿è¡Œåœ¨èŠ‚ç‚¹çš„ host å‘½åç©ºé—´ï¼Œå¯ä»¥è®¿é—®èŠ‚ç‚¹çš„æ–‡ä»¶ç³»ç»Ÿã€‚ 3.1 ä¸´æ—¶å®¹å™¨ ä» Kubernetes 1.18 ä¹‹åå¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨ kubectl ä¸ºè¿è¡Œçš„ pod æ·»åŠ ä¸€ä¸ªä¸´æ—¶å®¹å™¨ã€‚è¿™ä¸ªå‘½ä»¤è¿˜å¤„äº alpha é˜¶æ®µï¼Œå› æ­¤éœ€è¦åœ¨â€œfeature gateâ€ä¸­æ‰“å¼€ã€‚\nåœ¨ä½¿ç”¨ k3d åˆ›å»º k3s é›†ç¾¤æ—¶ï¼Œæ‰“å¼€ EphemeralContainers featureï¼š\n$ k3d cluster create test --k3s-arg \u0026#34;--kube-apiserver-arg=feature-gates=EphemeralContainers=true\u0026#34;@ ç„¶ååˆ›å»ºä¸´æ—¶å®¹å™¨ï¼Œåˆ›å»ºå®Œæˆåä¼šç›´æ¥è¿›å…¥å®¹å™¨ï¼š\n$ kubectl debug golang-distroless-85c4896c45-rkjwn -it --image=ubuntu --image-pull-policy=IfNotPresent #ä¸´æ—¶å®¹å™¨ shell $ apt update \u0026amp;\u0026amp; apt install -y curl $ curl localhost:8080 Hello world! å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸´æ—¶å®¹å™¨æ— æ³•ä¸åŸå®¹å™¨å…±äº«è¿›ç¨‹å‘½åç©ºé—´ï¼š\n$ ps -ef UID PID PPID C STIME TTY TIME CMD root 1 0 0 02:59 pts/0 00:00:00 bash root 3042 1 0 03:02 pts/0 00:00:00 ps -ef å¯ä»¥é€šè¿‡æ·»åŠ å‚æ•° --target=[container] æ¥å°†ä¸´æ—¶å®¹å™¨æŒ‚æ¥åˆ°ç›®æ ‡å®¹å™¨ã€‚è¿™é‡Œä¸ pod.spec.shareProcessNamespace å¹¶ä¸åŒï¼Œè¿›ç¨‹å·ä¸º 1 çš„è¿›ç¨‹æ˜¯ç›®æ ‡å®¹å™¨çš„è¿›ç¨‹ï¼Œè€Œåè€…çš„è¿›ç¨‹æ˜¯ infra å®¹å™¨çš„è¿›ç¨‹ /pauseï¼š\n$ kubectl debug golang-distroless-85c4896c45-rkjwn -it --image=ubuntu --image-pull-policy=IfNotPresent --target=golang-distroless-example æ³¨æ„ï¼šç›®å‰çš„ç‰ˆæœ¬è¿˜ä¸æ”¯æŒåˆ é™¤ä¸´æ—¶å®¹å™¨ï¼Œå‚è€ƒ issueï¼Œæ”¯æŒçš„ç‰ˆæœ¬ï¼š\n3.2 æ‹·è´ Pod å¹¶æ·»åŠ å®¹å™¨ é™¤äº†æ·»åŠ ä¸´æ—¶å®¹å™¨ä»¥å¤–ï¼Œå¦ä¸€ç§æ–¹å¼å°±æ˜¯åˆ›å»ºä¸€ä¸ª Pod çš„æ‹·è´ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªå®¹å™¨ã€‚æ³¨æ„è¿™é‡Œçš„æ˜¯æ™®é€šå®¹å™¨ï¼Œä¸æ˜¯ä¸´æ—¶å®¹å™¨ã€‚ æ³¨æ„è¿™é‡ŒåŠ ä¸Šäº† --share-processes\n$ kubectl debug golang-distroless-85c4896c45-rkjwn -it --image=ubuntu --image-pull-policy=IfNotPresent --share-processes --copy-to=golang-distroless-debug æ³¨æ„è¿™é‡ŒåŠ ä¸Šäº† --share-processesï¼Œä¼šè‡ªåŠ¨åŠ ä¸Š pod.spec.shareProcessNamespace=trueï¼š\n$ kubectl get po golang-distroless-debug -o jsonpath=\u0026#39;{.spec.shareProcessNamespace}\u0026#39; true æ³¨æ„ï¼šä½¿ç”¨ kubectl debug è°ƒè¯•ï¼Œå¹¶ä¸èƒ½ä¸º pod è‡ªåŠ¨åŠ ä¸Š SYS_PTRACE å®‰å…¨ç‰¹æ€§ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœå®¹å™¨ä½¿ç”¨çš„ UID ä¸ä¸€è‡´ï¼Œå°±æ— æ³•è®¿é—®è¿›ç¨‹ç©ºé—´ã€‚ æˆªæ­¢å‘æ–‡ï¼Œè®¡åˆ’åœ¨ 1.23 ä¸­æ”¯æŒã€‚\næ€»ç»“ ç›®å‰ä¸Šé¢æ‰€æœ‰çš„éƒ½ä¸é€‚åˆåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œæ— æ³•åœ¨ä¸ä¿®æ”¹ Pod å®šä¹‰çš„æƒ…å†µä¸‹è¿›è¡Œè°ƒè¯•ã€‚\næœŸæœ› Kubernetes 1.23 ç‰ˆæœ¬ä¹‹å debug åŠŸèƒ½æ·»åŠ  SYS_PTRACE çš„æ”¯æŒã€‚åˆ°æ—¶å€™ï¼Œå†å°è¯•ä¸€ä¸‹ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/debug-distroless-container-on-kubernetes/","tags":["Kubernetes","Container"],"title":"Kubernetes ä¸Šè°ƒè¯• distroless å®¹å™¨"},{"categories":["ç¬”è®°"],"contents":"è¿‡å»çš„å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å¾®æœåŠ¡ã€å®¹å™¨åŒ–ä»¥åŠæœåŠ¡ç¼–æ’æ„å»ºäº†æŠ€æœ¯å¹³å°ã€‚ä¸ºäº†æå‡å¼€å‘å›¢é˜Ÿçš„ç ”å‘æ•ˆç‡ï¼Œæˆ‘ä»¬åŒæ—¶è¿˜æä¾›äº† CICD å¹³å°ï¼Œç”¨æ¥å°†ä»£ç å¿«é€Ÿçš„éƒ¨ç½²åˆ° Openshiftï¼ˆä¼ä¸šçº§çš„ Kubernetesï¼‰ é›†ç¾¤ã€‚\néƒ¨ç½²çš„ç¬¬ä¸€æ­¥å°±æ˜¯åº”ç”¨ç¨‹åºçš„å®¹å™¨åŒ–ï¼ŒæŒç»­é›†æˆçš„äº¤ä»˜ç‰©ä»ä»¥å¾€çš„ jar åŒ…ã€webpack ç­‰å˜æˆäº†å®¹å™¨é•œåƒã€‚å®¹å™¨åŒ–å°†è½¯ä»¶ä»£ç å’Œæ‰€éœ€çš„æ‰€æœ‰ç»„ä»¶ï¼ˆåº“ã€æ¡†æ¶ã€è¿è¡Œç¯å¢ƒï¼‰æ‰“åŒ…åˆ°ä¸€èµ·ï¼Œè¿›è€Œå¯ä»¥åœ¨ä»»ä½•ç¯å¢ƒä»»ä½•åŸºç¡€æ¶æ„ä¸Šä¸€è‡´åœ°è¿è¡Œï¼Œå¹¶ä¸å…¶ä»–åº”ç”¨â€œéš”ç¦»â€ã€‚\næˆ‘ä»¬çš„ä»£ç éœ€è¦ä»æºç åˆ°ç¼–è¯‘åˆ°æœ€ç»ˆå¯è¿è¡Œçš„é•œåƒï¼Œç”šè‡³éƒ¨ç½²ï¼Œè¿™ä¸€åˆ‡åœ¨ CICD çš„æµæ°´çº¿ä¸­å®Œæˆã€‚æœ€åˆï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªä»£ç ä»“åº“ä¸­éƒ½åŠ å…¥äº†ä¸‰ä¸ªæ–‡ä»¶ï¼Œä¹Ÿé€šè¿‡é¡¹ç›®ç”Ÿæˆå™¨ï¼ˆç±»ä¼¼ Spring Initializerï¼‰åœ¨æ–°é¡¹ç›®ä¸­æ³¨å…¥ï¼š\nJenkinsfile.groovyï¼šç”¨æ¥å®šä¹‰ Jenkins çš„ Pipelineï¼Œé’ˆå¯¹ä¸åŒçš„è¯­è¨€è¿˜ä¼šæœ‰å¤šç§ç‰ˆæœ¬ Manifest YAMLï¼šç”¨äºå®šä¹‰ Kubernetes èµ„æºï¼Œä¹Ÿå°±æ˜¯å·¥ä½œè´Ÿè½½åŠå…¶è¿è¡Œçš„ç›¸å…³æè¿° Dockerfileï¼šç”¨äºæ„å»ºå¯¹è±¡ è¿™ä¸ªä¸‰ä¸ªæ–‡ä»¶ä¹Ÿéœ€è¦åœ¨å·¥ä½œä¸­ä¸æ–­çš„æ¼”è¿›ï¼Œèµ·åˆé¡¹ç›®è¾ƒå°‘ï¼ˆåå‡ ä¸ªï¼‰çš„æ—¶å€™æˆ‘ä»¬åŸºç¡€å›¢é˜Ÿè¿˜å¯ä»¥å»å„ä¸ªä»£ç ä»“åº“å»ç»´æŠ¤å‡çº§ã€‚éšç€é¡¹ç›®çˆ†å‘å¼çš„å¢é•¿ï¼Œç»´æŠ¤çš„æˆæœ¬è¶Šæ¥è¶Šé«˜ã€‚æˆ‘ä»¬å¯¹ CICD å¹³å°è¿›è¡Œäº†è¿­ä»£ï¼Œå°†â€œJenkinsfile.groovyâ€å’Œ â€œmanifest YAMLâ€ä»é¡¹ç›®ä¸­ç§»å‡ºï¼Œå˜æ›´è¾ƒå°‘çš„ Dockerfile å°±ä¿ç•™äº†ä¸‹æ¥ã€‚\néšç€å¹³å°çš„æ¼”è¿›ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å°†è¿™å”¯ä¸€çš„â€œé’‰å­æˆ·â€ Dockerfile ä¸ä»£ç è§£è€¦ï¼Œå¿…è¦çš„æ—¶å€™ä¹Ÿéœ€è¦å¯¹ Dockerfile è¿›è¡Œå‡çº§ã€‚å› æ­¤è°ƒç ”äº†ä¸€ä¸‹ buildpacksï¼Œå°±æœ‰äº†ä»Šå¤©çš„è¿™ç¯‡æ–‡ç« ã€‚\nä»€ä¹ˆæ˜¯ Dockerfile Docker é€šè¿‡è¯»å– Dockerfile ä¸­çš„è¯´æ˜è‡ªåŠ¨æ„å»ºé•œåƒã€‚Dockerfile æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ŒåŒ…å«äº†ç”± Docker å¯ä»¥æ‰§è¡Œç”¨äºæ„å»ºé•œåƒçš„æŒ‡ä»¤ã€‚æˆ‘ä»¬æ‹¿ä¹‹å‰ç”¨äºæµ‹è¯• Tekton çš„ Java é¡¹ç›®çš„ Dockerfile ä¸ºä¾‹ï¼š\nFROM openjdk:8-jdk-alpine RUN mkdir /app WORKDIR /app COPY target/*.jar /app/app.jar ENTRYPOINT [\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;java -Xmx128m -Xms64m -jar app.jar\u0026#34;] é•œåƒåˆ†å±‚ ä½ å¯èƒ½ä¼šå¬è¿‡ Docker é•œåƒåŒ…å«äº†å¤šä¸ªå±‚ã€‚æ¯ä¸ªå±‚ä¸ Dockerfile ä¸­çš„æ¯ä¸ªå‘½ä»¤å¯¹åº”ï¼Œæ¯”å¦‚ RUNã€COPYã€ADDã€‚æŸäº›ç‰¹å®šçš„æŒ‡ä»¤ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ï¼Œåœ¨é•œåƒæ„å»ºè¿‡ç¨‹ä¸­ï¼Œå‡å¦‚æŸäº›å±‚æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šä»ç¼“å­˜ä¸­è·å–ã€‚\nåœ¨ä¸‹é¢çš„ Buildpack ä¸­ä¹ŸåŒæ ·é€šè¿‡é•œåƒåˆ†å±‚å’Œ cache æ¥åŠ é€Ÿé•œåƒçš„æ„å»ºã€‚\nä»€ä¹ˆæ˜¯ Buildpack BuildPack æ˜¯ä¸€ä¸ªç¨‹åºï¼Œå®ƒèƒ½å°†æºä»£ç è½¬æ¢æˆå®¹å™¨é•œåƒçš„å¹¶å¯ä»¥åœ¨ä»»æ„äº‘ç¯å¢ƒä¸­è¿è¡Œã€‚é€šå¸¸ buildpack å°è£…äº†å•ä¸€è¯­è¨€çš„ç”Ÿæ€å·¥å…·é“¾ã€‚é€‚ç”¨äº Javaã€Rubyã€Goã€NodeJsã€Python ç­‰ã€‚\nBuilder æ˜¯ä»€ä¹ˆï¼Ÿ ä¸€äº› buildpacks æŒ‰é¡ºåºç»„åˆä¹‹åå°±æ˜¯ builderï¼Œé™¤äº† buildpacksï¼Œ builder ä¸­è¿˜åŠ å…¥äº† ç”Ÿå‘½å‘¨æœŸ å’Œ stack å®¹å™¨é•œåƒã€‚\nstack å®¹å™¨é•œåƒç”±ä¸¤ä¸ªé•œåƒç»„æˆï¼šç”¨äºè¿è¡Œ buildpack çš„é•œåƒ build imageï¼Œä»¥åŠæ„å»ºåº”ç”¨é•œåƒçš„åŸºç¡€é•œåƒ run imageã€‚å¦‚ä¸Šå›¾ï¼Œå°±æ˜¯ builder ä¸­çš„è¿è¡Œç¯å¢ƒã€‚\nBuildpack çš„å·¥ä½œæ–¹å¼ æ¯ä¸ª buildpack è¿è¡Œæ—¶éƒ½åŒ…å«äº†ä¸¤ä¸ªé˜¶æ®µï¼š\n1. æ£€æµ‹é˜¶æ®µ é€šè¿‡æ£€æŸ¥æºä»£ç ä¸­çš„æŸäº›ç‰¹å®šæ–‡ä»¶/æ•°æ®ï¼Œæ¥åˆ¤æ–­å½“å‰ buildpack æ˜¯å¦é€‚ç”¨ã€‚å¦‚æœé€‚ç”¨ï¼Œå°±ä¼šè¿›å…¥æ„å»ºé˜¶æ®µï¼›å¦åˆ™å°±ä¼šé€€å‡ºã€‚æ¯”å¦‚ï¼š\nJava maven çš„ buildpack ä¼šæ£€æŸ¥æºç ä¸­æ˜¯å¦æœ‰ pom.xml Python çš„ buildpack ä¼šæ£€æŸ¥æºç ä¸­æ˜¯å¦æœ‰ requirements.txt æˆ–è€… setup.py æ–‡ä»¶ Node buildpack ä¼šæŸ¥æ‰¾ package-lock.json æ–‡ä»¶ã€‚ 2. æ„å»ºé˜¶æ®µ åœ¨æ„å»ºé˜¶æ®µä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š\nè®¾ç½®æ„å»ºç¯å¢ƒå’Œè¿è¡Œæ—¶ç¯å¢ƒ ä¸‹è½½ä¾èµ–å¹¶ç¼–è¯‘æºç ï¼ˆå‡å¦‚éœ€è¦çš„è¯ï¼‰ è®¾ç½®æ­£ç¡®çš„ entrypoint å’Œå¯åŠ¨è„šæœ¬ã€‚ æ¯”å¦‚ï¼š\nJava maven buildpack åœ¨æ£€æŸ¥åˆ°æœ‰ pom.xml æ–‡ä»¶ä¹‹åï¼Œä¼šæ‰§è¡Œ mvn clean install -DskipTests Python buildpack æ£€æŸ¥åˆ°æœ‰ requrements.txt ä¹‹åï¼Œä¼šæ‰§è¡Œ pip install -r requrements.txt Node build pack æ£€æŸ¥åˆ°æœ‰ package-lock.json åæ‰§è¡Œ npm install BuildPack ä¸Šæ‰‹ é‚£åˆ°åº•å¦‚ä½•åœ¨æ²¡æœ‰ Dockerfile çš„æƒ…å†µä¸‹ä½¿ç”¨ builderpack æ„å»ºé•œåƒçš„ã€‚çœ‹äº†ä¸Šé¢è¿™äº›ï¼Œå¤§å®¶åŸºæœ¬ä¸Šä¹Ÿéƒ½èƒ½äº†è§£åˆ°è¿™ä¸ªæ ¸å¿ƒå°±åœ¨ buildpack çš„ç¼–å†™å’Œä½¿ç”¨çš„ã€‚\nå…¶å®ç°åœ¨æœ‰å¾ˆå¤šå¼€æºçš„ buildpack å¯ä»¥ç”¨ï¼Œæ²¡æœ‰ç‰¹å®šå®šåˆ¶çš„æƒ…å†µä¸‹æ— éœ€è‡ªå·±æ‰‹åŠ¨ç¼–å†™ã€‚æ¯”å¦‚ä¸‹é¢çš„å‡ ä¸ªå¤§å‚å¼€æºå¹¶ç»´æŠ¤çš„ Buildpacksï¼š\nHeroku Buildpacks Google Buildpacks Paketo ä½†æ˜¯æ­£å¼è¯¦ç»†ä»‹ç»å¼€æºçš„ buildpacks ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯é€šè¿‡è‡ªå·±åˆ›å»º buildpack çš„æ–¹å¼æ¥æ·±å…¥äº†è§£ Buildpacks çš„å·¥ä½œæ–¹å¼ã€‚æµ‹è¯•é¡¹ç›®å‘¢ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨æµ‹è¯• Tekton çš„ Java é¡¹ç›®ã€‚\nä¸‹é¢æ‰€æœ‰çš„å†…å®¹éƒ½æäº¤åˆ°äº† Github ä¸Šï¼Œå¯ä»¥è®¿é—®ï¼šhttps://github.com/addozhang/buildpacks-sample è·å–ç›¸å…³ä»£ç ã€‚\næœ€ç»ˆçš„ç›®å½•buildpacks-sample ç»“æ„å¦‚ä¸‹ï¼š\nâ”œâ”€â”€ builders â”‚Â â””â”€â”€ builder.toml â”œâ”€â”€ buildpacks â”‚Â â””â”€â”€ buildpack-maven â”‚Â â”œâ”€â”€ bin â”‚Â â”‚Â â”œâ”€â”€ build â”‚Â â”‚Â â””â”€â”€ detect â”‚Â â””â”€â”€ buildpack.toml â””â”€â”€ stacks â”œâ”€â”€ build â”‚Â â””â”€â”€ Dockerfile â”œâ”€â”€ build.sh â””â”€â”€ run â””â”€â”€ Dockerfile åˆ›å»º buildpack pack buildpack new examples/maven \\ --api 0.5 \\ --path buildpack-maven \\ --version 0.0.1 \\ --stacks io.buildpacks.samples.stacks.bionic çœ‹ä¸‹ç”Ÿæˆçš„ buildpack-maven ç›®å½•ï¼š\nbuildpack-maven â”œâ”€â”€ bin â”‚Â â”œâ”€â”€ build â”‚Â â””â”€â”€ detect â””â”€â”€ buildpack.toml å„ä¸ªæ–‡ä»¶ä¸­éƒ½æ˜¯é»˜è®¤çš„åˆè¯•æ•°æ®ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç”¨å¤„ã€‚éœ€è¦æ·»åŠ äº›å†…å®¹ï¼š\nbin/detectï¼š\n#!/usr/bin/env bash if [[ ! -f pom.xml ]]; then exit 100 fi plan_path=$2 cat \u0026gt;\u0026gt; \u0026#34;${plan_path}\u0026#34; \u0026lt;\u0026lt;EOL [[provides]] name = \u0026#34;jdk\u0026#34; [[requires]] name = \u0026#34;jdk\u0026#34; EOL bin/buildï¼š\n#!/usr/bin/env bash set -euo pipefail layers_dir=\u0026#34;$1\u0026#34; env_dir=\u0026#34;$2/env\u0026#34; plan_path=\u0026#34;$3\u0026#34; m2_layer_dir=\u0026#34;${layers_dir}/maven_m2\u0026#34; if [[ ! -d ${m2_layer_dir} ]]; then mkdir -p ${m2_layer_dir} echo \u0026#34;cache = true\u0026#34; \u0026gt; ${m2_layer_dir}.toml fi ln -s ${m2_layer_dir} $HOME/.m2 echo \u0026#34;---\u0026gt; Running Maven\u0026#34; mvn clean install -B -DskipTests target_dir=\u0026#34;target\u0026#34; for jar_file in $(find \u0026#34;$target_dir\u0026#34; -maxdepth 1 -name \u0026#34;*.jar\u0026#34; -type f); do cat \u0026gt;\u0026gt; \u0026#34;${layers_dir}/launch.toml\u0026#34; \u0026lt;\u0026lt;EOL [[processes]] type = \u0026#34;web\u0026#34; command = \u0026#34;java -jar ${jar_file}\u0026#34; EOL break; done buildpack.tomlï¼š\napi = \u0026#34;0.5\u0026#34; [buildpack] id = \u0026#34;examples/maven\u0026#34; version = \u0026#34;0.0.1\u0026#34; [[stacks]] id = \u0026#34;com.atbug.buildpacks.example.stacks.maven\u0026#34; åˆ›å»º stack æ„å»º Maven é¡¹ç›®ï¼Œé¦–é€‰éœ€è¦ Java å’Œ Maven çš„ç¯å¢ƒï¼Œæˆ‘ä»¬ä½¿ç”¨ maven:3.5.4-jdk-8-slim ä½œä¸º build image çš„ base é•œåƒã€‚åº”ç”¨çš„è¿è¡Œæ—¶éœ€è¦ Java ç¯å¢ƒå³å¯ï¼Œå› æ­¤ä½¿ç”¨ openjdk:8-jdk-slimä½œä¸º run image çš„ base é•œåƒã€‚\nåœ¨ stacks ç›®å½•ä¸­åˆ†åˆ«åˆ›å»º build å’Œ run ä¸¤ä¸ªç›®å½•ï¼š\nbuild/Dockerfile\nFROM maven:3.5.4-jdk-8-slim ARG cnb_uid=1000 ARG cnb_gid=1000 ARG stack_id ENV CNB_STACK_ID=${stack_id} LABEL io.buildpacks.stack.id=${stack_id} ENV CNB_USER_ID=${cnb_uid} ENV CNB_GROUP_ID=${cnb_gid} # Install packages that we want to make available at both build and run time RUN apt-get update \u0026amp;\u0026amp; \\ apt-get install -y xz-utils ca-certificates \u0026amp;\u0026amp; \\ rm -rf /var/lib/apt/lists/* # Create user and group RUN groupadd cnb --gid ${cnb_gid} \u0026amp;\u0026amp; \\ useradd --uid ${cnb_uid} --gid ${cnb_gid} -m -s /bin/bash cnb USER ${CNB_USER_ID}:${CNB_GROUP_ID} run/Dockerfile\nFROM openjdk:8-jdk-slim ARG stack_id ARG cnb_uid=1000 ARG cnb_gid=1000 LABEL io.buildpacks.stack.id=\u0026#34;${stack_id}\u0026#34; USER ${cnb_uid}:${cnb_gid} ç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ„å»ºå‡ºä¸¤ä¸ªé•œåƒï¼š\nexport STACK_ID=com.atbug.buildpacks.example.stacks.maven docker build --build-arg stack_id=${STACK_ID} -t addozhang/samples-buildpacks-stack-build:latest ./build docker build --build-arg stack_id=${STACK_ID} -t addozhang/samples-buildpacks-stack-run:latest ./run åˆ›å»º Builder æœ‰äº† buildpack å’Œ stack ä¹‹åå°±æ˜¯åˆ›å»º Builder äº†ï¼Œé¦–å…ˆåˆ›å»º builder.toml æ–‡ä»¶ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š\n[[buildpacks]] id = \u0026#34;examples/maven\u0026#34; version = \u0026#34;0.0.1\u0026#34; uri = \u0026#34;../buildpacks/buildpack-maven\u0026#34; [[order]] [[order.group]] id = \u0026#34;examples/maven\u0026#34; version = \u0026#34;0.0.1\u0026#34; [stack] id = \u0026#34;com.atbug.buildpacks.example.stacks.maven\u0026#34; run-image = \u0026#34;addozhang/samples-buildpacks-stack-run:latest\u0026#34; build-image = \u0026#34;addozhang/samples-buildpacks-stack-build:latest\u0026#34; ç„¶åæ‰§è¡Œå‘½ä»¤ï¼Œæ³¨æ„è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† --pull-policy if-not-present å‚æ•°ï¼Œå°±ä¸éœ€è¦å°† stack çš„ä¸¤ä¸ªé•œåƒæ¨é€åˆ°é•œåƒä»“åº“äº†ï¼š\npack builder create example-builder:latest --config ./builder.toml --pull-policy if-not-present æµ‹è¯• æœ‰äº† builder ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨åˆ›å»ºå¥½çš„ builder æ¥æ„å»ºé•œåƒäº†ã€‚\nè¿™é‡ŒåŒæ ·åŠ ä¸Šäº† --pull-policy if-not-present å‚æ•°æ¥ä½¿ç”¨æœ¬åœ°çš„ builder é•œåƒï¼š\n# ç›®å½• buildpacks-sample ä¸ tekton-test åŒçº§ï¼Œå¹¶åœ¨ buildpacks-sample ä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ pack build addozhang/tekton-test --builder example-builder:latest --pull-policy if-not-present --path ../tekton-test å¦‚æœçœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹å†…å®¹ï¼Œå°±è¯´æ˜é•œåƒæ„å»ºæˆåŠŸäº†ï¼ˆç¬¬ä¸€æ¬¡æ„å»ºé•œåƒç”±äºéœ€è¦ä¸‹è½½ maven ä¾èµ–è€—æ—¶å¯èƒ½ä¼šæ¯”è¾ƒä¹…ï¼Œåç»­å°±ä¼šå¾ˆå¿«ï¼Œå¯ä»¥æ‰§è¡Œä¸¤æ¬¡éªŒè¯ä¸‹ï¼‰ï¼š\n... ===\u0026gt; EXPORTING [exporter] Adding 1/1 app layer(s) [exporter] Reusing layer \u0026#39;launcher\u0026#39; [exporter] Reusing layer \u0026#39;config\u0026#39; [exporter] Reusing layer \u0026#39;process-types\u0026#39; [exporter] Adding label \u0026#39;io.buildpacks.lifecycle.metadata\u0026#39; [exporter] Adding label \u0026#39;io.buildpacks.build.metadata\u0026#39; [exporter] Adding label \u0026#39;io.buildpacks.project.metadata\u0026#39; [exporter] Setting default process type \u0026#39;web\u0026#39; [exporter] Saving addozhang/tekton-test... [exporter] *** Images (0d5ac1158bc0): [exporter] addozhang/tekton-test [exporter] Adding cache layer \u0026#39;examples/maven:maven_m2\u0026#39; Successfully built image addozhang/tekton-test å¯åŠ¨å®¹å™¨ï¼Œä¼šçœ‹åˆ° spring boot åº”ç”¨æ­£å¸¸å¯åŠ¨ï¼š\ndocker run --rm addozhang/tekton-test:latest . ____ _ __ _ _ /\\\\ / ___\u0026#39;_ __ _ _(_)_ __ __ _ \\ \\ \\ \\ ( ( )\\___ | \u0026#39;_ | \u0026#39;_| | \u0026#39;_ \\/ _` | \\ \\ \\ \\ \\\\/ ___)| |_)| | | | | || (_| | ) ) ) ) \u0026#39; |____| .__|_| |_|_| |_\\__, | / / / / =========|_|==============|___/=/_/_/_/ :: Spring Boot :: (v2.2.3.RELEASE) ... æ€»ç»“ å…¶å®ç°åœ¨æœ‰å¾ˆå¤šå¼€æºçš„ buildpack å¯ä»¥ç”¨ï¼Œæ²¡æœ‰ç‰¹å®šå®šåˆ¶çš„æƒ…å†µä¸‹æ— éœ€è‡ªå·±æ‰‹åŠ¨ç¼–å†™ã€‚æ¯”å¦‚ä¸‹é¢çš„å‡ ä¸ªå¤§å‚å¼€æºå¹¶ç»´æŠ¤çš„ Buildpacksï¼š\nHeroku Buildpacks Google Buildpacks Paketo ä¸Šé¢å‡ ä¸ª buildpacks åº“å†…å®¹æ¯”è¾ƒå…¨é¢ï¼Œå®ç°ä¸Šä¼šæœ‰äº›è®¸ä¸åŒã€‚æ¯”å¦‚ Heroku çš„æ‰§è¡Œé˜¶æ®µä½¿ç”¨ Shell è„šæœ¬ï¼Œè€Œ Paketo ä½¿ç”¨ Golangã€‚åè€…çš„æ‰©å±•æ€§è¾ƒå¼ºï¼Œç”± Cloud Foundry åŸºé‡‘ä¼šæ”¯æŒï¼Œå¹¶æ‹¥æœ‰ç”± VMware èµåŠ©çš„å…¨èŒæ ¸å¿ƒå¼€å‘å›¢é˜Ÿã€‚è¿™äº›å°å‹æ¨¡å—åŒ–çš„ buildpackï¼Œå¯ä»¥é€šè¿‡ç»„åˆæ‰©å±•ä½¿ç”¨ä¸åŒçš„åœºæ™¯ã€‚\nå½“ç„¶è¿˜æ˜¯é‚£å¥è¯ï¼Œè‡ªå·±ä¸Šæ‰‹å†™ä¸€ä¸ªä¼šæ›´å®¹æ˜“ç†è§£ Buildpack çš„å·¥ä½œæ–¹å¼ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/build-docker-image-without-dockerfile/","tags":["Docker"],"title":"æ— éœ€ Dockerfile çš„é•œåƒæ„å»ºï¼šBuildPack vs Dockerfile"},{"categories":["ç¿»è¯‘","äº‘åŸç”Ÿ"],"contents":"è¯‘è€…ï¼š\nä½œä¸ºä¸€ä¸ªæ›¾ç»åœ¨åˆ¶é€ ä¸šä¼ä¸šçš„åŸºç¡€æ¶æ„å›¢é˜Ÿä»»èŒï¼Œä¸ºæ”¯æŒå…¬å¸çš„â€œäº’è”ç½‘åŸºå› â€å’Œâ€œæ•°å­—åŒ–è½¬å‹â€è½åœ°äº†äº‘åŸç”ŸåŸºç¡€è®¾æ–½å¹³å°ï¼Œå¹¶åœ¨å°è¯•é‡‡ç”¨æœåŠ¡ç½‘æ ¼æœªæˆçš„æˆ‘æ¥è¯´ï¼Œçœ‹åˆ°è¿™ç¯‡æ–‡ç« æ·±æœ‰æ„Ÿè§¦ã€‚å°¤å…¶æ˜¯æ–‡ä¸­æ‰€è¯´çš„â€œäººå°‘ï¼Œé—®é¢˜å¤šï¼Œéœ€è¦å¿«é€Ÿè¾“å‡ºä»·å€¼â€ï¼Œç›´æˆ³åˆ°äº†ç—›å¤„ã€‚æœ‰é™çš„äººæ‰‹æœ‰é™çš„æ—¶é—´ï¼Œæˆ‘ä»¬éœ€è¦å°†å¤§éƒ¨åˆ†ç²¾åŠ›é›†ä¸­åœ¨è§£å†³æˆç†Ÿåº¦æ›²çº¿è¾ƒä½çš„åŸºæœ¬é—®é¢˜ä¸Šï¼Œè¦æƒ³å¾ˆå¥½çš„è¿è¡Œå¤æ‚çš„ç³»ç»Ÿæ˜¯éå¸¸å›°éš¾çš„ã€‚\næœåŠ¡ç½‘æ ¼æ˜¯ä¸€ä¸ªæ–°çš„åŸºç¡€è®¾æ–½å±‚ï¼Œå¯ä»¥æ‰¿è½½å¾ˆå¤šçš„åŠŸèƒ½ï¼Œæœªæ¥è¿˜ä¼šæœ‰æ›´å¤§çš„æƒ³è±¡ç©ºé—´å’Œå…‰æ˜çš„æœªæ¥ã€‚\nä»¥ä¸Šçš„ç§ç§åŸå› ï¼Œä¹Ÿä¿ƒä½¿æˆ‘åæ¥é€‰æ‹©è¿›å…¥ä¸€å®¶æä¾›æœåŠ¡ç½‘æ ¼çš„äº§å“ä¼ä¸šï¼Œä¹Ÿå¸Œæœ›æœåŠ¡ç½‘æ ¼å¯ä»¥è¢«æ›´ç®€å•çš„ä½¿ç”¨ã€‚\nâ€œé“é˜»ä¸”é•¿ï¼Œè¡Œåˆ™å°†è‡³ï¼â€\næœ¬æ–‡ç¿»è¯‘è‡ª Chris Campbell çš„ How Unnecessary Complexity Gave the Service Mesh a Bad Name\nå…³é”®è¦ç‚¹ é‡‡ç”¨æœåŠ¡ç½‘æ ¼æœ‰å·¨å¤§çš„ä»·å€¼ï¼Œä½†å¿…é¡»ä»¥è½»é‡çº§çš„æ–¹å¼è¿›è¡Œï¼Œä»¥é¿å…ä¸å¿…è¦çš„å¤æ‚æ€§ã€‚ åœ¨å®æ–½æœåŠ¡ç½‘æ—¶ï¼Œè¦é‡‡å–åŠ¡å®çš„æ–¹æ³•ï¼Œä¸æŠ€æœ¯çš„æ ¸å¿ƒåŠŸèƒ½ä¿æŒä¸€è‡´ï¼Œå¹¶å°å¿ƒå¹²æ‰°ï¼ˆè¯‘è€…ï¼šæ³¨æ„åŠ›çš„åˆ†æ•£ï¼‰ã€‚ æœåŠ¡ç½‘æ ¼çš„ä¸€äº›æ ¸å¿ƒç‰¹æ€§åŒ…æ‹¬æ ‡å‡†åŒ–ç›‘æ§ã€è‡ªåŠ¨åŠ å¯†å’Œèº«ä»½è¯†åˆ«ã€æ™ºèƒ½è·¯ç”±ã€å¯é çš„é‡è¯•å’Œç½‘ç»œå¯æ‰©å±•æ€§ã€‚ æœåŠ¡ç½‘æ ¼å¯ä»¥æä¾›å¼ºå¤§çš„åŠŸèƒ½ï¼Œä½†è¿™äº›åŠŸèƒ½ä¼šåˆ†æ•£æœ¬åº”å¯¹æ ¸å¿ƒä¼˜åŠ¿çš„å…³æ³¨ï¼Œå¹¶ä¸”è¿™äº›åŠŸèƒ½ä¹Ÿä¸æ˜¯å®æ–½æœåŠ¡ç½‘æ ¼çš„ä¸»è¦åŸå› ã€‚ åœ¨åˆå§‹å®æ–½æœåŠ¡ç½‘æ ¼æ—¶æ²¡æœ‰å¿…è¦å»å…³æ³¨é‚£äº›æ˜æ˜¾ä¼šåˆ†æ•£æ³¨æ„åŠ›çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å¤æ‚çš„æ§åˆ¶å¹³é¢ã€å¤šé›†ç¾¤æ”¯æŒã€Envoyã€WASM å’Œ A/B æµ‹è¯•ã€‚ æœåŠ¡ç½‘æ ¼æ˜¯ Kubernetes ä¸–ç•Œä¸­çš„ä¸€ä¸ªçƒ­é—¨è¯é¢˜ï¼Œä½†è®¸å¤šæ½œåœ¨çš„é‡‡ç”¨è€…å·²ç»æœ‰äº›å¤±æœ›äº†ã€‚æœåŠ¡ç½‘æ ¼çš„è½åœ°å—åˆ°å‹å€’æ€§çš„å¤æ‚æ€§å’Œçœ‹ä¼¼æ— ç©·æ— å°½çš„ä¾›åº”å•†è§£å†³æ–¹æ¡ˆçš„é™åˆ¶ã€‚åœ¨æˆ‘äº²è‡ªæµè§ˆäº†è¿™ä¸ªé¢†åŸŸä¹‹åï¼Œæˆ‘å‘ç°é‡‡ç”¨æœåŠ¡ç½‘æ ¼å…·æœ‰å·¨å¤§çš„ä»·å€¼ï¼Œä½†å®ƒå¿…é¡»ä»¥è½»é‡çº§çš„æ–¹å¼å®Œæˆï¼Œä»¥é¿å…ä¸å¿…è¦çš„å¤æ‚æ€§ã€‚å°½ç®¡æ™®éå­˜åœ¨å¹»ç­æ„Ÿï¼Œä½†æœåŠ¡ç½‘æ ¼çš„æœªæ¥ä¾ç„¶å…‰æ˜ã€‚\nåœ¨å·¥ä½œä¸­å­¦ä¹  æˆ‘è¿›å…¥æœåŠ¡ç½‘æ ¼çš„ä¸–ç•Œå§‹äºæˆ‘åœ¨ä¸€å®¶è€ç‰Œçš„è´¢å¯Œ 500 å¼ºæŠ€æœ¯å…¬å¸æ‹…ä»»äº‘è®¡ç®—æ¶æ„å¸ˆçš„è§’è‰²ã€‚åœ¨å¼€å§‹æˆ‘ä»¬çš„æœåŠ¡ç½‘æ ¼ä¹‹æ—…æ—¶ï¼Œæˆ‘èº«è¾¹æœ‰è®¸å¤šå¼ºå¤§çš„å·¥ç¨‹å¸ˆï¼Œä½†å¤§å¤šæ•°äººå‡ ä¹æ²¡æœ‰äº‘è®¡ç®—å¼€å‘ç»éªŒã€‚æˆ‘ä»¬çš„ç»„ç»‡è¯ç”Ÿäºäº‘è®¡ç®—ä¹‹å‰ï¼Œå®Œå…¨å®ç°äº‘è®¡ç®—çš„ä»·å€¼éœ€è¦æ—¶é—´ã€‚æˆ‘ä»¬çš„ä¼ ç»Ÿä¸šåŠ¡çº¿ä¸»è¦é›†ä¸­åœ¨æŠ€æœ¯æ ˆçš„ç¡¬ä»¶å…ƒç´ ä¸Šï¼Œäº‘è®¡ç®—çš„å†³ç­–æœ€åˆæ˜¯ç”±ä¸ºè¿é€ç¡¬ä»¶æˆ–ä¸ºè¯¥ç¡¬ä»¶æä¾›å›ºä»¶å’Œé©±åŠ¨ç¨‹åºè€Œå¼€å‘çš„æµç¨‹é©±åŠ¨çš„ã€‚\néšç€è¯¥ç»„ç»‡ç»å†å…¶â€œæ•°å­—åŒ–è½¬å‹â€ï¼Œå®ƒè¶Šæ¥è¶Šä¾èµ–äºæä¾›é«˜è´¨é‡çš„è½¯ä»¶æœåŠ¡ï¼Œå¹¶é€æ¸å¼€å‘å‡ºæ›´å¥½çš„æ–¹æ³•ã€‚ä½†ä½œä¸ºäº‘è®¡ç®—æ¶æ„å¸ˆï¼Œæˆ‘ä»åœ¨ä¸ºä¼˜å…ˆè€ƒè™‘ç¡¬ä»¶çš„ä¸šåŠ¡æµç¨‹ï¼Œä»¥åŠå…·æœ‰ä¸åŒæŠ€èƒ½ã€æµç¨‹å’Œä¿¡å¿µçš„å·¥ç¨‹å›¢é˜Ÿå¯¼èˆªã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘å’Œæˆ‘çš„å›¢é˜Ÿåœ¨å°† .NET åº”ç”¨ç¨‹åºè¿ç§»åˆ° Linuxã€é‡‡ç”¨ Dockerã€è¿ç§»åˆ° AWS ä»¥åŠä¸ä¹‹ç›¸å…³çš„æœ€ä½³å®è·µï¼ˆå¦‚æŒç»­é›†æˆã€è‡ªåŠ¨åŒ–éƒ¨ç½²ã€ä¸å¯å˜åŸºç¡€è®¾æ–½ã€åŸºç¡€è®¾æ–½å³ä»£ç ã€ç›‘æ§ç­‰ï¼‰æ–¹é¢å˜å¾—ç†Ÿç»ƒå¹¶æˆåŠŸã€‚ä½†æŒ‘æˆ˜ä¾ç„¶å­˜åœ¨ã€‚\nåœ¨æ­¤æœŸé—´ï¼Œæˆ‘ä»¬å¼€å§‹å°†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ‹†åˆ†ä¸ºä¸€ç»„å¾®æœåŠ¡ã€‚èµ·åˆï¼Œè¿™æ˜¯ä¸€ä¸ªç¼“æ…¢çš„è½¬å˜ï¼Œä½†æœ€ç»ˆè¿™ç§æ–¹æ³•æµè¡Œèµ·æ¥ï¼Œå¼€å‘äººå‘˜å¼€å§‹æ›´å–œæ¬¢æ„å»ºæ–°çš„æœåŠ¡è€Œä¸æ˜¯æ·»åŠ åˆ°ç°æœ‰æœåŠ¡ã€‚æˆ‘ä»¬è¿™äº›åŸºç¡€è®¾æ–½å›¢é˜Ÿçš„äººæŠŠè¿™çœ‹ä½œæ˜¯ä¸€ç§æˆåŠŸã€‚å”¯ä¸€çš„é—®é¢˜æ˜¯ä¸ç½‘ç»œç›¸å…³çš„é—®é¢˜æ•°é‡æ¿€å¢ï¼Œå¼€å‘äººå‘˜æ­£åœ¨å‘æˆ‘ä»¬å¯»æ±‚ç­”æ¡ˆï¼Œè€Œæˆ‘ä»¬è¿˜æ²¡æœ‰å‡†å¤‡å¥½æœ‰æ•ˆåœ°åº”å¯¹è¿™ç§å†²å‡»ã€‚\næœåŠ¡ç½‘æ ¼çš„æ´æ•‘ æˆ‘ç¬¬ä¸€æ¬¡å¬è¯´æœåŠ¡ç½‘æ ¼æ˜¯åœ¨ 2015 å¹´ï¼Œå½“æ—¶æˆ‘æ­£åœ¨ç ”ç©¶æœåŠ¡å‘ç°å·¥å…·å¹¶å¯»æ‰¾ä¸ Consul é›†æˆçš„ç®€å•æ–¹æ³•ã€‚æˆ‘å–œæ¬¢å°†åº”ç”¨ç¨‹åºèŒè´£å¸è½½åˆ°â€œsidecarâ€å®¹å™¨çš„æƒ³æ³•ï¼Œå¹¶æ‰¾åˆ°äº†ä¸€äº›å¯ä»¥å¸®åŠ©åšåˆ°è¿™ä¸€ç‚¹çš„å·¥å…·ã€‚å¤§çº¦åœ¨è¿™ä¸ªæ—¶å€™ï¼ŒDocker æœ‰ä¸€ä¸ªå«åšâ€œé“¾æ¥â€çš„åŠŸèƒ½ï¼Œè®©ä½ å¯ä»¥å°†ä¸¤ä¸ªåº”ç”¨ç¨‹åºæ”¾åœ¨ä¸€ä¸ªå…±äº«çš„ç½‘ç»œç©ºé—´ä¸­ï¼Œè¿™æ ·å®ƒä»¬å°±å¯ä»¥é€šè¿‡ localhost è¿›è¡Œé€šä¿¡ã€‚æ­¤åŠŸèƒ½æä¾›äº†ç±»ä¼¼äºæˆ‘ä»¬ç°åœ¨åœ¨ Kubernetes pod ä¸­æ‰€æ‹¥æœ‰çš„ä½“éªŒï¼šä¸¤ä¸ªç‹¬ç«‹æ„å»ºçš„æœåŠ¡å¯ä»¥åœ¨éƒ¨ç½²æ—¶è¿›è¡Œç»„åˆä»¥å®ç°ä¸€äº›é™„åŠ åŠŸèƒ½ã€‚\næˆ‘æ€»æ˜¯æŠ“ä½æœºä¼šç”¨ç®€å•çš„æ–¹æ¡ˆæ¥è§£å†³å¤§é—®é¢˜ï¼Œå› æ­¤è¿™äº›æ–°åŠŸèƒ½çš„åŠ›é‡ç«‹å³æ‰“åŠ¨äº†æˆ‘ã€‚è™½ç„¶è¿™ä¸ªå·¥å…·æ˜¯ä¸ºäº†ä¸ Consul é›†æˆè€Œæ„å»ºçš„ï¼Œä½†å®é™…ä¸Šï¼Œå®ƒå¯ä»¥åšä»»ä½•ä½ æƒ³åšçš„äº‹æƒ…ã€‚è¿™æ˜¯æˆ‘ä»¬æ‹¥æœ‰çš„åŸºç¡€è®¾æ–½å±‚ï¼Œå¯ä»¥ç”¨æ¥ä¸€æ¬¡ä¸ºæ‰€æœ‰äººè§£å†³é—®é¢˜ã€‚\nè¿™æ–¹é¢çš„ä¸€ä¸ªå…·ä½“ä¾‹å­å‡ºç°åœ¨æˆ‘ä»¬é‡‡ç”¨è¿‡ç¨‹çš„æ—©æœŸã€‚å½“æ—¶ï¼Œæˆ‘ä»¬æ­£è‡´åŠ›äºè·¨ä¸åŒæœåŠ¡çš„æ—¥å¿—æ ‡å‡†åŒ–è¾“å‡ºã€‚é€šè¿‡é‡‡ç”¨æœåŠ¡ç½‘æ ¼å’Œè¿™ç§æ–°çš„è®¾è®¡æ¨¡å¼ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°†æˆ‘ä»¬çš„äººçš„é—®é¢˜â€”â€”è®©å¼€å‘äººå‘˜æ ‡å‡†åŒ–ä»–ä»¬çš„æ—¥å¿—â€”â€”æ¢æˆæŠ€æœ¯é—®é¢˜â€”â€”å°†æ‰€æœ‰æµé‡ä¼ é€’ç»™å¯ä»¥ä¸ºä»–ä»¬è®°å½•æ—¥å¿—çš„ä»£ç†ã€‚è¿™æ˜¯æˆ‘ä»¬å›¢é˜Ÿå‘å‰è¿ˆå‡ºçš„é‡è¦ä¸€æ­¥ã€‚\næˆ‘ä»¬å¯¹æœåŠ¡ç½‘æ ¼çš„å®ç°éå¸¸åŠ¡å®ï¼Œå¹¶ä¸”ä¸è¯¥æŠ€æœ¯çš„æ ¸å¿ƒåŠŸèƒ½éå¸¸å»åˆã€‚ç„¶è€Œï¼Œå¤§éƒ¨åˆ†è¥é”€ç‚’ä½œéƒ½é›†ä¸­åœ¨ä¸å¤ªéœ€è¦çš„è¾¹ç¼˜æ¡ˆä¾‹ä¸Šï¼Œåœ¨è¯„ä¼°æœåŠ¡ç½‘æ ¼æ˜¯å¦é€‚åˆä½ æ—¶ï¼Œèƒ½å¤Ÿè¯†åˆ«è¿™äº›å¹²æ‰°æ˜¯å¾ˆé‡è¦çš„ã€‚\næ ¸å¿ƒåŠŸèƒ½ æœåŠ¡ç½‘æ ¼å¯ä»¥æä¾›çš„æ ¸å¿ƒåŠŸèƒ½åˆ†ä¸ºå››ä¸ªå…³é”®è´£ä»»é¢†åŸŸï¼šå¯è§‚å¯Ÿæ€§ã€å®‰å…¨æ€§ã€è¿æ¥æ€§å’Œå¯é æ€§ã€‚è¿™äº›åŠŸèƒ½åŒ…æ‹¬ï¼š\næ ‡å‡†åŒ–ç›‘æ§ æˆ‘ä»¬å–å¾—çš„æœ€å¤§èƒœåˆ©ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯æœ€å®¹æ˜“é‡‡ç”¨çš„ï¼Œæ˜¯æ ‡å‡†åŒ–ç›‘æ§ã€‚å®ƒçš„è¿è¥æˆæœ¬éå¸¸ä½ï¼Œå¯ä»¥é€‚åº”ä½ ä½¿ç”¨çš„ä»»ä½•ç›‘æ§ç³»ç»Ÿã€‚å®ƒä½¿ç»„ç»‡èƒ½å¤Ÿæ•è·æ‰€æœ‰ HTTP æˆ– gRPC æŒ‡æ ‡ï¼Œå¹¶ä»¥æ ‡å‡†æ–¹å¼åœ¨æ•´ä¸ªç³»ç»Ÿä¸­å­˜å‚¨å®ƒä»¬ã€‚è¿™æ§åˆ¶äº†å¤æ‚æ€§å¹¶å‡è½»äº†åº”ç”¨ç¨‹åºå›¢é˜Ÿçš„è´Ÿæ‹…ï¼Œä»–ä»¬ä¸å†éœ€è¦å®ç° Prometheus æŒ‡æ ‡ç«¯ç‚¹æˆ–æ ‡å‡†åŒ–æ—¥å¿—æ ¼å¼ã€‚å®ƒè¿˜ä½¿ç”¨æˆ·èƒ½å¤Ÿå…¬æ­£åœ°äº†è§£å…¶åº”ç”¨ç¨‹åºçš„é»„é‡‘ä¿¡å·ã€‚\nè‡ªåŠ¨åŠ å¯†å’Œèº«ä»½è¯†åˆ« è¯ä¹¦ç®¡ç†å¾ˆéš¾åšå¥½ã€‚å¦‚æœä¸€ä¸ªç»„ç»‡è¿˜æ²¡æœ‰åœ¨è¿™æ–¹é¢è¿›è¡ŒæŠ•å…¥ï¼Œä»–ä»¬åº”è¯¥æ‰¾åˆ°ä¸€ä¸ªç½‘æ ¼æ¥ä¸ºä»–ä»¬åšè¿™ä»¶äº‹ã€‚è¯ä¹¦ç®¡ç†éœ€è¦ç»´æŠ¤å…·æœ‰å·¨å¤§å®‰å…¨éšæ‚£çš„å¤æ‚åŸºç¡€è®¾æ–½ä»£ç ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œç½‘æ ¼å°†èƒ½å¤Ÿä¸ç¼–æ’ç³»ç»Ÿé›†æˆï¼Œä»¥äº†è§£å·¥ä½œè´Ÿè½½çš„èº«ä»½ï¼Œåœ¨éœ€è¦æ—¶å¯ä»¥ç”¨æ¥æ‰§è¡Œç­–ç•¥ã€‚è¿™å…è®¸æä¾›ä¸ Calico æˆ– Cilium ç­‰åŠŸèƒ½å¼ºå¤§çš„ CNI æä¾›çš„å®‰å…¨æ€åŠ¿ç›¸å½“æˆ–æ›´å¥½çš„å®‰å…¨æ€åŠ¿ã€‚\næ™ºèƒ½è·¯ç”± æ™ºèƒ½è·¯ç”±æ˜¯å¦ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒä½¿ç½‘æ ¼èƒ½å¤Ÿåœ¨å‘é€è¯·æ±‚æ—¶â€œåšæ­£ç¡®çš„äº‹â€ã€‚åœºæ™¯åŒ…æ‹¬ï¼š\nä½¿ç”¨å»¶è¿ŸåŠ æƒç®—æ³•ä¼˜åŒ–æµé‡ æ‹“æ‰‘æ„ŸçŸ¥è·¯ç”±ä»¥æé«˜æ€§èƒ½å¹¶é™ä½æˆæœ¬ æ ¹æ®è¯·æ±‚æˆåŠŸçš„å¯èƒ½æ€§ä½¿è¯·æ±‚è¶…æ—¶ ä¸ç¼–æ’ç³»ç»Ÿé›†æˆä»¥è¿›è¡Œ IP è§£æï¼Œè€Œä¸æ˜¯ä¾èµ– DNS ä¼ è¾“å‡çº§ï¼Œä¾‹å¦‚ HTTP åˆ° HTTP/2 è¿™äº›åŠŸèƒ½å¯èƒ½ä¸ä¼šè®©æ™®é€šäººæ„Ÿåˆ°å…´å¥‹ï¼Œä½†éšç€æ—¶é—´çš„æ¨ç§»ï¼Œå®ƒä»¬ä»æ ¹æœ¬ä¸Šå¢åŠ äº†ä»·å€¼\nå¯é çš„é‡è¯• åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é‡è¯•è¯·æ±‚å¯èƒ½å¾ˆéº»çƒ¦ï¼Œä½†æ˜¯å®ƒå‡ ä¹æ€»æ˜¯éœ€è¦å®ç°çš„ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿé€šå¸¸ä¼šå°†ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚è½¬æ¢ä¸ºæ›´å¤šä¸‹æ¸¸è¯·æ±‚ï¼Œè¿™æ„å‘³ç€â€œå°¾å·´â€åœºæ™¯çš„å¯èƒ½æ€§ä¼šå¤§å¤§å¢åŠ ï¼Œä¾‹å¦‚å‘ç”Ÿå¼‚å¸¸å¤±è´¥çš„è¯·æ±‚ã€‚å¯¹æ­¤æœ€ç®€å•çš„ç¼“è§£æªæ–½æ˜¯é‡è¯•å¤±è´¥çš„è¯·æ±‚ã€‚\nå›°éš¾æ¥è‡ªäºé¿å…â€œé‡è¯•é£æš´â€æˆ–â€œé‡è¯• DDoSâ€ï¼Œå³å½“å¤„äºé™çº§çŠ¶æ€çš„ç³»ç»Ÿè§¦å‘é‡è¯•ã€éšç€é‡è¯•å¢åŠ è€Œå¢åŠ è´Ÿè½½å¹¶è¿›ä¸€æ­¥é™ä½æ€§èƒ½æ—¶ã€‚å¤©çœŸçš„å®ç°ä¸ä¼šè€ƒè™‘è¿™ç§æƒ…å†µï¼Œå› ä¸ºå®ƒå¯èƒ½éœ€è¦ä¸ç¼“å­˜æˆ–å…¶ä»–é€šä¿¡ç³»ç»Ÿé›†æˆä»¥äº†è§£æ˜¯å¦å€¼å¾—æ‰§è¡Œé‡è¯•ã€‚æœåŠ¡ç½‘æ ¼å¯ä»¥é€šè¿‡å¯¹æ•´ä¸ªç³»ç»Ÿå…è®¸çš„é‡è¯•æ€»æ•°è¿›è¡Œé™åˆ¶æ¥å®ç°è¿™ä¸€ç‚¹ã€‚ç½‘æ ¼è¿˜å¯ä»¥åœ¨è¿™äº›é‡è¯•å‘ç”Ÿæ—¶æŠ¥å‘Šè¿™äº›é‡è¯•ï¼Œå¯èƒ½ä¼šåœ¨ä½ çš„ç”¨æˆ·æ³¨æ„åˆ°ç³»ç»Ÿé™çº§ä¹‹å‰æé†’ä½ ã€‚\nç½‘ç»œå¯æ‰©å±•æ€§ ä¹Ÿè®¸æœåŠ¡ç½‘æ ¼çš„æœ€ä½³å±æ€§æ˜¯å®ƒçš„å¯æ‰©å±•æ€§ã€‚å®ƒæä¾›äº†é¢å¤–çš„é€‚åº”æ€§å±‚ï¼Œä»¥åº”å¯¹ IT ä¸‹ä¸€æ­¥æŠ•å…¥çš„ä»»ä½•äº‹æƒ…ã€‚Sidecar ä»£ç†çš„è®¾è®¡æ¨¡å¼æ˜¯å¦ä¸€ä¸ªä»¤äººå…´å¥‹å’Œå¼ºå¤§çš„åŠŸèƒ½ï¼Œå³ä½¿å®ƒæœ‰æ—¶ä¼šè¢«è¿‡åº¦å®£ä¼ å’Œè¿‡åº¦è®¾è®¡æ¥åšç”¨æˆ·å’ŒæŠ€æœ¯äººå‘˜è¿˜æ²¡æœ‰å‡†å¤‡å¥½çš„äº‹æƒ…ã€‚è™½ç„¶ç¤¾åŒºåœ¨ç­‰ç€çœ‹å“ªä¸ªæœåŠ¡ç½‘æ ¼â€œç”Ÿå‡ºâ€ï¼Œè¿™åæ˜ äº†ä¹‹å‰è¿‡åº¦ç‚’ä½œçš„ç¼–æ’æˆ˜äº‰ï¼Œä½†æœªæ¥æˆ‘ä»¬å°†ä¸å¯é¿å…åœ°çœ‹åˆ°æ›´å¤šä¸“é—¨æ„å»ºçš„ç½‘æ ¼ï¼Œå¹¶ä¸”å¯èƒ½ä¼šæœ‰æ›´å¤šçš„æœ€ç»ˆç”¨æˆ·æ„å»ºè‡ªå·±çš„æ§åˆ¶å¹³é¢å’Œä»£ç†ä»¥æ»¡è¶³ä»–ä»¬çš„åœºæ™¯ã€‚\næœåŠ¡ç½‘æ ¼å¹²æ‰° å¹³å°æˆ–åŸºç¡€è®¾æ–½æ§åˆ¶å±‚çš„ä»·å€¼æ€ä¹ˆå¼ºè°ƒéƒ½ä¸ä¸ºè¿‡ã€‚ç„¶è€Œï¼Œåœ¨æœåŠ¡ç½‘æ ¼ä¸–ç•Œä¸­ï¼Œæˆ‘äº†è§£åˆ°å…¥é—¨çš„ä¸€ä¸ªä¸»è¦çš„æŒ‘æˆ˜æ˜¯ï¼ŒæœåŠ¡ç½‘æ ¼è§£å†³çš„æ ¸å¿ƒé—®é¢˜é€šå¸¸ç”šè‡³ä¸æ˜¯å¤§å¤šæ•°æœåŠ¡ç½‘æ ¼é¡¹ç›®äº¤æµçš„ç„¦ç‚¹ï¼\nç›¸åï¼Œæ¥è‡ªæœåŠ¡ç½‘æ ¼é¡¹ç›®çš„å¤§éƒ¨åˆ†äº¤æµéƒ½å›´ç»•ç€å¬èµ·æ¥å¾ˆå¼ºå¤§æˆ–ä»¤äººå…´å¥‹ä½†æœ€ç»ˆä¼šè®©äººåˆ†å¿ƒçš„åŠŸèƒ½ã€‚è¿™åŒ…æ‹¬ï¼š\nå¼ºï¼ˆå¤ï¼‰å¤§ï¼ˆæ‚ï¼‰çš„æ§åˆ¶å¹³é¢ è¦å¾ˆå¥½åœ°è¿è¡Œå¤æ‚çš„è½¯ä»¶æ˜¯éå¸¸å›°éš¾çš„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¦‚æ­¤å¤šçš„ç»„ç»‡ä½¿ç”¨äº‘è®¡ç®—æ¥ä½¿ç”¨å®Œå…¨æ‰˜ç®¡çš„æœåŠ¡æ¥å‡è½»è¿™ä¸€ç‚¹çš„åŸå› ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæœåŠ¡ç½‘æ ¼é¡¹ç›®ä¼šè®©æˆ‘ä»¬è´Ÿè´£æ“ä½œå¦‚æ­¤å¤æ‚çš„ç³»ç»Ÿå‘¢ï¼Ÿç³»ç»Ÿçš„å¤æ‚æ€§ä¸æ˜¯èµ„äº§ï¼Œè€Œæ˜¯è´Ÿå€ºï¼Œä½†å¤§å¤šæ•°é¡¹ç›®éƒ½åœ¨å¹æ§å®ƒä»¬çš„åŠŸèƒ½é›†å’Œå¯é…ç½®æ€§ã€‚\nå¤šé›†ç¾¤æ”¯æŒ å¤šé›†ç¾¤ç°åœ¨æ˜¯ä¸€ä¸ªçƒ­é—¨è¯é¢˜ã€‚æœ€ç»ˆï¼Œå¤§å¤šæ•°å›¢é˜Ÿå°†è¿è¡Œå¤šä¸ª Kubernetes é›†ç¾¤ã€‚ä½†æ˜¯å¤šé›†ç¾¤çš„ä¸»è¦ç—›ç‚¹æ˜¯ä½ çš„ Kubernetes ç®¡ç†çš„ç½‘ç»œè¢«åˆ‡åˆ†ã€‚æœåŠ¡ç½‘æ ¼æœ‰åŠ©äºè§£å†³è¿™ä¸ª Kubernetes æ¨ªå‘æ‰©å±•é—®é¢˜ï¼Œä½†å®ƒæœ€ç»ˆå¹¶æ²¡æœ‰å¸¦æ¥ä»»ä½•æ–°çš„ä¸œè¥¿ã€‚æ˜¯çš„ï¼Œå¤šé›†ç¾¤æ”¯æŒæ˜¯å¿…è¦çš„ï¼Œä½†å®ƒå¯¹æœåŠ¡ç½‘æ ¼çš„æ‰¿è¯ºè¢«è¿‡åº¦å®£ä¼ äº†ã€‚\nEnvoy Envoy æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„å·¥å…·ï¼Œä½†å®ƒè¢«ä½œä¸ºæŸç§æ ‡å‡†ä»‹ç»ï¼Œè¿™æ˜¯æœ‰é—®é¢˜çš„ã€‚Envoy æ˜¯ä¼—å¤šå¼€ç®±å³ç”¨çš„ä»£ç†ä¹‹ä¸€ï¼Œä½ å¯ä»¥å°†å…¶ä½œä¸ºæœåŠ¡ç½‘æ ¼å¹³å°çš„åŸºç¡€ã€‚ä½†æ˜¯ Envoy å¹¶æ²¡æœ‰ä»€ä¹ˆå†…åœ¨çš„ç‰¹åˆ«ä¹‹å¤„ï¼Œä½¿å…¶æˆä¸ºæ­£ç¡®çš„é€‰æ‹©ã€‚é‡‡ç”¨ Envoy ä¼šç»™ä½ çš„ç»„ç»‡å¸¦æ¥ä¸€ç³»åˆ—é‡è¦é—®é¢˜ï¼ŒåŒ…æ‹¬ï¼š\nè¿è¡Œæ—¶æˆæœ¬å’Œæ€§èƒ½ï¼ˆæ‰€æœ‰è¿™äº›è¿‡æ»¤å™¨åŠ èµ·æ¥ï¼ï¼‰ è®¡ç®—èµ„æºéœ€æ±‚ä»¥åŠå¦‚ä½•éšè´Ÿè½½æ‰©å±• å¦‚ä½•è°ƒè¯•é”™è¯¯æˆ–æ„å¤–è¡Œä¸º ä½ çš„ç½‘æ ¼å¦‚ä½•ä¸ Envoy äº¤äº’ä»¥åŠé…ç½®ç”Ÿå‘½å‘¨æœŸæ˜¯ä»€ä¹ˆ è¿ä½œæˆç†Ÿçš„æ—¶é—´ï¼ˆè¿™å¯èƒ½æ¯”ä½ é¢„æœŸçš„è¦é•¿ï¼‰ æœåŠ¡ç½‘æ ¼ä¸­ä»£ç†çš„é€‰æ‹©åº”è¯¥æ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ï¼Œè€Œä¸æ˜¯äº§å“è¦æ±‚ã€‚\nWASM æˆ‘æ˜¯ Web Assembly (WASM) çš„å¿ å®æ‹¥è¶¸ï¼Œå·²ç»æˆåŠŸåœ°ä½¿ç”¨å®ƒåœ¨ Blazor ä¸­æ„å»ºå‰ç«¯åº”ç”¨ç¨‹åºã€‚ç„¶è€Œï¼ŒWASM ä½œä¸ºå®šåˆ¶æœåŠ¡ç½‘æ ¼ä»£ç†è¡Œä¸ºçš„å·¥å…·ï¼Œè®©ä½ å¤„äºè·å¾—ä¸€ä¸ªå…¨æ–°çš„è½¯ä»¶ç”Ÿå‘½å‘¨æœŸå¼€é”€çš„å¢ƒåœ°ï¼Œè¿™ä¸ä½ ç°æœ‰çš„è½¯ä»¶ç”Ÿå‘½å‘¨æœŸå®Œå…¨æ­£äº¤ï¼å¦‚æœä½ çš„ç»„ç»‡è¿˜æ²¡æœ‰å‡†å¤‡å¥½æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²ã€ç»´æŠ¤ã€ç›‘æ§ã€å›æ»šå’Œç‰ˆæœ¬ä»£ç ï¼ˆå½±å“é€šè¿‡å…¶ç³»ç»Ÿè¿è¡Œçš„æ¯ä¸ªè¯·æ±‚ï¼‰ï¼Œé‚£ä¹ˆä½ è¿˜æ²¡æœ‰å‡†å¤‡å¥½ä½¿ç”¨ WASMã€‚\nA/B æµ‹è¯• ç›´åˆ°ä¸ºæ—¶å·²æ™šï¼Œæˆ‘æ‰æ„è¯†åˆ° A/B æµ‹è¯•å®é™…ä¸Šæ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºçº§åˆ«çš„é—®é¢˜ã€‚åœ¨åŸºç¡€è®¾æ–½å±‚æä¾›åŸè¯­æ¥å®ç°å®ƒæ˜¯å¾ˆå¥½çš„ï¼Œä½†æ˜¯æ²¡æœ‰ç®€å•çš„æ–¹æ³•æ¥å®Œå…¨è‡ªåŠ¨åŒ–å¤§å¤šæ•°ç»„ç»‡éœ€è¦çš„ A/B æµ‹è¯•æ°´å¹³ã€‚é€šå¸¸ï¼Œåº”ç”¨ç¨‹åºéœ€è¦å®šä¹‰ç‹¬ç‰¹çš„æŒ‡æ ‡æ¥å®šä¹‰æµ‹è¯•çš„ç§¯æä¿¡å·ã€‚å¦‚æœç»„ç»‡æƒ³è¦åœ¨æœåŠ¡ç½‘æ ¼çº§åˆ«æŠ•å…¥ A/B æµ‹è¯•ï¼Œé‚£ä¹ˆè§£å†³æ–¹æ¡ˆéœ€è¦æ”¯æŒä»¥ä¸‹å†…å®¹ï¼š\nå¯¹éƒ¨ç½²å’Œå›æ»šçš„ç²¾ç»†æ§åˆ¶ï¼Œå› ä¸ºå®ƒå¯èƒ½åŒæ—¶è¿›è¡Œå¤šä¸ªä¸åŒçš„â€œæµ‹è¯•â€ èƒ½å¤Ÿæ•è·ç³»ç»ŸçŸ¥é“çš„è‡ªå®šä¹‰æŒ‡æ ‡å¹¶å¯ä»¥æ ¹æ®è¿™äº›æŒ‡æ ‡åšå‡ºå†³ç­– æ ¹æ®è¯·æ±‚çš„ç‰¹å¾æš´éœ²å¯¹æµé‡æ–¹å‘çš„æ§åˆ¶ï¼Œå…¶ä¸­å¯èƒ½åŒ…æ‹¬è§£ææ•´ä¸ªè¯·æ±‚æ­£æ–‡ è¿™éœ€è¦å®ç°å¾ˆå¤šï¼Œæ²¡æœ‰å“ªä¸ªæœåŠ¡ç½‘æ ¼æ˜¯å¼€ç®±å³ç”¨çš„ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬çš„ç»„ç»‡é€‰æ‹©äº†ç½‘æ ¼ä¹‹å¤–çš„ç‰¹å¾æ ‡è®°è§£å†³æ–¹æ¡ˆï¼Œå…¶ä»¥æœ€å°çš„åŠªåŠ›å–å¾—äº†å·¨å¤§çš„æˆåŠŸã€‚\næˆ‘ä»¬åœ¨å“ªé‡Œç»“æŸ æœ€ç»ˆï¼Œæˆ‘ä»¬é¢ä¸´çš„æŒ‘æˆ˜å¹¶ä¸æ˜¯æœåŠ¡ç½‘æ ¼ç‹¬æœ‰çš„ã€‚æˆ‘ä»¬å·¥ä½œçš„ç»„ç»‡æœ‰ä¸€ç³»åˆ—é™åˆ¶æ¡ä»¶ï¼Œè¦æ±‚æˆ‘ä»¬å¯¹è§£å†³çš„é—®é¢˜ä»¥åŠå¦‚ä½•è§£å†³é—®é¢˜é‡‡å–åŠ¡å®çš„æ€åº¦ã€‚æˆ‘ä»¬é¢ä¸´çš„é—®é¢˜åŒ…æ‹¬ï¼š\nä¸€ä¸ªæ‹¥æœ‰å¤§é‡ä¸åŒæŠ€èƒ½çš„å¼€å‘äººå‘˜çš„å¤§å‹ç»„ç»‡ äº‘è®¡ç®—å’Œ SaaS èƒ½åŠ›æ™®éä¸æˆç†Ÿ ä¸ºéäº‘è®¡ç®—è½¯ä»¶ä¼˜åŒ–çš„æµç¨‹ ç¢ç‰‡åŒ–çš„è½¯ä»¶å·¥ç¨‹æ–¹æ³•å’Œä¿¡å¿µ æœ‰é™çš„èµ„æº æ¿€è¿›çš„æˆªæ­¢æ—¥æœŸ ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬äººå°‘ï¼Œé—®é¢˜å¤šï¼Œéœ€è¦å¿«é€Ÿè¾“å‡ºä»·å€¼ã€‚æˆ‘ä»¬å¿…é¡»æ”¯æŒä¸»è¦ä¸æ˜¯ Web æˆ–äº‘è®¡ç®—çš„å¼€å‘è€…ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å¤§è§„æ¨¡ä»¥æ”¯æŒæœ‰ä¸åŒæ–¹æ³•å’Œæµç¨‹çš„å¤§å‹å·¥ç¨‹ç»„ç»‡æ¥åšäº‘è®¡ç®—ã€‚æˆ‘ä»¬éœ€è¦å°†å¤§éƒ¨åˆ†ç²¾åŠ›é›†ä¸­åœ¨è§£å†³æˆç†Ÿåº¦æ›²çº¿è¾ƒä½çš„åŸºæœ¬é—®é¢˜ä¸Šã€‚\næœ€åï¼Œå½“é¢å¯¹æˆ‘ä»¬è‡ªå·±çš„æœåŠ¡ç½‘æ ¼å†³ç­–æ—¶ï¼Œæˆ‘ä»¬å†³å®šå»ºç«‹åœ¨ Linkerd æœåŠ¡ç½‘æ ¼ä¸Šï¼Œå› ä¸ºå®ƒæœ€ç¬¦åˆæˆ‘ä»¬çš„ä¼˜å…ˆäº‹é¡¹ï¼šä½è¿è¥æˆæœ¬ï¼ˆè®¡ç®—å’ŒäººåŠ›ï¼‰ã€ä½è®¤çŸ¥å¼€é”€ã€æ”¯æŒæ€§ç¤¾åŒºä»¥åŠé€æ˜çš„ç®¡ç†â€”â€”åŒæ—¶æ»¡è¶³æˆ‘ä»¬çš„åŠŸèƒ½è¦æ±‚å’Œé¢„ç®—ã€‚åœ¨ Linkerd æŒ‡å¯¼å§”å‘˜ä¼šå·¥ä½œäº†ä¸€æ®µæ—¶é—´åï¼ˆä»–ä»¬å–œæ¬¢è¯šå®çš„åé¦ˆå’Œç¤¾åŒºå‚ä¸ï¼‰ï¼Œæˆ‘äº†è§£åˆ°å®ƒä¸æˆ‘è‡ªå·±çš„å·¥ç¨‹åŸåˆ™æœ‰å¤šä¹ˆçš„å¥‘åˆã€‚Linkerd æœ€è¿‘åœ¨ CNCF è¾¾åˆ°æ¯•ä¸šçŠ¶æ€ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¼«é•¿çš„è¿‡ç¨‹ï¼Œå¼ºè°ƒäº†è¯¥é¡¹ç›®çš„æˆç†ŸåŠå…¶å¹¿æ³›é‡‡ç”¨ã€‚\nå…³äºä½œè€… Chris CampbellÂ æ‹…ä»»è½¯ä»¶å·¥ç¨‹å¸ˆå’Œæ¶æ„å¸ˆå·²æœ‰åå¤šå¹´ï¼Œä¸å¤šä¸ªå›¢é˜Ÿå’Œç»„ç»‡åˆä½œè½åœ°äº‘åŸç”ŸæŠ€æœ¯å’Œæœ€ä½³å®è·µã€‚ä»–åœ¨ä¸ä¸šåŠ¡é¢†å¯¼è€…åˆä½œé‡‡ç”¨åŠ é€Ÿä¸šåŠ¡çš„è½¯ä»¶äº¤ä»˜ç­–ç•¥å’Œä¸å·¥ç¨‹å›¢é˜Ÿåˆä½œäº¤ä»˜å¯æ‰©å±•çš„äº‘åŸºç¡€æ¶æ„ä¹‹é—´åˆ†é…æ—¶é—´ã€‚ä»–å¯¹æé«˜å¼€å‘äººå‘˜ç”Ÿäº§åŠ›å’Œä½“éªŒçš„æŠ€æœ¯æœ€æ„Ÿå…´è¶£ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/service-mesh-unnecessary-complexity/","tags":["Service Mesh","äº‘åŸç”Ÿ"],"title":"ä½å¤æ‚åº¦ - æœåŠ¡ç½‘æ ¼çš„ä¸‹ä¸€ç«™"},{"categories":["ç¬”è®°"],"contents":"å‰å‡ å¤©æœ‰æœ‹å‹åœ¨é—®å¦‚ä½•åœ¨æŸäº‘ä¸Šæ‹‰å– Tekton çš„é•œåƒï¼Œè¿™ç§æƒ…å†µå…¶å®æ¯”è¾ƒæ™®éä¸åªæ˜¯æŸäº‘ã€‚å·¥ä½œä¸­ç»å¸¸è¦ç”¨åˆ°è¿‡æŸäº›é è¿æ°”æ‰èƒ½æ‹‰å–åˆ°çš„é•œåƒï¼Œè¿™å¯¹å·¥ä½œæ¥è¯´çœŸæ˜¯æåº¦çš„ä¸å‹å¥½ã€‚\nå› æ­¤ä¹ŸèŒç”Ÿäº†ä¸ªæƒ³æ³•ï¼Œç»´æŠ¤ä¸€ä¸ªåç½‘ç»œå‹å¥½çš„ä»“åº“é•œåƒï¼Œåœ¨ Pod åˆ›å»ºæ—¶å°†é•œåƒä»“åº“åˆ‡æ¢åˆ°è‡ªç»´æŠ¤çš„ä»“åº“ï¼Œä»è‡ªç»´æŠ¤çš„ä»“åº“æ‹‰å–é•œåƒã€‚\nå‰å‡ å¤©ä½“éªŒäº†æç‹Gitlab çš„å®¹å™¨é•œåƒåº“ï¼Œä¾¿æ˜¯ä¸ºè¿™ä¸ªæƒ³æ³•åšçš„å‡†å¤‡ã€‚å½“ç„¶å…¶ä»–çš„äº‘å‚å•†ä¹Ÿæœ‰æä¾›é’ˆå¯¹ä¸ªäººç‰ˆçš„å…è´¹é•œåƒä»“åº“å’Œä¼ä¸šç‰ˆä»“åº“ã€‚\næ­£å¥½ Pipy ä½œä¸ºç­–ç•¥å¼•æ“ï¼Œéå¸¸é€‚åˆå®ç°è¿™ç§ç­–ç•¥çš„æ‰§è¡Œã€‚\nå®ç°æ€è·¯ Admission Webhook Kubernetes åŠ¨æ€å‡†å¤‡æ§åˆ¶ çš„ MutatingWebhookConfiguration å¯ä»¥ hook Pod çš„åˆ›å»ºæˆ–è€…æ›´æ–°ï¼Œç„¶åè°ƒç”¨ç›®æ ‡æœåŠ¡å¯¹ Pod èµ„æºå¯¹è±¡è¿›è¡Œ patch æ“ä½œã€‚\nç­–ç•¥å¼•æ“ Pipy ä½œä¸ºåº”ç”¨çš„æ ¸å¿ƒï¼Œä¹Ÿå°±æ˜¯ MutatingWebhookConfiguration çš„ç›®æ ‡æœåŠ¡ï¼Œä»¥ç­–ç•¥å¼•æ“çš„è§’è‰²å®Œæˆç­–ç•¥çš„æ‰§è¡Œã€‚\nPipy æ”¯æŒä»æ–‡ä»¶æˆ–è€… HTTP åœ°å€åŠ è½½è„šæœ¬ï¼Œè¿™é‡Œä¸ºäº†ä¾¿äºç­–ç•¥çš„æ›´æ–°ï¼Œä½¿ç”¨äº†åè€…ã€‚\nå¯¹äºä» HTTP åœ°å€åŠ è½½è„šæœ¬ï¼ŒHTTP åœ°å€è¿”å›å†…å®¹çš„ç¬¬ä¸€è¡Œä¼šä½œä¸º Pipy çš„ä¸»è„šæœ¬ï¼ŒPipy å¯åŠ¨æ—¶ä¼šåŠ è½½ä¸»è„šæœ¬ï¼Œå…¶ä»–çš„æ–‡ä»¶ä¹Ÿä¼šè¢«ç¼“å­˜åˆ°å†…å­˜ä¸­ã€‚\n#åœ°å€ http://localhost:6080/repo/registry-mirror/ $ curl http://localhost:6080/repo/registry-mirror/ /main.js /config.json Pipy ä¼šæ¯éš” 5s æ£€æŸ¥è„šæœ¬å’Œé…ç½®æ–‡ä»¶çš„ etagï¼ˆå°±æ˜¯æ–‡ä»¶çš„æœ€åæ›´æ–°æ—¶é—´ï¼‰ï¼Œå‡å¦‚ä¸å½“å‰æ–‡ä»¶çš„ etag ä¸ä¸€è‡´ï¼Œåˆ™ä¼šç¼“å­˜å¹¶é‡æ–°åŠ è½½ã€‚\nåˆ©ç”¨ Pipy çš„è¿™ä¸ªç‰¹æ€§ï¼Œä¾¿å¯ä»¥ç­–ç•¥å’Œé…ç½®çš„å‡†å®æ—¶æ›´æ–°ã€‚\nç­–ç•¥ å¯¹äºç­–ç•¥çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å…¶é€»è¾‘å’Œé…ç½®è¿›è¡Œäº†åˆ†ç¦»ã€‚é…ç½®éƒ¨åˆ†ï¼Œé…ç½®äº†éœ€è¦è¿›è¡Œæ›¿æ¢çš„é•œåƒçš„å‰ç¼€ï¼Œä»¥åŠæ›¿æ¢æˆçš„å†…å®¹ï¼›è€Œé€»è¾‘ï¼Œè¿™æ˜¯å¯¹ MutatingWebhookConfiguration çš„ AdmissionReview çš„å¯¹è±¡è¿›è¡Œæ£€æŸ¥ã€‚\né…ç½®ï¼š\n{ \u0026#34;registries\u0026#34;: { \u0026#34;gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd\u0026#34;: \u0026#34;registry.gitlab.cn/flomesh/registry-mirror/tekton-pipeline\u0026#34; } } æ¯”å¦‚è¯´ï¼Œå¯¹äºé•œåƒ gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/controller:v0.28.1ï¼Œå°† gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd æ›¿æ¢æˆ registry.gitlab.cn/addozhang/registry-mirror/tekton-pipelineã€‚\nDemo æœ¬æ–‡ä½¿ç”¨æ‰€æœ‰çš„æºç éƒ½å·²ä¸Šä¼ åˆ°äº† githubã€‚\nè„šæœ¬æœåŠ¡å™¨ æ—¢ç„¶é€‰ç”¨äº† HTTP æ–¹å¼åŠ è½½ Pipy çš„è„šæœ¬ï¼Œé‚£å°±éœ€è¦å®ç°ä¸€ä¸ªè„šæœ¬æœåŠ¡å™¨ã€‚å®ç°çš„æ–¹å¼æœ‰ä¸¤ç§ï¼šä½¿ç”¨è„šæœ¬å®ç°è„šæœ¬æœåŠ¡å™¨å’Œä½¿ç”¨ Pipy å†…ç½®çš„ Codebaseã€‚\nä½¿ç”¨è„šæœ¬å®ç°è„šæœ¬æœåŠ¡å™¨ æ ¹æ®éœ€æ±‚å®šä¹‰ä¸¤ç§è·¯ç”±ï¼š\n/repo/registry-mirror/ï¼šè¿”å›è„šæœ¬å’Œé…ç½®çš„æ–‡ä»¶åˆ—è¡¨ /repo/registry-mirror/[File Name]ï¼šè¿”å›å¯¹åº”çš„æ–‡ä»¶çš„å†…å®¹ï¼ŒåŒæ—¶éœ€è¦åœ¨å“åº”å¤´æ·»åŠ  etagï¼Œå€¼æ˜¯æ–‡ä»¶çš„æ›´æ–°æ—¶é—´ å…·ä½“è„šæœ¬å¦‚ä¸‹ï¼š\n#repo.js pipy({ _serveFile: (req, type, filename) =\u0026gt; ( filename = req.head.path.substring(22), os.stat(filename) ? ( new Message( { bodiless: req.head.method === \u0026#39;HEAD\u0026#39;, headers: { \u0026#39;etag\u0026#39;: os.stat(filename)?.mtime | 0, \u0026#39;content-type\u0026#39;: type, }, }, req.head.method === \u0026#39;HEAD\u0026#39; ? null : os.readFile(filename), ) ) : ( new Message({ status: 404 }, `file ${filename} not found`) ) ), _router: new algo.URLRouter({ \u0026#39;/repo/registry-mirror/\u0026#39;: () =\u0026gt; new Message(\u0026#39;/main.js\\n/config.json\u0026#39;), \u0026#39;/repo/registry-mirror/*\u0026#39;: req =\u0026gt; _serveFile(req, \u0026#39;text/plain\u0026#39;) }), }) .listen(6080) .serveHTTP( req =\u0026gt; _router.find(req.head.path)(req) )% $ pipy repo.js 2021-10-05 21:40:25 [info] [config] 2021-10-05 21:40:25 [info] [config] Module /repo.js 2021-10-05 21:40:25 [info] [config] =============== 2021-10-05 21:40:25 [info] [config] 2021-10-05 21:40:25 [info] [config] [Listen on :::6080] 2021-10-05 21:40:25 [info] [config] -----\u0026gt;| 2021-10-05 21:40:25 [info] [config] | 2021-10-05 21:40:25 [info] [config] serveHTTP 2021-10-05 21:40:25 [info] [config] | 2021-10-05 21:40:25 [info] [config] \u0026lt;-----| 2021-10-05 21:40:25 [info] [config] 2021-10-05 21:40:25 [info] [listener] Listening on port 6080 at :: æ£€æŸ¥è·¯ç”±ï¼š\n$ curl http://localhost:6080/repo/registry-mirror/ /main.js /config.json $ curl http://localhost:6080/repo/registry-mirror/main.js #çœç•¥ main.js çš„å†…å®¹ $ curl http://localhost:6080/repo/registry-mirror/config.json #çœç•¥ config.json çš„å†…å®¹ ä½¿ç”¨ Pipy å†…ç½®çš„ Codebase åœ¨æœ€æ–°å‘å¸ƒçš„ Pipy å†…ç½®äº†ä¸€ä¸ª Codebaseï¼Œå¤§å®¶å¯ä»¥ç†è§£æˆè„šæœ¬ä»“åº“ï¼Œä½†æ˜¯æ¯”å•çº¯çš„ä»“åº“åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼ˆåé¢ä¼šæœ‰æ–‡æ¡£ä»‹ç»è¯¥ç‰¹æ€§ï¼‰ã€‚\nç›®å‰ç‰ˆæœ¬çš„ Codebase è¿˜æœªæ”¯æŒæŒä¹…åŒ–çš„å­˜å‚¨ï¼Œæ•°æ®éƒ½æ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚åç»­ä¼šæä¾› KV store æˆ–è€… git ç±»å‹çš„æŒä¹…åŒ–æ”¯æŒã€‚\nå¯åŠ¨ Pipy çš„ Codebaseå¾ˆç®€å•ï¼š\n$ pipy 2021-10-05 21:49:08 [info] [codebase] Starting codebase service... 2021-10-05 21:49:08 [info] [listener] Listening on port 6060 at :: å¯¹äºæ–°çš„ Codebase æ§åˆ¶å°çš„ä½¿ç”¨ï¼Œè¿™é‡Œä¸åšè¿‡å¤šçš„ä»‹ç»ï¼Œç›´æ¥ä½¿ç”¨ REST API å®Œæˆè„šæœ¬çš„å†™å…¥ï¼š\n#åˆ›å»º registry-mirror codebaseï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªç©ºçš„ main.js $ curl -X POST http://localhost:6060/api/v1/repo/registry-mirror #æ›´æ–° main.js $ curl -X POST \u0026#39;http://localhost:6060/api/v1/repo/registry-mirror/main.js\u0026#39; --data-binary \u0026#39;@scripts/main.js\u0026#39; #åˆ›å»º config.json $ curl -X POST \u0026#39;http://localhost:6060/api/v1/repo/registry-mirror/config.json\u0026#39; --data-binary \u0026#39;@scripts/config.json\u0026#39; #æ£€æŸ¥ codebase çš„ç‰ˆæœ¬ $ curl -s http://localhost:6060/api/v1/repo/registry-mirror | jq -r .version #æ›´æ–°ç‰ˆæœ¬ $ curl -X POST \u0026#39;http://localhost:6060/api/v1/repo/registry-mirror\u0026#39; --data-raw \u0026#39;{\u0026#34;version\u0026#34;:2}\u0026#39; å®‰è£… è¿›å…¥åˆ°é¡¹ç›®çš„æ ¹ç›®å½•ä¸­ï¼Œæ‰§è¡Œï¼š\n$ helm install registry-mirror ./registry-mirror -n default NAME: registry-mirror LAST DEPLOYED: Tue Oct 5 22:19:26 2021 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None æŸ¥çœ‹ webhookï¼š\n$ kubectl get mutatingwebhookconfigurations NAME WEBHOOKS AGE registry-mirror-webhook 1 2m6s æ£€æŸ¥ pod çš„å¯åŠ¨æ—¥å¿—ï¼š\n$ kubectl logs -n pipy -l app=pipy 2021-10-05 14:19:28 [info] [codebase] GET http://192.168.1.101:6060/repo/registry-mirror/ -\u0026gt; 21 bytes 2021-10-05 14:19:28 [info] [codebase] GET /repo/registry-mirror/main.js -\u0026gt; 2213 bytes 2021-10-05 14:19:28 [info] [codebase] GET /repo/registry-mirror/config.json -\u0026gt; 149 bytes 2021-10-05 14:19:28 [info] [config] 2021-10-05 14:19:28 [info] [config] Module /main.js 2021-10-05 14:19:28 [info] [config] =============== 2021-10-05 14:19:28 [info] [config] 2021-10-05 14:19:28 [info] [config] [Listen on :::6443] 2021-10-05 14:19:28 [info] [config] -----\u0026gt;| 2021-10-05 14:19:28 [info] [config] | 2021-10-05 14:19:28 [info] [config] acceptTLS 2021-10-05 14:19:28 [info] [config] | 2021-10-05 14:19:28 [info] [config] |--\u0026gt; [tls-offloaded] 2021-10-05 14:19:28 [info] [config] decodeHTTPRequest 2021-10-05 14:19:28 [info] [config] replaceMessage 2021-10-05 14:19:28 [info] [config] encodeHTTPResponse --\u0026gt;| 2021-10-05 14:19:28 [info] [config] | 2021-10-05 14:19:28 [info] [config] \u0026lt;---------------------------------| 2021-10-05 14:19:28 [info] [config] 2021-10-05 14:19:28 [info] [listener] Listening on port 6443 at :: æµ‹è¯• åœ¨ä¸Šä¸€ç¯‡ä¸­æˆ‘å·²ç»æ¨é€äº† Tekton çš„ä¸¤ä¸ªé•œåƒåˆ°å®¹å™¨é•œåƒåº“ä¸­ï¼Œå› æ­¤è¿™é‡Œç›´æ¥å®‰è£… tekton è¿›è¡Œæµ‹è¯•ã€‚\n$ kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/previous/v0.28.1/release.yaml $ kubectl get pod -n tekton-pipelines NAME READY STATUS RESTARTS AGE tekton-pipelines-controller-75974fbfb8-f62dv 1/1 Running 0 7m36s tekton-pipelines-webhook-6cc478f7ff-mm5l9 1/1 Running 0 7m36s æ£€æŸ¥ç»“æœï¼š\n$ kubectl get pod -o json -n tekton-pipelines -l app=tekton-pipelines-controller | jq -r \u0026#39;.items[].spec.containers[].image\u0026#39; registry.gitlab.cn/flomesh/registry-mirror/tekton-pipeline/controller:v0.28.1 $ kubectl get pod -o json -n tekton-pipelines -l app=tekton-pipelines-webhook | jq -r \u0026#39;.items[].spec.containers[].image\u0026#39; registry.gitlab.cn/flomesh/registry-mirror/tekton-pipeline/webhook:v0.28.1 ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹åˆ°ç»“æœæ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚\næ€»ç»“ æ•´ä¸ªå®ç°çš„ç­–ç•¥éƒ¨åˆ†åŠ ä¸Šé…ç½®ï¼Œåªæœ‰ 70 å¤šè¡Œçš„ä»£ç ã€‚å¹¶ä¸”å®ç°äº†é€»è¾‘ä¸é…ç½®çš„åˆ†ç¦»ä¹‹åï¼Œåç»­çš„é…ç½®ä¹Ÿéƒ½å¯ä»¥åšåˆ°å®æ—¶çš„æ›´æ–°è€Œæ— éœ€ä¿®æ”¹ä»»ä½•é€»è¾‘ä»£ç ï¼Œæ›´æ— éœ€é‡æ–°éƒ¨ç½²ã€‚\nä½†æ˜¯ç›®å‰çš„å®ç°ï¼Œæ˜¯éœ€è¦æ‰‹åŠ¨æŠŠé•œåƒæ¨é€çš„è‡ªç»´æŠ¤çš„é•œåƒä»“åº“ä¸­ã€‚å®é™…ä¸Šç†æƒ³çš„æƒ…å†µæ˜¯æ£€æŸ¥è‡ªç»´æŠ¤çš„ä»“åº“ä¸­æ˜¯å¦å­˜åœ¨é•œåƒï¼ˆæ¯”å¦‚é€šè¿‡ REST APIï¼‰ï¼Œå¦‚æœæœªå‘ç°é•œåƒï¼Œå…ˆæŠŠé•œåƒæ‹‰å–åˆ°æœ¬åœ°ï¼Œtag åå†æ¨é€åˆ°è‡ªç»´æŠ¤çš„ä»“åº“ã€‚ä¸è¿‡è¿™ç§æ“ä½œï¼Œè¿˜æ˜¯éœ€è¦ç½‘ç»œçš„ç•…é€šã€‚å½“ç„¶ä¹Ÿå°è¯•è¿‡é€šè¿‡ REST API è§¦å‘ CICD Pipeline çš„æ‰§è¡Œæ‹‰å–é•œåƒå¹¶ tagï¼Œä½†æ˜¯æç‹Gitlab æ˜¯éƒ¨ç½²åœ¨æŸäº‘çš„ç¯å¢ƒä¸Šï¼ŒåŒæ ·ä¹Ÿå—å›°äºç½‘ç»œé—®é¢˜ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/kubernetes-images-swapper/","tags":["Kubernetes","DevOps","Container"],"title":"è‡ªåŠ¨æ›¿æ¢ Kubernetes é•œåƒ"},{"categories":["ç¬”è®°"],"contents":"æ„Ÿè°¢æç‹å›¢é˜Ÿä¸º GitLabï¼ˆSaaSï¼‰æœ¬åœ°åŒ–çš„åŠªåŠ›ï¼ŒåŒæ—¶ä¹Ÿæ„Ÿè°¢å°é©¬å“¥æä¾›çš„å†…æµ‹èµ„æ ¼ã€‚\næœ€è¿‘çªç„¶æƒ³åˆ°äº†ä¸ªç‚¹å­ï¼Œéœ€è¦ä½¿ç”¨ä¸€ä¸ªç§æœ‰çš„é•œåƒä»“åº“ã€‚æç‹GitLab æœ‰æä¾›å®¹å™¨é•œåƒåº“ï¼Œæ­£å¥½å’Œ CICD ä¸€èµ·åšä¸ªè½»åº¦ä½“éªŒã€‚\nå®¹å™¨é•œåƒåº“ Container Registry æ–‡æ¡£ä»‹ç»åœ¨è¿™é‡Œï¼Œç›®å‰è¿˜æ˜¯è‹±æ–‡ã€‚ï¼ˆåº”è¯¥æœ¬åœ°åŒ–çš„å·¥ä½œé‡å¾ˆå¤§ï¼Œæ–‡æ¡£è¿˜æ²¡ç¿»è¯‘ã€‚ï¼‰\nå®¹å™¨é•œåƒåº“å¯ä»¥ä½œä¸ºç‹¬ç«‹é•œåƒä»“åº“ä½¿ç”¨ï¼ˆä¸ºä»€ä¹ˆè¦è¿™ä¹ˆç”¨ï¼Œå–ä¸ªå…³å­ä¸‹ç¯‡æ–‡ç« è§ï¼‰ï¼Œå°±æ˜¯ä½¿ç”¨ docker å‘½ä»¤å°†æ„å»ºå¥½çš„é•œåƒæ¨é€åˆ° å®¹å™¨é•œåƒåº“ã€‚\nå½“ç„¶ä¹Ÿå¯ä»¥åŒ CICD æµæ°´çº¿ç»“åˆä½¿ç”¨ï¼Œåæ–‡ä¹Ÿä¼šä»‹ç»ã€‚\nç‹¬ç«‹ä½¿ç”¨ æœ¬åœ°ç™»å½• Container Registry æœ‰ä¸¤ç§éªŒè¯æ–¹å¼ï¼š\nä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç  å¼€å¯äº†åŒé‡èº«ä»½éªŒè¯ï¼Œå¯ä»¥ä½¿ç”¨è®¿é—®ä¸ªäººè®¿é—®ä»¤ç‰Œ å…¶å®ï¼Œä¸ç®¡æ˜¯å¦å¼€å§‹åŒé‡éªŒè¯ï¼Œéƒ½å»ºè®®ä½¿ç”¨è®¿é—®ä»¤ç‰Œã€‚\ndocker login registry.gitlab.cn #æ ¹æ®æç¤ºè¾“å…¥ç”¨æˆ·åå’Œå¯†ç æˆ–è€…ä»¤ç‰Œ image çš„åå­—æœ€å¤šæœ‰ä¸‰å±‚ï¼Œå³ registry.example.com/[namespace] ä¹‹åçš„å†…å®¹æœ€å¤šæœ‰ 3 å±‚ã€‚æ¯”å¦‚ä¸‹é¢çš„ image åå­— myproject/my/image\nregistry.example.com/mynamespace/myproject/my/image:rc1 å…¶æ¬¡ image åå­—çš„ç¬¬ä¸€å±‚å¿…é¡»æ˜¯é•œåƒåï¼Œå¦‚ä¸Šé¢çš„ myprojectã€‚\nå°è¯•å°† tekton çš„é•œåƒæ¨é€ä¸Šå»ï¼š\ndocker tag gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/controller:v0.28.1 registry.gitlab.cn/addozhang/registry-mirror/tekton-pipeline/controller:v0.28.1 docker push registry.gitlab.cn/addozhang/registry-mirror/tekton-pipeline/controller:v0.28.1 è¯·å¿½ç•¥å‘å¸ƒæ—¶é—´ï¼ŒåŸé•œåƒçš„ Created å­—æ®µå°±æœ‰é—®é¢˜ã€‚\nåŒæ ·å¯ä»¥ä½¿ç”¨ REST API è¿›è¡Œè®¿é—®ï¼š\ncurl --location --request GET \u0026#39;https://gitlab.cn/api/v4/projects/addozhang%2Fregistry-mirror/registry/repositories/155/tags\u0026#39; \\ --header \u0026#39;PRIVATE-TOKEN: TOKEN_HERE\u0026#39; [{\u0026#34;name\u0026#34;:\u0026#34;v0.28.1\u0026#34;,\u0026#34;path\u0026#34;:\u0026#34;addozhang/registry-mirror/tekton-pipeline/controller:v0.28.1\u0026#34;,\u0026#34;location\u0026#34;:\u0026#34;registry.gitlab.cn/addozhang/registry-mirror/tekton-pipeline/controller:v0.28.1\u0026#34;}] ä½¿ç”¨ CICD æ„å»ºå’Œæ¨é€ è§ä¸‹æ–‡ã€‚\nCICD æˆ‘å°†ä¹‹å‰ github çš„ä½¿ç”¨çš„æµ‹è¯• tekton çš„é¡¹ç›®é•œåƒåˆ°äº†è¿™é‡Œï¼Œå¹¶æ·»åŠ äº†ä¸€ä¸ª .gitlab-ci.yml çš„æµæ°´çº¿å®šä¹‰æ–‡ä»¶ã€‚\næœ‰äº†å®˜æ–¹çš„æ–‡æ¡£ï¼Œä»¥åŠå‚è€ƒå®˜æ–¹æä¾›å„ç§çš„æ¨¡æ¿ï¼Œæµæ°´çº¿çš„å®šä¹‰ä¸Šæ‰‹å¾ˆå¿«ã€‚\næ•´ä¸ªæµæ°´çº¿åŒ…å«äº†ä¸¤ä¸ª stageï¼šJava ä»£ç çš„ç¼–è¯‘æ‰“åŒ…å’Œé•œåƒçš„æ„å»ºã€‚\nå¦‚ä¸Šå›¾ï¼Œæœ€æ–°çš„ä¸€æ¬¡ä½¿ç”¨äº† cache åŠŸèƒ½å°† .m2/repository ç¼“å­˜ï¼›è€Œå‰ä¸¤æ¬¡ä½¿ç”¨äº†ç¼“å­˜ï¼ˆè¿™é‡Œçš„æ„å»ºè€—æ—¶å·®å¼‚å¾ˆå¤§ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å› ä¸ºæ™šä¸Šèµ„æºæ¯”è¾ƒå°‘ï¼Ÿï¼‰ã€‚Java é¡¹ç›®ä¼šå°†ä¾èµ–åŒ…ä¿å­˜åœ¨æœ¬åœ°åº“ä¸­ï¼Œä½¿ç”¨ cache åŠŸèƒ½å¯ä»¥æå‡æ„å»ºçš„æ•ˆç‡ã€‚\næµæ°´çº¿ DAG ä½¿ç”¨ needs å¯ä»¥æ§åˆ¶åŒ stage ä¸‹ä½œä¸šçš„æ„å»ºé¡ºåºï¼Œå¦åˆ™åŒ stage ä¸‹ä½œä¸šçš„æ‰§è¡Œæ˜¯å¹¶è¡Œçš„ã€‚åŒæ—¶æœ‰äº† needs è¿˜å¯ä»¥æ„å»ºå‡º DAGï¼Œå‰ææ˜¯æœ€å°‘éœ€è¦ 3 ä¸ªä½œä¸šï¼Œå› æ­¤æˆ‘åˆåŠ äº†ä¸€ä¸ªä½œä¸šã€‚\ncache: paths: - .m2/repository variables: MAVEN_OPTS: \u0026#34;-Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true\u0026#34; stages: - build - image - post-build maven-build: image: maven:3-jdk-8 stage: build artifacts: paths: - target/*.jar script: - mvn install -DskipTests docker-build: image: docker:19.03.12 stage: image needs: - maven-build dependencies: - maven-build services: - docker:19.03.12-dind variables: IMAGE_TAG: $CI_REGISTRY_IMAGE:latest script: - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY - docker build -t $IMAGE_TAG . - docker push $IMAGE_TAG done: image: busybox:latest stage: post-build needs: - docker-build script: - echo \u0026#34;All Done!\u0026#34; æ„Ÿè§‰å›¾æœ‰ç‚¹ç®€é™‹ï¼ŒåæœŸåº”è¯¥ä¼šä¼˜åŒ–ã€‚\nä½œä¸šä¾èµ– å‰é¢çš„æµæ°´çº¿å®šä¹‰ä¸­ï¼Œä¸ºäº†ä¼ é€’ maven æ„å»ºçš„ jarï¼Œä½¿ç”¨äº† artifacts å’Œ dependencies è¿›è¡Œäº†ä¼ é€’ã€‚\néš¾é“æ˜¯æˆ‘ç†è§£é”™äº†ï¼Ÿé¼ æ ‡æ‚¬åœå¹¶æ²¡æœ‰æ˜¾ç¤ºåšä¾èµ–çš„ä½œä¸šã€‚\næµæ°´çº¿è§¦å‘ é™¤äº† push ä»£ç è§¦å‘ï¼Œè¿˜å¯ä»¥åˆ›å»ºè§¦å‘å™¨é€šè¿‡ Web API è¿›è¡Œè§¦å‘ã€‚\ncurl -X POST \\ -F token=TOKEN_HERE \\ -F ref=main \\ https://gitlab.cn/api/v4/projects/9766/trigger/pipeline {\u0026#34;id\u0026#34;:19252,\u0026#34;project_id\u0026#34;:9766,\u0026#34;sha\u0026#34;:\u0026#34;5dde144d584b76fe6d3b63a4a9beb789762d1a2d\u0026#34;,\u0026#34;ref\u0026#34;:\u0026#34;main\u0026#34;,\u0026#34;status\u0026#34;:\u0026#34;created\u0026#34;,\u0026#34;created_at\u0026#34;:\u0026#34;2021-10-01T07:37:42.806+08:00\u0026#34;,\u0026#34;updated_at\u0026#34;:\u0026#34;2021-10-01T07:37:42.806+08:00\u0026#34;,\u0026#34;web_url\u0026#34;:\u0026#34;https://gitlab.cn/addozhang/tekton-test/-/pipelines/19252\u0026#34;,\u0026#34;before_sha\u0026#34;:\u0026#34;0000000000000000000000000000000000000000\u0026#34;,\u0026#34;tag\u0026#34;:false,\u0026#34;yaml_errors\u0026#34;:null,\u0026#34;user\u0026#34;:{\u0026#34;id\u0026#34;:432,\u0026#34;name\u0026#34;:\u0026#34;addozhang\u0026#34;,\u0026#34;username\u0026#34;:\u0026#34;addozhang\u0026#34;,\u0026#34;state\u0026#34;:\u0026#34;active\u0026#34;,\u0026#34;avatar_url\u0026#34;:null,\u0026#34;web_url\u0026#34;:\u0026#34;https://gitlab.cn/addozhang\u0026#34;},\u0026#34;started_at\u0026#34;:null,\u0026#34;finished_at\u0026#34;:null,\u0026#34;committed_at\u0026#34;:null,\u0026#34;duration\u0026#34;:null,\u0026#34;queued_duration\u0026#34;:null,\u0026#34;coverage\u0026#34;:null,\u0026#34;detailed_status\u0026#34;:{\u0026#34;icon\u0026#34;:\u0026#34;status_created\u0026#34;,\u0026#34;text\u0026#34;:\u0026#34;created\u0026#34;,\u0026#34;label\u0026#34;:\u0026#34;created\u0026#34;,\u0026#34;group\u0026#34;:\u0026#34;created\u0026#34;,\u0026#34;tooltip\u0026#34;:\u0026#34;created\u0026#34;,\u0026#34;has_details\u0026#34;:true,\u0026#34;details_path\u0026#34;:\u0026#34;/addozhang/tekton-test/-/pipelines/19252\u0026#34;,\u0026#34;illustration\u0026#34;:null,\u0026#34;favicon\u0026#34;:\u0026#34;/assets/ci_favicons/favicon_status_created-4b975aa976d24e5a3ea7cd9a5713e6ce2cd9afd08b910415e96675de35f64955.png\u0026#34;}} æ€»ç»“ ç”±äºä¹‹å‰ä»»èŒçš„å…¬å¸å†…éƒ¨ä¹Ÿæœ‰ç”¨ Gitlabï¼Œä¹Ÿæœ‰è¿‡ Github Action å’Œ Tektoncd çš„ä½¿ç”¨ç»éªŒï¼Œæ‰€ä»¥ä½“éªŒä¸‹æ¥å¹¶è¿˜æ²¡æœ‰ä»»ä½•é˜»ç¢ã€‚è¿™ä¹Ÿå¾—ç›Šäºæ–‡æ¡£çš„å®Œå–„ï¼Œä»¥åŠæç‹å›¢é˜Ÿçš„åŠªåŠ›ï¼Œå¸Œæœ›æç‹å¯ä»¥åšå¾—æ›´å¥½ã€‚\næ–‡ä¸­ä½¿ç”¨ registry-mirror åšäº†ä»“åº“åï¼Œå¤§å®¶ä¹Ÿèƒ½çŒœåˆ°ç‚¹ä»€ä¹ˆï¼Œæ•¬è¯·å…³æ³¨ä¸€ä¸‹ç¯‡ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/jihu-gitlab-experience/","tags":["Container","DevOps"],"title":"æç‹GitLab SaaS å†…æµ‹è½»åº¦ä½“éªŒ"},{"categories":["ç¿»è¯‘"],"contents":"è¯‘è€…ç‚¹è¯„ï¼š\næœ€è¿‘å¬äº†å¾ˆå¤šèµ„æ·±çš„äººå£«å…³äºå¼€æºï¼Œä»¥åŠå•†ä¸šåŒ–çš„åˆ†æã€‚å¼€æºä¸å•†ä¸šåŒ–ï¼Œå¬èµ·æ¥å°±æ˜¯ä¸€å¯¹çŸ›ç›¾çš„æ‰€åœ¨ï¼Œä¼¼ä¹å¤§å®¶éƒ½åœ¨å°è¯•åšå…¶äºŒè€…çš„å¹³è¡¡ã€‚æ˜¯å…ˆæœ‰å¼€æºï¼Œè¿˜æ˜¯å…ˆæœ‰å•†ä¸šåŒ–ï¼Ÿä¿—è¯è¯´â€œè°ˆé’±ä¸ä¼¤æ„Ÿæƒ…â€ï¼Œè¿‘å‡ å¹´èƒŒé å¼€æºçš„åˆ›ä¸šå…¬å¸å¦‚é›¨åæ˜¥ç¬‹èˆ¬æ¶Œç°ï¼Œå³ä½¿æ˜¯å¼€å‘äººå‘˜ä¹Ÿæ˜¯éœ€è¦ç”Ÿæ´»çš„ã€‚\nå®¹å™¨ç¥è¯ Docker æ›¾ç»æ— æ¯”é£å…‰ï¼Œç››æä¸€æ—¶ã€‚å³ä½¿è¿™æ ·ä¸€ä¸ªå¤‡å—ç©ç›®ï¼Œå¤§è·é£æŠ•çš„çƒ­æ§çš„ç‹¬è§’å…½ä¹Ÿæœªèƒ½å…ä¿—ï¼Œå¹¶ä»˜å‡ºäº†ä¸å°çš„ä»£ä»·ã€‚\nä»Šå¤©è¿™ç¯‡æ–‡ç« è®²è¿°äº† Docker è¿™å®¶å…¬å¸ä»è¯ç”Ÿåˆ°å·…å³°åˆ°æ²¡è½ï¼Œè¿™ä¸€è·¯ä¸Šæ‰€åšçš„æŠ‰æ‹©ï¼Œå¹¶æœ€ç»ˆåšäº†å¼€æºä¸å•†ä¸šçš„åˆ†ç¦»ï¼Œå†ä¸€æ¬¡ä»å¼€æºè¸ä¸Šæ‰¾å¯»å•†ä¸šåŒ–ä¹‹è·¯ã€‚è¿™äº›éƒ½æ˜¯å€¼å¾—æˆ‘ä»¬å‚è€ƒå’Œæ€è€ƒçš„ï¼Œä¸ç®¡æ˜¯å·²ç»å¼€æºæˆ–è€…å‡†å¤‡ä»äº‹å¼€æºçš„ã€‚\nè¿™ç¯‡æ–‡ç« ç¿»è¯‘è‡ªHow Docker broke in half è¿™å®¶æ”¹å˜æ¸¸æˆè§„åˆ™çš„å®¹å™¨å…¬å¸æ˜¯å…¶æ˜”æ—¥çš„å¤–è¡£ã€‚ä½œä¸ºäº‘æ—¶ä»£æœ€çƒ­é—¨çš„ä¼ä¸šæŠ€æœ¯ä¸šåŠ¡ä¹‹ä¸€çš„å®ƒåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ\nDocker å¹¶æ²¡æœ‰å‘æ˜å®¹å™¨â€”â€”å°†è®¡ç®—æœºä»£ç æ‰“åŒ…æˆç´§å‡‘å•å…ƒçš„æ–¹æ³•ï¼Œå¯ä»¥è½»æ¾åœ°ä»ç¬”è®°æœ¬ç”µè„‘ç§»æ¤åˆ°æœåŠ¡å™¨â€”â€”ä½†å®ƒç¡®å®é€šè¿‡åˆ›å»ºä¸€å¥—é€šç”¨çš„å¼€æºå·¥å…·å’Œå¯é‡ç”¨çš„é•œåƒä½¿å…¶æˆä¸ºä¸»æµï¼Œè¿™ä½¿æ‰€æœ‰å¼€å‘äººå‘˜åªéœ€æ„å»ºä¸€æ¬¡è½¯ä»¶å³å¯åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œã€‚\nDocker ä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿè½»æ¾åœ°å°†ä»–ä»¬çš„ä»£ç â€œå®¹å™¨åŒ–â€å¹¶å°†å…¶ä»ä¸€ä¸ªç³»ç»Ÿç§»åŠ¨åˆ°å¦ä¸€ä¸ªç³»ç»Ÿï¼Œè¿…é€Ÿå°†å…¶ç¡®ç«‹ä¸ºè¡Œä¸šæ ‡å‡†ï¼Œé¢ è¦†äº†åœ¨è™šæ‹Ÿæœº (VM) ä¸Šéƒ¨ç½²åº”ç”¨ç¨‹åºçš„ä¸»è¦æ–¹å¼ï¼Œå¹¶ä½¿ Docker æˆä¸ºæ–°ä¸€ä»£æœ€å¿«è¢«é‡‡ç”¨çš„ä¼ä¸šæŠ€æœ¯ä¹‹ä¸€ã€‚\nä»Šå¤©ï¼ŒDocker ä»ç„¶æ´»ç€ï¼Œä½†å®ƒåªæ˜¯å®ƒå¯èƒ½æˆä¸ºçš„å…¬å¸çš„ä¸€å°éƒ¨åˆ†ï¼Œä»æœªæˆåŠŸåœ°å°†è¿™ç§æŠ€æœ¯åˆ›æ–°è½¬åŒ–ä¸ºå¯æŒç»­çš„å•†ä¸šæ¨¡å¼ï¼Œæœ€ç»ˆå¯¼è‡´å…¶ä¼ä¸šä¸šåŠ¡äº 2019 å¹´ 11 æœˆå‡ºå”®ç»™ Mirantisã€‚InfoWorld é‡‡è®¿äº†åå‡ ä½å‰ä»»å’Œç°ä»» Docker å‘˜å·¥ã€å¼€æºè´¡çŒ®è€…ã€å®¢æˆ·å’Œè¡Œä¸šåˆ†æå¸ˆï¼Œäº†è§£ Docker å¦‚ä½•åˆ†å´©ç¦»æçš„æ•…äº‹ã€‚\nDocker è¯ç”Ÿäº† 2008 å¹´ç”± Solomon Hykes åœ¨å·´é»åˆ›ç«‹çš„ DotCloudï¼Œè¿™ä¸ªåæ¥æˆä¸º Docker çš„å…¬å¸æœ€åˆè¢«è®¾è®¡ä¸ºä¾›å¼€å‘äººå‘˜è½»æ¾æ„å»ºå’Œå‘å¸ƒä»–ä»¬çš„åº”ç”¨ç¨‹åºçš„å¹³å°å³æœåŠ¡ (PaaS)ã€‚\nåœ¨ 2010 å¹´å¤å¤©ä¸€èµ·æ¬åˆ°ç¡…è°·å‚åŠ è‘—åçš„ Y Combinator è®¡åˆ’ä¹‹å‰ï¼ŒHykes å¾ˆå¿«å°±åŠ å…¥äº†ä»–çš„æœ‹å‹å…¼ç¨‹åºå‘˜åŒäº‹ Sebastien Pahlã€‚å·²ç»è¢«æ‹’ç»ä¸€æ¬¡çš„ Hykes å’Œ Pahl é‡æ–°ç”³è¯·ï¼ŒPahl çš„çˆ¶äº²åœ¨ä»–ä»¬é¢è¯•å‰å‡ å‘¨æŠŠå»æ—§é‡‘å±±çš„æœºç¥¨é’±æ”¾åœ¨ä»–ä»¬é¢å‰ã€‚å”‰ï¼Œè¿™å¯¹å¤«å¦‡å†æ¬¡è¢«æ‹’ç»ï¼Œç›´åˆ° YC æ ¡å‹ James Lindenbaumï¼Œä¸€å®¶åä¸º Heroku çš„ç«äº‰å…¬å¸çš„åˆ›å§‹äººï¼Œå‡ºé¢ä¸ºä»–ä»¬æ‹…ä¿ã€‚\næˆ‘ä»¬æ‰€çŸ¥é“çš„ Docker äº 2013 å¹´ 3 æœˆåœ¨ PyCon ä¸Šç”± Hykes é¦–æ¬¡æ¼”ç¤ºï¼Œä»–è§£é‡Šè¯´å¼€å‘äººå‘˜ä¸€ç›´è¦æ±‚è®¿é—®æ”¯æŒ DotCloud å¹³å°çš„åº•å±‚æŠ€æœ¯ã€‚ä»–åœ¨é‚£æ¬¡è°ˆè¯ä¸­è¯´ï¼šâ€œæˆ‘ä»¬ä¸€ç›´è®¤ä¸ºèƒ½å¤Ÿè¯´â€œæ˜¯â€ä¼šå¾ˆé…·ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„åº•å±‚éƒ¨åˆ†ï¼Œç°åœ¨ä½ å¯ä»¥å’Œæˆ‘ä»¬ä¸€èµ·åš Linux å®¹å™¨ï¼Œåšä»»ä½•ä½ æƒ³åšçš„äº‹ï¼Œå»æ„å»ºä½ çš„å¹³å°ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ­£åœ¨åšçš„ï¼Œâ€ã€‚\nDocker é¦–å¸­æ‰§è¡Œå®˜ Ben Golub 2013 å¹´è‡³ 2017 å¹´ä¹‹é—´ï¼Œå‘Šè¯‰ InfoWorldï¼Œâ€œè¿™å¬èµ·æ¥å¾ˆè€å¥—ï¼Œä½† Solomon å’Œæˆ‘è°ˆè®ºçš„æ˜¯é¢„å‘å¸ƒï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰é›†è£…ç®±èˆ¹è¿›å…¥å¥¥å…‹å…°æ¸¯ï¼Œæˆ‘ä»¬æ­£åœ¨è°ˆè®ºé›†è£…ç®±åœ¨èˆªè¿ç•Œçš„ä»·å€¼ã€‚äº‹å®ä¸Šï¼Œä»ä¸–ç•Œçš„ä¸€ä¾§è¿é€æ±½è½¦æ¯”å°†åº”ç”¨ç¨‹åºä»ä¸€ä¸ªæœåŠ¡å™¨å¸¦åˆ°å¦ä¸€ä¸ªæœåŠ¡å™¨æ›´å®¹æ˜“ï¼Œè¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªéœ€è¦è§£å†³çš„é—®é¢˜ã€‚â€\nDocker å¼€æºé¡¹ç›®è¿…é€Ÿå´›èµ·ï¼Œå¸å¼•äº†æˆåƒä¸Šä¸‡çš„ç”¨æˆ·ï¼Œä¸å¾®è½¯ã€AWS å’Œ IBM ç­‰å…¬å¸å»ºç«‹äº†å¤‡å—ç©ç›®çš„åˆä½œä¼™ä¼´å…³ç³»ï¼Œå¹¶è·å¾—äº†æ»¡æ»¡ä¸€è½¦çš„é£é™©æŠ•èµ„ï¼ŒåŒ…æ‹¬ Benchmark çš„ Peter Fenton å’Œ Trinity Ventures çš„ Dan Scholnick çš„æ—©æœŸæŠ•èµ„ã€‚è°ƒæ•´åçš„å…¬å¸æ›´åä¸º Dockerï¼Œå¹¶ä» Benchmarkã€Coatue Managementã€Goldman Sachs å’Œ Greylock Partners ç­‰å…¬å¸ç­¹é›†äº†è¿‘ 3 äº¿ç¾å…ƒã€‚ç„¶è€Œï¼Œä¸è®¸å¤šåŸºäºå¼€æºè½¯ä»¶çš„å…¬å¸ä¸€æ ·ï¼Œå®ƒå¾ˆéš¾æ‰¾åˆ°ä¸€ç§å¯ç›ˆåˆ©çš„å•†ä¸šæ¨¡å¼ï¼Œè€Œè¿™äº›æŠ•èµ„è€…ä»æœªå¾—åˆ°ä»–ä»¬çš„å¤§ç¬”å›æŠ¥ã€‚ã€‚\nRedMonk åˆ†æå¸ˆ James Governor è¯´ï¼Œâ€œSolomon å»ºç«‹äº†è¿‡å» 20 å¹´æ¥æœ€å¼•äººæ³¨ç›®çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œå¹¶ä¸”åœ¨å°†è§‚ç‚¹æ‰“åŒ…å¹¶ä½¿å…¶å¯¹å¤§é‡å¼€å‘äººå‘˜éå¸¸æœ‰ä»·å€¼çš„ä¸šåŠ¡ä¸­ã€‚Docker æ˜¯å¦åšå‡ºäº†é”™è¯¯çš„å†³å®šï¼Ÿæ˜¾ç„¶æ˜¯çš„ï¼Œä½†é£æŠ•éƒ½ç–¯äº†ï¼Œä»–ä»¬å‘ä»–ä»¬æŠ•å…¥çš„é’±æ„å‘³ç€ä»–ä»¬ä¸€å®šè§‰å¾—ä»–ä»¬å¯ä»¥åšä»»ä½•äº‹æƒ…ï¼Œè¿™æ˜¯æœ‰é—®é¢˜çš„ã€‚â€\nå¿«è¿›åˆ° 2021 å¹´ï¼Œè¿™ä¸ªæ•…äº‹çš„ç®€ç‰ˆæ˜¯ï¼Œå¤‡å—æ¬¢è¿çš„å¼€æºå®¹å™¨ç¼–æ’å·¥å…· Kubernetes é€šè¿‡å–ä»£å…¶ä¸»è¦åˆ©æ¶¦æ¥æºï¼šä¸€ä¸ªåä¸º Docker Swarm çš„ä¼ä¸šç‰ˆå®¹å™¨ç¼–æ’å·¥å…·ï¼Œåƒæ‰äº† Dockerï¼ˆä¸šåŠ¡ï¼‰çš„åˆé¤. ç„¶è€Œï¼ŒçœŸå®çš„æ•…äº‹è¦å¤æ‚å¾—å¤šã€‚\nå¼€æºå•†ä¸šåŒ–å¾ˆéš¾ å·¨é¢çš„é£é™©æŠ•èµ„ã€å¿«é€Ÿå¢é•¿çš„ç«äº‰æ ¼å±€ä»¥åŠäº‘è¡Œä¸šå·¨å¤´éƒ½æƒ³åˆ†ä¸€æ¯ç¾¹çš„é˜´å½±ï¼Œå°†è¿™å®¶å¹´è½»çš„å…¬å¸å¸¦å…¥äº†ä¸€ä¸ªçŠ¹å¦‚å‹åŠ›é”…çš„è¿è¥ç¯å¢ƒã€‚\nâ€œæœ‰ä¸€ç§è¯´æ³•æ˜¯\u0026rsquo;å¤§è±¡æ‰“æ¶ï¼Œè‰è¢«è·µè¸\u0026rsquo;ï¼Œæˆ‘ä»¬å¾ˆæ¸…æ¥šè¿™ä¸ä»…æ˜¯é’ˆå¯¹ Dockerï¼Œè¿˜æœ‰äº‘ä¾›åº”å•†çš„ç›¸äº’ç«äº‰ã€‚ä»–ä»¬éƒ½æƒ³æŠŠæˆ‘ä»¬æ‹‰å‘ä¸åŒçš„æ–¹å‘ã€‚æ—¢è¦ä¿æŒæˆ‘ä»¬çš„ä»·å€¼è§‚å’Œæ ¹åŸºï¼Œåˆè¦å»ºç«‹ä¸€ä¸ªä¼ä¸šï¼Œè¿™ä¸ªæ ¹æœ¬å°±æ˜¯ä¸ªå›°å±€â€Golub è¯´ã€‚\nè¿™ä½å‰ CEO æŒ‡å‡ºï¼Œéšç€ Docker çš„å‘å±•ï¼Œæ‰€æœ‰è¿™äº›å› ç´ éƒ½é€ æˆäº†â€œè‡ªç„¶çš„ç´§å¼ å…³ç³»â€ã€‚Golub è¯´ï¼šâ€œæˆ‘ä»¬å¸Œæœ›å»ºç«‹ä¼Ÿå¤§çš„ç¤¾åŒºå¹¶é€šè¿‡å¼€å‘è€…äº§å“è·åˆ©ï¼ŒåŒæ—¶è¿˜å¸Œæœ›å»ºç«‹ä¸€ä¸ªä¼Ÿå¤§çš„è¿è¥å•†äº§å“ï¼Œè®©å®¢æˆ·èƒ½å¤Ÿå¤§è§„æ¨¡æ„å»ºå’Œéƒ¨ç½²å®¹å™¨ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„æ„¿æ™¯ï¼Œå¾ˆå¿«æˆ‘ä»¬æ„è¯†åˆ°æˆ‘ä»¬å¿…é¡»è¿…é€Ÿæ‰©å¤§è§„æ¨¡ï¼Œè€Œä¸”æ²¡æœ‰å¤ªå¤šæ—¶é—´æ¥å¹³è¡¡ç¤¾åŒºå’Œæˆä¸ºä¸€å®¶å•†ä¸šä¼ä¸š\u0026hellip;\u0026hellip;åœ¨ä¸€å®¶åˆåˆ›å…¬å¸ï¼Œä½ æ¯å¤©è¦åšå‡º 100 ä¸ªå†³å®šï¼Œä½ å¸Œæœ› 80 ä¸ªæ˜¯å¯¹çš„ã€‚â€\n2014 å¹´å·¦å³ï¼ŒDocker å¼€å§‹è®¤çœŸè€ƒè™‘å°†å…¶åœ¨å®¹å™¨é¢†åŸŸçš„é¢†å…ˆåœ°ä½è´§å¸åŒ–çš„å•†ä¸šæˆ˜ç•¥ï¼Œå½“æ—¶è¯¥å…¬å¸å°†éƒ¨åˆ†é£é™©æŠ•èµ„èµ„é‡‘ç”¨äº 2014 å¹´ Koality çš„æ”¶è´­å’Œ 2015 å¹´çš„ Tutum çš„æ”¶è´­ï¼ŒåŒæ—¶è¿˜æ¨å‡ºäº†è‡ªå·±çš„ä¼ä¸šæ”¯æŒè®¡åˆ’çš„ç¬¬ä¸€æ¬¡è¿­ä»£ã€‚\nè¿™äº›æŠ•èµ„å‚¬ç”Ÿäº†åƒ Docker Hub è¿™æ ·çš„äº§å“â€”â€”ä½ å¯ä»¥è®¤ä¸ºå®ƒæœ‰ç‚¹åƒ Docker é•œåƒçš„ GitHubï¼ˆç°åœ¨ä¹Ÿå­˜åœ¨ï¼‰â€”â€” ä»¥åŠæœ€ç»ˆçš„ Docker ä¼ä¸šç‰ˆã€‚ä½†è¿™äº›äº§å“éƒ½æ²¡æœ‰çœŸæ­£å—åˆ°ä¼ä¸šå®¢æˆ·çš„æ¬¢è¿ï¼Œä»–ä»¬é€šå¸¸ä¹äºä¸æ›´æˆç†Ÿçš„åˆä½œä¼™ä¼´åˆä½œï¼Œæˆ–è€…æ„å»ºè€Œä¸æ˜¯è´­ä¹°è§£å†³æ–¹æ¡ˆï¼Œå°½ç®¡ Docker åŠªåŠ›ç”Ÿäº§å®¢æˆ·çœŸæ­£æƒ³è¦çš„ä¸€ç³»åˆ—äº§å“ã€‚\nä»Šå¹´å¤å¤©åœ¨æ³•å›½åº¦å‡æ—¶ï¼ŒHykes å‘Šè¯‰ InfoWorldï¼šâ€œæˆ‘ä»¬ä»æœªå‘å¸ƒè¿‡å‡ºè‰²çš„å•†ä¸šäº§å“ï¼ŒåŸå› æ˜¯æˆ‘ä»¬æ²¡æœ‰é›†ä¸­æ³¨æ„åŠ›ã€‚æˆ‘ä»¬è¯•å›¾åšæ¯ä»¶äº‹çš„ä¸€ç‚¹ç‚¹ã€‚ç»´æŒå¼€å‘è€…ç¤¾åŒºçš„å¢é•¿å¹¶æ„å»ºä¸€ä¸ªä¼Ÿå¤§çš„å•†ä¸šäº§å“å·²ç»å¤Ÿéš¾çš„äº†ï¼Œæ›´ä¸ç”¨è¯´ä¸‰å››ä¸ªäº†ï¼Œè€Œä¸”åŸºæœ¬ä¸å¯èƒ½åŒæ—¶åšåˆ°ï¼Œä½†è¿™å°±æ˜¯æˆ‘ä»¬è¯•å›¾åšçš„ï¼Œæˆ‘ä»¬èŠ±äº†å¤§é‡çš„é’±æ¥åšè¿™äº›äº‹ã€‚ â€\nDockerDocker ä¸šåŠ¡å‘å±•å’ŒæŠ€æœ¯è”ç›Ÿçš„å‰å‰¯æ€»è£ã€æœ€æ—©çš„å‘˜å·¥ä¹‹ä¸€ Nick Stinemates è¯´ï¼šâ€œåœ¨å¼€æºä¹‹å¤–å‡ºç°äº†é›¶æŠ€æœ¯äº¤ä»˜ï¼Œæ ¹æœ¬æ— æ³•äº¤ä»˜å•†ä¸šè½¯ä»¶ã€‚â€\näº‹åçœ‹æ¥ï¼ŒHykes è®¤ä¸º Docker åº”è¯¥èŠ±æ›´å°‘çš„æ—¶é—´æ¥è¿é€äº§å“ï¼Œè€Œåº”è¯¥èŠ±æ›´å¤šçš„æ—¶é—´å€¾å¬å®¢æˆ·çš„æ„è§ã€‚Hykes è¯´ï¼šâ€œæˆ‘æœ¬æ¥ä¸ä¼šæ€¥äºæ‰©å¤§å•†ä¸šäº§å“çš„è§„æ¨¡ï¼Œè€Œæ˜¯æŠ•å…¥æ›´å¤šèµ„é‡‘ä»æˆ‘ä»¬çš„ç¤¾åŒºæ”¶é›†è§è§£ï¼Œå¹¶å»ºç«‹ä¸€ä¸ªè‡´åŠ›äºäº†è§£ä»–ä»¬çš„å•†ä¸šéœ€æ±‚çš„å›¢é˜Ÿã€‚æˆ‘ä»¬åœ¨ 2014 å¹´æœ‰ä¸€ä¸ªè½¬æŠ˜ç‚¹ï¼Œå½“æ—¶æˆ‘ä»¬è§‰å¾—æˆ‘ä»¬ç­‰ä¸åŠäº†ï¼Œä½†æˆ‘è®¤ä¸ºæˆ‘ä»¬ç­‰å¾…çš„æ—¶é—´æ¯”æˆ‘ä»¬æ„è¯†åˆ°çš„è¦å¤šã€‚â€\nå…¶ä»–äººè®¤ä¸º Docker è¿‡æ—©åœ°å…è´¹æä¾›äº†å¤ªå¤šä¸œè¥¿ã€‚ä»Šå¹´æ—©äº›æ—¶å€™ï¼Œè°·æ­Œçš„ Kelsey Hightower å‘Šè¯‰ Increment æ‚å¿—ï¼š â€œä»–ä»¬å…è´¹æ¨å‡ºäº†ä¸€äº›ä¸œè¥¿ï¼Œè¿™å°±æ˜¯æœ¬å’æ‰“ã€‚ä»–ä»¬è§£å†³äº†æ•´ä¸ªé—®é¢˜å¹¶è¾¾åˆ°äº†è¿™ä¸ªé—®é¢˜çš„å¤©èŠ±æ¿ï¼šåˆ›å»ºä¸€ä¸ªæ˜ åƒã€æ„å»ºå®ƒã€å°†å®ƒå­˜å‚¨åœ¨æŸä¸ªåœ°æ–¹ã€ç„¶åè¿è¡Œå®ƒã€‚è¿˜éœ€è¦åšä»€ä¹ˆï¼Ÿâ€\nHykes ä¸åŒæ„è¿™ç§è¯´æ³•ã€‚ä»–è¯´ï¼šâ€œæˆ‘è®¤ä¸ºè¿™æ˜¯é”™è¯¯çš„ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæ ¸å¿ƒå¼€æºäº§å“åˆ›é€ äº†å·¨å¤§çš„å¢é•¿ï¼Œè¿™é¦–å…ˆåˆ›é€ äº†å•†ä¸šåŒ–çš„æœºä¼šã€‚è®¸å¤šå…¬å¸æˆåŠŸåœ°å°† Docker å•†ä¸šåŒ–ï¼Œä½† Docker æ²¡æœ‰ã€‚æœ‰å¾ˆå¤šä¸œè¥¿å¯ä»¥å•†ä¸šåŒ–ï¼Œåªæ˜¯ Docker æœªèƒ½å°†å…¶å•†ä¸šåŒ–ã€‚â€\nä¾‹å¦‚ï¼Œçº¢å¸½å’Œ Pivotalï¼ˆç°åœ¨æ˜¯ VMware çš„ä¸€éƒ¨åˆ†ï¼‰éƒ½æ˜¯ Docker çš„æ—©æœŸåˆä½œä¼™ä¼´ï¼Œå°† Docker å®¹å™¨é›†æˆåˆ°ä»–ä»¬çš„å•†ä¸š PaaS äº§å“ï¼ˆåˆ†åˆ«æ˜¯ OpenShift å’Œ Cloud Foundryï¼‰ä¸­ï¼Œå¹¶ä¸ºå¼€æºé¡¹ç›®åšå‡ºäº†è´¡çŒ®ã€‚\nStinemates è¯´ï¼šâ€œå¦‚æœæˆ‘æ˜¯æ…·æ…¨çš„ï¼Œçº¢å¸½å…¬å¸æ—©æœŸçš„è´¡çŒ®è®© Solomon æœ‰ç‚¹å¤±æ§äº†ã€‚Solomon çƒ§æ‰äº†å¾ˆå¤šæ¡¥æ¢ï¼ŒHacker News ä¸Šæœ‰å…³äºä»–ä¸åå¯¹è€…äº‰åµçš„å¸–å­ã€‚ä¼ä¸šåˆä½œä¼™ä¼´ä¸å¯èƒ½ä¸ Solomon ä¸€èµ·æ‹¥æœ‰è¿™äº›ã€‚â€\nä»Šå¤©ï¼ŒHykes è¯´ä»–çŠ¯äº†æ··æ·†â€œç¤¾åŒºä¸ç”Ÿæ€ç³»ç»Ÿâ€çš„é”™è¯¯ã€‚çº¢å¸½ç‰¹åˆ«â€œä¸æ˜¯ç¤¾åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä»–ä»¬ä»æ¥æ²¡æœ‰ä¸º Docker çš„æˆåŠŸè€Œç”Ÿæ ¹ï¼Œâ€ä»–è¯´ã€‚â€œæˆ‘ä»¬çš„é”™è¯¯æ˜¯éå¸¸å¸Œæœ›ä»–ä»¬æˆä¸ºç¤¾åŒºçš„ä¸€éƒ¨åˆ†ã€‚å›æƒ³èµ·æ¥ï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šä»è¿™ç§ä¼™ä¼´å…³ç³»ä¸­å—ç›Šã€‚â€\nå› æ­¤ï¼Œæ—…æ¸¸ç§‘æŠ€å…¬å¸ Amadeus ç­‰æ—©æœŸå®¢æˆ·åœ¨ 2015 å¹´è½¬å‘çº¢å¸½ï¼Œä»¥å¡«è¡¥ä»–ä»¬è®¤ä¸º Docker ç•™ä¸‹çš„ä¼ä¸šçº§ç©ºç™½ã€‚Amadeus çš„äº‘å¹³å°è´Ÿè´£äºº Edouard Hubin é€šè¿‡ç”µå­é‚®ä»¶å‘Šè¯‰ InfoWorldï¼šâ€œæˆ‘ä»¬ç›´æ¥ä»ä½¿ç”¨ [Docker çš„] å¼€æºç‰ˆæœ¬çš„å…ˆé©±æ¨¡å¼è½¬å˜ä¸ºä¸çº¢å¸½å»ºç«‹å¼ºå¤§çš„åˆä½œä¼™ä¼´å…³ç³»ï¼Œä»–ä»¬ä¸ºæˆ‘ä»¬æä¾›å®¹å™¨æŠ€æœ¯çš„æ”¯æŒã€‚å®¹å™¨åŒ–æ˜¯è¿œç¦»è™šæ‹ŸåŒ–çš„æŠ€æœ¯å˜é©çš„ç¬¬ä¸€æ­¥ã€‚çœŸæ­£çš„æ¸¸æˆè§„åˆ™å˜é©è€…æ˜¯å®¹å™¨ç¼–æ’è§£å†³æ–¹æ¡ˆã€‚æ˜¾ç„¶ï¼ŒDocker è¾“ç»™äº† Kubernetesï¼Œè¿™å¯¹ä»–ä»¬æ¥è¯´æ˜¯ä¸€ä¸ªéå¸¸å›°éš¾çš„å±€é¢ã€‚â€\nKubernetes çš„å†³å®š Docker ä¼šåæ‚”ä¹‹å‰åšçš„ä¸€ç³»åˆ—å†³å®šï¼Œå› ä¸ºå®ƒæ‹’ç»çœŸæ­£æ¥å— Kubernetes ä½œä¸ºé¦–é€‰çš„æ–°å…´å®¹å™¨ç¼–æ’å·¥å…· â€”â€” Kubernetes å…è®¸å®¢æˆ·å¤§è§„æ¨¡ã€ä¸€è‡´åœ°è¿è¡Œå®¹å™¨é˜Ÿåˆ—â€”â€”è€Œä¸æ˜¯çŸ­è§†åœ°æ¨è¿›è‡ªå·±ä¸“æœ‰çš„ Docker Swarm ç¼–æ’å™¨ï¼ˆRIPï¼‰ã€‚\nDocker æœ€æ—©ä¹Ÿæ˜¯æœåŠ¡æ—¶é—´æœ€é•¿çš„å‘˜å·¥ä¹‹ä¸€ JÃ©rÃ´me Petazzoni è¯´ï¼šâ€œæœ€å¤§çš„é”™è¯¯æ˜¯é”™è¿‡äº† Kubernetesã€‚æˆ‘ä»¬å¤„äºé›†ä½“æ€æƒ³æ³¡æ²«ä¸­ï¼Œæˆ‘ä»¬åœ¨å†…éƒ¨è®¤ä¸º Kubernetes å¤ªå¤æ‚äº†ï¼Œè€Œ Swarm ä¼šæˆåŠŸå¾—å¤šã€‚æ²¡æœ‰æ„è¯†åˆ°è¿™ä¸€ç‚¹æ˜¯æˆ‘ä»¬çš„é›†ä½“å¤±è´¥ã€‚â€\näº‹å®æ˜¯ï¼ŒDocker åœ¨ 2014 å¹´æœ‰æœºä¼šä¸è°·æ­Œçš„ Kubernetes å›¢é˜Ÿå¯†åˆ‡åˆä½œï¼Œå¹¶åœ¨æ­¤è¿‡ç¨‹ä¸­å¯èƒ½æ‹¥æœ‰æ•´ä¸ªå®¹å™¨ç”Ÿæ€ç³»ç»Ÿã€‚Stinemates è¯´ï¼šâ€œæˆ‘ä»¬æœ¬å¯ä»¥è®© Kubernetes æˆä¸º GitHub ä¸Š Docker æ——å¸œä¸‹çš„ä¸€æµ Docker é¡¹ç›®ã€‚äº‹åçœ‹æ¥ï¼ŒSwarm ä¸Šå¸‚å¤ªæ™šæ˜¯ä¸€ä¸ªé‡å¤§é”™è¯¯ã€‚â€\næ®åœ¨åœºçš„å¤šåäººå£«ç§°ï¼Œè°·æ­Œæ—§é‡‘å±±åŠå…¬å®¤çš„æ—©æœŸè®¨è®ºæ˜¯æŠ€æœ¯æ€§çš„å’Œç´§å¼ çš„ï¼Œå› ä¸ºåŒæ–¹å¯¹å¦‚ä½•è¿›è¡Œå®¹å™¨ç¼–æ’æŒä¸åŒçš„æ„è§ã€‚\nKubernetes è”åˆåˆ›å§‹äººã€ç°ä»» VMware å‰¯æ€»è£ Craig McLuckie è¡¨ç¤ºï¼Œä»–æå‡ºå°† Kubernetes æèµ ç»™ Dockerï¼Œä½†åŒæ–¹æœªèƒ½è¾¾æˆåè®®ã€‚ä»–å‘Šè¯‰ InfoWorldï¼šâ€œé‚£é‡Œæœ‰ä¸€ä¸ªç›¸äº’å‚²æ…¢çš„å› ç´ ï¼Œä»ä»–ä»¬é‚£é‡Œæˆ‘ä»¬ä¸äº†è§£å¼€å‘äººå‘˜çš„ç»éªŒï¼Œä½†ç›¸äº’çš„æ„Ÿè§‰æ˜¯è¿™äº›å¹´è½»çš„æ–°è´µçœŸçš„ä¸äº†è§£åˆ†å¸ƒå¼ç³»ç»Ÿç®¡ç†ã€‚â€å…¶ä»–äººåˆ™è¡¨ç¤ºè®¨è®ºæ›´ä¸ºéæ­£å¼ï¼Œå¹¶ä¸”ä¾§é‡äºå®¹å™¨æŠ€æœ¯çš„è”åˆå¼€å‘ã€‚æ— è®ºå“ªç§æ–¹å¼ï¼Œå›¢é˜Ÿä»æ¥æ²¡æœ‰æ„è§ä¸€è‡´å¹¶æœ€ç»ˆåˆ†é“æ‰¬é•³ï¼Œè°·æ­Œåœ¨ 2014 å¹´å¤å¤©æ¨å‡ºäº† Kubernetesã€‚\nHykes å¯¹ Google å‘ Docker æä¾› Kubernetes é¡¹ç›®çš„æ‰€æœ‰æƒæå‡ºå¼‚è®®ï¼Œç§°ä»–ä»¬â€œæœ‰æœºä¼šåƒå…¶ä»–äººä¸€æ ·æˆä¸ºç”Ÿæ€ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†â€ã€‚\nHykes æ‰¿è®¤å½“æ—¶ Docker å’Œ Google å›¢é˜Ÿä¹‹é—´å¤„äºç´§å¼ å…³ç³»ã€‚Hykes è¯´ï¼šâ€œæœ‰é‚£ä¹ˆä¸€åˆ»ï¼Œè‡ªè´Ÿå äº†ä¸Šé£ã€‚è°·æ­Œçš„å¾ˆå¤šèªæ˜å’Œæœ‰ç»éªŒçš„äººéƒ½è¢« Docker çš„å®Œå…¨å±€å¤–äººè’™è”½äº†åŒçœ¼ã€‚æˆ‘ä»¬æ²¡æœ‰åœ¨è°·æ­Œå·¥ä½œï¼Œæˆ‘ä»¬æ²¡æœ‰å»æ–¯å¦ç¦ï¼Œæˆ‘ä»¬æ²¡æœ‰è®¡ç®—æœºç§‘å­¦åšå£«å­¦ä½ã€‚æœ‰äº›äººè§‰å¾—è¿™æ˜¯ä»–ä»¬çš„äº‹ï¼Œæ‰€ä»¥æœ‰ä¸€åœºè‡ªæˆ‘ä¹‹æˆ˜ã€‚ç»“æœå¹¶ä¸æ˜¯ Docker å’Œ Kubernetes å›¢é˜Ÿä¹‹é—´çš„è‰¯å¥½åˆä½œï¼Œè€Œæ­¤æ—¶åˆä½œç¡®å®æœ‰æ„ä¹‰ã€‚â€\nStinemates è¯´ï¼šâ€œä¸€æ–¹é¢æ˜¯åŸºæœ¬çš„è‡ªæˆ‘ï¼Œå¦ä¸€æ–¹é¢æ˜¯ä¸ [Kubernetes è”åˆåˆ›å§‹äºº] Joe Bedaã€Brendan Burns å’Œ Craig McLuckie çš„ç´§å¼ å…³ç³»â€”â€”ä»–ä»¬å¯¹æœåŠ¡çº§åˆ« API çš„éœ€æ±‚æœ‰å¼ºçƒˆçš„çœ‹æ³•ï¼Œè€Œä»ç®€å•çš„è§’åº¦æ¥çœ‹ Docker åœ¨æŠ€æœ¯ä¸Šå¯¹å•ä¸ª API æœ‰è‡ªå·±çš„çœ‹æ³•ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æ— æ³•è¾¾æˆä¸€è‡´ã€‚â€\nHykes æ‰¿è®¤ï¼Œå½“æ—¶ Docker é¢ä¸´ç€ä¸ºæƒ³è¦æ‰©å±•å®¹å™¨ä½¿ç”¨è§„æ¨¡çš„å®¢æˆ·å¯»æ‰¾ç¼–æ’è§£å†³æ–¹æ¡ˆçš„å‹åŠ›ï¼Œä½†å½“æ—¶Kubernetes å°†æˆä¸ºè¯¥è§£å†³æ–¹æ¡ˆå¹¶ä¸æ˜ç¡®ã€‚Hykes è¯´ï¼šâ€œKubernetes å¤ªæ—©äº†ï¼Œè€Œä¸”æ˜¯å‡ åä¸ªä¸­çš„ä¸€ä¸ªï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç¥å¥‡åœ°çŒœæµ‹å®ƒä¼šå æ®ä¸»å¯¼åœ°ä½ï¼Œç”šè‡³ä¸æ¸…æ¥šè°·æ­Œå¯¹å®ƒçš„æ‰¿è¯ºã€‚æˆ‘é—®æˆ‘ä»¬çš„å·¥ç¨‹å¸ˆå’Œæ¶æ„å¸ˆè¯¥æ€ä¹ˆåšï¼Œä»–ä»¬å»ºè®®æˆ‘ä»¬ç»§ç»­ä½¿ç”¨ Swarmã€‚â€\nç”šè‡³ McLuckie ä¹Ÿæ‰¿è®¤ä»–â€œä¸çŸ¥é“ Kubernetes ä¼šå˜æˆ Kubernetesã€‚å›é¡¾å†å²å¾ˆå®¹æ˜“è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªç³Ÿç³•çš„é€‰æ‹©ã€‚â€\nä¸ç®¡å®ƒå¤±è´¥äº†ï¼ŒKubernetes æœ€ç»ˆèµ¢å¾—äº†å®¹å™¨ç¼–æ’ä¹‹æˆ˜ï¼Œå…¶ä½™çš„æˆä¸ºè½¯ä»¶è¡Œä¸šçš„åŒ†åŒ†è¿‡å®¢ã€‚\n451 Research çš„åˆ†æå¸ˆ Jay Lyman è¯´ï¼šâ€œKubernetes æ¥äº†ï¼Œå¹¶æŠ¢èµ°äº†æ‰€æœ‰çš„é£å¤´ã€‚å®ƒä»£è¡¨äº†è°·æ­Œåœ¨å¼€å‘å’Œå¼€æºæ–¹é¢å¯¹å®¹å™¨çš„ä½¿ç”¨ï¼Œè¿™åœ¨å¾ˆå¤šæ–¹é¢éƒ½è¶…è¿‡äº†å¯¹ Docker çš„å…³æ³¨ã€‚[Docker] å°† Docker Swarm è§†ä¸ºä»–ä»¬é€šè¿‡è½¯ä»¶è·åˆ©çš„æ–¹å¼ã€‚å¦‚æœä»–ä»¬å¯ä»¥å›å»ï¼Œä»–ä»¬å¯èƒ½ä¼šä»ä¸€å¼€å§‹å°±ä¸ Kubernetes æ›´ç´§å¯†åœ°é›†æˆã€‚ä»–ä»¬è¿‡äºä¸“æ³¨äºç‹¬è‡ªè¡ŒåŠ¨ã€‚â€\nMcLuckie è¯´ï¼šâ€œæˆ‘æœ€æ·±åˆ‡çš„é—æ†¾ä¹‹ä¸€æ˜¯æˆ‘ä»¬æ²¡æœ‰æ‰¾åˆ°è°ˆåˆ¤çš„æ–¹æ³•ã€‚Docker æä¾›äº†ä¸€äº›éå‡¡çš„ä½“éªŒï¼Œè€Œ Kubernetes æä¾›çš„ä¸œè¥¿ï¼Œä»ä½“éªŒçš„è§’åº¦æ¥çœ‹ï¼Œå¹¶ä¸é‚£ä¹ˆå¼•äººæ³¨ç›®ã€‚â€ æˆ–è€…ï¼Œæ­£å¦‚ Docker è”åˆåˆ›å§‹äºº Sebastien Pahl æŒ‡å‡ºçš„é‚£æ ·ï¼šâ€œç®€å•å¹¶æ²¡æœ‰è·èƒœã€‚æˆ‘å–œæ¬¢ Kubernetesï¼Œä½†å®ƒä¸é€‚åˆæ™®é€šäººã€‚â€\né«˜å±‚çš„ç´§å¼ æ°”æ°› åœ¨ 2015 å¹´ä»¥ 10 äº¿ç¾å…ƒçš„â€œç‹¬è§’å…½â€ä¼°å€¼å®Œæˆ 9500 ä¸‡ç¾å…ƒçš„å¤§å‹ D è½®èèµ„ä¹‹åï¼ŒDocker æœ€ç»ˆè¾¾åˆ°äº†ç‚’ä½œå‘¨æœŸçš„å·…å³°ã€‚\nSteinmates è¯´ï¼šâ€œè¿™è®¾å®šäº†éå¸¸é«˜çš„æœŸæœ›ï¼Œå¹¶æš´éœ²äº†æˆ‘ä»¬ä½œä¸ºä¸€å®¶å…¬å¸å°†é¢ä¸´çš„ä¸€äº›åŸºæœ¬é—®é¢˜ã€‚æˆ‘è®¤ä¸º Ben [Golubï¼Œé¦–å¸­æ‰§è¡Œå®˜] å¯¹å…¬å¸çš„æƒ³æ³•ä¸ Solomon ä¸åŒï¼Œä¸¤äººæ²¡æœ‰æ„è§ä¸€è‡´åº”è¯¥ä¸æ˜¯ä»€ä¹ˆç§˜å¯†ã€‚è‘£äº‹ä¼šå¤§é‡æºå’ŒåŠªåŠ›è®©åˆ›å§‹äººå¼€å¿ƒï¼Œå¹¶ç»™ CEO è¶³å¤Ÿçš„å›æ—‹ä½™åœ°ï¼Œä½¿å…¬å¸å–å¾—æˆåŠŸã€‚å¦‚æœç”± Solomon å†³å®šï¼Œæˆ‘ä»¬ä¼šåšæŒä»¥ç¤¾åŒºä¸ºå¯¼å‘çš„è·¯çº¿æ¥åˆ›é€ ç—…æ¯’å¼ä¼ æ’­ã€‚å¦‚æœç”± Ben å†³å®šï¼Œæˆ‘ä»¬ä¼šæ›´æ—©åœ°è½¬å‘ä¸šåŠ¡æ–¹é¢ã€‚è¿™ç§ç´§å¼ å±€åŠ¿å¯¼è‡´æˆ‘ä»¬å¯¹ä¸¤è€…éƒ½é‡‡å–äº†åŠé€”è€ŒåºŸçš„æ–¹å¼ã€‚â€\nè¿™ç§æ–¹æ³•æœ‰æ•ˆåœ°å‚¬ç”Ÿäº†ä¸¤ä¸ªDockerï¼šDocker ç¤¾åŒºç‰ˆï¼ˆé¢å‘å¼€å‘äººå‘˜çš„å¹¿å—æ¬¢è¿çš„å‘½ä»¤è¡Œå·¥å…·å’Œå¼€æºé¡¹ç›®ï¼‰å’Œ Docker ä¼ä¸šç‰ˆï¼ˆé¢å‘å¸Œæœ›å¤§è§„æ¨¡é‡‡ç”¨å®¹å™¨çš„ä¼ä¸šå®¢æˆ·çš„å•†ä¸šå·¥å…·å¥—ä»¶ï¼‰ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå…¬å¸çš„åŠ¨ä½œå¤ªæ…¢äº†ï¼Œæ— æ³•æ­£å¼è¿›è¡Œæ‹†åˆ†å¹¶ç›¸åº”åœ°åˆ†é…èµ„æºã€‚\nGolub æ‰¿è®¤ä»–ä»¬â€œåº”è¯¥æ¯”å®é™…æ›´æ—©åœ°æ‹†åˆ†ä¸šåŠ¡â€ï¼Œè€Œ Hykes åŒæ„ Docker â€œä»æœªæ‰¾åˆ°è¿æ¥å…¬å¸è¿™ä¸¤éƒ¨åˆ†çš„æ–¹æ³•â€ã€‚\nåˆ°äº† 2018 å¹´ï¼Œè£‚ç¼å¼€å§‹æ˜¾ç°ï¼Œå› ä¸ºè¯¥å…¬å¸åŠªåŠ›åœ¨æ—¥ç›Šä¸æ»¡çš„å¼€æºç¤¾åŒºã€å¼ºå¤§çš„åˆä½œä¼™ä¼´å’Œè¦æ±‚åœ¨ç”Ÿäº§ä¸­è¿è¡Œå®¹å™¨çš„ä¼ä¸šå®¢æˆ·ä¹‹é—´æ‰¾åˆ°å¯è¡Œçš„é“è·¯ã€‚\nä¸ä¹…ä¹‹åï¼ŒHykes äº 2018 å¹´ 3 æœˆç¦»å¼€äº†ä»–åœ¨å…¬å¸çš„æ—¥å¸¸è§’è‰²ï¼Œä»–åœ¨ä¸€ç¯‡åšå®¢æ–‡ç« ä¸­æŒ‡å‡ºï¼Œâ€œä½œä¸ºåˆ›å§‹äººï¼Œæˆ‘å½“ç„¶æœ‰å¤æ‚çš„æƒ…ç»ªã€‚å½“ä½ åˆ›å»ºä¸€å®¶å…¬å¸æ—¶ï¼Œä½ çš„å·¥ä½œæ˜¯ç¡®ä¿å®ƒæœ‰ä¸€å¤©å¯ä»¥åœ¨æ²¡æœ‰ä½ çš„æƒ…å†µä¸‹å–å¾—æˆåŠŸã€‚ç„¶åæœ€ç»ˆæœ‰ä¸€å¤©ä¼šåˆ°æ¥ï¼Œåº†ç¥æ´»åŠ¨å¯èƒ½æ˜¯è‹¦ä¹å‚åŠã€‚å¯¹äºåˆ›å§‹äººæ¥è¯´ï¼Œæ”¾å¼ƒä¸€ç”Ÿçš„å·¥ä½œç»éæ˜“äº‹ã€‚â€\nä»Šå¤©å›æƒ³èµ·æ¥ï¼ŒHykes æ›´ç®€å•ã€‚â€œæˆ‘æ„è¯†åˆ°æˆ‘ä¸å±äºè¿™å®¶å…¬å¸ã€‚ç•™ä¸‹å¯¹æˆ‘æ¥è¯´æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œæ‰€ä»¥æˆ‘ç¦»å¼€äº†\u0026hellip;\u0026hellip;æˆ‘å¤šåŠæ˜¯ä¸ªåº”è¯¥ç»§ç»­æ‹…ä»»é¦–å¸­æ‰§è¡Œå®˜æˆ–ç¦»å¼€çš„ä¸å¿«ä¹åˆ›å§‹äººã€‚â€\nDocker ä¸€åˆ†ä¸ºäºŒ é¢å¯¹æ—¥ç›Šä¸¥é‡çš„èµ„é‡‘é—®é¢˜ï¼ŒDocker è½®æ¢äº†æ–°ä»» CEOï¼ŒGolub äº 2017 å¹´ 5 æœˆè®©ä½ç»™å‰ SAP æ‰§è¡Œå®˜ Steve Singhï¼Œç„¶å Singh äº 2019 å¹´ 6 æœˆè®©ä½ç»™å‰ Hortonworks é¦–å¸­æ‰§è¡Œå®˜ Rob Beardenã€‚\næœ€ç»ˆè¦æ¥å—æ‰¹è¯„çš„æ˜¯ Beardenã€‚ä¸Šä»»åä¸ä¹…ï¼ŒDocker äº 2019 å¹´ 11 æœˆå°†å…¶ä¼ä¸šéƒ¨åˆ†ä¸šåŠ¡å‡ºå”®ç»™ Mirantisï¼ŒDocker Enterprise å¹¶å…¥ Mirantis Kubernetes Engineã€‚\nBearden å½“æ—¶åœ¨ä¸€ä»½æ–°é—»ç¨¿ä¸­è¯´ï¼šâ€œåœ¨ä¸ç®¡ç†å›¢é˜Ÿå’Œè‘£äº‹ä¼šè¿›è¡Œå½»åº•åˆ†æåï¼Œæˆ‘ä»¬ç¡®å®š Docker æœ‰ä¸¤ä¸ªæˆªç„¶ä¸åŒçš„ä¸šåŠ¡ï¼šä¸€ä¸ªæ˜¯æ´»è·ƒçš„å¼€å‘è€…ä¸šåŠ¡ï¼Œå¦ä¸€ä¸ªæ˜¯æˆé•¿ä¸­çš„ä¼ä¸šä¸šåŠ¡ã€‚æˆ‘ä»¬è¿˜å‘ç°äº§å“å’Œè´¢åŠ¡æ¨¡å‹å¤§ä¸ç›¸åŒã€‚â€\nDocker å¦‚ä»Šåœ¨å“ªé‡Œï¼Ÿ æœ‰äº†åŸå§‹æŠ•èµ„è€… Insight Venture Partners å’Œ Benchmark Capital çš„ 3500 ä¸‡ç¾å…ƒç°é‡‘æ³¨å…¥ï¼Œå‰©ä¸‹çš„ Docker ç”±åŸå§‹ Docker Engine å®¹å™¨è¿è¡Œæ—¶ã€Docker Hub é•œåƒå­˜å‚¨åº“å’Œ Docker æ¡Œé¢åº”ç”¨ç¨‹åºæ”¯æ’‘ï¼Œåœ¨ 7 å¹´å…¬å¸èµ„æ·±äººå£« Scott Johnston çš„é¢†å¯¼ä¸‹æ´»äº†ä¸‹æ¥ã€‚\nJohnston å‘Šè¯‰ InfoWorldï¼Œä»–æ­£è¯•å›¾é€šè¿‡â€œåƒæ¿€å…‰ä¸€æ ·é‡æ–°å…³æ³¨å¼€å‘äººå‘˜çš„éœ€æ±‚â€ï¼Œè®©å…¬å¸å›å½’æœ¬æºã€‚â€œæˆ‘ä»¬è®¤ä¸ºè¯¥å…¬å¸æ¯”ä»¥å¾€ä»»ä½•æ—¶å€™éƒ½æ›´å¼ºå¤§ï¼Œå› ä¸ºä¸‰ç‚¹ï¼šä»¥å®¢æˆ·ä¸ºä¸­å¿ƒã€ç»Ÿä¸€çš„å¸‚åœºå®šä½å’Œç”Ÿæ€ç³»ç»Ÿå‹å¥½çš„å•†ä¸šæ¨¡å¼ã€‚â€\nä¸Šå‘¨ Docker å®£å¸ƒæ›´æ”¹ Docker è½¯ä»¶çš„è®¸å¯æ¡æ¬¾ã€‚å¾ˆå¿«ï¼Œä¸ºå¤§å…¬å¸å·¥ä½œçš„ Docker Desktop ä¸“ä¸šç”¨æˆ·å°†ä¸å¾—ä¸æ³¨å†Œä»˜è´¹è®¢é˜…æ‰èƒ½ç»§ç»­ä½¿ç”¨è¯¥åº”ç”¨ç¨‹åºã€‚\nJohnston å†³å¿ƒä¸é‡è¹ˆè¦†è¾™ï¼Œä¸“æ³¨äºä¸ºå…¬å¸çš„æ ¸å¿ƒè½¯ä»¶å¼€å‘äººå‘˜å—ä¼—æä¾›ä»·å€¼ã€‚ä»–è¯´ï¼šâ€œæˆ‘ä»¬çš„é‡å¿ƒæ›´å¤§ï¼Œå› ä¸ºå¼€å‘äººå‘˜ç”Ÿæ€ç³»ç»Ÿè¦é¢å‘çš„æ˜¯ä¸–ç•Œä¸Šçš„æ¯ä¸ªå¼€å‘äººå‘˜ï¼Œè€Œä¸ä»…ä»…æ˜¯é‚£äº›ä¸æˆ‘ä»¬çš„è¿è¡Œæ—¶ä¸€è‡´çš„å¼€å‘äººå‘˜ã€‚â€\nJohnston è®¤ä¸ºâ€œDocker 2.0â€çš„å¢é•¿æœºä¼šåœ¨äºä¸ºå®‰å…¨ã€å·²éªŒè¯çš„é•œåƒæ„å»ºæ–°çš„å¼€å‘äººå‘˜å·¥å…·å’Œå¯ä¿¡å†…å®¹ï¼Œä»¥åŠæ–°å…´è®¡ç®—æ¨¡å‹ï¼ˆå¦‚æ— æœåŠ¡å™¨ã€æœºå™¨å­¦ä¹ å’Œç‰©è”ç½‘ ä»¥å®¹å™¨æŠ€æœ¯ä¸ºåŸºç¡€çš„å·¥ä½œè´Ÿè½½ï¼‰èƒŒåçš„æŒç»­åŠ¨åŠ›ã€‚\nåŒæ—¶ï¼ŒDocker ä»ç„¶æ˜¯è¡Œä¸šæ ‡å‡†çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå¦‚ä»Š Docker Desktop å®‰è£…åœ¨ 330 ä¸‡å°æœºå™¨ä¸Šã€‚æ­¤å¤–ï¼Œåœ¨ Stack Overflow çš„ 2021 å¹´å¼€å‘è€…è°ƒæŸ¥ä¸­ï¼Œ49% çš„å—è®¿è€…è¡¨ç¤ºä»–ä»¬ç»å¸¸ä½¿ç”¨è¯¥å·¥å…·ã€‚\nå°½ç®¡å¦‚æ­¤ï¼Œäººä»¬ä»ç„¶å¯¹å¯èƒ½å‘ç”Ÿçš„äº‹æƒ…æ·±æ„Ÿå¤±æœ›ã€‚Stinemates è¯´ï¼šâ€œå¦‚æœæˆ‘æƒ³è¦è½»ç‡ï¼Œæˆ‘ä¼šé—®ä»Šå¤© Docker æ˜¯å¦å­˜åœ¨ã€‚ä»èŒä¸šè§’åº¦æ¥çœ‹ï¼Œè¿™å¾ˆå¯æ‚²ã€‚æˆ‘ä»åœ¨å¯»æ‰¾ä¸€å®¶åƒ Docker ä¸€æ ·ä»¤äººå…´å¥‹å’Œå……æ»¡æ´»åŠ›çš„å…¬å¸ï¼Œå¹¶èƒ½åˆ›é€ å‡ºç«èŠ±ã€‚â€\nHykes è¯´ï¼šâ€œå¯ä»¥å…¬å¹³åœ°è¯´ï¼ŒDocker æœªèƒ½å®ç°å…¶å•†ä¸šåŒ–çš„æ½œåŠ›â€¦â€¦åˆ°ç›®å‰ä¸ºæ­¢ã€‚æˆ‘å¾ˆé«˜å…´ Docker åœ¨è¿™ä¹ˆå¤šå¹´ä¹‹åæœ‰å†æ¬¡æœ‰å®ç°å•†ä¸šåŒ–çš„æœºä¼šã€‚è¿™æ˜¯å¯¹åŸºç¡€é¡¹ç›®å’Œå“ç‰Œçš„è¯æ˜ã€‚â€\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/how-docker-broke-in-half/","tags":["OpenSource","Docker"],"title":"å®¹å™¨ç¥è¯ Docker æ˜¯å¦‚ä½•ä¸€åˆ†ä¸ºäºŒçš„"},{"categories":["ç¬”è®°"],"contents":"ä¸ºä»€ä¹ˆè¦åœ¨ arm64 å¹³å°ä¸Šéƒ¨ç½² Kubernetesï¼Œè€Œä¸”è¿˜æ˜¯é²²é¹ 920 çš„æ¶æ„ã€‚è¯´æ¥è¯é•¿ ã€‚ã€‚ã€‚ æ­¤å¤„çœç•¥5000 å­—ã€‚\nä»‹ç»ä¸‹ç³»ç»Ÿä¿¡æ¯ï¼›\næ¶æ„ï¼šé²²é¹ 920(Kunpeng920) OSï¼šopenEuler 20.03 (LTS-SP1) CPUï¼š4c å†…å­˜ï¼š16G ç¡¬ç›˜ï¼šè‹¥å¹² æ•´ä¸ªè¿‡ç¨‹è™½ç„¶å‚è€ƒäº†é²²é¹è®ºå›çš„å¸–å­ï¼Œä¸è¿‡è¿˜æ˜¯é¢‡è´¹å‘¨æŠ˜ã€‚\nTL;DR æ•´ä¸ªè¿‡ç¨‹ä¸­è¦æ³¨æ„ arm64 å¹³å°ä¸Šå®‰è£… Kubernetes åŠç½‘ç»œç»„ä»¶ï¼Œéœ€è¦ä½¿ç”¨ arm64 ç‰ˆæœ¬çš„é•œåƒã€‚\nç¯å¢ƒé…ç½® 1.å…³é—­ selinux #ä¸´æ—¶å…³é—­ setenforce 0 #æ°¸ä¹…å…³é—­ SELINUX=disabled vim /etc/sysconfig/selinux 2. å…³é—­swapåˆ†åŒº #ä¸´æ—¶å…³é—­ swapoff -a #æ°¸ä¹…å…³é—­ æ³¨é‡Š swap è¡Œ vim /etc/fstab 3. å…³é—­é˜²ç«å¢™ systemctl stop firewalld ssystemctl disable firewalld 4. ç½‘ç»œé…ç½® å¯¹iptableså†…éƒ¨çš„nf-calléœ€è¦æ‰“å¼€çš„å†…ç”Ÿçš„æ¡¥æ¥åŠŸèƒ½\nvim /etc/sysctl.d/k8s.conf ä¿®æ”¹å¦‚ä¸‹å†…å®¹ï¼š\nnet.bridge.bridge-nf-call-iptables=1 net.bridge.bridge-nf-call-ip6tables=1 net.ipv4.ip_forward=1 vm_swappiness=0 ä¿®æ”¹å®Œæˆåæ‰§è¡Œï¼š\nmodprobe br_netfilter sysctl -p /etc/sysctl.d/k8s.conf 5. æ·»åŠ  Kubernetes æº åœ¨æ–‡ä»¶ /etc/yum.repos.d/openEuler.repo ä¸­è¿½åŠ å¦‚ä¸‹å†…å®¹ï¼š\n[kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-aarch64/ enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg å®‰è£…é…ç½® iSula yum install -y iSulad ä¿®æ”¹ iSula é…ç½®ï¼Œæ‰“å¼€æ–‡ä»¶ /etc/isulad/daemon.jsonï¼ŒæŒ‰ç…§ä¸‹é¢çš„éƒ¨åˆ†ï¼š\n{ \u0026#34;registry-mirrors\u0026#34;: [ \u0026#34;docker.io\u0026#34; ], \u0026#34;insecure-registries\u0026#34;: [ \u0026#34;rnd-dockerhub.huawei.com\u0026#34; ], \u0026#34;pod-sandbox-image\u0026#34;: \u0026#34;k8s.gcr.io/pause:3.2\u0026#34;, // æŒ‰ç…§å¯¹åº” Kubernetes ç‰ˆæœ¬è¿›è¡Œä¿®æ”¹ï¼Œåé¢ä¼šæœ‰è¯´æ˜ \u0026#34;network-plugin\u0026#34;: \u0026#34;cni\u0026#34;, \u0026#34;cni-bin-dir\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;cni-conf-dir\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;hosts\u0026#34;: [ \u0026#34;unix:///var/run/isulad.sock\u0026#34; ] } ä¿®æ”¹ä¹‹åé‡å¯ isulad\nsystemctl restart isulad systemctl enable isulad Kubernetes éƒ¨ç½² 1. å®‰è£… kubeletã€kubeadmã€kubectl yum install -y kubelet-1.20.0 kubeadm-1.20.0 kubectl-1.20.0 2. å‡†å¤‡é•œåƒ ç”±äºæŸç§æœªçŸ¥çš„ç½‘ç»œé—®æï¼Œä¼šå¯¼è‡´æ‹‰å– k8s.gcr.io çš„é•œåƒå¤±è´¥ã€‚éœ€è¦æå‰ä¸‹è½½å¥½ã€‚\né€šè¿‡ kubeadm config images list --kubernetes-version 1.20.0 å‘½ä»¤ï¼Œè·å–åˆå§‹åŒ–æ‰€éœ€çš„é•œåƒã€‚è¿™é‡Œéœ€è¦æ³¨æ„é€šè¿‡ --kubernetes-version å‚æ•°æŒ‡å®šç‰ˆæœ¬å·ï¼Œå¦åˆ™ kubeadm æ˜¯æ‰“å°å‡ºæœ€é«˜çš„ 1.20.x ç‰ˆæœ¬çš„åˆå§‹åŒ–é•œåƒï¼ˆæ¯”å¦‚ï¼Œ1.20.x çš„æœ€é«˜ç‰ˆæœ¬æ˜¯ 1.20.4ï¼‰ã€‚\nk8s.gcr.io/kube-apiserver:v1.20.0 k8s.gcr.io/kube-controller-manager:v1.20.0 k8s.gcr.io/kube-scheduler:v1.20.0 k8s.gcr.io/kube-proxy:v1.20.0 k8s.gcr.io/pause:3.2 k8s.gcr.io/etcd:3.4.13-0 k8s.gcr.io/coredns:1.7. å¯¹åº”çš„ arm64 ç‰ˆæœ¬é•œåƒä¸ºï¼š\nk8s.gcr.io/kube-apiserver-arm64:v1.20.0 k8s.gcr.io/kube-controller-manager-arm64:v1.20.0 k8s.gcr.io/kube-scheduler-arm64:v1.20.0 k8s.gcr.io/kube-proxy-arm64:v1.20.0 k8s.gcr.io/pause-arm64:3.2 k8s.gcr.io/etcd-arm64:3.4.2-0 #æ”¯æŒ arm64 çš„ 3.4.x çš„æœ€é«˜ç‰ˆæœ¬ k8s.gcr.io/coredns:1.7.0 #æ— éœ€ç‰¹åˆ«çš„ arm64 ç‰ˆæœ¬ å‡­â€œè¿æ°”â€ä¸‹è½½å¥½é•œåƒåï¼Œå†é€šè¿‡ isula tag å‘½ä»¤ä¿®æ”¹æˆæˆ‘ä»¬éœ€è¦çš„ï¼š\nisula tag k8s.gcr.io/kube-apiserver-arm64:v1.20.0 k8s.gcr.io/kube-apiserver:v1.20.0 isula tag k8s.gcr.io/kube-controller-manager-arm64:v1.20.0 k8s.gcr.io/kube-controller-manager:v1.20.0 isula tag k8s.gcr.io/kube-scheduler-arm64:v1.20.0 k8s.gcr.io/kube-scheduler:v1.20.0 isula tag k8s.gcr.io/kube-proxy-arm64:v1.20.0 k8s.gcr.io/kube-proxy:v1.20.0 isula tag k8s.gcr.io/pause-arm64:3.2 k8s.gcr.io/pause:3.2 isula tag k8s.gcr.io/etcd-arm64:3.4.2-0 k8s.gcr.io/etcd:3.4.13-0 isula tag k8s.gcr.io/coredns:1.7.0 k8s.gcr.io/coredns:1.7.0 3. åˆå§‹åŒ– master èŠ‚ç‚¹ æ³¨æ„éœ€è¦æŒ‡å®š --cri-socket å‚æ•°ä½¿ç”¨ isulad çš„ APIã€‚\nkubeadm init --kubernetes-version v1.20.0 --cri-socket=/var/run/isulad.sock --pod-network-cidr=10.244.0.0/16 å®‰è£…æˆåŠŸçš„è¯ï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹çš„å†…å®¹\nYour Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Alternatively, if you are the root user, you can run: export KUBECONFIG=/etc/kubernetes/admin.conf You should now deploy a pod network to the cluster. Run \u0026#34;kubectl apply -f [podnetwork].yaml\u0026#34; with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ Then you can join any number of worker nodes by running the following on each as root: kubeadm join 12.0.0.9:6443 --token 0110xl.lqzlegbduz2qkdhr \\ --discovery-token-ca-cert-hash sha256:42b13f5924a01128aac0d6e7b2487af990bc82701f233c8a6a4790187ea064af 4. é…ç½®é›†ç¾¤ç¯å¢ƒ ç„¶åæ ¹æ®ä¸Šé¢çš„è¾“å‡ºè¿›è¡Œé…ç½®\nmkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config export KUBECONFIG=/etc/kubernetes/admin.conf 5. å‘é›†ç¾¤æ·»åŠ  Node èŠ‚ç‚¹ é‡å¤å‰é¢çš„æ­¥éª¤ï¼šç¯å¢ƒé…ç½®ã€å®‰è£…é…ç½® iSula ä»¥åŠ Kubernetes éƒ¨ç½² çš„ 1 å’Œ 2ã€‚\nåŒæ ·ä½¿ç”¨ä¸Šé¢è¾“å‡ºçš„å‘½ä»¤ï¼Œå†åŠ ä¸Š --cri-socket å‚æ•°ï¼š\nkubeadm join 12.0.0.9:6443 --token 0110xl.lqzlegbduz2qkdhr \\ --discovery-token-ca-cert-hash \\ --cri-socket=/var/run/isulad.sock é…ç½®ç½‘ç»œæ’ä»¶ å®Œæˆ master èŠ‚ç‚¹åˆå§‹åŒ–å¹¶é…ç½®å®Œé›†ç¾¤ç¯å¢ƒåå°±å¯ä»¥æ‰§è¡Œ kubectl çš„å‘½ä»¤äº†ã€‚\nkubectl get nodes NAME STATUS ROLES AGE VERSION host-12-0-0-9 NotReady control-plane,master 178m v1.20.0 çœ‹ä¸‹èŠ‚ç‚¹ï¼Œå‘ç°èŠ‚ç‚¹æ˜¯ NotReady çš„çŠ¶æ€ï¼Œè¿™æ˜¯å› ä¸ºç½‘ç»œæ’ä»¶è¿˜æ²¡å®‰è£…ã€‚å¦‚æœæ­¤æ—¶é€šè¿‡å‘½ä»¤ journalctl -uf kubelet æŸ¥çœ‹ kubelet çš„æ—¥å¿—ï¼Œä¼šçœ‹åˆ°æ—¥å¿—æç¤ºç½‘ç»œæ’ä»¶æ²¡æœ‰ readyã€‚\nkubelet.go:2160] Container runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:iSulad: network plugin is not ready: cni config uninitialized è¿˜è®°å¾— isulad çš„é…ç½®ä¹ˆï¼Ÿ\n\u0026#34;network-plugin\u0026#34;: \u0026#34;cni\u0026#34;, \u0026#34;cni-bin-dir\u0026#34;: \u0026#34;\u0026#34;, //ä½¿ç”¨é»˜è®¤ /opt/cni/bin \u0026#34;cni-conf-dir\u0026#34;: \u0026#34;\u0026#34;, //ä½¿ç”¨é»˜è®¤ /etc/cni/net.d å®é™…ä¸Šä¸¤ä¸ªç›®å½•éƒ½æ˜¯ç©ºçš„å†…å®¹ï¼Œå¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºï¼š\nmkdir -p /opt/cni/bin mkdir -p /etc/cni/net.d è¿™é‡Œä½¿ç”¨ calico åšä¸ºç½‘ç»œæ’ä»¶ï¼Œå…ˆä¸‹è½½ manifestã€‚\nwget https://docs.projectcalico.org/v3.14/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml å› ä¸ºæ˜¯ arm64 çš„ç¡¬ä»¶ï¼ŒåŒæ ·éœ€è¦ä½¿ç”¨å¯¹åº” arm64 ç‰ˆæœ¬çš„é•œåƒï¼Œå…ˆæŸ¥çœ‹è¦ç”¨å“ªäº›é•œåƒï¼š\ngrep \u0026#39;image:\u0026#39; calico.yaml | uniq image: calico/cni:v3.14.2 image: calico/pod2daemon-flexvol:v3.14.2 image: calico/node:v3.14.2 image: calico/kube-controllers:v3.14.2 å¯¹åº”çš„ arm64 ç‰ˆæœ¬ï¼Œæ“ä½œæ­¥éª¤å‚è€ƒä¸Šé¢ï¼Œä¸å†èµ˜è¿°ã€‚\ncalico/cni:v3.14.2-arm64 calico/pod2daemon-flexvol:v3.14.2-arm64 calico/node:v3.14.2-arm64 calico/kube-controllers:v3.14.2-arm64 æå®šé•œåƒä¹‹åæ‰§è¡Œï¼š\nkubectl apply -f calico.yaml ä¹‹åå°±å¯ä»¥çœ‹åˆ°èŠ‚ç‚¹å˜æˆäº† Ready çŠ¶æ€ã€‚\næµ‹è¯• é€šå¸¸éƒ½æ˜¯ç”¨ nginx çš„é•œåƒåˆ›å»º pod è¿›è¡Œæµ‹è¯•ï¼Œä½†æ˜¯ nginx å¹¶æ²¡æœ‰ arm64 çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œå°±ç”¨ docker å®˜æ–¹æä¾›çš„ hello-world é•œåƒã€‚æ²¡é”™ï¼Œæ”¯æŒ arm64ã€‚\nkubectl run hello-world --image hello-world:latest --restart=Never kubectl logs hello-world --previous å¯ä»¥çœ‹åˆ°\nHello from Docker! This message shows that your installation appears to be working correctly. To generate this message, Docker took the following steps: 1. The Docker client contacted the Docker daemon. 2. The Docker daemon pulled the \u0026#34;hello-world\u0026#34; image from the Docker Hub. (arm64v8) 3. The Docker daemon created a new container from that image which runs the executable that produces the output you are currently reading. 4. The Docker daemon streamed that output to the Docker client, which sent it to your terminal. To try something more ambitious, you can run an Ubuntu container with: $ docker run -it ubuntu bash Share images, automate workflows, and more with a free Docker ID: https://hub.docker.com/ For more examples and ideas, visit: https://docs.docker.com/get-started/ æ€»ç»“ è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†åœ¨é²²é¹å¹³å°ä¸ŠåŸºäº openEuler + iSula éƒ¨ç½² Kubernetes çš„å·¥ä½œã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/setup-kubernetes-running-with-isulad-on-openeuler/","tags":["Kubernetes","Linux"],"title":"ARM64 å¹³å°åŸºäº openEuler + iSula ç¯å¢ƒéƒ¨ç½² Kubernetes"},{"categories":["äº‘åŸç”Ÿ"],"contents":"å†™åœ¨æœ€å‰ å’Œä¸Šä¸€ç¯‡ã€Šä½¿ç”¨ Flomesh å¼ºåŒ– Spring Cloud æœåŠ¡æ²»ç†ã€‹ä¸€æ ·ï¼Œè¿™æ¬¡åŒæ ·æ˜¯åœ¨æ— ä»£ç ä¾µå…¥çš„æƒ…å†µä¸‹å¯¹ Dubbo æœåŠ¡æ²»ç†çš„æå‡ã€‚\næ›´å¤šæ²»ç†åœºæ™¯é™†ç»­æ·»åŠ ä¸­ï¼Œæœ‰å…´è¶£çš„å¯å…³æ³¨ https://github.com/flomesh-io/service-mesh-dubbo-demoã€‚\nå¼€æºçš„ Pipy ä½œä¸º Flomesh çš„æ ¸å¿ƒï¼Œå¾—ç›Šäºå…¶è½»é‡åŠçµæ´»æ€§å¯ä»¥é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼è½»æ¾å¿«é€Ÿçš„æ”¯æŒå¤šä¸­å¹³å°çš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œæ¯”å¦‚ Eurekaã€Consulã€Nacos ç­‰ã€‚\næ¦‚è§ˆ ç»†èŠ‚ ç¯å¢ƒæ­å»º æ­å»º Kubernetes ç¯å¢ƒï¼Œå¯ä»¥é€‰æ‹© kubeadm è¿›è¡Œé›†ç¾¤æ­å»ºã€‚ä¹Ÿå¯ä»¥é€‰æ‹© minikubeã€k3sã€Kind ç­‰ï¼Œæœ¬æ–‡ä½¿ç”¨ k3sã€‚\nä½¿ç”¨ k3d å®‰è£… k3sã€‚k3d å°†åœ¨ Docker å®¹å™¨ä¸­è¿è¡Œ k3sï¼Œå› æ­¤éœ€è¦ä¿è¯å·²ç»å®‰è£…äº† Dockerã€‚\n$ k3d cluster create dubbo-demo -p \u0026#34;80:80@loadbalancer\u0026#34; --k3s-server-arg \u0026#39;--no-deploy=traefik\u0026#39; å®‰è£… Flomesh ä»ä»“åº“ https://github.com/flomesh-io/service-mesh-dubbo-demo å…‹éš†ä»£ç ã€‚è¿›å…¥åˆ° releaseç›®å½•ã€‚\næ‰€æœ‰ Flomesh ç»„ä»¶ä»¥åŠç”¨äº demo çš„ yamls æ–‡ä»¶éƒ½ä½äºè¿™ä¸ªç›®å½•ä¸­ã€‚\n$ kubectl apply -f artifacts/cert-manager-v1.3.1.yaml customresourcedefinition.apiextensions.k8s.io/certificaterequests.cert-manager.io created customresourcedefinition.apiextensions.k8s.io/certificates.cert-manager.io created customresourcedefinition.apiextensions.k8s.io/challenges.acme.cert-manager.io created customresourcedefinition.apiextensions.k8s.io/clusterissuers.cert-manager.io created customresourcedefinition.apiextensions.k8s.io/issuers.cert-manager.io created customresourcedefinition.apiextensions.k8s.io/orders.acme.cert-manager.io created namespace/cert-manager created serviceaccount/cert-manager-cainjector created serviceaccount/cert-manager created serviceaccount/cert-manager-webhook created clusterrole.rbac.authorization.k8s.io/cert-manager-cainjector created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-issuers created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-clusterissuers created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-certificates created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-orders created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-challenges created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-ingress-shim created clusterrole.rbac.authorization.k8s.io/cert-manager-view created clusterrole.rbac.authorization.k8s.io/cert-manager-edit created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-approve:cert-manager-io created clusterrole.rbac.authorization.k8s.io/cert-manager-webhook:subjectaccessreviews created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-cainjector created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-issuers created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-clusterissuers created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-certificates created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-orders created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-challenges created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-ingress-shim created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-approve:cert-manager-io created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-webhook:subjectaccessreviews created role.rbac.authorization.k8s.io/cert-manager-cainjector:leaderelection created role.rbac.authorization.k8s.io/cert-manager:leaderelection created role.rbac.authorization.k8s.io/cert-manager-webhook:dynamic-serving created rolebinding.rbac.authorization.k8s.io/cert-manager-cainjector:leaderelection created rolebinding.rbac.authorization.k8s.io/cert-manager:leaderelection created rolebinding.rbac.authorization.k8s.io/cert-manager-webhook:dynamic-serving created service/cert-manager created service/cert-manager-webhook created deployment.apps/cert-manager-cainjector created deployment.apps/cert-manager created deployment.apps/cert-manager-webhook created mutatingwebhookconfiguration.admissionregistration.k8s.io/cert-manager-webhook created validatingwebhookconfiguration.admissionregistration.k8s.io/cert-manager-webhook created æ³¨æ„: è¦ä¿è¯ cert-manager å‘½åç©ºé—´ä¸­æ‰€æœ‰çš„ pod éƒ½æ­£å¸¸è¿è¡Œï¼š\n$ kubectl get pod -n cert-manager NAME READY STATUS RESTARTS AGE cert-manager-cainjector-59f76f7fff-ggmdm 1/1 Running 0 32s cert-manager-59f6c76f4b-r2h5r 1/1 Running 0 32s cert-manager-webhook-56fdcbb848-sdnxb 1/1 Running 0 32s å®‰è£… Pipy Operator $ kubectl apply -f artifacts/pipy-operator.yaml æ‰§è¡Œå®Œå‘½ä»¤åä¼šçœ‹åˆ°ç±»ä¼¼çš„ç»“æœï¼š\nnamespace/flomesh created customresourcedefinition.apiextensions.k8s.io/proxies.flomesh.io created customresourcedefinition.apiextensions.k8s.io/proxyprofiles.flomesh.io created serviceaccount/operator-manager created role.rbac.authorization.k8s.io/leader-election-role created clusterrole.rbac.authorization.k8s.io/manager-role created clusterrole.rbac.authorization.k8s.io/metrics-reader created clusterrole.rbac.authorization.k8s.io/proxy-role created rolebinding.rbac.authorization.k8s.io/leader-election-rolebinding created clusterrolebinding.rbac.authorization.k8s.io/manager-rolebinding created clusterrolebinding.rbac.authorization.k8s.io/proxy-rolebinding created configmap/manager-config created service/operator-manager-metrics-service created service/proxy-injector-svc created service/webhook-service created deployment.apps/operator-manager created deployment.apps/proxy-injector created certificate.cert-manager.io/serving-cert created issuer.cert-manager.io/selfsigned-issuer created mutatingwebhookconfiguration.admissionregistration.k8s.io/mutating-webhook-configuration created mutatingwebhookconfiguration.admissionregistration.k8s.io/proxy-injector-webhook-cfg created validatingwebhookconfiguration.admissionregistration.k8s.io/validating-webhook-configuration created æ³¨æ„ï¼šè¦ä¿è¯ flomesh å‘½åç©ºé—´ä¸­æ‰€æœ‰çš„ pod éƒ½æ­£å¸¸è¿è¡Œï¼š\n$ kubectl get pod -n flomesh NAME READY STATUS RESTARTS AGE proxy-injector-6d5c774bc-rspmc 1/1 Running 0 21s operator-manager-c95cd449-xxc77 0/1 Running 0 38s å®‰è£… Ingress æ§åˆ¶å™¨ï¼šingress-pipy $ kubectl apply -f artifacts/ingress-pipy.yaml namespace/ingress-pipy created customresourcedefinition.apiextensions.k8s.io/ingressglobalhooks.flomesh.io created customresourcedefinition.apiextensions.k8s.io/ingressrules.flomesh.io created serviceaccount/ingress-pipy created role.rbac.authorization.k8s.io/ingress-pipy-leader-election-role created clusterrole.rbac.authorization.k8s.io/ingress-pipy-role created rolebinding.rbac.authorization.k8s.io/ingress-pipy-leader-election-rolebinding created clusterrolebinding.rbac.authorization.k8s.io/ingress-pipy-rolebinding created configmap/ingress-config created service/ingress-pipy-cfg created service/ingress-pipy-controller created service/ingress-pipy-defaultbackend created service/webhook-service created deployment.apps/ingress-pipy-cfg created deployment.apps/ingress-pipy-controller created deployment.apps/ingress-pipy-manager created certificate.cert-manager.io/serving-cert created issuer.cert-manager.io/selfsigned-issuer created mutatingwebhookconfiguration.admissionregistration.k8s.io/mutating-webhook-configuration configured validatingwebhookconfiguration.admissionregistration.k8s.io/validating-webhook-configuration configured æ£€æŸ¥ ingress-pipy å‘½åç©ºé—´ä¸‹ pod çš„çŠ¶æ€ï¼š\n$ kubectl get pod -n ingress-pipy NAME READY STATUS RESTARTS AGE svclb-ingress-pipy-controller-qwbk9 1/1 Running 0 90s ingress-pipy-cfg-6c54d5b9b6-6s7lz 1/1 Running 0 90s ingress-pipy-manager-7988dfbf4f-lxr4b 1/1 Running 0 90s ingress-pipy-controller-9d4698887-zrpfd 1/1 Running 0 90s è‡³æ­¤ï¼Œä½ å·²ç»æˆåŠŸå®‰è£… Flomesh çš„æ‰€æœ‰ç»„ä»¶ï¼ŒåŒ…æ‹¬ operator å’Œ ingress æ§åˆ¶å™¨ã€‚\nè¿è¡Œ Demo åˆ›å»ºå‘½åç©ºé—´ Demo è¿è¡Œåœ¨å¦ä¸€ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ flomesh-dubbo ä¸­ï¼Œæ‰§è¡Œå‘½ä»¤ kubectl apply -f dubbo-mesh/templates/namespace.yaml æ¥åˆ›å»ºè¯¥å‘½åç©ºé—´ã€‚å¦‚æœä½  describe è¯¥å‘½åç©ºé—´ä½ ä¼šå‘ç°å…¶ä½¿ç”¨äº† flomesh.io/inject=true æ ‡ç­¾ã€‚\nè¿™ä¸ªæ ‡ç­¾å‘ŠçŸ¥ operator çš„ admission webHook æ‹¦æˆªæ ‡æ³¨çš„å‘½åç©ºé—´ä¸‹ pod çš„åˆ›å»ºã€‚\n$ kubectl describe ns flomesh-dubbo Name: flomesh-dubbo Labels: app.kubernetes.io/managed-by=Helm app.kubernetes.io/name=dubbo-mesh app.kubernetes.io/version=1.19.0 flomesh.io/inject=true helm.sh/chart=dubbo-mesh-0.1.0 kubernetes.io/metadata.name=flomesh-dubbo Annotations: \u0026lt;none\u0026gt; Status: Active No resource quota. No LimitRange resource. åˆ›å»º ProxyProfile èµ„æº $ kubectl apply -f artifacts/proxy-profile.yaml proxyprofile.flomesh.io/poc-pf-dubbo created proxyprofile.flomesh.io/poc-pf-http created åˆ›å»º mock æœåŠ¡ $ kubectl apply -f dubbo-mesh/templates/configmap-mock.yaml $ kubectl apply -f dubbo-mesh/templates/configmap-proxychains.yaml $ kubectl apply -f dubbo-mesh/templates/deployment-mock.yaml $ kubectl apply -f dubbo-mesh/templates/service-mock.yaml éƒ¨ç½²æœåŠ¡ $ kubectl apply -f artifacts/deployment.yaml æµ‹è¯• å‡†å¤‡ è®¿é—® demo æœåŠ¡éƒ½è¦é€šè¿‡ ingress æ§åˆ¶å™¨ã€‚å› æ­¤éœ€è¦å…ˆè·å– LB çš„ ip åœ°å€ã€‚\n//Obtain the controller IP //Here, we append port. ingressAddr=`kubectl get svc ingress-pipy-controller -n ingress-pipy -o jsonpath=\u0026#39;{.spec.clusterIP}\u0026#39;`:80 è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†æ˜¯ k3d åˆ›å»ºçš„ k3sï¼Œå‘½ä»¤ä¸­åŠ å…¥äº† -p 80:80@loadbalancer é€‰é¡¹ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ 127.0.0.1:80 æ¥è®¿é—® ingress æ§åˆ¶å™¨ã€‚è¿™é‡Œæ‰§è¡Œå‘½ä»¤ ingressAddr=127.0.0.1:80ã€‚\nIngress è§„åˆ™ä¸­ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªè§„åˆ™æŒ‡å®šäº† hostï¼Œå› æ­¤æ¯ä¸ªè¯·æ±‚ä¸­éœ€è¦é€šè¿‡ HTTP è¯·æ±‚å¤´ Host æä¾›å¯¹åº”çš„ hostã€‚\næˆ–è€…åœ¨ /etc/hosts æ·»åŠ è®°å½•ï¼š\n$ kubectl get ing ingress-canary-router -n flomesh-dubbo -o jsonpath=\u0026#34;{range .spec.rules[*]}{.host}{\u0026#39;\\n\u0026#39;}\u0026#34; dubbo.demo.flomesh.cn //æ·»åŠ è®°å½•åˆ° /etc/hosts 127.0.0.1 dubbo.demo.flomesh.cn ç°åº¦ v1ã€v2 æœåŠ¡åªèƒ½è®¿é—®å¯¹åº”ç‰ˆæœ¬çš„æœåŠ¡ã€‚\n$ curl --location --request POST \u0026#39;http://127.0.0.1:80/hello\u0026#39; \\ --header \u0026#39;Host: dubbo.demo.flomesh.cn\u0026#39; \\ --header \u0026#39;x-canary-version: v1\u0026#39; \\ --header \u0026#39;Content-Type: application/json\u0026#39; \\ --data-raw \u0026#39;{\u0026#34;name\u0026#34;:\u0026#34;Flomesh\u0026#34;}\u0026#39; V1-[hello-service] : Hello, Flomesh, Today is (2021-08-17), Time is (04:06:56.823) $ curl --location --request POST \u0026#39;http://127.0.0.1:80/hello\u0026#39; \\ --header \u0026#39;Host: dubbo.demo.flomesh.cn\u0026#39; \\ --header \u0026#39;x-canary-version: v2\u0026#39; \\ --header \u0026#39;Content-Type: application/json\u0026#39; \\ --data-raw \u0026#39;{\u0026#34;name\u0026#34;:\u0026#34;Flomesh\u0026#34;}\u0026#39; V2-[hello-service] : Hello, Flomesh, Today is (Tue, 2021-Aug-17), Time is (04:06:37 +0000) ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/enhance-dubbo-service-governance-with-flomesh/","tags":["Pipy","Service Mesh","Kubernetes","Java"],"title":"ä½¿ç”¨ Flomesh è¿›è¡Œ Dubbo æœåŠ¡æ²»ç†"},{"categories":["äº‘åŸç”Ÿ"],"contents":"å†™åœ¨æœ€å‰ è¿™ç¯‡æ˜¯å…³äºå¦‚ä½•ä½¿ç”¨ Flomesh æœåŠ¡ç½‘æ ¼æ¥å¼ºåŒ– Spring Cloud çš„æœåŠ¡æ²»ç†èƒ½åŠ›ï¼Œé™ä½ Spring Cloud å¾®æœåŠ¡æ¶æ„è½åœ°æœåŠ¡ç½‘æ ¼çš„é—¨æ§›ï¼Œå®ç°â€œè‡ªä¸»å¯æ§â€ã€‚\næ–‡æ¡£åœ¨ github ä¸ŠæŒç»­æ›´æ–°ï¼Œæ¬¢è¿å¤§å®¶ä¸€èµ·è®¨è®ºï¼šhttps://github.com/flomesh-io/flomesh-bookinfo-demoã€‚\næ¶æ„ ç¯å¢ƒæ­å»º æ­å»º Kubernetes ç¯å¢ƒï¼Œå¯ä»¥é€‰æ‹© kubeadm è¿›è¡Œé›†ç¾¤æ­å»ºã€‚ä¹Ÿå¯ä»¥é€‰æ‹© minikubeã€k3sã€Kind ç­‰ï¼Œæœ¬æ–‡ä½¿ç”¨ k3sã€‚\nä½¿ç”¨ k3d å®‰è£… k3sã€‚k3d å°†åœ¨ Docker å®¹å™¨ä¸­è¿è¡Œ k3sï¼Œå› æ­¤éœ€è¦ä¿è¯å·²ç»å®‰è£…äº† Dockerã€‚\n$ k3d cluster create spring-demo -p \u0026#34;81:80@loadbalancer\u0026#34; --k3s-server-arg \u0026#39;--no-deploy=traefik\u0026#39; å®‰è£… Flomesh ä»ä»“åº“ https://github.com/flomesh-io/flomesh-bookinfo-demo.git å…‹éš†ä»£ç ã€‚è¿›å…¥åˆ° flomesh-bookinfo-demo/kubernetesç›®å½•ã€‚\næ‰€æœ‰ Flomesh ç»„ä»¶ä»¥åŠç”¨äº demo çš„ yamls æ–‡ä»¶éƒ½ä½äºè¿™ä¸ªç›®å½•ä¸­ã€‚\nå®‰è£… Cert Manager $ kubectl apply -f artifacts/cert-manager-v1.3.1.yaml customresourcedefinition.apiextensions.k8s.io/certificaterequests.cert-manager.io created customresourcedefinition.apiextensions.k8s.io/certificates.cert-manager.io created customresourcedefinition.apiextensions.k8s.io/challenges.acme.cert-manager.io created customresourcedefinition.apiextensions.k8s.io/clusterissuers.cert-manager.io created customresourcedefinition.apiextensions.k8s.io/issuers.cert-manager.io created customresourcedefinition.apiextensions.k8s.io/orders.acme.cert-manager.io created namespace/cert-manager created serviceaccount/cert-manager-cainjector created serviceaccount/cert-manager created serviceaccount/cert-manager-webhook created clusterrole.rbac.authorization.k8s.io/cert-manager-cainjector created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-issuers created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-clusterissuers created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-certificates created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-orders created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-challenges created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-ingress-shim created clusterrole.rbac.authorization.k8s.io/cert-manager-view created clusterrole.rbac.authorization.k8s.io/cert-manager-edit created clusterrole.rbac.authorization.k8s.io/cert-manager-controller-approve:cert-manager-io created clusterrole.rbac.authorization.k8s.io/cert-manager-webhook:subjectaccessreviews created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-cainjector created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-issuers created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-clusterissuers created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-certificates created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-orders created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-challenges created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-ingress-shim created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-approve:cert-manager-io created clusterrolebinding.rbac.authorization.k8s.io/cert-manager-webhook:subjectaccessreviews created role.rbac.authorization.k8s.io/cert-manager-cainjector:leaderelection created role.rbac.authorization.k8s.io/cert-manager:leaderelection created role.rbac.authorization.k8s.io/cert-manager-webhook:dynamic-serving created rolebinding.rbac.authorization.k8s.io/cert-manager-cainjector:leaderelection created rolebinding.rbac.authorization.k8s.io/cert-manager:leaderelection created rolebinding.rbac.authorization.k8s.io/cert-manager-webhook:dynamic-serving created service/cert-manager created service/cert-manager-webhook created deployment.apps/cert-manager-cainjector created deployment.apps/cert-manager created deployment.apps/cert-manager-webhook created mutatingwebhookconfiguration.admissionregistration.k8s.io/cert-manager-webhook created validatingwebhookconfiguration.admissionregistration.k8s.io/cert-manager-webhook created æ³¨æ„: è¦ä¿è¯ cert-manager å‘½åç©ºé—´ä¸­æ‰€æœ‰çš„ pod éƒ½æ­£å¸¸è¿è¡Œï¼š\n$ kubectl get pod -n cert-manager NAME READY STATUS RESTARTS AGE cert-manager-webhook-56fdcbb848-q7fn5 1/1 Running 0 98s cert-manager-59f6c76f4b-z5lgf 1/1 Running 0 98s cert-manager-cainjector-59f76f7fff-flrr7 1/1 Running 0 98s å®‰è£… Pipy Operator $ kubectl apply -f artifacts/pipy-operator.yaml æ‰§è¡Œå®Œå‘½ä»¤åä¼šçœ‹åˆ°ç±»ä¼¼çš„ç»“æœï¼š\nnamespace/flomesh created customresourcedefinition.apiextensions.k8s.io/proxies.flomesh.io created customresourcedefinition.apiextensions.k8s.io/proxyprofiles.flomesh.io created serviceaccount/operator-manager created role.rbac.authorization.k8s.io/leader-election-role created clusterrole.rbac.authorization.k8s.io/manager-role created clusterrole.rbac.authorization.k8s.io/metrics-reader created clusterrole.rbac.authorization.k8s.io/proxy-role created rolebinding.rbac.authorization.k8s.io/leader-election-rolebinding created clusterrolebinding.rbac.authorization.k8s.io/manager-rolebinding created clusterrolebinding.rbac.authorization.k8s.io/proxy-rolebinding created configmap/manager-config created service/operator-manager-metrics-service created service/proxy-injector-svc created service/webhook-service created deployment.apps/operator-manager created deployment.apps/proxy-injector created certificate.cert-manager.io/serving-cert created issuer.cert-manager.io/selfsigned-issuer created mutatingwebhookconfiguration.admissionregistration.k8s.io/mutating-webhook-configuration created mutatingwebhookconfiguration.admissionregistration.k8s.io/proxy-injector-webhook-cfg created validatingwebhookconfiguration.admissionregistration.k8s.io/validating-webhook-configuration created æ³¨æ„ï¼šè¦ä¿è¯ flomesh å‘½åç©ºé—´ä¸­æ‰€æœ‰çš„ pod éƒ½æ­£å¸¸è¿è¡Œï¼š\n$ kubectl get pod -n flomesh NAME READY STATUS RESTARTS AGE proxy-injector-5bccc96595-spl6h 1/1 Running 0 39s operator-manager-c78bf8d5f-wqgb4 1/1 Running 0 39s å®‰è£… Ingress æ§åˆ¶å™¨ï¼šingress-pipy $ kubectl apply -f ingress/ingress-pipy.yaml namespace/ingress-pipy created customresourcedefinition.apiextensions.k8s.io/ingressparameters.flomesh.io created serviceaccount/ingress-pipy created role.rbac.authorization.k8s.io/ingress-pipy-leader-election-role created clusterrole.rbac.authorization.k8s.io/ingress-pipy-role created rolebinding.rbac.authorization.k8s.io/ingress-pipy-leader-election-rolebinding created clusterrolebinding.rbac.authorization.k8s.io/ingress-pipy-rolebinding created configmap/ingress-config created service/ingress-pipy-cfg created service/ingress-pipy-controller created service/ingress-pipy-defaultbackend created service/webhook-service created deployment.apps/ingress-pipy-cfg created deployment.apps/ingress-pipy-controller created deployment.apps/ingress-pipy-manager created certificate.cert-manager.io/serving-cert created issuer.cert-manager.io/selfsigned-issuer created mutatingwebhookconfiguration.admissionregistration.k8s.io/mutating-webhook-configuration configured validatingwebhookconfiguration.admissionregistration.k8s.io/validating-webhook-configuration configured æ£€æŸ¥ ingress-pipy å‘½åç©ºé—´ä¸‹ pod çš„çŠ¶æ€ï¼š\n$ kubectl get pod -n ingress-pipy NAME READY STATUS RESTARTS AGE svclb-ingress-pipy-controller-8pk8k 1/1 Running 0 71s ingress-pipy-cfg-6bc649cfc7-8njk7 1/1 Running 0 71s ingress-pipy-controller-76cd866d78-m7gfp 1/1 Running 0 71s ingress-pipy-manager-5f568ff988-tw5w6 0/1 Running 0 70s è‡³æ­¤ï¼Œä½ å·²ç»æˆåŠŸå®‰è£… Flomesh çš„æ‰€æœ‰ç»„ä»¶ï¼ŒåŒ…æ‹¬ operator å’Œ ingress æ§åˆ¶å™¨ã€‚\nä¸­é—´ä»¶ Demo éœ€è¦ç”¨åˆ°ä¸­é—´ä»¶å®Œæˆæ—¥å¿—å’Œç»Ÿè®¡æ•°æ®çš„å­˜å‚¨ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ pipy è¿›è¡Œ mockï¼šç›´æ¥åœ¨æ§åˆ¶å°ä¸­æ‰“å°æ•°æ®ã€‚\nå¦å¤–ï¼ŒæœåŠ¡æ²»ç†ç›¸å…³çš„é…ç½®æœ‰ mock çš„ pipy config æœåŠ¡æä¾›ã€‚\nlog \u0026amp; metrics $ cat \u0026gt; middleware.js \u0026lt;\u0026lt;EOF pipy() .listen(8123) .link(\u0026#39;mock\u0026#39;) .listen(9001) .link(\u0026#39;mock\u0026#39;) .pipeline(\u0026#39;mock\u0026#39;) .decodeHttpRequest() .replaceMessage( req =\u0026gt; ( console.log(req.body.toString()), new Message(\u0026#39;OK\u0026#39;) ) ) .encodeHttpResponse() EOF $ docker run --rm --name middleware --entrypoint \u0026#34;pipy\u0026#34; -v ${PWD}:/script -p 8123:8123 -p 9001:9001 flomesh/pipy-pjs:0.4.0-118 /script/middleware.js pipy config $ cat \u0026gt; mock-config.json \u0026lt;\u0026lt;EOF { \u0026#34;ingress\u0026#34;: {}, \u0026#34;inbound\u0026#34;: { \u0026#34;rateLimit\u0026#34;: -1, \u0026#34;dataLimit\u0026#34;: -1, \u0026#34;circuitBreak\u0026#34;: false, \u0026#34;blacklist\u0026#34;: [] }, \u0026#34;outbound\u0026#34;: { \u0026#34;rateLimit\u0026#34;: -1, \u0026#34;dataLimit\u0026#34;: -1 } } EOF $ cat \u0026gt; mock.js \u0026lt;\u0026lt;EOF pipy({ _CONFIG_FILENAME: \u0026#39;mock-config.json\u0026#39;, _serveFile: (req, filename, type) =\u0026gt; ( new Message( { bodiless: req.head.method === \u0026#39;HEAD\u0026#39;, headers: { \u0026#39;etag\u0026#39;: os.stat(filename)?.mtime | 0, \u0026#39;content-type\u0026#39;: type, }, }, req.head.method === \u0026#39;HEAD\u0026#39; ? null : os.readFile(filename), ) ), _router: new algo.URLRouter({ \u0026#39;/config\u0026#39;: req =\u0026gt; _serveFile(req, _CONFIG_FILENAME, \u0026#39;application/json\u0026#39;), \u0026#39;/*\u0026#39;: () =\u0026gt; new Message({ status: 404 }, \u0026#39;Not found\u0026#39;), }), }) // Config .listen(9000) .decodeHttpRequest() .replaceMessage( req =\u0026gt; ( _router.find(req.head.path)(req) ) ) .encodeHttpResponse() EOF $ docker run --rm --name mock --entrypoint \u0026#34;pipy\u0026#34; -v ${PWD}:/script -p 9000:9000 flomesh/pipy-pjs:0.4.0-118 /script/mock.js è¿è¡Œ Demo Demo è¿è¡Œåœ¨å¦ä¸€ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ flomesh-spring ä¸­ï¼Œæ‰§è¡Œå‘½ä»¤ kubectl apply -f base/namespace.yaml æ¥åˆ›å»ºè¯¥å‘½åç©ºé—´ã€‚å¦‚æœä½  describe è¯¥å‘½åç©ºé—´ä½ ä¼šå‘ç°å…¶ä½¿ç”¨äº† flomesh.io/inject=true æ ‡ç­¾ã€‚\nè¿™ä¸ªæ ‡ç­¾å‘ŠçŸ¥ operator çš„ admission webHook æ‹¦æˆªæ ‡æ³¨çš„å‘½åç©ºé—´ä¸‹ pod çš„åˆ›å»ºã€‚\n$ kubectl describe ns flomesh-spring Name: flomesh-spring Labels: app.kubernetes.io/name=spring-mesh app.kubernetes.io/version=1.19.0 flomesh.io/inject=true kubernetes.io/metadata.name=flomesh-spring Annotations: \u0026lt;none\u0026gt; Status: Active No resource quota. No LimitRange resource. æˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹ Flomesh æä¾›çš„ CRD ProxyProfileã€‚è¿™ä¸ª demo ä¸­ï¼Œå…¶å®šä¹‰äº† sidecar å®¹å™¨ç‰‡æ®µä»¥åŠæ‰€ä½¿ç”¨çš„çš„è„šæœ¬ã€‚æ£€æŸ¥ sidecar/proxy-profile.yaml è·å–æ›´å¤šä¿¡æ¯ã€‚æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œåˆ›å»º CRD èµ„æºã€‚\n$ kubectl apply -f sidecar/proxy-profile.yaml æ£€æŸ¥æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š\n$ kubectl get pf -o wide NAME NAMESPACE DISABLED SELECTOR CONFIG AGE proxy-profile-002-bookinfo flomesh-spring false {\u0026#34;matchLabels\u0026#34;:{\u0026#34;sys\u0026#34;:\u0026#34;bookinfo-samples\u0026#34;}} {\u0026#34;flomesh-spring\u0026#34;:\u0026#34;proxy-profile-002-bookinfo-fsmcm-b67a9e39-0418\u0026#34;} 27s As the services has startup dependencies, you need to deploy it one by one following the strict order. Before starting, check the Endpoints section of base/clickhouse.yaml.\næä¾›ä¸­é—´ä»¶çš„è®¿é—® endpoidï¼Œå°† base/clickhouse.yamlã€base/metrics.yaml å’Œ base/config.yaml ä¸­çš„ ip åœ°å€æ”¹ä¸ºæœ¬æœºçš„ ip åœ°å€ï¼ˆä¸æ˜¯ 127.0.0.1ï¼‰ã€‚\nä¿®æ”¹ä¹‹åï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š\n$ kubectl apply -f base/clickhouse.yaml $ kubectl apply -f base/metrics.yaml $ kubectl apply -f base/config.yaml $ kubectl get endpoints samples-clickhouse samples-metrics samples-config NAME ENDPOINTS AGE samples-clickhouse 192.168.1.101:8123 3m samples-metrics 192.168.1.101:9001 3s samples-config 192.168.1.101:9000 3m éƒ¨ç½²æ³¨å†Œä¸­å¿ƒ $ kubectl apply -f base/discovery-server.yaml æ£€æŸ¥æ³¨å†Œä¸­å¿ƒ pod çš„çŠ¶æ€ï¼Œç¡®ä¿ 3 ä¸ªå®¹å™¨éƒ½è¿è¡Œæ­£å¸¸ã€‚\n$ kubectl get pod NAME READY STATUS RESTARTS AGE samples-discovery-server-v1-85798c47d4-dr72k 3/3 Running 0 96s éƒ¨ç½²é…ç½®ä¸­å¿ƒ $ kubectl apply -f base/config-service.yaml éƒ¨ç½² API ç½‘å…³ä»¥åŠ bookinfo ç›¸å…³çš„æœåŠ¡ $ kubectl apply -f base/bookinfo-v1.yaml $ kubectl apply -f base/bookinfo-v2.yaml $ kubectl apply -f base/productpage-v1.yaml $ kubectl apply -f base/productpage-v2.yaml æ£€æŸ¥ pod çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰ pod éƒ½æ³¨å…¥äº†å®¹å™¨ã€‚\n$ kubectl get pods samples-discovery-server-v1-85798c47d4-p6zpb 3/3 Running 0 19h samples-config-service-v1-84888bfb5b-8bcw9 1/1 Running 0 19h samples-api-gateway-v1-75bb6456d6-nt2nl 3/3 Running 0 6h43m samples-bookinfo-ratings-v1-6d557dd894-cbrv7 3/3 Running 0 6h43m samples-bookinfo-details-v1-756bb89448-dxk66 3/3 Running 0 6h43m samples-bookinfo-reviews-v1-7778cdb45b-pbknp 3/3 Running 0 6h43m samples-api-gateway-v2-7ddb5d7fd9-8jgms 3/3 Running 0 6h37m samples-bookinfo-ratings-v2-845d95fb7-txcxs 3/3 Running 0 6h37m samples-bookinfo-reviews-v2-79b4c67b77-ddkm2 3/3 Running 0 6h37m samples-bookinfo-details-v2-7dfb4d7c-jfq4j 3/3 Running 0 6h37m samples-bookinfo-productpage-v1-854675b56-8n2xd 1/1 Running 0 7m1s samples-bookinfo-productpage-v2-669bd8d9c7-8wxsf 1/1 Running 0 6m57s æ·»åŠ  Ingress è§„åˆ™ æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ·»åŠ  Ingress è§„åˆ™ã€‚\n$ kubectl apply -f ingress/ingress.yaml æµ‹è¯•å‰çš„å‡†å¤‡ è®¿é—® demo æœåŠ¡éƒ½è¦é€šè¿‡ ingress æ§åˆ¶å™¨ã€‚å› æ­¤éœ€è¦å…ˆè·å– LB çš„ ip åœ°å€ã€‚\n//Obtain the controller IP //Here, we append port. ingressAddr=`kubectl get svc ingress-pipy-controller -n ingress-pipy -o jsonpath=\u0026#39;{.spec.clusterIP}\u0026#39;`:81 è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†æ˜¯ k3d åˆ›å»ºçš„ k3sï¼Œå‘½ä»¤ä¸­åŠ å…¥äº† -p 81:80@loadbalancer é€‰é¡¹ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ 127.0.0.1:81 æ¥è®¿é—® ingress æ§åˆ¶å™¨ã€‚è¿™é‡Œæ‰§è¡Œå‘½ä»¤ ingressAddr=127.0.0.1:81ã€‚\nIngress è§„åˆ™ä¸­ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªè§„åˆ™æŒ‡å®šäº† hostï¼Œå› æ­¤æ¯ä¸ªè¯·æ±‚ä¸­éœ€è¦é€šè¿‡ HTTP è¯·æ±‚å¤´ Host æä¾›å¯¹åº”çš„ hostã€‚\næˆ–è€…åœ¨ /etc/hosts æ·»åŠ è®°å½•ï¼š\n$ kubectl get ing ingress-pipy-bookinfo -n flomesh-spring -o jsonpath=\u0026#34;{range .spec.rules[*]}{.host}{\u0026#39;\\n\u0026#39;}\u0026#34; api-v1.flomesh.cn api-v2.flomesh.cn fe-v1.flomesh.cn fe-v2.flomesh.cn //æ·»åŠ è®°å½•åˆ° /etc/hosts 127.0.0.1 api-v1.flomesh.cn api-v2.flomesh.cn fe-v1.flomesh.cn fe-v2.flomesh.cn éªŒè¯ $ curl http://127.0.0.1:81/actuator/health -H \u0026#39;Host: api-v1.flomesh.cn\u0026#39; {\u0026#34;status\u0026#34;:\u0026#34;UP\u0026#34;,\u0026#34;groups\u0026#34;:[\u0026#34;liveness\u0026#34;,\u0026#34;readiness\u0026#34;]} //OR $ curl http://api-v1.flomesh.cn:81/actuator/health {\u0026#34;status\u0026#34;:\u0026#34;UP\u0026#34;,\u0026#34;groups\u0026#34;:[\u0026#34;liveness\u0026#34;,\u0026#34;readiness\u0026#34;]} æµ‹è¯• ç°åº¦ åœ¨ v1 ç‰ˆæœ¬çš„æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬ä¸º book æ·»åŠ  rating å’Œ reviewã€‚\n# rate a book $ curl -X POST http://$ingressAddr/bookinfo-ratings/ratings \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -H \u0026#34;Host: api-v1.flomesh.cn\u0026#34; \\ -d \u0026#39;{\u0026#34;reviewerId\u0026#34;:\u0026#34;9bc908be-0717-4eab-bb51-ea14f669ef20\u0026#34;,\u0026#34;productId\u0026#34;:\u0026#34;2099a055-1e21-46ef-825e-9e0de93554ea\u0026#34;,\u0026#34;rating\u0026#34;:3}\u0026#39; $ curl http://$ingressAddr/bookinfo-ratings/ratings/2099a055-1e21-46ef-825e-9e0de93554ea -H \u0026#34;Host: api-v1.flomesh.cn\u0026#34; # review a book $ curl -X POST http://$ingressAddr/bookinfo-reviews/reviews \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -H \u0026#34;Host: api-v1.flomesh.cn\u0026#34; \\ -d \u0026#39;{\u0026#34;reviewerId\u0026#34;:\u0026#34;9bc908be-0717-4eab-bb51-ea14f669ef20\u0026#34;,\u0026#34;productId\u0026#34;:\u0026#34;2099a055-1e21-46ef-825e-9e0de93554ea\u0026#34;,\u0026#34;review\u0026#34;:\u0026#34;This was OK.\u0026#34;,\u0026#34;rating\u0026#34;:3}\u0026#39; $ curl http://$ingressAddr/bookinfo-reviews/reviews/2099a055-1e21-46ef-825e-9e0de93554ea -H \u0026#34;Host: api-v1.flomesh.cn\u0026#34; æ‰§è¡Œä¸Šé¢çš„å‘½ä»¤ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®å‰ç«¯æœåŠ¡ï¼ˆhttp://fe-v1.flomesh.cn:81/productpage?u=normalã€ http://fe-v2.flomesh.cn:81/productpage?u=normalï¼‰ï¼Œåªæœ‰ v1 ç‰ˆæœ¬çš„å‰ç«¯ä¸­æ‰èƒ½çœ‹åˆ°åˆšæ‰æ·»åŠ çš„è®°å½•ã€‚\nç†”æ–­ è¿™é‡Œç†”æ–­æˆ‘ä»¬é€šè¿‡ä¿®æ”¹ mock-config.json ä¸­çš„ inbound.circuitBreak ä¸º trueï¼Œæ¥å°†æœåŠ¡å¼ºåˆ¶å¼€å¯ç†”æ–­ï¼š\n{ \u0026#34;ingress\u0026#34;: {}, \u0026#34;inbound\u0026#34;: { \u0026#34;rateLimit\u0026#34;: -1, \u0026#34;dataLimit\u0026#34;: -1, \u0026#34;circuitBreak\u0026#34;: true, //here \u0026#34;blacklist\u0026#34;: [] }, \u0026#34;outbound\u0026#34;: { \u0026#34;rateLimit\u0026#34;: -1, \u0026#34;dataLimit\u0026#34;: -1 } } $ curl http://$ingressAddr/actuator/health -H \u0026#39;Host: api-v1.flomesh.cn\u0026#39; HTTP/1.1 503 Service Unavailable Connection: keep-alive Content-Length: 27 Service Circuit Break Open é™æµ ä¿®æ”¹ pipy config çš„é…ç½®ï¼Œå°† inbound.rateLimit è®¾ç½®ä¸º 1ã€‚\n{ \u0026#34;ingress\u0026#34;: {}, \u0026#34;inbound\u0026#34;: { \u0026#34;rateLimit\u0026#34;: 1, //here \u0026#34;dataLimit\u0026#34;: -1, \u0026#34;circuitBreak\u0026#34;: false, \u0026#34;blacklist\u0026#34;: [] }, \u0026#34;outbound\u0026#34;: { \u0026#34;rateLimit\u0026#34;: -1, \u0026#34;dataLimit\u0026#34;: -1 } } æˆ‘ä»¬ä½¿ç”¨ wrk æ¨¡æ‹Ÿå‘é€è¯·æ±‚ï¼Œ20 ä¸ªè¿æ¥ã€20 ä¸ªè¯·æ±‚ã€æŒç»­ 30sï¼š\n$ wrk -t20 -c20 -d30s --latency http://$ingressAddr/actuator/health -H \u0026#39;Host: api-v1.flomesh.cn\u0026#39; Running 30s test @ http://127.0.0.1:81/actuator/health 20 threads and 20 connections Thread Stats Avg Stdev Max +/- Stdev Latency 951.51ms 206.23ms 1.04s 93.55% Req/Sec 0.61 1.71 10.00 93.55% Latency Distribution 50% 1.00s 75% 1.01s 90% 1.02s 99% 1.03s 620 requests in 30.10s, 141.07KB read Requests/sec: 20.60 Transfer/sec: 4.69KB ä»ç»“æœæ¥çœ‹ 20.60 req/sï¼Œå³æ¯ä¸ªè¿æ¥ 1 req/sã€‚\né»‘ç™½åå• å°† pipy config çš„ mock-config.json åšå¦‚ä¸‹ä¿®æ”¹ï¼šip åœ°å€ä½¿ç”¨çš„æ˜¯ ingress controller çš„ pod ipã€‚\n$ kgpo -n ingress-pipy ingress-pipy-controller-76cd866d78-4cqqn -o jsonpath=\u0026#39;{.status.podIP}\u0026#39; 10.42.0.78 { \u0026#34;ingress\u0026#34;: {}, \u0026#34;inbound\u0026#34;: { \u0026#34;rateLimit\u0026#34;: -1, \u0026#34;dataLimit\u0026#34;: -1, \u0026#34;circuitBreak\u0026#34;: false, \u0026#34;blacklist\u0026#34;: [\u0026#34;10.42.0.78\u0026#34;] //here }, \u0026#34;outbound\u0026#34;: { \u0026#34;rateLimit\u0026#34;: -1, \u0026#34;dataLimit\u0026#34;: -1 } } è¿˜æ˜¯è®¿é—®ç½‘å…³çš„æ¥å£\ncurl http://$ingressAddr/actuator/health -H \u0026#39;Host: api-v1.flomesh.cn\u0026#39; HTTP/1.1 503 Service Unavailable content-type: text/plain Connection: keep-alive Content-Length: 20 Service Unavailable ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/enhance-springcloud-service-governance-with-flomesh/","tags":["Service Mesh","Spring","Java"],"title":"ä½¿ç”¨ Flomesh å¼ºåŒ– Spring Cloud æœåŠ¡æ²»ç†"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬æ–‡ç”±æœ¬äººç¿»è¯‘è‡ª Bilgin Ibryam çš„ A Framework for Open Source Evaluationï¼Œé¦–å‘åœ¨äº‘åŸç”Ÿç¤¾åŒºåšå®¢ã€‚\nå¦‚ä»Šï¼ŒçœŸå‡å¼€æºæ— å¤„ä¸åœ¨ã€‚æœ€è¿‘å¼€æºé¡¹ç›®è½¬ä¸ºé—­æºçš„æ¡ˆä¾‹è¶Šæ¥è¶Šå¤šï¼ŒåŒæ—¶ä¹Ÿæœ‰ä¸å°‘é—­æºé¡¹ç›®ï¼ˆæŒ‰ç…§ OSI å®šä¹‰ï¼‰åƒå¼€æºä¸€æ ·æ„å»ºç¤¾åŒºçš„ä¾‹å­ã€‚è¿™æ€ä¹ˆå¯èƒ½ï¼Œå¼€æºé¡¹ç›®ä¸åº”è¯¥å§‹ç»ˆå¦‚æ­¤å—ï¼Ÿ\nå¼€æºä¸æ˜¯éé»‘å³ç™½ï¼Œå®ƒå…·æœ‰å¼€æ”¾æ€§ã€é€æ˜ã€åä½œæ€§å’Œä¿¡ä»»æ€§çš„å¤šä¸ªç»´åº¦ã€‚æœ‰äº›å¼€æºæ˜¯ Github ä¸Šçš„ä»»ä½•é¡¹ç›®ï¼Œæœ‰äº›å¿…é¡»é€šè¿‡ OSI å®šä¹‰ï¼Œæœ‰äº›æ˜¯å¿…é¡»éµå®ˆä¸æˆæ–‡ä½†æ™®éæ¥å—çš„å¼€æºè§„èŒƒã€‚è¿™é‡Œé€šè¿‡çœ‹ä¸€äº›å•†ä¸šå’ŒæŠ€æœ¯æ–¹é¢ï¼Œå†è®¨è®ºç¤¾åŒºç®¡ç†ä¹ æƒ¯ï¼Œæ¥åŒå¤§å®¶åˆ†äº«ä¸€ä¸‹æˆ‘å¯¹è¯„ä¼°å¼€æºé¡¹ç›®çš„çœ‹æ³•ã€‚\nå…è´£å£°æ˜ è¿™äº›æ˜¯æˆ‘çš„ä¸ªäººè§‚ç‚¹ï¼Œä¸æˆ‘çš„é›‡ä¸»æˆ–æˆ‘æ‰€å±çš„è½¯ä»¶åŸºé‡‘ä¼šå’Œé¡¹ç›®æ— å…³ã€‚ è¿™ä¸æ˜¯æ³•å¾‹æˆ–ä¸“ä¸šæ„è§ï¼ˆæˆ‘ä¸æ˜¯å¾‹å¸ˆï¼Œä¹Ÿä¸æ˜¯ä¸“é—¨ä»äº‹ OSS è¯„ä¼°çš„ï¼‰ï¼Œè€Œæ˜¯å¤–è¡Œçš„æ„è§ã€‚ æ›´æ–°ï¼šæˆ‘æ”¶åˆ°äº†å¤šä½å¼€æºå¾‹å¸ˆçš„åé¦ˆå¹¶æ›´æ–°äº†æ–‡ç« ï¼ è¿™ç¯‡åšæ–‡ç”±è®¢é˜…å’Œåˆ†äº«æŒ‰é’®èµåŠ©ï¼Œç‚¹å‡»è¿™äº›æŒ‰é’®è¡¨ç¤ºæ”¯æŒã€‚ çŸ¥è¯†äº§æƒ å…³äºâ€œå¼€æºâ€é¡¹ç›®çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯å…³äºçŸ¥è¯†äº§æƒçš„æ‰€æœ‰æƒã€‚å¥½æ¶ˆæ¯æ˜¯ï¼Œå³ä½¿ä¸äº†è§£è¿™äº›æ³•å¾‹å«ä¹‰ï¼Œä½ å¯ä»¥åº”ç”¨ä¸€ä¸ªç®€å•çš„ Litmus æµ‹è¯•ã€‚è¯¥é¡¹ç›®æ˜¯å¦å±äºä½ ä¿¡ä»»çš„ä¿¡èª‰è‰¯å¥½çš„å¼€æºåŸºé‡‘ä¼šï¼Ÿä¾‹å¦‚ï¼ŒFSF æ‹¥æœ‰å…¶æ‰˜ç®¡é¡¹ç›®çš„ç‰ˆæƒï¼Œæ›´å¤šæƒ…å†µä¸‹æ‹¥æœ‰åŸºé‡‘ä¼šï¼ˆå¦‚ ASFã€LF) é€šè¿‡è´¡çŒ®è€…è®¸å¯åè®®ï¼Œèšåˆå¯¹å…¶é¡¹ç›®çš„è´¡çŒ®è®¸å¯æƒã€‚åœ¨ä»»ä½•ä¸€ç§æƒ…å†µä¸‹ï¼Œä½ éƒ½å¯ä»¥ç›¸ä¿¡ä»–ä»¬å°†å……å½“è‰¯å¥½çš„å»ä¸­å¿ƒåŒ–ç®¡å®¶ï¼Œå¹¶ä¸”ä¸ä¼šåœ¨ä¸€å¤œä¹‹é—´æ”¹å˜é¡¹ç›®çš„æœªæ¥æ–¹å‘ã€‚å¦‚æœä¸€ä¸ªé¡¹ç›®ä¸å±äºä¿¡èª‰è‰¯å¥½çš„è½¯ä»¶åŸºé‡‘ä¼šï¼Œè€Œæ˜¯ç”±ä¸€å®¶å…¬å¸æä¾›æ”¯æŒï¼Œé‚£ä¹ˆé—®é¢˜æ˜¯ä½ æ˜¯å¦ä¿¡ä»»è¯¥å…¬å¸ä½œä¸ºä¾›åº”é“¾åˆä½œä¼™ä¼´ã€‚å¦‚æœè¿™äº›é—®é¢˜çš„ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè¯·è½¬åˆ°ä¸‹ä¸€éƒ¨åˆ†ã€‚å¦‚æœç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œé‚£ä¹ˆä½ æœ€å¥½è°ƒæŸ¥ä¸€ä¸‹ç‰ˆæƒæ‰€æœ‰è€…æ˜¯è°ï¼Œä»¥åŠä»–ä»¬å¯¹ä½ çš„é•¿æœŸå‰æ™¯å’Œæ½œåœ¨é£é™©æ˜¯ä»€ä¹ˆã€‚ä»Šå¤©çš„å•ä¸€ä¾›åº”å•†å¼€æºé¡¹ç›®ï¼Œæ˜å¤©å¯èƒ½ä¼šå˜æˆé—­æºã€‚\nè®¸å¯ å•†æ ‡å‡ºç°åœ¨è®¸å¯ä¹‹å‰çš„åŸå› æ˜¯è½¯ä»¶çš„æƒåˆ©äººï¼ˆé€šå¸¸æ˜¯ä½œè€…ï¼‰é€šè¿‡è®¸å¯æˆäºˆæœ€ç»ˆç”¨æˆ·ä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªè½¯ä»¶å‰¯æœ¬çš„è®¸å¯ã€‚è‡ªç”±è½¯ä»¶è®¸å¯è¯æ˜¯ä¸€ç§è¯´æ˜ï¼Œå®ƒæˆäºˆæºä»£ç æˆ–å…¶äºŒè¿›åˆ¶å½¢å¼çš„ä½¿ç”¨è€…ä¿®æ”¹å’Œé‡æ–°åˆ†å‘è¯¥è½¯ä»¶çš„æƒåˆ©ã€‚å¦‚æœæ²¡æœ‰è®¸å¯ï¼Œè¿™äº›è¡Œä¸ºå°†å—åˆ°ç‰ˆæƒæ³•çš„ç¦æ­¢ã€‚è¿™é‡Œçš„é‡ç‚¹æ˜¯æƒåˆ©äººå¯ä»¥æ”¹å˜ä¸»æ„å¹¶æ›´æ”¹è®¸å¯ã€‚æƒåˆ©æŒæœ‰äººå¯ä»¥å†³å®šåœ¨å¤šä¸ªè®¸å¯è¯ä¸‹åˆ†å‘è½¯ä»¶æˆ–éšæ—¶å°†è®¸å¯è¯æ›´æ”¹ä¸ºéå¼€æºè®¸å¯è¯ã€‚è¯¥è½¯ä»¶ä¹Ÿå¯èƒ½åœ¨å…¬å…±é¢†åŸŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä¸å—ç‰ˆæƒæ³•çš„é™åˆ¶ã€‚å…¬å…±é¢†åŸŸå¹¶ä¸ç­‰åŒäºå¼€æºè®¸å¯è¯ï¼Œè¿™æ˜¯ä¸€ç§ä¸å¤ªæµè¡Œçš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œå¿½ç•¥ã€‚\nåŒæ ·ï¼Œå¦‚æœä¸æ˜¯å¾‹å¸ˆï¼Œè¿™æ˜¯ä¸€ä¸ªå¤–è¡Œå¯¹è®¸å¯çš„ Litmus æµ‹è¯•ï¼šè¯¥é¡¹ç›®æ˜¯å¦æ ¹æ® OSI æ‰¹å‡†çš„è®¸å¯æ¸…å•è·å¾—çš„è®¸å¯ï¼Ÿå¦‚æœç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä¾é è¿™äº›åŸºé‡‘ä¼šçš„å°½èŒè°ƒæŸ¥æ¥å®¡æŸ¥ã€åˆ†ç±»è®¸å¯å¹¶æŒ‡å‡ºä»»ä½•é™åˆ¶ã€‚å¦‚æœç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œè¯·è®©ä½ å…¬å¸çš„å¾‹å¸ˆæ¥æŸ¥çœ‹å’Œè§£é‡Šè®¸å¯ä¸Šçš„æ¯ä¸ªå­—ä»¥åŠå¯èƒ½çš„è®¸å¯å…¼å®¹æ€§å½±å“ã€‚\næ²»ç† åœ¨ä½™ä¸‹çš„æ£€æŸ¥ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨ä»æ›´å¤šçš„å•†ä¸šå’Œæ³•å¾‹æ–¹é¢è½¬å‘æ¶‰åŠå¼€æºé¡¹ç›®é¢†åŸŸçš„æŠ€æœ¯å’Œç¤¾åŒºã€‚\nå‡è®¾ä¸æ‹…å¿ƒå•†æ ‡æŒæœ‰æ–¹ï¼ˆæœªæ¥çš„åˆä½œä¼™ä¼´ï¼‰ã€è®¸å¯ï¼ˆä½¿ç”¨å¼€æºè½¯ä»¶çš„æ¡æ¬¾ï¼‰ï¼Œä¸‹ä¸€ä¸ªé—®é¢˜æ˜¯æ²»ç†ã€‚æ²»ç†æ˜¯é¡¹ç›®å†³å®šè°æ¥åšä»€ä¹ˆã€ä»–ä»¬åº”è¯¥å¦‚ä½•åšä»¥åŠä½•æ—¶åšçš„è§„åˆ™æˆ–ä¹ æƒ¯ã€‚å®ƒå®šä¹‰äº†ä¸ä¸åŒé¡¹ç›®è§’è‰²ç›¸å…³çš„èŒè´£ã€ç‰¹æƒå’Œæƒé™ï¼Œä»¥åŠäººä»¬å¦‚ä½•åˆ†é…åˆ°è§’è‰²å’Œä»è§’è‰²ä¸­åˆ é™¤ã€‚æ­¤å¤„çš„ç¤ºä¾‹æ˜¯å°å‹æ—¥å¸¸æ´»åŠ¨ï¼Œä¾‹å¦‚è°æœ‰æƒæ‰¹å‡†æ‹‰å–è¯·æ±‚ã€æŠ•ç¥¨ç»™å€™é€‰å‘å¸ƒã€å°±é¡¹ç›®æ¶æ„è¾¾æˆå…±è¯†ã€å®šä¹‰é¡¹ç›®è·¯çº¿å›¾ä»¥åŠé€‰ä¸¾é¡¹ç›®æ²»ç†å§”å‘˜ä¼šã€‚\nå¦‚æœä½ æ­£åœ¨è¯„ä¼°å¯¹ä½ çš„ç»„ç»‡å…·æœ‰æˆ˜ç•¥æ„ä¹‰çš„é¡¹ç›®ï¼Œä½ æƒ³çŸ¥é“è°è´Ÿè´£ã€‚ä¸ä»…å¦‚æ­¤ï¼Œä½ ç”šè‡³å¯èƒ½å¸Œæœ›ä½ çš„å¼€å‘äººå‘˜å¯¹é¡¹ç›®çš„æ–¹å‘æœ‰å‘è¨€æƒã€‚\nè¿˜æœ‰ä¸€ä¸ªç®€å•çš„ Litmus æµ‹è¯•ï¼šå¯¹äºå¼€æºåŸºé‡‘ä¼šçš„é¡¹ç›®ï¼Œå¯¹äºè°å¯ä»¥å¯¹é‡è¦å†³ç­–è¿›è¡ŒæŠ•ç¥¨ï¼Œä»¥åŠå¦‚ä½•æˆä¸ºå†³ç­–å§”å‘˜ä¼šçš„ä¸€éƒ¨åˆ†ï¼Œéƒ½æœ‰æ˜ç¡®çš„è§„åˆ™ã€‚åœ¨æŸäº›åŸºé‡‘ä¼šï¼ˆä¾‹å¦‚ ASFï¼‰ä¸­ï¼Œå®ƒåŸºäºç¤¾åŒºæˆå‘˜çš„ä¸ªäººåŠŸç»©ï¼Œè€Œåœ¨æŸäº›åŸºé‡‘ä¼šï¼ˆä¾‹å¦‚ CNCF ï¼‰ä¸­ï¼Œå®ƒä»æˆä¸ºä»˜è´¹æˆå‘˜ç»„ç»‡çš„å‘˜å·¥å¼€å§‹ã€‚åœ¨åŸºäºåŒºå—é“¾çš„å¼€æºé¡¹ç›®ä¸­ï¼Œå®ƒæ˜¯åŸºäºä»¤ç‰Œï¼ˆTokenï¼‰çš„æŠ•ç¥¨æŒæœ‰äººã€‚å…¶ä»–åŸºé‡‘ä¼šæœ‰ä¸åŒçš„è§„åˆ™ï¼Œä½†éƒ½åŠ›æ±‚åœ¨å¤šä¸ªå‚ä¸è€…ä¹‹é—´å®ç°ä¸­ç«‹å’ŒæƒåŠ›ä¸‹æ”¾ã€‚å¦‚æœä¸€ä¸ªé¡¹ç›®ç”±ä¸€å®¶å…¬å¸æˆ–ä¸€ä¸ªäººç®¡ç†ï¼Œä½ ç›¸ä¿¡ä»–ä»¬ä¼šä¸ºé¡¹ç›®å’Œç¤¾åŒºçš„åˆ©ç›Šåšå‡ºæœ€ä½³å†³ç­–ã€‚å…¶ä¸­ä¸€äº›é¡¹ç›®å¯èƒ½å·²ç»å†™ä¸‹äº†ä»–ä»¬éµå¾ªçš„æ²»ç†è§„åˆ™ï¼Œè€Œæœ‰äº›å¯èƒ½æ ¹æœ¬æ²¡æœ‰ã€‚ç”±ä½ æ¥ç¡®å®šæ²»ç†åŠ¨æ€åŠå…¶å¯¹ä½ çš„é¡¹ç›®å‚ä¸çš„é‡è¦æ€§ã€‚é™¤äº†å…·æœ‰æ²»ç†é€æ˜åº¦å’Œå…¬å¼€å†³ç­–ä¹‹å¤–ï¼Œå¦ä¸€ä¸ªæ–¹é¢æ˜¯æ²»ç†æœºæ„çš„ä¿¡ä»»åº¦å’Œå£°èª‰ã€‚å½“ä½ æŸ¥çœ‹é¡¹ç›®çš„æ²»ç†å§”å‘˜ä¼šæ—¶ï¼Œæ˜¯å¦æœ‰ä¸€ä½æˆ–ä¸€ç»„å…·æœ‰ç»è¿‡éªŒè¯çš„æŠ€æœ¯å’Œç¤¾äº¤æŠ€èƒ½çš„é¢†å¯¼è€…ï¼Œè®©ä½ ç›¸ä¿¡ä»–ä»¬å¯ä»¥å°†é¡¹ç›®æå‡åˆ°ä¸€ä¸ªæ–°çš„æ°´å¹³ï¼Ÿæˆ–è€…ä½ æ˜¯å¦çœ‹åˆ°ä¸€ä¸ªåœ¨æ”¿æ²»æ–—äº‰ä¸­ä¸æ–­äº‰è®ºçš„å›¢ä½“ï¼Ÿè¿™äº›æ˜¯å¼€æºé¡¹ç›®æ˜¯å¦ä¼šæˆåŠŸå¹¶é•¿æœŸå‘å±•çš„ä¸€äº›æŒ‡æ ‡ï¼Œè¿˜æ˜¯å¯ä»¥é¢„æœŸçš„å¤´ç—›å’Œåœæ»ã€‚\nåŸºç¡€è®¾æ–½ æ‹¥æœ‰å¼€æºè®¸å¯å¯èƒ½åœ¨æŠ€æœ¯ä¸Šæœ‰èµ„æ ¼ä½œä¸ºå¼€æºé¡¹ç›®ï¼Œä½†è¿™å¹¶ä¸èƒ½è¯´æ˜é¡¹ç›®æ˜¯å¦ä»¥å¼€æºæ–¹å¼æ„å»ºã€‚æœ‰è®¸å¤šåœ¨ OSI æ‰¹å‡†çš„è®¸å¯ä¸‹å‘å¸ƒçš„è½¯ä»¶ç¤ºä¾‹ï¼Œä½†å®ƒä»¬æ˜¯åœ¨å°é—­çš„åŸºç¡€è®¾æ–½ä¹‹åå¼€å‘çš„ã€‚é€šè¿‡åŸºç¡€è®¾æ–½ï¼Œæˆ‘çš„æ„æ€æ˜¯ç”¨æˆ·å¿«é€Ÿæé—®çš„èŠå¤©é¢‘é“ã€‚è¿›è¡Œæ›´æ·±å…¥çš„å¼€å‘äººå‘˜è®¨è®ºçš„è®ºå›å’Œé‚®ä»¶åˆ—è¡¨ã€‚å®¡æŸ¥æ‹‰å–è¯·æ±‚çš„æºä»£ç ç®¡ç†ç³»ç»Ÿï¼Œä»¥åŠè¿è¡Œæµ‹è¯•å’Œæ¯æ™šåˆ›å»ºäºŒè¿›åˆ¶æ–‡ä»¶çš„æ„å»ºæœåŠ¡å™¨ã€‚\nå¯¹äºå…³æ³¨å¼€æºé¡¹ç›®çš„å•†åŠ¡äººå£«å’Œå¾‹å¸ˆæ¥è¯´ï¼Œè¿™äº›å¯èƒ½å¹¶ä¸é‡è¦ï¼Œä½†å¯¹äºå°†è¦ä½¿ç”¨å¼€æºé¡¹ç›®çš„æŠ€æœ¯äººå‘˜æ¥è¯´ï¼Œè¿™äº›æ˜¯ä¸€äº›å‡è®¾çš„å¥½å¤„ã€‚è¿™é‡Œè¦åšçš„æ£€æŸ¥æ˜¯æ¢ç´¢è½¯ä»¶æ˜¯å¦æ˜¯ä½¿ç”¨å¼€æ”¾å¼åŸºç¡€è®¾æ–½ä»¥å¼€æºæ–¹å¼å¼€å‘çš„ï¼Œè€Œä¸æ˜¯é—­é—¨é€ è½¦ã€‚ä»¥ä¸‹æ˜¯å‡ ä¸ªç¤ºä¾‹é—®é¢˜ï¼š\nç”¨æˆ·å¯ä»¥åœ¨é¡¹ç›®èŠå¤©ä¸­æå‡ºé—®é¢˜å¹¶åœ¨æ²¡æœ‰ä¸­é—´äººçš„æƒ…å†µä¸‹ä»å¦ä¸€ä¸ªç”¨æˆ·é‚£é‡Œå¾—åˆ°ç­”æ¡ˆå—ï¼Ÿ å¼€å‘äººå‘˜èƒ½å¦ä¸é¡¹ç›®æäº¤è€…è”ç³»å¹¶è·å¾—æ·±å…¥çš„æŠ€æœ¯é—®é¢˜çš„ç­”æ¡ˆï¼Ÿ ä½ èƒ½å¦è¿è¡Œæœ€æ–°ç‰ˆæœ¬å¹¶ç¡®è®¤å·²çŸ¥çš„é”™è¯¯å·²ä¿®å¤ï¼Ÿ æ¶æ„å¸ˆå¯ä»¥å‚åŠ æ¯å‘¨ä¸€æ¬¡çš„ç¤¾åŒºç”µè¯ä¼šè®®å¹¶ç¡®å®šé¡¹ç›®çš„æœªæ¥æ–¹å‘å—ï¼Ÿï¼ˆåŸæ–‡ Can an architect the weekly community call and figure out the future direction of the project?Â ï¼‰ å¯¹äºå°é—­çš„åŸºç¡€æ¶æ„ï¼Œä½ å¿…é¡»åˆ›å»ºæ”¯æŒå·¥å•å¹¶ä»˜è´¹æ‰èƒ½è·å¾—ç±»ä¼¼é—®é¢˜çš„ç­”æ¡ˆã€‚é€šè¿‡å¼€æ”¾çš„åŸºç¡€è®¾æ–½å’Œå¼€æ”¾çš„å‚ä¸ï¼Œé‚£äº›çŸ¥é“å¦‚ä½•ä»¥å¼€æºæ–¹å¼å·¥ä½œçš„äººå¯ä»¥è·å¾—ç­”æ¡ˆã€‚\nç¤¾åŒºå’Œé‡‡ç”¨ å¼€æºè½¯ä»¶çš„ä¸»è¦å¥½å¤„ä¹‹ä¸€æ˜¯å®ƒå…è®¸å¥½åˆ›æ„çš„å‘å±•å’Œä¼ æ’­ã€‚ä½ å¯èƒ½æ‹¥æœ‰æœ€å…ˆè¿›çš„æŠ€æœ¯ã€æœ€å®½æ¾çš„è®¸å¯å’Œå¼€æ”¾å¼å¼€å‘ï¼Œä½†å¦‚æœè¯¥è½¯ä»¶æ²¡æœ‰ä¸æ–­å£®å¤§çš„ç¤¾åŒºå’Œä¸æ–­æé«˜çš„é‡‡ç”¨ç‡ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªå€¼å¾—è°ƒæŸ¥çš„è¿¹è±¡ã€‚ä¸åŒçš„é¡¹ç›®ä¼šæœ‰ä¸åŒçš„é‡‡ç”¨ç‡ã€‚æœ‰äº›å¯èƒ½ä¼šè¿…é€Ÿæˆé•¿ä¸ºä¸»æµæˆ–è¢«å…¶ä»–åŒç±»å‹é¡¹ç›®æ‰€å–ä»£ã€‚ä¸€äº›é¡¹ç›®å¯èƒ½æœ‰ä¸€ä¸ªå°ä½†æŒç»­çš„å¢é•¿ç‡å’Œä¸€ä¸ªæŒç»­æ•°åå¹´çš„ç”Ÿæ€ç¤¾åŒºã€‚ç¤¾åŒºè§„æ¨¡å’Œé‡‡ç”¨ç‡æ˜¯å¼€æºé¡¹ç›®çš„æœ€ç»ˆå¯¿å‘½æŒ‡æ ‡ã€‚ä»¥ä¸‹æ˜¯ä½ å¯ä»¥æå‡ºçš„ä¸€äº›ç¤ºä¾‹é—®é¢˜ï¼š\né¡¹ç›®ä¸­æœ‰å¤šå°‘æ´»è·ƒçš„å¼€å‘äººå‘˜ï¼ˆæäº¤è€…ï¼‰ï¼Œå¹³å‡æäº¤ç‡æ˜¯å¤šå°‘ï¼Ÿ ä¸Šä¸ªæœˆæœ‰å¤šå°‘ç”¨æˆ·è®¢é˜…äº†ç”¨æˆ·è®ºå›ä»¥åŠæå‡ºäº†å¤šå°‘é—®é¢˜ï¼Ÿ è½¯ä»¶çš„æœ€æ–°ç¨³å®šç‰ˆæœ¬å·²è¢«ä¸‹è½½å¤šå°‘æ¬¡ï¼Ÿ è¿˜æœ‰å“ªäº›é¡¹ç›®å’ŒæœåŠ¡ä¾èµ–å¹¶ä½¿ç”¨è¿™ä¸ªé¡¹ç›®ï¼Ÿ æœ‰å¤šå°‘å•†ä¸šç»„ç»‡æ”¯æŒè¿™ä¸ªé¡¹ç›®ï¼Ÿ æ˜¯å¦æœ‰å•†ä¸šç»„ç»‡å›´ç»•å®ƒæä¾›äº§å“ã€æ”¯æŒå’ŒæœåŠ¡ï¼Ÿ è¿™ä¸ªé¡¹ç›®æœ‰å¤šå°‘ StackOverflow é—®é¢˜ï¼Ÿ æœ‰å¤šå°‘ä¹¦ç±ã€ä¼šè®®æ¼”è®²å’ŒèŒä½æè¿°æåˆ°äº†è¿™ä¸ªé¡¹ç›®ï¼Ÿ æ‰§è¡Œè¿™äº›é—®é¢˜ä¼šç»™ä½ ä¸€ä¸ªæŒ‡ç¤ºï¼Œå³è¯¥é¡¹ç›®æ˜¯åœ¨å¢é•¿å¹¶æˆä¸ºå…¶é¢†åŸŸçš„äº‹å®ä¸Šçš„æ ‡å‡†ï¼Œè¿˜æ˜¯åœæ»ä¸å‰å¹¶å¯èƒ½è¢«ä¸‹ä¸€ä¸ªå¤§é¡¹ç›®æ‰€å–ä»£ã€‚\né€šå¸¸ï¼Œå¼€æºä¸å¿«èŠ‚å¥çš„å¼€å‘å’Œåˆ›æ–°æœ‰å…³ã€‚åŒæ—¶ï¼Œå¼€æºä¹Ÿæ˜¯ä¸€ç§åˆ›å»ºå¹¿æ³›é‡‡ç”¨å’Œåˆ›å»ºéå®˜æ–¹æ ‡å‡†çš„æœºåˆ¶ã€‚è®¸å¤šå¼€æºé¡¹ç›®å·²ç»å˜æˆäº†æ ‡å‡†ï¼Œä¾‹å¦‚ç”¨äºå®¹å™¨ç¼–æ’çš„ Kubernetesã€ç”¨äºæµå¤„ç†çš„ Apache Kafkaã€ç”¨äº Web æœåŠ¡å™¨çš„ Apache httpd ç­‰ã€‚è½¯ä»¶ä¸­æœ€æ˜‚è´µçš„äº‹æƒ…ä¹‹ä¸€æ˜¯æ‰¾åˆ°å…·æœ‰åˆé€‚æŠ€èƒ½çš„äººã€‚ä½¿ç”¨é‡‡ç”¨ç‡é«˜çš„å¼€æºé¡¹ç›®å°†ä½¿ä½ æœ‰æ›´å¥½çš„æœºä¼šæ‰¾åˆ°æŠ€æœ¯å¨´ç†Ÿçš„äººï¼Œå¹¶è®©ä»–ä»¬èƒ½å¤Ÿæ›´é•¿æ—¶é—´åœ°é‡å¤ä½¿ç”¨ä»–ä»¬çš„æŠ€èƒ½ã€‚\næ€»ç»“ æ ¹æ®å¼€æºé¡¹ç›®çš„å…³é”®ç¨‹åº¦ï¼Œæœ‰ä¸åŒçš„é£é™©å’Œè¯„ä¼°æ ‡å‡†ã€‚å¯¹äºæˆ˜ç•¥æ€§çš„ã€éš¾ä»¥æ›¿ä»£çš„é¡¹ç›®ï¼Œè¿™å°†æ˜¯ä½ çš„ IT åŸºç¡€è®¾æ–½çš„åŸºç¡€ï¼Œä½ éœ€è¦æ˜¯å·²ç»æˆä¸ºå…¶é¢†åŸŸäº‹å®ä¸Šçš„å¼€æºæ ‡å‡†çš„å®Œå–„é¡¹ç›®ã€‚åœ¨è¿™é‡Œç¡®å®šè°æ‹¥æœ‰è¯¥é¡¹ç›®çš„å•†æ ‡ä»¥åŠè°å°†æˆä¸ºä½ çš„é•¿æœŸåˆä½œä¼™ä¼´éå¸¸é‡è¦ã€‚é€šå¸¸ï¼Œè¿™äº›åˆä½œä¼™ä¼´æ˜¯é¡¹ç›®æ‰€å±è½¯ä»¶åŸºé‡‘ä¼šçš„æˆå‘˜ç»„ç»‡æˆ–æŒæœ‰é¡¹ç›® IP çš„å•ä¸ªå…¬å¸ã€‚å¯¹äºåè€…ï¼Œä½ å¯èƒ½éœ€è¦è€ƒè™‘é•¿æœŸé£é™©ï¼Œä¾‹å¦‚æ ¸å¿ƒå¼€å‘äººå‘˜åˆ†å‰é¡¹ç›®çš„æœºä¼šã€æä¾›é¡¹ç›®å³æœåŠ¡çš„è¶…å¤§è§„æ¨¡è€…ã€å…¬å¸æ”¶è´­ç­‰ã€‚\nå¯¹äºäº¤ä»˜é€Ÿåº¦æœ€é‡è¦çš„éæˆ˜ç•¥æ€§ã€æˆ˜æœ¯æ€§ã€çŸ­æœŸé¡¹ç›®ï¼Œä½ å¯ä»¥è®©ä½ çš„å¼€å‘äººå‘˜æ ¹æ®å¼€æ”¾æ€§ã€ç¤¾åŒºåä½œå’Œçƒ­åº¦ï¼ˆå¯¹äºæŸäº›å‰ç«¯æŠ€æœ¯å¾ˆé‡è¦ï¼‰æ¥æ¨åŠ¨é€‰æ‹©å’ŒæŒ‘é€‰é¡¹ç›®ã€‚åœ¨è¿™é‡Œï¼Œå®šæœŸçš„å®‰å…¨ä¿®å¤ã€å¼€å‘äººå‘˜æ”¯æŒå’Œè®¸å¯å…¼å®¹æ€§æ£€æŸ¥ç­‰ä¸­çŸ­æœŸé£é™©å¯èƒ½å°±è¶³å¤Ÿäº†ã€‚\nåœ¨ä»»ä½•ä¸€ç§æƒ…å†µä¸‹ï¼Œéƒ½æ²¡æœ‰é€‚åˆæ‰€æœ‰æƒ…å†µçš„å•ä¸€è¯„ä¼°æ ‡å‡†ã€‚ä½ å¿…é¡»åœ¨é•¿æœŸå•†ä¸šé£é™©ã€æŠ€æœ¯ç¨³å®šæ€§ä¸æœ€æ–°çƒ­åº¦ã€åˆ›æ–°å’Œå¼€å‘äººå‘˜æ»¡æ„åº¦ä¹‹é—´å–å¾—å¹³è¡¡ã€‚è¿™é‡Œçš„æ¡†æ¶å°†ä¸ºä½ æ¦‚æ‹¬éœ€è¦æ¢ç´¢çš„é¢†åŸŸå’Œéœ€è¦è€ƒè™‘çš„ä¸€äº›é£é™©ã€‚ç¥ä½ å¥½è¿ï¼\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/a-framework-for-open-source-evaluation/","tags":["OpenSource"],"title":"å¼€æºè¯„ä¼°æ¡†æ¶"},{"categories":["ç”Ÿæ´»"],"contents":" è¶ç€æ¢å·¥ä½œçš„é—´éš™ï¼Œæ¥ä¸€åœºâ€œè“„è°‹å·²ä¹…â€ã€â€œè¯´èµ°å°±èµ°â€çš„æ—…è¡Œã€‚\næ–°ç–†ï¼Œæ˜¯ä¸€ä¸ªç¾ä¸½è€Œé¥è¿œçš„åœ°æ–¹ã€‚å‰æ®µæ—¶é—´çœ‹äº†æå¨Ÿçš„ã€Šå†¬ç‰§åœºã€‹ï¼Œæ›´æ˜¯æèµ·äº†æˆ‘å¯¹æ–°ç–†å¯¹æ¸¸ç‰§å“ˆè¨å…‹æ—çš„å…´è¶£ã€‚ä»¥è‡³åæ¥æ¢¦ä¸­è§åˆ°ä¸€æœ›æ— é™…çš„æˆˆå£æ»©ï¼Œè®©è‡ªå·±ä¸‹å®šå†³å¿ƒåšå‡ºæ”¹å˜ã€‚\nèƒŒæ™¯ è¿™æ¬¡åŒ—ç–†ä¹‹è¡Œå‡†å¤‡ä»“ä¿ƒï¼Œä»è·¯çº¿æ–¹æ¡ˆåˆ°å¯»æ‰¾åŒä¼´ï¼Œéƒ½æ˜¯å‡ºå‘å‰ä¸€å‘¨æå®šçš„ã€‚\nåŒä¼´æ‰¾çš„æ˜¯äº‘åŸç”Ÿç¤¾åŒºçš„ å®‹å‡€è¶… Jimmyï¼ŒåŒæ ·ä¹Ÿæ˜¯è€ä¹¡ï¼ˆä¸¤äººåœ¨å¤–æ¼‚å¤šå¹´ï¼Œæ²Ÿé€šå…¨æ˜¯æ™®é€šè¯ã€‚ã€‚ã€‚ï¼‰ï¼Œä»–ä»åŒ—äº¬å‡ºå‘ã€‚ç”±äºä»–çš„å·¥ä½œæ€§è´¨ç‰¹åˆ«\u0026ndash;è¿œç¨‹å·¥ä½œï¼Œæ‰€ä»¥å½“åˆä¸´æ—¶æ‰¾åŒä¼´çš„æ—¶å€™æƒ³åˆ°äº†ä»–ï¼Œè€Œä¸”è¿˜ä¹Ÿåœ¨æœ‰é©¾ç…§åœ¨æ‰‹ã€‚ä¹Ÿç”±äºä»–éœ€è¦è¿œç¨‹å·¥ä½œï¼Œè¿™æ¬¡æˆ‘ä»¬é€‰æ‹©äº†æˆ¿è½¦è‡ªé©¾ï¼Œæ­£å¥½æœ¬äººä¹Ÿæƒ³ä½“éªŒä¸€ä¸‹æˆ¿è½¦ã€‚\nè·¯ä¹¦å‘åœ¨äº†è¿™é‡Œï¼Œå…¨ç¨‹ 2800km+ã€‚\nå»ºè®® å…ˆè¯´æ€»ç»“ï¼Œå‡å¦‚è¦ä½ è·Ÿæˆ‘èµ°åŒæ ·çš„è·¯çº¿è€Œä¸”å–œæ¬¢é©¾é©¶ï¼Œä¸å»ºè®®æˆ¿è½¦ï¼ˆä¸‰å›´å¤ªå¤§ï¼‰ã€‚ç†ç”±ï¼š\nå±±è·¯å¤šï¼Œå„ç§çš„å¼¯è·¯ï¼Œè€Œä¸”è·¯çš„ä¸€ä¾§å°±æ˜¯æ‚¬å´–ï¼ˆæˆ‘å¥½åƒè¿˜æ‹è¿‡ä¸€æ®µ 25 åˆ†é’Ÿçš„è§†é¢‘ï¼‰ æ˜­è‹åˆ°ç¼åº“ä»€å°ä¸€æ®µçš„å±±è·¯ï¼Œå¾ˆçª„ï¼ è½¦å¤ªé‡ï¼Œçˆ¬å¡éå¸¸æ…¢ï¼Œå¡å¤ªå¤šï¼ è½¦é«˜é‡å¿ƒé«˜ï¼Œæˆˆå£ä¸Šé«˜é€Ÿå…¬è·¯æ¨ªé£æœ‰æ—¶æ¯”è¾ƒå¼ºï¼Œè½¦å­æ™ƒåŠ¨å‰å®³ï¼ˆå°¤å…¶æ˜¯åé²ç•ªè‡³ä¹Œé²æœ¨é½çš„é£ç”µåŒºåŸŸï¼‰ï¼›å³ä½¿æ²¡æœ‰æ¨ªé£ï¼Œåœ¨è¶…å¤§è´§è½¦çš„æ—¶å€™ä¹Ÿä¼šæœ‰åŒæ ·çš„æ„Ÿè§‰ æˆ¿è½¦çš„å±…ä½ä½“éªŒè¿˜æ˜¯ä¸é”™çš„ï¼ˆäººå¤šä¸ä¸€å®šï¼‰ï¼Œéšåœéšä½ã€‚\næˆ‘çš„ç†æƒ³æ–¹æ¡ˆï¼ˆä¸‹æ¬¡è€ƒè™‘è¿™ä¹ˆæ¥ï¼‰ï¼š\néæˆ¿è½¦ è¿™æ¬¡çš„è·¯çº¿ï¼Œå•†ä¸šåŒ–è¿¹è±¡å¾ˆæ˜æ˜¾ï¼Œå°¤å…¶æ˜¯ç‹¬åº“å…¬è·¯é‚£æ¡çº¿ã€‚æ²¡æœ‰æˆ¿è½¦ï¼Œåƒä½ä¹Ÿä¸éœ€è¦æ‹…å¿ƒã€‚\nåƒï¼šé¦–é€‰ç‰§æ°‘å®¶ï¼Œä½“éªŒæœ€å¥½ï¼›å†å°±æ˜¯å„ç§é¤é¦†ï¼Œåªè¦æ˜¯æœ¬åœ°äººå¼€çš„ï¼Œéƒ½ä¸ä¼šå·®ï¼›è‡ªå·±åšï¼Ÿï¼ˆè¿™æ¬¡å¸¦äº†ç¶å…·ï¼Œä¸€æ¬¡æ²¡åšè¿‡ï¼‰ ä½ï¼šé…’åº— \u0026gt; ç‰§æ°‘è’™å¤åŒ…ï¼ˆå•†ä¸šæ€§çš„ï¼‰ \u0026gt; è‡ªå¸¦å¸ç¯·ï¼ˆåº”æ€¥+ä½“éªŒï¼‰ ä¸å¼€æˆ¿è½¦ï¼Œä¼Šæ˜­ã€ç‹¬åº“å…¬è·¯å’Œå…¶ä»–çš„å±±è·¯éƒ½ä¼šè½»æ¾ï¼Œä½“éªŒæ›´å¥½ã€‚å‡å¦‚æ˜¯ SUVï¼Œåº•ç›˜é«˜ä¹Ÿæ–¹ä¾¿æ·±å…¥è‰åŸã€‚æ³¨æ„ï¼Œä¸ºäº†ä¿æŠ¤è‰åŸç‰§æ°‘çš„æ“åœºè½¦è¾†ä¸èƒ½éšä¾¿è¿›ã€‚å¯ä»¥å¤šé—®ä¸‹ç‰§æ°‘ï¼Œä»˜è´¹åƒä½çš„è¯åº”è¯¥æ²¡é—®é¢˜ã€‚\næˆ¿è½¦ æˆ¿è½¦é€‚åˆå®¿åœ¨è‰åŸã€‚å‡å¦‚ï¼ŒçœŸæƒ³ä½“éªŒæˆ¿è½¦ï¼Œæˆ‘çš„å»ºè®®å°±æ˜¯ï¼šä¹Œé²æœ¨é½é£ä¼Šå®ç§Ÿè½¦ï¼Œç›´å¥”ç¼åº“ä»€å°æ‘ï¼ˆè¿™æ®µå±±è·¯å®åœ¨é¿ä¸å¼€ï¼‰ã€‚çœ‹è¿‡ç¼åº“ä»€å°çš„åŸç”Ÿæ€è‰åŸï¼Œå…¶ä»–çš„è‰åŸä¹Ÿå°±æ²¡äº†å…´è¶£ã€‚åœ¨é‚£é‡Œå®‰é™ä½å‡ å¤©ï¼Œéª‘éª‘é©¬ã€‚\nè¡Œç¨‹ æœ¬æ¥æƒ³å†™å†™çš„ï¼Œæœ‰ç‚¹å¤šæ— ä»ä¸‹æ‰‹ï¼Œçœ‹è·¯ä¹¦å‡‘åˆä¸‹å§ã€‚å…ˆæ”¾ä¸Šåˆ—è¡¨ï¼Œæœ‰æ—¶é—´æˆ‘å†å®Œå–„ã€‚\nDay01 å¹¿å· - ä¹Œé²æœ¨é½ Day02 ä¹Œé²æœ¨é½ - èµ›é‡Œæœ¨æ¹– Day03 èµ›é‡Œæœ¨æ¹– - æ˜­è‹è‰åŸ Day04 æ˜­è‹è‰åŸ - ç¼åº“ä»€å°æ‘ Day05 ç¼åº“ä»€å°æ‘ - é‚£æ‹‰ææ™¯åŒº Day06 é‚£æ‹‰æ - ç‹¬åº“å…¬è·¯å—æ®µ - åº“è½¦å¸‚ Day07 åº“è½¦å¸‚ - å’Œç¡•å¿ Day08 å’Œç¡•å¿ - åé²ç•ªå¸‚ - ä¹Œé²æœ¨é½ è§†é¢‘ Jimmy å‰ªè¾‘çš„è§†é¢‘ ç‹¬åº“å…¬è·¯ï¼ˆæœ‰ç‚¹æ¯ç‡¥ï¼Œæƒ³çœ‹çš„å•ç‹¬æ‰¾æˆ‘è¦å§ï¼‰ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/2021-xinjiang-trip/","tags":["æ—…è¡Œ","è‡ªé©¾"],"title":"æ¸¸è®° - 2021 åŒ—ç–†ä¹‹è¡Œ"},{"categories":["ç¿»è¯‘"],"contents":"æœ‰åˆ«äºå‰äº›å¤©çš„æ–‡ç«  - å¸¸ç”¨çš„å‡ æ¬¾å·¥å…·è®© Kubernetes é›†ç¾¤ä¸Šçš„å·¥ä½œæ›´å®¹æ˜“ åé‡äºå·¥å…·ç±»æ¥æå‡å·¥ä½œæ•ˆç‡ï¼Œä»Šå¤©è¿™ç¯‡æ–‡ç« æ›´åŠ é€‚åˆç”¨æ¥åšé€‰å‹æ—¶çš„å‚è€ƒã€‚\næ–‡æ¡£ç¿»è¯‘è‡ª Kubernetes Essential Tools: 2021ï¼Œç¯‡å¹…è¾ƒé•¿ï¼Œåšäº†éƒ¨åˆ†å¢åˆ ã€‚\nä»‹ç» åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å°è¯•æ€»ç»“æˆ‘æœ€å–œæ¬¢çš„ Kubernetes å·¥å…·ï¼Œå¹¶ç‰¹åˆ«å¼ºè°ƒæœ€æ–°çš„å’Œé²œä¸ºäººçŸ¥ä½†æˆ‘è®¤ä¸ºä¼šéå¸¸æµè¡Œçš„å·¥å…·ã€‚\nè¿™åªæ˜¯æˆ‘æ ¹æ®æˆ‘çš„ç»éªŒå¾—å‡ºçš„ä¸ªäººæ¸…å•ï¼Œä½†ä¸ºäº†é¿å…åè§ï¼Œæˆ‘è¿˜å°†å°è¯•æåŠæ¯ç§å·¥å…·çš„æ›¿ä»£æ–¹æ¡ˆï¼Œä»¥ä¾¿ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è¿›è¡Œæ¯”è¾ƒå’Œå†³å®šã€‚æˆ‘å°†å°½å¯èƒ½ç¼©çŸ­è¿™ç¯‡æ–‡ç« å¹¶æä¾›é“¾æ¥ï¼Œä»¥ä¾¿ä½ å¯ä»¥è‡ªè¡Œæ¢ç´¢æ›´å¤šå†…å®¹ã€‚æˆ‘çš„ç›®æ ‡æ˜¯å›ç­”è¿™ä¸ªé—®é¢˜ï¼šâ€œæˆ‘å¦‚ä½•åœ¨ Kubernetes ä¸­åš Xï¼Ÿâ€ é€šè¿‡æè¿°ä¸åŒè½¯ä»¶å¼€å‘ä»»åŠ¡çš„å·¥å…·ã€‚\nK3D K3D æ˜¯æˆ‘æœ€å–œæ¬¢çš„åœ¨ç¬”è®°æœ¬ç”µè„‘ä¸Šè¿è¡Œ Kubernetes (K8s) é›†ç¾¤çš„æ–¹å¼ã€‚å®ƒéå¸¸è½»å·§ä¸”é€Ÿåº¦éå¸¸å¿«ã€‚å®ƒæ˜¯ä½¿ç”¨ Docker å›´ç»• K3S çš„åŒ…è£…å™¨ã€‚æ‰€ä»¥ï¼Œä½ åªéœ€è¦ Docker æ¥è¿è¡Œå®ƒå¹¶ä¸”èµ„æºä½¿ç”¨ç‡éå¸¸ä½ã€‚å”¯ä¸€çš„é—®é¢˜æ˜¯å®ƒä¸å®Œå…¨ç¬¦åˆ K8s æ ‡å‡†ï¼Œä½†è¿™ä¸åº”è¯¥æ˜¯æœ¬åœ°å¼€å‘çš„é—®é¢˜ã€‚å¯¹äºæµ‹è¯•ç¯å¢ƒï¼Œä½ å¯ä»¥ä½¿ç”¨å…¶ä»–è§£å†³æ–¹æ¡ˆã€‚K3D æ¯” Kind å¿«ï¼Œä½† Kind å®Œå…¨å…¼å®¹ã€‚\nå¤‡é€‰ K3SÂ ç‰©è”ç½‘æˆ–è€…è¾¹ç¼˜è®¡ç®— Kind å®Œå…¨å…¼å®¹ Kubernetes çš„å¤‡é€‰ MicroK8s MiniKube Krew Krew æ˜¯ç®¡ç†çš„å¿…å¤‡å·¥å…· Kubectl æ’ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¿…é¡»æœ‰ä»»ä½• K8S ç”¨æˆ·ã€‚æˆ‘ä¸ä¼šè¯¦ç»†ä»‹ç»è¶…è¿‡ 145 ä¸ªå¯ç”¨æ’ä»¶ï¼Œä½†è‡³å°‘å®‰è£… kubens å’Œ kubectxã€‚\nLens Lens æ˜¯é€‚ç”¨äº SREã€Ops å’Œå¼€å‘äººå‘˜çš„ K8s IDEã€‚å®ƒé€‚ç”¨äºä»»ä½• Kubernetes å‘è¡Œç‰ˆï¼šæœ¬åœ°æˆ–äº‘ç«¯ã€‚å®ƒå¿«é€Ÿã€æ˜“äºä½¿ç”¨å¹¶æä¾›å®æ—¶å¯è§‚å¯Ÿæ€§ã€‚ä½¿ç”¨ Lens å¯ä»¥éå¸¸è½»æ¾åœ°ç®¡ç†å¤šä¸ªé›†ç¾¤ã€‚å¦‚æœä½ æ˜¯é›†ç¾¤æ“ä½œå‘˜ï¼Œè¿™æ˜¯å¿…é¡»çš„ã€‚\nå¤‡é€‰ å¯¹äºé‚£äº›å–œæ¬¢è½»é‡çº§ç»ˆç«¯æ›¿ä»£å“çš„äººæ¥è¯´ï¼ŒK9s æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚K9s ä¼šæŒç»­è§‚å¯Ÿ Kubernetes çš„å˜åŒ–ï¼Œå¹¶æä¾›åç»­å‘½ä»¤æ¥ä¸ä½ è§‚å¯Ÿåˆ°çš„èµ„æºè¿›è¡Œäº¤äº’ã€‚ Helm Helm ä¸éœ€è¦ä»‹ç»ï¼Œå®ƒæ˜¯ Kubernetes æœ€è‘—åçš„åŒ…ç®¡ç†å™¨ã€‚ä½ åº”è¯¥åœ¨ K8s ä¸­ä½¿ç”¨åŒ…ç®¡ç†å™¨ï¼Œå°±åƒåœ¨ç¼–ç¨‹è¯­è¨€ä¸­ä½¿ç”¨å®ƒä¸€æ ·ã€‚Helm å…è®¸ä½ å°†åº”ç”¨ç¨‹åºæ‰“åŒ…åˆ° Charts ä¸­ï¼Œå°†å¤æ‚çš„åº”ç”¨ç¨‹åºæŠ½è±¡ä¸ºæ˜“äºå®šä¹‰ã€å®‰è£…å’Œæ›´æ–°çš„å¯é‡ç”¨ç®€å•ç»„ä»¶ã€‚\nå®ƒè¿˜æä¾›äº†å¼ºå¤§çš„æ¨¡æ¿å¼•æ“ã€‚Helm å¾ˆæˆç†Ÿï¼Œæœ‰å¾ˆå¤šé¢„å®šä¹‰çš„ chartsï¼Œå¾ˆå¥½çš„æ”¯æŒï¼Œè€Œä¸”å¾ˆå®¹æ˜“ä½¿ç”¨ã€‚\nå¤‡é€‰ Kustomize æ˜¯ helm çš„ä¸€ä¸ªæ›´æ–°å’Œä¼Ÿå¤§çš„æ›¿ä»£å“ï¼Œå®ƒä¸ä½¿ç”¨æ¨¡æ¿å¼•æ“ï¼Œè€Œæ˜¯ä¸€ä¸ªè¦†ç›–å¼•æ“ï¼Œåœ¨å…¶ä¸­ä½ æœ‰åŸºæœ¬çš„å®šä¹‰å’Œè¦†ç›–åœ¨å®ƒä»¬ä¹‹ä¸Šã€‚ ArgoCD æˆ‘ç›¸ä¿¡ GitOps æ˜¯è¿‡å»åå¹´ä¸­æœ€å¥½çš„æƒ³æ³•ä¹‹ä¸€ã€‚åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨å•ä¸€çš„äº‹å®æ¥æºæ¥è·Ÿè¸ªæ„å»ºè½¯ä»¶æ‰€éœ€çš„æ‰€æœ‰ç§»åŠ¨éƒ¨åˆ†ï¼Œè€Œ Git æ˜¯åšåˆ°è¿™ä¸€ç‚¹çš„å®Œç¾å·¥å…·ã€‚æˆ‘ä»¬çš„æƒ³æ³•æ˜¯æ‹¥æœ‰ä¸€ä¸ª Git å­˜å‚¨åº“ï¼Œå…¶ä¸­åŒ…å«åº”ç”¨ç¨‹åºä»£ç ä»¥åŠè¡¨ç¤ºæ‰€éœ€ç”Ÿäº§ç¯å¢ƒçŠ¶æ€çš„åŸºç¡€è®¾æ–½ (IaC) çš„å£°æ˜æ€§æè¿°ï¼›ä»¥åŠä½¿æ‰€éœ€ç¯å¢ƒä¸å­˜å‚¨åº“ä¸­æè¿°çš„çŠ¶æ€ç›¸åŒ¹é…çš„è‡ªåŠ¨åŒ–è¿‡ç¨‹ã€‚\nGitOps: versioned CI/CD on top of declarative infrastructure. Stop scripting and start shipping.\nâ€” Kelsey Hightower\nå°½ç®¡ä½¿ç”¨ Terraform æˆ–ç±»ä¼¼å·¥å…·ï¼Œä½ å¯ä»¥å®ç°åŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆIaCï¼‰ï¼Œä½†è¿™è¿˜ä¸è¶³ä»¥å°†ä½ åœ¨ Git ä¸­çš„æ‰€éœ€çŠ¶æ€ä¸ç”Ÿäº§åŒæ­¥ã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥æŒç»­ç›‘æ§ç¯å¢ƒå¹¶ç¡®ä¿æ²¡æœ‰é…ç½®æ¼‚ç§»ã€‚ä½¿ç”¨ Terraformï¼Œä½ å°†ä¸å¾—ä¸ç¼–å†™è„šæœ¬æ¥è¿è¡Œterraform applyå¹¶æ£€æŸ¥çŠ¶æ€æ˜¯å¦ä¸ Terraform çŠ¶æ€åŒ¹é…ï¼Œä½†è¿™æ—¢ä¹å‘³åˆéš¾ä»¥ç»´æŠ¤ã€‚\nKubernetes ä»å¤´å¼€å§‹â€‹â€‹æ„å»ºæ§åˆ¶å¾ªç¯çš„æ€æƒ³ï¼Œè¿™æ„å‘³ç€ Kubernetes ä¸€ç›´åœ¨ç›‘è§†é›†ç¾¤çš„çŠ¶æ€ä»¥ç¡®ä¿å®ƒä¸æ‰€éœ€çš„çŠ¶æ€åŒ¹é…ï¼Œä¾‹å¦‚ï¼Œè¿è¡Œçš„å‰¯æœ¬æ•°é‡ä¸æ‰€éœ€çš„æ•°é‡ç›¸åŒ¹é…å¤åˆ¶å“ã€‚GitOps çš„æƒ³æ³•æ˜¯å°†å…¶æ‰©å±•åˆ°åº”ç”¨ç¨‹åºï¼Œå› æ­¤ä½ å¯ä»¥å°†ä½ çš„æœåŠ¡å®šä¹‰ä¸ºä»£ç ï¼Œä¾‹å¦‚ï¼Œé€šè¿‡å®šä¹‰ Helm Chartsï¼Œå¹¶ä½¿ç”¨åˆ©ç”¨ K8s åŠŸèƒ½çš„å·¥å…·æ¥ç›‘æ§ä½ çš„åº”ç”¨ç¨‹åºçš„çŠ¶æ€å¹¶ç›¸åº”åœ°è°ƒæ•´é›†ç¾¤ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ›´æ–°ä½ çš„ä»£ç å­˜å‚¨åº“æˆ–Helm Chartï¼Œç”Ÿäº§é›†ç¾¤ä¹Ÿä¼šæ›´æ–°ã€‚è¿™æ˜¯çœŸæ­£çš„æŒç»­éƒ¨ç½²ã€‚æ ¸å¿ƒåŸåˆ™æ˜¯åº”ç”¨ç¨‹åºéƒ¨ç½²å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†åº”è¯¥è‡ªåŠ¨åŒ–ã€å¯å®¡è®¡ä¸”æ˜“äºç†è§£ã€‚\nå¯¹æˆ‘æ¥è¯´ï¼Œè¿™ä¸ªæƒ³æ³•æ˜¯é©å‘½æ€§çš„ï¼Œå¦‚æœåšå¾—å¥½ï¼Œå°†ä½¿ç»„ç»‡èƒ½å¤Ÿæ›´å¤šåœ°å…³æ³¨åŠŸèƒ½ï¼Œè€Œä¸æ˜¯ç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬ã€‚è¿™ä¸ªæ¦‚å¿µå¯ä»¥æ‰©å±•åˆ°è½¯ä»¶å¼€å‘çš„å…¶ä»–é¢†åŸŸï¼Œä¾‹å¦‚ï¼Œä½ å¯ä»¥å°†æ–‡æ¡£å­˜å‚¨åœ¨ä»£ç ä¸­ä»¥è·Ÿè¸ªæ›´æ”¹çš„å†å²å¹¶ç¡®ä¿æ–‡æ¡£æ˜¯æœ€æ–°çš„ï¼›æˆ–ä½¿ç”¨ADRè·Ÿè¸ªæ¶æ„å†³ç­–ã€‚\nåœ¨æˆ‘çœ‹æ¥ï¼Œåœ¨æœ€å¥½çš„ GitOps å·¥å…· Kubernetes æ˜¯ ArgoCDã€‚ä½ å¯ä»¥åœ¨æ­¤å¤„é˜…è¯»æ›´å¤šä¿¡æ¯ã€‚ArgoCD æ˜¯ Argo ç”Ÿæ€ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€äº›å…¶ä»–å¾ˆæ£’çš„å·¥å…·ï¼Œå…¶ä¸­ä¸€äº›æˆ‘ä»¬å°†åœ¨ç¨åè®¨è®ºã€‚\nä½¿ç”¨ ArgoCDï¼Œä½ å¯ä»¥åœ¨ä»£ç å­˜å‚¨åº“ä¸­æ‹¥æœ‰æ¯ä¸ªç¯å¢ƒï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­å®šä¹‰è¯¥ç¯å¢ƒçš„æ‰€æœ‰é…ç½®ã€‚Argo CD åœ¨æŒ‡å®šçš„ç›®æ ‡ç¯å¢ƒä¸­è‡ªåŠ¨éƒ¨ç½²æ‰€éœ€çš„åº”ç”¨ç¨‹åºçŠ¶æ€ã€‚\nArgoCD è¢«å®ç°ä¸ºä¸€ä¸ª kubernetes æ§åˆ¶å™¨ï¼Œå®ƒæŒç»­ç›‘æ§æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºå¹¶å°†å½“å‰çš„å®æ—¶çŠ¶æ€ä¸æ‰€éœ€çš„ç›®æ ‡çŠ¶æ€ï¼ˆå¦‚ Git å­˜å‚¨åº“ä¸­æŒ‡å®šçš„ï¼‰è¿›è¡Œæ¯”è¾ƒã€‚ArgoCD æŠ¥å‘Šå¹¶å¯è§†åŒ–å·®å¼‚ï¼Œå¹¶ä¸”å¯ä»¥è‡ªåŠ¨æˆ–æ‰‹åŠ¨å°†å®æ—¶çŠ¶æ€åŒæ­¥å›æ‰€éœ€çš„ç›®æ ‡çŠ¶æ€ã€‚\nå¤‡é€‰ Flux åˆšåˆšå‘å¸ƒäº†ä¸€ä¸ªå…·æœ‰è®¸å¤šæ”¹è¿›çš„æ–°ç‰ˆæœ¬ã€‚å®ƒæä¾›äº†éå¸¸ç›¸ä¼¼çš„åŠŸèƒ½ã€‚ Argo å·¥ä½œæµï¼ˆWorkflowsï¼‰å’Œ Argo äº‹ä»¶ï¼ˆEventsï¼‰ åœ¨ Kubernetes ä¸­ï¼Œä½ å¯èƒ½è¿˜éœ€è¦è¿è¡Œæ‰¹å¤„ç†ä½œä¸šæˆ–å¤æ‚çš„å·¥ä½œæµã€‚è¿™å¯èƒ½æ˜¯ä½ çš„æ•°æ®ç®¡é“ã€å¼‚æ­¥æµç¨‹ç”šè‡³ CI/CD çš„ä¸€éƒ¨åˆ†ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œä½ ç”šè‡³å¯èƒ½éœ€è¦è¿è¡Œå¯¹æŸäº›äº‹ä»¶åšå‡ºååº”çš„é©±åŠ¨å¾®æœåŠ¡ï¼Œä¾‹å¦‚æ–‡ä»¶ä¸Šä¼ æˆ–æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—ã€‚å¯¹äºæ‰€æœ‰è¿™äº›ï¼Œæˆ‘ä»¬æœ‰ Argo Workflows å’Œ Argo Eventsã€‚\nå°½ç®¡å®ƒä»¬æ˜¯ç‹¬ç«‹çš„é¡¹ç›®ï¼Œä½†å®ƒä»¬å¾€å¾€ä¼šè¢«éƒ¨ç½²åœ¨ä¸€èµ·ã€‚\nArgo Workflows æ˜¯ä¸€ä¸ªç±»ä¼¼äº Apache Airflow çš„ç¼–æ’å¼•æ“ï¼Œä½†å®ƒæ˜¯ Kubernetes åŸç”Ÿçš„ã€‚å®ƒä½¿ç”¨è‡ªå®šä¹‰ CRD æ¥å®šä¹‰å¤æ‚çš„å·¥ä½œæµç¨‹ï¼Œä½¿ç”¨ YAML çš„æ­¥éª¤æˆ– DAGï¼Œè¿™åœ¨ K8s ä¸­æ„Ÿè§‰æ›´è‡ªç„¶ã€‚å®ƒæœ‰ä¸€ä¸ªæ¼‚äº®çš„ UIã€é‡è¯•æœºåˆ¶ã€åŸºäº cron çš„ä½œä¸šã€è¾“å…¥å’Œè¾“å‡ºè·Ÿè¸ªç­‰ç­‰ã€‚ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥ç¼–æ’æ•°æ®ç®¡é“ã€æ‰¹å¤„ç†ä½œä¸šç­‰ç­‰ã€‚\næœ‰æ—¶ï¼Œä½ å¯èƒ½å¸Œæœ›å°†ç®¡é“ä¸å¼‚æ­¥æœåŠ¡ï¼ˆå¦‚ Kafka ç­‰æµå¼•æ“ã€é˜Ÿåˆ—ã€webhooks æˆ–æ·±åº¦å­˜å‚¨æœåŠ¡ï¼‰é›†æˆã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½æƒ³è¦å¯¹ä¸Šä¼ åˆ° S3 çš„æ–‡ä»¶ç­‰äº‹ä»¶åšå‡ºååº”ã€‚ä¸ºæ­¤ï¼Œä½ å°†ä½¿ç”¨ Argo äº‹ä»¶ï¼ˆEventï¼‰ã€‚\nè¿™ä¸¤ä¸ªå·¥å…·ç»„åˆä¸ºä½ çš„æ‰€æœ‰ç®¡é“éœ€æ±‚æä¾›äº†ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ CI/CD ç®¡é“ï¼Œå®ƒå…è®¸ä½ åœ¨ Kubernetes ä¸­æœ¬åœ°è¿è¡Œ CI/CD ç®¡é“ã€‚\nå¤‡é€‰ å¯¹äº ML ç®¡é“ï¼Œä½ å¯ä»¥ä½¿ç”¨ Kubeflowã€‚ å¯¹äº CI/CD ç®¡é“ï¼Œä½ å¯ä»¥ä½¿ç”¨ Tektonã€‚ Kaniko æˆ‘ä»¬åˆšåˆšçœ‹åˆ°äº†å¦‚ä½•ä½¿ç”¨ Argo Workflows è¿è¡Œ Kubernetes åŸç”Ÿ CI/CD ç®¡é“ã€‚ä¸€ä¸ªå¸¸è§çš„ä»»åŠ¡æ˜¯æ„å»º Docker é•œåƒï¼Œè¿™åœ¨ Kubernetes ä¸­é€šå¸¸æ˜¯ä¹å‘³çš„ï¼Œå› ä¸ºæ„å»ºè¿‡ç¨‹å®é™…ä¸Šæ˜¯åœ¨å®¹å™¨æœ¬èº«ä¸Šè¿è¡Œçš„ï¼Œä½ éœ€è¦ä½¿ç”¨å˜é€šæ–¹æ³•æ¥ä½¿ç”¨ä¸»æœºçš„ Docker å¼•æ“ã€‚\nåº•çº¿æ˜¯ä½ ä¸åº”è¯¥ä½¿ç”¨ Docker æ¥æ„å»ºä½ çš„é•œåƒï¼šæ”¹ç”¨ Kanicoã€‚Kaniko ä¸ä¾èµ–äº Docker å®ˆæŠ¤è¿›ç¨‹ï¼Œè€Œæ˜¯å®Œå…¨åœ¨ç”¨æˆ·ç©ºé—´ä¸­æ‰§è¡Œ Dockerfile ä¸­çš„æ¯ä¸ªå‘½ä»¤ã€‚è¿™ä½¿å¾—åœ¨æ— æ³•è½»æ¾æˆ–å®‰å…¨åœ°è¿è¡Œ Docker å®ˆæŠ¤ç¨‹åºçš„ç¯å¢ƒä¸­æ„å»ºå®¹å™¨é•œåƒæˆä¸ºå¯èƒ½ï¼Œä¾‹å¦‚æ ‡å‡†çš„ Kubernetes é›†ç¾¤ã€‚è¿™æ¶ˆé™¤äº†åœ¨ K8s é›†ç¾¤ä¸­æ„å»ºé•œåƒçš„æ‰€æœ‰é—®é¢˜ã€‚\nIstio Istio æ˜¯å¸‚åœºä¸Šæœ€è‘—åçš„æœåŠ¡ç½‘æ ¼ï¼Œå®ƒæ˜¯å¼€æºçš„å¹¶ä¸”éå¸¸å—æ¬¢è¿ã€‚æˆ‘ä¸ä¼šè¯¦ç»†ä»‹ç»ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå·¨å¤§çš„è¯é¢˜ï¼Œä½†æ˜¯å¦‚æœä½ æ­£åœ¨æ„å»ºå¾®æœåŠ¡ï¼Œå¹¶ä¸”å¯èƒ½åº”è¯¥è¿™æ ·åšï¼Œé‚£ä¹ˆä½ å°†éœ€è¦ä¸€ä¸ªæœåŠ¡ç½‘æ ¼æ¥ç®¡ç†é€šä¿¡ã€å¯è§‚å¯Ÿæ€§ã€é”™è¯¯å¤„ç†ã€å®‰å…¨æ€§ã€‚ä¸å…¶ç”¨é‡å¤çš„é€»è¾‘æ±¡æŸ“æ¯ä¸ªå¾®æœåŠ¡çš„ä»£ç ï¼ˆè¯‘è€…ï¼šSDK ä¾µå…¥ï¼‰ï¼Œä¸å¦‚åˆ©ç”¨æœåŠ¡ç½‘æ ¼ä¸ºä½ åšè¿™ä»¶äº‹ã€‚\nç®€è€Œè¨€ä¹‹ï¼ŒæœåŠ¡ç½‘æ ¼æ˜¯ä¸€ä¸ªä¸“ç”¨çš„åŸºç¡€è®¾æ–½å±‚ï¼Œä½ å¯ä»¥å°†å…¶æ·»åŠ åˆ°ä½ çš„åº”ç”¨ç¨‹åºä¸­ã€‚å®ƒå…è®¸ä½ é€æ˜åœ°æ·»åŠ å¯è§‚å¯Ÿæ€§ã€æµé‡ç®¡ç†å’Œå®‰å…¨æ€§ç­‰åŠŸèƒ½ï¼Œè€Œæ— éœ€å°†å®ƒä»¬æ·»åŠ åˆ°ä½ è‡ªå·±çš„ä»£ç ä¸­ã€‚\nå¦‚æœ Istio ç”¨äºè¿è¡Œå¾®æœåŠ¡ï¼Œå°½ç®¡ä½ å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œ Istio å¹¶ä½¿ç”¨å¾®æœåŠ¡ï¼Œä½† Kubernetes å·²è¢«ä¸€æ¬¡åˆä¸€æ¬¡åœ°è¯æ˜æ˜¯è¿è¡Œå®ƒä»¬çš„æœ€ä½³å¹³å°ã€‚Istio è¿˜å¯ä»¥å°†ä½ çš„ K8s é›†ç¾¤æ‰©å±•åˆ°å…¶ä»–æœåŠ¡ï¼Œä¾‹å¦‚ VMï¼Œå…è®¸ä½ æ‹¥æœ‰åœ¨è¿ç§»åˆ° Kubernetes æ—¶éå¸¸æœ‰ç”¨çš„æ··åˆç¯å¢ƒã€‚\nå¤‡é€‰ Linkerd æ˜¯ä¸€ç§æ›´è½»å·§ä¸”å¯èƒ½æ›´å¿«çš„æœåŠ¡ç½‘æ ¼ã€‚Linkerd ä»å¤´å¼€å§‹â€‹â€‹ä¸ºå®‰å…¨æ€§è€Œæ„å»ºï¼ŒåŒ…æ‹¬é»˜è®¤ mTLSã€ä½¿ç”¨ Rust æ„å»ºçš„æ•°æ®å¹³é¢ã€å†…å­˜å®‰å…¨è¯­è¨€å’Œå®šæœŸå®‰å…¨å®¡è®¡ç­‰åŠŸèƒ½ Consul æ˜¯ä¸ºä»»ä½•è¿è¡Œæ—¶å’Œäº‘æä¾›å•†æ„å»ºçš„æœåŠ¡ç½‘æ ¼ï¼Œå› æ­¤å®ƒéå¸¸é€‚åˆè·¨ K8s å’Œäº‘æä¾›å•†çš„æ··åˆéƒ¨ç½²ã€‚å¦‚æœä¸æ˜¯æ‰€æœ‰çš„å·¥ä½œè´Ÿè½½éƒ½åœ¨ Kubernetes ä¸Šè¿è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ Argo Rollouts æˆ‘ä»¬å·²ç»æåˆ°ï¼Œä½ å¯ä»¥ä½¿ç”¨ Kubernetes ä½¿ç”¨ Argo Workflows æˆ–ä½¿ç”¨ Kanico æ„å»ºå›¾åƒçš„ç±»ä¼¼å·¥å…·æ¥è¿è¡Œ CI/CD ç®¡é“ã€‚ä¸‹ä¸€ä¸ªåˆä¹é€»è¾‘çš„æ­¥éª¤æ˜¯ç»§ç»­å¹¶è¿›è¡ŒæŒç»­éƒ¨ç½²ã€‚ç”±äºæ¶‰åŠé«˜é£é™©ï¼Œè¿™åœ¨çœŸå®åœºæ™¯ä¸­æ˜¯æå…·æŒ‘æˆ˜æ€§çš„ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•°å…¬å¸åªåšæŒç»­äº¤ä»˜ï¼Œè¿™æ„å‘³ç€ä»–ä»¬å·²ç»å®ç°äº†è‡ªåŠ¨åŒ–ï¼Œä½†ä»–ä»¬ä»ç„¶éœ€è¦æ‰‹åŠ¨æ‰¹å‡†å’ŒéªŒè¯ï¼Œè¿™ä¸ªæ‰‹åŠ¨æ­¥éª¤æ˜¯è¿™æ˜¯å› ä¸ºå›¢é˜Ÿä¸èƒ½å®Œå…¨ä¿¡ä»»ä»–ä»¬çš„è‡ªåŠ¨åŒ–ã€‚\né‚£ä¹ˆï¼Œä½ å¦‚ä½•å»ºç«‹è¿™ç§ä¿¡ä»»ä»¥æ‘†è„±æ‰€æœ‰è„šæœ¬å¹¶å®Œå…¨è‡ªåŠ¨åŒ–ä»æºä»£ç åˆ°ç”Ÿäº§çš„æ‰€æœ‰å†…å®¹ï¼Ÿç­”æ¡ˆæ˜¯ï¼šå¯è§‚å¯Ÿæ€§ã€‚ä½ éœ€è¦å°†èµ„æºæ›´å¤šåœ°é›†ä¸­åœ¨æŒ‡æ ‡ä¸Šï¼Œå¹¶æ”¶é›†å‡†ç¡®è¡¨ç¤ºåº”ç”¨ç¨‹åºçŠ¶æ€æ‰€éœ€çš„æ‰€æœ‰æ•°æ®ã€‚ç›®æ ‡æ˜¯ä½¿ç”¨ä¸€ç»„æŒ‡æ ‡æ¥å»ºç«‹è¿™ç§ä¿¡ä»»ã€‚å¦‚æœä½ åœ¨ Prometheus ä¸­æ‹¥æœ‰æ‰€æœ‰æ•°æ®ï¼Œé‚£ä¹ˆä½ å¯ä»¥è‡ªåŠ¨éƒ¨ç½²ï¼Œå› ä¸ºä½ å¯ä»¥æ ¹æ®è¿™äº›æŒ‡æ ‡è‡ªåŠ¨é€æ­¥æ¨å‡ºåº”ç”¨ç¨‹åºã€‚\nç®€è€Œè¨€ä¹‹ï¼Œä½ éœ€è¦æ¯” K8s å¼€ç®±å³ç”¨çš„æ»šåŠ¨æ›´æ–°æ›´é«˜çº§çš„éƒ¨ç½²æŠ€æœ¯ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨é‡‘ä¸é›€éƒ¨ç½²è¿›è¡Œæ¸è¿›å¼äº¤ä»˜ã€‚ç›®æ ‡æ˜¯é€æ­¥å°†æµé‡è·¯ç”±åˆ°åº”ç”¨ç¨‹åºçš„æ–°ç‰ˆæœ¬ï¼Œç­‰å¾…æ”¶é›†æŒ‡æ ‡ï¼Œåˆ†æå®ƒä»¬å¹¶å°†å®ƒä»¬ä¸é¢„å®šä¹‰çš„è§„åˆ™è¿›è¡ŒåŒ¹é…ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæˆ‘ä»¬å¢åŠ æµé‡ï¼›å¦‚æœæœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šå›æ»šéƒ¨ç½²ã€‚ è¦åœ¨ Kubernetes ä¸­æ‰§è¡Œæ­¤æ“ä½œï¼Œä½ å¯ä»¥ä½¿ç”¨æä¾› Canary å‘å¸ƒç­‰çš„ Argo Rollouts ã€‚\nArgo Rollouts æ˜¯ä¸€ä¸ª Kubernetes æ§åˆ¶å™¨å’Œä¸€ç»„ CRDï¼Œå¯æä¾›é«˜çº§éƒ¨ç½²åŠŸèƒ½ï¼Œä¾‹å¦‚è“ç»¿ã€é‡‘ä¸é›€ã€é‡‘ä¸é›€åˆ†æã€å®éªŒå’Œå‘ Kubernetes çš„æ¸è¿›å¼äº¤ä»˜åŠŸèƒ½ã€‚\nå°½ç®¡åƒ Istio è¿™æ ·çš„æœåŠ¡ç½‘æ ¼æä¾› Canary å‘å¸ƒï¼Œä½† Argo Rollouts ä½¿è¿™ä¸ªè¿‡ç¨‹å˜å¾—æ›´åŠ å®¹æ˜“å¹¶ä¸”ä»¥å¼€å‘äººå‘˜ä¸ºä¸­å¿ƒï¼Œå› ä¸ºå®ƒæ˜¯ä¸“é—¨ä¸ºæ­¤ç›®çš„è€Œæ„å»ºçš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒArgo Rollouts å¯ä»¥ä¸ä»»ä½•æœåŠ¡ç½‘æ ¼é›†æˆã€‚\nArgo Rollouts åŠŸèƒ½ï¼š\nè“ç»¿æ›´æ–°ç­–ç•¥ é‡‘ä¸é›€æ›´æ–°ç­–ç•¥ ç»†ç²’åº¦ã€åŠ æƒçš„æµé‡è½¬ç§» è‡ªåŠ¨å›æ»šå’Œä¿ƒé”€æˆ–äººå·¥åˆ¤æ–­ å¯å®šåˆ¶çš„æŒ‡æ ‡æŸ¥è¯¢å’Œä¸šåŠ¡ KPI åˆ†æ å…¥å£æ§åˆ¶å™¨é›†æˆï¼šNGINXã€ALB æœåŠ¡ç½‘æ ¼é›†æˆï¼šIstioã€Linkerdã€SMI æŒ‡æ ‡æä¾›è€…é›†æˆï¼šPrometheusã€Wavefrontã€Kayentaã€Webã€Kubernetes Jobs å¤‡é€‰ Istio ä½œä¸º Canary ç‰ˆæœ¬çš„æœåŠ¡ç½‘æ ¼ã€‚Istio ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ¸è¿›å¼äº¤ä»˜å·¥å…·ï¼Œå®ƒè¿˜æ˜¯ä¸€ä¸ªå®Œæ•´çš„æœåŠ¡ç½‘æ ¼ã€‚Istio ä¸ä¼šè‡ªåŠ¨éƒ¨ç½²ï¼ŒArgo Rollouts å¯ä»¥ä¸ Istio é›†æˆæ¥å®ç°è¿™ä¸€ç‚¹ã€‚ Flagger ä¸ Argo Rollouts éå¸¸ç›¸ä¼¼ï¼Œå¹¶ä¸”ä¸ Flux å¾ˆå¥½åœ°é›†æˆåœ¨ä¸€èµ·ï¼Œå› æ­¤å¦‚æœä½ ä½¿ç”¨ Fluxï¼Œè¯·è€ƒè™‘ä½¿ç”¨ Flaggerã€‚ Spinnaker æ˜¯ Kubernetes çš„ç¬¬ä¸€ä¸ªæŒç»­äº¤ä»˜å·¥å…·ï¼Œå®ƒå…·æœ‰è®¸å¤šåŠŸèƒ½ï¼Œä½†ä½¿ç”¨å’Œè®¾ç½®èµ·æ¥æœ‰ç‚¹å¤æ‚ã€‚ Crossplane Crossplane æ˜¯æˆ‘æœ€å–œæ¬¢çš„ K8s å·¥å…·ï¼Œæˆ‘å¯¹è¿™ä¸ªé¡¹ç›®æ„Ÿåˆ°éå¸¸å…´å¥‹ï¼Œå› ä¸ºå®ƒç»™ Kubernetes å¸¦æ¥äº†ä¸€ä¸ªå…³é”®çš„ç¼ºå¤±éƒ¨åˆ†ï¼šåƒç®¡ç† K8s èµ„æºä¸€æ ·ç®¡ç†ç¬¬ä¸‰æ–¹æœåŠ¡ã€‚è¿™æ„å‘³ç€ï¼Œä½ å¯ä»¥ä½¿ç”¨ YAML ä¸­å®šä¹‰çš„ K8s èµ„æºæ¥é…ç½®äº‘æä¾›å•†æ•°æ®åº“ï¼Œä¾‹å¦‚ AWS RDS æˆ– GCP Cloud SQLï¼Œå°±åƒä½ åœ¨ K8s ä¸­é…ç½®æ•°æ®åº“ä¸€æ ·ã€‚\nä½¿ç”¨ Crossplaneï¼Œæ— éœ€ä½¿ç”¨ä¸åŒçš„å·¥å…·å’Œæ–¹æ³•åˆ†ç¦»åŸºç¡€è®¾æ–½å’Œä»£ç ã€‚ä½ å¯ä»¥ä½¿ç”¨ K8s èµ„æºå®šä¹‰ä¸€åˆ‡ã€‚è¿™æ ·ï¼Œä½ å°±æ— éœ€å­¦ä¹  Terraform ç­‰æ–°å·¥å…·å¹¶å°†å®ƒä»¬åˆ†å¼€ä¿å­˜ã€‚\nCrossplane æ˜¯ä¸€ä¸ªå¼€æº Kubernetes é™„åŠ ç»„ä»¶ï¼Œå®ƒä½¿å¹³å°å›¢é˜Ÿèƒ½å¤Ÿç»„è£…æ¥è‡ªå¤šä¸ªä¾›åº”å•†çš„åŸºç¡€è®¾æ–½ï¼Œå¹¶å…¬å¼€æ›´é«˜çº§åˆ«çš„è‡ªåŠ© API ä¾›åº”ç”¨ç¨‹åºå›¢é˜Ÿä½¿ç”¨ï¼Œè€Œæ— éœ€ç¼–å†™ä»»ä½•ä»£ç ã€‚\nCrossplane æ‰©å±•äº†ä½ çš„ Kubernetes é›†ç¾¤ï¼Œä¸ºä½ æä¾›é€‚ç”¨äºä»»ä½•åŸºç¡€æ¶æ„æˆ–æ‰˜ç®¡äº‘æœåŠ¡çš„ CRDã€‚æ­¤å¤–ï¼Œå®ƒå…è®¸ä½ å®Œå…¨å®ç°æŒç»­éƒ¨ç½²ï¼Œå› ä¸ºä¸ Terraform ç­‰å…¶ä»–å·¥å…·ç›¸åï¼ŒCrossplane ä½¿ç”¨ç°æœ‰çš„ K8s åŠŸèƒ½ï¼ˆä¾‹å¦‚æ§åˆ¶å¾ªç¯ï¼‰æ¥æŒç»­è§‚å¯Ÿä½ çš„é›†ç¾¤å¹¶è‡ªåŠ¨æ£€æµ‹ä»»ä½•å¯¹å…¶èµ·ä½œç”¨çš„é…ç½®æ¼‚ç§»ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ å®šä¹‰äº†ä¸€ä¸ªæ‰˜ç®¡æ•°æ®åº“å®ä¾‹å¹¶ä¸”æœ‰äººæ‰‹åŠ¨æ›´æ”¹å®ƒï¼ŒCrossplane å°†è‡ªåŠ¨æ£€æµ‹é—®é¢˜å¹¶å°†å…¶è®¾ç½®å›ä»¥å‰çš„å€¼ã€‚è¿™å°†å®æ–½åŸºç¡€è®¾æ–½å³ä»£ç å’Œ GitOps åŸåˆ™ã€‚Crossplane ä¸ ArgoCD é…åˆä½¿ç”¨æ•ˆæœå¾ˆå¥½ï¼Œå®ƒå¯ä»¥æŸ¥çœ‹æºä»£ç å¹¶ç¡®ä¿ä½ çš„ä»£ç å­˜å‚¨åº“æ˜¯å”¯ä¸€çš„çœŸå®æ¥æºï¼Œå¹¶ä¸”ä»£ç ä¸­çš„ä»»ä½•æ›´æ”¹éƒ½ä¼šä¼ æ’­åˆ°é›†ç¾¤ä»¥åŠå¤–éƒ¨äº‘æœåŠ¡ã€‚å¦‚æœæ²¡æœ‰ Crossplaneï¼Œä½ åªèƒ½åœ¨ K8s æœåŠ¡ä¸­å®ç° GitOpsï¼Œè€Œä¸èƒ½åœ¨ä¸ä½¿ç”¨å•ç‹¬è¿›ç¨‹çš„æƒ…å†µä¸‹åœ¨äº‘æœåŠ¡ä¸­å®ç°ï¼Œç°åœ¨ä½ å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œè¿™å¤ªæ£’äº†ã€‚\nå¤‡é€‰ Terraform æ˜¯æœ€è‘—åçš„ IaC å·¥å…·ï¼Œä½†å®ƒä¸æ˜¯ K8s åŸç”Ÿçš„ï¼Œéœ€è¦æ–°æŠ€èƒ½å¹¶ä¸”ä¸ä¼šè‡ªåŠ¨ç›‘è§†é…ç½®æ¼‚ç§»ã€‚ Pulumi æ˜¯ä¸€ç§ Terraform æ›¿ä»£å“ï¼Œå®ƒä½¿ç”¨å¼€å‘äººå‘˜å¯ä»¥æµ‹è¯•å’Œç†è§£çš„ç¼–ç¨‹è¯­è¨€å·¥ä½œã€‚ Knative å¦‚æœä½ åœ¨äº‘ä¸­å¼€å‘åº”ç”¨ç¨‹åºï¼Œä½ å¯èƒ½å·²ç»ä½¿ç”¨äº†ä¸€äº›æ— æœåŠ¡å™¨æŠ€æœ¯ï¼Œä¾‹å¦‚ AWS Lambda ï¼Œå®ƒæ˜¯ä¸€ç§ç§°ä¸º FaaS çš„äº‹ä»¶é©±åŠ¨èŒƒä¾‹ã€‚\næˆ‘è¿‡å»å·²ç»è®¨è®ºè¿‡ Serverlessï¼Œå› æ­¤è¯·æŸ¥çœ‹æˆ‘ä¹‹å‰çš„æ–‡ç« ä»¥äº†è§£æ›´å¤šä¿¡æ¯ã€‚Serverless çš„é—®é¢˜åœ¨äºå®ƒä¸äº‘æä¾›å•†ç´§å¯†è€¦åˆï¼Œå› ä¸ºæä¾›å•†å¯ä»¥ä¸ºäº‹ä»¶é©±åŠ¨çš„åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªå¾ˆå¥½çš„ç”Ÿæ€ç³»ç»Ÿã€‚\nå¯¹äº Kubernetesï¼Œå¦‚æœä½ å¸Œæœ›å°†å‡½æ•°ä½œä¸ºä»£ç è¿è¡Œå¹¶ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œé‚£ä¹ˆä½ æœ€å¥½çš„é€‰æ‹©æ˜¯ Knativeã€‚Knative æ—¨åœ¨åœ¨ Kubernetes ä¸Šè¿è¡Œå‡½æ•°ï¼Œåœ¨ Pod ä¹‹ä¸Šåˆ›å»ºä¸€ä¸ªæŠ½è±¡ã€‚\nç‰¹ç‚¹ï¼š\né’ˆå¯¹å¸¸è§åº”ç”¨ç¨‹åºç”¨ä¾‹çš„å…·æœ‰æ›´é«˜çº§åˆ«æŠ½è±¡çš„é‡ç‚¹ APIã€‚ åœ¨å‡ ç§’é’Ÿå†…å»ºç«‹ä¸€ä¸ªå¯æ‰©å±•ã€å®‰å…¨ã€æ— çŠ¶æ€çš„æœåŠ¡ã€‚ æ¾æ•£è€¦åˆçš„åŠŸèƒ½è®©ä½ å¯ä»¥ä½¿ç”¨æ‰€éœ€çš„éƒ¨åˆ†ã€‚ å¯æ’æ‹”ç»„ä»¶è®©ä½ å¯ä»¥ä½¿ç”¨è‡ªå·±çš„æ—¥å¿—è®°å½•å’Œç›‘æ§ã€ç½‘ç»œå’ŒæœåŠ¡ç½‘æ ¼ã€‚ Knative æ˜¯å¯ç§»æ¤çš„ï¼šåœ¨ Kubernetes è¿è¡Œçš„ä»»ä½•åœ°æ–¹è¿è¡Œå®ƒï¼Œä¸ç”¨æ‹…å¿ƒä¾›åº”å•†é”å®šã€‚ æƒ¯ç”¨çš„å¼€å‘è€…ä½“éªŒï¼Œæ”¯æŒ GitOpsã€DockerOpsã€ManualOps ç­‰å¸¸ç”¨æ¨¡å¼ã€‚ Knative å¯ä»¥ä¸å¸¸è§çš„å·¥å…·å’Œæ¡†æ¶ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚ Djangoã€Ruby on Railsã€Spring ç­‰ç­‰ã€‚ å¤‡é€‰ Argo Events ä¸º Kubernetes æä¾›äº†ä¸€ä¸ªäº‹ä»¶é©±åŠ¨çš„å·¥ä½œæµå¼•æ“ï¼Œå¯ä»¥ä¸ AWS Lambda ç­‰äº‘å¼•æ“é›†æˆã€‚å®ƒä¸æ˜¯ FaaSï¼Œè€Œæ˜¯ä¸º Kubernetes æä¾›äº†ä¸€ä¸ªäº‹ä»¶é©±åŠ¨çš„æ¶æ„ã€‚ OpenFaas Kyverno Kubernetes æä¾›äº†æå¤§çš„çµæ´»æ€§ï¼Œä»¥èµ‹äºˆæ•æ·çš„è‡ªæ²»å›¢é˜ŸæƒåŠ›ï¼Œä½†èƒ½åŠ›è¶Šå¤§ï¼Œè´£ä»»è¶Šå¤§ã€‚å¿…é¡»æœ‰ä¸€ç»„æœ€ä½³å®è·µå’Œè§„åˆ™ï¼Œä»¥ç¡®ä¿ä»¥ä¸€è‡´ä¸”æœ‰å‡èšåŠ›çš„æ–¹å¼æ¥éƒ¨ç½²å’Œç®¡ç†ç¬¦åˆå…¬å¸æ”¿ç­–å’Œå®‰å…¨è¦æ±‚çš„å·¥ä½œè´Ÿè½½ã€‚\næœ‰å‡ ç§å·¥å…·å¯ä»¥å®ç°è¿™ä¸€ç‚¹ï¼Œä½†æ²¡æœ‰ä¸€ä¸ªæ˜¯ Kubernetes åŸç”Ÿçš„â€¦â€¦ ç›´åˆ°ç°åœ¨ã€‚Kyverno æ˜¯ä¸º Kubernetes è®¾è®¡çš„ç­–ç•¥å¼•æ“ï¼Œç­–ç•¥ä½œä¸º Kubernetes èµ„æºè¿›è¡Œç®¡ç†ï¼Œå¹¶ä¸”ä¸éœ€è¦æ–°çš„è¯­è¨€æ¥ç¼–å†™ç­–ç•¥ã€‚Kyverno ç­–ç•¥å¯ä»¥éªŒè¯ã€æ”¹å˜å’Œç”Ÿæˆ Kubernetes èµ„æºã€‚\nä½ å¯ä»¥åº”ç”¨æœ‰å…³æœ€ä½³å®è·µã€ç½‘ç»œæˆ–å®‰å…¨æ€§çš„ä»»ä½•ç±»å‹çš„ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥å¼ºåˆ¶æ‰€æœ‰æœåŠ¡éƒ½æœ‰æ ‡ç­¾æˆ–æ‰€æœ‰å®¹å™¨éƒ½ä»¥é root èº«ä»½è¿è¡Œã€‚ä½ å¯ä»¥åœ¨æ­¤å¤„æŸ¥çœ‹ä¸€äº›æ”¿ç­–ç¤ºä¾‹ã€‚ç­–ç•¥å¯ä»¥åº”ç”¨äºæ•´ä¸ªé›†ç¾¤æˆ–ç»™å®šçš„å‘½åç©ºé—´ã€‚ä½ è¿˜å¯ä»¥é€‰æ‹©æ˜¯åªæƒ³å®¡æ ¸ç­–ç•¥è¿˜æ˜¯å¼ºåˆ¶æ‰§è¡Œå®ƒä»¬ä»¥é˜»æ­¢ç”¨æˆ·éƒ¨ç½²èµ„æºã€‚\nå¤‡é€‰ Open Policy Agent æ˜¯è‘—åçš„äº‘åŸç”ŸåŸºäºç­–ç•¥çš„æ§åˆ¶å¼•æ“ã€‚å®ƒä½¿ç”¨è‡ªå·±çš„å£°æ˜æ€§è¯­è¨€ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è®¸å¤šç¯å¢ƒä¸­è¿è¡Œï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨ Kubernetes ä¸Šã€‚å®ƒæ¯” Kyverno æ›´éš¾ç®¡ç†ï¼Œä½†æ›´å¼ºå¤§ã€‚ Kubevela Kubernetes çš„ä¸€ä¸ªé—®é¢˜æ˜¯å¼€å‘äººå‘˜éœ€è¦éå¸¸äº†è§£å’Œç†è§£å¹³å°å’Œé›†ç¾¤é…ç½®ã€‚è®¸å¤šäººä¼šäº‰è¾©è¯´ K8s çš„æŠ½è±¡çº§åˆ«å¤ªä½ï¼Œè¿™ä¼šç»™åªæƒ³ä¸“æ³¨äºç¼–å†™å’Œäº¤ä»˜åº”ç”¨ç¨‹åºçš„å¼€å‘äººå‘˜å¸¦æ¥å¾ˆå¤šæ‘©æ“¦ã€‚\nåœ¨å¼€æ”¾å¼åº”ç”¨ç¨‹åºæ¨¡å‹ï¼ˆOAMï¼‰çš„è®¾ç«‹æ˜¯ä¸ºäº†å…‹æœè¿™ä¸ªé—®é¢˜ã€‚è¿™ä¸ªæƒ³æ³•æ˜¯å›´ç»•åº”ç”¨ç¨‹åºåˆ›å»ºæ›´é«˜çº§åˆ«çš„æŠ½è±¡ï¼Œå®ƒç‹¬ç«‹äºåº•å±‚è¿è¡Œæ—¶ã€‚ä½ å¯ä»¥åœ¨æ­¤å¤„é˜…è¯»è§„èŒƒã€‚\nä¸“æ³¨äºåº”ç”¨ç¨‹åºè€Œä¸æ˜¯å®¹å™¨æˆ–åè°ƒå™¨ï¼Œå¼€æ”¾åº”ç”¨ç¨‹åºæ¨¡å‹ [OAM] å¸¦æ¥äº†æ¨¡å—åŒ–ã€å¯æ‰©å±•å’Œå¯ç§»æ¤çš„è®¾è®¡ï¼Œç”¨äºä½¿ç”¨æ›´é«˜çº§åˆ«ä½†ä¸€è‡´çš„ API å¯¹åº”ç”¨ç¨‹åºéƒ¨ç½²è¿›è¡Œå»ºæ¨¡ã€‚\nKubevela æ˜¯ OAM æ¨¡å‹çš„ä¸€ä¸ªå®ç°ã€‚KubeVela ä¸è¿è¡Œæ—¶æ— å…³ï¼Œå¯æœ¬åœ°æ‰©å±•ï¼Œä½†æœ€é‡è¦çš„æ˜¯ï¼Œä»¥åº”ç”¨ç¨‹åºä¸ºä¸­å¿ƒ ã€‚åœ¨ Kubevela ä¸­ï¼Œåº”ç”¨ç¨‹åºæ˜¯ä½œä¸º Kubernetes èµ„æºå®ç°çš„ä¸€ç­‰å…¬æ°‘ã€‚**é›†ç¾¤è¿è¥å•†ï¼ˆPlatform Teamï¼‰å’Œå¼€å‘è€…ï¼ˆApplication Teamï¼‰**æ˜¯æœ‰åŒºåˆ«çš„ã€‚é›†ç¾¤æ“ä½œå‘˜é€šè¿‡å®šä¹‰ç»„ä»¶ï¼ˆç»„æˆåº”ç”¨ç¨‹åºçš„å¯éƒ¨ç½²/å¯é…ç½®å®ä½“ï¼Œå¦‚ Helm Chartï¼‰å’Œç‰¹å¾æ¥ç®¡ç†é›†ç¾¤å’Œä¸åŒçš„ç¯å¢ƒã€‚å¼€å‘äººå‘˜é€šè¿‡ç»„è£…ç»„ä»¶å’Œç‰¹å¾æ¥å®šä¹‰åº”ç”¨ç¨‹åºã€‚\nKubeVela æ˜¯ä¸€ä¸ªäº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šæ²™ç®±é¡¹ç›®ï¼Œè™½ç„¶å®ƒä»å¤„äºèµ·æ­¥é˜¶æ®µï¼Œä½†å®ƒå¯ä»¥åœ¨ä¸ä¹…çš„å°†æ¥æ”¹å˜æˆ‘ä»¬ä½¿ç”¨ Kubernetes çš„æ–¹å¼ï¼Œè®©å¼€å‘äººå‘˜æ— éœ€æˆä¸º Kubernetes ä¸“å®¶å³å¯ä¸“æ³¨äºåº”ç”¨ç¨‹åºã€‚ä½†æ˜¯ï¼Œæˆ‘ç¡®å®å¯¹ OAM åœ¨ç°å®ä¸–ç•Œä¸­çš„é€‚ç”¨æ€§æœ‰ä¸€äº›æ‹…å¿§ï¼Œå› ä¸ºç³»ç»Ÿåº”ç”¨ç¨‹åºã€ML æˆ–å¤§æ•°æ®è¿‡ç¨‹ç­‰ä¸€äº›æœåŠ¡åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºä½çº§ç»†èŠ‚ï¼Œè¿™äº›ç»†èŠ‚å¯èƒ½å¾ˆéš¾èå…¥ OAM æ¨¡å‹ä¸­ã€‚\nå¤‡é€‰ Shipa éµå¾ªç±»ä¼¼çš„æ–¹æ³•ï¼Œä½¿å¹³å°å’Œå¼€å‘å›¢é˜Ÿèƒ½å¤ŸååŒå·¥ä½œï¼Œè½»æ¾å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Kubernetesã€‚ Snyk ä»»ä½•å¼€å‘è¿‡ç¨‹ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹é¢æ˜¯å®‰å…¨æ€§ï¼Œè¿™ä¸€ç›´æ˜¯ Kubernetes çš„ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºæƒ³è¦è¿ç§»åˆ° Kubernetes çš„å…¬å¸æ— æ³•è½»æ¾å®ç°å…¶å½“å‰çš„å®‰å…¨åŸåˆ™ã€‚\nSnyk è¯•å›¾é€šè¿‡æä¾›ä¸€ä¸ªå¯ä»¥è½»æ¾ä¸ Kubernetes é›†æˆçš„å®‰å…¨æ¡†æ¶æ¥ç¼“è§£è¿™ç§æƒ…å†µã€‚å®ƒå¯ä»¥æ£€æµ‹å®¹å™¨æ˜ åƒã€ä½ çš„ä»£ç ã€å¼€æºé¡¹ç›®ç­‰ä¸­çš„æ¼æ´ã€‚\nå¤‡é€‰ Falco æ˜¯ Kubernetes çš„è¿è¡Œæ—¶å®‰å…¨çº¿ç¨‹æ£€æµ‹å·¥å…·ã€‚ Velero å¦‚æœä½ åœ¨ Kubernetes ä¸­è¿è¡Œå·¥ä½œè´Ÿè½½å¹¶ä½¿ç”¨å·æ¥å­˜å‚¨æ•°æ®ï¼Œåˆ™éœ€è¦åˆ›å»ºå’Œç®¡ç†å¤‡ä»½ã€‚Velero æä¾›ç®€å•çš„å¤‡ä»½/æ¢å¤è¿‡ç¨‹ã€ç¾éš¾æ¢å¤æœºåˆ¶å’Œæ•°æ®è¿ç§»ã€‚\nä¸å…¶ä»–ç›´æ¥è®¿é—® Kubernetes etcd æ•°æ®åº“æ‰§è¡Œå¤‡ä»½å’Œæ¢å¤çš„å·¥å…·ä¸åŒï¼ŒVelero ä½¿ç”¨ Kubernetes API æ¥æ•è·é›†ç¾¤èµ„æºçš„çŠ¶æ€å¹¶åœ¨å¿…è¦æ—¶æ¢å¤å®ƒä»¬ã€‚æ­¤å¤–ï¼ŒVelero ä½¿ä½ èƒ½å¤Ÿåœ¨é…ç½®çš„åŒæ—¶å¤‡ä»½å’Œæ¢å¤ä½ çš„åº”ç”¨ç¨‹åºæŒä¹…æ•°æ®ã€‚\nSchema Hero è½¯ä»¶å¼€å‘ä¸­çš„å¦ä¸€ä¸ªå¸¸è§è¿‡ç¨‹æ˜¯åœ¨ä½¿ç”¨å…³ç³»æ•°æ®åº“æ—¶ç®¡ç†æ¨¡å¼æ¼”å˜ã€‚\nSchemaHero æ˜¯ä¸€ç§å¼€æºæ•°æ®åº“æ¶æ„è¿ç§»å·¥å…·ï¼Œå¯å°†æ¶æ„å®šä¹‰è½¬æ¢ä¸ºå¯åº”ç”¨äºä»»ä½•ç¯å¢ƒçš„è¿ç§»è„šæœ¬ã€‚å®ƒä½¿ç”¨ Kubernetes å£°æ˜æ€§æ¥ç®¡ç†æ•°æ®åº“æ¨¡å¼è¿ç§»ã€‚ä½ åªéœ€æŒ‡å®šæ‰€éœ€çš„çŠ¶æ€ï¼Œç„¶å SchemaHero ç®¡ç†å…¶ä½™çš„ã€‚\nå¤‡é€‰ LiquidBase æ˜¯æœ€è‘—åçš„æ›¿ä»£å“ã€‚å®ƒæ›´éš¾ä½¿ç”¨ï¼Œä¸”ä¸æ˜¯ Kubernetes åŸç”Ÿçš„ï¼Œä½†å®ƒå…·æœ‰æ›´å¤šåŠŸèƒ½ã€‚ Bitnami Sealed Secrets æˆ‘ä»¬å·²ç»ä»‹ç»äº†è®¸å¤š GitOps å·¥å…·ï¼Œä¾‹å¦‚ ArgoCDã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†æ‰€æœ‰å†…å®¹ä¿ç•™åœ¨ Git ä¸­ï¼Œå¹¶ä½¿ç”¨ Kubernetes å£°æ˜æ€§æ¥ä¿æŒç¯å¢ƒåŒæ­¥ã€‚æˆ‘ä»¬åˆšåˆšçœ‹åˆ°æˆ‘ä»¬å¦‚ä½•ï¼ˆå¹¶ä¸”åº”è¯¥ï¼‰åœ¨ Git ä¸­ä¿ç•™çœŸå®æ¥æºï¼Œå¹¶è®©è‡ªåŠ¨åŒ–æµç¨‹å¤„ç†é…ç½®æ›´æ”¹ã€‚\nåœ¨ Git ä¸­é€šå¸¸å¾ˆéš¾ä¿ç•™çš„ä¸€ä»¶äº‹æ˜¯è¯¸å¦‚æ•°æ®åº“å¯†ç æˆ– API å¯†é’¥ä¹‹ç±»çš„ç§˜å¯†ï¼Œè¿™æ˜¯å› ä¸ºä½ æ°¸è¿œä¸åº”è¯¥åœ¨ä»£ç å­˜å‚¨åº“ä¸­å­˜å‚¨ç§˜å¯†ã€‚ä¸€ç§å¸¸è§çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨å¤–éƒ¨ä¿ç®¡åº“ï¼ˆä¾‹å¦‚ AWS Secret Manager æˆ– HashiCorp Vaultï¼‰æ¥å­˜å‚¨æœºå¯†ï¼Œä½†è¿™ä¼šäº§ç”Ÿå¾ˆå¤šæ‘©æ“¦ï¼Œå› ä¸ºä½ éœ€è¦æœ‰ä¸€ä¸ªå•ç‹¬çš„æµç¨‹æ¥å¤„ç†æœºå¯†ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥åƒä»»ä½•å…¶ä»–èµ„æºä¸€æ ·å®‰å…¨åœ°åœ¨ Git ä¸­å­˜å‚¨æœºå¯†ã€‚\nSealed Secrets æ—¨åœ¨å…‹æœè¿™ä¸ªé—®é¢˜ï¼Œå…è®¸ä½ ä½¿ç”¨å¼ºåŠ å¯†å°†æ•æ„Ÿæ•°æ®å­˜å‚¨åœ¨ Git ä¸­ã€‚Bitnami Sealed Secrets æœ¬åœ°é›†æˆåœ¨ Kubernetes ä¸­ï¼Œå…è®¸ä½ ä»…é€šè¿‡åœ¨ Kubernetes ä¸­è¿è¡Œçš„ Kubernetes æ§åˆ¶å™¨è€Œä¸æ˜¯å…¶ä»–ä»»ä½•äººæ¥è§£å¯†å¯†é’¥ã€‚æ§åˆ¶å™¨å°†è§£å¯†æ•°æ®å¹¶åˆ›å»ºå®‰å…¨å­˜å‚¨çš„åŸç”Ÿ K8s æœºå¯†ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†æ‰€æœ‰å†…å®¹ä½œä¸ºä»£ç å­˜å‚¨åœ¨æˆ‘ä»¬çš„ repo ä¸­ï¼Œä»è€Œå…è®¸æˆ‘ä»¬å®‰å…¨åœ°æ‰§è¡ŒæŒç»­éƒ¨ç½²ï¼Œè€Œæ— éœ€ä»»ä½•å¤–éƒ¨ä¾èµ–ã€‚\nSealed Secrets ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š\né›†ç¾¤ç«¯æ§åˆ¶å™¨ å®¢æˆ·ç«¯å®ç”¨ç¨‹åºï¼škubeseal è¯¥ kubeseal å®ç”¨ç¨‹åºä½¿ç”¨éå¯¹ç§°åŠ å¯†æ¥åŠ å¯†åªæœ‰æ§åˆ¶å™¨æ‰èƒ½è§£å¯†çš„æœºå¯†ã€‚è¿™äº›åŠ å¯†çš„ç§˜å¯†è¢«ç¼–ç åœ¨ä¸€ä¸ª SealedSecret K8s èµ„æºä¸­ï¼Œä½ å¯ä»¥å°†å…¶å­˜å‚¨åœ¨ Git ä¸­ã€‚\nå¤‡é€‰ AWS Secret Manager HashiCorp Vaultï¼‰ Capsule è®¸å¤šå…¬å¸ä½¿ç”¨å¤šç§Ÿæˆ·æ¥ç®¡ç†ä¸åŒçš„å®¢æˆ·ã€‚è¿™åœ¨è½¯ä»¶å¼€å‘ä¸­å¾ˆå¸¸è§ï¼Œä½†åœ¨ Kubernetes ä¸­å¾ˆéš¾å®ç°ã€‚å‘½åç©ºé—´æ˜¯å°†é›†ç¾¤çš„é€»è¾‘åˆ†åŒºåˆ›å»ºä¸ºéš”ç¦»åˆ‡ç‰‡çš„å¥½æ–¹æ³•ï¼Œä½†è¿™ä¸è¶³ä»¥å®‰å…¨åœ°éš”ç¦»å®¢æˆ·ï¼Œæˆ‘ä»¬éœ€è¦å¼ºåˆ¶æ‰§è¡Œç½‘ç»œç­–ç•¥ã€é…é¢ç­‰ã€‚ä½ å¯ä»¥ä¸ºæ¯ä¸ªåç§°ç©ºé—´åˆ›å»ºç½‘ç»œç­–ç•¥å’Œè§„åˆ™ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªéš¾ä»¥æ‰©å±•çš„ä¹å‘³è¿‡ç¨‹ã€‚æ­¤å¤–ï¼Œç§Ÿæˆ·å°†ä¸èƒ½ä½¿ç”¨å¤šä¸ªå‘½åç©ºé—´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é™åˆ¶ã€‚\nåˆ›å»ºåˆ†å±‚å‘½åç©ºé—´æ˜¯ä¸ºäº†å…‹æœå…¶ä¸­ä¸€äº›é—®é¢˜ã€‚è¿™ä¸ªæƒ³æ³•æ˜¯ä¸ºæ¯ä¸ªç§Ÿæˆ·æ‹¥æœ‰ä¸€ä¸ªçˆ¶å‘½åç©ºé—´ï¼Œä¸ºç§Ÿæˆ·æä¾›å…¬å…±ç½‘ç»œç­–ç•¥å’Œé…é¢ï¼Œå¹¶å…è®¸åˆ›å»ºå­å‘½åç©ºé—´ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ”¹è¿›ï¼Œä½†å®ƒåœ¨å®‰å…¨å’Œæ²»ç†æ–¹é¢æ²¡æœ‰å¯¹ç§Ÿæˆ·çš„æœ¬åœ°æ”¯æŒã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æ²¡æœ‰è¾¾åˆ°ç”Ÿäº§çŠ¶æ€ï¼Œä½† 1.0 ç‰ˆé¢„è®¡å°†åœ¨æœªæ¥å‡ ä¸ªæœˆå†…å‘å¸ƒã€‚\nå½“å‰è§£å†³æ­¤é—®é¢˜çš„å¸¸ç”¨æ–¹æ³•æ˜¯ä¸ºæ¯ä¸ªå®¢æˆ·åˆ›å»ºä¸€ä¸ªé›†ç¾¤ï¼Œè¿™æ˜¯å®‰å…¨çš„å¹¶æä¾›ç§Ÿæˆ·æ‰€éœ€çš„ä¸€åˆ‡ï¼Œä½†è¿™å¾ˆéš¾ç®¡ç†ä¸”éå¸¸æ˜‚è´µã€‚\nCapsule æ˜¯ä¸€ç§ä¸ºå•ä¸ªé›†ç¾¤ä¸­çš„å¤šä¸ªç§Ÿæˆ·æä¾›åŸç”Ÿ Kubernetes æ”¯æŒçš„å·¥å…·ã€‚ä½¿ç”¨ Capsuleï¼Œä½ å¯ä»¥ä¸ºæ‰€æœ‰ç§Ÿæˆ·æ‹¥æœ‰ä¸€ä¸ªé›†ç¾¤ã€‚Capsule å°†ä¸ºç§Ÿæˆ·æä¾› â€œå‡ ä¹â€ åŸç”Ÿä½“éªŒï¼ˆæœ‰ä¸€äº›å°é™åˆ¶ï¼‰ï¼Œä»–ä»¬å°†èƒ½å¤Ÿåˆ›å»ºå¤šä¸ªå‘½åç©ºé—´å¹¶ä½¿ç”¨é›†ç¾¤ï¼Œå› ä¸ºå®ƒä»¬å®Œå…¨å¯ç”¨ï¼Œéšè—äº†é›†ç¾¤å®é™…ä¸Šæ˜¯å…±äº«çš„äº‹å®ã€‚\nåœ¨å•ä¸ªé›†ç¾¤ä¸­ï¼ŒCapsule Controller åœ¨ç§°ä¸º Tenant çš„è½»é‡çº§ Kubernetes æŠ½è±¡ä¸­èšåˆå¤šä¸ªå‘½åç©ºé—´ï¼Œè¿™æ˜¯ä¸€ç»„ Kubernetes å‘½åç©ºé—´ã€‚åœ¨æ¯ä¸ªç§Ÿæˆ·å†…ï¼Œç”¨æˆ·å¯ä»¥è‡ªç”±åˆ›å»ºä»–ä»¬çš„å‘½åç©ºé—´å¹¶å…±äº«æ‰€æœ‰åˆ†é…çš„èµ„æºï¼Œè€Œç­–ç•¥å¼•æ“åˆ™ä½¿ä¸åŒçš„ç§Ÿæˆ·å½¼æ­¤éš”ç¦»ã€‚\nç§Ÿæˆ·çº§åˆ«å®šä¹‰çš„ç½‘ç»œå’Œå®‰å…¨ç­–ç•¥ã€èµ„æºé…é¢ã€é™åˆ¶èŒƒå›´ã€RBAC å’Œå…¶ä»–ç­–ç•¥ç”±ç§Ÿæˆ·ä¸­çš„æ‰€æœ‰å‘½åç©ºé—´è‡ªåŠ¨ç»§æ‰¿ï¼Œç±»ä¼¼äºåˆ†å±‚å‘½åç©ºé—´ã€‚ç„¶åç”¨æˆ·å¯ä»¥è‡ªç”±åœ°è‡ªæ²»æ“ä½œä»–ä»¬çš„ç§Ÿæˆ·ï¼Œè€Œæ— éœ€é›†ç¾¤ç®¡ç†å‘˜çš„å¹²é¢„ã€‚ Capsule æ˜¯ GitOps å°±ç»ªçš„ï¼Œå› ä¸ºå®ƒæ˜¯å£°æ˜æ€§çš„ï¼Œå¹¶ä¸”æ‰€æœ‰é…ç½®éƒ½å¯ä»¥å­˜å‚¨åœ¨ Git ä¸­ã€‚\nvCluster vCluster åœ¨å¤šç§Ÿæˆ·æ–¹é¢æ›´è¿›äº†ä¸€æ­¥ï¼Œå®ƒåœ¨ Kubernetes é›†ç¾¤å†…æä¾›äº†è™šæ‹Ÿé›†ç¾¤ã€‚æ¯ä¸ªé›†ç¾¤éƒ½åœ¨ä¸€ä¸ªå¸¸è§„å‘½åç©ºé—´ä¸Šè¿è¡Œï¼Œå¹¶ä¸”æ˜¯å®Œå…¨éš”ç¦»çš„ã€‚è™šæ‹Ÿé›†ç¾¤æœ‰è‡ªå·±çš„ API æœåŠ¡å™¨å’Œç‹¬ç«‹çš„æ•°æ®å­˜å‚¨ï¼Œæ‰€ä»¥ä½ åœ¨ vCluster ä¸­åˆ›å»ºçš„æ¯ä¸ª Kubernetes å¯¹è±¡éƒ½åªå­˜åœ¨äº vcluster å†…éƒ¨ã€‚æ­¤å¤–ï¼Œæ‚¨å¯ä»¥å°† kube ä¸Šä¸‹æ–‡ä¸è™šæ‹Ÿé›†ç¾¤ä¸€èµ·ä½¿ç”¨ï¼Œä»¥åƒä½¿ç”¨å¸¸è§„é›†ç¾¤ä¸€æ ·ä½¿ç”¨å®ƒä»¬ã€‚\nåªè¦æ‚¨å¯ä»¥åœ¨å•ä¸ªå‘½åç©ºé—´å†…åˆ›å»ºéƒ¨ç½²ï¼Œæ‚¨å°±å¯ä»¥åˆ›å»ºè™šæ‹Ÿé›†ç¾¤å¹¶æˆä¸ºè¯¥è™šæ‹Ÿé›†ç¾¤çš„ç®¡ç†å‘˜ï¼Œç§Ÿæˆ·å¯ä»¥åˆ›å»ºå‘½åç©ºé—´ã€å®‰è£… CRDã€é…ç½®æƒé™ç­‰ç­‰ã€‚\nvCluster ä½¿ç”¨ k3s ä½œä¸ºå…¶ API æœåŠ¡å™¨ï¼Œä½¿è™šæ‹Ÿé›†ç¾¤è¶…è½»é‡çº§ä¸”ç»æµé«˜æ•ˆï¼›ç”±äº k3s é›†ç¾¤ 100% åˆè§„ï¼Œè™šæ‹Ÿé›†ç¾¤ä¹Ÿ 100% åˆè§„ã€‚vClusters æ˜¯è¶…è½»é‡çº§çš„ï¼ˆ1 ä¸ª podï¼‰ï¼Œæ¶ˆè€—å¾ˆå°‘çš„èµ„æºå¹¶ä¸”å¯ä»¥åœ¨ä»»ä½• Kubernetes é›†ç¾¤ä¸Šè¿è¡Œï¼Œè€Œæ— éœ€å¯¹åº•å±‚é›†ç¾¤è¿›è¡Œç‰¹æƒè®¿é—®ã€‚ä¸ Capsule ç›¸æ¯”ï¼Œå®ƒç¡®å®ä½¿ç”¨äº†æ›´å¤šçš„èµ„æºï¼Œä½†å®ƒæä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå› ä¸ºå¤šç§Ÿæˆ·åªæ˜¯ç”¨ä¾‹ä¹‹ä¸€ã€‚\nå…¶ä»–å·¥å…· kube-burner ç”¨äºå‹åŠ›æµ‹è¯•ã€‚å®ƒæä¾›æŒ‡æ ‡å’Œè­¦æŠ¥ã€‚ æ··æ²Œå·¥ç¨‹çš„ Litmusã€‚ kubewatch ç”¨äºç›‘æ§ï¼Œä½†ä¸»è¦å…³æ³¨åŸºäº Kubernetes äº‹ä»¶ï¼ˆå¦‚èµ„æºåˆ›å»ºæˆ–åˆ é™¤ï¼‰çš„æ¨é€é€šçŸ¥ã€‚å®ƒå¯ä»¥ä¸ Slack ç­‰è®¸å¤šå·¥å…·é›†æˆã€‚ BotKube æ˜¯ä¸€ä¸ªæ¶ˆæ¯æœºå™¨äººï¼Œç”¨äºç›‘æ§å’Œè°ƒè¯• Kubernetes é›†ç¾¤ã€‚ä¸ kubewatch ç±»ä¼¼ï¼Œä½†æ›´æ–°å¹¶å…·æœ‰æ›´å¤šåŠŸèƒ½ã€‚ Mizu æ˜¯ä¸€ä¸ª API æµé‡æŸ¥çœ‹å™¨å’Œè°ƒè¯•å™¨ã€‚ kube-fledged æ˜¯ä¸€ä¸ª Kubernetes æ’ä»¶ï¼Œç”¨äºç›´æ¥åœ¨ Kubernetes é›†ç¾¤çš„å·¥ä½œèŠ‚ç‚¹ä¸Šåˆ›å»ºå’Œç®¡ç†å®¹å™¨é•œåƒçš„ç¼“å­˜ã€‚å› æ­¤ï¼Œåº”ç”¨ç¨‹åº pod å‡ ä¹ç«‹å³å¯åŠ¨ï¼Œå› ä¸ºä¸éœ€è¦ä»æ³¨å†Œè¡¨ä¸­æå–å›¾åƒã€‚ ç»“è®º åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å›é¡¾äº†æˆ‘æœ€å–œæ¬¢çš„ Kubernetes å·¥å…·ã€‚æˆ‘ä¸“æ³¨äºå¯ä»¥åˆå¹¶åˆ°ä»»ä½• Kubernetes å‘è¡Œç‰ˆä¸­çš„å¼€æºé¡¹ç›®ã€‚æˆ‘æ²¡æœ‰æ¶µç›–è¯¸å¦‚ OpenShift æˆ– Cloud Providers Add-Ons ä¹‹ç±»çš„å•†ä¸šè§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºæˆ‘æƒ³è®©å®ƒä¿æŒé€šç”¨æ€§ï¼Œä½†æˆ‘é¼“åŠ±æ‚¨æ¢ç´¢å¦‚æœæ‚¨åœ¨äº‘ä¸Šè¿è¡Œ Kubernetes æˆ–ä½¿ç”¨å•†ä¸šå·¥å…·ï¼Œæ‚¨çš„äº‘æä¾›å•†å¯ä»¥ä¸ºæ‚¨æä¾›ä»€ä¹ˆã€‚\næˆ‘çš„ç›®æ ‡æ˜¯å‘æ‚¨å±•ç¤ºæ‚¨å¯ä»¥åœ¨ Kubernetes ä¸­å®Œæˆæ‚¨åœ¨æœ¬åœ°æ‰€åšçš„ä¸€åˆ‡ã€‚æˆ‘è¿˜æ›´å¤šåœ°å…³æ³¨é²œä¸ºäººçŸ¥çš„å·¥å…·ï¼Œæˆ‘è®¤ä¸ºè¿™äº›å·¥å…·å¯èƒ½å…·æœ‰å¾ˆå¤§çš„æ½œåŠ›ï¼Œä¾‹å¦‚ Crossplaneã€Argo Rolloutsæˆ– Kubevelaã€‚æˆ‘æ›´æ„Ÿå…´è¶£çš„å·¥å…·æ˜¯ vClusterã€Crossplane å’Œ ArgoCD/Workflowsã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/translation-kuberletes-essential-tools-2021/","tags":["Kubernetes","OPA","Service Mesh","Istio","Tool","DevOps"],"title":"Kubernetes å¿…å¤‡å·¥å…·ï¼š2021"},{"categories":["ç¬”è®°"],"contents":"è¿˜ä¸çŸ¥é“ Pipy æ˜¯ä»€ä¹ˆçš„åŒå­¦å¯ä»¥çœ‹ä¸‹ GitHub ã€‚\nPipy æ˜¯ä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½ã€é«˜ç¨³å®šã€å¯ç¼–ç¨‹çš„ç½‘ç»œä»£ç†ã€‚Pipy æ ¸å¿ƒæ¡†æ¶ä½¿ç”¨ C++ å¼€å‘ï¼Œç½‘ç»œ IO é‡‡ç”¨ ASIO åº“ã€‚ Pipy çš„å¯æ‰§è¡Œæ–‡ä»¶ä»…æœ‰ 5M å·¦å³ï¼Œè¿è¡ŒæœŸçš„å†…å­˜å ç”¨ 10M å·¦å³ï¼Œå› æ­¤ Pipy éå¸¸é€‚åˆåš Sidecar proxyã€‚\nPipy å†…ç½®äº†è‡ªç ”çš„ pjs ä½œä¸ºè„šæœ¬æ‰©å±•ï¼Œä½¿å¾—Pipy å¯ä»¥ç”¨ JS è„šæœ¬æ ¹æ®ç‰¹å®šéœ€æ±‚å¿«é€Ÿå®šåˆ¶é€»è¾‘ä¸åŠŸèƒ½ã€‚\nPipy é‡‡ç”¨äº†æ¨¡å—åŒ–ã€é“¾å¼çš„å¤„ç†æ¶æ„ï¼Œç”¨é¡ºåºæ‰§è¡Œçš„æ¨¡å—æ¥å¯¹ç½‘ç»œæ•°æ®å—è¿›è¡Œå¤„ç†ã€‚è¿™ç§ç®€å•çš„æ¶æ„ä½¿å¾— Pipy åº•å±‚ç®€å•å¯é ï¼ŒåŒæ—¶å…·å¤‡äº†åŠ¨æ€ç¼–æ’æµé‡çš„èƒ½åŠ›ï¼Œå…¼é¡¾äº†ç®€å•å’Œçµæ´»ã€‚é€šè¿‡ä½¿ç”¨ REUSE_PORT çš„æœºåˆ¶ï¼ˆä¸»æµ Linux å’Œ BSD ç‰ˆæœ¬éƒ½æ”¯æŒè¯¥åŠŸèƒ½ï¼‰ï¼ŒPipy å¯ä»¥ä»¥å¤šè¿›ç¨‹æ¨¡å¼è¿è¡Œï¼Œä½¿å¾— Pipy ä¸ä»…é€‚ç”¨äº Sidecar æ¨¡å¼ï¼Œä¹Ÿé€‚ç”¨äºå¤§è§„æ¨¡çš„æµé‡å¤„ç†åœºæ™¯ã€‚ åœ¨å®è·µä¸­ï¼ŒPipy ç‹¬ç«‹éƒ¨ç½²çš„æ—¶å€™ç”¨ä½œâ€œè½¯è´Ÿè½½â€ï¼Œå¯ä»¥åœ¨ä½å»¶è¿Ÿçš„æƒ…å†µä¸‹ï¼Œå®ç°åª²ç¾ç¡¬ä»¶çš„è´Ÿè½½å‡è¡¡ååèƒ½åŠ›ï¼ŒåŒæ—¶å…·æœ‰çµæ´»çš„æ‰©å±•æ€§ã€‚\nåœ¨ç©è¿‡å‡ æ¬¡ Pipy å¹¶æ¢ç©¶å…¶å·¥ä½œåŸç†åï¼Œåˆæœ‰äº†æ›´å¤šçš„æƒ³æ³•ã€‚\nåˆæ¢å¯ç¼–ç¨‹ç½‘å…³ Pipy å¯ç¼–ç¨‹ç½‘å…³ Pipy ç¬¬äºŒå¼¹ï¼šç¼–ç¨‹å®ç° Metrics åŠæºç è§£è¯» å¯ç¼–ç¨‹ç½‘å…³ Pipy ç¬¬ä¸‰å¼¹ï¼šäº‹ä»¶æ¨¡å‹è®¾è®¡ åœ¨ä½¿ç”¨OPAçš„æ—¶å€™ï¼Œä¸€ç›´è§‰å¾—Regoä¸æ˜¯é‚£ä¹ˆé¡ºæ‰‹ï¼Œä½¿ç”¨pipy jsæ¥å†™è§„åˆ™çš„æƒ³æ³•æ²¹ç„¶è€Œç”Ÿã€‚ä»Šå¤©å°±ä¸€èµ·è¯•è¯•è¿™ä¸ªæ€è·¯ã€‚æœç„¶ï¼Œä¸è¯•ä¸çŸ¥é“ï¼Œä¸€è¯•å‘ç°å¤ªå¤šçš„æƒŠå–œï½Pipyä¸æ­¢äºâ€œä»£ç†â€ï¼Œæ›´æœ‰å¾ˆå¤šå¯ä»¥é€‚ç”¨çš„åœºæ™¯ï¼š\næå°çš„å•ä¸€å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆsingle binaryï¼‰ä½¿å¾— pipy å¯èƒ½æ˜¯æœ€å¥½çš„ â€œäº‘åŸç”Ÿ sidecarâ€ sidecar ä¸ä»…ä»…æ˜¯ä»£ç†ï¼Œè¿˜å¯ä»¥åšæ§åˆ¶å™¨ï¼Œåšè¿ç®—å•å…ƒ proxy çš„ä¸²è·¯ç»“æ„é€‚åˆå„ç§ç®¡æ§ç±»çš„æ“ä½œï¼Œæ¯”å¦‚è®¿é—®æ§åˆ¶ Pipy js çš„æ‰©å±•èƒ½åŠ›å’Œå¿«é€Ÿç¼–ç¨‹èƒ½åŠ›ï¼Œå¾ˆé€‚åˆåš â€œè§„åˆ™å¼•æ“â€ï¼Œæˆ–è€…ç”¨æœ€è¿‘æµè¡Œçš„è¯´æ³• â€œäº‘åŸç”Ÿçš„è§„åˆ™å¼•æ“â€ã€‚å¯¹æ¯” OPA æˆ‘è®¤ä¸ºå®ƒå®Œå…¨å¤Ÿæ ¼åšä¸€ä¸ª â€œç¾½é‡çº§è§„åˆ™æ‰§è¡Œå¼•æ“â€ ç°åœ¨æˆ‘æ›´å€¾å‘äºå®šä¹‰ pipy æ˜¯ä¸€ä¸ª â€œäº‘åŸç”Ÿçš„æµé‡ç¼–ç¨‹æ¡†æ¶â€ï¼Œä»£ç†åªæ˜¯å…¶åº•å±‚çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œå åŠ äº† pipy js ä»¥åï¼Œä¸Šå±‚å¯ä»¥åšçš„äº‹æƒ…å¾ˆå¤šï¼Œâ€œæµé‡æ»‹å…»ä¸‡ç‰©â€ã€‚\nåœ¨ ä½¿ç”¨ Open Policy Agent å®ç°å¯ä¿¡é•œåƒä»“åº“æ£€æŸ¥ ä¹‹åï¼Œå°±åœ¨æƒ³ Pipy æ˜¯å¦ä¸€æ ·å¯ä»¥åšåˆ°ï¼Œå°†å†…æ ¸æ›¿æ¢æˆ Pipy + è§„åˆ™ã€‚æ‰€ä»¥ä»Šå¤©å¤§éƒ¨åˆ†å†…å®¹å’Œä¸Šé¢è¿™ç¯‡æ˜¯ç›¸ä¼¼çš„ã€‚\næ¥ï¼Œä¸€èµ·çœ‹çœ‹è¿™ä¸ªâ€œä¸åŠ¡æ­£ä¸šâ€çš„ Pipy å¦‚ä½•å®ç° Kubernetes çš„å‡†å…¥æ§åˆ¶å™¨ æ¥åšé•œåƒçš„æ£€æŸ¥ã€‚\nç¯å¢ƒ ç»§ç»­ä½¿ç”¨ minikube\nminikube start åˆ›å»ºéƒ¨ç½² Pipy çš„å‘½åç©ºé—´ kubectl create namespace pipy kubens pipy kubectl label ns pipy pipy/webhook=ignore #åé¢è§£é‡Š è§„åˆ™ åœ¨ OPA ä¸­ï¼Œé€šè¿‡ kube-mgmt å®¹å™¨ç›‘æ§ configmap çš„æ”¹åŠ¨ï¼Œå°† Policy æ¨é€åˆ°åŒ pod çš„ opa å®¹å™¨ä¸­ã€‚\nå¯¹äº Pipy ä¸ºäº†æ¸å˜ï¼Œç›´æ¥ä½¿ç”¨æŒ‚è½½çš„æ–¹å¼å°†ä¿å­˜äº†è§„åˆ™çš„ configmap æŒ‚è½½åˆ° Pipy çš„å®¹å™¨ä¸­ã€‚\nå®é™…çš„ä½¿ç”¨ä¸­ï¼ŒPipy æ”¯æŒè½®è®­çš„æ–¹å¼æ£€æŸ¥æ§åˆ¶å¹³é¢ä¸­è§„åˆ™çš„å˜æ›´ï¼Œå¹¶å®æ—¶åŠ è½½ï¼›ä¹Ÿå¯ä»¥å®ç°ä¸ OPA çš„ kube-mgmt åŒæ ·çš„é€»è¾‘ã€‚\nå®ç°äº†ä¸Šä¸€è®²åŠŸèƒ½çš„ pipy è§„åˆ™å¦‚ä¸‹ï¼š\ncat \u0026gt; pipy-rule.js \u0026lt;\u0026lt;EOF pipy({ _repoPrefix: \u0026#39;192.168.64.1\u0026#39;, //192.168.64.1:5000 æ˜¯ç¬”è€…æœ¬åœ°å®¹å™¨è¿è¡Œçš„ä¸€ä¸ªç§æœ‰ä»“åº“ã€‚ _tagSuffix: \u0026#39;:latest\u0026#39;, }) .listen(6443, { tls: { cert: os.readFile(\u0026#39;/certs/tls.crt\u0026#39;).toString(), key: os.readFile(\u0026#39;/certs/tls.key\u0026#39;).toString(), }, }) .decodeHttpRequest() .replaceMessage( msg =\u0026gt; ( ((req, result, invalids, reason) =\u0026gt; ( req = JSON.decode(msg.body), invalids = req.request.object.spec.containers.find(container =\u0026gt; ( (!container.image.startsWith(_repoPrefix) ? ( reason = `${container.image} repo not start with ${_repoPrefix}`, console.log(reason), true ) : (false)) || (container.image.endsWith(_tagSuffix) ? ( reason = `${container.image} tag end with ${_tagSuffix}`, console.log(reason), true ) : (false) ))), invalids != undefined ? ( result = { \u0026#34;apiVersion\u0026#34;: \u0026#34;admission.k8s.io/v1beta1\u0026#34;, \u0026#34;kind\u0026#34;: \u0026#34;AdmissionReview\u0026#34;, \u0026#34;response\u0026#34;: { \u0026#34;allowed\u0026#34;: false, \u0026#34;uid\u0026#34;: req.request.uid, \u0026#34;status\u0026#34;: { \u0026#34;reason\u0026#34;: reason, }, }, } ) : ( result = { \u0026#34;apiVersion\u0026#34;: \u0026#34;admission.k8s.io/v1beta1\u0026#34;, \u0026#34;kind\u0026#34;: \u0026#34;AdmissionReview\u0026#34;, \u0026#34;response\u0026#34;: { \u0026#34;allowed\u0026#34;: true, \u0026#34;uid\u0026#34;: req.request.uid }, } ), console.log(JSON.encode(result)), new Message({ \u0026#39;status\u0026#39; : 200, \u0026#39;headers\u0026#39;: { \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39; } }, JSON.encode(result)) ))() ) ) .encodeHttpResponse() EOF å°†è§„åˆ™ä¿å­˜åœ¨ configmap ä¸­ï¼š\nkubectl create configmap pipy-rule --from-file=pipy-rule.js åœ¨ Kubernetes ä¸Šéƒ¨ç½² Pipy Kubernetes ä¸å‡†å…¥æ§åˆ¶å™¨ï¼ˆAdmission Controllerï¼‰çš„é€šä¿¡éœ€è¦ä½¿ç”¨ TLSã€‚é…ç½® TLSï¼Œä½¿ç”¨ openssl åˆ›å»ºè¯ä¹¦é¢å‘æœºæ„ï¼ˆcertificate authority CAï¼‰å’Œ OPA çš„è¯ä¹¦/ç§˜é’¥å¯¹ã€‚\nopenssl genrsa -out ca.key 2048 openssl req -x509 -new -nodes -key ca.key -days 100000 -out ca.crt -subj \u0026#34;/CN=admission_ca\u0026#34; ä¸º OPA åˆ›å»º TLS ç§˜é’¥å’Œè¯ä¹¦ï¼š\ncat \u0026gt;server.conf \u0026lt;\u0026lt;EOF [req] req_extensions = v3_req distinguished_name = req_distinguished_name prompt = no [req_distinguished_name] CN = pipy.pipy.svc [ v3_req ] basicConstraints = CA:FALSE keyUsage = nonRepudiation, digitalSignature, keyEncipherment extendedKeyUsage = clientAuth, serverAuth subjectAltName = @alt_names [alt_names] DNS.1 = pipy.pipy.svc EOF æ³¨æ„ CN å’Œ alt_names å¿…é¡»ä¸åé¢åˆ›å»º Pipy service çš„åŒ¹é…ã€‚\nopenssl genrsa -out server.key 2048 openssl req -new -key server.key -out server.csr -config server.conf openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 100000 -extensions v3_req -extfile server.conf ä¸º OPA åˆ›å»ºä¿å­˜ TLS å‡­è¯çš„ Secretï¼š\nkubectl create secret tls pipy-server --cert=server.crt --key=server.key å°† Pipy éƒ¨ç½²ä¸ºå‡†å…¥æ§åˆ¶å™¨ï¼ˆadmission controllerï¼‰ã€‚ä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œæˆ‘ä»¬ä½¿ç”¨å¯åŠ¨ Pipy çš„æ—¶å€™æ‰“å¼€äº†æ§åˆ¶å°ã€‚\nkind: Service apiVersion: v1 metadata: name: pipy namespace: pipy spec: selector: app: pipy ports: - name: https protocol: TCP port: 443 targetPort: 6443 - name: gui # æ–¹ä¾¿è°ƒè¯• protocol: TCP port: 6060 targetPort: 6060 - name: http protocol: TCP port: 6080 targetPort: 6080 --- apiVersion: apps/v1 kind: Deployment metadata: labels: app: pipy namespace: pipy name: pipy spec: replicas: 1 selector: matchLabels: app: pipy template: metadata: labels: app: pipy name: pipy spec: containers: - name: pipy image: pipy:latest imagePullPolicy: IfNotPresent args: - \u0026#34;pipy\u0026#34; - \u0026#34;/opt/data/pipy-rule.js\u0026#34; - \u0026#34;--gui-port=6060\u0026#34; # æ–¹ä¾¿è°ƒè¯• # - \u0026#34;--log-level=debug\u0026#34; ports: - name: gui containerPort: 6060 protocol: TCP - name: http containerPort: 6080 protocol: TCP - name: https containerPort: 6443 protocol: TCP volumeMounts: - readOnly: true mountPath: /certs name: pipy-server - readOnly: false mountPath: /opt/data name: pipy-rule volumes: - name: pipy-server secret: secretName: pipy-server - name: pipy-rule configMap: name: pipy-rule æš´éœ²æ§åˆ¶å°çš„è®¿é—®ï¼š\nkubectl expose deploy pipy --name pipy-node --type NodePort kubectl get svc pipy-port minikube service --url pipy-node -n pipy # æ‰¾åˆ°æ§åˆ¶å°ç«¯å£ æ¥ä¸‹æ¥ï¼Œç”Ÿæˆå°†ç”¨äºå°† Pipy æ³¨å†Œä¸ºå‡†å…¥æ§åˆ¶å™¨çš„ manifestã€‚\ncat \u0026gt; webhook-configuration.yaml \u0026lt;\u0026lt;EOF kind: ValidatingWebhookConfiguration apiVersion: admissionregistration.k8s.io/v1beta1 metadata: name: pipy-validating-webhook webhooks: - name: validating-webhook.pipy.flomesh-io.cn namespaceSelector: matchExpressions: - key: pipy/webhook operator: NotIn values: - ignore rules: - operations: [\u0026#34;CREATE\u0026#34;, \u0026#34;UPDATE\u0026#34;] apiGroups: [\u0026#34;*\u0026#34;] apiVersions: [\u0026#34;*\u0026#34;] resources: [\u0026#34;pods\u0026#34;] clientConfig: caBundle: $(cat ca.crt | base64 | tr -d \u0026#39;\\n\u0026#39;) service: namespace: pipy name: pipy EOF ç”Ÿæˆçš„é…ç½®æ–‡ä»¶åŒ…å« CA è¯ä¹¦çš„ base64 ç¼–ç ï¼Œä»¥ä¾¿å¯ä»¥åœ¨ Kubernetes API æœåŠ¡å™¨å’Œ OPA ä¹‹é—´å»ºç«‹ TLS è¿æ¥ã€‚\nkubectl apply -f webhook-configuration.yaml æµ‹è¯• pod-bad-repo.yaml:\napiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: web-server name: web-server namespace: default spec: containers: - image: nginx:1.21.1 name: web-server resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} kubectl apply -f pod-bad-repo.yaml Error from server (nginx:1.21.1 repo not start with 192.168.64.1): error when creating \u0026#34;pod-bad-repo.yaml\u0026#34;: admission webhook \u0026#34;validating-webhook.pipy.flomesh-io.cn\u0026#34; denied the request: nginx:1.21.1 repo not start with 192.168.64.1 pod-bad-tag.yaml\napiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: web-server name: web-server namespace: default spec: containers: - image: 192.168.64.1:5000/nginx:latest name: web-server resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} kubectl apply -f pod-bad-tag.yaml Error from server (192.168.64.1:5000/nginx:latest tag end with :latest): error when creating \u0026#34;pod-bad-tag.yaml\u0026#34;: admission webhook \u0026#34;validating-webhook.pipy.flomesh-io.cn\u0026#34; denied the request: 192.168.64.1:5000/nginx:latest tag end with :latest pod-ok.yaml\napiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: web-server name: web-server namespace: default spec: containers: - image: 192.168.64.1:5000/nginx:1.21.1 name: web-server resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} kubectl apply -f pod-ok.yaml pod/web-server created æ€»ç»“ OPA å“ªå“ªéƒ½å¥½ï¼Œå”¯ä¸€ç¼ºç‚¹å°±æ˜¯å…¶å¼•è¿›çš„ Rego è¯­è¨€æŠ¬é«˜äº†ä½¿ç”¨çš„é—¨æ§›ã€‚è€Œ Pipy çš„è§„åˆ™æ˜¯é€šè¿‡ JavaScrip æ¥ç¼–å†™çš„ï¼Œå‰ç«¯çš„åŒå­¦ä¸€æ ·å¯ä»¥å®Œæˆè§„åˆ™çš„ç¼–å†™ã€‚å®Œå…¨æ›¿ä»£å¯èƒ½å¤¸å¼ äº†ä¸€äº›ï¼Œä½†ç¡®å®åœ¨éƒ¨åˆ†åœºæ™¯ä¸‹å¯ä»¥æ›¿ä»£ OPAã€‚\nç©åˆ°è¿™é‡Œï¼Œä½ ä¼šå‘ç°æœ‰äº†è§„åˆ™ï¼ŒåŠ ä¸ŠåŠŸèƒ½å¼ºå¤§çš„è¿‡æ»¤å™¨ï¼ˆç°åœ¨æˆ‘å–œæ¬¢å«ä»–ä»¬ Hook äº†ï¼‰ï¼ŒPipy çš„å¯ç©æ€§éå¸¸å¼ºã€‚\næ¯”å¦‚OPA: Kubernetes å‡†å…¥æ§åˆ¶ç­–ç•¥ Top 5ï¼Œæ¯”å¦‚\u0026hellip;ã€‚å¤§èƒ†çš„æƒ³è±¡å§ã€‚\næƒ³å†™ä¸€ä¸ªç³»åˆ—ï¼Œå°±å«â€œå¦‚ä½•æŠŠ Pipy ç©åâ€ï¼Ÿ\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/pipy-implement-kubernetes-admission-control/","tags":["Kubernetes","OPA","Pipy","äº‘åŸç”Ÿ","Container"],"title":"Rego ä¸å¥½ç”¨ï¼Ÿç”¨ Pipy å®ç° OPA"},{"categories":["äº‘åŸç”Ÿ"],"contents":"å¦‚ä½•ä½¿ç”¨ Open Policy Agent å®ç°å‡†å…¥ç­–ç•¥æ§åˆ¶ï¼Œå¯ä»¥å‚è€ƒè¿™é‡Œ\næœ¬æ–‡ç¿»è¯‘è‡ª Open Policy Agent: The Top 5 Kubernetes Admission Control Policies\nKubernetes å¼€å‘äººå‘˜å’Œå¹³å°å·¥ç¨‹å¸ˆé€šå¸¸æ‰¿å—ç€éå¸¸å¤§çš„å‹åŠ›ï¼Œä»¥ä¿æŒåº”ç”¨ç¨‹åºéƒ¨ç½²çš„å¿«é€Ÿè¿›è¡Œï¼Œå¹¶ä¸”æ€»æ˜¯ä¸ºäº†é€Ÿåº¦å’Œè¿›åº¦è€Œåšå‡ºå¦¥åã€‚å¹³å°å›¢é˜Ÿè¶Šæ¥è¶Šæœ‰è´£ä»»ç¡®ä¿è¿™äº›å¦¥åï¼ˆä¾‹å¦‚ç®¡ç† Ingressï¼‰ä¸ä¼šå¯¼è‡´å®¢æˆ·æ•°æ®æš´éœ²åœ¨æ•´ä¸ªäº’è”ç½‘ä¸Šç­‰åæœã€‚\nå¹¸è¿çš„æ˜¯ï¼ŒKubernetes æä¾›äº†è®¾ç½®ç­–ç•¥çš„èƒ½åŠ›ï¼Œé€šè¿‡æ£€æŸ¥å¹¶é˜²æ­¢éƒ¨ç½²é”™è¯¯å°†å…¶æŠ•å…¥ç”Ÿäº§ï¼Œä»è€Œé¿å…è¿™äº›åæœã€‚ä¸ºäº†ç¡®ä¿å›¢é˜Ÿçš„åº”ç”¨ç¨‹åºä¸ä¼šæ¯”ä¿¡å¿ƒæ›´é‡è¦ï¼Œä»¥ä¸‹æ˜¯ç°åœ¨åº”è¯¥åœ¨é›†ç¾¤ä¸­è¿è¡Œçš„å‰äº”ä¸ª Kubernetes å‡†å…¥æ§åˆ¶ç­–ç•¥ã€‚\n1. å¯ä¿¡é•œåƒä»“åº“ æ­¤ç­–ç•¥å¾ˆç®€å•ï¼Œä½†åŠŸèƒ½å¼ºå¤§ï¼šä»…å…è®¸ä»å—ä¿¡ä»»çš„é•œåƒä»“åº“ä¸­æ‹‰å–çš„å®¹å™¨æ˜ åƒï¼Œå¹¶ä¸”å¯ä»¥é€‰æ‹©ä»…æ‹‰å–ä¸å…è®¸çš„ä»“åº“é•œåƒåœ°å€åˆ—è¡¨åŒ¹é…çš„é‚£äº›é•œåƒã€‚\nå½“ç„¶ï¼Œä»äº’è”ç½‘ï¼ˆæˆ–å¯ä¿¡é•œåƒä»“åº“åº“ä»¥å¤–çš„ä»»ä½•åœ°æ–¹ï¼‰æ‹‰å–æœªçŸ¥é•œåƒä¼šå¸¦æ¥é£é™©â€”â€”ä¾‹å¦‚æ¶æ„è½¯ä»¶ã€‚ä½†æ˜¯è¿˜æœ‰å…¶ä»–å¾ˆå¥½çš„ç†ç”±æ¥ç»´æŠ¤å•ä¸€çš„å¯ä¿¡æ¥æºï¼Œä¾‹å¦‚åœ¨ä¼ä¸šä¸­å®ç°å¯æ”¯æŒæ€§ã€‚é€šè¿‡ç¡®ä¿é•œåƒä»…æ¥è‡ªå—ä¿¡ä»»çš„é•œåƒä»“åº“ï¼Œå¯ä»¥å¯†åˆ‡æ§åˆ¶é•œåƒåº“å­˜ï¼Œé™ä½è½¯ä»¶ç†µå’Œè”“å»¶çš„é£é™©ï¼Œå¹¶æé«˜é›†ç¾¤çš„æ•´ä½“å®‰å…¨æ€§ã€‚\nç›¸å…³ç­–ç•¥ï¼š\nç¦æ­¢æ‰€æœ‰å¸¦æœ‰â€œlatestâ€ tag çš„é•œåƒ ä»…å…è®¸ç­¾åé•œåƒæˆ–åŒ¹é…ç‰¹å®šå“ˆå¸Œ/SHA çš„é•œåƒ ç­–ç•¥ç¤ºä¾‹ï¼š\npackage kubernetes.validating.images deny[msg] { some i input.request.kind.kind == \u0026#34;Pod\u0026#34; image := input.request.object.spec.containers[i].image not startswith(image, \u0026#34;hooli.com/\u0026#34;) msg := sprintf(\u0026#34;Image \u0026#39;%v\u0026#39; comes from untrusted registry\u0026#34;, [image]) } 2. æ ‡ç­¾å®‰å…¨ æ­¤ç­–ç•¥è¦æ±‚æ‰€æœ‰ Kubernetes èµ„æºéƒ½åŒ…å«æŒ‡å®šçš„æ ‡ç­¾å¹¶ä½¿ç”¨é€‚å½“çš„æ ¼å¼ã€‚ç”±äºæ ‡ç­¾å†³å®šäº† Kubernetes å¯¹è±¡å’Œç­–ç•¥çš„åˆ†ç»„ï¼ŒåŒ…æ‹¬å·¥ä½œè´Ÿè½½å¯ä»¥è¿è¡Œçš„ä½ç½®â€”â€”å‰ç«¯ã€åç«¯ã€æ•°æ®å±‚â€”â€”ä»¥åŠå“ªäº›èµ„æºå¯ä»¥å‘é€æµé‡ï¼Œæ ‡ç­¾é”™è¯¯ä¼šå¯¼è‡´ç”Ÿäº§ä¸­æ— æ³•è§£é‡Šçš„éƒ¨ç½²å’Œå¯æ”¯æŒæ€§é—®é¢˜ã€‚æ­¤å¤–ï¼Œå¦‚æœæ²¡æœ‰å¯¹æ ‡ç­¾åº”ç”¨æ–¹å¼çš„è®¿é—®æ§åˆ¶ï¼Œé›†ç¾¤å°±ç¼ºä¹åŸºæœ¬çš„å®‰å…¨æ€§ã€‚æœ€åï¼Œæ‰‹åŠ¨è¾“å…¥æ ‡ç­¾çš„å±é™©åœ¨äºé”™è¯¯ä¼šè”“å»¶ï¼Œç‰¹åˆ«æ˜¯å› ä¸ºæ ‡ç­¾åœ¨ Kubernetes ä¸­æ—¢çµæ´»åˆå¼ºå¤§ã€‚åº”ç”¨æ­¤ç­–ç•¥å¹¶ç¡®ä¿æ ‡ç­¾é…ç½®æ­£ç¡®ä¸”ä¸€è‡´ã€‚\nç›¸å…³æ”¿ç­–ï¼š\nç¡®ä¿æ¯ä¸ªå·¥ä½œè´Ÿè½½éƒ½éœ€è¦ç‰¹å®šçš„æ³¨è§£ï¼ˆannotationsï¼‰ æŒ‡å®šæ±¡ç‚¹å’Œå®¹å¿åº¦ä»¥é™åˆ¶å¯ä»¥éƒ¨ç½²æ˜ åƒçš„ä½ç½® ç­–ç•¥ç¤ºä¾‹ï¼š\npackage kubernetes.validating.existence deny[msg] { not input.request.object.metadata.labels.costcenter msg := \u0026#34;Every resource must have a costcenter label\u0026#34; } deny[msg] { value := input.request.object.metadata.labels.costcenter not startswith(value, \u0026#34;cccode-\u0026#34;) msg := sprintf(\u0026#34;Costcenter code must start with `cccode-`; found `%v`\u0026#34;, [value]) } ## 3. ç¦æ­¢ï¼ˆæˆ–æŒ‡å®šï¼‰ç‰¹æƒæ¨¡å¼\næ­¤ç­–ç•¥ç¡®ä¿é»˜è®¤æƒ…å†µä¸‹å®¹å™¨ä¸èƒ½åœ¨ç‰¹æƒæ¨¡å¼ä¸‹è¿è¡Œ - é™¤éåœ¨å…è®¸çš„æƒ…å†µä¸‹æ’é™¤ç‰¹å®šæƒ…å†µï¼ˆé€šå¸¸å¾ˆå°‘è§ï¼‰ã€‚\né€šå¸¸ï¼Œå¸Œæœ›é¿å…åœ¨ç‰¹æƒæ¨¡å¼ä¸‹è¿è¡Œå®¹å™¨ï¼Œå› ä¸ºå®ƒæä¾›å¯¹ä¸»æœºèµ„æºå’Œå†…æ ¸åŠŸèƒ½çš„è®¿é—®â€”â€”åŒ…æ‹¬ç¦ç”¨ä¸»æœºçº§ä¿æŠ¤çš„èƒ½åŠ›ã€‚è™½ç„¶å®¹å™¨åœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯éš”ç¦»çš„ï¼Œä½†å®ƒä»¬æœ€ç»ˆå…±äº«ç›¸åŒçš„å†…æ ¸ã€‚è¿™æ„å‘³ç€å¦‚æœç‰¹æƒå®¹å™¨é­åˆ°å…¥ä¾µï¼Œå®ƒå¯èƒ½ä¼šæˆä¸ºå…¥ä¾µæ•´ä¸ªç³»ç»Ÿçš„èµ·ç‚¹ã€‚å°½ç®¡å¦‚æ­¤ï¼Œåœ¨ç‰¹æƒæ¨¡å¼ä¸‹è¿è¡Œè¿˜æ˜¯æœ‰æ­£å½“ç†ç”±çš„â€”â€”åªè¦ç¡®ä¿è¿™äº›æ—¶é—´æ˜¯ä¾‹å¤–ï¼Œè€Œä¸æ˜¯è§„åˆ™ã€‚\nç›¸å…³æ”¿ç­–ï¼š\nç¦æ­¢ä¸å®‰å…¨çš„èƒ½åŠ›ï¼ˆcapabilitiesï¼‰ ç¦æ­¢å®¹å™¨ä»¥ root èº«ä»½è¿è¡Œï¼ˆä»¥é root èº«ä»½è¿è¡Œï¼‰ è®¾ç½® userID ç­–ç•¥ç¤ºä¾‹ï¼š\npackage kubernetes.validating.privileged deny[msg] { some c input_container[c] c.securityContext.privileged msg := sprintf(\u0026#34;Container \u0026#39;%v\u0026#39; should not run in privileged mode.\u0026#34;, [c.name]) } input_container[container] { container := input.request.object.spec.containers[_] } input_container[container] { container := input.request.object.spec.initContainers[_] } å®šä¹‰å’Œæ§åˆ¶å…¥å£ Ingress ç­–ç•¥å…è®¸æ ¹æ®éœ€è¦å…¬å¼€ç‰¹å®šæœåŠ¡ï¼ˆå…è®¸ Ingressï¼‰ï¼Œæˆ–è€…æ ¹æ®éœ€è¦ä¸å…¬å¼€ä»»ä½•æœåŠ¡ã€‚åœ¨ Kubernetes ä¸­ï¼Œå¾ˆå®¹æ˜“æ„å¤–å¯åŠ¨ä¸å…¬å…±äº’è”ç½‘é€šä¿¡çš„æœåŠ¡ï¼ˆKubernetes æ•…éšœæ•…äº‹ä¸­æœ‰å¾ˆå¤šè¿™æ ·çš„ä¾‹å­ï¼‰ã€‚åŒæ—¶ï¼Œè¿‡äºå®½æ¾çš„ Ingress ä¼šå¯¼è‡´å¯åŠ¨ä¸å¿…è¦çš„å¤–éƒ¨ LoadBalancerï¼Œè¿™ä¹Ÿå¯èƒ½ä¼šå˜å¾—éå¸¸æ˜‚è´µï¼ˆå¦‚æ¯æœˆé¢„ç®—æ”¯å‡ºï¼‰éå¸¸å¿«ï¼æ­¤å¤–ï¼Œå½“ä¸¤ä¸ªæœåŠ¡å°è¯•å…±äº«åŒä¸€ä¸ª Ingress æ—¶ï¼Œå®ƒå¯èƒ½ä¼šç ´ååº”ç”¨ç¨‹åºã€‚\nä¸‹é¢çš„ç­–ç•¥ç¤ºä¾‹é˜²æ­¢ä¸åŒå‘½åç©ºé—´ä¸­çš„ Ingress å¯¹è±¡å…±äº«ç›¸åŒçš„ä¸»æœºåã€‚è¿™ä¸ªå¸¸è§é—®é¢˜æ„å‘³ç€æ–°å·¥ä½œè´Ÿè½½ä¼šä»ç°æœ‰å·¥ä½œè´Ÿè½½â€œçªƒå–â€äº’è”ç½‘æµé‡ï¼Œè¿™ä¼šäº§ç”Ÿä¸€ç³»åˆ—è´Ÿé¢åæœâ€”â€”ä»æœåŠ¡ä¸­æ–­åˆ°æ•°æ®æš´éœ²ç­‰ç­‰ã€‚\nç›¸å…³æ”¿ç­–ï¼š\néœ€è¦ TLS ç¦æ­¢/å…è®¸ç‰¹å®šç«¯å£ ç­–ç•¥ç¤ºä¾‹ï¼š\npackage kubernetes.validating.ingress deny[msg] { is_ingress input_host := input.request.object.spec.rules[_].host some other_ns, other_name other_host := data.kubernetes.ingresses[other_ns][other_name].spec.rules[_].host [input_ns, input_name] != [other_ns, other_name] input_host == other_host msg := sprintf(\u0026#34;Ingress host conflicts with ingress %v/%v\u0026#34;, [other_ns, other_name]) } input_ns = input.request.object.metadata.namespace input_name = input.request.object.metadata.name is_ingress { input.request.kind.kind == \u0026#34;Ingress\u0026#34; input.request.kind.group == \u0026#34;extensions\u0026#34; input.request.kind.version == \u0026#34;v1beta1\u0026#34; } 5. å®šä¹‰å’Œæ§åˆ¶å‡ºå£ æ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½éœ€è¦é˜²æŠ¤æ æ¥æ§åˆ¶å‡ºå£æµé‡çš„æµåŠ¨æ–¹å¼ï¼Œæ­¤ç­–ç•¥å…è®¸ä½ æŒ‡å®šé›†ç¾¤å†…å’Œé›†ç¾¤å¤–çš„é€šä¿¡ã€‚ä¸ Ingress ä¸€æ ·ï¼Œé»˜è®¤æƒ…å†µä¸‹å¾ˆå®¹æ˜“æ„å¤–åœ°â€œå…è®¸ Egressâ€åˆ°å…¨ä¸–ç•Œçš„æ¯ä¸ª IPã€‚æœ‰æ—¶è¿™ç”šè‡³ä¸æ˜¯æ„å¤–â€”â€”å®Œå…¨çš„æ”¾å¼€é€šå¸¸æ˜¯ç¡®ä¿å¯ä»¥è®¿é—®æ–°éƒ¨ç½²çš„åº”ç”¨ç¨‹åºçš„æœ€ååŠªåŠ›ï¼Œå³ä½¿å®ƒè¿‡äºå®½æ¾æˆ–å¼•å…¥é£é™©ã€‚åœ¨é›†ç¾¤å†…çº§åˆ«ï¼Œè¿˜æœ‰å¯èƒ½æ— æ„ä¸­å°†æ•°æ®å‘é€åˆ°ä¸åº”è¯¥æ‹¥æœ‰çš„æœåŠ¡ã€‚å¦‚æœæœåŠ¡å—åˆ°æŸå®³ï¼Œè¿™ä¸¤ç§æƒ…å†µéƒ½å­˜åœ¨æ•°æ®æ³„éœ²å’Œç›—çªƒçš„é£é™©ã€‚å¦ä¸€æ–¹é¢ï¼šè¿‡äºä¸¥æ ¼ï¼Œä½¿ç”¨ Egress æœ‰æ—¶ä¼šå¯¼è‡´é…ç½®é”™è¯¯ï¼Œä»è€Œç ´ååº”ç”¨ç¨‹åºã€‚å®ç°ä¸¤å…¨å…¶ç¾æ„å‘³ç€ä½¿ç”¨æ­¤ç­–ç•¥é€‰æ‹©å’ŒæŒ‡å®šå…è®¸ Egress å‘ç”Ÿçš„æ—¶é—´å’ŒæœåŠ¡ã€‚\nç›¸å…³æ”¿ç­–ã€‚\nè¯·å‚é˜…ä¸Šé¢çš„å…¥å£ç­–ç•¥ ç­–ç•¥ç¤ºä¾‹ï¼š\npackage kubernetes.validating.egress allow_list := { \u0026#34;10.10.0.0/16\u0026#34;, \u0026#34;192.168.100.1/32\u0026#34; } deny[reason] { network_policy_allows_all_egress reason := \u0026#34;Network policy allows access to any IP address.\u0026#34; } deny[reason] { count(allow_list) \u0026gt; 0 input.request.kind.kind == \u0026#34;NetworkPolicy\u0026#34; input.request.object.spec.policyTypes[_] == \u0026#34;Egress\u0026#34; ipBlock := input.request.object.spec.egress[_].to[_].ipBlock not any({t | t := net.cidr_contains(allow_list[_], ipBlock.cidr)}) reason := \u0026#34;Network policy allows egress traffic outside of allowed IP ranges.\u0026#34; } network_policy_allows_all_egress { input.request.kind.kind == \u0026#34;NetworkPolicy\u0026#34; input.request.object.spec.policyTypes[_] == \u0026#34;Egress\u0026#34; egress := input.request.object.spec.egress[_] not egress.to } æœ‰äº†è¿™äº›æ”¿ç­–ï¼Œä½ å°±å¯ä»¥ä¸“æ³¨äºæ„å»ºä¸€ä¸ªä¸–ç•Œçº§çš„å¹³å°ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æƒ³ä¸º Kubernetes æ·»åŠ æ›´å¤šåŸºæœ¬ç­–ç•¥ï¼Œè¯·æŸ¥çœ‹ openpolicyagent.orgã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/open-policy-agent-top-5-kubernetes-admission-control/","tags":["OPA","Kubernetes","äº‘åŸç”Ÿ"],"title":"Open Policy Agent: Top 5 Kubernetes å‡†å…¥æ§åˆ¶ç­–ç•¥"},{"categories":["ç¿»è¯‘","äº‘åŸç”Ÿ"],"contents":"ç¬”è€…ï¼šKubernetes æŠ½è±¡äº†èµ„æºå’Œå·¥ä½œè´Ÿè½½çš„æ“ä½œæ¨¡å¼ï¼Œç»Ÿä¸€äº†å·¥å…·é›†ï¼Œå®ç°äººæœºæ¥å£çš„æ ‡å‡†åŒ–ã€‚æ­£å¦‚ç±» Docker å·¥å…·æä¾›äº†åº”ç”¨è¿è¡Œæ—¶çš„æ“ä½œæ¨¡å¼ï¼›Spring Framework æä¾›äº† Java åº”ç”¨çš„å¼€å‘æ¨¡å¼ã€‚\nKubernetes æ˜¯å…³äºè·¨äº‘çš„æŠ€èƒ½ã€å·¥å…·å’Œå®è·µçš„å¯ç§»æ¤æ€§ã€‚ä¸æ˜¯å·¥ä½œè´Ÿè½½çš„å¯ç§»æ¤æ€§ã€‚ \u0026ndash; Bilgin Lbryam @bibryam\næœ¬æ–‡ç¿»è¯‘è‡ª Kubernetes magic is in enterprise standardization, not app portability\nKubernetes ä¸ä¼šç¥å¥‡åœ°ä½¿ä½ çš„åº”ç”¨ç¨‹åºå…·æœ‰å¯ç§»æ¤æ€§ï¼Œä½†å®ƒå¯èƒ½ä¼šç»™ä½ å¸¦æ¥æ›´å¥½çš„ä¸œè¥¿ã€‚\näº‘ä¸ºä¼ä¸šæä¾›äº†çœ‹ä¼¼æ— é™çš„é€‰æ‹©ã€‚ç„¶è€Œï¼Œæ ¹æ® Canonical-sponsored çš„ä¸€é¡¹è°ƒæŸ¥ï¼Œè¿™å¹¶ä¸æ˜¯å¤§å¤šæ•°ä¼ä¸šé‡‡ç”¨ Kubernetes ç­‰äº‘å‹å¥½æŠ€æœ¯çš„åŸå› ã€‚ç›¸åï¼ŒKubernetes çš„ä¸»è¦ç›®æ ‡æ˜¯æ ‡å‡†åŒ–â€”â€”å¤–è§‚å’Œæ“ä½œä¸å…¶ä»–äººä¸€æ ·ã€‚\nå¯ç§»æ¤æ€§ä¸æ˜¯ç›®æ ‡ æˆ‘ä¹‹å‰å·²ç»è®¨è®ºè¿‡è¿™ä¸ªé—®é¢˜ï¼Œå‚è€ƒäº† Gartner å…³äº Kubernetes å’Œå¯ç§»æ¤æ€§çš„æŒ‡å—ã€‚è®¸å¤šäººè®¤ä¸º Kubernetesï¼ˆå’Œå®¹å™¨ï¼‰å¯ä»¥è®©ä»–ä»¬åœ¨äº‘ä¹‹é—´è½»æ¾ç§»æ¤ï¼Œä½†äº‹å®è¯æ˜å¹¶ä¸æ˜¯è¿™æ ·çš„ã€‚æ­£å¦‚ Gartner åˆ†æå¸ˆ Marco Meinardi æ‰€å†™ï¼Œå½“è¢«é—®åŠå…¬å¸æ˜¯å¦åº”è¯¥é‡‡ç”¨â€œKubernetes ä½¿ä»–ä»¬çš„åº”ç”¨ç¨‹åºå¯ç§»æ¤\u0026hellip;\u0026hellip;ç­”æ¡ˆæ˜¯ï¼šä¸ã€‚â€ å†è¯´ä¸€æ¬¡ï¼Ÿ\nè°ƒæŸ¥æ˜¾ç¤ºï¼Œ[åœ¨äº‘æä¾›å•†ä¹‹é—´ç§»åŠ¨åº”ç”¨ç¨‹åº] çš„å¯èƒ½æ€§å®é™…ä¸Šéå¸¸ä½ã€‚ä¸€æ—¦éƒ¨ç½²åœ¨ä¾›åº”å•†ä¸­ï¼Œåº”ç”¨ç¨‹åºå¾€å¾€ä¼šç•™åœ¨é‚£é‡Œã€‚è¿™æ˜¯å› ä¸ºæ•°æ®æ¹–éš¾ä»¥ç§»æ¤ä¸”æˆæœ¬é«˜æ˜‚ï¼Œå› æ­¤æœ€ç»ˆæˆä¸ºè¿ç§»çš„é‡å¿ƒã€‚\nå› æ­¤ Kubernetes é€šå¸¸ä¸ä¼šè¢«å…¬å¸æ¥å—ï¼Œä»¥å¢å¼ºåº”ç”¨ç¨‹åºçš„å¯ç§»æ¤æ€§ï¼›ç›¸åï¼Œè°ˆè®ºäººå‘˜å¯ç§»æ¤æ€§æˆ–æ¢è¨€ä¹‹ï¼ŒæŠ€èƒ½å¯ç§»æ¤æ€§æ›´æ¥è¿‘äº‹å®ã€‚Weaveworks é¦–å¸­æ‰§è¡Œå®˜äºšå†å…‹è¥¿æ–¯Â·ç†æŸ¥æ£®ï¼ˆAlexis Richardsonï¼‰å°†è¿™ä¸ªä¸»é¢˜æ‰“å›å®¶ï¼š\né‡ç‚¹æ˜¯â€œæŠ€èƒ½å¯ç§»æ¤æ€§â€ï¼Œå› ä¸ºä½¿ç”¨æ ‡å‡†æ“ä½œæ¨¡å‹å’Œå·¥å…·é“¾ã€‚å¤§å‹ç»„ç»‡å¸Œæœ›å¼€å‘äººå‘˜ä½¿ç”¨æ ‡å‡†çš„å·¥ä½œæ–¹å¼ï¼Œå› ä¸ºè¿™å¯ä»¥é™ä½åŸ¹è®­æˆæœ¬ï¼Œå¹¶æ¶ˆé™¤å‘˜å·¥åœ¨ä¸åŒé¡¹ç›®ä¹‹é—´è½¬ç§»çš„éšœç¢ã€‚å¦‚æœä½ çš„â€œå¹³å°â€ï¼ˆæˆ–å¤šä¸ªå¹³å°ï¼‰åŸºäºç›¸åŒçš„æ ¸å¿ƒäº‘åŸç”Ÿå·¥å…·é›†ï¼Œé‚£ä¹ˆå®ƒä¹Ÿå¯ä»¥æ›´è½»æ¾ã€æ›´ä¾¿å®œåœ°åº”ç”¨ç­–ç•¥ã€‚\nè¿™è®©æˆ‘ä»¬å›åˆ°è§„èŒƒè°ƒæŸ¥ã€‚\nSamesies å½“è¢«é—®åŠç¡®å®šä¸é‡‡ç”¨ Kubernetes ç­‰äº‘åŸç”ŸæŠ€æœ¯ç›¸å…³çš„æŠ€æœ¯ç›®æ ‡æ—¶ï¼Œè°ƒæŸ¥å—è®¿è€…å°†å¯ç§»æ¤æ€§æ’åœ¨æœ€åï¼Œå°†æ›´ç›´æ¥çš„é—®é¢˜æ’åœ¨ç¬¬ä¸€ä½ï¼š\næ”¹è¿›ç»´æŠ¤ã€ç›‘æ§å’Œè‡ªåŠ¨åŒ– - 64.6%ã€‚ åŸºç¡€è®¾æ–½ç°ä»£åŒ– - 46.4%ã€‚ æ›´å¿«çš„ä¸Šçº¿æ—¶é—´ - 26.5%ã€‚ åˆ é™¤ä¾›åº”å•†ä¾èµ–é¡¹ - 12.8%ã€‚ å…¨çƒè¦†ç›–ç‡ - 12.5%ã€‚ å›´ç»•æµé‡é«˜å³°çš„æ•æ·æ€§ - 9.2%ã€‚ ç¡®ä¿ä¾¿æºæ€§ - 8.9% æˆ‘å–œæ¬¢ Google Cloud çš„å¼€å‘è€…å€¡å¯¼è€… Kelsey Hightower åœ¨è°ƒæŸ¥æŠ¥å‘Šä¸­è¯„è®ºè¿™äº›ç»“æœçš„æ–¹å¼ï¼š\nå¾ˆå¤šäººè®¤ä¸ºç»„ç»‡è½¬å‘ Kubernetes æ˜¯å› ä¸ºè§„æ¨¡ï¼Œæˆ–è€…å› ä¸ºä»–ä»¬æƒ³æˆä¸ºè¶…å¤§è§„æ¨¡è€…ï¼Œæˆ–è€…ä¸ Twitter æ‹¥æœ‰ç›¸åŒçš„æµé‡æ°´å¹³ã€‚å¯¹äºå¤§å¤šæ•°ç»„ç»‡è€Œè¨€ï¼Œæƒ…å†µå¹¶éä¸€å®šå¦‚æ­¤ã€‚å¾ˆå¤šäººéƒ½å–œæ¬¢ K8s ä¸­å†…ç½®äº†è®¸å¤šå†³ç­–ï¼Œä¾‹å¦‚æ—¥å¿—è®°å½•ã€ç›‘æ§å’Œè´Ÿè½½å¹³è¡¡ã€‚\näººä»¬å¾€å¾€ä¼šå¿˜è®°äº‹æƒ…æœ‰å¤šä¹ˆå¤æ‚ï¼Œåªæ˜¯ä¸ºäº†æ„å»ºä¸€ä¸ªæ²¡æœ‰æ‰€æœ‰è‡ªåŠ¨åŒ–çš„åº”ç”¨ç¨‹åºã€‚å¦‚æœä½ åœ¨å…¬æœ‰äº‘ä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›æœ¬æœºé›†æˆå’Œå·¥å…·ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ åœ¨æœ¬åœ°ï¼Œé‚£ä¸æ˜¯ç»™å®šçš„â€”â€”ä½ å¿…é¡»è‡ªå·±å°†è§£å†³æ–¹æ¡ˆç²˜åˆåœ¨ä¸€èµ·ã€‚ä½¿ç”¨ Kubernetesï¼Œä½ å‡ ä¹å°† 25 ç§ä¸åŒçš„å·¥å…·åˆäºŒä¸ºä¸€ã€‚\nè¿™å°±æ˜¯äººä»¬æ‰€è¯´çš„â€œç°ä»£åŸºç¡€è®¾æ–½â€çš„æ„æ€â€”â€”ä»–ä»¬å¹¶ä¸æ˜¯åœ¨è°ˆè®ºåšä¸€äº›ä»¥å‰ä»æœªåšè¿‡çš„äº‹æƒ…ã€‚ä»–ä»¬è°ˆè®ºçš„æ˜¯è¿‡å» 10 å¹´æˆ– 15 å¹´ä¸€ç›´åœ¨ç”Ÿäº§çš„ä¸œè¥¿ã€‚Kubernetes æ˜¯å½“ä»Šæ‰€æœ‰â€œç°ä»£æ¨¡å¼â€çš„æ£€æŸ¥ç«™ã€‚\næ¢å¥è¯è¯´ï¼Œäººä»¬çœŸæ­£æƒ³è¦ä» Kubernetes è·å¾—çš„æ˜¯ä¸€ç§æ ‡å‡†çš„åŸºç¡€è®¾æ–½æ€è€ƒæ–¹å¼ã€‚å›åˆ° Richardson ä¹‹å‰çš„è§‚ç‚¹ï¼Œè™½ç„¶ Kubernetes å’Œäº‘åŸç”ŸæŠ€æœ¯ä½¿å…¬å¸èƒ½å¤Ÿä»¥æ›´é«˜çš„é€Ÿåº¦è¿è¥ï¼Œä½†æœ€å¤§çš„å¥½å¤„å¯èƒ½æ˜¯ä½¿æŠ€èƒ½åœ¨ç»„ç»‡ä¹‹é—´å¯ä»¥äº’æ¢â€”â€”è¿™ä¸ºé›‡ä¸»å’Œå‘˜å·¥éƒ½åˆ›é€ äº†å·¨å¤§çš„ç»©æ•ˆæ”¶ç›Šã€‚è¿™æ˜¯ä¼ä¸šä¸æ–­å¢åŠ å¯¹ Kubernetes æŠ•èµ„çš„å¦ä¸€ä¸ªåŸå› ã€‚\nå£°æ˜ï¼šæˆ‘ä¸º AWS å·¥ä½œï¼Œä½†æ­¤å¤„è¡¨è¾¾çš„è§‚ç‚¹æ˜¯æˆ‘çš„ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/translation-kubernetes-magic-is-in-enterprise-standardization-not-app-portability/","tags":["Kubernetes","äº‘åŸç”Ÿ"],"title":"Kubernetes çš„é­”åŠ›åœ¨äºä¼ä¸šæ ‡å‡†åŒ–ï¼Œè€Œä¸æ˜¯åº”ç”¨ç¨‹åºçš„å¯ç§»æ¤æ€§"},{"categories":["äº‘åŸç”Ÿ"],"contents":"ä»äº’è”ç½‘ï¼ˆæˆ–å¯ä¿¡é•œåƒä»“åº“åº“ä»¥å¤–çš„ä»»ä½•åœ°æ–¹ï¼‰æ‹‰å–æœªçŸ¥é•œåƒä¼šå¸¦æ¥é£é™©â€”â€”ä¾‹å¦‚æ¶æ„è½¯ä»¶ã€‚ä½†æ˜¯è¿˜æœ‰å…¶ä»–å¾ˆå¥½çš„ç†ç”±æ¥ç»´æŠ¤å•ä¸€çš„å¯ä¿¡æ¥æºï¼Œä¾‹å¦‚åœ¨ä¼ä¸šä¸­å®ç°å¯æ”¯æŒæ€§ã€‚é€šè¿‡ç¡®ä¿é•œåƒä»…æ¥è‡ªå—ä¿¡ä»»çš„é•œåƒä»“åº“ï¼Œå¯ä»¥å¯†åˆ‡æ§åˆ¶é•œåƒåº“å­˜ï¼Œé™ä½è½¯ä»¶ç†µå’Œè”“å»¶çš„é£é™©ï¼Œå¹¶æé«˜é›†ç¾¤çš„æ•´ä½“å®‰å…¨æ€§ã€‚é™¤æ­¤ä»¥å¤–ï¼Œæœ‰æ—¶è¿˜ä¼šéœ€è¦æ£€æŸ¥é•œåƒçš„ tagï¼Œæ¯”å¦‚ç¦æ­¢ä½¿ç”¨ latest é•œåƒã€‚\nè¿™ä»Šå¤©æˆ‘ä»¬å°è¯•ç”¨â€œç­–ç•¥å³ä»£ç â€çš„å®ç° OPA æ¥å®ç°åŠŸèƒ½ã€‚\nè¿˜æ²¡å¼€å§‹ä¹‹å‰å¯èƒ½æœ‰äººä¼šé—®ï¼šæ˜æ˜å¯ä»¥å®ç°ä¸ª Admission Webhook å°±è¡Œï¼Œä¸ºä»€ä¹ˆè¿˜è¦åŠ ä¸Š OPAï¼Ÿ\nç¡®å®å¯ä»¥ï¼Œä½†æ˜¯è¿™æ ·ç­–ç•¥å’Œé€»è¾‘éƒ½ä¼šè€¦åˆåœ¨ä¸€èµ·ï¼Œå½“ç­–ç•¥éœ€è¦è°ƒæ•´çš„æ—¶å€™éœ€è¦ä¿®æ”¹ä»£ç é‡æ–°å‘å¸ƒã€‚è€Œ OPA å°±æ˜¯ç”¨æ¥åšè§£è€¦çš„ï¼Œå…¶æ›´åƒæ˜¯ä¸€ä¸ªç­–ç•¥çš„æ‰§è¡Œå¼•æ“ã€‚\nä»€ä¹ˆæ˜¯ OPA Open Policy Agentï¼ˆä»¥ä¸‹ç®€ç§° OPAï¼Œå‘éŸ³ â€œoh-paâ€ï¼‰ä¸€ä¸ªå¼€æºçš„é€šç”¨ç­–ç•¥å¼•æ“ï¼Œå¯ä»¥ç»Ÿä¸€æ•´ä¸ªå †æ ˆçš„ç­–ç•¥æ‰§è¡Œã€‚OPA æä¾›äº†ä¸€ç§é«˜çº§å£°æ˜æ€§è¯­è¨€ï¼ˆRegoï¼‰ï¼Œå¯è®©ä½ å°†ç­–ç•¥æŒ‡å®šä¸ºä»£ç å’Œç®€å•çš„ APIï¼Œä»¥ä»ä½ çš„è½¯ä»¶ä¸­å¸è½½ç­–ç•¥å†³ç­–ã€‚ä½ å¯ä»¥ä½¿ç”¨ OPA åœ¨å¾®æœåŠ¡ã€Kubernetesã€CI/CD ç®¡é“ã€API ç½‘å…³ç­‰ä¸­å®æ–½ç­–ç•¥ã€‚\nRego æ˜¯ä¸€ç§é«˜çº§çš„å£°æ˜æ€§è¯­è¨€ï¼Œæ˜¯ä¸“é—¨ä¸º OPA å»ºç«‹çš„ã€‚æ›´å¤š OPA çš„ä»‹ç»å¯ä»¥çœ‹ Open Policy Agent å®˜ç½‘ï¼Œä¸æƒ³çœ‹è‹±æ–‡ç›´æ¥çœ‹è¿™é‡Œã€‚\nç°åœ¨è¿›å…¥æ­£é¢˜ã€‚\nå¯åŠ¨é›†ç¾¤ å¯åŠ¨ minikube\nminikube start åˆ›å»ºç”¨äºéƒ¨ç½² OPA çš„å‘½åç©ºé—´ åˆ›å»ºå¹¶åˆ‡æ¢åˆ°å‘½åç©ºé—´ opa ï¼ˆå‘½åç©ºé—´çš„åˆ‡æ¢ä½¿ç”¨ kubensï¼Œæ›´å¤šå·¥å…·ä»‹ç»è§è¿™é‡Œï¼‰\nkubectl create namespace opa kubens opa åœ¨ Kubernetes ä¸Šéƒ¨ç½² OPA Kubernetes å’Œ OPA é—´çš„é€šä¿¡å¿…é¡»ä½¿ç”¨ TLS è¿›è¡Œä¿æŠ¤ã€‚é…ç½® TLSï¼Œä½¿ç”¨ openssl åˆ›å»ºè¯ä¹¦é¢å‘æœºæ„ï¼ˆcertificate authority CAï¼‰å’Œ OPA çš„è¯ä¹¦/ç§˜é’¥å¯¹ã€‚\nopenssl genrsa -out ca.key 2048 openssl req -x509 -new -nodes -key ca.key -days 100000 -out ca.crt -subj \u0026#34;/CN=admission_ca\u0026#34; ä¸º OPA åˆ›å»º TLS ç§˜é’¥å’Œè¯ä¹¦ï¼š\ncat \u0026gt;server.conf \u0026lt;\u0026lt;EOF [req] req_extensions = v3_req distinguished_name = req_distinguished_name prompt = no [req_distinguished_name] CN = opa.opa.svc [ v3_req ] basicConstraints = CA:FALSE keyUsage = nonRepudiation, digitalSignature, keyEncipherment extendedKeyUsage = clientAuth, serverAuth subjectAltName = @alt_names [alt_names] DNS.1 = opa.opa.svc EOF æ³¨æ„ CN å’Œ alt_names å¿…é¡»ä¸åé¢åˆ›å»º OPA service çš„åŒ¹é…ã€‚\nopenssl genrsa -out server.key 2048 openssl req -new -key server.key -out server.csr -config server.conf openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 100000 -extensions v3_req -extfile server.conf ä¸º OPA åˆ›å»ºä¿å­˜ TLS å‡­è¯çš„ Secretï¼š\nkubectl create secret tls opa-server --cert=server.crt --key=server.key å°† OPA éƒ¨ç½²ä¸ºå‡†å…¥æ§åˆ¶å™¨ï¼ˆadmission controllerï¼‰ã€‚\nadmission-controller.yamlï¼š\n# æˆæƒ OPA/kube-mgmt å¯¹èµ„æºçš„åªè¯»æƒé™ # kube-mgmt ä¼šåŒæ­¥èµ„æºä¿¡æ¯ç»™ OPAï¼Œä»¥ä¾¿åœ¨ç­–ç•¥ä¸­ä½¿ç”¨ kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: opa-viewer roleRef: kind: ClusterRole name: view apiGroup: rbac.authorization.k8s.io subjects: - kind: Group name: system:serviceaccounts:opa apiGroup: rbac.authorization.k8s.io --- # ä¸º OPA/kube-mgmt å®šä¹‰è§’è‰²æ¥åœ¨ configmaps ä¸­æ›´æ–°ç­–ç•¥çŠ¶æ€ kind: Role apiVersion: rbac.authorization.k8s.io/v1 metadata: namespace: opa name: configmap-modifier rules: - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;configmaps\u0026#34;] verbs: [\u0026#34;update\u0026#34;, \u0026#34;patch\u0026#34;] --- # ä¸º OPA/kube-mgmt æˆäºˆè§’è‰² kind: RoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: namespace: opa name: opa-configmap-modifier roleRef: kind: Role name: configmap-modifier apiGroup: rbac.authorization.k8s.io subjects: - kind: Group name: system:serviceaccounts:opa apiGroup: rbac.authorization.k8s.io --- kind: Service apiVersion: v1 metadata: name: opa namespace: opa spec: selector: app: opa ports: - name: https protocol: TCP port: 443 targetPort: 8443 --- apiVersion: apps/v1 kind: Deployment metadata: labels: app: opa namespace: opa name: opa spec: replicas: 1 selector: matchLabels: app: opa template: metadata: labels: app: opa name: opa spec: containers: # WARNING: OPA is NOT running with an authorization policy configured. This # means that clients can read and write policies in OPA. If you are # deploying OPA in an insecure environment, be sure to configure # authentication and authorization on the daemon. See the Security page for # details: https://www.openpolicyagent.org/docs/security.html. - name: opa image: openpolicyagent/opa:0.30.1-rootless args: - \u0026#34;run\u0026#34; - \u0026#34;--server\u0026#34; - \u0026#34;--tls-cert-file=/certs/tls.crt\u0026#34; - \u0026#34;--tls-private-key-file=/certs/tls.key\u0026#34; - \u0026#34;--addr=0.0.0.0:8443\u0026#34; - \u0026#34;--addr=http://127.0.0.1:8181\u0026#34; - \u0026#34;--log-format=json-pretty\u0026#34; - \u0026#34;--set=decision_logs.console=true\u0026#34; volumeMounts: - readOnly: true mountPath: /certs name: opa-server readinessProbe: httpGet: path: /health?plugins\u0026amp;bundle scheme: HTTPS port: 8443 initialDelaySeconds: 3 periodSeconds: 5 livenessProbe: httpGet: path: /health scheme: HTTPS port: 8443 initialDelaySeconds: 3 periodSeconds: 5 - name: kube-mgmt image: openpolicyagent/kube-mgmt:0.11 args: - \u0026#34;--replicate=v1/pods\u0026#34; volumes: - name: opa-server secret: secretName: opa-server --- kind: ConfigMap apiVersion: v1 metadata: name: opa-default-system-main namespace: opa data: main: | package system import data.kubernetes.validating.images main = { \u0026#34;apiVersion\u0026#34;: \u0026#34;admission.k8s.io/v1beta1\u0026#34;, \u0026#34;kind\u0026#34;: \u0026#34;AdmissionReview\u0026#34;, \u0026#34;response\u0026#34;: response, } default uid = \u0026#34;\u0026#34; uid = input.request.uid response = { \u0026#34;allowed\u0026#34;: false, \u0026#34;uid\u0026#34;: uid, \u0026#34;status\u0026#34;: { \u0026#34;reason\u0026#34;: reason, }, } { reason = concat(\u0026#34;, \u0026#34;, images.deny) reason != \u0026#34;\u0026#34; } else = {\u0026#34;allowed\u0026#34;: true, \u0026#34;uid\u0026#34;: uid} kubectl apply -f admission-controller.yaml æ¥ä¸‹æ¥ï¼Œç”Ÿæˆå°†ç”¨äºå°† OPA æ³¨å†Œä¸ºå‡†å…¥æ§åˆ¶å™¨çš„ manifestã€‚\ncat \u0026gt; webhook-configuration.yaml \u0026lt;\u0026lt;EOF kind: ValidatingWebhookConfiguration apiVersion: admissionregistration.k8s.io/v1beta1 metadata: name: opa-validating-webhook webhooks: - name: validating-webhook.openpolicyagent.org rules: - operations: [\u0026#34;CREATE\u0026#34;, \u0026#34;UPDATE\u0026#34;] apiGroups: [\u0026#34;*\u0026#34;] apiVersions: [\u0026#34;*\u0026#34;] resources: [\u0026#34;pods\u0026#34;] clientConfig: caBundle: $(cat ca.crt | base64 | tr -d \u0026#39;\\n\u0026#39;) service: namespace: opa name: opa EOF ç”Ÿæˆçš„é…ç½®æ–‡ä»¶åŒ…å« CA è¯ä¹¦çš„ base64 ç¼–ç ï¼Œä»¥ä¾¿å¯ä»¥åœ¨ Kubernetes API æœåŠ¡å™¨å’Œ OPA ä¹‹é—´å»ºç«‹ TLS è¿æ¥ã€‚\nkubectl apply -f webhook-configuration.yaml æŸ¥çœ‹ OPA æ—¥å¿—ï¼š\nkubectl logs -l app=opa -c opa -f å®šä¹‰ç­–ç•¥å¹¶é€šè¿‡ Kubernetes å°†å…¶åŠ è½½åˆ° OPA è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†å¯¹å®¹å™¨é•œåƒçš„æ£€æŸ¥ï¼š\næ˜¯å¦æ¥è‡ªå—ä¿¡ä»»çš„ä»“åº“ æ˜¯å¦ä½¿ç”¨äº† latest tag çš„é•œåƒ image-policy.rego\npackage kubernetes.validating.images deny[msg] { some i input.request.kind.kind == \u0026#34;Pod\u0026#34; image := input.request.object.spec.containers[i].image endswith(image, \u0026#34;:latest\u0026#34;) msg := sprintf(\u0026#34;Image \u0026#39;%v\u0026#39; used latest image\u0026#34;, [image]) } { some i input.request.kind.kind == \u0026#34;Pod\u0026#34; image := input.request.object.spec.containers[i].image not startswith(image, \u0026#34;192.168.64.1:5000\u0026#34;) msg := sprintf(\u0026#34;Image \u0026#39;%v\u0026#39; comes from untrusted registry\u0026#34;, [image]) } kubectl create configmap image-policy --from-file=image-policy.rego æ£€æŸ¥ configmap çš„ annotation openpolicyagent.org/policy-status å€¼æ˜¯å¦ ä¸º '{\u0026quot;status\u0026quot;:\u0026quot;ok\u0026quot;}'ã€‚å¦åˆ™ï¼Œå°±è¦æ ¹æ®æŠ¥é”™ä¿¡æ¯å¤„ç†é—®é¢˜ã€‚\næ³¨ï¼š192.168.64.1:5000 æ˜¯ç¬”è€…æœ¬åœ°å®¹å™¨è¿è¡Œçš„ä¸€ä¸ªç§æœ‰ä»“åº“ã€‚\nversion: \u0026#39;3.6\u0026#39; services: registry: image: registry:2.7.1 container_name: registry restart: always environment: REGISTRY_HTTP_ADDR: 0.0.0.0:5000 REGISTRY_STORAGE: filesystem REGISTRY_STORAGE_DELETE_ENABLED: \u0026#39;true\u0026#39; REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry ports: - \u0026#39;5000:5000\u0026#39; volumes: - \u0026#39;/Users/addo/Downloads/tmp/registry:/var/lib/registry\u0026#39; æµ‹è¯• pod-bad-repo.yaml apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: web-server name: web-server spec: containers: - image: nginx:1.21.1 name: web-server resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} kubectl apply -f pod-bad-repo.yaml Error from server (Image \u0026#39;nginx:1.21.1\u0026#39; comes from untrusted registry): error when creating \u0026#34;pod-bad-repo.yaml\u0026#34;: admission webhook \u0026#34;validating-webhook.openpolicyagent.org\u0026#34; denied the request: Image \u0026#39;nginx:1.21.1\u0026#39; comes from untrusted registry pod-bad-tag.yaml apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: web-server name: web-server spec: containers: - image: 192.168.64.1:5000/nginx:latest name: web-server resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} kubectl apply -f pod-bad-tag.yaml Error from server (Image \u0026#39;192.168.64.1:5000/nginx:latest\u0026#39; used latest image): error when creating \u0026#34;pod-bad-tag.yaml\u0026#34;: admission webhook \u0026#34;validating-webhook.openpolicyagent.org\u0026#34; denied the request: Image \u0026#39;192.168.64.1:5000/nginx:latest\u0026#39; used latest image pod-ok.yaml apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: web-server name: web-server spec: containers: - image: 192.168.64.1:5000/nginx:1.21.1 name: web-server resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} kubectl apply -f pod-ok.yaml pod/web-server created æ€»ç»“ ç­–ç•¥å³ä»£ç ï¼Œä»¥ä»£ç çš„å®ç°è¡¨è¾¾ç­–ç•¥ï¼›åœ¨é€šè¿‡ç­–ç•¥ä¸æ‰§è¡Œå¼•æ“çš„è§£è€¦åˆ†ç¦»ï¼Œè®©ç­–ç•¥æ›´åŠ çš„çµæ´»ã€‚\nåé¢æˆ‘ä»¬å†æ¢ç´¢ OPA çš„æ›´å¤šåœºæ™¯ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/image-trusted-repository-with-open-policy-agent/","tags":["OPA","Kubernetes","Docker"],"title":"ä½¿ç”¨ Open Policy Agent å®ç°å¯ä¿¡é•œåƒä»“åº“æ£€æŸ¥"},{"categories":["ç¬”è®°"],"contents":"Kubernetes ä½¿ç”¨æœ‰å¥½å‡ å¹´äº†ï¼Œä½†åœ¨ä»Šå¹´ 5 æœˆæ‰å®Œæˆ CKA çš„è€ƒè¯•ã€‚è™½è¯´ç”¨äº†å‡ å¹´ï¼Œè¿˜æ˜¯æå‰åˆ·äº†éƒ¨åˆ†é¢˜ç†Ÿæ‚‰ä¸‹ã€‚\nç»å¤§éƒ¨åˆ†é¢˜éƒ½æ˜¯æœ‰åœ¨ minikube çš„ç¯å¢ƒä¸Šæ“ä½œè¿‡ï¼Œåªæœ‰éƒ¨åˆ†æ¯”å¦‚å‡çº§é›†ç¾¤å—é™äºç¯å¢ƒé—®é¢˜æ²¡æœ‰å®åœ°æ“ä½œã€‚\nå†™åœ¨æœ€å‰ ä¿å­˜å¸¸ç”¨æ–‡æ¡£è¿›ä¹¦ç­¾ï¼Œå¦‚æœæœ‰ Alfred å¯ç”¨æµè§ˆå™¨ä¹¦ç­¾ workflowã€‚æ•ˆæœè§ä¸‹å›¾ kubectl è‡ªåŠ¨è¡¥å…¨ echo \u0026quot;source \u0026lt;(kubectl completion bash)\u0026quot; \u0026gt;\u0026gt; ~/.bashrc; source ~/.bashrc æ¯é“é¢˜å¼€å§‹å‰è¦åˆ‡æ¢ context å’Œ namespaceï¼Œç›´æ¥å¤åˆ¶é¢˜ç›®é‡Œçš„å‘½ä»¤å³å¯ å¿…è¦çš„ alias å–„ç”¨ --dry-run=client -o yaml é¿å…æ‰‹åŠ¨æ•²å¤ªå¤š å–„ç”¨ kubectl explain [resource[.field]] çœ‹æ‡‚é¢˜ç›®æœ€é‡è¦ï¼Œè¾“å‡ºæ­£ç¡®çš„ç»“æœæ›´é‡è¦ï¼ˆé‡è¦çš„äº‹è®²ä¸‰éï¼‰ çœ‹æ‡‚é¢˜ç›®æœ€é‡è¦ï¼Œè¾“å‡ºæ­£ç¡®çš„ç»“æœæ›´é‡è¦ï¼ˆé‡è¦çš„äº‹è®²ä¸‰éï¼‰ çœ‹æ‡‚é¢˜ç›®æœ€é‡è¦ï¼Œè¾“å‡ºæ­£ç¡®çš„ç»“æœæ›´é‡è¦ï¼ˆé‡è¦çš„äº‹è®²ä¸‰éï¼‰ ä¹¦ç­¾åœ°å€ï¼šK8s-CKA-CAKD-Bookmarks.html\nå®‰å…¨ï¼šRBAC åœ¨é»˜è®¤å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ªåä¸º dev-sa çš„æœåŠ¡å¸æˆ·ï¼Œdev-sa å¯ä»¥åœ¨ dev å‘½åç©ºé—´ä¸­åˆ›å»ºä»¥ä¸‹ç»„ä»¶ï¼š Deploymentã€StatefulSetã€DaemonSet\nçŸ¥è¯†ç‚¹ role sa rolebinding auth can-i å‚è€ƒæ–‡æ¡£ï¼š https://kubernetes.io/docs/reference/access-authn-authz/rbac/#command-line-utilities\nè§£é¢˜æ€è·¯ $ kubectl create sa dev-sa $ kubectl create role dev-role --verb=create --resource=deployment,statefulset,daemonset #æ£€æŸ¥ $ kubectl describe role dev-role Name: dev-role Labels: \u0026lt;none\u0026gt; Annotations: \u0026lt;none\u0026gt; PolicyRule: Resources Non-Resource URLs Resource Names Verbs --------- ----------------- -------------- ----- daemonsets.apps [] [] [create] deployments.apps [] [] [create] statefulsets.apps [] [] [create] $ kubectl create rolebinding dev --serviceaccount default:dev-sa --role dev-role #æ£€æŸ¥ $ kubectl auth can-i create deployment --as system:serviceaccount:default:dev-sa yes $ kubectl auth can-i create statefulset --as system:serviceaccount:default:dev-sa yes $ kubectl auth can-i create daemonset --as system:serviceaccount:default:dev-sa yes $ kubectl auth can-i create pod --as system:serviceaccount:default:dev-sa no å¤šå®¹å™¨ Pod åˆ›å»ºä¸€ä¸ªpodåç§°æ—¥å¿—ï¼Œå®¹å™¨åç§° log-pro ä½¿ç”¨image busyboxï¼Œåœ¨ /log/data/output.log è¾“å‡ºé‡è¦ä¿¡æ¯ã€‚ç„¶åå¦ä¸€ä¸ªå®¹å™¨åç§° log-cus ä½¿ç”¨ image busyboxï¼Œåœ¨ /log/data/output.log åŠ è½½ output.log å¹¶æ‰“å°å®ƒã€‚ è¯·æ³¨æ„ï¼Œæ­¤æ—¥å¿—æ–‡ä»¶åªèƒ½åœ¨ pod å†…å…±äº«ã€‚\nçŸ¥è¯†ç‚¹ pod volume: emptyDir å‚è€ƒæ–‡æ¡£ï¼š https://kubernetes.io/docs/concepts/storage/volumes/#emptydir\nè§£é¢˜æ€è·¯ kubectl run log --image busybox --dry-run=client -o yaml \u0026gt; log.yaml ä¿®æ”¹ log.yaml\napiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: log name: log spec: containers: - command: - sh - -c - echo important information \u0026gt; /log/data/output.log; sleep 1d image: busybox name: log-pro resources: {} imagePullPolicy: IfNotPresent volumeMounts: - mountPath: /log/data name: log - command: - sh - -c - tail -f /log/data/output.log image: busybox name: log-cus imagePullPolicy: IfNotPresent volumeMounts: - mountPath: /log/data name: log dnsPolicy: ClusterFirst restartPolicy: Always volumes: - name: log emptyDir: {} status: {} æ‰§è¡Œåˆ›å»º kubectl apply -f log.yaml\næ£€æŸ¥\n$ kubectl logs log -c log-cus important information å®‰å…¨ï¼šç½‘ç»œç­–ç•¥ NetworkPolicy åªæœ‰å‘½åç©ºé—´ mysql çš„ pod åªèƒ½è¢«å¦ä¸€ä¸ªå‘½åç©ºé—´ internal çš„ pod é€šè¿‡ 8080 ç«¯å£è¿›è¡Œè®¿é—®\nçŸ¥è¯†ç‚¹ NetworkPolicy Ingress å‚è€ƒæ–‡æ¡£ï¼š https://kubernetes.io/docs/concepts/services-networking/network-policies/#the-networkpolicy-resource\nè§£é¢˜æ€è·¯ apiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: cka-network namespace: target #ç›®çš„å‘½åç©ºé—´ spec: podSelector: {} policyTypes: - Ingress #ç­–ç•¥å½±å“å…¥æ ˆæµé‡ ingress: - from: #å…è®¸æµé‡çš„æ¥æº - namespaceSelector: matchLabels: ns: source #æºå‘½åç©ºé—´çš„ label ports: - protocol: TCP port: 8080 #å…è®¸è®¿é—®çš„ç«¯å£ èŠ‚ç‚¹çŠ¶æ€åŠæ±¡ç‚¹ ç»Ÿè®¡è¿™ä¸ªé›†ç¾¤ä¸­æ²¡æœ‰æ±¡æŸ“çš„å°±ç»ªèŠ‚ç‚¹ï¼Œå¹¶è¾“å‡ºåˆ°æ–‡ä»¶ /root/cka/readyNode.txtã€‚\nçŸ¥è¯†ç‚¹ Node Taintï¼ˆæ±¡ç‚¹ï¼‰ å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/\nè§£é¢˜æ€è·¯ # Ready çŠ¶æ€çš„æ•°é‡ $ kubectl get node | grep -w Ready | wc -l # æŸ¥çœ‹å«æœ‰ Taint çš„æ•°é‡ï¼Œéœ€è¦æ’é™¤æ‰è¿™äº› $ kubectl describe node | grep Taints | grep -i NoSchedule | wc -l èµ„æº å°†å ç”¨CPUèµ„æºæœ€å¤šçš„podåç§°è¾“å‡ºåˆ°æ–‡ä»¶ /root/cka/name.txt\nçŸ¥è¯†ç‚¹ kubectl top å‘½ä»¤ metrics è§£é¢˜æ€è·¯ å¦‚æœæ˜¯ minikube ç¯å¢ƒï¼ŒæŠ¥é”™ error: Metrics API not availableï¼Œå¯ä»¥æ‰§è¡Œ minikube addons enable metrics-server å‘½ä»¤å¼€å¯ metrics serverã€‚\né€šè¿‡ kubectl top å‘½ä»¤æ‰¾åˆ° cpu æœ€é«˜çš„ podï¼Œå°†å…¶åå­—å†™å…¥ /root/cka/name.txtã€‚\n$ kubectl top pod # æˆ–è€… $ kubectl top pod | sort -k 2 -n ç½‘ç»œï¼šDNS æœ‰ pod åç§° pod-nginxï¼Œåˆ›å»ºæœåŠ¡åç§° service-nginxï¼Œä½¿ç”¨ nodePort æš´éœ²podã€‚ ç„¶ååˆ›å»ºä¸€ä¸ª pod ä½¿ç”¨ image busybox æ¥ nslookup pod pod-nginx å’Œ service service-nginxã€‚\nçŸ¥è¯†ç‚¹ service with nodePort kubectl expose kubectl run å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/concepts/services-networking/dns-pod-service/\nè§£é¢˜æ€è·¯ ä½¿ç”¨ kubectl expose åˆ›å»º serviceã€‚\n# åˆ›å»º service kubectl expose pod pod-nginx --name service-nginx --type NodePort --target-port 80 # åˆ›å»º pod kubectl run busybox --image busybox:latest --command sleep 1h è·å– pod çš„ ip åœ°å€ï¼Œpod çš„ dns lookup éœ€è¦ç”¨ç”¨åˆ° ipã€‚\n$ kubectl get po -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES busybox 1/1 Running 0 2m17s 172.17.0.5 cka \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; pod-nginx 1/1 Running 0 59m 172.17.0.4 cka \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; æ‰§è¡Œ nslookup\n$ kubectl exec busybox -it -- nslookup 172.17.0.4 4.0.17.172.in-addr.arpa\tname = 172-17-0-4.service-nginx.default.svc.cluster.local. $ kubectl exec busybox -it -- nslookup service-nginx Server:\t10.96.0.10 Address:\t10.96.0.10#53 Name:\tservice-nginx.default.svc.cluster.local Address: 10.110.253.70 å·¥ä½œè´Ÿè½½ï¼šæ‰©å®¹ å°†å‘½åç©ºé—´ dev ä¸­çš„ Deployment scale-deploy ç¼©æ”¾åˆ°ä¸‰ä¸ª pod å¹¶è®°å½•ä¸‹æ¥ã€‚\nå‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/concepts/workloads/controllers/deployment/#scaling-a-deployment\nçŸ¥è¯†ç‚¹ deployment scale up kubectl scale è§£é¢˜æ€è·¯ kubectl scale çš„ä½¿ç”¨ï¼Œéœ€è¦å‚æ•° --record è¿›è¡Œè®°å½•ï¼ˆå°†æ“ä½œå‘½ä»¤è®°å½•åˆ° deployment çš„ kubernetes.io/change-cause annotation ä¸­ï¼‰ã€‚\n$ kubectl scale deployment scale-deploy --replicas 3 --record é›†ç¾¤å¤‡ä»½åŠæ¢å¤ å¤‡ä»½ etcd å¹¶å°†å…¶ä¿å­˜åœ¨ä¸»èŠ‚ç‚¹ä¸Šçš„ /root/cka/etcd-backup.dbã€‚\næœ€åæ¢å¤å¤‡ä»½ã€‚\nçŸ¥è¯†ç‚¹ etcd çš„å¤‡ä»½åŠæ¢å¤ å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster\nè§£é¢˜æ€è·¯ Kubernetes çš„æ‰€æœ‰æ•°æ®éƒ½è®°å½•åœ¨ etcd ä¸­ï¼Œå¯¹ etcd è¿›è¡Œå¤‡ä»½å°±æ˜¯å¯¹é›†ç¾¤è¿›è¡Œå¤‡ä»½ã€‚\nè¿æ¥ etcd éœ€è¦è¯ä¹¦ï¼Œè¯ä¹¦å¯ä»¥ä» apiserver è·å–ï¼Œå› ä¸º apiserver éœ€è¦è¿æ¥ etcdã€‚æ–°ç‰ˆæœ¬çš„ apiserver éƒ½æ˜¯ä»¥ static pod çš„æ–¹å¼è¿è¡Œï¼Œè¯ä¹¦æ˜¯é€šè¿‡ volume æŒ‚è½½åˆ° pod ä¸­çš„ã€‚\næ¯”å¦‚ minikube ç¯å¢ƒï¼Œè¯ä¹¦æ˜¯ä» node èŠ‚ç‚¹çš„ /var/lib/minikube/certs æŒ‚è½½è¿›å»çš„ã€‚\nè¦å…ˆ ssh åˆ° master èŠ‚ç‚¹ä¸Šã€‚å‘½ä»¤çš„æ‰§è¡Œéå¸¸å¿«ï¼Œå¦‚æœé•¿æ—¶é—´æ²¡ç»“æŸï¼Œé‚£å°±è¯´åæœ‰é—®é¢˜äº†ã€‚\n#å¤‡ä»½ $ ETCDCTL_API=3 etcdctl snapshot save /root/cka/etcd-backup.db \\ --endpoints=https://127.0.0.1:2379 \\ --cacert=/var/lib/minikube/certs/etcd/ca.crt \\ --cert=/var/lib/minikube/certs/apiserver-etcd-client.crt \\ --key=/var/lib/minikube/certs/apiserver-etcd-client.key ç”±äºåªè¯´äº† restoreï¼Œæ‰€ä»¥å°±æ‰§è¡Œ restore çš„å‘½ä»¤ï¼Œé»˜è®¤ä¼šæ¢å¤åˆ°å½“å‰ç›®å½•çš„ default.etcd ä¸‹ã€‚\n#æ¢å¤ $ ETCDCTL_API=3 etcdctl snapshot restore /root/cka/etcd-backup.db \\ --endpoints=https://127.0.0.1:2379 \\ --cacert=/var/lib/minikube/certs/etcd/ca.crt \\ --cert=/var/lib/minikube/certs/apiserver-etcd-client.crt \\ --key=/var/lib/minikube/certs/apiserver-etcd-client.key é›†ç¾¤èŠ‚ç‚¹å‡çº§ å°†masterèŠ‚ç‚¹ç‰ˆæœ¬ä» 1.20.0 å‡çº§åˆ° 1.21.0ï¼Œç¡®ä¿ master èŠ‚ç‚¹ä¸Šçš„ pod é‡æ–°è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œå‡çº§å®Œæˆåï¼Œä½¿ master èŠ‚ç‚¹å¯ç”¨ã€‚\nçŸ¥è¯†ç‚¹ drain cordon å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/#upgrading-control-plane-nodes\nè§£é¢˜æ€è·¯ å—é™äºç¯å¢ƒï¼Œæ²¡æœ‰å®åœ°æ“ä½œã€‚\n# å°†èŠ‚ç‚¹è®¾ç½®ä¸ºä¸å¯è°ƒåº¦ $ kubectl cordon master # é©±é€ master èŠ‚ç‚¹ä¸Šçš„ pod $ kubectl drain master --ignore-daemonsets # è¿›è¡Œå‡çº§ $ apt-mark unhold kubelet kubectl \u0026amp;\u0026amp; \\ apt-get update \u0026amp;\u0026amp; apt-get install -y kubelet=1.21.0-00 kubectl=1.21.0-00 \u0026amp;\u0026amp; \\ apt-mark hold kubelet kubectl # é‡æ–°å¯åŠ¨kubelet $ systemctl daemon-reload $ systemctl restart kubelet # å°†èŠ‚ç‚¹è®¾ç½®ä¸ºå¯è°ƒåº¦ $ kubectl uncordon master é›†ç¾¤ï¼šèŠ‚ç‚¹æ•…éšœæ’æŸ¥ ç°åœ¨ node01 è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œè¯·æ‰¾å‡ºæ ¹æœ¬åŸå› å¹¶ä½¿å…¶å‡†å¤‡å¥½ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç¡®ä¿å®ƒåœ¨ node01 ä¸Šè¿è¡Œçš„ podã€‚\nçŸ¥è¯†ç‚¹ èŠ‚ç‚¹æ•…éšœæ’æŸ¥ è§£é¢˜æ€è·¯ è¿™ç§é—®é¢˜å¤§æ¦‚ç‡é—®é¢˜å‡ºåœ¨ kubelet ä¸Š\nssh node01 systemctl status kubelet systemctl restart kubelet # å†æ£€æŸ¥nodeçŠ¶æ€ æ’æ’­ä¸€ä¸ªæ•…éšœï¼Œæœ¬åœ°å®‰è£… 2 ä¸ªèŠ‚ç‚¹çš„ minikube é›†ç¾¤æ—¶ï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹æŒç»­ NotReadyã€‚ä½¿ç”¨ systemctl status kubelet çœ‹åˆ° unable to update cni config: no networks found in /etc/cni/net.mkã€‚\næ£€æŸ¥è¯¥ç›®å½•ç¡®å®æ²¡æœ‰æ–‡ä»¶ï¼Œä» master èŠ‚ç‚¹å¤åˆ¶åˆ°è¯¥èŠ‚ç‚¹åé‡å¯ kubelet è§£å†³ã€‚\nå­˜å‚¨ï¼šæŒä¹…åŒ–å· é›†ç¾¤ä¸­æœ‰ä¸€ä¸ªæŒä¹…å·åç§° dev-pvï¼Œåˆ›å»ºä¸€ä¸ªæŒä¹…å·å£°æ˜åç§° dev-pvcï¼Œç¡®ä¿è¿™ä¸ªæŒä¹…å·å£°æ˜ä¼šç»‘å®šæŒä¹…å·ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª pod åç§° test-pvcï¼Œå°†è¿™ä¸ª pvc æŒ‚è½½åˆ° path /tmp/dataï¼Œä½¿ç”¨ nginx é•œåƒã€‚\nçŸ¥è¯†ç‚¹ PersistentVolume PersistentVolumeClaim Mount Volume å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolume\nè§£é¢˜æ€è·¯ åˆ›å»º pvc å‰å…ˆè·å– pvçš„ä¿¡æ¯\n$ kubectl get pv dev-pv -o yaml åˆ›å»º pv\n$ cat \u0026gt; pvc.yaml \u0026lt;\u0026lt;EOF apiVersion: v1 kind: PersistentVolumeClaim metadata: name: dev-pvc spec: accessModes: - ReadWriteOnce resources: requests: storage: 1Gi EOF $ kubectl apply -f pvc.yaml åˆ›å»º pod çš„ manifestï¼Œè®°å¾—ä½¿ç”¨ kubectl run --dry-run=client -o yaml\nkubectl run test-pvc --image nginx --dry-run=client -o yaml \u0026gt; test-pvc.yaml ä¿®æ”¹ä¹‹åå¾—åˆ°æœ€ç»ˆçš„ pod yaml\napiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: test-pvc name: test-pvc spec: volumes: - name: data persistentVolumeClaim: claimName: dev-pvc containers: - image: nginx name: test-pvc resources: {} volumeMounts: - name: data mountPath: /tmp/data dnsPolicy: ClusterFirst restartPolicy: Always ç†è®ºä¸Šåªè¦ pod èƒ½è¿è¡Œï¼Œå°±è¯´æ˜æˆåŠŸã€‚ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥ç¡®è®¤æŒ‚è½½æ˜¯å¦æˆåŠŸï¼Œåœ¨ pod çš„ /tmp/data ä¸­ touch ä¸ªæ–‡ä»¶ï¼Œç„¶ååˆ°èŠ‚ç‚¹çš„ç›®å½•ä¸­æŸ¥çœ‹æ˜¯æœ‰è¯¥æ–‡ä»¶ã€‚\nå·¥ä½œè´Ÿè½½ï¼šå¤šå®¹å™¨çš„ Deployment åˆ›å»ºä¸€ä¸ªåä¸º deploy-important çš„ Deploymentï¼Œæ ‡ç­¾ä¸º id=very-importantï¼ˆpod ä¹Ÿåº”è¯¥æœ‰è¿™ä¸ªæ ‡ç­¾ï¼‰å’Œå‘½åç©ºé—´ dev ä¸­çš„ 3 ä¸ªå‰¯æœ¬ã€‚ å®ƒåº”è¯¥åŒ…å«ä¸¤ä¸ªå®¹å™¨ï¼Œç¬¬ä¸€ä¸ªåä¸º container1 å¹¶å¸¦æœ‰é•œåƒï¼Œç¬¬äºŒä¸ªåä¸º container2 çš„å›¾åƒä¸º kubernetes/pauseã€‚\nåœ¨ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šåº”è¯¥åªè¿è¡Œè¯¥éƒ¨ç½²çš„ä¸€ä¸ª Podã€‚ æˆ‘ä»¬æœ‰ä¸¤ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼šcluster1-worker1 å’Œ cluster1-worker2ã€‚ å› ä¸º Deployment æœ‰ä¸‰ä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥ç»“æœåº”è¯¥æ˜¯åœ¨ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰ä¸€ä¸ª Pod æ­£åœ¨è¿è¡Œã€‚ ä¸ä¼šè°ƒåº¦ç¬¬ä¸‰ä¸ª Podï¼Œé™¤éæ·»åŠ æ–°çš„å·¥ä½œèŠ‚ç‚¹ã€‚\nçŸ¥è¯†ç‚¹ deployment pod label replicas multi container pod pod anti affinity å®˜æ–¹æ–‡æ¡£å‚è€ƒï¼šhttps://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#never-co-located-in-the-same-node\nè§£é¢˜æ€è·¯ å…ˆåˆ›å»ºæ¨¡æ¿\n$ kubectl create deployment deploy-important --image nginx --replicas 3 --dry-run=client -o yaml \u0026gt; deploy-important.yaml ä¿®æ”¹åçš„ yaml\napiVersion: apps/v1 kind: Deployment metadata: creationTimestamp: null labels: app: deploy-important id: very-important name: deploy-important spec: replicas: 3 selector: matchLabels: app: deploy-important id: very-important strategy: {} template: metadata: creationTimestamp: null labels: app: deploy-important id: very-important spec: affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: id operator: In values: - very-important topologyKey: kubernetes.io/hostname containers: - image: nginx name: container1 resources: {} - image: kubernetes/pause name: container2 status: {} minikube ä¸Šæµ‹è¯•åªèƒ½è°ƒåº¦ä¸€ä¸ª podï¼Œç¬¦åˆé¢„æœŸ\n$ kgpo NAME READY STATUS RESTARTS AGE deploy-important-659d54fc47-6cp8r 0/2 Pending 0 3h10m deploy-important-659d54fc47-92z4d 2/2 Running 0 3h10m deploy-important-659d54fc47-c6llc 0/2 Pending 0 3h10m å­˜å‚¨ï¼šSecretçš„ä½¿ç”¨ åœ¨ secret å‘½åç©ºé—´ä¸‹ï¼Œä½¿ç”¨é•œåƒ busybox:1.31.1 åˆ›å»ºä¸€ä¸ªåä¸º secret-pod çš„ podï¼Œå¹¶ä¿è¯ pod è¿è¡Œä¸€æ®µæ—¶é—´\næœ‰ä¸ªåä¸º sercret1.yaml çš„ Secret æ–‡ä»¶ï¼Œåœ¨ secret å‘½åç©ºé—´ä¸‹åˆ›å»º Secretï¼Œå¹¶ä»¥åªè¯»çš„æ–¹å¼æŒ‚åœ¨åˆ° Pod çš„ /tmp/secret1 ç›®å½• åˆ›å»ºä¸€ä¸ªæ–°çš„ Secret secret2 åŒ…å« user=user1 å’Œ pass=1234ï¼Œåˆ†åˆ«ä»¥ç¼“è§£å˜é‡ APP_USER å’Œ APP_PASS è¾“å…¥åˆ° Pod ä¸­\nçŸ¥è¯†ç‚¹ secret toleration taints å‚è€ƒæ–‡æ¡£ï¼š https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets-as-environment-variables\nè§£é¢˜æ€è·¯ åˆ›å»º namespace\n$ kubectl create ns secret åˆ›å»º pod æ¨¡æ¿\n$ kubectl run secret-pod --image busybox:1.31.1 --dry-run=client -o yaml --command -- sleep 1d \u0026gt; secret-pod.yaml ä¿®æ”¹ secret1.yamlï¼Œä½¿ç”¨ secret namespace\napiVersion: v1 data: halt: IyEvYmluL2Jhc2g= kind: Secret metadata: creationTimestamp: \u0026#34;2021-05-15T07:48:02Z\u0026#34; name: secret1 namespace: secret type: Opaque åˆ›å»º secret2\n$ kubectl create secret generic secret2 --from-literal user=user1 --from-literal pass=1234 ä¿®æ”¹æ¨¡æ¿\napiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: secret-pod name: secret-pod spec: containers: - command: - sleep - 1d image: busybox:1.31.1 name: secret-pod env: - name: APP_USER valueFrom: secretKeyRef: name: secret2 key: user - name: APP_PASS valueFrom: secretKeyRef: name: secret2 key: pass resources: {} volumeMounts: - mountPath: /tmp/secret1 name: sec dnsPolicy: ClusterFirst restartPolicy: Always volumes: - name: sec secret: secretName: secret1 status: {} æ£€æŸ¥ç»“æœï¼š\n$ kubectl exec secret-pod -- cat /tmp/secret1/halt #!/bin/bash $ kubectl exec secret-pod -- env | grep \u0026#39;APP_\u0026#39; APP_USER=user1 APP_PASS=1234 å·¥ä½œè´Ÿè½½ï¼šé™æ€ Pod åœ¨ cluster3-master1 ä¸Šçš„ default å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ªåä¸º my-static-pod çš„é™æ€ Podã€‚ ä½¿ç”¨é•œåƒ nginx:1.16-alpine å¹¶åˆ†é… 10m CPU å’Œ 20Mi å†…å­˜çš„èµ„æºã€‚\nThen create a NodePort Service named static-pod-service which exposes that static Pod on port 80 and check if it has Endpoints and if its reachable through the cluster3-master1 internal IP address. You can connect to the internal node IPs from your main terminal. ç„¶ååˆ›å»ºä¸€ä¸ªåä¸º static-pod-service çš„ NodePort Serviceï¼Œè¯¥æœåŠ¡åœ¨ç«¯å£ 80 ä¸Šå…¬å¼€è¯¥é™æ€ Podï¼Œå¹¶æ£€æŸ¥å®ƒæ˜¯å¦å…·æœ‰ç«¯ç‚¹ä»¥åŠæ˜¯å¦å¯ä»¥é€šè¿‡ cluster3-master1 å†…éƒ¨ IP åœ°å€è®¿é—®å®ƒã€‚\nçŸ¥è¯†ç‚¹ static pod resource nodeport service endpoints å‚è€ƒæ–‡æ¡£ï¼š\nhttps://kubernetes.io/docs/tasks/configure-pod-container/static-pod/ https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory \u0008è§£é¢˜æ€è·¯ åˆ›å»ºpodæ¨¡æ¿\n$ kubectl run my-static-pod --image nginx:1.16-alpine --dry-run=client -o yaml \u0026gt; static-pod.yaml ä¿®æ”¹æ¨¡æ¿ï¼Œå¢åŠ èµ„æºé…ç½®\napiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: my-static-pod name: my-static-pod spec: containers: - image: nginx:1.16-alpine name: my-static-pod resources: requests: cpu: \u0026#34;10m\u0026#34; memory: \u0026#34;20Mi\u0026#34; dnsPolicy: ClusterFirst restartPolicy: Always status: {} ssh åˆ°ä¸»æœºï¼Œæ‰¾åˆ° kubelet é…ç½®æ–‡ä»¶çš„ä½ç½® ps -ef | grep kubelet\næŸ¥çœ‹é…ç½®æ–‡ä»¶ï¼ˆminikubeï¼š/var/lib/kubelet/config.yamlï¼‰ä¸­ staticPodPath é…ç½®çš„å°±æ˜¯é™æ€ pod çš„ manifest çš„ä½ç½®ï¼ˆminikubeï¼š/etc/kubernetes/manifestsï¼‰\nå°† static-pod.yaml æ”¾åˆ°æ­£ç¡®çš„æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åé‡å¯ kubelet\n$ systemctl restart kubelet æ£€æŸ¥podæ˜¯å¦æ­£ç¡®è¿è¡Œ\nåˆ›å»º node port\n$ kubectl expose pod my-static-pod --name static-pod-service --type NodePort --port 80 æ£€æŸ¥æ˜¯å¦åˆ›å»ºæˆåŠŸ\n$ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE static-pod-service NodePort 10.97.248.99 \u0026lt;none\u0026gt; 80:31938/TCP 68s è·å– node çš„ ip\n$ kubectl get node -o wide NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME cka Ready master 10h v1.18.8 192.168.64.3 \u0026lt;none\u0026gt; Buildroot 2020.02.10 4.19.171 docker://20.10.4 åœ¨ minikube çš„ç¯å¢ƒä¸‹å¯ç›´æ¥é€šè¿‡ minikube ip è·å–\næµ‹è¯•\n$ http 192.168.64.3:31938 --headers HTTP/1.1 200 OK Accept-Ranges: bytes Connection: keep-alive Content-Length: 612 Content-Type: text/html Date: Sat, 15 May 2021 08:35:11 GMT ETag: \u0026#34;5d52db33-264\u0026#34; Last-Modified: Tue, 13 Aug 2019 15:45:55 GMT Server: nginx/1.16.1 è°ƒåº¦ï¼šæ±¡ç‚¹å’Œå®¹å¿åº¦ åœ¨å‘½åç©ºé—´ default ä¸­åˆ›å»ºå›¾åƒ httpd:2.4.41-alpine çš„å•ä¸ª Podã€‚Pod åº”å‘½åä¸º pod1ï¼Œå®¹å™¨åä¸º pod1-containerã€‚åœ¨ä¸ç»™ä»»ä½•èŠ‚ç‚¹æ·»åŠ æ–°æ ‡ç­¾çš„å‰æä¸‹ï¼Œå°†è¯¥ pod è°ƒåº¦åˆ°ä¸»èŠ‚ç‚¹ä¸Šã€‚\nçŸ¥è¯†ç‚¹ Taint Label Tolerance å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/\nè§£é¢˜æ€è·¯ #æ‰¾å‡ºmasterèŠ‚ç‚¹ï¼ˆä¸€èˆ¬è€ƒè¯•åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼‰ $ kubectl get node #æ‰¾åˆ° master èŠ‚ç‚¹çš„ taintsï¼Œéœ€è¦åœ¨ pod çš„ .spec.tolerations æ’é™¤æ‰ $ kubectl describe node xxxx | grep -w Taints #æ‰¾åˆ° master èŠ‚ç‚¹çš„ labels $ kubectl describe node xxxx | grep -w Labels -A10 åˆ›å»ºpodæ¨¡æ¿\n$ kubectl run pod1 --image httpd:2.4.41-alpine --dry-run=client -o yaml \u0026gt; pod1.yaml ä¿®æ”¹æ¨¡æ¿ï¼š è¿™é‡Œå‡è®¾ä¸»èŠ‚ç‚¹çš„ Taint ä¸º node-role.kubernetes.io/master=:NoSchedule\n# minikube é›†ç¾¤åä¸º ckaï¼Œä¸»èŠ‚ç‚¹åŒå $ kubectl describe node cka | grep -i taint Taints: node-role.kubernetes.io/master:NoSchedule æœ€ç»ˆçš„ pod å¦‚ä¸‹\napiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: pod1 name: pod1 spec: containers: - image: httpd:2.4.41-alpine name: pod1 resources: {} dnsPolicy: ClusterFirst tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule nodeSelector: node-role.kubernetes.io/master: \u0026#34;\u0026#34; restartPolicy: Always status: {} æœ€åæ£€æŸ¥ä¸‹æ˜¯å¦è°ƒåº¦åˆ°ä¸»èŠ‚ç‚¹ä¸Šï¼š\n$ kubectl get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod1 1/1 Running 0 102s 10.244.0.3 cka \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kubectl å‘½ä»¤å’Œæ’åº æ‰€æœ‰å‘½åç©ºé—´ä¸­éƒ½æœ‰å„ç§ Podã€‚ å°†å‘½ä»¤å†™å…¥ /opt/course/5/find_pods.shï¼Œå…¶ä¸­åˆ—å‡ºæ‰€æœ‰æŒ‰ AGE æ’åºçš„ Podï¼ˆmetadata.creationTimestampï¼‰ã€‚\nå°†ç¬¬äºŒä¸ªå‘½ä»¤å†™å…¥ /opt/course/5/find_pods_uid.shï¼Œå…¶ä¸­åˆ—å‡ºæŒ‰å­—æ®µ metadata.uid æ’åºçš„æ‰€æœ‰ Podã€‚å¯¹è¿™ä¸¤ä¸ªå‘½ä»¤éƒ½ä½¿ç”¨ kubectl æ’åºã€‚\nçŸ¥è¯†ç‚¹ kubectl å‘½ä»¤çš„ä½¿ç”¨ï¼Œä¸»è¦æ˜¯ --all-namespaces ï¼ˆç¼©å†™ -Aï¼‰ å’Œ --sort-by è§£é¢˜æ€è·¯ $ cat \u0026gt; /opt/course/5/find_pods.sh \u0026lt;\u0026lt;EOF kubectl get pod -A --sort-by \u0026#39;.metadata.creationTimestamp\u0026#39; EOF $ cat \u0026gt; /opt/course/5/find_pods_uid.sh \u0026lt;\u0026lt;EOF kubectl get pod -A --sort-by \u0026#39;.metadata.uid\u0026#39; EOF å­˜å‚¨ï¼šæŒä¹…åŒ–å·å’ŒæŒ‚è½½ åˆ›å»ºä¸€ä¸ªåä¸º safari-pv çš„æ–° PersistentVolumeã€‚å®ƒåº”è¯¥å…·æœ‰ 2Gi çš„å®¹é‡ã€accessMode ReadWriteOnceã€hostPath /Volumes/Data å¹¶ä¸”æ²¡æœ‰å®šä¹‰ storageClassNameã€‚\næ¥ä¸‹æ¥åœ¨å‘½åç©ºé—´ project-tiger ä¸­åˆ›å»ºä¸€ä¸ªåä¸º safari-pvc çš„æ–° PersistentVolumeClaimã€‚ å®ƒåº”è¯¥è¯·æ±‚ 2Gi å­˜å‚¨ï¼ŒaccessMode ReadWriteOnce å¹¶ä¸”ä¸åº”å®šä¹‰ storageClassNameã€‚ PVC åº”è¯¥æ­£ç¡®ç»‘å®šåˆ° PVã€‚\næœ€ååœ¨å‘½åç©ºé—´ project-tiger ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ Deployment safariï¼Œå®ƒå°†è¯¥å·æŒ‚è½½åˆ° /tmp/safari-dataã€‚è¯¥ Deployment çš„ Pod åº”è¯¥æ˜¯é•œåƒ httpd:2.4.41-alpineã€‚\nçŸ¥è¯†ç‚¹ pv pvc pod ä½¿ç”¨ pvc deployment mount PVC volume å‚è€ƒæ–‡æ¡£ï¼š\nhttps://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolume https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolumeclaim https://kubernetes.io/docs/concepts/storage/persistent-volumes/#claims-as-volumes è§£é¢˜æ€è·¯ åˆ›å»º pv\napiVersion: v1 kind: PersistentVolume metadata: name: safari-pv labels: type: local spec: capacity: storage: 2Gi accessModes: - ReadWriteOnce hostPath: path: \u0026#34;/Volumes/Data\u0026#34; åˆ›å»º pvc\napiVersion: v1 kind: PersistentVolumeClaim metadata: name: safari-pvc spec: accessModes: - ReadWriteOnce resources: requests: storage: 2Gi æ£€æŸ¥æ˜¯å¦ç»‘å®šæˆåŠŸ\n$ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE safari-pvc Bound pvc-d4c15825-2de3-470f-8ed0-9519cacaad21 2Gi RWO standard 24s åˆ›å»º deployment æ¨¡æ¿\n$ kubectl create deployment safari --image httpd:2.4.41-alpine --dry-run=client -o yaml æœ€ç»ˆçš„yaml\napiVersion: apps/v1 kind: Deployment metadata: creationTimestamp: null labels: app: safari name: safari spec: replicas: 1 selector: matchLabels: app: safari strategy: {} template: metadata: creationTimestamp: null labels: app: safari spec: containers: - image: httpd:2.4.41-alpine name: httpd resources: {} volumeMounts: - mountPath: /tmp/safari-data name: data volumes: - name: data persistentVolumeClaim: claimName: safari-pvc status: {} kubectl å‘½ä»¤å’Œ context å¯ä»¥é€šè¿‡ kubectl ä¸Šä¸‹æ–‡ä»ä¸»ç»ˆç«¯è®¿é—®å¤šä¸ªé›†ç¾¤ã€‚å°†æ‰€æœ‰è¿™äº›ä¸Šä¸‹æ–‡åç§°å†™å…¥ /opt/course/1/contextsã€‚\næ¥ä¸‹æ¥åœ¨ /opt/course/1/context_default_kubectl.sh ä¸­å†™ä¸€ä¸ªæ˜¾ç¤ºå½“å‰ä¸Šä¸‹æ–‡çš„å‘½ä»¤ï¼Œè¯¥å‘½ä»¤åº”è¯¥ä½¿ç”¨kubectlã€‚\næœ€ååœ¨ /opt/course/1/context_default_no_kubectl.sh ä¸­å†™å…¥ç¬¬äºŒä¸ªæ‰§è¡Œç›¸åŒæ“ä½œçš„å‘½ä»¤ï¼Œä½†ä¸ä½¿ç”¨ kubectlã€‚\nçŸ¥è¯†ç‚¹ kubectl config ç›¸å…³å‘½ä»¤çš„ä½¿ç”¨\nè§£é¢˜æ€è·¯ kubectl config get-contexts -o name \u0026gt; /opt/course/1/contexts cat \u0026gt; /opt/course/1/context_default_kubectl.sh \u0026lt;\u0026lt;EOF kubectl config current-context EOF chmod +x /opt/course/1/context_default_kubectl.sh cat ~/.kube/config | grep current-context | awk \u0026#39;{print $2}\u0026#39; å·¥ä½œè´Ÿè½½ï¼šç¼©å®¹ å‘½åç©ºé—´ project-c13 ä¸­æœ‰ä¸¤ä¸ªåä¸º o3db-* çš„ Podã€‚ C13 ç®¡ç†å±‚è¦æ±‚å°† Pod ç¼©å‡ä¸ºä¸€ä¸ªå‰¯æœ¬ä»¥èŠ‚çœèµ„æºã€‚ è®°å½•åŠ¨ä½œã€‚\nçŸ¥è¯†ç‚¹ scale deploy statefulset å‚è€ƒæ–‡æ¡£ï¼š https://kubernetes.io/zh/docs/tasks/run-application/scale-stateful-set/ https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/#scaling-a-deployment\nè§£é¢˜æ€è·¯ kubectl scale \u0026lt;resource\u0026gt; xxx --replicas=1 scale å‘½ä»¤éœ€è¦ç¡®è®¤èµ„æºç±»å‹ï¼šdeployment/statefulset\nåº”ç”¨å°±ç»ªå’Œæ¢æ´» åœ¨å‘½åç©ºé—´ default ä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚ä¸º nginx:1.16.1-alpine åˆ›å»ºä¸€ä¸ªåä¸º ready-if-service-ready çš„ Podã€‚é…ç½®ä¸€ä¸ª LivenessProbeï¼Œå®ƒåªæ˜¯è¿è¡Œ trueã€‚è¿˜è¦é…ç½®ä¸€ä¸ª ReadinessProbe æ¥æ£€æŸ¥ url http://service-am-i-ready:80 æ˜¯å¦å¯è¾¾ï¼Œå¯ä»¥ä½¿ç”¨ wget -T2 -O- http://service-am-i-ready:80ã€‚ å¯åŠ¨ Pod å¹¶ç¡®è®¤å®ƒå› ä¸º ReadinessProbe è€Œæ²¡æœ‰å‡†å¤‡å¥½ã€‚\nåˆ›å»ºç¬¬äºŒä¸ªåä¸º am-i-ready çš„ Pod é•œåƒ nginx:1.16.1-alpineï¼Œæ ‡ç­¾ id:cross-server-readyã€‚å·²ç»å­˜åœ¨çš„æœåŠ¡ service-am-i-ready ç°åœ¨åº”è¯¥æœ‰ç¬¬äºŒä¸ª Pod ä½œä¸ºç«¯ç‚¹ã€‚\nçŸ¥è¯†ç‚¹ probe pod å‚è€ƒæ–‡æ¡£ï¼š https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/\nè§£é¢˜æ€è·¯ kubectl run ready-if-service-ready --image nginx:1.16.1-alpine --dry-run=client -o yaml \u0026gt; ready-if-service-ready.yaml kubectl run am-i-ready --image nginx:1.16.1-alpine --labels id=cross-server-ready --dry-run=client -o yaml \u0026gt; am-i-ready.yaml æ·»åŠ  probes\napiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: ready-if-service-ready name: ready-if-service-ready spec: containers: - image: nginx:1.16.1-alpine name: ready-if-service-ready resources: {} livenessProbe: exec: command: - echo - hi readinessProbe: exec: command: - wget - -T2 - -O- - http://service-am-i-ready:80 dnsPolicy: ClusterFirst restartPolicy: Always status: {} é›†ç¾¤ï¼šæ§åˆ¶å¹³é¢ ä½¿ç”¨ ssh cluster1-master1 ssh è¿›å…¥ä¸»èŠ‚ç‚¹ã€‚æ£€æŸ¥ master ç»„ä»¶ kubeletã€kube-apiserverã€kube-schedulerã€kube-controller-manager å’Œ etcd å¦‚ä½•åœ¨ master èŠ‚ç‚¹ä¸Šå¯åŠ¨/å®‰è£…ã€‚è¿˜è¦æ‰¾å‡º DNS åº”ç”¨çš„åç§°ä»¥åŠå®ƒæ˜¯å¦‚ä½•åœ¨ä¸»èŠ‚ç‚¹ä¸Šå¯åŠ¨/å®‰è£…çš„ã€‚\nå°†ç»“æœå†™å…¥æ–‡ä»¶ /opt/course/8/master-components.txtã€‚è¯¥æ–‡ä»¶çš„ç»“æ„åº”å¦‚ä¸‹æ‰€ç¤ºï¼š\n# /opt/course/8/master-components.txt kubelet: [TYPE] kube-apiserver: [TYPE] kube-scheduler: [TYPE] kube-controller-manager: [TYPE] etcd: [TYPE] dns: [TYPE] [NAME] Choices of [TYPE] are: not-installed, process, static-pod, pod\nçŸ¥è¯†ç‚¹ Kubernetes components çš„å®‰è£…æ–¹å¼\nè§£é¢˜æ€è·¯ å½“å‰æ¯”è¾ƒçš„ç»„ä»¶éƒ½æ˜¯ä»¥static podçš„å½¢å¼è¿è¡Œçš„ï¼Œè€Œ static pod éƒ½æ˜¯ç”± Kubelet ç®¡ç†çš„ï¼Œæ‰€ä»¥ä» kubelet å¤„å…¥æ‰‹ã€‚\nä»¥ minikube ä¸ºä¾‹ï¼š\n$ ps -ef | grep -w kubelet root 140597 1 2 May15 ? 00:36:00 /var/lib/minikube/binaries/v1.18.8/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --config=/var/lib/kubelet/config.yaml --container-runtime=docker --hostname-override=cka --kubeconfig=/etc/kubernetes/kubelet.conf --node-ip=192.168.64.3 $ systemctl is-active kubelet active #kubelet: process æ ¹æ®å‰é¢è¿›ç¨‹ä¸­çš„ä¿¡æ¯ï¼ŒæŸ¥çœ‹ /var/lib/kubelet/config.yamlä¸­çš„å†…å®¹ã€‚å¯ä»¥å¾—åˆ°ï¼š\netcd: static-pod kube-apiserver: static-pod kube-controller-manager: static-pod\n$ cat /var/lib/kubelet/config.yaml | grep -i staticpod staticPodPath: /etc/kubernetes/manifests ls /etc/kubernetes/manifests etcd.yaml kube-apiserver.yaml\tkube-controller-manager.yaml kube-scheduler.yaml æœ€åä¸Šä¸‹dnsï¼ŒæŸ¥çœ‹ä¸‹podï¼Œå¾—çŸ¥ dns: pod\n$ kubectl get pod -A | grep dns kube-system coredns-66bff467f8-6k2br 1/1 Running 0 32h æœ€åå°†ä¸Šé¢çš„ç»“æœå†™å…¥åˆ° /opt/course/8/master-components.txtï¼Œä¸èƒ½å‰åŠŸå°½å¼ƒã€‚\né›†ç¾¤ï¼šPod è°ƒåº¦ ä½¿ç”¨ ssh cluster2-master1 ssh è¿›å…¥ä¸»èŠ‚ç‚¹ã€‚æš‚æ—¶åœæ­¢ kube-schedulerï¼Œè¿™æ„å‘³ç€å¯ä»¥åœ¨ä¹‹åå†æ¬¡å¯åŠ¨å®ƒã€‚\nä¸ºé•œåƒ httpd:2.4-alpine åˆ›å»ºä¸€ä¸ªåä¸º manual-schedule çš„ Podï¼Œç¡®è®¤å®ƒå·²å¯åŠ¨ä½†æœªåœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šè°ƒåº¦ã€‚\nç°åœ¨æ‚¨æ˜¯è°ƒåº¦ç¨‹åºå¹¶æ‹¥æœ‰æ‰€æœ‰æƒåŠ›ï¼Œåœ¨èŠ‚ç‚¹ cluster2-master1 ä¸Šæ‰‹åŠ¨è°ƒåº¦è¯¥ Podã€‚ ç¡®ä¿å®ƒæ­£åœ¨è¿è¡Œã€‚\nå†æ¬¡å¯åŠ¨ kube-scheduler å¹¶é€šè¿‡åœ¨é•œåƒ httpd:2.4-alpine åˆ›å»ºç¬¬äºŒä¸ªåä¸º manual-schedule2 çš„ Pod å¹¶æ£€æŸ¥å®ƒæ˜¯å¦åœ¨ cluster2-worker1 ä¸Šè¿è¡Œæ¥ç¡®è®¤å…¶è¿è¡Œæ­£å¸¸ã€‚\nçŸ¥è¯†ç‚¹ kubernetes ç»„ä»¶çš„è¿è¡Œæ–¹å¼ åˆ›å»º pod pod è°ƒåº¦ è§£é¢˜æ€è·¯ kube-scheduler æ˜¯ä»¥ static pod çš„æ–¹å¼è¿è¡Œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ ssh åˆ°èŠ‚ç‚¹ä¸Šï¼Œå°† scheduler çš„ yaml ç§»å‡ºï¼ˆè®°ä½ä¸è¦åˆ æ‰ï¼Œè¿˜è¦è¿˜åŸå›å»ï¼‰ï¼Œé‡å¯ kubelet\n$ ps -ef | grep -w kubelet root 140597 1 2 May15 ? 00:36:00 /var/lib/minikube/binaries/v1.18.8/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --config=/var/lib/kubelet/config.yaml --container-runtime=docker --hostname-override=cka --kubeconfig=/etc/kubernetes/kubelet.conf --node-ip=192.168.64.3 $ cat /var/lib/kubelet/config.yaml | grep -i staticpod staticPodPath: /etc/kubernetes/manifests $ ls /etc/kubernetes/manifests etcd.yaml kube-apiserver.yaml\tkube-controller-manager.yaml kube-scheduler.yaml $ mv /etc/kubernetes/manifests/kube-scheduler.yaml /etc/kubernetes $ systemctl restart kubelet æ£€æŸ¥ä¸‹ schedule pod æ²¡æœ‰è¿è¡Œï¼Œç„¶åå°è¯•åˆ›å»º podï¼Œå¹¶æŸ¥çœ‹ pod å¤„äº pending çŠ¶æ€ï¼Œå³æ²¡æœ‰ kube-scheduler ä¸ºå…¶è°ƒåº¦ã€‚\n$ kubectl run manual-schedule --image httpd:2.4-alpine $ kubectl get pod | grep manual-schedule manual-schedule 0/1 Pending 0 16s æ‰‹åŠ¨è°ƒåº¦ï¼Œå³ä¸º pod æŒ‡å®šä¸€ä¸ª nodeNameï¼Œæˆ‘çš„ minikube åªæœ‰ä¸€ä¸ª node åä¸º ckaï¼Œä¿®æ”¹podï¼š\n$ kubectl get pod manual-schedule -o yaml \u0026gt; manual-schedule.yaml æ·»åŠ  nodeName ä¹‹å\napiVersion: v1 kind: Pod metadata: creationTimestamp: \u0026#34;2021-05-16T07:27:16Z\u0026#34; labels: run: manual-schedule name: manual-schedule namespace: dev resourceVersion: \u0026#34;84805\u0026#34; selfLink: /api/v1/namespaces/dev/pods/manual-schedule uid: c4b592f6-1e07-4911-a7fe-867d813c7a55 spec: containers: - image: httpd:2.4-alpine imagePullPolicy: IfNotPresent name: manual-schedule resources: {} terminationMessagePath: /dev/termination-log terminationMessagePolicy: File volumeMounts: - mountPath: /var/run/secrets/kubernetes.io/serviceaccount name: default-token-v7f28 readOnly: true dnsPolicy: ClusterFirst nodeName: cka #node name here enableServiceLinks: true priority: 0 restartPolicy: Always schedulerName: default-scheduler securityContext: {} serviceAccount: default serviceAccountName: default terminationGracePeriodSeconds: 30 tolerations: - effect: NoExecute key: node.kubernetes.io/not-ready operator: Exists tolerationSeconds: 300 - effect: NoExecute key: node.kubernetes.io/unreachable operator: Exists tolerationSeconds: 300 volumes: - name: default-token-v7f28 secret: defaultMode: 420 secretName: default-token-v7f28 status: phase: Pending qosClass: BestEffort å¼ºåˆ¶æ›´æ–° podï¼ˆè¿è¡Œæ—¶åªèƒ½ä¿®æ”¹éƒ¨åˆ†å†…å®¹ï¼‰ï¼š\n$ kubectl replace -f manual-schedule.yaml --force pod \u0026#34;manual-schedule\u0026#34; deleted pod/manual-schedule replaced å†æ¬¡æ£€æŸ¥\n$ kubectl get pod | grep manual-schedule manual-schedule 1/1 Running 0 15s æ¢å¤ kube-scheduler çš„è¿è¡Œï¼š\n$ mv /etc/kubernetes/kube-scheduler.yaml /etc/kubernetes/manifests $ systemctl restart kubelet æ£€æŸ¥æ˜¯å¦è¿è¡Œ\n$ kubectl get pod -A | grep kube-scheduler kube-system kube-scheduler-cka 1/1 Running 0 66s åˆ›å»ºç¬¬äºŒä¸ªpodï¼Œå¹¶æ£€æŸ¥æ˜¯å¦åœ¨è¿è¡Œï¼ˆrunningï¼‰çŠ¶æ€\n$ kubectl run manual-schedule2 --image httpd:2.4-alpine pod/manual-schedule2 created kubectl get pod manual-schedule2 NAME READY STATUS RESTARTS AGE manual-schedule2 1/1 Running 0 6s é›†ç¾¤ï¼šå¤‡ä»½åŠæ¢å¤ å¯¹åœ¨ cluster3-master1 ä¸Šè¿è¡Œçš„ etcd è¿›è¡Œå¤‡ä»½ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨ä¸»èŠ‚ç‚¹ä¸Šçš„ /tmp/etcd-backup.dbã€‚\nç„¶ååœ¨é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªä½ å–œæ¬¢çš„ Podã€‚\næœ€åæ¢å¤å¤‡ä»½ï¼Œç¡®è®¤é›†ç¾¤ä»åœ¨å·¥ä½œå¹¶ä¸”åˆ›å»ºçš„ Pod ä¸å†ä¸æˆ‘ä»¬åœ¨ä¸€èµ·ã€‚\nçŸ¥è¯†ç‚¹ etc çš„ä½œç”¨ï¼šå­˜å‚¨é›†ç¾¤çš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬ pod ä¿¡æ¯ etc çš„å¤‡ä»½å’Œæ¢å¤ å‚è€ƒæ–‡æ¡£ï¼š https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster\nè§£é¢˜æ€è·¯ etcdçš„å‘½ä»¤æ‰§è¡Œï¼Œè®°å¾—è®¾ç½®APIçš„ç‰ˆæœ¬ ETCDCTL_API=3\næ“ä½œ etcd éœ€è¦ endpointsã€cacertã€certã€keyã€‚Kubernetes çš„æ‰€æœ‰ç»„ä»¶ä¸ etcd çš„æ•°æ®äº¤äº’éƒ½æ˜¯é€šè¿‡ api-server å®Œæˆçš„ï¼Œæˆ‘åªéœ€è¦æ‰¾åˆ° api-server çš„è¿è¡Œå‘½ä»¤å°±è¡Œï¼Œä¸¤ç§æ–¹å¼ï¼šåˆ° master ä¸»æœºæŸ¥çœ‹ api-server çš„è¿›ç¨‹ï¼›æˆ–è€…å» api-server çš„ pod æŸ¥çœ‹ .spec.containers[].command\n#ssh to master $ ps -ef | grep kube-apiserver $ kubectl get pod -n kube-system kube-apiserver-cka -o jsonpath=\u0026#39;{.spec.containers[].command}\u0026#39; etcd å¤‡ä»½ï¼Œå‘½ä»¤ç›´æ¥ä» Kubernetes å®˜æ–¹æ–‡æ¡£å¤åˆ¶å†ä¿®æ”¹\n#ssh to master $ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 \\ --cacert=/var/lib/minikube/certs/etcd/ca.crt --cert=/var/lib/minikube/certs/apiserver-etcd-client.crt --key=/var/lib/minikube/certs/apiserver-etcd-client.key \\ snapshot save /tmp/etcd-backup.db Snapshot saved at /tmp/etcd-backup.db åˆ›å»º pod\n$ kubectl run sleep1d --image busybox --command -- sleep 1d #æ£€æŸ¥ pod è¿è¡Œæƒ…å†µ $ kubectl get pod NAME READY STATUS RESTARTS AGE sleep1d 1/1 Running 0 10s æ¢å¤ etcd çš„å¤‡ä»½ï¼Œå¤åˆ¶å‰é¢çš„å‘½ä»¤å¹¶ä¿®æ”¹ï¼Œæ¢å¤å¤‡ä»½åˆ° /var/lib/etcd-backup\n$ ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/var/lib/minikube/certs/etcd/ca.crt --cert=/var/lib/minikube/certs/apiserver-etcd-client.crt --key=/var/lib/minikube/certs/apiserver-etcd-client.key snapshot restore /tmp/etcd-backup.db --data-dir /var/lib/etcd-backup 2021-05-16 08:09:17.797061 I | mvcc: restore compact to 85347 2021-05-16 08:09:17.803208 I | etcdserver/membership: added member 8e9e05c52164694d [http://localhost:2380] to cluster cdf818194e3a8c32 ä¿®æ”¹ etcd çš„é…ç½®ï¼Œ /etc/kubernetes/manifests/etcd.yaml\nvolumes: - hostPath: path: /var/lib/minikube/certs/etcd type: DirectoryOrCreate name: etcd-certs - hostPath: path: /var/lib/etcd-backup #åŸæ¥æ˜¯/var/lib/minikube/etcd type: DirectoryOrCreate name: etcd-data status: {} ä¿å­˜åé‡å¯kubelet\n$ systemctl restart kubelet æ£€æŸ¥podæ˜¯å¦å­˜åœ¨ï¼š\n$ kubectl get pod sleep1d Error from server (NotFound): pods \u0026#34;sleep1d\u0026#34; not found å®‰å…¨ï¼šç½‘ç»œç­–ç•¥ å‘ç”Ÿäº†ä¸€èµ·å®‰å…¨äº‹ä»¶ï¼Œå…¥ä¾µè€…èƒ½å¤Ÿä»ä¸€ä¸ªè¢«é»‘çš„åç«¯ Pod è®¿é—®æ•´ä¸ªé›†ç¾¤ã€‚\nä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œåœ¨å‘½åç©ºé—´ project-snake ä¸­åˆ›å»ºä¸€ä¸ªåä¸º np-backend çš„ NetworkPolicyã€‚å®ƒåº”è¯¥åªå…è®¸ backend-* Podsï¼š\nè¿æ¥åˆ°ç«¯å£ 1111 ä¸Šçš„ db1-* Pod è¿æ¥åˆ°ç«¯å£ 2222 ä¸Šçš„ db2-* Pod åœ¨ç­–ç•¥ä¸­ä½¿ç”¨ Pod çš„åº”ç”¨ç¨‹åºæ ‡ç­¾ã€‚\nå®æ–½åï¼Œä¾‹å¦‚ï¼Œç«¯å£ 3333 ä¸Šä» backend-* Pod åˆ° vault-* Pod çš„è¿æ¥åº”è¯¥ä¸å†æœ‰æ•ˆã€‚\nçŸ¥è¯†ç‚¹ NetworkPolicy å‚è€ƒæ–‡æ¡£ï¼š https://kubernetes.io/docs/concepts/services-networking/network-policies\nè§£é¢˜æ€è·¯ ä¸º backend-* pod è®¾ç½® egress çš„ NetworkPolicyï¼Œåªå…è®¸å…¶è®¿é—® db1-* çš„ 1111 ç«¯å£å’Œ db2-* çš„ 2222 ç«¯å£ï¼Œç­–ç•¥ä¸­ä½¿ç”¨ app label æ¥è¿›è¡ŒåŒ¹é…ã€‚\nä» Kubernetes å®˜ç½‘æ–‡æ¡£ä¸­å¤åˆ¶ä¸€æ®µyamlé…ç½®è¿›è¡Œä¿®æ”¹ã€‚\napiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: np-backend namespace: project-snake spec: podSelector: matchLabels: app: backend policyTypes: - Egress egress: - to: - podSelector: matchLabels: app: db1 ports: - protocol: TCP port: 1111 - to: - podSelector: matchLabels: app: db2 ports: - protocol: TCP port: 2222 å‡è®¾ backend pod çš„ app label ä¸º backendï¼Œdb1 çš„ ä¸º db1ï¼Œdb2 çš„ä¸º db2ã€‚\nåˆ›å»ºç¯å¢ƒï¼š\n$ kubectl run backend --image nginx --labels app=backend $ kubectl run db1 --image nginx --labels app=db1 $ kubectl run db2 --image nginx --labels app=db2 $ kubectl run vault --image nginx --labels app=vault $ kubectl get pod -L app NAME READY STATUS RESTARTS AGE APP backend 1/1 Running 0 13s backend db1 1/1 Running 0 66s db1 db2 1/1 Running 0 71s db2 vault 1/1 Running 0 79s vault ç”±äºæˆ‘ä»¬ç”¨çš„ nginx é•œåƒï¼Œå°†å‰é¢çš„ NetworkPolicy ç«¯å£ä¿®æ”¹ä¸€ä¸‹ï¼š\napiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: np-backend spec: podSelector: matchLabels: app: backend policyTypes: - Egress egress: - to: - podSelector: matchLabels: app: db1 ports: - protocol: TCP port: 80 - to: - podSelector: matchLabels: app: db2 ports: - protocol: TCP port: 80 æ£€æŸ¥ä¸€ä¸‹ï¼š\n$ kubectl get networkpolicy NAME POD-SELECTOR AGE np-backend app=backend 31s æµ‹è¯•ä¸‹ç½‘ç»œï¼š\n#è·å–pod ip $ kubectl get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES backend 1/1 Running 0 3m15s 172.17.0.7 cka \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; db1 1/1 Running 0 4m8s 172.17.0.6 cka \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; db2 1/1 Running 0 4m13s 172.17.0.3 cka \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; vault 1/1 Running 0 4m21s 172.17.0.4 cka \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; é›†ç¾¤ï¼škubelet å¯åŠ¨æ–¹å¼ èŠ‚ç‚¹ cluster2-worker1 å·²ä½¿ç”¨ kubeadm å’Œ TLS å¼•å¯¼æ·»åŠ åˆ°é›†ç¾¤ä¸­ã€‚ æ‰¾åˆ° cluster2-worker1 çš„ â€œIssuerâ€ å’Œ â€œExtended Key Usageâ€ å€¼ï¼š kubelet å®¢æˆ·ç«¯è¯ä¹¦ï¼Œç”¨äºå‘å¤–è¿æ¥åˆ° kube-apiserver çš„è¯ä¹¦ã€‚ kubelet æœåŠ¡å™¨è¯ä¹¦ï¼Œç”¨äºæ¥è‡ª kube-apiserver çš„ä¼ å…¥è¿æ¥ã€‚ å°†ä¿¡æ¯å†™å…¥æ–‡ä»¶ /opt/course/23/certificate-info.txtã€‚\nçŸ¥è¯†ç‚¹ kubelet çš„åŠŸèƒ½ï¼šè¿æ¥ api-serverï¼›æ¥å—æ¥è‡ª api-server çš„å“åº”ã€‚ä¸¤ç§æƒ…å†µéƒ½éœ€è¦ TLS è§£é¢˜æ€è·¯ kubelet è¿æ¥ apiserver çš„æ–¹å¼åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå…ˆæ‰¾å‡ºé…ç½®æ–‡ä»¶çš„ä¿å­˜ä½ç½®ã€‚\n# ssh åˆ°èŠ‚ç‚¹ä¸Šï¼ŒæŸ¥çœ‹ kubelet çš„å¯åŠ¨å‘½ä»¤ $ ps -ef | grep kubelet root 3935 1 1 12:54 ? 00:00:23 /var/lib/minikube/binaries/v1.20.0/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --cni-conf-dir=/etc/cni/net.mk --config=/var/lib/kubelet/config.yaml --container-runtime=docker --hostname-override=cka-m02 --kubeconfig=/etc/kubernetes/kubelet.conf --network-plugin=cni --node-ip=192.168.64.9 docker 13653 13616 0 13:22 pts/0 00:00:00 grep kubelet #kubelet è¿æ¥ api server çš„ä¿¡æ¯ï¼Œ client cert çš„é…ç½®æ‰€åœ¨ /var/lib/kubelet/pki/kubelet-client-current.pem cat /var/lib/kubelet/config.yaml #kubelet çš„å¯åŠ¨ä¿¡æ¯ï¼Œ servert cert çš„é…ç½®æ‰€åœ¨ /var/lib/minikube/certs/ca.crt cat /etc/kubernetes/kubelet.conf $ openssl x509 -noout -text -in /var/lib/kubelet/pki/kubelet-client-current.pem | grep -i issuer Issuer: CN = minikubeCA $ openssl x509 -noout -text -in /var/lib/kubelet/pki/kubelet-client-current.pem | grep -i -A1 extended X509v3 Extended Key Usage: TLS Web Client Authentication $ openssl x509 -noout -text -in /var/lib/minikube/certs/ca.crt | grep -i issuer Issuer: CN = minikubeCA $ openssl x509 -noout -text -in /var/lib/minikube/certs/ca.crt | grep -i -A1 extended X509v3 Extended Key Usage: TLS Web Client Authentication, TLS Web Server Authentication æœ€åè®°å¾—å°†ä¿¡æ¯å†™å…¥åˆ° /opt/course/23/certificate-info.txt\né›†ç¾¤ï¼šè¯ä¹¦ æ£€æŸ¥ kube-apiserver æœåŠ¡å™¨è¯ä¹¦åœ¨ cluster2-master1 ä¸Šçš„æœ‰æ•ˆæœŸã€‚ä½¿ç”¨ openssl æˆ– cfssl æ‰§è¡Œæ­¤æ“ä½œã€‚å°†åˆ°æœŸæ—¥æœŸå†™å…¥ /opt/course/22/expirationã€‚\nåŒæ—¶è¿è¡Œæ­£ç¡®çš„ kubeadm å‘½ä»¤ä»¥åˆ—å‡ºåˆ°æœŸæ—¥æœŸå¹¶ç¡®è®¤ä¸¤ç§æ–¹æ³•æ˜¾ç¤ºç›¸åŒçš„æ—¥æœŸã€‚\nå°†æ›´æ–° apiserver æœåŠ¡å™¨è¯ä¹¦çš„æ­£ç¡® kubeadm å‘½ä»¤å†™å…¥ /opt/course/22/kubeadm-renew-certs.shã€‚\nçŸ¥è¯†ç‚¹ api-server openssl kubeadm å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#check-certificate-expiration\nè§£é¢˜æ€è·¯ é€šè¿‡ kube-apiserver pod çš„å¯åŠ¨å‘½ä»¤ï¼Œæˆ–è€… ssh åˆ° master æ¥æŸ¥çœ‹å‘½ä»¤å‚æ•°ï¼Œtls-cert-file=/var/lib/minikube/certs/apiserver.crt\n$ openssl x509 -noout -text -in /var/lib/minikube/certs/apiserver.crt | grep -i valid -A2 Validity Not Before: May 13 22:33:43 2021 GMT Not After : May 14 22:33:43 2022 GMT å°† May 14 22:33:43 2022 GMT å†™å…¥ /opt/course/22/expiration\né€šè¿‡ kubeadm æ¥æ£€æŸ¥\n$ kubeadm certs check-expiration | grep -i apiserver #macos æ— æ³•å®‰è£… kubeadm #minikube æ— æ³•ä½¿ç”¨ kubeadm æ£€æŸ¥ å°† kubeadm certs renew apiserver å†™å…¥ /opt/course/22/kubeadm-renew-certs.sh\né›†ç¾¤ï¼šå‡çº§èŠ‚ç‚¹ ä½ çš„åŒäº‹è¯´èŠ‚ç‚¹ cluster3-worker2 è¿è¡Œçš„æ˜¯è¾ƒæ—§çš„ Kubernetes ç‰ˆæœ¬ï¼Œç”šè‡³ä¸å±äºé›†ç¾¤çš„ä¸€éƒ¨åˆ†ã€‚å°† kubectl å’Œ kubeadm æ›´æ–°ä¸ºåœ¨ cluster3-master1 ä¸Šè¿è¡Œçš„ç¡®åˆ‡ç‰ˆæœ¬ã€‚ç„¶åå°†æ­¤èŠ‚ç‚¹æ·»åŠ åˆ°é›†ç¾¤ä¸­ï¼Œæ‚¨å¯ä»¥ä¸ºæ­¤ä½¿ç”¨kubeadmã€‚\nçŸ¥è¯†ç‚¹ kubeadm å‡çº§é›†ç¾¤ å‚è€ƒæ–‡æ¡£ï¼š\nè§£é¢˜æ€è·¯ æ£€æŸ¥node\n$ kubectl get nodes æ£€æŸ¥å½“å‰ç»„ä»¶ç‰ˆæœ¬\n$ ssh cluster3-worker2 $ kubeadm version $ kubectl version --short Client Version: vx.xx.x Server Version: vx.xx.x $ kubelet --version #ä½¿ç”¨å‘½ä»¤å¹¶å‡çº§å„ä¸ªç»„ä»¶ï¼Œå¹¶é‡å¯ kubelet #å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œä¸€èˆ¬æ˜¯éœ€è¦tokenè¿æ¥åˆ°api-serverï¼Œéœ€è¦sshåˆ°masterä¸Šè¿è¡Œ kubeadm create token --print-join-command #å†sshåˆ° nodeä¸Šï¼Œæ‰§è¡Œæ‰“å°çš„å‘½ä»¤ï¼Œé‡å¯kubeletå¹¶æ£€æŸ¥è£…å¡« #æœ€åæ£€æŸ¥nodeæ˜¯å¦æˆåŠŸåŠ å…¥é›†ç¾¤ Docker å‘½ä»¤ åœ¨å‘½åç©ºé—´ project-tiger ä¸­åˆ›å»ºä¸€ä¸ªåä¸º Tigers-reunite çš„ Pod é•œåƒ httpd:2.4.41-alpineï¼Œæ ‡ç­¾ä¸º pod=container å’Œ container=podã€‚æ‰¾å‡º Pod è¢«å®‰æ’åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šã€‚ssh è¿›å…¥è¯¥èŠ‚ç‚¹å¹¶æ‰¾åˆ°å±äºè¯¥ Pod çš„ docker å®¹å™¨ã€‚\nå°†å®¹å™¨çš„ docker ID å’Œè¿™äº›æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹/å‘½ä»¤å†™å…¥ /opt/course/17/pod-container.txtã€‚\næœ€åï¼Œä½¿ç”¨ docker å‘½ä»¤å°†ä¸» Docker å®¹å™¨ï¼ˆæ¥è‡ª yaml ä¸­æŒ‡å®šçš„é‚£ä¸ªï¼‰çš„æ—¥å¿—å†™å…¥ /opt/course/17/pod-container.logã€‚\nçŸ¥è¯†ç‚¹ docker å‘½ä»¤ï¼špsã€logsã€inspect è§£é¢˜æ€è·¯ åˆ›å»º pod\n$ kubectl run tigers-reunite --image httpd:2.4.41-alpine --labels pod=container,container=pod æ£€æŸ¥ pod çš„ä¿¡æ¯\n$ kubectl get pods --show-labels NAME READY STATUS RESTARTS AGE LABELS tigers-reunite 1/1 Running 0 34s container=pod,pod=container è·å–podæ‰€åœ¨çš„èŠ‚ç‚¹\n$ kubectl get pod tigers-reunite -o jsonpath=\u0026#39;{.spec.nodeName}\u0026#39; cka sshåˆ°èŠ‚ç‚¹ä¸Š\ndocker ps | grep tigers-reunite e6ff69b437bc 54b0995a6305 \u0026#34;httpd-foreground\u0026#34; About a minute ago Up About a minute k8s_tigers-reunite_tigers-reunite_dev_53391212-911d-4275-a19d-e8f8b0f85a98_0 06d3ca65eb08 k8s.gcr.io/pause:3.2 \u0026#34;/pause\u0026#34; About a minute ago Up About a minute k8s_POD_tigers-reunite_dev_53391212-911d-4275-a19d-e8f8b0f85a98_0 #ä½¿ç”¨docker inspect æˆ–è€… è¿›å…¥å®¹å™¨ç›´æ¥æŸ¥çœ‹è¿›ç¨‹ $ docker inspect e6ff69b437bc | grep -i \u0026#39;cmd\\|entrypoint\u0026#39; -A1 \u0026#34;Cmd\u0026#34;: [ \u0026#34;httpd-foreground\u0026#34; -- \u0026#34;Entrypoint\u0026#34;: null, \u0026#34;OnBuild\u0026#34;: null, $ docker inspect 06d3ca65eb08 | grep -i \u0026#39;cmd\\|entrypoint\u0026#39; -A1 \u0026#34;Cmd\u0026#34;: null, \u0026#34;Image\u0026#34;: \u0026#34;k8s.gcr.io/pause:3.2\u0026#34;, -- \u0026#34;Entrypoint\u0026#34;: [ \u0026#34;/pause\u0026#34; ç»“æœå†™å…¥æ–‡ä»¶\ne6ff69b437bc httpd-foreground 06d3ca65eb08 pause å†™æ—¥å¿—åˆ°æ–‡ä»¶\ndocker logs e6ff69b437bc \u0026gt; /opt/course/17/pod-container.log ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/notes-for-cka-preparation/","tags":["Kubernetes","äº‘åŸç”Ÿ"],"title":"Kubernetes CKA è¯ä¹¦å¤‡è€ƒç¬”è®°"},{"categories":["æºç è§£æ","ç¬”è®°"],"contents":"è‡ªä»å‚åŠ äº† Flomesh çš„ workshopï¼Œäº†è§£äº†å¯ç¼–ç¨‹ç½‘å…³ Pipyã€‚å¯¹è¿™ä¸ªâ€œå°ä¸œè¥¿â€å……æ»¡äº†å¥½å¥‡ï¼Œå‰åå†™äº†ä¸¤ç¯‡æ–‡ç« ï¼Œçœ‹äº†éƒ¨åˆ†æºç è§£å¼€äº†å…¶éƒ¨åˆ†é¢çº±ã€‚ä½†å§‹ç»ˆæœªè§å…¶å…¨è²Œï¼Œæ²¡æœ‰è§¦åŠå…¶æ ¸å¿ƒè®¾è®¡ã€‚\nä¸æ˜¯æœ‰å¥è¯ï¼Œâ€œå¥½å¥‡å®³æ­»çŒ«â€ã€‚å…¶å®åº”è¯¥è¿˜æœ‰ååŠå¥ï¼Œâ€œæ»¡è¶³äº†å°±æ²¡äº‹â€ï¼ˆè§ç»´åŸºç™¾ç§‘ï¼‰ã€‚\næ‰€æœ‰å°±æœ‰äº†ä»Šå¤©çš„è¿™ä¸€ç¯‡ï¼Œå¯¹å‰ä¸¤ç¯‡æ„Ÿå…´è¶£çš„å¯ä»¥è·³è½¬ç¿»çœ‹ã€‚\nåˆæ¢å¯ç¼–ç¨‹ç½‘å…³ Pipy å¯ç¼–ç¨‹ç½‘å…³ Pipy ç¬¬äºŒå¼¹ï¼šç¼–ç¨‹å®ç° Metrics åŠæºç è§£è¯» è¨€å½’æ­£ä¼ ã€‚\näº‹ä»¶æ¨¡å‹ ä¸Šç¯‡å†™äº† Pipy åŸºäºäº‹ä»¶çš„ä¿¡æ¯æµè½¬ï¼Œå…¶å®è¿˜æœªæ·±å…¥è§¦åŠå…¶æ ¸å¿ƒçš„äº‹ä»¶æ¨¡å‹ã€‚æ—¢ç„¶æ˜¯äº‹ä»¶æ¨¡å‹ï¼Œå…ˆçœ‹äº‹ä»¶ã€‚\nsrc/event.hpp:41 ä¸­å®šä¹‰äº† Pipy çš„å››ç§äº‹ä»¶ï¼š\nData MessageStart MessageEnd SessionEnd ç¿»çœ‹æºç å¯çŸ¥ï¼ˆå¿…é¡»åæ§½æ–‡æ¡£å¤ªå°‘ï¼‰è¿™å‡ ç§äº‹ä»¶å…¶å®æ˜¯æœ‰é¡ºåºçš„ï¼šMessageStart -\u0026gt; Data -\u0026gt; MessageEnd -\u0026gt; SessionEndã€‚\nè¿™ç§é¢å‘äº‹ä»¶æ¨¡å‹ï¼Œå¿…ç„¶æœ‰ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚åˆæ˜¯ç¿»çœ‹æºç å¯çŸ¥ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½æ˜¯ pipy::Filterã€‚æˆ‘ä»¬åœ¨ä¸Šç¯‡æ–‡ç« ä¸­è®²è¿‡ï¼šæ¯ä¸ª Pipeline éƒ½æœ‰ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œç±»ä¼¼å•å‘é“¾è¡¨çš„æ•°æ®ç»“æ„ã€‚\né‚£æ˜¯ä¸æ˜¯æŒ‰ç…§ä¸Šé¢è¯´çš„ï¼Œäº‹ä»¶æ˜¯ä»ä¸€ä¸ª Filter æµå‘ä¸‹ä¸€ä¸ª Filterï¼Ÿä¹Ÿå¯¹ï¼Œä¹Ÿä¸å¯¹ã€‚\nçŸ›ç›¾ï¼Ÿ å…ˆçœ‹ Filter å¦‚ä½•å‘ä¸‹ä¼ é€’äº‹ä»¶ï¼Œsrc/session.cpp:55 å¤„ï¼ŒFilter æŒæœ‰ output å˜é‡ï¼Œç±»ä¼¼ä¸º Event::Receiverï¼ˆå‚æ•°ä¸º Event çš„ std::function çš„åˆ«åï¼Œä½œä¸ºå¤–è¡Œçš„ç¬”è€…å¹¶ä¸æ‡‚ c++ï¼Œä½†ä¸å¦¨ç¢äº†è§£ç¨‹åºè®¾è®¡ï¼‰ã€‚é€šè¿‡ Receiver è°ƒç”¨ä¸‹ä¸€ä¸ª Filter çš„ #process æ–¹æ³•ã€‚\nè¿™é‡Œçš„ Receiver å°±å¯ä»¥ç†è§£ä¸ºäº‹ä»¶å‘é€çš„çª—å£ï¼Œè€Œ #process(Context *ctx, Event *inp) å°±æ˜¯äº‹ä»¶çš„æ¥æ”¶çª—å£ã€‚\nè¿™å°±æ˜¯å‰é¢ä¸ºä»€ä¹ˆè¯´ â€œäº‹ä»¶æ˜¯ä»ä¸€ä¸ª Filter æµå‘ä¸‹ä¸€ä¸ª Filterâ€ æ˜¯æ­£ç¡®çš„ã€‚\nä¸ºä»€ä¹ˆä¸å¯¹ï¼Ÿé¦–å…ˆï¼Œä¸€ä¸ª Filter ä¼šäº§ç”Ÿå¤šä¸ªäº‹ä»¶ï¼Œæ¯”å¦‚ decodeHttpRequest å¯èƒ½ä¼šäº§ç”Ÿ MessageStartã€Data å’Œ MessageEnd äº‹ä»¶ï¼Œå¹¶ä¸”æ¯äº§ç”Ÿä¸€ä¸ªäº‹ä»¶éƒ½ä¼šé€šè¿‡Receiver å‘ä¸‹ä¼ é€’ï¼Œä¸ä¼šç­‰ #process æµç¨‹ç»“æŸæ‰ä¼ é€’äº‹ä»¶ï¼›å†å°±æ˜¯ä¸‹ä¸€ä¸ª Filter å¯èƒ½å¹¶ä¸ä¼šå¯¹æŸä¸ªäº‹ä»¶æ„Ÿå…´è¶£ï¼ˆä¸‹ä¸€ä¸ª Filter çš„ #process æ–¹æ³•ä¸åšä»»ä½•å¤„ç†å°±è¿”å›äº†ï¼‰ã€‚\nå¯èƒ½çœ‹ä¸‹å›¾ä¼šæ›´å®¹æ˜“ç†è§£ï¼ˆå›¾ä¸­ no output è¡¨æ˜äº‹ä»¶ä¸ä¼šå‘ä¸‹ä¼ é€’ï¼‰ï¼š\næœ€ç®€å•çš„ç¤ºä¾‹ åœ¨ test/001-echo/pipy.js æä¾›äº†çš„ç¤ºä¾‹ï¼š\npipy() .listen(6080) .decodeHttpRequest() .encodeHttpResponse() å‘èµ·è¯·æ±‚\n$ curl -X POST localhost:6080 -d \u0026#39;{}\u0026#39; {} HTTP æ¶ˆæ¯ä½“\n#request POST / HTTP/1.1 Content-Type: application/javascript User-Agent: PostmanRuntime/7.28.1 Accept: */* Postman-Token: fc84b575-7fea-487b-a55d-f6085bc62cf7 Host: localhost:6080 Accept-Encoding: gzip, deflate, br Connection: keep-alive Content-Length: 2 {} #response HTTP/1.1 200 OK postman-token: fc84b575-7fea-487b-a55d-f6085bc62cf7 accept-encoding: gzip, deflate, br host: localhost:6080 accept: */* user-agent: PostmanRuntime/7.28.1 content-type: application/javascript Connection: keep-alive Content-Length: 2 {} è¿™é‡Œæˆ‘ä»¬ä»¥è¿‡æ»¤å™¨ decodeHttpRequest ä¸ºä¾‹ï¼Œå®˜æ–¹çš„è¯´æ˜æ˜¯ Deframes an HTTP request messageã€‚å‰é¢æåˆ°å®ƒä¼šäº§ç”Ÿ 3 ä¸ªäº‹ä»¶ï¼Œéƒ½æ˜¯åœ¨ deframe çš„è¿‡ç¨‹ä¸­å‘å‡ºçš„ã€‚\nSession è°ƒç”¨ç¬¬ä¸€ä¸ª Filter æ—¶ï¼Œä¼ å…¥çš„äº‹ä»¶ç±»å‹æ˜¯ event::Dataã€‚decodeHttpRequest å…³æ³¨è¯¥äº‹ä»¶ï¼Œå¹¶æŒ‰ç…§ HTTP åè®®å¼€å§‹è§£æã€‚\nåœ¨ä¸Šå›¾å¯ä»¥çœ‹åˆ°è§£æçš„ä¸åŒé˜¶æ®µï¼Œä¼šå‘å‡ºä¸åŒçš„äº‹ä»¶ã€‚è°ƒç”¨ Receiver ä¼ è¾“äº‹ä»¶ï¼Œè°ƒç”¨ encodeHttpResponse çš„ #process() æ–¹æ³•ã€‚\nè¿™é‡Œåˆä¼šå¥½å¥‡ï¼Œå‡å¦‚ä¸Šé¢çš„ç¤ºä¾‹ä¸­å»æ‰ä¸¤ä¸ªè¿‡æ»¤å™¨ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œæˆ–è€…éƒ½å»æ‰ï¼Œèƒ½ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Ÿ\nç­”æ¡ˆæ˜¯éƒ½ä¸èƒ½ï¼å“åº”çŠ¶æ€ç éƒ½æ˜¯ 502 Bad Gatewayï¼ˆcurl/httpieï¼‰ã€‚\nåˆ†æ è¿™é‡Œéœ€è¦ç»“åˆæœ¬æ–‡çš„ç¬¬ä¸€å¼ å›¾ event-handling-flowã€‚\nå»æ‰ä¸¤ä¸ªè¿‡æ»¤å™¨ å‡å¦‚ä¸¤ä¸ªéƒ½å»æ‰äº†ï¼ŒHTTP Request è¯·æ±‚æ¶ˆæ¯ä¼šè¢«ç›´æ¥å›ä¼ ç»™å®¢æˆ·ç«¯ï¼Œåè®®é”™è¯¯ã€‚\nå»æ‰ decodeHttpRequest å‰é¢æåˆ° Session ä¼ ç»™ç¬¬ä¸€ä¸ª Filter çš„äº‹ä»¶æ˜¯ event::Dataã€‚è€Œ encodeHttpResponse é’ˆå¯¹è¯¥äº‹ä»¶åªä¼šå°†å…¶ä¿å­˜åˆ° buffer ä¸­ã€‚\nç„¶åæ•´ä¸ªé“¾è·¯åœ¨æ­¤ç»“æŸï¼Œæ²¡æœ‰å›ä¼ ä»»ä½•æ•°æ®ã€‚å®¢æˆ·ç«¯ä¼šç­‰å¾…å“åº”ï¼Œè¶…æ—¶é€€å‡ºï¼ˆcurlï¼‰ã€‚\nå»æ‰ encodeHttpResponse å…ˆè¯´ç»“æœï¼Œä¸å‰é¢ä¸€æ ·è¶…æ—¶é€€å‡ºã€‚\nä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œæ˜æ˜ decodeHttpRequest äº§ç”Ÿäº† 3 ä¸ªæ—¶é—´ï¼ŒSession é‡Œçš„ Receiver ä¹Ÿæœ‰æ”¶åˆ°ï¼Œä¹Ÿç¡®å®å†™å›äº†è¯·æ±‚ body é‡Œçš„ {}ã€‚\nencodeHttpResponse è¿‡æ»¤å™¨æœ‰å†™å›å“åº”å¤´ï¼Œç¼ºå°‘äº†è¿™äº›ä¿¡æ¯ï¼Œå“åº”å°±ä¸å¹¶ä¸æ˜¯åˆæ³•çš„ HTTP åè®®ï¼Œåªæ˜¯æ™®é€šçš„ TCP åè®®ã€‚\næ€»ç»“ Pipy åŸºäºäº‹ä»¶æ¨¡å‹çš„è®¾è®¡ï¼Œæä¾›äº†å¼ºå¤§çš„çµæ´»æ€§ã€‚å…è®¸æˆ‘ä»¬åœ¨â€œè§„åˆ™â€ä¸­ä½¿ç”¨ä¸åŒè¿‡æ»¤å™¨é’ˆå¯¹ä¸åŒçš„äº‹ä»¶ï¼Œå¯¹è¯·æ±‚å’Œå“åº”çš„ä¿¡æ¯è¿›è¡Œå¤„ç†ã€‚\nâ€œè§„åˆ™â€ å°±æ˜¯ä¸šåŠ¡é€»è¾‘çš„æ ¸å¿ƒï¼Œè€Œ Pipy å°±æ˜¯è¿™é€»è¾‘çš„æ‰§è¡Œå¼•æ“ã€‚\næœ€åï¼Œâ€œå¥½å¥‡å¿ƒæ˜¯æˆé•¿çš„é©±åŠ¨åŠ›ï¼Œæ°¸è¿œä¿æŒå¥½å¥‡å¿ƒã€‚â€\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/pipy-event-handling-design/","tags":["Pipy"],"title":"å¯ç¼–ç¨‹ç½‘å…³ Pipy ç¬¬ä¸‰å¼¹ï¼šäº‹ä»¶æ¨¡å‹è®¾è®¡"},{"categories":["äº‘åŸç”Ÿ"],"contents":"ä¹‹å‰å†™è¿‡ä¸€ç¯‡ ä»‹ç»äº†å·¥å…·åŠ é€Ÿäº‘åŸç”Ÿ Java å¼€å‘ã€‚\nå…¶å®æ—¥å¸¸å·¥ä½œä¸­åœ¨é›†ç¾¤ä¸Šçš„æ“ä½œä¹Ÿéå¸¸å¤šï¼Œä»Šå¤©å°±æ¥ä»‹ç»æˆ‘æ‰€ä½¿ç”¨çš„å·¥å…·ã€‚\nkubectl-alias ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„å·¥å…·ï¼Œæˆ‘è‡ªå·±ç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹ï¼ŒåŠ å…¥äº† StatefulSet çš„æ”¯æŒã€‚\nè¿™ä¸ªæ˜¯æˆ‘çš„ https://github.com/addozhang/kubectl-aliasesï¼ŒåŸºäº https://github.com/ahmetb/kubectl-aliasesã€‚\næ¯”å¦‚è¾“å‡ºæŸä¸ª pod çš„ jsonï¼Œkgpoojson xxx ç­‰åŒäº kubectl get pod xxx -o jsonã€‚\nç»“åˆ jq ä½¿ç”¨æ•ˆæœæ›´å¥½ ğŸ˜‚ã€‚\nè¯­æ³•è§£è¯» k=kubectl sys=--namespace kube-system commands: g=get d=describe rm=delete a:apply -f ak:apply -k k:kustomize ex:Â exec -i -t lo:Â logs -f resources: po=pod,Â dep=deployment,Â ing=ingress,Â svc=service,Â cm=configmap,Â sec=secret,ns=namespace,Â no=node flags: output format:Â oyaml,Â ojson,Â owide all:Â --allÂ orÂ --all-namespacesÂ depending on the command sl:Â --show-labels w=-w/--watch value flags (should be at the end): n=-n/--namespace f=-f/--filename l=-l/--selector kubectx + kubens å®‰è£…çœ‹è¿™é‡Œ\nkubectx ç”¨äºåœ¨ä¸åŒçš„é›†ç¾¤é—´è¿›è¡Œå¿«é€Ÿåˆ‡æ¢ã€‚å‡å¦‚ç”¨ kubectlï¼Œä½ éœ€è¦ï¼š\n# context åˆ—è¡¨ kubectl config current-context # è®¾ç½® context kubectl config use-context coffee kubens å°±æ˜¯åœ¨ä¸åŒ namespace é—´å¿«é€Ÿåˆ‡æ¢çš„å·¥å…·ã€‚ç”¨ kubectl çš„è¯ï¼Œéœ€è¦ï¼š\n# namespace åˆ—è¡¨ kbuectl get ns # kubectl config set-context --current --namespace=kube-system k9s æ²¡é”™ï¼Œåªæ¯” k8s å¤šäº†ä¸ª 1 ğŸ˜‚ã€‚\nk9s æä¾›äº†ç»ˆç«¯ UI ä¸ Kubernetes é›†ç¾¤è¿›è¡Œç¼–è¾‘äº¤äº’ã€‚æœ¬äººå¸¸ç”¨çš„æ¯”å¦‚ï¼š\nF é…ç½®ç«¯å£è½¬å‘ l è¾“å‡º pod æ—¥å¿— e ä¿®æ”¹èµ„æºå¯¹è±¡ s pod ç»ˆç«¯äº¤äº’æ¨¡å¼ y yaml æ–¹å¼è¾“å‡ºèµ„æºå¯¹è±¡ d describe èµ„æºå¯¹è±¡ ctrl+d åˆ é™¤ pod å¯åŠ¨æ–¹å¼\n# æŒ‡å®š namespace è¿è¡Œ k9s -n mycoolns # æŒ‡å®š context è¿è¡Œ k9s --context coolCtx # åªè¯»æ¨¡å¼è¿è¡Œ k9s --readonly é”®å…¥é—®å·â€œ?â€ å°±å¯ä»¥æ‰“å¼€å¿«æ·æ“ä½œæŒ‡å¼•ã€‚\nstern stern å¯ä»¥ç”¨æ¥ tail é›†ç¾¤ä¸Šçš„å¤šä¸ª pod å’Œ pod ä¸­å¤šä¸ªå®¹å™¨çš„æ—¥å¿—ã€‚ä¸åŒçš„ pod å’Œå®¹å™¨ä»¥ä¸åŒçš„é¢œè‰²åŒºåˆ†ï¼Œæ–¹ä¾¿ debugã€‚\næ¯”å¦‚ä½¿ç”¨å‘½ä»¤ stern -l tier=control-plane -n kube-system å¯ä»¥è¾“å‡º kube-system å‘½åç©ºé—´ä¸‹æ§åˆ¶å¹³é¢ï¼ˆlabel ä¸º tier=control-planeï¼‰ pod çš„æ—¥å¿—ã€‚\nå‘½ä»¤è¡Œé€‰é¡¹\nTail multiple pods and containers from Kubernetes Usage: stern pod-query [flags] Flags: -A, --all-namespaces If present, tail across all namespaces. A specific namespace is ignored even if specified with --namespace. --color string Color output. Can be \u0026#39;always\u0026#39;, \u0026#39;never\u0026#39;, or \u0026#39;auto\u0026#39; (default \u0026#34;auto\u0026#34;) --completion string Outputs stern command-line completion code for the specified shell. Can be \u0026#39;bash\u0026#39; or \u0026#39;zsh\u0026#39; -c, --container string Container name when multiple containers in pod (default \u0026#34;.*\u0026#34;) --container-state string If present, tail containers with status in running, waiting or terminated. Default to running. (default \u0026#34;running\u0026#34;) --context string Kubernetes context to use. Default to current context configured in kubeconfig. -e, --exclude strings Regex of log lines to exclude -E, --exclude-container string Exclude a Container name --field-selector string Selector (field query) to filter on. If present, default to \u0026#34;.*\u0026#34; for the pod-query. -h, --help help for stern -i, --include strings Regex of log lines to include --init-containers Include or exclude init containers (default true) --kubeconfig string Path to kubeconfig file to use -n, --namespace strings Kubernetes namespace to use. Default to namespace configured in Kubernetes context. To specify multiple namespaces, repeat this or set comma-separated value. -o, --output string Specify predefined template. Currently support: [default, raw, json] (default \u0026#34;default\u0026#34;) -l, --selector string Selector (label query) to filter on. If present, default to \u0026#34;.*\u0026#34; for the pod-query. -s, --since duration Return logs newer than a relative duration like 5s, 2m, or 3h. Defaults to 48h. --tail int The number of lines from the end of the logs to show. Defaults to -1, showing all logs. (default -1) --template string Template to use for log lines, leave empty to use --output flag -t, --timestamps Print timestamps --timezone string Set timestamps to specific timezone (default \u0026#34;Local\u0026#34;) -v, --version Print the version and exit Lens Lens æ˜¯ç”¨æ¥æ§åˆ¶ Kubernetes çš„ IDEï¼Œå¼€æºä¸”å…è´¹ã€‚\næ¶ˆé™¤äº†é›†ç¾¤æ“ä½œçš„å¤æ‚æ€§ã€æä¾›äº†å®æ—¶çš„å¯è§‚å¯Ÿæ€§ã€æ–¹ä¾¿æ•…éšœæ’æŸ¥ã€æ”¯æŒå¤šç³»ç»Ÿçš„æ¡Œé¢å®¢æˆ·ç«¯ã€å…¼å®¹å¤šç§é›†ç¾¤ã€‚\nInfra App Infra App è·Ÿ Lens å·®ä¸å¤šï¼ŒUI è¾ƒ Lens å¥½äº›ï¼Œä½†æ˜¯åŠŸèƒ½å°±å¼±å¾ˆå¤šï¼Œç±»ä¼¼ Lens çš„åªè¯»æ¨¡å¼ã€‚\nå…è´¹ç‰ˆæ¯”æ”¶è´¹ç‰ˆçš„åŒºåˆ«åªåœ¨äºæ”¯æŒçš„é›†ç¾¤æ•°é‡ï¼Œå…è´¹ç‰ˆåªæ”¯æŒä¸€ä¸ªé›†ç¾¤ã€‚\nkubefwd kubefwdï¼Œè¿™ä¸ªä¸€ç›´æœ‰å®‰è£…ä½†æ˜¯ä½¿ç”¨æ¬¡æ•°å¯¥å¯¥ï¼Œå› ä¸ºåº”ç”¨ä¹‹é—´çš„è®¿é—®æ²¡æœ‰èµ° serviceï¼Œä¸è¿‡å¶å°”åšäº›å®éªŒçš„æ—¶å€™ä¼šç”¨çš„ä¸Šã€‚\nkubefwd æ˜¯ä¸€ä¸ªç”¨äºç«¯å£è½¬å‘Kubernetesä¸­æŒ‡å®šnamespaceä¸‹çš„å…¨éƒ¨æˆ–è€…éƒ¨åˆ†podçš„å‘½ä»¤è¡Œå·¥å…·ã€‚ kubefwd ä½¿ç”¨æœ¬åœ°çš„ç¯å›IPåœ°å€è½¬å‘éœ€è¦è®¿é—®çš„serviceï¼Œå¹¶ä¸”ä½¿ç”¨ä¸serviceç›¸åŒçš„ç«¯å£ã€‚ kubefwd ä¼šä¸´æ—¶å°†serviceçš„åŸŸæ¡ç›®æ·»åŠ åˆ° /etc/hosts æ–‡ä»¶ä¸­ã€‚\nå¯åŠ¨kubefwdåï¼Œåœ¨æœ¬åœ°å°±èƒ½åƒåœ¨Kubernetesé›†ç¾¤ä¸­ä¸€æ ·ä½¿ç”¨serviceåå­—ä¸ç«¯å£è®¿é—®å¯¹åº”çš„åº”ç”¨ç¨‹åºã€‚\næ€»ç»“ å–„ç”¨å·¥å…·å¯ä»¥æå‡æ•ˆç‡ï¼Œä½†å¹¶ä¸æ˜¯ä¸å¯æˆ–ç¼ºçš„ã€‚\nå¦‚æœä½ æœ‰å…¶ä»–çš„å·¥å…·ï¼Œæ¬¢è¿ç•™è¨€æå‡ºã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/tools-accelerate-work-on-kubernetes-cluster/","tags":["Kubernetes","Tool"],"title":"å¸¸ç”¨çš„å‡ æ¬¾å·¥å…·è®© Kubernetes é›†ç¾¤ä¸Šçš„å·¥ä½œæ›´å®¹æ˜“"},{"categories":["äº‘åŸç”Ÿ"],"contents":"æœ¬æ–‡è¯¦ç»†ä»‹ç»äº† Jenkins å¦‚ä½•é€šè¿‡ tekton-client-plugin å®ç°ä¸ Kubernetes ä¸Šçš„ Tekton Pipeline äº¤äº’ï¼ŒåŒ…æ‹¬ Kubernetes ä¸Šå®‰è£… Jenkinsã€Tekton Pipelines ç­‰ã€‚\nå…³äºå¦‚ä½•ä½¿ç”¨ Tekton Pipeline å®ç° CICD å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç«  äº‘åŸç”Ÿ CICD: Tekton Pipeline å®æˆ˜\næœ¬æ–‡ç”¨äºæ„å»ºçš„é¡¹ç›®ä»¥åŠæ‰€æœ‰ manifest yaml éƒ½åœ¨å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½ã€‚\nTL;DR æƒ¯ä¾‹ï¼Œå…ˆä¸Šæ€»ç»“ã€‚tekton-client-plugin è™½ç„¶è¿˜æ˜¯å¤„äºåˆæœŸé˜¶æ®µï¼Œä½†æ˜¯ å…¶ä»·å€¼éå¸¸æ˜æ˜¾ï¼Œå°¤å…¶æ˜¯å¯¹å…ˆç”¨ä½¿ç”¨ Jenkins ä½œä¸º CICD å®ç°çš„ç”¨æˆ·æ¥è¯´ã€‚ä» Jenkins è¿ç§»åˆ°äº‘åŸç”Ÿçš„ Tekton æ—¶ï¼Œå¯ä»¥çœæ‰ç”¨æˆ·ç•Œé¢çš„å¼€å‘æˆæœ¬ï¼Œè€Œä¸”å°½å¯èƒ½å°‘çš„æ”¹å˜ç”¨æˆ·ä¹ æƒ¯ ï¼Œä¾é ç‰ˆæœ¬ç®¡ç†å¯ä»¥æ§åˆ¶è¿ç§»çš„èŠ‚å¥ã€‚\ntekton-client-plugin åœ¨ä»Šå¹´ 5 æœˆ 7 æ—¥å‘å¸ƒçš„ 1.0.0 ç‰ˆæœ¬ï¼Œç›®å‰ä¸º 1.0.02ã€‚ç›®å‰è¿˜å¤„äºåˆæœŸé˜¶æ®µï¼Œæˆ‘ä¸ªäººæ„Ÿè§‰ç›®å‰ä»…ä»…ç®—æ˜¯æ‰“é€š Jenkins ä¸ Tekton äº¤äº’è¿™æ¡è·¯ï¼Œæ‰©å±•æ€§è¿˜ä¸å¤Ÿå¥½ã€‚\næ¯”å¦‚ç›®å‰ä»…ä»…æ”¯æŒå¦‚ä¸‹å‡ ä¸ªå‚æ•°æ³¨å…¥åˆ° PipelineRun ä¸­ï¼Œéš¾ä»¥æ”¯æ’‘å¤æ‚çš„æµç¨‹æ§åˆ¶ï¼Œæ”¯æŒçš„ Pipeline å‚æ•° hardcode åœ¨ä»£ç ä¸­ã€‚\nBUILD_ID - the build id/number of the Jenkins job JOB_NAME - the name of the jenkins job that triggered this pipeline PULL_BASE_REF - name of the base branch PULL_PULL_SHA - the commit sha of the pull request or branch REPO_NAME - name of the repository REPO_OWNER - owner of the repository REPO_URL - the URL of the repository å¸Œæœ›åé¢ä¼šæ”¯æŒè‡ªå®šä¹‰å‚æ•°ï¼Œæ¯”å¦‚å°†æ›´å¤šçš„é¡¹ç›®å…ƒæ•°æ®ä¿¡æ¯æ³¨å†Œåˆ° Pipeline ä¸­ã€‚\nå€¼å¾—ä¸€æçš„æ˜¯ï¼Œtekton-client-plugin æä¾›äº†å¯¹ Job DSL çš„æ”¯æŒï¼Œæœ¬æ–‡åé¢æ²¡æœ‰ç”¨è¿™ç§æ–¹å¼ï¼Œè€Œæ˜¯ç”¨çš„ FreeStyle Projectã€‚\npipeline { agent any stages { stage(\u0026#39;Stage\u0026#39;) { steps { checkout scm tektonCreateRaw(inputType: \u0026#39;FILE\u0026#39;, input: \u0026#39;.tekton/pipeline.yaml\u0026#39;) } } } } å‰ç½®æ¡ä»¶ ç¯å¢ƒ Kubernetesï¼šæ¨è minikube Jenkinsï¼šå»ºè®®åœ¨ Kubernetes ä¸Šå®‰è£… Tekton ç”¨äºæ„å»ºçš„é¡¹ç›® å·¥å…· kubectl tektoncd-cli kubectxã€kubens helm Kubernetes ä¸Šå®‰è£… Jenkinsï¼ˆHelmï¼‰ Jenkins è¿™é‡Œä½¿ç”¨ Helm å®‰è£…åˆ° Kubernetes ä¸Šã€‚\nåˆå§‹åŒ–å‘½åç©ºé—´ã€æŒä¹…åŒ–å·ã€ServiceAccount ç­‰ã€‚\nkubectl create namespace jenkins kubens jenkins # æŒä¹…åŒ–å­˜å‚¨ï¼Œç¬”è€…å°†å®¹é‡ä¿®æ”¹ä¸º 5G http https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/doc/tutorials/kubernetes/installing-jenkins-on-kubernetes/jenkins-volume.yaml --body \u0026gt; jenkins-volume.yaml # åˆ›å»º PV kubectl apply -f jenkins-volume.yaml # åˆ›å»º service account kubectl apply -f https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/doc/tutorials/kubernetes/installing-jenkins-on-kubernetes/jenkins-sa.yaml å‡†å¤‡ helm ç¯å¢ƒå¹¶æ·»åŠ  Jenkins ChartRepo # homebrew å®‰è£… helm brew install helm # æ·»åŠ  jenkins chart repo helm repo add jenkinsci https://charts.jenkins.io helm repo update é…ç½® Jenkins Chart ä¸‹è½½å®˜æ–¹çš„ values yamlè¿›è¡Œä¿®æ”¹ï¼šhttp https://raw.githubusercontent.com/jenkinsci/helm-charts/main/charts/jenkins/values.yaml \u0026gt; jenkins-values.yaml ä¿®æ”¹ serviceType ä¸º NodePortï¼Œå¹¶å¢åŠ  nodePort: 32000ã€‚ç”¨äºä» minikube å¤–è®¿é—® Jenkins ä¿®æ”¹ storageClass ä¸º jenkins-pvã€‚å‰é¢åˆ›å»º PV çš„æ—¶å€™ä½¿ç”¨äº† jenkins-pv ä½œä¸º Dynamic Volume Provisioning çš„ storageClass ä¿®æ”¹ serviceAccount éƒ¨åˆ†ï¼Œå°† create è®¾ç½®ä¸º falseï¼ˆä¸Šé¢å·²ç»åˆ›å»ºäº† serviceAccountï¼‰ï¼ŒåŒæ—¶å°† name æŒ‡å®šä¸ºå‰é¢çš„ sa åå­— jenkins installPlugins ä¸‹å¢åŠ  tekton-client:1.0.2 ä¿®æ”¹ adminPassword ä¸º adminã€‚æŒ‡å®šåˆå§‹å¯†ç ï¼ˆä¸æŒ‡å®šä¹Ÿå¯ä»¥é€šè¿‡å®‰è£…è¾“å‡ºçš„è¯´æ˜è·å–åˆå§‹å¯†ç ï¼‰ ä¿®æ”¹ persistence çš„ size ä¸º 5Gi ï¼ˆæˆ‘çš„ minikube çš„è™šæ‹Ÿæœºåªæœ‰ 20Gi å¤§å°ï¼‰ ä¿®æ”¹åçš„æ–‡ä»¶åœ¨è¿™é‡Œ jenkins-values.yamlã€‚\næ‰§è¡Œå®‰è£… chart=jenkinsci/jenkins helm install jenkins -n jenkins -f jenkins-values.yaml $chart è¾“å‡ºç»“æœï¼š\nNAME: jenkins LAST DEPLOYED: Sun Jun 20 22:05:53 2021 NAMESPACE: jenkins STATUS: deployed REVISION: 1 è·å– Jenkins çš„è®¿é—®åœ°å€ echo $(minikube ip):$(kubectl get svc jenkins -o jsonpath=\u0026quot;{.spec.ports[0].nodePort}\u0026quot;)ï¼Œç„¶åä½¿ç”¨å‰é¢è®¾ç½®çš„è´¦å·ç™»å½•ã€‚\nTekton å®‰è£… kubectl create ns tekton-pipelines kubens tekton-pipelines kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml å®‰è£… CLI brew install tektoncd-cli\nRBAC Tekton Pipeline å®‰è£…å®Œæˆåï¼Œéœ€è¦ç»™å‰é¢åˆ›å»ºçš„ ServiceAccount jenkins å¢åŠ  tekon èµ„æºçš„æ“ä½œæƒé™ã€‚\n//tekton-role.yaml kind: Role apiVersion: rbac.authorization.k8s.io/v1 metadata: name: tekton-role namespace: tekton-pipelines rules: - apiGroups: - \u0026#34;\u0026#34; resources: - pods - pods/log verbs: - get - list - watch - apiGroups: - tekton.dev resources: - tasks - taskruns - pipelines - pipelineruns verbs: - create - delete - deletecollection - get - list - patch - update - watch --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: tekton-role-binding namespace: tekton-pipelines roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: tekton-role subjects: - kind: ServiceAccount name: jenkins namespace: jenkins Jenkins ä¸ Tekton äº¤äº’ å‰é¢å¤§ç¯‡å¹…çš„éƒ½åªæ˜¯å‡†å¤‡å·¥ä½œï¼ŒJenkins å®‰è£…æ—¶æˆ‘ä»¬å·²ç»æ·»åŠ äº† tekton-client-plugin æ’ä»¶ã€‚\næ·»åŠ ä¸€ä¸ªåä¸º tekton-client-sample çš„ FreeStyle projectã€‚\nSCM è¿™é‡Œå¡«å…¥ç”¨äºæ„å»ºçš„é¡¹ç›®ä»“åº“åœ°å€ä»¥åŠåˆ†æ”¯ã€‚\nBuild æ¨¡å—ä¸­é€‰æ‹© Tekton: Create Resource (RAW)\nè¿™é‡Œé€‰æ‹© FILE ç±»å‹ï¼Œå› ä¸ºæˆ‘å·²ç»å°† PipelineRun çš„ yaml æ”¾è¿›äº†ä»£ç ä»“åº“ä¸­äº†ã€‚\næ‰§è¡Œä¸€æ¬¡æ„å»º\næ£€æŸ¥ä¸‹åº”ç”¨\n$ kubectl get pod | grep tekton-test tekton-test-75975dcc88-xkzb6 1/1 Running 0 3m13s tekton-test-c26lw-deploy-to-k8s-28trp-pod-w8tgc 0/1 Completed 0 3m18s tekton-test-c26lw-fetch-from-git-pv66g-pod-nm5qh 0/1 Completed 0 6m30s tekton-test-c26lw-source-to-image-k8mpg-pod-qh7g4 0/2 Completed 0 6m15s $ curl $(minikube ip):$(kubectl get svc tekton-test -o jsonpath=\u0026#34;{.spec.ports[0].nodePort}\u0026#34;)/hi hello world å‚è€ƒ Jenkins on Kubernetes Tekton Client Plugin Tutorial Easily reuse Tekton and Jenkins X from Jenkins ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/jenkins-interact-with-tekton-pipelines-via-plugin/","tags":["Jenkins","Tekton","Kubernetes","DevOps"],"title":"Jenkins å¦‚ä½•ä¸ Kubernetes é›†ç¾¤çš„ Tekton Pipeline äº¤äº’ï¼Ÿ"},{"categories":["æ•™ç¨‹","äº‘åŸç”Ÿ"],"contents":"æ›´æ–°å†å²ï¼š\nv1ï¼š2020.1.21 åŸºäº Tekton Pipline v0.9.0 v2ï¼ˆå½“å‰ï¼‰ï¼š2021.6.22 åŸºäº Tekton Pipeline v0.25.0 Tekton æ˜¯ Google å¼€æºçš„ Kubernetes åŸç”ŸCI/CD ç³»ç»Ÿ, åŠŸèƒ½å¼ºå¤§æ‰©å±•æ€§å¼º. å‰èº«æ˜¯ Knavite é‡Œçš„ build-pipeline é¡¹ç›®, åæœŸå­µåŒ–æˆç‹¬ç«‹çš„é¡¹ç›®. å¹¶æˆä¸º CDF ä¸‹çš„å››ä¸ªé¡¹ç›®ä¹‹ä¸€, å…¶ä»–ä¸‰ä¸ªåˆ†åˆ«æ˜¯ Jenkins, Jenkins X, Spinnaker.\nä¸ºä»€ä¹ˆè¯´ Tekton æ˜¯ Kubernetes åŸç”Ÿçš„, ä»¥å†…å…¶åŸºäº Kubernetes çš„ CRD å®šä¹‰äº† Pipeline æµæ°´çº¿.\nCRD åŠè¯´æ˜:\nTask: æ„å»ºä»»åŠ¡, å¯ä»¥å®šä¹‰ä¸€äº›åˆ—çš„ steps. æ¯ä¸ª step ç”±ä¸€ä¸ª container æ‰§è¡Œ. TaskRun: task å®é™…çš„æ‰§è¡Œ, å¹¶æä¾›æ‰§è¡Œæ‰€éœ€çš„å‚æ•°. è¿™ä¸ªå¯¹è±¡åˆ›å»ºå, å°±ä¼šæœ‰ pod è¢«åˆ›å»º. Pipeline: å®šä¹‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª task çš„æ‰§è¡Œ, ä»¥åŠ PipelineResource å’Œå„ç§å®šä¹‰å‚æ•°çš„é›†åˆ PipelineRun: ç±»ä¼¼ task å’Œ taskrun çš„å…³ç³»: ä¸€ä¸ªå®šä¹‰ä¸€ä¸ªæ‰§è¡Œ. PipelineRun åˆ™æ˜¯ pipeline çš„å®é™…æ‰§è¡Œ. åˆ›å»ºåä¹Ÿä¼šåˆ›å»º pod æ¥æ‰§è¡Œå„ä¸ª task. PipelineResource: æµæ°´çº¿çš„è¾“å…¥èµ„æº, æ¯”å¦‚ github/gitlab çš„æºç , æŸç§å­˜å‚¨æœåŠ¡çš„æ–‡ä»¶, æˆ–è€…é•œåƒç­‰. æ‰§è¡Œæ—¶, ä¹Ÿä¼šä½œä¸º pod çš„å…¶ä¸­ä¸€ä¸ª container æ¥è¿è¡Œ(æ¯”å¦‚æ‹‰å–ä»£ç ). PipelineResource ç›®å‰å¤„äº Alahaï¼Œè‡³äºåŸå› å¯ä»¥çœ‹Why Aren\u0026rsquo;t PipelineResources in Beta? Condition: åœ¨ pipeline çš„ task æ‰§è¡Œæ—¶é€šè¿‡æ·»åŠ  condition æ¥å¯¹æ¡ä»¶è¿›è¡Œè¯„ä¼°, è¿›è€Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œ task. ç›®å‰æ˜¯WIPçš„çŠ¶æ€, å¾…#1137çš„å®Œæˆ. ç»„ä»¶:\ntekton-pipelines-controller: ç›‘æ§ CRD å¯¹è±¡(TaskRun, PipelineRun)çš„åˆ›å»º, ä¸ºè¯¥æ¬¡æ‰§è¡Œåˆ›å»º pod. tekton-pipelines-webhook: å¯¹ apiserver æä¾› http æ¥å£åš CRD å¯¹è±¡çš„æ ¡éªŒ. å‰ç½®æ¡ä»¶ æ–‡ä¸­ä½¿ç”¨çš„ä¸€äº›å·¥å…·ï¼ŒåŸºæœ¬éƒ½å¯ä»¥é€šè¿‡ homebrew å®‰è£…ï¼š\njq ï¼šæ“ä½œ json çš„å‘½ä»¤è¡Œå·¥å…· httpieï¼šHTTP å®¢æˆ·ç«¯å‘½ä»¤è¡Œå·¥å…· minikube ç¯å¢ƒ æ–‡ä¸­çš„ Java é¡¹ç›®ä»¥åŠ tekton çš„ç›¸å…³ yaml éƒ½å·²ç»æäº¤åˆ°äº† tekton-test.\nå®‰è£… å‚è€ƒä¸Šä¸€ç¯‡æ–‡ç« , æ–‡ç« ä¸­æœ‰ä¸ªç®€å•çš„\u0026quot;hello world\u0026quot;.\nå®è·µ åˆ°äº†è¿™é‡Œç›¸ä¿¡å·²ç»å®‰è£…å¥½äº† Tekton. æˆ‘ä»¬ä½¿ç”¨Spring Initializerç”Ÿæˆçš„é¡¹ç›®ä¸ºä¾‹, æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Tekton å®ç° CICD.\nå¼€å§‹ä¹‹å‰ç®€å•æ•´ç†ä¸‹è¿™ä¸ªé¡¹ç›®çš„ CICD æµç¨‹:\næ‹‰å–ä»£ç  maven æ‰“åŒ… æ„å»ºé•œåƒå¹¶æ¨é€ éƒ¨ç½² æ³¨: æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åœ¨ tekton-pipelines namespace ä¸‹æ“ä½œ\n0x00 æ·»åŠ  Dockerfile å’Œéƒ¨ç½²ç”¨çš„ yaml ç”¨äºæ„å»ºé•œåƒçš„Dockerfile\nFROM openjdk:8-jdk-alpine RUN mkdir /app WORKDIR /app COPY target/*.jar /app/app.jar ENTRYPOINT [\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;java -Xmx128m -Xms64m -jar app.jar\u0026#34;] ç”¨äºéƒ¨ç½² K8s Deployment çš„ deployment.ymlï¼ŒåŒæ—¶é€šè¿‡åˆ›å»º NodePort ç±»å‹çš„ Service ç”¨äºè®¿é—®åº”ç”¨ã€‚\napiVersion: \u0026#34;apps/v1\u0026#34; kind: \u0026#34;Deployment\u0026#34; metadata: labels: app: \u0026#34;tekton-test\u0026#34; name: \u0026#34;tekton-test\u0026#34; spec: replicas: 1 selector: matchLabels: app: \u0026#34;tekton-test\u0026#34; template: metadata: labels: app: \u0026#34;tekton-test\u0026#34; spec: containers: - image: \u0026#34;addozhang/tekton-test:latest\u0026#34; imagePullPolicy: \u0026#34;Always\u0026#34; livenessProbe: failureThreshold: 3 httpGet: path: \u0026#34;/actuator/info\u0026#34; port: 8080 scheme: \u0026#34;HTTP\u0026#34; initialDelaySeconds: 60 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 10 name: \u0026#34;tekton-test\u0026#34; ports: - containerPort: 8080 name: \u0026#34;http\u0026#34; protocol: \u0026#34;TCP\u0026#34; readinessProbe: failureThreshold: 3 httpGet: path: \u0026#34;/actuator/info\u0026#34; port: 8080 scheme: \u0026#34;HTTP\u0026#34; initialDelaySeconds: 30 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 10 --- apiVersion: v1 kind: Service metadata: creationTimestamp: null labels: app: tekton-test name: tekton-test spec: ports: - port: 8080 protocol: TCP targetPort: 8080 selector: app: tekton-test type: NodePort 0x01 RBAC åˆ›å»º ServiceAccount ç”¨äº Pipeline çš„è¿è¡Œã€‚\næ³¨ï¼šè¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆäºˆäº† ClusterRole adminã€‚\n# serviceaccount.yaml apiVersion: v1 kind: ServiceAccount metadata: name: tekton-build --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: pipeline-admin-binding roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: admin # user cluster role admin subjects: - kind: ServiceAccount name: tekton-build namespace: tekton-pipelines 0x02 æ‹‰å–ä»£ç  ä»£ç ä½œä¸ºæ„å»ºçš„è¾“å…¥, éœ€è¦æä¾›ä¸€ä¸ª Pipeline CRD å¯¹è±¡æ¥è¡¨ç¤ºè¾“å…¥æ˜¯ä» git ä»“åº“æ¥è·å–ä»£ç ã€‚\nè®¿é—® Tekton Hub å¯ä»¥æ‰¾åˆ°ç°æˆçš„ git-clone taskã€‚\nä½¿ç”¨ kubectl å®‰è£…ï¼š\nkubectl apply -f https://raw.githubusercontent.com/tektoncd/catalog/main/task/git-clone/0.4/git-clone.yaml æˆ–è€…ä½¿ç”¨ tekton-cli å®‰è£…ï¼š\ntkn hub install task git-clone 0x03 maven æ‰“åŒ… Task source-to-image.yamlçš„ step mavenï¼š\nspec: workspaces: - name: source steps: - name: maven image: maven:3.5.0-jdk-8-alpine workingDir: $(workspaces.source.path) command: - mvn args: - clean - install - -DskipTests volumeMounts: - name: m2 mountPath: /root/.m2 volumes: - name: m2 hostPath: path: /home/docker/.m2 è¯´æ˜:\næœ‰äº†ä»£ç ä¸‹ä¸€æ­¥å°±æ˜¯æ‰§è¡Œ maven çš„ç¼–è¯‘æ‰“åŒ…, åœ¨maven:3.5.0-jdk-8-alpineé•œåƒä¸­æ‰§è¡Œmvnçš„ç›¸å…³å‘½ä»¤.\nè¿™é‡ŒæŒ‚åœ¨äº†ä¸€ä¸ªæœ¬åœ°çš„volume, é¿å…æ¯æ¬¡æ„å»ºé‡å¤ä¸‹è½½ä¾èµ–åŒ…, åŒæ—¶é‡Œé¢è¿˜æœ‰ settings.xml\næ³¨æ„: å¯¹äº minikube, hostPath è¯·ä½¿ç”¨/data/.m2, å¦åˆ™minikubeé‡å¯åæ— æ³•æŒä¹…åŒ–\n0x04 æ„å»ºé•œåƒå¹¶æ¨é€ Task source-to-image.yaml çš„ step build-and-pushï¼š\nspec: params: - name: pathToDockerFile description: The path to the dockerfile to build (relative to the context) default: Dockerfile - name: imageUrl description: Url of image repository - name: imageTag description: Tag to apply to the built image default: latest workspaces: - name: source - name: dockerconfig mountPath: /kaniko/.docker # config.json çš„æŒ‚è½½ç›®å½• steps: - name: build-and-push image: gcr.io/kaniko-project/executor:v1.6.0-debug command: - /kaniko/executor args: - --dockerfile=$(params.pathToDockerFile) - --destination=$(params.imageUrl):$(params.imageTag) - --context=$(workspaces.source.path) è¯´æ˜:\né•œåƒçš„æ„å»º, æˆ‘ä»¬é‡‡ç”¨äº† kanikoã€‚\né•œåƒä»“åº“æˆ‘ä»¬é€‰æ‹©äº†Docker Hub, æ¨é€çš„æ—¶å€™éœ€è¦ä½¿ç”¨ credentialsã€‚\nkaniko éœ€è¦å°† docker config çš„æ–‡ä»¶å­˜åœ¨äº /kanika/.docker ç›®å½•ä¸‹ã€‚è¿™é‡Œçš„æ€è·¯æ˜¯å°† docker çš„ config.jsonï¼Œä»¥ secret çš„æ–¹å¼æŒä¹…åŒ–ï¼Œåœ¨é€šè¿‡å…ˆæ·»åŠ  docker-registryç±»å‹çš„ secretï¼Œç„¶åé€šè¿‡ workspace çš„æ–¹å¼è¾“å…¥åˆ° kaniko è¿è¡Œç¯å¢ƒä¸­ã€‚\nconfig.json é‡Œé¢ä¿å­˜çš„ json ç»“æ„åŒ–çš„æ•°æ®ï¼Œä¸ºäº†æ–¹ä¾¿é€šè¿‡ dry run åˆ›å»º\nkubectl create secret docker-registry dockerhub --docker-server=https://index.docker.io/v1/ --docker-username=[USERNAME] --docker-password=[PASSWORD] --dry-run=client -o json | jq -r \u0026#39;.data.\u0026#34;.dockerconfigjson\u0026#34;\u0026#39; | base64 -d \u0026gt; /tmp/config.json \u0026amp;\u0026amp; kubectl create secret generic docker-config --from-file=/tmp/config.json \u0026amp;\u0026amp; rm -f /tmp/config.json æ‰§è¡Œ:\nkubectl apply -f tasks/source-to-image.yaml 0x05 éƒ¨ç½² deploy-to-k8s.yaml:\napiVersion: tekton.dev/v1alpha1 kind: Task metadata: name: deploy-to-k8s spec: inputs: resources: - name: git-source type: git params: - name: pathToYamlFile description: The path to the yaml file to deploy within the git source default: deployment.yaml steps: - name: run-kubectl image: lachlanevenson/k8s-kubectl command: [\u0026#34;kubectl\u0026#34;] args: - \u0026#34;apply\u0026#34; - \u0026#34;-f\u0026#34; - \u0026#34;/workspace/git-source/$(inputs.params.pathToYamlFile)\u0026#34; è¯´æ˜:\npathToYamlFile: æŒ‡å®šéƒ¨ç½²åº”ç”¨çš„ yamlã€‚ æ‰§è¡Œ:\nkubectl apply -f tasks/deploy-to-k8s.yaml 0x06 ç»„è£…æµæ°´çº¿ build-pipeline.yaml\napiVersion: tekton.dev/v1beta1 kind: Pipeline metadata: name: build-pipeline spec: params: - name: git-url - name: git-revision - name: pathToContext description: The path to the build context, used by Kaniko - within the workspace default: . - name: imageUrl description: Url of image repository - name: imageTag description: Tag to apply to the built image workspaces: - name: git-source - name: docker-config tasks: - name: fetch-from-git taskRef: name: git-clone params: - name: url value: \u0026#34;$(params.git-url)\u0026#34; - name: revision value: \u0026#34;$(params.git-revision)\u0026#34; workspaces: - name: output workspace: git-source - name: source-to-image taskRef: name: source-to-image params: - name: imageUrl value: \u0026#34;$(params.imageUrl)\u0026#34; - name: imageTag value: \u0026#34;$(params.imageTag)\u0026#34; workspaces: - name: source workspace: git-source - name: dockerconfig workspace: docker-config runAfter: - fetch-from-git - name: deploy-to-k8s taskRef: name: deploy-to-k8s params: - name: pathToYamlFile value: deployment.yaml workspaces: - name: source workspace: git-source runAfter: - source-to-image æ‰§è¡Œ:\nkubectl apply -f tasks/deploy-to-k8s.yaml 0x07 æ‰§è¡Œæµæ°´çº¿ apiVersion: tekton.dev/v1beta1 kind: PipelineRun metadata: generateName: generic-pr- name: generic-pipeline-run spec: pipelineRef: name: build-pipeline params: - name: git-revision value: main - name: git-url value: https://github.com/addozhang/tekton-test.git - name: imageUrl value: addozhang/tekton-test - name: imageTag value: latest workspaces: - name: git-source volumeClaimTemplate: spec: accessModes: - ReadWriteOnce resources: requests: storage: 1Gi - name: docker-config secret: secretName: docker-config serviceAccountName: tekton-build æ‰§è¡Œ:\nkubectl apply -f run/run.yaml 0x08 ç»“æœ æ‰§è¡Œæµæ°´çº¿å, å¯ä»¥çœ‹åˆ°åˆ†åˆ«åˆ›å»ºäº†ä¸‹é¢çš„å‡ ä¸ª pod:\ngeneric-pipeline-run-deploy-to-k8s-xxx generic-pipeline-run-fetch-from-git-xxx generic-pipeline-run-source-to-image-xxx ä»¥åŠæˆ‘ä»¬çš„åº”ç”¨ tekton-test-xxxï¼Œå‘èµ·è¯·æ±‚æµ‹è¯•ï¼š\n$ http $(minikube ip):$(kubectl get svc tekton-test -o jsonpath=\u0026#34;{.spec.ports[0].nodePort}\u0026#34;)/hi --body hello world æ€»ç»“ ç›®å‰ Tekton è¿›å…¥ beta é˜¶æ®µ, æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ 0.25.0ã€‚åŸºäº CRD çš„å®ç°è®© Tekton åœ¨å®é™…ä½¿ç”¨ä¸­å¯ä»¥çµæ´»çš„è®¾è®¡è‡ªå·±çš„ CICD æµç¨‹.\nç”Ÿæ€ä¹Ÿè¶Šæ¥è¶Šå®Œå–„ï¼Œæ¯”å¦‚ Tekton Hub æä¾›äº†å¤§é‡çš„å¯é‡ç”¨æœ€ä½³å®ç°çš„ Task å’Œ Pipelineã€‚\nä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°è¯•ä¸‹å¦‚ä½•åœ¨ Jenkins ä¸­ä¸ Tekton Pipeline è¿›è¡Œäº¤äº’ã€‚\næ›´å¤šæ–‡ç« :\nTekton çš„å·¥ä½œåŸç† Tekton Dashboard å®‰è£… Tekton Trigger ä»‹ç» Tekton Trigger å®æˆ˜ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/tekton-pipeline-practice/","tags":["DevOps","Tekton","Kubernetes","äº‘åŸç”Ÿ"],"title":"äº‘åŸç”Ÿ CICD: Tekton Pipeline å®æˆ˜"},{"categories":["æºç è§£æ"],"contents":"æœ¬æ–‡ä¸»è¦ä»‹ç» kubelet åŠŸèƒ½ã€æ ¸å¿ƒç»„ä»¶ï¼Œä»¥åŠå¯åŠ¨æµç¨‹çš„æºç åˆ†æï¼Œæ€»ç»“äº† kubelet çš„å·¥ä½œåŸç†ã€‚\nkubelet ç®€ä»‹ ä»å®˜æ–¹çš„æ¶æ„å›¾ä¸­å¾ˆå®¹æ˜“å°±èƒ½æ‰¾åˆ° kubelet\næ‰§è¡Œ kubelet -h çœ‹åˆ° kubelet çš„åŠŸèƒ½ä»‹ç»ï¼š\nkubelet æ˜¯æ¯ä¸ª Node èŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œçš„ä¸»è¦â€œèŠ‚ç‚¹ä»£ç†â€ã€‚ä½¿ç”¨å¦‚ä¸‹çš„ä¸€ä¸ªå‘ apiserver æ³¨å†Œ Node èŠ‚ç‚¹ï¼šä¸»æœºçš„ hostnameï¼›è¦†ç›– host çš„å‚æ•°ï¼›æˆ–è€…äº‘æä¾›å•†æŒ‡å®šçš„é€»è¾‘ã€‚ kubelet åŸºäº PodSpec å·¥ä½œã€‚PodSpec æ˜¯ç”¨ YAML æˆ–è€… JSON å¯¹è±¡æ¥æè¿° Podã€‚Kubelet æ¥å—é€šè¿‡å„ç§æœºåˆ¶ï¼ˆä¸»è¦æ˜¯ apiserverï¼‰æä¾›çš„ä¸€ç»„ PodSpecï¼Œå¹¶ç¡®ä¿é‡Œé¢æè¿°çš„å®¹å™¨è‰¯å¥½è¿è¡Œã€‚ é™¤äº†ç”± apiserver æä¾› PodSpecï¼Œè¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æä¾›ï¼š\næ–‡ä»¶ HTTP ç«¯ç‚¹ HTTP æœåŠ¡å™¨ kubelet åŠŸèƒ½å½’çº³ä¸€ä¸‹å°±æ˜¯ä¸ŠæŠ¥ Node èŠ‚ç‚¹ä¿¡æ¯ï¼Œå’Œç®¡ç†ï¼ˆåˆ›å»ºã€é”€æ¯ï¼‰Podã€‚ åŠŸèƒ½çœ‹ä¼¼ç®€å•ï¼Œå®é™…ä¸ç„¶ã€‚æ¯ä¸€ä¸ªç‚¹æ‹¿å‡ºæ¥éƒ½éœ€è¦å¾ˆå¤§çš„ç¯‡å¹…æ¥è®²ï¼Œæ¯”å¦‚ Node èŠ‚ç‚¹çš„è®¡ç®—èµ„æºï¼Œé™¤äº†ä¼ ç»Ÿçš„ CPUã€å†…å­˜ã€ç¡¬ç›˜ï¼Œè¿˜æä¾›æ‰©å±•æ¥æ”¯æŒç±»ä¼¼ GPU ç­‰èµ„æºï¼›Pod ä¸ä»…ä»…æœ‰å®¹å™¨ï¼Œè¿˜æœ‰ç›¸å…³çš„ç½‘ç»œã€å®‰å…¨ç­–ç•¥ç­‰ã€‚\nkubelet æ¶æ„ é‡è¦ç»„ä»¶ kubelet çš„æ¶æ„ç”± N å¤šçš„ç»„ä»¶ç»„æˆï¼Œä¸‹é¢ç®€å•ä»‹ç»ä¸‹æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªï¼š\nPLEG å³ Pod Lifecycle Event Generatorï¼Œå­—é¢æ„æ€ Pod ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆContainerStartedã€ContainerDiedã€ContainerRemovedã€ContainerChangedï¼‰ç”Ÿæˆå™¨ã€‚\nå…¶ç»´æŠ¤ç€ Pod ç¼“å­˜ï¼›å®šæœŸé€šè¿‡ ContainerRuntime è·å– Pod çš„ä¿¡æ¯ï¼Œä¸ç¼“å­˜ä¸­çš„ä¿¡æ¯æ¯”è¾ƒï¼Œç”Ÿæˆå¦‚ä¸Šçš„äº‹ä»¶ï¼›å°†äº‹ä»¶å†™å…¥å…¶ç»´æŠ¤çš„é€šé“ï¼ˆchannelï¼‰ä¸­ã€‚\nPodWorkers å¤„ç†äº‹ä»¶ä¸­ Pod çš„åŒæ­¥ã€‚æ ¸å¿ƒæ–¹æ³• managePodLoop() é—´æ¥è°ƒç”¨ kubelet.syncPod() å®Œæˆ Pod çš„åŒæ­¥ï¼š\nå¦‚æœ Pod æ­£åœ¨è¢«åˆ›å»ºï¼Œè®°å½•å…¶å»¶è¿Ÿ ç”Ÿæˆ Pod çš„ API Statusï¼Œå³ v1.PodStatusï¼šä»è¿è¡Œæ—¶çš„ status è½¬æ¢æˆ api status è®°å½• Pod ä» pending åˆ° running çš„è€—æ—¶ åœ¨ StatusManager ä¸­æ›´æ–° pod çš„çŠ¶æ€ æ€æ‰ä¸åº”è¯¥è¿è¡Œçš„ Pod å¦‚æœç½‘ç»œæ’ä»¶æœªå°±ç»ªï¼Œåªå¯åŠ¨ä½¿ç”¨äº†ä¸»æœºç½‘ç»œï¼ˆhost networkï¼‰çš„ Pod å¦‚æœ static pod ä¸å­˜åœ¨ï¼Œä¸ºå…¶åˆ›å»ºé•œåƒï¼ˆMirrorï¼‰Pod ä¸º Pod åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•ï¼šPod ç›®å½•ã€å·ç›®å½•ã€æ’ä»¶ç›®å½• ä½¿ç”¨ VolumeManager ä¸º Pod æŒ‚è½½å· è·å– image pull secrets è°ƒç”¨å®¹å™¨è¿è¡Œæ—¶ï¼ˆcontainer runtimeï¼‰çš„ #SyncPod() æ–¹æ³• PodManager å­˜å‚¨ Pod çš„æœŸæœ›çŠ¶æ€ï¼Œkubelet æœåŠ¡çš„ä¸åŒæ¸ é“çš„ Pod\nStatsProvider æä¾›èŠ‚ç‚¹å’Œå®¹å™¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œæœ‰ cAdvisor å’Œ CRI ä¸¤ç§å®ç°ã€‚\nContainerRuntime é¡¾åæ€ä¹‰ï¼Œå®¹å™¨è¿è¡Œæ—¶ã€‚ä¸éµå¾ª CRI è§„èŒƒçš„é«˜çº§å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ã€‚\nDeps.PodConfig PodConfig æ˜¯ä¸€ä¸ªé…ç½®å¤šè·¯å¤ç”¨å™¨ï¼Œå®ƒå°†è®¸å¤š Pod é…ç½®æºåˆå¹¶æˆä¸€ä¸ªå•ä¸€çš„ä¸€è‡´ç»“æ„ï¼Œç„¶åæŒ‰é¡ºåºå‘ç›‘å¬å™¨ä¼ é€’å¢é‡å˜æ›´é€šçŸ¥ã€‚\né…ç½®æºæœ‰ï¼šæ–‡ä»¶ã€apiserverã€HTTP\n#syncLoop æ¥æ”¶æ¥è‡ª PodConfig çš„ Pod å˜æ›´é€šçŸ¥ã€å®šæ—¶ä»»åŠ¡ã€PLEG çš„äº‹ä»¶ï¼Œä»¥åŠ ProbeManager çš„äº‹ä»¶ï¼Œå°† Pod åŒæ­¥åˆ°æœŸæœ›çŠ¶æ€ã€‚\nPodAdmitHandlers Pod admission è¿‡ç¨‹ä¸­è°ƒç”¨çš„ä¸€ç³»åˆ—å¤„ç†å™¨ï¼Œæ¯”å¦‚ eviction handlerï¼ˆèŠ‚ç‚¹å†…å­˜æœ‰å‹åŠ›æ—¶ï¼Œä¸ä¼šé©±é€ QoS è®¾ç½®ä¸º BestEffort çš„ Podï¼‰ã€shutdown admit handlerï¼ˆå½“èŠ‚ç‚¹å…³é—­æ—¶ï¼Œä¸å¤„ç† pod çš„åŒæ­¥æ“ä½œï¼‰ç­‰ã€‚\nOOMWatcher ä»ç³»ç»Ÿæ—¥å¿—ä¸­è·å–å®¹å™¨çš„ OOM æ—¥å¿—ï¼Œå°†å…¶å°è£…æˆäº‹ä»¶å¹¶è®°å½•ã€‚\nVolumeManger VolumeManager è¿è¡Œä¸€ç»„å¼‚æ­¥å¾ªç¯ï¼Œæ ¹æ®åœ¨æ­¤èŠ‚ç‚¹ä¸Šè°ƒåº¦çš„ pod ç¡®å®šéœ€è¦é™„åŠ /æŒ‚è½½/å¸è½½/åˆ†ç¦»å“ªäº›å·å¹¶æ‰§è¡Œæ“ä½œã€‚\nCertificateManager å¤„ç†è¯ä¹¦è½®æ¢ã€‚\nProbeManager å®é™…ä¸ŠåŒ…å«äº†ä¸‰ç§ Probeï¼Œæä¾› probe ç»“æœç¼“å­˜å’Œé€šé“ã€‚\nLivenessManager ReadinessManager StartupManager EvictionManager ç›‘æ§ Node èŠ‚ç‚¹çš„èµ„æºå ç”¨æƒ…å†µï¼Œæ ¹æ®é©±é€è§„åˆ™é©±é€ Pod é‡Šæ”¾èµ„æºï¼Œç¼“è§£èŠ‚ç‚¹çš„å‹åŠ›ã€‚\nPluginManager PluginManager è¿è¡Œä¸€ç»„å¼‚æ­¥å¾ªç¯ï¼Œæ ¹æ®æ­¤èŠ‚ç‚¹ç¡®å®šå“ªäº›æ’ä»¶éœ€è¦æ³¨å†Œ/å–æ¶ˆæ³¨å†Œå¹¶æ‰§è¡Œã€‚å¦‚ CSI é©±åŠ¨å’Œè®¾å¤‡ç®¡ç†å™¨æ’ä»¶ï¼ˆDevice Pluginï¼‰ã€‚\nCSI Container Storage Interfaceï¼Œç”±å­˜å‚¨å‚å•†å®ç°çš„å­˜å‚¨é©±åŠ¨ã€‚\nè®¾å¤‡ç®¡ç†å™¨æ’ä»¶ï¼ˆDevice Pluginï¼‰ Kubernetes æä¾›äº†ä¸€ä¸ª è®¾å¤‡æ’ä»¶æ¡†æ¶ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥å°†ç³»ç»Ÿç¡¬ä»¶èµ„æºå‘å¸ƒåˆ° Kubeletã€‚\nä¾›åº”å•†å¯ä»¥å®ç°è®¾å¤‡æ’ä»¶ï¼Œç”±ä½ æ‰‹åŠ¨éƒ¨ç½²æˆ–ä½œä¸º DaemonSet æ¥éƒ¨ç½²ï¼Œè€Œä¸å¿…å®šåˆ¶ Kubernetes æœ¬èº«çš„ä»£ç ã€‚ç›®æ ‡è®¾å¤‡åŒ…æ‹¬ GPUã€é«˜æ€§èƒ½ NICã€FPGAã€ InfiniBand é€‚é…å™¨ä»¥åŠå…¶ä»–ç±»ä¼¼çš„ã€å¯èƒ½éœ€è¦ç‰¹å®šäºä¾›åº”å•†çš„åˆå§‹åŒ–å’Œè®¾ç½®çš„è®¡ç®—èµ„æºã€‚\nkubelet çš„å¯åŠ¨æµç¨‹ è¦åˆ†æ kubelet çš„å¯åŠ¨æµç¨‹ï¼Œå¯ä»¥ä» kubelet è¿è¡Œæ–¹å¼ç€æ‰‹ã€‚æ‰¾ä¸€ä¸ª Node èŠ‚ç‚¹ï¼Œå¾ˆå®¹æ˜“å°±èƒ½æ‰¾åˆ° kubelet çš„è¿›ç¨‹ã€‚ç”±äºå…¶æ˜¯ä»¥ systemd çš„æ–¹å¼å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ systemctl æŸ¥çœ‹å…¶çŠ¶æ€ã€‚\nkubelet å¯åŠ¨å‘½ä»¤ kubelet çš„å¯åŠ¨å‘½ä»¤ï¼ˆminikube ç¯å¢ƒï¼‰\n$ ps -aux | grep \u0026#39;/kubelet\u0026#39; | grep -v grep root 4917 2.6 0.3 1857652 106152 ? Ssl 01:34 13:05 /var/lib/minikube/binaries/v1.21.0/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --config=/var/lib/kubelet/config.yaml --container-runtime=docker --hostname-override=1.21.0 --kubeconfig=/etc/kubernetes/kubelet.conf --node-ip=192.168.64.5 æˆ–è€…\n$ systemctl status kubelet.service â— kubelet.service - kubelet: The Kubernetes Node Agent Loaded: loaded (/usr/lib/systemd/system/kubelet.service; disabled; vendor preset: enabled) Drop-In: /etc/systemd/system/kubelet.service.d â””â”€10-kubeadm.conf Active: active (running) since Sun 2021-06-13 01:34:42 UTC; 11h ago Docs: http://kubernetes.io/docs/ Main PID: 4917 (kubelet) Tasks: 15 (limit: 38314) Memory: 39.4M CGroup: /system.slice/kubelet.service â””â”€4917 /var/lib/minikube/binaries/v1.21.0/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --config=/var/lib/kubelet/config.yaml --container-runtime=docker --hostname-override=1.21.0 --kubeconfig=/etc/kubernetes/kubelet.conf --node-ip=192.168.64 æºç åˆ†æ ä» git@github.com:kubernetes/kubernetes.git ä»“åº“è·å–ä»£ç ï¼Œä½¿ç”¨æœ€æ–°çš„ release-1.21 åˆ†æ”¯ã€‚\ncmd/kubelet/kubelet.go:35 çš„ main æ–¹æ³•ä¸ºç¨‹åºå…¥å£ã€‚ è°ƒç”¨ NewKubeletCommand æ–¹æ³•ï¼Œåˆ›å»º command æ‰§è¡Œ command cmd/kubelet/app/server.go:434 çš„ Run æ–¹æ³•ã€‚ è°ƒç”¨ RunKubelet æ–¹æ³•ã€‚ è°ƒç”¨ createAndInitKubelet æ–¹æ³•ï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ– kubelet pkg/kubelet/kubelet.go çš„ NewMainKubelet æ–¹æ³•ï¼Œåˆ›å»º kubeletçš„ å„ç§ç»„ä»¶ã€‚å…±åå‡ ä¸ªç»„ä»¶ï¼Œè§ kubelet çš„æ„æ¶ã€‚ è°ƒç”¨ BirtyCry æ–¹æ³•ï¼šæ”¾å‡º Starting äº‹ä»¶ è°ƒç”¨ StartGarbageCollection æ–¹æ³•ï¼Œå¼€å¯ ContainerGC å’Œ ImageGC è°ƒç”¨ startKubelet æ–¹æ³•ï¼ˆå¤§é‡ä½¿ç”¨ goroutine å’Œé€šé“ï¼‰ goroutineï¼škubelet.Run() åˆå§‹åŒ–æ¨¡å— metrics ç›¸å…³ åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•ç›®å½• åˆ›å»ºå®¹å™¨æ—¥å¿—ç›®å½• å¯åŠ¨ ImageGCManager å¯åŠ¨ ServerCertificateManager å¯åŠ¨ OOMWatcher å¯åŠ¨ ResourceAnalyzer goroutineï¼šVolumeManager.Run() å¼€å§‹å¤„ç† Pod Volume çš„å¸è½½å’ŒæŒ‚è½½ goroutineï¼šçŠ¶æ€æ›´æ–° fastStatusUpdateOnce() ï¼ˆæ›´æ–° Pod CIDR -\u0026gt; æ›´æ–° ContainerRuntime çŠ¶æ€ -\u0026gt; æ›´æ–° Node èŠ‚ç‚¹çŠ¶æ€ï¼‰ goroutineï¼š NodeLeaseController.Run() æ›´æ–°èŠ‚ç‚¹ç§Ÿçº¦ goroutineï¼špodKiller.PerformPodKillingWork æ€æ‰æœªè¢«æ­£ç¡®å¤„ç†çš„ pod StatusManager.Start() å¼€å§‹å‘ apiserver æ›´æ–° Pod çŠ¶æ€ RuntimeClassManager.Start() PLEG.Start()ï¼šæŒç»­ä» ContainerRuntime è·å– Pod/å®¹å™¨çš„çŠ¶æ€ï¼Œå¹¶ä¸ kubelet æœ¬åœ° cache ä¸­çš„æ¯”è¾ƒï¼Œç”Ÿæˆå¯¹åº”çš„ Event syncLoop() é‡ç‚¹ï¼ŒæŒç»­ç›‘æ§å¹¶å¤„ç†æ¥è‡ªæ–‡ä»¶ã€apiserverã€http çš„å˜æ›´ã€‚åŒ…æ‹¬ Pod çš„å¢åŠ ã€æ›´æ–°ã€ä¼˜é›…åˆ é™¤ã€éä¼˜é›…åˆ é™¤ã€è°ƒå’Œã€‚ å¯åŠ¨ serverï¼Œæš´éœ² /healthz ç«¯ç‚¹ é€šçŸ¥ systemd kuberlet æœåŠ¡å·²ç»å¯åŠ¨ kubelet çš„å·¥ä½œåŸç† æ¥é™æ€æ–‡ä»¶ã€apiserver ä»¥åŠ HTTP è¯·æ±‚çš„ Pod é…ç½®å˜æ›´ï¼Œè¢«å‘é€åˆ° kubelet.syncLoop PLEG ä¼šå®šæœŸé€šè¿‡å®¹å™¨è¿è¡Œæ—¶è·å–èŠ‚ç‚¹ä¸Š Pod çš„çŠ¶æ€ï¼Œä¸å…¶ç¼“å­˜ä¸­çš„ Pod ä¿¡æ¯è¿›è¡Œæ¯”è¾ƒï¼Œå°è£…æˆäº‹ä»¶ï¼Œè¿›å…¥ PLEG çš„é€šé“ å®šæœŸæ£€æŸ¥å·¥ä½œé˜Ÿåˆ—ä¸­çš„ Pod ProbeManager çš„é€šé“ä¸­çš„ Pod ä»¥ä¸Š 1~4ï¼Œéƒ½ä¼šè¿›å…¥ syncLoopIterationï¼Œå¹¶ä»å¯¹åº”çš„é€šé“ä¸­è·å–åˆ°å¯¹åº” Podï¼Œå°† Pod çš„ä¿¡æ¯ä¿å­˜åˆ° PodManagerï¼›ç„¶ååˆ†å‘ç»™ PodWorkerï¼Œå®Œæˆä¸€äº›åˆ—çš„åŒæ­¥å·¥ä½œã€‚ æ€»ç»“ kubelet å¯åŠ¨æµé‡å°±è®²åˆ°è¿™é‡Œï¼Œè™½ç„¶å¤æ‚ï¼Œè¿˜æ˜¯æœ‰è¿¹å¯å¾ªã€‚åªè¦äº†è§£äº† kubelet åœ¨ Kubernetes ä¸­çš„å®šä½åŠè§’è‰²ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£å…¶å·¥ä½œæµé‡ã€‚\nåé¢ä¼šå†æ·±å…¥åˆ†æ Pod åˆ›å»ºåŠå¯åŠ¨æµç¨‹ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/kubelet-source-code-analysis/","tags":["Kubernetes","äº‘åŸç”Ÿ"],"title":"æºç è§£æï¼šä¸€æ–‡è¯»æ‡‚ Kubelet"},{"categories":["æºç åˆ†æ","ç¬”è®°"],"contents":"ç”±äºè¦ç»™å›¢é˜Ÿåšä¸€ä¸‹å…³äº Flomesh çš„åˆ†äº«ï¼Œå‡†å¤‡ä¸‹ææ–™ã€‚\nâ€œåˆ†äº«æ˜¯æœ€å¥½çš„å­¦ä¹ æ–¹æ³•ã€‚â€\nä¸Šä¸€å›åˆæ¢å¯ç¼–ç¨‹ç½‘å…³ Pipyï¼Œé¢†ç•¥äº† Pipy çš„â€œé£éªšâ€ã€‚ä» Pipy çš„ GUI äº¤äº’æ·±å…¥äº†è§£äº† Pipy çš„é…ç½®åŠ è½½æµç¨‹ã€‚\nä»Šå¤©çœ‹ä¸€ä¸‹ Pipy å¦‚ä½•å®ç° Metrics çš„åŠŸèƒ½ï¼Œé¡ºä¾¿çœ‹ä¸‹æ•°æ®å¦‚ä½•åœ¨å¤šä¸ª Pipeline ä¸­è¿›è¡Œæµè½¬ã€‚\nå‰ç½® é¦–å…ˆï¼Œéœ€è¦å¯¹ Pipy æœ‰ä¸€å®šçš„äº†è§£ï¼Œå¦‚æœä¸äº†è§£çœ‹ä¸€ä¸‹ä¸Šä¸€ç¯‡æ–‡ç« ã€‚\nå…¶æ¬¡æ„å»ºå¥½ Pipy ç¯å¢ƒï¼Œå…³äºæ„å»ºè¿˜æ˜¯å»çœ‹ä¸Šä¸€ç¯‡æ–‡ç« ã€‚\nMetrics åŠŸèƒ½å®ç° è‡³äº Pipy å®ç° Metrics çš„æ–¹å¼ï¼Œæºç ä¸­å°±æœ‰ï¼Œä½äº test/006-metrics/pipy.jsã€‚\nä»£ç†ç›‘å¬ 6080 ç«¯å£ï¼Œåç«¯æœåŠ¡åœ¨ 8080 ç«¯å£ï¼ŒMetrics åœ¨ 9090 ç«¯å£ å…±æœ‰ 5 ä¸ª Pipelineï¼š3 ä¸ª listen ç±»å‹ï¼Œ2 ä¸ª Pipeline ç±»å‹ 7 ç§è¿‡æ»¤å™¨ï¼šforkã€connectã€decodeHttpRequestã€onMessageStartã€decodeHttpResponseã€encodeHttpRespnseã€replaceMessage è´´ä¸€ä¸‹æºç ï¼š\npipy({ _metrics: { count: 0, }, _statuses: {}, _latencies: [ 1,2,5,7,10,15,20,25,30,40,50,60,70,80,90,100, 200,300,400,500,1000,2000,5000,10000,30000,60000, Number.POSITIVE_INFINITY ], _buckets: [], _timestamp: 0, }) .listen(6080) .fork(\u0026#39;in\u0026#39;) .connect(\u0026#39;127.0.0.1:8080\u0026#39;) .fork(\u0026#39;out\u0026#39;) // Extract request info .pipeline(\u0026#39;in\u0026#39;) .decodeHttpRequest() .onMessageStart( () =\u0026gt; ( _timestamp = Date.now(), _metrics.count++ ) ) // Extract response info .pipeline(\u0026#39;out\u0026#39;) .decodeHttpResponse() .onMessageStart( e =\u0026gt; ( ((status, latency, i) =\u0026gt; ( status = e.head.status, latency = Date.now() - _timestamp, i = _latencies.findIndex(t =\u0026gt; latency \u0026lt;= t), _buckets[i]++, _statuses[status] = (_statuses[status]|0) + 1 ))() ) ) // Expose as Prometheus metrics .listen(9090) .decodeHttpRequest() .replaceMessage( () =\u0026gt; ( (sum =\u0026gt; new Message( [ `count ${_metrics.count}`, ...Object.entries(_statuses).map( ([k, v]) =\u0026gt; `status{code=\u0026#34;${k}\u0026#34;} ${v}` ), ..._buckets.map((n, i) =\u0026gt; `bucket{le=\u0026#34;${_latencies[i]}\u0026#34;} ${sum += n}`) ] .join(\u0026#39;\\n\u0026#39;) ))(0) ) ) .encodeHttpResponse() // Mock service on port 8080 .listen(8080) .decodeHttpRequest() .replaceMessage( new Message(\u0026#39;Hello!\\n\u0026#39;) ) .encodeHttpResponse() æµ‹è¯• ä½¿ç”¨ ab åšè¯·æ±‚æ¨¡æ‹Ÿ ab -n 2000 -c 10 http://localhost:6080/ï¼Œç„¶åæ£€æŸ¥ä¸‹è®°å½•çš„æŒ‡æ ‡ã€‚\n$ http :9090 --body count 2000 status{code=\u0026#34;200\u0026#34;} 2000 bucket{le=\u0026#34;1\u0026#34;} 1762 bucket{le=\u0026#34;2\u0026#34;} 1989 bucket{le=\u0026#34;5\u0026#34;} 1994 bucket{le=\u0026#34;7\u0026#34;} 1999 bucket{le=\u0026#34;10\u0026#34;} 2000 åˆ†æ TL;DRï¼šæœ¬æ¬¡ç¤ºä¾‹çš„æ ¸å¿ƒæ˜¯ forkï¼Œä»å­—é¢æ„æ€å°±å¾ˆå®¹æ˜“ç†è§£ï¼šæ–°å¼€ä¸€ä¸ªå¤„ç†åˆ†æ”¯ï¼ˆPipelineï¼‰ï¼Œä¸ä¸»çº¿å¹¶è¡Œæ‰§è¡Œã€‚\nåœ¨ src/inbound.cpp:104 109 å¤„ï¼ŒPipy æ¥æ”¶ä¸€ä¸ªæ–°çš„è¿æ¥ã€‚ åˆ›å»º Context å’Œ Sessionï¼Œå¹¶åœ¨ L178 å¤„æ³¨å†Œäº‹ä»¶çš„å¤„ç†å™¨ï¼Œç„¶ååœ¨ L187 å¤„å¼€å§‹æ¥æ”¶æ•°æ®ã€‚ åœ¨ #receive æ–¹æ³•ä¸­ï¼Œå®šä¹‰äº†æ•°æ®æ¥æ”¶å¤„ç†å™¨ï¼šå°†è¯»åˆ°çš„æ•°æ®å†™å…¥ buffer ä¸­ã€‚è¿™ä¸ª buffer å­˜å‚¨çš„æ˜¯ Eventç±»å‹æ•°æ®ã€‚ï¼ˆæ‰€ä»¥è¯´ Pipy æ˜¯åŸºäºæ•°æ®æµäº‹ä»¶ï¼Œå°†ä¸€äº›å°è£…æˆäº†äº‹ä»¶ï¼‰\næ¥ç€è°ƒç”¨ Session#inputã€‚\nå®é™…ä¸Šè°ƒç”¨çš„æ˜¯ ReusableSession#inputï¼Œè°ƒç”¨ m_filters çš„ #process æ–¹æ³•ã€‚m_filters å®é™…ä¸Šæ˜¯ Filter ç±»å‹ã€‚\nä¸ºä»€ä¹ˆåªæœ‰ä¸€ä¸ª Filterï¼Ÿé‡ç‚¹æ¥äº†ï¼Œçœ‹ä¸‹ ReusableSession çš„æ„é€ è¿‡ç¨‹å°±èƒ½æ˜ç™½äº†ï¼ˆè¿™é‡Œç”¨äº†ä¸ªåå‘è¿­ä»£å™¨ï¼‰ã€‚output æ˜¯å½“å‰ Filter å¤„ç†å®Œè¦æ‰§è¡Œçš„ï¼Œå®ç°ç±»ä¼¼é“¾å¼çš„æ‰§è¡Œã€‚\nå†å›å¤´çœ‹ä¸Šé¢çš„ç¤ºä¾‹ï¼Œå¯ä»¥æƒ³è±¡ fork å°±æ˜¯ Session çš„ m_filtersã€‚\nsrc/filters/fork.cpp:85ï¼Œåœ¨ fork è¿‡æ»¤å™¨ä¸­ï¼Œåœ¨ 1 å¤„ä» module ä¸­è·å–åˆ°ç›®æ ‡ Pipelineï¼Œå¹¶åœ¨ 3 å’Œ 4 å¤„ åˆ›å»ºäº†æ–°çš„ Session å¹¶ä¿å­˜åŸ Session çš„æ•°æ®ã€‚\nç„¶ååœ¨ 5 å¤„å°†åŸ Event è¾“å…¥åˆ°æ–°çš„ Session ä¸­ï¼Œè§¦å‘ç›®æ ‡ Pipeline çš„ Filter é“¾ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ˜¯åŸºäºäº‹ä»¶çš„å¤„ç†ï¼Œå¹¶ä¸æ˜¯é˜»å¡çš„ã€‚è¿™å°±æ„å‘³ç€ï¼Œfork çš„ç›®æ ‡ piplineï¼Œä¸ fork æ‰€åœ¨çš„ pipeline æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚ åœ¨ç¤ºä¾‹ä¸­ï¼Œå°±æ˜¯ Pipeline â€˜inâ€™ ä¸ ä¸» Pipeline çš„ connect æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚\næœ€ç»ˆåœ¨ 6 å¤„ï¼Œç»§ç»­ä½¿ç”¨åŸ Session çš„ Filter é“¾ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/programming-archive-metrics-with-pipy/","tags":["Pipy"],"title":"å¯ç¼–ç¨‹ç½‘å…³ Pipy ç¬¬äºŒå¼¹ï¼šç¼–ç¨‹å®ç° Metrics åŠæºç è§£è¯»"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬æ–‡ç¿»è¯‘è‡ª learnk8s çš„ Architecting Kubernetes clusters â€” choosing the best autoscaling strategyï¼Œæœ‰å¢åˆ éƒ¨åˆ†å†…å®¹ã€‚\nTL;DR: åœ¨é»˜è®¤è®¾ç½®ä¸‹ï¼Œæ‰©å±• Kubernetes é›†ç¾¤ä¸­çš„ pod å’ŒèŠ‚ç‚¹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚äº†è§£å¦‚ä½•è°ƒæ•´é›†ç¾¤èŠ‚ç‚¹çš„å¤§å°ã€é…ç½®æ°´å¹³å’Œé›†ç¾¤è‡ªåŠ¨ç¼©æ”¾å™¨ä»¥åŠè¿‡åº¦é…ç½®é›†ç¾¤ä»¥åŠ å¿«æ‰©å±•é€Ÿåº¦ã€‚\nè‡ªåŠ¨æ‰©å±•å™¨ åœ¨ Kubernetes ä¸­ï¼Œå¸¸è¯´çš„â€œè‡ªç”¨æ‰©å±•â€æœ‰ï¼š\nHPAï¼šPod æ°´å¹³ç¼©æ”¾å™¨ VPAï¼šPod å‚ç›´ç¼©æ”¾å™¨ CAï¼šé›†ç¾¤è‡ªåŠ¨ç¼©æ”¾å™¨ ä¸åŒç±»å‹çš„è‡ªåŠ¨ç¼©æ”¾å™¨ï¼Œä½¿ç”¨çš„åœºæ™¯ä¸ä¸€æ ·ã€‚\nHPA HPA å®šæœŸæ£€æŸ¥å†…å­˜å’Œ CPU ç­‰æŒ‡æ ‡ï¼Œè‡ªåŠ¨è°ƒæ•´ Deployment ä¸­çš„å‰¯æœ¬æ•°ï¼Œæ¯”å¦‚æµé‡å˜åŒ–ï¼š\nVPA æœ‰äº›æ—¶å€™æ— æ³•é€šè¿‡å¢åŠ  Pod æ•°æ¥æ‰©å®¹ï¼Œæ¯”å¦‚æ•°æ®åº“ã€‚è¿™æ—¶å€™å¯ä»¥é€šè¿‡ VPA å¢åŠ  Pod çš„å¤§å°ï¼Œæ¯”å¦‚è°ƒæ•´ Pod çš„ CPU å’Œå†…å­˜ï¼š\nCA å½“é›†ç¾¤èµ„æºä¸è¶³æ—¶ï¼ŒCA ä¼šè‡ªåŠ¨é…ç½®æ–°çš„è®¡ç®—èµ„æºå¹¶æ·»åŠ åˆ°é›†ç¾¤ä¸­ï¼š\nè‡ªåŠ¨ç¼©æ”¾ Pod å‡ºé”™æ—¶ æ¯”å¦‚ä¸€ä¸ªåº”ç”¨éœ€è¦ 1.5 GB å†…å­˜å’Œ 0.25 ä¸ª vCPUã€‚ä¸€ä¸ª 8GB å’Œ 2 ä¸ª vCPU çš„èŠ‚ç‚¹ï¼Œå¯ä»¥å®¹çº³ 4 ä¸ªè¿™æ ·çš„ Podï¼Œå®Œç¾ï¼\nåšå¦‚ä¸‹é…ç½®ï¼š\nHPAï¼šæ¯å¢åŠ  10 ä¸ªå¹¶å‘ï¼Œå¢åŠ ä¸€ä¸ªå‰¯æœ¬ã€‚å³ 40 ä¸ªå¹¶å‘çš„æ—¶å€™ï¼Œè‡ªåŠ¨æ‰©å±•åˆ° 4 ä¸ªå‰¯æœ¬ã€‚ï¼ˆè¿™é‡Œä½¿ç”¨è‡ªå®šä¹‰æŒ‡æ ‡ï¼Œæ¯”å¦‚æ¥è‡ª Ingress Controller çš„ QPSï¼‰ CAï¼šåœ¨èµ„æºä¸è¶³çš„æ—¶å€™ï¼Œå¢åŠ è®¡ç®—èŠ‚ç‚¹ã€‚ å½“å¹¶å‘è¾¾åˆ° 30 çš„æ—¶å€™ï¼Œç³»ç»Ÿæ˜¯ä¸‹é¢è¿™æ ·ã€‚å®Œç¾ï¼HPA å·¥ä½œæ­£å¸¸ï¼ŒCA æ²¡å·¥ä½œã€‚\nå½“å¢åŠ åˆ° 40 ä¸ªå¹¶å‘çš„æ—¶å€™ï¼Œç³»ç»Ÿæ˜¯ä¸‹é¢çš„æƒ…å†µï¼š\nHPA å¢åŠ äº†ä¸€ä¸ª Pod Pod æŒ‚èµ· CA å¢åŠ äº†ä¸€ä¸ªèŠ‚ç‚¹ ä¸ºä»€ä¹ˆ Pod æ²¡æœ‰éƒ¨ç½²æˆåŠŸï¼Ÿ\nèŠ‚ç‚¹ä¸Šçš„æ“ä½œç³»ç»Ÿè¿›ç¨‹å’Œ kubelet ä¹Ÿä¼šæ¶ˆè€—ä¸€éƒ¨åˆ†èµ„æºï¼Œ8G å’Œ 2 vCPU å¹¶ä¸æ˜¯å…¨éƒ½å¯ä»¥æä¾›ç»™ Pod ç”¨çš„ã€‚å¹¶ä¸”è¿˜æœ‰ä¸€ä¸ªé©±é€é˜ˆå€¼ï¼šåœ¨èŠ‚ç‚¹ç³»ç»Ÿå‰©ä½™èµ„æºè¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œä¼šé©±é€ Podï¼Œé¿å… OOM çš„å‘ç”Ÿã€‚\nå½“ç„¶ä¸Šé¢çš„è¿™äº›éƒ½æ˜¯å¯é…ç½®çš„ã€‚\né‚£ä¸ºä»€ä¹ˆåœ¨åˆ›å»ºè¯¥ Pod ä¹‹å‰ï¼ŒCA æ²¡æœ‰å¢åŠ æ–°çš„èŠ‚ç‚¹å‘¢ï¼Ÿ\nCA å¦‚ä½•å·¥ä½œï¼Ÿ CA åœ¨è§¦å‘è‡ªåŠ¨ç¼©æ”¾æ—¶ï¼Œä¸ä¼šæŸ¥çœ‹å¯ç”¨çš„å†…å­˜æˆ– CPUã€‚\nCA æ˜¯é¢å‘äº‹ä»¶å·¥ä½œçš„ï¼Œå¹¶æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦å­˜åœ¨ä¸å¯è°ƒåº¦ï¼ˆPendingï¼‰çš„ Podã€‚\nå½“è°ƒåº¦å™¨æ— æ³•æ‰¾åˆ°å¯ä»¥å®¹çº³ Pod çš„èŠ‚ç‚¹æ—¶ï¼Œè¿™ä¸ª Pod æ˜¯ä¸å¯è°ƒåº¦çš„ã€‚\næ­¤æ—¶ï¼ŒCA å¼€å§‹åˆ›å»ºæ–°èŠ‚ç‚¹ï¼šCA æ‰«æé›†ç¾¤å¹¶æ£€æŸ¥æ˜¯å¦æœ‰ä¸å¯è°ƒåº¦çš„ Podã€‚\nå½“é›†ç¾¤æœ‰å¤šç§èŠ‚ç‚¹æ± ï¼ŒCA ä¼šé€šè¿‡é€‰æ‹©ä¸‹é¢çš„ä¸€ç§ç­–ç•¥ï¼š\nrandomï¼šé»˜è®¤çš„æ‰©å±•å™¨ï¼Œéšæœºé€‰æ‹©ä¸€ç§èŠ‚ç‚¹æ±  most-podsï¼šèƒ½å¤Ÿè°ƒåº¦æœ€å¤š Pod çš„èŠ‚ç‚¹æ±  least-wasteï¼šé€‰æ‹©æ‰©å±•åï¼Œèµ„æºç©ºé—²æœ€å°‘çš„èŠ‚ç‚¹æ±  priceï¼šé€‰æ‹©æˆæœ¬æœ€ä½çš„èŠ‚ç‚¹æ±  priorityï¼šé€‰æ‹©ç”¨æˆ·åˆ†é…çš„å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§çš„èŠ‚ç‚¹æ±  ç¡®å®šç±»å‹åï¼ŒCA ä¼šè°ƒç”¨ç›¸å…³ API æ¥åˆ›å»ºèµ„æºã€‚ï¼ˆäº‘å‚å•†ä¼šå®ç° APIï¼Œæ¯”å¦‚ AWS æ·»åŠ  EC2ï¼›Azure æ·»åŠ  Virtual Machineï¼›é˜¿é‡Œäº‘å¢åŠ  ECSï¼›GCP å¢åŠ  Compute Engineï¼‰\nè®¡ç®—èµ„æºå°±ç»ªåï¼Œå°±ä¼šè¿›è¡ŒèŠ‚ç‚¹çš„åˆå§‹åŒ–ã€‚\næ³¨æ„ï¼Œè¿™é‡Œéœ€è¦ä¸€å®šçš„è€—æ—¶ï¼Œé€šå¸¸æ¯”è¾ƒæ…¢ã€‚\næ¢ç´¢ Pod è‡ªåŠ¨ç¼©æ”¾çš„å‰ç½®æ—¶é—´ å››ä¸ªå› ç´ ï¼š\nHPA çš„å“åº”è€—æ—¶ CA çš„å“åº”è€—æ—¶ èŠ‚ç‚¹çš„åˆå§‹åŒ–è€—æ—¶ Pod çš„åˆ›å»ºæ—¶é—´ é»˜è®¤æƒ…å†µä¸‹ï¼Œkubelet æ¯ 10 ç§’æŠ“å–ä¸€æ¬¡ Pod çš„ CPU å’Œå†…å­˜å ç”¨æƒ…å†µã€‚\næ¯åˆ†é’Ÿï¼ŒMetrics Server ä¼šå°†èšåˆçš„æŒ‡æ ‡å¼€æ”¾ç»™ Kubernetes API çš„å…¶ä»–ç»„ä»¶ä½¿ç”¨ã€‚\nCA æ¯ 10 ç§’æ’æŸ¥ä¸å¯è°ƒåº¦çš„ Podã€‚\nå°‘äº 100 ä¸ªèŠ‚ç‚¹ï¼Œä¸”æ¯ä¸ªèŠ‚ç‚¹æœ€å¤š 30 ä¸ª Podï¼Œæ—¶é—´ä¸è¶…è¿‡ 30sã€‚å¹³å‡å»¶è¿Ÿå¤§çº¦ 5sã€‚ 100 åˆ° 1000ä¸ªèŠ‚ç‚¹ï¼Œä¸è¶…è¿‡ 60sã€‚å¹³å‡å»¶è¿Ÿå¤§çº¦ 15sã€‚ èŠ‚ç‚¹çš„é…ç½®æ—¶é—´ï¼Œå–å†³äºäº‘æœåŠ¡å•†ã€‚é€šå¸¸åœ¨ 3~5 åˆ†é’Ÿã€‚\nå®¹å™¨è¿è¡Œæ—¶åˆ›å»º Podï¼šå¯åŠ¨å®¹å™¨çš„å‡ æ¯«ç§’å’Œä¸‹è½½é•œåƒçš„å‡ ç§’é’Ÿã€‚å¦‚æœä¸åšé•œåƒç¼“å­˜ï¼Œå‡ ç§’åˆ° 1 åˆ†é’Ÿä¸ç­‰ï¼Œå–å†³äºå±‚çš„å¤§å°å’Œæ¢³ç†ã€‚\nå¯¹äºå°è§„æ¨¡çš„é›†ç¾¤ï¼Œæœ€åçš„æƒ…å†µæ˜¯ 6 åˆ† 30 ç§’ã€‚å¯¹äº 100 ä¸ªä»¥ä¸ŠèŠ‚ç‚¹è§„æ¨¡çš„é›†ç¾¤ï¼Œå¯èƒ½é«˜è¾¾ 7 åˆ†é’Ÿã€‚\nHPA delay: 1m30s + CA delay: 0m30s + Cloud provider: 4m + Container runtime: 0m30s + ========================= Total 6m30s çªå‘æƒ…å†µï¼Œæ¯”å¦‚æµé‡æ¿€å¢ï¼Œä½ æ˜¯å¦æ„¿æ„ç­‰è¿™ 7 åˆ†é’Ÿï¼Ÿ\nè¿™ 7 åˆ†é’Ÿï¼Œå¦‚ä½•ä¼˜åŒ–å‹ç¼©ï¼Ÿ\nHPA çš„åˆ·æ–°æ—¶é—´ï¼Œé»˜è®¤ 15 ç§’ï¼Œé€šè¿‡ --horizontal-pod-autoscaler-sync-period æ ‡å¿—æ§åˆ¶ã€‚ Metrics Server çš„æŒ‡æ ‡æŠ“å–æ—¶é—´ï¼Œé»˜è®¤ 60 ç§’ï¼Œé€šè¿‡ metric-resolution æ§åˆ¶ã€‚ CA çš„æ‰«æé—´éš”ï¼Œé»˜è®¤ 10 ç§’ï¼Œé€šè¿‡ scan-interval æ§åˆ¶ã€‚ èŠ‚ç‚¹ä¸Šç¼“å­˜é•œåƒï¼Œæ¯”å¦‚ kube-fledged ç­‰å·¥å…·ã€‚ å³ä½¿è°ƒå°äº†ä¸Šè¿°è®¾ç½®ï¼Œä¾ç„¶ä¼šå—äº‘æœåŠ¡å•†çš„æ—¶é—´é™åˆ¶ã€‚\né‚£ä¹ˆï¼Œå¦‚ä½•è§£å†³ï¼Ÿ\nä¸¤ç§å°è¯•ï¼š\nå°½é‡é¿å…è¢«åŠ¨åˆ›å»ºæ–°èŠ‚ç‚¹ ä¸»åŠ¨åˆ›å»ºæ–°èŠ‚ç‚¹ ä¸º Kubernetes é€‰æ‹©æœ€ä½³è§„æ ¼çš„èŠ‚ç‚¹ è¿™ä¼šå¯¹æ‰©å±•ç­–ç•¥äº§ç”Ÿå·¨å¤§å½±å“ã€‚\nè¿™æ ·çš„åœºæ™¯\nåº”ç”¨ç¨‹åºéœ€è¦ 1GB å†…å­˜å’Œ 0.1 vCPUï¼›æœ‰ä¸€ä¸ª 4GB å†…å­˜å’Œ 1 ä¸ª vCPU çš„èŠ‚ç‚¹ã€‚\næ’é™¤æ“ä½œç³»ç»Ÿã€kubelet å’Œé˜ˆå€¼ä¿ç•™ç©ºé—´åï¼Œæœ‰ 2.5GB å†…å­˜å’Œ 0.7 ä¸ª vCPU å¯ç”¨ã€‚\næœ€å¤šåªèƒ½å®¹çº³ 2 ä¸ª Podï¼Œæ‰©å±•å‰¯æœ¬æ—¶æœ€é•¿è€—æ—¶ 7 åˆ†é’Ÿï¼ˆHPAã€CAã€äº‘æœåŠ¡å•†çš„èµ„æºé…ç½®è€—æ—¶ï¼‰\nå‡å¦‚èŠ‚ç‚¹çš„è§„æ ¼æ˜¯ 64GB å†…å­˜å’Œ 16 ä¸ª vCPUï¼Œå¯ç”¨çš„èµ„æºä¸º 58.32GB å’Œ 15.8 ä¸ª vCPUã€‚\nè¿™ä¸ªèŠ‚ç‚¹å¯ä»¥æ‰˜ç®¡ 58 ä¸ª Podã€‚åªæœ‰æ‰©å®¹ç¬¬ 59 ä¸ªå‰¯æœ¬æ—¶ï¼Œæ‰éœ€è¦åˆ›å»ºæ–°çš„èŠ‚ç‚¹ã€‚\nè¿™æ ·è§¦å‘ CA çš„æœºä¼šæ›´å°‘ã€‚\né€‰æ‹©å¤§è§„æ ¼çš„èŠ‚ç‚¹ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªå¥½å¤„ï¼šèµ„æºçš„åˆ©ç”¨ç‡ä¼šæ›´é«˜ã€‚\nèŠ‚ç‚¹ä¸Šå¯ä»¥å®¹çº³çš„ Pod æ•°é‡ï¼Œå†³å®šäº†æ•ˆç‡çš„å³°å€¼ã€‚\nç‰©æå¿…åï¼æ›´å¤§çš„å®ä¾‹ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼š\nçˆ†ç‚¸åŠå¾„ï¼ˆBlast radiusï¼‰ï¼šèŠ‚ç‚¹æ•…éšœæ—¶ï¼Œå°‘èŠ‚ç‚¹çš„é›†ç¾¤å’Œå¤šèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œå‰è€…å½±å“æ›´å¤§ã€‚ è‡ªåŠ¨ç¼©æ”¾çš„æˆæœ¬æ•ˆç›Šä½ï¼šå¢åŠ ä¸€ä¸ªå¤§å®¹é‡çš„èŠ‚ç‚¹ï¼Œå…¶åˆ©ç”¨ç‡ä¼šæ¯”è¾ƒä½ï¼ˆè°ƒåº¦è¿‡å»çš„ Pod æ•°å°‘ï¼‰ å³ä½¿é€‰æ‹©äº†æ­£ç¡®è§„æ ¼çš„èŠ‚ç‚¹ï¼Œé…ç½®æ–°çš„è®¡ç®—å•å…ƒæ—¶ï¼Œå»¶è¿Ÿä»ç„¶å­˜åœ¨ã€‚æ€ä¹ˆè§£å†³ï¼Ÿ\nèƒ½å¦æå‰åˆ›å»ºèŠ‚ç‚¹ï¼Ÿ\nä¸ºé›†ç¾¤è¿‡åº¦é…ç½®èŠ‚ç‚¹ å³ä¸ºé›†ç¾¤å¢åŠ å¤‡ç”¨èŠ‚ç‚¹ï¼Œå¯ä»¥ï¼š\nåˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ç•™ç©º ï¼ˆæ¯”å¦‚ SchedulingDisabledï¼‰ ä¸€æ—¦ç©ºèŠ‚ç‚¹ä¸­æœ‰äº†ä¸€ä¸ª Podï¼Œé©¬ä¸Šåˆ›å»ºæ–°çš„ç©ºèŠ‚ç‚¹ è¿™ç§ä¼šäº§ç”Ÿé¢å¤–çš„æˆæœ¬ï¼Œä½†æ˜¯æ•ˆç‡ä¼šæå‡ã€‚\nCA å¹¶ä¸æ”¯æŒæ­¤åŠŸèƒ½ \u0026ndash; æ€»æ˜¯ä¿ç•™ä¸€ä¸ªç©ºèŠ‚ç‚¹ã€‚\nä½†æ˜¯ï¼Œå¯ä»¥ä¼ªé€ ã€‚åˆ›å»ºä¸€ä¸ªåªå ç”¨èµ„æºï¼Œä¸ä½¿ç”¨èµ„æºçš„ Pod å ç”¨æ•´ä¸ª Node èŠ‚ç‚¹ã€‚\nä¸€æ—¦æœ‰äº†çœŸæ­£çš„ Podï¼Œé©±é€å ä½çš„ Podã€‚ å¾…åå°å®Œæˆæ–°çš„èŠ‚ç‚¹é…ç½®åï¼Œå°†â€œå ä½â€ Pod å†æ¬¡å ç”¨æ•´ä¸ªèŠ‚ç‚¹ã€‚\nè¿™ä¸ªâ€œå ä½â€çš„ Pod å¯ä»¥é€šè¿‡æ°¸ä¹…ä¼‘çœ æ¥å®ç°ç©ºé—´çš„ä¿ç•™ã€‚\napiVersion: apps/v1 kind: Deployment metadata: name: overprovisioning spec: replicas: 1 selector: matchLabels: run: overprovisioning template: metadata: labels: run: overprovisioning spec: containers: - name: pause image: k8s.gcr.io/pause resources: requests: cpu: \u0026#39;1739m\u0026#39; memory: \u0026#39;5.9G\u0026#39; ä½¿ç”¨ä¼˜å…ˆçº§å’ŒæŠ¢å ï¼Œæ¥å®ç°åˆ›å»ºçœŸæ­£çš„ Pod åé©±é€â€œå ä½â€çš„ Podã€‚\nä½¿ç”¨ PodPriorityClass åœ¨é…ç½® Pod ä¼˜å…ˆçº§ï¼š\napiVersion: scheduling.k8s.io/v1beta1 kind: PriorityClass metadata: name: overprovisioning value: -1 #é»˜è®¤çš„æ˜¯ 0ï¼Œè¿™ä¸ªè¡¨ç¤ºæ¯”é»˜è®¤çš„ä½ globalDefault: false description: \u0026#39;Priority class used by overprovisioning.\u0026#39; ä¸ºâ€œå ä½â€ Pod é…ç½®ä¼˜å…ˆçº§ï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: overprovisioning spec: replicas: 1 selector: matchLabels: run: overprovisioning template: metadata: labels: run: overprovisioning spec: priorityClassName: overprovisioning #HERE containers: - name: reserve-resources image: k8s.gcr.io/pause resources: requests: cpu: \u0026#39;1739m\u0026#39; memory: \u0026#39;5.9G\u0026#39; å·²ç»åšå®Œè¿‡åº¦é…ç½®ï¼Œåº”ç”¨ç¨‹åºæ˜¯å¦éœ€è¦ä¼˜åŒ–ï¼Ÿ\nä¸º Pod é€‰æ‹©æ­£ç¡®çš„å†…å­˜å’Œ CPU è¯·æ±‚ Kubernetes æ˜¯æ ¹æ® Pod çš„å†…å­˜å’Œ CPU è¯·æ±‚ï¼Œä¸ºå…¶åˆ†é…èŠ‚ç‚¹ã€‚\nå¦‚æœ Pod çš„èµ„æºè¯·æ±‚é…ç½®ä¸æ­£ç¡®ï¼Œå¯èƒ½ä¼šè¿‡æ™šï¼ˆæˆ–è¿‡æ—©ï¼‰è§¦å‘è‡ªåŠ¨ç¼©æ”¾å™¨ã€‚\nè¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š\nåº”ç”¨ç¨‹åºå¹³å‡è´Ÿè½½ä¸‹æ¶ˆè€— 512MB å†…å­˜å’Œ 0.25 ä¸ª vCPUã€‚ é«˜å³°æ—¶ï¼Œæ¶ˆè€— 4GB å†…å­˜ å’Œ 1 ä¸ª vCPUã€‚ï¼ˆå³èµ„æºé™åˆ¶ï¼ŒLimitï¼‰ æœ‰ä¸‰ç§è¯·æ±‚çš„é…ç½®é€‰æ‹©ï¼š\nè¿œä½äºå¹³å‡ä½¿ç”¨é‡ åŒ¹é…å¹³å‡ä½¿ç”¨é‡ å°½é‡æ¥è¿‘é™åˆ¶ ç¬¬ä¸€ç§çš„é—®é¢˜åœ¨äºè¶…å–ä¸¥é‡ï¼Œè¿‡åº¦ä½¿ç”¨èŠ‚ç‚¹ã€‚kubelet è´Ÿè½½é«˜ï¼Œç¨³å®šæ€§å·®ã€‚\nç¬¬ä¸‰ç§ï¼Œä¼šé€ æˆèµ„æºçš„åˆ©ç”¨ç‡ä½ï¼Œæµªè´¹èµ„æºã€‚è¿™ç§é€šå¸¸è¢«ç§°ä¸º QoSï¼šQuality of Service class ä¸­çš„ Guaranteed çº§åˆ«ï¼ŒPod ä¸ä¼šè¢«ç»ˆæ­¢å’Œé©±é€ã€‚ å¦‚ä½•åœ¨ç¨³å®šæ€§å’Œèµ„æºä½¿ç”¨ç‡é—´åšæƒè¡¡ï¼Ÿ\nè¿™å°±æ˜¯ QoSï¼šQuality of Service class ä¸­çš„ Burstable çº§åˆ«ï¼Œå³ Pod å¶å°”ä¼šä½¿ç”¨æ›´å¤šçš„å†…å­˜å’Œ CPUã€‚\nå¦‚æœèŠ‚ç‚¹ä¸­æœ‰å¯ç”¨èµ„æºï¼Œåº”ç”¨ç¨‹åºä¼šåœ¨è¿”å›åŸºçº¿ï¼ˆbaselineï¼‰å‰ä½¿ç”¨è¿™äº›èµ„æºã€‚ å¦‚æœèµ„æºä¸è¶³ï¼ŒPod å°†ç«äº‰èµ„æºï¼ˆCPUï¼‰ï¼Œkubelet ä¹Ÿæœ‰å¯èƒ½å°è¯•é©±é€ Podï¼ˆå†…å­˜ï¼‰ã€‚ åœ¨ Guaranteed å’Œ Burstable ä¹‹å‰å¦‚ä½•åšé€‰æ‹©ï¼Ÿå–å†³äºï¼š\næƒ³å°½é‡å‡å°‘ Pod çš„é‡æ–°è°ƒåº¦å’Œé©±é€ï¼Œåº”è¯¥æ˜¯ç”¨ Guaranteedã€‚ å¦‚æœæƒ³å……åˆ†åˆ©ç”¨èµ„æºæ—¶ï¼Œä½¿ç”¨ Burstableã€‚æ¯”å¦‚å¼¹æ€§è¾ƒå¤§çš„æœåŠ¡ï¼ŒWeb æˆ–è€… REST æœåŠ¡ã€‚ å¦‚ä½•åšå‡ºæ­£ç¡®çš„é…ç½®ï¼Ÿ\nåº”è¯¥åˆ†æåº”ç”¨ç¨‹åºï¼Œå¹¶æµ‹ç®—ç©ºé—²ã€è´Ÿè½½å’Œå³°å€¼æ—¶çš„å†…å­˜å’Œ CPU æ¶ˆè€—ã€‚\nç”šè‡³å¯ä»¥é€šè¿‡éƒ¨ç½² VPA æ¥è‡ªåŠ¨è°ƒæ•´ã€‚\nå¦‚ä½•è¿›è¡Œé›†ç¾¤ç¼©å®¹ï¼Ÿ æ¯ 10 ç§’ï¼Œå½“è¯·æ±‚ï¼ˆrequestï¼‰åˆ©ç”¨ç‡ä½äº 50%æ—¶ï¼ŒCA æ‰ä¼šå†³å®šåˆ é™¤èŠ‚ç‚¹ã€‚\nCA ä¼šæ±‡æ€»åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Pod çš„ CPU å’Œå†…å­˜è¯·æ±‚ã€‚å°äºèŠ‚ç‚¹å®¹é‡çš„ä¸€åŠï¼Œå°±ä¼šè€ƒè™‘å¯¹å½“å‰èŠ‚ç‚¹è¿›è¡Œç¼©å‡ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCA ä¸è€ƒè™‘å®é™…çš„ CPU å’Œå†…å­˜ä½¿ç”¨æˆ–è€…é™åˆ¶ï¼ˆlimitï¼‰ï¼Œåªçœ‹è¯·æ±‚ï¼ˆrequestï¼‰ã€‚\nç§»é™¤èŠ‚ç‚¹ä¹‹å‰ï¼ŒCA ä¼šï¼š\næ£€æŸ¥ Pod ç¡®ä¿å¯ä»¥è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚ æ£€æŸ¥èŠ‚ç‚¹ï¼Œé¿å…èŠ‚ç‚¹è¢«è¿‡æ—©çš„é”€æ¯ï¼Œæ¯”å¦‚ä¸¤ä¸ªèŠ‚ç‚¹çš„è¯·æ±‚éƒ½ä½äº 50%ã€‚ æ£€æŸ¥éƒ½é€šè¿‡ä¹‹åï¼Œæ‰ä¼šåˆ é™¤èŠ‚ç‚¹ã€‚\nä¸ºä»€ä¹ˆä¸æ ¹æ®å†…å­˜æˆ– CPU è¿›è¡Œè‡ªåŠ¨ç¼©æ”¾ï¼Ÿ åŸºäºå†…å­˜å’Œ CPU çš„è‡ªåŠ¨ç¼©æ”¾å™¨ï¼Œä¸å…³å¿ƒ podã€‚\næ¯”å¦‚é…ç½®ç¼©æ”¾å™¨åœ¨èŠ‚ç‚¹çš„ CPU è¾¾åˆ°æ€»é‡çš„ 80%ï¼Œå°±è‡ªåŠ¨å¢åŠ èŠ‚ç‚¹ã€‚\nå½“ä½ åˆ›å»º 3 ä¸ªå‰¯æœ¬çš„ Deploymentï¼Œ3 ä¸ªèŠ‚ç‚¹çš„ CPU è¾¾åˆ°äº† 85%ã€‚è¿™æ—¶ä¼šåˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½†ä½ å¹¶ä¸éœ€è¦ç¬¬ 4 ä¸ªå‰¯æœ¬ï¼Œæ–°çš„èŠ‚ç‚¹å°±ç©ºé—²äº†ã€‚\nä¸å»ºè®®ä½¿ç”¨è¿™ç§ç±»å‹çš„è‡ªåŠ¨ç¼©æ”¾å™¨ã€‚\næ€»ç»“ å®šä¹‰å’Œå®æ–½æˆåŠŸçš„æ‰©å±•ç­–ç•¥ï¼Œéœ€è¦æŒæ¡ä»¥ä¸‹å‡ ç‚¹ï¼š\nèŠ‚ç‚¹çš„å¯åˆ†é…èµ„æºã€‚ å¾®è°ƒ Metrics Serverã€HPA å’Œ CA çš„åˆ·æ–°é—´éš”ã€‚ è®¾è®¡é›†ç¾¤å’ŒèŠ‚ç‚¹çš„è§„æ ¼ã€‚ ç¼“å­˜å®¹å™¨é•œåƒåˆ°èŠ‚ç‚¹ã€‚ åº”ç”¨ç¨‹åºçš„åŸºå‡†æµ‹è¯•å’Œåˆ†æã€‚ é…åˆé€‚å½“çš„ç›‘æ§å·¥å…·ï¼Œå¯ä»¥åå¤æµ‹è¯•æ‰©å±•ç­–ç•¥å¹¶è°ƒæ•´é›†ç¾¤çš„ç¼©æ”¾é€Ÿåº¦å’Œæˆæœ¬ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/auto-scaling-best-practice-in-kubernetes/","tags":["Kubernetes","äº‘åŸç”Ÿ"],"title":"Kubernetes çš„è‡ªåŠ¨ä¼¸ç¼©ä½ ç”¨å¯¹äº†å—ï¼Ÿ"},{"categories":["äº‘åŸç”Ÿ"],"contents":"æœ‰å¹¸å‚åŠ äº† Flomesh ç»„ç»‡çš„workshopï¼Œäº†è§£äº†ä»–ä»¬çš„ Pipy ç½‘ç»œä»£ç†ï¼Œä»¥åŠå›´ç»• Pipy æ„å»ºèµ·æ¥çš„ç”Ÿæ€ã€‚Pipy åœ¨ç”Ÿæ€ä¸­ï¼Œä¸æ­¢æ˜¯ä»£ç†çš„è§’è‰²ï¼Œè¿˜æ˜¯ Flomesh æœåŠ¡ç½‘æ ¼â€‹ä¸­çš„æ•°æ®å¹³é¢ã€‚\næ•´ç†ä¸€ä¸‹ï¼Œåšä¸ªè®°å½•ï¼Œé¡ºä¾¿ç„ä¸€ä¸‹ Pipy çš„éƒ¨åˆ†æºç ã€‚\nä»‹ç» ä¸‹é¢æ˜¯æ‘˜è‡ª Github ä¸Šå…³äº Pipy çš„ä»‹ç»ï¼š\nPipy æ˜¯ä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½ã€é«˜ç¨³å®šã€å¯ç¼–ç¨‹çš„ç½‘ç»œä»£ç†ã€‚Pipy æ ¸å¿ƒæ¡†æ¶ä½¿ç”¨ C++ å¼€å‘ï¼Œç½‘ç»œ IO é‡‡ç”¨ ASIO åº“ã€‚ Pipy çš„å¯æ‰§è¡Œæ–‡ä»¶ä»…æœ‰ 5M å·¦å³ï¼Œè¿è¡ŒæœŸçš„å†…å­˜å ç”¨ 10M å·¦å³ï¼Œå› æ­¤ Pipy éå¸¸é€‚åˆåš Sidecar proxyã€‚\nPipy å†…ç½®äº†è‡ªç ”çš„ pjs ä½œä¸ºè„šæœ¬æ‰©å±•ï¼Œä½¿å¾—Pipy å¯ä»¥ç”¨ JS è„šæœ¬æ ¹æ®ç‰¹å®šéœ€æ±‚å¿«é€Ÿå®šåˆ¶é€»è¾‘ä¸åŠŸèƒ½ã€‚\nPipy é‡‡ç”¨äº†æ¨¡å—åŒ–ã€é“¾å¼çš„å¤„ç†æ¶æ„ï¼Œç”¨é¡ºåºæ‰§è¡Œçš„æ¨¡å—æ¥å¯¹ç½‘ç»œæ•°æ®å—è¿›è¡Œå¤„ç†ã€‚è¿™ç§ç®€å•çš„æ¶æ„ä½¿å¾— Pipy åº•å±‚ç®€å•å¯é ï¼ŒåŒæ—¶å…·å¤‡äº†åŠ¨æ€ç¼–æ’æµé‡çš„èƒ½åŠ›ï¼Œå…¼é¡¾äº†ç®€å•å’Œçµæ´»ã€‚é€šè¿‡ä½¿ç”¨ REUSE_PORT çš„æœºåˆ¶ï¼ˆä¸»æµ Linux å’Œ BSD ç‰ˆæœ¬éƒ½æ”¯æŒè¯¥åŠŸèƒ½ï¼‰ï¼ŒPipy å¯ä»¥ä»¥å¤šè¿›ç¨‹æ¨¡å¼è¿è¡Œï¼Œä½¿å¾— Pipy ä¸ä»…é€‚ç”¨äº Sidecar æ¨¡å¼ï¼Œä¹Ÿé€‚ç”¨äºå¤§è§„æ¨¡çš„æµé‡å¤„ç†åœºæ™¯ã€‚ åœ¨å®è·µä¸­ï¼ŒPipy ç‹¬ç«‹éƒ¨ç½²çš„æ—¶å€™ç”¨ä½œâ€œè½¯è´Ÿè½½â€ï¼Œå¯ä»¥åœ¨ä½å»¶è¿Ÿçš„æƒ…å†µä¸‹ï¼Œå®ç°åª²ç¾ç¡¬ä»¶çš„è´Ÿè½½å‡è¡¡ååèƒ½åŠ›ï¼ŒåŒæ—¶å…·æœ‰çµæ´»çš„æ‰©å±•æ€§ã€‚\nPipy çš„æ ¸å¿ƒæ˜¯æ¶ˆæ¯æµå¤„ç†å™¨ï¼š\nPipy æµé‡å¤„ç†çš„æµç¨‹ï¼š\næ ¸å¿ƒæ¦‚å¿µ æµï¼ˆStreamï¼‰ ç®¡é“ï¼ˆPipelineï¼‰ æ¨¡å—ï¼ˆModuleï¼‰ ä¼šè¯ï¼ˆSessionï¼‰ ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ ä»¥ä¸‹æ˜¯ä¸ªäººæµ…è§ï¼š\nPipy ä½¿ç”¨ pjs å¼•æ“å°† JavaScriptæ ¼å¼çš„é…ç½®ï¼Œè§£ææˆå…¶æŠ½è±¡çš„ Configuration å¯¹è±¡ã€‚æ¯ä¸ª Configuration ä¸­åŒ…å«äº†å¤šä¸ª Pipelineï¼Œæ¯ä¸ª Configuration ä¸­åˆä¼šç”¨åˆ°å¤šä¸ª Filterã€‚è¿™äº›éƒ½å±äº Pipy çš„é™æ€é…ç½®éƒ¨åˆ†ã€‚ï¼ˆåé¢ä¼šæåˆ° Pipeline çš„ä¸‰ç§ä¸åŒç±»å‹ï¼‰\nè€Œå±äºè¿è¡Œæ—¶çš„å°±æ˜¯æµã€ä¼šè¯å’Œä¸Šä¸‹æ–‡äº†ï¼Œåœ¨ Pipy ä¸­ï¼Œæ•°æ®æµæ˜¯ç”±å¯¹è±¡ï¼ˆPipy çš„æŠ½è±¡ï¼‰ç»„æˆçš„ã€‚è€Œè¿™äº›å¯¹è±¡æŠµè¾¾ Pipyï¼Œè¢«æŠ½è±¡æˆä¸åŒçš„äº‹ä»¶ã€‚è€Œäº‹ä»¶è§¦å‘ä¸åŒçš„è¿‡æ»¤å™¨çš„æ‰§è¡Œã€‚\næˆ‘ä¸ªäººæ›´å–œæ¬¢å°†å…¶æ ¸å¿ƒç†è§£ä¸ºï¼šå¯¹æ•°æ®æµçš„äº‹ä»¶å¤„ç†å¼•æ“ã€‚\nç†è§£å½’ç†è§£ï¼Œå®è·µå‡ºçœŸçŸ¥ã€‚â€œå¤§èƒ†å‡è®¾ï¼Œå°å¿ƒæ±‚è¯ï¼â€\næœ¬åœ°ç¼–è¯‘ ä»ç¼–è¯‘ Pipy å¼€å§‹ã€‚\nç¯å¢ƒå‡†å¤‡ #å®‰è£… nodejs $ nvm install lts/erbium #å®‰è£… cmake $ brew install cmake ç¼–è¯‘ Pipy ä» https://github.com/flomesh-io/pipy.git å…‹éš†ä»£ç ã€‚\nPipy çš„ç¼–è¯‘åŒ…æ‹¬äº†ä¸¤ä¸ªéƒ¨åˆ†ï¼ŒGUI å’Œ Pipy æœ¬ä½“ã€‚\nGUI æ˜¯ Pipy æä¾›çš„ä¸€ä¸ªç”¨äºå¼€å‘æ¨¡å¼ä¸‹è¿›è¡Œé…ç½®çš„ç•Œé¢ï¼Œé¦–å…ˆç¼–è¯‘Pipy GUIã€‚\n# pipy root folder $ cd gui $ npm install $ npm run build æ¥ç€ç¼–è¯‘ Pipy çš„æœ¬ä½“\n# pipy root folder $ mkdir build $ cd build $ cmake -DCMAKE_BUILD_TYPE=Release -DPIPY_GUI=ON .. $ make å®Œæˆåæ£€æŸ¥æ ¹ç›®å½•ä¸‹çš„ bin ç›®å½•ï¼Œå¯ä»¥çœ‹åˆ° pipy çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¤§å°åªæœ‰ 11Mã€‚\n$ bin/pipy --help Usage: pipy [options] \u0026lt;script filename\u0026gt; Options: -h, -help, --help Show help information -v, -version, --version Show version information --list-filters List all filters --help-filters Show detailed usage information for all filters --log-level=\u0026lt;debug|info|warn|error\u0026gt; Set the level of log output --verify Verify configuration only --reuse-port Enable kernel load balancing for all listening ports --gui-port=\u0026lt;port\u0026gt; Enable web GUI on the specified port Demoï¼šHello Pipy å¼€å‘æ¨¡å¼ä¸‹å¯ä»¥è®© Pipy æºå¸¦ GUI å¯åŠ¨ï¼Œé€šè¿‡ GUI è¿›è¡Œé…ç½®ã€‚\n#æŒ‡å®š gui çš„ç«¯å£ä¸º 6060ï¼Œä» test ç›®å½•ä¸­åŠ è½½é…ç½® $ bin/pipy --gui-port=6060 test/ 2021-05-30 22:48:41 [info] [gui] Starting GUI service... 2021-05-30 22:48:41 [info] [listener] Listening on 0.0.0.0:6060 æµè§ˆå™¨ä¸­æ‰“å¼€ é…ç½®ç•Œé¢ å±•å¼€ 002-hello å­ç›®å½•ç‚¹é€‰ pipy å¹¶ç‚¹å‡»è¿è¡ŒæŒ‰é’®ï¼š\n$ curl -i localhost:6080 HTTP/1.1 200 OK Connection: keep-alive Content-Length: 7 Hello! Pipy è¿‡æ»¤å™¨ é€šè¿‡ pipe çš„å‘½ä»¤å¯ä»¥è¾“å‡ºå…¶æ”¯æŒçš„è¿‡æ»¤å™¨åˆ—è¡¨ï¼Œä¸€å…± 31 ä¸ªã€‚é€šè¿‡å°†ä¸€ç³»åˆ—è¿‡æ»¤å™¨è¿›è¡Œç»„è£…ï¼Œå¯ä»¥å®ç°å¤æ‚çš„æµå¤„ç†ã€‚\næ¯”å¦‚ 007-logging çš„é…ç½®å®ç°äº†æ—¥å¿—çš„åŠŸèƒ½ï¼šè®°å½•è¯·æ±‚å’Œå“åº”çš„æ•°æ®ï¼Œå¹¶æ‰¹é‡å‘é€åˆ° ElasticSearchã€‚è¿™é‡Œå°±ç”¨åˆ°äº† forkã€connectã€onSessionStartã€encodeHttpRequestã€decodeHttpRequestã€onMessageStartã€onMessageã€decodeHttpResponseã€replaceMessageã€linkã€muxã€task ç­‰åå¤šç§è¿‡æ»¤å™¨ã€‚\n$ bin/pipy --list-filters connect (target[, options]) Sends data to a remote endpoint and receives data from it demux (target) Sends messages to a different pipline with each one in its own session and context decodeDubbo () Deframes a Dubbo message decodeHttpRequest () Deframes an HTTP request message decodeHttpResponse () Deframes an HTTP response message dummy () Eats up all events dump ([tag]) Outputs events to the standard output encodeDubbo ([head]) Frames a Dubbo message encodeHttpRequest ([head]) Frames an HTTP request message encodeHttpResponse ([head]) Frames an HTTP response message exec (command) Spawns a child process and connects to its input/output fork (target[, sessionData]) Sends copies of events to other pipeline sessions link (target[, when[, target2[, when2, ...]]]) Sends events to a different pipeline mux (target[, selector]) Sends messages from different sessions to a shared pipeline session onSessionStart (callback) Handles the initial event in a session onData (callback) Handles a Data event onMessageStart (callback) Handles a MessageStart event onMessageEnd (callback) Handles a MessageEnd event onSessionEnd (callback) Handles a SessionEnd event onMessageBody (callback) Handles a complete message body onMessage (callback) Handles a complete message including the head and the body print () Outputs raw data to the standard output replaceSessionStart (callback) Replaces the initial event in a session replaceData ([replacement]) Replaces a Data event replaceMessageStart ([replacement]) Replaces a MessageStart event replaceMessageEnd ([replacement]) Replaces a MessageEnd event replaceSessionEnd ([replacement]) Replaces a SessionEnd event replaceMessageBody ([replacement]) Replaces an entire message body replaceMessage ([replacement]) Replaces a complete message including the head and the body tap (quota[, account]) Throttles message rate or data rate use (module, pipeline[, argv...]) Sends events to a pipeline in a different module wait (condition) Buffers up events until a condition is fulfilled åŸç† â€œTalk is cheap, show me the code.â€\né…ç½®åŠ è½½ ä¸ªäººæ¯”è¾ƒå–œæ¬¢çœ‹æºç æ¥ç†è§£å®ç°ï¼Œå³ä½¿æ˜¯ C++ã€‚ä»æµè§ˆå™¨è¯·æ±‚å…¥æ‰‹å‘ç°è¿è¡Œæ—¶å‘/api/program å‘é€äº† POST è¯·æ±‚ï¼Œè¯·æ±‚çš„å†…å®¹æ˜¯é…ç½®æ–‡ä»¶çš„åœ°å€ã€‚\næ£€æŸ¥æºç åï¼Œæ‰¾åˆ°é€»è¾‘çš„å®ç°åœ¨ src/gui.cpp:189ï¼š\nåˆ›å»ºæ–°çš„ worker åŠ è½½é…ç½®ï¼Œå°† JavaScrip ä»£ç è§£ææˆ Configuration å¯¹è±¡ å¯åŠ¨ workerï¼Œæ‰§è¡ŒConfiguration::apply() å¸è½½æ—§çš„ worker ä» src/api/configuration.cpp:267 å¤„çœ‹ï¼špipelineã€listen å’Œ task é…ç½®å®é™…åœ¨ Pipy çš„é…ç½®ä¸­éƒ½æ˜¯è¢«æŠ½è±¡ä¸º Pipeline å¯¹è±¡ï¼Œåªæ˜¯åœ¨ç±»å‹ä¸Šæœ‰å·®å¼‚åˆ†åˆ«ä¸ºï¼šNAMEDã€LISTEN å’Œ TASKã€‚æ¯”å¦‚ listen ä¸­å¯ä»¥é€šè¿‡ fork è¿‡æ»¤å™¨å°†äº‹ä»¶çš„å‰¯æœ¬å‘é€åˆ°æŒ‡å®šçš„ pipeline ä¸­ã€‚\nåŸºäºæ•°æ®æµäº‹ä»¶çš„å¤„ç† src/inbound.cpp:171\nç»“è¯­ Pipy è™½å°ï¼ˆåªæœ‰ 11Mï¼‰ï¼Œä½†ä»¥å…¶å¯ç¼–ç¨‹çš„ç‰¹æ€§æä¾›äº†çµæ´»çš„é…ç½®èƒ½åŠ›ï¼Œæ½œåŠ›æ— é™ã€‚\nPipy åƒå¤„ç† HTTP ä¸€æ ·å¤„ç†ä»»æ„çš„ä¸ƒå±‚åè®®ã€‚å†…éƒ¨ç‰ˆæœ¬æ”¯æŒDubboã€Redisã€Socks ç­‰ï¼Œç›®å‰æ­£åœ¨è¿ç§»åˆ°å¼€æºç‰ˆæœ¬ã€‚\næœŸå¾…å³å°†å¼€æºçš„ Portalï¼Œä»¥åŠæœåŠ¡ç½‘æ ¼ Flomeshã€‚æŒç»­å…³æ³¨ï¼Œåé¢è€ƒè™‘å†å†™å‡ ç¯‡ã€‚\nâ€œæœªæ¥å¯æœŸï¼â€\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/glance-at-programmable-gateway-pipy/","tags":["Pipy","äº‘åŸç”Ÿ"],"title":"åˆæ¢å¯ç¼–ç¨‹ç½‘å…³ Pipy"},{"categories":["ç¿»è¯‘"],"contents":"Quarkus çš„æ–‡ç« ä¹‹å‰å†™è¿‡ä¸‰ç¯‡äº†ï¼Œè®²è¿‡äº† Quarkus çš„å°è€Œå¿«ã€‚\nHello, Quarkus åº”\u0026quot;äº‘\u0026quot;è€Œç”Ÿçš„ Java æ¡†æ¶ Quarkusï¼šæ„å»ºæœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶ è°è¯´ Java ä¸èƒ½ç”¨æ¥è·‘ Serverlessï¼Ÿ ä¸€ç›´åœ¨é…é…¿å†™ä¸€ç¯‡ Quarkus ç”Ÿæ€ç›¸å…³çš„ï¼Œå› ä¸ºæœ€è¿‘ä¸€ç›´åœ¨å¿™ Meetup çš„äº‹æƒ…è€Œææµ…ã€‚æ­£å¥½çœ‹åˆ°äº†è¿™ç¯‡æ–‡ç« ï¼Œå°±æ‹¿æ¥ç¿»è¯‘ä¸€ä¸‹ï¼Œè¡¥å…¨äº‘åŸç”Ÿä¸­çš„â€œå¾®æœåŠ¡â€è¿™ä¸€å—ã€‚\næœ¬æ–‡è¯‘è‡ªã€ŠImplementing Microservicilities with Quarkus and MicroProfileã€‹ ã€‚\nä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¾®æœåŠ¡ç‰¹æ€§ï¼Ÿ åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºæ˜¯ç”±å‡ ä¸ªç›¸äº’è¿æ¥çš„æœåŠ¡ç»„æˆçš„ï¼Œè¿™äº›æœåŠ¡ä¸€èµ·å·¥ä½œæ¥å®ç°æ‰€éœ€çš„ä¸šåŠ¡åŠŸèƒ½ã€‚\nå› æ­¤ï¼Œå…¸å‹çš„ä¼ä¸šå¾®æœåŠ¡æ¶æ„å¦‚ä¸‹æ‰€ç¤ºï¼š\nåˆšå¼€å§‹ï¼Œä½¿ç”¨å¾®æœåŠ¡æ¶æ„å®ç°åº”ç”¨ç¨‹åºçœ‹èµ·æ¥å¾ˆå®¹æ˜“ã€‚\nä½†æ˜¯ï¼Œå› ä¸ºæœ‰äº†å•ä½“æ¶æ„æ²¡æœ‰ä¸€äº›æ–°çš„æŒ‘æˆ˜ï¼Œå› æ­¤åšèµ·æ¥å¹¶ä¸å®¹å™¨\nä¸¾å‡ ä¸ªä¾‹å­ï¼Œæ¯”å¦‚å®¹é”™ã€æœåŠ¡å‘ç°ã€æ‰©å±•æ€§ã€æ—¥å¿—è®°å½•å’Œè·Ÿè¸ªã€‚\nä¸ºäº†è§£å†³è¿™äº›æŒ‘æˆ˜ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½åº”å®ç°æˆ‘ä»¬åœ¨ Red Hat æ‰€è¯´çš„â€œå¾®æœåŠ¡ç‰¹æ€§â€ã€‚\nè¯¥æœ¯è¯­æ˜¯æŒ‡é™¤ä¸šåŠ¡é€»è¾‘ä»¥å¤–ï¼ŒæœåŠ¡è¿˜å¿…é¡»å®ç°æ¥è§£å†³çš„è·¨é¢†åŸŸå…³æ³¨ç‚¹æ¸…å•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¯ä»¥ç”¨ä»»ä½•è¯­è¨€ï¼ˆJavaã€Goã€JavaScriptï¼‰æˆ–ä»»ä½•æ¡†æ¶ï¼ˆSpring Bootã€Quarkusï¼‰å®ç°ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯å›´ç»•ä¸šåŠ¡é€»è¾‘ï¼Œåº”å®ç°ä»¥ä¸‹å…³æ³¨ç‚¹ï¼š\nAPIï¼šå¯é€šè¿‡ä¸€ç»„å®šä¹‰çš„ API æ“ä½œæ¥è®¿é—®è¯¥æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œå¯¹äº RESTful Web APIï¼ŒHTTP ç”¨ä½œåè®®ã€‚æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨è¯¸å¦‚ Swagger ä¹‹ç±»çš„å·¥å…·æ¥è®°å½• API ã€‚ æœåŠ¡å‘ç°ï¼ˆDiscoveryï¼‰ï¼šæœåŠ¡éœ€è¦å‘ç°å…¶ä»–æœåŠ¡ã€‚\nè°ƒç”¨æœåŠ¡ï¼ˆInvocationï¼‰ï¼šå‘ç°æœåŠ¡åï¼Œéœ€è¦ä½¿ç”¨ä¸€ç»„å‚æ•°å¯¹å…¶è¿›è¡Œè°ƒç”¨ï¼Œå¹¶é€‰æ‹©æ€§åœ°è¿”å›å“åº”ã€‚\nå¼¹æ€§ï¼ˆElasticityï¼‰ï¼šå¾®æœåŠ¡æ¶æ„çš„é‡è¦ç‰¹å¾ä¹‹ä¸€æ˜¯æ¯ä¸ªæœåŠ¡éƒ½æ˜¯å¼¹æ€§çš„ï¼Œè¿™æ„å‘³ç€å¯ä»¥æ ¹æ®ç³»ç»Ÿçš„å…³é”®ç¨‹åº¦æˆ–å½“å‰çš„å·¥ä½œé‡ç­‰å‚æ•°ç‹¬ç«‹åœ°è¿›è¡Œç¼©æ”¾ã€‚ï¼ˆè¯‘è€…æ³¨ï¼šè¿™é‡Œçš„å¼¹æ€§åªæ˜¯èµ„æºçš„å¼¹æ€§ï¼‰\nå¼¹æ€§ï¼ˆResiliencyï¼‰ï¼šåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæˆ‘ä»¬åœ¨å¼€å‘æ—¶åº”ç‰¢è®°å¤±è´¥ï¼Œå°¤å…¶æ˜¯åœ¨ä¸å…¶ä»–æœåŠ¡è¿›è¡Œé€šä¿¡æ—¶ã€‚åœ¨å•ä½“åº”ç”¨ä¸­ï¼Œæ•´ä¸ªåº”ç”¨ç¨‹åºå¤„äºå¯åŠ¨æˆ–å…³é—­çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå½“æ­¤åº”ç”¨ç¨‹åºåˆ†è§£ä¸ºå¾®æœåŠ¡ä½“ç³»ç»“æ„æ—¶ï¼Œè¯¥åº”ç”¨ç¨‹åºç”±å¤šä¸ªæœåŠ¡ç»„æˆï¼Œå¹¶ä¸”æ‰€æœ‰è¿™äº›æœåŠ¡éƒ½é€šè¿‡ç½‘ç»œäº’è¿ï¼Œè¿™æ„å‘³ç€è¯¥åº”ç”¨ç¨‹åºçš„æŸäº›éƒ¨åˆ†å¯èƒ½æ­£åœ¨è¿è¡Œï¼Œè€Œå…¶ä»–éƒ¨åˆ†å¯èƒ½ä¼šå¤±è´¥ã€‚éåˆ¶æ•…éšœå¯¹é¿å…é€šè¿‡å…¶ä»–æœåŠ¡ä¼ æ’­é”™è¯¯å¾ˆé‡è¦ã€‚å¼¹æ€§ï¼ˆæˆ–åº”ç”¨ç¨‹åºå¼¹æ€§ï¼‰æ˜¯åº”ç”¨ç¨‹åº/æœåŠ¡å¯¹é—®é¢˜åšå‡ºååº”å¹¶ä»ç„¶æä¾›æœ€ä½³ç»“æœçš„èƒ½åŠ›ã€‚ï¼ˆè¯‘è€…æ³¨ï¼šè¿™é‡Œçš„å¼¹æ€§ä¸å®¹é”™ç›¸å…³ï¼Œå¯¹å¤±è´¥å¤„ç†çš„å¼¹æ€§ï¼‰\nç®¡é“ï¼ˆPipelineï¼‰ï¼šæœåŠ¡åº”ç‹¬ç«‹éƒ¨ç½²ï¼Œè€Œæ— éœ€è¿›è¡Œä»»ä½•å½¢å¼çš„ç¼–æ’ã€‚å› æ­¤ï¼Œæ¯ä¸ªæœåŠ¡åº”å…·æœ‰è‡ªå·±çš„éƒ¨ç½²ç®¡é“ã€‚\nèº«ä»½éªŒè¯ï¼ˆAuthenticationï¼‰ï¼šå…³äºå¾®æœåŠ¡ä½“ç³»ç»“æ„ä¸­çš„å®‰å…¨æ€§çš„å…³é”®æ–¹é¢ä¹‹ä¸€æ˜¯å¦‚ä½•å¯¹å†…éƒ¨æœåŠ¡ä¹‹é—´çš„è°ƒç”¨è¿›è¡Œèº«ä»½éªŒè¯/æˆæƒã€‚Web ä»¤ç‰Œï¼ˆé€šå¸¸æ˜¯ä»¤ç‰Œï¼‰æ˜¯åœ¨å†…éƒ¨æœåŠ¡ä¸­å®‰å…¨åœ°è¡¨ç¤ºå£°æ˜çš„é¦–é€‰æ–¹å¼ã€‚\næ—¥å¿—è®°å½•ï¼ˆLoggingï¼‰ï¼šåœ¨å•ä½“åº”ç”¨ç¨‹åºä¸­ï¼Œæ—¥å¿—è®°å½•å¾ˆç®€å•ï¼Œå› ä¸ºè¯¥åº”ç”¨ç¨‹åºçš„æ‰€æœ‰ç»„ä»¶éƒ½åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ç„¶åç°åœ¨ç»„ä»¶ä»¥æœåŠ¡çš„å½¢å¼åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œå› æ­¤ï¼Œè¦æ‹¥æœ‰å®Œæ•´çš„æ—¥å¿—è®°å½•è§†å›¾ï¼Œéœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„æ—¥å¿—è®°å½•ç³»ç»Ÿ/æ•°æ®æ”¶é›†å™¨ã€‚\nç›‘æ§ï¼ˆMonitoringï¼‰ï¼šè¡¡é‡ç³»ç»Ÿçš„æ€§èƒ½ã€äº†è§£åº”ç”¨ç¨‹åºçš„æ•´ä½“è¿è¡ŒçŠ¶å†µï¼Œä»¥åŠåœ¨å‡ºç°é—®é¢˜æ—¶å‘å‡ºè­¦æŠ¥æ˜¯ä¿æŒåŸºäºå¾®æœåŠ¡çš„åº”ç”¨ç¨‹åºæ­£ç¡®è¿è¡Œçš„å…³é”®æ–¹é¢ã€‚ç›‘æ§æ˜¯æ§åˆ¶åº”ç”¨ç¨‹åºçš„å…³é”®æ–¹é¢ã€‚\nè·Ÿè¸ªï¼ˆTracingï¼‰ï¼šè·Ÿè¸ªç”¨äºå¯è§†åŒ–ç¨‹åºçš„æµç¨‹å’Œæ•°æ®è¿›åº¦ã€‚ä½œä¸ºå¼€å‘äººå‘˜/è¿ç»´äººå‘˜ï¼Œå½“æˆ‘ä»¬éœ€è¦æ£€æŸ¥ç”¨æˆ·åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­çš„è¡Œç¨‹æ—¶ï¼Œè¿™ç‰¹åˆ«æœ‰ç”¨ã€‚\nKubernetesæ­£åœ¨æˆä¸ºéƒ¨ç½²å¾®æœåŠ¡çš„å®é™…å·¥å…·ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºè‡ªåŠ¨åŒ–ã€ç¼–æ’ã€æ‰©å±•å’Œç®¡ç†å®¹å™¨çš„å¼€æºç³»ç»Ÿã€‚\nä½¿ç”¨ Kubernetes æ—¶ï¼Œåä¸ªå¾®æœåŠ¡ç‰¹æ€§ä¸­åªæœ‰ä¸‰ä¸ªè¢«æ¶µç›–ã€‚\n**æœåŠ¡å‘ç°Â **æ˜¯é€šè¿‡ Kubernetes æœåŠ¡çš„æ¦‚å¿µå®ç°çš„ã€‚å®ƒæä¾›äº†ä¸€ç§ä½¿ç”¨ç¨³å®šçš„è™šæ‹Ÿ IP å’Œ DNS åç§°å°† Kubernetes Pod åˆ†ç»„ï¼ˆä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼‰çš„æ–¹æ³•ã€‚å‘ç°æœåŠ¡åªæ˜¯ä½¿ç”¨ Kubernetes çš„æœåŠ¡åä½œä¸º hostname è¿›è¡Œè¯·æ±‚ã€‚\nä½¿ç”¨ Kubernetes å¯ä»¥å¾ˆå®¹æ˜“åœ°è°ƒç”¨æœåŠ¡ï¼Œå› ä¸ºå¹³å°æœ¬èº«æä¾›äº†è°ƒç”¨ä»»ä½•æœåŠ¡æ‰€éœ€çš„ç½‘ç»œã€‚\nä»ä¸€å¼€å§‹ï¼ŒKubernetes å°±ä¸€ç›´åœ¨è€ƒè™‘å¼¹æ€§ï¼ˆæˆ–å¯ä¼¸ç¼©æ€§ï¼‰ï¼Œä¾‹å¦‚è¿è¡Œæ—¶kubectl scale deployment myservice --replicas=5 commandï¼Œmyservice deployment å¯ä¼¸ç¼©è‡³äº”ä¸ªå‰¯æœ¬æˆ–å®ä¾‹ã€‚Kubernetes å¹³å°è´Ÿè´£å¯»æ‰¾åˆé€‚çš„èŠ‚ç‚¹ï¼Œéƒ¨ç½²æœåŠ¡å¹¶å§‹ç»ˆä¿æŒæ‰€éœ€æ•°é‡çš„å‰¯æœ¬å¹¶æ­£å¸¸è¿è¡Œã€‚\nä½†æ˜¯å…¶ä½™çš„å¾®æœåŠ¡ç‰¹æ€§åˆå¦‚ä½•å‘¢ï¼ŸKubernetes ä»…æ¶µç›–å…¶ä¸­çš„ä¸‰ä¸ªï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•å®ç°å‰©ä¸‹çš„å‘¢ï¼Ÿ\næ ¹æ®æ‰€ä½¿ç”¨çš„è¯­è¨€æˆ–æ¡†æ¶ï¼Œå¯ä»¥éµå¾ªçš„ç­–ç•¥å¾ˆå¤šã€‚ä½†æ˜¯åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†äº†è§£å¦‚ä½•ä½¿ç”¨ Quarkus å®ç°å…¶ä¸­çš„ä¸€äº›ç­–ç•¥ã€‚\nä»€ä¹ˆæ˜¯ Quarkusï¼Ÿ QuarkusÂ æ˜¯é’ˆå¯¹ Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰å’Œæœ¬æœºç¼–è¯‘çš„å…¨æ ˆ Kubernetes æœ¬åœ° Java æ¡†æ¶ï¼Œä¸“é—¨é’ˆå¯¹å®¹å™¨ä¼˜åŒ– Javaï¼Œä½¿å…¶æˆä¸ºæ— æœåŠ¡å™¨ï¼ˆServerlessï¼‰ã€äº‘å’Œ Kubernetes ç¯å¢ƒçš„é«˜æ•ˆå¹³å°ã€‚\nInstead of reinventing the wheel, Quarkus uses well-known enterprise-grade frameworks backed by standards/specifications and makes them compilable to a binary usingÂ GraalVM. Quarkusä¸ç”¨é‡æ–°å‘æ˜è½®å­ï¼Œè€Œæ˜¯ä½¿ç”¨ä»¥æ ‡å‡†/è§„èŒƒä¸ºåç›¾çš„çŸ¥åä¼ä¸šçº§æ¡†æ¶ï¼Œå¹¶ä½¿ç”¨ GraalVM å°†å…¶ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ã€‚\nä»€ä¹ˆæ˜¯ MicroProfileï¼Ÿ Quarkus ä¸ MicroProfile è§„èŒƒé›†æˆï¼Œä»è€Œå°†ä¼ä¸š Java ç”Ÿæ€ç³»ç»Ÿè¿ç§»åˆ°å¾®æœåŠ¡ä½“ç³»ç»“æ„ä¸­ã€‚\nåœ¨ä¸‹å›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æ„æˆ MicroProfile è§„èŒƒçš„æ‰€æœ‰ APIã€‚æŸäº› APIï¼ˆä¾‹å¦‚ CDIã€JSON-P å’Œ JAX-RSï¼‰åŸºäº Jakarta EEï¼ˆä»¥å‰çš„ Java EEï¼‰è§„èŒƒã€‚å…¶ä½™çš„ç”± Java ç¤¾åŒºå¼€å‘ã€‚\nLetâ€™s implement API, invocation, resilience, authentication, logging, monitoring, and tracing microservicilities using Quarkus. è®©æˆ‘ä»¬ä½¿ç”¨Quarkuså®ç°APIã€è°ƒç”¨ã€å¼¹æ€§ã€èº«ä»½éªŒè¯ã€æ—¥å¿—è®°å½•ã€ç›‘è§†å’Œè·Ÿè¸ªå¾®æœåŠ¡ç‰¹æ€§ã€‚\nå¦‚ä½•ä½¿ç”¨ Quarkus å®ç°å¾®æœåŠ¡ç‰¹æ€§ å…¥é—¨ å¼€å§‹ä½¿ç”¨ Quarkus çš„æœ€å¿«æ–¹æ³•æ˜¯é€šè¿‡åœ¨å¼€å§‹é¡µé¢ä¸­é€‰æ‹©æ‰€éœ€çš„ä¾èµ–ã€‚å¯¹äºå½“å‰ç¤ºä¾‹ï¼Œé€‰æ‹©å¦‚ä¸‹ä¾èµ–å…³ç³»ä»¥æ»¡è¶³å¾®æœåŠ¡éœ€æ±‚ï¼š\nAPIï¼šRESTEasy JAX-RSã€RESTEasy JSON-Bã€OpenAPI è°ƒç”¨ï¼šREST Client JSON-B å¼¹æ€§ï¼šFault Tolerance è®¤è¯ï¼šJWT è®°å½•ï¼šGELF ç›‘æ§ï¼šMicrometer metrics è·Ÿè¸ªï¼šOpenTracing\næˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨é€‰æ‹©å„è‡ªçš„ä¾èµ–å…³ç³»ï¼Œæˆ–æµè§ˆä»¥ä¸‹é“¾æ¥ Quarkus å¾®æœåŠ¡ç‰¹æ€§ç”Ÿæˆå™¨ï¼Œæ‰€æœ‰è¿™äº›éƒ½ä¼šè¢«é€‰ä¸­ã€‚ç„¶åæŒ‰â€œç”Ÿæˆåº”ç”¨ç¨‹åºâ€æŒ‰é’®ä»¥ä¸‹è½½åŒ…å«æ”¯æ¶åº”ç”¨ç¨‹åºçš„zipæ–‡ä»¶ã€‚\næœåŠ¡ å¯¹äºå½“å‰ç¤ºä¾‹ï¼Œä»…ä½¿ç”¨ä¸¤ä¸ªæœåŠ¡ç”Ÿæˆäº†ä¸€ä¸ªéå¸¸ç®€å•çš„åº”ç”¨ç¨‹åºã€‚ä¸€ä¸ªåä¸ºâ€œè¯„çº§æœåŠ¡ rating serviceâ€çš„æœåŠ¡è¿”å›ç»™å®šä¹¦ç±çš„è¯„çº§ï¼Œè€Œå¦ä¸€ä¸ªåä¸ºâ€œä¹¦ç±æœåŠ¡ book serviceâ€çš„æœåŠ¡åˆ™è¿”å›ä¸€æœ¬ä¹¦çš„ä¿¡æ¯åŠå…¶è¯„çº§ã€‚æœåŠ¡ä¹‹é—´çš„æ‰€æœ‰è°ƒç”¨éƒ½å¿…é¡»ç»è¿‡èº«ä»½éªŒè¯ã€‚\nåœ¨ä¸‹å›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æ•´ä¸ªç³»ç»Ÿçš„æ¦‚è¿°ï¼š\nè¯„çº§æœåŠ¡å·²ç»å¼€å‘å¹¶ä½œä¸º Linux å®¹å™¨æä¾›ã€‚é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåœ¨ç«¯å£ 9090 ä¸Šå¯åŠ¨æœåŠ¡ï¼š\ndocker run --rm -ti -p 9090:8080 quay.io/lordofthejars/rating-service:1.0.0 è¦éªŒè¯æœåŠ¡ï¼Œè¯·å‘ http://localhost:9090/rate/1 å‘å‡ºè¯·æ±‚\ncurl localhost:8080/rate/1 -vv \u0026gt; GET /rate/1 HTTP/1.1 \u0026gt; Host: localhost:8080 \u0026gt; User-Agent: curl/7.64.1 \u0026gt; Accept: */* \u0026gt; \u0026lt; HTTP/1.1 401 Unauthorized \u0026lt; www-authenticate: Bearer {token} \u0026lt; Content-Length: 0 è¿”å›çš„çŠ¶æ€ç æ˜¯ 401 Unauthorized å› ä¸ºæ²¡æœ‰åœ¨è¯·æ±‚ä¸­æºå¸¦ä»¤ç‰Œï¼ˆJWTï¼‰æä¾›æˆæƒä¿¡æ¯ã€‚åªæœ‰å¸¦æœ‰ group Echoer æœ‰æ•ˆä»¤ç‰Œæ‰èƒ½è®¿é—®è¯„çº§æœåŠ¡ã€‚\nAPI Quarkus ä½¿ç”¨ä¼—æ‰€å‘¨çŸ¥çš„ JAX-RS è§„èŒƒæ¥å®šä¹‰ RESTful Web APIã€‚åœ¨å¹•åï¼ŒQuarkus ä½¿ç”¨ RESTEasy å®ç°ç›´æ¥ä¸ Vert.X æ¡†æ¶ä¸€èµ·ä½¿ç”¨ï¼Œè€Œæ— éœ€ä½¿ç”¨ Servlet æŠ€æœ¯ã€‚\nè®©æˆ‘ä»¬ä¸ºå®ç°æœ€å¸¸è§æ“ä½œçš„å›¾ä¹¦æœåŠ¡å®šä¹‰ä¸€ä¸ª APIï¼š\nimport javax.ws.rs.Consumes; import javax.ws.rs.DELETE; import javax.ws.rs.GET; import javax.ws.rs.POST; import javax.ws.rs.Path; import javax.ws.rs.PathParam; import javax.ws.rs.Produces; import javax.ws.rs.QueryParam; import javax.ws.rs.core.MediaType; import javax.ws.rs.core.Response; import javax.ws.rs.core.UriBuilder; @Path(\u0026#34;/book\u0026#34;) public class BookResource { @GET @Path(\u0026#34;/{bookId}\u0026#34;) @Produces(MediaType.APPLICATION_JSON) public Book book(@PathParam(\u0026#34;bookId\u0026#34;) Long bookId) { // logic } @POST @Consumes(MediaType.APPLICATION_JSON) public Response getBook(Book book) { // logic return Response.created( UriBuilder.fromResource(BookResource.class) .path(Long.toString(book.bookId)) .build()) .build(); } @DELETE @Path(\u0026#34;/{bookId}\u0026#34;) public Response delete(@PathParam(\u0026#34;bookId\u0026#34;) Long bookId) { // logic return Response.noContent().build(); } @GET @Produces(MediaType.APPLICATION_JSON) @Path(\u0026#34;search\u0026#34;) public Response searchBook(@QueryParam(\u0026#34;description\u0026#34;) String description) { // logic return Response.ok(books).build(); } } é¦–å…ˆè¦æ³¨æ„çš„æ˜¯ï¼Œå®šä¹‰äº†å››ä¸ªä¸åŒçš„ç«¯ç‚¹ï¼š\nGET /book/{bookId}Â ä½¿ç”¨ GET HTTP æ–¹æ³•è¿”å›å¸¦æœ‰å…¶è¯„çº§çš„å›¾ä¹¦ä¿¡æ¯ã€‚return å…ƒç´ ä¼šè‡ªåŠ¨è§£ç¼–ä¸º JSONã€‚ POST /bookÂ ä½¿ç”¨ POST HTTP æ–¹æ³•æ’å…¥ä¸€æœ¬ä¹¦ä½œä¸ºæ­£æ–‡å†…å®¹ã€‚æ­£æ–‡å†…å®¹ä¼šè‡ªåŠ¨ä» JSON ç¼–ç»„åˆ° Java å¯¹è±¡ã€‚ DELETE /book/{bookId}Â ä½¿ç”¨ DELETE HTTP æ–¹æ³•é€šè¿‡ä¹¦çš„ ID åˆ é™¤ä¹¦ã€‚ GET /book/search?description={description}Â æŒ‰ä¹¦åæœç´¢ä¹¦ç±ã€‚ æ³¨æ„çš„ç¬¬äºŒä»¶äº‹æ˜¯è¿”å›ç±»å‹ï¼Œæœ‰æ—¶æ˜¯ Java å¯¹è±¡ï¼Œæœ‰æ—¶æ˜¯ Java å®ä¾‹ javax.ws.rs.core.Responseã€‚ä½¿ç”¨ Java å¯¹è±¡æ—¶ï¼Œä¼šå°†å…¶ä» Java å¯¹è±¡åºåˆ—åŒ–ä¸º @Produces æ³¨è§£ä¸­è®¾ç½®çš„åª’ä½“ç±»å‹ã€‚åœ¨æ­¤ç‰¹å®šæœåŠ¡ä¸­ï¼Œè¾“å‡ºä¸º JSON æ–‡æ¡£ã€‚é€šè¿‡è¯¥ Response å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¿”å›ç»™è°ƒç”¨æ–¹çš„å†…å®¹è¿›è¡Œç»†ç²’åº¦çš„æ§åˆ¶ã€‚å¯ä»¥è®¾ç½® HTTP çŠ¶æ€ä»£ç ã€æ ‡å¤´æˆ–è¿”å›ç»™è°ƒç”¨æ–¹çš„å†…å®¹ã€‚å–å†³äºä½¿ç”¨åœºæ™¯ï¼Œæ˜¯åçˆ±ä¸€ç§æ–¹æ³•è€Œä¸æ˜¯å¦ä¸€ç§æ–¹æ³•ã€‚\nè°ƒç”¨ åœ¨å®šä¹‰äº†ç”¨äºè®¿é—®å›¾ä¹¦æœåŠ¡çš„ API ä¹‹åï¼Œæ˜¯æ—¶å€™å¼€å‘ä¸€æ®µä»£ç æ¥è°ƒç”¨è¯„çº§æœåŠ¡ä»¥æ£€ç´¢å›¾ä¹¦çš„è¯„çº§äº†ã€‚\nQuarkus ä½¿ç”¨ MicroProfile Rest Client è§„èŒƒæ¥è®¿é—®å¤–éƒ¨ï¼ˆHTTPï¼‰æœåŠ¡ã€‚å®ƒæä¾›äº†ä¸€ç§ç±»å‹å®‰å…¨çš„æ–¹æ³•ï¼Œä»¥é€šè¿‡æŸäº› JAX-RS 2.0 API é€šè¿‡ HTTP è°ƒç”¨ RESTful æœåŠ¡ï¼Œä»¥å®ç°ä¸€è‡´æ€§å’Œæ›´æ˜“äºé‡ç”¨ã€‚\nè¦åˆ›å»ºçš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªä½¿ç”¨ JAX-RS æ‰¹æ³¨è¡¨ç¤ºè¿œç¨‹æœåŠ¡çš„æ¥å£ã€‚\nimport javax.ws.rs.GET; import javax.ws.rs.Path; import javax.ws.rs.PathParam; import javax.ws.rs.Produces; import javax.ws.rs.core.MediaType; import org.eclipse.microprofile.rest.client.inject.RegisterRestClient; @Path(\u0026#34;/rate\u0026#34;) @RegisterRestClient public interface RatingService { @GET @Path(\u0026#34;/{bookId}\u0026#34;) @Produces(MediaType.APPLICATION_JSON) Rate getRate(@PathParam(\u0026#34;bookId\u0026#34;) Long bookId); } When the getRate() method is called, a remote HTTP call is invoked at /rate/{bookId} replacing the bookId with the value set in the method parameter. It is important to annotate the interface with the @RegisterRestClient annotation. Then the RatingService interface needs to be injected into BookResource to execute the remote calls. å½“ getRate() æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè¿œç¨‹ HTTP è¯·æ±‚åœ¨è°ƒç”¨ /rate/{bookId} æ›¿æ¢ bookId ç”¨åœ¨è¯¥æ–¹æ³•ä¸­çš„å‚æ•°å€¼é›†åˆã€‚ç”¨ @RegisterRestClient æ³¨è§£å¯¹æ¥å£è¿›è¡Œæ³¨è§£å¾ˆé‡è¦ã€‚\nç„¶å RatingService éœ€è¦å°†æ¥å£æ³¨å…¥ BookResource ä»¥æ‰§è¡Œè¿œç¨‹è°ƒç”¨ã€‚\nimport org.eclipse.microprofile.rest.client.inject.RestClient; @RestClient RatingService ratingService; @GET @Path(\u0026#34;/{bookId}\u0026#34;) @Produces(MediaType.APPLICATION_JSON) public Book book(@PathParam(\u0026#34;bookId\u0026#34;) Long bookId) { final Rate rate = ratingService.getRate(bookId); Book book = findBook(bookId); return book; } The @RestClient annotation injects a proxied instance of the interface, providing the implementation of the client. The last thing is to configure the service location (the hostname part). In Quarkus, the configuration properties are set in src/main/resources/application.properties file. To configure the location of the service, we need to use the fully qualified name of the Rest Client interface with URL as key, and the location as a value: è¯¥ @RestClient æ³¨è§£æ³¨å…¥ç•Œé¢çš„ä»£ç†å®ä¾‹ï¼Œæä¾›å®¢æˆ·ç«¯çš„å®ç°ã€‚\næœ€åä¸€ä»¶äº‹æ˜¯é…ç½®æœåŠ¡ä½ç½®ï¼ˆhostname éƒ¨åˆ†ï¼‰ã€‚åœ¨ Quarkus ä¸­ï¼Œé…ç½®å±æ€§åœ¨ src/main/resources/application.properties æ–‡ä»¶ä¸­è®¾ç½®ã€‚è¦é…ç½®æœåŠ¡çš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ Rest Client æ¥å£çš„æ ‡å‡†åç§°ï¼Œå…¶ä¸­ URL ä½œä¸ºé”®ï¼Œè€Œ location ä½œä¸ºå€¼ï¼š\norg.acme.RatingService/mp-rest/url=http://localhost:9090 åœ¨æ­£ç¡®è®¿é—®è¯„ä¼°æœåŠ¡è€Œæ²¡æœ‰ 401 Unauthorized é—®é¢˜ä¹‹å‰ï¼Œå¿…é¡»è§£å†³ç›¸äº’è®¤è¯é—®é¢˜ã€‚\nèº«ä»½éªŒè¯ åŸºäºä»¤ç‰Œçš„èº«ä»½éªŒè¯æœºåˆ¶å…è®¸ç³»ç»ŸåŸºäºå®‰å…¨ä»¤ç‰Œå¯¹èº«ä»½è¿›è¡Œèº«ä»½éªŒè¯ã€æˆæƒå’ŒéªŒè¯ã€‚Quarkus ä¸ MicroProfile JWT RBAC å®‰å…¨è§„èŒƒé›†æˆåœ¨ä¸€èµ·ï¼Œä»¥ä½¿ç”¨ JWT ä»¤ç‰Œä¿æŠ¤æœåŠ¡ã€‚\nè¦ä½¿ç”¨ MicroProfile JWT RBAC å®‰å…¨æ€§ä¿æŠ¤ç«¯ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨æ‰¹æ³¨å¯¹æ–¹æ³•è¿›è¡Œ @RolesAllowed æ³¨è§£ã€‚\n@GET @Path(\u0026#34;/{bookId}\u0026#34;) @RolesAllowed(\u0026#34;Echoer\u0026#34;) @Produces(MediaType.APPLICATION_JSON) public Book book(@PathParam(\u0026#34;bookId\u0026#34;) Long bookId) ç„¶åï¼Œæˆ‘ä»¬é…ç½®ä»¤ç‰Œçš„å‘è¡Œæ–¹å’Œå…¬é’¥çš„ä½ç½®ï¼Œä»¥éªŒè¯ä»¤ç‰Œåœ¨ application.properties æ–‡ä»¶ä¸­çš„ç­¾åï¼š\nmp.jwt.verify.publickey.location=https://raw.githubusercontent.com/redhat-developer-demos/quarkus-tutorial/master/jwt-token/quarkus.jwt.pub mp.jwt.verify.issuer=https://quarkus.io/using-jwt-rbac æ­¤æ‰©å±•åè‡ªåŠ¨éªŒè¯ï¼šä»¤ç‰Œæœ‰æ•ˆï¼›å‘è¡Œæ–¹æ˜¯æ­£ç¡®çš„ï¼›ä»¤ç‰Œå°šæœªä¿®æ”¹ï¼›ç­¾åæœ‰æ•ˆï¼›æ²¡æœ‰è¿‡æœŸã€‚\nè¿™ä¸¤ç§å›¾ä¹¦æœåŠ¡å’Œè¯„çº§æœåŠ¡ç°åœ¨æ˜¯ç”±åŒä¸€ JWT å‘è¡Œæ–¹å’Œå¯†é’¥ä¿æŠ¤ï¼Œå› æ­¤æœåŠ¡ä¹‹é—´çš„é€šä¿¡è¦æ±‚éªŒè¯æä¾›åœ¨ä»¤ç‰Œçš„æœ‰æ•ˆæ‰¿è½½ç”¨æˆ· Authentication å¤´éƒ¨ã€‚\nè¯„çº§æœåŠ¡å¯åŠ¨å’Œè¿è¡Œï¼Œè®©æˆ‘ä»¬å¼€å§‹ç”¨ä¸‹é¢çš„å‘½ä»¤å›¾ä¹¦æœåŠ¡ï¼š\n./mvnw compile quarkus:dev Finally, we can make a request to get book information providing a valid JSON Web Token as a bearer token. The generation of the token is out of the scope of this article, and a token has been already generated: æœ€åï¼Œæˆ‘ä»¬å¯ä»¥è¯·æ±‚è·å–æä¾›æœ‰æ•ˆ JSON Web ä»¤ç‰Œä½œä¸ºæ‰¿è½½ä»¤ç‰Œçš„å›¾ä¹¦ä¿¡æ¯ã€‚\nä»¤ç‰Œçš„ç”Ÿæˆä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ä¹‹å†…ï¼Œå¹¶ä¸”å·²ç»ç”Ÿæˆäº†ä»¤ç‰Œï¼š\ncurl -H \u0026#34;Authorization: Bearer eyJraWQiOiJcL3ByaXZhdGVLZXkucGVtIiwidHlwIjoiSldUIiwiYWxnIjoiUlMyNTYifQ.eyJzdWIiOiJqZG9lLXVzaW5nLWp3dC1yYmFjIiwiYXVkIjoidXNpbmctand0LXJiYWMiLCJ1cG4iOiJqZG9lQHF1YXJrdXMuaW8iLCJiaXJ0aGRhdGUiOiIyMDAxLTA3LTEzIiwiYXV0aF90aW1lIjoxNTcwMDk0MTcxLCJpc3MiOiJodHRwczpcL1wvcXVhcmt1cy5pb1wvdXNpbmctand0LXJiYWMiLCJyb2xlTWFwcGluZ3MiOnsiZ3JvdXAyIjoiR3JvdXAyTWFwcGVkUm9sZSIsImdyb3VwMSI6Ikdyb3VwMU1hcHBlZFJvbGUifSwiZ3JvdXBzIjpbIkVjaG9lciIsIlRlc3RlciIsIlN1YnNjcmliZXIiLCJncm91cDIiXSwicHJlZmVycmVkX3VzZXJuYW1lIjoiamRvZSIsImV4cCI6MjIwMDgxNDE3MSwiaWF0IjoxNTcwMDk0MTcxLCJqdGkiOiJhLTEyMyJ9.Hzr41h3_uewy-g2B-sonOiBObtcpkgzqmF4bT3cO58v45AIOiegl7HIx7QgEZHRO4PdUtR34x9W23VJY7NJ545ucpCuKnEV1uRlspJyQevfI-mSRg1bHlMmdDt661-V3KmQES8WX2B2uqirykO5fCeCp3womboilzCq4VtxbmM2qgf6ag8rUNnTCLuCgEoulGwTn0F5lCrom-7dJOTryW1KI0qUWHMMwl4TX5cLmqJLgBzJapzc5_yEfgQZ9qXzvsT8zeOWSKKPLm7LFVt2YihkXa80lWcjewwt61rfQkpmqSzAHL0QIs7CsM9GfnoYc0j9po83-P3GJiBMMFmn-vg\u0026#34; localhost:8080/book/1 -v å“åº”åˆæ˜¯ forbidden é”™è¯¯ï¼š\n\u0026lt; HTTP/1.1 401 Unauthorized \u0026lt; Content-Length: 0 ä½ å¯èƒ½æƒ³çŸ¥é“ä¸ºä»€ä¹ˆåœ¨æä¾›æœ‰æ•ˆä»¤ç‰Œåä»ç„¶å‡ºç°æ­¤é”™è¯¯ã€‚å¦‚æœæˆ‘ä»¬æ£€æŸ¥å›¾ä¹¦æœåŠ¡çš„æ§åˆ¶å°ï¼Œå°±ä¼šå‘ç°æŠ›å‡ºäº†ä»¥ä¸‹å¼‚å¸¸ï¼š\norg.jboss.resteasy.client.exception.ResteasyWebApplicationException: Unknown error, status code 401 at org.jboss.resteasy.client.exception.WebApplicationExceptionWrapper.wrap(WebApplicationExceptionWrapper.java:107) at org.jboss.resteasy.microprofile.client.DefaultResponseExceptionMapper.toThrowable(DefaultResponseExceptionMapper.java:21) å‘ç”Ÿæ­¤å¼‚å¸¸çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬å·²è·å¾—èº«ä»½éªŒè¯å¹¶æœ‰æƒè®¿é—®å›¾ä¹¦æœåŠ¡ï¼Œä½†æ‰¿è½½ä»¤ç‰Œå°šæœªä¼ æ’­åˆ°è¯„çº§æœåŠ¡ã€‚\nä¸ºäº†è‡ªåŠ¨å°† Authorization æ ‡å¤´ä»ä¼ å…¥è¯·æ±‚ä¼ æ’­åˆ°å…¶ä½™å®¢æˆ·ç«¯è¯·æ±‚ï¼Œéœ€è¦è¿›è¡Œä¸¤æ¬¡ä¿®æ”¹ã€‚\nç¬¬ä¸€ä¸ªä¿®æ”¹æ˜¯ä¿®æ”¹ Rest Client ç•Œé¢ï¼Œå¹¶ä½¿ç”¨å¯¹å…¶è¿›è¡Œæ³¨è§£ org.eclipse.microprofile.rest.client.inject.RegisterClientHeadersã€‚\n@Path(\u0026#34;/rate\u0026#34;) @RegisterRestClient @RegisterClientHeaders public interface RatingService {} ç¬¬äºŒä¸ªä¿®æ”¹æ˜¯é…ç½®åœ¨è¯·æ±‚ä¹‹é—´ä¼ æ’­å“ªäº›æ ‡å¤´ã€‚è¿™æ˜¯åœ¨ application.properties æ–‡ä»¶ä¸­è®¾ç½®çš„ï¼š\norg.eclipse.microprofile.rest.client.propagateHeaders=Authorization æ‰§è¡Œä¸ä¹‹å‰ç›¸åŒçš„ curl å‘½ä»¤ï¼Œæˆ‘ä»¬å°†è·å¾—æ­£ç¡®çš„è¾“å‡ºï¼š\n\u0026lt; HTTP/1.1 200 OK \u0026lt; Content-Length: 39 \u0026lt; Content-Type: application/json \u0026lt; * Connection #0 to host localhost left intact {\u0026#34;bookId\u0026#34;:2,\u0026#34;name\u0026#34;:\u0026#34;Book 2\u0026#34;,\u0026#34;rating\u0026#34;:1}* Closing connection 0 å¼¹æ€§ åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå…·æœ‰å®¹é”™èƒ½åŠ›å¾ˆé‡è¦ï¼Œè¿™æ ·å¯ä»¥é¿å…æ•…éšœä»ä¸€ä¸ªæœåŠ¡ä¼ æ’­åˆ°è¯¥æœåŠ¡çš„æ‰€æœ‰ç›´æ¥å’Œé—´æ¥è°ƒç”¨æ–¹ã€‚Quarkus å°† MicroProfile Fault Tolerance è§„èŒƒä¸ä»¥ä¸‹ç”¨äºå¤„ç†æ•…éšœçš„æ³¨é‡Šé›†æˆåœ¨ä¸€èµ·ï¼š\nâ—Â @Timeoutï¼šå®šä¹‰æŠ›å‡ºå¼‚å¸¸ä¹‹å‰æ‰§è¡Œçš„æœ€é•¿æ—¶é—´ã€‚ â—Â @Retryï¼šå¦‚æœè°ƒç”¨å¤±è´¥ï¼Œè¯·å†æ¬¡é‡è¯•æ‰§è¡Œã€‚ â—Â @Bulkheadï¼šé™åˆ¶å¹¶å‘æ‰§è¡Œï¼Œä»¥ä½¿è¯¥åŒºåŸŸä¸­çš„æ•…éšœä¸ä¼šä½¿æ•´ä¸ªç³»ç»Ÿè¿‡è½½ã€‚ â—Â @CircuitBreakerï¼šæ‰§è¡Œåå¤å¤±è´¥æ—¶ï¼Œå°†è‡ªåŠ¨è¿›è¡Œå¿«é€Ÿæ•…éšœåˆ‡æ¢ã€‚ â—Â @Fallbackï¼šæ‰§è¡Œå¤±è´¥æ—¶ï¼Œæä¾›å¤‡ç”¨è§£å†³æ–¹æ¡ˆ/é»˜è®¤å€¼ã€‚\nè®©æˆ‘ä»¬æ·»åŠ ä¸‰æ¬¡é‡è¯•ï¼Œå…¶ä¸­é‡è¯•ä¹‹é—´çš„å»¶è¿Ÿè®¡æ—¶å™¨ä¸ºä¸€ç§’ï¼Œä»¥é˜²è®¿é—®è¯„çº§æœåŠ¡æ—¶å‘ç”Ÿé”™è¯¯ã€‚\n@Retry(maxRetries = 3, delay = 1000) Rate getRate(@PathParam(\u0026#34;bookId\u0026#34;) Long bookId); ç°åœ¨ï¼Œåœæ­¢è¯„çº§æœåŠ¡å¹¶æ‰§è¡Œè¯·æ±‚ã€‚å¼•å‘ä»¥ä¸‹å¼‚å¸¸ï¼š\norg.jboss.resteasy.spi.UnhandledException: javax.ws.rs.ProcessingException: RESTEASY004655: Unable to invoke request: org.apache.http.conn.HttpHostConnectException: Connect to localhost:9090 [localhost/127.0.0.1, localhost/0:0:0:0:0:0:0:1] failed: Connection refused æ˜¾ç„¶ï¼Œè¿™é‡Œå­˜åœ¨é”™è¯¯ï¼Œä½†æ˜¯è¯·æ³¨æ„ï¼Œç”±äºæ‰§è¡Œäº†ä¸‰æ¬¡é‡è¯•ï¼ˆå»¶è¿Ÿä¸€ç§’ï¼‰ï¼Œå› æ­¤å¼•å‘å¼‚å¸¸ä¹‹å‰ï¼Œç»è¿‡äº†ä¸‰ç§’é’Ÿã€‚\nåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯„çº§æœåŠ¡å·²å…³é—­ï¼Œå› æ­¤æ— æ³•è¿›è¡Œæ¢å¤ï¼Œä½†æ˜¯åœ¨ä¸€ä¸ªå®é™…ç¤ºä¾‹ä¸­ï¼Œè¯„çº§æœåŠ¡å¯èƒ½ä»…åœ¨çŸ­æ—¶é—´å†…å°±æ¢å¤äº†ï¼Œæˆ–è€…éƒ¨ç½²äº†è¯¥æœåŠ¡çš„å¤šä¸ªå‰¯æœ¬ï¼Œå› æ­¤å¯ä»¥ç®€å•åœ°é‡è¯•æ“ä½œå¯èƒ½è¶³ä»¥æ¢å¤å¹¶æä¾›æœ‰æ•ˆçš„å“åº”ã€‚\nä½†æ˜¯ï¼Œå½“å¼•å‘å¼‚å¸¸æ—¶é‡è¯•æ¬¡æ•°ä¸å¤Ÿæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†é”™è¯¯ä¼ æ’­ç»™è°ƒç”¨æ–¹ï¼Œä¹Ÿå¯ä»¥ä¸ºè°ƒç”¨æä¾›æ›¿ä»£å€¼ã€‚è¿™ç§é€‰æ‹©å¯ä»¥æ˜¯å¯¹å¦ä¸€ä¸ªç³»ç»Ÿçš„è°ƒç”¨ï¼ˆå³åˆ†å¸ƒå¼ç¼“å­˜ï¼‰æˆ–é™æ€å€¼ã€‚\nå¯¹äºæ­¤ç”¨ä¾‹ï¼Œå½“ä¸è¯„çº§æœåŠ¡çš„è¿æ¥å¤±è´¥æ—¶ï¼Œå°†è¿”å›è¯„çº§å€¼ 0ã€‚\nè¦å®ç°å›é€€é€»è¾‘ï¼Œé¦–å…ˆè¦åšçš„æ˜¯å®ç°å°† org.eclipse.microprofile.faulttolerance.FallbackHandler è¿”å›ç±»å‹è®¾ç½®ä¸ºä¸å›é€€ç­–ç•¥æ–¹æ³•æä¾›çš„æ›¿ä»£ç±»å‹ç›¸åŒçš„æ¥å£ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå°† Rate è¿”å›é»˜è®¤å¯¹è±¡ã€‚\nimport org.eclipse.microprofile.faulttolerance.ExecutionContext; import org.eclipse.microprofile.faulttolerance.FallbackHandler; public class RatingServiceFallback implements FallbackHandler\u0026lt;Rate\u0026gt; { @Override public Rate handle(ExecutionContext context) { Rate rate = new Rate(); rate.rate = 0; return rate; } } æœ€åè¦åšçš„æ˜¯ç”¨æ³¨è§£å¯¹ getRating() æ–¹æ³•è¿›è¡Œ @org.eclipse.microprofile.faulttolerance.Fallback æ³¨è§£ï¼Œä»¥é…ç½®æ— æ³•æ¢å¤æ—¶è¦æ‰§è¡Œçš„å›é€€ç±»ã€‚\n@Retry(maxRetries = 3, delay = 1000) @Fallback(RatingServiceFallback.class) Rate getRate(@PathParam(\u0026#34;bookId\u0026#34;) Long bookId); å¦‚æœé‡å¤ä¸ä»¥å‰ç›¸åŒçš„è¯·æ±‚ï¼Œåˆ™ä¸ä¼šå¼•å‘ä»»ä½•å¼‚å¸¸ï¼Œä½†æ˜¯æœ‰æ•ˆå€¼çš„è¾“å‡ºå°† rating å­—æ®µè®¾ç½®ä¸º 0ã€‚\n* Connection #0 to host localhost left intact {\u0026#34;bookId\u0026#34;:2,\u0026#34;name\u0026#34;:\u0026#34;Book 2\u0026#34;,\u0026#34;rating\u0026#34;:0}* Closing connection 0 è§„èŒƒæä¾›çš„ä»»ä½•å…¶ä»–ç­–ç•¥éƒ½å¯ä»¥ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå¯¹äºæ–­è·¯å™¨æ¨¡å¼ï¼š\n@CircuitBreaker(requestVolumeThreshold = 4, failureRatio=0.75, delay = 1000) å¦‚æœåœ¨å››ä¸ªè¿ç»­è°ƒç”¨çš„æ»šåŠ¨çª—å£ä¸­å‘ç”Ÿäº†ä¸‰ä¸ªï¼ˆ4 x 0.75ï¼‰æ•…éšœï¼Œåˆ™ç”µè·¯å°†æ–­å¼€ 1000 msï¼Œç„¶åæ¢å¤åˆ°åŠæ–­å¼€çŠ¶æ€ã€‚å¦‚æœåœ¨åŠå¼€æ—¶è°ƒç”¨æˆåŠŸï¼Œåˆ™å°†å…¶å†æ¬¡å…³é—­ã€‚å¦åˆ™ï¼Œå®ƒå°†ä¿æŒæ‰“å¼€çŠ¶æ€\næ—¥å¿—è®°å½• åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå»ºè®®å°†æ‰€æœ‰æœåŠ¡çš„æ—¥å¿—æ”¶é›†åœ¨ä¸€ä¸ªç»Ÿä¸€çš„æ—¥å¿—ä¸­ï¼Œä»¥æ›´æœ‰æ•ˆåœ°ä½¿ç”¨å’Œç†è§£ã€‚\nä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ Fluentdï¼Œå®ƒæ˜¯ Kubernetes ä¸­ç”¨äºç»Ÿä¸€æ—¥å¿—è®°å½•å±‚çš„å¼€æºæ•°æ®æ”¶é›†å™¨ã€‚Quarkus ä½¿ç”¨ Graylog æ‰©å±•æ—¥å¿—æ ¼å¼ï¼ˆGELFï¼‰ä¸ Fluentd é›†æˆã€‚\né›†æˆçœŸçš„å¾ˆç®€å•ã€‚é¦–å…ˆï¼Œä¸å…¶ä»–ä»»ä½• Quarkus åº”ç”¨ç¨‹åºä¸€æ ·ä½¿ç”¨æ—¥å¿—é€»è¾‘ï¼š\nimport org.jboss.logging.Logger; private static final Logger LOG = Logger.getLogger(BookResource.class); @GET @Path(\u0026#34;/{bookId}\u0026#34;) @RolesAllowed(\u0026#34;Echoer\u0026#34;) @Produces(MediaType.APPLICATION_JSON) public Book book(@PathParam(\u0026#34;bookId\u0026#34;) Long bookId) { LOG.info(\u0026#34;Get Book\u0026#34;); æ¥ä¸‹æ¥ï¼Œå¯ç”¨ GELF æ ¼å¼å¹¶è®¾ç½® Fluentd æœåŠ¡å™¨ä½ç½®ï¼š\nquarkus.log.handler.gelf.enabled=true quarkus.log.handler.gelf.host=localhost quarkus.log.handler.gelf.port=12201 æœ€åï¼Œæˆ‘ä»¬å¯ä»¥å‘è®°å½•çš„ç«¯ç‚¹å‘å‡ºè¯·æ±‚ï¼š\ncurl -H \u0026#34;Authorization: Bearer ...\u0026#34; localhost:8080/book/1 {\u0026#34;bookId\u0026#34;:1,\u0026#34;name\u0026#34;:\u0026#34;Book 1\u0026#34;,\u0026#34;rating\u0026#34;:3} è¾“å‡ºæ–¹é¢æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œä½†æ˜¯æ—¥å¿—è¡Œå·²ä¼ è¾“åˆ° Fluentdã€‚å¦‚æœä½¿ç”¨ Kibana å¯è§†åŒ–æ•°æ®ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å­˜å‚¨çš„æ—¥å¿—è¡Œï¼š\nç›‘æ§ ç›‘æ§æ˜¯å¦ä¸€ä¸ªéœ€è¦åœ¨æˆ‘ä»¬çš„å¾®æœåŠ¡æ¶æ„ä¸­å®ç°çš„ â€œå¾®æœåŠ¡ç‰¹æ€§â€ã€‚Quarkus ä¸ Micrometer é›†æˆåœ¨ä¸€èµ·ä»¥è¿›è¡Œåº”ç”¨ç¨‹åºç›‘æ§ã€‚Micrometer æä¾›äº†æœ€æµè¡Œçš„ç›‘æ§ç³»ç»Ÿçš„å•ä¸ªå…¥å£ç‚¹ï¼Œä½¿ä½ æ— éœ€ä¾›åº”å•†é”å®šå³å¯æ£€æµ‹åŸºäº JVM çš„åº”ç”¨ç¨‹åºä»£ç ã€‚\nå¯¹äºæ­¤ç¤ºä¾‹ï¼Œç›‘æ§è¾“å‡ºé‡‡ç”¨ Prometheus æ ¼å¼ï¼Œä½† Micrometerï¼ˆå’Œ Quarkusï¼‰è¿˜æ”¯æŒå…¶ä»–æ ¼å¼ï¼Œä¾‹å¦‚ Azure Monitorã€Stackdriverã€SignalFxã€StatsD å’Œ DataDogã€‚\nä½ å¯ä»¥æ³¨å†Œä»¥ä¸‹ Maven ä¾èµ–é¡¹ä»¥æä¾› Prometheus è¾“å‡ºï¼š\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.quarkus\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;quarkus-micrometer-registry-prometheus\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; é»˜è®¤æƒ…å†µä¸‹ï¼ŒMicrometer æ‰©å±•æ³¨å†Œäº†ä¸€äº›ä¸ç³»ç»Ÿï¼ŒJVM æˆ– HTTP ç›¸å…³çš„åº¦é‡ã€‚æ”¶é›†çš„æŒ‡æ ‡çš„ä¸€ä¸ªå­é›†åœ¨ /q/metrics ç«¯ç‚¹å¤„å¯ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\ncurl localhost:8080/q/metrics jvm_threads_states_threads{state=\u0026#34;runnable\u0026#34;,} 22.0 jvm_threads_states_threads{state=\u0026#34;blocked\u0026#34;,} 0.0 jvm_threads_states_threads{state=\u0026#34;waiting\u0026#34;,} 10.0 http_server_bytes_read_count 1.0 http_server_bytes_read_sum 0.0 ä½†æ˜¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Micrometer API æ¥å®ç°ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„æŒ‡æ ‡ã€‚ è®©æˆ‘ä»¬å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æŒ‡æ ‡ï¼Œè¯¥æŒ‡æ ‡ç”¨äºè¡¡é‡è¯„ä»·æœ€é«˜çš„å›¾ä¹¦ã€‚\nä½¿ç”¨ io.micrometer.core.instrument.MeterRegistry è¯¥ç±»å¯ä»¥å®ŒæˆæŒ‡æ ‡ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ä¸ºé‡è§„ï¼‰çš„æ³¨å†Œã€‚\nprivate final MeterRegistry registry; private final LongAccumulator highestRating = new LongAccumulator(Long::max, 0); public BookResource(MeterRegistry registry) { this.registry = registry; registry.gauge(\u0026#34;book.rating.max\u0026#34;, this, BookResource::highestRatingBook); } è¯·æ±‚ä¸€ä¸‹ï¼Œå¹¶éªŒè¯é‡è§„æ˜¯å¦æ­£ç¡®æ›´æ–°ã€‚\ncurl -H \u0026#34;Authorization: Bearer ...\u0026#34; localhost:8080/book/1 {\u0026#34;bookId\u0026#34;:1,\u0026#34;name\u0026#34;:\u0026#34;Book 1\u0026#34;,\u0026#34;rating\u0026#34;:3} curl localhost:8080/q/metrics # HELP book_rating_max # TYPE book_rating_max gauge book_rating_max 3.0 æˆ‘ä»¬è¿˜å¯ä»¥è®¾ç½®ä¸€ä¸ªè®¡æ—¶å™¨æ¥è®°å½•ä»è¯„çº§æœåŠ¡è·å–è¯„çº§ä¿¡æ¯æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚\nSupplier\u0026lt;Rate\u0026gt; rateSupplier = () -\u0026gt; { return ratingService.getRate(bookId); }; final Rate rate = registry.timer(\u0026#34;book.rating.test\u0026#34;).wrap(rateSupplier).get(); è¯·æ±‚ä¸€ä¸‹ï¼Œå¹¶éªŒè¯æ”¶é›†è¯„ä»·â€‹â€‹æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚\n# HELP book_rating_test_seconds # TYPE book_rating_test_seconds summary book_rating_test_seconds_count 4.0 book_rating_test_seconds_sum 1.05489108 # HELP book_rating_test_seconds_max # TYPE book_rating_test_seconds_max gauge book_rating_test_seconds_max 1.018622001 Micrometer ä½¿ç”¨ MeterFilter å®ä¾‹æ¥è‡ªå®šä¹‰ MeterRegistry å®ä¾‹å‘å‡ºçš„åº¦é‡ã€‚Micrometer æ‰©å±•å°†æ£€æµ‹ MeterFilter CDI beanï¼Œå¹¶åœ¨åˆå§‹åŒ– MeterRegistry å®ä¾‹æ—¶ä½¿ç”¨å®ƒä»¬ã€‚\nä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªé€šç”¨æ ‡ç­¾æ¥è®¾ç½®è¿è¡Œåº”ç”¨ç¨‹åºçš„ç¯å¢ƒï¼ˆäº§å“ã€æµ‹è¯•ã€é¢„å‘å¸ƒç­‰ï¼‰ã€‚\n@Singleton public class MicrometerCustomConfiguration { @Produces @Singleton public MeterFilter configureAllRegistries() { return MeterFilter.commonTags(Arrays.asList( Tag.of(\u0026#34;env\u0026#34;, \u0026#34;prod\u0026#34;))); } } å‘é€æ–°è¯·æ±‚å¹¶éªŒè¯æŒ‡æ ‡æ˜¯å¦å·²æ ‡è®°ã€‚\nhttp_client_requests_seconds_max{clientName=\u0026#34;localhost\u0026#34;,env=\u0026#34;prod\u0026#34;,method=\u0026#34;GET\u0026#34;,outcome=\u0026#34;SUCCESS\u0026#34;,status=\u0026#34;200\u0026#34;,uri=\u0026#34;/rate/2\u0026#34;,} 0.0 è¯·æ³¨æ„ env åŒ…å«å€¼ä¸º prod çš„æ ‡ç­¾ã€‚\nè·Ÿè¸ª Quarkus åº”ç”¨ç¨‹åºåˆ©ç”¨ OpenTracing è§„èŒƒä¸ºäº¤äº’å¼ Web åº”ç”¨ç¨‹åºæä¾›åˆ†å¸ƒå¼è·Ÿè¸ªã€‚\nè®©æˆ‘ä»¬é…ç½® OpenTracing ä»¥è¿æ¥åˆ° Jaeger æœåŠ¡å™¨ï¼Œå°† book-service è®¾ç½®ä¸ºæœåŠ¡åç§°ä»¥æ ‡è¯†è·Ÿè¸ªï¼š\nquarkus.jaeger.enabled=true quarkus.jaeger.endpoint=http://localhost:14268/api/traces quarkus.jaeger.service-name=book-service quarkus.jaeger.sampler-type=const quarkus.jaeger.sampler-param=1 ç°åœ¨å‘ä¸€ä¸ªè¯·æ±‚ï¼š\ncurl -H \u0026#34;Authorization: Bearer ...\u0026#34; localhost:8080/book/1 {\u0026#34;bookId\u0026#34;:1,\u0026#34;name\u0026#34;:\u0026#34;Book 1\u0026#34;,\u0026#34;rating\u0026#34;:3} è®¿é—®Jaeger UIä»¥éªŒè¯æ˜¯å¦è·Ÿè¸ªäº†è¯¥è°ƒç”¨ï¼š\næ€»ç»“ ä¸å¼€å‘æ•´ä½“åº”ç”¨ç¨‹åºç›¸æ¯”ï¼Œå¼€å‘å’Œå®ç°å¾®æœåŠ¡ä½“ç³»ç»“æ„æ›´å…·æŒ‘æˆ˜æ€§ã€‚æˆ‘ä»¬è®¤ä¸ºï¼Œå¾®æœåŠ¡å¯ä»¥é©±åŠ¨ä½ æ ¹æ®åº”ç”¨ç¨‹åºåŸºç¡€ç»“æ„æ­£ç¡®åœ°å¼€å‘æœåŠ¡ã€‚\næ­¤å¤„ä»‹ç»çš„å¤§å¤šæ•°å¾®æœåŠ¡ï¼ˆAPI å’Œç®¡é“é™¤å¤–ï¼‰æ˜¯æ–°çš„ï¼Œæˆ–è€…åœ¨æ•´ä½“åº”ç”¨ä¸­å®ç°æ–¹å¼æœ‰æ‰€ä¸åŒã€‚åŸå› æ˜¯ç°åœ¨åº”ç”¨ç¨‹åºè¢«åˆ†è§£æˆå‡ éƒ¨åˆ†ï¼Œæ‰€æœ‰éƒ¨åˆ†éƒ½åœ¨ç½‘ç»œä¸­äº’è¿ã€‚\nå¦‚æœä½ May 26, 2021æ‰“ç®—å¼€å‘å¾®æœåŠ¡å¹¶å°†å…¶éƒ¨ç½²åˆ° Kubernetesï¼Œé‚£ä¹ˆ Quarkus æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºå®ƒå¯ä»¥ä¸ Kubernetes é¡ºåˆ©é›†æˆã€‚å®æ–½å¤§å¤šæ•°å¾®æœåŠ¡å¾ˆç®€å•ï¼Œåªéœ€è¦å‡ è¡Œä»£ç ã€‚\næœ¬æ–‡æ¼”ç¤ºçš„æºä»£ç å¯ä»¥åœ¨ github ä¸Šæ‰¾åˆ°ã€‚\nå…³äºä½œè€… Alex Soto æ˜¯ Red Hat å¼€å‘äººå‘˜ç»éªŒæ€»ç›‘ã€‚ä»–å¯¹ Java ä¸–ç•Œï¼Œè½¯ä»¶è‡ªåŠ¨åŒ–å……æ»¡çƒ­æƒ…ï¼Œå¹¶ä¸”ä»–ç›¸ä¿¡å¼€æºè½¯ä»¶æ¨¡å‹ã€‚Soto æ˜¯ Manning çš„åˆè‘—è€… | æµ‹è¯• Java å¾®æœåŠ¡å’Œ O\u0026rsquo;Reilly Quarkus Cookbook å’Œå‡ ä¸ªå¼€æºé¡¹ç›®çš„è´¡çŒ®è€…ã€‚è‡ª 2017 å¹´ä»¥æ¥ä¸€ç›´æ˜¯ Java å† å†›ï¼Œä»–è¿˜æ˜¯ Salle URL University çš„å›½é™…æ¼”è®²è€…å’Œè€å¸ˆã€‚ä½ å¯ä»¥åœ¨ Twitter ï¼ˆAlex Sotoï¼‰ä¸Šå…³æ³¨ä»–ï¼Œä»¥éšæ—¶äº†è§£ Kubernetes å’Œ Java ä¸–ç•Œä¸­æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/microservicilities-quarkus/","tags":["Quarkus","Java"],"title":"ä½¿ç”¨ Quarkus å’Œ MicroProfile å®ç°å¾®æœåŠ¡ç‰¹æ€§"},{"categories":["äº‘åŸç”Ÿ"],"contents":"åœ¨é…ç½®ç³»ç»Ÿç›‘æ§çš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯å³ä½¿ç»å°½è„‘æ±ç›‘æ§çš„ä¹Ÿè¿˜æ˜¯ä¸å¤Ÿå…¨é¢ï¼Œæˆ–è€…ä¸çŸ¥å¦‚ä½•è·å–æƒ³è¦çš„æŒ‡æ ‡ã€‚\nAwesome Prometheus alerts ç»´æŠ¤äº†ä¸€å¥—å¼€ç®±å³ç”¨çš„ Prometheus å‘Šè­¦è§„åˆ™é›†åˆï¼Œæœ‰ 300 å¤šä¸ªå‘Šè­¦è§„åˆ™ã€‚åŒæ—¶ï¼Œè¿˜æ˜¯è¯´æ˜å¦‚ä½•è·å–å¯¹åº”çš„æŒ‡æ ‡ã€‚è¿™äº›è§„åˆ™ï¼Œå¯¹æ¯ä¸ª Prometheus éƒ½æ˜¯é€šç”¨çš„ã€‚\næ¶‰åŠå¦‚ä¸»æœºã€ç¡¬ä»¶ã€å®¹å™¨ç­‰åŸºç¡€èµ„æºï¼Œåˆ°æ•°æ®åº“ã€æ¶ˆæ¯ä»£ç†ã€è¿è¡Œæ—¶ã€åå‘ä»£ç†ã€è´Ÿè´£å‡è¡¡å™¨ï¼Œè¿è¡Œæ—¶ã€æœåŠ¡ç¼–æ’ï¼Œç”šè‡³æ˜¯ç½‘ç»œå±‚é¢å’Œ Prometheus è‡ªèº«å’Œé›†ç¾¤ã€‚\nPrometheus çš„å®‰è£…å’Œé…ç½®ä¸åšèµ˜è¿°ï¼Œé…ç½®å¯ä»¥çœ‹è¿™é‡Œã€‚ä¸‹é¢ç®€å•çœ‹ä¸‹å‡ ä¸ªå¸¸ç”¨è§„åˆ™\nä¸»æœºå’Œç¡¬ä»¶èµ„æº ä¸»æœºå’Œç¡¬ä»¶èµ„æºçš„å‘Šè­¦ä¾èµ– node-exporter è¾“å‡ºçš„æŒ‡æ ‡ã€‚ä¾‹å¦‚ï¼š\nå†…å­˜ä¸è¶³ å¯ç”¨å†…å­˜ä½äºé˜ˆå€¼ 10% å°±ä¼šè§¦å‘å‘Šè­¦ã€‚\n- alert: HostOutOfMemory expr: node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100 \u0026lt; 10 for: 2m labels: severity: warning annotations: summary: Host out of memory (instance {{ $labels.instance }}) description: \u0026#34;Node memory is filling up (\u0026lt; 10% left)\\n VALUE = {{ $value }}\\n LABELS = {{ $labels }}\u0026#34; ä¸»æœºå¼‚å¸¸çš„ç½‘ç»œåå æœ€è¿‘ä¸¤åˆ†é’Ÿå…¥ç«™çš„æµé‡è¶…è¿‡ 100mã€‚\nrate è¯­æ³•è§è¿™é‡Œã€‚\n- alert: HostUnusualNetworkThroughputIn expr: sum by (instance) (rate(node_network_receive_bytes_total[2m])) / 1024 / 1024 \u0026gt; 100 for: 5m labels: severity: warning annotations: summary: Host unusual network throughput in (instance {{ $labels.instance }}) description: \u0026#34;Host network interfaces are probably receiving too much data (\u0026gt; 100 MB/s)\\n VALUE = {{ $value }}\\n LABELS = {{ $labels }}\u0026#34; Mysql Mysql çš„å‘Šè­¦ä¾èµ– prometheus/mysqld_exporter è¾“å‡ºçš„æŒ‡æ ‡ã€‚\nè¿æ¥æ•°è¿‡å¤š Mysql å®ä¾‹çš„è¿æ¥æ•°æœ€è¿‘ä¸€åˆ†é’Ÿçš„è¿æ¥æ•°è¶…è¿‡æœ€å¤§å€¼çš„ 80% è§¦å‘å‘Šè­¦\n- alert: MysqlTooManyConnections(\u0026gt;80%) expr: avg by (instance) (rate(mysql_global_status_threads_connected[1m])) / avg by (instance) (mysql_global_variables_max_connections) * 100 \u0026gt; 80 for: 2m labels: severity: warning annotations: summary: MySQL too many connections (\u0026gt; 80%) (instance {{ $labels.instance }}) description: \u0026#34;More than 80% of MySQL connections are in use on {{ $labels.instance }}\\n VALUE = {{ $value }}\\n LABELS = {{ $labels }}\u0026#34; æ…¢æŸ¥è¯¢ æœ€è¿‘ä¸€åˆ†é’Ÿæ…¢æŸ¥è¯¢æ•°é‡å¤§äº 0 æ—¶è§¦å‘ã€‚\n- alert: MysqlSlowQueries expr: increase(mysql_global_status_slow_queries[1m]) \u0026gt; 0 for: 2m labels: severity: warning annotations: summary: MySQL slow queries (instance {{ $labels.instance }}) description: \u0026#34;MySQL server mysql has some new slow query.\\n VALUE = {{ $value }}\\n LABELS = {{ $labels }}\u0026#34; è¿è¡Œæ—¶ JVM JVM çš„è¿è¡Œæ—¶å‘Šè­¦ï¼Œå±…ç„¶åªæœ‰å¯æ€œå·´å·´çš„ä¸€ä¸ªã€‚å †ç©ºé—´å ç”¨è¶…è¿‡ 80% è§¦å‘å‘Šè­¦ã€‚\nä¾èµ– java-client è¾“å‡ºçš„æŒ‡æ ‡ã€‚\n- alert: JvmMemoryFillingUp expr: (sum by (instance)(jvm_memory_used_bytes{area=\u0026#34;heap\u0026#34;}) / sum by (instance)(jvm_memory_max_bytes{area=\u0026#34;heap\u0026#34;})) * 100 \u0026gt; 80 for: 2m labels: severity: warning annotations: summary: JVM memory filling up (instance {{ $labels.instance }}) description: \u0026#34;JVM memory is filling up (\u0026gt; 80%)\\n VALUE = {{ $value }}\\n LABELS = {{ $labels }}\u0026#34; Kubernetes Kubernetes ç›¸å…³çš„å‘Šè­¦è§„åˆ™æœ‰ 33 ä¸ªï¼Œæ¯”è¾ƒä¸°å¯Œã€‚\næ‘˜ä¸ªæ¯”è¾ƒå¸¸è§çš„ï¼šå®¹å™¨OOMå‘Šè­¦ã€‚\n- alert: KubernetesContainerOomKiller expr: (kube_pod_container_status_restarts_total - kube_pod_container_status_restarts_total offset 10m \u0026gt;= 1) and ignoring (reason) min_over_time(kube_pod_container_status_last_terminated_reason{reason=\u0026#34;OOMKilled\u0026#34;}[10m]) == 1 for: 0m labels: severity: warning annotations: summary: Kubernetes container oom killer (instance {{ $labels.instance }}) description: \u0026#34;Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} has been OOMKilled {{ $value }} times in the last 10 minutes.\\n VALUE = {{ $value }}\\n LABELS = {{ $labels }}\u0026#34; SSL è¯ä¹¦è¿‡æœŸ é€šè¿‡ è¾“å‡ºçš„æŒ‡æ ‡ï¼Œå¯ä»¥ç›‘æ§è¯ä¹¦è¿‡æœŸï¼šæœªæ¥ 7 å¤© æœ‰è¯ä¹¦è¿‡æœŸä¾¿ä¼šè§¦å‘å‘Šè­¦ã€‚\n- alert: SslCertificateExpiry(\u0026lt;7Days) expr: ssl_verified_cert_not_after{chain_no=\u0026#34;0\u0026#34;} - time() \u0026lt; 86400 * 7 for: 0m labels: severity: warning annotations: summary: SSL certificate expiry (\u0026lt; 7 days) (instance {{ $labels.instance }}) description: \u0026#34;{{ $labels.instance }} Certificate is expiring in 7 days\\n VALUE = {{ $value }}\\n LABELS = {{ $labels }}\u0026#34; ä»Šå¤©åˆ—å‡ºæ¥çš„ä¹Ÿä»…ä»…æ˜¯å†°å±±ä¸€è§’ï¼Œè€Œä¸”ç”¨æˆ·ä¹Ÿå¯ä»¥è´¡çŒ®å‡ºæ›´å¤šçš„è§„åˆ™ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/introduction-awesome-prometheus-alerts/","tags":["Prometheus"],"title":"å¼€ç®±å³ç”¨çš„ Prometheus å‘Šè­¦è§„åˆ™é›†"},{"categories":["æºç è§£æ"],"contents":"å»å¹´å†™è¿‡ä¸€ç¯‡åšå®¢ï¼šæ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåºï¼Œåˆ†æäº† TektonCD çš„å®¹å™¨å¯åŠ¨æ§åˆ¶çš„åŸç†ã€‚\nä¸ºä»€ä¹ˆè¦åšå®¹å™¨å¯åŠ¨é¡ºåºæ§åˆ¶ï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“ Pod ä¸­é™¤äº† init-container ä¹‹å¤–ï¼Œæ˜¯å…è®¸æ·»åŠ å¤šä¸ªå®¹å™¨çš„ã€‚ç±»ä¼¼ TektonCD ä¸­ task å’Œ step çš„æ¦‚å¿µå°±åˆ†åˆ«ä¸ pod å’Œ container å¯¹åº”ï¼Œè€Œ step æ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œçš„ã€‚æ­¤å¤–è¿˜æœ‰æœåŠ¡ç½‘æ ¼çš„åœºæ™¯ï¼Œsidecar å®¹å™¨éœ€è¦åœ¨æœåŠ¡å®¹å™¨å¯åŠ¨ä¹‹å‰å®Œæˆé…ç½®çš„åŠ è½½ï¼Œä¹Ÿéœ€è¦å¯¹å®¹å™¨çš„å¯åŠ¨é¡ºåºåŠ ä»¥æ§åˆ¶ã€‚å¦åˆ™ï¼ŒæœåŠ¡å®¹å™¨å…ˆå¯åŠ¨ï¼Œè€Œ sidecar è¿˜æ— æ³•æä¾›ç½‘ç»œä¸Šçš„æ”¯æŒã€‚\nç°å® æœŸæœ› åˆ°äº†è¿™é‡Œè‚¯å®šæœ‰åŒå­¦ä¼šé—®ï¼Œspec.containers[] æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„æ˜¯æœ‰é¡ºåºçš„ã€‚Kubernetes ä¹Ÿç¡®å®æ˜¯æŒ‰ç…§é¡ºåºæ¥åˆ›å»ºå’Œå¯åŠ¨å®¹å™¨ï¼Œä½†æ˜¯ å®¹å™¨å¯åŠ¨æˆåŠŸï¼Œå¹¶ä¸è¡¨ç¤ºå®¹å™¨å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡ã€‚\nåœ¨ Kubernetes 1.18 éæ­£å¼ç‰ˆä¸­æ›¾åœ¨ Lifecycle å±‚é¢æä¾›äº†å¯¹ sidecar ç±»å‹å®¹å™¨çš„ æ”¯æŒï¼Œä½†æ˜¯æœ€ç»ˆè¯¥åŠŸèƒ½å¹¶æ²¡æœ‰è½åœ°ã€‚\né‚£åˆ°åº•è¯¥æ€ä¹ˆåšï¼Ÿ\nTL;DR ç¬”è€…å‡†å¤‡äº†ä¸€ä¸ªç®€å•çš„ go é¡¹ç›®ï¼Œç”¨äºæ¨¡æ‹Ÿ sidecar çš„å¯åŠ¨åŠé…ç½®åŠ è½½ã€‚\nå…‹éš†ä»£ç åå¯ä»¥é€šè¿‡ make build æ„å»ºå‡ºé•œåƒï¼Œå‡å¦‚ä½ æ˜¯ç”¨çš„ minikube è¿›è¡Œçš„å®éªŒï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ make load-2-minikube å°†é•œåƒåŠ è½½åˆ° minikube èŠ‚ç‚¹ä¸­ã€‚\nä½¿ç”¨ Deployment çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ï¼Œç›´æ¥ç”¨ Pod ä¹Ÿå¯ä»¥ã€‚\napiVersion: apps/v1 kind: Deployment metadata: creationTimestamp: null labels: app: sample name: sample spec: replicas: 1 selector: matchLabels: app: sample strategy: {} template: metadata: creationTimestamp: null labels: app: sample spec: containers: - image: addozhang/k8s-container-sequence-sidecar:latest name: sidecar imagePullPolicy: IfNotPresent lifecycle: postStart: exec: command: - /entrypoint - wait - image: busybox:latest name: app imagePullPolicy: IfNotPresent command: [\u0026#34;/bin/sh\u0026#34;,\u0026#34;-c\u0026#34;] args: [\u0026#34;date; echo \u0026#39;app container started\u0026#39;; tail -f /dev/null\u0026#34;] ä¸‹é¢çš„æˆªå›¾ä¸­ï¼Œæ¼”ç¤ºäº†åœ¨ sample å‘½åç©ºé—´ä¸­ï¼Œpod å†…ä¸¤ä¸ªå®¹å™¨çš„æ‰§è¡Œé¡ºåºã€‚\nKubernetes æºç  åœ¨ kubelet çš„æºç  pkg/kubelet/kuberuntime/kuberuntime_manager.go ä¸­ï¼Œ#SyncPod æ–¹æ³•ç”¨äºåˆ›å»º Podï¼Œæ­¥éª¤æ¯”è¾ƒç¹çï¼Œç›´æ¥çœ‹ç¬¬ 7 æ­¥ï¼šåˆ›å»ºæ™®é€šå®¹å™¨ã€‚\n// SyncPod syncs the running pod into the desired pod by executing following steps: // // 1. Compute sandbox and container changes. // 2. Kill pod sandbox if necessary. // 3. Kill any containers that should not be running. // 4. Create sandbox if necessary. // 5. Create ephemeral containers. // 6. Create init containers. // 7. Create normal containers. func (m *kubeGenericRuntimeManager) SyncPod(pod *v1.Pod, podStatus *kubecontainer.PodStatus, pullSecrets []v1.Secret, backOff *flowcontrol.Backoff) (result kubecontainer.PodSyncResult) { ... // Step 7: start containers in podContainerChanges.ContainersToStart. for _, idx := range podContainerChanges.ContainersToStart { start(\u0026#34;container\u0026#34;, containerStartSpec(\u0026amp;pod.Spec.Containers[idx])) } return } åœ¨ #start æ–¹æ³•ä¸­è°ƒç”¨äº† #startContainer æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå¯åŠ¨å®¹å™¨ï¼Œå¹¶è¿”å›å®¹å™¨å¯åŠ¨çš„ç»“æœã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ç»“æœè¿˜ åŒ…å«äº†å®¹å™¨çš„ Lifecycle hooks è°ƒç”¨ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚å®¹å™¨çš„ PostStart hook æ²¡æœ‰æ­£ç¡®çš„è¿”å›ï¼Œkubelet ä¾¿ä¸ä¼šå»åˆ›å»ºä¸‹ä¸€ä¸ªå®¹å™¨ã€‚\n// startContainer starts a container and returns a message indicates why it is failed on error. // It starts the container through the following steps: // * pull the image // * create the container // * start the container // * run the post start lifecycle hooks (if applicable) func (m *kubeGenericRuntimeManager) startContainer(podSandboxID string, podSandboxConfig *runtimeapi.PodSandboxConfig, spec *startSpec, pod *v1.Pod, podStatus *kubecontainer.PodStatus, pullSecrets []v1.Secret, podIP string, podIPs []string) (string, error) { ... // Step 4: execute the post start hook. if container.Lifecycle != nil \u0026amp;\u0026amp; container.Lifecycle.PostStart != nil { kubeContainerID := kubecontainer.ContainerID{ Type: m.runtimeName, ID: containerID, } msg, handlerErr := m.runner.Run(kubeContainerID, pod, container, container.Lifecycle.PostStart) if handlerErr != nil { m.recordContainerEvent(pod, container, kubeContainerID.ID, v1.EventTypeWarning, events.FailedPostStartHook, msg) if err := m.killContainer(pod, kubeContainerID, container.Name, \u0026#34;FailedPostStartHook\u0026#34;, reasonFailedPostStartHook, nil); err != nil { klog.ErrorS(fmt.Errorf(\u0026#34;%s: %v\u0026#34;, ErrPostStartHook, handlerErr), \u0026#34;Failed to kill container\u0026#34;, \u0026#34;pod\u0026#34;, klog.KObj(pod), \u0026#34;podUID\u0026#34;, pod.UID, \u0026#34;containerName\u0026#34;, container.Name, \u0026#34;containerID\u0026#34;, kubeContainerID.String()) } return msg, fmt.Errorf(\u0026#34;%s: %v\u0026#34;, ErrPostStartHook, handlerErr) } } return \u0026#34;\u0026#34;, nil } å®ç°æ–¹æ¡ˆ cmd/entrypoint/wait.go#L26 ï¼ˆè¿™é‡Œå‚è€ƒäº† Istio çš„ pilot-agent å®ç° ï¼‰\nåœ¨ PostStart ä¸­æŒç»­çš„å»æ£€æŸ¥ /ready æ–­ç‚¹ï¼Œå¯ä»¥ hold ä½å½“å‰å®¹å™¨çš„åˆ›å»ºæµç¨‹ã€‚ä¿è¯ /ready è¿”å› 200 åï¼Œkubelet æ‰ä¼šå»åˆ›å»ºä¸‹ä¸€ä¸ªå®¹å™¨ã€‚\nè¿™æ ·å°±è¾¾åˆ°äº†å‰é¢æˆªå›¾ä¸­æ¼”ç¤ºçš„æ•ˆæœã€‚\nfor time.Now().Before(timeoutAt) { err = checkIfReady(client, url) if err == nil { log.Println(\u0026#34;sidecar is ready\u0026#34;) return nil } log.Println(\u0026#34;sidecar is not ready\u0026#34;) time.Sleep(time.Duration(periodMillis) * time.Millisecond) } return fmt.Errorf(\u0026#34;sidecar is not ready in %d second(s)\u0026#34;, timeoutSeconds) å‚è€ƒ Sidecar container lifecycle changes in Kubernetes 1.18 Delaying application start until sidecar is ready ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/k8s-1.18-container-start-sequence-control/","tags":["Kubernetes","Istio"],"title":"Kubernetes ä¸Šå¦‚ä½•æ§åˆ¶å®¹å™¨çš„å¯åŠ¨é¡ºåºï¼Ÿ"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬æ–‡ç”± Addo Zhang ç¿»è¯‘è‡ª A Reference Architecture for Fine-Grained Access Management on the Cloud\nä»€ä¹ˆæ˜¯è®¿é—®ç®¡ç†ï¼Ÿ è®¿é—®ç®¡ç†æ˜¯è¯†åˆ«ç”¨æˆ·æˆ–ä¸€ç»„ç”¨æˆ·æ˜¯å¦åº”è¯¥èƒ½å¤Ÿè®¿é—®ç»™å®šèµ„æºï¼ˆä¾‹å¦‚ä¸»æœºã€æœåŠ¡æˆ–æ•°æ®åº“ï¼‰çš„è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼Œå¯¹äºå¼€å‘äººå‘˜æ¥è¯´æ˜¯å¦å¯ä»¥ä½¿ç”¨ SSH ç™»å½•ç”Ÿäº§åº”ç”¨ç¨‹åºæœåŠ¡å™¨ï¼Œå¦‚æœå¯ä»¥ï¼Œé‚£ä¹ˆå¯ä»¥ç™»å½•å¤šé•¿æ—¶é—´ï¼Ÿå¦‚æœ SRE åœ¨éæ”¯æŒæ—¶é—´å°è¯•è®¿é—®æ•°æ®åº“ï¼Œä»–ä»¬è¿™æ ·åšï¼Ÿå¦‚æœæ•°æ®å·¥ç¨‹å¸ˆå·²è½¬ç§»åˆ°å…¶ä»–å›¢é˜Ÿï¼Œä»–ä»¬æ˜¯å¦åº”è¯¥ç»§ç»­è®¿é—® ETL ç®¡é“çš„ S3 å­˜å‚¨æ¡¶ï¼Ÿ\nç°åœ¨å¦‚ä½•è¿›è¡Œè®¿é—®ç®¡ç†ï¼Ÿ åœ¨äº‘ä¸Šå„ç§åŸºç¡€è®¾æ–½å’Œæ•°æ®æœåŠ¡æ¿€å¢ä¹‹å‰ï¼Œè®¿é—®ç®¡ç†æ˜¯ DevOps å’Œ Security å›¢é˜Ÿè¦è§£å†³çš„ç›¸å¯¹ç®€å•çš„é—®é¢˜ã€‚VPN å’Œå ¡å’ä¸»æœºæ˜¯ï¼ˆç°åœ¨ä»ç„¶æ˜¯ï¼‰åœ¨ç½‘ç»œçº§åˆ«å°é”æ‰€æœ‰å…³é”®èµ„æºçš„é¦–é€‰æœºåˆ¶ã€‚ç”¨æˆ·å¿…é¡»å…ˆé€šè¿‡ VPN æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ï¼Œæˆ–è€…ç™»å½•åˆ°å ¡å’ä¸»æœºï¼Œç„¶åæ‰èƒ½è®¿é—®ä¸“ç”¨ç½‘ç»œä¸Šçš„æ‰€æœ‰èµ„æºã€‚\nå½“èµ„æºæ˜¯é™æ€çš„å¹¶ä¸”å®ƒä»¬çš„æ•°é‡ç›¸å¯¹è¾ƒå°æ—¶ï¼Œæ­¤æ–¹æ³•æ•ˆæœå¾ˆå¥½ã€‚ä½†æ˜¯ï¼Œéšç€è¶Šæ¥è¶Šå¤šçš„èµ„æºåŠ¨æ€åœ°æ¶Œå…¥ä¸“ç”¨ç½‘ç»œçš„å„å¤„ï¼ŒVPN / å ¡å’ä¸»æœºè§£å†³æ–¹æ¡ˆå˜å¾—ç«™ä¸ä½è„šã€‚\nå…·ä½“æ¥è¯´ï¼Œåœ¨ä¸‰ä¸ªæ–¹é¢ï¼ŒVPN å’Œå ¡å’ä¸»æœºä¸è¶³ä»¥ä½œä¸ºä¸€ç§æœ‰æ•ˆçš„è®¿é—®ç®¡ç†æœºåˆ¶ã€‚\nå®ƒä»¬ä½œç”¨äºç½‘ç»œå±‚é¢ï¼šç”¨æˆ·é€šè¿‡ VPN è¿›è¡Œèº«ä»½éªŒè¯å¹¶è·å¾—å¯¹ä¸“ç”¨ç½‘ç»œçš„è®¿é—®æƒé™åï¼Œä»–ä»¬å®é™…ä¸Šå°±å¯ä»¥è®¿é—®å…¶ä¸Šè¿è¡Œçš„æ‰€æœ‰æœåŠ¡ã€‚æ— æ³•æ ¹æ®ç”¨æˆ·çš„èº«ä»½åœ¨åŸºç¡€æ¶æ„æˆ–æ•°æ®æœåŠ¡çš„ç²’åº¦ä¸Šç®¡ç†è®¿é—®ã€‚ å‡­æ®æ˜¯æ”»å‡»çš„åª’ä»‹ï¼šVPN å’Œå ¡å’ä¸»æœºéƒ½è¦æ±‚ç”¨æˆ·è®°ä½å¹¶å­˜å‚¨å‡­æ®ã€‚è¿‡æœŸå’Œè½®æ¢å‡­è¯ä½œä¸ºå®‰å…¨ç­–ç•¥éå¸¸å›°éš¾ï¼Œå°¤å…¶æ˜¯åœ¨æ¶‰åŠå¤§é‡ç”¨æˆ·çš„æƒ…å†µä¸‹ï¼Œå‡­è¯å› æ­¤æˆä¸ºæ½œåœ¨çš„æ”»å‡»åª’ä»‹ã€‚ ä¸èƒ½ç®¡ç†ç¬¬ä¸‰æ–¹ SaaS å·¥å…·ï¼šSaaS å·¥å…·ï¼ˆå¦‚ Lookerã€Tableau å’Œ Periscope Dataï¼‰éœ€è¦ç›´æ¥è®¿é—®æ•°æ®ç«¯ç‚¹ã€‚å› æ­¤ï¼Œä½¿ç”¨è¿™äº›å·¥å…·è®¿é—®æ•°æ®çš„ä»»ä½•äººéƒ½æ— æ³•é€šè¿‡ä½¿ç”¨äº†ç›¸åŒçš„æœºåˆ¶å’Œå‡­æ®çš„åŸºç¡€è®¾æ–½è¿›è¡Œèº«ä»½éªŒè¯ã€‚ äº‘ä¸Šè®¿é—®ç®¡ç†çš„æ–°æ¶æ„ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å®šä¹‰æ–°çš„å‚è€ƒæ¶æ„ï¼Œä¸ºé‚£äº›æ­£åœ¨å¯»æ±‚ç®€åŒ–è®¿é—®ç®¡ç†äº‘èµ„æºï¼ˆä» SSH ä¸»æœºã€æ•°æ®åº“ã€æ•°æ®ä»“åº“åˆ°æ¶ˆæ¯ç®¡é“å’Œäº‘å­˜å‚¨ç»ˆç»“ç‚¹ï¼‰è§£å†³æ–¹æ¡ˆçš„äº‘åŸç”Ÿä¼ä¸šã€‚\nå®ƒè§£å†³äº† VPN å’Œå ¡å’ä¸»æœºæ— æ³•å…‹æœçš„ä»¥ä¸‹ç‰¹å®šæŒ‘æˆ˜ï¼š\nåœ¨ç»†ç²’åº¦çš„æœåŠ¡çº§åˆ«ä¸Šè¿›è¡Œè®¿é—®é‰´æƒ æ¶ˆé™¤å…±äº«å‡­æ®å’Œä¸ªäººå¸æˆ·ç®¡ç† é€šè¿‡ç¬¬ä¸‰æ–¹ SaaS å·¥å…·æ§åˆ¶è®¿é—® æ­¤å¤–ï¼Œå®ƒä¸ºå…·æœ‰æ•æ„Ÿæ•°æ®çš„ç»„ç»‡å¸¦æ¥ä»¥ä¸‹å•†ä¸šåˆ©ç›Šï¼š\né€šè¿‡è·¨æ‰€æœ‰æœåŠ¡çš„ä¼šè¯è®°å½•å’Œæ´»åŠ¨ç›‘è§†æ¥æ»¡è¶³ FedRamp å’Œ SOC2 ç­‰åˆè§„æ€§æ ‡å‡†çš„å¯å®¡æ ¸æ€§ åŸºäºè®¿é—®è€…çš„èº«ä»½ï¼Œé€šè¿‡ç»†ç²’åº¦çš„æˆæƒç­–ç•¥æ¥é™åˆ¶æˆ–æ¸…é™¤æ•æ„Ÿæ•°æ®ï¼Œä»è€Œå®ç°éšç§å’Œæ•°æ®æ²»ç† è¯¥æ¶æ„å»ºç«‹åœ¨ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒåŸåˆ™çš„åŸºç¡€ä¸Šï¼Œè¿™äº›åŸåˆ™çš„å®ç°ä½¿ DevOps å’Œ Security å›¢é˜Ÿå¯ä»¥åœ¨å¯¹æ‰€æœ‰ç¯å¢ƒè¿›è¡Œå…¨é¢æ§åˆ¶çš„åŒæ—¶ï¼Œé€šè¿‡ç®€å•è€Œä¸€è‡´çš„ä½“éªŒæ¥æé«˜ç”¨æˆ·çš„å·¥ä½œæ•ˆç‡ã€‚\nä¸ºè®¿é—®èµ„æºçš„ç”¨æˆ·å»ºç«‹ä¸å¯å¦è®¤çš„èº«ä»½ ä½¿ç”¨çŸ­æœŸçš„çŸ­æš‚ä»¤ç‰Œå’Œè¯ä¹¦ä»£æ›¿é™æ€å‡­è¯å’Œå¯†é’¥ åœ¨ä¸€å¤„é›†ä¸­æ‰€æœ‰èµ„æºç±»å‹çš„ç»†ç²’åº¦è®¿é—®ç­–ç•¥ ä¸‹å›¾æ˜¾ç¤ºäº†å‚è€ƒæ¶æ„åŠå…¶ç»„ä»¶ã€‚\nä¸Šå›¾ä¸­çš„ VPN / å ¡å’ä¸»æœºå·²æ›¿æ¢ä¸ºæ¥å…¥ç½‘å…³ï¼ˆAccess Gatewayï¼‰ã€‚æ¥å…¥ç½‘å…³å®é™…ä¸Šæ˜¯å¾®æœåŠ¡çš„é›†åˆï¼Œè´Ÿè´£éªŒè¯å•ä¸ªç”¨æˆ·ã€åŸºäºç‰¹å®šå±æ€§æˆæƒä»–ä»¬çš„è¯·æ±‚ï¼Œå¹¶æœ€ç»ˆæˆäºˆä»–ä»¬è®¿é—®ä¸“ç”¨ç½‘ç»œä¸­çš„åŸºç¡€ç»“æ„å’Œæ•°æ®æœåŠ¡çš„æƒé™ã€‚\næ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å„ä¸ªç»„ä»¶ï¼Œä»¥äº†è§£ä¹‹å‰æ¦‚æ‹¬çš„æ ¸å¿ƒåŸç†æ˜¯å¦‚ä½•å®ç°çš„ã€‚\nè®¿é—®æ§åˆ¶å™¨ æ”¯æŒæ­¤ä½“ç³»ç»“æ„çš„å…³é”®è§è§£æ˜¯å°†ç”¨æˆ·èº«ä»½éªŒè¯å§”æ´¾ç»™å•ä¸ªæœåŠ¡ï¼ˆè®¿é—®æ§åˆ¶å™¨ï¼‰ï¼Œè€Œä¸æ˜¯å°†è´£ä»»åˆ†é…ç»™ç”¨æˆ·å¯èƒ½éœ€è¦è®¿é—®çš„æœåŠ¡ã€‚è¿™ç§è”åˆåœ¨ SaaS åº”ç”¨ç¨‹åºä¸–ç•Œä¸­å¾ˆå¸¸è§ã€‚ç”±å•ä¸€æœåŠ¡è´Ÿè´£èº«ä»½éªŒè¯ï¼Œå¯ä»¥ç®€åŒ–åº”ç”¨ç¨‹åºæ‰€æœ‰è€…çš„ç”¨æˆ·é…ç½®å’Œæ¥è§¦é…ç½®ï¼Œå¹¶åŠ å¿«åº”ç”¨ç¨‹åºå¼€å‘ã€‚\nå¯¹äºå®é™…çš„èº«ä»½éªŒè¯åºåˆ—ï¼Œè®¿é—®æ§åˆ¶å™¨æœ¬èº«é€šå¸¸ä¼šä¸èº«ä»½æä¾›å•†é›†æˆï¼Œä¾‹å¦‚ Auth0 æˆ– Oktaï¼Œå› æ­¤ï¼Œå¯ä»¥è·¨æä¾›è€…å’Œåè®®æä¾›æœ‰ç”¨çš„æŠ½è±¡ã€‚æœ€ç»ˆï¼Œèº«ä»½æä¾›å•†ä»¥ç­¾åçš„ SAML å£°æ˜\\JWT ä»¤ç‰Œæˆ–ä¸´æ—¶è¯ä¹¦çš„å½¢å¼ä¿è¯ç”¨æˆ·çš„èº«ä»½ä¸å¯å¦è®¤ã€‚è¿™æ ·å°±æ— éœ€ä¾èµ–å—ä¿¡ä»»çš„å­ç½‘ä½œä¸ºç”¨æˆ·èº«ä»½çš„ä»£ç†ã€‚ä¸ VPN å…è®¸ç”¨æˆ·è®¿é—®ç½‘ç»œä¸Šçš„æ‰€æœ‰æœåŠ¡ä¸åŒï¼Œå®ƒè¿˜å…è®¸å°†è®¿é—®ç­–ç•¥é…ç½®åˆ°æœåŠ¡çš„ç²’åº¦ã€‚\nå°†èº«ä»½éªŒè¯å§”æ´¾ç»™èº«ä»½æä¾›è€…çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¯ä»¥ä½¿ç”¨é›¶ä¿¡ä»»åŸåˆ™å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ã€‚ å…·ä½“æ¥è¯´ï¼Œå¯ä»¥åˆ›å»ºèº«ä»½æä¾›è€…ç­–ç•¥ä»¥å¼ºåˆ¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\nç¦æ­¢ä»ä¿¡èª‰ä¸ä½³çš„åœ°ç†ä½ç½®å’Œ IP åœ°å€è®¿é—® ç¦æ­¢ä»å·²çŸ¥æ¼æ´çš„è®¾å¤‡ï¼ˆæœªä¿®è¡¥çš„ OSã€è¾ƒæ—§çš„æµè§ˆå™¨ç­‰ï¼‰è¿›è¡Œè®¿é—® æˆåŠŸè¿›è¡Œ SAML äº¤æ¢åç«‹å³è§¦å‘ MFA èº«ä»½éªŒè¯åºåˆ—å¦‚ä½•å·¥ä½œï¼š ç”¨æˆ·é¦–å…ˆé€šè¿‡è®¿é—®æ§åˆ¶å™¨è¿›è¡Œèº«ä»½éªŒè¯ï¼Œè®¿é—®æ§åˆ¶å™¨åˆå°†èº«ä»½éªŒè¯å§”æ´¾ç»™èº«ä»½æä¾›è€…ã€‚ æˆåŠŸç™»å½•åˆ°èº«ä»½æä¾›è€…åï¼Œè®¿é—®æ§åˆ¶å™¨å°†ç”Ÿæˆä¸€ä¸ªçŸ­æš‚çš„ä¸´æ—¶è¯ä¹¦ï¼Œè¿›è¡Œç­¾åå¹¶å°†å…¶è¿”å›ç»™ç”¨æˆ·ã€‚æˆ–è€…ï¼Œå®ƒå¯ä»¥ä»£æ›¿è¯ä¹¦ç”Ÿæˆä»¤ç‰Œã€‚åªè¦è¯ä¹¦æˆ–ä»¤ç‰Œæœ‰æ•ˆï¼Œå°±å¯ä»¥å°†å…¶ç”¨äºè¿æ¥åˆ° æ¥å…¥ç½‘å…³ç®¡ç†çš„ä»»ä½•æˆæƒåŸºç¡€è®¾æ–½æˆ–æ•°æ®æœåŠ¡ã€‚åˆ°æœŸåï¼Œå¿…é¡»è·å–æ–°çš„è¯ä¹¦æˆ–ä»¤ç‰Œã€‚ ç”¨æˆ·å°†åœ¨æ­¥éª¤ï¼ˆ2ï¼‰ä¸­è·å¾—çš„è¯ä¹¦ä¼ é€’ç»™ä»–ä»¬é€‰æ‹©çš„å·¥å…·ï¼Œç„¶åè¿æ¥åˆ°æ¥å…¥ç½‘å…³ã€‚æ ¹æ®ç”¨æˆ·è¯·æ±‚è®¿é—®çš„æœåŠ¡ï¼ŒåŸºç¡€è®¾æ–½ç½‘å…³æˆ–æ•°æ®ç½‘å…³å°†é¦–å…ˆå…è®¸è®¿é—®æ§åˆ¶å™¨éªŒè¯ç”¨æˆ·çš„è¯ä¹¦ï¼Œç„¶åå†å…è®¸ä»–ä»¬è®¿é—®è¯¥æœåŠ¡ã€‚å› æ­¤ï¼Œè®¿é—®æ§åˆ¶å™¨å……å½“ç”¨æˆ·ä¸å…¶è®¿é—®çš„æœåŠ¡ä¹‹é—´çš„ CAï¼Œå› æ­¤ä¸ºæ¯ä¸ªç”¨æˆ·æä¾›äº†ä¸å¯å¦è®¤çš„èº«ä»½ã€‚ ç­–ç•¥å¼•æ“ å½“è®¿é—®æ§åˆ¶å™¨å¼ºåˆ¶å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼Œç­–ç•¥å¼•æ“ä¼šå¯¹ç”¨æˆ·çš„è¯·æ±‚å¼ºåˆ¶è¿›è¡Œç»†ç²’åº¦çš„æˆæƒã€‚å®ƒä»¥æ˜“äºä½¿ç”¨çš„ YAML è¯­æ³•æ¥å—æˆæƒè§„åˆ™ï¼ˆæŸ¥çœ‹æœ€åçš„ç¤ºä¾‹ï¼‰ï¼Œå¹¶æ ¹æ®ç”¨æˆ·è¯·æ±‚å’Œå“åº”å¯¹å®ƒä»¬è¿›è¡Œè¯„ä¼°ã€‚\nå¼€æ”¾ç­–ç•¥ä»£ç†ï¼ˆOPAï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„ CNCF é¡¹ç›®ï¼Œæ˜¯ç­–ç•¥å¼•æ“çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚å®ƒå¯ä»¥è‡ªå·±ä½œä¸ºå¾®æœåŠ¡è¿è¡Œï¼Œä¹Ÿå¯ä»¥ç”¨ä½œå…¶ä»–å¾®æœåŠ¡è¿›ç¨‹ç©ºé—´ä¸­çš„åº“ã€‚OPA ä¸­çš„ç­–ç•¥ä»¥ç§°ä¸º Rego çš„è¯­è¨€ç¼–å†™ã€‚å¦å¤–ï¼Œä¹Ÿå¯ä»¥åœ¨ Rego ä¹‹ä¸Šè½»æ¾æ„å»ºä¸€ä¸ªç®€å•çš„ YAML ç•Œé¢ï¼Œä»¥ç®€åŒ–æ”¿ç­–è§„èŒƒã€‚\nå…·æœ‰ç‹¬ç«‹äºåŸºç¡€ç»“æ„å’Œæ•°æ®æœåŠ¡çš„å®‰å…¨æ¨¡å‹çš„ç‹¬ç«‹ç­–ç•¥å¼•æ“çš„ä¼˜ç‚¹å¦‚ä¸‹ï¼š\nå¯ä»¥ä»¥ä¸æœåŠ¡å’Œä½ç½®æ— å…³çš„æ–¹å¼æŒ‡å®šå®‰å…¨ç­–ç•¥ ä¾‹å¦‚åœ¨æ‰€æœ‰ SSH æœåŠ¡å™¨ä¸Šç¦æ­¢ç‰¹æƒå‘½ä»¤ ä¾‹å¦‚å¼ºåˆ¶æ‰§è¡Œ MFA æ£€æŸ¥æ‰€æœ‰æœåŠ¡ï¼ˆåŸºç¡€è®¾æ–½å’Œæ•°æ®ï¼‰ ç­–ç•¥å¯ä»¥ä¿å­˜åœ¨ä¸€ä¸ªåœ°æ–¹å¹¶è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ ç­–ç•¥å¯ä»¥ä½œä¸ºä»£ç ç­¾å…¥ GitHub å­˜å‚¨åº“ æ¯é¡¹å˜æ›´åœ¨æäº¤ä¹‹å‰éƒ½è¦ç»è¿‡åä½œå®¡æ ¸æµç¨‹ å­˜åœ¨ç‰ˆæœ¬å†å²è®°å½•ï¼Œå¯ä»¥è½»æ¾åœ°è¿˜åŸç­–ç•¥æ›´æ”¹ åŸºç¡€è®¾æ–½ç½‘å…³å’Œæ•°æ®ç½‘å…³éƒ½ä¾èµ–äºç­–ç•¥å¼•æ“ï¼Œä»¥åˆ†åˆ«è¯„ä¼°ç”¨æˆ·çš„åŸºç¡€è®¾æ–½å’Œæ•°æ®æ´»åŠ¨ã€‚\nåŸºç¡€è®¾æ–½ç½‘å…³ åŸºç¡€è®¾æ–½ç½‘å…³ç®¡ç†å’Œç›‘æ§å¯¹åŸºç¡€è®¾æ–½æœåŠ¡çš„è®¿é—®ï¼Œä¾‹å¦‚ SSH æœåŠ¡å™¨å’Œ Kubernetes é›†ç¾¤ã€‚å®ƒä¸ç­–ç•¥å¼•æ“è¿æ¥ï¼Œä»¥ç¡®å®šç»†åŒ–çš„æˆæƒè§„åˆ™ï¼Œå¹¶åœ¨ç”¨æˆ·ä¼šè¯æœŸé—´å¯¹æ‰€æœ‰åŸºç¡€è®¾æ–½æ´»åŠ¨å¼ºåˆ¶æ‰§è¡Œè¿™äº›è§„åˆ™ã€‚ ä¸ºäº†å®ç°è´Ÿè½½å¹³è¡¡ï¼Œç½‘å…³å¯ä»¥åŒ…å«ä¸€ç»„å·¥ä½œèŠ‚ç‚¹ï¼Œå¯ä»¥åœ¨ AWS ä¸Šéƒ¨ç½²ä¸ºè‡ªåŠ¨æ‰©å±•ç»„ï¼Œä¹Ÿå¯ä»¥åœ¨ Kubernetes é›†ç¾¤ä¸Šä½œä¸ºå‰¯æœ¬é›†è¿è¡Œã€‚\nHashicorp è¾¹ç•Œ æ˜¯åŸºç¡€è®¾æ–½ç½‘å…³çš„ç¤ºä¾‹ã€‚è¿™æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œä½¿å¼€å‘äººå‘˜ã€DevOps å’Œ SRE å¯ä»¥ä½¿ç”¨ç»†ç²’åº¦çš„æˆæƒæ¥å®‰å…¨åœ°è®¿é—®åŸºç¡€è®¾æ–½æœåŠ¡ï¼ˆSSH æœåŠ¡å™¨ã€Kubernetes ç¾¤é›†ï¼‰ï¼Œè€Œæ— éœ€ç›´æ¥è®¿é—®ç½‘ç»œï¼ŒåŒæ—¶åˆç¦æ­¢ä½¿ç”¨ VPN æˆ–å ¡å’ä¸»æœºã€‚\nåŸºç¡€è®¾æ–½ç½‘å…³æ”¯æŒ SSH æœåŠ¡å™¨å’Œ Kubernetes å®¢æˆ·ç«¯ä½¿ç”¨çš„å„ç§è¿æ¥åè®®ï¼Œå¹¶æä¾›ä»¥ä¸‹å…³é”®åŠŸèƒ½ï¼š\nä¼šè¯è®°å½• è¿™æ¶‰åŠå¤åˆ¶ç”¨æˆ·åœ¨ä¼šè¯æœŸé—´æ‰§è¡Œçš„æ¯ä¸ªå‘½ä»¤ã€‚æ•è·çš„å‘½ä»¤é€šå¸¸ä¼šé™„åŠ å…¶ä»–ä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨æˆ·çš„èº«ä»½ã€ä»–ä»¬æ‰€å±çš„å„ç§èº«ä»½æä¾›è€…ç»„ã€å½“å¤©çš„æ—¶é—´ã€å‘½ä»¤çš„æŒç»­æ—¶é—´ä»¥åŠå“åº”çš„ç‰¹å¾ï¼ˆæ˜¯å¦æˆåŠŸã€æ˜¯å¦æœ‰é”™è¯¯ã€æ˜¯å¦å·²è¯»å–æˆ–å†™å…¥æ•°æ®ç­‰ï¼‰ã€‚\næ´»åŠ¨ç›‘æ§ ç›‘æ§ä½¿ä¼šè¯è®°å½•çš„æ¦‚å¿µæ›´è¿›ä¸€æ­¥ã€‚é™¤äº†æ•è·æ‰€æœ‰å‘½ä»¤å’Œå“åº”ï¼ŒåŸºç¡€è®¾æ–½ç½‘å…³è¿˜å°†å®‰å…¨ç­–ç•¥åº”ç”¨äºç”¨æˆ·çš„æ´»åŠ¨ã€‚åœ¨å‘ç”Ÿè¿è§„çš„æƒ…å†µä¸‹ï¼Œå®ƒå¯ä»¥é€‰æ‹©è§¦å‘è­¦æŠ¥ã€é˜»æ­¢æœ‰é—®é¢˜çš„å‘½ä»¤åŠå…¶å“åº”æˆ–å®Œå…¨ç»ˆæ­¢ç”¨æˆ·çš„ä¼šè¯ã€‚\næ•°æ®ç½‘å…³ æ•°æ®ç½‘å…³ç®¡ç†å’Œç›‘æ§å¯¹æ•°æ®æœåŠ¡çš„è®¿é—®ï¼Œä¾‹å¦‚ MySQLã€PostgreSQL å’Œ MongoDB ç­‰æ‰˜ç®¡æ•°æ®åº“ã€AWS RDS ç­‰ DBaaS ç«¯ç‚¹ã€Snowflake å’Œ Bigquery ç­‰æ•°æ®ä»“åº“ã€AWS S3 ç­‰äº‘å­˜å‚¨ä»¥åŠ Kafka å’Œ Kinesisã€‚å®ƒä¸ç­–ç•¥å¼•æ“è¿æ¥ï¼Œä»¥ç¡®å®šç»†åŒ–çš„æˆæƒè§„åˆ™ï¼Œå¹¶åœ¨ç”¨æˆ·ä¼šè¯æœŸé—´å¯¹æ‰€æœ‰æ•°æ®æ´»åŠ¨å¼ºåˆ¶æ‰§è¡Œè¿™äº›è§„åˆ™ã€‚\nä¸åŸºç¡€è®¾æ–½ç½‘å…³ç±»ä¼¼ï¼Œæ•°æ®ç½‘å…³å¯ä»¥åŒ…å«ä¸€ç»„å·¥ä½œèŠ‚ç‚¹ï¼Œå¯ä»¥åœ¨ AWS ä¸Šéƒ¨ç½²ä¸ºè‡ªåŠ¨æ‰©å±•ç»„ï¼Œä¹Ÿå¯ä»¥åœ¨ Kubernetes é›†ç¾¤ä¸Šä½œä¸ºå‰¯æœ¬é›†è¿è¡Œã€‚\nç”±äºä¸åŸºç¡€è®¾æ–½æœåŠ¡ç›¸æ¯”ï¼Œæ•°æ®æœåŠ¡çš„ç§ç±»æ›´å¤šï¼Œå› æ­¤æ•°æ®ç½‘å…³é€šå¸¸å°†æ”¯æŒå¤§é‡çš„è¿æ¥åè®®å’Œè¯­æ³•ã€‚\næ­¤ç±»æ•°æ®ç½‘å…³çš„ç¤ºä¾‹æ˜¯ Cyralï¼Œè¿™æ˜¯ä¸€ç§è½»é‡çº§çš„æ‹¦æˆªæœåŠ¡ï¼Œä»¥è¾¹è½¦ï¼ˆsidecarï¼‰çš„æ–¹å¼éƒ¨ç½²æ¥ç›‘æ§å’Œç®¡ç†å¯¹ç°ä»£æ•°æ®ç»ˆç«¯èŠ‚ç‚¹çš„è®¿é—®ï¼Œå¦‚ AWS RDSã€Snowflakeã€Bigqueryï¼Œã€AWS S3ã€Apache Kafka ç­‰ã€‚å…¶åŠŸèƒ½åŒ…æ‹¬ï¼š\nä¼šè¯è®°å½• è¿™ç±»ä¼¼äºè®°å½•åŸºç¡€è®¾æ–½æ´»åŠ¨ï¼Œå¹¶ä¸”æ¶‰åŠç”¨æˆ·åœ¨ä¼šè¯æœŸé—´æ‰§è¡Œçš„æ¯ä¸ªå‘½ä»¤çš„å‰¯æœ¬ï¼Œå¹¶ä½¿ç”¨ä¸°å¯Œçš„å®¡è®¡ä¿¡æ¯è¿›è¡Œæ³¨é‡Šã€‚\næ´»åŠ¨ç›‘æ§ åŒæ ·ï¼Œè¿™ç±»ä¼¼äºç›‘è§†åŸºç¡€è®¾æ–½æ´»åŠ¨ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ç­–ç•¥é˜»æ­¢æ•°æ®åˆ†æäººå‘˜è¯»å–æ•æ„Ÿçš„å®¢æˆ· PIIã€‚\néšç§æƒæ‰§è¡Œ ä¸åŸºç¡€è®¾æ–½æœåŠ¡ä¸åŒï¼Œæ•°æ®æœåŠ¡æˆäºˆç”¨æˆ·å¯¹é€šå¸¸ä½äºæ•°æ®åº“ã€æ•°æ®ä»“åº“ã€äº‘å­˜å‚¨å’Œæ¶ˆæ¯ç®¡é“ä¸­çš„ä¸å®¢æˆ·ã€åˆä½œä¼™ä¼´å’Œç«äº‰å¯¹æ‰‹æœ‰å…³çš„æ•æ„Ÿæ•°æ®çš„è¯»å†™è®¿é—®æƒé™ã€‚ å‡ºäºéšç§åŸå› ï¼Œå¯¹æ•°æ®ç½‘å…³çš„ä¸€ä¸ªéå¸¸æ™®éçš„è¦æ±‚æ˜¯èƒ½å¤Ÿæ¸…ç†ï¼ˆä¹Ÿç§°ä¸ºä»¤ç‰ŒåŒ–æˆ–å±è”½ï¼‰PIIï¼Œä¾‹å¦‚ç”µå­é‚®ä»¶ã€å§“åã€ç¤¾ä¼šä¿é™©å·ã€ä¿¡ç”¨å¡å·å’Œåœ°å€ã€‚\né‚£ä¹ˆè¿™ç§ä½“ç³»ç»“æ„å¦‚ä½•ç®€åŒ–è®¿é—®ç®¡ç†ï¼Ÿ è®©æˆ‘ä»¬çœ‹ä¸€äº›å¸¸è§çš„è®¿é—®ç®¡ç†æ–¹æ¡ˆï¼Œä»¥äº†è§£ä¸ä½¿ç”¨ VPN å’Œå ¡å’ä¸»æœºç›¸æ¯”ï¼Œæ¥å…¥ç½‘å…³æ¶æ„å¦‚ä½•æä¾›ç»†ç²’åº¦çš„æ§åˆ¶ã€‚\nç‰¹æƒæ´»åŠ¨ç›‘æ§ï¼ˆPAMï¼‰ è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ç­–ç•¥ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹ç›‘è§†æ‰€æœ‰åŸºç¡€è®¾æ–½å’Œæ•°æ®æœåŠ¡ä¸­çš„ç‰¹æƒæ´»åŠ¨ï¼š\nä»…å…è®¸å±äº Admins å’Œ SRE ç»„çš„ä¸ªäººåœ¨ SSH æœåŠ¡å™¨ã€Kubernetes é›†ç¾¤å’Œæ•°æ®åº“ä¸Šè¿è¡Œç‰¹æƒå‘½ä»¤ã€‚ è™½ç„¶å¯ä»¥è¿è¡Œç‰¹æƒå‘½ä»¤ï¼Œä½†æ˜¯æœ‰ä¸€äº›ä¾‹å¤–å½¢å¼çš„é™åˆ¶ã€‚å…·ä½“æ¥è¯´ï¼Œä»¥ä¸‹å‘½ä»¤æ˜¯ä¸å…è®¸çš„ï¼š â€œsudoâ€ å’Œ â€œyumâ€ å‘½ä»¤å¯èƒ½æ— æ³•åœ¨ä»»ä½• SSH æœåŠ¡å™¨ä¸Šè¿è¡Œ â€œkubectl deleteâ€ å’Œ â€œkubectl taintâ€ å‘½ä»¤å¯èƒ½æ— æ³•åœ¨ä»»ä½• Kubernetes é›†ç¾¤ä¸Šè¿è¡Œ â€œdrop tableâ€ å’Œ â€œcreate userâ€ å‘½ä»¤å¯èƒ½æ— æ³•åœ¨ä»»ä½•æ•°æ®åº“ä¸Šè¿è¡Œ é›¶ç‰¹æƒï¼ˆZSPï¼‰æ‰§è¡Œ The next policy shows an example of enforcing zero standing privileges \u0026ndash; a paradigm where no one has access to an infrastructure or data service by default. Access may be obtained only upon satisfying one or more qualifying criteria:\nOnly individuals belonging to the Support group are allowed access An individual must be on-call to gain access. On call status may be determined by checking their schedule in an incident response service such as PagerDuty A multi-factor authentication (MFA) check is triggered upon successful authentication They must use TLS to connect to the infrastructure or data service Lastly, if a data service is being accessed, full table scans (e.g. SQL requests lacking a WHERE or a LIMIT clause that end up reading an entire dataset) are disallowed. ä¸‹ä¸€ä¸ªç­–ç•¥æ˜¾ç¤ºäº†ä¸€ä¸ªå®æ–½é›¶ç‰¹æƒçš„ç¤ºä¾‹ \u0026ndash; ä¸€ç§é»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰äººå¯ä»¥è®¿é—®åŸºç¡€è®¾æ–½æˆ–æ•°æ®æœåŠ¡çš„èŒƒä¾‹ã€‚åªæœ‰æ»¡è¶³ä¸€ä¸ªæˆ–å¤šä¸ªåˆæ ¼æ ‡å‡†ï¼Œæ‰èƒ½è·å¾—è®¿é—®æƒé™ï¼š\nåªå…è®¸å±äºæ”¯æŒç»„çš„ä¸ªäººè®¿é—® ä¸ªäººå¿…é¡» on-call æ‰èƒ½è·å¾—è®¿é—®æƒé™ã€‚å¯ä»¥é€šè¿‡æ£€æŸ¥äº‹ä»¶å“åº”æœåŠ¡ï¼ˆä¾‹å¦‚ PagerDutyï¼‰ä¸­çš„æ—¶é—´è¡¨æ¥ç¡®å®šé€šè¯çŠ¶æ€ æˆåŠŸé€šè¿‡èº«ä»½éªŒè¯åä¼šè§¦å‘å¤šå› å­èº«ä»½éªŒè¯ï¼ˆMFAï¼‰æ£€æŸ¥ ä»–ä»¬å¿…é¡»ä½¿ç”¨ TLS è¿æ¥åˆ°åŸºç¡€è®¾æ–½æˆ–æ•°æ®æœåŠ¡ æœ€åï¼Œå¦‚æœæ­£åœ¨è®¿é—®æ•°æ®æœåŠ¡ï¼Œåˆ™ä¸å…è®¸è¿›è¡Œå…¨è¡¨æ‰«æï¼ˆä¾‹å¦‚ï¼Œç¼ºå°‘ WHERE æˆ– LIMIT å­å¥çš„ SQL è¯·æ±‚æœ€ç»ˆå°†è¯»å–æ•´ä¸ªæ•°æ®é›†ï¼‰ã€‚ éšç§å’Œæ•°æ®ä¿æŠ¤ The last policy shows an example of data governance involving data scrubbing:\nIf anyone from Marketing is accessing PII (social security number (SSN), credit card number (CCN), age), scrub the data before returning If anyone is accessing PII using the Looker or Tableau services, also scrub the data Scrubbing rules are defined by the specific type of the PII For SSNs, scrub the first 5 digits For CCNs, scrub the lastÂ 4 digits For ages, scrub the last digit i.e., the requestor will know the age brackets but never the actual ages æœ€åä¸€æ¡ç­–ç•¥æ˜¾ç¤ºäº†æ¶‰åŠæ•°æ®æ¸…ç†çš„æ•°æ®æ²»ç†ç¤ºä¾‹ï¼š\nå¦‚æœå¸‚åœºè¥é”€äººå‘˜æ­£åœ¨è®¿é—® PIIï¼ˆç¤¾ä¼šä¿é™©å·ï¼ˆSSNï¼‰ã€ä¿¡ç”¨å¡å·ï¼ˆCCNï¼‰ã€å¹´é¾„ï¼‰ï¼Œå…ˆæ¸…æ´—æ•°æ®ç„¶åå†è¿”å› å¦‚æœæœ‰äººæ­£åœ¨ä½¿ç”¨ Looker æˆ– Tableau æœåŠ¡è®¿é—® PIIï¼ŒåŒæ—¶æ¸…æ´—æ•°æ® æ¸…ç†è§„åˆ™ç”± PII çš„ç‰¹å®šç±»å‹å®šä¹‰ å¯¹äº SSNï¼Œæ¸…æ´—å‰ 5 ä½æ•°å­— å¯¹äº CCNï¼Œæ¸…æ´—æœ€å 4 ä½æ•°å­— å¯¹äºå¹´é¾„ï¼Œè¯·æ¸…æ´—æœ€åä¸€ä½æ•°å­—ï¼Œå³è¯·æ±‚è€…å°†çŸ¥é“å¹´é¾„æ®µï¼Œä½†ä»ä¸çŸ¥é“å®é™…å¹´é¾„ æ¦‚æ‹¬ æˆ‘ä»¬çœ‹åˆ°ï¼Œå¯¹äºé«˜åº¦åŠ¨æ€çš„äº‘ç¯å¢ƒï¼ŒVPN å’Œå ¡å’ä¸»æœºä¸è¶³ä»¥ä½œä¸ºé«˜æ•ˆäº‘ç¯å¢ƒä¸­çš„æœ‰æ•ˆè®¿é—®ç®¡ç†æœºåˆ¶ã€‚ä¸€ç§æ–°çš„è®¿é—®ç®¡ç†ä½“ç³»ç»“æ„ï¼Œå…¶é‡ç‚¹æ˜¯ä¸å¯å¦è®¤çš„ç”¨æˆ·èº«ä»½ï¼ŒçŸ­æš‚çš„è¯ä¹¦æˆ–ä»¤ç‰Œä»¥åŠé›†ä¸­çš„ç»†ç²’åº¦æˆæƒå¼•æ“ï¼Œå¯æœ‰æ•ˆè§£å†³ VPN å’Œå ¡å’ä¸»æœºæ— æ³•è§£å†³çš„éš¾é¢˜ã€‚é™¤äº†ä¸ºè®¿é—®å…³é”®åŸºç¡€è®¾æ–½å’Œæ•°æ®æœåŠ¡çš„ç”¨æˆ·æä¾›å…¨é¢çš„å®‰å…¨æ€§ä¹‹å¤–ï¼Œè¯¥ä½“ç³»ç»“æ„è¿˜å¯ä»¥å¸®åŠ©ç»„ç»‡å®ç°å…¶å®¡æ ¸ã€åˆè§„æ€§ã€éšç§å’Œä¿æŠ¤ç›®æ ‡ã€‚\næˆ‘ä»¬è¿˜è®¨è®ºäº†è¯¥æ¶æ„çš„å‚è€ƒå®ç°ï¼Œå…¶ä¸­ä½¿ç”¨äº†ä»¥å¼€å‘äººå‘˜ä¸ºä¸­å¿ƒçš„è‘—åå¼€æºè§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ Hashicorp Boundary å’Œ OPA ä»¥åŠ Cyralï¼ˆä¸€ç§ç”¨äºç°ä»£æ•°æ®æœåŠ¡çš„å¿«é€Ÿä¸”æ— çŠ¶æ€çš„è¾…åŠ©å·¥å…·ï¼‰ã€‚ ä»–ä»¬ä¸€èµ·å¯ä»¥åœ¨äº‘ä¸Šæä¾›ç»†ç²’åº¦ä¸”æ˜“äºä½¿ç”¨çš„è®¿é—®ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚\nå…³äºä½œè€… Manav Mital æ˜¯ Cyral çš„è”åˆåˆ›å§‹äººå…¼é¦–å¸­æ‰§è¡Œå®˜ï¼ŒCyral æ˜¯é¦–ä¸ªä¸ºæ•°æ®äº‘æä¾›å¯è§æ€§ã€è®¿é—®æ§åˆ¶å’Œä¿æŠ¤çš„äº‘åŸç”Ÿå®‰å…¨æœåŠ¡ã€‚Cyral æˆç«‹äº 2018 å¹´ï¼Œä¸å„ç§ç»„ç»‡åˆä½œ - ä»äº‘åŸç”Ÿåˆåˆ›ä¼ä¸šåˆ°è´¢å¯Œ 500 å¼ºä¼ä¸šï¼Œå› ä¸ºå®ƒä»¬é‡‡ç”¨ DevOps æ–‡åŒ–å’Œäº‘æŠ€æœ¯æ¥ç®¡ç†å’Œåˆ†ææ•°æ®ã€‚ Manav æ‹¥æœ‰ UCLA çš„è®¡ç®—æœºç§‘å­¦ç¡•å£«å­¦ä½å’Œåæ™®å°”çš„å°åº¦ç†å·¥å­¦é™¢çš„è®¡ç®—æœºç§‘å­¦å­¦å£«å­¦ä½ã€‚\nå…³äºè¯‘è€… Addo Zhang äº‘åŸç”Ÿä»ä¸šäººå‘˜ï¼Œçˆ±å¥½å„ç§ä»£ç ã€‚æ›´å¤šç¿»è¯‘ï¼š\nåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨ Kubernetes ä¸Šçš„è¿›åŒ– 2021 å¹´åŠæœªæ¥çš„äº‘åŸç”Ÿé¢„æµ‹ åº”ç”¨æ¶æ„ï¼šä¸ºä»€ä¹ˆè¦éšç€å¸‚åœºæ¼”è¿› ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/translation-access-management-reference-architecture/","tags":["OPA","äº‘åŸç”Ÿ"],"title":"äº‘ä¸Šç»†ç²’åº¦è®¿é—®ç®¡ç†çš„å‚è€ƒæ¶æ„"},{"categories":["ç¬”è®°","äº‘åŸç”Ÿ"],"contents":"\næƒ³åˆ°è¿™ä¸ªæ ‡é¢˜çš„æ—¶å€™ï¼Œæˆ‘ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„å°±æ˜¯æ˜Ÿçˆ·çš„ã€Šå”ä¼¯è™ç‚¹ç§‹é¦™ã€‹çš„è¿™ä¸€å¹•ã€‚\nå½“è®¨è®ºèµ·ä¸–ç•Œä¸Šæœ€å¥½çš„å¼€å‘è¯­è¨€æ˜¯ä»€ä¹ˆçš„æ—¶å€™ï¼ŒJava çš„ç²‰ä¸ä»¬æ€»ä¼šé‡åˆ°è¿™ç§åœºæ™¯ï¼š\nå¹ï¼šâ€œJava è¯­æ³•ç®€å•ï¼Œå®¹æ˜“ä¸Šæ‰‹ï¼â€ é»‘ï¼šâ€œJava å¯åŠ¨æ…¢ï¼Œæ€§èƒ½å·®ï¼Œè€—èµ„æºï¼â€ å¹ï¼šâ€œJava æœ‰ä¸–ç•Œä¸Šæœ€å¤šçš„ç¨‹åºå‘˜ï¼â€ é»‘ï¼šâ€œJava å¯åŠ¨æ…¢ï¼Œæ€§èƒ½å·®ï¼Œè€—èµ„æºï¼â€ å¹ï¼šâ€œJava ç”Ÿæ€å¥½ï¼â€ é»‘ï¼šâ€œJava å¯åŠ¨æ…¢ï¼Œæ€§èƒ½å·®ï¼Œè€—èµ„æºï¼â€ å¹ï¼šâ€œæ»šï¼â€\nä»Šå¤©æˆ‘ä»¬ç»§ç»­è¯´è¯´ Quarkusï¼Œåº”â€œäº‘â€è€Œç”Ÿçš„ Java æ¡†æ¶ã€‚ä»Šå¤©ç®—æ˜¯ç¬¬ä¸‰ç¯‡äº†ï¼Œæ²¡çœ‹è¿‡çš„åŒå­¦å¯ä»¥å›é¡¾ä¸€ä¸‹ï¼š\nHello, Quarkus åº”\u0026quot;äº‘\u0026quot;è€Œç”Ÿçš„ Java æ¡†æ¶ Quarkusï¼šæ„å»ºæœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶ ä¸Šä¸€ç¯‡çš„ç»“å°¾é¢„å‘Šï¼šè¯•è¯• Quarkus åœ¨ ArgoCD ä¸­çš„åº”ç”¨ï¼Œçœ‹ä¸‹ Serverless ä¸Šçš„ä½¿ç”¨ä½“éªŒã€‚ä¸è¿‡ä¸æƒ³ç”¨ ArgoCD äº†ï¼Œå› ä¸ºè¿™ workflow è¿™ç§åœºæ™¯å®åœ¨ä½“ç°ä¸å‡º Quarkus åˆ°åº•æœ‰å¤šå¿«ã€‚ä½†åˆæƒ³åš Serverlessï¼Œé‚£å°±æƒ³åˆ°äº† Knative Serving äº†ã€‚\nå…¶å®ï¼Œè¿˜æœ‰ä¸€ä¸ªåŸå› æ˜¯æ¯”è¾ƒæ‡’ï¼Œä¸Šæ¬¡çš„é•œåƒè¿˜å¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ã€‚\nTL;DR åºŸè¯ä¸å¤šè¯´ï¼Œå…ˆä¸Šç»“è®ºã€‚Quarkus ä¸ Spring é¦–ä¸ªè¯·æ±‚çš„å“åº”è€—æ—¶ï¼š2.5s vs 5.7sã€‚\næ³¨ï¼šä¸ºäº†å¿½ç•¥æ‹‰å–é•œåƒçš„æ—¶é—´å·®å¼‚ï¼Œæå‰ pull é•œåƒã€‚\néªŒè¯ ç¯å¢ƒå‡†å¤‡ Kubernetes 1.18+ via minikube Istio 1.9.2 Knative 0.22.0 Knative CLI ï¼ˆbrew å®‰è£…ï¼‰ watch ï¼ˆbrew å®‰è£…ï¼‰ ç¯å¢ƒçš„å®‰è£…å‡†å¤‡å‚è€ƒå®˜æ–¹çš„æ–‡æ¡£ã€‚\né•œåƒ èµ„æºé•œåƒå°±ä½¿ç”¨ä¸Šä¸€ç¯‡æ–‡ç« æ„å»ºçš„ï¼Œä½†éœ€è¦åšä¸‹è°ƒæ•´ï¼š\ndocker tag quarkus/quarkus-getting-started:distroless dev.local/quarkus/quarkus-getting-started:distroless docker tag spring/spring-getting-started:latest dev.local/spring/spring-getting-started:latest æ³¨ï¼šknative ä¼šå¿½ç•¥ dev.local é•œåƒçš„é¢„åŠ è½½ï¼Œä¸ä¼šåœ¨åˆ›å»º knative service çš„æ—¶å€™æ‹‰å–ã€‚\nç„¶åä½¿ç”¨ minikube image load åŠ è½½åˆ° minikubeç¯å¢ƒä¸­ï¼š\nminikube image load dev.local/quarkus/quarkus-getting-started:distroless minikube image load dev.local/spring/spring-getting-started:latest knative é…ç½®ï¼ˆå¯é€‰ï¼‰ ä¿®æ”¹ istio-system namespace ä¸‹çš„ configmap config-domainï¼Œå¢åŠ æ–°çš„ domainï¼šnip.io\næ³¨ï¼šè¿™ä¸ªæ“ä½œçº¯å±ä¸ªäººå–œå¥½ï¼Œä¸å–œæ¬¢é‚£ä¸ª example.comï¼Œå¯è·³è¿‡ã€‚\nè·å– Istio Ingress åœ°å€ ä½¿ç”¨å‘½ä»¤è·å– Ingress çš„è®¿é—®æ–¹å¼ï¼Œè¿™é‡Œ http2/80 åçš„ http://192.168.64.2:31608 å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œè®°ä¸‹è¿™ä¸ª ip å’Œç«¯å£ã€‚\nminikube service list |------------------|----------------------------|-------------------|---------------------------| | NAMESPACE | NAME | TARGET PORT | URL | |------------------|----------------------------|-------------------|---------------------------| | default | kubernetes | No node port | | istio-system | istio-egressgateway | No node port | | istio-system | istio-ingressgateway | status-port/15021 | http://192.168.64.2:32431 | | | | http2/80 | http://192.168.64.2:31608 | | | | https/443 | http://192.168.64.2:31795 | | | | tcp/31400 | http://192.168.64.2:31369 | | | | tls/15443 | http://192.168.64.2:30293 | | istio-system | istiod | No node port | | istio-system | knative-local-gateway | No node port | | knative-eventing | broker-filter | No node port | | knative-eventing | broker-ingress | No node port | | knative-eventing | eventing-webhook | No node port | | knative-eventing | imc-dispatcher | No node port | | knative-serving | activator-service | No node port | | knative-serving | autoscaler | No node port | | knative-serving | autoscaler-bucket-00-of-01 | No node port | | knative-serving | autoscaler-hpa | No node port | | knative-serving | controller | No node port | | knative-serving | istio-webhook | No node port | | knative-serving | webhook | No node port | | kube-system | kube-dns | No node port | |------------------|----------------------------|-------------------|---------------------------| åˆ›å»º Knative service #quarkus apiVersion: serving.knative.dev/v1 kind: Service metadata: name: hello-quarkus namespace: default spec: template: spec: containers: - image: dev.local/quarkus/quarkus-getting-started:distroless imagePullPolicy: Never --- #spring apiVersion: serving.knative.dev/v1 kind: Service metadata: name: hello-spring namespace: default spec: template: spec: containers: - image: dev.local/spring/spring-getting-started:latest imagePullPolicy: Never é€šè¿‡ cli kn å‘½ä»¤æŸ¥çœ‹ä¸‹ service çš„ä¿¡æ¯ï¼š\nkn service describe hello-quarkus -n default Name: hello-quarkus Namespace: default Age: 21s URL: http://hello-quarkus.default.nip.io Revisions: 100% @latest (hello-quarkus-00001) [1] (21s) Image: dev.local/quarkus/quarkus-getting-started:distroless Conditions: OK TYPE AGE REASON ++ Ready 9s ++ ConfigurationsReady 10s ++ RoutesReady 9s kn service describe hello-spring -n default Name: hello-spring Namespace: default Age: 44s URL: http://hello-spring.default.nip.io Revisions: 100% @latest (hello-spring-00001) [1] (44s) Image: dev.local/spring/spring-getting-started:latest Conditions: OK TYPE AGE REASON ++ Ready 31s ++ ConfigurationsReady 32s ++ RoutesReady 31s ä»æè¿°ä¿¡æ¯ä¸­å¯ä»¥æ‹¿åˆ°æœåŠ¡çš„è®¿é—®åœ°å€ï¼Œåˆ†åˆ«æ˜¯ http://hello-quarkus.default.nip.io å’Œ http://hello-spring.default.nip.ioã€‚\næ¥ä¸‹æ¥å°±éœ€è¦åœ¨æœ¬åœ°ä¸»æœºçš„ hosts ä¸­åŠ å…¥è§£æï¼š\n192.168.64.2 hello-quarkus.default.nip.io 192.168.64.2 hello-spring.default.nip.io æµ‹è¯• ä¸Šé¢æ“ä½œå®Œä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„åœ°å€è®¿é—®æœåŠ¡äº†ã€‚\nhttp://hello-quarkus.default.nip.io:31608/hello/greeting/quarkus http://hello-spring.default.nip.io:31608/hello/greeting/spring\nåœ¨æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡ watch -n 1 'kubectl get po -n default | grep hello' å‘½ä»¤æ¥æŸ¥çœ‹ pod çš„åˆ›å»ºå’Œé”€æ¯ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/quarkus-enable-java-running-in-serverless/","tags":["Java","Serverless","Quarkus","Knative"],"title":"Quarkusï¼šè°è¯´ Java ä¸èƒ½ç”¨æ¥è·‘ Serverlessï¼Ÿ"},{"categories":["ç¬”è®°"],"contents":"ä¸ºä»€ä¹ˆ è¯´èµ·æœåŠ¡ç½‘æ ¼ï¼Œè¿™å¹…å›¾å¤§å®¶è‚¯å®šä¸ä¼šé™Œç”Ÿã€‚è¿™å°±æ˜¯æœåŠ¡ç½‘æ ¼çš„ç½‘ç»œï¼Œä¹Ÿæ˜¯ç½‘æ ¼æ¶æ„çš„ç»ˆæå½¢æ€ã€‚\né‚£åœ¨è¿ç§»åˆ°ç½‘æ ¼æ¶æ„ä¹‹å‰ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ\næˆ‘ä»¬çš„ç³»ç»Ÿåœ¨æ¼”è¿›çš„è¿‡ç¨‹ä¸­ï¼Œä¸å¯é¿å…çš„ä¼šé‡åˆ°å„ç§ 0 åˆ° 1 è¿‡ç¨‹ä¸­çš„ä¸­é—´æ€ã€‚æ¯”å¦‚ä¸‹é¢è¿™ç§ï¼Œå¯ä»¥æ¯”è¾ƒç›´è§‚çš„çœ‹å‡º Istio æˆ–è€…ç½‘æ ¼æ˜¯éƒ¨åˆ†è¦†ç›–çš„ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¹³æ»‘ã€å¯æ§çš„æ¨è¿›ï¼Œæ‰èƒ½åœ¨ä¿éšœç³»ç»Ÿå¯ç”¨æ€§çš„å‰æä¸‹è¿›è¡Œæ¶æ„çš„æ¼”è¿›ã€‚\næ€ä¹ˆåš Sidecar çš„æ³¨å…¥åˆ†ä¸¤ç§ï¼šæ‰‹åŠ¨å’Œè‡ªåŠ¨ã€‚\næ‰‹åŠ¨ æ‰‹åŠ¨å°±æ˜¯åˆ©ç”¨ Istio çš„ cli å·¥å…· istioctl kube-inject å¯¹èµ„æº yaml è¿›è¡Œä¿®æ”¹ï¼š\n$ istioctl kube-inject -f samples/sleep/sleep.yaml | kubectl apply -f - serviceaccount/sleep created service/sleep created deployment.apps/sleep created æ‰‹åŠ¨çš„æ–¹å¼æ¯”è¾ƒé€‚åˆå¼€å‘é˜¶æ®µä½¿ç”¨ã€‚\nè‡ªåŠ¨ sidecar çš„è‡ªåŠ¨æ³¨å…¥åˆ™æ˜¯é€šè¿‡ mutating webhook admission controller å®ç°çš„ã€‚å…¶åŸç†ç®€å•è¯´å°±æ˜¯æ‹¦æˆª podçš„åˆ›å»ºè¯·æ±‚æ¥å¯¹ pod çš„èµ„æºå®šä¹‰è¿›è¡Œä¿®æ”¹ã€‚\næˆ‘ä»¬å¯¹æˆªå–äº† istio-sidecar-injector MutatingWebhookConfiguration çš„éƒ¨åˆ†å†…å®¹ã€‚\nwebhooks: ... matchPolicy: Exact #1 name: sidecar-injector.istio.io namespaceSelector: #2 matchLabels: istio-injection: enabled objectSelector: #3 matchExpressions: - key: sidecar.istio.io/inject operator: NotIn values: - \u0026#34;false\u0026#34; rules: #4 - apiGroups: - \u0026#34;\u0026#34; apiVersions: - v1 operations: - CREATE resources: - pods scope: \u0026#39;*\u0026#39; ... è¿™é‡Œçš„ matchPolicy: Exact é’ˆå¯¹çš„æ˜¯ #4 ä¸­çš„ apiGroupsä¸apiVersions çš„ç»„åˆï¼Œå³ç²¾ç¡®åŒ¹é… v1/pods çš„ CREATE è¯·æ±‚ é¡¾åæ€ä¹‰ï¼ŒåŒ¹é…ç¬¦åˆæ¡ä»¶çš„ namespace åŒ2ï¼ŒåŒ¹é…ç¬¦åˆæ¡ä»¶çš„ object æ³¨ï¼š #2ã€#3 æ”¯æŒ Kubernetes çš„æ ‡ç­¾é€‰æ‹©è¯­æ³•\næŒ‰ç…§å‰é¢çš„è¯´æ˜ï¼Œè¿™ä¸ª hook ä¼šæ‹¦æˆªæ‰“äº† istio-injection: enabled label çš„ namespace ä¸‹ï¼Œæ²¡æœ‰æ‰“ sidecar.istio.io/inject: false æ ‡ç­¾çš„ v1/pod çš„åˆ›å»ºã€‚é€šè¿‡ https://istiod.istio-system:443/inject ç«¯ç‚¹å¯¹ pod çš„å®šä¹‰è¿›è¡Œå®šåˆ¶ï¼ˆæ·»åŠ  init-containerã€sidecar å®¹å™¨ç­‰ï¼‰ã€‚\næœ‰äººå¯èƒ½ä¼šè¯´è¿™æ ·è¿˜ä¸å¤Ÿç²¾å‡†ï¼Œå› ä¸ºå¯èƒ½æŸä¸ª namespace ä¸‹åªæœ‰éƒ¨åˆ†å¯¹è±¡æ‰ä¼šæ³¨å…¥ sidecarã€‚\nè¿™å°±éœ€è¦å€ŸåŠ© istiod çš„é€»è¾‘äº†ã€‚\nåªé’ˆå¯¹ç‰¹å®š pod æ³¨å…¥sidecar æˆ–å¿½ç•¥æ³¨å…¥ åœ¨ configmap istio-sidecar-injector ä¸­æœ‰ä¸¤ä¸ªå­—æ®µ alwaysInjectSelector å’Œ neverInjectSelectorã€‚ä»åå­—æ¥çœ‹è¿™ä¸¤ä¸ªåˆ†åˆ«æä¾›äº†ç™½åå•ã€é»‘åå•çš„åŠŸèƒ½ã€‚\nalwaysInjectSelector: [] neverInjectSelector:[] æˆ‘ä»¬åªéœ€å¦‚ä¸‹è°ƒæ•´ï¼ˆéœ€è¦é‡å¯ istiodï¼‰ï¼Œç„¶åä¸ºéœ€è¦æ³¨å…¥ sidecar çš„èµ„æºæ‰“ä¸Šç›¸åº”çš„æ ‡ç­¾å³å¯ã€‚\nalwaysInjectSelector: - matchExpressions: - key: sidecar.istio.io/inject operator: In values: - \u0026#34;true\u0026#34; - \u0026#34;enabled\u0026#34; - \u0026#34;yes\u0026#34; ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/how-to-control-istio-sidecar-injection/","tags":["Istio","Kubernetes","Service Mesh"],"title":"æœåŠ¡ç½‘æ ¼å¹³ç¨³è½åœ°ï¼šIstio ä¸­ç²¾å‡†æ§åˆ¶ Sidecar çš„æ³¨å…¥"},{"categories":["æ•™ç¨‹","ç¬”è®°"],"contents":"\nç”µå½±ã€ŠåŠŸå¤«ã€‹ä¸­ï¼Œç«äº‘é‚ªç¥æœ‰å¥è¯ï¼šâ€œå¤©ä¸‹æ­¦åŠŸæ— åšä¸æ‘§ï¼Œå”¯å¿«ä¸ç ´ã€‚â€\nåœ¨ ä¸Šä¸€ç¯‡æ–‡ç«  ä¸­ï¼Œæˆ‘ä»¬å†™äº†ç¬¬ä¸€ä¸ª Quarkus åº”ç”¨ï¼Œå¹¶å°è¯•ç€æ„å»ºäº† legacy-jar å’Œ fast-jarã€‚\nä»Šå¤©æ¥çœ‹ä¸€ä¸‹ Quarkus æ„å»ºå‡ºæ¥çš„æœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶åˆ°åº•æ¯” Spring åº”ç”¨èƒ½å¿«å¤šå°‘ï¼Œç”Ÿæ€çš„æˆç†Ÿåº¦ä¸åœ¨è¿™é‡Œè®¨è®ºã€‚\nTLDR å…ˆä¸Šç»“è®ºï¼Œ ä¸åªæœ‰ä¸€ä¸ª Controller çš„Spring Web åº”ç”¨åšä¸‹å¯¹æ¯”ã€‚\nåº”ç”¨å¯åŠ¨æ—¶é—´ï¼š0.012s vs 2.294s é•œåƒå¤§å°ï¼š49MB vs 237 MB Spring åº”ç”¨é•œåƒä½¿ç”¨ openjdk:11.0-jre-slim ä½œä¸º base é•œåƒï¼Œå¤§å°ä¸º 220MBã€‚\ndocker images REPOSITORY TAG IMAGE ID CREATED SIZE spring/spring-getting-started latest 5f47030c5c3f 6 minutes ago 237MB quarkus/quarkus-getting-started distroless2 fe973c5ac172 24 minutes ago 49MB quarkus/quarkus-getting-started distroless 6fe27dd44e86 31 minutes ago 51MB quarkus/quarkus-getting-started ubi 8f86f5915715 58 minutes ago 132MB Java åº”ç”¨å®¹å™¨åŒ–çš„å›°å¢ƒ äº‘åŸç”Ÿä¸–ç•Œä¸­ï¼Œåº”ç”¨å®¹å™¨åŒ–æ˜¯ä¸ªæ˜¾è‘—çš„ç‰¹ç‚¹ã€‚Java åº”ç”¨å®¹å™¨åŒ–æ—¶é¢ä¸´äº†å¦‚ä¸‹é—®é¢˜ï¼š\nåº”ç”¨å¯åŠ¨æ…¢ï¼šå…¶å®è¿™æ˜¯ Java åº”ç”¨çš„é—®é¢˜ã€‚Java åº”ç”¨å ç”¨å†…å­˜å¤šï¼›JVM è™šæ‹Ÿæœºå¯åŠ¨æ—¶éœ€è¦åšç¯å¢ƒçš„åˆå§‹åŒ–ã€é¢„åŠ è½½å¤§é‡çš„ç±»ã€åˆå§‹åŒ–çº¿ç¨‹ç­‰ç­‰ã€‚å¯åŠ¨è€—æ—¶è§†åº”ç”¨æƒ…å†µéœ€è¦å‡ ç§’ï¼Œç”šè‡³å¯è¾¾åˆ†é’Ÿçº§ã€‚è¾ƒé•¿çš„å¯åŠ¨è€—æ—¶ï¼Œä¹ŸæŠ‘åˆ¶äº†æ°´å¹³ä¼¸ç¼©æ€§ã€‚å³ä½¿åœ¨ Serverless è¿™ç§å“åº”è€—æ—¶è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œä¹Ÿä¼šè¢«å«Œå¼ƒã€‚ é•œåƒè¿‡å¤§ï¼šå…¶å®ä½¿ç”¨äº†é•œåƒçš„åˆ†å±‚è®¾è®¡ï¼Œå¸¸è§çš„ä¸€ä¸ª SpringCloud åº”ç”¨çš„ uÌˆber-jar åŒ…å¯èƒ½éƒ½æœ‰ 7ã€80MBã€‚ ç©ºé—´å ç”¨ï¼šè™½ç„¶ç”¨äº†é•œåƒåˆ†å±‚ï¼Œä½†ç§¯å°‘æˆå¤šï¼Œä¹Ÿä¼šå¢åŠ å­˜å‚¨æˆæœ¬ã€‚ Quarkus ä¸æœ¬æœºæ˜ åƒï¼ˆnative imageï¼‰ Quarkus çš„å¼€å‘éµä»äº†å®¹å™¨ä¼˜å…ˆçš„åŸåˆ™ï¼š\næ”¯æŒ Graal/SubstrateVM æ„å»ºæ—¶å¤„ç†å…ƒæ•°æ® å‡å°‘åå°„çš„ä½¿ç”¨ æœ¬æœºæ˜ åƒé¢„å¯åŠ¨ æœ¬æœºæ˜ åƒæ˜¯å°† Java ä»£ç æå‰ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆç§°ä¸ºæœ¬æœºæ˜ åƒï¼‰çš„æŠ€æœ¯ã€‚è¯¥å¯æ‰§è¡Œæ–‡ä»¶åŒ…æ‹¬åº”ç”¨ç¨‹åºç±»ã€å…¶ä¾èµ–é¡¹ä¸­çš„ç±»ã€è¿è¡Œæ—¶åº“ç±»ä»¥åŠ JDK ä¸­çš„é™æ€é“¾æ¥æœ¬æœºä»£ç ã€‚å®ƒä¸æ˜¯åœ¨ Java VM ä¸Šè¿è¡Œï¼Œè€Œæ˜¯åŒ…æ‹¬å¿…è¦çš„ç»„ä»¶ï¼Œä¾‹å¦‚å†…å­˜ç®¡ç†ï¼Œçº¿ç¨‹è°ƒåº¦ç­‰ï¼Œè¿™äº›ç»„ä»¶æ¥è‡ªå¦ä¸€ä¸ªè¿è¡Œæ—¶ç³»ç»Ÿ â€œSubstrate VMâ€ã€‚â€œSubstrate VMâ€ æ˜¯è¿è¡Œæ—¶ç»„ä»¶ï¼ˆä¾‹å¦‚åä¼˜åŒ–å™¨ï¼Œåƒåœ¾æ”¶é›†å™¨ï¼Œçº¿ç¨‹è°ƒåº¦ç­‰ï¼‰çš„åç§°ã€‚ä¸ JVM ç›¸æ¯”ï¼Œç”Ÿæˆçš„ç¨‹åºå…·æœ‰æ›´å¿«çš„å¯åŠ¨æ—¶é—´å’Œæ›´ä½çš„è¿è¡Œæ—¶å†…å­˜å¼€é”€ã€‚\nå¦‚ä½•æ„å»ºæœ¬æœºæ˜ åƒ ç¯å¢ƒé…ç½®å‚è€ƒä¸Šä¸€ç¯‡æ–‡ç« ï¼Œå¯ä»¥ç›´æ¥ä»è¿™é‡Œä¸‹è½½æºç ã€‚\né…ç½® GraalVM ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨äº† sdkman è¿›è¡Œ GraalVM å®‰è£…ã€‚è®¾ç½® GRAALVM_HOME ç¯å¢ƒå˜é‡ï¼š\nexport GRAALVM_HOME=`sdk home java 21.0.0.2.r11-grl` ä½¿ç”¨ gu å®‰è£… native-imageï¼š\n${GRAALVM_HOME}/bin/gu install native-image æ„å»ºæœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶ åœ¨æºç çš„ pom.xml ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ profileï¼š\n\u0026lt;profiles\u0026gt; \u0026lt;profile\u0026gt; \u0026lt;id\u0026gt;native\u0026lt;/id\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;quarkus.package.type\u0026gt;native\u0026lt;/quarkus.package.type\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;/profile\u0026gt; \u0026lt;/profiles\u0026gt; æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ª profile è¿›è¡Œæœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶çš„æ„å»ºï¼Œæ•´ä¸ªæ„å»ºè€—æ—¶ å‡ åˆ†é’Ÿ ã€‚\n./mvnw package -Pnative éƒ¨åˆ†æ„å»ºæ—¥å¿—ï¼š\n[INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ quarkus-getting-started --- [INFO] [INFO] --- quarkus-maven-plugin:1.13.0.Final:build (default) @ quarkus-getting-started --- [INFO] [org.jboss.threads] JBoss Threads version 3.2.0.Final [INFO] [io.quarkus.deployment.pkg.steps.JarResultBuildStep] Building native image source jar: /Users/addo/Workspaces/private_w/quarkus-getting-started/target/quarkus-getting-started-1.0.0-SNAPSHOT-native-image-source-jar/quarkus-getting-started-1.0.0-SNAPSHOT-runner.jar [INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildStep] Building native image from /Users/addo/Workspaces/private_w/quarkus-getting-started/target/quarkus-getting-started-1.0.0-SNAPSHOT-native-image-source-jar/quarkus-getting-started-1.0.0-SNAPSHOT-runner.jar [INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildContainerRunner] Using docker to run the native image builder [INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildContainerRunner] Checking image status quay.io/quarkus/ubi-quarkus-native-image:21.0.0-java11 21.0.0-java11: Pulling from quarkus/ubi-quarkus-native-image Digest: sha256:becf08de869e707beaa5e57444b533ef93ebef15aad90c92ac660ddf7cea2b11 Status: Image is up to date for quay.io/quarkus/ubi-quarkus-native-image:21.0.0-java11 quay.io/quarkus/ubi-quarkus-native-image:21.0.0-java11 [INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildStep] Running Quarkus native-image plugin on GraalVM Version 21.0.0 (Java Version 11.0.10+8-jvmci-21.0-b06) [INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildRunner] docker run --env LANG=C --rm -v /Users/addo/Workspaces/private_w/quarkus-getting-started/target/quarkus-getting-started-1.0.0-SNAPSHOT-native-image-source-jar:/project:z quay.io/quarkus/ubi-quarkus-native-image:21.0.0-java11 -J-Dsun.nio.ch.maxUpdateArraySize=100 -J-Djava.util.logging.manager=org.jboss.logmanager.LogManager -J-Dvertx.logger-delegate-factory-class-name=io.quarkus.vertx.core.runtime.VertxLogDelegateFactory -J-Dvertx.disableDnsResolver=true -J-Dio.netty.leakDetection.level=DISABLED -J-Dio.netty.allocator.maxOrder=1 -J-Duser.language=en -J-Duser.country=CN -J-Dfile.encoding=UTF-8 --initialize-at-build-time= -H:InitialCollectionPolicy=com.oracle.svm.core.genscavenge.CollectionPolicy\\$BySpaceAndTime -H:+JNI -H:+AllowFoldMethods -jar quarkus-getting-started-1.0.0-SNAPSHOT-runner.jar -H:FallbackThreshold=0 -H:+ReportExceptionStackTraces -J-Xmx5g -H:-AddAllCharsets -H:EnableURLProtocols=http --no-server -H:-UseServiceLoaderFeature -H:+StackTrace quarkus-getting-started-1.0.0-SNAPSHOT-runner [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] classlist: 5,859.24 ms, 0.96 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (cap): 633.34 ms, 0.94 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] setup: 2,468.19 ms, 0.94 GB 00:06:00,437 INFO [org.jbo.threads] JBoss Threads version 3.2.0.Final [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (clinit): 516.65 ms, 2.23 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (typeflow): 12,642.02 ms, 2.23 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (objects): 11,340.37 ms, 2.23 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (features): 525.87 ms, 2.23 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] analysis: 26,032.67 ms, 2.23 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] universe: 1,394.06 ms, 2.16 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (parse): 2,690.38 ms, 2.16 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (inline): 4,336.77 ms, 2.73 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (compile): 17,580.03 ms, 2.71 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] compile: 26,152.06 ms, 2.71 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] image: 3,288.43 ms, 2.70 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] write: 1,904.64 ms, 2.70 GB [quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] [total]: 67,414.16 ms, 2.70 GB [WARNING] [io.quarkus.deployment.pkg.steps.NativeImageBuildStep] objcopy executable not found in PATH. Debug symbols will not be separated from executable. [WARNING] [io.quarkus.deployment.pkg.steps.NativeImageBuildStep] That will result in a larger native image with debug symbols embedded in it. [INFO] [io.quarkus.deployment.QuarkusAugmentor] Quarkus augmentation completed in 74739ms [INFO] ------------------------------------------------------------------------ [INFO] BUILD SUCCESS [INFO] ------------------------------------------------------------------------ [INFO] Total time: 01:21 min [INFO] Finished at: 2021-04-17T08:06:47+08:00 [INFO] ------------------------------------------------------------------------ å‡å¦‚æ„å»ºæ—¶å‡ºç°ç±»ä¼¼ Caused by: java.lang.RuntimeException: Image generation failed. Exit code was 137 which indicates an out of memory error. Consider increasing the Xmx value for native image generation by setting the \u0026quot;quarkus.native.native-image-xmx\u0026quot; property è¿™ç§æŠ¥é”™ã€‚éœ€è¦è°ƒæ•´ä¸‹ Docker çš„è®¾ç½®ï¼Œæ¯”å¦‚ç¬”è€…ä½¿ç”¨çš„ macOSï¼Œæ‰“å¼€ Docker Desktop \u0026gt; Preference \u0026gt; Resource \u0026gt; Advancedï¼Œå°†å†…å­˜ä»é»˜è®¤çš„ 2GB è°ƒå¤§ï¼Œæ¯”å¦‚ 8GBã€‚\nä»æ„å»ºæ—¥å¿—å¯ä»¥çœ‹å‡ºï¼Œæ„å»ºçš„è¿‡ç¨‹æ˜¯åœ¨ quay.io/quarkus/ubi-quarkus-native-image çš„å®¹å™¨ä¸­å®Œæˆçš„ã€‚è™½ç„¶å¼‚å¸¸æç¤ºè°ƒæ•´ \u0026ldquo;quarkus.native.native-image-xmx\u0026rdquo; ï¼Œå…¶å®æ˜¯å®¹å™¨å†…å­˜å¤ªå°å¯¼è‡´çš„ã€‚\næ„å»ºæˆåŠŸåï¼Œå¯ä»¥åœ¨ target ä¸­æ‰¾åˆ° quarkus-getting-started-1.0.0-SNAPSHOT-runnerã€‚è¿™æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¤§å°ä¸º 28MBã€‚\nå°è¯•æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œæ”¶åˆ° zsh: exec format error: ./target/quarkus-getting-started-1.0.0-SNAPSHOT-runner é”™è¯¯ã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ª Linux å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨å®¹å™¨ä¸­è¿è¡Œã€‚\næ„å»ºæœ¬æœºé•œåƒ åœ¨æºæ–‡ä»¶çš„ src/main/docker ç›®å½•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ° Dockerfile.nativeï¼š\nFROM registry.access.redhat.com/ubi8/ubi-minimal:8.3 WORKDIR /work/ RUN chown 1001 /work \\ \u0026amp;\u0026amp; chmod \u0026#34;g+rwX\u0026#34; /work \\ \u0026amp;\u0026amp; chown 1001:root /work COPY --chown=1001:root target/*-runner /work/application EXPOSE 8080 USER 1001 CMD [\u0026#34;./application\u0026#34;, \u0026#34;-Dquarkus.http.host=0.0.0.0\u0026#34;] è¿è¡Œé•œåƒ æœ¬åœ°è¿è¡Œä¸€ä¸‹ï¼Œå¯ä»¥çœ‹å‡ºå¯åŠ¨åªéœ€è¦ 0.013sã€‚\ndocker run --rm -p 8080:8080 quarkus/quarkus-getting-started:latest __ ____ __ _____ ___ __ ____ ______ --/ __ \\/ / / / _ | / _ \\/ //_/ / / / __/ -/ /_/ / /_/ / __ |/ , _/ ,\u0026lt; / /_/ /\\ \\ --\\___\\_\\____/_/ |_/_/|_/_/|_|\\____/___/ 2021-04-17 00:22:27,146 INFO [io.quarkus] (main) quarkus-getting-started 1.0.0-SNAPSHOT native (powered by Quarkus 1.13.0.Final) started in 0.013s. Listening on: http://0.0.0.0:8080 2021-04-17 00:22:27,147 INFO [io.quarkus] (main) Profile prod activated. 2021-04-17 00:22:27,147 INFO [io.quarkus] (main) Installed features: [cdi, resteasy] æµ‹è¯•ä¸€ä¸‹ç«¯ç‚¹ï¼š\nhttp :8080/hello/greeting/quarkus HTTP/1.1 200 OK Content-Length: 14 Content-Type: text/plain;charset=UTF-8 Hello, quarkus çœ‹ä¸‹é•œåƒçš„ä¿¡æ¯ï¼Œå¤§å°ä¸º 132MBï¼Œå…¶ä¸­ base é•œåƒ ubi-minimal å°±å äº† 103 MBã€‚æ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹å¤§ï¼Œæ˜¯å¦ç»§ç»­ç²¾ç®€ä¸€ä¸‹ï¼Ÿ\ndocker images REPOSITORY TAG IMAGE ID CREATED SIZE quarkus/quarkus-getting-started latest 8f86f5915715 4 minutes ago 132MB registry.access.redhat.com/ubi8/ubi-minimal 8.3 604ddd554fec 2 weeks ago 103MB é•œåƒç˜¦èº« åœ¨ src/main/docker ä¸­è¿˜æœ‰ä¸ªåä¸º Dockerfile.native-distroless çš„Dockerfileï¼Œé‡Œé¢ä½¿ç”¨äº† quay.io/quarkus/quarkus-distroless-image:1.0 ä½œä¸º base é•œåƒ\nä½¿ç”¨è¿™ä¸ªDockerfileè¿›è¡Œæ„å»ºï¼Œå¾—åˆ°çš„é•œåƒå°±å°å¾ˆå¤šï¼Œåªæœ‰ 51MBï¼š\ndocker images REPOSITORY TAG IMAGE ID CREATED SIZE quarkus/quarkus-getting-started distroless 6fe27dd44e86 33 seconds ago 51MB quarkus/quarkus-getting-started ubi 8f86f5915715 27 minutes ago 132MB quay.io/quarkus/quarkus-distroless-image 1.0 062663862a83 6 days ago 21.3MB registry.access.redhat.com/ubi8/ubi-minimal 8.3 604ddd554fec 2 weeks ago 103MB è¿è¡ŒæˆåŠŸï¼š\ndocker run --rm -p 8080:8080 quarkus/quarkus-getting-started:distroless __ ____ __ _____ ___ __ ____ ______ --/ __ \\/ / / / _ | / _ \\/ //_/ / / / __/ -/ /_/ / /_/ / __ |/ , _/ ,\u0026lt; / /_/ /\\ \\ --\\___\\_\\____/_/ |_/_/|_/_/|_|\\____/___/ 2021-04-17 00:51:26,070 INFO [io.quarkus] (main) quarkus-getting-started 1.0.0-SNAPSHOT native (powered by Quarkus 1.13.0.Final) started in 0.013s. Listening on: http://0.0.0.0:8080 2021-04-17 00:51:26,071 INFO [io.quarkus] (main) Profile prod activated. 2021-04-17 00:51:26,071 INFO [io.quarkus] (main) Installed features: [cdi, resteasy] æè‡´ç˜¦èº«ï¼Œå‚è€ƒäº†è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»º Dockerfile.native-distroless2ã€‚\næœ€ç»ˆé•œåƒçš„å¤§å°ä¸º 49MBï¼Œä¸å®˜æ–¹æä¾›çš„ distroless base é•œåƒåªå°äº† 2MBã€‚\ndocker images REPOSITORY TAG IMAGE ID CREATED SIZE quarkus/quarkus-getting-started distroless2 fe973c5ac172 3 seconds ago 49MB å‰é¢å¯¹æ¯”ï¼Œç”¨æ¥æ„å»º Spring åº”ç”¨çš„ base é•œåƒ openjdk:11.0-jre-slim å·²ç»æœ‰ 220MBï¼Œè¿™è¿˜æ²¡ç®—ä¸Šåº”ç”¨çš„å¤§å°ã€‚å³ä½¿æ˜¯ openjdk:17-alpine3.13 ä¹Ÿæœ‰ 182 MBã€‚\nNEXT ä¸‹ä¸€å›ï¼Œæˆ‘ä»¬è¯•è¯• Quarkus åœ¨ ArgoCD ä¸­çš„åº”ç”¨ï¼Œçœ‹ä¸‹ Serverless ä¸Šçš„ä½¿ç”¨ä½“éªŒå¦‚ä½•ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/quarkus-build-native-executable-file/","tags":["äº‘åŸç”Ÿ","Java","Quarkus","Graalvm","Container"],"title":"åº”â€œäº‘â€è€Œç”Ÿçš„ Java æ¡†æ¶ï¼šæ„å»ºæœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶"},{"categories":["ç¬”è®°"],"contents":"Wikipediaä¸Šæœ‰å…³ Quarkus çš„ä¿¡æ¯è¿˜å¾ˆå°‘ï¼Œåªæœ‰ä¸€å¥ç®€å•çš„ä»‹ç»ï¼š\nQuarkus æ˜¯ä¸“ä¸º OpenJDK HotSpot å’Œ GraalVM å®šåˆ¶çš„å…¨æ ˆ Kubernetes åŸç”Ÿ Java åº”ç”¨ç¨‹åºæ¡†æ¶ã€‚ä¸å¦‚ Spring ä¹‹ç±»çš„å…¶ä»–æ¡†æ¶ç›¸æ¯”ï¼Œå®ƒæä¾›äº†è¾ƒå°çš„å†…å­˜å ç”¨å¹¶ç¼©çŸ­äº†å¯åŠ¨æ—¶é—´ã€‚å®ƒå…è®¸ç»“åˆå‘½ä»¤å¼å’Œéé˜»å¡å“åº”å¼ç¼–ç¨‹ã€‚\nä» Quarkus çš„å®˜ç½‘ï¼Œå¯ä»¥çœ‹åˆ°å…¶æœ‰å‡ ä¸ªç‰¹æ€§ï¼š\nå®¹å™¨ä¼˜å…ˆ ç»Ÿä¸€äº†å‘½ä»¤å¼å’Œå“åº”å¼ç¼–ç¨‹ å¼€å‘è€…å‹å¥½ æœ€ä½³å“ç§çš„åº“åŠæ ‡å‡† æ›´å¤š Quarkus å¯ä»¥å‚è€ƒå®˜ç½‘çš„ä»‹ç»åŠæ–‡æ¡£ã€‚ä»Šå¤©ä¸»è¦å°±æ˜¯è·‘ä¸€ä¸‹ Quarkus çš„ Hello worldã€‚\næ”¾ä¸€å¼ å®˜ç½‘çš„å›¾ï¼š\nç¯å¢ƒå‡†å¤‡ åŸºäº Java 11 çš„ GraalVM Maven 3.6.2+ ç¬”è€…ä½¿ç”¨çš„æ˜¯ macos 10.15.4ï¼ŒGraalVM å’Œ Maven å»ºè®®é€šè¿‡ sdkman è¿›è¡Œå®‰è£…ã€‚\n$ sdk install java 21.0.0.2.r11-grl #å¦‚æœå·²ä½¿ç”¨å…¶ä»– java ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ sdk use java 21.0.0.2.r11-grl è¿›è¡Œåˆ‡æ¢ $ sdk install maven 3.6.3 éªŒè¯å®‰è£… $ java -version openjdk version \u0026#34;11.0.10\u0026#34; 2021-01-19 OpenJDK Runtime Environment GraalVM CE 21.0.0.2 (build 11.0.10+8-jvmci-21.0-b06) OpenJDK 64-Bit Server VM GraalVM CE 21.0.0.2 (build 11.0.10+8-jvmci-21.0-b06, mixed mode, sharing) $ mvn -version Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f) Maven home: /Users/addo/.sdkman/candidates/maven/current Java version: 11.0.10, vendor: GraalVM Community, runtime: /Users/addo/.sdkman/candidates/java/21.0.0.2.r11-grl Default locale: en_CN, platform encoding: UTF-8 OS name: \u0026#34;mac os x\u0026#34;, version: \u0026#34;10.15.4\u0026#34;, arch: \u0026#34;x86_64\u0026#34;, family: \u0026#34;mac\u0026#34; å¿«é€Ÿå¼€å§‹ åˆ›å»ºé¡¹ç›® åˆ›å»º quarkus é¡¹ç›®æœ€å¿«çš„æ–¹å¼æ˜¯é€šè¿‡ quarkus-maven-plugin æ¥åˆ›å»ºï¼Œä½¿ç”¨å¦‚ä¸‹çš„å‘½ä»¤å¿«é€Ÿå¯ä»¥åˆ›å»º\n$ mvn io.quarkus:quarkus-maven-plugin:1.13.0.Final:create \\ -DprojectGroupId=com.atbug.quickstart \\ -DprojectArtifactId=quarkus-getting-started \\ -DclassName=\u0026#34;com.atbug.quickstart.GreetingResource\u0026#34; \\ -Dpath=\u0026#34;/hello\u0026#34; åœ¨ ./quarkus-getting-started ä¸­æä¾›äº†ï¼š\nmaven çš„é¡¹ç›®ç»“æ„ com.atbug.quickstart.GreetingResource æš´éœ²äº† /hello ç«¯ç‚¹ï¼Œé€šè¿‡ JAX-RS æ³¨è§£å®ç° ç›¸å…³çš„å•å…ƒæµ‹è¯• åº”ç”¨å¯åŠ¨åå¯ä»¥é€šè¿‡ http://localhost:8080 æ‰“å¼€çš„å¯åŠ¨é¡µé¢ src/main/docker ä¸‹æä¾›äº† native å’Œ jvm é£æ ¼çš„ Dockerfile åº”ç”¨é…ç½®æ–‡ä»¶ è¿è¡Œåº”ç”¨ æ‰§è¡Œ ./mvnw compile quarkus:dev å‘½ä»¤å¯å¯åŠ¨åº”ç”¨\n__ ____ __ _____ ___ __ ____ ______ --/ __ \\/ / / / _ | / _ \\/ //_/ / / / __/ -/ /_/ / /_/ / __ |/ , _/ ,\u0026lt; / /_/ /\\ \\ --\\___\\_\\____/_/ |_/_/|_/_/|_|\\____/___/ 2021-04-05 19:48:36,419 INFO [io.quarkus] (Quarkus Main Thread) quarkus-getting-started 1.0.0-SNAPSHOT on JVM (powered by Quarkus 1.13.0.Final) started in 2.135s. Listening on: http://localhost:8080 2021-04-05 19:48:36,448 INFO [io.quarkus] (Quarkus Main Thread) Profile dev activated. Live Coding activated. 2021-04-05 19:48:36,448 INFO [io.quarkus] (Quarkus Main Thread) Installed features: [cdi, resteasy] è®¿é—® /hello æ–­ç‚¹\n$ http :8080/hello HTTP/1.1 200 OK Content-Length: 5 Content-Type: text/plain;charset=UTF-8 Hello ç¬”è€…é€šè¿‡ httpie è¿›è¡Œè®¿é—®ï¼Œå¯ä»¥é€šè¿‡ brew install httpie è¿›è¡Œå®‰è£…ï¼Œæ¨èä½¿ç”¨ã€‚\nå¢åŠ æ–°çš„æ–­ç‚¹ @GET @Produces(MediaType.TEXT_PLAIN) @Path(\u0026#34;/greeting/{name}\u0026#34;) public String greeting(@PathParam String name) { return \u0026#34;Hello, \u0026#34; + name; } æ³¨ï¼šPathParam æ¥è‡ª org.jboss.resteasy.annotations.jaxrs.PathParam\næµ‹è¯•ï¼š\n$ http :8080/hello/greeting/Quarkus HTTP/1.1 200 OK Content-Length: 14 Content-Type: text/plain;charset=UTF-8 Hello, Quarkus ä¸ºæ–°çš„ç«¯ç‚¹å¢åŠ å•å…ƒæµ‹è¯•\n@Test public void testGreetingEndpoint() { final String uuid = UUID.randomUUID().toString(); given() .pathParam(\u0026#34;name\u0026#34;, uuid) .when().get(\u0026#34;/hello/greeting/{name}\u0026#34;) .then() .statusCode(200) .body(is(\u0026#34;Hello, \u0026#34; + uuid)); } é€šè¿‡ ./mvnw test è¿è¡Œå•å…ƒæµ‹è¯•\næ³¨æ„è¿™é‡Œä½¿ç”¨ intellij è¿è¡Œå•å…ƒæµ‹è¯•çš„è¯ï¼Œä¼šæŠ¥é”™ã€‚éœ€è¦ä¿®æ”¹ Java Compiler çš„é…ç½®ï¼Œæ·»åŠ é¢å¤–çš„å‘½ä»¤è¡Œå‚æ•° -parameters\næ‰“åŒ… ä¸é€šå¸¸çš„ maven é¡¹ç›®æ‰“åŒ…æ–¹å¼ä¸€æ ·ï¼Œæ‰§è¡Œ ./mvnw packageï¼Œåœ¨ target ç›®å½•ä¸­ï¼š\nquarkus-getting-started-1.0.0-SNAPSHOT.jar ä»…åŒ…å«äº†é¡¹ç›®ç¼–è¯‘çš„ç±»å’Œèµ„æºæ–‡ä»¶ï¼Œæ˜¯ä¸å¯æ‰§è¡Œçš„ jar quarkus-app ç›®å½•ä¸­åŒ…å«äº†å¯æ‰§è¡Œçš„ jar æ–‡ä»¶ quarkus-run.jar ï¼Œä½†æ˜¯ï¼Œå…¶å¹¶ä¸æ˜¯ä¸€ä¸ª Ã¼ber-jarï¼Œé¡¹ç›®çš„ä¾èµ–åº“éƒ½ä½äº libç›®å½•ä¸­ã€‚ å¯ä»¥é€šè¿‡æ‰§è¡Œ java -jar target/quarkus-app/quarkus-run.jar åœ¨å¯åŠ¨åº”ç”¨ã€‚\nè¿™æ„å‘³ç€å‡å¦‚ä½ æƒ³åœ¨å®¹å™¨ä¸­è¿è¡Œï¼Œéœ€è¦éƒ¨ç½²æ•´ä¸ª quarkus-app ç›®å½•\nä½¿ç”¨ fast-jar qurakus çš„æ‰“åŒ…æ–¹å¼æœ‰ä¸¤ç§ï¼šlegacy-jar å’Œ fast-jarã€‚å¯ä»¥åœ¨ application.properties æ–‡ä»¶ä¸­è¿›è¡ŒæŒ‡å®šï¼Œæœªæ˜¾å¼æŒ‡å®šé»˜è®¤ä¸º legacy-jarã€‚\nquarkus.package.type=fast-jar å¦‚æœè¦åœ¨å®¹å™¨ä¸­è¿è¡Œï¼ŒåŒæ ·éœ€è¦éƒ¨ç½²æ•´ä¸ª quarkus-app ç›®å½• fast-jar ç±»å‹çš„åŒ…æ¯” legacy-jar çš„åŒ…å¯åŠ¨ä¼šå¿«ä¸€ç‚¹ç‚¹ï¼ŒåŒæ—¶å ç”¨çš„å†…å­˜ä¹Ÿæ›´ä½ã€‚å› ä¸º fast-jar çš„åŒ…å«äº†ä¾èµ–åŒ…ä¸­çš„ç±»å’Œèµ„æºæ–‡ä»¶çš„ç´¢å¼•ï¼Œé¿å…åœ¨ç±»å’Œèµ„æºæ–‡ä»¶åŠ è½½æ—¶å¯¹ classpath ä¸‹çš„åŒ…çš„æŸ¥æ‰¾ã€‚\nä¸‹ä¸€ç¯‡ï¼Œè¯•è¯•æ„å»ºä¸€ä¸ªåŸç”Ÿçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/hello-quarkus/","tags":["äº‘åŸç”Ÿ","Java","Graalvm"],"title":"åº”â€œäº‘â€è€Œç”Ÿçš„ Java æ¡†æ¶ï¼šHello, Quarkus"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬æ–‡è¯‘è‡ª The Evolution of Distributed Systems on Kubernetes\nåœ¨ 3 æœˆä»½çš„ QCon ä¸Šï¼Œæˆ‘åšäº†ä¸€ä¸ªå…³äº Kubernetes çš„åˆ†å¸ƒå¼ç³»ç»Ÿè¿›åŒ–çš„æ¼”è®²ã€‚é¦–å…ˆï¼Œæˆ‘æƒ³å…ˆé—®ä¸€ä¸ªé—®é¢˜ï¼Œå¾®æœåŠ¡ä¹‹åæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ç›¸ä¿¡å¤§å®¶éƒ½æœ‰å„è‡ªçš„ç­”æ¡ˆï¼Œæˆ‘ä¹Ÿæœ‰æˆ‘çš„ç­”æ¡ˆã€‚ä½ ä¼šåœ¨æœ€åå‘ç°æˆ‘çš„æƒ³æ³•æ˜¯ä»€ä¹ˆã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæˆ‘å»ºè®®å¤§å®¶çœ‹çœ‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Ÿä»¥åŠè¿™äº›éœ€æ±‚åœ¨è¿‡å»æ˜¯å¦‚ä½•å‘å±•çš„ï¼Œä»å•ä½“åº”ç”¨å¼€å§‹åˆ° Kubernetesï¼Œå†åˆ°æœ€è¿‘çš„ Daprã€Istioã€Knative ç­‰é¡¹ç›®ï¼Œå®ƒä»¬æ˜¯å¦‚ä½•æ”¹å˜æˆ‘ä»¬åšåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ–¹å¼ã€‚æˆ‘ä»¬å°†å°è¯•å¯¹æœªæ¥åšä¸€äº›é¢„æµ‹ã€‚\nç°ä»£åˆ†å¸ƒå¼åº”ç”¨ ä¸ºäº†ç»™è¿™ä¸ªè¯é¢˜æä¾›æ›´å¤šçš„èƒŒæ™¯ä¿¡æ¯ï¼Œæˆ‘è®¤ä¸ºçš„åˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ç”±æ•°ç™¾ä¸ªç»„ä»¶ç»„æˆçš„ç³»ç»Ÿã€‚è¿™äº›ç»„ä»¶å¯ä»¥æ˜¯æœ‰çŠ¶æ€çš„ã€æ— çŠ¶æ€çš„æˆ–è€…æ— æœåŠ¡å™¨çš„ã€‚æ­¤å¤–ï¼Œè¿™äº›ç»„ä»¶å¯ä»¥ç”¨ä¸åŒçš„è¯­è¨€åˆ›å»ºï¼Œè¿è¡Œåœ¨æ··åˆç¯å¢ƒä¸Šï¼Œå¹¶å¼€å‘å¼€æºæŠ€æœ¯ã€å¼€æ”¾æ ‡å‡†å’Œäº’æ“ä½œæ€§ã€‚æˆ‘ç›¸ä¿¡ä½ å¯ä»¥ä½¿ç”¨é—­æºè½¯ä»¶æ¥æ„å»ºè¿™æ ·çš„ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥åœ¨ AWS å’Œå…¶ä»–åœ°æ–¹æ„å»ºã€‚å…·ä½“åˆ°è¿™æ¬¡æ¼”è®²ï¼Œæˆ‘å°†å…³æ³¨ Kubernetes ç”Ÿæ€ç³»ç»Ÿï¼Œä»¥åŠä½ å¦‚ä½•åœ¨ Kubernetes å¹³å°ä¸Šæ„å»ºè¿™æ ·ä¸€ä¸ªç³»ç»Ÿã€‚\næˆ‘ä»¬ä»åˆ†å¸ƒå¼ç³»ç»Ÿçš„éœ€æ±‚è®²èµ·ã€‚æˆ‘è®¤ä¸ºæ˜¯æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªåº”ç”¨æˆ–è€…æœåŠ¡ï¼Œå¹¶å†™ä¸€äº›ä¸šåŠ¡é€»è¾‘ã€‚é‚£ä»è¿è¡Œæ—¶çš„å¹³å°åˆ°æ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä»€ä¹ˆå‘¢ï¼Ÿåœ¨åº•å±‚ï¼Œæœ€å¼€å§‹æ˜¯æˆ‘ä»¬è¦ä¸€äº›ç”Ÿå‘½å‘¨æœŸçš„èƒ½åŠ›ã€‚å½“ä½ ç”¨ä»»ä¸€è¯­è¨€å¼€å‘ä½ çš„åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰èƒ½åŠ›æŠŠè¿™ä¸ªåº”ç”¨å¯é åœ°æ‰“åŒ…å’Œéƒ¨ç½²ã€å›æ»šã€å¥åº·æ£€æŸ¥ã€‚å¹¶ä¸”èƒ½å¤ŸæŠŠåº”ç”¨éƒ¨ç½²åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œå¹¶å®ç°èµ„æºéš”ç¦»ã€æ‰©å±•ã€é…ç½®ç®¡ç†ï¼Œä»¥åŠæ‰€æœ‰è¿™äº›ã€‚è¿™äº›éƒ½æ˜¯ä½ åˆ›å»ºåˆ†å¸ƒå¼åº”ç”¨æ‰€éœ€è¦çš„ç¬¬ä¸€ç‚¹ã€‚\nç¬¬äºŒç‚¹æ˜¯å›´ç»•ç½‘ç»œã€‚æˆ‘ä»¬æœ‰äº†åº”ç”¨ä¹‹åï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒèƒ½å¤Ÿå¯é åœ°è¿æ¥åˆ°å…¶ä»–æœåŠ¡ï¼Œæ— è®ºè¯¥æœåŠ¡æ˜¯åœ¨é›†ç¾¤å†…éƒ¨è¿˜æ˜¯åœ¨å¤–éƒ¨ã€‚æˆ‘ä»¬å¸Œæœ›å…¶å…·æœ‰æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ã€‚ä¸ºäº†ä¸åŒçš„å‘å¸ƒç­–ç•¥æˆ–æ˜¯å…¶ä»–çš„ä¸€äº›åŸå› çš„æˆ‘ä»¬å¸Œæœ›æœ‰æµé‡è½¬ç§»çš„èƒ½åŠ›ã€‚ç„¶åæˆ‘ä»¬è¿˜å¸Œæœ›å…¶å…·æœ‰ä¸å…¶ä»–ç³»ç»Ÿè¿›è¡Œå¼¹æ€§é€šä¿¡çš„èƒ½åŠ›ï¼Œæ— è®ºæ˜¯é€šè¿‡é‡è¯•ã€è¶…æ—¶è¿˜æ˜¯æ–­è·¯å™¨ã€‚è¦æœ‰é€‚å½“çš„å®‰å…¨ä¿éšœï¼Œå¹¶ä¸”è¦æœ‰è¶³å¤Ÿçš„ç›‘æ§ã€è¿½è¸ªã€å¯è§‚å¯Ÿæ€§ç­‰ç­‰ã€‚\næˆ‘ä»¬æœ‰äº†ç½‘ç»œä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬å¸Œæœ›æœ‰èƒ½åŠ›ä¸ä¸åŒçš„ API å’Œç«¯ç‚¹äº¤äº’ï¼Œå³èµ„æºç»‘å®š\u0026ndash;ä¸å…¶ä»–åè®®å’Œä¸åŒçš„æ•°æ®æ ¼å¼äº¤äº’ã€‚ç”šè‡³èƒ½å¤Ÿä»ä¸€ç§æ•°æ®æ ¼å¼è½¬æ¢æˆå¦ä¸€ç§æ•°æ®æ ¼å¼ã€‚æˆ‘è¿˜ä¼šåœ¨è¿™é‡ŒåŠ å…¥è¯¸å¦‚æ»¤å…‰çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬è®¢é˜…ä¸€ä¸ªä¸»é¢˜æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè®¸åªå¯¹æŸäº›äº‹ä»¶æ„Ÿå…´è¶£ã€‚\nä½ è®¤ä¸ºæœ€åä¸€ç±»æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯çŠ¶æ€ã€‚å½“æˆ‘åœ¨è¯´çŠ¶æ€å’Œæœ‰çŠ¶æ€çš„æŠ½è±¡æ—¶ï¼Œæˆ‘å¹¶ä¸æ˜¯åœ¨è°ˆè®ºå®é™…çš„çŠ¶æ€ç®¡ç†ï¼Œæ¯”å¦‚æ•°æ®åº“æˆ–è€…æ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½ã€‚æˆ‘è¦è¯´çš„æ›´å¤šæ˜¯æœ‰å…³å¹•åä¾èµ–çŠ¶æ€çš„å¼€å‘äººå‘˜æŠ½è±¡ã€‚å¯èƒ½ï¼Œä½ éœ€è¦å…·æœ‰å·¥ä½œæµç®¡ç†çš„èƒ½åŠ›ã€‚ä¹Ÿè®¸ä½ æƒ³ç®¡ç†è¿è¡Œæ—¶é—´é•¿çš„è¿›ç¨‹æˆ–è€…åšä¸´æ—¶è°ƒåº¦æˆ–è€…æŸäº›å®šæ—¶ä»»åŠ¡æ¥å®šæœŸè¿è¡ŒæœåŠ¡ã€‚ä¹Ÿè®¸ä½ è¿˜æƒ³è¿›è¡Œåˆ†å¸ƒå¼ç¼“å­˜ï¼Œå…·æœ‰å¹‚ç­‰æ€§æˆ–è€…æ”¯æŒå›æ»šã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯å¼€å‘äººå‘˜çº§çš„åŸè¯­ï¼Œä½†åœ¨å¹•åï¼Œå®ƒä»¬ä¾èµ–äºå…·æœ‰æŸç§çŠ¶æ€ã€‚ä½ æƒ³éšæ„ä½¿ç”¨è¿™äº›æŠ½è±¡ä¿©åˆ›å»ºå®Œå–„çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚\næˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªåˆ†å¸ƒå¼ç³»ç»ŸåŸè¯­çš„æ¡†æ¶æ¥è¯„ä¼°å®ƒä»¬åœ¨ Kubernetes å’Œå…¶ä»–é¡¹ç›®ä¸Šçš„å˜åŒ–æƒ…å†µã€‚\nå•ä½“æ¶æ„ \u0026ndash; ä¼ ç»Ÿä¸­é—´ä»¶åŠŸèƒ½ å‡è®¾æˆ‘ä»¬ä»å•ä½“æ¶æ„ä»¥åŠå¦‚ä½•è·å¾—è¿™äº›èƒ½åŠ›å¼€å§‹ã€‚åœ¨é‚£ç§æƒ…å†µä¸‹ï¼Œé¦–å…ˆæ˜¯å½“æˆ‘è¯´å•ä½“çš„æ—¶å€™ï¼Œåœ¨åˆ†å¸ƒå¼åº”ç”¨çš„æƒ…å†µä¸‹æˆ‘æƒ³åˆ°çš„æ˜¯ ESBã€‚ESB æ˜¯ç›¸å½“å¼ºå¤§çš„ï¼Œå½“æˆ‘ä»¬æ£€æŸ¥æˆ‘ä»¬çš„éœ€æ±‚åˆ—è¡¨æ—¶ï¼Œæˆ‘ä»¬ä¼šè¯´ ESB å¯¹æ‰€æœ‰æœ‰çŠ¶æ€çš„æŠ½è±¡æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚\nä½¿ç”¨ ESBï¼Œä½ å¯ä»¥è¿›è¡Œé•¿æ—¶é—´è¿è¡Œçš„æµç¨‹çš„ç¼–æ’ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€å›æ»šå’Œå¹‚ç­‰ã€‚æ­¤å¤–ï¼ŒESB è¿˜æä¾›äº†å‡ºè‰²çš„èµ„æºç»‘å®šèƒ½åŠ›ï¼Œå¹¶ä¸”æœ‰æ•°ç™¾ä¸ªè¿æ¥å™¨ï¼Œæ”¯æŒè½¬æ¢ã€ç¼–æ’ï¼Œç”šè‡³æœ‰è”ç½‘åŠŸèƒ½ã€‚æœ€åï¼ŒESB ç”šè‡³å¯ä»¥åšæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚\nå®ƒå…·æœ‰å›´ç»•ç½‘ç»œè¿æ¥çš„å¼¹æ€§çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå› æ­¤å®ƒå¯ä»¥è¿›è¡Œé‡è¯•ã€‚å¯èƒ½ ESB æœ¬è´¨ä¸Šä¸æ˜¯å¾ˆåˆ†å¸ƒå¼ï¼Œæ‰€ä»¥å®ƒä¸éœ€è¦éå¸¸é«˜çº§çš„ç½‘ç»œå’Œå‘å¸ƒèƒ½åŠ›ã€‚ESB æ¬ ç¼ºçš„ä¸»è¦æ˜¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚å› ä¸ºå®ƒæ˜¯å•ä¸€è¿è¡Œæ—¶ï¼Œæ‰€ä»¥ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ä½ åªèƒ½ä½¿ç”¨ä¸€ç§è¯­è¨€ã€‚é€šå¸¸æ˜¯åˆ›å»ºå®é™…è¿è¡Œæ—¶çš„è¯­è¨€ï¼ŒJavaã€.NETã€æˆ–è€…å…¶ä»–çš„è¯­è¨€ã€‚ç„¶åï¼Œå› ä¸ºæ˜¯å•ä¸€è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½è½»æ¾åœ°è¿›è¡Œå£°æ˜å¼çš„éƒ¨ç½²æˆ–è€…è‡ªåŠ¨é˜²æ­¢ã€‚éƒ¨ç½²æ˜¯ç›¸å½“å¤§ä¸”éå¸¸é‡çš„ï¼Œæ‰€ä»¥å®ƒé€šå¸¸æ¶‰åŠåˆ°äººæœºäº¤äº’ã€‚è¿™ç§å•ä½“æ¶æ„çš„å¦ä¸€ä¸ªéš¾ç‚¹æ˜¯æ‰©å±•ï¼šâ€œæˆ‘ä»¬æ— æ³•æ‰©å±•å•ä¸ªç»„ä»¶ã€‚â€\næœ€åå´å¹¶éæœ€ä¸é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œå›´ç»•éš”ç¦»ï¼Œæ— è®ºæ˜¯èµ„æºéš”ç¦»è¿˜æ˜¯æ•…éšœéš”ç¦»ã€‚ä½¿ç”¨å•ä½“æ¶æ„æ— æ³•å®Œæˆæ‰€æœ‰è¿™äº›å·¥ä½œã€‚ä»æˆ‘ä»¬çš„éœ€æ±‚æ¡†æ¶æ¥çœ‹ï¼ŒESB çš„å•ä½“æ¶æ„ä¸ç¬¦åˆæ¡ä»¶ã€‚\näº‘åŸç”Ÿæ¶æ„ \u0026ndash; å¾®æœåŠ¡å’Œ Kubernetes æ¥ä¸‹æ¥ï¼Œæˆ‘å»ºè®®æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹äº‘åŸç”Ÿæ¶æ„ä»¥åŠè¿™äº›éœ€æ±‚æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚å¦‚æœæˆ‘ä»¬ä»ä¸€ä¸ªéå¸¸é«˜çš„å±‚é¢æ¥çœ‹ï¼Œè¿™äº›æ¶æ„æ˜¯å¦‚ä½•å‘ç”Ÿå˜åŒ–çš„ï¼Œäº‘åŸç”Ÿå¯èƒ½å§‹äºå¾®æœåŠ¡è¿åŠ¨ã€‚å¾®æœåŠ¡ä½¿æˆ‘ä»¬å¯ä»¥æŒ‰ä¸šåŠ¡é¢†åŸŸè¿›è¡Œæ‹†åˆ†å•ä½“åº”ç”¨ã€‚äº‹å®è¯æ˜ï¼Œå®¹å™¨å’Œ Kubernetes å®é™…ä¸Šæ˜¯ç®¡ç†è¿™äº›å¾®æœåŠ¡çš„ä¼˜ç§€å¹³å°ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Kubernetes å¯¹äºå¾®æœåŠ¡ç‰¹åˆ«æœ‰å¸å¼•åŠ›çš„ä¸€äº›å…·ä½“ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚\nä»ä¸€å¼€å§‹ï¼Œè¿›è¡Œå¥åº·çŠ¶å†µæ¢æµ‹çš„èƒ½åŠ›å°±æ˜¯ Kubernetes å—æ¬¢è¿çš„åŸå› ã€‚åœ¨å®è·µä¸­ï¼Œè¿™æ„å‘³ç€å½“ä½ å°†å®¹å™¨éƒ¨ç½²åˆ° Pod ä¸­æ—¶ï¼ŒKubernetes ä¼šæ£€æŸ¥è¿›ç¨‹çš„è¿è¡ŒçŠ¶å†µã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¯¥è¿‡ç¨‹æ¨¡å‹è¿˜ä¸å¤Ÿå¥½ã€‚ä½ å¯èƒ½ä»ç„¶æœ‰ä¸€ä¸ªå·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œä½†æ˜¯å®ƒå¹¶ä¸å¥åº·ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿˜å¯ä»¥ä½¿ç”¨å°±ç»ªåº¦å’Œå­˜æ´»åº¦æ£€æŸ¥çš„åŸå› ã€‚Kubernetes ä¼šåšä¸€ä¸ªå°±ç»ªåº¦æ£€æŸ¥ï¼Œä»¥ç¡®å®šä½ çš„åº”ç”¨åœ¨å¯åŠ¨æœŸé—´ä½•æ—¶å‡†å¤‡æ¥å—æµé‡ã€‚å®ƒå°†è¿›è¡Œæ´»è·ƒåº¦æ£€æŸ¥ï¼Œä»¥æ£€æŸ¥æœåŠ¡çš„è¿è¡ŒçŠ¶å†µã€‚åœ¨ Kubernetes ä¹‹å‰ï¼Œè¿™å¹¶ä¸æ˜¯å¾ˆæµè¡Œï¼Œä½†ä»Šå¤©å‡ ä¹æ‰€æœ‰è¯­è¨€ã€æ‰€æœ‰æ¡†æ¶ã€æ‰€æœ‰è¿è¡Œæ—¶éƒ½æœ‰å¥åº·æ£€æŸ¥åŠŸèƒ½ï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­å¿«é€Ÿå¯åŠ¨ç«¯ç‚¹ã€‚\nKubernetes å¼•å…¥çš„ä¸‹ä¸€ä¸ªç‰¹æ€§æ˜¯å›´ç»•åº”ç”¨ç¨‹åºçš„æ‰˜ç®¡ç”Ÿå‘½å‘¨æœŸ\u0026ndash;æˆ‘çš„æ„æ€æ˜¯ï¼Œä½ ä¸å†æ§åˆ¶ä½•æ—¶å¯åŠ¨ã€ä½•æ—¶å…³é—­æœåŠ¡ã€‚ä½ ç›¸ä¿¡å¹³å°å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚Kubernetes å¯ä»¥å¯åŠ¨ä½ çš„åº”ç”¨ï¼›å®ƒå¯ä»¥å°†å…¶å…³é—­ï¼Œç„¶ååœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šç§»åŠ¨å®ƒã€‚ä¸ºæ­¤ï¼Œä½ å¿…é¡»æ­£ç¡®æ‰§è¡Œå¹³å°åœ¨åº”ç”¨å¯åŠ¨å’Œå…³é—­æœŸé—´å‘Šè¯‰ä½ çš„äº‹ä»¶ã€‚\nKubernetes åˆ˜å…´çš„å¦ä¸€ä»¶ç‰¹æ€§æ˜¯å›´ç»•ç€å£°æ˜å¼éƒ¨ç½²ã€‚è¿™æ„å‘³ç€ä½ ä¸å†éœ€è¦å¯åŠ¨æœåŠ¡ï¼›æ£€æŸ¥æ—¥å¿—æ˜¯å¦å·²ç»å¯åŠ¨ã€‚ä½ ä¸å¿…æ‰‹åŠ¨å‡çº§å®ä¾‹\u0026ndash;æ”¯æŒå£°æ˜å¼éƒ¨ç½²çš„ Kubernetes å¯ä»¥ä¸ºä½ åšåˆ°è¿™ä¸€ç‚¹ã€‚æ ¹æ®ä½ é€‰æ‹©çš„ç­–ç•¥ï¼Œå®ƒå¯ä»¥åœæ­¢æ—§å®ä¾‹å¹¶å¯åŠ¨æ–°å®ä¾‹ã€‚æ­¤å¤–ï¼Œå¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥è¿›è¡Œå›æ»šã€‚\nå¦å¤–å°±æ˜¯å£°æ˜ä½ çš„èµ„æºéœ€æ±‚ã€‚åˆ›å»ºæœåŠ¡æ—¶ï¼Œå°†å…¶å®¹å™¨åŒ–ã€‚æœ€å¥½å‘Šè¯‰å¹³å°è¯¥æœåŠ¡å°†éœ€è¦å¤šå°‘ CPU å’Œå†…å­˜ã€‚Kubernetes åˆ©ç”¨è¿™äº›ä¿¡æ¯ä¸ºä½ çš„å·¥ä½œè´Ÿè½½æ‰¾åˆ°æœ€ä½³èŠ‚ç‚¹ã€‚åœ¨ä½¿ç”¨ Kubernetes ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»æ ¹æ®æˆ‘ä»¬çš„æ ‡å‡†å°†å®ä¾‹æ‰‹åŠ¨æ”¾ç½®åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„åå¥½æ¥æŒ‡å¯¼ Kubernetesï¼Œå®ƒå°†ä¸ºæˆ‘ä»¬åšå‡ºæœ€ä½³çš„å†³ç­–ã€‚\nå¦‚ä»Šï¼Œåœ¨ Kubernetes ä¸Šï¼Œä½ å¯ä»¥è¿›è¡Œå¤šè¯­è¨€é…ç½®ç®¡ç†ã€‚æ— éœ€åœ¨åº”ç”¨ç¨‹åºè¿è¡Œæ—¶è¿›è¡Œé…ç½®æŸ¥æ‰¾å°±å¯ä»¥è¿›è¡Œä»»ä½•æ“ä½œã€‚Kubernetes ä¼šç¡®ä¿é…ç½®æœ€ç»ˆåœ¨å·¥ä½œè´Ÿè½½æ‰€åœ¨çš„åŒä¸€èŠ‚ç‚¹ä¸Šã€‚è¿™äº›é…ç½®è¢«æ˜ å°„ä¸ºå·æˆ–ç¯å¢ƒå˜é‡ï¼Œä»¥ä¾›ä½ çš„åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚\näº‹å®è¯æ˜ï¼Œæˆ‘åˆšæ‰è°ˆåˆ°çš„é‚£äº›ç‰¹å®šåŠŸèƒ½ä¹Ÿæ˜¯ç›¸å…³çš„ã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æœè¦è¿›è¡Œè‡ªåŠ¨æ”¾ç½®ï¼Œåˆ™å¿…é¡»å‘Šè¯‰ Kubernetes æœåŠ¡çš„èµ„æºéœ€æ±‚ã€‚ç„¶åï¼Œä½ å¿…é¡»å‘Šè¯‰å®ƒè¦ä½¿ç”¨çš„éƒ¨ç½²ç­–ç•¥ã€‚ä¸ºäº†è®©ç­–ç•¥æ­£ç¡®è¿è¡Œï¼Œä½ çš„åº”ç”¨ç¨‹åºå¿…é¡»æ‰§è¡Œæ¥è‡ªç¯å¢ƒçš„äº‹ä»¶ã€‚å®ƒå¿…é¡»æ‰§è¡Œå¥åº·æ£€æŸ¥ã€‚ä¸€æ—¦é‡‡ç”¨äº†æ‰€æœ‰è¿™äº›æœ€ä½³å®è·µå¹¶ä½¿ç”¨æ‰€æœ‰è¿™äº›åŠŸèƒ½ï¼Œä½ çš„åº”ç”¨å°±ä¼šæˆä¸ºå‡ºè‰²çš„äº‘åŸç”Ÿå…¬æ°‘ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ Kubernetes ä¸Šå®ç°è‡ªåŠ¨åŒ–äº†ï¼ˆè¿™æ˜¯åœ¨ Kubernetes ä¸Šè¿è¡Œå·¥ä½œè´Ÿè½½çš„åŸºæœ¬æ¨¡å¼ï¼‰ã€‚æœ€åï¼Œè¿˜æœ‰å›´ç»•ç€æ„å»º Pod ä¸­çš„å®¹å™¨ã€é…ç½®ç®¡ç†å’Œè¡Œä¸ºï¼Œè¿˜æœ‰å…¶ä»–æ¨¡å¼ã€‚\næˆ‘è¦ç®€è¦ä»‹ç»çš„ä¸‹ä¸€ä¸ªä¸»é¢˜æ˜¯å·¥ä½œè´Ÿè½½ã€‚ä»ç”Ÿå‘½å‘¨æœŸçš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè¿è¡Œä¸åŒçš„å·¥ä½œè´Ÿè½½ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ Kubernetes ä¸Šåšåˆ°è¿™ä¸€ç‚¹ã€‚è¿è¡ŒåäºŒè¦ç´ åº”ç”¨ç¨‹åºå’Œæ— çŠ¶æ€å¾®æœåŠ¡éå¸¸ç®€å•ã€‚Kubernetes å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚è¿™ä¸æ˜¯ä½ å°†è¦æ‰¿æ‹…çš„å”¯ä¸€å·¥ä½œé‡ã€‚å¯èƒ½ä½ è¿˜æœ‰æœ‰çŠ¶æ€çš„å·¥ä½œè´Ÿè½½ï¼Œä½ å¯ä»¥ä½¿ç”¨æœ‰çŠ¶æ€é›†åœ¨ Kubernetes ä¸Šå®Œæˆæ­¤å·¥ä½œã€‚\nä½ å¯èƒ½è¿˜æœ‰çš„å¦ä¸€ä¸ªå·¥ä½œè´Ÿè½½æ˜¯å•ä¾‹ã€‚ä¹Ÿè®¸ä½ å¸Œæœ›æŸä¸ªåº”ç”¨ç¨‹åºçš„å®ä¾‹æ˜¯æ•´ä¸ªé›†ç¾¤ä¸­åº”ç”¨ç¨‹åºçš„å”¯ä¸€ä¸€ä¸ªå®ä¾‹\u0026ndash;ä½ å¸Œæœ›å®ƒæˆä¸ºå¯é çš„å•ä¾‹ã€‚å¦‚æœå¤±è´¥ï¼Œåˆ™é‡æ–°å¯åŠ¨ã€‚å› æ­¤ï¼Œä½ å¯ä»¥æ ¹æ®éœ€æ±‚ä»¥åŠæ˜¯å¦å¸Œæœ›å•ä¾‹è‡³å°‘å…·æœ‰ä¸€ç§æˆ–æœ€å¤šä¸€ç§è¯­ä¹‰æ¥åœ¨æœ‰çŠ¶æ€é›†å’Œå‰¯æœ¬é›†ä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚ä½ å¯èƒ½è¿˜æœ‰çš„å¦ä¸€ä¸ªå·¥ä½œè´Ÿè½½æ˜¯å›´ç»•ä½œä¸šå’Œå®šæ—¶ä½œä¸š\u0026ndash;æœ‰äº† Kubernetesï¼Œä½ ä¹Ÿå¯ä»¥å®ç°è¿™äº›ã€‚\nå¦‚æœæˆ‘ä»¬å°†æ‰€æœ‰è¿™äº› Kubernetes åŠŸèƒ½æ˜ å°„åˆ°æˆ‘ä»¬çš„éœ€æ±‚ï¼Œåˆ™ Kubernetes å¯ä»¥æ»¡è¶³ç”Ÿå‘½å‘¨æœŸéœ€æ±‚ã€‚æˆ‘é€šå¸¸åˆ›å»ºçš„éœ€æ±‚åˆ—è¡¨ä¸»è¦æ˜¯ç”± Kubernetes ä»Šå¤©æä¾›ç»™æˆ‘ä»¬çš„ã€‚è¿™äº›æ˜¯ä»»ä½•å¹³å°ä¸Šçš„é¢„æœŸåŠŸèƒ½ï¼Œè€Œ Kubernetes å¯ä»¥ä¸ºä½ çš„éƒ¨ç½²åšçš„æ˜¯é…ç½®ç®¡ç†ã€èµ„æºéš”ç¦»å’Œæ•…éšœéš”ç¦»ã€‚æ­¤å¤–ï¼Œé™¤äº†æ— æœåŠ¡å™¨æœ¬èº«ä¹‹å¤–ï¼Œå®ƒè¿˜æ”¯æŒå…¶ä»–å·¥ä½œè´Ÿè½½ã€‚\nç„¶åï¼Œå¦‚æœè¿™å°±æ˜¯ Kubernetes ç»™å¼€å‘è€…æä¾›çš„å…¨éƒ¨åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•æ‰©å±• Kubernetes å‘¢ï¼Ÿä»¥åŠå¦‚ä½•ä½¿å®ƒå…·æœ‰æ›´å¤šåŠŸèƒ½ï¼Ÿå› æ­¤ï¼Œæˆ‘æƒ³æè¿°å½“ä»Šä½¿ç”¨çš„ä¸¤ç§å¸¸ç”¨æ–¹æ³•ã€‚\nè¿›ç¨‹å¤–æ‰©å±•æœºåˆ¶ é¦–å…ˆæ˜¯ Pod çš„æ¦‚å¿µï¼ŒPod æ˜¯ç”¨äºåœ¨èŠ‚ç‚¹ä¸Šéƒ¨ç½²å®¹å™¨çš„æŠ½è±¡ã€‚æ­¤å¤–ï¼ŒPod ç»™æˆ‘ä»¬æä¾›äº†ä¸¤ç»„ä¿è¯ï¼š\nç¬¬ä¸€ç»„æ˜¯éƒ¨ç½²ä¿è¯ \u0026ndash; Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å§‹ç»ˆä½äºåŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚è¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥é€šè¿‡ localhost ç›¸äº’é€šä¿¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæˆ–é€šè¿‡å…¶ä»– IPC æœºåˆ¶è¿›è¡Œå¼‚æ­¥é€šä¿¡ã€‚ Pod ç»™æˆ‘ä»¬çš„å¦ä¸€ç»„ä¿è¯æ˜¯å›´ç»•ç”Ÿå‘½å‘¨æœŸçš„ã€‚Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å¹¶ééƒ½ç›¸ç­‰ã€‚ æ ¹æ®ä½¿ç”¨çš„æ˜¯ init å®¹å™¨è¿˜æ˜¯åº”ç”¨ç¨‹åºå®¹å™¨ï¼Œä½ ä¼šè·å¾—ä¸åŒçš„ä¿è¯ã€‚ä¾‹å¦‚ï¼Œinit å®¹å™¨åœ¨å¼€å§‹æ—¶è¿è¡Œï¼›å½“ Pod å¯åŠ¨æ—¶ï¼Œå®ƒæŒ‰é¡ºåºä¸€ä¸ªæ¥ä¸€ä¸ªåœ°è¿è¡Œã€‚ä»–ä»¬ä»…åœ¨ä¹‹å‰çš„å®¹å™¨å·²æˆåŠŸå®Œæˆæ—¶è¿è¡Œã€‚å®ƒä»¬æœ‰åŠ©äºå®ç°ç”±å®¹å™¨é©±åŠ¨çš„ç±»ä¼¼å·¥ä½œæµçš„é€»è¾‘ã€‚\nå¦ä¸€æ–¹é¢ï¼Œåº”ç”¨ç¨‹åºå®¹å™¨æ˜¯å¹¶è¡Œè¿è¡Œçš„ã€‚å®ƒä»¬åœ¨æ•´ä¸ª Pod çš„ç”Ÿå‘½å‘¨æœŸä¸­è¿è¡Œï¼Œè¿™ä¹Ÿæ˜¯ sidecar æ¨¡å¼çš„åŸºç¡€ã€‚sidecar å¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œè¿™äº›å®¹å™¨å¯ä»¥åä½œå¹¶å…±åŒä¸ºç”¨æˆ·æä¾›ä»·å€¼ã€‚è¿™ä¹Ÿæ˜¯å½“ä»Šæˆ‘ä»¬çœ‹åˆ°çš„æ‰©å±• Kubernetes é™„åŠ åŠŸèƒ½çš„ä¸»è¦æœºåˆ¶ä¹‹ä¸€ã€‚\nä¸ºäº†è§£é‡Šä»¥ä¸‹åŠŸèƒ½ï¼Œæˆ‘å¿…é¡»ç®€è¦åœ°å‘Šè¯‰ä½  Kubernetes å†…éƒ¨çš„å·¥ä½œæ–¹å¼ã€‚å®ƒæ˜¯åŸºäºè°ƒè°å¾ªç¯çš„ã€‚è°ƒè°å¾ªç¯çš„æ€æƒ³æ˜¯å°†æœŸæœ›çŠ¶æ€é©±åŠ¨åˆ°å®é™…çŠ¶æ€ã€‚åœ¨ Kubernetes ä¸­ï¼Œå¾ˆå¤šåŠŸèƒ½éƒ½æ˜¯é è¿™ä¸ªæ¥å®ç°çš„ã€‚ä¾‹å¦‚ï¼Œå½“ä½ è¯´æˆ‘è¦ä¸¤ä¸ª Pod å®ä¾‹ï¼Œè¿™ç³»ç»Ÿçš„æœŸæœ›çŠ¶æ€ã€‚æœ‰ä¸€ä¸ªæ§åˆ¶å¾ªç¯ä¸æ–­åœ°è¿è¡Œï¼Œå¹¶æ£€æŸ¥ä½ çš„ Pod æ˜¯å¦æœ‰ä¸¤ä¸ªå®ä¾‹ã€‚å¦‚æœä¸å­˜åœ¨ä¸¤ä¸ªå®ä¾‹ï¼Œå®ƒå°†è®¡ç®—å·®å€¼ã€‚å®ƒå°†ç¡®ä¿å­˜åœ¨ä¸¤ä¸ªå®ä¾‹ã€‚\nè¿™æ–¹é¢çš„ä¾‹å­æœ‰å¾ˆå¤šã€‚ä¸€äº›æ˜¯å‰¯æœ¬é›†æˆ–æœ‰çŠ¶æ€é›†ã€‚èµ„æºå®šä¹‰æ˜ å°„åˆ°æ§åˆ¶å™¨æ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸”æ¯ä¸ªèµ„æºå®šä¹‰éƒ½æœ‰ä¸€ä¸ªæ§åˆ¶å™¨ã€‚è¯¥æ§åˆ¶å™¨ç¡®ä¿ç°å®ä¸–ç•Œä¸æ‰€éœ€æ§åˆ¶å™¨ç›¸åŒ¹é…ï¼Œä½ ç”šè‡³å¯ä»¥ç¼–å†™è‡ªå·±çš„è‡ªå®šä¹‰æ§åˆ¶å™¨ã€‚\nå½“åœ¨ Pod ä¸­è¿è¡Œåº”ç”¨ç¨‹åºæ—¶ï¼Œä½ å°†æ— æ³•åœ¨è¿è¡Œæ—¶åŠ è½½ä»»ä½•é…ç½®æ–‡ä»¶æ›´æ”¹ã€‚ç„¶è€Œï¼Œä½ å¯ä»¥ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰æ§åˆ¶å™¨ï¼Œæ£€æµ‹ config map çš„å˜åŒ–ï¼Œé‡æ–°å¯åŠ¨ Pod å’Œåº”ç”¨ç¨‹åº\u0026ndash;ä»è€Œè·å–é…ç½®æ›´æ”¹ã€‚\näº‹å®è¯æ˜ï¼Œå³ä½¿ Kubernetes æ‹¥æœ‰ä¸°å¯Œçš„èµ„æºé›†åˆï¼Œä½†å®ƒä»¬å¹¶ä¸èƒ½æ»¡è¶³ä½ çš„æ‰€æœ‰ä¸åŒéœ€æ±‚ã€‚Kubernetes å¼•å…¥äº†è‡ªå®šä¹‰èµ„æºå®šä¹‰çš„æ¦‚å¿µã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å¯¹éœ€æ±‚è¿›è¡Œå»ºæ¨¡å¹¶å®šä¹‰é€‚ç”¨äº Kubernetes çš„ APIã€‚å®ƒä¸å…¶ä»– Kubernetes åŸç”Ÿèµ„æºå…±å­˜ã€‚ä½ å¯ä»¥ç”¨èƒ½ç†è§£æ¨¡å‹çš„ä»»ä½•è¯­è¨€ç¼–å†™è‡ªå·±çš„æ§åˆ¶å™¨ã€‚ä½ å¯ä»¥è®¾è®¡ä¸€ä¸ªç”¨ Java å®ç°çš„ ConfigWatcherï¼Œæè¿°æˆ‘ä»¬å‰é¢æ‰€è§£é‡Šçš„å†…å®¹ã€‚è¿™å°±æ˜¯ operator æ¨¡å¼ï¼Œå³ä¸è‡ªå®šä¹‰èµ„æºå®šä¹‰ä¸€èµ·ä½¿ç”¨çš„æ§åˆ¶å™¨ã€‚å¦‚ä»Šï¼Œæˆ‘ä»¬çœ‹åˆ°å¾ˆå¤š operator å‡å¦‚ï¼Œè¿™å°±æ˜¯ç¬¬äºŒç§æ‰©å±• Kubernetes é™„åŠ åŠŸèƒ½çš„æ–¹å¼ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘æƒ³ç®€å•ä»‹ç»ä¸€ä¸‹åŸºäº Kubernetes æ„å»ºçš„ä¸€äº›å¹³å°ï¼Œè¿™äº›å¹³å°å¤§é‡ä½¿ç”¨ sidecar å’Œ operator æ¥ç»™å¼€å‘è€…æä¾›é¢å¤–çš„åŠŸèƒ½ã€‚\nä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Ÿ è®©æˆ‘ä»¬ä»æœåŠ¡ç½‘æ ¼å¼€å§‹ï¼Œä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Ÿ\næˆ‘ä»¬æœ‰ä¸¤ä¸ªæœåŠ¡ï¼ŒæœåŠ¡ A è¦è°ƒç”¨æœåŠ¡ Bï¼Œå¹¶ä¸”å¯ä»¥ç”¨ä»»ä½•è¯­è¨€ã€‚æŠŠè¿™ä¸ªå½“åšæ˜¯æˆ‘ä»¬çš„åº”ç”¨å·¥ä½œè´Ÿè½½ã€‚æœåŠ¡ç½‘æ ¼ä½¿ç”¨ sidecar æ§åˆ¶å™¨ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„æœåŠ¡æ—è¾¹æ³¨å…¥ä¸€ä¸ªä»£ç†ã€‚ä½ æœ€ç»ˆä¼šåœ¨ Pod ä¸­å¾—åˆ°ä¸¤ä¸ªå®¹å™¨ã€‚ä»£ç†æ˜¯ä¸€ä¸ªé€æ˜çš„ä»£ç†ï¼Œä½ çš„åº”ç”¨å¯¹è¿™ä¸ªä»£ç†å®Œå…¨æ— æ„ŸçŸ¥\u0026ndash;å®ƒæ‹¦æˆªæ‰€æœ‰ä¼ å…¥å’Œä¼ å‡ºçš„æµé‡ã€‚æ­¤å¤–ï¼Œä»£ç†è¿˜å……å½“æ•°æ®é˜²ç«å¢™ã€‚\nè¿™äº›æœåŠ¡ä»£ç†çš„é›†åˆä»£è¡¨äº†ä½ çš„æ•°æ®å¹³é¢ï¼Œå¹¶ä¸”å¾ˆå°ä¸”æ— çŠ¶æ€ã€‚ä¸ºäº†è·å¾—æ‰€æœ‰çŠ¶æ€å’Œé…ç½®ï¼Œå®ƒä»¬ä¾èµ–äºæ§åˆ¶å¹³é¢ã€‚æ§åˆ¶å¹³é¢æ˜¯ä¿æŒæ‰€æœ‰é…ç½®ï¼Œæ”¶é›†æŒ‡æ ‡ï¼Œåšå‡ºå†³å®šå¹¶ä¸æ•°æ®å¹³é¢è¿›è¡Œäº¤äº’çš„æœ‰çŠ¶æ€éƒ¨åˆ†ã€‚æ­¤å¤–ï¼Œå®ƒä»¬æ˜¯ä¸åŒæ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢çš„æ­£ç¡®é€‰æ‹©ã€‚äº‹å®è¯æ˜ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç»„ä»¶-ä¸€ä¸ª API ç½‘å…³ï¼Œä»¥å°†æ•°æ®è·å–åˆ°æˆ‘ä»¬çš„é›†ç¾¤ä¸­ã€‚ä¸€äº›æœåŠ¡ç½‘æ ¼å…·æœ‰è‡ªå·±çš„ API ç½‘å…³ï¼Œè€ŒæŸäº›ä½¿ç”¨ç¬¬ä¸‰æ–¹ã€‚å¦‚æœä½ ç ”ç©¶ä¸‹æ‰€æœ‰è¿™äº›ç»„ä»¶ï¼Œå®ƒä»¬å°†æä¾›æˆ‘ä»¬æ‰€éœ€çš„åŠŸèƒ½ã€‚\nAPI ç½‘å…³ä¸»è¦ä¸“æ³¨äºæŠ½è±¡æˆ‘ä»¬æœåŠ¡çš„å®ç°ã€‚å®ƒéšè—ç»†èŠ‚å¹¶æä¾›è¾¹ç•ŒåŠŸèƒ½ã€‚æœåŠ¡ç½‘æ ¼åˆ™ç›¸åã€‚åœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œå®ƒå¢å¼ºäº†æœåŠ¡å†…çš„å¯è§æ€§å’Œå¯é æ€§ã€‚å¯ä»¥è¯´ï¼ŒAPI ç½‘å…³å’ŒæœåŠ¡ç½‘æ ¼å…±åŒæä¾›äº†æ‰€æœ‰ç½‘ç»œéœ€æ±‚ã€‚è¦åœ¨ Kubernetes ä¸Šè·å¾—ç½‘ç»œåŠŸèƒ½ï¼Œä»…ä½¿ç”¨æœåŠ¡æ˜¯ä¸å¤Ÿçš„ï¼šâ€œä½ éœ€è¦ä¸€äº›æœåŠ¡ç½‘æ ¼ã€‚â€\nä»€ä¹ˆæ˜¯ Knativeï¼Ÿ æˆ‘è¦è®¨è®ºçš„ä¸‹ä¸€ä¸ªä¸»é¢˜æ˜¯ Knativeï¼Œè¿™æ˜¯ Google å‡ å¹´å‰å¯åŠ¨çš„ä¸€ä¸ªé¡¹ç›®ã€‚å®ƒæ˜¯ Kubernetes ä¹‹ä¸Šçš„ä¸€å±‚ï¼Œå¯ä¸ºæ‚¨æä¾›æ— æœåŠ¡å™¨åŠŸèƒ½ï¼Œå¹¶å…·æœ‰ä¸¤ä¸ªä¸»è¦æ¨¡å—ï¼š\nKnative æœåŠ¡ - å›´ç»•ç€è¯·æ±‚-åº”ç­”äº¤äº’ï¼Œä»¥åŠ Knative Eventing - æ›´å¤šçš„æ˜¯ç”¨äºäº‹ä»¶é©±åŠ¨çš„äº¤äº’ã€‚ åªæ˜¯è®©ä½ æ„Ÿå—ä¸€ä¸‹ï¼ŒKnative Serving æ˜¯ä»€ä¹ˆï¼Ÿé€šè¿‡ Knative Servingï¼Œä½ å¯ä»¥å®šä¹‰æœåŠ¡ï¼Œä½†è¿™ä¸åŒäº Kubernetes æœåŠ¡ã€‚è¿™æ˜¯ Knative æœåŠ¡ã€‚ä½¿ç”¨ Knative æœåŠ¡å®šä¹‰å·¥ä½œè´Ÿè½½åï¼Œä½ å°±ä¼šå¾—åˆ°å…·æœ‰æ— æœåŠ¡å™¨çš„ç‰¹å¾çš„éƒ¨ç½²ã€‚ä½ ä¸éœ€è¦æœ‰å¯åŠ¨å¹¶è¿è¡Œå®ä¾‹ã€‚å®ƒå¯ä»¥åœ¨è¯·æ±‚åˆ°è¾¾æ—¶ä»é›¶å¼€å§‹ã€‚ä½ å¾—åˆ°çš„æ˜¯æ— æœåŠ¡å™¨çš„èƒ½åŠ›ï¼›å®ƒå¯ä»¥è¿…é€Ÿæ‰©å®¹ï¼Œä¹Ÿå¯ä»¥ç¼©å®¹åˆ°é›¶ã€‚\nKnative Eventing ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå®Œå…¨å£°æ˜å¼çš„äº‹ä»¶ç®¡ç†ç³»ç»Ÿã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€äº›è¦ä¸ä¹‹é›†æˆçš„å¤–éƒ¨ç³»ç»Ÿï¼Œä»¥åŠä¸€äº›å¤–éƒ¨çš„äº‹ä»¶ç”Ÿäº§è€…ã€‚åœ¨åº•éƒ¨ï¼Œæˆ‘ä»¬å°†åº”ç”¨ç¨‹åºæ”¾åœ¨å…·æœ‰ HTTP ç«¯ç‚¹çš„å®¹å™¨ä¸­ã€‚å€ŸåŠ© Knative Eventingï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ä»£ç†ï¼Œè¯¥ä»£ç†å¯ä»¥è§¦å‘ Kafka æ˜ å°„çš„ä»£ç†ï¼Œä¹Ÿå¯ä»¥åœ¨å†…å­˜æˆ–è€…æŸäº›äº‘æœåŠ¡ä¸­ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨è¿æ¥åˆ°å¤–éƒ¨ç³»ç»Ÿçš„å¯¼å…¥å™¨ï¼Œå¹¶å°†äº‹ä»¶å¯¼å…¥åˆ°æˆ‘ä»¬çš„ä»£ç†ä¸­ã€‚è¿™äº›å¯¼å…¥å™¨å¯ä»¥åŸºäºï¼Œä¾‹å¦‚ï¼Œå…·æœ‰æ•°ç™¾ä¸ªè¿æ¥å™¨çš„ Apache Camelã€‚\nä¸€æ—¦æˆ‘ä»¬å°†äº‹ä»¶å‘é€ç»™ä»£ç†ï¼Œç„¶åç”¨ YAML æ–‡ä»¶å£°æ˜ï¼Œæˆ‘ä»¬å¯ä»¥è®©å®¹å™¨è®¢é˜…è¿™äº›äº‹ä»¶ã€‚åœ¨æˆ‘ä»¬çš„å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä»»ä½•æ¶ˆæ¯å®¢æˆ·ç«¯\u0026ndash;æ¯”å¦‚ Kafka å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬çš„å®¹å™¨å°†ä½¿ç”¨äº‘äº‹ä»¶é€šè¿‡ HTTP POST è·å–äº‹ä»¶ã€‚è¿™æ˜¯ä¸€ä¸ªå®Œå…¨å¹³å°ç®¡ç†çš„æ¶ˆæ¯ä¼ é€’åŸºç¡€è®¾æ–½ã€‚ä½œä¸ºå¼€å‘äººå‘˜ï¼Œä½ å¿…é¡»åœ¨å®¹å™¨ä¸­ç¼–å†™ä¸šåŠ¡ä»£ç ï¼Œå¹¶ä¸”ä¸å¤„ç†ä»»ä½•æ¶ˆæ¯ä¼ é€’é€»è¾‘ã€‚\nä»æˆ‘ä»¬çš„éœ€æ±‚çš„è§’åº¦æ¥çœ‹ï¼ŒKnative å¯ä»¥æ»¡è¶³å…¶ä¸­çš„ä¸€äº›è¦æ±‚ã€‚ä»ç”Ÿå‘½å‘¨æœŸçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒä¸ºæˆ‘ä»¬çš„å·¥ä½œè´Ÿè½½æä¾›äº†æ— æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œå› æ­¤èƒ½å¤Ÿå°†å…¶æ‰©å±•åˆ°é›¶ï¼Œå¹¶ä»é›¶å¼€å§‹æ¿€æ´»ã€‚ä»ç½‘ç»œçš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœæœåŠ¡ç½‘æ ¼ä¹‹é—´å­˜åœ¨æŸäº›é‡å ï¼Œåˆ™ Knative ä¹Ÿå¯ä»¥è¿›è¡Œæµé‡è½¬ç§»ã€‚ä»ç»‘å®šçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒå¯¹ä½¿ç”¨ Knative å¯¼å…¥ç¨‹åºè¿›è¡Œç»‘å®šæä¾›äº†å¾ˆå¥½çš„æ”¯æŒã€‚å®ƒå¯ä»¥ä½¿æˆ‘ä»¬è¿›è¡Œå‘å¸ƒ/è®¢é˜…ï¼Œæˆ–ç‚¹å¯¹ç‚¹äº¤äº’ï¼Œç”šè‡³å¯ä»¥è¿›è¡Œä¸€äº›æ’åºã€‚å®ƒå¯ä»¥æ»¡è¶³å‡ ç±»éœ€æ±‚ã€‚\nä»€ä¹ˆæ˜¯ Daprï¼Ÿ å¦ä¸€ä¸ªä½¿ç”¨ sidecar å’Œ operator çš„é¡¹ç›®æ˜¯ Daprï¼Œå®ƒæ˜¯å¾®è½¯å‡ ä¸ªæœˆå‰æ‰å¼€å§‹å¹¶ä¸”æ­£åœ¨è¿…é€Ÿæµè¡Œèµ·æ¥ã€‚æ­¤å¤–ï¼Œ1.0 ç‰ˆæœ¬ è¢«è®¤ä¸ºæ˜¯ç”Ÿäº§å¯ç”¨çš„ã€‚å®ƒæ˜¯ä¸€ä¸ªä½œä¸º sidecar çš„åˆ†å¸ƒå¼ç³»ç»Ÿå·¥å…·åŒ…\u0026ndash;Dapr ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯ä½œä¸º sidecar æä¾›çš„ï¼Œå¹¶ä¸”æœ‰ä¸€å¥—ä»–ä»¬æ‰€è°“çš„æ„ä»¶æˆ–åŠŸèƒ½é›†çš„é›†åˆã€‚\nè¿™äº›åŠŸèƒ½æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç¬¬ä¸€ç»„åŠŸèƒ½æ˜¯å›´ç»•ç½‘ç»œã€‚Dapr å¯ä»¥è¿›è¡ŒæœåŠ¡å‘ç°å’ŒæœåŠ¡ä¹‹é—´çš„ç‚¹å¯¹ç‚¹é›†æˆã€‚åŒæ ·ï¼Œå®ƒä¹Ÿå¯ä»¥è¿›è¡ŒæœåŠ¡ç½‘æ ¼çš„è¿½è¸ªã€å¯é é€šä¿¡ã€é‡è¯•å’Œæ¢å¤ã€‚ç¬¬äºŒå¥—åŠŸèƒ½æ˜¯å›´ç»•èµ„æºç»‘å®šï¼š\nå®ƒæœ‰å¾ˆå¤šäº‘ APIã€ä¸åŒç³»ç»Ÿçš„è¿æ¥å™¨ï¼Œä»¥åŠ ä¹Ÿå¯ä»¥åšæ¶ˆæ¯å‘å¸ƒ/è®¢é˜…å’Œå…¶ä»–é€»è¾‘ã€‚ æœ‰è¶£çš„æ˜¯ï¼ŒDapr è¿˜å¼•å…¥äº†çŠ¶æ€ç®¡ç†çš„æ¦‚å¿µã€‚é™¤äº† Knative å’ŒæœåŠ¡ç½‘æ ¼æä¾›çš„åŠŸèƒ½å¤–ï¼ŒDapr åœ¨çŠ¶æ€å­˜å‚¨ä¹‹ä¸Šè¿›è¡Œäº†æŠ½è±¡ã€‚æ­¤å¤–ï¼Œä½ é€šè¿‡å­˜å‚¨æœºåˆ¶æ”¯æŒä¸ Dapr è¿›è¡ŒåŸºäºé”®å€¼çš„äº¤äº’ã€‚\nåœ¨è¾ƒé«˜çš„å±‚æ¬¡ä¸Šï¼Œæ¶æ„æ˜¯ä½ çš„åº”ç”¨ç¨‹åºä½äºé¡¶éƒ¨ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•è¯­è¨€ã€‚ä½ å¯ä»¥ä½¿ç”¨ Dapr æä¾›çš„å®¢æˆ·ç«¯åº“ï¼Œä½†ä½ ä¸å¿…è¿™æ ·åšã€‚ä½ å¯ä»¥ä½¿ç”¨è¯­è¨€åŠŸèƒ½æ¥æ‰§è¡Œç§°ä¸º sidecar çš„ HTTP å’Œ gRPCã€‚ä¸ æœåŠ¡ç½‘æ ¼çš„åŒºåˆ«åœ¨äºï¼Œè¿™é‡Œçš„ Dapr sidecar ä¸æ˜¯ä¸€ä¸ªé€æ˜çš„ä»£ç†ã€‚å®ƒæ˜¯ä¸€ä¸ªæ˜¾å¼ä»£ç†ï¼Œä½ å¿…é¡»ä»ä½ çš„åº”ç”¨ä¸­è°ƒç”¨å®ƒï¼Œå¹¶é€šè¿‡ HTTP æˆ– gRPC ä¸ä¹‹äº¤äº’ã€‚æ ¹æ®ä½ éœ€è¦çš„åŠŸèƒ½ï¼ŒDapr å¯ä»¥ä¸å…¶ä»–å¦‚äº‘æœåŠ¡çš„ç³»ç»Ÿå¯¹è¯ã€‚\nåœ¨ Kubernetes ä¸Šï¼ŒDapr æ˜¯ä½œä¸º sidecar éƒ¨ç½²çš„ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ Kubernetes ä¹‹å¤–å·¥ä½œï¼ˆä¸ä»…ä»…æ˜¯ Kubernetesï¼‰ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª operator \u0026ndash; è€Œ sidecar å’Œ Operator æ˜¯ä¸»è¦çš„æ‰©å±•æœºåˆ¶ã€‚å…¶ä»–ä¸€äº›ç»„ä»¶ç®¡ç†è¯ä¹¦ã€å¤„ç†åŸºäº actor çš„å»ºæ¨¡å¹¶æ³¨å…¥ sidecarã€‚ä½ çš„å·¥ä½œè´Ÿè½½ä¸ sidecar äº¤äº’ï¼Œå¹¶å°½å…¶æ‰€èƒ½ä¸å…¶ä»–æœåŠ¡å¯¹è¯ï¼Œè®©ä½ ä¸ä¸åŒçš„äº‘æä¾›å•†è¿›è¡Œäº’æ“ä½œã€‚å®ƒè¿˜ä¸ºä½ æä¾›äº†é¢å¤–çš„åˆ†å¸ƒå¼ç³»ç»ŸåŠŸèƒ½ã€‚\nç»¼ä¸Šæ‰€è¿°ï¼Œè¿™äº›é¡¹ç›®æ‰€æä¾›çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥è¯´ ESB æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—©æœŸåŒ–èº«ï¼Œå…¶ä¸­æˆ‘ä»¬æœ‰é›†ä¸­å¼çš„æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢\u0026ndash;ä½†æ˜¯æ‰©å±•æ€§ä¸å¥½ã€‚åœ¨äº‘åŸç”Ÿä¸­ï¼Œé›†ä¸­å¼æ§åˆ¶å¹³é¢ä»ç„¶å­˜åœ¨ï¼Œä½†æ˜¯æ•°æ®å¹³é¢æ˜¯åˆ†æ•£çš„\u0026ndash;å¹¶ä¸”å…·æœ‰éš”éŸ³åŠŸèƒ½å’Œé«˜åº¦çš„å¯æ‰©å±•æ€§ã€‚\næˆ‘ä»¬å§‹ç»ˆéœ€è¦ Kubernetes æ¥åšè‰¯å¥½çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä½ å¯èƒ½è¿˜éœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ªé™„åŠ ç»„ä»¶ã€‚ä½ å¯èƒ½éœ€è¦ Istio æ¥è¿›è¡Œé«˜çº§è”ç½‘ã€‚ä½ å¯èƒ½ä¼šä½¿ç”¨ Knative æ¥è¿›è¡Œæ— æœåŠ¡å™¨å·¥ä½œè´Ÿè½½ï¼Œæˆ–è€…ä½¿ç”¨ Dapr æ¥åšé›†æˆã€‚è¿™äº›æ¡†æ¶å¯ä¸ Istio å’Œ Envoy å¾ˆå¥½çš„é…åˆä½¿ç”¨ã€‚ä» Dapr å’Œ Knative çš„è§’åº¦æ¥çœ‹ï¼Œä½ å¯èƒ½å¿…é¡»é€‰æ‹©ä¸€ä¸ªã€‚å®ƒä»¬å…±åŒä»¥äº‘åŸç”Ÿçš„æ–¹å¼æä¾›äº†æˆ‘ä»¬è¿‡å»åœ¨ ESB ä¸Šæ‹¥æœ‰çš„ä¸œè¥¿ã€‚\næœªæ¥äº‘åŸç”Ÿè¶‹åŠ¿\u0026ndash;ç”Ÿå‘½å‘¨æœŸè¶‹åŠ¿ åœ¨æ¥ä¸‹æ¥çš„éƒ¨åˆ†ï¼Œæˆ‘åˆ—å‡ºäº†ä¸€äº›æˆ‘è®¤ä¸ºåœ¨è¿™äº›é¢†åŸŸæ­£åœ¨å‘ç”Ÿä»¤äººæŒ¯å¥‹çš„å‘å±•çš„é¡¹ç›®ã€‚\næˆ‘æƒ³ä»ç”Ÿå‘½å‘¨æœŸå¼€å§‹ã€‚é€šè¿‡ Kubernetesï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºåº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ªæœ‰ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™å¯èƒ½ä¸è¶³ä»¥è¿›è¡Œæ›´å¤æ‚çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªæ›´å¤æ‚çš„æœ‰çŠ¶æ€åº”ç”¨ï¼Œåˆ™å¯èƒ½ä¼šæœ‰è¿™æ ·çš„åœºæ™¯ï¼Œå…¶ä¸­ Kubernetes ä¸­çš„éƒ¨ç½²åŸè¯­ä¸è¶³ä»¥ä¸ºåº”ç”¨æä¾›æ”¯æŒã€‚\nåœ¨è¿™äº›åœºæ™¯ä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ operator æ¨¡å¼ã€‚ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ª operator æ¥è¿›è¡Œéƒ¨ç½²å’Œå‡çº§ï¼Œè¿˜å¯ä»¥å°† S3 ä½œä¸ºæœåŠ¡å¤‡ä»½çš„å­˜å‚¨ä»‹è´¨ã€‚æ­¤å¤–ï¼Œä½ å¯èƒ½è¿˜ä¼šå‘ç° Kubernetes çš„å®é™…å¥åº·æ£€æŸ¥æœºåˆ¶ä¸å¤Ÿå¥½ã€‚å‡è®¾å­˜æ´»æ£€æŸ¥å’Œå°±ç»ªæ£€æŸ¥ä¸å¤Ÿå¥½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ operator å¯¹ä½ çš„åº”ç”¨è¿›è¡Œæ›´æ™ºèƒ½çš„å­˜æ´»å’Œå°±ç»ªæ£€æŸ¥ï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ¢å¤ã€‚\nç¬¬ä¸‰ä¸ªé¢†åŸŸå°±æ˜¯è‡ªåŠ¨ä¼¸ç¼©å’Œè°ƒæ•´ã€‚ä½ å¯ä»¥è®© operator æ›´å¥½çš„äº†è§£ä½ çš„åº”ç”¨ï¼Œå¹¶åœ¨å¹³å°ä¸Šè¿›è¡Œè‡ªåŠ¨è°ƒæ•´ã€‚ç›®å‰ï¼Œç¼–å†™ operator çš„æ¡†æ¶ä¸»è¦æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ Kubernetes ç‰¹åˆ«å…´è¶£å°ç»„çš„ Kubebuilderï¼Œå¦ä¸€ä¸ªæ˜¯çº¢å¸½åˆ›å»ºçš„ operator æ¡†æ¶çš„ä¸€éƒ¨åˆ†\u0026ndash;operator SDKã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„å†…å®¹ï¼š\nOperator SDK è®©ä½ å¯ä»¥ç¼–å†™ operator \u0026ndash; operator ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨æ¥ç®¡ç† operator çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠå¯ä»¥å‘å¸ƒä½ çš„ operator åˆ° OperatorHubã€‚å¦‚ä»Šåœ¨ OperatorHubï¼Œä½ ä¼šçœ‹åˆ° 100 å¤šä¸ª operator ç”¨äºç®¡ç†æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—å’Œç›‘æ§å·¥å…·ã€‚ä»ç”Ÿå‘½å‘¨æœŸç©ºé—´æ¥çœ‹ï¼Œoperator å¯èƒ½æ˜¯ Kubernetes ç”Ÿæ€ç³»ç»Ÿä¸­å‘å±•æœ€æ´»è·ƒçš„é¢†åŸŸã€‚\nç½‘ç»œè¶‹åŠ¿ - Envoy æˆ‘é€‰çš„å¦ä¸€ä¸ªé¡¹ç›®æ˜¯ Envoyã€‚æœåŠ¡ç½‘æ ¼æ¥å£è§„èŒƒçš„å¼•å…¥å°†ä½¿ä½ æ›´è½»æ¾åœ°åˆ‡æ¢ä¸åŒçš„æœåŠ¡ç½‘æ ¼å®ç°ã€‚åœ¨éƒ¨ç½²ä¸Š Istio å¯¹æ¶æ„è¿›è¡Œäº†ä¸€äº›æ•´åˆã€‚ä½ ä¸å†éœ€è¦ä¸ºæ§åˆ¶å¹³é¢éƒ¨ç½² 7 ä¸ª Podï¼›ç°åœ¨ï¼Œä½ åªéœ€è¦éƒ¨ç½²ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚æ›´æœ‰è¶£çš„æ˜¯åœ¨ Envoy é¡¹ç›®çš„æ•°æ®å¹³é¢ä¸Šæ‰€æ­£åœ¨å‘ç”Ÿçš„ï¼šè¶Šæ¥è¶Šå¤šçš„ç¬¬ 7 å±‚åè®®è¢«æ·»åŠ åˆ° Envoy ä¸­ã€‚\næœåŠ¡ç½‘æ ¼å¢åŠ äº†å¯¹æ›´å¤šåè®®çš„æ”¯æŒï¼Œæ¯”å¦‚ MongoDBã€ZooKeeperã€MySQLã€Redisï¼Œè€Œæœ€æ–°çš„åè®®æ˜¯ Kafkaã€‚æˆ‘çœ‹åˆ° Kafka ç¤¾åŒºç°åœ¨æ­£åœ¨è¿›ä¸€æ­¥æ”¹è¿›ä»–ä»¬çš„åè®®ï¼Œä½¿å…¶å¯¹æœåŠ¡ç½‘æ ¼æ›´åŠ å‹å¥½ã€‚æˆ‘ä»¬å¯ä»¥é¢„æ–™å°†ä¼šæœ‰æ›´ç´§å¯†çš„é›†æˆã€æ›´å¤šçš„åŠŸèƒ½ã€‚æœ€æœ‰å¯èƒ½çš„æ˜¯ï¼Œä¼šæœ‰ä¸€äº›æ¡¥æ¥çš„èƒ½åŠ›ã€‚ä½ å¯ä»¥ä»æœåŠ¡ä¸­åœ¨ä½ çš„åº”ç”¨æœ¬åœ°åšä¸€ä¸ª HTTP è°ƒç”¨ï¼Œè€Œä»£ç†å°†åœ¨åå°ä½¿ç”¨ Kafkaã€‚ä½ å¯ä»¥åœ¨åº”ç”¨å¤–éƒ¨ï¼Œåœ¨ sidecar ä¸­é’ˆå¯¹ Kafka åè®®è¿›è¡Œè½¬æ¢å’ŒåŠ å¯†ã€‚\nå¦ä¸€ä¸ªä»¤äººå…´å¥‹çš„å‘å±•æ˜¯å¼•å…¥äº† HTTP ç¼“å­˜ã€‚ç°åœ¨ Envoy å¯ä»¥è¿›è¡Œ HTTP ç¼“å­˜ã€‚ä½ ä¸å¿…åœ¨ä½ çš„åº”ç”¨ä¸­ä½¿ç”¨ç¼“å­˜å®¢æˆ·ç«¯ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯åœ¨ sidecar ä¸­é€æ˜åœ°å®Œæˆçš„ã€‚æœ‰äº† tap è¿‡æ»¤å™¨ï¼Œä½ å¯ä»¥ tap æµé‡å¹¶è·å¾—æµé‡çš„å‰¯æœ¬ã€‚æœ€è¿‘ï¼ŒWebAssembly çš„å¼•å…¥ï¼Œæ„å‘³ç€å¦‚æœä½ è¦ä¸º Envoy ç¼–å†™ä¸€äº›è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ï¼Œä½ ä¸å¿…ç”¨ C++ ç¼–å†™ï¼Œä¹Ÿä¸å¿…ç¼–è¯‘æ•´ä¸ª Envoy è¿è¡Œæ—¶ã€‚ä½ å¯ä»¥ç”¨ WebAssembly å†™ä½ çš„è¿‡æ»¤å™¨ï¼Œç„¶ååœ¨è¿è¡Œæ—¶è¿›è¡Œéƒ¨ç½²ã€‚è¿™äº›å¤§å¤šæ•°è¿˜åœ¨è¿›è¡Œä¸­ã€‚å®ƒä»¬ä¸å­˜åœ¨ï¼Œè¯´æ˜æ•°æ®å¹³é¢å’ŒæœåŠ¡ç½‘æ ¼æ— æ„åœæ­¢ï¼Œä»…æ”¯æŒ HTTP å’Œ gRPCã€‚ä»–ä»¬æœ‰å…´è¶£æ”¯æŒæ›´å¤šçš„åº”ç”¨å±‚åè®®ï¼Œä¸ºä½ æä¾›æ›´å¤šçš„åŠŸèƒ½ï¼Œä»¥å®ç°æ›´å¤šçš„ç”¨ä¾‹ã€‚æœ€ä¸»è¦çš„æ˜¯ï¼Œéšç€ WebAssembly çš„å¼•å…¥ï¼Œä½ ç°åœ¨å¯ä»¥åœ¨ sidecar ä¸­ç¼–å†™è‡ªå®šä¹‰é€»è¾‘ã€‚åªè¦ä½ æ²¡æœ‰åœ¨å…¶ä¸­æ·»åŠ ä¸€äº›ä¸šåŠ¡é€»è¾‘å°±å¯ä»¥äº†ã€‚\nç»‘å®šè¶‹åŠ¿ - Apache Camel Apache Camel æ˜¯ä¸€ä¸ªç”¨äºé›†æˆçš„é¡¹ç›®ï¼Œå®ƒå…·æœ‰å¾ˆå¤šä½¿ç”¨ä¼ä¸šé›†æˆæ¨¡å¼è¿æ¥åˆ°ä¸åŒç³»ç»Ÿçš„è¿æ¥å™¨ã€‚Â æ¯”å¦‚ Camel version 3 å°±æ·±åº¦é›†æˆåˆ°äº† Kubernetes ä¸­ï¼Œå¹¶ä¸”ä½¿ç”¨äº†æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢æ‰€è®²çš„é‚£äº›åŸè¯­ï¼Œæ¯”å¦‚ operatorã€‚\nä½ å¯ä»¥åœ¨ Camel ä¸­ç”¨ Javaã€JavaScript æˆ– YAML ç­‰è¯­è¨€ç¼–å†™ä½ çš„é›†æˆé€»è¾‘ã€‚æœ€æ–°çš„ç‰ˆæœ¬å¼•å…¥äº†ä¸€ä¸ª Camel operatorï¼Œå®ƒåœ¨ Kubernetes ä¸­è¿è¡Œå¹¶ç†è§£ä½ çš„é›†æˆã€‚å½“ä½ å†™å¥½ Camel åº”ç”¨ï¼Œå°†å…¶éƒ¨ç½²åˆ°è‡ªå®šä¹‰èµ„æºä¸­ï¼Œoperator å°±çŸ¥é“å¦‚ä½•æ„å»ºå®¹å™¨æˆ–æŸ¥æ‰¾ä¾èµ–é¡¹ã€‚æ ¹æ®å¹³å°çš„èƒ½åŠ›ï¼Œä¸ç®¡æ˜¯åªç”¨ Kubernetesï¼Œè¿˜æ˜¯å¸¦æœ‰ Knative çš„ Kubernetesï¼Œå®ƒéƒ½å¯ä»¥å†³å®šè¦ä½¿ç”¨çš„æœåŠ¡ä»¥åŠå¦‚ä½•å®ç°é›†æˆã€‚åœ¨è¿è¡Œæ—¶ä¹‹å¤–æœ‰ç›¸å½“å¤šçš„æ™ºèƒ½ \u0026ndash; åŒ…æ‹¬ operator \u0026ndash; æ‰€æœ‰è¿™äº›éƒ½éå¸¸å¿«åœ°å‘ç”Ÿã€‚ä¸ºä»€ä¹ˆæˆ‘ä¼šè¯´è¿™æ˜¯ä¸€ä¸ªç»‘å®šçš„è¶‹åŠ¿ï¼Ÿä¸»è¦æ˜¯å› ä¸º Apache Camel æä¾›çš„è¿æ¥å™¨çš„åŠŸèƒ½ã€‚è¿™é‡Œæœ‰è¶£çš„ä¸€ç‚¹æ˜¯å®ƒå¦‚ä½•ä¸ Kubernetes æ·±åº¦é›†æˆã€‚\nçŠ¶æ€è¶‹åŠ¿ - Cloudstate å¦ä¸€ä¸ªæˆ‘æƒ³è®¨è®ºçš„é¡¹ç›®æ˜¯ Cloudstate å’Œä¸çŠ¶æ€ç›¸å…³çš„è¶‹åŠ¿ã€‚Cloudstate æ˜¯ Lightbend çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä¸»è¦è‡´åŠ›äºæ— æœåŠ¡å™¨å’ŒåŠŸèƒ½é©±åŠ¨çš„å¼€å‘ã€‚æœ€æ–°å‘å¸ƒçš„ç‰ˆæœ¬ï¼Œæ­£åœ¨ä½¿ç”¨ sidecar å’Œ operator ä¸ Kubernetes è¿›è¡Œæ·±åº¦é›†æˆã€‚\nè¿™ä¸ªåˆ›æ„æ˜¯ï¼Œå½“ä½ ç¼–å†™ä½ çš„åŠŸèƒ½æ—¶ï¼Œä½ åœ¨åŠŸèƒ½ä¸­è¦åšçš„å°±æ˜¯ä½¿ç”¨ gRPC æ¥è·å–çŠ¶æ€å¹¶ä¸ä¹‹è¿›è¡Œäº¤äº’ã€‚æ•´ä¸ªçŠ¶æ€ç®¡ç†åœ¨ä¸å…¶ä»– sidecar ç¾¤é›†çš„ sidear ä¸­è¿›è¡Œã€‚å®ƒä½¿ä½ èƒ½å¤Ÿè¿›è¡Œäº‹ä»¶æº¯æºã€CQRSã€é”®å€¼æŸ¥è¯¢ã€æ¶ˆæ¯ä¼ é€’ã€‚\nä»åº”ç”¨ç¨‹åºè§’åº¦æ¥çœ‹ï¼Œä½ å¹¶ä¸äº†è§£æ‰€æœ‰è¿™äº›å¤æ‚æ€§ã€‚ä½ æ‰€åšçš„åªæ˜¯è°ƒç”¨ä¸€ä¸ªæœ¬åœ°çš„ sidecarï¼Œè€Œ sidecar ä¼šå¤„ç†è¿™äº›å¤æ‚çš„äº‹æƒ…ã€‚å®ƒå¯ä»¥åœ¨åå°ä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„æ•°æ®æºã€‚è€Œä¸”å®ƒæ‹¥æœ‰å¼€å‘äººå‘˜æ‰€éœ€çš„æ‰€æœ‰æœ‰çŠ¶æ€æŠ½è±¡ã€‚\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†äº‘åŸç”Ÿç”Ÿæ€ç³»ç»Ÿä¸­çš„æœ€æ–°æŠ€æœ¯ä»¥åŠä¸€äº›ä»åœ¨è¿›è¡Œä¸­çš„å¼€å‘ã€‚æˆ‘ä»¬å¦‚ä½•ç†è§£è¿™ä¸€åˆ‡ï¼Ÿ\nå¤šè¿è¡Œæ—¶å¾®æœåŠ¡å·²ç»åˆ°æ¥ å¦‚æœä½ çœ‹å¾®æœåŠ¡åœ¨ Kubernetes ä¸Šçš„æ ·å­ï¼Œåˆ™å°†éœ€è¦ä½¿ç”¨æŸäº›å¹³å°åŠŸèƒ½ã€‚æ­¤å¤–ï¼Œä½ å°†éœ€è¦é¦–å…ˆä½¿ç”¨ Kubernetes çš„åŠŸèƒ½è¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ç„¶åï¼Œå¾ˆæœ‰å¯èƒ½é€æ˜åœ°ï¼Œä½ çš„æœåŠ¡ä¼šä½¿ç”¨æŸäº›æœåŠ¡ç½‘æ ¼ï¼ˆä¾‹å¦‚ Envoyï¼‰æ¥è·å¾—å¢å¼ºçš„ç½‘ç»œåŠŸèƒ½ï¼Œæ— è®ºæ˜¯æµé‡è·¯ç”±ã€å¼¹æ€§ã€å¢å¼ºçš„å®‰å…¨æ€§ï¼Œç”šè‡³å‡ºäºç›‘æ§çš„ç›®çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ ¹æ®ä½ çš„åœºæ™¯å’Œä½¿ç”¨çš„å·¥ä½œè´Ÿè½½å¯èƒ½éœ€è¦ Dapr æˆ–è€… Knativeã€‚æ‰€æœ‰è¿™äº›éƒ½ä»£è¡¨äº†è¿›ç¨‹å¤–é™„åŠ çš„åŠŸèƒ½ã€‚å‰©ä¸‹çš„å°±æ˜¯ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ˜¯æ”¾åœ¨æœ€ä¸Šé¢è€Œæ˜¯ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„è¿è¡Œæ—¶æ¥ç¼–å†™ã€‚æœªæ¥çš„å¾®æœåŠ¡å¾ˆæœ‰å¯èƒ½å°†æ˜¯ç”±å¤šä¸ªå®¹å™¨ç»„æˆçš„è¿™ç§å¤šè¿è¡Œæ—¶ã€‚æœ‰äº›æ˜¯é€æ˜çš„ï¼Œæœ‰äº›åˆ™æ˜¯éå¸¸æ˜ç¡®çš„ã€‚\næ™ºèƒ½çš„ sidecar å’Œæ„šè ¢çš„ç®¡é“ å¦‚æœæ›´æ·±å…¥åœ°çœ‹ï¼Œé‚£å¯èƒ½æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›é«˜çº§è¯­è¨€ç¼–å†™ä¸šåŠ¡é€»è¾‘ã€‚æ˜¯ä»€ä¹ˆå¹¶ä¸é‡è¦ï¼Œä¸å¿…ä»…æ˜¯ Javaï¼Œå› ä¸ºä½ å¯ä»¥ä½¿ç”¨ä»»ä½•å…¶ä»–è¯­è¨€å¹¶åœ¨å†…éƒ¨å¼€å‘è‡ªå®šä¹‰é€»è¾‘ã€‚\nä½ çš„ä¸šåŠ¡é€»è¾‘ä¸å¤–éƒ¨ä¸–ç•Œçš„æ‰€æœ‰äº¤äº’éƒ½æ˜¯é€šè¿‡ sidecar å‘ç”Ÿçš„ï¼Œå¹¶ä¸å¹³å°é›†æˆè¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚å®ƒä¸ºå¤–éƒ¨ç³»ç»Ÿæ‰§è¡Œç½‘ç»œæŠ½è±¡ï¼Œä¸ºä½ æä¾›é«˜çº§çš„ç»‘å®šåŠŸèƒ½å’ŒçŠ¶æ€æŠ½è±¡ã€‚sidecar æ˜¯ä½ ä¸éœ€è¦å¼€å‘çš„ä¸œè¥¿ã€‚ä½ å¯ä»¥ä»è´§æ¶ä¸Šæ‹¿åˆ°å®ƒã€‚ä½ ç”¨ä¸€ç‚¹ YAML æˆ– JSON é…ç½®å®ƒï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨å®ƒã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥è½»æ¾åœ°æ›´æ–° sidecarï¼Œå› ä¸ºå®ƒä¸å†è¢«åµŒå…¥åˆ°ä½ çš„è¿è¡Œæ—¶ã€‚è¿™ä½¿å¾—æ‰“è¡¥ä¸ã€æ›´æ–°å˜å¾—æ›´åŠ æ›´å®¹æ˜“ã€‚å®ƒä¸ºæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘å¯ç”¨äº†å¤šè¯­è¨€è¿è¡Œæ—¶ã€‚\nå¾®æœåŠ¡ä¹‹åæ˜¯ä»€ä¹ˆï¼Ÿ è¿™è®©æˆ‘æƒ³åˆ°äº†æœ€åˆçš„é—®é¢˜ï¼Œå¾®æœåŠ¡ä¹‹åæ˜¯ä»€ä¹ˆï¼Ÿ\nå¦‚æœæˆ‘ä»¬çœ‹ä¸‹æ¶æ„çš„å‘å±•å†ç¨‹ï¼Œåº”ç”¨æ¶æ„åœ¨å¾ˆé«˜çš„å±‚é¢ä¸Šæ˜¯ä»å•ä½“åº”ç”¨å¼€å§‹çš„ã€‚ç„¶è€Œå¾®æœåŠ¡ç»™æˆ‘ä»¬æä¾›äº†å¦‚ä½•æŠŠä¸€ä¸ªå•ä½“åº”ç”¨æ‹†åˆ†æˆç‹¬ç«‹çš„ä¸šåŠ¡åŸŸçš„æŒ‡å¯¼åŸåˆ™ã€‚ä¹‹ååˆå‡ºç°äº†æ— æœåŠ¡å™¨å’ŒåŠŸèƒ½å³æœåŠ¡ï¼ˆFaaSï¼‰ï¼Œæˆ‘ä»¬è¯´è¿‡å¯ä»¥æŒ‰æ“ä½œå°†å…¶è¿›ä¸€æ­¥æ‹†åˆ†ï¼Œä»è€Œå®ç°æé«˜çš„å¯æ‰©å±•æ€§-å› ä¸ºæˆ‘ä»¬å¯ä»¥åˆ†åˆ«æ‰©å±•æ¯ä¸ªæ“ä½œã€‚\næˆ‘æƒ³è¯´çš„æ˜¯ FaaS å¹¶ä¸æ˜¯æœ€å¥½çš„æ¨¡å¼ \u0026ndash; å› ä¸ºåŠŸèƒ½å¹¶ä¸æ˜¯å®ç°åˆç†çš„å¤æ‚æœåŠ¡çš„æœ€ä½³æ¨¡å¼ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å¤šä¸ªæ“ä½œå¿…é¡»ä¸åŒä¸€ä¸ªæ•°æ®é›†è¿›è¡Œäº¤äº’æ—¶ï¼Œä½ å¸Œæœ›å®ƒä»¬é©»ç•™åœ¨ä¸€èµ·ã€‚å¯èƒ½æ˜¯å¤šè¿è¡Œæ—¶ï¼ˆæˆ‘æŠŠå®ƒç§°ä¸º Mecha æ¶æ„ï¼‰ï¼Œåœ¨è¯¥æ¶æ„ä¸­ä½ å°†ä¸šåŠ¡é€»è¾‘æ”¾åœ¨ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œè€Œæ‰€æœ‰ä¸åŸºç¡€è®¾æ–½ç›¸å…³çš„å…³æ³¨ç‚¹ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å®¹å™¨å­˜åœ¨ã€‚å®ƒä»¬å…±åŒä»£è¡¨å¤šè¿è¡Œæ—¶å¾®æœåŠ¡ã€‚ä¹Ÿè®¸è¿™æ˜¯ä¸€ä¸ªæ›´åˆé€‚çš„æ¨¡å‹ï¼Œå› ä¸ºå®ƒæœ‰æ›´å¥½çš„å±æ€§ã€‚\nä½ å¯ä»¥è·å¾—å¾®æœåŠ¡çš„æ‰€æœ‰å¥½å¤„ã€‚ä»ç„¶å°†æ‰€æœ‰åŸŸå’Œæ‰€æœ‰é™ç•Œä¸Šä¸‹æ–‡æ”¾åœ¨ä¸€å¤„ã€‚ä½ å°†æ‰€æœ‰çš„åŸºç¡€è®¾æ–½å’Œåˆ†å¸ƒå¼åº”ç”¨éœ€æ±‚æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„å®¹å™¨ä¸­ï¼Œå¹¶åœ¨è¿è¡Œæ—¶å°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ã€‚å¤§æ¦‚ï¼Œç°åœ¨æœ€æ¥è¿‘è¿™ç§æ¨¡å‹çš„æ˜¯ Daprã€‚ä»–ä»¬æ­£åœ¨éµå¾ªè¿™ç§æ¨¡å‹ã€‚å¦‚æœä½ ä»…å¯¹ç½‘ç»œæ–¹é¢æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆå¯èƒ½ä½¿ç”¨ Envoy ä¹Ÿä¼šæ¥è¿‘è¿™ç§æ¨¡å‹ã€‚\nå…³äºä½œè€… Bilgin Ibryam æ˜¯çº¢å¸½å…¬å¸çš„äº§å“ç»ç†å’Œå‰æ¶æ„å¸ˆã€æäº¤äººï¼Œå¹¶ä¸”æ˜¯ Apache è½¯ä»¶åŸºé‡‘ä¼šçš„æˆå‘˜ã€‚ä»–æ˜¯å¼€æºå¸ƒé“è€…ï¼Œç»å¸¸å†™åšå®¢ã€å‘è¡¨æ¼”è®²ï¼Œæ˜¯ Kubernetes Patterns å’Œ Camel Design Patterns ä¹¦ç±çš„ä½œè€…ã€‚Bilgin ç›®å‰çš„å·¥ä½œä¸»è¦é›†ä¸­åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿã€äº‹ä»¶é©±åŠ¨æ¶æ„ä»¥åŠå¯é‡å¤çš„äº‘åŸç”Ÿåº”ç”¨å¼€å‘æ¨¡å¼å’Œå®è·µä¸Šã€‚è¯·å…³æ³¨ä»– @bibryam äº†è§£æœªæ¥ç±»ä¼¼ä¸»é¢˜çš„æ›´æ–°ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/translation-distributed-systems-kubernetes/","tags":["äº‘åŸç”Ÿ","Kubernetes","Service Mesh","Knative","Serverless","Dapr"],"title":"åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨ Kubernetes ä¸Šçš„è¿›åŒ–"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬æ–‡è¯‘è‡ª Cloud Native Predictions for 2021 and Beyond\nåŸæ–‡å‘å¸ƒåœ¨Â Chris Aniszczyk çš„ä¸ªäººåšå®¢\næˆ‘å¸Œæœ›æ¯ä¸ªäººéƒ½æœ‰ä¸€ä¸ªç¾å¥½çš„å‡æœŸï¼Œå› ä¸º 2021 å¹´ 1 æœˆçš„å‰å‡ å‘¨ä¸€ç›´éå¸¸ç–¯ç‹‚ï¼Œä»å›ä¹±åˆ°æ–°çš„ COVID èŒæ ªã€‚åœ¨äº‘åŸç”Ÿå›½åº¦ï¼ŒCNCF æœ€è¿‘å‘å¸ƒäº†å…³äºæˆ‘ä»¬å»å¹´å®Œæˆçš„æ‰€æœ‰å·¥ä½œçš„å¹´åº¦æŠ¥å‘Šã€‚æˆ‘å»ºè®®å¤§å®¶æ‰¾ä¸ªæœºä¼šå»çœ‹ä¸€ä¸‹è¿™ä»½æŠ¥å‘Šï¼Œåœ¨ç–«æƒ…å¤§æµè¡Œçš„è¿™ä¸€å¹´ï¼Œæˆ‘ä»¬æ”¶è·é¢‡ä¸°ã€‚https://twitter.com/CloudNativeFdn/status/1343914259177222145\nä½œä¸ºæˆ‘å·¥ä½œçš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘å¯¹äº‘åŸç”Ÿè¶‹åŠ¿æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„è§‚ç‚¹ï¼Œé€ç»™æ‰€æœ‰ä¸æˆ‘åˆä½œçš„ä¼šå‘˜å…¬å¸å’Œå¼€å‘äººå‘˜ï¼Œæ‰€ä»¥æˆ‘æƒ³æˆ‘ä¼šåˆ†äº«æˆ‘å¯¹ 2021 å¹´åŠä»¥åäº‘åŸç”Ÿå‘å±•çš„æƒ³æ³•ã€‚\näº‘åŸç”Ÿçš„ IDE\nä½œä¸ºä¸€ä¸ªåœ¨ Eclipse åŸºé‡‘ä¼šå†…éƒ¨ä»äº‹å¼€å‘è€…å·¥å…·å·¥ä½œçš„äººï¼Œæˆ‘å¯¹æœ€è¿‘çš„æŠ€æœ¯çŠ¶æ€è¿›å±•æ„Ÿåˆ°æ— æ¯”å…´å¥‹ã€‚æœªæ¥ï¼Œå¼€å‘ç”Ÿå‘½å‘¨æœŸï¼ˆä»£ç ã€æ„å»ºã€è°ƒè¯•ï¼‰å°†ä¸»è¦å‘ç”Ÿåœ¨äº‘ç«¯ï¼Œè€Œä¸æ˜¯ä½ æœ¬åœ°çš„ Emacs æˆ– VSCodeã€‚ä½ å°†æ¯ä¸€ä¸ªæ‹‰åŠ¨è¯·æ±‚æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„å¼€å‘ç¯å¢ƒè®¾ç½®ï¼Œé¢„å…ˆé…ç½®å¹¶è¿æ¥åˆ°ä»–ä»¬è‡ªå·±çš„éƒ¨ç½²ï¼Œä»¥ååŠ©ä½ çš„å¼€å‘å’Œè°ƒè¯•éœ€æ±‚ã€‚ä»Šå¤©è¿™ç§æŠ€æœ¯çš„ä¸€ä¸ªå…·ä½“ä¾‹å­æ˜¯é€šè¿‡ GitHub Codespaces å’Œ GitPod å®ç°çš„ã€‚è™½ç„¶ GitHub Codespaces è¿˜å¤„äºæµ‹è¯•é˜¶æ®µï¼Œä½†ä»Šå¤©ä½ å¯ä»¥é€šè¿‡ GitPod æ¥ä½“éªŒï¼Œä»¥ Prometheus ä¸ºä¾‹ã€‚ä¸€åˆ†é’Ÿå·¦å³ï¼Œä½ å°±æ‹¥æœ‰äº†ä¸€ä¸ªæœ‰ç¼–è¾‘å™¨å’Œé¢„è§ˆç¯å¢ƒçš„å®Œå…¨å®æ—¶çš„å¼€å‘ç¯å¢ƒã€‚æœ€ç–¯ç‹‚çš„æ˜¯ï¼Œè¿™ä¸ªå¼€å‘ç¯å¢ƒï¼ˆå·¥ä½œç©ºé—´ï¼‰æ˜¯ ç”¨ä»£ç æè¿°ï¼Œå¹¶ä¸”å¯ä»¥åƒå…¶ä»–ä»£ç å·¥ä»¶ä¸€æ ·ï¼Œä¸ä½ å›¢é˜Ÿçš„å…¶ä»–å¼€å‘è€…å…±äº«ã€‚\næœ€åï¼Œæˆ‘æœŸæœ›åœ¨æ¥ä¸‹æ¥çš„ä¸€å¹´é‡Œï¼Œèƒ½çœ‹åˆ°äº‘åŸç”Ÿ IDE é¢†åŸŸå‡ºç°ä»¤äººéš¾ä»¥ç½®ä¿¡çš„åˆ›æ–°ï¼Œç‰¹åˆ«æ˜¯éšç€ GitHub Codespaces è¿›å…¥æµ‹è¯•ç‰ˆä¹‹åï¼Œå¹¶å¾—åˆ°å¹¿æ³›åœ°ä½¿ç”¨ï¼Œè®©å¼€å‘è€…å¯ä»¥ä½“éªŒåˆ°è¿™ä¸ªæ–°æ¦‚å¿µï¼Œå¹¶çˆ±ä¸Šå®ƒã€‚\nè¾¹ç¼˜çš„ Kubernetes\nKubernetes æ˜¯é€šè¿‡åœ¨å¤§è§„æ¨¡æ•°æ®ä¸­å¿ƒçš„ä½¿ç”¨è€Œè¯ç”Ÿçš„ï¼Œä½† Kubernetes ä¼šåƒ Linux ä¸€æ ·ä¸ºæ–°çš„ç¯å¢ƒè€Œè¿›åŒ–ã€‚Linux æ‰€å‘ç”Ÿçš„äº‹æƒ…æ˜¯ï¼Œç»ˆç«¯ç”¨æˆ·æœ€ç»ˆå¯¹å†…æ ¸è¿›è¡Œäº†æ‰©å±•ï¼Œä»¥æ”¯æŒä»ç§»åŠ¨ã€åµŒå…¥å¼ç­‰å„ç§æ–°çš„éƒ¨ç½²åœºæ™¯ã€‚æˆ‘åšä¿¡ Kubernetes ä¹Ÿä¼šç»å†ç±»ä¼¼çš„è¿›åŒ–ï¼Œæˆ‘ä»¬å·²ç»è§è¯äº† Telcosï¼ˆå’Œå…¶ä»–åˆåˆ›å…¬å¸ï¼‰é€šè¿‡å°† VNFs è½¬åŒ–ä¸º äº‘åŸç”Ÿç½‘ç»œåŠŸèƒ½ï¼ˆCNFsï¼‰ï¼Œä»¥åŠ k3sã€KubeEdgeã€k0sã€LFEdgeã€Eclipse ioFog ç­‰å¼€æºé¡¹ç›®ï¼Œæ¥æ¢ç´¢ Kubernetes ä½œä¸ºè¾¹ç¼˜å¹³å°ã€‚æ¨åŠ¨è¶…å¤§è§„æ¨¡äº‘æœåŠ¡æ”¯æŒç”µä¿¡å…¬å¸å’Œè¾¹ç¼˜çš„èƒ½åŠ›ï¼Œå†åŠ ä¸Šé‡ç”¨äº‘åŸç”Ÿè½¯ä»¶çš„èƒ½åŠ›ï¼Œä»¥åŠå»ºç«‹åœ¨ç°æœ‰åºå¤§çš„ç”Ÿæ€ç³»ç»ŸåŸºç¡€ä¸Šçš„èƒ½åŠ›ï¼Œå°†å·©å›º Kubernetes åœ¨æœªæ¥å‡ å¹´å†…æˆä¸ºè¾¹ç¼˜è®¡ç®—çš„ä¸»å¯¼å¹³å°ã€‚\näº‘åŸç”Ÿ + Wasm\nWeb Assembly(Wasm) æ˜¯ä¸€é¡¹æ–°çš„æŠ€æœ¯ï¼Œä½†æˆ‘é¢„è®¡å®ƒå°†æˆä¸ºäº‘åŸç”Ÿç”Ÿæ€ç³»ç»Ÿä¸­ä¸æ–­å¢é•¿çš„å®ç”¨å·¥å…·å’Œå·¥ä½œè´Ÿè½½ï¼Œç‰¹åˆ«æ˜¯éšç€ WASI çš„æˆç†Ÿï¼Œä»¥åŠ Kubernetes æ›´å¤šåœ°ä½œä¸ºè¾¹ç¼˜ç¼–æ’å·¥å…·ä½¿ç”¨ï¼Œå¦‚å‰æ‰€è¿°ã€‚ä¸€ä¸ªåœºæ™¯æ˜¯å¢å¼ºæ‰©å±•æœºåˆ¶ï¼Œå°±åƒ Envoy å¯¹è¿‡æ»¤å™¨å’Œ LuaJIT æ‰€åšçš„é‚£æ ·ã€‚ä½ å¯ä»¥ä¸ä¸€ä¸ªæ”¯æŒå„ç§ç¼–ç¨‹è¯­è¨€çš„æ›´å°çš„ä¼˜åŒ–è¿è¡Œæ—¶ååŒï¼Œè€Œä¸æ˜¯ç›´æ¥ä¸ Lua æ‰“äº¤é“ã€‚Envoy é¡¹ç›®ç›®å‰æ­£å¤„äº é‡‡ç”¨ Wasm çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘é¢„è®¡ä»»ä½•ä½¿ç”¨è„šæœ¬è¯­è¨€ä½œä¸ºæµè¡Œæ‰©å±•æœºåˆ¶çš„ç¯å¢ƒéƒ½ä¼šå‡ºç°è¢« Wasm å…¨ç›˜å–ä»£çš„æƒ…å†µã€‚\nåœ¨ Kubernetes æ–¹é¢ï¼Œæœ‰åƒå¾®è½¯çš„ Krustlet è¿™æ ·çš„é¡¹ç›®ï¼Œæ­£åœ¨æ¢ç´¢å¦‚ä½•åœ¨ Kubernetes ä¸­æ”¯æŒåŸºäº WASI çš„è¿è¡Œæ—¶ã€‚è¿™ä¸åº”è¯¥å¤ªä»¤äººæƒŠè®¶ï¼Œå› ä¸º Kubernetes å·²ç»åœ¨é€šè¿‡ CRD å’Œå…¶ä»–æœºåˆ¶æ‰©å±•ï¼Œä»¥è¿è¡Œä¸åŒç±»å‹çš„å·¥ä½œè´Ÿè½½ï¼Œå¦‚ VMï¼ˆKubeVirtï¼‰ç­‰ç­‰ã€‚\nå¦å¤–ï¼Œå¦‚æœä½ æ˜¯ Wasm çš„æ–°æ‰‹ï¼Œæˆ‘æ¨è Linux åŸºé‡‘ä¼šçš„è¿™æœ¬æ–°çš„ å…¥é—¨è¯¾ç¨‹ï¼Œå®ƒå¯¹å…¶è¿›è¡Œäº†ä»‹ç»ï¼Œä»¥åŠä¼˜é€‰çš„æ–‡æ¡£ã€‚\nFinOps çš„å´›èµ·ï¼ˆCFMï¼‰\næ–°å† ç—…æ¯’çš„çˆ†å‘åŠ é€Ÿäº†å‘äº‘åŸç”Ÿçš„è½¬å˜ã€‚è‡³å°‘æœ‰ä¸€åŠçš„å…¬å¸åœ¨å±æœºä¸­åŠ å¿«äº†ä»–ä»¬çš„äº‘è®¡åˆ’ã€‚è¿‘ 60% çš„å—è®¿è€…è¡¨ç¤ºï¼Œç”±äº COVID-19 å¤§æµè¡Œï¼Œäº‘è®¡ç®—çš„ä½¿ç”¨é‡å°†è¶…è¿‡ä¹‹å‰çš„è®¡åˆ’ (2020 å¹´äº‘è®¡ç®—ç°çŠ¶æŠ¥å‘Š)ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œäº‘è´¢åŠ¡ç®¡ç† (æˆ– FinOps) å¯¹è®¸å¤šå…¬å¸æ¥è¯´æ˜¯ä¸€ä¸ªæ—¥ç›Šä¸¥é‡çš„é—®é¢˜å’Œ å…³æ³¨ï¼Œè€å®è¯´ï¼Œåœ¨è¿‡å» 6 ä¸ªæœˆé‡Œï¼Œæˆ‘ä¸æ­£åœ¨è¿›è¡Œäº‘åŸç”Ÿä¹‹æ—…çš„å…¬å¸è¿›è¡Œçš„è®¨è®ºä¸­ï¼Œå¤§çº¦æœ‰ä¸€åŠçš„è®¨è®ºéƒ½ä¼šæåˆ°è¿™ä¸ªé—®é¢˜ã€‚ä½ ä¹Ÿå¯ä»¥è¯´ï¼Œäº‘æä¾›å•†æ²¡æœ‰åŠ¨åŠ›è®©äº‘è´¢åŠ¡ç®¡ç†å˜å¾—æ›´å®¹æ˜“ï¼Œå› ä¸ºè¿™å°†ä½¿å®¢æˆ·æ›´å®¹æ˜“å‡å°‘æ”¯å‡ºï¼Œç„¶è€Œï¼Œåœ¨æˆ‘çœ‹æ¥ï¼ŒçœŸæ­£çš„ç—›è‹¦æ˜¯ç¼ºä¹å›´ç»•äº‘è´¢åŠ¡ç®¡ç†çš„å¼€æºåˆ›æ–°å’Œæ ‡å‡†åŒ–ï¼ˆæ‰€æœ‰çš„äº‘éƒ½ä»¥ä¸åŒçš„æ–¹å¼è¿›è¡Œæˆæœ¬ç®¡ç†ï¼‰ã€‚åœ¨ CNCF çš„èƒŒæ™¯ä¸‹ï¼Œè¯•å›¾è®© FinOps å˜å¾—æ›´å®¹æ˜“çš„å¼€æºé¡¹ç›®å¹¶ä¸å¤šï¼Œæœ‰ KubeCost é¡¹ç›®ï¼Œä½†è¿˜ç›¸å½“æ—©æœŸã€‚\nå¦å¤–ï¼ŒLinux åŸºé‡‘ä¼šæœ€è¿‘æ¨å‡ºäº† FinOps åŸºé‡‘ä¼š æ¥å¸®åŠ©è¿™ä¸ªé¢†åŸŸçš„åˆ›æ–°ï¼Œä»–ä»¬åœ¨è¿™ä¸ªé¢†åŸŸæœ‰ä¸€äº› å¾ˆæ£’çš„å…¥é—¨ææ–™ã€‚æˆ‘æœŸæœ›åœ¨æœªæ¥å‡ å¹´ï¼Œåœ¨ FinOps é¢†åŸŸèƒ½çœ‹åˆ°æ›´å¤šçš„å¼€æºé¡¹ç›®å’Œè§„èŒƒã€‚\näº‘åŸç”Ÿä¸­æ›´å¤šçš„ä½¿ç”¨ Rust\nRust ä»ç„¶æ˜¯ä¸€é—¨å¹´è½»è€Œå°ä¼—çš„ç¼–ç¨‹è¯­è¨€ï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ ä»¥ Redmonk çš„ ç¼–ç¨‹è¯­è¨€æ’å ä¸ºä¾‹ã€‚ç„¶è€Œï¼Œæˆ‘çš„æ„Ÿè§‰æ˜¯ï¼Œé‰´äºå·²ç»æœ‰ä¸€äº› ä½¿ç”¨ Rust çš„ CNCF é¡¹ç›®ï¼Œä»¥åŠå®ƒå‡ºç°åœ¨åƒ microvm Firecracker è¿™æ ·æœ‰è¶£çš„åŸºç¡€è®¾æ–½é¡¹ç›®ä¸­ï¼Œä½ å°†åœ¨æœªæ¥ä¸€å¹´ä¸­çœ‹åˆ° Rust å‡ºç°åœ¨æ›´å¤šçš„äº‘åŸç”Ÿé¡¹ç›®ä¸­ã€‚è™½ç„¶ CNCF ç›®å‰æœ‰è¶…å¤šçš„é¡¹ç›®æ˜¯ç”¨ Golang ç¼–å†™çš„ï¼Œä½†æˆ‘é¢„è®¡éšç€ Rust ç¤¾åŒºçš„æˆç†Ÿï¼Œå‡ å¹´ååŸºäº Rust çš„é¡¹ç›®å°†ä¸åŸºäº Go çš„é¡¹ç›®å¹³èµ·å¹³åã€‚\nGitOps+CD/PD å¢é•¿æ˜¾è‘—\nGitOps æ˜¯äº‘åŸç”ŸæŠ€æœ¯çš„ä¸€ç§æ“ä½œæ¨¡å¼ï¼Œæä¾›äº†ä¸€å¥—ç»Ÿä¸€éƒ¨ç½²ã€ç®¡ç†å’Œç›‘æ§åº”ç”¨ç¨‹åºçš„æœ€ä½³å®è·µ (æœ€åˆæ˜¯ç”± Weaveworks åæ°”å¾ˆå¤§çš„ Alexis Richardsonåˆ›é€ )ã€‚GitOps æœ€é‡è¦çš„æ–¹é¢æ˜¯é€šè¿‡å£°æ˜çš„æ–¹å¼æè¿°æ‰€éœ€çš„åœ¨ Git ä¸­ç‰ˆæœ¬åŒ–çš„ç³»ç»ŸçŠ¶æ€ï¼Œè¿™åŸºæœ¬ä¸Šå¯ä»¥ä½¿ä¸€ç³»åˆ—å¤æ‚çš„ç³»ç»Ÿå˜æ›´è¢«æ­£ç¡®åœ°åº”ç”¨ï¼Œç„¶åè¿›è¡ŒéªŒè¯ï¼ˆé€šè¿‡ Git å’Œå…¶ä»–å·¥å…·å¯ç”¨çš„æ¼‚äº®çš„å®¡è®¡æ—¥å¿—ï¼‰ã€‚ä»å®ç”¨çš„è§’åº¦æ¥çœ‹ï¼ŒGitOps æ”¹å–„äº†å¼€å‘è€…çš„ä½“éªŒï¼Œéšç€ Argoã€GitLabã€Flux ç­‰é¡¹ç›®çš„å‘å±•ï¼Œæˆ‘é¢„è®¡ä»Šå¹´ GitOps å·¥å…·ä¼šæ›´å¤šåœ°å†²å‡»ä¼ä¸šã€‚å¦‚æœä½ çœ‹è¿‡ GitLab çš„ æ•°æ®ï¼ŒGitOps è¿˜æ˜¯ä¸€ä¸ªå¤§éƒ¨åˆ†å…¬å¸è¿˜æ²¡æœ‰æ¢ç´¢å‡ºæ¥çš„æ–°å…´çš„å®è·µï¼Œä½†éšç€è¶Šæ¥è¶Šå¤šçš„å…¬å¸å¤§è§„æ¨¡é‡‡ç”¨äº‘åŸç”Ÿè½¯ä»¶ï¼Œæˆ‘è®¤ä¸º GitOps è‡ªç„¶ä¼šéšä¹‹è€Œæ¥ã€‚å¦‚æœä½ æœ‰å…´è¶£äº†è§£æ›´å¤šå…³äºè¿™ä¸ªé¢†åŸŸçš„ä¿¡æ¯ï¼Œæˆ‘æ¨èä½ å»çœ‹çœ‹ CNCF ä¸­ æ–° æˆç«‹çš„ GitOps å·¥ä½œç»„ã€‚\næœåŠ¡ç›®å½•2.0ï¼šäº‘åŸç”Ÿå¼€å‘è€…ä»ªè¡¨ç›˜\næœåŠ¡ç›®å½•çš„æ¦‚å¿µå¹¶ä¸æ˜¯ä¸€ä¸ªæ–°äº‹ç‰©ï¼Œå¯¹äºæˆ‘ä»¬ä¸€äº›åœ¨ ITIL æ—¶ä»£æˆé•¿èµ·æ¥çš„è€äººä»¬æ¥è¯´ï¼Œä½ å¯èƒ½è¿˜è®°å¾— CMDBs ï¼ˆææ€–ï¼‰ç­‰ä¸œè¥¿ã€‚ç„¶è€Œï¼Œéšç€å¾®æœåŠ¡å’Œäº‘åŸç”Ÿå¼€å‘çš„å…´èµ·ï¼Œå¯¹æœåŠ¡è¿›è¡Œç¼–ç›®å’Œç´¢å¼•å„ç§å®æ—¶æœåŠ¡å…ƒæ•°æ®çš„èƒ½åŠ›å¯¹äºæ¨åŠ¨å¼€å‘è€…è‡ªåŠ¨åŒ–æ˜¯è‡³å…³é‡è¦çš„ã€‚è¿™å¯ä»¥åŒ…æ‹¬ä½¿ç”¨æœåŠ¡ç›®å½•æ¥äº†è§£æ‰€æœ‰æƒæ¥å¤„ç†äº‹ä»¶ç®¡ç†ã€ç®¡ç† SLO ç­‰ã€‚\nåœ¨æœªæ¥ï¼Œä½ å°†çœ‹åˆ°å¼€å‘äººå‘˜ä»ªè¡¨ç›˜çš„è¶‹åŠ¿ï¼Œå®ƒä¸ä»…æ˜¯ä¸€ä¸ªæœåŠ¡ç›®å½•ï¼Œè€Œä¸”æä¾›äº†é€šè¿‡å„ç§è‡ªåŠ¨åŒ–åŠŸèƒ½åœ¨æ‰©å±•ä»ªè¡¨ç›˜çš„èƒ½åŠ›ã€‚è¿™æ–¹é¢çš„å…¸èŒƒå¼€æºä¾‹å­æ˜¯ Lyft çš„ Backstage å’Œ Clutchï¼Œç„¶è€Œï¼Œä»»ä½•æ‹¥æœ‰ç›¸å½“ç°ä»£çš„äº‘åŸç”Ÿéƒ¨ç½²çš„å…¬å¸å¾€å¾€éƒ½æœ‰ä¸€ä¸ªå¹³å°åŸºç¡€è®¾æ–½å›¢é˜Ÿï¼Œä»–ä»¬å·²ç»å°è¯•æ„å»ºç±»ä¼¼çš„ä¸œè¥¿ã€‚éšç€å¼€æºå¼€å‘è€…ä»ªè¡¨ç›˜ä¸ å¤§å‹æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ çš„æˆç†Ÿï¼Œä½ ä¼šçœ‹åˆ°å…¶è¢«å„åœ°çš„å¹³å°å·¥ç¨‹å›¢é˜ŸåŠ é€Ÿé‡‡ç”¨ã€‚\nè·¨äº‘å˜å¾—æ›´çœŸå®\nKubernetes å’Œäº‘åŸç”Ÿè¿åŠ¨å·²ç»è¯æ˜äº†äº‘åŸç”Ÿå’Œå¤šäº‘æ–¹å¼åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯å¯è¡Œçš„ï¼Œæ•°æ®å¾ˆæ¸…æ¥šåœ°è¡¨æ˜â€œ93% çš„ä¼ä¸šéƒ½æœ‰ä½¿ç”¨å¾®è½¯ Azureã€äºšé©¬é€Šç½‘ç»œæœåŠ¡å’Œè°·æ­Œäº‘ç­‰å¤šä¸ªæä¾›å•†çš„ç­–ç•¥â€ (2020 å¹´äº‘è®¡ç®—ç°çŠ¶æŠ¥å‘Š)ã€‚äº‹å®ä¸Šï¼ŒKubernetes è¿™äº›å¹´ä¼´éšç€äº‘å¸‚åœºçš„å‘å±•è€Œæ›´åŠ æˆç†Ÿï¼Œå°†æœ‰æœ›è§£é”ç¨‹åºåŒ–çš„è·¨äº‘ç®¡ç†æœåŠ¡ã€‚è¿™ç§æ–¹æ³•çš„ä¸€ä¸ªå…·ä½“ä¾‹å­ä½“ç°åœ¨ Crossplane é¡¹ç›®ä¸­ï¼Œè¯¥é¡¹ç›®æä¾›äº†ä¸€ä¸ªå¼€æºçš„è·¨äº‘æ§åˆ¶å¹³é¢ï¼Œåˆ©ç”¨ Kubernetes API çš„å¯æ‰©å±•æ€§æ¥å®ç°è·¨äº‘å·¥ä½œè´Ÿè½½ç®¡ç†ï¼ˆå‚è§ \u0026ldquo;GitLab éƒ¨ç½² Crossplane æ§åˆ¶å¹³é¢ï¼Œæä¾›å¤šäº‘éƒ¨ç½² \u0026ldquo;ï¼‰ã€‚\nä¸»æµ eBPF\neBPF å…è®¸ä½ åœ¨ä¸æ”¹å˜å†…æ ¸ä»£ç æˆ–åŠ è½½æ¨¡å—çš„æƒ…å†µä¸‹ï¼Œåœ¨ Linux å†…æ ¸ä¸­è¿è¡Œç¨‹åºï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ä¸€ç§æ²™ç®±æ‰©å±•æœºåˆ¶ã€‚eBPF å…è®¸ æ–°ä¸€ä»£è½¯ä»¶ ä»æ”¹è¿›çš„ç½‘ç»œã€ç›‘æ§å’Œå®‰å…¨ç­‰å„ç§ä¸åŒçš„æ–¹å‘æ‰©å±• Linux å†…æ ¸çš„è¡Œä¸ºã€‚ä»å†å²ä¸Šçœ‹ï¼ŒeBPF çš„ç¼ºç‚¹æ˜¯å®ƒéœ€è¦ä¸€ä¸ªç°ä»£çš„å†…æ ¸ç‰ˆæœ¬æ¥åˆ©ç”¨å®ƒï¼Œåœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´é‡Œï¼Œè¿™å¯¹è®¸å¤šå…¬å¸æ¥è¯´éƒ½ä¸æ˜¯ä¸€ä¸ªç°å®çš„é€‰æ‹©ã€‚ç„¶è€Œï¼Œäº‹æƒ…æ­£åœ¨å‘ç”Ÿå˜åŒ–ï¼Œç”šè‡³æ–°ç‰ˆæœ¬çš„ RHEL ç»ˆäºæ”¯æŒ eBPFï¼Œæ‰€ä»¥ä½ ä¼šçœ‹åˆ°æ›´å¤šçš„é¡¹ç›®åˆ©ç”¨å…¶ [ä¼˜åŠ¿]ï¼ˆhttps://sysdig.com/blog/sysdig-and-falco-now-powered-by-ebpf/ï¼‰ã€‚å¦‚æœä½ çœ‹è¿‡ Sysdig æœ€æ–°çš„ å®¹å™¨æŠ¥å‘Šï¼Œä½ ä¼šå‘ç° Falco çš„é‡‡ç”¨ç‡æœ€è¿‘åœ¨ä¸Šå‡ï¼Œè™½ç„¶ Sysdig çš„æŠ¥å‘Šå¯èƒ½æœ‰ç‚¹åé¢‡ï¼Œä½†å®ƒåæ˜ åœ¨ç”Ÿäº§ä½¿ç”¨ä¸Šã€‚æ‰€ä»¥è¯·ç»§ç»­å…³æ³¨ï¼Œå¹¶æœŸå¾…æœªæ¥æ›´å¤šåŸºäº eBPF çš„é¡¹ç›®ã€‚\næœ€åï¼Œç¥å¤§å®¶ 2021 å¹´å¿«ä¹ï¼\næˆ‘è¿˜æœ‰ä¸€äº›é¢„æµ‹å’Œè¶‹åŠ¿è¦åˆ†äº«ï¼Œå°¤å…¶æ˜¯å›´ç»•ç»ˆç«¯ç”¨æˆ·é©±åŠ¨çš„å¼€æºã€æœåŠ¡ç½‘æ ¼æ‹†è§£/æ ‡å‡†åŒ–ã€Prometheus+OTelã€ä¿éšœè½¯ä»¶ä¾›åº”é“¾å®‰å…¨çš„ KYC ç­‰ç­‰ï¼Œä½†æˆ‘ä¼šæŠŠè¿™äº›ç•™åˆ°æ›´è¯¦ç»†çš„æ–‡ç« ä¸­å»ï¼Œ9 ä¸ªé¢„æµ‹è¶³ä»¥å¼€å¯æ–°çš„ä¸€å¹´ï¼æ€»ä¹‹ï¼Œæ„Ÿè°¢å¤§å®¶çš„é˜…è¯»ï¼Œå¸Œæœ›åœ¨ 2021 å¹´ 5 æœˆçš„ KubeCon+CloudNativeCon EU ä¸Šä¸å¤§å®¶è§é¢ï¼ŒæŠ¥åå·²å¼€å§‹ï¼\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/translation-cloud-native-predictions-for-2021-and-beyond/","tags":["äº‘åŸç”Ÿ"],"title":"ã€è¯‘ã€‘2021 å¹´åŠæœªæ¥çš„äº‘åŸç”Ÿé¢„æµ‹"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬æ–‡è¯‘è‡ª Application architecture: why it should evolve with the market æœ€åˆç”±Mia Platformå›¢é˜Ÿå‘å¸ƒåœ¨Mia Platformçš„åšå®¢ä¸Š\nå¦‚ä»Šï¼ŒIT æŒ‘æˆ˜åœ¨äºé€šè¿‡æœ‰æ•ˆé€‰æ‹©åº”ç”¨æ¶æ„æ¥é€‚åº”å¸‚åœºå’Œä¸šåŠ¡éœ€æ±‚çš„å‘å±•ã€‚ä¸ºäº†æ»¡è¶³ä¸šåŠ¡å’Œå®¢æˆ·çš„éœ€æ±‚ï¼ŒIT éƒ¨é—¨åº”èƒ½å¤Ÿå¯¹æŠ€æœ¯å’Œæ–¹æ³•é‡‡å–è¡ŒåŠ¨ä»¥ç¡®ä¿è½¯ä»¶å…·æœ‰çµæ´»æ€§ï¼Œå¹¶å®ç°äº§å“å’ŒæœåŠ¡çš„æŒç»­åˆ›æ–°æµç¨‹ï¼Œä»è€Œåšå‡ºæ›´å¿«çš„ååº” ã€‚\nå½“ç„¶ï¼Œè¿‡å»çš„å•ä½“åº”ç”¨ç¨‹åºå’Œåˆšæ€§åŸºç¡€è®¾æ–½æ— æ³•åšåˆ°è¿™ä¸€ç‚¹ã€‚ç›¸åï¼Œå®ƒå¯ä»¥é€šè¿‡ä¸ºæ¼”åŒ–è€Œè®¾è®¡çš„æ¶æ„æ¥å®ç°ï¼Œè¯¥æ¶æ„åœ¨éœ€è¦æ—¶æ˜“äºæ›´æ–°å’Œé‡æ„ã€‚å®¹å™¨åŒ–å®è·µçš„å¹¿æ³›åº”ç”¨ï¼ˆæ ¹æ® Gartnerï¼Œåˆ°2022å¹´ï¼Œå¤§å…¬å¸çš„å°±ä¸šäººæ•°å°†ä»ç›®å‰çš„ 30ï¼… å¢é•¿åˆ° 75ï¼…ï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹é‡‡ç”¨äº‘åŸç”Ÿæ–¹æ³•é‡æ–°è®¾è®¡å¾®æœåŠ¡åº”ç”¨æ˜¯æˆåŠŸçš„å…³é”®ã€‚\nå¦‚ä½•æ„å»ºä¸æ–­å‘å±•çš„åº”ç”¨æ¶æ„ æµ·å¤–ä¸“å®¶ç§°å®ƒä»¬ä¸ºå¯æ¼”è¿›çš„æ¶æ„ï¼Œä»¥å°†å®ƒä»¬ä¸å½“ä»Šé˜»ç¢æˆ–æ— åŠ©äºæ”¹å˜çš„ä¼ ç»Ÿæ¶æ„åŒºåˆ†å¼€ã€‚åº”ç”¨æ¶æ„åŸºäºå¾®æœåŠ¡æ¶æ„é£æ ¼ ï¼Œè¢«è®¾è®¡æˆåœ¨ç°ä»£è™šæ‹ŸåŒ– IT å’Œäº‘ç¯å¢ƒä¸­å‘æŒ¥æœ€ä½³æ€§èƒ½ã€‚\nåŸºæœ¬æ€æƒ³æ˜¯åˆ›å»ºå¯ä»¥è½»æ¾â€œåˆ†è§£â€çš„åº”ç”¨ç¨‹åºï¼Œå…¶ç»„ä»¶å¯ä»¥åœ¨å…¶ä»–ä¸Šä¸‹æ–‡æˆ–ç»„åˆä¸­é‡ç”¨ï¼Œå¦‚ Lego ç³»åˆ—ã€‚å¼€å‘ä¸€ç³»åˆ—å¾®æœåŠ¡ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½ç”¨äºæ‰§è¡Œå•ä¸ªä¸šåŠ¡åŠŸèƒ½ï¼ˆæ ¹æ®â€œå•ä¸€èŒè´£åŸåˆ™â€ï¼‰ï¼Œå¯ä»¥åœ¨åº”ç”¨æœ¬èº«çš„å¼€å‘å’Œæ¼”è¿›ä¸­è·å¾—ç›¸å½“å¤§çš„çµæ´»æ€§ã€‚å®é™…ä¸Šï¼Œå¯ä»¥æ ¹æ®æ”¯æŒåŠŸèƒ½çš„ç‰¹å®šç”Ÿå‘½å‘¨æœŸç‹¬ç«‹å¼€å‘ã€æ›´æ–°å’Œæµ‹è¯•æœåŠ¡ã€‚\næ­¤å¤–ï¼Œè°ˆåˆ°éƒ¨ç½²ï¼Œå¾®æœåŠ¡åº”ç”¨çš„æ¶æ„å…·æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ï¼šå¯ä»¥æ ¹æ®éœ€è¦åœ¨å†…éƒ¨æˆ–äº‘ä¸­é€šè¿‡ä½¿ç”¨å¯ç”¨èµ„æºæ¥æ‰©å±•å•ä¸ªå¾®æœåŠ¡ã€‚\nä¸ºæ­¤ï¼Œå¾®æœåŠ¡åº”ç”¨è·å¾—åŸºäºå®¹å™¨çš„åŸºç¡€è®¾æ–½çš„æ”¯æŒï¼Œè¯¥åŸºç¡€è®¾æ–½é€šè¿‡ä¸šåŠ¡ç¼–æ’ç³»ç»Ÿï¼ˆé€šå¸¸ä¸º Kubernetesï¼‰è¿›è¡Œç®¡ç†ï¼Œè¯¥æµç¨‹å¯ä»¥è‡ªåŠ¨åŒ–å¹¶ä¿ƒè¿›å…¬å¸ç³»ç»Ÿä¹‹é—´ä»¥åŠä»è¿™äº›ç³»ç»Ÿåˆ°äº‘æä¾›å•†æœåŠ¡çš„è½¯ä»¶ä½œä¸šçš„è¿ç§»ã€‚\néšç€ä¸šåŠ¡å‘å±•çš„åº”ç”¨æ¶æ„çš„ä¼˜åŠ¿ åŸºäºå¾®æœåŠ¡çš„åº”ç”¨æ¶æ„åœ¨å¼€å‘å’Œéƒ¨ç½²æ–¹é¢å…·æœ‰æ›´å¤§çš„è‡ªæ²»æƒã€‚å¦‚æˆ‘ä»¬æ‰€è§ï¼Œå¾®æœåŠ¡å¯ä»¥åœ¨å…¶ä»–åº”ç”¨ç¨‹åºä¸­å•ç‹¬å®ç°ã€â€œåˆ†è§£â€ã€æ›´æ–°å’Œé‡ç”¨ã€‚å› æ­¤ï¼Œé€šè¿‡äº§å“æˆ–å®¢æˆ·éœ€æ±‚çš„æ¼”å˜ï¼Œå®ƒæœ‰é™ä½å‡å°‘å¸‚åœºæ‰€éœ€çš„æ¯ä¸ªæ–°äº§å“çš„è®¾è®¡/å¼€å‘æ—¶é—´å’Œæˆæœ¬ã€‚\næ­¤å¤–ï¼Œé€šè¿‡ä½¿ç”¨å®¹å™¨åŒ–å®è·µï¼Œå¯ä»¥ç®€åŒ–åœ¨æœ¬åœ°ã€äº‘ã€å¤šäº‘æˆ–æ··åˆç¯å¢ƒçš„ä»»ä½•ç¯å¢ƒä¸­åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ï¼Œä»è€Œä¼˜åŒ–æˆæœ¬ã€‚\nåœ¨å¾®æœåŠ¡æ¶æ„é£æ ¼çš„ä¼˜ç‚¹ä¸­ï¼Œæˆ‘ä»¬è¿˜å‘ç°æœ‰å¯èƒ½åœ¨å„ç§æœåŠ¡ä¹‹é—´çš„å¯¹è¯åŠå…¶å¥åº·çŠ¶å†µä¸Šè·å¾—æ›´å¤§çš„é€æ˜åº¦ï¼šæ›´å¥½çš„å¯è§‚å¯Ÿæ€§æ„å‘³ç€å¯ä»¥è½»æ¾è§£å†³å¤æ‚åº”ç”¨çš„é—®é¢˜ã€‚å®é™…ä¸Šï¼Œç®¡ç†å‘˜å¯ä»¥æ›´å¿«åœ°å®šä½å’Œè§£å†³æ€§èƒ½å’Œå®‰å…¨æ€§é—®é¢˜ï¼Œåœ¨è¿ç»´å’Œä»£ç å±‚é¢å®æ–½æªæ–½ï¼Œä»è€Œä½¿å“åº”é€Ÿåº¦ä¸å˜æ›´çš„é•¿æœŸæœ‰æ•ˆæ€§ä¿æŒä¸€è‡´ã€‚\né€šè¿‡é‡‡ç”¨å¾®æœåŠ¡ä»¥åŠæ–°çš„å¼€å‘å’Œéƒ¨ç½²æ–¹æ³•ï¼Œå¯ä»¥åˆ›å»ºèƒ½å¤Ÿéšæ—¶é—´å‘å±•çš„åº”ç”¨æ¶æ„ã€‚é™¤äº† IT å›¢é˜Ÿå¿…é¡»æŒæ¡çš„æ–°æŠ€èƒ½å¤–ï¼Œè¿˜å¿…é¡»å¯¹å…¬å¸çš„æœªæ¥æœ‰ä¸€ä¸ªæ¸…æ™°çš„æ„¿æ™¯ï¼Œä»¥ç¡®ä¿æ‰€æä¾›çš„æœåŠ¡å¯¹ä¸šåŠ¡å‘å±•æœ‰ç”¨ã€‚\nåˆ›å»ºå¯æ¼”è¿›çš„åº”ç”¨æ¶æ„ æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†åŸºäºå¾®æœåŠ¡çš„ç°ä»£åº”ç”¨æ¶æ„å¦‚ä½•ä¿è¯è½¯ä»¶çš„çµæ´»æ€§ï¼Œå¹¶å…è®¸ä½ åˆ©ç”¨æœ¬åœ°å’ŒæŒ‰éœ€ä½¿ç”¨çš„æ‰€æœ‰èµ„æºï¼Œåœ¨å¯ä»¥æ–¹ä¾¿åœ°è·å¾—æ‰€éœ€æ€§èƒ½ã€é™ä½æˆæœ¬æˆ–ä¿æŠ¤æ•°æ®çš„ä½ç½®åˆ†é…ä½œä¸šã€‚\nä¸ºäº†ä½¿ä¹‹æˆä¸ºå¯èƒ½ï¼Œæœ‰å¿…è¦åœ¨äº‘å’Œæ··åˆç¯å¢ƒä¸­åˆ›å»ºå’Œç®¡ç†è™šæ‹ŸåŒ–çš„ IT ç¯å¢ƒï¼Œå¹¶é‡‡ç”¨æœ€åˆé€‚çš„æ–¹æ³•å’Œç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œåœ¨ç”¨äºå°†å¼€å‘å’Œè¿ç»´æ´»åŠ¨é“¾æ¥åœ¨ä¸€èµ·çš„DevOpsé¢†åŸŸä¸­ï¼ŒæŒç»­é›†æˆ/æŒç»­äº¤ä»˜ï¼ˆCI / CDï¼‰ç­–ç•¥çš„æ–¹æ³•å­¦æ”¯æŒå¯å¸®åŠ©æé«˜æ›´æ–°é€Ÿåº¦å’Œåº”ç”¨è½¯ä»¶çš„è´¨é‡ã€‚\næ­¤å¤–ï¼Œå¾®æœåŠ¡å¯ä¿ƒè¿›å¯¹é—ç•™åº”ç”¨ç¨‹åºçš„é›†æˆï¼Œä»è€Œä½¿å…¬å¸æ›´åŠ æ•æ·ï¼Œå¹¶åˆ©ç”¨å¸‚åœºä¸Šæœ€å…ˆè¿›çš„è§£å†³æ–¹æ¡ˆã€‚é™¤äº†éœ€è¦æ–°çš„æŠ€æœ¯å’Œå·¥ä½œæ–¹æ³•å¤–ï¼Œç°åœ¨è¿˜éœ€è¦å¯æ¼”è¿›çš„åº”ç”¨æ¶æ„æ¥æ”¯æŒæ•°å­—åŒ–è½¬å‹æ‰€å†³å®šçš„ä¸æ–­å˜åŒ–çš„éœ€æ±‚ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/translation-application-architecture-why-it-should-evolve-with-the-market/","tags":["äº‘åŸç”Ÿ"],"title":"ã€è¯‘ã€‘åº”ç”¨æ¶æ„ï¼šä¸ºä»€ä¹ˆè¦éšç€å¸‚åœºæ¼”è¿›"},{"categories":["ç¬”è®°"],"contents":"æœ€è¿‘åœ¨çœ‹ openservicemesh ç›¸å…³å†…å®¹ï¼Œè¿™å‘¨æ›´æ–°äº† main åˆ†æ”¯çš„ä»£ç ä¹‹åã€‚å‘ç°åŸæœ¬ v0.5.0 æ—¶å¯ä»¥æ­£å¸¸ä»£ç†çš„ mysql æµé‡ï¼Œåœ¨æ–°çš„ commit ä¸­æ— æ³•ä»£ç†äº†ã€‚\nå¼€å¯ envoy çš„ filter debug æ—¥å¿—åå‘ç°å‡ºç°äº†è¶…æ—¶ã€‚\n[2020-12-09 08:54:42.285][15][debug][filter] [source/extensions/filters/listener/original_dst/original_dst.cc:18] original_dst: New connection accepted [2020-12-09 08:54:42.285][15][debug][filter] [source/extensions/filters/listener/http_inspector/http_inspector.cc:38] http inspector: new connection accepted [2020-12-09 08:54:42.285][15][trace][filter] [source/extensions/filters/listener/http_inspector/http_inspector.cc:105] http inspector: recv: 0 [2020-12-09 08:54:57.286][15][debug][conn_handler] [source/server/connection_handler_impl.cc:273] listener filter times out after 15000 ms è´´ä¸€ä¸‹ outbound listener çš„é…ç½®ç‰‡æ®µ:\n{ \u0026#34;@type\u0026#34;: \u0026#34;type.googleapis.com/envoy.admin.v3.ListenersConfigDump\u0026#34;, \u0026#34;version_info\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;dynamic_listeners\u0026#34;: [{ \u0026#34;name\u0026#34;: \u0026#34;outbound_listener\u0026#34;, \u0026#34;active_state\u0026#34;: { \u0026#34;version_info\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;listener\u0026#34;: { \u0026#34;@type\u0026#34;: \u0026#34;type.googleapis.com/envoy.config.listener.v3.Listener\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;outbound_listener\u0026#34;, \u0026#34;address\u0026#34;: { \u0026#34;socket_address\u0026#34;: { \u0026#34;address\u0026#34;: \u0026#34;0.0.0.0\u0026#34;, \u0026#34;port_value\u0026#34;: 15001 } }, \u0026#34;filter_chains\u0026#34;: [ //çœç•¥å…¶ä»– filter chain { \u0026#34;filters\u0026#34;: [{ \u0026#34;name\u0026#34;: \u0026#34;envoy.filters.network.tcp_proxy\u0026#34;, \u0026#34;typed_config\u0026#34;: { \u0026#34;@type\u0026#34;: \u0026#34;type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy\u0026#34;, \u0026#34;stat_prefix\u0026#34;: \u0026#34;passthrough-outbound\u0026#34;, \u0026#34;cluster\u0026#34;: \u0026#34;passthrough-outbound\u0026#34; } }], \u0026#34;name\u0026#34;: \u0026#34;outbound-egress-filter-chain\u0026#34; }], \u0026#34;listener_filters\u0026#34;: [{ \u0026#34;name\u0026#34;: \u0026#34;envoy.filters.listener.original_dst\u0026#34; }, { \u0026#34;name\u0026#34;: \u0026#34;envoy.filters.listener.http_inspector\u0026#34; } ], \u0026#34;traffic_direction\u0026#34;: \u0026#34;OUTBOUND\u0026#34; }, \u0026#34;last_updated\u0026#34;: \u0026#34;2020-12-08T10:07:41.191Z\u0026#34; } }] } åˆ†æ Envoy é‚£è¾¹çœ‹åˆ°äº†æœ‰ä¸ª issueï¼Œä¸ºæ­¤å¢åŠ äº† timeout çš„è®¾ç½®ï¼Œé»˜è®¤ 15sã€‚\nlistener_filters_timeoutï¼šé»˜è®¤ 15sã€‚ç­‰å¾… listener filter å®Œæˆçš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœè®¾ç½®ä¸º 0ï¼Œåˆ™ä¸è¶…æ—¶ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®ä¸‹é¢çš„é…ç½®ä¸ºtrueï¼Œåˆ™ä¼šç›´æ¥å…³é—­è¿æ¥ã€‚ continue_on_listener_filters_timeoutï¼šé»˜è®¤ falseã€‚è¶…æ—¶æ—¶æ˜¯å¦ä½¿ç”¨é»˜è®¤çš„ filter_chain åˆ›å»ºè¿æ¥ã€‚ å¯¹æ¯”ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä¸åŒä¹‹å¤„æ˜¯åœ¨ filter ä¸­å¤šäº† envoy.filters.listener.http_inspectorã€‚ä¸€ä¸ª http_inspector ä¸ºä½• hold ä½æ•´ä¸ª followã€‚\næ­£å¥½æ˜¨å¤©é…ç½®äº† Clion ç”¨äºæºç é˜…è¯»ï¼Œçœ‹ä¸‹ http_inspector çš„æºç ï¼š\nåœ¨http_inspector.ccçš„onReadæ–¹æ³•ï¼Œåœ¨åšMSG_PEEKæ˜¯é“å®šè¯»ä¸åˆ°æ•°æ®çš„ï¼Œè§ä¸Šé¢çš„æ—¥å¿—ï¼ŒåŒæ—¶æŸ¥çœ‹ stats http_inspector.read_error: 0ã€‚å¯è§ï¼Œè¿”å›äº†ParseState::Continueã€‚\nApi::IoError::IoErrorCode::Againçš„æ„æ€æ˜¯ï¼šNo data available right now, try again later. å¯¹äºParseState::Continueçš„è§£é‡Šæ˜¯ï¼šParser expects more data.\nç”±äºonReadè¿”å›äº†ParseState::Continueï¼ŒonAcceptæ–¹æ³•ä¼šè¿”å› Network::FilterStatus::StopIterationã€‚è¿”å›ä¹‹å‰ä¼šæ³¨å†Œä¸ªé’ˆå¯¹Event::FileReadyType::Read | Event::FileReadyType::Closed çš„ callbackï¼Œç”¨äºè¯»å–åˆ°æ•°æ®æˆ–è€…å…³é—­æ–‡ä»¶æ—¶è¿›è¡Œå›è°ƒå¤„ç†ã€‚\nNetwork::FilterStatus::StopIterationï¼šStop executing further filters.\nsource/server/connection_handler_impl.cc çš„ continueFilterChainæ–¹æ³•ï¼Œçœ‹æ³¨é‡Šï¼šBlocking at the filter but no errorã€‚ç­‰å¾…ä¸Šé¢çš„ callback è¢«è°ƒç”¨ã€‚\nç”±äºå‰é¢ç›´æ¥ä»for loop ä¸­è·³å‡ºï¼Œè¿­ä»£å¹¶æ²¡æœ‰æ‰§è¡Œåˆ°endï¼Œä¼šå¯åŠ¨ä¸€ä¸ªè¶…æ—¶çš„ timerã€‚ å‚è€ƒï¼š\né…ç½® Clion é˜…è¯» envoy æºç  allow fallback to default filter chain when listener filters timeout ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/envoy-listener-filter-times-out/","tags":["Envoy"],"title":"Envoy listener filter times out é—®é¢˜"},{"categories":["æºç è§£æ"],"contents":"è™½ç„¶ä¸å†™ C++ï¼Œä½†æ˜¯çœ‹ç‚¹ä»£ç è¿˜æ˜¯èƒ½çœ‹æ‡‚ã€‚Envoy çš„åŠŸèƒ½é…ç½®å¤æ‚ï¼Œæœ‰æ—¶å€™å¤„ç†é—®é¢˜è¿˜æ˜¯éœ€è¦çœ‹ä¸‹æºç çš„ã€‚\nVim æˆ–è€… Code å°±ç®—äº†ï¼Œæˆ‘åªæ˜¯é˜…è¯»æºç éœ€è¦å…³è”è·³è½¬å°±è¡Œã€‚åœ¨ Clion ä¸­ï¼Œä»£ç çš„å…³è”è·³è½¬éœ€è¦ä¸€ä¸ªCMakeLists.txt æ–‡ä»¶ã€‚\næˆ‘å°†ç”Ÿæˆçš„å†…å®¹æŒ‚åœ¨äº† gist ä¸Šäº†ï¼Œä¸æƒ³èŠ±è´¹æ—¶é—´ç”Ÿæˆçš„å¯ä»¥ç›´æ¥å¤åˆ¶ã€‚\nå‡†å¤‡ç¯å¢ƒ 1. å®‰è£…ä¾èµ–çš„å·¥å…· brew install coreutils wget cmake libtool go automake ninja clang-format 2. bazel ä½¿ç”¨ homebrew è¿›è¡Œå®‰è£…ï¼š brew install bazel å³å¯\nå®‰è£…é—®è¿è¡Œç¼–è¯‘æµ‹è¯•ä¸‹ï¼šbazel build //source/exe:envoy-staticï¼Œæç¤ºç‰ˆæœ¬å¤ªé«˜ã€‚\nç°åœ¨ homebrew å®‰è£…çš„ç‰ˆæœ¬æ˜¯3.7.1ï¼Œè€Œ envoy éœ€è¦3.4.1ã€‚\næŒ‰ç…§æç¤ºä¸‹è½½3.4.1çš„ç‰ˆæœ¬ï¼šcd \u0026quot;/usr/local/Cellar/bazel/3.7.1/libexec/bin\u0026quot; \u0026amp;\u0026amp; curl -fLO https://releases.bazel.build/3.4.1/release/bazel-3.4.1-darwin-x86_64 \u0026amp;\u0026amp; chmod +x bazel-3.4.1-darwin-x86_64ï¼Œç„¶å è¿›åˆ°ç›®å½•é‡Œè¿›è¡Œä¸‹æ›¿æ¢ ã€‚\næ³¨æ„ï¼šç¼–è¯‘è€—æ—¶å¾ˆé•¿ï¼Œåƒ cpuã€‚\nINFO: Elapsed time: 1844.351s, Critical Path: 336.48s INFO: 4918 processes: 4918 darwin-sandbox. INFO: Build completed successfully, 6088 total actions 3. ç”ŸæˆCMakeLists.txtæ–‡ä»¶ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢éœ€è¦å®‰è£…ç¼–è¯‘å·¥å…·äº†ï¼Œclone git@github.com:lizan/bazel-cmakelists.git è¿™ä¸ªä»“åº“ã€‚\nåªè¦bazelç¼–è¯‘èƒ½é€šè¿‡ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å…·ç”Ÿæˆæ–‡ä»¶äº†ã€‚\nåœ¨ envoy æºç æ ¹ç›®å½•æ‰§è¡Œå‘½ä»¤ï¼š/path_to_bazel-cmakelists/bazel-cmakelists //source/exe:envoy-staticã€‚\næ‰§è¡Œç»“æœï¼š\nCMakeLists.txt generated in following directory: /Users/addo/Workspaces/github_w/envoyproxy/envoy 4. Clion åˆ·æ–° Clion æ£€æµ‹åˆ° CMakeLists.txt ä¹‹åå°±ä¼šè‡ªåŠ¨åˆ·æ–° workspaceï¼Œè‡ªæ­¤å°±å¯ä»¥åœ¨ Clion ä¸­æ„‰å¿«çš„é˜…è¯»æºç äº†ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/read-envoy-source-code-in-clion/","tags":["Envoy"],"title":"ä½¿ç”¨ cLion é˜…è¯» envoy æºç "},{"categories":["ç¬”è®°"],"contents":"ä¸Šç¯‡æ‰’äº† HPA çš„æºç ï¼Œä½†æ˜¯æ²¡æ·±å…¥ç»†èŠ‚ï¼Œä»Šå¤©å¾€ç»†èŠ‚æ·±å…¥ã€‚\nå¼€å±€å…ˆç¥­å‡ºä¸€å¼ å›¾ï¼š\nä¸ºä»€ä¹ˆè¦æœ‰ Informerï¼Ÿ Kubernetes ä¸­çš„æŒä¹…åŒ–æ•°æ®ä¿å­˜åœ¨ etcdä¸­ï¼Œå„ä¸ªç»„ä»¶å¹¶ä¸ä¼šç›´æ¥è®¿é—® etcdï¼Œè€Œæ˜¯é€šè¿‡ api-serveræš´éœ²çš„ RESTful æ¥å£å¯¹é›†ç¾¤è¿›è¡Œè®¿é—®å’Œæ§åˆ¶ã€‚\nèµ„æºçš„æ§åˆ¶å™¨ï¼ˆå›¾ä¸­å³ä¾§ç°è‰²çš„éƒ¨åˆ†ï¼‰è¯»å–æ•°æ®ä¹Ÿå¹¶ä¸ä¼šç›´æ¥ä» api-server ä¸­è·å–èµ„æºä¿¡æ¯ï¼ˆè¿™æ ·ä¼šå¢åŠ  api-server çš„å‹åŠ›ï¼‰ï¼Œè€Œæ˜¯ä»å…¶â€œæœ¬åœ°ç¼“å­˜â€ä¸­è¯»å–ã€‚è¿™ä¸ªâ€œæœ¬åœ°ç¼“å­˜â€åªæ˜¯è¡¨è±¡çš„å­˜åœ¨ï¼ŒåŠ ä¸Šç¼“å­˜çš„åŒæ­¥é€»è¾‘å°±æ˜¯ä»Šå¤©è¦æ˜¯è¯´çš„Informerï¼ˆç°è‰²åŒºåŸŸä¸­çš„ç¬¬ä¸€ä¸ªè“è‰²å—ï¼‰æ‰€æä¾›çš„åŠŸèƒ½ã€‚\nä»å›¾ä¸­å¯ä»¥çœ‹åˆ° Informer çš„å‡ ä¸ªç»„ä»¶ï¼š\nReflectorï¼šä¸ api-serveräº¤äº’ï¼Œç›‘å¬èµ„æºçš„å˜æ›´ã€‚ Delta FIFO Queueï¼šå¢é‡çš„ FIFO é˜Ÿåˆ—ï¼Œä¿å­˜ Reflector ç›‘å¬åˆ°çš„èµ„æºå˜æ›´ï¼ˆç®€å•çš„å°è£…ï¼‰ã€‚ Indexerï¼šInformer çš„æœ¬åœ°ç¼“å­˜ï¼ŒFIFO é˜Ÿåˆ—ä¸­çš„æ•°æ®æ ¹æ®ä¸åŒçš„å˜æ›´ç±»å‹ï¼Œåœ¨è¯¥ç¼“å­˜ä¸­è¿›è¡Œæ“ä½œã€‚ Local Storeï¼š ä¸Šç¯‡ æåˆ°äº†æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©çš„æ§åˆ¶å™¨HorizontalControllerï¼Œå…¶æ„é€ æ–¹æ³•å°±éœ€è¦æä¾› Informerã€‚\n//pkg/controller/podautoscaler/horizontal.go type HorizontalController struct { scaleNamespacer scaleclient.ScalesGetter hpaNamespacer autoscalingclient.HorizontalPodAutoscalersGetter mapper apimeta.RESTMapper replicaCalc *ReplicaCalculator eventRecorder record.EventRecorder downscaleStabilisationWindow time.Duration hpaLister autoscalinglisters.HorizontalPodAutoscalerLister hpaListerSynced cache.InformerSynced podLister corelisters.PodLister podListerSynced cache.InformerSynced queue workqueue.RateLimitingInterface recommendations map[string][]timestampedRecommendation } func NewHorizontalController( evtNamespacer v1core.EventsGetter, scaleNamespacer scaleclient.ScalesGetter, hpaNamespacer autoscalingclient.HorizontalPodAutoscalersGetter, mapper apimeta.RESTMapper, metricsClient metricsclient.MetricsClient, //ä»HorizontalPodAutoscalerInformer è·å–hpa å®ä¾‹ä¿¡æ¯ hpaInformer autoscalinginformers.HorizontalPodAutoscalerInformer, //ä»PodInformer ä¸­è·å– pod ä¿¡æ¯ podInformer coreinformers.PodInformer, resyncPeriod time.Duration, downscaleStabilisationWindow time.Duration, tolerance float64, cpuInitializationPeriod, delayOfInitialReadinessStatus time.Duration, ) *HorizontalController { ...... hpaInformer.Informer().AddEventHandlerWithResyncPeriod( //æ·»åŠ äº‹ä»¶å¤„ç†å™¨ cache.ResourceEventHandlerFuncs{ AddFunc: hpaController.enqueueHPA, UpdateFunc: hpaController.updateHPA, DeleteFunc: hpaController.deleteHPA, }, resyncPeriod, ) ...... } type HorizontalPodAutoscalerInformer interface { Informer() cache.SharedIndexInformer Lister() v1.HorizontalPodAutoscalerLister } HorizontalPodAutoscalerInformerçš„å®ä¾‹åŒ–æ–¹æ³•ä¸­å°±å‡ºç°äº†ä»Šå¤©çš„æ­£ä¸»cache.NewSharedIndexInformer()ã€‚\n//staging/src/k8s.io/client-go/informers/autoscaling/v1/horizontalpodautoscaler.go func NewFilteredHorizontalPodAutoscalerInformer(client kubernetes.Interface, namespace string, resyncPeriod time.Duration, indexers cache.Indexers, tweakListOptions internalinterfaces.TweakListOptionsFunc) cache.SharedIndexInformer { return cache.NewSharedIndexInformer( //ç”¨äº list å’Œ watch api-server ä¸­çš„èµ„æºã€‚æ¯”å¦‚ç”¨æ¥åˆ›å»º Reflector \u0026amp;cache.ListWatch{ ListFunc: func(options metav1.ListOptions) (runtime.Object, error) { if tweakListOptions != nil { tweakListOptions(\u0026amp;options) } //ä½¿ç”¨ HPA API è·å– HPAèµ„æº return client.AutoscalingV1().HorizontalPodAutoscalers(namespace).List(options) }, WatchFunc: func(options metav1.ListOptions) (watch.Interface, error) { if tweakListOptions != nil { tweakListOptions(\u0026amp;options) } //ä½¿ç”¨ HPA API ç›‘æ§ HPAèµ„æº return client.AutoscalingV1().HorizontalPodAutoscalers(namespace).Watch(options) }, }, \u0026amp;autoscalingv1.HorizontalPodAutoscaler{}, resyncPeriod, indexers, ) } åˆå§‹åŒ– Informer //staging/src/k8s.io/client-go/tools/cache/index.go type Indexers map[string]IndexFunc type IndexFunc func(obj interface{}) ([]string, error) å®ä¾‹åŒ– Indexers cache.Indexers{cache.NamespaceIndex: cache.MetaNamespaceIndexFunc}\n//staging/src/k8s.io/client-go/tools/cache/shared_informer.go // ListerWatcher ç”¨äº list å’Œwatch api-server ä¸Šçš„èµ„æº //runtime.Objectè¦ç›‘æ§çš„èµ„æºçš„è¿è¡Œæ—¶å¯¹è±¡ //time.DurationåŒæ­¥çš„é—´éš”æ—¶é—´ //Indexers æä¾›ä¸åŒèµ„æºçš„ç´¢å¼•æ•°æ®çš„ä¿¡æ¯æŸ¥è¯¢æ–¹æ³•ï¼Œå¦‚ namespace =\u0026gt; MetaNamespaceIndexFunc func NewSharedIndexInformer(lw ListerWatcher, objType runtime.Object, defaultEventHandlerResyncPeriod time.Duration, indexers Indexers) SharedIndexInformer { realClock := \u0026amp;clock.RealClock{} sharedIndexInformer := \u0026amp;sharedIndexInformer{ processor: \u0026amp;sharedProcessor{clock: realClock}, indexer: NewIndexer(DeletionHandlingMetaNamespaceKeyFunc, indexers), //åˆå§‹åŒ– Indexer listerWatcher: lw, objectType: objType, resyncCheckPeriod: defaultEventHandlerResyncPeriod, defaultEventHandlerResyncPeriod: defaultEventHandlerResyncPeriod, cacheMutationDetector: NewCacheMutationDetector(fmt.Sprintf(\u0026#34;%T\u0026#34;, objType)), clock: realClock, } return sharedIndexInformer } Indexer Indexeræä¾›äº†æœ¬åœ°ç¼“å­˜çš„å®ç°ï¼šè®¡ç®— key å’Œå¯¹æ•°æ®è¿›è¡Œæ§åˆ¶ï¼ˆé€šè¿‡è°ƒç”¨ThreadSafeStoreçš„æ¥å£ï¼‰\ntype Indexer interface { Store Index(indexName string, obj interface{}) ([]interface{}, error) IndexKeys(indexName, indexedValue string) ([]string, error) ListIndexFuncValues(indexName string) []string ByIndex(indexName, indexedValue string) ([]interface{}, error) GetIndexers() Indexers AddIndexers(newIndexers Indexers) error } Indexer çš„åˆ›å»º\n//staging/src/k8s.io/client-go/tools/cache/store.go //keyFuncï¼škey çš„ç”Ÿæˆè§„åˆ™ //indexersï¼šæä¾›äº†ç´¢å¼•èµ„æºçš„ä¸åŒä¿¡æ¯çš„è®¿é—®æ–¹æ³•ï¼Œå¦‚ç”¨äºæŸ¥è¯¢å‘½åç©ºé—´çš„ namespace =\u0026gt; MetaNamespaceIndexFunc func NewIndexer(keyFunc KeyFunc, indexers Indexers) Indexer { return \u0026amp;cache{ cacheStorage: NewThreadSafeStore(indexers, Indices{}), keyFunc: keyFunc, } } ThreadSafeStore ThreadSafeStoreæä¾›äº†å¯¹å­˜å‚¨çš„å¹¶å‘è®¿é—®æ¥å£\næ³¨æ„äº‹é¡¹ï¼šä¸èƒ½ä¿®æ”¹Getæˆ–Listè¿”å›çš„ä»»ä½•å†…å®¹ï¼Œå› ä¸ºå®ƒä¸ä»…ä¼šç ´åçº¿ç¨‹å®‰å…¨ï¼Œè¿˜ä¼šç ´åç´¢å¼•åŠŸèƒ½ã€‚\n//staging/src/k8s.io/client-go/tools/cache/thread_safe_store.go func NewThreadSafeStore(indexers Indexers, indices Indices) ThreadSafeStore { return \u0026amp;threadSafeMap{ items: map[string]interface{}{}, indexers: indexers, indices: indices, } } type threadSafeMap struct { lock sync.RWMutex items map[string]interface{} //key =\u0026gt; value indexers Indexers //value çš„ä¿¡æ¯çš„è®¿é—®æ–¹æ³• indices Indices //ç´¢å¼• } Reflector Reflectoré€šè¿‡ ListerWatcherï¼ˆAPIï¼‰ä¸api-serveräº¤äº’ï¼Œå¯¹èµ„æºè¿›è¡Œç›‘æ§ã€‚å°†èµ„æºå®ä¾‹çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ç­‰æ—¶é—´å°è£…åä¿å­˜åœ¨Informerçš„FIFO é˜Ÿåˆ—ä¸­ã€‚\n//staging/src/k8s.io/client-go/tools/cache/reflector.go func NewReflector(lw ListerWatcher, expectedType interface{}, store Store, resyncPeriod time.Duration) *Reflector { return NewNamedReflector(naming.GetNameFromCallsite(internalPackages...), lw, expectedType, store, resyncPeriod) } // NewNamedReflector same as NewReflector, but with a specified name for logging func NewNamedReflector(name string, lw ListerWatcher, expectedType interface{}, store Store, resyncPeriod time.Duration) *Reflector { r := \u0026amp;Reflector{ name: name, listerWatcher: lw, store: store, //FIFOé˜Ÿåˆ— period: time.Second, resyncPeriod: resyncPeriod, clock: \u0026amp;clock.RealClock{}, } r.setExpectedType(expectedType) return r } æ·»åŠ åŒæ­¥äº‹ä»¶ç›‘å¬å™¨ é€šè¿‡sharedIndexInformer#AddEventHandlerWithResyncPeriod()æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ã€‚\nä»¥å‰é¢çš„ HorizontalControllerä¸ºä¾‹ï¼Œåˆ›å»º informer çš„æ—¶å€™æ·»åŠ äº†ä¸‰ä¸ªå¤„ç†æ–¹æ³•ï¼šAddFuncã€UpdateFuncã€DeleteFuncã€‚è¿™ä¸‰ä¸ªæ–¹æ³•çš„å®ç°æ˜¯å°†å¯¹åº”çš„å…ƒç´ çš„ keyï¼ˆå›ºå®šæ ¼å¼ namespace/nameï¼‰ä» workequeueä¸­è¿›è¡Œå…¥é˜Ÿã€å‡ºé˜Ÿçš„æ“ä½œã€‚ï¼ˆèµ„æºæ§åˆ¶å™¨ç›‘å¬äº†è¯¥ workqueueï¼‰\nè¿è¡Œ controller-manager åœ¨é€šè¿‡InformerFactoryåˆ›å»ºInformerå®Œæˆåï¼Œéƒ½ä¼šå°†æ–°å»ºçš„ InformeråŠ å…¥åˆ°InformerFactoryçš„ä¸€ä¸ªmapä¸­ã€‚\nåœ¨controller-manageråœ¨å®Œæˆæ‰€æœ‰çš„æ§åˆ¶å™¨ï¼ˆå„ç§Controllerï¼ŒåŒ…æ‹¬ CRDï¼‰åï¼Œä¼šè°ƒç”¨InformerFactory#Start()æ¥å¯åŠ¨InformerFactoryçš„mapä¸­çš„æ‰€æœ‰ Informerï¼ˆè°ƒç”¨Informer#Run()æ–¹æ³•ï¼‰\nsharedIndexInformer#Run() //staging/src/k8s.io/client-go/tools/cache/shared_informer.go func (s *sharedIndexInformer) Run(stopCh \u0026lt;-chan struct{}) { defer utilruntime.HandleCrash() //åˆ›å»ºä¸€ä¸ªå¢é‡çš„ FIFOé˜Ÿåˆ—ï¼šDeltaFIFO fifo := NewDeltaFIFO(MetaNamespaceKeyFunc, s.indexer) cfg := \u0026amp;Config{ Queue: fifo, ListerWatcher: s.listerWatcher, ObjectType: s.objectType, FullResyncPeriod: s.resyncCheckPeriod, RetryOnError: false, ShouldResync: s.processor.shouldResync, Process: s.HandleDeltas, } //å¯åŠ¨å‰çš„åˆå§‹åŒ–ï¼Œåˆ›å»º Controller func() { s.startedLock.Lock() defer s.startedLock.Unlock() s.controller = New(cfg) s.controller.(*controller).clock = s.clock s.started = true }() processorStopCh := make(chan struct{}) var wg wait.Group defer wg.Wait() // Wait for Processor to stop defer close(processorStopCh) // Tell Processor to stop wg.StartWithChannel(processorStopCh, s.cacheMutationDetector.Run) wg.StartWithChannel(processorStopCh, s.processor.run) //é€€å‡ºæ—¶çš„çŠ¶æ€æ¸…ç† defer func() { s.startedLock.Lock() defer s.startedLock.Unlock() s.stopped = true // Don\u0026#39;t want any new listeners }() //å®è¡Œæ§åˆ¶é€»è¾‘ s.controller.Run(stopCh) } controller#Run() //staging/src/k8s.io/client-go/tools/cache/controller.go func (c *controller) Run(stopCh \u0026lt;-chan struct{}) { defer utilruntime.HandleCrash() go func() { \u0026lt;-stopCh c.config.Queue.Close() }() //åˆ›å»ºä¸€ä¸ª Reflectorï¼Œç”¨äºä» api-server list å’Œ watch èµ„æº r := NewReflector( c.config.ListerWatcher, c.config.ObjectType, c.config.Queue, c.config.FullResyncPeriod, ) r.ShouldResync = c.config.ShouldResync r.clock = c.clock //ä¸º controller æŒ‡å®š Reflector c.reflectorMutex.Lock() c.reflector = r c.reflectorMutex.Unlock() var wg wait.Group defer wg.Wait() //æ‰§è¡ŒReflector#Run()ï¼šä¼šå¯åŠ¨ä¸€ä¸ªgoroutineå¼€å§‹ç›‘æ§èµ„æºï¼Œå°† watch åˆ°çš„æ•°æ®å†™å…¥åˆ°queueï¼ˆFIFO é˜Ÿåˆ—ï¼‰ä¸­ wg.StartWithChannel(stopCh, r.Run) //æŒç»­ä» queueï¼ˆFIFO é˜Ÿåˆ—ï¼‰ è·å–æ•°æ®å¹¶è¿›è¡Œå¤„ç†ï¼Œå¤„ç†çš„é€»è¾‘åœ¨sharedIndexInformer#HandleDeltas() wait.Until(c.processLoop, time.Second, stopCh) } sharedIndexInformer#HandleDeltas() //staging/src/k8s.io/client-go/tools/cache/shared_informer.go func (s *sharedIndexInformer) HandleDeltas(obj interface{}) error { s.blockDeltas.Lock() defer s.blockDeltas.Unlock() // from oldest to newest for _, d := range obj.(Deltas) { //å¾ªç¯å¤„ç† FIFO é˜Ÿåˆ—ä¸­å–å‡ºçš„èµ„æºå®ä¾‹ switch d.Type { case Sync, Added, Updated: //åŒæ­¥ï¼ˆåé¢è¯¦ç»†è§£è¯»ï¼‰ã€æ–°å¢ã€æ›´æ–°äº‹ä»¶ isSync := d.Type == Sync s.cacheMutationDetector.AddObject(d.Object) if old, exists, err := s.indexer.Get(d.Object); err == nil \u0026amp;\u0026amp; exists { if err := s.indexer.Update(d.Object); err != nil { //å¦‚æœ indexer ä¸­å·²ç»å­˜åœ¨ï¼Œæ›´æ‰ç”¨ update æ–¹æ³•è¿›è¡Œæ›´æ–° return err } //æ›´æ–°æˆåŠŸåå‘é€â€œæ›´æ–°â€é€šçŸ¥ï¼šåŒ…å«äº†æ–°ã€æ—§èµ„æºå®ä¾‹ s.processor.distribute(updateNotification{oldObj: old, newObj: d.Object}, isSync) } else { //å¦‚æœ indexer ä¸­æ²¡æœ‰è¯¥èµ„æºå®ä¾‹ï¼Œåˆ™æ”¾å…¥ indexer ä¸­ if err := s.indexer.Add(d.Object); err != nil { return err } //æ·»åŠ æˆåŠŸåï¼Œå‘é€â€œæ–°å¢â€é€šçŸ¥ï¼šåŒ…å«äº†æ–°åŠ çš„èµ„æºå®ä¾‹ s.processor.distribute(addNotification{newObj: d.Object}, isSync) } case Deleted: //åˆ é™¤äº‹ä»¶ if err := s.indexer.Delete(d.Object); err != nil {//ä» indexer ä¸­åˆ é™¤ return err } //åˆ é™¤æˆåŠŸåï¼Œå‘é€â€œåˆ é™¤é€šçŸ¥â€ï¼šåŒ…å«äº†åˆ é™¤çš„èµ„æºå®ä¾‹ s.processor.distribute(deleteNotification{oldObj: d.Object}, false) } } return nil } æ€»ç»“ Informer çš„å®ç°ä¸ç®—å¤æ‚ï¼Œå´åœ¨ Kubernetes ä¸­å¾ˆå¸¸è§ï¼Œæ¯ç§èµ„æºçš„æ§åˆ¶ä¹Ÿéƒ½é€šè¿‡ Informer æ¥è·å–api-serverçš„èµ„æºå®ä¾‹çš„å˜æ›´ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/kubernetes-source-code-how-informer-work/","tags":["Kubernetes","Go"],"title":"Kubernetes æºç è§£æ - Informer"},{"categories":["ç¬”è®°"],"contents":"HPA - Horizontal Pod Autoscaler çš„ç¼©å†™ï¼ŒPod æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ã€‚é€šè¿‡å¯¹ Pod è´Ÿè½½çš„ç›‘æ§ï¼Œæ¥è‡ªåŠ¨å¢åŠ æˆ–è€…å‡å°‘ Pod çš„å‰¯æœ¬æ•°é‡ã€‚\nä»å­—é¢æ„æ€æ¥çœ‹ï¼Œå…¶ä¸»è¦åŒ…å«äº†ä¸¤éƒ¨åˆ†ï¼š\nç›‘æ§ Pod çš„è´Ÿè½½ æ§åˆ¶ Pod çš„å‰¯æœ¬æ•°é‡ é‚£å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿä»¥ä¸‹åŸºäº1.17 æºç ï¼Œæ¥åˆ†æä¸‹ HPA å¦‚ä½•å·¥ä½œã€‚\næ³¨æ„ï¼šæ–‡ç« ä¸­çš„ä»£ç åœ¨æºç çš„åŸºç¡€ä¸Šè¿›è¡Œäº†ç²¾ç®€ï¼šåˆ æ‰äº†æ³¨é‡Šã€åºåˆ—åŒ–ç­‰ä¿¡æ¯ï¼Œæˆ–ä¿ç•™äº†éƒ¨åˆ†æ ¸å¿ƒä»£ç ï¼ŒåŠ ä¸Šæ–°çš„æ³¨é‡Šã€‚\nèµ„æº HPA çš„èµ„æºæ˜¯HorizontalPodAutoscalerï¼Œåœ¨v1ç‰ˆæœ¬ä¸­ï¼Œåªæ”¯æŒåŸºäº CPU æŒ‡æ ‡çš„è®¡ç®—ï¼›åœ¨v2beta2ç‰ˆæœ¬ä¸­åŠ å…¥äº†åŸºäºå†…å­˜å’Œè‡ªå®šä¹‰æŒ‡æ ‡çš„è®¡ç®—ã€‚\nv1 //staging/src/k8s.io/api/autoscaling/v1/types.go type HorizontalPodAutoscaler struct { metav1.TypeMeta metav1.ObjectMeta Spec HorizontalPodAutoscalerSpec Status HorizontalPodAutoscalerStatus } type HorizontalPodAutoscalerSpec struct { ScaleTargetRef CrossVersionObjectReference //ç›‘æ§çš„ç›®æ ‡èµ„æº MinReplicas *int32 //æœ€å°å‰¯æœ¬æ•° MaxReplicas int32 //æœ€å¤§å‰¯æœ¬æ•° TargetCPUUtilizationPercentage *int32 //è§¦å‘è°ƒæ•´çš„CPU ä½¿ç”¨ç‡ } v2 //staging/src/k8s.io/api/autoscaling/v2beta2/types.go type HorizontalPodAutoscaler struct { metav1.TypeMeta metav1.ObjectMeta Spec HorizontalPodAutoscalerSpec Status HorizontalPodAutoscalerStatus } type HorizontalPodAutoscalerSpec struct { ScaleTargetRef CrossVersionObjectReference //ç›‘æ§çš„ç›®æ ‡èµ„æº MinReplicas *int32 MaxReplicas int32 Metrics []MetricSpec //æ–°åŠ å…¥çš„è‡ªå®šä¹‰æŒ‡æ ‡ } type MetricSpec struct { Type MetricSourceType //æŒ‡æ ‡æºçš„ç±»å‹ï¼šObjectï¼ˆåŸºäºæŸä¸ªå¯¹è±¡ï¼‰ã€Podsï¼ˆåŸºäºpod æ•°ï¼‰ã€Resourceï¼ˆåŸºäºèµ„æºä½¿ç”¨è®¡ç®—ï¼Œæ¯”å¦‚v1 ç‰ˆæœ¬ä¸­cpuï¼‰ã€Externalï¼ˆåŸºäºå¤–éƒ¨çš„æŒ‡æ ‡ï¼‰ã€‚å¯¹åº” MetricsClient æ¥å£çš„å››ä¸ªæ–¹æ³• Object *ObjectMetricSource //å¯¹åº” Object ç±»å‹çš„æŒ‡æ ‡æº Pods *PodsMetricSource //å¯¹åº” Pod ç±»å‹çš„æŒ‡æ ‡æº Resource *ResourceMetricSource //å¯¹åº” Resource ç±»å‹çš„æŒ‡æ ‡æº External *ExternalMetricSource //å¯¹åº” External ç±»å‹çš„æŒ‡æ ‡æº } type ObjectMetricSource struct { DescribedObject CrossVersionObjectReference //ç›®æ ‡å¯¹è±¡ Target MetricTarget //æŒ‡å®šæŒ‡æ ‡çš„ç›®æ ‡å€¼ã€å¹³å‡å€¼æˆ–è€…å¹³å‡ä½¿ç”¨ç‡ Metric MetricIdentifier //æŒ‡æ ‡æ ‡è¯†ï¼šåå­—ã€labelé€‰æ‹©å™¨ } type PodsMetricSource struct { Metric MetricIdentifier Target MetricTarget } type ResourceMetricSource struct { Name v1.ResourceName Target MetricTarget } type ExternalMetricSource struct { Metric MetricIdentifier Target MetricTarget } type MetricTarget struct { Type MetricTargetType //ç±»å‹ï¼šUtilizationã€Valueã€AverageValue Value *resource.Quantity AverageValue *resource.Quantity AverageUtilization *int32 } æ§åˆ¶å™¨ HorizontalController HorizontalControllerè¢«é€šè¿‡ key horizontalpodautoscaling åŠ å…¥åˆ° controller manager ä¸­ã€‚ç”¨æ¥æ§åˆ¶HorizontalPodAutoscalerå®ä¾‹ã€‚\n///cmd/kube-controller-manager/app/controllermanager.go func NewControllerInitializers(loopMode ControllerLoopMode) map[string]InitFunc { ... controllers[\u0026#34;horizontalpodautoscaling\u0026#34;] = startHPAController ... } è·å–è´Ÿè½½æŒ‡æ ‡ æ—¢ç„¶ Pod å‰¯æœ¬æ•°é‡çš„è®¡ç®—æ˜¯åŸºäº Pod çš„è´Ÿè½½æƒ…å†µï¼Œé‚£è¾¹éœ€è¦é€”å¾„è·å–è´Ÿè½½æ•°æ®ï¼Œè¿™ä¸ªé€”å¾„å°±æ˜¯MetricsClientã€‚\nMetricsClientæœ‰ä¸¤ç§å®ç°ï¼šREST æ–¹å¼å’Œä¼ ç»Ÿï¼ˆLegacyï¼‰æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯restMetricsClientå’ŒHeapsterMetricsClientã€‚ä¸€ä¸ªæ˜¯REST å®ç°ä»¥æ”¯æŒè‡ªå®šä¹‰çš„æŒ‡æ ‡ï¼›ä¸€ä¸ªæ˜¯ä¼ ç»Ÿçš„ Heapster æŒ‡æ ‡ï¼ˆheapster å·²ç»ä» 1.13 ç‰ˆæœ¬å¼€å§‹è¢«åºŸå¼ƒäº†ï¼‰ã€‚\n//cmd/kube-controller-manager/app/autoscaling.go func startHPAController(ctx ControllerContext) (http.Handler, bool, error) { if !ctx.AvailableResources[schema.GroupVersionResource{Group: \u0026#34;autoscaling\u0026#34;, Version: \u0026#34;v1\u0026#34;, Resource: \u0026#34;horizontalpodautoscalers\u0026#34;}] { return nil, false, nil } if ctx.ComponentConfig.HPAController.HorizontalPodAutoscalerUseRESTClients { // use the new-style clients if support for custom metrics is enabled return startHPAControllerWithRESTClient(ctx) } return startHPAControllerWithLegacyClient(ctx) } æ§åˆ¶å™¨é€»è¾‘HorizontalController#Run() //pkg/controller/podautoscaler/horizontal.go func (a *HorizontalController) Run(stopCh \u0026lt;-chan struct{}) { defer utilruntime.HandleCrash() defer a.queue.ShutDown() klog.Infof(\u0026#34;Starting HPA controller\u0026#34;) defer klog.Infof(\u0026#34;Shutting down HPA controller\u0026#34;) // ç­‰å¾… informer å®ŒæˆHorizontalPodAutoscalerç›¸å…³äº‹ä»¶çš„åŒæ­¥ if !cache.WaitForNamedCacheSync(\u0026#34;HPA\u0026#34;, stopCh, a.hpaListerSynced, a.podListerSynced) { return } // start a single worker (we may wish to start more in the future) //æ‰§è¡Œ worker é€»è¾‘ï¼Œç›´åˆ°æ”¶åˆ°é€€å‡ºæŒ‡ä»¤ go wait.Until(a.worker, time.Second, stopCh) \u0026lt;-stopCh } workerçš„æ ¸å¿ƒæ˜¯ä»å·¥ä½œé˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ª keyï¼ˆæ ¼å¼ä¸ºï¼šnamespace/nameï¼‰ï¼Œç„¶åå¯¹ key è¿›è¡Œ reconcileï¼ˆè¿™ä¸ªè¯æ˜¯Kubernetes çš„æ ¸å¿ƒï¼Œç¿»è¯‘ä¸ºâ€œè°ƒå’Œâ€ã€â€œå’Œè§£â€ã€‚ä¸ªäººæ›´å–œæ¬¢â€œè°ƒæ•´â€ï¼Œå³å°†å®ä¾‹çš„çŠ¶æ€è°ƒæ•´ä¸ºæœŸæœ›çš„çŠ¶æ€ã€‚æ­¤å¤„ï¼Œå¯¹äº hpa çš„å®ä¾‹çš„æ¯ä¸ªäº‹ä»¶ï¼Œéƒ½ä¼šæŒ‰ç…§ç‰¹å®šçš„é€»è¾‘è°ƒæ•´ç›®æ ‡å®ä¾‹çš„ Pod çš„å‰¯æœ¬æ•°é‡ã€‚ï¼‰ã€‚\n//pkg/controller/podautoscaler/horizontal.go func (a *HorizontalController) worker() { for a.processNextWorkItem() { } klog.Infof(\u0026#34;horizontal pod autoscaler controller worker shutting down\u0026#34;) } func (a *HorizontalController) processNextWorkItem() bool { key, quit := a.queue.Get() if quit { return false } defer a.queue.Done(key) deleted, err := a.reconcileKey(key.(string)) if err != nil { utilruntime.HandleError(err) } if !deleted { a.queue.AddRateLimited(key) } return true } å¯¹ key è¿›è¡Œ reconcile çš„è°ƒç”¨æ ˆï¼šHorizontalController#reconcileKey -\u0026gt; HorizontalController#reconcileAutoscaler -\u0026gt; HorizontalController#computeReplicasForMetrics -\u0026gt; ScaleInterface#Update\nç®€å•æ¥è¯´å°±æ˜¯å…ˆä»Informerä¸­æ‹¿åˆ° key å¯¹åº”çš„HorizontalPodAutoscalerèµ„æºå®ä¾‹ï¼›ç„¶åé€šè¿‡HorizontalPodAutoscalerå®ä¾‹ä¸­çš„ä¿¡æ¯ï¼Œæ£€æŸ¥ç›®æ ‡èµ„æºçš„Pod è´Ÿè½½ä»¥åŠå½“å‰çš„å‰¯æœ¬æ•°ï¼Œå¾—åˆ°æœŸæœ›çš„ Pod å‰¯æœ¬æ•°ï¼›æœ€ç»ˆé€šè¿‡ Scale API æ¥è°ƒæ•´ Pod çš„å‰¯æœ¬æ•°ã€‚æœ€åä¼šå°†è°ƒæ•´çš„åŸå› ã€è®¡ç®—çš„ç»“æœç­‰ä¿¡æ¯å†™å…¥HorizontalPodAutoscalerå®ä¾‹çš„ condition ä¸­ã€‚\nè®¡ç®—æœŸæœ›çš„å‰¯æœ¬æ•° å¯¹æ¯ä¸ªæŒ‡æ ‡è¿›è¡Œè®¡ç®—ï¼Œéƒ½ä¼šå¾—åˆ°å»ºè®®çš„å‰¯æœ¬æ•°ï¼Œç„¶åæœ€å¤§çš„é‚£ä¸ªå°±æ˜¯æœ€ç»ˆçš„æœŸæœ›å‰¯æœ¬æ•°ã€‚\n//pkg/controller/podautoscaler/horizontal.go func (a *HorizontalController) computeReplicasForMetrics(hpa *autoscalingv2.HorizontalPodAutoscaler, scale *autoscalingv1.Scale, metricSpecs []autoscalingv2.MetricSpec) (replicas int32, metric string, statuses []autoscalingv2.MetricStatus, timestamp time.Time, err error) { ...... for i, metricSpec := range metricSpecs { replicaCountProposal, metricNameProposal, timestampProposal, condition, err := a.computeReplicasForMetric(hpa, metricSpec, specReplicas, statusReplicas, selector, \u0026amp;statuses[i]) if err != nil { if invalidMetricsCount \u0026lt;= 0 { invalidMetricCondition = condition invalidMetricError = err } invalidMetricsCount++ } if err == nil \u0026amp;\u0026amp; (replicas == 0 || replicaCountProposal \u0026gt; replicas) { timestamp = timestampProposal replicas = replicaCountProposal metric = metricNameProposal } } ...... } #computeStatusForObjectMetricï¼ˆæ³¨æ„è¿™ä¸ªæ–¹æ³•åå°‘äº†ä¸ª \u0026ldquo;s\u0026rdquo;ï¼‰ä½¿ç”¨MetricsClientå¾—åˆ°æŒ‡å®šæŒ‡æ ‡çš„å€¼ã€‚\nè¿™ä¸ªæµç¨‹çš„ç»†èŠ‚è¿˜å¯ä»¥ç»§ç»­æ·±æŒ–ï¼Œä½†åˆ°æ­¤å·²å¤Ÿæˆ‘ä»¬ç†è§£ HPAâ€‹ çš„å®ç°æ–¹å¼äº†ã€‚â€‹\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/kubernetes-source-code-how-hpa-work/","tags":["Kubernetes","Go","DevOps"],"title":"Kubernetes æºç è§£æ - HPA æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©å¦‚ä½•å·¥ä½œ"},{"categories":["ç¬”è®°"],"contents":"Spring Cloud ä¸­ Ribbonæœ‰åœ¨ Zuul å’Œ Feign ä¸­ä½¿ç”¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡åœ¨RestTemplateçš„ bean å®šä¹‰ä¸Šæ·»åŠ @LoadBalancedæ³¨è§£æ–¹å¼è·å¾—ä¸€ä¸ªå¸¦æœ‰è´Ÿè½½å‡è¡¡æ›´èƒ½çš„RestTemplateã€‚\nä¸è¿‡å®ç°çš„æ–¹æ³•éƒ½å¤§åŒå°å¼‚ï¼šå¯¹HttpClientè¿›è¡Œå°è£…ï¼ŒåŠ ä¸Šå®ä¾‹çš„â€é€‰æ‹©â€œï¼ˆè¿™ä¸ªé€‰æ‹©çš„é€»è¾‘å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„è´Ÿè½½å‡è¡¡ï¼‰ã€‚\nè¦å­¦ä¹ æŸä¸ªæ¡†æ¶çš„æ—¶å€™ï¼Œæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯ï¼šRunning+Debuggingã€‚\nè·‘å°±æ˜¯äº†ã€‚\ndebug ä¸ä¸€å®šæ˜¯ä¸ºäº† bug\ndebug å‡ºçœŸçŸ¥\nDebugging = Learning\né€‰ç”¨ Ali Spittel çš„ä¸€æ¡æ¨æ–‡ï¼š\nä»¥ Zuul è·¯ç”±çš„çº¿ç¨‹æ ˆä¸ºä¾‹ è°ƒæ•´ä¸‹é¡ºåºï¼š\nRetryableRibbonLoadBalancingHttpClient#execute(RibbonApacheHttpRequest, IClientConfig) RetryableRibbonLoadBalancingHttpClient#executeWithRetry(...) RetryTemplate#execute(RetryCallback\u0026lt;T, E\u0026gt;, RecoveryCallback\u0026lt;T\u0026gt;) RetryTemplate#doExecute(RetryCallback\u0026lt;T, E\u0026gt;, RecoveryCallback\u0026lt;T\u0026gt;, RetryState) RetryTemplate#canRetry(RetryPolicy, RetryContext) InterceptorRetryPolicy#canRetry(RetryContext) AbstractLoadBalancingClient#choose(String serviceId) ZoneAwareLoadBalancer#chooseServer(Object key) //key as serviceId BaseLoadBalancer#chooseServer(Object key) PredicateBasedRule#choose(Object key) AbstractServerPredicate#chooseRoundRobinAfterFiltering(List\u0026lt;Server\u0026gt; servers, Object loadBalancerKey) AbstractServerPredicate#apply(Predicate) åˆ†æ Zuul æ”¶åˆ°è¯·æ±‚ç»è¿‡ä¸€ç³»åˆ— Filter çš„å¤„ç†ï¼Œæ¥åˆ° RibbonRoutingFilterï¼›å°†è¯·æ±‚å°è£…æˆ RibbonCommandContextï¼Œç„¶åä½¿ç”¨ context æ„å»º RibbonCommandã€‚æœ€ç»ˆè°ƒç”¨RibbonCommand#execute()æ–¹æ³•ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°ä¸‹æ¸¸ã€‚\nRibbonCommandæŒæœ‰AbstractLoadBalancerAwareClientçš„å¯¹è±¡ï¼Œé€šè¿‡è¯¥ client åœ¨å¤„ç†è¯·æ±‚å’Œå“åº”ã€‚\nå¯¹äº retryable çš„ clientï¼ˆæ¯”å¦‚æ­¤å¤„çš„RetryableRibbonLoadBalancingHttpClientï¼‰ï¼Œ æ¯æ¬¡å¤„ç†è¯·æ±‚çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ª RetryTemplateå¯¹è±¡æ¥å¤„ç†è¯·æ±‚ï¼›åŒæ—¶æ ¹æ®RetryPolicyæ¥åˆ›å»ºRetryContextå¯¹è±¡ï¼Œç”¨æ¥ä¿å­˜é‡è¯•çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶ æ£€æŸ¥å®ä¾‹æ˜¯å¦å¯ä»¥è¿›è¡Œé‡è¯• ã€‚\næ³¨æ„é‡ç‚¹å°±åœ¨è¿™é‡Œï¼šæ£€æŸ¥çš„æ—¶å€™å¦‚æœé‡è¯•æ¬¡æ•°ä¸º 0 ä¸”è¦æ£€æŸ¥çš„å®ä¾‹ä¸ºç©ºï¼ˆè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼‰ï¼Œè¿™æ—¶ä¾¿ä¼šé€šè¿‡è´Ÿè½½å‡è¡¡å™¨å®¢æˆ·ç«¯ï¼ˆåŸºæœ¬éƒ½æ˜¯AbstractLoadBalancingClientçš„å­ç±»ï¼‰ä»åç«¯åˆ—è¡¨æ‹©å‡ºä¸€ä¸ªå®ä¾‹ï¼Œä¿å­˜åœ¨RetryContextä¸­ã€‚\nè´Ÿè½½å‡è¡¡å™¨å®¢æˆ·ç«¯ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨ï¼ˆILoadBalancerçš„å®ç°ï¼‰æ¥é€‰æ‹©å®ä¾‹ã€‚æ¯ä¸ªè´Ÿè½½å‡è¡¡å™¨éƒ½æœ‰è‡ªå·±çš„è§„åˆ™ï¼ˆIRuleçš„å®ç°ç±»ï¼‰ï¼Œé€šè¿‡è§„åˆ™æ¥é€‰æ‹©å®ä¾‹ã€‚\nIRuleçš„å®ç°ä¸æ˜¯å¾ˆå¤šï¼Œ\nå…¶ä¸­çš„ClientConfigEnabledRoundRobinRuleåœ¨RoundRobinRuleçš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†é…ç½®çš„æ¥å£ï¼ˆå› ä¸ºå…¶å®ç°äº†IClientConfigAwareæ¥å£ï¼‰å¯ä»¥å¯¹è§„åˆ™è¿›è¡Œé…ç½®ã€‚\næŸäº›ClientConfigEnabledRoundRobinRuleçš„å­ç±»äº†ï¼Œå¢åŠ äº†Predicateé€»è¾‘ï¼šä½¿ç”¨Predicateï¼ˆAbstractServerPredicateçš„å­ç±»ï¼‰çš„é€»è¾‘è¿›è¡Œé€‰æ‹©ï¼›è€ŒClientConfigEnabledRoundRobinRuleåªæ˜¯ç®€å•çš„ä½¿ç”¨RoundRobinRuleè¿›è¡Œé€‰æ‹©ã€‚\nå› æ­¤é€‰æ‹©çš„é€»è¾‘éƒ½æ˜¯åœ¨AbstractServerPredicateå­ç±»ä¸­ï¼Œå…¶æœ‰ä¸ªç‰¹åˆ«çš„å­ç±»CompositePredicateï¼Œé¡¾åæ€ä¹‰å°±æ˜¯å°†å¤šä¸ªé€»è¾‘æ•´åˆåœ¨ä¸€èµ·ï¼ˆä½¿ç”¨Predicate#and()å°†æ‰€æœ‰é€»è¾‘ä¸²è”èµ·æ¥ï¼Œè¾¾åˆ°\u0026amp;\u0026amp;çš„æ•ˆæœï¼‰ï¼Œæ‰€æœ‰çš„é€»è¾‘æ£€æŸ¥éƒ½é€šè¿‡ï¼ˆè¿”å›trueï¼‰æ—¶ï¼Œè¿™ä¸ªå®ä¾‹å°±ä¼šè¢«é€‰ä¸­ã€‚\né‚£ä¹ˆç°åœ¨è¦ä½ å†™ä¸ªè‡ªå·±è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œåº”è¯¥çŸ¥é“ä»å“ªé‡Œå…¥æ‰‹äº†å§ï¼Ÿ:D\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/how-loadbalancer-works-in-ribbon/","tags":["Spring","Java"],"title":"å¸¦ä½ äº†è§£ Ribbon è´Ÿè½½å‡è¡¡å™¨çš„å®ç°"},{"categories":["ç¬”è®°"],"contents":"\nè¿™æ˜¯çœŸå®å‘ç”Ÿåœ¨ç”Ÿäº§ç¯å¢ƒçš„ caseï¼Œå®ä¾‹å¯åŠ¨åæ­£å¸¸è¿è¡Œï¼Œè€Œåœ¨æ³¨å†Œä¸­å¿ƒçš„çŠ¶æ€ä¸€ç›´ä¿æŒSTARTINGï¼Œè€Œæœ¬åœ°çš„çŠ¶æ€ä¸ºUPã€‚å¯¼è‡´æœåŠ¡çš„æ¶ˆè´¹æ–¹æ— æ³•å‘ç°å¯ç”¨å®ä¾‹ã€‚\nè¿™ç§æƒ…å†µçš„å‡ºç°æ¦‚ç‡éå¸¸ä½ï¼Œè¿è¡Œä¸€å¹´å¤šæœªå‘ç°ä¸¤ä¸ªå®ä¾‹åŒæ—¶å‡ºç°é—®é¢˜çš„æƒ…å†µï¼Œå› æ­¤å¤šå®ä¾‹è¿è¡Œå¯ä»¥é¿å…ã€‚æ–‡æœ«æœ‰é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œä¸æƒ³èŠ±æ—¶é—´çœ‹åˆ†æè¿‡ç¨‹å¯ç›´æ¥è·³åˆ°æœ€åã€‚\nç¯å¢ƒè¯´æ˜ï¼š\neureka-client: 1.7.2 spring-boot: 1.5.12.RELEASE spring-cloud: Edgware.SR3\né—®é¢˜é‡ç° å€ŸåŠ©Btraceé‡ç°, java -noverify -cp .:btrace-boot.jar -javaagent:btrace-agent.jar=script=\u0026lt;pre-compiled-btrace-script\u0026gt; \u0026lt;MainClass\u0026gt; \u0026lt;AppArguments\u0026gt;\næ€è·¯ ä¸»çº¿ç¨‹æ›´æ–°å®ä¾‹æœ¬åœ°çŠ¶æ€(STARTING-\u0026gt;UP)å‰, ç­‰å¾…å¿ƒè·³çº¿ç¨‹å®Œæˆç¬¬ä¸€æ¬¡å¿ƒè·³å¹¶å°è¯•æ³¨å†Œå®ä¾‹, è·å–åˆ°å½“å‰çš„çŠ¶æ€STARTING. ä¸»çº¿ç¨‹æ›´æ–°çŠ¶æ€åè§¦å‘\nBtrace è„šæœ¬\nimport com.sun.btrace.annotations.BTrace; import com.sun.btrace.annotations.Kind; import com.sun.btrace.annotations.Location; import com.sun.btrace.annotations.OnMethod; import java.util.concurrent.atomic.AtomicBoolean; import static com.sun.btrace.BTraceUtils.currentThread; import static com.sun.btrace.BTraceUtils.println; /** * @author Addo.Zhang * @date 2019-07-31 */ @BTrace(unsafe = true) public class EurekaRequest { public static final AtomicBoolean heartbeatThreadRegistrationStarted = new AtomicBoolean(false); public static final AtomicBoolean replicatorThreadRegistrationCompleted = new AtomicBoolean(false); public static final AtomicBoolean statusUP = new AtomicBoolean(false); @OnMethod(clazz = \u0026#34;org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistry\u0026#34;, location = @Location(value = Kind.LINE, line = 45)) public static void waitHeartbeatExecution() { println(currentThread() + \u0026#34; is waiting heartbeatThreadRegistrationStarted thread executing first\u0026#34;); while (!heartbeatThreadRegistrationStarted.get()) ; } @OnMethod(clazz = \u0026#34;org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistry\u0026#34;, location = @Location(value = Kind.LINE, line = 46)) public static void markStatusUp() { statusUP.set(true); println(\u0026#34;Heartbeat thread executed and \u0026#34; + currentThread() + \u0026#34; continues procedure to change status to [UP]\u0026#34;); } @OnMethod(clazz = \u0026#34;com.netflix.discovery.converters.EurekaJacksonCodec$InstanceInfoSerializer\u0026#34;, location = @Location(value = Kind.LINE, line = 369)) public static void continueRegistrationExecution() { doExecution(); } @OnMethod(clazz = \u0026#34;com.logancloud.forge.discovery.converters.LoganEurekaJacksonCodec$LoganInstanceInfoSerializer\u0026#34;, location = @Location(value = Kind.LINE, line = 117)) public static void continueRegistrationExecution2() { doExecution(); } private static void doExecution() { println(currentThread() + \u0026#34; started to proceed registration\u0026#34;); if (Thread.currentThread().getName().contains(\u0026#34;HeartbeatExecutor\u0026#34;)) { heartbeatThreadRegistrationStarted.set(true); while (!statusUP.get() || !replicatorThreadRegistrationCompleted.get()) { } try { Thread.sleep(500); //interval for replicator registration request completed. } catch (InterruptedException e) { Thread.currentThread().interrupt(); } } else if (Thread.currentThread().getName().contains(\u0026#34;InstanceInfoReplicator\u0026#34;)) { replicatorThreadRegistrationCompleted.set(true); } println(currentThread() + \u0026#34; thread registration completed\u0026#34;); } } å¿ƒè·³çº¿ç¨‹HeartbeatThreadå‘é€å¿ƒè·³è¯·æ±‚(PUT), æ³¨å†Œä¸­å¿ƒè¿”å›404. å®ä¾‹ä¿¡æ¯åŒæ­¥çº¿ç¨‹InstanceInfoReplicatorå‘é€æ³¨å†Œè¯·æ±‚(POST): çŠ¶æ€ä¸ºUP, lastDirtyTimestampä¸ºa å¿ƒè·³çº¿ç¨‹å‘é€å®ä¾‹æ³¨å†Œè¯·æ±‚(POST): çŠ¶æ€ä¸ºSTARTING, lastDirtyTimestampä¸ºa æœåŠ¡æ³¨å†Œ å…ˆåˆ†ææœåŠ¡å®ä¾‹çš„æ³¨å†Œé€»è¾‘.\nInstanceInfoåˆå§‹åŒ– é€šè¿‡InstanceInfoFactory#create()æ–¹æ³•æ¥åˆå§‹åŒ–ApplicationInfoManager.instanceInfoå®ä¾‹æ—¶, å®ä¾‹çŠ¶æ€è¢«è®¾ç½®ä¸ºSTARTING\næœåŠ¡å®ä¾‹æ³¨å†Œ æœåŠ¡å®ä¾‹æ³¨å†Œçš„çœŸæ­£é€»è¾‘æ˜¯åœ¨DiscoveryClient#register()ä¸­å®Œæˆçš„. ä½†æ˜¯è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨å´æœ‰ä¸¤ä¸ªå…¥å£, åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­å¯è§£é‡Šä¸ºä¸»åŠ¨æ³¨å†Œå’Œè¢«åŠ¨æ³¨å†Œ.\nä¸€. ä¸»åŠ¨æ³¨å†Œ EurekaAutoServiceRegistrationå®ç°äº†SmartLifecycleæ¥å£, åœ¨EurekaClientAutoConfiguration#eurekaAutoServiceRegistration()è¢«å®ä¾‹åŒ–.\nEurekaAutoServiceRegistration#start()æ–¹æ³•å°†EurekaRegistrationæ³¨å†Œç»™EurekaServiceRegistry:\npublic void start() { ... if (!this.running.get() \u0026amp;\u0026amp; this.registration.getNonSecurePort() \u0026gt; 0) { //è°ƒç”¨EurekaServiceRegistryè¿›è¡Œæ³¨å†Œ this.serviceRegistry.register(this.registration); //å‘å¸ƒå®ä¾‹æ³¨å†Œçš„äº‹ä»¶ this.context.publishEvent( new InstanceRegisteredEvent\u0026lt;\u0026gt;(this, this.registration.getInstanceConfig())); this.running.set(true); } } EurekaServiceRegistry#register(): å…ˆå°†å®ä¾‹çŠ¶æ€è®¾ç½®ä¸ºåˆå§‹çŠ¶æ€UP(å¯é€šè¿‡eureka.instance.initial-statusä¿®æ”¹, é»˜è®¤ä¸ºUP). è¿™é‡Œä¼šè§¦å‘StatusChangeListener#notify().\npublic void register(EurekaRegistration reg) { maybeInitializeClient(reg); if (log.isInfoEnabled()) { log.info(\u0026#34;Registering application \u0026#34; + reg.getInstanceConfig().getAppname() + \u0026#34; with eureka with status \u0026#34; + reg.getInstanceConfig().getInitialStatus()); } //1 reg.getApplicationInfoManager() .setInstanceStatus(reg.getInstanceConfig().getInitialStatus()); if (reg.getHealthCheckHandler() != null) { //2 reg.getEurekaClient().registerHealthCheck(reg.getHealthCheckHandler()); } } DiscoveryClientå†…éƒ¨åŒ¿åç±»æä¾›äº†StatusChangeListenerçš„å®ç°, è°ƒç”¨InstanceInfoReplicator#onDemandUpdate()\nstatusChangeListener = new ApplicationInfoManager.StatusChangeListener() { @Override public String getId() { return \u0026#34;statusChangeListener\u0026#34;; } @Override public void notify(StatusChangeEvent statusChangeEvent) { if (InstanceStatus.DOWN == statusChangeEvent.getStatus() || InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) { // log at warn level if DOWN was involved logger.warn(\u0026#34;Saw local status change event {}\u0026#34;, statusChangeEvent); } else { logger.info(\u0026#34;Saw local status change event {}\u0026#34;, statusChangeEvent); } instanceInfoReplicator.onDemandUpdate(); } }; InstanceInfoReplicatoræ˜¯åœ¨DiscoveryClient#initScheduledTasks()ä¸­å®ä¾‹åŒ–çš„Runnableçš„å®ç°, å®ä¾‹åŒ–ä¹‹å, ä½¿ç”¨å…¶å†…éƒ¨çš„è°ƒåº¦çº¿ç¨‹æ± è°ƒåº¦ä¸€ä¸ªçº¿ç¨‹. è€ŒonDemandUpdate()ä¹ŸåŒæ ·ä¼šä½¿ç”¨è°ƒåº¦çº¿ç¨‹æ± è°ƒåº¦ä¸€ä¸ªçº¿ç¨‹.\nå…¶#run()æ–¹æ³•ä¼šè°ƒç”¨DiscoveryClient#refreshInstanceInfo()æ¥æ›´æ–°çŠ¶æ€. çŠ¶æ€çš„æ›´æ–°æ˜¯é€šè¿‡HealthCheckHandleræ¥å®ç°çš„, å…·ä½“è¯·çœ‹çŠ¶æ€æ£€æŸ¥. ç„¶åè°ƒç”¨DiscoveryClient#register()æ–¹æ³•è¿›è¡Œæ³¨å†Œ.\näºŒ. è¢«åŠ¨æ³¨å†Œ ä¸Šé¢æåˆ°äº†DiscoveryClient#initScheduledTasks(), è¿™é‡Œçš„taské™¤äº†InstanceInfoReplicatorä¹‹å¤–è¿˜æœ‰å…¶ä»–çš„çº¿ç¨‹. å…¶ä¸­ä¸€ä¸ªæ˜¯çº¿æ¡çº¿ç¨‹HeartbeatThread. è¿™ä¸ªçº¿ç¨‹ä¼šæ¯éš”ä¸€æ®µæ—¶é—´å‘æ³¨å†Œä¸­å¿ƒå‘é€ä¸€ä¸ªPUTç±»å‹çš„HTTPè¯·æ±‚: ä¸ŠæŠ¥å®ä¾‹çš„çŠ¶æ€(çŠ¶æ€(status), ä»¥åŠçŠ¶æ€ä¿®æ”¹çš„æ—¶é—´(lastDirtyTimestamp)).\nè¿™ä¸ªè¯·æ±‚å¯èƒ½ä¼šæœ‰ä¸¤ç§ç»“æœ: 404å’Œ200. å‰è€…è¯´æ˜æ³¨å†Œä¸­å¿ƒä¸­è¿˜æ²¡æœ‰è¿™ä¸ªå®ä¾‹çš„æ³¨å†Œä¿¡æ¯; åè€…è¯´æ˜çŠ¶æ€ä¸ŠæŠ¥æˆåŠŸ.\nå‡å¦‚æ˜¯404, ä¾¿ç›´æ¥å‘èµ·æ³¨å†Œçš„åŠ¨ä½œ, å³è°ƒç”¨DiscoveryClient#register()æ–¹æ³•è¿›è¡Œæ³¨å†Œ.\nçŠ¶æ€æ£€æŸ¥ CloudEurekaClienté€šè¿‡HealthCheckHandleræ¥æ£€æŸ¥å®ä¾‹çš„å¥åº·çŠ¶æ€, çœ‹ä¸‹HealthCheckCallbackToHandlerBridgeå®ç°: callbackä¸ºç©º, æˆ–è€…å½“å‰çŠ¶æ€ä¸ºSTARTINGæˆ–è€…OUT_OF_SERVICEæ—¶, è¿”å›å½“å‰çš„çŠ¶æ€. æˆ‘ä»¬æ²¡æœ‰è®¾ç½®callback, æ•…è€Œæ€»æ˜¯ä¼šè¿”å›å½“å‰çš„çŠ¶æ€. æ¯”å¦‚åº”ç”¨å¯åŠ¨çš„åˆå§‹çŠ¶æ€ä¸ºSTARTING\npublic InstanceInfo.InstanceStatus getStatus(InstanceInfo.InstanceStatus currentStatus) { if (null == callback || InstanceInfo.InstanceStatus.STARTING == currentStatus || InstanceInfo.InstanceStatus.OUT_OF_SERVICE == currentStatus) { // Do not go to healthcheck handler if the status is starting or OOS. return currentStatus; } return callback.isHealthy() ? InstanceInfo.InstanceStatus.UP : InstanceInfo.InstanceStatus.DOWN; } é—®é¢˜åˆ†æ ç°è±¡ TCPæŠ“åŒ… HeartBeatè¯·æ±‚å’ŒFetchè¯·æ±‚æ­£å¸¸. status=UP\u0026amp;lastDirtyTimestamp=1545039481813\nå †ä¿¡æ¯ æœ¬åœ°çŠ¶æ€ä¸ºUP, lastDirtyTimestampä¸º1545039481813, lastUpdatedTimestampä¸º1545039472888\næ³¨å†Œä¸­å¿ƒé‡Œçš„å®ä¾‹ä¿¡æ¯ çŠ¶æ€ä¸ºSTARTING, lastDirtyTimestampä¸º1545039481813, registrationTimestampä¸º1545039481898, lastUpdatedTimestampä¸º1545039481899\n\u0026lt;instance\u0026gt; \u0026lt;instanceId\u0026gt;xp-xtower-webapp-boot-6-txcxb:xp-xtower-webapp-boot:10100\u0026lt;/instanceId\u0026gt; \u0026lt;hostName\u0026gt;10.128.41.74\u0026lt;/hostName\u0026gt; \u0026lt;app\u0026gt;XP-XTOWER-WEBAPP-BOOT\u0026lt;/app\u0026gt; \u0026lt;ipAddr\u0026gt;10.128.41.74\u0026lt;/ipAddr\u0026gt; \u0026lt;status\u0026gt;STARTING\u0026lt;/status\u0026gt; \u0026lt;overriddenstatus\u0026gt;UNKNOWN\u0026lt;/overriddenstatus\u0026gt; \u0026lt;port enabled=\u0026#34;true\u0026#34;\u0026gt;10100\u0026lt;/port\u0026gt; \u0026lt;securePort enabled=\u0026#34;false\u0026#34;\u0026gt;443\u0026lt;/securePort\u0026gt; \u0026lt;countryId\u0026gt;1\u0026lt;/countryId\u0026gt; \u0026lt;dataCenterInfo class=\u0026#34;com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo\u0026#34;\u0026gt; \u0026lt;name\u0026gt;MyOwn\u0026lt;/name\u0026gt; \u0026lt;/dataCenterInfo\u0026gt; \u0026lt;leaseInfo\u0026gt; \u0026lt;renewalIntervalInSecs\u0026gt;5\u0026lt;/renewalIntervalInSecs\u0026gt; \u0026lt;durationInSecs\u0026gt;20\u0026lt;/durationInSecs\u0026gt; \u0026lt;registrationTimestamp\u0026gt;1545039481898\u0026lt;/registrationTimestamp\u0026gt; \u0026lt;lastRenewalTimestamp\u0026gt;1545950719063\u0026lt;/lastRenewalTimestamp\u0026gt; \u0026lt;evictionTimestamp\u0026gt;0\u0026lt;/evictionTimestamp\u0026gt; \u0026lt;serviceUpTimestamp\u0026gt;0\u0026lt;/serviceUpTimestamp\u0026gt; \u0026lt;/leaseInfo\u0026gt; \u0026lt;metadata\u0026gt; \u0026lt;forge\u0026gt;1.0.0\u0026lt;/forge\u0026gt; \u0026lt;management.port\u0026gt;10100\u0026lt;/management.port\u0026gt; \u0026lt;jmx.port\u0026gt;1099\u0026lt;/jmx.port\u0026gt; \u0026lt;group\u0026gt;innovation\u0026lt;/group\u0026gt; \u0026lt;/metadata\u0026gt; \u0026lt;homePageUrl\u0026gt;http://10.128.41.74:10100/\u0026lt;/homePageUrl\u0026gt; \u0026lt;statusPageUrl\u0026gt;\u0026lt;/statusPageUrl\u0026gt; \u0026lt;healthCheckUrl\u0026gt;http://10.128.41.74:10100/health\u0026lt;/healthCheckUrl\u0026gt; \u0026lt;vipAddress\u0026gt;xp-xtower-webapp-boot\u0026lt;/vipAddress\u0026gt; \u0026lt;secureVipAddress\u0026gt;xp-xtower-webapp-boot\u0026lt;/secureVipAddress\u0026gt; \u0026lt;isCoordinatingDiscoveryServer\u0026gt;false\u0026lt;/isCoordinatingDiscoveryServer\u0026gt; \u0026lt;lastUpdatedTimestamp\u0026gt;1545039481899\u0026lt;/lastUpdatedTimestamp\u0026gt; \u0026lt;lastDirtyTimestamp\u0026gt;1545039481813\u0026lt;/lastDirtyTimestamp\u0026gt; \u0026lt;actionType\u0026gt;ADDED\u0026lt;/actionType\u0026gt; \u0026lt;/instance\u0026gt; Scope Status lastDirtyTimestamp lastUpdatedTimestamp registrationTimestamp Request UP 1545039481813 Local UP 1545039481813 1545039472888 Remote STARTING 1545039481813 1545039481899 1545039481898 ç»“åˆèµ·æ¥çœ‹, é—®é¢˜å‡ºåœ¨lastDirtyTimestampæœªæ›´æ–°, å¯¼è‡´æ³¨å†Œä¸­å¿ƒçš„çŠ¶æ€æœªæ›´æ–°. è€ŒlastUpdatedTimestampçš„æ—¶é—´ä¸º1545039481899, ä¸lastDirtyTimestampç›¸å·®86æ¯«ç§’.\næœåŠ¡ç«¯InstanceResource#validateDirtyTimestamp()æ ¹æ®æœ¬åœ°ä¿å­˜çš„å®ä¾‹çš„ä¿¡æ¯, å’Œå¿ƒè·³è¯·æ±‚å‘é€è¿‡æ¥çš„è¯·æ±‚åšæ¯”è¾ƒ, å†³å®šå“åº”çš„çŠ¶æ€ç 200, 404æˆ–è€…409\næ¨ç† æ³¨å†Œä¸­å¿ƒé‡Œå®ä¾‹çš„çŠ¶æ€ä¸ºSTARTING, å¯ä»¥ç¡®å®šå®ä¾‹æ˜¯[è¢«åŠ¨æ³¨å†Œ](#äºŒ. è¢«åŠ¨æ³¨å†Œ)çš„.\nè¿™é‡Œæœ‰å‡ ä¸ªæ—¶é—´ç‚¹:\n1545039472888: InstanceInfoå¯¹è±¡å®ä¾‹åŒ–çš„æ—¶é—´, å› ä¸ºæœ¬åœ°å¯¹è±¡çš„#lastUpdatedTimestampå­—æ®µåªæœ‰åœ¨å®ä¾‹åŒ–æ‰ä¼šèµ‹å€¼, æ­¤åä¸ä¼šè¢«ä¿®æ”¹. è§å †ä¿¡æ¯ 1545039481813: çŠ¶æ€ä»STARTINGå˜ä¸ºUPçš„æ—¶é—´, ä¹Ÿæ˜¯å®ä¾‹çŠ¶æ€çš„æœ€åä¸€æ¬¡æ›´æ–°æ—¶é—´. æ­¤åçš„å¿ƒè·³è¯·æ±‚éƒ½ä¼šå¸¦ä¸Šå®ä¾‹çš„æœ€æ–°çŠ¶æ€(UP)å’ŒçŠ¶æ€çš„æœ€åä¸€æ¬¡æ›´æ–°æ—¶é—´(1545039481813), è§TCPæŠ“åŒ…. 1545039481898: æ³¨å†Œä¸­å¿ƒæ”¶åˆ°å®ä¾‹çš„æ³¨å†Œè¯·æ±‚çš„æ—¶é—´. è§æ³¨å†Œä¸­å¿ƒé‡Œçš„å®ä¾‹ä¿¡æ¯ 1545039481899: æ³¨å†Œä¸­å¿ƒä¸­çš„å®ä¾‹ä¿¡æ¯è¢«æ›´æ–°çš„æ—¶é—´. è¿™ä¸ªæ—¶é—´åªæ¯”æ³¨å†Œçš„æ—¶é—´æ™šäº†1æ¯«ç§’. è§æ³¨å†Œä¸­å¿ƒé‡Œçš„å®ä¾‹ä¿¡æ¯ ç»¼ä¸Šå¯è§, è¢«åŠ¨æ³¨å†Œæ—¶å‘é€è¯·æ±‚, æ‹¿åˆ°çš„å®ä¾‹çš„æ—§çš„çŠ¶æ€STARTING, ä¿®æ”¹æ—¶é—´ç¡®å®æœ€æ–°çš„1545039481813. åç»­çš„å¿ƒè·³ä¸ŠæŠ¥å®ä¾‹çŠ¶æ€ä¸ºæœ€æ–°çš„UP, ä¿®æ”¹æ—¶é—´ä¹Ÿæ˜¯æœ€æ–°çš„1545039481813. ä½†æ˜¯ç”±äºæœ€åä¿®æ”¹æ—¶é—´ä¸æ³¨å†Œæ—¶çš„æœ€åä¿®æ”¹æ—¶é—´ç›¸åŒ, å³ä½¿çŠ¶æ€å·²ç»å˜ä¸ºUP, æ³¨å†Œä¸­å¿ƒåœ¨æ”¶åˆ°å¿ƒè·³è¯·æ±‚ä¹‹åä¹Ÿä¸ä¼šå°†çŠ¶æ€æ›´æ–°ä¸ºUP.\næœåŠ¡ç«¯InstanceResource#renewLease() -\u0026gt; InstanceResource#validateDirtyTimestamp(): å¦‚æœè¯·æ±‚ä¸­çš„lastDirtyTimestampä¸å½“å‰ä¿å­˜çš„å®ä¾‹çš„ç›¸åŒ, åˆ™ç›´æ¥è¿”å›OK, ä¸ä¼šæ›´æ–°æ³¨å†Œä¸­å¿ƒä¸­ä¿å­˜çš„å®ä¾‹çš„çŠ¶æ€.\nprivate Response validateDirtyTimestamp(Long lastDirtyTimestamp, boolean isReplication) { InstanceInfo appInfo = registry.getInstanceByAppAndId(app.getName(), id, false); if (appInfo != null) { if ((lastDirtyTimestamp != null) \u0026amp;\u0026amp; (!lastDirtyTimestamp.equals(appInfo.getLastDirtyTimestamp()))) { Object[] args = {id, appInfo.getLastDirtyTimestamp(), lastDirtyTimestamp, isReplication}; if (lastDirtyTimestamp \u0026gt; appInfo.getLastDirtyTimestamp()) { logger.debug( \u0026#34;Time to sync, since the last dirty timestamp differs -\u0026#34; + \u0026#34; ReplicationInstance id : {},Registry : {} Incoming: {} Replication: {}\u0026#34;, args); return Response.status(Status.NOT_FOUND).build(); } else if (appInfo.getLastDirtyTimestamp() \u0026gt; lastDirtyTimestamp) { // In the case of replication, send the current instance info in the registry for the // replicating node to sync itself with this one. if (isReplication) { logger.debug( \u0026#34;Time to sync, since the last dirty timestamp differs -\u0026#34; + \u0026#34; ReplicationInstance id : {},Registry : {} Incoming: {} Replication: {}\u0026#34;, args); return Response.status(Status.CONFLICT).entity(appInfo).build(); } else { return Response.ok().build(); } } } } return Response.ok().build(); } ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µ? åº”ç”¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹ä¼šè§¦å‘æ³¨å†Œçš„åŠ¨ä½œ\nInstanceInfoReplicatorçº¿ç¨‹: DiscoveryClientä¸­çš„ApplicationInfoManager.StatusChangeListenerç›‘å¬åˆ°å®ä¾‹çŠ¶æ€å‘ç”Ÿå˜åŒ–, ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹å°†å®ä¾‹æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ DiscoveryClient$HeartbeatThreadçº¿ç¨‹: è¿™ä¸ªçº¿ç¨‹åœ¨DiscoveryClientå®ä¾‹åˆå§‹åŒ–åå»¶è¿Ÿ(ä¸å¿ƒè·³é—´éš”æ—¶é—´ç›¸åŒ, é»˜è®¤æ˜¯30s, ä¸­å°ä¸ºæé«˜å®ä¾‹å‘ç°æ•ˆç‡å°†å…¶æ”¹ä¸ºäº†5s)å¯åŠ¨è¿è¡Œ. ç¬¬ä¸€æ¬¡å‘é€å¿ƒè·³è¯·æ±‚æ˜¯å¦‚æœæ³¨å†Œä¸­å¿ƒè¿”å›404(è¯´æ˜å¿ƒè·³çº¿ç¨‹æå®ä¾‹çŠ¶æ€æ›´æ–°çº¿ç¨‹å…ˆå¯åŠ¨), åˆ™ä¼šå…ˆå°†å®ä¾‹æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ. ä¸Šé¢ä¸¤ä¸ªçº¿ç¨‹éƒ½é€šè¿‡è°ƒç”¨AbstractJerseyEurekaHttpClient$register()æ–¹æ³•å¹¶ä½¿ç”¨EurekaJacksonCodec$InstanceInfoSerializerå°†å®ä¾‹ä¿¡æ¯åºåˆ—åŒ–. åºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­å…ˆè®°å½•å®ä¾‹çš„çŠ¶æ€åè®°å½•å®ä¾‹çŠ¶æ€çš„æœ€åä¿®æ”¹æ—¶é—´(lastDirtyTimestamp), è¿™ä¸¤ä¸ªæ“ä½œä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œ.\néå¸¸æç«¯çš„æƒ…å†µä¸‹(ç¼©å°å¿ƒè·³é—´éš”å¢åŠ äº†å‡ºç°çš„æ¦‚ç‡, ä½†ä¾ç„¶æåœ°), ä¸¤ä¸ªæ“ä½œä¹‹é—´(å¿ƒè·³çº¿ç¨‹å…ˆæ‹¿åˆ°å®ä¾‹çŠ¶æ€STARTING)ä¸»çº¿ç¨‹ä¿®æ”¹äº†å®ä¾‹çŠ¶æ€ä¸ºUP, åŒæ—¶ä¿®æ”¹äº†lastDirtyTimestamp, å¹¶è§¦å‘äº†InstanceInfoReplicatorçº¿ç¨‹çš„æ³¨å†Œæ“ä½œ, æ­¤æ—¶å¿ƒè·³çº¿ç¨‹è·å–åˆ°çš„å®ä¾‹çš„æœ€åä¿®æ”¹æ—¶é—´ä¸STARTINGçŠ¶æ€å¹¶ä¸ä¸€è‡´. ä¹‹ååŒæ ·æ³¨å†ŒåŠ¨ä½œè¦†ç›–äº†å®ä¾‹åœ¨æ³¨å†Œä¸­å¿ƒçš„çŠ¶æ€: UP -\u0026gt; STARTING.\nåç»­çš„å¿ƒè·³è¯·æ±‚å¸¦å»çš„æœ€æ–°çŠ¶æ€UPå’ŒlastDirtyTimestamp, å¹¶ä¸ä¼šæ›´æ–°åœ¨æ³¨å†Œä¸­å¿ƒçš„çŠ¶æ€.\nè§£å†³æ–¹æ¡ˆ åœ¨EurekaJacksonCodec$InstanceInfoSerializer#serialize()æ–¹æ³•ä¸­, å°†#autoMarshalEligible() çš„è°ƒç”¨ç§»åˆ°jgen.writeStartObject()åé¢. è¿™æ ·å°±ä½¿å¾—lastDirtyTimestampçš„è·å–æ¯”statusæ—©, å°±èƒ½ä¿è¯å³ä½¿æ³¨å†Œæ—¶çš„lastDirtyTimestampå°äºçœŸæ­£çš„, ä½†æ˜¯çŠ¶æ€æ˜¯ä¸å®é™…ç›¸ç¬¦. lastDirtyTimestampä¼šåœ¨åç»­çš„å¿ƒè·³è¯·æ±‚ä¸­æ›´æ–°. addInstance-info.getStatus(): UP addInstance-info.getLastDirtyTimestamp(): 1565164484429 addInstance-info.getStatus(): STARTING addInstance-info.getLastDirtyTimestamp(): 1565164484415 renew-status-in-registry: UP renew-lastDirtyTimestamp: 1565164484429 renew-appInfo.getLastDirtyTimestamp(): 1565164484429 PR å·²ç»æäº¤å¹¶åˆå¹¶å®Œæˆï¼Œç„¶è€Œ 1.7.x çš„ç‰ˆæœ¬ä¸çŸ¥ä½•æ—¶ä¼šå‘å¸ƒä¿®å¤ç‰ˆæœ¬\nå‚è€ƒ:\nGitHub issue PR ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/troubleshooting-on-eureka-instance-keep-starting/","tags":["Spring","Troubleshooting"],"title":"Eureka å®ä¾‹æ³¨å†ŒçŠ¶æ€ä¿æŒ STARTING çš„é—®é¢˜æ’æŸ¥"},{"categories":["ç¬”è®°"],"contents":"\nè¿™ç¯‡æ–‡ç« æ˜¯åŸºäº Tekton Pipeline çš„æœ€æ–°ç‰ˆæœ¬v0.12.1ç‰ˆæœ¬ã€‚\nå¿«é€Ÿå…¥é—¨è¯·å‚è€ƒï¼šäº‘åŸç”Ÿ CICD: Tekton Pipeline å®æˆ˜ ï¼Œå®æˆ˜æ˜¯åŸºäºç‰ˆæœ¬ v0.10.xã€‚\nPipeline CRD ä¸æ ¸å¿ƒèµ„æºçš„å…³ç³» $ k api-resources --api-group=tekton.dev NAME SHORTNAMES APIGROUP NAMESPACED KIND clustertasks tekton.dev false ClusterTask conditions tekton.dev true Condition pipelineresources tekton.dev true PipelineResource pipelineruns pr,prs tekton.dev true PipelineRun pipelines tekton.dev true Pipeline taskruns tr,trs tekton.dev true TaskRun tasks tekton.dev true Task Tekton Pipelinesæä¾›äº†ä¸Šé¢çš„CRDï¼Œå…¶ä¸­éƒ¨åˆ†CRDä¸k8s coreä¸­èµ„æºç›¸å¯¹åº”\nTask =\u0026gt; Pod Task.Step =\u0026gt; Container å·¥ä½œåŸç† (å›¾ç‰‡æ¥è‡ª)\nTekton Pipeline æ˜¯åŸºäº Knative çš„å®ç°ï¼Œpod tekton-pipelines-controller ä¸­æœ‰ä¸¤ä¸ª Knative Controllerçš„å®ç°ï¼šPipelineRun å’Œ TaskRunã€‚\nTaskçš„æ‰§è¡Œé¡ºåº PipelineRun Controller çš„ #reconcile()æ–¹æ³•ï¼Œç›‘æ§åˆ°æœ‰PipelineRunè¢«åˆ›å»ºã€‚ç„¶åä»PipelineSpecçš„ tasks åˆ—è¡¨ï¼Œæ„å»ºå‡ºä¸€ä¸ªå›¾ï¼ˆgraphï¼‰ï¼Œç”¨äºæè¿°Pipelineä¸­ Task é—´çš„ä¾èµ–å…³ç³»ã€‚ä¾èµ–å…³ç³»æ˜¯é€šè¿‡runAfterå’Œfromï¼Œè¿›è€Œæ§åˆ¶Taskçš„æ‰§è¡Œé¡ºåºã€‚ä¸æ­¤åŒæ—¶ï¼Œå‡†å¤‡PipelineRunä¸­å®šä¹‰çš„PipelineResourcesã€‚\n// Node represents a Task in a pipeline. type Node struct { // Task represent the PipelineTask in Pipeline Task Task // Prev represent all the Previous task Nodes for the current Task Prev []*Node // Next represent all the Next task Nodes for the current Task Next []*Node } // Graph represents the Pipeline Graph type Graph struct { //Nodes represent map of PipelineTask name to Node in Pipeline Graph Nodes map[string]*Node } func Build(tasks Tasks) (*Graph, error) { ... } PipelineRunä¸­å®šä¹‰çš„å‚æ•°ï¼ˆparametersï¼‰ä¹Ÿä¼šæ³¨å…¥åˆ°PipelineSpecä¸­ï¼š\npipelineSpec = resources.ApplyParameters(pipelineSpec, pr) æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨dag#GetSchedulable()æ–¹æ³•ï¼Œè·å–æœªå®Œæˆï¼ˆé€šè¿‡TaskçŠ¶æ€åˆ¤æ–­ï¼‰çš„ Task åˆ—è¡¨ï¼›\nfunc GetSchedulable(g *Graph, doneTasks ...string) (map[string]struct{}, error) { ... } ä¸º Task A åˆ›å»ºTaskRunï¼Œå‡å¦‚Taské…ç½®äº†Conditionã€‚ä¼šå…ˆä¸º conditionåˆ›å»ºä¸€ä¸ªTaskRunï¼Œåªæœ‰åœ¨ condition çš„TaskRunè¿è¡ŒæˆåŠŸï¼Œæ‰ä¼šè¿è¡Œ A çš„TaskRunï¼›å¦åˆ™å°±è·³è¿‡ã€‚\nStepçš„æ‰§è¡Œé¡ºåº è¿™ä¸€éƒ¨åˆ†ç¯‡å¹…è¾ƒé•¿ï¼Œä¹‹å‰çš„æ–‡ç«  æ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº ä¸­æåˆ°è¿‡ã€‚\nè¿™é‡Œè¡¥å……ä¸€ä¸‹Kubernetes Downward APIçš„ä½¿ç”¨ï¼ŒKubernetes Downward APIçš„å¼•å…¥ï¼Œæ§åˆ¶ç€ Task çš„ç¬¬ä¸€ä¸ª Step åœ¨ä½•æ—¶æ‰§è¡Œã€‚\nTaskRun Controller åœ¨ reconciling çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨ç›¸åº”çš„ Pod çŠ¶æ€å˜ä¸ºRunningæ—¶ï¼Œä¼šå°†tekton.dev/ready=READYå†™å…¥åˆ° Pod çš„ annotation ä¸­ï¼Œæ¥é€šçŸ¥ç¬¬ä¸€ä¸ªStepçš„æ‰§è¡Œã€‚\nPodçš„éƒ¨åˆ†å†…å®¹ï¼š\nspec: containers: - args: - -wait_file - /tekton/downward/ready - -wait_file_content - -post_file - /tekton/tools/0 - -termination_path - /tekton/termination - -entrypoint - /ko-app/git-init - -- - -url - ssh://git@gitlab.nip.io:8022/addozhang/logan-pulse.git - -revision - develop - -path - /workspace/git-source command: - /tekton/tools/entrypoint volumeMounts: - mountPath: /tekton/downward name: tekton-internal-downward volumes: - downwardAPI: defaultMode: 420 items: - fieldRef: apiVersion: v1 fieldPath: metadata.annotations[\u0026#39;tekton.dev/ready\u0026#39;] path: ready name: tekton-internal-downward å¯¹åŸç”Ÿçš„æ’åºstep containerè¿›ä¸€æ­¥å¤„ç†ï¼šå¯åŠ¨å‘½ä»¤ä½¿ç”¨entrypointæä¾›ï¼Œå¹¶è®¾ç½®æ‰§è¡Œå‚æ•°ï¼š\nentrypoint.go\nfunc orderContainers(entrypointImage string, steps []corev1.Container, results []v1alpha1.TaskResult) (corev1.Container, []corev1.Container, error) { initContainer := corev1.Container{ Name: \u0026#34;place-tools\u0026#34;, Image: entrypointImage, Command: []string{\u0026#34;cp\u0026#34;, \u0026#34;/ko-app/entrypoint\u0026#34;, entrypointBinary}, VolumeMounts: []corev1.VolumeMount{toolsMount}, } if len(steps) == 0 { return corev1.Container{}, nil, errors.New(\u0026#34;No steps specified\u0026#34;) } for i, s := range steps { var argsForEntrypoint []string switch i { case 0: argsForEntrypoint = []string{ // First step waits for the Downward volume file. \u0026#34;-wait_file\u0026#34;, filepath.Join(downwardMountPoint, downwardMountReadyFile), \u0026#34;-wait_file_content\u0026#34;, // Wait for file contents, not just an empty file. // Start next step. \u0026#34;-post_file\u0026#34;, filepath.Join(mountPoint, fmt.Sprintf(\u0026#34;%d\u0026#34;, i)), \u0026#34;-termination_path\u0026#34;, terminationPath, } default: // All other steps wait for previous file, write next file. argsForEntrypoint = []string{ \u0026#34;-wait_file\u0026#34;, filepath.Join(mountPoint, fmt.Sprintf(\u0026#34;%d\u0026#34;, i-1)), \u0026#34;-post_file\u0026#34;, filepath.Join(mountPoint, fmt.Sprintf(\u0026#34;%d\u0026#34;, i)), \u0026#34;-termination_path\u0026#34;, terminationPath, } } ... } è‡ªåŠ¨è¿è¡Œçš„å®¹å™¨ è¿™äº›è‡ªåŠ¨è¿è¡Œçš„å®¹å™¨ä½œä¸º pod çš„initContainerä¼šåœ¨ step å®¹å™¨è¿è¡Œä¹‹å‰è¿è¡Œ\ncredential-initializer ç”¨äºå°† ServiceAccount çš„ç›¸å…³secretsæŒä¹…åŒ–åˆ°å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚æ¯”å¦‚ ssh ç›¸å…³ç§˜é’¥ã€configæ–‡ä»¶ä»¥åŠknow_hostsæ–‡ä»¶ï¼›docker registry ç›¸å…³çš„å‡­è¯åˆ™ä¼šè¢«å†™å…¥åˆ° docker çš„é…ç½®æ–‡ä»¶ä¸­ã€‚\nworking-dir-initializer æ”¶é›†Taskå†…çš„å„ä¸ªStepçš„workingDiré…ç½®ï¼Œåˆå§‹åŒ–ç›®å½•ç»“æ„\nplace-scripts å‡å¦‚Stepä½¿ç”¨çš„æ˜¯scripté…ç½®ï¼ˆä¸command+argsç›¸å¯¹ï¼‰ï¼Œè¿™ä¸ªå®¹å™¨ä¼šå°†è„šæœ¬ä»£ç ï¼ˆscriptå­—æ®µçš„å†…å®¹ï¼‰æŒä¹…åŒ–åˆ°/tekton/scriptsç›®å½•ä¸­ã€‚\næ³¨ï¼šæ‰€æœ‰çš„è„šæœ¬ä¼šè‡ªåŠ¨åŠ ä¸Š#!/bin/sh\\nset -xe\\nï¼Œæ‰€ä»¥scriptå­—æ®µé‡Œå°±ä¸å¿…å†™äº†ã€‚\nplace-tools å°†entrypointçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¤åˆ¶åˆ°/tekton/tools/entrypoint.\nTask/Stepé—´çš„æ•°æ®ä¼ é€’ é’ˆå¯¹ä¸åŒçš„æ•°æ®ï¼Œæœ‰å¤šç§ä¸åŒçš„é€‰æ‹©ã€‚æ¯”å¦‚Workspaceã€Resultã€PipelineResourceã€‚å¯¹äºç”±äºTaskçš„æ‰§è¡Œæ˜¯é€šè¿‡Podæ¥å®Œæˆçš„ï¼Œè€ŒPodä¼šè°ƒåº¦åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šã€‚å› æ­¤Taské—´çš„æ•°æ®ä¼ é€’ï¼Œéœ€è¦ç”¨åˆ°æŒä¹…åŒ–çš„å·ã€‚\nè€ŒStepä½œä¸ºPodä¸­çš„å®¹å™¨æ¥è¿è¡Œï¼Œ\nWorkspace å·¥ä½œåŒºï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæŒ‚åœ¨åˆ°å®¹å™¨ä¸Šçš„å·ï¼Œç”¨äºæ–‡ä»¶çš„ä¼ é€’ã€‚\npersistentVolumeClaim å¼•ç”¨å·²å­˜åœ¨persistentVolumeClaimå·ï¼ˆvolumeï¼‰ã€‚è¿™ç§å·¥ä½œç©ºé—´ï¼Œå¯å¤šæ¬¡ä½¿ç”¨ï¼Œéœ€è¦å…ˆè¿›è¡Œåˆ›å»ºã€‚æ¯”å¦‚ Java é¡¹ç›®çš„ mavenï¼Œç¼–è¯‘éœ€è¦æœ¬åœ°ä¾èµ–åº“ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœæ¯æ¬¡ç¼–è¯‘éƒ½è¦ä¸‹è½½ä¾èµ–åŒ…çš„æˆæœ¬ã€‚\nworkspaces: - name: m2 persistentVolumeClaim: claimName: m2-pv-claim apiVersion: v1 kind: PersistentVolume metadata: name: m2-pv labels: type: local spec: storageClassName: manual capacity: storage: 10Gi accessModes: - ReadWriteMany hostPath: path: \u0026#34;/data/.m2\u0026#34; --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: m2-pv-claim spec: storageClassName: manual # volumeName: m2-pv accessModes: - ReadWriteMany resources: requests: storage: 10Gi volumeClaimTemplate ä¸ºæ¯ä¸ªPipelineRunæˆ–è€…TaskRunåˆ›å»ºPersistentVolumeClaimå·ï¼ˆvolumeï¼‰çš„æ¨¡æ¿ã€‚æ¯”å¦‚ä¸€æ¬¡æ„å»ºéœ€è¦ä» git ä»“åº“å…‹éš†ä»£ç ï¼Œè€Œé’ˆå¯¹ä¸åŒçš„æµæ°´çº¿ä»£ç ä»“åº“æ˜¯ä¸åŒçš„ã€‚è¿™é‡Œå°±ä¼šç”¨åˆ°volumeClaimTemplateï¼Œä¸ºæ¯æ¬¡æ„å»ºåˆ›å»ºä¸€ä¸ªPersistentVolumeClaimå·ã€‚ï¼ˆä»0.12.0å¼€å§‹ï¼‰\nç”Ÿå‘½å‘¨æœŸåŒPipelineRunæˆ–è€…TaskRunï¼Œè¿è¡Œä¹‹åé‡Šæ”¾ã€‚\nworkspaces: - name: git-source volumeClaimTemplate: spec: accessModes: - ReadWriteMany resources: requests: storage: 1Gi ç›¸è¾ƒäºpersistantVolumeClainç±»å‹çš„workspaceï¼ŒvolumeClaimTemplateä¸éœ€è¦åœ¨æ¯æ¬¡åœ¨PipelineRunå®Œæˆåæ¸…ç†å·¥ä½œåŒºï¼›å¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚\nemptyDir å¼•ç”¨emptyDirå·ï¼Œè·ŸéšTaskç”Ÿå‘½å‘¨æœŸçš„ä¸´æ—¶ç›®å½•ã€‚é€‚åˆåœ¨Taskçš„Stepé—´å…±äº«æ•°æ®ï¼Œæ— æ³•åœ¨å¤šä¸ªTaské—´å…±äº«ã€‚\nworkspaces: - name: temp emptyDir: {} configMap å¼•ç”¨ä¸€ä¸ªconfigMapå·ï¼Œå°†configMapå·ä½œä¸ºå·¥ä½œåŒºï¼Œæœ‰å¦‚ä¸‹é™åˆ¶ï¼š\næŒ‚è½½çš„å·æ˜¯åªè¯»çš„ éœ€è¦æå‰åˆ›å»ºconfigMap configMapçš„å¤§å°é™åˆ¶ä¸º1MBï¼ˆK8sçš„é™åˆ¶ï¼‰ ä½¿ç”¨åœºæ™¯ï¼Œæ¯”å¦‚ä½¿ç”¨mavenç¼–è¯‘Javaé¡¹ç›®ï¼Œé…ç½®æ–‡ä»¶settings.xmlå¯ä»¥ä½¿ç”¨configMapä½œä¸ºå·¥ä½œåŒº\nworkspaces: - name: maven-settings configmap: name: maven-settings secret ç”¨äºå¼•ç”¨secretå·ï¼ŒåŒconfigMapå·¥ä½œåŒºä¸€æ ·ï¼Œä¹Ÿæœ‰é™åˆ¶ï¼š\næŒ‚è½½çš„å·æ˜¯åªè¯»çš„ éœ€è¦æå‰åˆ›å»ºsecret secretçš„å¤§å°é™åˆ¶ä¸º1MBï¼ˆK8sçš„é™åˆ¶ï¼‰ Result resultså­—æ®µå¯ä»¥ç”¨æ¥é…ç½®å¤šä¸ªæ–‡ä»¶ç”¨æ¥å­˜å‚¨Tasksçš„æ‰§è¡Œç»“æœï¼Œè¿™äº›æ–‡ä»¶ä¿å­˜åœ¨/tekton/resultsç›®å½•ä¸­ã€‚\nåœ¨Pipelineä¸­ï¼Œå¯ä»¥é€šè¿‡tasks.[task-nanme].results.[result-name]æ³¨å…¥åˆ°å…¶ä»–Taskçš„å‚æ•°ä¸­ã€‚\napiVersion: tekton.dev/v1beta1 kind: Task metadata: name: print-date annotations: description: | A simple task that prints the date spec: results: - name: current-date-unix-timestamp description: The current date in unix timestamp format - name: current-date-human-readable description: The current date in human readable format steps: - name: print-date-unix-timestamp image: bash:latest script: | #!/usr/bin/env bash date +%s | tee $(results.current-date-unix-timestamp.path) - name: print-date-humman-readable image: bash:latest script: | #!/usr/bin/env bash date | tee $(results.current-date-human-readable.path) --- apiVersion: tekton.dev/v1beta1 kind: PipelineRun metadata: name: pass-date spec: pipelineSpec: tasks: - name: print-date taskRef: name: print-date - name: read-date runAfter: #é…ç½®æ‰§è¡Œé¡ºåº - print-date taskSpec: params: - name: current-date-unix-timestamp type: string - name: current-date-human-readable type: string steps: - name: read image: busybox script: | echo $(params.current-date-unix-timestamp) echo $(params.current-date-human-readable) params: - name: current-date-unix-timestamp value: $(tasks.print-date.results.current-date-unix-timestamp) # æ³¨å…¥å‚æ•° - name: current-date-human-readable value: $(tasks.print-date.results.current-date-human-readable) # æ³¨å…¥å‚æ•° æ‰§è¡Œç»“æœï¼š\nâ”Œâ”€â”€â”€â”€â”€â”€Logs(tekton-pipelines/pass-date-read-date-rhlf2-pod-9b2sk)[all] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ place-scripts stream closed â”‚â”‚ step-read 1590242170 â”‚ â”‚ step-read Sat May 23 13:56:10 UTC 2020 â”‚â”‚ step-read + echo 1590242170 â”‚ â”‚ step-read + echo Sat May 23 13:56:10 UTC 2020 â”‚ â”‚ place-tools stream closed â”‚ â”‚ step-read stream closed â”‚ â”‚ PipelineResource PipelineResourceåœ¨æœ€åæï¼Œå› ä¸ºç›®å‰åªæ˜¯alphaç‰ˆæœ¬ï¼Œä½•æ—¶ä¼šè¿›å…¥betaæˆ–è€…å¼ƒç”¨ç›®å‰è¿˜æ˜¯æœªçŸ¥æ•°ã€‚æœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸‹è¿™é‡Œï¼šWhy Arenâ€™t PipelineResources in Beta?\nç®€å•æ¥è¯´ï¼ŒPipelineResourceå¯ä»¥é€šè¿‡å…¶ä»–çš„æ–¹å¼å®ç°ï¼Œè€Œå…¶æœ¬èº«ä¹Ÿå­˜åœ¨å¼Šç«¯ï¼šæ¯”å¦‚å®ç°ä¸é€æ˜ï¼Œdebugæœ‰éš¾åº¦ï¼›åŠŸèƒ½ä¸å¤Ÿå¼ºï¼›é™ä½äº†Taskçš„é‡ç”¨æ€§ç­‰ã€‚\næ¯”å¦‚gitç±»å‹çš„PipelineResourceï¼Œå¯ä»¥é€šè¿‡workspaceå’Œgit-clone Taskæ¥å®ç°ï¼›å­˜å‚¨ç±»å‹çš„ï¼Œä¹Ÿå¯ä»¥é€šè¿‡workspaceæ¥å®ç°ã€‚\nè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢ä»‹ç»workspaceçš„ç¯‡å¹…æ¯”è¾ƒå¤§ã€‚ä¸ªäººä¹Ÿåå‘äºä½¿ç”¨workspaceï¼Œçµæ´»åº¦é«˜ï¼›ä½¿ç”¨workspaceçš„Taské‡ç”¨æ€§å¼ºã€‚\nå‚è€ƒ äº‘åŸç”Ÿ CICD: Tekton Pipeline å®æˆ˜ æ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº Knative Controller Why Arenâ€™t PipelineResources in Beta? ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/how-tekton-works/","tags":["Tekton","Kubernetes","DevOps"],"title":"Tekton çš„å·¥ä½œåŸç†"},{"categories":["ç¬”è®°"],"contents":"\n(Photo by Andrea Piacquadio from Pexels)\nè¯è¯´å·¥ä½œåå¤šå¹´ï¼Œmysql è¿˜çœŸæ²¡ç”¨å‡ å¹´ã€‚èµ·åˆæ˜¯å¤–ä¼é“¶è¡Œï¼Œæ— æ³•ç›´æ¥æ¥è§¦åˆ° DBï¼›åæ¥ä¸€ç›´ä»äº‹æ¶æ„æ–¹é¢ï¼Œä¹Ÿå¤šæ˜¯è§£å†³é—®é¢˜ä¸ºä¸»ã€‚\nè¿™æ¬¡æ­å»ºæµ·å¤–æœºæˆ¿ï¼Œå›´ç»•æ—¶åŒºå¤§å®¶åšäº†ä¸€ç•ªè®¨è®ºã€‚ä¸è¯´æœ€ç»ˆçš„ç»“æœæ˜¯ä»€ä¹ˆï¼ŒæœŸé—´æœ‰åŒäº‹è®¤ä¸º DB è¿”å›çš„æ˜¯ UTC æ—¶é—´ã€‚\nè¿™é‡Œç®€å•åšä¸ªéªŒè¯ï¼Œé¡ºä¾¿çœ‹ä¸‹æ—¶åŒºçš„é—®é¢˜åˆ°åº•æ˜¯å¦‚ä½•å¤„ç†ã€‚\nç¯å¢ƒ openjdk version \u0026ldquo;1.8.0_242\u0026rdquo; mysql-connector-java \u0026ldquo;8.0.20\u0026rdquo; mysql \u0026ldquo;5.7\u0026rdquo; æ—¶åŒº TZ=Europe/London æœ¬åœ°æ—¶åŒº GMT+8\nåˆ›å»ºä¸ªç®€å•çš„åº“teståŠè¡¨userï¼Œ è¡¨ç»“æ„å¦‚ä¸‹ï¼š\nCREATE TABLE `user` ( `name` varchar(50) NOT NULL, `birth_date` timestamp NULL DEFAULT CURRENT_TIMESTAMP ) ENGINE=InnoDB DEFAULT CHARSET=latin1 æ’å…¥ä¸€æ¡æµ‹è¯•æ•°æ®ï¼š\nmysql\u0026gt; insert into `user` -\u0026gt; values (\u0026#39;Tom\u0026#39;, time(\u0026#39;2020-05-15 08:00:00\u0026#39;)); Query OK, 1 row affected (0.01 sec) mysql\u0026gt; select * from user; +------+---------------------+ | name | birth_date | +------+---------------------+ | Tom | 2020-05-14 08:00:00 | +------+---------------------+ 1 row in set (0.00 sec) æµ‹è¯•ä»£ç ï¼š\nConnection conn = DriverManager.getConnection(\u0026#34;jdbc:mysql://localhost:3306/test?useSSL=false\u0026#34;, \u0026#34;root\u0026#34;, \u0026#34;root\u0026#34;); Statement stmt = conn.createStatement(); stmt.execute(\u0026#34;select * from user where name = \u0026#39;Tom\u0026#39;\u0026#34;); ResultSet rs = stmt.getResultSet(); while (rs.next()) { Timestamp timestamp = rs.getTimestamp(\u0026#34;birth_date\u0026#34;); System.out.println(timestamp.toLocalDateTime().toString()); } æ‰§è¡Œç»“æœï¼š\n2020-05-14T15:00 åˆ†æ ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹åŒæ—¶ç”¨ wireshark æŠ“äº†åŒ…ã€‚å¯ä»¥çœ‹åˆ°ä¸€æ¬¡æŸ¥è¯¢ï¼Œåšäº†è¿™ä¹ˆå¤šæ¬¡çš„äº¤äº’ï¼ˆåŒ…å«äº†ä¼šè¯åˆå§‹åŒ–ï¼‰ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ° #177 çš„äº¤äº’è¿”å›æŸ¥è¯¢çš„ç»“æœï¼šTom 2020-05-14 08:00:00ï¼Œä¸ DB ä¸­çš„æ•°æ®ç›¸ç¬¦ã€‚å¯è§ï¼Œè¿”å›çš„å¹¶ä¸æ˜¯ UTC æ—¶é—´ã€‚\nåœ¨ TCP æŠ“åŒ…ç»“æœä¸­ #155 çš„æŸ¥è¯¢è¯­å¥ï¼š\n/* mysql-connector-java-8.0.20 (Revision: afc0a13cd3c5a0bf57eaa809ee0ee6df1fd5ac9b) */ SELECT @@session.auto_increment_increment AS auto_increment_increment, @@character_set_client AS character_set_client, @@character_set_connection AS character_set_connection, @@character_set_results AS character_set_results, @@character_set_server AS character_set_server, @@collation_server AS collation_server, @@collation_connection AS collation_connection, @@init_connect AS init_connect, @@interactive_timeout AS interactive_timeout, @@license AS license, @@lower_case_table_names AS lower_case_table_names, @@max_allowed_packet AS max_allowed_packet, @@net_write_timeout AS net_write_timeout, @@performance_schema AS performance_schema, @@query_cache_size AS query_cache_size, @@query_cache_type AS query_cache_type, @@sql_mode AS sql_mode, @@system_time_zone AS system_time_zone, @@time_zone AS time_zone, @@transaction_isolation AS transaction_isolation, @@wait_timeout AS wait_timeout; æœåŠ¡ç«¯è¿”å›çš„ time_zone ä¸º BSTã€‚ä¸æœ¬åœ°æ—¶åŒºçš„è½¬æ¢ï¼Œç”± mysql çš„ connector è‡ªåŠ¨å®Œæˆã€‚\nè¿›é˜¶ æ—¶åŒºè‡ªåŠ¨è½¬æ¢ å®ç°æºç ï¼š\nResultSetImplæºç \nthis.defaultTimestampValueFactory = new SqlTimestampValueFactory(pset, null, this.session.getServerSession().getServerTimeZone()); @Override public Timestamp getTimestamp(int columnIndex) throws SQLException { checkRowPos(); checkColumnBounds(columnIndex); return this.thisRow.getValue(columnIndex - 1, this.defaultTimestampValueFactory); } å¦‚ä½•ç¡®è®¤æœåŠ¡ç«¯æ—¶åŒºï¼Ÿ ä½¿ç”¨ä¼šè¯ä¸­çš„æœåŠ¡ç«¯æ—¶åŒºè¿›è¡ŒæœåŠ¡ç«¯æ—¶åŒºã€‚ä¼šè¯åˆå§‹åŒ–æ—¶ä¼šè¿›è¡Œæ—¶åŒºçš„ç¡®è®¤ï¼Œæ¯”å¦‚å‰é¢è·å–çš„åˆ°BSTã€‚ç¡®è®¤æ—¶åŒºçš„é€»è¾‘åœ¨NativeProtocol#configureTimezone()ä¸­ï¼š\npublic void configureTimezone() { #ä»mysqlçš„å“åº”è·å– time_zone å’Œ system_time_zone çš„è®¾ç½® String configuredTimeZoneOnServer = this.serverSession.getServerVariable(\u0026#34;time_zone\u0026#34;); if (\u0026#34;SYSTEM\u0026#34;.equalsIgnoreCase(configuredTimeZoneOnServer)) { configuredTimeZoneOnServer = this.serverSession.getServerVariable(\u0026#34;system_time_zone\u0026#34;); } #ä» jdbc url å‚æ•° serverTimezone è·å–æ—¶åŒº String canonicalTimezone = getPropertySet().getStringProperty(PropertyKey.serverTimezone).getValue(); if (configuredTimeZoneOnServer != null) { //å¦‚æœ jdbc url ä¸­æœªé€šè¿‡ serverTimezone æŒ‡å®šæ—¶åŒºã€‚åˆ™ä»TimeZoneMapping.propertiesä¸­è·å–mysql å›ä¼ çš„æ—¶åŒºç¼©å†™å¯¹åº”çš„æ ‡å‡†æ—¶åŒºï¼Œæ¯”å¦‚æ­¤å¤„çš„ BST =\u0026gt; Europe/London //ä¼šå‡ºç°æ— æ³•æ˜ å°„çš„æƒ…å†µï¼Œä¸å¦‚ CEST æ— æ³•æ˜ å°„åˆ° =\u0026gt; Europe/Berlinï¼Œå¯ä»¥æŒ‡å®šè‡ªå®šä¹‰çš„ Properties æ–‡ä»¶è¿›è¡Œæ˜ å°„ // user can override this with driver properties, so don\u0026#39;t detect if that\u0026#39;s the case if (canonicalTimezone == null || StringUtils.isEmptyOrWhitespaceOnly(canonicalTimezone)) { try { canonicalTimezone = TimeUtil.getCanonicalTimezone(configuredTimeZoneOnServer, getExceptionInterceptor()); } catch (IllegalArgumentException iae) { throw ExceptionFactory.createException(WrongArgumentException.class, iae.getMessage(), getExceptionInterceptor()); } } } //å¦‚æœ jdbc url ä¸­é€šè¿‡ serverTimezone æŒ‡å®šäº†æ—¶åŒºï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨è¯¥æ—¶åŒº if (canonicalTimezone != null \u0026amp;\u0026amp; canonicalTimezone.length() \u0026gt; 0) { this.serverSession.setServerTimeZone(TimeZone.getTimeZone(canonicalTimezone)); // // The Calendar class has the behavior of mapping unknown timezones to \u0026#39;GMT\u0026#39; instead of throwing an exception, so we must check for this... // if (!canonicalTimezone.equalsIgnoreCase(\u0026#34;GMT\u0026#34;) \u0026amp;\u0026amp; this.serverSession.getServerTimeZone().getID().equals(\u0026#34;GMT\u0026#34;)) { throw ExceptionFactory.createException(WrongArgumentException.class, Messages.getString(\u0026#34;Connection.9\u0026#34;, new Object[] { canonicalTimezone }), getExceptionInterceptor()); } } } å…³äº serverTimezone çš„å®˜æ–¹è¯´æ˜ Override detection/mapping of time zone. Used when time zone from server doesn\u0026rsquo;t map to Java time zone\nä¿®æ”¹ä¸€ä¸‹ jdbc urlï¼Œé€šè¿‡serverTimezoneæŒ‡å®šæ—¶åŒºä¸º GMT+8ï¼šjdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8\u0026amp;useSSL=false\nå†æ¬¡æ‰§è¡Œä»£ç ï¼š\n2020-05-14T08:00 ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/pexels-marcel-eberle-10622582.jpg","permalink":"https://atbug.com/mysql-timezone-in-java/","tags":["Java"],"title":"Java ä¸­çš„ Mysql æ—¶åŒºé—®é¢˜"},{"categories":null,"contents":"è¿™æ ·æ–‡ç« é€šè¿‡Googleç¿»è¯‘å’Œäººå·¥é€å­—ä¿®æ”¹çš„æ–¹å¼å®Œæˆçš„ï¼ŒæŸäº›ä½ç½®ä¹ŸåŠ ä¸Šè‡ªå·±çš„ç†è§£ã€‚å¦‚æœ‰é”™è¯¯ï¼Œè¯·æŒ‡å‡ºã€‚\nç¿»è¯‘è¿™ç¯‡æ–‡ç« çš„ç›®çš„å…¶å®æ˜¯ä¸ºäº†è‡ªå·±åŠ æ·±å¯¹å¾®æœåŠ¡ã€åˆ†å¸ƒå¼æ¶æ„ä»¥åŠå¤šè¿è¡Œæ—¶æ¶æ„çš„ç†è§£ã€‚æ•´ç¯‡æ–‡ç« ä»â€æˆ˜ç•¥â€œä¸Šåˆ†æäº†å¾®æœåŠ¡â€ä»å¤è‡³ä»Šâ€œè§£å†³çš„é—®é¢˜ï¼Œä»¥åŠå¸¦æ¥çš„æ–°é—®é¢˜ï¼›è¿›è€Œåœ¨â€œæˆ˜æœ¯â€å±‚é¢ï¼Œç»™å‡ºäº†è§£å†³è¿™äº›æ–°é—®é¢˜çš„æ‰‹æ®µã€‚\nä¸ªäººè§è§£ï¼šæ¶æ„ä»æ¥éƒ½æ˜¯è§£å†³é—®é¢˜å¹¶å¸¦æ¥é—®é¢˜ï¼Œ å–èˆä¹‹é“ ã€‚\nèƒŒæ™¯çŸ¥è¯† å¾®æœåŠ¡çš„ 12 è¦ç´ ï¼š\nåŸºå‡†ä»£ç ï¼šä¸€ä»½åŸºå‡†ä»£ç ï¼Œå¤šä»½éƒ¨ç½² ä¾èµ–ï¼šæ˜¾å¼å£°æ˜ä¾èµ–å…³ç³» é…ç½®ï¼šåœ¨ç¯å¢ƒä¸­å­˜å‚¨é…ç½® åç«¯æœåŠ¡ï¼šæŠŠåç«¯æœåŠ¡å½“åšé™„åŠ èµ„æº æ„å»ºã€å‘å¸ƒã€è¿è¡Œï¼šä¸¥æ ¼åˆ†ç¦»æ„å»ºå’Œè¿è¡Œ è¿›ç¨‹ï¼šä»¥ä¸€ä¸ªæˆ–å¤šä¸ªæ— çŠ¶æ€è¿›ç¨‹è¿è¡Œåº”ç”¨ ç«¯å£ç»‘å®šï¼šé€šè¿‡ç«¯å£ç»‘å®šæä¾›æœåŠ¡ å¹¶å‘ï¼šé€šè¿‡è¿›ç¨‹æ¨¡å‹è¿›è¡Œæ‰©å±• æ˜“å¤„ç†ï¼šå¿«é€Ÿå¯åŠ¨å’Œä¼˜é›…ç»ˆæ­¢å¯æœ€å¤§åŒ–å¥å£®æ€§ å¼€å‘ç¯å¢ƒä¸çº¿ä¸Šç¯å¢ƒç­‰ä»·ï¼šå°½å¯èƒ½çš„ä¿æŒå¼€å‘ã€é¢„å‘å¸ƒã€çº¿ä¸Šç¯å¢ƒç›¸åŒ æ—¥å¿—ï¼šæŠŠæ—¥å¿—å½“åšäº‹ä»¶æµ ç®¡ç†è¿›ç¨‹ï¼šåå°ç®¡ç†ä»»åŠ¡å½“åšä¸€æ¬¡æ€§è¿›ç¨‹è¿è¡Œ åŸæ–‡ä»æ­¤å¤„å¼€å§‹ï¼š\nåˆ›å»ºåˆ†å¸ƒå¼ç³»ç»Ÿå¹¶éæ˜“äº‹ã€‚å›´ç»•â€œå¾®æœåŠ¡â€æ¶æ„å’Œâ€œ 12è¦ç´ åº”ç”¨ç¨‹åºâ€è®¾è®¡å‡ºç°äº†æœ€ä½³å®è·µã€‚è¿™äº›æä¾›äº†ä¸äº¤ä»˜ç”Ÿå‘½å‘¨æœŸï¼Œç½‘ç»œï¼ŒçŠ¶æ€ç®¡ç†ä»¥åŠå¯¹å¤–éƒ¨ä¾èµ–é¡¹çš„ç»‘å®šæœ‰å…³çš„å‡†åˆ™ã€‚ ä½†æ˜¯ï¼Œä»¥å¯æ‰©å±•å’Œå¯ç»´æŠ¤çš„æ–¹å¼ä¸€è‡´åœ°å®æ–½è¿™äº›åŸåˆ™æ˜¯å…·æœ‰æŒ‘æˆ˜æ€§çš„ã€‚ è§£å†³è¿™äº›åŸç†çš„ä»¥æŠ€æœ¯ä¸ºä¸­å¿ƒçš„ä¼ ç»Ÿæ–¹æ³•åŒ…æ‹¬ä¼ä¸šæœåŠ¡æ€»çº¿ï¼ˆESBï¼‰å’Œé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼ˆMOMï¼‰ã€‚è™½ç„¶è¿™äº›è§£å†³æ–¹æ¡ˆæä¾›äº†è‰¯å¥½çš„åŠŸèƒ½é›†ï¼Œä½†ä¸»è¦çš„æŒ‘æˆ˜æ˜¯æ•´ä½“æ¶æ„ä»¥åŠä¸šåŠ¡é€»è¾‘å’Œå¹³å°ä¹‹é—´çš„ç´§å¯†æŠ€æœ¯è€¦åˆã€‚ éšç€äº‘ï¼Œå®¹å™¨å’Œå®¹å™¨åè°ƒå™¨ï¼ˆKubernetesï¼‰çš„æµè¡Œï¼Œå‡ºç°äº†è§£å†³è¿™äº›åŸç†çš„æ–°è§£å†³æ–¹æ¡ˆã€‚ä¾‹å¦‚ï¼ŒKnativeç”¨äºäº¤ä»˜ï¼ŒæœåŠ¡ç½‘æ ¼ç”¨äºç½‘ç»œï¼Œè€ŒCamel-Kç”¨äºç»‘å®šå’Œé›†æˆã€‚ é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œä¸šåŠ¡é€»è¾‘ï¼ˆç§°ä¸ºâ€œå¾®é€»è¾‘â€ï¼‰æ„æˆäº†åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒï¼Œå¹¶ä¸”å¯ä»¥åˆ›å»ºæä¾›å¼ºå¤§çš„ç°æˆåˆ†å¸ƒå¼åŸè¯­çš„sidecarâ€œ mechaâ€ç»„ä»¶ã€‚ å¾®è§‚ç»„ä»¶å’Œæœºæ¢°ç»„ä»¶çš„è¿™ç§åˆ†ç¦»å¯ä»¥æ”¹å–„ç¬¬äºŒå¤©çš„æ“ä½œï¼Œä¾‹å¦‚æ‰“è¡¥ä¸å’Œå‡çº§ï¼Œå¹¶æœ‰åŠ©äºç»´æŒä¸šåŠ¡é€»è¾‘å†…èšå•å…ƒçš„é•¿æœŸå¯ç»´æŠ¤æ€§ã€‚ åˆ›å»ºè‰¯å¥½çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºå¹¶éæ˜“äº‹ï¼šæ­¤ç±»ç³»ç»Ÿé€šå¸¸éµå¾ª12è¦ç´ åº”ç”¨ç¨‹åºå’Œå¾®æœåŠ¡åŸåˆ™ã€‚å®ƒä»¬å¿…é¡»æ˜¯æ— çŠ¶æ€çš„ï¼Œå¯ä¼¸ç¼©çš„ï¼Œå¯é…ç½®çš„ï¼Œç‹¬ç«‹å‘å¸ƒçš„ï¼Œå®¹å™¨åŒ–çš„ï¼Œå¯è‡ªåŠ¨åŒ–çš„ï¼Œå¹¶ä¸”æœ‰æ—¶æ˜¯äº‹ä»¶é©±åŠ¨çš„å’Œæ— æœåŠ¡å™¨çš„ã€‚åˆ›å»ºåï¼Œå®ƒä»¬åº”è¯¥æ˜“äºå‡çº§ï¼Œå¹¶ä¸”é•¿æœŸå¯ä»¥æ‰¿å—ã€‚åœ¨å½“ä»Šçš„æŠ€æœ¯ä¸­ï¼Œè¦åœ¨è¿™äº›ç›¸äº’ç«äº‰çš„è¦æ±‚ä¹‹é—´æ‰¾åˆ°è‰¯å¥½çš„å¹³è¡¡ä»ç„¶æ˜¯ä¸€é¡¹è‰°å·¨çš„åŠªåŠ›ã€‚\nåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†æ¢è®¨åˆ†å¸ƒå¼å¹³å°å¦‚ä½•å‘å±•ä»¥å®ç°è¿™ç§å¹³è¡¡ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¼”è¿›ä¸­è¿˜éœ€è¦å‘ç”Ÿä»€ä¹ˆäº‹æƒ…ï¼Œä»¥ç®€åŒ–å¯ç»´æŠ¤çš„åˆ†å¸ƒå¼ä½“ç³»ç»“æ„çš„åˆ›å»ºã€‚å¦‚æœæ‚¨æƒ³è®©æˆ‘å®æ—¶è°ˆè®ºè¿™ä¸ªè¯é¢˜ï¼Œè¯·åŠ å…¥æˆ‘çš„QCon ä¸‰æœˆçš„ä¼¦æ•¦ã€‚\nåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºéœ€æ±‚ åœ¨æ­¤è®¨è®ºä¸­ï¼Œæˆ‘å°†æŠŠç°ä»£åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„éœ€æ±‚åˆ†ä¸ºå››ä¸ªç±»åˆ«-ç”Ÿå‘½å‘¨æœŸï¼Œç½‘ç»œï¼ŒçŠ¶æ€ï¼Œç»‘å®š-å¹¶ç®€è¦åˆ†æå®ƒä»¬åœ¨æœ€è¿‘å‡ å¹´ä¸­çš„å‘å±•æƒ…å†µã€‚\nç”Ÿå‘½å‘¨æœŸ Lifecycle æ‰“åŒ… Packaging å¥åº·æ£€æŸ¥ Healthcheck éƒ¨ç½² Deployment æ‰©å±• Scaling é…ç½® Configuration è®©æˆ‘ä»¬ä»åŸºç¡€å¼€å§‹ã€‚å½“æˆ‘ä»¬ç¼–å†™ä¸€é¡¹åŠŸèƒ½æ—¶ï¼Œç¼–ç¨‹è¯­è¨€å°†æŒ‡ç¤ºç”Ÿæ€ç³»ç»Ÿä¸­çš„å¯ç”¨åº“ï¼Œæ‰“åŒ…æ ¼å¼å’Œè¿è¡Œæ—¶ã€‚ä¾‹å¦‚ï¼ŒJavaä½¿ç”¨.jaræ ¼å¼ï¼Œå°†æ‰€æœ‰Mavenä¾èµ–é¡¹ç”¨ä½œç”Ÿæ€ç³»ç»Ÿï¼Œå¹¶å°†JVMç”¨ä½œè¿è¡Œæ—¶ã€‚å¦‚ä»Šï¼Œéšç€å‘å¸ƒå‘¨æœŸçš„ç¼©çŸ­ï¼Œç”Ÿå‘½å‘¨æœŸæ›´é‡è¦çš„æ˜¯èƒ½å¤Ÿè‡ªåŠ¨éƒ¨ç½²ï¼Œä»é”™è¯¯ä¸­æ¢å¤ä»¥åŠæ‰©å±•æœåŠ¡çš„èƒ½åŠ›ã€‚è¿™ç»„åŠŸèƒ½å¹¿æ³›åœ°ä»£è¡¨äº†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸéœ€æ±‚ã€‚\nè¯‘è€…ï¼šé”™è¯¯æ¢å¤ä¾èµ–å¥åº·æ£€æŸ¥\nç½‘ç»œ Networking æœåŠ¡å‘ç° Service Discovery A/B æµ‹è¯•ã€é‡‘ä¸é›€éƒ¨ç½² A/B Testingï¼ŒCanary rollouts é‡è¯•ã€è¶…æ—¶ã€æ–­è·¯å™¨ Retryï¼Œtimeoutï¼Œcircuit breaker ç‚¹åˆ°ç‚¹ã€å‘å¸ƒ/è®¢é˜… Point-to-pointï¼Œpub/sub å®‰å…¨ã€å¯è§‚æµ‹æ€§ Security observability ä»æŸç§æ„ä¹‰ä¸Šè®²ï¼Œä»Šå¤©å‡ ä¹æ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½æ˜¯åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºï¼Œå› æ­¤éœ€è¦è”ç½‘ã€‚ä½†æ˜¯ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿéœ€è¦ä»æ›´å¹¿æ³›çš„è§’åº¦æŒæ¡ç½‘ç»œã€‚ä»æœåŠ¡å‘ç°å’Œé”™è¯¯æ¢å¤å¼€å§‹ï¼Œåˆ°å¯ç”¨ç°ä»£è½¯ä»¶å‘å¸ƒæŠ€æœ¯ä»¥åŠå„ç§è·Ÿè¸ªå’Œé¥æµ‹ã€‚ä¸ºäº†æˆ‘ä»¬çš„ç›®çš„ï¼Œæˆ‘ä»¬ç”šè‡³å°†ä¸åŒçš„æ¶ˆæ¯äº¤æ¢æ¨¡å¼ï¼Œç‚¹å¯¹ç‚¹å’Œå‘å¸ƒ/è®¢é˜…æ–¹æ³•ä»¥åŠæ™ºèƒ½è·¯ç”±æœºåˆ¶åŒ…æ‹¬åœ¨æ­¤ç±»åˆ«ä¸­ã€‚\nçŠ¶æ€ State å·¥ä½œæµç®¡ç† Workflow mgmt å¹‚ç­‰æ€§ Idempotency ä¸´æ—¶è°ƒåº¦ Temporal scheduling ç¼“å­˜ Caching åº”ç”¨çŠ¶æ€ Application State å½“æˆ‘ä»¬è°ˆè®ºçŠ¶æ€æ—¶ï¼Œé€šå¸¸æ˜¯å…³äºæœåŠ¡çŠ¶æ€ä»¥åŠä¸ºä»€ä¹ˆæœ€å¥½æ˜¯æ— çŠ¶æ€çš„ã€‚ä½†æ˜¯ç®¡ç†æœåŠ¡çš„å¹³å°æœ¬èº«éœ€è¦çŠ¶æ€ã€‚è¿™å¯¹äºæ‰§è¡Œå¯é çš„æœåŠ¡ç¼–æ’å’Œå·¥ä½œæµï¼Œåˆ†å¸ƒå¼å•ä¾‹ï¼Œä¸´æ—¶è°ƒåº¦ï¼ˆcronä½œä¸šï¼‰ï¼Œå¹‚ç­‰æ€§ï¼Œæœ‰çŠ¶æ€çš„é”™è¯¯æ¢å¤ï¼Œç¼“å­˜ç­‰æ˜¯å¿…éœ€çš„ã€‚æ­¤å¤„åˆ—å‡ºçš„æ‰€æœ‰åŠŸèƒ½éƒ½ä¾èµ–äºåº•å±‚çš„çŠ¶æ€ã€‚è™½ç„¶å®é™…çš„çŠ¶æ€ç®¡ç†ä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ä¹‹å†…ï¼Œä½†å…³æ³¨çŠ¶æ€çš„åˆ†å¸ƒå¼åŸè¯­åŠå…¶æŠ½è±¡å´å¾ˆå—å…³æ³¨ã€‚\nç»‘å®š Binding è¿æ¥å™¨ Connectors åè®®è½¬æ¢ Protocol conversion æ¶ˆæ¯è½¬æ¢ Message transformation æ¶ˆæ¯è·¯ç”± Message routeing äº‹åŠ¡æ€§ Transactionality åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç»„ä»¶ä¸ä»…å¿…é¡»å½¼æ­¤å¯¹è¯ï¼Œè€Œä¸”è¿˜å¿…é¡»ä¸ç°ä»£æˆ–æ—§å¼å¤–éƒ¨ç³»ç»Ÿé›†æˆã€‚è¿™å°±è¦æ±‚è¿æ¥å™¨èƒ½å¤Ÿè½¬æ¢å„ç§åè®®ï¼Œæ”¯æŒä¸åŒçš„æ¶ˆæ¯äº¤æ¢æ¨¡å¼ï¼ˆä¾‹å¦‚è½®è¯¢ï¼Œäº‹ä»¶é©±åŠ¨ï¼Œè¯·æ±‚/ç­”å¤ï¼‰è½¬æ¢æ¶ˆæ¯æ ¼å¼ï¼Œç”šè‡³èƒ½å¤Ÿæ‰§è¡Œè‡ªå®šä¹‰çš„é”™è¯¯æ¢å¤è¿‡ç¨‹å’Œå®‰å…¨æœºåˆ¶ã€‚\nè¯‘è€…ï¼šæ‰§è¡Œè‡ªå®šä¹‰çš„é”™è¯¯æ¢å¤è¿‡ç¨‹å’Œå®‰å…¨æœºåˆ¶ \u0026ndash; äº‹åŠ¡\nåœ¨ä¸æ¶‰åŠä¸€æ¬¡æ€§ä½¿ç”¨æ¡ˆä¾‹çš„æƒ…å†µä¸‹ï¼Œä»¥ä¸Šå†…å®¹ä»£è¡¨äº†åˆ›å»ºè‰¯å¥½çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ‰€éœ€çš„é€šç”¨åŸè¯­çš„è‰¯å¥½é›†åˆã€‚å¦‚ä»Šï¼Œè®¸å¤šå¹³å°éƒ½æä¾›äº†è¿™æ ·çš„åŠŸèƒ½ï¼Œä½†æ˜¯æœ¬æ–‡ä¸­æˆ‘ä»¬è¦å¯»æ‰¾çš„æ˜¯è¿‡å»åå¹´ä¸­æˆ‘ä»¬ä½¿ç”¨è¿™äº›åŠŸèƒ½çš„æ–¹å¼å¦‚ä½•å˜åŒ–ï¼Œä»¥åŠåœ¨ä¸‹ä¸€ä¸ªåå¹´ä¸­å®ƒå°†å¦‚ä½•å˜åŒ–ã€‚ä¸ºäº†è¿›è¡Œæ¯”è¾ƒï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿‡å»çš„åå¹´ï¼Œçœ‹çœ‹åŸºäºJavaçš„ä¸­é—´ä»¶å¦‚ä½•æ»¡è¶³è¿™äº›éœ€æ±‚ã€‚\nä¼ ç»Ÿä¸­é—´ä»¶çš„é™åˆ¶ ä¸Šä¸€ä»£çš„ä¼ä¸šæœåŠ¡æ€»çº¿ï¼ˆESBï¼‰åŠå…¶å˜ä½“ï¼ˆä¾‹å¦‚é¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼Œæ›´è½»é‡çº§çš„é›†æˆæ¡†æ¶ç­‰ï¼‰å¯æ»¡è¶³ä¸Šè¿°éœ€æ±‚ï¼Œè¿™æ˜¯ä¸€ç§ä¼—æ‰€å‘¨çŸ¥çš„ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆã€‚ESB æ˜¯ä¸€ç§ä¸­é—´ä»¶ï¼Œå¯ä»¥ä½¿ç”¨é¢å‘æœåŠ¡çš„ä½“ç³»ç»“æ„ï¼ˆå³ç»å…¸SOAï¼‰åœ¨å¼‚æ„ç¯å¢ƒä¹‹é—´å®ç°äº’æ“ä½œæ€§ã€‚\nESBå¯ä»¥ä¸ºæ‚¨æä¾›è‰¯å¥½çš„åŠŸèƒ½é›†ï¼Œä½†ESBçš„ä¸»è¦æŒ‘æˆ˜æ˜¯æ•´ä½“æ¶æ„ä»¥åŠä¸šåŠ¡é€»è¾‘å’Œå¹³å°ä¹‹é—´ç´§å¯†çš„æŠ€æœ¯è€¦åˆï¼Œä»è€Œå¯¼è‡´æŠ€æœ¯å’Œç»„ç»‡é›†ä¸­åŒ–ã€‚åœ¨å°†æœåŠ¡å¼€å‘å¹¶éƒ¨ç½²åˆ°è¿™æ ·çš„ç³»ç»Ÿä¸­æ—¶ï¼Œå®ƒä¸åˆ†å¸ƒå¼ç³»ç»Ÿæ¡†æ¶ç´§å¯†ç»“åˆï¼Œä»è€Œé™åˆ¶äº†æœåŠ¡çš„å‘å±•ã€‚è¿™é€šå¸¸åªä¼šåœ¨è½¯ä»¶ç”Ÿå‘½å‘¨æœŸçš„åæœŸæ‰å˜å¾—æ˜æ˜¾ã€‚\nä»¥ä¸‹æ˜¯æ¯ç±»éœ€æ±‚çš„ä¸€äº›é—®é¢˜å’Œå±€é™æ€§ï¼Œè¿™äº›é—®é¢˜å’Œå±€é™æ€§ä½¿å¾—ESBåœ¨ç°ä»£æ—¶ä»£ä¸å†æœ‰ç”¨ã€‚\nç”Ÿå‘½å‘¨æœŸ åœ¨ä¼ ç»Ÿçš„ä¸­é—´ä»¶ä¸­ï¼Œé€šå¸¸åªæœ‰ä¸€ä¸ªå—æ”¯æŒçš„è¯­è¨€è¿è¡Œæ—¶ï¼ˆä¾‹å¦‚Javaï¼‰ï¼Œå®ƒè§„å®šäº†è½¯ä»¶çš„æ‰“åŒ…æ–¹å¼ï¼Œå¯ç”¨çš„åº“ï¼Œå¿…é¡»å®šæœŸå¯¹å…¶è¿›è¡Œæ‰“è¡¥ä¸ç­‰ã€‚ä¸šåŠ¡æœåŠ¡å¿…é¡»ä½¿ç”¨é‚£äº›ä½¿å…¶ä¸ä»¥ç›¸åŒè¯­è¨€ç¼–å†™çš„å¹³å°ç´§å¯†ç»“åˆçš„åº“ã€‚å®é™…ä¸Šï¼Œè¿™å¯¼è‡´åè°ƒçš„æœåŠ¡å’Œå¹³å°å‡çº§ï¼Œä»è€Œé˜»æ­¢äº†ç‹¬ç«‹å’Œå¸¸è§„çš„æœåŠ¡å’Œå¹³å°å‘å¸ƒã€‚\nè”ç½‘ å°½ç®¡ä¼ ç»Ÿçš„ä¸­é—´ä»¶æ‹¥æœ‰å›´ç»•ä¸å…¶ä»–å†…éƒ¨å’Œå¤–éƒ¨æœåŠ¡äº¤äº’çš„é«˜çº§åŠŸèƒ½é›†ï¼Œä½†å®ƒå…·æœ‰ä¸€äº›ä¸»è¦ç¼ºç‚¹ã€‚ ç½‘ç»œåŠŸèƒ½é›†ä¸­äºä¸€ç§ä¸»è¦è¯­è¨€åŠå…¶ç›¸å…³æŠ€æœ¯ã€‚ å¯¹äºJavaæ¥è¯´ï¼Œå³JMSï¼ŒJDBCï¼ŒJTAç­‰ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œç½‘ç»œé—®é¢˜å’Œè¯­ä¹‰ä¹Ÿæ·±æ·±åœ°åˆ»åœ¨ä¸šåŠ¡æœåŠ¡ä¸­ã€‚ æœ‰ä¸€äº›å…·æœ‰æŠ½è±¡çš„åº“æ¥è§£å†³ç½‘ç»œé—®é¢˜ï¼ˆä¾‹å¦‚æ›¾ç»å¾ˆå—æ¬¢è¿çš„Hystrixé¡¹ç›®ï¼‰ï¼Œä½†æ˜¯è¯¥åº“çš„æŠ½è±¡â€œæ³„æ¼â€åˆ°äº†æœåŠ¡çš„ç¼–ç¨‹æ¨¡å‹ï¼Œäº¤æ¢æ¨¡å¼å’Œé”™è¯¯å¤„ç†è¯­ä¹‰ä»¥åŠåº“æœ¬èº«ä¸­ã€‚ è™½ç„¶å¯ä»¥æ–¹ä¾¿åœ°åœ¨ä¸€ä¸ªä½ç½®ç¼–å†™å’Œè¯»å–ä¸ç½‘ç»œæ–¹é¢æ··åˆçš„æ•´ä¸ªä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯è¿™å°†ä¸¤ä¸ªé—®é¢˜ç´§å¯†åœ°è€¦åˆåˆ°ä¸€ä¸ªå®ç°ä¸­ï¼Œæœ€ç»ˆå½¢æˆäº†ä¸€æ¡å…±åŒçš„æ¼”è¿›è·¯å¾„ã€‚\nè¯‘è€…ï¼šè¿™é‡Œé—®é¢˜åœ¨äºä¸€äº›é€šç”¨çš„é«˜çº§åŠŸèƒ½ä¸è¯­è¨€ç»‘å®šã€‚è¿™é‡Œæåˆ°çš„ Hystrix ä½œä¸ºæ–­è·¯å™¨çš„ä¸€ä¸ªå®ç°ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦é‡‡ç”¨ Hystrix çš„ç¼–ç¨‹æ¨¡å‹ã€‚å¦‚æœåˆ‡æ¢åˆ°å…¶ä»–çš„å®ç°ï¼Œåˆ™éœ€è¦å­¦ä¹ å’Œæ”¹é€ çš„æˆæœ¬ã€‚\nçŠ¶æ€ ä¸ºäº†è¿›è¡Œå¯é çš„æœåŠ¡ç¼–æ’ï¼Œä¸šåŠ¡æµç¨‹ç®¡ç†ä»¥åŠå®æ–½æ¨¡å¼ï¼ˆä¾‹å¦‚Sagaæ¨¡å¼å’Œå…¶ä»–è¿è¡Œç¼“æ…¢çš„æµç¨‹ï¼‰ï¼Œå¹³å°éœ€è¦åœ¨å¹•åä¿æŒæŒä¹…çŠ¶æ€ã€‚åŒæ ·ï¼Œä¸´æ—¶åŠ¨ä½œï¼ˆä¾‹å¦‚è§¦å‘è®¡æ—¶å™¨å’Œcronä½œä¸šï¼‰å»ºç«‹åœ¨çŠ¶æ€ä¹‹ä¸Šï¼Œå¹¶ä¸”éœ€è¦åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å¯¹æ•°æ®åº“è¿›è¡Œé›†ç¾¤åŒ–å’Œæ¢å¤ã€‚è¿™é‡Œçš„ä¸»è¦çº¦æŸæ˜¯ä»¥ä¸‹äº‹å®ï¼šä¸çŠ¶æ€äº¤äº’çš„åº“å’Œæ¥å£æ²¡æœ‰å®Œå…¨æŠ½è±¡å‡ºæ¥ï¼Œä¹Ÿæ²¡æœ‰ä¸æœåŠ¡è¿è¡Œæ—¶åˆ†ç¦»ã€‚é€šå¸¸ï¼Œè¿™äº›åº“å¿…é¡»é…ç½®æœ‰æ•°æ®åº“è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶ä¸”å®ƒä»¬å­˜åœ¨äºæœåŠ¡ä¸­ï¼Œä»è€Œå°†è¯­ä¹‰å’Œä¾èµ–å…³ç³»æ³„æ¼åˆ°åº”ç”¨ç¨‹åºåŸŸä¸­\nç»‘å®š ä½¿ç”¨é›†æˆä¸­é—´ä»¶çš„ä¸»è¦é©±åŠ¨ç¨‹åºä¹‹ä¸€æ˜¯èƒ½å¤Ÿä½¿ç”¨ä¸åŒçš„åè®®ï¼Œæ•°æ®æ ¼å¼å’Œæ¶ˆæ¯äº¤æ¢æ¨¡å¼è¿æ¥åˆ°å…¶ä»–å„ç§ç³»ç»Ÿã€‚ä½†æ˜¯ï¼Œè¿™äº›è¿æ¥å™¨å¿…é¡»ä¸åº”ç”¨ç¨‹åºä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ„å‘³ç€å¿…é¡»å°†ä¾èµ–å…³ç³»ä¸ä¸šåŠ¡é€»è¾‘ä¸€èµ·è¿›è¡Œæ›´æ–°å’Œä¿®è¡¥ã€‚è¿™æ„å‘³ç€å¿…é¡»åœ¨æœåŠ¡å†…æ¥å›è½¬æ¢æ•°æ®ç±»å‹å’Œæ•°æ®æ ¼å¼ã€‚è¿™æ„å‘³ç€å¿…é¡»æ ¹æ®æ¶ˆæ¯äº¤æ¢æ¨¡å¼æ¥æ„é€ ä»£ç å¹¶è®¾è®¡æµç¨‹ã€‚è¿™äº›æ˜¯å³ä½¿æŠ½è±¡çš„ç«¯ç‚¹å¦‚ä½•å½±å“ä¼ ç»Ÿä¸­é—´ä»¶ä¸­æœåŠ¡å®ç°çš„ä¸€äº›ç¤ºä¾‹ã€‚\nè¯‘è€…ï¼šä½¿ç”¨ä¸åŒ RPC å®ç°çš„æœåŠ¡ä¹‹é—´çš„å¯¹è¯ï¼Œæ¯”å¦‚æŸä¸ªæœåŠ¡è°ƒç”¨ä¼šåŒæ—¶ï¼ˆç©ºé—´ä¸Šï¼‰è°ƒç”¨ä½¿ç”¨ Dubbo åè®®çš„æœåŠ¡å’Œä½¿ç”¨ RESTful åè®®çš„æœåŠ¡\näº‘åŸç”Ÿè¶‹åŠ¿ ä¼ ç»Ÿçš„ä¸­é—´ä»¶åŠŸèƒ½å¼ºå¤§ã€‚å®ƒå…·æœ‰æ‰€æœ‰å¿…è¦çš„æŠ€æœ¯åŠŸèƒ½ï¼Œä½†ç¼ºä¹ç°ä»£æ•°å­—ä¸šåŠ¡éœ€æ±‚æ‰€è¦æ±‚çš„å¿«é€Ÿæ›´æ”¹å’Œæ‰©å±•çš„èƒ½åŠ›ã€‚è¿™å°±æ˜¯å¾®æœåŠ¡ä½“ç³»ç»“æ„åŠå…¶è®¾è®¡ç°ä»£åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„æŒ‡å¯¼åŸåˆ™æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚\nå¾®æœåŠ¡èƒŒåçš„æ€æƒ³åŠå…¶æŠ€æœ¯è¦æ±‚ä¿ƒè¿›äº†å®¹å™¨å’ŒKubernetesçš„æ™®åŠå’Œå¹¿æ³›ä½¿ç”¨ã€‚è¿™å¼€å§‹äº†ä¸€ç§æ–°çš„åˆ›æ–°æ–¹å¼ï¼Œè¿™ç§æ–¹å¼å°†å½±å“æˆ‘ä»¬ä»Šåå‡ å¹´å¤„ç†åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„æ–¹å¼ã€‚è®©æˆ‘ä»¬çœ‹çœ‹Kuberneteså’Œç›¸å…³æŠ€æœ¯å¦‚ä½•å½±å“æ¯ç»„éœ€æ±‚ã€‚\nç”Ÿå‘½å‘¨æœŸ å®¹å™¨å’ŒKuberneteså°†æˆ‘ä»¬æ‰“åŒ…ã€åˆ†å‘å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºçš„æ–¹å¼å‘å±•ä¸ºä¸è¯­è¨€æ— å…³çš„æ ¼å¼ã€‚å…³äºKubernetesæ¨¡å¼å’ŒKuberneteså¯¹å¼€å‘äººå‘˜çš„å½±å“çš„æ–‡ç« å¾ˆå¤šï¼Œåœ¨è¿™é‡Œæˆ‘å°†ç®€çŸ­ä»‹ç»ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œå¯¹äºKubernetesï¼Œè¦ç®¡ç†çš„æœ€å°åŸè¯­æ˜¯å®¹å™¨ï¼Œå®ƒä¸“æ³¨äºåœ¨å®¹å™¨çº§åˆ«å’Œæµç¨‹æ¨¡å‹ä¸Šäº¤ä»˜åˆ†å¸ƒå¼åŸè¯­ã€‚è¿™æ„å‘³ç€å®ƒåœ¨ç®¡ç†åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸæ–¹é¢ï¼Œè¿è¡ŒçŠ¶å†µæ£€æŸ¥ã€æ¢å¤ã€éƒ¨ç½²å’Œæ‰©å±•æ–¹é¢åšå¾—å¾ˆå¥½ï¼Œä½†æ˜¯åœ¨å®¹å™¨å†…çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„å…¶ä»–æ–¹é¢å´æ²¡æœ‰åšå¾—é‚£ä¹ˆå¥½ï¼Œä¾‹å¦‚çµæ´»çš„ç½‘ç»œã€çŠ¶æ€ç®¡ç†å’Œç»‘å®šã€‚\næ‚¨å¯èƒ½ä¼šæŒ‡å‡ºï¼ŒKuberneteså…·æœ‰çŠ¶æ€å·¥ä½œè´Ÿè½½ã€æœåŠ¡å‘ç°ã€cronä½œä¸šå’Œå…¶ä»–åŠŸèƒ½ã€‚çš„ç¡®å¦‚æ­¤ï¼Œä½†æ˜¯æ‰€æœ‰è¿™äº›åŸè¯­éƒ½æ˜¯åœ¨å®¹å™¨çº§åˆ«çš„ï¼Œå¹¶ä¸”åœ¨å®¹å™¨å†…éƒ¨ï¼Œå¼€å‘äººå‘˜ä»ç„¶å¿…é¡»ä½¿ç”¨ç‰¹å®šäºè¯­è¨€çš„åº“æ¥è®¿é—®æˆ‘ä»¬åœ¨æœ¬æ–‡å¼€å¤´åˆ—å‡ºçš„æ›´è¯¦ç»†çš„åŠŸèƒ½ã€‚è¿™å°±æ˜¯æ¨åŠ¨è¯¸å¦‚Envoyã€Linkerdã€Consulã€Knativeã€Daprã€Camel-Kç­‰é¡¹ç›®çš„åŸå› ã€‚\nç½‘ç»œ äº‹å®è¯æ˜ï¼ŒKubernetesæä¾›çš„å›´ç»•æœåŠ¡å‘ç°çš„åŸºæœ¬ç½‘ç»œåŠŸèƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åŸºç¡€ï¼Œä½†å¯¹äºç°ä»£åº”ç”¨ç¨‹åºæ¥è¯´è¿˜ä¸å¤Ÿã€‚éšç€å¾®æœåŠ¡æ•°é‡çš„å¢åŠ å’Œéƒ¨ç½²é€Ÿåº¦çš„åŠ å¿«ï¼Œå¯¹æ›´é«˜çº§çš„å‘å¸ƒç­–ç•¥ã€ç®¡ç†å®‰å…¨æ€§ã€æŒ‡æ ‡ã€è·Ÿè¸ªã€ä»é”™è¯¯ä¸­æ¢å¤ã€é”™è¯¯æ¨¡æ‹Ÿç­‰ç­‰æ–¹é¢çš„éœ€æ±‚å˜å¾—è¶Šæ¥è¶Šå…·æœ‰å¸å¼•åŠ›ï¼Œå¹¶äº§ç”Ÿäº†ä¸€ç§æ–°çš„è½¯ä»¶ç±»åˆ«ï¼Œç§°ä¸ºæœåŠ¡ç½‘æ ¼ã€‚\nè¿™é‡Œæ›´ä»¤äººå…´å¥‹çš„æ˜¯ï¼Œè¶‹åŠ¿æ˜¯å°†ä¸ç½‘ç»œç›¸å…³çš„é—®é¢˜ä»åŒ…å«ä¸šåŠ¡é€»è¾‘çš„æœåŠ¡ç§»å‡ºåˆ°å•ç‹¬çš„è¿è¡Œæ—¶ï¼ˆæ— è®ºæ˜¯sidecarè¿˜æ˜¯èŠ‚ç‚¹çº§ä»£ç†ï¼‰ã€‚å¦‚ä»Šï¼ŒæœåŠ¡ç½‘æ ¼å¯ä»¥æ‰§è¡Œé«˜çº§è·¯ç”±ã€åŠ©åŠ›æµ‹è¯•ã€å¤„ç†å®‰å…¨æ€§çš„æŸäº›éƒ¨åˆ†ï¼Œæ›´ç”šè‡³ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„åè®®ï¼ˆä¾‹å¦‚ï¼ŒEnvoyæ”¯æŒKafkaï¼ŒMongoDBï¼ŒRedisï¼ŒMySQLç­‰ï¼‰ã€‚å°½ç®¡ä½œä¸ºè§£å†³æ–¹æ¡ˆçš„æœåŠ¡ç½‘æ ¼å¯èƒ½å°šæœªå¾—åˆ°å¹¿æ³›é‡‡ç”¨ï¼Œä½†å®ƒè§¦åŠäº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„çœŸæ­£ç—›ç‚¹ï¼Œæˆ‘ç›¸ä¿¡å®ƒå°†æ‰¾åˆ°å…¶å½¢çŠ¶å’Œå­˜åœ¨å½¢å¼ã€‚\né™¤äº†å…¸å‹çš„æœåŠ¡æœºåˆ¶å¤–ï¼Œè¿˜æœ‰å…¶ä»–é¡¹ç›®ï¼Œä¾‹å¦‚Skupperï¼Œè¿™äº›é¡¹ç›®è¯å®äº†å°†ç½‘ç»œåŠŸèƒ½æ”¾å…¥å¤–éƒ¨è¿è¡Œæ—¶ä»£ç†çš„è¶‹åŠ¿ã€‚Skupperé€šè¿‡ç¬¬7å±‚è™šæ‹Ÿç½‘ç»œè§£å†³äº†å¤šé›†ç¾¤é—´çš„é€šä¿¡éš¾é¢˜ï¼Œå¹¶æä¾›äº†å…ˆè¿›çš„è·¯ç”±å’Œè¿æ¥åŠŸèƒ½ã€‚ä½†æ˜¯ï¼ŒSkupperå¹¶æ²¡æœ‰è¢«åµŒå…¥åˆ°ä¸šåŠ¡æœåŠ¡è¿è¡Œæ—¶ä¸­ï¼Œè€Œæ˜¯æ¯ä¸ªKuberneteså‘½åç©ºé—´è¿è¡Œä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å®ä¾‹å……å½“å…±äº«çš„è¡¥å……å·¥å…·ã€‚\nç»¼ä¸Šæ‰€è¿°ï¼Œå®¹å™¨å’ŒKubernetesåœ¨åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†æ–¹é¢è¿ˆå‡ºäº†é‡è¦çš„ä¸€æ­¥ã€‚æœåŠ¡ç½‘æ ¼å’Œç›¸å…³æŠ€æœ¯é‡åˆ°äº†çœŸæ­£çš„ç—›ç‚¹ï¼Œå¹¶ä¸ºå°†æ›´å¤šèŒè´£ä»åº”ç”¨ç¨‹åºç§»åˆ°ä»£ç†ä¸­å¥ å®šäº†åŸºç¡€ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ä¸‹ä¸€æ­¥ã€‚\nçŠ¶æ€ æˆ‘ä»¬åœ¨å‰é¢åˆ—å‡ºäº†ä¾èµ–çŠ¶æ€çš„ä¸»è¦é›†æˆåŸè¯­ã€‚ç®¡ç†çŠ¶æ€éå¸¸å›°éš¾ï¼Œåº”å°†å…¶å§”æ´¾ç»™ä¸“é—¨çš„å­˜å‚¨è½¯ä»¶å’Œæ‰˜ç®¡æœåŠ¡ã€‚è¿™ä¸æ˜¯è¿™é‡Œçš„ä¸»é¢˜ï¼Œè€Œæ˜¯åœ¨è¯­è¨€æ— å…³çš„æŠ½è±¡ä¸­ä½¿ç”¨çŠ¶æ€æ¥å¸®åŠ©é›†æˆç”¨ä¾‹ã€‚ä»Šå¤©ï¼Œè®¸å¤šåŠªåŠ›è¯•å›¾åœ¨è¯­è¨€æ— å…³çš„æŠ½è±¡åé¢æä¾›æœ‰çŠ¶æ€çš„åŸè¯­ã€‚æœ‰çŠ¶æ€çš„å·¥ä½œæµç®¡ç†æ˜¯åŸºäºäº‘çš„æœåŠ¡ä¸­çš„å¼ºåˆ¶æ€§åŠŸèƒ½ï¼Œä¾‹å¦‚AWS Step Functionsï¼ŒAzure Durable Functionsç­‰ç¤ºä¾‹ã€‚åœ¨åŸºäºå®¹å™¨çš„éƒ¨ç½²ä¸­ï¼ŒCloudStateå’ŒDapréƒ½ä¾èµ–äºsidecaræ¨¡å‹æ¥è¿›ä¸€æ­¥è§£è€¦åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºä¸­çš„çŠ¶æ€æŠ½è±¡ã€‚\næˆ‘ä¹ŸæœŸå¾…å°†ä¸Šé¢åˆ—å‡ºçš„æ‰€æœ‰æœ‰çŠ¶æ€åŠŸèƒ½æŠ½è±¡åˆ°ä¸€ä¸ªå•ç‹¬çš„è¿è¡Œæ—¶ä¸­ã€‚è¿™æ„å‘³ç€å·¥ä½œæµç®¡ç†ã€å•ä¾‹ã€å¹‚ç­‰ã€äº‹åŠ¡ç®¡ç†ã€cronä½œä¸šè§¦å‘å™¨å’Œæœ‰çŠ¶æ€é”™è¯¯å¤„ç†éƒ½å¯é åœ°å‘ç”Ÿåœ¨Sidecarï¼ˆæˆ–ä¸»æœºçº§ä»£ç†ï¼‰ä¸­ï¼Œè€Œä¸æ˜¯å­˜åœ¨äºæœåŠ¡ä¸­ã€‚ä¸šåŠ¡é€»è¾‘ä¸éœ€è¦åœ¨åº”ç”¨ç¨‹åºä¸­åŒ…å«æ­¤ç±»ä¾èµ–å…³ç³»å’Œè¯­ä¹‰ï¼Œå¹¶ä¸”å¯ä»¥ä»ç»‘å®šç¯å¢ƒä¸­å£°æ˜æ€§åœ°è¯·æ±‚æ­¤ç±»è¡Œä¸ºã€‚ä¾‹å¦‚ï¼ŒSidecarå¯ä»¥å……å½“cronä½œä¸šè§¦å‘å™¨ã€å¹‚ç­‰æ¶ˆè´¹è€…å’Œå·¥ä½œæµç®¡ç†å™¨ï¼Œè€Œè‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘å¯ä»¥ä½œä¸ºå›è°ƒè°ƒç”¨æˆ–æ’å…¥å·¥ä½œæµçš„æŸäº›é˜¶æ®µã€é”™è¯¯å¤„ç†ã€ä¸´æ—¶è°ƒç”¨æˆ–å”¯ä¸€å¹‚ç­‰è¦æ±‚ç­‰ã€‚\nå¦ä¸€ä¸ªæœ‰çŠ¶æ€ç”¨ä¾‹æ˜¯ç¼“å­˜ã€‚æ— è®ºæ˜¯ç”±æœåŠ¡ç½‘æ ¼å±‚æ‰§è¡Œè¯·æ±‚ç¼“å­˜ï¼Œè¿˜æ˜¯ä½¿ç”¨è¯¸å¦‚Infinispanï¼ŒRedisï¼ŒHazelcastç­‰ä¹‹ç±»çš„æ•°æ®ç¼“å­˜ï¼Œéƒ½æœ‰ä¸€äº›å°†ç¼“å­˜åŠŸèƒ½æ¨åˆ°åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ä¹‹å¤–çš„ç¤ºä¾‹ã€‚\nç»‘å®š å°½ç®¡æˆ‘ä»¬çš„ä¸»é¢˜æ˜¯å°†æ‰€æœ‰åˆ†å¸ƒå¼éœ€æ±‚ä¸åº”ç”¨ç¨‹åºè¿è¡Œæ—¶è„±é’©ï¼Œä½†è¿™ç§è¶‹åŠ¿ä¹Ÿç»§ç»­ä¼´éšç€ç»‘å®šã€‚è¿æ¥å™¨ã€åè®®è½¬æ¢ã€æ¶ˆæ¯è½¬æ¢ ã€é”™è¯¯å¤„ç†å’Œå®‰å…¨ä¸­ä»‹éƒ½å¯ä»¥ç§»å‡ºæœåŠ¡è¿è¡Œæ—¶ã€‚æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ°é‚£é‡Œï¼Œä½†æ˜¯åœ¨è¯¸å¦‚Knativeå’ŒDaprä¹‹ç±»çš„é¡¹ç›®ä¸­æœè¿™ä¸ªæ–¹å‘è¿›è¡Œäº†å°è¯•ã€‚å°†æ‰€æœ‰è¿™äº›èŒè´£ç§»å‡ºåº”ç”¨ç¨‹åºè¿è¡Œæ—¶å°†å¯¼è‡´æ›´å°ï¼Œæ›´æ³¨é‡ä¸šåŠ¡é€»è¾‘çš„ä»£ç ã€‚è¿™æ ·çš„ä»£ç å°†åœ¨ç‹¬ç«‹äºåˆ†å¸ƒå¼ç³»ç»Ÿéœ€æ±‚çš„è¿è¡Œæ—¶ä¸­è¿è¡Œï¼Œè€Œåˆ†å¸ƒå¼ç³»ç»Ÿéœ€æ±‚å¯ä»¥ä½œä¸ºé¢„åŒ…è£…åŠŸèƒ½ä½¿ç”¨ã€‚\nApache Camel-K é‡‡ç”¨äº†å¦ä¸€ç§æœ‰è¶£çš„æ–¹æ³•ã€‚è¯¥é¡¹ç›®æ²¡æœ‰ä½¿ç”¨æ¥ä¼´éšä¸»åº”ç”¨ç¨‹åºçš„ä»£ç†è¿è¡Œæ—¶ï¼Œè€Œæ˜¯ä¾é æ™ºèƒ½çš„Kubernetes Operatoræ¥æ„å»ºå…·æœ‰Kuberneteså’ŒKnativeçš„é™„åŠ å¹³å°åŠŸèƒ½çš„åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ã€‚åœ¨è¿™é‡Œï¼Œå•ä¸€ä»£ç†æ˜¯è´Ÿè´£åŒ…æ‹¬åº”ç”¨ç¨‹åºæ‰€éœ€çš„åˆ†å¸ƒå¼ç³»ç»ŸåŸè¯­çš„æ“ä½œå‘˜ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼ŒæŸäº›åˆ†å¸ƒå¼åŸè¯­å·²æ·»åŠ åˆ°åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ä¸­ï¼Œè€ŒæŸäº›å·²åœ¨å¹³å°ä¸­å¯ç”¨ï¼ˆä¹Ÿå¯èƒ½åŒ…æ‹¬Sidecarï¼‰ã€‚\næœªæ¥æ¶æ„è¶‹åŠ¿ æ¦‚æ‹¬åœ°è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œé€šè¿‡å°†åŠŸèƒ½éƒ¨ä»¶è½¬ç§»åˆ°å¹³å°çº§åˆ«ï¼Œåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„äº§å“åŒ–è¾¾åˆ°äº†æ–°çš„é¢†åŸŸã€‚é™¤äº†ç”Ÿå‘½å‘¨æœŸä¹‹å¤–ï¼Œç°åœ¨æˆ‘ä»¬è¿˜å¯ä»¥è§‚å¯Ÿåˆ°è”ç½‘ï¼ŒçŠ¶æ€æŠ½è±¡ï¼Œå£°æ˜æ€§äº‹ä»¶å’Œç«¯ç‚¹ç»‘å®šï¼ˆæ‹†ç®±å³ç”¨ï¼‰ï¼Œå¹¶ä¸”EIPsåœ¨æ­¤åˆ—è¡¨ä¸­æ’åœ¨åé¢ã€‚æœ‰è¶£çš„æ˜¯ï¼Œäº§å“åŒ–ä½¿ç”¨è¿›ç¨‹å¤–æ¨¡å‹ï¼ˆsidecarï¼‰è¿›è¡ŒåŠŸèƒ½æ‰©å±•ï¼Œè€Œä¸æ˜¯ä½¿ç”¨è¿è¡Œæ—¶åº“æˆ–çº¯å¹³å°åŠŸèƒ½ï¼ˆä¾‹å¦‚æ–°çš„KubernetesåŠŸèƒ½ï¼‰ã€‚\nè¯‘è€…ï¼šäº§å“åŒ–å¯ä»¥ç†è§£ä¸ºåˆ†å¸ƒå¼åŸè¯­çš„å†…èšï¼šä¾¿äºç‹¬ç«‹å‘å¸ƒå’Œæ¼”è¿›ã€‚\nç°åœ¨ï¼Œæˆ‘ä»¬é€šè¿‡å°†æ‰€æœ‰ä¼ ç»Ÿçš„ä¸­é—´ä»¶åŠŸèƒ½ï¼ˆä¹Ÿç§°ä¸ºESBï¼‰è½¬ç§»åˆ°å…¶ä»–è¿è¡Œæ—¶ä¸­æ¥ï¼Œä¸ä¹…ï¼Œæˆ‘ä»¬åœ¨æœåŠ¡ä¸­è¦åšçš„å°±åªæ˜¯ç¼–å†™ä¸šåŠ¡é€»è¾‘ã€‚\nä¼ ç»Ÿä¸­é—´ä»¶å¹³å°å’Œäº‘åŸç”Ÿå¹³å°æ¦‚è¿°\nä¸ä¼ ç»Ÿçš„ESBæ—¶ä»£ç›¸æ¯”ï¼Œæ­¤ä½“ç³»ç»“æ„å°†ä¸šåŠ¡é€»è¾‘ä¸å¹³å°æ›´å¥½åœ°åˆ†ç¦»äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å®Œå…¨åˆ†ç¦»ã€‚è®¸å¤šåˆ†å¸ƒå¼åŸè¯­ï¼Œä¾‹å¦‚ç»å…¸çš„ä¼ä¸šé›†æˆæ¨¡å¼ï¼ˆEIPï¼‰ï¼šæ‹†åˆ†å™¨ã€èšåˆå™¨ã€è¿‡æ»¤å™¨ã€åŸºäºå†…å®¹çš„è·¯ç”±å™¨ï¼›æµå¤„ç†æ¨¡å¼ï¼šæ˜ å°„ã€è¿‡æ»¤ã€æŠ˜å ã€è”æ¥ã€åˆå¹¶ã€æ»‘åŠ¨çª—å£ï¼›ä»ç„¶å¿…é¡»åŒ…å«åœ¨ä¸šåŠ¡é€»è¾‘è¿è¡Œæ—¶ä¸­ï¼Œè®¸å¤šå…¶ä»–ä¾èµ–äºå¤šä¸ªä¸åŒä¸”é‡å çš„å¹³å°é™„åŠ ç»„ä»¶ã€‚\nå¦‚æœæˆ‘ä»¬å°†åœ¨ä¸åŒé¢†åŸŸè¿›è¡Œåˆ›æ–°çš„å„ç§äº‘åŸç”Ÿé¡¹ç›®è¿›è¡Œå †å ï¼Œé‚£ä¹ˆæœ€ç»ˆå°†å¾—åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå¤šè¿è¡Œæ—¶å¾®æœåŠ¡\nè¿™é‡Œçš„å›¾ä»…ç”¨äºè¯´æ˜ç›®çš„ï¼Œå®ƒæœ‰ç›®çš„åœ°é€‰æ‹©ä»£è¡¨æ€§çš„é¡¹ç›®å¹¶å°†å…¶æ˜ å°„åˆ°åˆ†å¸ƒå¼åŸè¯­çš„ç±»åˆ«ã€‚å®é™…ä¸Šï¼Œæ‚¨ä¸ä¼šåŒæ—¶ä½¿ç”¨æ‰€æœ‰è¿™äº›é¡¹ç›®ï¼Œå› ä¸ºå…¶ä¸­ä¸€äº›é¡¹ç›®æ˜¯é‡å çš„ä¸”ä¸å…¼å®¹çš„å·¥ä½œè´Ÿè½½æ¨¡å‹ã€‚å¦‚ä½•è§£é‡Šè¿™ä¸ªå›¾ï¼Ÿ\nKuberneteså’Œå®¹å™¨åœ¨å¤šè¯­è¨€åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸­å–å¾—äº†å·¨å¤§é£è·ƒï¼Œå¹¶ä¸ºæœªæ¥çš„åˆ›æ–°å¥ å®šäº†åŸºç¡€ã€‚ æœåŠ¡ç½‘æ ¼æŠ€æœ¯é€šè¿‡é«˜çº§ç½‘ç»œåŠŸèƒ½åœ¨Kubernetesä¸Šè¿›è¡Œäº†æ”¹è¿›ï¼Œå¹¶å¼€å§‹æ¶‰è¶³åº”ç”¨ç¨‹åºæ–¹é¢ã€‚ å°½ç®¡Knativeé€šè¿‡å¿«é€Ÿæ‰©å±•ä¸»è¦ä¸“æ³¨äºæ— æœåŠ¡å™¨å·¥ä½œè´Ÿè½½ï¼Œä½†å®ƒä¹Ÿæ»¡è¶³äº†æœåŠ¡ç¼–æ’å’Œäº‹ä»¶é©±åŠ¨çš„ç»‘å®šéœ€æ±‚ã€‚ Daprä»¥Kubernetesã€Knativeå’ŒService Meshçš„æ€æƒ³ä¸ºåŸºç¡€ï¼Œå¹¶æ·±å…¥åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ä»¥è§£å†³æœ‰çŠ¶æ€çš„å·¥ä½œè´Ÿè½½ã€ç»‘å®šå’Œé›†æˆéœ€æ±‚ï¼Œå……å½“ç°ä»£çš„åˆ†å¸ƒå¼ä¸­é—´ä»¶ã€‚ è¯¥å›¾å¯å¸®åŠ©æ‚¨ç›´è§‚åœ°çœ‹åˆ°ï¼Œå¾ˆå¯èƒ½åœ¨å°†æ¥ï¼Œæˆ‘ä»¬æœ€ç»ˆå°†ä½¿ç”¨å¤šä¸ªè¿è¡Œæ—¶æ¥å®ç°åˆ†å¸ƒå¼ç³»ç»Ÿã€‚å¤šä¸ªè¿è¡Œæ—¶ï¼Œä¸æ˜¯å› ä¸ºæœ‰å¤šä¸ªå¾®æœåŠ¡ï¼Œè€Œæ˜¯å› ä¸ºæ¯ä¸ªå¾®æœåŠ¡éƒ½å°†ç”±å¤šä¸ªè¿è¡Œæ—¶ç»„æˆï¼Œæœ€æœ‰å¯èƒ½æ˜¯ä¸¤ä¸ªè¿è¡Œæ—¶-è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘è¿è¡Œæ—¶å’Œåˆ†å¸ƒå¼åŸè¯­è¿è¡Œæ—¶ã€‚\nå¼•å…¥å¤šè¿è¡Œæ—¶å¾®æœåŠ¡ è¿™æ˜¯å¼€å§‹å½¢æˆçš„å¤šè¿è¡Œæ—¶å¾®æœåŠ¡ä½“ç³»ç»“æ„çš„ç®€è¦è¯´æ˜ã€‚\næ‚¨è¿˜è®°å¾—ç§‘å­¦å®¶ä»¬åˆ¶ä½œçš„ç”µå½±ä¸­çš„Avatarå’Œæœºç”²ï¼ˆæœºæ¢°å¥—ä»¶ï¼‰ï¼Œä»–ä»¬å»æ—·é‡æ¢ç´¢æ½˜å¤šæ‹‰å—ï¼Ÿè¿™ç§å¤šè¿è¡Œæ—¶æ¶æ„ç±»ä¼¼äºè¿™äº›Mecha-ä¸ºç±»äººåŠ¨ç‰©é©¾é©¶å‘˜èµ‹äºˆè¶…èƒ½åŠ›çš„å¥—è£…ã€‚åœ¨ç”µå½±ä¸­ï¼Œæ‚¨è¦ç©¿ä¸Šå¥—è£…æ‰èƒ½è·å¾—åŠ›é‡å¹¶è·å¾—ç ´åæ€§æ­¦å™¨ã€‚åœ¨è¿™ç§è½¯ä»¶æ¶æ„ä¸­ï¼Œæ‚¨å…·æœ‰æ„æˆåº”ç”¨ç¨‹åºæ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘ï¼ˆç§°ä¸ºmicrologicå¾®é€»è¾‘ï¼‰å’Œæä¾›å¼ºå¤§ä¸”æ‹†ç®±å³ç”¨çš„åˆ†å¸ƒå¼åŸè¯­çš„sidecar mechaç»„ä»¶ã€‚å¾®é€»è¾‘ä¸mechaåŠŸèƒ½ç›¸ç»“åˆï¼Œå½¢æˆäº†ä¸€ä¸ªå¤šè¿è¡Œæ—¶å¾®æœåŠ¡ï¼Œè¯¥æœåŠ¡å°†è¿›ç¨‹å¤–åŠŸèƒ½ç”¨äºè§£å†³å…¶åˆ†å¸ƒå¼ç³»ç»Ÿéœ€æ±‚ã€‚æœ€æ£’çš„æ˜¯ï¼ŒAvatar 2å³å°†é¢ä¸–ï¼Œä»¥å¸®åŠ©æ¨å¹¿è¿™ç§æ¶æ„ã€‚æˆ‘ä»¬æœ€ç»ˆå¯ä»¥åœ¨æ‰€æœ‰è½¯ä»¶ä¼šè®®ä¸Šç”¨ä»¤äººèµå¹çš„æœºç”²å›¾ç‰‡ä»£æ›¿è€å¼çš„è¾¹è½¦æ‘©æ‰˜è½¦ï¼›-)ã€‚æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹è¯¥è½¯ä»¶ä½“ç³»ç»“æ„çš„è¯¦ç»†ä¿¡æ¯ã€‚\nè¿™æ˜¯ä¸€ä¸ªç±»ä¼¼äºå®¢æˆ·ç«¯-æœåŠ¡å™¨ä½“ç³»ç»“æ„çš„ä¸¤ç»„ä»¶æ¨¡å‹ï¼Œå…¶ä¸­æ¯ä¸ªç»„ä»¶éƒ½æ˜¯ç‹¬ç«‹çš„è¿è¡Œæ—¶ã€‚å®ƒä¸çº¯å®¢æˆ·ç«¯-æœåŠ¡å™¨ä½“ç³»ç»“æ„çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œè¿™ä¸¤ä¸ªç»„ä»¶éƒ½ä½äºåŒä¸€ä¸»æœºä¸Šï¼Œå½¼æ­¤ä¹‹é—´æ²¡æœ‰å¯é çš„ç½‘ç»œè¿æ¥ã€‚è¿™ä¸¤ä¸ªç»„ä»¶çš„é‡è¦æ€§ç›¸åŒï¼Œå®ƒä»¬å¯ä»¥åœ¨ä»»ä¸€æ–¹å‘ä¸Šå¯åŠ¨æ“ä½œå¹¶å……å½“å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨ã€‚å…¶ä¸­çš„ä¸€ä¸ªç»„ä»¶ç§°ä¸ºä¸ºé€»è¾‘ï¼ˆMicrologicï¼‰ï¼Œå®ƒæ‹¥æœ‰ä»å‡ ä¹æ‰€æœ‰åˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜ä¸­å‰¥ç¦»å‡ºæ¥çš„éå¸¸å°‘çš„ä¸šåŠ¡é€»è¾‘ã€‚å¦ä¸€ä¸ªéšé™„çš„ç»„ä»¶æ˜¯Mechaï¼Œå®ƒæä¾›äº†æˆ‘ä»¬åœ¨æœ¬æ–‡ä¸­ä¸€ç›´è®¨è®ºçš„æ‰€æœ‰åˆ†å¸ƒå¼ç³»ç»ŸåŠŸèƒ½ï¼ˆç”Ÿå‘½å‘¨æœŸé™¤å¤–ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¹³å°åŠŸèƒ½ï¼‰ã€‚\nå¤šè¿è¡Œæ—¶ï¼ˆè¿›ç¨‹å¤–ï¼‰å¾®æœåŠ¡æ¶æ„\nMicrologicå’ŒMechaå¯èƒ½æ˜¯ä¸€å¯¹ä¸€çš„éƒ¨ç½²ï¼ˆç§°ä¸ºsidecaræ¨¡å‹ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯å¸¦æœ‰å‡ ä¸ªMicrologicè¿è¡Œæ—¶çš„å…±äº«Mechaã€‚ç¬¬ä¸€ç§æ¨¡å‹æœ€é€‚ç”¨äºKubernetesç­‰ç¯å¢ƒï¼Œè€Œç¬¬äºŒç§æ¨¡å‹åˆ™é€‚ç”¨äºè¾¹ç¼˜éƒ¨ç½²ã€‚\nå¾®é€»è¾‘è¿è¡Œæ—¶ç‰¹å¾ è®©æˆ‘ä»¬ç®€è¦åœ°æ¢è®¨Micrologicè¿è¡Œæ—¶çš„ä¸€äº›ç‰¹å¾ï¼š\nMicrologicç»„ä»¶æœ¬èº«ä¸æ˜¯å¾®æœåŠ¡ã€‚å®ƒåŒ…å«å¾®æœåŠ¡å°†å…·æœ‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯è¯¥é€»è¾‘åªèƒ½ä¸Mechaç»„ä»¶ç»“åˆä½¿ç”¨ã€‚å¦ä¸€æ–¹é¢ï¼Œå¾®æœåŠ¡æ˜¯è‡ªåŒ…å«çš„ï¼Œæ²¡æœ‰æ•´ä½“åŠŸèƒ½çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ²¡æœ‰ä¸€éƒ¨åˆ†å¤„ç†æµç¨‹æ‰©å±•åˆ°å…¶ä»–è¿è¡Œæ—¶ä¸­ã€‚MicrologicåŠå…¶ä¸Mechaå¯¹åº”çš„äº§å“çš„ç»„åˆå½¢æˆäº†å¾®æœåŠ¡ã€‚ è¿™ä¹Ÿä¸æ˜¯å‡½æ•°æˆ–æ— æœåŠ¡å™¨æ¶æ„ã€‚æ— æœåŠ¡å™¨æœ€è‘—åçš„æ˜¯å…¶æä¾›çš„å¿«é€Ÿæ‰©å±•å’Œä»é›¶æ‰©å±•åˆ°é›¶çš„èƒ½åŠ›ã€‚åœ¨æ— æœåŠ¡å™¨ä½“ç³»ç»“æ„ä¸­ï¼Œå‡½æ•°å®ç°å•ä¸ªæ“ä½œï¼Œå› ä¸ºè¿™æ˜¯å¯ä¼¸ç¼©æ€§çš„å•ä½ã€‚åœ¨è¿™æ–¹é¢ï¼Œå‡½æ•°ä¸åŒäºå®ç°å¤šç§æ“ä½œçš„Micrologicï¼Œä½†å®ç°æ–¹å¼ä¸æ˜¯ç«¯åˆ°ç«¯çš„ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œæ“ä½œçš„å®ç°åˆ†å¸ƒåœ¨Mechaå’ŒMicrologicè¿è¡Œæ—¶ä¸Šã€‚ è¿™æ˜¯å®¢æˆ·ç«¯-æœåŠ¡å™¨ä½“ç³»ç»“æ„çš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œé’ˆå¯¹æ— éœ€ç¼–ç å³å¯ä½¿ç”¨ä¼—æ‰€å‘¨çŸ¥çš„åˆ†å¸ƒå¼åŸè¯­è¿›è¡Œäº†ä¼˜åŒ–ã€‚å¦å¤–ï¼Œå¦‚æœæˆ‘ä»¬å‡è®¾Mechaæ‰®æ¼”æœåŠ¡å™¨è§’è‰²ï¼Œé‚£ä¹ˆæ¯ä¸ªå®ä¾‹éƒ½å¿…é¡»ç»è¿‡ä¸“é—¨é…ç½®ä»¥ä¾¿ä¸å•ä¸ªå®¢æˆ·ç«¯ä¸€èµ·å·¥ä½œã€‚å®ƒä¸æ˜¯é‚£ç§æ—¨åœ¨ä¸å…¸å‹çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨ä½“ç³»ç»“æ„åŒæ—¶æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯çš„é€šç”¨æœåŠ¡å™¨å®ä¾‹ã€‚ï¼ˆè¯‘è€…ï¼šå¤šè¿è¡Œæ—¶æ¶æ„ä¸­å‡å¦‚ mecha ä½œä¸ºæœåŠ¡ç«¯ï¼Œé‚£ä¹ˆå¾®é€»è¾‘ä½œä¸ºå®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„å…³ç³»å¤šä¸ºä¸€å¯¹ä¸€ï¼Œæˆ–è€…å¤šå¯¹ä¸€ã€‚è€Œä¼ ç»Ÿå¾®æœåŠ¡æ¶æ„ä¸­çš„å®¢æˆ·ç«¯æœåŠ¡ç«¯ä¸€èˆ¬æ˜¯å¤šå¯¹å¤šï¼‰ Micrologicä¸­çš„ç”¨æˆ·ä»£ç ä¸ä¼šç›´æ¥ä¸å…¶ä»–ç³»ç»Ÿäº¤äº’ï¼Œä¹Ÿä¸ä¼šå®ç°ä»»ä½•åˆ†å¸ƒå¼ç³»ç»ŸåŸè¯­ã€‚å®ƒé€šè¿‡äº‹å®ä¸Šçš„æ ‡å‡†ï¼ˆä¾‹å¦‚HTTP / gRPCï¼ŒCloudEventsè§„èŒƒï¼‰ä¸Mechaè¿›è¡Œäº¤äº’ï¼Œå¹¶ä¸”Mechaä½¿ç”¨ä¸°å¯Œçš„åŠŸèƒ½å¹¶åœ¨é…ç½®çš„æ­¥éª¤å’Œæœºåˆ¶çš„æŒ‡å¯¼ä¸‹ä¸å…¶ä»–ç³»ç»Ÿè¿›è¡Œé€šä¿¡ã€‚ å°½ç®¡Micrologicä»…è´Ÿè´£å®ç°ä»åˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜ä¸­å‰¥ç¦»å‡ºæ¥çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†å®ƒä»å¿…é¡»è‡³å°‘å®ç°ä¸€äº›APIã€‚å®ƒå¿…é¡»å…è®¸Mechaå’Œå¹³å°é€šè¿‡é¢„å®šä¹‰çš„APIå’Œåè®®ä¸å…¶è¿›è¡Œäº¤äº’ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡éµå¾ªKuberneteséƒ¨ç½²çš„äº‘åŸç”Ÿè®¾è®¡åŸåˆ™ï¼‰ã€‚ï¼ˆè¯‘è€…ï¼šæ¯”å¦‚å¾®é€»è¾‘éœ€è¦å®ç°å¥åº·æ£€æŸ¥çš„ APIï¼Œæ–¹ä¾¿å¹³å°-Kubernetes æˆ–è€… mecha è¿›è¡Œå¥åº·æ£€æŸ¥ï¼‰ Mechaè¿è¡Œæ—¶ç‰¹å¾ ä»¥ä¸‹æ˜¯ä¸€äº›Mechaè¿è¡Œæ—¶ç‰¹å¾ï¼š\nMechaæ˜¯ä¸€ä¸ªé€šç”¨çš„ã€é«˜åº¦å¯é…ç½®çš„ã€å¯é‡ç”¨çš„ç»„ä»¶ã€æä¾›åˆ†å¸ƒå¼åŸè¯­ä½œä¸ºç°æˆçš„åŠŸèƒ½ã€‚ Mechaçš„æ¯ä¸ªå®ä¾‹éƒ½å¿…é¡»é…ç½®ä¸ºä¸ä¸€ä¸ªMicrologicç»„ä»¶ï¼ˆè¾¹è½¦æ¨¡å‹ï¼‰ä¸€èµ·ä½¿ç”¨ï¼Œæˆ–è€…é…ç½®ä¸ºä¸å‡ ä¸ªç»„ä»¶å…±äº«ï¼ˆèŠ‚ç‚¹çº§åˆ«ï¼‰ã€‚ Mechaä¸å¯¹Micrologicè¿è¡Œæ—¶åšä»»ä½•å‡è®¾ã€‚å®ƒä¸ä½¿ç”¨å¼€æ”¾åè®®å’Œæ ¼å¼ï¼ˆä¾‹å¦‚HTTP / gRPCï¼ŒJSONï¼ŒProtobufï¼ŒCloudEventsï¼‰çš„å¤šè¯­è¨€å¾®æœåŠ¡ç”šè‡³å•ç‰‡ç³»ç»Ÿä¸€èµ·ä½¿ç”¨ã€‚ Mechaä»¥ç®€å•çš„æ–‡æœ¬æ ¼å¼ï¼ˆä¾‹å¦‚YAMLï¼ŒJSONï¼‰å£°æ˜æ€§åœ°é…ç½®ï¼Œè¯¥æ ¼å¼è¡¨æ˜è¦å¯ç”¨çš„åŠŸèƒ½ä»¥åŠå¦‚ä½•å°†å…¶ç»‘å®šåˆ°Micrologicç«¯ç‚¹ã€‚å¯¹äºä¸“é—¨çš„APIäº¤äº’ï¼Œå¯ä»¥ä¸ºMechané™„åŠ è§„èŒƒï¼Œä¾‹å¦‚OpenAPIï¼ŒAsyncAPIï¼ŒANSI-SQLç­‰ã€‚å¯¹äºç”±å¤šä¸ªå¤„ç†æ­¥éª¤ç»„æˆçš„æœ‰çŠ¶æ€å·¥ä½œæµï¼Œå¯ä»¥ä½¿ç”¨è¯¸å¦‚Amazon State Languageçš„è§„èŒƒã€‚å¯¹äºæ— çŠ¶æ€é›†æˆï¼Œå¯ä»¥ä½¿ç”¨ä¸Camel-K YAML DSLç±»ä¼¼çš„æ–¹æ³•æ¥ä½¿ç”¨ä¼ä¸šé›†æˆæ¨¡å¼ï¼ˆEIPï¼‰ã€‚è¿™é‡Œçš„å…³é”®ç‚¹æ˜¯ï¼Œæ‰€æœ‰è¿™äº›éƒ½æ˜¯Mechaæ— éœ€ç¼–ç å³å¯å®ç°çš„ç®€å•çš„ã€åŸºäºæ–‡æœ¬çš„ã€å£°æ˜æ€§çš„ã€å¤šç§è¯­è¨€çš„å®šä¹‰ã€‚è¯·æ³¨æ„ï¼Œè¿™äº›éƒ½æ˜¯æœªæ¥æ´¾çš„é¢„æµ‹ï¼Œå½“å‰ï¼Œæ²¡æœ‰ç”¨äºçŠ¶æ€ç¼–æ’æˆ–EIPçš„Mechasï¼Œä½†æ˜¯æˆ‘å¸Œæœ›ç°æœ‰çš„Mechasï¼ˆEnvoyï¼ŒDaprï¼ŒCloudstateç­‰ï¼‰å¾ˆå¿«å°±ä¼šå¼€å§‹æ·»åŠ æ­¤ç±»åŠŸèƒ½ã€‚Mechaæ˜¯åº”ç”¨ç¨‹åºçº§åˆ«çš„åˆ†å¸ƒå¼åŸè¯­æŠ½è±¡å±‚ã€‚ ä¸å…¶ä¸ºäº†ä¸åŒç›®çš„è€Œä¾èµ–äºå¤šä¸ªä»£ç†çš„ï¼ˆä¾‹å¦‚ç½‘ç»œä»£ç†ã€ç¼“å­˜ä»£ç†ã€ç»‘å®šä»£ç†ï¼‰ï¼Œè€Œåº”è¯¥ç”±ä¸€ä¸ªMechaæä¾›æ‰€æœ‰è¿™äº›åŠŸèƒ½ã€‚ä¸€äº›åŠŸèƒ½ï¼ˆä¾‹å¦‚å­˜å‚¨ã€æ¶ˆæ¯æŒä¹…æ€§ã€ç¼“å­˜ç­‰ï¼‰çš„å®ç°å°†è¢«å…¶ä»–äº‘æˆ–æœ¬åœ°æœåŠ¡æ³¨å…¥å¹¶æ”¯æŒã€‚ ä¸€äº›ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ‰å…³çš„åˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜å¯ä»¥ç”±ç®¡ç†å¹³å°ï¼ˆä¾‹å¦‚Kubernetesæˆ–å…¶ä»–äº‘æœåŠ¡ï¼‰æ¥å¤„ç†ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é€šç”¨çš„å¼€æ”¾è§„èŒƒï¼ˆä¾‹å¦‚Open App Modelï¼‰æä¾›çš„Mechaè¿è¡Œæ—¶ã€‚ è¿™ç§æ¶æ„çš„ä¸»è¦å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ å¥½å¤„æ˜¯ä¸šåŠ¡é€»è¾‘å’Œè¶Šæ¥è¶Šå¤šçš„åˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜ä¹‹é—´çš„è€¦åˆå˜å¾—æ¾æ•£ã€‚è½¯ä»¶ç³»ç»Ÿçš„è¿™ä¸¤ä¸ªè¦ç´ å…·æœ‰å®Œå…¨ä¸åŒçš„åŠ¨åŠ›å­¦ã€‚ä¸šåŠ¡é€»è¾‘å§‹ç»ˆæ˜¯å†…éƒ¨ç¼–å†™çš„å”¯ä¸€çš„è‡ªå®šä¹‰ä»£ç ã€‚å®ƒç»å¸¸æ›´æ”¹ï¼Œå…·ä½“å–å†³äºæ‚¨çš„ç»„ç»‡ä¼˜å…ˆçº§å’Œæ‰§è¡Œèƒ½åŠ›ã€‚å¦ä¸€æ–¹é¢ï¼Œç”¨äºè§£å†³æœ¬æ–‡ä¸­åˆ—å‡ºçš„é—®é¢˜çš„åˆ†å¸ƒå¼åŸè¯­ï¼Œå¹¶ä¸”ä¼—æ‰€å‘¨çŸ¥ã€‚è¿™äº›ç”±è½¯ä»¶ä¾›åº”å•†å¼€å‘ï¼Œå¹¶ä½œä¸ºåº“ï¼Œå®¹å™¨æˆ–æœåŠ¡ä½¿ç”¨ã€‚è¯¥ä»£ç æ ¹æ®ä¾›åº”å•†çš„ä¼˜å…ˆçº§ã€å‘å¸ƒå‘¨æœŸã€å®‰å…¨è¡¥ä¸ã€å¼€æ”¾æºä»£ç ç®¡ç†è§„åˆ™ç­‰è€Œæ›´æ”¹ã€‚è¿™ä¸¤éƒ¨åˆ†ä¹‹é—´å‡ ä¹ä¸å¯è§å¹¶ä¸”æ— æ³•ç›¸äº’æ§åˆ¶ã€‚\nä¸šåŠ¡é€»è¾‘å’Œåˆ†å¸ƒå¼ç³»ç»Ÿå…³æ³¨ä¸åŒæ¶æ„ä¸­çš„è€¦åˆ\nå¾®æœåŠ¡åŸç†æœ‰åŠ©äºé€šè¿‡æœ‰é™çš„ä¸Šä¸‹æ–‡ä½¿ä¸åŒçš„ä¸šåŠ¡é¢†åŸŸè„±é’©ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½å¯ä»¥ç‹¬ç«‹å‘å±•ã€‚ä½†æ˜¯å¾®æœåŠ¡æ¶æ„æ— æ³•è§£å†³å°†ä¸šåŠ¡é€»è¾‘ä¸ä¸­é—´ä»¶é—®é¢˜è€¦åˆåœ¨ä¸€èµ·å¸¦æ¥çš„å›°éš¾ã€‚å¯¹äºæŸäº›ä¾èµ–äºé›†æˆç”¨ä¾‹çš„å¾®æœåŠ¡ï¼Œè¿™å¯èƒ½ä¸æ˜¯ä¸€ä¸ªå¤§å› ç´ ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„é¢†åŸŸæ¶‰åŠå¤æ‚çš„é›†æˆï¼ˆä¹Ÿæ˜¯è¶Šæ¥è¶Šå¤šçš„äººæ‰€é¢ä¸´çš„ï¼‰ï¼Œé‚£ä¹ˆéµå¾ªå¾®æœåŠ¡åŸåˆ™ä¹Ÿæ— æ³•å¸®åŠ©æ‚¨é¿å…ä¸ä¸­é—´ä»¶çš„è€¦åˆã€‚å³ä½¿ä¸­é—´ä»¶æ˜¯ä¸ºæ‚¨åŒ…å«åœ¨å¾®æœåŠ¡ä¸­çš„åº“ï¼Œå½“æ‚¨å¼€å§‹è¿ç§»å’Œæ›´æ”¹è¿™äº›åº“æ—¶ï¼Œè¿™ç§è€¦åˆä¾¿ä¼šæ˜¾ç°å‡ºæ¥ã€‚è¿˜æœ‰æ‚¨éœ€è¦çš„åˆ†å¸ƒçš„åŸè¯­è¶Šå¤šï¼Œæ‚¨ä¸é›†æˆå¹³å°çš„è€¦åˆå°±è¶Šå¼ºã€‚é€šè¿‡é¢„å®šä¹‰çš„APIï¼ˆè€Œä¸æ˜¯åº“ï¼‰æ¥è®¿é—®ä½œä¸ºç‹¬ç«‹è¿è¡Œæ—¶/è¿›ç¨‹çš„ä¸­é—´ä»¶ï¼Œæœ‰åŠ©äºè§£è€¦å¹¶å®ç°æ¯ä¸ªç»„ä»¶çš„ç‹¬ç«‹æ¼”è¿›ã€‚\nè¿™ä¹Ÿæ˜¯ä¸ºä¾›åº”å•†åˆ†å‘å’Œç»´æŠ¤å¤æ‚çš„ä¸­é—´ä»¶è½¯ä»¶çš„è¾ƒå¥½çš„æ–¹æ³•ã€‚åªè¦ä¸ä¸­é—´ä»¶çš„äº¤äº’æ˜¯é€šè¿‡å¼€æ”¾APIå’Œæ ‡å‡†çš„è¿›ç¨‹é—´é€šä¿¡è¿›è¡Œçš„ï¼Œè½¯ä»¶ä¾›åº”å•†å°±å¯ä»¥æŒ‰ç…§è‡ªå·±çš„èŠ‚å¥è‡ªç”±å‘å¸ƒè¡¥ä¸å’Œå‡çº§ã€‚æ¶ˆè´¹è€…å¯ä»¥è‡ªç”±ä½¿ç”¨ä»–ä»¬å–œæ¬¢çš„è¯­è¨€ã€åº“ã€è¿è¡Œæ—¶ã€éƒ¨ç½²æ–¹æ³•å’Œè¿‡ç¨‹ã€‚\nè¿™ç§æ¶æ„çš„ä¸»è¦ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ è¿›ç¨‹é—´é€šä¿¡ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸šåŠ¡é€»è¾‘å’Œä¸­é—´ä»¶æœºåˆ¶ï¼ˆæ‚¨å¯ä»¥çœ‹åˆ°åç§°çš„æ¥æºï¼‰åœ¨ä¸åŒçš„è¿è¡Œæ—¶ä¸­ï¼Œå¹¶ä¸”éœ€è¦HTTPæˆ–gRPCè°ƒç”¨è€Œä¸æ˜¯è¿›ç¨‹å†…æ–¹æ³•è°ƒç”¨ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œè¿™å¹¶ä¸æ˜¯è·¨æœºå™¨æˆ–æ•°æ®ä¸­å¿ƒçš„ç½‘ç»œè°ƒç”¨ã€‚Micrologicè¿è¡Œæ—¶å’ŒMechaåº”å½“ä½äºåŒä¸€ä¸»æœºä¸Šï¼Œå¹¶ä¸”å»¶è¿Ÿæ—¶é—´çŸ­ï¼Œå¹¶ä¸”å‡ºç°ç½‘ç»œé—®é¢˜çš„å¯èƒ½æ€§æœ€å°ã€‚\nå¤æ‚ã€‚ä¸‹ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæ˜¯å¦å€¼å¾—ä¸ºè·å¾—æŸäº›å¥½å¤„è€Œè¿›è¡Œå¤æ‚çš„å¼€å‘ã€å¹¶ç»´æŠ¤æ­¤ç±»ç³»ç»Ÿã€‚æˆ‘è®¤ä¸ºç­”æ¡ˆå°†è¶Šæ¥è¶Šå€¾å‘äºæ˜¯ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿçš„éœ€æ±‚å’Œå‘å¸ƒå‘¨æœŸçš„æ­¥ä¼æ­£åœ¨å¢åŠ ï¼Œå¹¶ä¸”æ­¤æ¶æ„ä¸ºæ­¤è¿›è¡Œäº†ä¼˜åŒ–ã€‚æˆ‘å‰æ®µæ—¶é—´å†™é“ï¼Œæœªæ¥çš„å¼€å‘äººå‘˜å¿…é¡»å…·å¤‡æ··åˆå¼€å‘æŠ€èƒ½ã€‚è¿™ç§ä½“ç³»ç»“æ„è¿›ä¸€æ­¥è¯å®äº†è¿™ä¸€è¶‹åŠ¿ã€‚åº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†å°†ä½¿ç”¨é«˜çº§ç¼–ç¨‹è¯­è¨€ç¼–å†™ï¼Œéƒ¨åˆ†åŠŸèƒ½å°†ç”±å¿…é¡»è¿›è¡Œå£°æ˜æ€§é…ç½®çš„ç°æˆç»„ä»¶æä¾›ã€‚è¿™ä¸¤ä¸ªéƒ¨åˆ†çš„äº’è¿ä¸æ˜¯åœ¨ç¼–è¯‘æ—¶æˆ–åœ¨å¯åŠ¨æ—¶é€šè¿‡è¿›ç¨‹å†…ä¾èµ–æ³¨å…¥ï¼Œè€Œæ˜¯åœ¨éƒ¨ç½²æ—¶é€šè¿‡è¿›ç¨‹é—´é€šä¿¡äº’è¿ã€‚è¯¥æ¨¡å‹å¯å®ç°æ›´é«˜çš„è½¯ä»¶é‡ç”¨ç‡å’Œæ›´å¿«çš„å˜æ›´é€Ÿåº¦ã€‚\nå¾®æœåŠ¡åæ— æ³•ä½¿ç”¨çš„åŠŸèƒ½ å¾®æœåŠ¡æ¶æ„æœ‰ä¸€ä¸ªæ˜ç¡®çš„ç›®æ ‡ã€‚å®ƒä¸ºå˜åŒ–è€Œä¼˜åŒ–ã€‚é€šè¿‡å°†åº”ç”¨ç¨‹åºåˆ’åˆ†åˆ°ä¸šåŠ¡åŸŸä¸­ï¼Œæ­¤è½¯ä»¶æ¶æ„é€šè¿‡ç‹¬ç«‹çš„å›¢é˜Ÿåˆ†ç¦»ã€ç®¡ç†å¹¶ä»¥ç‹¬ç«‹çš„æ­¥è°ƒå‘å¸ƒçš„æœåŠ¡ï¼Œä¸ºè½¯ä»¶æ¼”è¿›å’Œå¯ç»´æŠ¤æ€§æä¾›äº†æœ€ä½³çš„æœåŠ¡è¾¹ç•Œã€‚\nå¦‚æœæˆ‘ä»¬çœ‹ä¸€ä¸‹æ— æœåŠ¡å™¨ä½“ç³»ç»“æ„çš„ç¼–ç¨‹æ¨¡å‹ï¼Œå®ƒä¸»è¦åŸºäºåŠŸèƒ½ã€‚åŠŸèƒ½å·²é’ˆå¯¹å¯ä¼¸ç¼©æ€§è¿›è¡Œäº†ä¼˜åŒ–ã€‚é€šè¿‡åŠŸèƒ½ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªæ“ä½œåˆ†è§£ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç»„ä»¶ï¼Œä»¥ä¾¿å¯ä»¥å¿«é€Ÿï¼Œç‹¬ç«‹å’ŒæŒ‰éœ€æ‰©å±•ã€‚åœ¨æ­¤æ¨¡å‹ä¸­ï¼Œéƒ¨ç½²ç²’åº¦æ˜¯ä¸€é¡¹åŠŸèƒ½ã€‚ä¹‹æ‰€ä»¥é€‰æ‹©è¯¥å‡½æ•°ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯ä»£ç ç»“æ„ï¼šå…¶è¾“å…¥çš„é€Ÿç‡ä¸ç¼©æ”¾è¡Œä¸ºç›´æ¥ç›¸å…³ã€‚è¿™æ˜¯ä¸€ç§é’ˆå¯¹æç«¯å¯ä¼¸ç¼©æ€§ï¼ˆè€Œä¸æ˜¯å¤æ‚ç³»ç»Ÿçš„é•¿æœŸå¯ç»´æŠ¤æ€§ï¼‰è¿›è¡Œäº†ä¼˜åŒ–çš„ä½“ç³»ç»“æ„ã€‚\nä»AWS Lambdaçš„æµè¡ŒåŠå…¶å®Œå…¨æ‰˜ç®¡çš„è¿è¥æ€§è´¨æ¥çœ‹ï¼ŒServerlessçš„å…¶ä»–æ–¹é¢åˆå¦‚ä½•å‘¢ï¼Ÿåœ¨è¿™æ–¹é¢ï¼Œâ€œAWSæ— æœåŠ¡å™¨â€ä¸ºé…ç½®é€Ÿåº¦è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä½†ç¼ºå°‘æ§åˆ¶å’Œé”å®šåŠŸèƒ½ã€‚ä½†æ˜¯å®Œå…¨æ‰˜ç®¡çš„æ–¹é¢ä¸æ˜¯åº”ç”¨ç¨‹åºä½“ç³»ç»“æ„ï¼Œè€Œæ˜¯ä¸€ç§è½¯ä»¶ä½¿ç”¨æ¨¡å‹ã€‚å®ƒåœ¨åŠŸèƒ½ä¸Šæ˜¯æ­£äº¤çš„ï¼Œç±»ä¼¼äºä½¿ç”¨åŸºäºSaaSçš„å¹³å°ï¼Œè¯¥å¹³å°åœ¨ç†æƒ³æƒ…å†µä¸‹åº”é€‚ç”¨äºä»»ä½•ç±»å‹çš„ä½“ç³»ç»“æ„ï¼Œæ— è®ºæ˜¯æ•´ä½“å¼ã€å¾®æœåŠ¡ã€æœºç”²è¿˜æ˜¯åŠŸèƒ½ã€‚åœ¨è®¸å¤šæ–¹é¢ï¼ŒAWS Lambdaç±»ä¼¼äºå®Œå…¨æ‰˜ç®¡çš„Mechaæ¶æ„ï¼Œä½†æœ‰ä¸€ä¸ªå¾ˆå¤§çš„åŒºåˆ«ï¼šMechaä¸æ‰§è¡ŒåŠŸèƒ½æ¨¡å‹ï¼Œè€Œæ˜¯å…è®¸å›´ç»•ä¸šåŠ¡åŸŸä½¿ç”¨æ›´å…·å‡èšåŠ›çš„ä»£ç æ„é€ ï¼Œè€Œä¸æ‰€æœ‰ä¸­é—´ä»¶æ— å…³ã€‚\næ¶æ„ä¼˜åŒ–\nå¦ä¸€æ–¹é¢ï¼ŒMechaæ¶æ„ä¸ºä¸­é—´ä»¶ç‹¬ç«‹æ€§ä¼˜åŒ–äº†å¾®æœåŠ¡ã€‚å°½ç®¡å¾®æœåŠ¡å½¼æ­¤ç‹¬ç«‹ï¼Œä½†å®ƒä»¬åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºåµŒå…¥çš„åˆ†å¸ƒå¼åŸè¯­ã€‚Mechaæ¶æ„å°†è¿™ä¸¤ä¸ªé—®é¢˜åˆ†ä¸ºå•ç‹¬çš„è¿è¡Œæ—¶ï¼Œä»è€Œå…è®¸ç‹¬ç«‹å›¢é˜Ÿç‹¬ç«‹å‘å¸ƒå®ƒä»¬ã€‚è¿™ç§è§£è€¦å¯ä»¥æ”¹å–„ç¬¬äºŒå¤©ï¼ˆday-2ï¼‰çš„æ“ä½œï¼ˆä¾‹å¦‚ä¿®è¡¥å’Œå‡çº§ï¼‰ï¼Œå¹¶æ”¹å–„ä¸šåŠ¡é€»è¾‘å†…èšå•å…ƒçš„é•¿æœŸå¯ç»´æŠ¤æ€§ã€‚åœ¨è¿™æ–¹é¢ï¼ŒMechaæ¶æ„æ˜¯å¾®æœåŠ¡æ¶æ„çš„è‡ªç„¶å‘å±•ï¼Œå®ƒé€šè¿‡æ ¹æ®å¼•èµ·æœ€å¤§æ‘©æ“¦çš„è¾¹ç•Œæ‹†åˆ†è½¯ä»¶æ¥è¿›è¡Œå¼€å‘ã€‚ä¸åŠŸèƒ½æ¨¡å‹ç›¸æ¯”ï¼Œè¯¥ä¼˜åŒ–ä»¥è½¯ä»¶é‡ç”¨å’Œæ¼”åŒ–çš„å½¢å¼æä¾›äº†æ›´å¤šå¥½å¤„ï¼Œè€ŒåŠŸèƒ½æ¨¡å‹åˆ™ä»¥ä»£ç çš„è¿‡åº¦åˆ†é…ä¸ºä»£ä»·è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä»¥å®ç°æé«˜çš„å¯ä¼¸ç¼©æ€§ã€‚\nè¯‘è€…ï¼šday-2å¯ä»¥ç†è§£ä¸ºå‰ä¸€å¤©çš„å‘å¸ƒå¸¦æ¥çš„é—®é¢˜éœ€è¦ç¬¬äºŒå¤©çš„å‘å¸ƒè¿›è¡Œä¿®å¤ï¼Œè€Œå¤šè¿è¡Œæ—¶è§£è€¦äº†ä¸šåŠ¡é€»è¾‘å’Œåˆ†å¸ƒå¼åŸè¯­ï¼Œå…è®¸å…¶ä¸­ä¸€ä¸ªçš„ç‹¬ç«‹å‘å¸ƒï¼Œä¸éœ€è¦ç»Ÿä¸€å®‰æ’å‡çº§çš„èŠ‚ç‚¹ã€‚\nç»“è®º åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºæœ‰è®¸å¤šè¦æ±‚ã€‚åˆ›å»ºé«˜æ•ˆçš„åˆ†å¸ƒå¼ç³»ç»Ÿéœ€è¦å¤šç§æŠ€æœ¯å’Œè‰¯å¥½çš„é›†æˆæ–¹æ³•ã€‚å°½ç®¡ä¼ ç»Ÿçš„å•ä½“ä¸­é—´ä»¶æä¾›äº†åˆ†å¸ƒå¼ç³»ç»Ÿæ‰€éœ€çš„æ‰€æœ‰å¿…è¦çš„æŠ€æœ¯åŠŸèƒ½ï¼Œä½†å®ƒç¼ºä¹ä¸šåŠ¡æ‰€éœ€çš„å¿«é€Ÿæ›´æ”¹ã€é€‚åº”å’Œæ‰©å±•çš„èƒ½åŠ›ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåŸºäºå¾®æœåŠ¡çš„æ¶æ„èƒŒåçš„æ€æƒ³ä¸ºå®¹å™¨å’ŒKubernetesçš„å¿«é€Ÿæ™®åŠåšå‡ºäº†è´¡çŒ®ã€‚éšç€äº‘åŸç”Ÿé¢†åŸŸçš„æœ€æ–°å‘å±•ï¼Œæˆ‘ä»¬ç°åœ¨é€šè¿‡å°†æ‰€æœ‰ä¼ ç»Ÿä¸­é—´ä»¶åŠŸèƒ½è½¬ç§»åˆ°å¹³å°å’Œç°æˆçš„è¾…åŠ©è¿è¡Œæ—¶ä¸­æ¥å…¨é¢å‘å±•ã€‚\nåº”ç”¨ç¨‹åºåŠŸèƒ½çš„è¿™ç§äº§å“åŒ–ä¸»è¦æ˜¯ä½¿ç”¨è¿›ç¨‹å¤–æ¨¡å‹è¿›è¡ŒåŠŸèƒ½æ‰©å±•ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶åº“æˆ–çº¯å¹³å°åŠŸèƒ½ã€‚è¿™æ„å‘³ç€ï¼Œå°†æ¥å¾ˆæœ‰å¯èƒ½æˆ‘ä»¬å°†ä½¿ç”¨å¤šä¸ªè¿è¡Œæ—¶æ¥å®ç°åˆ†å¸ƒå¼ç³»ç»Ÿã€‚å¤šä¸ªè¿è¡Œæ—¶ï¼Œä¸æ˜¯å› ä¸ºæœ‰å¤šä¸ªå¾®æœåŠ¡ï¼Œè€Œæ˜¯å› ä¸ºæ¯ä¸ªå¾®æœåŠ¡éƒ½å°†ç”±å¤šä¸ªè¿è¡Œæ—¶ç»„æˆã€‚è‡ªå®šä¹‰å¾®ä¸šåŠ¡é€»è¾‘çš„è¿è¡Œæ—¶ï¼Œä»¥åŠæ‹†ç®±å³ç”¨çš„åˆ†å¸ƒå¼åŸè¯­è¿è¡Œæ—¶ã€‚\nå…³äºä½œè€… Bilgin Ibryamæ˜¯Red Hatçš„é¦–å¸­æ¶æ„å¸ˆã€æäº¤è€…å’ŒApache Software Foundationçš„æˆå‘˜ã€‚ä»–æ˜¯ä¸€ä½å¼€æºçš„ä¼ æ’­è€… ã€åšå®¢ä½œè€…ã€å¶å°”çš„æ¼”è®²è€…ï¼Œå¹¶ä¸”æ˜¯Kubernetes Patternså’ŒCamel Design Patternsä¹¦ç±çš„ä½œè€…ã€‚åœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼ŒBilginä¹äºæŒ‡å¯¼ã€ç¼–ç å¹¶å¸¦é¢†å¼€å‘äººå‘˜æˆåŠŸæ„å»ºå¼€æºè§£å†³æ–¹æ¡ˆã€‚ä»–å½“å‰çš„å·¥ä½œé›†ä¸­åœ¨åŒºå—é“¾ã€åˆ†å¸ƒå¼ç³»ç»Ÿã€å¾®æœåŠ¡ã€devopså’Œäº‘åŸç”Ÿåº”ç”¨ç¨‹åºå¼€å‘ä¸Šã€‚\nåŸæ–‡çš„æŸäº›è¿æ¥ï¼š\n12-Factorsï¼šhttps://12factor.net/zh_cn/ åŸæ–‡ï¼šhttps://www.infoq.com/articles/multi-runtime-microservice-architecture/ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/translation-multi-runtime-microservices-architecture/","tags":["Kubernetes","Container","äº‘åŸç”Ÿ"],"title":"ç¿»è¯‘ï¼šå¤šè¿è¡Œæ—¶å¾®æœåŠ¡æ¶æ„"},{"categories":["ç¬”è®°"],"contents":"\n2021.4.30 æ›´æ–°ï¼š\næœ€æ–°çš„æ–¹æ¡ˆï¼Œè¯·è·³è½¬æ–°ç¯‡ Kubernetes ä¸Šå¦‚ä½•æ§åˆ¶å®¹å™¨çš„å¯åŠ¨é¡ºåºã€‚\nèƒŒæ™¯ ä¼—æ‰€å‘¨çŸ¥, Kubernetes Pod å†…æœ‰ä¸¤ç§å®¹å™¨: åˆå§‹åŒ–å®¹å™¨(init container)å’Œåº”ç”¨å®¹å™¨(app container). å…¶ä¸­åˆå§‹åŒ–å®¹å™¨çš„æ‰§è¡Œå…ˆäºåº”ç”¨å®¹å™¨, å¹¶ä¸”åˆå§‹åŒ–å®¹å™¨å’Œåº”ç”¨å®¹å™¨çš„ä¸ªæ•°åˆ†åˆ«ä¸º 0~n å’Œ 1~n.\nåˆå§‹åŒ–å®¹å™¨ä¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œ, é¡ºåºæ‰§è¡Œçš„å‰ææ˜¯åˆå§‹åŒ–å®¹å™¨å§‹ç»ˆä¼šè¿è¡Œåˆ°å®Œæˆ(completed)çŠ¶æ€. è€Œåº”ç”¨å®¹å™¨æ°å¥½ç›¸å: å¯åŠ¨é¡ºåºéšæœº, å¹¶å§‹ç»ˆä¿æŒè¿è¡Œ(running)çŠ¶æ€.\né—®é¢˜ å·¥ä½œä¸­æœ‰ä¸ªæ¶æ„çš„æ–¹æ¡ˆä½¿ç”¨åˆ°äº† sidecar å®¹å™¨: å°†åŸºç¡€ç»„ä»¶åŠŸèƒ½ä»å®¹å™¨è½¬ç§»åˆ° sidecar å®¹å™¨ä¸­, å…¶ä¸­æœ‰ä¸ªåŠŸèƒ½æ˜¯ä»è¿œç¨‹é…ç½®ä¸­å¿ƒè·å–é…ç½®å¹¶ä¿æŒå®æ—¶æ›´æ–°. ä¿è¯å®æ—¶æ›´æ–°æ²¡æœ‰é—®é¢˜, ä½†æ˜¯é…ç½®æ–‡ä»¶éœ€è¦åœ¨ app å¯åŠ¨ä¹‹å‰å®Œæˆåˆå§‹åŒ–.\nå¯¹äºåŒä¸º\u0026quot;åº”ç”¨å®¹å™¨\u0026quot;ç±»å‹çš„ sidecar å®¹å™¨æ¥è¯´, ç”±äºå®¹å™¨å¯åŠ¨é¡ºåºéšæœºè€Œæ— æ³•åšåˆ°è¿™ä¸€ç‚¹.\nå½“æ—¶æˆ‘ä»¬ç»™å®šçš„æ–¹æ¡ˆæ˜¯å¢åŠ ä¸€ä¸ªåˆå§‹åŒ–å®¹å™¨è¿›è¡Œé…ç½®çš„åˆå§‹åŒ–, ä¸å¯é¿å…çš„æˆ‘ä»¬éœ€è¦å¢åŠ ä¸€ä¸ªé¢å¤–çš„å®¹å™¨, å³ä½¿æ˜¯è¿™ä¸ªå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸéå¸¸çŸ­.\nè¿½æ±‚æè‡´çš„æˆ‘ä»¬æ€»æ˜¯å¯¹è¿™ä¸ªé¢å¤–å¢åŠ çš„å®¹å™¨è€¿è€¿äºæ€€: å‡å¦‚èƒ½æ§åˆ¶åº”ç”¨å®¹å™¨çš„å¯åŠ¨é¡ºåº\u0026hellip;\næ–°å‘ç° è¿‘æœŸåœ¨ç ”ç©¶ CDF (Continuous Delivery Foundation)ä¸‹çš„ Tekton, å…¶ä¸­æœ‰ä¸ªæ¦‚å¿µæ˜¯å…¶å°†æµæ°´çº¿(pipeline)ä¸­çš„å„ä¸ªæ­¥éª¤(step)ä½œä¸ºåº”ç”¨å®¹å™¨åœ¨åŒä¸€ä¸ª Pod ä¸­è¿è¡Œ.\næˆ‘ä»¬éƒ½çŸ¥é“æµæ°´çº¿ä¸­çš„æ­¥éª¤æ˜¯æŒ‰ç…§å®šä¹‰çš„é¡ºåºæ‰§è¡Œçš„, é‚£ä¹ˆ Tekton æ˜¯å¦‚ä½•ä¿è¯åº”ç”¨å®¹å™¨çš„æ‰§è¡Œé¡ºåºçš„?\næŸ¥çœ‹ pod çš„ manifest ä¹‹åå‘ç°äº†ä¸‹é¢çš„å®¹å™¨é…ç½® (è¿™ä¸ªå®¹å™¨çš„ä½œç”¨ä» git ä»“åº“å…‹éš†ä»£ç )\nspec: containers: - args: - -wait_file - /tekton/downward/ready - -wait_file_content - -post_file - /tekton/tools/0 - -termination_path - /tekton/termination - -entrypoint - /ko-app/git-init - -- - -url - http://gitlab.nip.io:8088/addozhang/tekton-test - -revision - develop - -path - /workspace/git-source command: - /tekton/tools/entrypoint å…‹éš†ä»£ç çš„å‘½ä»¤æ˜¯:\ngit-init -url http://gitlab.nip.io:8088/addozhang/tekton-test -revision develop -path /workspace/git-source ä½†æ˜¯å®¹å™¨çš„å¯åŠ¨å‘½ä»¤æ˜¯/tekton/tools/entrypointå¹¶å¸¦ä¸Šäº†ä¸€å¨çš„å‚æ•°(æ­¤å¤„ç•¥è¿‡, åé¢åˆ†æ).\nç¿»çœ‹äº†ä¸‹æ–‡æ¡£:\nThis binary is used to override the entrypoint of a container by wrapping it. In tektoncd/pipeline this is used to make sure Task\u0026rsquo;s steps are executed in order, or for sidecars.\nè¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶è¢«ç”¨äºé€šè¿‡åŒ…è£…çš„æ–¹å¼æ¥è¦†ç›–å®¹å™¨çš„å…¥å£ç‚¹. åœ¨ tektoncd/pipeline ä¸­ç¡®ä¿ä»»åŠ¡ä¸­çš„æ­¥éª¤æˆ–è€… sidecar è¢«é¡ºåºåœ°æ‰§è¡Œ.\n-entrypoint: åŸå§‹çš„å®¹å™¨å¯åŠ¨å‘½ä»¤, ä½œä¸º entrypoint çš„å­è¿›ç¨‹è¿è¡Œ. å³ä¸Šé¢çš„ git-init XXXX -post_file: å­è¿›ç¨‹è¿è¡Œç»“æŸåå†™çš„æ–‡ä»¶è·¯å¾„(å³ä¸Šé¢çš„/tekton/tools/0). å¦‚æœå­è¿›ç¨‹æ‰§è¡Œå¤±è´¥, åˆ™å†™ä¸€ä¸ª{{post_file}}.erræ–‡ä»¶, è€Œä¸æ˜¯{{post_file}} -wait_file: å¯åŠ¨å­è¿›ç¨‹å‰ç›‘æ§çš„æ–‡ä»¶è·¯å¾„(å³ä¸Šé¢çš„/tekton/downward/ready). é€šè¿‡ç›‘æ§åˆ°çš„{{watch_file}}æˆ–è€…{{watch_file}}.erræ–‡ä»¶æ¥å†³å®šæ‰§è¡Œå­è¿›ç¨‹, è¿˜æ˜¯è·³è¿‡æ‰§è¡Œç„¶åå†™å…¥{{post_file}}.erræ–‡ä»¶å¹¶è¿”å›é”™è¯¯ç (exitCode \u0026gt;= 0) -wait_file_content: ç­‰å¾…wait_fileæœ‰å®é™…å†…å®¹å†™å…¥, æŒç»­ç›‘æ§wait_fileç›´åˆ°æœ‰å†…å®¹å†™å…¥. å›å¤´çœ‹ä¸Šé¢å®¹å™¨é…ç½®:\nå®¹å™¨çš„entrypointå¯åŠ¨è¿›ç¨‹ ç›‘æ§åˆ°/tekton/downward/readyæ–‡ä»¶çš„åˆ›å»º, å¹¶ç­‰å¾…æ–‡ä»¶å†…å®¹çš„å†™å…¥ æ‰§è¡Œgit-initå­è¿›ç¨‹, ä» git ä»“åº“å…‹éš†æºç  åˆ›å»º/tekton/tools/0æ–‡ä»¶ å®é™…åº”ç”¨ è¿™ä¸ªæ–¹æ¡ˆæ˜¯å¦èƒ½è§£å†³æˆ‘ä»¬çš„é—®é¢˜, è¿˜æ˜¯æœ‰ä¸€å®šçš„å±€é™æ€§çš„.\né¦–å…ˆéœ€è¦åº”ç”¨å®¹å™¨çš„å¯åŠ¨å‘½ä»¤è¿›è¡Œé‡æ–°çš„ç¼–æ’, è¿™ä¸ªå­˜åœ¨ä¸€å®šçš„æŒ‘æˆ˜. éœ€è¦ç»Ÿä¸€åº”ç”¨çš„å¯åŠ¨å‘½ä»¤æ‰èƒ½åšåˆ°è§„æ¨¡åŒ–+è‡ªåŠ¨åŒ–.\nå…¶æ¬¡å¼•å…¥å¯ç”¨äºç›‘æ§çš„æ–‡ä»¶, éœ€è¦é¢å¤–å¢åŠ Volumeç”¨äºè·¨å®¹å™¨çš„æ–‡ä»¶è®¿é—®. å½“ç„¶é€šè¿‡å¢åŠ emptyDirçš„Volumeå³å¯.\nåŒæ—¶ sidecar å®¹å™¨éœ€è¦åœ¨å®Œæˆå¯åŠ¨ååˆ›å»ºpost_file, åº”ç”¨å®¹å™¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªentrypointè¿›è¡ŒåŒ…è£….\nå¦‚æœè¦çªç ´è¿™ä¸ªå±€é™, CRD æ— éæ˜¯ä¸ªä¼˜ç§€çš„æ–¹æ¡ˆ. ä¸‹ä¸€ç¯‡, æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ CRD æ¥å®ç°.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/control-process-order-of-pod-containers/","tags":["Kubernetes","Container"],"title":"æ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº"},{"categories":["ç¬”è®°"],"contents":" â€‹[å›¾ç‰‡æ¥è‡ª https://www.facebook.com/sequenceprocess/]\né—®é¢˜: å…¥é—¨åˆ°ç”Ÿäº§çº§çš„å·®è· æ˜¨å¤©çš„æ–‡ç« ã€Šä¸º Go åº”ç”¨åˆ›å»º Docker é•œåƒã€‹, ç®—æ˜¯å…¥é—¨çº§çš„, å¹¶ä¸é€‚ç”¨äºç”Ÿäº§çº§. ä¸ºä»€ä¹ˆ?\n$ docker images REPOSITORY TAG IMAGE ID CREATED SIZE addozhang/golang-hello-world latest 4cce1292a87a 4 seconds ago 813MB æ•´ä¸ªé•œåƒçš„å¤§å°æœ‰ 813MB, è¿™è¿˜åªæœ‰ä¸€ä¸ªç®€å•çš„ Hello world. å› ä¸ºå…¶ä¸­åŒ…å«äº† Golang çš„ç¼–è¯‘å’Œè¿è¡Œç¯å¢ƒ. ä½†æ˜¯å®é™…ç”Ÿäº§ç¯å¢ƒä¸­, æˆ‘ä»¬å¹¶ä¸éœ€è¦è¿™ä¹ˆå¤š.\nå…ˆçœ‹ç»“æœ ç²¾ç®€ä¹‹ååªæœ‰ 2.07MB, è€Œä¸”å¹¶ä¸å½±å“è¿è¡Œ.\n$ docker images REPOSITORY TAG IMAGE ID CREATED SIZE addozhang/golang-hello-world latest 4cce1292a87a 3 minutes ago 813MB addozhang/golang-hello-world2 latest 1da5bb994074 7 minutes ago 2.07MB $ docker run --rm addozhang/golang-hello-world2 Hello world è§£å†³æ–¹æ¡ˆ å¦‚æœåšåˆ°çš„? é¦–å…ˆä»åŸºç¡€é•œåƒå¼€å§‹, æ¢æˆscratch1. æ„å»ºæ—¶å°†ç¼–è¯‘å¥½çš„æ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­\nFROM scratch ADD golang-hello-world / CMD [\u0026#34;/golang-hello-world\u0026#34;] å‡å¦‚ä½ æ˜¯ä½¿ç”¨go buildæ¥ç¼–è¯‘, åœ¨ Macos ä¸Šä¼šé‡åˆ°å¦‚ä¸‹é—®é¢˜:\n$ docker run --rm addozhang/golang-hello-world2 standard_init_linux.go:211: exec user process caused \u0026#34;exec format error\u0026#34; è§£å†³æ–¹æ¡ˆæ˜¯CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build\nä»å¤´æ¥çœ‹, æ„å»ºå‡ºä¸€ä¸ªç²¾ç®€çš„é•œåƒ, æˆ‘ä»¬éœ€è¦:\nè¿è¡ŒCGO_ENABLED=0 GOOS=linux GOARCH=amd64 go buildæ„å»º linux ç¯å¢ƒçš„å¯æ‰§è¡Œæ–‡ä»¶. è¯¥æ–‡ä»¶å¹¶ä¸èƒ½åœ¨ mac ä¸Šè¿è¡Œ ä½¿ç”¨docker buildè¿›è¡Œæ„å»º è¿™æ ·çš„æ“ä½œæ­¥éª¤å¤ªéº»çƒ¦, è¿˜èƒ½ä¸èƒ½ç²¾ç®€ä¸€ä¸‹?\nè¿›é˜¶: ä½¿ç”¨ Docker çš„å¤šæ­¥æ„å»º #build stage FROM golang as builder ENV GO111MODULE=on ENV GOPROXY=https://goproxy.io WORKDIR /app COPY go.mod . RUN go mod download COPY . . RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build #image stage FROM scratch COPY --from=builder /app/golang-hello-world / CMD [\u0026#34;/golang-hello-world\u0026#34;] å‚è€ƒ https://dev.to/plutov/docker-and-go-modules-3kkn\nscratchæ˜¯ä¸€ä¸ªç©ºçš„é•œåƒæ–‡ä»¶\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/build-minimal-docker-image-for-go-app/","tags":["Docker"],"title":"Go Docker é•œåƒè¿›é˜¶: ç²¾ç®€é•œåƒ"},{"categories":["ç¬”è®°"],"contents":"\nå—¯å—¯, æœ€è¿‘å¼€å§‹ç”¨ Golang äº†.\nä»Šå¤©éœ€è¦ä¸º Go åº”ç”¨åˆ›å»ºå¯¹è±¡, çœ‹äº†ä¸‹å®˜æ–¹åšå®¢. æ‹¿ hello world åšä¸ªæµ‹è¯•.\nä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åˆ›å»ºä¸ªæ–°çš„é¡¹ç›®\n$ mkdir -p $GOPATH/src/github.com/addozhang/golang-hello-world \u0026amp;\u0026amp; cd \u0026#34;$_\u0026#34; $ go mod init github.com/addozhang/golang-hello-world go: creating new go.mod: module github.com/addozhang/golang-hello-world $ cat \u0026lt;\u0026lt; EOF \u0026gt; main.go package main import \u0026#34;fmt\u0026#34; func main() { fmt.Println(\u0026#34;Hello world\u0026#34;) } EOF # go fmt è¿è¡Œæ£€æŸ¥ä¸€æ¬¡\n$ go run main.go Hello world ç¨‹åºæ²¡é—®é¢˜, ä¸‹é¢å°±æ˜¯æ„å»ºé•œåƒäº†. åˆ›å»ºä¸€ä¸ª Dockerfile æ–‡ä»¶, å†…å®¹å¦‚ä¸‹:\nFROM golang LABEL Author=\u0026#34;addozhang\u0026#34; ADD . /go/src/github.com/addozhang/golang-hello-world RUN go install github.com/addozhang/golang-hello-world ENTRYPOINT [ \u0026#34;/go/bin/golang-hello-world\u0026#34; ] æ„å»ºé•œåƒ:\n$ docker build -t addozhang/golang-hello-world . è¿è¡Œé•œåƒ:\n$ docker run --rm addozhang/golang-hello-world:latest Hello world è¿è¡Œæ²¡é—®é¢˜, æ”¶å·¥\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/build-docker-image-for-go-app/","tags":["Docker"],"title":"ä¸º Go åº”ç”¨åˆ›å»º Docker é•œåƒ"},{"categories":["æ•™ç¨‹"],"contents":"Triggerçš„ä»‹ç»çœ‹ è¿™é‡Œ.\næ¥ä¸Šæ–‡ Tekton Pipeline å®æˆ˜ , æˆ‘ä»¬ä¸ºæŸä¸ªé¡¹ç›®åˆ›å»ºäº†ä¸€ä¸ªPipeline, ä½†æ˜¯æ‰§è¡Œæ—¶é€šè¿‡ PipelineRun æ¥å®Œæˆçš„. åœ¨ PipelineRun ä¸­æˆ‘ä»¬åˆ¶å®šäº† Pipepline ä»¥åŠè¦ä½¿ç”¨çš„ PipelineResource. ä½†æ˜¯æ—¥å¸¸çš„å¼€å‘ä¸­, æˆ‘ä»¬æ›´å¤šå¸Œæœ›åœ¨æäº¤äº†ä»£ç ä¹‹åå¼€å§‹ Pipeline çš„æ‰§è¡Œ. è¿™æ—¶æˆ‘ä»¬å°±è¦ç”¨åˆ° Tekton Trigger äº†.\næ€è·¯æ˜¯è¿™æ ·: ä»£ç æäº¤åå°†Push Eventå‘é€ç»™Tekton Trigger EventController(ä»¥ä¸‹ç®€ç§° Controller), ç„¶å Controller åŸºäºçš„TriggerBindingçš„é…ç½®ä» payload ä¸­æå–ä¿¡æ¯, è£…è½½åœ¨\u0026quot;Params\u0026quot;ä¸­ä½œä¸ºTriggerTemplateçš„å…¥å‚. æœ€å Controller åˆ›å»ºPipelineRun.\nTrigger ç›¸å…³çš„èµ„æº TriggerTemplate å›çœ‹ä¸Šå›ç”¨çš„PipelineRun Yaml, å‚æ•°æœ‰revision, url, imageUrlå’ŒimageTag. (imageUrl ä¸é¡¹ç›®åä¸€ç›´)\nå› æ­¤å®šä¹‰TriggerTemplateå°†è¿™ 4 ä¸ªå…ƒç´ ä½œä¸ºå…¥å‚, ç„¶åå¤ç”¨ä¹‹å‰çš„Pipeline.\napiVersion: tekton.dev/v1alpha1 kind: TriggerTemplate metadata: name: trigger-test-triggertemplate namespace: tekton-pipelines spec: params: - name: gitrevision description: The git revision default: master - name: gitrepositoryurl description: The git repository url - name: namespace description: The namespace to create the resources default: tekton-pielines - name: projectname description: The project name - name: imagetag description: The image tag default: latest resourcetemplates: - apiVersion: tekton.dev/v1alpha1 kind: PipelineRun metadata: name: tekton-test-pipeline-run-$(uid) namespace: $(params.namespace) spec: serviceAccountName: tekton-test params: - name: imageUrl value: addozhang/$(params.projectname) - name: imageTag value: $(params.imagetag) pipelineRef: name: build-pipeline resources: - name: git-source resourceSpec: type: git params: - name: revision value: $(params.gitrevision) - name: url value: $(params.gitrepositoryurl) æ‰§è¡Œkubectl apply -f trigger/trigger-template.yaml\nTriggerBinding TriggerTemplateçš„å…¥å‚éƒ½å¯ä»¥ä»PushEventçš„ payloadä¸­é€šè¿‡ JsonPath è¡¨è¾¾å¼æ¥æå–. æ›´å¤šè¡¨è¾¾å¼çš„ä½¿ç”¨å‚è€ƒå®˜æ–¹çš„æ–‡æ¡£.\næ³¨æ„: è¿™é‡Œçš„ payload æ ¼å¼ä½¿ç”¨çš„æ˜¯ Gitlab çš„ PushEvent å®šä¹‰. ä¸ºä»€ä¹ˆè¦ç”¨ Gitlab åä»€ä¹ˆä¼šè§£é‡Š\napiVersion: tekton.dev/v1alpha1 kind: TriggerBinding metadata: name: trigger-test-triggerbinding namespace: tekton-pipelines spec: params: - name: gitrevision value: $(body.after) - name: namespace value: tekton-pipelines - name: gitrepositoryurl value: $(body.project.git_http_url) - name: projectname value: $(body.project.name) æ‰§è¡Œkubectl apply -f trigger/trigger-binding.yaml\nEventListener EventControllerå°†TriggerTemplateå’ŒTriggerBindingå…³è”åœ¨ä¸€èµ·, èµ„æºåœ¨åˆ›å»ºåä¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„ pod å’Œ service.\napiVersion: tekton.dev/v1alpha1 kind: EventListener metadata: name: trigger-test-eventlistener namespace: tekton-pipelines spec: serviceAccountName: tekton-test //éœ€è¦è®¿é—® API, ç”¨ä¸Šå›åˆ›å»º serviceaccount triggers: - bindings: - name: trigger-test-triggerbinding template: name: trigger-test-triggertemplate æ‰§è¡Œkubectl apply -f trigger/event-listener.yaml\næä¾› WebHook çš„è®¿é—®å…¥å£, ä¸ºEventListeneråˆ›å»ºingress\napiVersion: extensions/v1beta1 kind: Ingress metadata: name: el-trigger-test-eventlistener namespace: tekton-pipelines spec: rules: - host: trigger-test.el.nip.io http: paths: - backend: serviceName: el-trigger-test-eventlistener servicePort: 8080 åšå®Œä¹‹åè®°å¾—æ·»åŠ è§£æsudo echo \u0026quot;$(minikube ip) trigger-test.el.nip.io\u0026quot; \u0026gt;\u0026gt; /etc/hosts\nGitLab è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ç»§ç»­ç”¨ github ä½œä¸º CVS, minikube è¿è¡Œåœ¨æœ¬åœ°, ingress åœ°å€æ— æ³•åœ¨ github ä¸Šè§£æ(webhook æ— æ³•å·¥ä½œ). å› æ­¤åªèƒ½æœ¬åœ°æ­å»ºä¸ª gitlab.\nä½¿ç”¨ Docker Compose çš„æ–¹å¼éƒ¨ç½², å¹¶åˆ¶å®šåŸŸågitlab.nip.io.\nversion: \u0026#39;3.6\u0026#39; services: web: image: \u0026#39;gitlab/gitlab-ce:latest\u0026#39; restart: always hostname: \u0026#39;gitlab.nip.io\u0026#39; environment: GITLAB_OMNIBUS_CONFIG: | external_url \u0026#39;http://gitlab.nip.io:8088\u0026#39; gitlab_rails[\u0026#39;gitlab_shell_ssh_port\u0026#39;] = 8022 # Add any other gitlab.rb configuration here, each on its own line ports: - \u0026#39;8088:8088\u0026#39; - \u0026#39;8022:22\u0026#39; è®°å¾—æ·»åŠ è§£æ\nsudo echo \u0026#34;$(ifconfig | grep -Eo \u0026#39;inet (addr:)?([0-9]*\\.){3}[0-9]*\u0026#39; | grep -Eo \u0026#39;([0-9]*\\.){3}[0-9]*\u0026#39; | grep -v \u0026#39;127.0.0.1\u0026#39; | head -n 1) gitlab.nip.io\u0026#34; \u0026gt;\u0026gt; /etc/hosts GitLab çš„é»˜è®¤è´¦å·æ˜¯root, é¦–æ¬¡è®¿é—®http://gitlab.nip.io:8088çš„æ—¶å€™ä¼šæç¤ºè®¾ç½®å¯†ç .\nåˆ›å»ºé¡¹ç›®, æäº¤ä»£ç çš„æ“ä½œä¸å¤šè¯´äº†. æ·»åŠ  webhook å‰, è¦å…ˆå»\u0026quot;Admin Area \u0026raquo; Settings \u0026raquo; Network \u0026raquo; Outbound Requests\u0026quot;å‹¾é€‰Allow requests to the local network from web hooks and services.\nDNS è§£æé—®é¢˜ Docker å’Œ minikube æ˜¯åœ¨ä¸¤ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿæœºä¸­è¿è¡Œ, å¹¶ä¸”æˆ‘ä»¬æ·»åŠ äº†ä¸¤ä¸ªåœ°å€è§£æ. äº’ç›¸è®¿é—®çš„æ—¶å€™ä¾¿ä¼šå‡ºç° domain æ— æ³•è§£æçš„é—®é¢˜, è¿™é‡Œæ˜¯é€šè¿‡éƒ¨ç½²ä¸€ä¸ª dnsmasq ä½œä¸ºç‹¬ç«‹çš„ dns è§£ææœåŠ¡å™¨.\nå®‰è£…å’Œé…ç½® dnsmasq, dnsmasq ä¼šå°† /etc/hosts ä¸­çš„è®°å½•åŠ å…¥åˆ°è®°å½•ä¸­.\næˆ‘æœ¬åœ°çš„ minikube ä½äº192.168.64.0ç½‘æ®µ, å› æ¬¡ dnsmasq æ·»åŠ ç›‘å¬åœ°å€192.168.64.1\nbrew install dnsmasq cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/local/etc/dnsmasq.conf strict-order listen-address=127.0.0.1,192.168.64.1 EOF sudo brew services start dnsmasq æ£€æŸ¥ä¸€ä¸‹, 192.168.1.136æ˜¯æˆ‘æœ¬æœº ip.\n$ dig gitlab.nip.io @192.168.64.1 ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.10.6 \u0026lt;\u0026lt;\u0026gt;\u0026gt; gitlab.nip.io @192.168.64.1 ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 63393 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ;; QUESTION SECTION: ;gitlab.nip.io.\tIN\tA ;; ANSWER SECTION: gitlab.nip.io.\t0\tIN\tA\t192.168.1.136 ;; Query time: 0 msec ;; SERVER: 192.168.64.1#53(192.168.64.1) ;; WHEN: Thu Feb 13 18:20:19 CST 2020 ;; MSG SIZE rcvd: 58 æµ‹è¯• æ¨é€ä¸€ä¸ªç©ºçš„æäº¤åˆ°ä»£ç ä»“åº“: git commit -a -m \u0026quot;trigger commit\u0026quot; --allow-empty \u0026amp;\u0026amp; git push origin master\nç„¶åå°±å¯ä»¥çœ‹åˆ°æ–°çš„PipelineRunåˆ›å»ºå¹¶è¿è¡Œ.\n$ tkn pr list NAME STARTED DURATION STATUS tekton-test-pipeline-run-fk2xj 42 seconds ago --- Running å…¶ä»–æ–‡ç«  Tekton Pipeline å®æˆ˜: https://atbug.com/tekton-pipeline-practice\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/tekton-trigger-practice/","tags":["DevOps","Tekton"],"title":"äº‘åŸç”ŸCICD: Tekton Trigger å®æˆ˜"},{"categories":["ç¬”è®°"],"contents":"èƒŒæ™¯ Tekton çš„ä»‹ç»è¯·å‚è€ƒTekton Pipeline å®æˆ˜.\né€šå¸¸, CI/CD äº‹ä»¶åº”è¯¥åŒ…å«å¦‚ä¸‹ä¿¡æ¯:\nç¡®å®šäº‹ä»¶çš„ç±»å‹(æ¯”å¦‚ GitHub Push, GitLab Issue, Docker Hub Webhook ç­‰) å¯ä»ç‰¹å®šç®¡é“è®¿é—®å¹¶æ˜ å°„åˆ°ç‰¹å®šç®¡é“ (ä»äº‹ä»¶è´Ÿè½½ä¸­è·å– SHA ä¿¡æ¯, ç„¶ååœ¨ç®¡é“ä¸­ä½¿ç”¨) å‡†ç¡®åœ°è§¦å‘ç®¡é“ (åŸºäºæœ‰æ•ˆè´Ÿè½½å€¼è§¦å‘ç®¡é“) Tekton API çš„è®¾è®¡åˆ†ç¦»äº†é…ç½®(æ¯”å¦‚ PipelineRun VS Pipeline), ä¿è¯äº† step å¯ä»¥è¢«é‡ç”¨. ä½†æ˜¯æ²¡æœ‰æä¾›åŠ¨æ€å°è£…é…ç½®çš„æœºåˆ¶æ¥ç”Ÿæˆèµ„æº(å°¤å…¶æ˜¯ PipelineRun å’Œ PipelineResource). Triggers é€šè¿‡ä¸‹é¢çš„ CRDs åœ¨æ¶æ„ä¸Šå¯¹ Tekton è¿›è¡Œäº†æ‰©å±•:\nTriggerTemplate: åˆ›å»ºèµ„æºçš„æ¨¡æ¿(æ¯”å¦‚ç”¨æ¥åˆ›å»º PipelineResource å’Œ PipelineRun) TriggerBinding: æ ¡éªŒäº‹ä»¶å¹¶æå–è´Ÿè½½å­—æ®µ EventListener: è¿æ¥TriggerBindingå’ŒTriggerTemplateåˆ°å¯å¯»å€çš„ç«¯ç‚¹(äº‹ä»¶æ¥æ”¶å™¨). ä½¿ç”¨ä»å„ä¸ª TriggerBindingä¸­æå–çš„å‚æ•°æ¥åˆ›å»ºTriggerTemplateä¸­æŒ‡å®šçš„ resources. åŒæ ·é€šè¿‡ interceptorå­—æ®µæ¥æŒ‡å®šå¤–éƒ¨æœåŠ¡æ¥å¯¹äº‹ä»¶è´Ÿè½½è¿›è¡Œé¢„å¤„ç†. ClusterTriggerBinding: clusterçº§åˆ«çš„TriggerBinding å®‰è£… kubectl apply --filename https://storage.googleapis.com/tekton-releases/triggers/latest/release.yaml æ£€æŸ¥æ–°å¢çš„ CRD: kubectl api-resources | grep tekton. Triggers å¼•å…¥äº† 3 ä¸ª CRD: TriggerTemplate, TriggerBinding,EventListener.\næ£€æŸ¥æ–°å¢çš„ deployment: tekton-triggers-webhook, tekton-triggers-controller.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/tekton-trigger-glance/","tags":["DevOps","Tekton","Kubernetes"],"title":"Tekton Trigger ä»‹ç»"},{"categories":["æ•™ç¨‹"],"contents":"Tekton æä¾›äº†dashboardæ–¹ä¾¿ç”¨æˆ·ç®¡ç†å’ŒæŸ¥çœ‹ Tekton PipelineRun å’Œ TaskRun ä»¥åŠåˆ›å»º, æ‰§è¡Œå’Œå®Œæˆè¿‡ç¨‹ä¸­æ¶‰åŠçš„èµ„æº. å®ƒè¿˜å…è®¸æŒ‰æ ‡ç­¾è¿‡æ»¤ PipelineRun å’Œ TaskRun.\nå®‰è£…æ–¹æ³• kubectl apply --filename https://github.com/tektoncd/dashboard/releases/download/v0.4.1/dashboard_latest_release.yaml æ£€æŸ¥dashboardçš„è¿è¡Œæƒ…å†µ, STATUSä¸ºRunningçš„è¯åˆ™è¯´æ˜è¿è¡ŒæˆåŠŸ.\nkubectl get pods --namespace tekton-pipelines è®¿é—® è®¿é—®Tektonçš„Dashboardæœ‰ä¸¤ç§æ–¹å¼, ä¸€ç§æ˜¯é€šè¿‡port-forward, å¦ä¸€ç§æ˜¯é€šè¿‡ingressæ¥è®¿é—®.\nport-forward kubectl port-forward svc/tekton-dashboard 9097 ingress å…ˆæ£€æŸ¥ingressæ˜¯å¦å¼€å¯.\nminikube addon list ... - ingress: enabled ... å¦‚æœæ˜¯disabledçš„è¯, é€šè¿‡å‘½ä»¤minikube addons enable ingress.\næ³¨æ„: è¿™é‡Œæ‹‰å–quay.io/kubernetes-ingress-controller/nginx-ingress-controlleré•œåƒå¯èƒ½æ¯”è¾ƒæ…¢, å»ºè®®ä½¿ç”¨å›½å†…çš„é•œåƒ, æ¯”å¦‚quay.mirrors.ustc.edu.cn/kubernetes-ingress-controller/nginx-ingress-controller\nä¿®æ”¹basic-dashboard-ingress.yamlä¸­çš„hoståœ°å€:\napiVersion: extensions/v1beta1 kind: Ingress metadata: name: tekton-dashboard namespace: tekton-pipelines spec: rules: - host: tekton-dashboard.nip.io http: paths: - backend: serviceName: tekton-dashboard servicePort: 9097 æ‰§è¡Œkubectl apply -f basic-dashboard-ingress.yaml.\nè¿˜æœ‰æœ€åä¸€æ­¥, åœ¨/etc/hostsä¸­æ·»åŠ ä¸€æ¡è§£æx.x.x.x tekton-dashboard.nip.io, ipåœ°å€é€šè¿‡minikube ipæ¥è·å–\næµè§ˆå™¨ä¸­æ‰“å¼€ tekton-dashboard.nip.io\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/tekton-dashboard-installation/","tags":["DevOps","Tekton","Kubernetes"],"title":"Tekton Dashboard å®‰è£…"},{"categories":["äº‘åŸç”Ÿ"],"contents":"ç¿»è¯‘æ•´ç†è‡ª Whatâ€™s New in Tekton 0.9\nåŠŸèƒ½åŠBugä¿®å¤ è„šæœ¬æ¨¡å¼ ä»¥å‰å¦‚æœè¦åœ¨å®¹å™¨é‡Œè¿è¡Œä¸ªç®€å•çš„ bash è„šæœ¬, éœ€è¦è¿™ä¹ˆå†™:\n- name: hello image: ubuntu command: [\u0026#39;bash\u0026#39;] args: - -c - | set -ex echo \u0026#34;hello\u0026#34; åœ¨ 0.9 ä¹‹å, å¯ä»¥æ›´åŠ ç®€å•, ä¸éœ€è¦å†å†™command å’Œè®¨åŒçš„-c.\n- name: hello image: ubuntu script: | #!/bin/bash echo \u0026#34;hello\u0026#34; æ€§èƒ½ é€šè¿‡ä¸€ç³»åˆ—çš„å·¥ä½œ, æ¯ä¸ª PipelineRun çš„è¿è¡Œæ—¶é—´ç¼©çŸ­äº† 5-20 ç§’\nAPI å˜åŒ– ä¸ºäº† beta ç‰ˆæœ¬çš„å‘å¸ƒ, API åšäº†ä¸€äº›è°ƒæ•´:\né•œåƒæ‘˜è¦è¾“å‡ºè·¯å¾„çš„æ ‡å‡†åŒ– Tekton ç›®å‰æä¾›äº†ä¸€ä¸ªæœºåˆ¶ç”¨äºå­˜å‚¨ task æ„å»ºå‡ºçš„é•œåƒçš„æ‘˜è¦. è¿™ä¸ªæœºåˆ¶æ—©äº PipelineResourceå­ç³»ç»Ÿ, å¹¶è¦æ±‚ Task ç¼–å†™è€…é•œåƒè¿™äº›æ‘˜è¦å†™åˆ°æŒ‡å®šçš„ä½ç½®/builder/image-outputs. ä»ç°åœ¨å¼€å§‹, æœ‰äº†è¾“å‡ºèµ„æºçš„æ ‡å‡†è·¯å¾„/workspace/output/\u0026lt;resource-name\u0026gt;\nç®€åŒ–é›†ç¾¤èµ„æº é›†ç¾¤PipelineResourceä½¿ä» Tasks å†…éƒ¨éƒ¨ç½²å’Œä½¿ç”¨ Kubernetes é›†ç¾¤å˜å¾—ç®€å•. å®ƒä¸ºç”¨æˆ·æä¾›äº†å£°æ˜é›†ç¾¤çš„ä½ç½®ä»¥åŠå¦‚ä½•è¿›è¡Œèº«ä»½éªŒè¯çš„æœºåˆ¶. ç„¶åå†æ‰§è¡Œ Task è¿‡ç¨‹ä¸­, ä»–ä»¬ä¼šè‡ªåŠ¨é…ç½®.kubeconfigæ–‡ä»¶, ä»¥ä¾¿ Kubernetes å·¥å…·å¯ä»¥æ‰¾åˆ°è¯¥é›†ç¾¤.\nè¿™ä¸ªç‰ˆæœ¬ä¿å‡½äº†ä¸€äº›æ›´æ”¹, ä½¿é›†ç¾¤ PipelineResourceæ›´æ˜“äºä½¿ç”¨.\nä»¥å‰ç”¨æˆ·å¿…é¡»ä¸¤æ¬¡æŒ‡å®šåå­—å‚æ•°: ä¸€æ¬¡åœ¨èµ„æºåç§°ä¸­æŒ‡å®š, ä¸€æ¬¡ä½œä¸ºèµ„æºå‚æ•°. ç°åœ¨ç¬¬äºŒä¸ªå‚æ•°ä¸éœ€è¦äº†.\nåŸºç¡€å·¥ä½œ æ¯ä¸ªTektonç‰ˆæœ¬ä¸­åŒ…å«çš„å¤§éƒ¨åˆ†å·¥ä½œéƒ½æ˜¯é’ˆå¯¹æŸäº›åŠŸèƒ½çš„, è¿™äº›åŠŸèƒ½è¦ç­‰åˆ°ä»¥åçš„ç‰ˆæœ¬æ‰èƒ½å…¬å¼€.å†µã€‚\næ”¹è¿›çš„ PipelineResource æºäºPipeline Resource Redesign\nAPI çš„ç‰ˆæœ¬æ§åˆ¶ æºäºCreate a v1alpha2 apiVersion\nç‹¬ç«‹çš„åŒ… Tektoné¡¹ç›®å‘å±•æƒŠäºº. é™¤äº†è¿™é‡Œæåˆ°çš„Pipelineæ›´æ–°, å…¶ä»–æ¯”å¦‚Triggers, CLI, Dashboardä¹Ÿæœ‰æ˜¾è‘—çš„æˆæœ.\nTriggers ç°åœ¨æ”¯æŒå¼€ç®±å³ç”¨çš„ Github å’Œ Gitlab æ ¡éªŒ. CLIåŠ å…¥äº†äº¤äº’å¼åˆ›å»ºPipelineResourceå’Œå¯åŠ¨ task çš„æ”¯æŒ. Dashboard æ¥ä¸‹æ¥ä¹Ÿä¼šå‡å¦‚å¯è§†åŒ–ç‰¹æ€§.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/tekton-0.9.0-release/","tags":["DevOps","Tekton"],"title":"Tekton 0.9.0 æ›´æ–°"},{"categories":["æ•™ç¨‹"],"contents":"å®‰è£… kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml æ£€æŸ¥å®‰è£…çš„tektonç›¸å…³çš„CRD:\nkubectl api-resources | grep tekton clustertasks tekton.dev false ClusterTask conditions tekton.dev true Condition pipelineresources tekton.dev true PipelineResource pipelineruns pr,prs tekton.dev true PipelineRun pipelines tekton.dev true Pipeline taskruns tr,trs tekton.dev true TaskRun tasks tekton.dev true Task tektonçš„ä¸¤ä¸ªpod:\nkubectl get pods --namespace tekton-pipelines NAME READY STATUS RESTARTS AGE tekton-pipelines-controller-556d8f4494-2qthv 1/1 Running 0 11m tekton-pipelines-webhook-849cff5cf-8m5qq 1/1 Running 0 11m å®‰è£…CLI cli: https://github.com/tektoncd/cli#installing-tkn\nbrew install tektoncd-cli Tekton: hello world åˆ›å»ºä¸€ä¸ªç®€å•çš„Task, åªæœ‰ä¸€ä¸ªstepå°±æ˜¯æ‰“å°å‡º\u0026quot;hello world\u0026quot;\napiVersion: tekton.dev/v1alpha1 kind: Task metadata: name: echo-hello-world spec: steps: - name: echo image: alpine command: - echo args: - \u0026#34;hello world\u0026#34; åˆ›å»ºä¸€ä¸ªTaskRunæ‰§è¡Œä¸Šé¢çš„Task\napiVersion: tekton.dev/v1alpha1 kind: TaskRun metadata: name: echo-hello-world-task-run spec: taskRef: name: echo-hello-world è¿è¡Œtask:\nkubectl apply -f \u0026lt;name-of-file.yaml\u0026gt; æ£€æŸ¥TaskRunçš„è¾“å‡º, æ‰§è¡Œå‘½ä»¤:\ntkn taskrun describe echo-hello-world-task-run Name: echo-hello-world-task-run Namespace: tekton-pipelines Task Ref: echo-hello-world Status STARTED DURATION STATUS 21 minutes ago 1 minute Succeeded Input Resources No resources Output Resources No resources Params No params Steps NAME STATUS echo Completed SucceededçŠ¶æ€è¡¨ç¤ºtaskæ‰§è¡ŒæˆåŠŸ.\næŸ¥çœ‹å®é™…çš„è¾“å‡º, æ‰§è¡Œå‘½ä»¤:\ntkn taskrun logs echo-hello-world-task-run ç»“æœ:\n[echo] hello world ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/tekton-installation-and-sample/","tags":["Kubernetes","DevOps","Tekton"],"title":"Tektonå®‰è£…åŠHello world"},{"categories":["äº‘åŸç”Ÿ"],"contents":"å‡†å¤‡ æ³¨æ„: istioctlçš„å®‰è£…è¦ä½¿ç”¨å®‰è£…é‡Œçš„, ä¸è¦æ˜¯ç”¨homebrewé‡Œçš„. github issue\ncurl -L https://istio.io/downloadIstio | sh - cd istio-1.4.2 cp bin/istioctl /usr/local/bin/istioctl å®‰è£…å‰æ£€æŸ¥ istioctl verify-install å¦‚æœæ£€æŸ¥æ²¡é—®é¢˜, ä¼šçœ‹åˆ°Install Pre-Check passed! The cluster is ready for Istio installation.\nå®‰è£… istioæœ‰5ç§å†…å»ºçš„å®‰è£…é…ç½®1: remote, sds, default, demo, minimal\nistioctl profile list minimal: ä½¿ç”¨istioçš„æµé‡ç®¡ç†æ‰€éœ€ç»„ä»¶çš„æœ€å°åŒ–å®‰è£… default: æ ¹æ®IstioControlPlane APIçš„é»˜è®¤è®¾ç½®(å»ºè®®ç”¨äºç”Ÿäº§éƒ¨ç½²)å¯ç”¨ç»„ä»¶. æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œå‘½ä»¤istioctl profile dumpæ˜¾ç¤ºé»˜è®¤è®¾ç½®. demo: å‡ ä¹å®‰è£…æ‰€æœ‰çš„ç‰¹æ€§, åŒ…æ‹¬loggingå’Œtracingçš„æ¯”ä¾‹ä¸º100%. ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ, è´Ÿè½½å¤ªé‡ default demo minimal sds remote Core components istio-citadel X X X X istio-egressgateway X istio-galley X X X istio-ingressgateway X X X istio-nodeagent X istio-pilot X X X X istio-policy X X X istio-sidecar-injector X X X X istio-telemetry X X X Addons grafana X istio-tracing X kiali X prometheus X X X demo profileå®‰è£…\nistioctl manifest apply --set profile=demo éªŒè¯å®‰è£…ç»“æœ\nistioctl manifest generate --set profile=demo \u0026gt; /tmp/generated-manifest.yaml istioctl verify-install -f /tmp/generated-manifest.yaml \u0026hellip;\u0026hellip; Checked 23 crds Checked 9 Istio Deployments Istio is installed successfully\nå¸è½½ helm template install/kubernetes/helm/istio --namespace istio-system \\ --values install/kubernetes/helm/istio/values-istio-demo.yaml | kubectl delete -f - kubectl delete namespace istio-system #delete all CRDs kubectl delete -f install/kubernetes/helm/istio-init/files è¿™é‡Œå¯ä»¥æŸ¥çœ‹å„ä¸ªé…ç½®çš„è¯¦ç»†è¯´æ˜\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/install-istio-on-minikube/","tags":["Kubernetes","Istio","Service Mesh"],"title":"Minikubeå®‰è£…istio"},{"categories":["ç¿»è¯‘"],"contents":"æœ¬æ–‡ç¿»è¯‘è‡ªThe Mystery of Eureka Self-Preservation\næ ¹æ®CAPå®šç†, Eurekaæ˜¯ä¸€ä¸ªAPç³»ç»Ÿ, è¿™å°±å¯¼è‡´äº†åœ¨ç½‘ç»œåˆ†åŒºæœŸé—´å¤šä¸ªæ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯ä¸ä¸€è‡´. è‡ªæˆ‘ä¿æŠ¤åŠŸèƒ½åˆ™æ˜¯ä¸ºäº†å°½å¯èƒ½é™ä½è¿™ç§ä¸ä¸€è‡´.\nè‡ªæˆ‘ä¿æŠ¤çš„å®šä¹‰ è‡ªæˆ‘ä¿æŠ¤(self preservation)æ˜¯Eurekaçš„ä¸€é¡¹åŠŸèƒ½, Eurekaæ³¨å†Œè¡¨åœ¨æœªæ”¶åˆ°å®ä¾‹çš„å¿ƒè·³æƒ…å†µè¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶åœæ­¢é©±é€è¿‡æœŸçš„å®ä¾‹.\nä»ä¸€ä¸ªå¥åº·çš„ç³»ç»Ÿå¼€å§‹ æŠŠä¸‹é¢çœ‹æˆä¸€ä¸ªå¥åº·çš„ç³»ç»Ÿ\nå‡è®¾æ‰€æœ‰çš„å¾®æœåŠ¡éƒ½å¤„äºå¥åº·çš„çŠ¶æ€å¹¶æˆåŠŸæ³¨å†Œåˆ°Eurekaæ³¨å†Œè¡¨ä¸­.\nå¤šä¸ªæ³¨å†Œè¡¨é—´ä¼šåŒæ­¥æ³¨å†Œè¡¨è®°å½•, æ‰€æœ‰çš„å¾®æœåŠ¡å®ä¾‹éƒ½å¤„äºUPçŠ¶æ€. å‡è®¾å®ä¾‹2ä»æ³¨å†Œä¸­å¿ƒå‘ç°é‡Œå®ä¾‹4, å¹¶è°ƒç”¨å®ä¾‹4ä¸Šçš„æœåŠ¡.\nçªå‘ç½‘ç»œåˆ†åŒº å‡è®¾å‡ºç°äº†ç½‘ç»œåˆ†åŒº, ç³»ç»Ÿå˜æˆä¸‹é¢çš„çŠ¶æ€.\nç”±äºç½‘ç»œåˆ†åŒº, å®ä¾‹4å’Œ5ä¸¢å¤±äº†æ³¨å†Œä¸­å¿ƒçš„è¿æ¥, ä½†æ˜¯å®ä¾‹2ä»ç„¶å¯ä»¥è¿æ¥åˆ°å®ä¾‹4. EurekaæœåŠ¡ç«¯å› ä¸ºæ²¡æœ‰æ”¶åˆ°å®ä¾‹4å’Œ5çš„å¿ƒè·³(è¶…è¿‡ä¸€å®šæ—¶é—´å), å°†ä»–ä»¬é©±é€. ç„¶åEurekaæœåŠ¡ç«¯æ„è¯†åˆ°çªç„¶ä¸¢å¤±äº†è¶…è¿‡15%(2/5)çš„å¿ƒè·³, å› æ­¤å…¶è¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼\nä»æ­¤æ—¶å¼€å§‹, EurekaæœåŠ¡ç«¯ä¸åœ¨é©±é€ä»»ä½•å®ä¾‹, å³ä½¿å®ä¾‹çœŸæ­£çš„ä¸‹çº¿äº†.\nå®ä¾‹3ä¸‹çº¿, ä½†å…¶å§‹ç»ˆå­˜åœ¨æ³¨å†Œè¡¨ä¸­.\nä½†æ­¤æ—¶æ³¨å†Œè¡¨è¿˜ä¼šæ¥å—æ–°å®ä¾‹çš„æ³¨å†Œ.\nè‡ªæˆ‘ä¿æŠ¤çš„åŸºæœ¬åŸç† è‡ªæˆ‘ä¿æŠ¤åŠŸèƒ½åœ¨ä¸‹é¢ä¸¤ç§æƒ…å†µä¸‹æ˜¯åˆç†çš„:\nEurekaæœåŠ¡ç«¯å› ä¸ºå¼±ç½‘åˆ†åŒºé—®é¢˜æ²¡æœ‰æ”¶åˆ°å¿ƒè·³(è¿™å¹¶ä¸æ„å‘³ç€å®¢æˆ·ç«¯ä¸‹çº¿), ä½†æ˜¯è¿™ç§é—®é¢˜å¯èƒ½ä¼šå¾ˆå¿«è¢«ä¿®å¤. å³ä½¿EurekaæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„è¿æ¥æ–­å¼€, å®¢æˆ·ç«¯é—´è¿˜å¯ä»¥ç»§ç»­ä¿æŒè¿æ¥. (æ¯”å¦‚ä¸Šé¢å®ä¾‹2ä»ç„¶å¯ä»¥è¿æ¥åˆ°å®ä¾‹4) é…ç½® (é»˜è®¤) ä¸‹é¢çš„é…ç½®ä¼šç›´æ¥æˆ–é—´æ¥å½±å“åˆ°è‡ªæˆ‘ä¿æŠ¤çš„è¡Œä¸º.\neureka.instance.lease-renewal-interval-in-seconds = 30 å®¢æˆ·ç«¯å‘é€å¿ƒè·³çš„é¢‘ç‡. æœåŠ¡ç«¯ä¼šä»¥æ­¤åœ¨è®¡ç®—æœŸæœ›æ”¶åˆ°å¿ƒè·³æ•°, é»˜è®¤30ç§’\neureka.instance.lease-expiration-duration-in-seconds = 90 å¤šé•¿æ—¶é—´æœªæ”¶åˆ°å¿ƒè·³å, å®ä¾‹æ‰å¯ä»¥è¢«é©±é€, é»˜è®¤90ç§’\neureka.server.eviction-interval-timer-in-ms = 60 * 1000 EurekaæœåŠ¡ç«¯é©±é€æ“ä½œçš„æ‰§è¡Œé¢‘ç‡, é»˜è®¤60ç§’\neureka.server.renewal-percent-threshold = 0.85 æœŸæœ›å¿ƒè·³æ•°è¾¾åˆ°è¯¥é˜ˆå€¼å, å°±ä¼šè¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼, é»˜è®¤0.85\neureka.server.renewal-threshold-update-interval-ms = 15 * 60 * 1000 æœŸæœ›å¿ƒè·³æ•°çš„è®¡ç®—é—´éš”, é»˜è®¤15åˆ†é’Ÿ\neureka.server.enable-self-preservation = true æ˜¯å¦å…è®¸EurekaæœåŠ¡ç«¯è¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼, é»˜è®¤å¼€å¯\nç†è§£é…ç½® EurekaæœåŠ¡ç«¯åœ¨\u0026quot;ä¸Šä¸€åˆ†é’Ÿå®é™…æ”¶åˆ°çš„å¿ƒè·³æ•°\u0026quot;å°äº\u0026quot;æ¯åˆ†é’ŸæœŸæœ›çš„å¿ƒè·³æ•°\u0026quot;æ—¶å°±ä¼šè¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼\næœŸæœ›çš„æ¯åˆ†é’Ÿå¿ƒè·³æ•° å‡è®¾renewal-percent-thresholdè®¾ç½®ä¸º0.85\nè®¡ç®—æ–¹å¼:\nå•ä¸ªå®ä¾‹æ¯åˆ†é’ŸæœŸæœ›çš„å¿ƒè·³æ•°æ˜¯: 21 Nä¸ªå®ä¾‹çš„æ¯åˆ†é’ŸæœŸæœ›çš„å¿ƒè·³æ•°: 2 * N æœŸæœ›çš„ä¸Šä¸€åˆ†é’Ÿæœ€å°å¿ƒè·³æ•°: 2 * N * 0.85 å®é™…çš„æ¯åˆ†é’Ÿå¿ƒè·³æ•° æ­£å¦‚ä¸Šé¢æ‰€è¿°, ä¸¤ä¸ªå®šæ—¶è°ƒåº¦å™¨ç‹¬ç«‹åœ°è¿è¡Œè®¡ç®—å®é™…å’ŒæœŸæœ›çš„å¿ƒè·³æ•°. æ­¤å¤–è¿˜æœ‰å¦ä¸€ä¸ªè°ƒåº¦ä»»åŠ¡EvictionTaskè¿›è¡Œç»“æœæ¯”è¾ƒ, å¹¶è¯†åˆ«å½“å‰ç³»ç»Ÿæ˜¯å¦åœ¨è‡ªæˆ‘ä¿æŠ¤çŠ¶æ€.\nè¿™ä¸ªè°ƒåº¦ä»»åŠ¡æ¯ä¸ªeviction-interval-timer-in-msæ—¶é—´æ‰§è¡Œä¸€æ¬¡, å¹¶å†³å®šæ˜¯å¦é©±é€å®ä¾‹.\nç»“è®º åŸºäºä½¿ç”¨çš„ç»éªŒ, å¤§å¤šæ•°æƒ…å†µä¸‹è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼éƒ½æ˜¯é”™è¯¯çš„, å®ƒé”™è¯¯åœ°è®¤ä¸ºä¸€äº›ä¸‹çº¿çš„å¾®æœåŠ¡å®ä¾‹æ˜¯ä¸è‰¯çš„ç½‘ç»œåˆ†åŒº è‡ªæˆ‘ä¿æŠ¤æ°¸è¿œä¸ä¼šè¿‡æœŸ, é™¤éä¸‹çº¿çš„å®ä¾‹é‡æ–°ä¸Šçº¿ å¦‚æœå¯ç”¨äº†è‡ªæˆ‘ä¿ç•™, åˆ™æ— æ³•å¯¹å®ä¾‹çš„å¿ƒè·³é—´éš”è¿›è¡Œå¾®è°ƒ, å› ä¸ºè‡ªæˆ‘ä¿æŠ¤åœ¨è®¡ç®—æœŸæœ›å¿ƒè·³æ•°æ˜¯æŒ‰ç…§30sé—´éš”æ¥è®¡ç®—çš„ é™¤éç¯å¢ƒä¸­ç»å¸¸å‡ºç°ç±»ä¼¼çš„ç½‘ç»œåˆ†åŒºæ•…éšœ, å¦åˆ™å»ºè®®å…³é—­ è¿™ä¸ªå€¼æ˜¯å›ºå®šçš„, æºäºé»˜è®¤çš„å¿ƒè·³é—´éš”æ˜¯30s, æ•…æ¯åˆ†é’Ÿ2æ¬¡. è§eureka-core-1.7.2çš„AbstractInstanceRegistryL226\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/translation-the-mystery-of-eurekas-self-preservation/","tags":["Spring"],"title":"ç¥ç§˜çš„ Eureka è‡ªæˆ‘ä¿æŠ¤"},{"categories":["ç¬”è®°","äº‘åŸç”Ÿ"],"contents":"ä»Šå¤©æ¥è¯´è¯´æ—¥å¸¸åœ¨Kuberneteså¼€å‘Javaé¡¹ç›®é‡åˆ°çš„é—®é¢˜.\nå½“æˆ‘ä»¬æ–°å»ºä¸€ä¸ªé¡¹ç›®çš„æ—¶å€™, æ€»æ˜¯é¢ä¸´éœ€è¦æ–°å»ºmanifest, å¹³æ—¶éƒ½æ˜¯copy+paste+modify. èƒ½å¦ä»¥å˜æˆçš„æ–¹å¼æ¥ç”Ÿæˆ?\nå¼€å‘æ—¶çš„æ­¥éª¤ä¹Ÿæ¯”è¾ƒç¹ç: docker build, docker push, kubectl apple, kubectl delete pod. å¯¹äºä¸€ä¸ªJavaåº”ç”¨æ¥è¯´è¿˜å¤šäº†ä¸€æ­¥ç¼–è¯‘. æ“ä½œä¸€æ¬¡è¿˜ok, ä½†æ˜¯ä¸€å¤©åå‡ æ¬¡æ€»ä¼šæœ‰æƒ³åçš„æ„Ÿè§‰. è¿™äº›æ­¥éª¤èƒ½å¦ç®€åŒ–æˆä¸€ä¸ªå‘½ä»¤, ç”šè‡³ä¿®æ”¹äº†ä»£ç è‡ªåŠ¨å°±å®Œæˆä¸Šé¢ä¸€ç³»åˆ—çš„æ“ä½œ?\nå®ç°è¿™äº›æˆ‘ä»¬éœ€è¦å‡ ä¸ªå·¥å…·: dekorate, Jib, Skaffold. å…¶ä¸­Jibä¹Ÿåœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä½¿ç”¨Jibä¸ºJavaåº”ç”¨æ„å»ºé•œåƒä¸­ä»‹ç»è¿‡.\ndekorate Dekorate is a collection of Java compile-time generators and decorators for Kubernetes/OpenShift manifests. Dekorateæ˜¯Javaç¼–è¯‘æ—¶ç”Ÿæˆå’Œè£…é¥°Kubernetes/OpenShiftçš„manifestsçš„å·¥å…·\nå¿«é€Ÿå¼€å§‹ 1. é€šè¿‡ä½¿ç”¨Spring Initializerç”Ÿæˆä¸€ä¸ªé¡¹ç›®(Spring Boot 2.2.2), å¹¶åŠ å…¥ä¾èµ–: \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.dekorate\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;kubernetes-spring-starter\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.10.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; 2. åŠ å…¥ä¸€ä¸ªç®€å•çš„Controller: /** * @author Addo.Zhang * @date 2019/12/22 */ @RestController public class DekorateExampleController { @GetMapping public String hi() { return \u0026#34;Hello World\u0026#34;; } } 3. æ‰§è¡Œå‘½ä»¤mvn clean install, ç„¶ååœ¨target/classes/META-INF/dekorateç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°kubernetes.jsonå’Œkubernetes.ymlä¸¤ä¸ªæ–‡ä»¶. kubernetes.ymlçš„å†…å®¹:\n--- apiVersion: \u0026#34;v1\u0026#34; kind: \u0026#34;Service\u0026#34; metadata: labels: app: \u0026#34;dekorate-example\u0026#34; version: \u0026#34;0.0.1-SNAPSHOT\u0026#34; group: \u0026#34;addo\u0026#34; name: \u0026#34;dekorate-example\u0026#34; spec: ports: - name: \u0026#34;http\u0026#34; port: 8081 targetPort: 8081 selector: app: \u0026#34;dekorate-example\u0026#34; version: \u0026#34;0.0.1-SNAPSHOT\u0026#34; group: \u0026#34;addo\u0026#34; type: \u0026#34;ClusterIP\u0026#34; --- apiVersion: \u0026#34;apps/v1\u0026#34; kind: \u0026#34;Deployment\u0026#34; metadata: labels: app: \u0026#34;dekorate-example\u0026#34; version: \u0026#34;0.0.1-SNAPSHOT\u0026#34; group: \u0026#34;addo\u0026#34; name: \u0026#34;dekorate-example\u0026#34; spec: replicas: 1 selector: matchLabels: app: \u0026#34;dekorate-example\u0026#34; version: \u0026#34;0.0.1-SNAPSHOT\u0026#34; group: \u0026#34;addo\u0026#34; template: metadata: labels: app: \u0026#34;dekorate-example\u0026#34; version: \u0026#34;0.0.1-SNAPSHOT\u0026#34; group: \u0026#34;addo\u0026#34; spec: containers: - env: - name: \u0026#34;KUBERNETES_NAMESPACE\u0026#34; valueFrom: fieldRef: fieldPath: \u0026#34;metadata.namespace\u0026#34; image: \u0026#34;addo/dekorate-example:0.0.1-SNAPSHOT\u0026#34; imagePullPolicy: \u0026#34;IfNotPresent\u0026#34; livenessProbe: failureThreshold: 3 httpGet: path: \u0026#34;/actuator/info\u0026#34; port: 8081 scheme: \u0026#34;HTTP\u0026#34; initialDelaySeconds: 0 periodSeconds: 30 successThreshold: 1 timeoutSeconds: 10 name: \u0026#34;dekorate-example\u0026#34; ports: - containerPort: 8081 name: \u0026#34;http\u0026#34; protocol: \u0026#34;TCP\u0026#34; readinessProbe: failureThreshold: 3 httpGet: path: \u0026#34;/actuator/health\u0026#34; port: 8081 scheme: \u0026#34;HTTP\u0026#34; initialDelaySeconds: 0 periodSeconds: 30 successThreshold: 1 timeoutSeconds: 10 ymlä¸­åŒ…å«äº†Serviceå’ŒDeploymentä¸¤éƒ¨åˆ†, dekorateå®Œç¾å…¼å®¹çš„Spring:\napp: dekorate-example: é¡¹ç›®å version: 0.0.1-SNAPSHOT: é¡¹ç›®å½“å‰ç‰ˆæœ¬ group: addo: æ˜¯æˆ‘ç³»ç»Ÿå½“å‰ç”¨æˆ·å /actuator/health: Spring Boot 2.2åactuatorçš„health endpoint, ä½œä¸ºreadinessProbe /actuator/info: Spring Boot 2.2åactuatorçš„endpoint, ä½œä¸ºlivenessProbe è¿›é˜¶ å‰é¢ymlçš„å†…å®¹éƒ½æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„, å‡å¦‚æœ‰äº›ç‰¹æ®Šçš„éœ€æ±‚. æ¯”å¦‚ä¿®æ”¹é•œåƒçš„repositoryå³è¿™é‡Œçš„group, å¦‚ä½•æ“ä½œ?\ndekorate.kubernetes.group = addozhang ç»“æœ:\næˆ–è€…ä¿®æ”¹Serviceçš„ç±»å‹ä¸ºNodePort\ndekorate.kubernetes.service-type = NodePort é…ç½® dekorationæä¾›äº†ä¸°å¯Œçš„é…ç½®æ¥ä¸ªæ€§åŒ–manifest.\né™¤äº†ä¸Šé¢ä½¿ç”¨çš„é…ç½®æ–‡ä»¶(properties/yaml)çš„æ–¹å¼, è¿˜æä¾›äº†Annotationæ³¨è§£é…ç½®æ–¹å¼.\nimport io.dekorate.kubernetes.annotation.Env; import io.dekorate.kubernetes.annotation.KubernetesApplication; @KubernetesApplication(envVars = @Env(name = \u0026#34;key1\u0026#34;, value = \u0026#34;var1\u0026#34;)) public class Main { public static void main(String[] args) { //Your code goes here } } Jib Jibçš„è¯´æ˜è¯·çœ‹ä¸Šä¸€ç¯‡æ–‡ç« :ä½¿ç”¨Jibä¸ºJavaåº”ç”¨æ„å»ºé•œåƒ\næ’ä»¶é…ç½® ä¸‹é¢æ˜¯é’ˆå¯¹è¯¥é¡¹ç›®æ·»åŠ çš„é…ç½®:\n\u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;com.google.cloud.tools\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jib-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.8.0\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;container\u0026gt; \u0026lt;jvmFlags\u0026gt; \u0026lt;jvmFlag\u0026gt;-Xmx128m\u0026lt;/jvmFlag\u0026gt; \u0026lt;jvmFlag\u0026gt;-Xms64m\u0026lt;/jvmFlag\u0026gt; \u0026lt;/jvmFlags\u0026gt; \u0026lt;labels\u0026gt; \u0026lt;Author\u0026gt;Addo.Zhang\u0026lt;/Author\u0026gt; \u0026lt;/labels\u0026gt; \u0026lt;creationTime\u0026gt;USE_CURRENT_TIMESTAMP\u0026lt;/creationTime\u0026gt; \u0026lt;/container\u0026gt; \u0026lt;from\u0026gt; \u0026lt;image\u0026gt;openjdk:8-jdk-alpine\u0026lt;/image\u0026gt; \u0026lt;/from\u0026gt; \u0026lt;to\u0026gt; \u0026lt;image\u0026gt;addo/dekorate-example\u0026lt;/image\u0026gt; \u0026lt;tags\u0026gt; \u0026lt;tag\u0026gt;latest\u0026lt;/tag\u0026gt; \u0026lt;/tags\u0026gt; \u0026lt;/to\u0026gt; \u0026lt;allowInsecureRegistries\u0026gt;true\u0026lt;/allowInsecureRegistries\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; æ‰§è¡Œå‘½ä»¤mvn compile jib:dockerBuildä¾¿å¯ä»¥ç¼–è¯‘ä»£ç , æ„å»ºé•œåƒå¹¶æ¨é€åˆ°é•œåƒä»“åº“.\nSkaffold Skaffoldä¹Ÿæ˜¯GoogleContainerToolsä¸­çš„ä¸€ä¸ªå·¥å…·.\nSkaffold is a command line tool that facilitates continuous development for Kubernetes applications. You can iterate on your application source code locally then deploy to local or remote Kubernetes clusters. Skaffold handles the workflow for building, pushing and deploying your application. It also provides building blocks and describe customizations for a CI/CD pipeline. Skaffoldæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·, å¯ä¿ƒè¿›Kubernetesåº”ç”¨ç¨‹åºçš„æŒç»­å¼€å‘. å¯ä»¥åœ¨æœ¬åœ°è¿­ä»£åº”ç”¨ç¨‹åºæºä»£ç , ç„¶åéƒ¨ç½²åˆ°æœ¬åœ°æˆ–è¿œç¨‹Kubernetesé›†ç¾¤. Skaffoldå¤„ç†æ„å»º, æ¨é€å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºçš„å·¥ä½œæµç¨‹. å®ƒè¿˜æä¾›äº†æ„å»ºå—å¹¶æè¿°äº†CI/CDç®¡é“çš„è‡ªå®šä¹‰.\nåœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­, é€šè¿‡ä¸Jibçš„è”åŠ¨, å®Œæˆç¼–è¯‘ä»£ç , æ„å»ºé•œåƒ, æ¨é€é•œåƒ, éƒ¨ç½²ä¸€ç³»åˆ—æ“ä½œ.\n![Run](https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/2019-12-23 15.12.24.gif)\næˆªå±ä¸­çš„æ“ä½œ, å› ä¸ºæ²¡æœ‰ä»£ç æ”¹åŠ¨è€Œä¸ç»­æ„å»ºé•œåƒ, Skaffoldç›´æ¥ä»cacheä¸­è·å–é•œåƒå¹¶éƒ¨ç½²åˆ°Kubernetesä¸­.\nSkaffoldæ“ä½œ 1. æ‰§è¡Œå‘½ä»¤skaffold init --XXenableJibInitå¹¶åœ¨æç¤ºå‡ºè¾“å…¥y 2. è¯¥å‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ªåä¸ºskaffold.yamlçš„æ–‡ä»¶ ç”±äºdekorateåŒæ—¶ç”Ÿæˆäº†jsonå’Œyamlæ ¼å¼çš„manifest, è¢«skaffoldæ£€æµ‹åˆ°. å®é™…æ“ä½œä¸­åªéœ€è¦å…¶ä¸­ä¸€ä¸ªå³å¯.\napiVersion: skaffold/v1 kind: Config metadata: name: dekorate-example build: artifacts: - image: addo/dekorate-example jib: {} deploy: kubectl: manifests: - target/classes/META-INF/dekorate/kubernetes.json - target/classes/META-INF/dekorate/kubernetes.yml 3. æ‰§è¡Œskaffold run 4. podå¯åŠ¨å®Œæˆå, é€šè¿‡kubectl port-forward PODNAME-HERE 8081 5. è¯·æ±‚http http://localhost:8081 è¿›é˜¶ Skaffoldçš„åŠŸèƒ½å¼ºå¤§, ç›®å‰ä¸ªäººä½¿ç”¨çš„æœ‰é™, æœ‰æ—¶é—´æ–°å¼€ä¸€ç¯‡æ¥å­¦ä¹ ä¸€ä¸‹.\nCLI âœ ~ skaffold help A tool that facilitates continuous development for Kubernetes applications. Find more information at: https://skaffold.dev/docs/getting-started/ End-to-end pipelines: run Run a pipeline dev Run a pipeline in development mode debug [beta] Run a pipeline in debug mode Pipeline building blocks for CI/CD: build Build the artifacts deploy Deploy pre-built artifacts delete Delete the deployed application render [alpha] Perform all image builds, and output rendered Kubernetes manifests Getting started with a new project: init [alpha] Generate configuration for deploying an application fix Update old configuration to newest schema version Other Commands: completion Output shell completion for the given shell (bash or zsh) config Interact with the Skaffold configuration credits Export third party notices to given path (./skaffold-credits by default) diagnose Run a diagnostic on Skaffold version Print the version information Usage: skaffold [flags] [options] Use \u0026#34;skaffold \u0026lt;command\u0026gt; --help\u0026#34; for more information about a given command. Use \u0026#34;skaffold options\u0026#34; for a list of global command-line options (applies to all commands). Yamlé…ç½® å‚è€ƒskaffold.yaml\næ€»ç»“ æ–‡ç« çš„å¼€å¤´æˆ‘ä»¬æåˆ°å¦‚ä½•åšåˆ°ä¿®æ”¹ä»£ç åè‡ªåŠ¨å®Œæˆä¸€äº›åˆ—çš„æ“ä½œ, é€šè¿‡skaffold devå°±å¯ä»¥å®ç°.\næ–‡ç« ä¸­ä½¿ç”¨çš„dekoration-exampleå¯åœ¨GitHubä¸Šæ‰¾åˆ°.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/speed-up-java-development-on-kubernetes/","tags":["Docker","Java","Kubernetes","Tool","äº‘åŸç”Ÿ"],"title":"åŠ é€Ÿäº‘åŸç”Ÿçš„ Java å¼€å‘"},{"categories":["ç¬”è®°"],"contents":"\nJibæ˜¯Google Container Toolsä¸­çš„ä¸€ä¸ªå·¥å…·ã€‚\nJib builds optimized Docker and OCI images for your Java applications without a Docker daemon - and without deep mastery of Docker best-practices. It is available as plugins for Maven and Gradle and as a Java library.\nJibæ— éœ€Dockerå®ˆæŠ¤ç¨‹åºå³å¯ä¸ºJavaåº”ç”¨ç¨‹åºæ„å»ºä¼˜åŒ–çš„Dockerå’ŒOCIæ˜ åƒ-æ— éœ€æ·±å…¥äº†è§£Dockeræœ€ä½³å®è·µ. å®ƒå¯ä»¥ä½œä¸ºMavenå’ŒGradleçš„æ’ä»¶ä»¥åŠJavaåº“ä½¿ç”¨.\nä¸Dockeræ„å»ºæµç¨‹æ¯”è¾ƒ Dockeré•œåƒæ„å»ºæµç¨‹:\nJibæ„å»ºæµç¨‹:\n(pic from Google Cloud Platform Blog)\nå¿«é€Ÿå¼€å§‹ æ„å»ºé•œåƒ, å¹¶æ¨é€åˆ°å¯¹åº”çš„é•œåƒä»“åº“, æ¯”å¦‚Docker Hubç­‰, æˆ–è€…è‡ªå»ºä»“åº“.\nmvn compile com.google.cloud.tools:jib-maven-plugin:1.8.0:build -Dimage=\u0026lt;MY IMAGE\u0026gt;\nå‡å¦‚è¦æ„å»ºåˆ°Dockerå®ˆæŠ¤è¿›ç¨‹çš„è¯:\nmvn compile com.google.cloud.tools:jib-maven-plugin:1.8.0:dockerBuild\næ’ä»¶ è®¾ç½® pom.xmlä¸­ä½¿ç”¨jib-maven-pluginæ’ä»¶.\n\u0026lt;project\u0026gt; ... \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; ... \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;com.google.cloud.tools\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jib-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.8.0\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;to\u0026gt; \u0026lt;image\u0026gt;myimage\u0026lt;/image\u0026gt; \u0026lt;/to\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; ... \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; ... \u0026lt;/project\u0026gt; æ’ä»¶é…ç½® \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;com.google.cloud.tools\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jib-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${jib.maven-plugin-version}\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;container\u0026gt; \u0026lt;jvmFlags\u0026gt; \u0026lt;jvmFlag\u0026gt;-Xmx1024m\u0026lt;/jvmFlag\u0026gt; \u0026lt;jvmFlag\u0026gt;-Xms512m\u0026lt;/jvmFlag\u0026gt; \u0026lt;jvmFlag\u0026gt;-XX:NewRatio=1\u0026lt;/jvmFlag\u0026gt; \u0026lt;jvmFlag\u0026gt;-XX:+UseConcMarkSweepGC\u0026lt;/jvmFlag\u0026gt; \u0026lt;jvmFlag\u0026gt;-XX:CMSInitiatingOccupancyFraction=75\u0026lt;/jvmFlag\u0026gt; \u0026lt;jvmFlag\u0026gt;-XX:+UseCMSInitiatingOccupancyOnly\u0026lt;/jvmFlag\u0026gt; \u0026lt;jvmFlag\u0026gt;-XX:ReservedCodeCacheSize=128M\u0026lt;/jvmFlag\u0026gt; \u0026lt;jvmFlag\u0026gt;-XX:ParallelGCThreads=2\u0026lt;/jvmFlag\u0026gt; \u0026lt;jvmFlag\u0026gt;-XX:+ExplicitGCInvokesConcurrent\u0026lt;/jvmFlag\u0026gt; \u0026lt;jvmFlag\u0026gt;-Duser.timezone=Asia/Shanghai\u0026lt;/jvmFlag\u0026gt; \u0026lt;jvmFlag\u0026gt;-Djava.security.egd=file:/dev/./urandom\u0026lt;/jvmFlag\u0026gt; \u0026lt;/jvmFlags\u0026gt; \u0026lt;labels\u0026gt; \u0026lt;Author\u0026gt;Addo.Zhang\u0026lt;/Author\u0026gt; \u0026lt;/labels\u0026gt; \u0026lt;user\u0026gt;apps\u0026lt;/user\u0026gt; \u0026lt;appRoot\u0026gt;/home/apps/local\u0026lt;/appRoot\u0026gt; \u0026lt;workingDirectory\u0026gt;/home/apps/local\u0026lt;/workingDirectory\u0026gt; \u0026lt;creationTime\u0026gt;USE_CURRENT_TIMESTAMP\u0026lt;/creationTime\u0026gt; \u0026lt;/container\u0026gt; \u0026lt;from\u0026gt; \u0026lt;image\u0026gt;PRIVATE_REGISTRY/REPOSITORY/GLOBAL_BASE:1.0.0\u0026lt;/image\u0026gt; \u0026lt;auth\u0026gt; \u0026lt;username\u0026gt;USERNAME\u0026lt;/username\u0026gt; \u0026lt;password\u0026gt;PASSWORD\u0026lt;/password\u0026gt; \u0026lt;/auth\u0026gt; \u0026lt;/from\u0026gt; \u0026lt;to\u0026gt; \u0026lt;image\u0026gt;PRIVATE_REGISTRY/REPOSITORY/${project.artifactId}\u0026lt;/image\u0026gt; \u0026lt;auth\u0026gt; \u0026lt;username\u0026gt;USERNAME\u0026lt;/username\u0026gt; \u0026lt;password\u0026gt;PASSWORD\u0026lt;/password\u0026gt; \u0026lt;/auth\u0026gt; \u0026lt;/to\u0026gt; \u0026lt;allowInsecureRegistries\u0026gt;true\u0026lt;/allowInsecureRegistries\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; æ³¨æ„: å¦‚æœä½ çš„ç§åº“æ˜¯insecureçš„, éœ€è¦æŒ‡å®šallowInsecureRegistriesä¸ºtrue. åŒæ—¶å‘½ä»¤è¡Œæ„å»ºçš„æ—¶å€™æ·»åŠ -DsendCredentialsOverHttp=true\næ›´å¤šçš„é…ç½®å‚è§å®˜æ–¹æ–‡æ¡£\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/build-docker-or-oci-image-with-jib-for-java/","tags":["Docekr","Tool"],"title":"ä½¿ç”¨ Jib ä¸º Java åº”ç”¨æ„å»ºé•œåƒ"},{"categories":["èµ„è®¯"],"contents":"åŸæ–‡\nSpring Cloud Hoxton.RELEASEåŸºäºSpring Boot 2.2.1.RELEASE\næ–‡æ¡£å˜åŒ– Hoxton.RELEASEä½¿ç”¨äº†æ–°çš„é¦–é¡µ, æ–°çš„æ ·å¼ä»¥åŠå•é¡µé¢, å¤šé¡µé¢å’ŒPDFç‰ˆæœ¬.\næ–°çš„è´Ÿè½½å‡è¡¡å™¨å®ç° Hoxton.RELEASEæ˜¯ç¬¬ä¸€ä¸ªåŒ…å«é˜»å¡å’Œéé˜»å¡å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨å®ç°çš„ç‰ˆæœ¬, æ›¿ä»£è¿›å…¥ç»´æŠ¤çŠ¶æ€çš„Netflix Ribbon.\næ­é…BlockingLoadBalancerClientä½¿ç”¨RestTemplate, éœ€è¦åœ¨classpathä¸­å¼•å…¥org.springframework.cloud:spring-cloud-loadbalancer. è¿™ä¸ªä¾èµ–åŒæ ·ç”¨äºä½¿ç”¨äº†@LoadBalanced WebClient.Builderçš„å“åº”å¼åº”ç”¨ä¸­. å”¯ä¸€çš„åŒºåˆ«æ˜¯Spring Cloudä¼šè‡ªåŠ¨é…ç½®ReactorLoadBalancerExchangeFilterFunctionå®ä¾‹. æ›´å¤šå†…å®¹æŸ¥çœ‹æ–‡æ¡£. æ–°çš„ReactorLoadBalancerExchangeFilterFunctionå¯ç”¨äºè‡ªåŠ¨è£…é…å¹¶è‡ªåŠ¨ä¼ é€’ç»™WebClient.Builder(æ–‡æ¡£).\nSpring Cloud Netflix å¢åŠ äº†æ–°çš„ReactiveDiscoveryClient, åŒæ—¶å¢åŠ äº†æ–°çš„Spring Cloud Circuit Breaker APIçš„Hystrixå®ç°. å¢åŠ é…ç½®é¡¹spring.cloud.circuitbreaker.hystrix.enabledæ¥ç¦ç”¨Spring Cloud CircuitBreaker Hystrixçš„è‡ªåŠ¨é…ç½®. Spring Cloud Cloudfoundry æ”¯æŒæ–°çš„ReactiveDiscoveryClient\nSpring Cloud Bus æ–‡æ¡£æ›´æ–°\nSpring Cloud Vault åœ¨Pivotalåº”ç”¨ç¨‹åºæœåŠ¡)ä»¥å‰çš„PCF)ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºå¯ä»¥åˆ©ç”¨å®¹å™¨çš„èº«ä»½æ¥ä½¿ç”¨ä¿é™©æŸœçš„PCFèº«ä»½éªŒè¯æ”¯æŒè¿›è¡Œèº«ä»½éªŒè¯ ä½¿ç”¨X-Vault-Namespaceæ ‡å¤´æ”¯æŒVaultåç§°ç©ºé—´(Vault EnterpriseåŠŸèƒ½) Spring Cloud Kubernetes æ”¯æŒæ–°çš„ReactiveDiscoveryClient\nSpring Cloud Contract å®Œæ•´çš„æ–‡æ¡£é‡å†™ ä¸»è¦æµ‹è¯•ç±»ç”Ÿæˆé‡æ„ ä»Groovyåˆ°Javaçš„å¤§é‡é‡å†™ æ·»åŠ äº†å¯¹ä½¿ç”¨Kotlinå’ŒJavaç¼–å†™åˆåŒçš„æ”¯æŒ åœ¨åˆåŒDSLå’Œè¿è¡Œæ—¶å­˜æ ¹ç”Ÿæˆä¸­æ·»åŠ äº†inProgressæ ‡å¿— å¢åŠ äº†å¯¹ç”Ÿæˆæµ‹è¯•çš„TestNGæ”¯æŒ è®¸å¤šåº“ç‰ˆæœ¬å¢é‡(åŒ…æ‹¬Groovy, WireMockå’ŒPact) Spring Cloud Consul æ”¯æŒæ–°çš„ReactiveDiscoveryClientä»¥åŠConsulçš„ä¸€è‡´æ€§æ¨¡å‹\nSpring Cloud Config æ–°çš„ç¯å¢ƒä»“åº“æ”¯æŒAWS S3 æ·»åŠ äº†è§£å¯†çº¯æ–‡æœ¬å±æ€§çš„åŠŸèƒ½ Spring Cloud Gcp æ·»åŠ BigQueryæ¨¡å— ä¸ºCloud Foundryåˆ›å»ºäº†ä¸€ä¸ªå•ç‹¬çš„å¯åŠ¨å™¨ï¼šspring-cloud-gcp-starter-cloudfoundry å¯ä»¥æµè§ˆå˜æ›´æ—¥å¿—æ–‡æ¡£ä»¥è·å–æ›´å¤šä¿¡æ¯ Spring Cloud Stream ä»annotation-drivenè¿‡åº¦åˆ°äº†æ›´åŠ ç®€å•çš„å‡½æ•°å¼.\nSpring Cloud Stream - demystified and simplified Spring Cloud Stream - functional and reactive Spring Cloud Stream - and Spring Integration Spring Cloud Stream - Event Routing Spring Cloud Commons å¼•å…¥é˜»å¡å’Œéé˜»å¡å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨å®ç°, æ¥æ›¿ä»£è¿›å…¥ç»´æŠ¤çŠ¶æ€çš„Netflix Ribbon.\nSpring Cloud Openfeign Openfeignå‡çº§åˆ°10.4.0 æ”¯æŒSpring Cloud LoadBalancer Spring Cloud Task æ”¯æŒMicrometer æ›´æ–°æ–‡æ¡£ ä½¿ç”¨Spring Batchåˆ†åŒºæ—¶å¯åŠ¨çš„ä»»åŠ¡åº”ç”¨ç°åœ¨åŠ å…¥äº†external-execution-id Spring Cloud Sleuth åŠ å…¥å¯¹æœ€æ–°çš„Brave(åŒ…æ‹¬æ¶ˆæ¯é‡‡æ ·)çš„æ”¯æŒ æ·»åŠ äº†onLastOperator Reactorè·Ÿè¸ªé€‰é¡¹ï¼Œä»¥æé«˜æ€§èƒ½ æ·»åŠ äº†Redisè·Ÿè¸ª å°†é»˜è®¤é‡‡æ ·å™¨è®¾ç½®ä¸ºé™é€Ÿé‡‡æ ·å™¨ æ·»åŠ äº†å¯¹AWS SQSè·Ÿè¸ªçš„æ”¯æŒ å¢åŠ äº†å¯¹Quartzè·Ÿè¸ªçš„æ”¯æŒ æ·»åŠ äº†è¿›ç¨‹å†…ä¼ æ’­æœºåˆ¶ é»˜è®¤ä¸ºZipkinæŠ¥å‘Šçš„MicrometeræŒ‡æ ‡ Spring Cloud AWS Bugä¿®å¤\nSpring Cloud Zookeeper æ”¯æŒæ–°çš„ReactiveDiscoveryClient\nSpring Cloud Security Bugä¿®å¤\nSpring Cloud CurcuitBreaker å¼•å…¥æ–°çš„é¡¹ç›®Spring Cloud CircuitBreaker, è¿™ä¸ªé¡¹ç›®åŒ…å«çš„æŠ½è±¡çš„APIç”¨äºåœ¨é¡¹ç›®ä¸­ä½¿ç”¨æ–­è·¯å™¨. æ”¯æŒè¯¥APIçš„å®ç°:\nResilience4j Spring Retry Hystrix (in spring-cloud-netflix) Sentinel (in spring-cloud-alibaba) æ›´å¤šä¿¡æ¯\næ—¶æ·»åŠ äº†è‡ªåŠ¨é…ç½®, åœ¨ä½¿ç”¨Resilience4Jæ”¶é›†æ–­è·¯å™¨çš„æŒ‡æ ‡æ•°æ® å‡çº§åˆ°Resilience4J 1.1.0 æ·»åŠ é…ç½®é¡¹ç¦ç”¨REsilience4Jçš„è‡ªåŠ¨é…ç½® Spring Cloud Function æ·»åŠ äº†æ›´å¤šæ–°ç‰¹æ€§:\né€æ˜ç±»å‹è½¬æ¢ å‡½æ•°è·¯ç”± å‡½æ•°å‚æ•° æ›´å¤šè¯¦ç»†ä¿¡æ¯\nSpring Cloud Gateway æ”¯æŒæ–°çš„ReactiveDiscoveryClient RSocketæ¨¡å—è¿ç§»åˆ°äº†è‡ªå·±ç»´æŠ¤çš„ä½äºSpring Cloud Incubator organizationé¡¹ç›®ä¸­ é€šè¿‡å¢åŠ çš„ä½¿ç”¨äº†æ–°Spring Cloud CircuitBreakeråº“è¿‡æ»¤å™¨ä¸ºè·¯ç”±æä¾›æ–­è·¯å™¨åŠŸèƒ½ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/spring-cloud-hoxton-release/","tags":["Spring"],"title":"Spring Cloud Hoxtonå‘å¸ƒ"},{"categories":["æŠ˜è…¾"],"contents":"ä¸ºä»€ä¹ˆè¦é™çº§? æ—¢ç„¶å·²ç»æœåˆ°äº†è¿™é‡Œ, ç›¸ä¿¡ä¸ªä¸­åŸå› ä¹Ÿéƒ½æ¸…æ¥š.\næˆ‘çš„QC35ä¸€ä»£, ä¹‹å‰å‡çº§åˆ°äº†3.0.3å›ºä»¶. ç›®å‰å·²æˆåŠŸé™çº§åˆ°äº†1.0.6, ä¸‹é¢çš„æ“ä½œæ­¥éª¤Mac OSXçš„, ä½œè€…ä¹Ÿæä¾›äº†Windowsä¸Šçš„æ“ä½œæ­¥éª¤.\næ“ä½œæ­¥éª¤ ç¡®è®¤å·²ç»å¸è½½Bose Updater GitHubä¸Šä¸‹è½½ä½œè€…å·²ç»æ”¹å¥½çš„6.0.0.4388ç‰ˆæœ¬çš„Bose Updater è§£å‹åå¤åˆ¶åˆ°/Applicationsä¸‹ è¿è¡ŒBose Updaterç¡®è®¤èƒ½å¦æ­£å¸¸è¿è¡Œ é€€å‡º (å³é”®\u0026gt;Exit) æ£€æŸ¥æ˜¯å¦è¿˜æœ‰Bose Updaterçš„è¿›ç¨‹ æ‰“å¼€https://btu.bose.com/ é¡µé¢ä¸Šé€‰æ‹©Launch Bose Updater çœ‹åˆ°ä¸‹é¢ç•Œé¢(å€Ÿç”¨ä½œè€…çš„å›¾)æ—¶, é”®ç›˜ä¸Šä¾æ¬¡æŒ‰: a, d, v, æ–¹å‘ä¸Š, æ–¹å‘ä¸‹ æ¥ä¸‹æ¥ä¼šçœ‹åˆ°ä¸‹é¢ç•Œé¢(å€Ÿç”¨ä½œè€…çš„å›¾) å¯ä»¥ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©ç‰ˆæœ¬è¿›è¡Œå‡/é™çº§ ç­‰å¾…å‡/é™çº§å®Œæˆ å¸è½½æ‰‹æœºapp (æˆ‘æ˜¯å¸è½½äº†, é˜²æ­¢å†æ¬¡æ‰‹è´±) å‚è€ƒ Reddit GitHub ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/bose-qc35-downgrade/","tags":null,"title":"Bose QC35 å›ºä»¶é™çº§"},{"categories":["ç¬”è®°"],"contents":"æ ¹æ®å®˜æ–¹çš„æ–‡æ¡£Docker Desktop on Mac vs. Docker Toolbox, Docker Desktop on Macåªæä¾›äº†UNIX socket/var/run/docker.sock, å¹¶æœªæä¾›tcpçš„ç›‘å¬(é»˜è®¤2375ç«¯å£).\nå¦‚æœä½¿ç”¨linuxçš„é…ç½®æ–¹å¼åœ¨Docker Desktopä¸­é…ç½®host, Docker Desktopå°†æ— æ³•å¯åŠ¨. éœ€è¦å»~/.docker/daemon.jsonä¸­åˆ é™¤hostsé…ç½®æ‰èƒ½æ­£å¸¸å¯åŠ¨.\né€šè¿‡ä¸‹é¢çš„æ–¹å¼æš´éœ²å‡º2375çš„tcp\ndocker run --rm -d -v /var/run/docker.sock:/var/run/docker.sock -p 127.0.0.1:2375:2375 bobrik/socat TCP-LISTEN:2375,fork UNIX-CONNECT:/var/run/docker.sock ç„¶åé€šè¿‡docker versionæŸ¥çœ‹å½“å‰çš„docker engineçš„ç‰ˆæœ¬, æ¯”å¦‚1.40. æŸ¥çœ‹å®˜æ–¹çš„Engine APIæ–‡æ¡£: https://docs.docker.com/engine/api/v1.40\næœç´¢ä¸ªé•œåƒæµ‹è¯•ä¸€ä¸‹:\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/docker-engine-api-on-mac-osx/","tags":null,"title":"Docker Engine API on Mac Osx"},{"categories":["èµ„è®¯"],"contents":"è¯‘è‡ª: https://spring.io/blog/2019/10/16/spring-boot-2-2-0\nç»„ä»¶å‡çº§ Spring AMQP 2.2 Spring Batch 4.2 Spring Data Moore Spring Framework 5.2 Spring HATEOAS 1.0 Spring Integration 5.2 Spring Kafka 2.3 Spring Security 5.2 Spring Session Corn ç¬¬ä¸‰æ–¹åº“å‡çº§ Elasticsearch 6.7 Flyway 6.0 Jackson 2.10 JUnit 5.5 Micrometer 1.3 Reactor Dysprosium Solr 8.0 æ€§èƒ½æå‡ å»¶è¿Ÿåˆå§‹åŒ–(Lazy initialization) æ”¯æŒå¼€å¯å…¨å±€å»¶è¿ŸåŠ è½½spring.main.lazy-initialization. ä»£ä»·:\nåˆæ¬¡å¤„ç†HTTPè¯·æ±‚è€—æ—¶é•¿ æœ¬åº”åœ¨å¯åŠ¨åˆå§‹åŒ–æ—¶å‡ºç°çš„é—®é¢˜, å»¶åå‡ºç° æ›´å¤šå‚è€ƒ: https://spring.io/blog/2019/03/14/lazy-initialization-in-spring-boot-2-2\nJava 13æ”¯æŒ è·ŸéšSpring Framework5.2å¯¹Java 13çš„æ”¯æŒ, Spring Boot 2.2ç°åœ¨ä¹Ÿæ”¯æŒäº†Java13. åŒæ—¶å…¼å®¹Java 11å’Œ8.\nä¸å¯å˜çš„@ConfigurationPropertiesç»‘å®š ç°åœ¨åŠ å…¥äº†åŸºäºæ„é€ å™¨çš„ç»‘å®š, å…è®¸@ConfigurationPropertiesæ ‡æ³¨çš„ç±»ä¸å¯å˜(å±æ€§ä¸å¯å˜).\nå¯é€šè¿‡@ConfigurationPropertiesæ ‡æ³¨ç±», æˆ–è€…ä½¿ç”¨@ConstructorBindingæ ‡æ³¨æ„é€ å™¨æ¥å¼€å¯.\né¢å¤–çš„æ³¨è§£å¦‚@DefaultValue, @DateTimeFormtå¯å¯¹æ„é€ å‚æ•°è¿›è¡Œé…ç½®.\næ›´å¤šå‚è€ƒ: https://docs.spring.io/spring-boot/docs/2.2.0.RELEASE/reference/html/spring-boot-features.html#boot-features-external-config-constructor-binding\nRScoketæ”¯æŒ ä½¿ç”¨æ–°çš„starterspring-boot-starter-rsocketè‡ªåŠ¨é…ç½®.\nSpring Securityçš„RScoketé›†æˆåœ¨classpathä¸­å­˜åœ¨spring-security-rsocketæ—¶è‡ªåŠ¨å®Œæˆé…ç½®.\næ›´å¤šå‚è€ƒ: https://docs.spring.io/spring-boot/docs/2.2.0.RELEASE/reference/html//spring-boot-features.html#boot-features-rsocket\nå¥åº·æŒ‡ç¤ºå™¨åˆ†ç»„ æ”¯æŒå¯¹å¥åº·æŒ‡ç¤ºå™¨(Health Indicator)è¿›è¡Œåˆ†ç»„. æ¯”å¦‚å°†åº”ç”¨éƒ¨ç½²åˆ°Kubernetesæ—¶, å¸Œæœ›é’ˆå¯¹\u0026quot;liveness\u0026quot;å’Œ\u0026quot;readiness\u0026quot;å¯¹æŒ‡ç¤ºå™¨è¿›è¡Œåˆ†ç»„\nmanagement.endpoint.health.group.custom.include=db æ£€æŸ¥æ—¶ä½¿ç”¨localhost:8080/actuator/health/custom\næ›´å¤šå‚è€ƒ: https://docs.spring.io/spring-boot/docs/2.2.0.RELEASE/reference/html//production-ready-features.html#health-groups\nå…¶ä»–å˜åŒ– å‚è€ƒ: https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.2-Release-Notes\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/spring-boot-2-2-0-release/","tags":["Spring","Java"],"title":"Spring Boot 2.2.0 å‘å¸ƒ"},{"categories":["ç¬”è®°"],"contents":"ä¸Šå›è¯´ä¸ºäº†è§£å†³ååé—®é¢˜, å°†zipkin-dependenciesçš„ç‰ˆæœ¬å‡çº§åˆ°äº†2.3.0.\nå¥½æ™¯ä¸é•¿, ä»æŸä¸€å¤©å¼€å§‹ä½œä¸šè¿è¡ŒæŠ¥é”™:\nIssue communicating with driver in heartbeater org.apache.spark.rpc.RpcTimeoutException: Futures timed out after [10000 milliseconds]. This timeout is controlled by spark.executor.heartbeatInterval ... 19/09/18 08:33:20 ERROR Executor: Exception in task 1.0 in stage 1.0 (TID 4) java.lang.OutOfMemoryError: Java heap space ... è§£å†³æ–¹æ¡ˆ æœ€æ–°ç‰ˆæœ¬(2.3.0)ç›®å‰ä¸æ”¯æŒé¢å¤–çš„sparkå’Œelasticsearch-sparkçš„é…ç½®, å·²ç»æäº¤äº†PR\nè¶…æ—¶çš„è§£å†³æ–¹æ¡ˆ: ä¸ºsparkæŒ‡å®šé…ç½®\nspark.executor.heartbeatInterval=600000 spark.network.timeout=600000 OOMè§£å†³æ–¹æ¡ˆ: æ ¹æ®å®é™…æƒ…å†µé€šè¿‡es.input.max.docs.per.partitioné…ç½®executorçš„æ•°é‡. è°ƒæ•´è¿è¡Œå†…å­˜åŠspark.executor.memory\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/zipkin-dependencies-bug-two-timeout-and-oom/","tags":null,"title":"Zipkin dependenciesçš„å‘ä¹‹äºŒ: å¿ƒè·³è¶…æ—¶å’ŒExecutor OOM"},{"categories":["ç¬”è®°"],"contents":"zipkin-dependenciesæ˜¯zipkinè°ƒç”¨é“¾çš„ä¾èµ–åˆ†æå·¥å…·.\nç³»ç»Ÿä¸Šçº¿æ—¶ä½¿ç”¨äº†å½“æ—¶çš„æœ€æ–°ç‰ˆæœ¬2.0.1, è¿è¡Œä¸€å¹´ä¹‹åéšç€æœåŠ¡çš„å¢å¤š, åˆ†æä¸€å¤©çš„æ•°æ®è€—æ—¶è¶Šæ¥è¶Šå¤š. ä»æœ€åˆçš„å‡ åˆ†é’Ÿ, åˆ°æœ€æ…¢çš„å‡ åå°æ—¶(æ•°æ®é‡18m).\næœ€ç»ˆè¿”ç°æ˜¯ç‰ˆæœ¬çš„é—®é¢˜, å‡çº§åˆ°\u0026gt;=2.3.0çš„ç‰ˆæœ¬ä¹‹åååè¿…é€Ÿä¸Šå‡.\næ‰€ä»¥ä¾¿æœ‰äº†issue: Reminder: do NOT use the version before 2.3.0\nä½†è¿™ä¹Ÿå¼•æ¥äº†å¦ä¸€ä¸ªå‘: å¿ƒè·³è¶…æ—¶å’ŒExecutor OOM\nTL;DR ç®€å•æµè§ˆäº†ä¸‹zipkin-dependenciesçš„æºç , 2.0.1å’Œ2.3.2çš„æ¯”è¾ƒå¤§çš„å·®è·æ˜¯ä¾èµ–çš„elasticsearch-sparkçš„ç‰ˆæœ¬. å‰è€…ç”¨çš„æ˜¯6.3.2, åè€…æ˜¯7.3.0.\nå°è¯•åœ¨zipkin-dependencies-2.0.1ä¸­ä½¿ç”¨elasticsearch-spark-7.3.0, å’Œ2.3.2çš„æ€§èƒ½ä¸€ç›´.\né€šè¿‡æ‰“å¼€log4j debugæ—¥å¿—, å‘ç°åˆ°elasticsearch-sparkä¸¤ä¸ªç‰ˆæœ¬çš„è¿è¡Œå·®å¼‚:\n#7.3.0 19/09/05 18:13:14 INFO DAGScheduler: Submitting 3 missing tasks from ShuffleMapStage 0 (MapPartitionsRDD[1] at groupBy at ElasticsearchDependenciesJob.java:185) (first 15 tasks are for partitions Vector(0, 1, 2)) #6.3.2 19/09/05 18:09:56 INFO DAGScheduler: Submitting 214 missing tasks from ShuffleMapStage 0 (MapPartitionsRDD[1] at groupBy at ElasticsearchDependenciesJob.java:185) (first 15 tasks are for partitions Vector(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14)) RestService#findPartitions()L268çš„æºç : 7.3.0 6.3.2 7.x es.input.max.docs.per.partitionä¸ºnull è®¡ç®—å‡ºpartitions=3 (å®é™…åˆ†åŒºæ•°ä¸º3, ä½¿ç”¨æ–¹æ³•#findShardPartitions()) 6.x es.input.use.sliced.partitionsä¸ºtrue, è®¡ç®—å‡ºpartitions=214 (ä½¿ç”¨æ–¹æ³•#findSlicePartitions())\nåœ¨7.xä¸­, å¯ä»¥é€šè¿‡è®¾ç½®es.input.max.docs.per.partitionçš„å€¼æ¥è®¾ç½®åˆ‡ç‰‡æ•°é‡(å¯¹å•ä¸ªpartitionè¿›è¡Œåˆ‡åˆ†, é€šè¿‡å¢åŠ å¹¶è¡Œä»»åŠ¡æ•°é‡æ¥æé«˜åå)\n**è¯¥è¡Œä»£ç çš„commit message: **\nRemove default setting for max documents per partition We added support for sliced scrolls back in 5.0, which allows subdividing scrolls into smaller input splits. there are some cases where the added subdivision of the scroll operations causes high amounts of overhead when reading very large shards. in most cases, shards should be small enough that a regular read operation over them should complete in reasonable time. In order to avoid performance degradation at higher levels, we are removing the default value of 100k from this setting, and instead, checking if it is set. Additionally, the \u0026rsquo;es.input.use.sliced.partitions\u0026rsquo; setting has been removed as it is now redundant.\nå…³è”çš„issue#1196\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/zipkin-dependencies-bug-one/","tags":null,"title":"Zipkin dependenciesçš„å‘ä¹‹ä¸€: è€—æ—¶è¶Šæ¥è¶Šé•¿"},{"categories":["ç¬”è®°"],"contents":"åœ¨kafkaä¸­, topicçš„åˆ†åŒºæ˜¯å¹¶è¡Œè®¡ç®—çš„å•å…ƒ. åœ¨producerç«¯å’Œbrokerç«¯, å¯ä»¥åŒæ—¶å¹¶å‘çš„å†™æ•°æ®åˆ°ä¸åŒçš„åˆ†åŒºä¸­. åœ¨consumerç«¯, Kafkaæ€»æ˜¯å°†æŸä¸ªåˆ†åŒºåˆ†é…ä¸ªä¸€ä¸ªconsumerçº¿ç¨‹. å› æ­¤åŒä¸€ä¸ªæ¶ˆè´¹ç»„å†…çš„å¹¶è¡Œåº¦ä¸åˆ†åŒºæ•°æ¯æ¯ç›¸å…³.\nPartitionåˆ†åŒºæ•°çš„å¤§å°, æ›´å¤šç›´æ¥å½±å“åˆ°æ¶ˆè´¹ç«¯çš„åå(ä¸€ä¸ªåˆ†åŒºåªèƒ½åŒä¸€æ¶ˆè´¹ç»„çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹). åˆ†åŒºæ•°å°, æ¶ˆè´¹ç«¯çš„ååå°±ä½. ä½†æ˜¯å¤ªå¤§ä¹Ÿä¼šæœ‰å…¶ä»–çš„å½±å“\nåŸåˆ™:\næ›´å¤šçš„åˆ†åŒºå¯æé«˜ååé‡ åˆ†åŒºæ•°è¶Šå¤šæ‰“å¼€çš„æ–‡ä»¶å¥æŸ„è¶Šå¤š åˆ†åŒºæ•°è¶Šå¤šé™ä½å¯ç”¨æ€§ æ›´å¤šçš„åˆ†åŒºå¢åŠ ç«¯åˆ°ç«¯çš„å»¶è¿Ÿ å®¢æˆ·ç«¯éœ€è¦æ›´å¤šçš„å†…å­˜ å½’æ ¹ç»“åº•è¿˜æ˜¯å¾—æœ‰ä¸ªåº¦. å¦‚ä½•æ‰¾å‡ºè¿™ä¸ªåº¦?\næœ‰ä¸ªç²—ç•¥çš„è®¡ç®—å…¬å¼: max(t/p, t/c). tå°±æ˜¯æ‰€é¢„æœŸååé‡, pæ˜¯å½“å‰ç”Ÿäº§ç«¯å•ä¸ªåˆ†åŒºçš„åå, é‚£cå°±æ˜¯æ¶ˆè´¹ç«¯å•ä¸ªåˆ†åŒºçš„åå.\næ¯”å¦‚å•ä¸ªpartitionçš„ç”Ÿäº§ç«¯ååæ˜¯200, æ¶ˆè´¹ç«¯æ˜¯100. é¢„æœŸçš„ååæ˜¯500, é‚£ä¹ˆpartitionçš„æ•°é‡å°±æ˜¯5.\nå•ä¸ªåˆ†åŒºçš„ååé€šå¸¸é€šè¿‡ä¿®æ”¹é…ç½®æ¥æå‡, æ¯”å¦‚ç”Ÿäº§ç«¯çš„æ‰¹å¤„ç†å¤§å°, å‹ç¼©ç®—æ³•, acknowledgementç±»å‹, å‰¯æœ¬æ•°ç­‰. è€Œåœ¨æ¶ˆè´¹ç«¯åˆ™æ›´ä¾èµ–äºæ¶ˆæ¯çš„å¤„ç†é€Ÿåº¦.\nå‚è€ƒ Confluentåšå®¢ Linkedinçš„benchmark ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/how-to-choose-topic-partition-count-number-kafka/","tags":["Kafka","Java"],"title":"å¦‚ä½•é€‰æ‹©Kafka Topicçš„åˆ†åŒºæ•°"},{"categories":["ç¬”è®°"],"contents":"ä¸Šä¸€ç¯‡æ—¥å¿—æ›´æ–°è¿˜æ˜¯åœ¨å»å¹´çš„12æœˆ, è‡³ä»Šæœ‰å·®ä¸å¤š10ä¸ªæœˆæ²¡æœ‰æ›´æ–°äº†.\nä¸æ˜¯è¯´æ²¡æœ‰ä¸œè¥¿å¯å†™, è€Œä¸”æƒ³å†™çš„ä¸œè¥¿å¾ˆå¤š. å·¥ä½œå¤ªå¿™, ä¸å¿™çš„æ—¶å€™åˆå¤ªæ‡’, å½’æ ¹ç»“åº•è¿˜æ˜¯å¤ªæ‡’.\nè¿‡å»ä¸€å¹´å¤šéƒ½æ˜¯åœ¨åšåŸºç¡€æ¶æ„æ–¹é¢çš„å·¥ä½œ, å›´ç»•æŠ€æœ¯ä¸­å°å±•å¼€çš„. æœ‰å¾ˆå¤šæŠ€æœ¯éœ€è¦å»å­¦ä¹ , ä¹Ÿæœ‰å¾ˆå¤šé—®é¢˜è¦å¤„ç†. è¿‡ç¨‹ä¸­ä¸€ç›´æœ‰è®°ç¬”è®°çš„ä¹ æƒ¯, æ‰€ä»¥å¯ä»¥å†™çš„ä¸œè¥¿å¾ˆå¤š. ä¸è¿‡æœ‰äº›å±äºå…¬å¸çš„éƒ¨åˆ†è¿˜æ˜¯ä¸èƒ½å†™çš„, å¿…è¦çš„èŒä¸šé“å¾·è¿˜æ˜¯è¦æœ‰çš„.\nç¬”è®°è®°å½•ä¸€ç›´åœ¨ç”¨MWeb, å¹¶ä½¿ç”¨iCloudåŒæ­¥, æœ€è¿‘å‡ ä¸ªæœˆä¹Ÿåœ¨ç»“åˆå¹•å¸ƒæ•´ç†æ€è·¯å’Œå·¥ä½œå®‰æ’. å¥½ç”¨çš„è½¯ä»¶æˆ‘ä¹Ÿæ¯”è¾ƒå–œæ¬¢åˆ†äº«, è®°å¾—æœ€æ—©åœ¨Workpressä¸Šçš„åšå®¢å°±åˆ†äº«äº†å¾ˆå¤šè‡ªå·±å¸¸ç”¨çš„è½¯ä»¶. (æœ‰ç‚¹æ‰¯è¿œäº†~~~)\nMWebæ²¡æœ‰ç»Ÿè®¡åŠŸèƒ½, è¿˜æœ‰ä½¿ç”¨çš„æ˜¯sqlite. ç®€å•sqlæŸ¥è¯¢äº†ä¸‹, ä»å»å¹´è¿™ä»½å·¥ä½œå¼€å§‹æœ‰244ç¯‡ç¬”è®°. ä»Šå¹´åˆ°ç°åœ¨æœ‰109ç¯‡. å½“ç„¶æœ‰äº›ç¬”è®°çš„å†…å®¹æ¯”è¾ƒå°‘, ä¸å¾—ä¸è¯´è¿™ä¸€å¹´å¤šæ”¶è·ç”šå¤š.\nä¸ºä»€ä¹ˆä»Šå¤©åˆå†™äº†è¿™ä¹ˆä¸€ç¯‡, æºäºé˜®ä¸€å³°çš„ç§‘æŠ€çˆ±å¥½è€…å‘¨åˆŠï¼šç¬¬ 69 æœŸ.\nåˆŠé¦–è¯­æ˜¯\u0026quot;ä¸€ä»¶äº‹\u0026quot;åšå¾—å¥½\u0026quot;æ¯”è¾ƒå¥½ï¼Œè¿˜æ˜¯\u0026quot;åšå¾—å¿«\u0026quot;æ¯”è¾ƒå¥½ï¼Ÿ\u0026quot;, ç›´æ¥copyä»–çš„ç»“è®º.\næˆ‘å¾ˆèµåŒä¸€ç¯‡æ–‡ç« çš„ç»“è®ºï¼šåšå¾—å¿«æ›´å¥½ã€‚\nåšå¾—å¿«ä¸ä»…å¯ä»¥è®©ä½ åœ¨å•ä½æ—¶é—´å†…å®Œæˆæ›´å¤šçš„å·¥ä½œï¼Œè€Œä¸” å› ä¸ºä½ å·¥ä½œå¾—å¾ˆå¿«ï¼Œæ‰€ä»¥ä½ ä¼šè§‰å¾—æˆæœ¬ä½ï¼Œä»è€Œå€¾å‘äºåšæ›´å¤šã€‚\nå†™ä¸€ç¯‡åšå®¢ï¼Œä½ å¯èƒ½éœ€è¦ä¸¤å¤©ã€‚è¿™æ˜¯å¾ˆé«˜çš„æ—¶é—´æˆæœ¬ï¼Œä½ è§‰å¾—å¤ªè´µäº†ï¼Œäºæ˜¯ä½ å¾ˆå°‘å†™ã€‚ä½†æ˜¯ï¼Œåšå¥½ä¸€ä»¶äº‹çš„å”¯ä¸€æ–¹æ³•ï¼Œå°±æ˜¯å¤šåšè¿™ä»¶äº‹ã€‚ åšå¾—è¶Šå¿«ï¼Œè¿™ä»¶äº‹çš„æ—¶é—´æˆæœ¬å°±è¶Šä½ï¼Œä½ ä¼šæ„¿æ„åšå¾—æ›´å¤šã€‚\näººä»¬æ€»æ˜¯å€¾å‘äºï¼Œå¤šæ¶ˆè´¹æ—¶é—´æˆæœ¬ä½çš„ä¸œè¥¿ã€‚ç½‘ç«™å¾ˆå¿«ï¼Œå°±ä¼šå¤šè®¿é—®ï¼›æœç´¢å¾ˆå¿«ï¼Œå°±ä¼šå¤šæœç´¢ï¼›æ–‡ç« å¾ˆå®¹æ˜“è¯»æ‡‚ï¼Œå°±ä¼šå¤šè¯»å‡ ç¯‡ã€‚åšå¾—å¿«çš„æ ¸å¿ƒï¼Œå°±æ˜¯è¦è®©æ—¶é—´æˆæœ¬é™ä¸‹æ¥ï¼Œä»è€Œå¤šåšã€‚\nä¹‹å‰å†™åšå®¢çš„æ—¶å€™, ç¡®å®æŠ•å…¥å¾ˆå¤š. ç¬”è®°è®°å½•çš„æ—¶å€™å¾ˆéšæ„, ä½†æ˜¯å‘åˆ°åšå®¢ä¸­åˆè¦èŠ±ä¸å°‘çš„æ—¶é—´æ¥æ•´ç†è¯­è¨€. æ€»æƒ³å†™çš„å¤§è€Œç¾, ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸ªåŸå› å¯¼è‡´å¤§åŠå¹´æ²¡æœ‰æ›´æ–°(å…¶å®ä¹Ÿè¿˜æ˜¯æ‡’), æ¯æ¬¡æƒ³å†™éƒ½å› ä¸ºè¦èŠ±æ—¶é—´è€ŒèŒç”Ÿé€€æ„.\næ‰€ä»¥ä»Šåè¿˜æ˜¯å¤šå†™å†™, å°è€Œç¾.\nè™½ç„¶å¤§åŠå¹´æ²¡æ›´æ–°, è®¿é—®é‡å±…ç„¶è¿˜æœ‰æå‡.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/no-output-in-past-half-year/","tags":["ç”Ÿæ´»"],"title":"åšå®¢æœ€è¿‘åŠå¹´æ²¡ä»€ä¹ˆäº§å‡º"},{"categories":["æºç è§£æ"],"contents":"@Configurationæ³¨è§£ @Configurationæ³¨è§£æŒ‡ç¤ºä¸€ä¸ªç±»å£°æ˜ä¸€ä¸ªæˆ–å¤šä¸ª@Beanæ–¹æ³•, å¹¶ä¸”å¯ä»¥ç”±Springå®¹å™¨å¤„ç†, ä»¥åœ¨è¿è¡Œæ—¶ä¸ºè¿™äº›beanç”Ÿæˆbeanå®šä¹‰å’ŒæœåŠ¡è¯·æ±‚.\nä½¿ç”¨ConfigurationClassParseræ¥å¯¹@Configurationæ ‡æ³¨çš„ç±»è¿›è¡Œè§£æ, å°è£…æˆConfigurationClasså®ä¾‹. å…·ä½“çš„å®ç°é€šè¿‡ConfigurationClassPostProcessoræ¥å®ç°çš„.\nConfigurationClassPostProcessor å®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£, é—´æ¥å®ç°äº†BeanFactorPostProcessoræ¥å£.\n#postProcessBeanDefinitionRegistry(): æ³¨å†Œæ‰€æœ‰ConfigurationClassä¸­çš„BeanDefinition, åŒ…æ‹¬@Beanæ³¨è§£çš„æ–¹æ³•, @ImporResourceå¼•å…¥çš„èµ„æºä¸­å®šä¹‰çš„bean, å’Œ@Importæ³¨è§£å¼•å…¥çš„ImportBeanDefinitionRegistrarä¸­æ³¨å†Œçš„BeanDefinition #postProcessBeanFactory(): åœ¨è¿è¡Œæ—¶ä»¥é€šè¿‡cgligå¢å¼ºçš„ç±»æ¥æ›¿æ¢ConfigurationClass, ä¸ºæœåŠ¡beanè¯·æ±‚åšå‡†å¤‡. å¢å¼ºçš„å®ç°æ˜¯é€šè¿‡ConfigurationClassEnhancerå®Œæˆçš„. æ’å…¥ä¸€ç‚¹, ConfigurationClassEnhancerå®ç°äº†ç›´æ¥ä½¿ç”¨beanæ³¨å†Œæ–¹æ³•æ¥è·å–beançš„æ“ä½œ, æä¾›äº†ä¸€ä¸ªBeanMethodInterceptorçš„å†…éƒ¨ç±»æ¥å®è¡Œ.\n@Configuration public class Config { @Bean public A a() { ... return a; } @Bean public B b() { b.setA(a()); ... return b; } } Full ConfigurationClass VS Lite ConfigurationClass å…ˆè¯´åŒºåˆ«: fullçš„ConfigurationClassä¼šä½¿ç”¨CGLIBè¿›è¡Œå¢å¼º.\næŸ¥çœ‹ç±»ConfigurationClassUtils, å…¶ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•#isFullConfigurationClass()å’Œ#isLiteConfigurationClass().\næ–¹æ³•çš„å®ç°æ˜¯å»æ£€æŸ¥BeanDefinitionä¸­çš„ConfigurationClassPostProcessor.configurationClasså±æ€§, æ˜¯fullè¿˜æ˜¯lite.\nè¿™ä¸ªå±æ€§çš„å€¼åˆæ¥æºäº#checkConfigurationClassCandidate()æ–¹æ³•, å¦‚æœBeanDefinitionä½¿ç”¨çš„æ˜¯@Configurationæ³¨è§£, åˆ™ä¸ºfull; å¦‚æœæ˜¯@Component, @ComponentScan, @Importæˆ–è€…@ImportResourceä¸­çš„ä»»ä½•ä¸€ç§, åˆ™ä¸ºlite. å¦‚æœæ˜¯ConfigurationClass, åˆ™ä¼šç»§ç»­ä¸ºå…¶æ·»åŠ é¡ºåºå±æ€§.\npublic static boolean checkConfigurationClassCandidate(BeanDefinition beanDef, MetadataReaderFactory metadataReaderFactory) { ... if (isFullConfigurationCandidate(metadata)) { beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_FULL); } else if (isLiteConfigurationCandidate(metadata)) { beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_LITE); } else { return false; } // It\u0026#39;s a full or lite configuration candidate... Let\u0026#39;s determine the order value, if any. Map\u0026lt;String, Object\u0026gt; orderAttributes = metadata.getAnnotationAttributes(Order.class.getName()); if (orderAttributes != null) { beanDef.setAttribute(ORDER_ATTRIBUTE, orderAttributes.get(AnnotationUtils.VALUE)); } } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/spring-boot-configuration-annotation/","tags":["Spring","Java"],"title":"Spring Bootæºç åˆ†æ - Configurationæ³¨è§£"},{"categories":null,"contents":"Elasticssearchçš„HTTPåŸºæœ¬è®¤è¯å®ç°æœ‰ä¸¤ç§æ–¹æ¡ˆ: x-packå’Œnginxåå‘ä»£ç†. å‰è€…æ”¶è´¹, åè€…ä¸å¤ªé€‚åˆç”Ÿäº§ä½¿ç”¨. å¦‚æœä»…ä»…æ˜¯å¼€å‘æµ‹è¯•, ç¬¬äºŒç§å®Œå…¨è¶³å¤Ÿ.\nåˆ›å»ºå¯†ç  htpasswd -bc ./passwd [username] [password] Docker compose version: \u0026#39;3\u0026#39; services: elasticsearch: image: elasticsearch:5.5.2 container_name: elasticsearch restart: unless-stopped volumes: - /tmp/elasticsearch:/usr/share/elasticsearch/data nginx: image: nginx:latest container_name: elasticsearch-proxy ports: - 9200:9200 links: - elasticsearch volumes: - ./passwd:/etc/nginx/.passwd - ./default.conf:/etc/nginx/conf.d/default.conf nginxé…ç½®æ–‡ä»¶ upstream es { server elasticsearch:9200; keepalive 15; } server { listen 9200; server_name localhost; access_log /dev/stdout; error_log /dev/stdout; location / { auth_basic \u0026#34;Administratorâ€™s Area\u0026#34;; auth_basic_user_file /etc/nginx/.passwd; proxy_http_version 1.1; proxy_set_header Connection \u0026#34;Keep-Alive\u0026#34;; proxy_set_header Proxy-Connection \u0026#34;Keep-Alive\u0026#34;; proxy_pass http://es; } location /health { access_log off; return 200 \u0026#34;healthy\\n\u0026#34;; } #error_page 404 /404.html; # redirect server error pages to the static page /50x.html # error_page 500 502 503 504 /50x.html; location = /50x.html { root html; } # proxy the PHP scripts to Apache listening on 127.0.0.1:80 # #location ~ \\.php$ { # proxy_pass http://127.0.0.1; #} # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000 # #location ~ \\.php$ { # root html; # fastcgi_pass 127.0.0.1:9000; # fastcgi_index index.php; # fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name; # include fastcgi_params; #} # deny access to .htaccess files, if Apache\u0026#39;s document root # concurs with nginx\u0026#39;s one # #location ~ /\\.ht { # deny all; #} } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/elasticsearch-http-basic-authentication-via-nginx/","tags":["DevOps"],"title":"Nginxå®ç°Elasticsearchçš„HTTPåŸºæœ¬è®¤è¯"},{"categories":["ç¬”è®°"],"contents":"å®‰è£…Docker echo \u0026#34;http://dl-2.alpinelinux.org/alpine/edge/main\u0026#34; \u0026gt; /etc/apk/repositories echo \u0026#34;http://dl-2.alpinelinux.org/alpine/edge/community\u0026#34; \u0026gt;\u0026gt; /etc/apk/repositories echo \u0026#34;http://dl-2.alpinelinux.org/alpine/edge/testing\u0026#34; \u0026gt;\u0026gt; /etc/apk/repositories apk -U --no-cache \\ --allow-untrusted add \\ shadow \\ docker \\ py-pip \\ openrc \\ \u0026amp;\u0026amp; pip install docker-compose rc-update add docker boot å®‰è£…OpenShift Client Tools éœ€è¦å…ˆå®‰è£…glibc\napk --no-cache add ca-certificates wget wget -q -O /etc/apk/keys/sgerrand.rsa.pub https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub wget https://github.com/sgerrand/alpine-pkg-glibc/releases/download/2.28-r0/glibc-2.28-r0.apk apk add glibc-2.28-r0.apk curl --retry 7 -Lo /tmp/client-tools.tar.gz \u0026quot;https://mirror.openshift.com/pub/openshift-v3/clients/3.9.1/linux/oc.tar.gz\u0026quot;\ncurl --retry 7 -Lo /tmp/client-tools.tar.gz \u0026#34;https://mirror.openshift.com/pub/openshift-v3/clients/3.9.1/linux/oc.tar.gz\u0026#34; tar zxf /tmp/client-tools.tar.gz -C /usr/local/bin oc \\ \u0026amp;\u0026amp; rm /tmp/client-tools.tar.gz \\ \u0026amp;\u0026amp; apk del .build-deps # ADDED: Resolve issue x509 oc login issue apk add --update ca-certificates å‚è€ƒ: github issue\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/install-docker-and-openshift-client-tools-in-alpine-container/","tags":["Docker","Openshift"],"title":"Alpineå®¹å™¨å®‰è£…Dockerå’ŒOpenShift Client Tools"},{"categories":["ç¬”è®°"],"contents":"ç›¸å…³é…ç½® #å¦‚æœè·¯ç”±è½¬å‘è¯·æ±‚å‘ç”Ÿè¶…æ—¶(è¿æ¥è¶…æ—¶æˆ–å¤„ç†è¶…æ—¶), åªè¦è¶…æ—¶æ—¶é—´çš„è®¾ç½®å°äºHystrixçš„å‘½ä»¤è¶…æ—¶æ—¶é—´,é‚£ä¹ˆå®ƒå°±ä¼šè‡ªåŠ¨å‘èµ·é‡è¯•. é»˜è®¤ä¸ºfalse. æˆ–è€…å¯¹æŒ‡å®šå“åº”çŠ¶æ€ç è¿›è¡Œé‡è¯• zuul.retryable = true zuul.routes.\u0026lt;route\u0026gt;.retryable = false #åŒä¸€å®ä¾‹ä¸Šçš„æœ€å¤§é‡è¯•æ¬¡æ•°, é»˜è®¤å€¼ä¸º0. ä¸åŒ…æ‹¬é¦–æ¬¡è°ƒç”¨ ribbon.MaxAutoRetries=0 #é‡è¯•å…¶ä»–å®ä¾‹çš„æœ€å¤§é‡è¯•æ¬¡æ•°, ä¸åŒ…æ‹¬ç¬¬ä¸€æ¬¡é€‰çš„å®ä¾‹. é»˜è®¤ä¸º1 ribbon.MaxAutoRetriesNextServer=1 #æ˜¯å¦æ‰€æœ‰æ“ä½œæ‰§è¡Œé‡è¯•, é»˜è®¤å€¼ä¸ºfalse, åªé‡è¯•`GET`è¯·æ±‚ ribbon.OkToRetryOnAllOperations=false #è¿æ¥è¶…æ—¶, é»˜è®¤2000 ribbon.ConnectTimeout=15000 #å“åº”è¶…æ—¶, é»˜è®¤5000 ribbon.ReadTimeout=15000 #æ¯ä¸ªhostçš„æœ€å¤§è¿æ¥æ•° ribbon.MaxHttpConnectionsPerHost=50 #æœ€å¤§è¿æ¥æ•° ribbon.MaxTotalHttpConnections=200 #ä½•ç§å“åº”çŠ¶æ€ç æ‰è¿›è¡Œé‡è¯• ribbon.retryableStatusCodes=404,502 å®ç° SimpleRouteLocator#getRouteè¿”å›çš„routeå¯¹è±¡ä¸­ä¼šå¸¦ä¸Šretryableçš„è®¾ç½®. PreDecorationFilteråœ¨å¯¹RequestContextè¿›è¡Œè£…é¥°çš„æ—¶å€™ä¼šå°†retryableçš„è®¾ç½®é€šè¿‡keyFilterConstants.RETRYABLE_KEYæ³¨å…¥RequestContextä¸­. RibbonRoutingFilter#buildCommandContextä¼šä½¿ç”¨RequestContextçš„retryableè®¾ç½®æ„é€ RibbonCommandContextå¯¹è±¡. RibbonCommandFactoryä½¿ç”¨RibbonCommandContextæ„å»ºå‡ºRibbonCommandå¯¹è±¡. RibbonCommand#runä¸­, å½“retryableä¸ºtrueæ—¶, ä¼šè°ƒç”¨IClientçš„executeæ–¹æ³•å¤„ç†è¯·æ±‚. ä¸ºfalseæ—¶, ä¼šè°ƒç”¨IClientçš„executeWithLoadBalanceræ–¹æ³•æ‰§è¡Œè¯·æ±‚. executeä¼šåœ¨å¤±è´¥æ—¶è¿›è¡Œé‡è¯•(ä¸è¶…è¿‡è¶…æ—¶é™åˆ¶) executeWithLoadBalanceræ–¹æ³•æ˜¯å…ˆé€šè¿‡LoadBalanceré€‰æ‹©å‡ºä¸€ä¸ªServer, ç„¶åæ„å»ºå‡ºè¯·æ±‚åœ°å€. IClient#executeæ‰§è¡Œæ—¶, é€šè¿‡LoadBalancedRetryPolicyFactoryåˆ›å»ºä¸€ä¸ªLoadBalancedRetryPolicyå¯¹è±¡. LoadBalancedRetryPolicyæŒæœ‰ä¸Šé¢ribbon.XXXçš„è®¾ç½®. å½“å“åº”çŠ¶æ€ç ä¸åœ¨ribbon.retryableStatusCodesè®¾ç½®ä¸­, åˆ™ä¼šç›´æ¥è¿”å›å“åº”. å¦‚æœå±äºå¯é‡è¯•çš„å“åº”çŠ¶æ€ç , åˆ™ä¼šå°†å“åº”å°è£…ä¸ºHttpClientStatusCodeExceptionæŠ›å‡º. å¼‚å¸¸è¢«RetryTemplateæ•è·, ç„¶åä½¿ç”¨LoadBalancedRetryPolicyå¯¹å½“å‰çŠ¶æ€(MaxAutoRetries, MaxAutoRetriesNextServer)è®¡ç®—å‡ºèƒ½å¦è¿›è¡Œä¸€æ¬¡é‡è¯•. ç›´è‡³æˆåŠŸ, æˆ–è€…å½“å‰çŠ¶æ€ä¸æ»¡è¶³æ¡ä»¶. ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/ribbon-retry-in-zuul/","tags":["Spring","Java"],"title":"Zuulç½‘å…³Ribboné‡è¯•"},{"categories":["ç¬”è®°"],"contents":"å¼‚å¸¸å¤„ç† Hystrixå¼‚å¸¸ç±»å‹ HystrixRuntimeException HystrixBadRequestException HystrixTimeoutException RejectedExecutionException HystrixRuntimeException HystrixCommandå¤±è´¥æ—¶æŠ›å‡º, ä¸ä¼šè§¦å‘fallback.\nHystrixBadRequestException ç”¨æä¾›çš„å‚æ•°æˆ–çŠ¶æ€è¡¨ç¤ºé”™è¯¯çš„å¼‚å¸¸, è€Œä¸æ˜¯æ‰§è¡Œå¤±è´¥. ä¸å…¶ä»–HystrixCommandæŠ›å‡ºçš„å¼‚å¸¸ä¸åŒ, è¿™ä¸ªå¼‚å¸¸ä¸ä¼šè§¦å‘fallback, ä¹Ÿä¸ä¼šè®°å½•è¿›failureçš„æŒ‡æ ‡, å› è€Œä¹Ÿä¸ä¼šè§¦å‘æ–­è·¯å™¨,\nåº”è¯¥åœ¨ç”¨æˆ·è¾“å…¥å¼•èµ·çš„é”™è¯¯æ˜¯æŠ›å‡º, å¦åˆ™ä¼šå®ƒä¸å®¹é”™å’Œåé€€è¡Œä¸ºçš„ç›®çš„ç›¸æ‚–.\nä¸ä¼šè§¦å‘fallback, ä¹Ÿä¸ä¼šè®°å½•åˆ°é”™è¯¯çš„æŒ‡æ ‡ä¸­, ä¹Ÿä¸ä¼šè§¦å‘æ–­è·¯å™¨.\nRejectedExecutionException çº¿ç¨‹æ± å‘ç”Ÿrejectæ—¶æŠ›å‡º\nHystrixTimeoutException åœ¨HystrixCommand.run()æˆ–è€…HystrixObservableCommand.construct()æ—¶æŠ›å‡º, ä¼šè®°å½•timeoutçš„æ¬¡æ•°. å¦‚æœå¸Œæœ›æŸäº›ç±»å‹çš„å¤±è´¥è¢«è®°å½•ä¸ºtimeout, åº”è¯¥å°†è¿™äº›ç±»å‹çš„å¤±è´¥åŒ…è£…ä¸ºHystrixTimeoutException\nå¼‚å¸¸å¤„ç† ignoreExceptions\nfinal Func1\u0026lt;Throwable, Observable\u0026lt;R\u0026gt;\u0026gt; handleFallback = new Func1\u0026lt;Throwable, Observable\u0026lt;R\u0026gt;\u0026gt;() { @Override public Observable\u0026lt;R\u0026gt; call(Throwable t) { circuitBreaker.markNonSuccess(); Exception e = getExceptionFromThrowable(t); executionResult = executionResult.setExecutionException(e); if (e instanceof RejectedExecutionException) { return handleThreadPoolRejectionViaFallback(e); } else if (t instanceof HystrixTimeoutException) { return handleTimeoutViaFallback(); } else if (t instanceof HystrixBadRequestException) { return handleBadRequestByEmittingError(e); } else { /* * Treat HystrixBadRequestException from ExecutionHook like a plain HystrixBadRequestException. */ if (e instanceof HystrixBadRequestException) { eventNotifier.markEvent(HystrixEventType.BAD_REQUEST, commandKey); return Observable.error(e); } return handleFailureViaFallback(e); } } }; Feignä¸­å“åº”çŠ¶æ€ç å¤„ç† Feignä½¿ç”¨SynchronousMethodHandleråšè¯·æ±‚çš„æ‰§è¡Œå’Œå“åº”çš„å¤„ç†. å“åº”å¤„ç†çš„éƒ¨åˆ†, å¯¹[200, 300)åŒºé—´çš„çŠ¶æ€, ä¼šå°†responseè¿”å›; å¦‚æœæ˜¯404, æ ¹æ®@FeignClientä¸­decode404(é»˜è®¤ä¸ºfalse)å’Œæ–¹æ³•è¿”å›å€¼åˆ¤æ–­æ˜¯å¦ç†”æ–­, å¦‚æœå“åº”è¿”å›404, decodeä¸ºfalse, åŒæ—¶æ–¹æ³•è¿”å›å€¼ä¸æ˜¯void, ä¼šåŒ…è£…æˆFeignExceptionæŠ›å‡º; å…¶ä»–çš„çŠ¶æ€, é€šè¿‡åŒ…è£…æˆFeignExceptionæŠ›å‡º.\nFeignExceptionæ˜¯RuntimeExceptionçš„å®ç°, å¦‚æœæ²¡æœ‰ignoreçš„è¯, ä¼šè®¡å…¥ç†”æ–­å™¨çš„è®¡ç®—ä¸­.\nfinal class SynchronousMethodHandler implements MethodHandler { Object executeAndDecode(RequestTemplate template) throws Throwable { ... if (response.status() \u0026gt;= 200 \u0026amp;\u0026amp; response.status() \u0026lt; 300) { if (void.class == metadata.returnType()) { return null; } else { return decode(response); } } else if (decode404 \u0026amp;\u0026amp; response.status() == 404 \u0026amp;\u0026amp; void.class != metadata.returnType()) { return decode(response); } else { throw errorDecoder.decode(metadata.configKey(), response); } ... } } Ribbonä¸­å“åº”çŠ¶æ€ç å¤„ç† åœ¨Zuulä¸­, è·¯ç”±ä½¿ç”¨Ribbonåšè´Ÿè½½å‡è¡¡, åŒæ—¶ä½¿ç”¨Hystrixåšæ–­è·¯å™¨, ä½¿ç”¨RibbonCommandæ¥å£çš„å®ç°. RibbonCommandçš„å®ç°å¹¶æ²¡æœ‰å¯¹å“åº”ç¼–ç å°è£…å¼‚å¸¸, å› æ­¤ä¹Ÿä¸ä¼šè§¦å‘ç†”æ–­å™¨.\nAbstractRibbonCommandæ˜¯RibbonCommandçš„æŠ½è±¡å®ç°, æ‰€æœ‰å…¶ä»–å®ç°çš„çˆ¶ç±». æ ¸å¿ƒrun()æ–¹æ³•å¹¶æ²¡æœ‰é’ˆå¯¹å“åº”ç¼–ç é‡æ–°å°è£…å¼‚å¸¸.\npublic abstract class AbstractRibbonCommand\u0026lt;LBC extends AbstractLoadBalancerAwareClient\u0026lt;RQ, RS\u0026gt;, RQ extends ClientRequest, RS extends HttpResponse\u0026gt; extends HystrixCommand\u0026lt;ClientHttpResponse\u0026gt; implements RibbonCommand { ... @Override protected ClientHttpResponse run() throws Exception { final RequestContext context = RequestContext.getCurrentContext(); RQ request = createRequest(); RS response; boolean retryableClient = this.client instanceof AbstractLoadBalancingClient \u0026amp;\u0026amp; ((AbstractLoadBalancingClient)this.client).isClientRetryable((ContextAwareRequest)request); if (retryableClient) { response = this.client.execute(request, config); } else { response = this.client.executeWithLoadBalancer(request, config); } context.set(\u0026#34;ribbonResponse\u0026#34;, response); // Explicitly close the HttpResponse if the Hystrix command timed out to // release the underlying HTTP connection held by the response. // if (this.isResponseTimedOut()) { if (response != null) { response.close(); } } return new RibbonHttpResponse(response); } ... } Observable.error(ex)ä¼šæ•è·run()æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸.\npublic abstract class HystrixCommand\u0026lt;R\u0026gt; extends AbstractCommand\u0026lt;R\u0026gt; implements HystrixExecutable\u0026lt;R\u0026gt;, HystrixInvokableInfo\u0026lt;R\u0026gt;, HystrixObservable\u0026lt;R\u0026gt; { ... final protected Observable\u0026lt;R\u0026gt; getExecutionObservable() { return Observable.defer(new Func0\u0026lt;Observable\u0026lt;R\u0026gt;\u0026gt;() { @Override public Observable\u0026lt;R\u0026gt; call() { try { return Observable.just(run()); } catch (Throwable ex) { return Observable.error(ex); } } }).doOnSubscribe(new Action0() { @Override public void call() { // Save thread on which we get subscribed so that we can interrupt it later if needed executionThread.set(Thread.currentThread()); } }); } ... } Hystrix è¶…æ—¶å¤„ç† åœ¨Hystrixç‰ˆæœ¬1.4ä¹‹å‰, Seamphoreç­–ç•¥æ˜¯ä¸æ”¯æŒè¶…æ—¶çš„. ç›®å‰spring-cloud-netflixçš„1.4.4ä¸­ä½¿ç”¨çš„æ˜¯1.5.12\nå¦‚æœå¼€å¯äº†timeout, HystrixCommandä¼šliftä¸€ä¸ªHystrixObservableTimeoutOperatoråˆ°Observableä¸­.\nabstract class AbstractCommand\u0026lt;R\u0026gt; implements HystrixInvokableInfo\u0026lt;R\u0026gt;, HystrixObservable\u0026lt;R\u0026gt; { private Observable\u0026lt;R\u0026gt; executeCommandAndObserve(final AbstractCommand\u0026lt;R\u0026gt; _cmd) { ... Observable\u0026lt;R\u0026gt; execution; if (properties.executionTimeoutEnabled().get()) { execution = executeCommandWithSpecifiedIsolation(_cmd) .lift(new HystrixObservableTimeoutOperator\u0026lt;R\u0026gt;(_cmd)); } else { execution = executeCommandWithSpecifiedIsolation(_cmd); } return execution.doOnNext(markEmits) .doOnCompleted(markOnCompleted) .onErrorResumeNext(handleFallback) .doOnEach(setRequestContext); } } è¿™ä¸ªHystrixObservableTimeoutOperatorä¼šæ·»åŠ æ³¨å†ŒTimeListener. TimeListeneræ˜¯ä»¥tickçš„æ–¹å¼è¿è¡Œ, å³å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»¶è¿ŸexecutionTimeoutInMillisecondsè¿è¡Œ, ç„¶åæ¯æ¬¡åœ¨executionTimeoutInMilliseconds + n * executionTimeoutInMillisecondsæ—¶è¿è¡Œ.\nå¦‚æœåˆ¤æ–­æ“ä½œè¶…æ—¶? çœ‹tickæ–¹æ³•çš„å®ç°, çº¿ç¨‹æ¯æ¬¡è¿è¡Œæ—¶, å°è¯•ä¿®æ”¹Commandçš„çŠ¶æ€ä»NOT_EXECUTEDåˆ°TIMED_OUT. å¦‚æœæˆåŠŸ, è¯´æ˜è¿è¡Œè¶…æ—¶. æœ€åæŠ›å‡ºHystrixTimeoutExceptionå¼‚å¸¸, è¢«handleFallbackå¤„ç†.\n// if we can go from NOT_EXECUTED to TIMED_OUT then we do the timeout codepath // otherwise it means we lost a race and the run() execution completed or did not start if (originalCommand.isCommandTimedOut.compareAndSet(TimedOutStatus.NOT_EXECUTED, TimedOutStatus.TIMED_OUT)) { // report timeout failure originalCommand.eventNotifier.markEvent(HystrixEventType.TIMEOUT, originalCommand.commandKey); // shut down the original request s.unsubscribe(); final HystrixContextRunnable timeoutRunnable = new HystrixContextRunnable(originalCommand.concurrencyStrategy, hystrixRequestContext, new Runnable() { @Override public void run() { child.onError(new HystrixTimeoutException()); } }); timeoutRunnable.run(); //if it did not start, then we need to mark a command start for concurrency metrics, and then issue the timeout } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/hystrix-exception-handling/","tags":["Java","Spring"],"title":"Hystrixå·¥ä½œåŸç†ä¸‰"},{"categories":["ç¬”è®°"],"contents":"éš”ç¦»ç­–ç•¥ çº¿ç¨‹å’Œçº¿ç¨‹æ±  å®¢æˆ·ç«¯(åº“, ç½‘ç»œè°ƒç”¨ç­‰)åœ¨å„è‡ªçš„çº¿ç¨‹ä¸Šè¿è¡Œ. è¿™ç§åšæ³•å°†ä»–ä»¬ä¸è°ƒç”¨çº¿ç¨‹éš”å¼€, å› æ­¤è°ƒç”¨è€…å¯ä»¥ä»ä¸€ä¸ªè€—æ—¶çš„ä¾èµ–è°ƒç”¨\u0026quot;ç¦»å¼€(walk away)\u0026quot;\nHystrixä½¿ç”¨å•ç‹¬çš„, æ¯ä¸ªä¾èµ–çš„çº¿ç¨‹æ± ä½œä¸ºçº¦æŸä»»ä½•ç»™å®šä¾èµ–çš„ä¸€ç§æ–¹å¼, å› æ­¤æ½œåœ¨æ‰§è¡Œçš„å»¶è¿Ÿå°†ä»…åœ¨è¯¥æ± ä¸­ä½¿å¯ç”¨çº¿ç¨‹é¥±å’Œ.\nå¦‚æœä¸è¯•ç”¨çº¿ç¨‹æ± å¯ä»¥ä¿æŠ¤ä½ å…å—æ•…éšœçš„å½±å“, ä½†æ˜¯è¿™éœ€è¦å®¢æˆ·ç«¯å¯ä¿¡ä»»åœ°å¿«é€Ÿå¤±è´¥(ç½‘ç»œè¿æ¥/è¯»å–è¶…æ—¶, é‡è¯•çš„é…ç½®)å¹¶å§‹ç»ˆè¡¨ç°è‰¯å¥½.\nåœ¨Hystrixçš„è®¾è®¡ä¸­, Netflixé€‰æ‹©è¯•ç”¨çº¿ç¨‹å’Œçº¿ç¨‹æ± æ¥è¾¾åˆ°éš”ç¦»çš„ç›®çš„, åŸå› æœ‰:\nå¾ˆå¤šåº”ç”¨ç¨‹åºè°ƒç”¨äº†ç”±å¾ˆå¤šä¸åŒçš„å›¢é˜Ÿå¼€å‘çš„è®¸å¤š(æœ‰æ—¶è¶…è¿‡1000)ä¸åŒçš„åç«¯æœåŠ¡ æ¯ä¸ªæœåŠ¡éƒ½å„è‡ªæä¾›äº†å…¶å®¢æˆ·ç«¯åº“ å®¢æˆ·ç«¯åº“ä¸æ–­åœ°åœ¨æ›´æ–° å®¢æˆ·ç«¯åº“å¯èƒ½è¢«æ·»åŠ ä½¿ç”¨æ–°çš„ç½‘ç»œè°ƒç”¨ å®¢æˆ·ç«¯åº“çš„é€»è¾‘ä¸­å¯èƒ½åŒ…å«é‡è¯•, æ•°æ®è§£æ, ç¼“å­˜(å†…å­˜æˆ–è€…è·¨ç½‘ç»œ)å’Œå…¶ä»–ç±»ä¼¼çš„è¡Œä¸º å®¢æˆ·ç«¯åº“æ›´ç±»ä¼¼äºä¸€ä¸ªé»‘ç›’, å…¶å®ç°ç»†èŠ‚, ç½‘ç»œè®¿é—®æ¨¡å¼, é»˜è®¤é…ç½®ç­‰æ˜¯å¯¹ä½¿ç”¨è€…ä¸é€æ˜çš„ åœ¨å®é™…çš„ç”Ÿäº§é—®é¢˜ä¸­, æ ¹æºç»å¸¸æ˜¯ \u0026ldquo;æœ‰äº›ä¸œè¥¿æ”¹å˜äº†, é…ç½®åº”è¯¥è¢«ä¿®æ”¹\u0026rdquo; æˆ–è€… \u0026ldquo;å®¢æˆ·ç«¯åº“ä¿®æ”¹äº†é€»è¾‘\u0026rdquo; å³ä½¿å®¢æˆ·ç«¯æ²¡æœ‰æ”¹å˜, æœåŠ¡ç«¯è‡ªèº«å‘ç”Ÿäº†å˜ä¼šå‘˜. è¿™ç§å˜åŒ–ä¼šæ˜¯å®¢æˆ·ç«¯è®¾ç½®æ— æ•ˆè€Œå½±å“æ€§èƒ½ç‰¹æ€§ ä¼ é€’ä¾èµ–ä¼šå¼•å…¥å…¶ä»–å®¢æˆ·ç«¯, è¿™äº›å®¢æˆ·ç«¯ä¸æ˜¯å¯é¢„æœŸçš„, ä¹Ÿå¯èƒ½æ²¡æœ‰è¢«æ­£ç¡®åœ°é…ç½® å¤§å¤šæ•°ç½‘ç»œè®¿é—®æ˜¯åŒæ­¥çš„ å¤±è´¥å’Œå»¶è¿Ÿä¹Ÿå¯èƒ½å‘ç”Ÿåœ¨å®¢æˆ·ç«¯, ä¸åªæ˜¯ç½‘ç»œè°ƒç”¨ çº¿ç¨‹æ± çš„ä¼˜åŠ¿ è¯¥åº”ç”¨ç¨‹åºå®Œå…¨å…å—å¤±æ§å®¢æˆ·ç«¯åº“çš„ä¿æŠ¤. ç»™å®šä¾èµ–åº“çš„çº¿ç¨‹æ± å¯ä»¥å¡«æ»¡è€Œä¸ä¼šå½±å“åº”ç”¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†. åº”ç”¨ç¨‹åºå¯ä»¥æ¥å—é£é™©ä½å¾—å¤šçš„æ–°å®¢æˆ·ç«¯åº“. å¦‚æœå‘ç”Ÿé—®é¢˜, å®ƒä¼šä¸å…¶ä»–ä¾èµ–åº“éš”ç¦», ä¸ä¼šå½±å“å…¶ä»–çš„ä¾èµ–åº“ å½“å‘ç”Ÿæ•…éšœçš„å®¢æˆ·ç«¯å†æ¬¡å¥åº·æ—¶, çº¿ç¨‹æ± å°†è¿›è¡Œæ¸…ç†, åº”ç”¨ç¨‹åºä¼šç«‹å³æ¢å¤å¥åº·çš„æ€§èƒ½, è€Œä¸æ˜¯æ•´ä¸ªTomcatå®¹å™¨ä¸å ªé‡è´Ÿçš„é•¿æ—¶é—´æ¢å¤. å¦‚æœå®¢æˆ·ç«¯åº“é…ç½®é”™è¯¯, çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶å†µå°†å¾ˆå¿«è¯æ˜è¿™ä¸€ç‚¹(é€šè¿‡å¢åŠ é”™è¯¯, å»¶è¿Ÿ, è¶…æ—¶, æ‹’ç»ç­‰), å¹¶ä¸”ä½ å¯ä»¥åœ¨ä¸å½±å“åº”ç”¨ç¨‹åºåŠŸèƒ½çš„æƒ…å†µä¸‹å¤„ç†å®ƒ(é€šå¸¸é€šè¿‡åŠ¨æ€å±æ€§è¿›è¡Œå®æ—¶ä¿®æ”¹). å¦‚æœå®¢æˆ·ç«¯æœåŠ¡æ”¹å˜äº†æ€§èƒ½ç‰¹å¾(ç»å¸¸å‘ç”Ÿä¼šä»¥æˆä¸ºä¸€ä¸ªé—®é¢˜), ä»è€Œå¯¼è‡´éœ€è¦è°ƒæ•´å±æ€§(å¢åŠ /å‡å°‘è¶…æ—¶, æ›´æ”¹é‡è¯•ç­‰), è¿™é€šè¿‡çº¿ç¨‹æ± æŒ‡æ ‡(é”™è¯¯, å»¶è¿Ÿ, è¶…æ—¶, æ‹’ç»), å¹¶ä¸”å¯ä»¥åœ¨ä¸å½±å“å…¶ä»–å®¢æˆ·ç«¯, è¯·æ±‚æˆ–ç”¨æˆ·çš„æƒ…å†µä¸‹è¿›è¡Œå¤„ç†. é™¤äº†éš”ç¦»ä¼˜åŠ¿å¤–, æ‹¥æœ‰ä¸“ç”¨çº¿ç¨‹æ± è¿˜æä¾›äº†å†…ç½®å¹¶å‘æ€§, å¯ç”¨äºåœ¨åŒæ­¥å®¢æˆ·ç«¯åº“ä¹‹ä¸Šæ„å»ºå¼‚æ­¥ç‰¹æ€§(ç±»ä¼¼äºNetflix APIåœ¨Hystrixå‘½ä»¤ä¹‹ä¸Šæ„å»ºååº”å¼, å®Œå…¨å¼‚æ­¥çš„Java API). ç®€è€Œè¨€ä¹‹, ç”±çº¿ç¨‹æ± æä¾›çš„éš”ç¦»åŠŸèƒ½å¯ä»¥ä½¿å®¢æˆ·ç«¯åº“å’Œå­ç³»ç»Ÿæ€§èƒ½ç‰¹æ€§çš„ä¸æ–­å˜åŒ–å’ŒåŠ¨æ€ç»„åˆå¾—åˆ°é€‚åº¦å¤„ç†, è€Œä¸ä¼šé€ æˆä¸­æ–­.\næ³¨æ„: å°½ç®¡å•ç‹¬çš„çº¿ç¨‹æä¾›äº†éš”ç¦», ä½†ä½ çš„åº•å±‚å®¢æˆ·ç«¯ä»£ç ä¹Ÿåº”è¯¥æœ‰è¶…æ—¶ å’Œ/æˆ– å“åº”çº¿ç¨‹ä¸­æ–­, ä»¥ä¾¿å®ƒä¸ä¼šæ— é™åˆ¶åœ°é˜»å¡å¹¶ä½¿Hystrixçº¿ç¨‹æ± é¥±å’Œ.\nçº¿ç¨‹æ± çš„ç¼ºç‚¹\nçº¿ç¨‹æ± çš„ä¸»è¦ç¼ºç‚¹æ˜¯å¢åŠ äº†è®¡ç®—å¼€é”€, æ¯ä¸ªCommandçš„æ‰§è¡Œè®¾è®¡åˆ°é˜Ÿåˆ—, è°ƒåº¦å’ŒCommandå•ç‹¬è¿è¡Œçš„çº¿ç¨‹çš„ä¸Šä¸‹æ–‡çš„åˆ‡æ¢.\nåœ¨è®¾è®¡è¿™ä¸ªç³»ç»Ÿæ—¶, Netflixå†³å®šæ¥å—è¿™ç§å¼€é”€, ä»¥æ¢å–å…¶æä¾›çš„å¥½å¤„, å¹¶è®¤ä¸ºå®ƒè¶³å¤Ÿå°, ä¸ä¼šå¯¹æˆæœ¬æˆ–æ€§èƒ½äº§ç”Ÿé‡å¤§å½±å“,.\nçº¿ç¨‹æˆæœ¬\nHystrixåœ¨å­çº¿ç¨‹ä¸Šæ‰§è¡Œconstruct()æˆ–run()æ–¹æ³•æ—¶æµ‹é‡å»¶è¿Ÿ, ä»¥åŠçˆ¶çº¿ç¨‹ä¸Šçš„æ€»ç«¯åˆ°ç«¯æ—¶é—´. é€šè¿‡è¿™ç§æ–¹å¼, ä½ å¯ä»¥çœ‹åˆ°Hystrixå¼€é”€çš„æˆæœ¬(çº¿ç¨‹, æŒ‡æ ‡, æ—¥å¿—è®°å½•, æ–­è·¯å™¨ç­‰).\nNetflix APIæ¯å¤©ä½¿ç”¨çº¿ç¨‹éš”ç¦»å¤„ç†10äº¿å¤šHystrix Commandæ‰§è¡Œ. æ¯ä¸ªAPIå®ä¾‹éƒ½æœ‰40å¤šä¸ªçº¿ç¨‹æ± , æ¯ä¸ªçº¿ç¨‹æ± ä¸­æœ‰5-20ä¸ªçº¿ç¨‹(å¤§å¤šæ•°è®¾ç½®ä¸º10).\nä¿¡å·é‡ ä½ å¯ä»¥ä½¿ç”¨ä¿¡å·é‡(æˆ–è®¡æ•°å™¨)æ¥é™åˆ¶å¯¹ä»»ä½•ç»™å®šä¾èµ–é¡¹çš„å¹¶å‘è°ƒç”¨æ•°é‡, è€Œä¸æ˜¯ä½¿ç”¨çº¿ç¨‹æ± /é˜Ÿåˆ—å¤§å°. è¿™å…è®¸Hystrixåœ¨ä¸ä½¿ç”¨çº¿ç¨‹æ± çš„æƒ…å†µä¸‹å¸è½½è´Ÿè½½. å¦‚æœä½ ä¿¡ä»»ä¸‹å®¢æˆ·ç«¯, è€Œä½ åªæƒ³è¦å¸è½½, ä½ å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•.\nHystrixCommandå’ŒHystrixObservableCommandæ”¯æŒ2ä¸ªåœ°æ–¹çš„ä¿¡å·é‡:\nå›é€€: å½“Hystrixæ‰§è¡Œå›é€€æ—¶, å®ƒæ€»æ˜¯åœ¨è°ƒç”¨Tomcatçº¿ç¨‹ä¸Šæ‰§è¡Œå›é€€ æ‰§è¡Œ: å¦‚æœå°†å±æ€§execution.isolation.strategyè®¾ç½®ä¸ºSEMAPHORE, åˆ™Hystrixå°†ä½¿ç”¨ä¿¡å·è€Œä¸æ˜¯çº¿ç¨‹æ¥é™åˆ¶è°ƒç”¨è¯¥å‘½ä»¤çš„å¹¶å‘çˆ¶çº¿ç¨‹çš„æ•°é‡.\nä½ å¯ä»¥é€šè¿‡åŠ¨æ€å±æ€§æ¥é…ç½®è¿™ä¸¤ç§ä¿¡å·é‡çš„ä½¿ç”¨, è¿™äº›åŠ¨æ€å±æ€§å®šä¹‰äº†å¯ä»¥æ‰§è¡Œå¤šå°‘ä¸ªå¹¶å‘çº¿ç¨‹. åœ¨è°ƒæ•´çº¿ç¨‹æ± å¤§å°æ—¶, ä½ åº”è¯¥ä½¿ç”¨ç±»ä¼¼çš„è®¡ç®—æ¥è°ƒæ•´å®ƒä»¬çš„å¤§å°(å†…å­˜è°ƒç”¨è¿”å›çš„æ¬¡æ¯«ç§’æ—¶é—´å¯ä»¥åœ¨ä¿¡å·é‡ä»…ä¸º1æˆ–2çš„æƒ…å†µä¸‹æ‰§è¡Œè¶…è¿‡5000rps, ä½†é»˜è®¤å€¼ä¸º10).\nä¸€æ—¦è¾¾åˆ°é™åˆ¶, ä¿¡å·é‡æ‹’ç»å°†å¼€å§‹, ä½†å¡«å……ä¿¡å·é‡çš„çº¿ç¨‹ä¸èƒ½ç¦»å¼€.\nç¿»è¯‘è‡ªHow it Works\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/hystrix-isolation/","tags":["Spring","Java"],"title":"Hystrixå·¥ä½œåŸç†äºŒ"},{"categories":["ç¬”è®°"],"contents":"è¿è¡Œæ—¶çš„æµç¨‹å›¾ æ„å»ºHystrixCommandæˆ–è€…HystrixObservableCommandå¯¹è±¡\nç¬¬ä¸€æ­¥æ˜¯æ„å»ºä¸€ä¸ªHystrixCommandæˆ–HystrixObservableCommandå¯¹è±¡æ¥ä»£è¡¨å¯¹ä¾èµ–æœåŠ¡æ‰€åšçš„è¯·æ±‚ã€‚ å°†åœ¨è¯·æ±‚å‘ç”Ÿæ—¶å°†éœ€è¦çš„ä»»ä½•å‚æ•°ä¼ é€’ç»™æ„é€ å‡½æ•°ã€‚\nå¦‚æœä¾èµ–çš„æœåŠ¡é¢„æœŸä¼šè¿”å›å•ä¸€çš„å“åº”, æ„é€ ä¸€ä¸ªHystrixCommandå¯¹è±¡, ä¾‹å¦‚:\nHystrixCommand command = new HystrixCommand(arg1, arg2); å¦‚æœä¾èµ–çš„æœåŠ¡é¢„æœŸä¼šè¿”å›ä¸€ä¸ªå‘å‡ºå“åº”çš„Observableå¯¹è±¡, åˆ™æ„é€ ä¸€ä¸ªHystrixObservableCommandå¯¹è±¡, ä¾‹å¦‚:\nHystrixObservableCommand command = new HystrixObservableCommand(arg1, arg2); æ‰§è¡ŒCommand\nå“åº”æ˜¯å¦è¢«ç¼“å­˜?\nå¦‚æœCommandçš„ç¼“å­˜è¯·æ±‚è¢«å¼€å¯, åŒæ—¶è¯·æ±‚çš„å“åº”åœ¨ç¼“å­˜ä¸­å¯ç”¨, ç¼“å­˜çš„å“åº”è¢«ç«‹å³ä»¥ä¸€ä¸ªObservableçš„æ–¹å¼è¿”å›.\næ–­è·¯å™¨æ˜¯å¦å¼€å¯?\næ‰§è¡ŒCommandæ—¶, Hystrixä¼šæ£€æŸ¥æ–­è·¯å™¨(circuti-breaker)æ˜¯å¦å¼€å§‹å›è·¯(circuit).\nå¦‚æœå›è·¯å¼€å¯, Hystrixå°†ä¸ä¼šæ‰§è¡ŒCommand, è€Œç›´æ¥å»åˆ°æµç¨‹8: Get the Fallback å¦‚æœå…³é—­, åˆ™æ‰§è¡Œæµç¨‹5æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å®¹é‡æ¥è¿è¡Œè¯¥å‘½ä»¤\nçº¿ç¨‹æ± /é˜Ÿåˆ—/é™å·é‡æ˜¯å¦æ»¡?\nå‡å¦‚ä¸Commandç›¸å…³çš„çº¿ç¨‹æ± å’Œé˜Ÿåˆ—(æˆ–è€…ä¿¡å·é‡, ä¸é€‚ç”¨éš”ç¦»çº¿ç¨‹çš„è¯)æ»¡äº†, Hystrixå°†ä¸ä¼šæ‰§è¡ŒCommand, è€Œæ˜¯ç›´æ¥å»åˆ°æµç¨‹8.\nHystrixObservableCommand.construct()æˆ–HystrixCommand.run()\nHystrixä½¿ç”¨ä¸‹é¢ä»»ä¸€çš„æ–¹å¼å‘ä¾èµ–çš„æœåŠ¡å‘å‡ºè¯·æ±‚:\nHystrixCommand.run() è¿”å›å•ä¸ªå“åº”æˆ–æŠ›å‡ºå¼‚å¸¸ HystrixObservableCommand.construct() è¿”å›ä¸€ä¸ªå‘å‡ºå“åº”çš„Observableå¯¹è±¡, æˆ–è€…å‘é€onErroré€šçŸ¥ å¦‚æœrun()æˆ–è€…construct()æ–¹æ³•æ‰§è¡Œè¶…è¿‡Commandçš„è¶…æ—¶è®¾ç½®, çº¿ç¨‹ä¼šæŠ›å‡ºä¸€ä¸ªTimeoutException(æˆ–è€…ç‹¬ç«‹çš„timerçº¿ç¨‹æŠ›å‡º, å¦‚æœCommandä¸æ˜¯è¿è¡Œåœ¨å®ƒè‡ªå·±çš„çº¿ç¨‹ä¸Š). è¿™æ˜¯Hystrixç›´æ¥å»åˆ°æµç¨‹8. è·å–Fallback, å¦‚æœæ²¡æœ‰cancel/interrup, åˆ™æŠ›å¼ƒrun()æˆ–construct()çš„æœ€ç»ˆè¿”å›å€¼.\nè¯·æ³¨æ„, æ²¡æœ‰ä»»ä½•æ–¹æ³•å¯ä»¥å¼ºåˆ¶ä»»åŠ¡çº¿ç¨‹åœæ­¢å·¥ä½œ, æœ€ä½³çš„æ–¹å¼æ˜¯HystrixæŠ›å‡ºä¸€ä¸ªInterruptException. å¦‚æœHystrixå°è£…çš„ä»»åŠ¡å¿½ç•¥InterruptException, è¯¥ä»»åŠ¡çº¿ç¨‹ä¼šç»§ç»­å·¥ä½œ, å³ä½¿å®¢æˆ·ç«¯å·²ç»æ”¶åˆ°äº†ä¸€ä¸ªTimeoutException. è¿™ç§è¡Œä¸ºä¼šæ˜¯Hystrixçš„çº¿ç¨‹æ± é¥±å’Œ, å°½ç®¡è´Ÿè½½æ­£ç¡®åœ°æµå‡º(correctly shed). å¤§å¤šæ•°Java HTTPå®¢æˆ·ç«¯åº“ä¸è§£é‡ŠInterruptedExceptions. å› æ­¤, è¯·ç¡®ä¿åœ¨HTTPå®¢æˆ·ç«¯ä¸Šæ­£ç¡®é…ç½®è¿æ¥å’Œè¯»/å†™è¶…æ—¶.\nå¦‚æœCommandæ‰§è¡Œæ²¡æœ‰è¶…æ—¶è€Œè¿”å›ä¸€ä¸ªå“åº”, Hystrixåœ¨æ‰§è¡ŒæŸäº›æ—¥å¿—è®°å½•å’ŒæŒ‡æ ‡æŠ¥å‘Šä¹‹åè¿”å›è¿™ä¸ªå“åº”.\nè®¡ç®—ç”µè·¯å¥åº·\nHystrixå°†æˆåŠŸ, å¤±è´¥, æ‹’ç»æœåŠ¡å’Œè¶…æ—¶ä¸ŠæŠ¥ç»™æ–­è·¯å™¨, æ–­è·¯å™¨ç»´æŠ¤ç€ä¸€ä¸ªè®¡ç®—ç»Ÿè®¡æ•°æ®çš„è®¡æ•°å™¨.\nå®ƒé€šè¿‡è¿™äº›ç»Ÿè®¡æ•°æ®å†³å®šæ–­è·¯å™¨ä½•æ—¶åº”è¯¥æ‰“å¼€, åœ¨å“ªä¸ªç‚¹å¼€å§‹çŸ­è·¯åç»­çš„è¯·æ±‚çŸ¥é“æ¢å¤æœŸè¿‡å», æˆ–è€…å†³å®šåœ¨ç¬¬ä¸€æ¬¡å¥åº·æ£€æŸ¥è¯·æ±‚ç»“æŸåæ˜¯å¦è¦å…³é—­æ–­è·¯å™¨.\nè·å–Fallback\nåœ¨commandæ‰§è¡Œå¤±è´¥å: å½“run()æˆ–construct()æŠ›å‡ºå¼‚å¸¸(6), commandå› ä¸ºæ–­è·¯å™¨å¼€å¯è€ŒçŸ­è·¯(4), commandçš„çº¿ç¨‹æ± å’Œé˜Ÿåˆ—æˆ–è€…è®¡æ•°å™¨å¤„äºæ»¡è´Ÿè·(6), æˆ–è€…æ‰§è¡Œè¶…æ—¶, Hystrixå°è¯•è½¬å‘ä½ çš„Fallback.\nè¿”å›æˆåŠŸçš„å“åº”\nå¦‚æœCommandå¤„ç†æˆåŠŸ, å®ƒå°†ä»¥Obervableçš„å®è¡Œè¿”å›responseæˆ–è€…responsesç»™è°ƒç”¨è€…. å–å†³äºä¸Šé¢æµç¨‹2ä¸­çš„Commandçš„æ‰§è¡Œæ–¹å¼, è¯¥Observableå¯èƒ½åœ¨è¿”å›ç»™ä½ ä¹‹å‰è¢«è½¬æ¢:\nexecute() - è¿”å›ä¸€ä¸ªFatureå¯¹è±¡, å¯ä»¥é€šè¿‡è°ƒç”¨get()è·å–Obervableè¿”å›çš„å•ä¸ªå€¼ queue() - æŠŠObservableè½¬æ¢ä¸ºBlockingObservable, å› æ­¤BlockingObservableå¯ä»¥è¢«è½¬æ¢æˆFuture, å¹¶è¿”å› observe() - ç†è§£è®¢é˜…Observable, å¹¶å¼€å§‹Commandçš„æ‰§è¡Œæµç¨‹. è¿”å›ä¸€ä¸ªObservable, å½“è®¢é˜…å®ƒæ—¶, é‡æ’­è¿”å›å’Œé€šçŸ¥(replay emissions and notifiactions). toObservable() - ä¸å˜åœ°è¿”å›Observable; å¿…é¡»è®¢é˜…å®ƒæ‰èƒ½çœŸæ­£å¼€å§‹å¯¼è‡´æ‰§è¡Œå‘½ä»¤çš„æµç¨‹. æ›´è¯¦ç»†çš„æµç¨‹å›¾\næ–­è·¯å™¨ å‡è®¾é€šè¿‡æ–­è·¯å™¨çš„è´Ÿè½½è¾¾åˆ°äº†é˜ˆå€¼ (HystrixCommandProperties.circuitBreakerRequestVolumeThreshold()) å‡è®¾é”™è¯¯ç™¾åˆ†æ¯”è¶…è¿‡é”™è¯¯çš„é˜ˆå€¼ (HystrixCommandProperties.circuitBreakerErrorThresholdPercentage()) æ–­è·¯å™¨çŠ¶æ€ä»å…³é—­å˜ä¸ºæ‰“å¼€ æ‰“å¼€å, æ–­è·¯å™¨ä¼šçŸ­è·¯æ‰€æœ‰é’ˆå¯¹è¯¥æ–­è·¯å™¨çš„è¯·æ±‚ è¿‡äº†ä¸€æ®µæ—¶é—´å(HystrixCommandProperties.circuitBreakerSleepWindowInMilliseconds()), ä¸‹ä¸€æ¡è¯·æ±‚ä¼šè¢«æ”¾è¡Œ(åŠå¼€çŠ¶æ€). å¦‚æœè¯·æ±‚å¤±è´¥, æ–­è·¯å™¨é‡å›æ‰“å¼€çŠ¶æ€(OPEN)å¹¶æŒç»­ä¸€ä¸ªç¡çœ çª—å£(sleep window). å¦‚æœæˆåŠŸ, çŠ¶æ€å˜ä¸ºå…³é—­(CLOSED). ä¸‹ä¸ªè¯·æ±‚ä»é€»è¾‘1å¼€å§‹. ç¿»è¯‘è‡ªHystrix Wiki - How it works\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/how-hystrix-works/","tags":["Java"],"title":"Hystrixå·¥ä½œåŸç†ä¸€"},{"categories":["ç¬”è®°"],"contents":"rsyslogdèµ„æºå ç”¨é«˜é—®é¢˜è®°å½• é—®é¢˜: openshifté›†ç¾¤å®‰è£…åœ¨esxiçš„è™šæ‹Ÿæœºä¸Š. å„ä¸ªèŠ‚ç‚¹å‡ºç°é—®é¢˜, é›†ç¾¤å“åº”å¾ˆæ…¢.\nkswapd0è¿›ç¨‹cpu 90%å¤š. rsyslogdè¿›ç¨‹å†…å­˜ 90%å¤š. **å…ˆä¸Šæ€»ç»“: **\nsystem-journalæœåŠ¡ç›‘å¬/dev/logsocketè·å–æ—¥å¿—, ä¿å­˜åœ¨å†…å­˜ä¸­, å¹¶é—´æ­‡æ€§çš„å†™å…¥/var/log/journalç›®å½•ä¸­.\nrsyslogæœåŠ¡å¯åŠ¨åç›‘å¬/run/systemd/journal/syslogsocketè·å–syslogç±»å‹æ—¥å¿—, å¹¶å†™å…¥/var/log/messagesæ–‡ä»¶ä¸­. è·å–æ—¥å¿—æ—¶éœ€è¦è®°å½•æ—¥å¿—æ¡ç›®çš„positionåˆ°/var/lib/rsyslog/imjournal.stateæ–‡ä»¶ä¸­.\nå¯èƒ½æ˜¯è™šæ‹Ÿæœºç³»ç»Ÿå®‰è£…é—®é¢˜, å¯¼è‡´æ²¡æœ‰åˆ›å»º/var/lib/rsyslog. rsyslogå°†å¼‚å¸¸æ—¥å¿—å†™å…¥/dev/logsocketä¸­.\nè¿™æ ·å°±å¯¼è‡´äº†æ­»å¾ªç¯, rsyslogå› ä¸ºè¦æ‰“å¼€/var/log/messageså¹¶å†™å…¥æ—¥å¿—, æ¶ˆè€—cpu, å†…å­˜è¿˜æœ‰ç£ç›˜I/O.\nè¯Šæ–­æ­¥éª¤: rsyslog é‡å¯rsyslogæœåŠ¡\né‡å¯ä¹‹åå†…å­˜å¾—åˆ°é‡Šæ”¾, ä½†æ˜¯rsyslogdè¿›ç¨‹cpuè·‘åˆ°90%å¤š, ä¸”å†…å­˜åœ¨æŒç»­å‡é«˜.\næ£€æŸ¥æœåŠ¡çŠ¶æ€å‘ç°è¿›ç¨‹ä¸€ç›´åœ¨æŠ¥é”™:\nfopen() failed: \u0026#39;Permission denied\u0026#39;, path: \u0026#39;/imjournal.state.tmp\u0026#39; [try http://www.rsyslog.com/e/2013 ] fopen() failed: \u0026#39;Permission denied\u0026#39;, path: \u0026#39;/imjournal.state.tmp\u0026#39; [try http://www.rsyslog.com/e/2013 ] ... æ£€æŸ¥/etc/rsyslog.confä¸­çš„WorkDirectoryè¡Œæ˜¯æ²¡æœ‰è¢«æ³¨é‡Šçš„. æ£€æŸ¥é»˜è®¤å·¥ä½œç›®å½•/var/lib/rsyslog, å‘ç°ç›®å½•ä¸å­˜åœ¨.\nå› æ­¤åˆ›å»º/var/lib/rsyslogç›®å½•, å¹¶èµ‹äºˆ600æƒé™.\nå†æ¬¡é‡å¯rsyslogæœåŠ¡, è§‚å¯Ÿä¸€æ®µæ—¶é—´æ²¡æœ‰é”™è¯¯æŠ›å‡º, /var/lib/rsyslogç›®å½•ä¸‹åˆ›å»ºäº†imjournal.stateæ–‡ä»¶. æ£€æŸ¥æ–‡ä»¶, å†…å®¹ä¸æ–­è¢«åˆ·æ–°. ä½†æ˜¯å ç”¨å†…å­˜è¿˜åœ¨å‡é«˜, /var/log/messagesæ–‡ä»¶ä¸­è¿˜æœ‰é”™è¯¯ä¿¡æ¯å†™å…¥. ä½†æ˜¯é”™è¯¯æ—¥å¿—çš„æ—¶é—´æ˜¯æ¯”è¾ƒæ—©çš„.\nå†æ¬¡æ£€æŸ¥/etc/rsyslog.confé…ç½®, æœ‰ä¸€è¡Œé…ç½®:\n# Include all config files in /etc/rsyslog.d/ $IncludeConfig /etc/rsyslog.d/*.conf\nç›®å½•ä¸­æœ‰æ–‡ä»¶/etc/rsyslog.d/listen.conf, å†…å®¹ä¸º$SystemLogSocketName /run/systemd/journal/syslog.\nåˆ†æ:\n/runæ˜¯linuxå†…å­˜ä¸­çš„æ•°æ® journalç›¸å…³æœåŠ¡:systemd-journald.service. systemd-journald.service systemd-journaldæ˜¯ç”¨æ¥ååŠ©rsyslogè®°å½•ç³»ç»Ÿå¯åŠ¨æœåŠ¡å’ŒæœåŠ¡å¯åŠ¨å¤±è´¥çš„æƒ…å†µç­‰ç­‰. systemd-journaldä½¿ç”¨å†…å­˜ä¿å­˜è®°å½•, ç³»ç»Ÿé‡å¯è®°å½•ä¼šä¸¢å¤±. æ‰€æœ‰è¿˜è¦ç”¨rsyslogæ¥è®°å½•åˆ†ç±»ä¿¡æ¯, å¦‚ä¸Šé¢/etc/rsyslog.d/listen.confä¸­çš„syslogåˆ†ç±».\n~ systemctl list-sockets LISTEN UNIT ACTIVATES .... /dev/log systemd-journald.socket systemd-journald.service /run/systemd/journal/socket systemd-journald.socket systemd-journald.service /run/systemd/journal/stdout systemd-journald.socket systemd-journald.service .... æŸ¥çœ‹journalçš„é…ç½®/etc/systemd/jounal.conf, æœ€ç»ˆè¿˜æ˜¯ä¼šæŒä¹…åŒ–åˆ°ç¡¬ç›˜ä¸Šçš„/var/log/journalç›®å½•ä¸­. æ¯ä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯10M, æœ€å¤šä½¿ç”¨8Gçš„ç©ºé—´, åŒæ­¥é—´éš”1s.\n[Journal] Storage=persistent Compress=True #Seal=yes #SplitMode=uid SyncIntervalSec=1s RateLimitInterval=1s RateLimitBurst=10000 SystemMaxUse=8G SystemMaxFileSize=10M #RuntimeKeepFree= #RuntimeMaxFileSize= MaxRetentionSec=1month ForwardToSyslog=False #ForwardToKMsg=no #ForwardToConsole=no ForwardToWall=False #TTYPath=/dev/console #MaxLevelStore=debug #MaxLevelSyslog=debug #MaxLevelKMsg=notice #MaxLevelConsole=info #MaxLevelWall=emerg æ£€æŸ¥/var/log/journalç›®å½•, å‘ç°é‡Œé¢æ–‡ä»¶å¾ˆå¤š, æ¯ä¸ªå¤§å°ä¸º10m. æ¸…ç©ºè¯¥ç›®å½•å¹¶é‡å¯rsyslog, è§‚å¯Ÿä¸€æ®µæ—¶é—´åä¸€åˆ‡æ­£å¸¸.\nå‚è€ƒ:\nRedhat systemd-journald.service ç®€ä»‹ StackExchange ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/rsyslogd-high-cpu-trouble-shooting/","tags":["Linux","Openshift"],"title":"è§£å†³ rsyslogd èµ„æºå ç”¨ç‡é«˜é—®é¢˜"},{"categories":["ç¬”è®°"],"contents":"èƒŒæ™¯ Nginxè¿è¡Œåœ¨kubernetsä¸­, åå‘ä»£ç†serviceæä¾›æœåŠ¡.\nkubernetesç‰ˆæœ¬v1.9.1+a0ce1bc657.\né—®é¢˜: é…ç½®å¦‚ä¸‹:\nlocation ^~/info { proxy_pass: http://serviceName:port; } åˆ é™¤å¹¶é‡å»ºServiceçš„æ—¶å€™, nginxä¼šå‡ºç°ä¸‹é¢çš„é—®é¢˜:\nconnect() failed (113: No route to host) \u0026hellip; upstream: \u0026ldquo;xxxxx\u0026rdquo;\nåˆ†æ é€šè¿‡googleå‘ç°, æ˜¯nginxçš„dnsè§£ææ–¹æ¡ˆçš„é—®é¢˜.\nnginxå®˜æ–¹çš„è¯´æ˜:\nIf the domain name canâ€™t be resolved, NGINX fails to start or reload its configuration. NGINX caches the DNS records until the next restart or configuration reload, ignoring the recordsâ€™ TTL values. We canâ€™t specify another loadâ€‘balancing algorithm, nor can we configure passive health checks or other features defined by parameters to the server directive, which weâ€™ll describe in the next section. æ„æ€æ˜¯è¯´, nginxåœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šè§£æproxy_passåçš„åŸŸå, å¹¶æŠŠipç¼“å­˜ä¸‹æ¥, è€Œä¸”æ²¡æœ‰TTL. åªæœ‰åœ¨restartæˆ–è€…reloadçš„æ—¶å€™æ‰ä¼šå†æ¬¡è§£æ.\nè§£å†³æ–¹æ¡ˆ ä½¿ç”¨nginx podçš„è§£ææœåŠ¡å™¨ä½œä¸ºresolver:\n#nginx conf resolver NAME_SERVER valid=30s ipv6=off; set $service \u0026#34;http://serviceName:port\u0026#34;; location ^~/info { proxy_pass: $service; } ä½¿ç”¨shellè·å–podä¸­ä½¿ç”¨çš„è§£ææœåŠ¡å™¨\nNAME_SERVER=`cat /etc/resolv.conf | grep \u0026#34;nameserver\u0026#34; | awk \u0026#39;{print $2}\u0026#39; | tr \u0026#39;\\n\u0026#39; \u0026#39; \u0026#39;` å‚è€ƒ: Nginx proxy_pass with $remote_addr\nNginx with dynamic upstreams\nå¦ä¸€ä¸ªé—®é¢˜ serviceName could not be resolved (3: Host not found)\nserviceçš„çŸ­åç§°æ˜¯è§£æä¸äº†çš„, éœ€è¦ä½¿ç”¨serviceName.namespace.svc.clusterName.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/nginx-dynamic-domain-parse-in-kubernetes/","tags":["Kubernetes","DevOps"],"title":"Kubernetes ä¸­çš„ Nginx åŠ¨æ€è§£æ"},{"categories":["æºç è§£æ"],"contents":"å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡, Ribbonçš„æ ¸å¿ƒæ¦‚å¿µæ˜¯å‘½åçš„å®¢æˆ·ç«¯.\nä½¿ç”¨ å¼•å…¥Ribbonä¾èµ–å’Œé…ç½® åŠ å…¥spring-cloud-starter-netflix-ribbonä¾èµ–\nä»£ç ä¸­ä½¿ç”¨RibbonClientæ³¨è§£ @Configuration @RibbonClient(name = \u0026#34;foo\u0026#34;, configuration = FooConfiguration.class) public class TestConfiguration {} @Configuration protected static class FooConfiguration { @Bean public ZonePreferenceServerListFilter serverListFilter() { ZonePreferenceServerListFilter filter = new ZonePreferenceServerListFilter(); filter.setZone(\u0026#34;myTestZone\u0026#34;); return filter; } @Bean public IPing ribbonPing() { return new PingUrl(); } } Ribbonå®¢æˆ·ç«¯çš„é…ç½®, å¦‚æœä¸æŒ‡å®šä¼šä½¿ç”¨é»˜è®¤çš„å®ç°:\nIClientConfig å®¢æˆ·ç«¯ç›¸å…³é…ç½® IRule å®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥ IPing å®šä¹‰å¦‚ä½•pingç›®æ ‡æœåŠ¡å®ä¾‹æ¥åˆ¤æ–­æ˜¯å¦å­˜æ´», ribbonä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹æ¯éš”ä¸€æ®µæ—¶é—´(é»˜è®¤10s)å¯¹æœ¬åœ°ç¼“å­˜çš„ServerListåšä¸€æ¬¡æ£€æŸ¥ ServerList å®šä¹‰å¦‚ä½•è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨. ä¸¤ç§å®ç°åŸºäºé…ç½®çš„ConfigurationBasedServerListå’ŒåŸºäºEurekaæœåŠ¡å‘ç°çš„DiscoveryEnabledNIWSServerList ServerListFilter ç”¨æ¥ä½¿ç”¨æœŸæœ›çš„ç‰¹å¾è¿‡æ»¤é™æ€é…ç½®åŠ¨æ€è·å¾—çš„å€™é€‰æœåŠ¡å®ä¾‹åˆ—è¡¨. è‹¥æœªæä¾›, é»˜è®¤ä½¿ç”¨ZoneAffinityServerListFilter ILoadBalancer å®šä¹‰äº†è½¯è´Ÿè½½å‡è¡¡å™¨çš„æ“ä½œçš„æ¥å£. ä¸€ä¸ªå…¸å‹çš„è´Ÿè½½å‡è¡¡å™¨è‡³å°‘éœ€è¦ä¸€ç»„ç”¨æ¥åšè´Ÿè½½å‡è¡¡çš„æœåŠ¡å®ä¾‹, ä¸€ä¸ªæ ‡è®°æŸä¸ªæœåŠ¡å®ä¾‹ä¸åœ¨æ—‹è½¬ä¸­çš„æ–¹æ³•, å’Œå¯¹åº”çš„æ–¹æ³•è°ƒç”¨ä»å®ä¾‹åˆ—è¡¨ä¸­é€‰å‡ºæŸä¸€ä¸ªæœåŠ¡å®ä¾‹. ServerListUpdater DynamicServerListLoadBalancerç”¨æ¥æ›´æ–°å®ä¾‹åˆ—è¡¨çš„ç­–ç•¥(æ¨EurekaNotificationServerListUpdater/æ‹‰PollingServerListUpdater, é»˜è®¤æ˜¯æ‹‰) åˆ†æ ç±»ç»“æ„\nå®ç° å®é™…ä½¿ç”¨ä¸­, æœåŠ¡è°ƒç”¨ä½¿ç”¨RestTemplate, è¯·æ±‚åœ°å€ä¸ºhttp://\u0026lt;serviceName\u0026gt;/\u0026lt;path\u0026gt;, å¦‚http://foo/ é€šè¿‡@RibbonClientæ³¨è§£ä¸ºæœåŠ¡åˆ›å»ºribbonå®¢æˆ·ç«¯, åå­—ä¸ºæ–¹æ³•å. RestTemplateå‘é€è¯·æ±‚çš„æ—¶å€™, è¯·æ±‚ä¼šè¢«LoadBalancerInterceptoræ‹¦æˆªåˆ°, ä½¿ç”¨æœåŠ¡å¯¹åº”çš„ribbonå®¢æˆ·ç«¯. Ribbonå®¢æˆ·ç«¯çš„LoadBalancerä¼šä»ServerListä¸­æ ¹æ®IRuleçš„è§„åˆ™é€‰æ‹©æŸä¸ªæœåŠ¡å®ä¾‹ä½œä¸ºè¯·æ±‚å¯¹è±¡. ServerListæœ‰åŠ¨æ€çš„å®ç°, æ›´æ–°åˆ—è¡¨æ—¶ä¼šä½¿ç”¨ServerListFilterè¿›è¡Œè¿‡æ»¤.\nRibbonClientæ³¨è§£ ä»æ³¨é‡Šä¸Š@RibbonClientä¸ºä¸€ä¸ªribbonå®¢æˆ·ç«¯å£°æ˜é…ç½®ä¿¡æ¯. æŠŠè¿™ä¸ªæ³¨è§£åŠ åœ¨ä»»ä½•@Configurationæ ‡æ³¨çš„ç±»ä¸Š, ç„¶åæ³¨å…¥SpringClientFactoryæ¥è®¿é—®åˆ›å»ºçš„å®¢æˆ·ç«¯.\nä»ä»£ç ä¸Šçœ‹@RibbonClientå¼•å…¥äº†RibbonClientConfigurationRegistrar. RibbonClientConfigurationRegistrarå®ç°äº†ImportBeanDefinitionRegistraræ¥å£, åœ¨@Configurationçš„è§£ææç«¯è°ƒç”¨æ¥å£çš„registerBeanDefinitionsæ–¹æ³•, ä¸ºribbonå®¢æˆ·ç«¯åˆ›å»ºBeanDefinition ä½¿ç”¨name/valueå’Œconfigurationåˆ›å»ºä¸€ä¸ªBeanDefinition. Definitionçš„åä¸º\u0026lt;name\u0026gt;.RibbonClientSpecification, classä¸ºRibbonClientSpecification.\nFooConfiguration.classä¹Ÿè¦ä½¿ç”¨@Configurationæ³¨è§£, ç„¶åé€šè¿‡RibbonClientConfigurationRegistrarå…³è”åˆ°Ribbonå®¢æˆ·ç«¯çš„BeanDefinition. æ‰€ä»¥ä¸èƒ½æŠŠFooConfigurationæ”¾åˆ°@ComponentScançš„ä¸Šä¸‹æ–‡ä¸­, åŒæ ·@SpringBootApplicationä¹Ÿä¸è¡Œ. å¿…è¦æ—¶ä½¿ç”¨excludeæ’é™¤, å¦åˆ™ä¼šå˜æˆæ‰€æœ‰Ribbonå®¢æˆ·ç«¯å…±äº«.\nRibbonAutoConfigurationä¸­åœ¨åˆ›å»ºSpringClientFactorybeanæ—¶, ä¼šæ³¨å…¥è¿™äº›RibbonClientSpecification. SpringClientFactoryç»§æ‰¿äº†ç±»NamedContextFactory. ä»æ³¨é‡Šçœ‹NamedContextFactoryå¯ä»¥åˆ›å»ºä¸€ç»„å­ä¸Šä¸‹æ–‡, æ¯ä¸ªå­ä¸Šä¸‹æ–‡ä¸­å¯ä»¥ä½¿ç”¨ä¸€ç»„çš„Specificationæ¥å®šä¹‰bean. å¯¹äºRibbonæ¥è¯´, æ¯ä¸ªribbonå®¢æˆ·ç«¯å„è‡ªä¸ºä¸€ä¸ªå­ä¸Šä¸‹æ–‡, @RibbonClientçš„configurationæŒ‡å®šçš„é…ç½®, å°±æ˜¯ç”¨æ¥æ„å»ºè¯¥å­ä¸Šä¸‹æ–‡çš„é…ç½®, æœ€ç»ˆè¢«ç”¨æ¥æ„å»ºribbonå®¢æˆ·ç«¯. è¿™äº›ä¸Šä¸‹æ–‡æœ‰å…±åŒçš„çˆ¶ä¸Šä¸‹æ–‡, å³ApplicationContext. è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢æåˆ°çš„FooConfigurationä¸èƒ½ç½®äºApplicationContextä¸­, å¦åˆ™ä¼šè¢«æ‰€æœ‰çš„Ribbonå®¢æˆ·ç«¯å…±äº«é…ç½®.\nLoadBalancerAutoConfigurationé…ç½®ç±» é€šè¿‡RibbonAutoConfigurationå¼•å…¥, å®šä¹‰äº†å‡ ä¸ªé‡è¦çš„bean:\nLoadBalancerRequestFactory: 1) å°†Httpè¯·æ±‚å°è£…æˆServiceRequestWrapper. ServiceRequestWrapperç»§æ‰¿å¹¶é‡å†™äº†HttpRquestWrapperçš„getURIæ–¹æ³•: è°ƒç”¨LoadBalancerClientçš„reconstructURIæ–¹æ³•,åˆ›å»ºå®é™…è¯·æ±‚çš„åœ°å€. 2) å¦‚æœæœ‰æä¾›LoadBalancerRequestTransformerçš„å®ä¾‹, åˆ™ä½¿ç”¨è¿™äº›å®ä¾‹å¯¹ç›¸æ±‚è¿›è¡Œå“åº”çš„è½¬æ¢. LoadBalancerInterceptor: Httpè¯·æ±‚æ‹¦æˆªå™¨, å°†è¯·æ±‚çš„hostä½œä¸ºserviceNameå¹¶ä½¿ç”¨LoadBalancerRequestFactoryå°è£…è¯·æ±‚, è°ƒç”¨LoadBalancerClientçš„executeæ–¹æ³•, å‘é€è¯·æ±‚åˆ°çœŸå®çš„æœåŠ¡å®ä¾‹åœ°å€, è¿”å›å“åº”\nRestTemplateCustomizer: æä¾›ä¸€ä¸ªRestTemplateCustomizerçš„åŒ¿åç±»å®ç°, ä¸ºæ‰€æœ‰çš„RestTemplateå®ä¾‹æ·»åŠ ä¸€ä¸ªLoadBalancerInterceptoræ‹¦æˆªå™¨\nRibbonAutoConfigurationé…ç½®ç±» é€šè¿‡spring.factorieså¼•å…¥, RibbonAutoConfigurationå®šä¹‰äº†å‡ ä¸ªé‡è¦çš„bean:\nSpringClientFactory: ä½¿ç”¨@RibbonClientæ³¨è§£å¼•å…¥çš„ribbonå®¢æˆ·ç«¯çš„é…ç½®, æ„å»ºribbonå®¢æˆ·ç«¯çš„å­ä¸Šä¸‹æ–‡, åˆå§‹åŒ–ribbonå®¢æˆ·ç«¯bean. å››ä¸ªgetæ–¹æ³•, åˆ†åˆ«è¿”å›å¯¹åº”serviceçš„IClient, ILoadBalancer, IClientConfig, RibbonLoadBalancerContextå®ä¾‹. LoadBalancerClient: ä½¿ç”¨Spring Cloudæä¾›çš„å®ç°RibbonLoadBalancerClient. é€šè¿‡SpringClientFactoryåˆ›å»ºä¸€ä¸ªILoadBalancerå®ä¾‹, é€šè¿‡ILoadBalancerè¿”å›ä¸€ä¸ªServerå®ä¾‹. ä½¿ç”¨Serverå®ä¾‹.\nreconstructURI(): é€šè¿‡SpringClientFactoryè·å–è¯¥æœåŠ¡ribbonå®¢æˆ·ç«¯å­ä¸Šä¸‹æ–‡RibbonLoadBalancerContextå¯¹è±¡, è°ƒç”¨RibbonLoadBalancerContextçš„reconstructURIWithServeræ–¹æ³•æ„å»ºæœ€ç»ˆçš„è¯·æ±‚åœ°å€\nchoose(): é€šè¿‡SpringClientFactoryè·å–è¯¥æœåŠ¡çš„æœåŠ¡å‡è¡¡å™¨, ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨çš„IRuleè¿”å›æœåŠ¡å®ä¾‹.\nexecute(): æ‰§è¡Œæœ€ç»ˆçš„è¯·æ±‚, å¹¶è®°å½•çŠ¶æ€: ServerStatså’ŒStopwatch\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/spring-cloud-ribbon-breakdown-1/","tags":["Spring"],"title":"Spring Cloud Ribbon è¯¦è§£"},{"categories":["æ•™ç¨‹","ç¬”è®°"],"contents":"æœ€è¿‘å¼€å§‹å®¢ä¸²è¿ç»´åšCI/CDçš„è§„åˆ’è®¾è®¡, ä¸»è¦æ˜¯åŸºäº\u0026rsquo;Pipeline as Code in Jenkins\u0026rsquo;. æ•´ç†äº†ä¸‹æ€è·¯å’ŒæŠ€æœ¯ç‚¹, æ…¢æ…¢çš„å†™.\nè¿™ä¸€ç¯‡æ˜¯å…³äºåŸºäºè§’è‰²çš„æˆæƒç­–ç•¥, ç”¨çš„æ˜¯Role-Based Authorization Strategy Plugin.\næˆæƒåœ¨CI/CDæµç¨‹ä¸­æ¯”è¾ƒå¸¸è§, æ¯”å¦‚æˆ‘ä»¬åªè®©æŸäº›ç‰¹å®šç”¨æˆ·æ‰å¯ä»¥æ„å»ºPre-Releaseçš„Job. è€Œæ›´é«˜çº§çš„Releaseå‘å¸ƒ, åˆä¼šéœ€è¦æŸäº›ç”¨æˆ·çš„å®¡æ‰¹æ‰å¯ä»¥è¿›è¡Œ. éœ€è¦æˆæƒæ—¶, å¯èƒ½è¿˜éœ€è¦å‘é‚®ä»¶æé†’ç”¨æˆ·.\nUIä¸Šå¦‚ä½•ä½¿ç”¨å°±ä¸æäº†, è¿™é‡Œåªè¯´Pipeline as Code. åé¢çš„å‡ ç¯‡ä¹Ÿä¼šæ˜¯è¿™ä¸ªèƒŒæ™¯.\nå‚è€ƒçš„è¿™ç¯‡æ–‡ç« , æ–‡ç« é‡Œçš„ä»£ç è¿è¡Œå¤±è´¥, åšäº†ä¿®å¤.\né…ç½® å®‰è£…å®Œæ’ä»¶, éœ€è¦å¼€å§‹åŸºäºè§’è‰²çš„æˆæƒç­–ç•¥. åŒæ—¶æ·»åŠ è§’è‰²å’Œä¸ºç”¨æˆ·åˆ†é…è§’è‰².\nä½¿ç”¨Role-Based Strategyä½œä¸ºéªŒè¯æ–¹å¼ Manage Jenkins / Configure Global Security / Configure Global Security\næ·»åŠ è§’è‰² Manage Jenkins / Manage and Assign Roles / Manage Roles / Global roles è¾“å…¥è¦æ·»åŠ çš„è§’è‰²å\nä¸ºæ–°åŠ çš„è§’è‰²é…ç½®æƒé™ ä¸ºç”¨æˆ·æŒ‡å®šè§’è‰² `Manage Jenkins / Manage and Assign Roles / Assign Roles / Global roles'\nè¾“å…¥å·²æœ‰çš„ç”¨æˆ·å\nåˆ†é…è§’è‰²\nç¼–ç  æˆæƒä¼šåœ¨å¾ˆå¤šjobé‡Œä½¿ç”¨, æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨shared libraryæ¥å®šä¹‰.\ntimeout(time: 5, unit: \u0026#39;MINUTES\u0026#39;) { notifyAwaitApproval approvers: getApprovers(\u0026#39;pre-release\u0026#39;), emailPrompt: \u0026#39;Build is ready to prepare release\u0026#39; } ç»™ç”¨æˆ·å‘é€å¾…å®¡æ‰¹é‚®ä»¶, ä½¿ç”¨inputç­‰å¾…ç”¨æˆ·çš„äº¤äº’, åŒæ—¶ä½¿ç”¨milestoneé˜»å¡åç»­çš„æ„å»ºè¯·æ±‚. notifyAwaitApproval.groovy\ndef call(options) { def jobName = env.JOB_NAME if(options.message == null) { options.message = \u0026#34;Action Required For Build $jobName\u0026#34; } def csvApproverUsernames = { switch (options.approvers) { case String: // already csv return options.approvers case Map: // keys are usernames and values are names return options.approvers.keySet().join(\u0026#39;,\u0026#39;) case ArrayList: case HashSet: return options.approvers.join(\u0026#39;,\u0026#39;) default: throw new Exception(\u0026#34;Unexpeced approver type ${options.approvers.class}!\u0026#34;) } }() echo \u0026#34;Notify approvers: $csvApproverUsernames for approval\u0026#34; // emailext needs to be inside a node block but don\u0026#39;t want to take up a node while waiting for approval emailext body: \u0026#34;Action Required For Build \\${jobName} (#\\${env.BUILD_NUMBER})\u0026#34;, to: csvApproverUsernames, subject: \u0026#34;Action Required For Build \\${jobName} (#\\${env.BUILD_NUMBER})\u0026#34; milestone() input id: \u0026#39;Approval\u0026#39;, message: options.message, submitter: csvApproverUsernames, submitterParameter: \u0026#39;submitter\u0026#39; milestone() } æ£€æŸ¥å¹¶è·å–Jenkinså½“å‰é…ç½®çš„æˆæƒç­–ç•¥, å¦‚æœæ˜¯Role-Based Authorization, è¿”å›æ‹¥æœ‰æŒ‡å®šè§’è‰²çš„ç”¨æˆ·åˆ—è¡¨. getApprovers.groovy\nimport com.cloudbees.groovy.cps.NonCPS import com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy @NonCPS def call(role) { echo \u0026#34;Retrieving users for $role\u0026#34; def strategy = RoleBasedAuthorizationStrategy.instance; if (strategy != null) { return strategy.getGrantedRoles(RoleBasedAuthorizationStrategy.GLOBAL) .entrySet() .find { entry -\u0026gt; entry.key.getName().equals(role) }.getValue() } else { throw new Exception(\u0026#34;Role Strategy Plugin not in use. Please enable to retrieve users for a role\u0026#34;) } } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/using-role-based-authorization-strategy-in-jenkins/","tags":["DevOps","Jenkins"],"title":"Jenkins CI/CD (ä¸€) åŸºäºè§’è‰²çš„æˆæƒç­–ç•¥"},{"categories":["ç¬”è®°"],"contents":"æ·»åŠ è™šæ‹Ÿæœºæµç¨‹ï¼š 1. é…ç½®ç½‘ç»œ 2. é…ç½®å­˜å‚¨æ±  3. ä¸Šä¼ é•œåƒ 4. å®‰è£…è™šæ‹Ÿæœºï¼ŒæŒ‡å®šé…ç½® å®‰è£…KVMè™šæ‹Ÿæœº 1. å…³é—­é˜²ç«å¢™ï¼Œselinux # service iptables stop # setenforce 0 ä¸´æ—¶å…³é—­ # chkconfig NetworkManager off 2. å®‰è£…kvmè™šæ‹Ÿæœº # yum install kvm libvirt libvirt-devel python-virtinst python-virtinst qemu-kvm virt-viewer bridge-utils virt-top libguestfs-tools ca-certificates audit-libs-python device-mapper-libs virt-install # å¯åŠ¨æœåŠ¡ # service libvirtd restart ä¸‹è½½virtio-win-1.5.2-1.el6.noarch.rpm å¦‚æœä¸å®‰è£…windowè™šæ‹Ÿæœºæˆ–è€…ä½¿ç”¨å¸¦virtioé©±åŠ¨çš„é•œåƒå¯ä»¥ä¸ç”¨å®‰è£… # rpm -ivh virtio-win-1.5.2-1.el6.noarch.rpm 3. Libvirtåœ¨ç®¡ç†æœ¬åœ°æˆ–è¿œç¨‹Hypervisoræ—¶çš„è¡¨ç°å½¢å¼å¦‚ä¸‹ã€‚ åœ¨libvirtå†…éƒ¨ç®¡ç†äº†äº”éƒ¨åˆ†ï¼š\nèŠ‚ç‚¹ï¼šæ‰€è°“çš„èŠ‚ç‚¹å°±æ˜¯æˆ‘ä»¬çš„ç‰©ç†æœåŠ¡å™¨ï¼Œä¸€ä¸ªæœåŠ¡å™¨ä»£è¡¨ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸Šè¾¹å­˜æ”¾ç€Hyperå’ŒDomain Hypervisorï¼šå³VMMï¼ŒæŒ‡è™šæ‹Ÿæœºçš„ç›‘æ§ç¨‹åºï¼Œåœ¨KVMä¸­æ˜¯ä¸€ä¸ªåŠ è½½äº†kvm.koçš„æ ‡å‡†Linuxç³»ç»Ÿã€‚ åŸŸï¼ˆDomainï¼‰ï¼šæŒ‡è™šæ‹Ÿæœºï¼Œä¸€ä¸ªåŸŸä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿæœºï¼ˆä¼°è®¡æ€è·¯æ¥æºäºXençš„Domain0ï¼‰ å­˜å‚¨æ± ï¼ˆStorage Poolï¼‰ï¼šå­˜å‚¨ç©ºé—´ï¼Œæ”¯æŒå¤šç§åè®®å’Œç½‘ç»œå­˜å‚¨ã€‚ä½œä¸ºè™šæ‹Ÿæœºç£ç›˜çš„å­˜å‚¨æºã€‚ å·ç»„ï¼ˆVolumeï¼‰ï¼šè™šæ‹Ÿæœºç£ç›˜åœ¨Hostä¸Šçš„è¡¨ç°å½¢å¼ã€‚ ä¸Šè¾¹çš„äº”éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨çš„æ˜¯å‰ä¸‰ä¸ªï¼Œå› ä¸ºå¾ˆå¤šæ—¶å€™æ ¹æ®ä¸šåŠ¡è§„åˆ™æˆ–åº”ç”¨çš„çµæ´»æ€§å¹¶æ²¡æœ‰ä½¿ç”¨å·ç»„ï¼ˆå…¶å®å°±æ˜¯æœ‰äº†ç¼–åˆ¶çš„è™šæ‹Ÿç£ç›˜æ–‡ä»¶ï¼‰ï¼Œä¹Ÿå°±æ²¡æœ‰å¿…è¦ä½¿ç”¨å­˜å‚¨æ± ã€‚ é…ç½® 1. ä¿®æ”¹ç½‘ç»œé…ç½® æ–¹æ¡ˆä¸€ (æ¨è)\nbrctl addbr br0 \u0026amp;\u0026amp; brctl addif br0 em1 \u0026amp;\u0026amp; brctl stp br0 on \u0026amp;\u0026amp; ifconfig em1 0.0.0.0 \u0026amp;\u0026amp; ifconfig br0 192.168.1.31 netmask 255.255.255.0 \u0026amp;\u0026amp; route add default gw 192.168.1.1 æ–¹æ¡ˆäºŒ\nå‚è€ƒ\n# vim /etc/sysconfig/network-scripts/ifcfg-br0 DEVICE=br0 TYPE=Bridge BOOTPROTO=static BROADCAST=192.168.1.255 IPADDR=192.168.1.10 NETMASK=255.255.255.0 NETWORK=192.168.1.0 GATEWAY=192.168.1.1 DNS1=119.29.29.29 ONBOOT=yes\n# vim /etc/sysconfig/network-scripts/ifcfg-em1 DEVICE=em1 BOOTPROTO=none ONBOOT=yes BRIDGE=br0\n# vim /etc/sysconfig/network-scripts/ifcfg-bond0 DEVICE=bond0 TYPE=Ethernet NAME=bond0 BONDING_MASTER=yes BOOTPROTO=none BRIDGE=br0 ONBOOT=yes BONDING_OPTS=\u0026ldquo;mode=5 miimon=100\u0026rdquo;\næ–¹æ¡ˆä¸‰\n3. å…³é—­å®¿ä¸»æœºçš„GSOä¸TSOåŠŸèƒ½ # ethtool -K em1 gso off # ethtool -K em1 tso off # systemctl restart network 4. åˆ›å»ºåŸºäºæ–‡ä»¶å¤¹çš„å­˜å‚¨æ± ï¼ˆç›®å½•ï¼‰ # mkdir -p /home/vmdisk å®šä¹‰å­˜å‚¨æ± ä¸å…¶ç›®å½•\n# virsh pool-define-as vmDiskPool --type dir --target /home/vmdisk Pool vmDiskPool defined åˆ›å»ºå·²å®šä¹‰çš„å­˜å‚¨æ± \n# virsh pool-build vmDiskPool Pool vmDiskPool built æŸ¥çœ‹å·²å®šä¹‰çš„å­˜å‚¨æ± ï¼Œå­˜å‚¨æ± ä¸æ¿€æ´»æ— æ³•ä½¿ç”¨\n# virsh pool-list --all Name State Autostart ----------------------------------------- vmDiskPool inactive no æŸ¥çœ‹å­˜å‚¨å·ä¿¡æ¯\n# virsh pool-info vmDiskPool Name: vmDiskPool UUID: 3fc996c4-9bfa-7fdc-2960-445e4c551855 State: inactive Persistent: yes Autostart: no æ¿€æ´»å¹¶è‡ªåŠ¨å¯åŠ¨å·²å®šä¹‰çš„å­˜å‚¨æ± \n# virsh pool-autostart vmDiskPool Pool vmDiskPool marked as autostarted å¯åŠ¨å­˜å‚¨å·\n# virsh pool-start vmDiskPool Pool vmDiskPool started å†æ¬¡æŸ¥çœ‹å­˜å‚¨å·ä¿¡æ¯\n# virsh pool-info vmDiskPool Name: vmDiskPool UUID: 3fc996c4-9bfa-7fdc-2960-445e4c551855 State: running Persistent: yes Autostart: yes Capacity: 39.25 GiB Allocation: 47.89 MiB Available: 39.20 GiB 3. åœ¨å­˜å‚¨æ± ä¸­åˆ›å»ºè™šæ‹Ÿæœºå­˜å‚¨å·ï¼ˆåˆ›å»ºå·ï¼‰ # virsh vol-create-as vmDiskPool linux_vm0.qcow2 300G --format qcow2 æŸ¥çœ‹å­˜å‚¨å·\nll /home/vmdisk/ å­˜å‚¨æ± ç›¸å…³ç®¡ç†å‘½ä»¤ åˆ é™¤å­˜å‚¨æ± ä¸­çš„å­˜å‚¨å·\n# virsh vol-delete --pool vmDiskPool linux_vm1.qcow2 å–æ¶ˆæ¿€æ´»å­˜å‚¨æ± \n# virsh pool-destroy vmDiskPool å–æ¶ˆå®šä¹‰å­˜å‚¨æ± \n# virsh pool-undefine vmDiskPool åˆ é™¤å­˜å‚¨æ± \n# virsh pool-delete vmDiskPool 4. å®‰è£…è™šæ‹Ÿæœº bridgeç½‘ç»œæ¨¡å¼\n# virt-install \\ --virt-type kvm \\ --os-type=linux \\ --os-variant=RHEL7 \\ --name=vm0 \\ --memory 16384 \\ --vcpus 6 \\ --disk path=/home/vmdisk/linux_vm0.qcow2,format=qcow2,bus=virtio \\ --location /root/CentOS-7-x86_64-Minimal-1708.iso \\ --graphics none \\ --network bridge=br0,model=virtio \\ --autostart \\ --boot cdrom,hd,menu=on \\ --console pty,target_type=serial \\ --extra-args \u0026#39;console=ttyS0,115200n8 serial\u0026#39; \\ --debug NATç½‘ç»œæ¨¡å¼\n# virt-install --name=test --ram 512 --vcpus=1 -f /data/kvm/vm/test.qcow2 --cdrom /data/iso/CentOS-6.5-x86_64-bin-DVD1.iso --graphics vnc,listen=0.0.0.0,port=5988, --network network=default,model=virtio --force --accelerate --autostart --boot cdrom,hd,menu=on å®‰è£…windowä¸»æœº\n# virt-install --name=window_24 --ram 12288 --vcpus 4 -c /data/iso/windows2008.iso --disk path=/usr/share/virtio-win/virtio-win-1.5.2.iso,device=cdrom --disk path=/data/kvm/vm/window_24.img,format=qcow2,bus=virtio --network bridge=br0,model=virtio --vnc --vncport=5924 --vnclisten=0.0.0.0 --force --autostart --os-type=windows --accelerate --boot cdrom,hd,menu=on è®¾ç½®è™šæ‹Ÿæœºç½‘ç»œ\n# vi /etc/sysconfig/network-scripts/ifcfg-eth0 TYPE=Ethernet BOOTPROTO=static DEFROUTE=yes PEERDNS=yes PEERROUTES=yes IPV4_FAILURE_FATAL=no NAME=eth0 DEVICE=eth0 ONBOOT=yes IPADDR=192.168.1.16 PREFIX=24 GATEWAY=192.168.1.1 DNS1=119.29.29.29 5. å¯åŠ¨ ä½¿ç”¨virsh list \u0026ndash;allæŸ¥çœ‹å·²å®‰è£…çš„kvm\n[root@localhost ~]# virsh list --all Id Name State ---------------------------------------------------- 5 test running 6. åŠ¨æ€è°ƒæ•´cpuä¸ªæ•° # virsh setvcpus test --maximum 4 --config #è®¾ç½®testçš„æœ€å¤§cpué¢—æ•° # virsh setvcpus test 3 #å¢åŠ åˆ°3ä¸ªCPU æ³¨ï¼šä½¿ç”¨ä¸Šé¢å‘½ä»¤ä¿®æ”¹ï¼Œè™šæ‹Ÿæœºé‡å¯ä¿®æ”¹çš„é…ç½®ä¼šä¸¢å¤± # virsh edit test #ä¿®æ”¹CPUä¸ªæ•°å†ä¿å­˜é…ç½®ï¼Œè¿™æ ·é‡å¯ä¹‹åä¹Ÿä¼šç”Ÿæ•ˆ 7. åŠ¨æ€è°ƒæ•´memå®¹é‡ # virsh setmaxmem test 2G --config #è®¾ç½®æœ€å¤§å†…å­˜ # virsh setmem test 800M --config #é‡å¯åç”Ÿæ•ˆ # virsh setmem test 800M --config --live #é©¬ä¸Šç”Ÿæ•ˆ 8. æŸ¥çœ‹è™šæ‹ŸåŒ–å®¢æˆ·æœºçš„èµ„æºä½¿ç”¨æƒ…å†µ # virt-top 9. ä¸€äº›æ‰©å±•å‘½ä»¤ virshå‘½ä»¤è¡Œï¼š\n# virsh list #æ˜¾ç¤ºæœ¬åœ°æ´»åŠ¨è™šæ‹Ÿæœº # virsh list --all #æ˜¾ç¤ºæœ¬åœ°æ‰€æœ‰çš„è™šæ‹Ÿæœºï¼ˆæ´»åŠ¨çš„+ä¸æ´»åŠ¨çš„ï¼‰ # virsh define test.xml #é€šè¿‡é…ç½®æ–‡ä»¶å®šä¹‰ä¸€ä¸ªè™šæ‹Ÿæœºï¼ˆè¿™ä¸ªè™šæ‹Ÿæœºè¿˜ä¸æ˜¯æ´»åŠ¨çš„ï¼‰ # virsh start test #å¯åŠ¨åå­—ä¸ºtestçš„éæ´»åŠ¨è™šæ‹Ÿæœº # virsh create test.xml #åˆ›å»ºè™šæ‹Ÿæœºï¼ˆåˆ›å»ºåï¼Œè™šæ‹Ÿæœºç«‹å³æ‰§è¡Œï¼Œæˆä¸ºæ´»åŠ¨ä¸»æœºï¼‰ # virsh suspend test #æš‚åœè™šæ‹Ÿæœº # virsh resume test #å¯åŠ¨æš‚åœçš„è™šæ‹Ÿæœº # virsh shutdown test #æ­£å¸¸å…³é—­è™šæ‹Ÿæœº # virsh destroy test #å¼ºåˆ¶å…³é—­è™šæ‹Ÿæœº # virsh undefine test #æ¸…é™¤è™šæ‹Ÿæœº # virsh dominfo test #æ˜¾ç¤ºè™šæ‹Ÿæœºçš„åŸºæœ¬ä¿¡æ¯ # virsh domname 2 #æ˜¾ç¤ºidå·ä¸º2çš„è™šæ‹Ÿæœºå # virsh domid test #æ˜¾ç¤ºè™šæ‹Ÿæœºidå· # virsh domuuid test #æ˜¾ç¤ºè™šæ‹Ÿæœºçš„uuid # virsh domstate test #æ˜¾ç¤ºè™šæ‹Ÿæœºçš„å½“å‰çŠ¶æ€ # virsh dumpxml test #æ˜¾ç¤ºè™šæ‹Ÿæœºçš„å½“å‰é…ç½®æ–‡ä»¶ï¼ˆå¯èƒ½å’Œå®šä¹‰è™šæ‹Ÿæœºæ—¶çš„é…ç½®ä¸åŒï¼Œå› ä¸ºå½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œéœ€è¦ç»™è™šæ‹Ÿæœºåˆ†é…idå·ã€uuidã€vncç«¯å£å·ç­‰ç­‰ï¼‰ # virsh setmem test 512000 #ç»™ä¸æ´»åŠ¨è™šæ‹Ÿæœºè®¾ç½®å†…å­˜å¤§å° # virsh setmaxmem test 1024000 #è®¾å®šå†…å­˜ä¸Šé™ # virsh setvcpus test 4 #ç»™ä¸æ´»åŠ¨è™šæ‹Ÿæœºè®¾ç½®cpuä¸ªæ•° # virsh edit test #ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼ˆä¸€èˆ¬æ˜¯åœ¨åˆšå®šä¹‰å®Œè™šæ‹Ÿæœºä¹‹åï¼‰ # virsh vcpuinfo test #æ˜¾ç¤ºå®¢æˆ·ç«¯çš„è™šæ‹Ÿ CPU ä¿¡æ¯ã€‚ # virsh vcpupin test #æ§åˆ¶å®¢æˆ·ç«¯çš„è™šæ‹Ÿ CPU äº²å’Œæ€§ã€‚ # virsh domblkstat test #æ˜¾ç¤ºæ­£åœ¨è¿è¡Œçš„å®¢æˆ·ç«¯çš„å—è®¾å¤‡ç»Ÿè®¡ã€‚ # virsh domifstat test #æ˜¾ç¤ºæ­£åœ¨è¿è¡Œçš„å®¢æˆ·ç«¯çš„ç½‘ç»œæ¥å£ç»Ÿè®¡ã€‚ # virsh attach-device test #ä½¿ç”¨ XML æ–‡ä»¶ä¸­çš„è®¾å¤‡å®šä¹‰åœ¨å®¢æˆ·ç«¯ä¸­æ·»åŠ è®¾å¤‡ã€‚ # virsh attach-disk test #åœ¨å®¢æˆ·ç«¯ä¸­é™„åŠ æ–°ç£ç›˜è®¾å¤‡ã€‚ # virsh attach-interface test #åœ¨å®¢æˆ·ç«¯ä¸­é™„åŠ æ–°ç½‘ç»œæ¥å£ã€‚ # virsh detach-device test #ä»å®¢æˆ·ç«¯ä¸­åˆ†ç¦»è®¾å¤‡ï¼Œä½¿ç”¨åŒæ ·çš„ XML æè¿°ä½œä¸ºå‘½ä»¤attach-device # virsh detach-disk test #ä»å®¢æˆ·ç«¯ä¸­åˆ†ç¦»ç£ç›˜è®¾å¤‡ã€‚ # virsh detach-interface #ä»å®¢æˆ·ç«¯ä¸­åˆ†ç¦»ç½‘ç»œæ¥å£ã€‚ é—®é¢˜ Could not open \u0026lsquo;/root/CentOS-7-x86_64-Minimal-1708.iso\u0026rsquo;: Permission denied\nä¿®æ”¹/etc/libvirt/qemu.conf\n#å–æ¶ˆæ³¨é‡Š user = \u0026#34;root\u0026#34; group = \u0026#34;root\u0026#34; é‡å¯libvirtd\nservice libvirtd restart\nerror: æ“ä½œå¤±è´¥: è¿™ä¸ªåŸŸæœ‰æ´»è·ƒæ§åˆ¶å°ä¼šè¯\nps -ef|grep \u0026#39;console VMNAME|grep -v \u0026#39;grep\u0026#39; #ç„¶åkillæ‰ç›¸åº”çš„è¿›è¡Œ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/kvm-installation-note/","tags":["Linux"],"title":"KVM å®‰è£…æ‰‹å†Œ"},{"categories":["ç¬”è®°"],"contents":"Jenkins CLIæä¾›äº†SSHå’ŒClientæ¨¡å¼.\nDockerè¿è¡ŒJenkins\nversion: \u0026#39;3\u0026#39; services: jenkins: image: jenkins/jenkins:alpine ports: - 8080:8080 - 50000:50000 - 46059:46059 volumes: - \u0026#34;/Users/addo/DevApps/Docker/data/jenkins:/var/jenkins_home\u0026#34; note: ä»¥ä¸ºæ˜¯dockerè¿è¡Œ, sshç«¯å£è®¾ç½®é€‰ç”¨äº†å›ºå®šç«¯å£.\nClient ä»http://JENKINS_URL/clié¡µé¢ä¸‹è½½client jar\nä½¿ç”¨æ–¹æ³•:\njava -jar jenkins-cli.jar -s http://localhost:8080/ help æ„å»º:\njava -jar jenkins-cli.jar -s http://localhost:8080/ build JOB [-c] [-f] [-p] [-r N] [-s] [-v] [-w] Starts a build, and optionally waits for a completion. Aside from general scripting use, this command can be used to invoke another job from within a build of one job. With the -s option, this command changes the exit code based on the outcome of the build (exit code 0 indicates a success) and interrupting the command will interrupt the job. With the -f option, this command changes the exit code based on the outcome of the build (exit code 0 indicates a success) however, unlike -s, interrupting the command will not interrupt the job (exit code 125 indicates the command was interrupted). With the -c option, a build will only run if there has been an SCM change. JOB : Name of the job to build -c : Check for SCM changes before starting the build, and if there\u0026#39;s no change, exit without doing a build -f : Follow the build progress. Like -s only interrupts are not passed through to the build. -p : Specify the build parameters in the key=value format. -s : Wait until the completion/abortion of the command. Interrupts are passed through to the build. -v : Prints out the console output of the build. Use with -s -w : Wait until the start of the command SSH å¯ç”¨SSH, ä½¿ç”¨éšæœºç«¯å£. ä¹Ÿå¯ä»¥ä½¿ç”¨å›ºå®šç«¯å£:\nè·å–SSHç«¯å£å·:\ncurl -Lv http://localhost:8080/login 2\u0026gt;\u0026amp;1 | grep \u0026#39;X-SSH-Endpoint\u0026#39; #\u0026lt; X-SSH-Endpoint: localhost:46059 ç”Ÿæˆssh key:\nssh-keygen -t rsa -b 4096 -C \u0026#34;admin\u0026#34; æ·»åŠ sshå…¬é’¥:\nhttp://localhost:8080/user/admin/configure ä¿®æ”¹ssh config, æ·»åŠ å¦‚ä¸‹é…ç½®:\nHost localhost IdentityFile ~/.ssh/id_rsa_jenkins_cli Port 46059 éªŒè¯:\nssh admin@localhost help add-job-to-view Adds jobs to view. build Builds a job, and optionally waits until its completion. cancel-quiet-down Cancel the effect of the \u0026#34;quiet-down\u0026#34; command. clear-queue Clears the build queue. connect-node Reconnect to a node(s) console Retrieves console output of a build. copy-job Copies a job. ... ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/jenkins-cli-enable/","tags":["Jenkins","DevOps"],"title":"å¯ç”¨Jenkins CLI"},{"categories":["ç¬”è®°"],"contents":"å› ä¸ºProcessTreeKillerçš„å­˜åœ¨, æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨shellå¯åŠ¨çš„è¿›ç¨‹åœ¨Jobå®Œæˆæ—¶éƒ½ä¼šè¢«killæ‰.\nå„ç§æœç´¢ä»¥åŠProcessTreeKilleræä¾›çš„è§£å†³æ–¹å¼æ˜¯ä¿®æ”¹BUILD_IDå’Œæ·»åŠ  -Dhudson.util.ProcessTree.disable=trueéƒ½æ— æ³•è§£å†³.\næœ€åå‚è€ƒStackOverflowå’ŒJenkins JIRA, ä¿®æ”¹JENKINS_NODE_COOKIEä¸ºä»»ä½•å€¼, å¦‚dontKillMe. è¿™ç§æ–¹æ³•å¯ä»¥è§£å†³, è®°å½•ä¸€ä¸‹. (æœç´¢æ’åé å‰çš„ç»“æœéƒ½ä¸å¯¹).\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/resolve-process-be-killed-after-jenkins-job-done/","tags":["Jenkins","DevOps"],"title":"Jenkins - è§£å†³execute shellä¸­å¯åŠ¨çš„è¿›ç¨‹è¢«åœ¨Jobé€€å‡ºæ—¶è¢«æ€æ­»é—®é¢˜"},{"categories":["äº‘åŸç”Ÿ","ç¬”è®°"],"contents":"MacOSç¯å¢ƒå®‰è£…minishift\nå®‰è£…minishift cli brew cask install minishift ä½¿ç”¨virtualboxå®‰è£… å®‰è£…çš„æ—¶å€™å¯ä»¥æŒ‡å®šHTTPä»£ç†, æ‹‰å–å¢™å¤–é•œåƒæ—¶éœ€è¦; è¿˜å¯ä»¥æŒ‡å®šinsecureçš„é•œåƒåº“.\nminishift start --docker-env HTTP_PROXY=\u0026#34;192.168.99.1:1087\u0026#34; --docker-env HTTPS_PROXY=\u0026#34;192.168.99.1:1087\u0026#34; --docker-env NO_PROXY=\u0026#34;192.168.0.0/16,172.30.0.0/16\u0026#34; --insecure-registry=\u0026#34;192.168.1.34\u0026#34; --vm-driver=virtualbox å¯åŠ¨ minishift start --vm-driver=virtualbox åˆ é™¤ minishift delete æ‰“å¼€Openshiftæ§åˆ¶é¢æ¿ minishift dashboard è·å–é›†ç¾¤ipåœ°å€ minishift ip å®‰è£…Openshift Cli brew install openshift-cli å¯ä»¥ä½¿ç”¨openshift cliè¿›è¡Œæ“ä½œ. minishiftå®‰è£…å®Œæˆåä¼šå°†é…ç½®ä¿¡æ¯å†™å…¥åˆ°ä¸»æœºçš„ç”¨æˆ·ç›®å½•ä¸‹, $HOME/.kubeç›®å½•ä¸‹é™¤äº†configä¿¡æ¯, è¿˜æœ‰openshiftçš„é›†ç¾¤ä¿¡æ¯åŠæ”¯æŒçš„api.\noc login -u system:admin oc get pods --all-namespaces ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/install-minishift-on-mac/","tags":["Kubernetes","Openshift","macOS"],"title":"macOS å®‰è£… minishift"},{"categories":["ç¬”è®°","æºç è§£æ"],"contents":"Spring Cloudå¯¹Netflix Zuulåšäº†å°è£…é›†æˆ, ä½¿å¾—åœ¨Spring Cloudç¯å¢ƒä¸­ä½¿ç”¨Zuulæ›´æ–¹ä¾¿. Netflix Zuulç›¸å…³åˆ†æè¯·çœ‹ä¸Šä¸€ç¯‡.\nå®ç° @EnableZuulProxy ä¸ @EnableZuulServer äºŒè€…çš„åŒºåˆ«åœ¨äºå‰è€…ä½¿ç”¨äº†æœåŠ¡å‘ç°ä½œä¸ºè·¯ç”±å¯»å€, å¹¶ä½¿ç”¨Ribbonåšå®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡; åè€…æ²¡æœ‰ä½¿ç”¨. Zuul serverçš„è·¯ç”±éƒ½é€šè¿‡ZuulPropertiesè¿›è¡Œé…ç½®.\nå…·ä½“å®ç°: ä½¿ç”¨ZuulController(ServletWrappingControllerçš„å­ç±»)å°è£…ZuulServletå®ä¾‹, å¤„ç†ä»DispatcherServletè¿›æ¥çš„è¯·æ±‚. ZuulHandlerMappingè´Ÿè´£æ³¨å†Œhandler mapping, å°†Routeçš„fullPathçš„è¯·æ±‚äº¤ç”±ZuulControllerå¤„ç†. åŒæ—¶ä½¿ç”¨ServletRegistrationBeanæ³¨å†ŒZuulServlet, é»˜è®¤ä½¿ç”¨/zuulä½œä¸ºurlMapping. æ‰€æœ‰æ¥è‡ªä»¥/zuulå¼€å¤´çš„pathçš„è¯·æ±‚éƒ½ä¼šç›´æ¥è¿›å…¥ZuulServlet, ä¸ä¼šè¿›å…¥DispatcherServlet. ä½¿ç”¨æ³¨è§£ @EnableZuulProxyå¼•å…¥äº†ZuulProxyMarkerConfiguration, ZuulProxyMarkerConfigurationåªåšäº†ä¸€ä»¶äº‹, å®ä¾‹åŒ–äº†å†…éƒ¨ç±»Marker.\n@Configuration public class ZuulProxyMarkerConfiguration { @Bean public Marker zuulProxyMarkerBean() { return new Marker(); } class Marker { } } @EnableZuulServerå¼•å…¥äº†ZuulServerMarkerConfiguration, ZuulServerMarkerConfigurationä¹Ÿåªåšäº†ä¸€ä»¶äº‹: å®ä¾‹åŒ–äº†å†…éƒ¨ç±»Marker\n@Configuration public class ZuulServerMarkerConfiguration { @Bean public Marker zuulServerMarkerBean() { return new Marker(); } class Marker { } } EnableAutoConfiguration é¡¹ç›®ä¸­ä½¿ç”¨@EnableAutoConfigurationæ³¨è§£, å¼€å¯Springä¸Šä¸‹æ–‡å¯¹è±¡çš„è‡ªåŠ¨é…ç½®åŠŸèƒ½, å°è¯•å»çŒœæµ‹å’Œå®ä¾‹åŒ–ä½ å¯èƒ½éœ€è¦çš„bean.\nè¿™ä¸ªåŠŸèƒ½æ˜¯åŸºäºclassPathæ¥å®Œæˆçš„. æ¯”å¦‚: é¡¹ç›®ä¸­å¼•ç”¨äº†tomcat-embedded.jar, ä½ å¯èƒ½éœ€è¦ä¸€ä¸ªTomcatEmbeddedServletContainerFactoryå®ä¾‹, é™¤éå®šä¹‰äº†è‡ªå·±çš„EmbeddedServletContainerFactoryå®ä¾‹.\næˆ‘ä»¬æ¥æ¥ç€çœ‹, åœ¨spring-cloud-netflix-coreçš„spring.factoriesä¸­çš„org.springframework.boot.autoconfigure.EnableAutoConfigurationå®ç°ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°org.springframework.cloud.netflix.zuul.ZuulProxyAutoConfigurationå’Œorg.springframework.cloud.netflix.zuul.ZuulServerAutoConfiguration\nZuulServerAutoConfiguration å®ƒçš„åˆå§‹åŒ–æ¡ä»¶æœ‰ä¸¤ä¸ª:\n@ConditionalOnClass(ZuulServlet.class)æŒ‡å®šclasspathä¸­éœ€è¦æœ‰ZuulServlet.class. è¿™ä¸ªservletè´Ÿè´£å¯¹æ‰€æœ‰è¿›å…¥Zuul serverçš„è¯·æ±‚ä»¥åŠé…ç½®åº”ç”¨æŒ‡å®šçš„preRoute, route, postRouteå’Œerror. @ConditionalOnBean(ZuulServerMarkerConfiguration.Marker.class) ä¸@EnableZuulServeræ³¨è§£å‘¼åº”. â€‹java @Configuration @EnableConfigurationProperties({ ZuulProperties.class }) @ConditionalOnClass(ZuulServlet.class) @ConditionalOnBean(ZuulServerMarkerConfiguration.Marker.class) // Make sure to get the ServerProperties from the same place as a normal web app would @Import(ServerPropertiesAutoConfiguration.class) public class ZuulServerAutoConfiguration { ... } â€‹\nZuulProxyAutoConfiguration å®ƒæœ‰ä¸€ä¸ªåˆå§‹åŒ–çš„æ¡ä»¶@ConditionalOnBean(ZuulProxyMarkerConfiguration.Marker.class), å°±æ˜¯ä¸Šä¸‹æ–‡ä¸­éœ€è¦æœ‰ZuulProxyMarkerConfiguration.Markerè¿™ä¸ªå†…éƒ¨ç±»çš„bean. ä¸@EnableZuulProxyæ³¨è§£å‘¼åº”.\nåˆå§‹åŒ–åŒ…æ‹¬å†…ç½®çš„filter, ä»¥åŠDiscovery, Ribbonç­‰çš„åˆå§‹åŒ–.\n@Configuration @Import({ RibbonCommandFactoryConfiguration.RestClientRibbonConfiguration.class, RibbonCommandFactoryConfiguration.OkHttpRibbonConfiguration.class, RibbonCommandFactoryConfiguration.HttpClientRibbonConfiguration.class }) @ConditionalOnBean(ZuulProxyMarkerConfiguration.Marker.class) public class ZuulProxyAutoConfiguration extends ZuulServerAutoConfiguration { ... } â€‹\nZuulServerAutoConfiguration è¯¦è§£ //å£°æ˜é…ç½® @Configuration //é…ç½®ZuulPropertieså®ä¾‹ @EnableConfigurationProperties({ ZuulProperties.class }) //æ¡ä»¶1 å­˜åœ¨ZuulServlet.class @ConditionalOnClass(ZuulServlet.class) //æ¡ä»¶2 å­˜åœ¨ZuulServerMarkerConfiguration.Marker.class bean, å³åº”ç”¨ä½¿ç”¨@EnableZuulServeræ³¨è§£ @ConditionalOnBean(ZuulServerMarkerConfiguration.Marker.class) //é…ç½®ServerPropertieså®ä¾‹ // Make sure to get the ServerProperties from the same place as a normal web app would @Import(ServerPropertiesAutoConfiguration.class) public class ZuulServerAutoConfiguration { @Autowired protected ZuulProperties zuulProperties; @Autowired protected ServerProperties server; @Autowired(required = false) private ErrorController errorController; @Bean public HasFeatures zuulFeature() { return HasFeatures.namedFeature(\u0026#34;Zuul (Simple)\u0026#34;, ZuulServerAutoConfiguration.class); } //å¤åˆç»“æ„çš„RouteLocator @Bean @Primary public CompositeRouteLocator primaryRouteLocator( Collection\u0026lt;RouteLocator\u0026gt; routeLocators) { return new CompositeRouteLocator(routeLocators); } //æ²¡æœ‰SimpleRouteLocator.classçš„beanæ—¶, ä½¿ç”¨zuulPropertieså®ä¾‹åŒ–ä¸€ä¸ªSimpleRouteLocatorå®ä¾‹. @Bean @ConditionalOnMissingBean(SimpleRouteLocator.class) public SimpleRouteLocator simpleRouteLocator() { return new SimpleRouteLocator(this.server.getServletPrefix(), this.zuulProperties); } //zuulController, åŒ…è£…äº†ä¸€ä¸ªZuulServletç±»å‹çš„servlet, å®ç°å¯¹ZuulServletç±»å‹çš„servletçš„åˆå§‹åŒ–. @Bean public ZuulController zuulController() { return new ZuulController(); } @Bean public ZuulHandlerMapping zuulHandlerMapping(RouteLocator routes) { ZuulHandlerMapping mapping = new ZuulHandlerMapping(routes, zuulController()); mapping.setErrorController(this.errorController); return mapping; } @Bean public ApplicationListener\u0026lt;ApplicationEvent\u0026gt; zuulRefreshRoutesListener() { return new ZuulRefreshListener(); } @Bean @ConditionalOnMissingBean(name = \u0026#34;zuulServlet\u0026#34;) public ServletRegistrationBean zuulServlet() { ServletRegistrationBean servlet = new ServletRegistrationBean(new ZuulServlet(), this.zuulProperties.getServletPattern()); // The whole point of exposing this servlet is to provide a route that doesn\u0026#39;t // buffer requests. servlet.addInitParameter(\u0026#34;buffer-requests\u0026#34;, \u0026#34;false\u0026#34;); return servlet; } // pre filters @Bean public ServletDetectionFilter servletDetectionFilter() { return new ServletDetectionFilter(); } @Bean public FormBodyWrapperFilter formBodyWrapperFilter() { return new FormBodyWrapperFilter(); } @Bean public DebugFilter debugFilter() { return new DebugFilter(); } @Bean public Servlet30WrapperFilter servlet30WrapperFilter() { return new Servlet30WrapperFilter(); } // post filters @Bean public SendResponseFilter sendResponseFilter() { return new SendResponseFilter(); } @Bean public SendErrorFilter sendErrorFilter() { return new SendErrorFilter(); } @Bean public SendForwardFilter sendForwardFilter() { return new SendForwardFilter(); } @Bean @ConditionalOnProperty(value = \u0026#34;zuul.ribbon.eager-load.enabled\u0026#34;, matchIfMissing = false) public ZuulRouteApplicationContextInitializer zuulRoutesApplicationContextInitiazer( SpringClientFactory springClientFactory) { return new ZuulRouteApplicationContextInitializer(springClientFactory, zuulProperties); } @Configuration protected static class ZuulFilterConfiguration { @Autowired private Map\u0026lt;String, ZuulFilter\u0026gt; filters; @Bean public ZuulFilterInitializer zuulFilterInitializer( CounterFactory counterFactory, TracerFactory tracerFactory) { FilterLoader filterLoader = FilterLoader.getInstance(); FilterRegistry filterRegistry = FilterRegistry.instance(); return new ZuulFilterInitializer(this.filters, counterFactory, tracerFactory, filterLoader, filterRegistry); } } @Configuration @ConditionalOnClass(CounterService.class) protected static class ZuulCounterFactoryConfiguration { @Bean @ConditionalOnBean(CounterService.class) public CounterFactory counterFactory(CounterService counterService) { return new DefaultCounterFactory(counterService); } } @Configuration protected static class ZuulMetricsConfiguration { @Bean @ConditionalOnMissingBean(CounterFactory.class) public CounterFactory counterFactory() { return new EmptyCounterFactory(); } @ConditionalOnMissingBean(TracerFactory.class) @Bean public TracerFactory tracerFactory() { return new EmptyTracerFactory(); } } private static class ZuulRefreshListener implements ApplicationListener\u0026lt;ApplicationEvent\u0026gt; { @Autowired private ZuulHandlerMapping zuulHandlerMapping; private HeartbeatMonitor heartbeatMonitor = new HeartbeatMonitor(); @Override public void onApplicationEvent(ApplicationEvent event) { if (event instanceof ContextRefreshedEvent || event instanceof RefreshScopeRefreshedEvent || event instanceof RoutesRefreshedEvent) { this.zuulHandlerMapping.setDirty(true); } else if (event instanceof HeartbeatEvent) { if (this.heartbeatMonitor.update(((HeartbeatEvent) event).getValue())) { this.zuulHandlerMapping.setDirty(true); } } } } } ZuulProxyAutoConfiguration è¯¦è§£ â€‹```java //å£°æ˜é…ç½® @Configuration //å¼•å…¥RibbonCommandFactoryé…ç½® @Import({ RibbonCommandFactoryConfiguration.RestClientRibbonConfiguration.class, RibbonCommandFactoryConfiguration.OkHttpRibbonConfiguration.class, RibbonCommandFactoryConfiguration.HttpClientRibbonConfiguration.class, HttpClientConfiguration.class }) //é…ç½®ç”Ÿæ•ˆæ¡ä»¶ @ConditionalOnBean(ZuulProxyMarkerConfiguration.Marker.class) public class ZuulProxyAutoConfiguration extends ZuulServerAutoConfiguration { @SuppressWarnings(\u0026quot;rawtypes\u0026quot;) @Autowired(required = false) private List\u0026lt;RibbonRequestCustomizer\u0026gt; requestCustomizers = Collections.emptyList(); //ç½‘å…³æœåŠ¡æ³¨å†Œå®ä¾‹ä¿¡æ¯ @Autowired(required = false) private Registration registration; //æœåŠ¡å‘ç°å®¢æˆ·ç«¯ @Autowired private DiscoveryClient discovery; //serviceIdå’Œè·¯ç”±çš„æ˜ å°„é€»è¾‘, é»˜è®¤ä¸ºç›¸åŒ @Autowired private ServiceRouteMapper serviceRouteMapper; @Override public HasFeatures zuulFeature() { return HasFeatures.namedFeature(\u0026quot;Zuul (Discovery)\u0026quot;, ZuulProxyAutoConfiguration.class); } //é™æ€å’ŒåŠ¨æ€è·¯ç”±å¯»å€: é™æ€ä»é…ç½®æ–‡ä»¶è·å–, åŠ¨æ€é€šè¿‡æœåŠ¡å‘ç°å®¢æˆ·ç«¯å®Œæˆ. åè€…ä¼˜å…ˆçº§æ›´é«˜ @Bean @ConditionalOnMissingBean(DiscoveryClientRouteLocator.class) public DiscoveryClientRouteLocator discoveryRouteLocator() { return new DiscoveryClientRouteLocator(this.server.getServletPrefix(), this.discovery, this.zuulProperties, this.serviceRouteMapper, this.registration); } //è£…é¥°è¿‡æ»¤å™¨ // pre filters @Bean public PreDecorationFilter preDecorationFilter(RouteLocator routeLocator, ProxyRequestHelper proxyRequestHelper) { return new PreDecorationFilter(routeLocator, this.server.getServletPrefix(), this.zuulProperties, proxyRequestHelper); } //åŸºäºRibbonè·¯ç”±è¿‡æ»¤å™¨ // route filters @Bean public RibbonRoutingFilter ribbonRoutingFilter(ProxyRequestHelper helper, RibbonCommandFactory\u0026lt;?\u0026gt; ribbonCommandFactory) { RibbonRoutingFilter filter = new RibbonRoutingFilter(helper, ribbonCommandFactory, this.requestCustomizers); return filter; } //åŸºäºhostçš„è·¯ç”±è¿‡æ»¤å™¨ @Bean @ConditionalOnMissingBean({SimpleHostRoutingFilter.class, CloseableHttpClient.class}) public SimpleHostRoutingFilter simpleHostRoutingFilter(ProxyRequestHelper helper, ZuulProperties zuulProperties, ApacheHttpClientConnectionManagerFactory connectionManagerFactory, ApacheHttpClientFactory httpClientFactory) { return new SimpleHostRoutingFilter(helper, zuulProperties, connectionManagerFactory, httpClientFactory); } @Bean @ConditionalOnMissingBean({SimpleHostRoutingFilter.class}) public SimpleHostRoutingFilter simpleHostRoutingFilter2(ProxyRequestHelper helper, ZuulProperties zuulProperties, CloseableHttpClient httpClient) { return new SimpleHostRoutingFilter(helper, zuulProperties, httpClient); } //æœåŠ¡å‘ç°å¯»å€åˆ·æ–°ç›‘å¬å™¨ @Bean public ApplicationListener\u0026lt;ApplicationEvent\u0026gt; zuulDiscoveryRefreshRoutesListener() { return new ZuulDiscoveryRefreshListener(); } @Bean @ConditionalOnMissingBean(ServiceRouteMapper.class) public ServiceRouteMapper serviceRouteMapper() { return new SimpleServiceRouteMapper(); } @Configuration @ConditionalOnMissingClass(\u0026quot;org.springframework.boot.actuate.endpoint.Endpoint\u0026quot;) protected static class NoActuatorConfiguration { @Bean public ProxyRequestHelper proxyRequestHelper(ZuulProperties zuulProperties) { ProxyRequestHelper helper = new ProxyRequestHelper(); helper.setIgnoredHeaders(zuulProperties.getIgnoredHeaders()); helper.setTraceRequestBody(zuulProperties.isTraceRequestBody()); return helper; } } @Configuration @ConditionalOnClass(Endpoint.class) protected static class EndpointConfiguration { @Autowired(required = false) private TraceRepository traces; @ConditionalOnEnabledEndpoint(\u0026quot;routes\u0026quot;) @Bean public RoutesEndpoint routesEndpoint(RouteLocator routeLocator) { return new RoutesEndpoint(routeLocator); } @ConditionalOnEnabledEndpoint(\u0026quot;routes\u0026quot;) @Bean public RoutesMvcEndpoint routesMvcEndpoint(RouteLocator routeLocator, RoutesEndpoint endpoint) { return new RoutesMvcEndpoint(endpoint, routeLocator); } @ConditionalOnEnabledEndpoint(\u0026quot;filters\u0026quot;) @Bean public FiltersEndpoint filtersEndpoint() { FilterRegistry filterRegistry = FilterRegistry.instance(); return new FiltersEndpoint(filterRegistry); } @Bean public ProxyRequestHelper proxyRequestHelper(ZuulProperties zuulProperties) { TraceProxyRequestHelper helper = new TraceProxyRequestHelper(); if (this.traces != null) { helper.setTraces(this.traces); } helper.setIgnoredHeaders(zuulProperties.getIgnoredHeaders()); helper.setTraceRequestBody(zuulProperties.isTraceRequestBody()); return helper; } } private static class ZuulDiscoveryRefreshListener implements ApplicationListener\u0026lt;ApplicationEvent\u0026gt; { private HeartbeatMonitor monitor = new HeartbeatMonitor(); @Autowired private ZuulHandlerMapping zuulHandlerMapping; @Override public void onApplicationEvent(ApplicationEvent event) { if (event instanceof InstanceRegisteredEvent) { reset(); } else if (event instanceof ParentHeartbeatEvent) { ParentHeartbeatEvent e = (ParentHeartbeatEvent) event; resetIfNeeded(e.getValue()); } else if (event instanceof HeartbeatEvent) { HeartbeatEvent e = (HeartbeatEvent) event; resetIfNeeded(e.getValue()); } } private void resetIfNeeded(Object value) { if (this.monitor.update(value)) { reset(); } } private void reset() { this.zuulHandlerMapping.setDirty(true); } } } â€‹``` é…ç½®é¡¹ zuul.servletPath é»˜è®¤ä¸º*/zuul*, æ³¨å†ŒZuulServletçš„æ—¶å€™ä½œä¸ºurlMappingä½¿ç”¨. å³æ‰€æœ‰æ¥è‡ªä»¥*/zuul*å¼€å¤´çš„pathéƒ½ä¼šç”±ZuulServletå¤„ç†.\nzuul.ignoredPatterns Zuulä½¿ç”¨ZuulControllerå°è£…äº†ZuulServlet. æ‰€æœ‰è¿›å…¥Zuulçš„è¯·æ±‚çš„å…¥å£éƒ½æ˜¯ZuulController. ZuulControllerçš„ZuulHandlerMappingé»˜è®¤æŠŠzuul.routes.[ITEM].pathçš„è¯·æ±‚äº¤ç»™ZuulServletå¤„ç†. å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„pathçš„route, åˆ™ä¼šèµ°å…¶ä»–çš„DispatcherServlet\nzuul.ignoredPatternsä½œç”¨å°±æ˜¯è¿›å…¥Zuulçš„è¯·æ±‚, åªè¦matchéƒ½ä¼šç›´æ¥äº¤ç”±å…¶ä»–çš„DispatcherServletå¤„ç†, è€Œä¸éœ€è¦å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”pathçš„route.\n\u0026hellip;\nè¿‡æ»¤å™¨ ZuulServerAutoConfiguration ServletDetectionFilter æ£€æŸ¥è¯·æ±‚çš„å…¥å£æ˜¯DispatcherServletè¿˜æ˜¯ZuulServlet å¦‚æœæ˜¯DispatcherServletè¿›æ¥çš„è¯·æ±‚, å°†RequestContextä¸­çš„å±æ€§isDispatcherServletRequestè®¾ç½®ä¸ºture.\næ£€æŸ¥çš„æ–¹æ³•æ˜¯åˆ¤æ–­RequestContextä¸­çš„è¯·æ±‚ç±»å‹æ˜¯å¦ä¸ºHttpServletRequestWrapperç±»å‹, å› ä¸ºZuulServletè¿›æ¥çš„è¯·æ±‚ä¼šä½¿ç”¨HttpServletRequestWrapperè¿›è¡Œå†æ¬¡å°è£…; åŒæ—¶æ£€æŸ¥è¯·æ±‚ä¸­ä¸­æ˜¯å¦æœ‰DispatcherServlet.CONTEXTå±æ€§, å› ä¸ºDispatcherServletè¿›æ¥çš„è¯·æ±‚ä¼šå¸¦æœ‰è¯¥å±æ€§.\nFormBodyWrapperFilter ä¸ºä¸‹æ¸¸çš„æœåŠ¡è§£æè¡¨å•æ•°æ®, å¹¶é‡æ–°ç¼–ç . åªé’ˆå¯¹multipart/form-dataå’Œapplication/x-www-form-urlencodedç±»å‹çš„è¯·æ±‚.\nDebugFilter é€šè¿‡è®¾ç½®zuul.debug.parameterå±æ€§æ§åˆ¶, é»˜è®¤å¯ç”¨. æ‰§è¡Œæ—¶å°†ä¸Šä¸‹æ–‡ä¸­çš„debugRoutingå’ŒdebugRequestè®¾ç½®ä¸ºtrue\nServlet30WrapperFilter ä½¿ç”¨Servlet30RequestWrapperå°è£…è¯·æ±‚, å¼ºåˆ¶å¯ç”¨.\nSendResponseFilter åæ‰§è¡Œçš„è¿‡æ»¤å™¨, è´Ÿè´£å°†ä»£ç†è¯·æ±‚çš„å“åº”å†™å…¥å½“å‰çš„è¯·æ±‚çš„å“åº”ä¸­.\nZuulProxyAutoConfiguration PreDecorationFilter Preç±»å‹çš„è¿‡æ»¤å™¨, é€šè¿‡æä¾›çš„RouteLocatorå†³å®šå°†å¦‚ä½•è¯·æ±‚è·¯ç”±åˆ°å“ªé‡Œå’Œå¦‚ä½•è·¯ç”±. åŒæ—¶ä¸ºä¸‹æ¸¸è¯·æ±‚æ·»åŠ å¤šä¸ªä¸ä»£ç†ç›¸å…³çš„å¤´ä¿¡æ¯. å½“RequestContextä¸­ä¸å­˜åœ¨FORWARD_TO_KEYå’ŒSERVICE_ID_KEYä¿¡æ¯æ—¶ç”Ÿæ•ˆ.\nå°†è·¯ç”±åˆ¤æ–­ç»“æœå†™å…¥routeHost, FORWARD_TO_KEYæˆ–è€…SERVICE_ID_KEY.\nRibbonRoutingFilter Routeç±»å‹çš„è¿‡æ»¤å™¨, å½“RequestContextä¸­routeHostä¸ºç©º, ä¸”æœ‰serviceIdå€¼æ—¶ç”Ÿæ•ˆ.\nä½¿ç”¨RequestContextæ„å»ºRibbonCommandContext, é€šè¿‡RibbonCommandFactoryè¿›è€Œåˆ›å»ºRibbonCommandå¹¶æ‰§è¡Œ. æœ€åé€šè¿‡ProxyRequestHelperå°†å“åº”ç»“æœè®°å½•åˆ°RequestContextä¸­.\nSimpleHostRoutingFilter Routeç±»å‹çš„è¿‡æ»¤å™¨, å½“RequestContextä¸­çš„routeHostä¸ä¸ºç©ºæ—¶ç”Ÿæ•ˆ. ä½¿ç”¨Apacheçš„HttpClientå‘é€è¯·æ±‚\nç›‘å¬å™¨ ZuulRefreshListener é€šè¿‡ç›‘å¬åº”ç”¨ç¨‹åºäº‹ä»¶(ContextRefreshedEvent, RefreshScopeRefreshedEvent, RoutesRefreshedEventå’ŒRoutesRefreshedEvent)æ›´æ–°handler mappingçš„æ³¨å†Œä¿¡æ¯. å‰ä¸¤ä¸ªäº‹ä»¶åœ¨ContextRefreshæ—¶å‘å‡º; ç¬¬ä¸‰ä¸ªæ˜¯é€šè¿‡JMXé‡ç½®è·¯ç”±æ—¶å‘å‡º(å‚è€ƒRoutesMvcEndpoint); æœ€åä¸€ä¸ªæ˜¯DiscoveryClientæ¯æ¬¡æ‹‰å–æœåŠ¡æ³¨å†Œä¿¡æ¯åå‘å‡º.\næ”¶åˆ°äº‹ä»¶å, å°†ZuulHandlerMappingçš„dirtyå˜é‡ç½®ä¸ºtrue, å½“ä¸‹æ¬¡è¯·æ±‚è¿›æ¥æ—¶, æ£€æŸ¥åˆ°dirtyä¸ºtrue, å°±ä¼šé‡æ–°æ³¨å†Œurl mapping.\nZuulDiscoveryRefreshListener ç›‘å¬åº”ç”¨ç¨‹åºäº‹ä»¶(InstanceRegisteredEvent, ParentHeartbeatEventå’ŒHeartbeatEvent)æ›´æ–°handler mappingçš„æ³¨å†Œä¿¡æ¯.\nInstanceRegisteredEventå½“å‰è·¯ç”±æœåŠ¡å®ä¾‹å®ŒæˆæœåŠ¡æ³¨å†Œåå‘å‡ºçš„äº‹ä»¶. ParentHeartbeatEventå½“DiscoveryClientå®šä½åˆ°Config ServeræœåŠ¡çš„æ—¶å€™æœ‰bootstrapContextå‘ç»™åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡çš„äº‹ä»¶. HeartbeatEventç”±DiscoveryClientæ¯æ¬¡æ‹‰å–æœåŠ¡æ³¨å†Œä¿¡æ¯åå‘å‡º.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/spring-cloud-zuul-breakdown/","tags":["Spring"],"title":"Spring Cloud Zuulè¯¦è§£"},{"categories":["æºç è§£æ"],"contents":"ä¹‹å‰åˆ†æè¿‡Spring Cloudçš„EurekaæœåŠ¡å‘ç°, ä»Šå¤©åˆ†æä¸€ä¸‹æœåŠ¡æ³¨å†Œ.\né…ç½® BootstrapConfiguration EurekaDiscoveryClientConfigServiceBootstrapConfiguration spring-cloud-configç¯å¢ƒä¸­ä½¿ç”¨çš„é…ç½®\nå¼•å…¥EurekaDiscoveryClientConfigurationå’ŒEurekaClientAutoConfiguration\nEurekaDiscoveryClientConfiguration åœ¨spring-cloudä¸­(é€šè¿‡æ˜¯å¦å­˜åœ¨RefreshScopeRefreshedEvent.classåˆ¤æ–­), æ·»åŠ RefreshScopeRefreshedEventçš„listener. æ”¶åˆ°äº‹ä»¶åé‡æ–°æ³¨å†Œå®ä¾‹. åœ¨eureka.client.healthcheck.enabledè®¾ç½®ä¸ºtrueæ—¶, æ³¨å†ŒEurekaHealthCheckHandlerbean. EurekaHealthCheckHandlerè´Ÿè´£å°†åº”ç”¨çŠ¶æ€æ˜ å°„ä¸ºå®ä¾‹çŠ¶æ€InstanceStatus. EurekaClientAutoConfiguration æ”¯æŒspring-cloudå’Œéspring-cloudç¯å¢ƒ, åœ¨spring-cloudç¯å¢ƒä¸­, ä¸‹é¢ä¸¤ä¸ªbeanè¦ä½¿ç”¨@RefreshScopeæ ‡æ³¨\nå®ä¾‹åŒ–EurekaClientbean, åœ¨spring-cloudä¸­ä½¿ç”¨å®ç°ç±»CloudEurekaClient. ä½¿ç”¨EurekaInstanceConfigå®ä¾‹, å®ä¾‹åŒ–ApplicationInfoManagerbean EnableAutoConfiguration EurekaClientConfigServerAutoConfiguration åœ¨spring-cloud-configçš„ç¯å¢ƒä¸­, å°†configPathåŠ å…¥åˆ°å®ä¾‹çš„metadata mapä¸­.\nEurekaDiscoveryClientConfigServiceAutoConfiguration å½“configå®¢æˆ·ç«¯å¸Œæœ›é€šè¿‡æœåŠ¡å‘ç°å¯»æ‰¾configæœåŠ¡çš„æ—¶å€™ä½¿ç”¨çš„å¼•å¯¼é…ç½®\nåœ¨spring.cloud.config.discovery.enabledä¸ºtrueæ—¶, å…³é—­çˆ¶application contexté‡Œå®ä¾‹åŒ–çš„EurekaClientå®ä¾‹. åªä½¿ç”¨å½“å‰ä¸Šä¸‹æ–‡é‡Œçš„å®ä¾‹.\nEurekaClientAutoConfiguration æ ¸å¿ƒé…ç½® æ”¯æŒspring-cloud(æ”¯æŒåŠ¨æ€é…ç½®)å’Œéspring-cloudç¯å¢ƒ, EurekaClientå’ŒEurekaInstanceConfigä¸¤ä¸ªbeanè¦ä½¿ç”¨@RefreshScopeæ ‡æ³¨\nå®ä¾‹åŒ–å½“å‰æœåŠ¡å®ä¾‹ä¿¡æ¯EurekaInstanceConfigBeançš„å®ä¾‹ å®ä¾‹åŒ–DiscoveryClientçš„å®ç°, åœ¨è¿™é‡Œæ˜¯EurekaDiscoveryClient å®ä¾‹åŒ–EurekaServiceRegistry å®ä¾‹åŒ–EurekaRegistration å®ä¾‹åŒ–EurekaAutoServiceRegistration, è¿™ä¸ªç±»å®ç°äº†StartLifecycleæ¥å£. åœ¨ApplicationContext refreshæˆ–è€…shutdownä¹‹åæ³¨å†Œæˆ–è€…æ³¨é”€å½“å‰å®ä¾‹ å®ä¾‹åŒ–EurekaClientbean, åœ¨spring-cloudä¸­ä½¿ç”¨å®ç°ç±»CloudEurekaClient ä½¿ç”¨EurekaInstanceConfigå®ä¾‹, å®ä¾‹åŒ–ApplicationInfoManagerbean RibbonEurekaAutoConfiguration å½“å¯ç”¨Eureka client(eureka.client.enableä¸ºtrueå’Œribbon.eureka.enabledä¸ºtrueæ—¶, é»˜è®¤ä¸ºtrue)æ—¶é…ç½®é»˜è®¤åŸºäºeurekaçš„ribbon. ä½¿ç”¨EurekaRibbonClientConfigurationæä¾›çš„é…ç½®: RibbonPing, ServerList, ServerIntrospector.\nEurekaDiscoveryClientConfiguration æä¾›ç›‘å¬RefreshScopeRefreshedEventçš„ç›‘å¬å™¨, å½“äº‹ä»¶å‘ç”Ÿæ—¶æ³¨é”€å¹¶é‡æ–°æ³¨å†Œ(é˜²æ­¢metadataå‘ç”Ÿæ”¹å˜) æä¾›ä¸€ä¸ªé»˜è®¤çš„EurekaHealthCheckHandlerå®ä¾‹, å½“beanä¸å­˜åœ¨çš„ä¸”eureka.client.healthcheck.enabledä¸ºtrueæ—¶.\nä¸»è¦ç±» ServiceRegistry springæä¾›çš„æœåŠ¡å®ä¾‹æ³¨å†Œå’Œæ³¨é”€çš„æ¥å£.\nEurekaServiceRegistry ServiceRegistryçš„Eurekaå®ç°. æ³¨å†Œå’Œæ³¨é”€çš„å®ç°æ˜¯é€šè¿‡EurekaRegistrationçš„ApplicationInfoManagerä¿®æ”¹å®ä¾‹çŠ¶æ€å®ç°çš„.\nEurekaRegistration é€šè¿‡å®ç°ServiceInstanceæä¾›è®¿é—®å®ä¾‹ä¿¡æ¯çš„æ¥å£,\nApplicationInfoManager æä¾›ä¿®æ”¹å®ä¾‹çŠ¶æ€çš„æ¥å£, å¹¶é€šçŸ¥çŠ¶æ€å˜åŒ–çš„ç›‘å¬å™¨. æä¾›å†…éƒ¨ç±»StatusChangeListener. æä¾›æ³¨å†Œå’Œæ³¨é”€çŠ¶æ€å˜åŒ–ç›‘å¬å™¨çš„æ¥å£, Eurekaçš„DiscoveryClientä¸­é€šè¿‡åŒ¿åç±»çš„æ–¹å¼å®ç°äº†è¯¥æ¥å£, å½“å®ä¾‹çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶, åˆ·æ–°å®ä¾‹çŠ¶æ€.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/spring-cloud-service-registry-via-eureka/","tags":["Spring"],"title":"Spring Cloud - EurekaæœåŠ¡æ³¨å†Œ"},{"categories":["ç¬”è®°"],"contents":"åµŒå…¥å¼çš„zuulä»£ç†\nä½¿ç”¨äº†Netfilx OSSçš„å…¶ä»–ç»„ä»¶:\nHystrix ç†”æ–­ Ribbon è´Ÿè´£å‘é€å¤–å‡ºè¯·æ±‚çš„å®¢æˆ·ç«¯, æä¾›è½¯ä»¶è´Ÿè½½å‡è¡¡åŠŸèƒ½ Trubine å®æ—¶åœ°èšåˆç»†ç²’åº¦çš„metricsæ•°æ® Archaius åŠ¨æ€é…ç½® ä»‹ç» ç”±äº2.0åœæ­¢å¼€å‘ä¸”ä¼šæœ‰bug, æ•…ä¸‹é¢çš„åˆ†æåŸºäº1.xç‰ˆæœ¬.\nç‰¹æ€§ Authentication è®¤è¯ Insights æ´å¯Ÿ Stress Testing å‹åŠ›æµ‹è¯• Canary Testing é‡‘ä¸é›€æµ‹è¯• Dynamic Routing åŠ¨æ€è·¯ç”± Multi-Region Resiliency å¤šåŒºåŸŸå¼¹æ€§ Load Shedding è´Ÿè½½è„±è½ Security å®‰å…¨ Static Response handling é™æ€å“åº”å¤„ç† Multi-Region Resiliency ä¸»åŠ¨/ä¸»åŠ¨æµé‡ç®¡ç† Zuulæ ¸å¿ƒæ¶æ„ è¿‡æ»¤å™¨åŠ è½½å™¨ ä»æ–‡ä»¶ç›®å½•å®šæ—¶çš„ç›‘æ§æ–‡ä»¶, ç¼–è¯‘æˆClasså¹¶åŠ è½½åˆ°è¿‡æ»¤å™¨é“¾ä¸­.\nè´¯ç©¿æ•´ä¸ªè¯·æ±‚çš„RequestContext å°†Servletçš„è¯·æ±‚å’Œå“åº”åˆå§‹åŒ–æˆRequestContext, ä¿å­˜åœ¨ThreadLocalä¸­è´¯ç©¿æ•´ä¸ªè¯·æ±‚.\nä»¥åŠæ·»åŠ Netfixåº“çš„æŒ‡å®šæ¦‚å¿µå’Œæ•°æ®çš„æ‰©å±•å¯¹è±¡NFRequestContext, å¦‚Eureka\nå››ç§è¿‡æ»¤å™¨: preRoute route postRoute error Zuulè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ Zuul Netflix ä½¿ç”¨Netflixçš„å…¶ä»–ç»„ä»¶\nzullåœ¨Netfilxçš„åº”ç”¨ ç²¾ç¡®è·¯ç”± åˆ›å»ºä¸€ä¸ªè¿‡æ»¤å™¨æ˜¯ç‰¹å®šçš„ç”¨æˆ·æˆ–è€…è®¾å¤‡çš„è¯·æ±‚é‡å®šå‘åˆ°ç‹¬ç«‹çš„APIé›†ç¾¤è¾¾åˆ°è°ƒè¯•çš„ç›®çš„.\nå¤šåŒºåŸŸå¼¹ Zuulæ˜¯æˆ‘ä»¬ç§°ä¸ºåœ°å³¡(Isthmus)çš„å¤šåœ°åŒºELBå¼¹æ€§é¡¹ç›®çš„æ ¸å¿ƒ. ä½œä¸ºIsthmusçš„ä¸€éƒ¨åˆ†, Zuulè¢«ç”¨æ¥å°†è¯·æ±‚ä»è¥¿æµ·å²¸æ•°æ®ä¸­å¿ƒä¼ é€åˆ°ä¸œæµ·å²¸, ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„å…³é”®é¢†åŸŸçš„ELBä¸­å®ç°å¤šåŒºåŸŸå†—ä½™.\nå‹åŠ›æµ‹è¯• åœ¨Zuulè¿‡æ»¤å™¨ä¸­ä½¿ç”¨åŠ¨æ€Archaiusé…ç½®é€æ­¥æå‡è¿›å…¥ä¸€éƒ¨åˆ†æœåŠ¡å™¨çš„æµé‡, è‡ªåŠ¨å®ç°å‹åŠ›æµ‹è¯•.\nåŸç† å¦‚ä½•å·¥ä½œ StartServeråˆå§‹åŒ– å®ç°äº†ServletContextListeneræ¥å£, å¦‚æœéœ€è¦ä¸netflix osså…¶ä»–ç»„ä»¶é›†æˆ(å¦‚Eureka, Archaius)å®ä¾‹åŒ–çš„æ—¶å€™å¯åŠ¨ä¸€ä¸ªKaryonæœåŠ¡å™¨.\nåœ¨ServletContextåˆå§‹åŒ–å®Œæˆåè°ƒç”¨initGroovyFilterManagerå’ŒinitJavaFilters.\ninitGroovyFilterManager å‘è¿‡æ»¤å™¨æ³¨å†Œè¡¨ä¸­æ·»åŠ Groovyè¿‡æ»¤å™¨.\nprivate void initGroovyFilterManager() { //è®¾ç½®GroovyCompiler //GroovyCompileræ˜¯DynamicCompilerçš„å®ç°ç±» FilterLoader.getInstance().setCompiler(new GroovyCompiler()); //ä»é…ç½®ä¸­æ˜¯è·å–è¿‡æ»¤å™¨æºæ–‡ä»¶çš„æ ¹ç›®å½• String scriptRoot = System.getProperty(\u0026#34;zuul.filter.root\u0026#34;, \u0026#34;\u0026#34;); if (scriptRoot.length() \u0026gt; 0) scriptRoot = scriptRoot + File.separator; try { //è®¾ç½®æ–‡ä»¶åè¿‡æ»¤å™¨, è¿™é‡Œåªè¿‡æ»¤`.groovy`ç±»å‹æ–‡ä»¶. FilterFileManager.setFilenameFilter(new GroovyFileFilter()); //åˆå§‹åŒ–è¿‡æ»¤å™¨æ–‡ä»¶ç®¡ç†å™¨ //ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ‰«æç›®å½•çš„é—´éš”æ—¶é—´, å•ä½ä¸ºç§’ //åé¢è·Ÿè¦æ‰«æçš„å­ç›®å½• //1. åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰«æå„ä¸ªå­ç›®å½•, ä½¿ç”¨æ–‡ä»¶åè¿‡æ»¤å™¨è·å–åˆ°æ‰€æœ‰çš„è¿‡æ»¤å™¨æºæ–‡ä»¶. //2. éå†è¿™äº›æ–‡ä»¶, ä½¿ç”¨`FilterLoader.getInstance().putFilter(file)`, compilerç¼–è¯‘ä¹‹åä½¿ç”¨FilterFactoryè¿›è¡Œå®ä¾‹åŒ–, å¹¶æ·»åŠ åˆ°è¿‡æ»¤å™¨æ³¨å†Œè¡¨ä¸­. æ˜¯å¦å®ä¾‹åŒ–çš„é€»è¾‘åˆ¤æ–­æ˜¯å¦åœ¨ä¸Šæ¬¡ä¿®æ”¹ä¸”æ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´æ˜¯å¦ç›¸åŒ. å¦‚æœæ˜¯ä¸Šæ¬¡ä¿®æ”¹ä¹‹ååˆæœ‰æ”¹åŠ¨, è¦é‡å»ºæ”¹ç±»å‹è¿‡æ»¤å™¨çš„åˆ—è¡¨. å¦‚æœæ²¡æœ‰ä¿®æ”¹, å¯¹æ”¹æ–‡ä»¶ä¸åšä»»ä½•å¤„ç†. //3. å¯åŠ¨çº¿ç¨‹, æ¯ä¸ª5ç§’æ‰§è¡Œä¸€ä¸ª1å’Œ2çš„æ“ä½œ. FilterFileManager.init(5, scriptRoot + \u0026#34;pre\u0026#34;, scriptRoot + \u0026#34;route\u0026#34;, scriptRoot + \u0026#34;post\u0026#34;); } catch (Exception e) { throw new RuntimeException(e); } } initJavaFilters å‘è¿‡æ»¤å™¨æ³¨å†Œè¡¨ä¸­æ·»åŠ Javaè¿‡æ»¤å™¨.\n*å®˜æ–¹æ²¡æœ‰æä¾›ä»javaæºä»£ç åˆ°classsçš„ç¼–è¯‘å™¨.\nZuulServlet æ ¸å¿ƒzuul servlet, åˆå§‹åŒ–å’Œå¸æ‰zullFilterçš„è¿è¡Œ. ä½¿ç”¨ZuulRunnerå°†Servletçš„è¯·æ±‚å’Œå“åº”åˆå§‹åŒ–æˆRequestContext, å¹¶å°†FilterProcessorçš„è°ƒç”¨åŒ…è£…æˆpreRoute(), route(), postRoute()å’Œerror()æ–¹æ³•. åˆå§‹åŒ–æ—¶å¯ä»¥é€‰æ‹©å°†è¯·æ±‚åŒ…è£…æˆHttpServletRequestWrapperå¹¶ç¼“å†²è¯·æ±‚æ¶ˆæ¯ä½“.\nåˆå§‹åŒ–åçš„RequestContextä¼šæ”¾åœ¨ThreadLocalä¸­, ä¾›åç»­çš„filterè®¿é—®.\nServiceæ–¹æ³•\npublic void service(javax.servlet.ServletRequest servletRequest, javax.servlet.ServletResponse servletResponse) throws ServletException, IOException { try { init((HttpServletRequest) servletRequest, (HttpServletResponse) servletResponse); // Marks this request as having passed through the \u0026#34;Zuul engine\u0026#34;, as opposed to servlets // explicitly bound in web.xml, for which requests will not have the same data attached RequestContext context = RequestContext.getCurrentContext(); context.setZuulEngineRan(); try { preRoute(); } catch (ZuulException e) { error(e); postRoute(); return; } try { route(); } catch (ZuulException e) { error(e); postRoute(); return; } try { postRoute(); } catch (ZuulException e) { error(e); return; } } catch (Throwable e) { error(new ZuulException(e, 500, \u0026#34;UNHANDLED_EXCEPTION_\u0026#34; + e.getClass().getName())); } finally { RequestContext.getCurrentContext().unset(); } } é€šè¿‡FilterProcessor.getInstnace()è°ƒç”¨FilterProcessorçš„preRoute(), route(), postRoute()å’Œerror()æ–¹æ³•.\nå››ä¸ªæ–¹æ³•éƒ½æ˜¯é€šè¿‡FilterLoader.getInstance()è·å–å¯¹åº”ç±»å‹çš„filteråˆ—è¡¨.\néå†filteråˆ—è¡¨, è°ƒç”¨filterçš„runFilter()æ–¹æ³•.\n/** * runFilter checks !isFilterDisabled() and shouldFilter(). The run() method is invoked if both are true. * * @return the return from ZuulFilterResult */ public ZuulFilterResult runFilter() { ZuulFilterResult zr = new ZuulFilterResult(); //åŠ¨æ€è·å–`zuul.filerClassName.filterType.disable`çš„å€¼ //åŠ¨æ€è·å–ä½¿ç”¨Archaiusçš„DynamicPropertyFactoryè·å–*, é€šè¿‡è¿™ä¸ªå¯å®ç°åŠ¨æ€é…ç½® if (!isFilterDisabled()) { //è°ƒç”¨filterç±»çš„æ ¡éªŒé€»è¾‘ if (shouldFilter()) { Tracer t = TracerFactory.instance().startMicroTracer(\u0026#34;ZUUL::\u0026#34; + this.getClass().getSimpleName()); try { //æ‰§è¡Œfilterçš„é€»è¾‘å¤„ç† Object res = run(); //æ‰§è¡ŒæˆåŠŸ zr = new ZuulFilterResult(res, ExecutionStatus.SUCCESS); } catch (Throwable e) { t.setName(\u0026#34;ZUUL::\u0026#34; + this.getClass().getSimpleName() + \u0026#34; failed\u0026#34;); //æ‰§è¡Œå¤±è´¥ zr = new ZuulFilterResult(ExecutionStatus.FAILED); zr.setException(e); } finally { t.stopAndLog(); } } else { //filterä¸é€‚ç”¨, ç›´æ¥è·³è¿‡ zr = new ZuulFilterResult(ExecutionStatus.SKIPPED); } } return zr; } ContextLifecycleFilter æ¸…ç©ºThreadLocalä¸­çš„RequestContext\npublic void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException { try { chain.doFilter(req, res); } finally { RequestContext.getCurrentContext().unset(); } } è°ƒè¯• è°ƒè¯•ä¿¡æ¯ä¸­çš„åè¯\nZUUL_DEBUG è¾“å‡ºzuulçš„è¯Šæ–­ä¿¡æ¯ REQUEST_DUBG è¾“å‡ºHttpè¯·æ±‚çš„ä¿¡æ¯. REQUEST -\u0026gt; ZUUL -\u0026gt; ORIGIN_RESPONSE -\u0026gt; OUTBOUND REQUEST è¿›å…¥zuulçš„è¯·æ±‚ ZUUL zuulè½¬å‘ç»™åŸç›®æ ‡çš„è¯·æ±‚ ORIGIN_RESPONSE åŸç›®æ ‡è¿”å›çš„åŸå§‹å“åº” OUTBOND zuulè¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº” æ¥å£å’Œç±» æ¥å£ DynamicCodeCompiler ä»æºä»£ç ç¼–è¯‘æˆClassesçš„æ¥å£, ç›®å‰åªæœ‰ä¸€ä¸ªGroovyCompilerå®ç°ç±»\nFilterFactory ç”Ÿæˆç»™å®šçš„è¿‡æ»¤å™¨ç±»å®ä¾‹çš„æ¥å£, å®ç°ç±»DefaultFilterFactory\nFilterUsageNotifier æ³¨å†Œè¿‡æ»¤å™¨ä½¿ç”¨æ—¶çš„å›è°ƒçš„æ¥å£\nç±» DefaultFilterFactory ä½¿ç”¨åå°„å®ç°\npublic ZuulFilter newInstance(Class clazz) throws InstantiationException, IllegalAccessException { return (ZuulFilter) clazz.newInstance(); } FilterFileManager ä»è¿‡æ»¤å™¨ç›®å½•ä¸­è·å–ä¿®æ”¹å’Œæ–°å¢çš„Groovyè¿‡æ»¤å™¨æ–‡ä»¶.\nFilterLoader æŒæœ‰è¿‡æ»¤å™¨æ³¨å†Œè¡¨, åŠ è½½è¿‡æ»¤å™¨.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/learn-netflix-zuul/","tags":["Java","Spring"],"title":"åˆè¯† Netflix Zuul"},{"categories":["ç¬”è®°"],"contents":"ä¸ºä»€ä¹ˆè¦è®¨è®ºè¿™ä¸ªé—®é¢˜, å·¥ä½œä¸­ä¸€ä¸ªåŒäº‹å†™çš„ç±»ä½¿ç”¨äº†ConfigurationProperties, åªæä¾›äº†æ ‡å‡†çš„setteræ–¹æ³•. å±æ€§çš„è®¿é—®, æä¾›äº†å®šåˆ¶çš„æ–¹æ³•. å¯ä»¥å‚è€ƒEurekaClientConfigBean.\nä»–ä½¿ç”¨çš„æ˜¯spring boot 2.0.0.M5ç‰ˆæœ¬, å¯ä»¥æ­£å¸¸è·å–é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å€¼, ä½†æ˜¯åœ¨1.5.8.RELEASEè·å–ä¸åˆ°.\nçœ‹ä¸‹æ–‡æ¡£å’Œæºç :\nAnnotation for externalized configuration. Add this to a class definition or a @Bean method in a @Configuration class if you want to bind and validate some external Properties (e.g. from a .properties file).\nå¤–ç½®é…ç½®çš„æ³¨è§£. å½“éœ€è¦ç»‘å®šå¤–ç½®é…ç½®(å¦‚propertiesæˆ–è€…yamlé…ç½®)çš„æ—¶å€™, å°†å…¶åŠ åˆ°ä½¿ç”¨äº†@Configurationæ³¨è§£çš„ç±»å£°æ˜å¤„æˆ–è€…@Beanæ ‡æ³¨çš„æ–¹æ³•ä¸Š.\nå€¼çš„ç»‘å®šæ˜¯é€šè¿‡ConfigurationPropertiesBindingPostProcessoråœ¨beanå®ä¾‹åˆ›å»ºå, åˆå§‹åŒ–å›è°ƒ(å¦‚InitializingBeançš„afterPropertiesSetæ–¹æ³•)æˆ–è€…init-methodä¹‹å‰ä¹‹å‰å®Œæˆçš„.\n1.5.x æ‰§è¡Œç»‘å®šçš„æ—¶å€™å¦‚æœæ‰¾ä¸åˆ°getteræ–¹æ³•, ä¼šæŠ›å‡ºRelaxedBindingNotWritablePropertyExceptionå¼‚å¸¸. debugæ¨¡å¼ä¸‹, ä¼šæ‰“å°Ignoring benign property binding failure.\n2.x 2.xç‰ˆæœ¬ä¸­, å¦‚æœæ‰¾ä¸åˆ°getteræ–¹æ³•, ä¼šå°†åŸå€¼é»˜è®¤ä¸ºnull, å¹¶ç»§ç»­æ‰§è¡Œç»‘å®š.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/configurationproperties-requires-getter-or-not/","tags":["Spring","Java"],"title":"ConfigurationPropertiesåˆ°åº•éœ€ä¸éœ€è¦getter"},{"categories":["ç¬”è®°"],"contents":"\nå¹¶å‘æ¨¡å¼ runner runnerå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨é€šé“æ¥ç›‘è§†ç¨‹åºçš„æ‰§è¡Œæ—¶é—´, å¦‚æœç¨‹åºæ‰§è¡Œæ—¶é—´å¤ªé•¿, ä¹Ÿå¯ä»¥ç”¨ç»ˆæ­¢ç¨‹åº. è¿™ä¸ªç¨‹åºå¯ç”¨ä½œcornä½œä¸šæ‰§è¡Œ\npackage runner import ( \u0026#34;os\u0026#34; \u0026#34;time\u0026#34; \u0026#34;errors\u0026#34; \u0026#34;os/signal\u0026#34; \u0026#34;log\u0026#34; ) type Runner struct { //ç³»ç»Ÿä¿¡å·é€šé“ interrupt chan os.Signal //ä»»åŠ¡æ‰§è¡Œç»“æœé€šé“ complete chan error //æŠ¥å‘Šä»»åŠ¡å¤„ç†å·²ç»è¶…æ—¶ timeout \u0026lt;-chan time.Time tasks []func(int) } //è¶…æ—¶é”™è¯¯ var ErrTimeout = errors.New(\u0026#34;received timeout\u0026#34;) //ç³»ç»Ÿç»ˆç«¯é”™è¯¯ var ErrInterrupt = errors.New(\u0026#34;received interrupt\u0026#34;) //è¿”å›ä¸€ä¸ªæ–°çš„å‡†å¤‡ä½¿ç”¨çš„Runner func New(d time.Duration) *Runner { return \u0026amp;Runner{ interrupt: make(chan os.Signal, 1), complete: make(chan error), timeout: time.After(d), //Afterå‡½æ•°ä¼šä½¿ç”¨goroutineå¯åŠ¨ä¸€ä¸ªtimer, timeræ—¶é—´åˆ°åå‘channelå†™å…¥Time } } //å‘Runnerä¸­æ·»åŠ task func (r *Runner) AddTask(tasks ... func(int)) { r.tasks = append(r.tasks, tasks...) } func (r *Runner) Start() error { //å¸Œæœ›æ¥æ”¶æ‰€æœ‰ç»ˆç«¯ä¿¡å· signal.Notify(r.interrupt, os.Interrupt) go func() { //ä½¿ç”¨goroutineæ‰§è¡Œä»»åŠ¡ r.complete \u0026lt;- r.run() }() select { //mainçº¿ç¨‹åœ¨selectå¤„é˜»å¡, è¦ä¹ˆç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æœç»“æŸ, è¦ä¹ˆç­‰å¾…è®¡æ—¶å™¨æŠ¥å‘Šè¶…æ—¶ case err := \u0026lt;-r.complete://é˜»å¡ç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æœ return err case \u0026lt;-r.timeout: //é˜»å¡ç­‰å¾…è¶…æ—¶æŠ¥å‘Š return ErrTimeout } } func (r *Runner) run() error { for id, task := range r.tasks { //æ£€æµ‹æ˜¯å¦æœ‰æ¥è‡ªæ“ä½œç³»ç»Ÿçš„ç»ˆç«¯ä¿¡å· if r.getInterrupted() { return ErrInterrupt } //æ‰§è¡Œä»»åŠ¡ task(id) } return nil } func (r *Runner) getInterrupted() bool { //ä½¿ç”¨defaultå°†selectçš„é˜»å¡å˜æˆéé˜»å¡. æ¯æ¬¡æ–¹æ³•è°ƒç”¨åªæ˜¯æ£€æŸ¥é€šé“ä¸­æ˜¯å¦æœ‰æ•°æ®, ä¸é˜»å¡ select { case \u0026lt;-r.interrupt: return true default: return false } } package main import ( \u0026#34;time\u0026#34; \u0026#34;os\u0026#34; \u0026#34;log\u0026#34; \u0026#34;github.com/addozhang/learning-go-lang/runner\u0026#34; ) func main(){ log.Println(\u0026#34;Starting working.\u0026#34;) const timeout = 3 * time.Second r := runner.New(timeout) r.AddTask(createTask(), createTask(), createTask()) if err := r.Start(); err != nil { switch err { case runner.ErrTimeout: log.Println(\u0026#34;Terminating due to timeout.\u0026#34;) os.Exit(1) case runner.ErrInterrupt: log.Println(\u0026#34;Terminating due to interrupt.\u0026#34;) os.Exit(2) } } log.Println(\u0026#34;Process ended.\u0026#34;) } //åˆ›å»ºä»»åŠ¡, è¿”å›æ¥å—intç±»å‹å‚æ•°çš„å‡½æ•° func createTask() func(int){ return func(id int) { log.Printf(\u0026#34;Processor - Task #%d\u0026#34;, id) time.Sleep(time.Duration(id) * time.Second) } } //åˆ›å»ºä»»åŠ¡, è¿”å›æ¥å—intç±»å‹å‚æ•°çš„å‡½æ•° func createTask() func(int){ return func(id int) { log.Printf(\u0026#34;Processor - Task #%d\u0026#34;, id) time.Sleep(time.Duration(id) * time.Second) } } //ç»“æœè¾“å‡º //2018/01/01 09:45:57 Starting working. //2018/01/01 09:45:57 Processor - Task #0 //2018/01/01 09:45:57 Processor - Task #1 //2018/01/01 09:45:58 Processor - Task #2 //2018/01/01 09:46:00 Terminating due to timeout. pool ä¸‹é¢çš„ä»£ç å±•ç¤ºå¦‚ä½•ä½¿ç”¨æœ‰ç¼“å†²é€šé“å®ç°èµ„æºæ± , ä»¥1.5ç‰ˆæœ¬ä¸ºåŸºç¡€å†™çš„. 1.6ä¹‹åçš„ç‰ˆæœ¬, æ ‡å‡†åº“ä¸­è‡ªå¸¦äº†èµ„æºæ± çš„å®ç°sycn.Pool\npackage pool import ( \u0026#34;sync\u0026#34; \u0026#34;io\u0026#34; \u0026#34;errors\u0026#34; \u0026#34;log\u0026#34; ) type Pool struct { m sync.Mutex //äº’æ–¥é”ç”¨äºå®‰å…¨åœ°æ–¹è®¿é—®èµ„æºæ±  resources chan io.Closer //èµ„æºæ± é€šé“, éœ€è¦å®ç°io.Closeræ¥å£ factory func() (io.Closer, error) //åˆ›å»ºèµ„æºçš„å·¥å‚æ–¹æ³• closed bool //èµ„æºæ± æ˜¯å¦å…³é—­ } //èµ„æºæ± å…³é—­é”™è¯¯ var ErrPoolClosed = errors.New(\u0026#34;Pool has ben closed.\u0026#34;) func New(fn func() (io.Closer, error), size int) (*Pool, error) { if size \u0026lt;= 0 { return nil, errors.New(\u0026#34;Size value too small.\u0026#34;) } return \u0026amp;Pool{ resources: make(chan io.Closer, size), //ä½¿ç”¨æœ‰ç¼“å†²èµ„æºæ±  factory: fn, }, nil } //ä»æ± ä¸­è·å–èµ„æº func (p *Pool) Acquire() (io.Closer, error) { select { case res, ok := \u0026lt;-p.resources: //ä»èµ„æºæ± é€šé“è·å–ä¸€ä¸ªèµ„æº, å› ä¸ºæœ‰default, ä¸é˜»å¡ log.Println(\u0026#34;Acqure: \u0026#34;, \u0026#34;Shared Resources\u0026#34;) if !ok { return nil, ErrPoolClosed } return res, nil default: //èµ„æºæ± é€šé“æ²¡æœ‰æ•°æ®æ—¶, æ–°å»ºä¸€ä¸ª log.Println(\u0026#34;Acquire: \u0026#34;, \u0026#34;New Resource\u0026#34;) return p.factory() } } //é‡Šæ”¾èµ„æº func (p *Pool) Release(res io.Closer) { p.m.Lock() //éœ€è¦ä½¿ç”¨äº’æ–¥é”æ“ä½œèµ„æºæ±  defer p.m.Unlock() if p.closed { // res.Close() return } select { case p.resources \u0026lt;- res: //å°†èµ„æºæ”¾å›é€šé“. å¦‚æœé€šé“æ»¡ä¸ä¼šé˜»å¡, å› ä¸ºæœ‰default log.Println(\u0026#34;Release: \u0026#34;, \u0026#34;In Queue\u0026#34;) default: //å¦‚æœé€šé“å·²æ»¡, ç›´æ¥å…³é—­èµ„æº log.Println(\u0026#34;Release: \u0026#34;, \u0026#34;Closing\u0026#34;) res.Close() } } //å…³é—­èµ„æºæ±  func (p *Pool) Close() { p.m.Lock() //åŠ äº’æ–¥é” defer p.m.Unlock() if p.closed { return } //å°†æ± å…³é—­ p.closed = true //åœ¨æ¸…ç©ºé€šé“èµ„æºä¹‹å‰å…³é—­é€šé“, å¦‚æœä¸å…³é—­ä¼šå‘å£°æ­»é” close(p.resources) for res := range p.resources { res.Close() //å…³é—­é€šé“ä¸­çš„èµ„æº } } package main import ( \u0026#34;github.com/addozhang/learning-go-lang/pool\u0026#34; \u0026#34;log\u0026#34; \u0026#34;io\u0026#34; \u0026#34;sync/atomic\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; \u0026#34;math/rand\u0026#34; ) const ( maxGoRoutines = 25 pooledResources = 2 ) type dbConnection struct { ID int32 } var idCounter int32 func (dbConn *dbConnection) Close() error { log.Println(\u0026#34;Close: Connection, \u0026#34;, dbConn.ID) return nil } func createConnection() (io.Closer, error) { id := atomic.AddInt32(\u0026amp;idCounter, 1) log.Println(\u0026#34;Create: New Connection\u0026#34;, id) return \u0026amp;dbConnection{id}, nil } func main() { var wg sync.WaitGroup wg.Add(maxGoRoutines) p, err := pool.New(createConnection, pooledResources) if err != nil { log.Println(err) } for query := 0; query \u0026lt; maxGoRoutines; query++ { go func(q int) { performQuery(q, p) wg.Done() }(query) } wg.Wait() log.Println(\u0026#34;Shutdown Program.\u0026#34;) p.Close() } func performQuery(query int, pool *pool.Pool) { dbConn, err := pool.Acquire() if err != nil { log.Println(err) } defer dbConn.Close() time.Sleep(time.Duration(rand.Intn(1000)) * time.Millisecond) log.Printf(\u0026#34;QID[%d] CID[%d]\u0026#34;, query, dbConn.(*dbConnection).ID) } work ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æ— ç¼“å†²é€šé“æ¥åˆ›å»ºä¸€ä¸ªgoroutineæ± . è¿™ä¸ªgoroutineæ‰§è¡Œå¹¶æ§åˆ¶ä¸€ç»„å·¥ä½œ, è®©å…¶å¹¶å‘æ‰§è¡Œ.\npackage worker import \u0026#34;sync\u0026#34; type Worker interface { Task() } type Pool struct { worker chan Worker wg sync.WaitGroup } func New(maxRoutines int) *Pool { p := Pool{ worker: make(chan Worker), } p.wg.Add(maxRoutines) for i := 0; i \u0026lt; maxRoutines; i++ { go func() { for w := range p.worker { w.Task() } p.wg.Done() }() } return \u0026amp;p; } func (p *Pool) Run(w Worker) { p.worker \u0026lt;- w } func (p *Pool) Shutdown() { close(p.worker) p.wg.Wait() } package main import ( \u0026#34;log\u0026#34; \u0026#34;time\u0026#34; worker2 \u0026#34;github.com/addozhang/learning-go-lang/worker\u0026#34; \u0026#34;sync\u0026#34; ) var names = []string{ \u0026#34;bob\u0026#34;, \u0026#34;steve\u0026#34;, \u0026#34;mary\u0026#34;, \u0026#34;therese\u0026#34;, \u0026#34;json\u0026#34;, } type namePrinter struct { name string } func (np *namePrinter) Task() { log.Print(np.name) time.Sleep(time.Second / 10) } func main() { p := worker2.New(2) var wg sync.WaitGroup wg.Add(100 * len(names)) for i := 0; i \u0026lt; 100; i++ { for _, name := range names{ np := namePrinter{name} go func() { p.Run(\u0026amp;np) wg.Done() }() } } wg.Wait() p.Shutdown() } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/go-in-action-four/","tags":["Go"],"title":"Go In Action è¯»ä¹¦ç¬”è®° å››"},{"categories":["å­¦ä¹ "],"contents":"å¹¶å‘ Goè¯­è¨€é‡Œçš„å¹¶å‘æ˜¯æŒ‡è®©æŸä¸ªå‡½æ•°å¯ä»¥ç‹¬ç«‹äºå…¶ä»–å‡½æ•°è¿è¡Œçš„èƒ½åŠ›. å½“ä¸€ä¸ªå‡½æ•°åˆ›å»ºä¸ºgoroutineæ—¶, Goä¼šå°†å…¶è§†ä¸ºä¸€ä¸ªç‹¬ç«‹çš„å·¥ä½œå•å…ƒ. è¿™ä¸ªå·¥ä½œå•å…ƒä¼šè¢«è°ƒåº¦åˆ°å¯ç”¨çš„é€»è¾‘å¤„ç†å™¨ä¸Šæ‰§è¡Œ.\nGoçš„è¿è¡Œæ—¶è°ƒåº¦å™¨å¯ä»¥ç®¡ç†æ‰€æœ‰åˆ›å»ºçš„goroutine, å¹¶ä¸ºå…¶åˆ†é…æ‰§è¡Œæ—¶é—´. è¿™ä¸ªè°ƒåº¦å™¨åœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Š, å°†æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ä¸é€»è¾‘å¤„ç†å™¨ç»‘å®š, å¹¶åœ¨é€»è¾‘å¤„ç†å™¨æ‰§è¡Œgoroutine. è°ƒåº¦å™¨å¯ä»¥åœ¨ä»»ä½•ç»™å®šçš„æ—¶é—´, å…¨é¢æ§åˆ¶å“ªä¸ªgoroutineåœ¨å“ªä¸ªé€»è¾‘å¤„ç†å™¨ä¸Šè¿è¡Œ.\nGoçš„å¹¶å‘åŒæ­¥æ¨¡å‹æ¥è‡ªä¸€ä¸ªå«åšé€šä¿¡é¡ºåºè¿›ç¨‹(Communicating Sequential Processes, CSP). CSPæ˜¯ä¸€ä¸ªæ¶ˆæ¯ä¼ é€’æ¨¡å‹, é€šè¿‡åœ¨goroutineä¹‹å‰ä¼ é€’æ•°æ®æ¥ä¼ é€’æ¶ˆæ¯, ä¸éœ€è¦é€šè¿‡åŠ é”å®ç°åŒæ­¥è®¿é—®. ç”¨äºåœ¨goroutineé—´ä¼ é€’æ¶ˆæ¯çš„æ•°æ®ç»“æ„å«åšé€šé“(channel).\nå¹¶å‘ä¸å¹¶è¡Œ æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹(thread)å’Œè¿›ç¨‹(process).\nè¿›ç¨‹ç±»ä¼¼åº”ç”¨ç¨‹åºåœ¨è¿è¡Œä¸­éœ€è¦ç”¨åˆ°å’Œç»´æŠ¤çš„å„ç§èµ„æºçš„å®¹å™¨. èµ„æºåŒ…æ‹¬ä½†ä¸é™äº: å†…å­˜(æ¥è‡ªæ–‡ä»¶ç³»ç»Ÿçš„ä»£ç å’Œæ•°æ®), å¥æŸ„(æ–‡ä»¶, è®¾å¤‡, æ“ä½œç³»ç»Ÿ), çº¿ç¨‹.\næ¯ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹, ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸€ä¸ªæ‰§è¡Œç©ºé—´. è¿™ä¸ªç©ºé—´ä¼šè¢«æ“ä½œç³»ç»Ÿè°ƒåº¦æ¥è¿è¡Œå‡½æ•°ä¸­æ‰€å†™çš„ä»£ç . æ¯ä¸ªçº¿ç¨‹çš„åˆå§‹çº¿ç¨‹è¢«ç§°ä¸ºä¸»çº¿ç¨‹. ä¸»çº¿ç¨‹ç»ˆæ­¢æ—¶, åº”ç”¨ç¨‹åºä¹Ÿä¼šç»ˆæ­¢.æ“ä½œç³»ç»Ÿå°†çº¿ç¨‹è°ƒåº¦åˆ°æŸä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œ, è¿™ä¸ªå¤„ç†å™¨ä¸ä¸€å®šæ˜¯è¿›ç¨‹æ‰€åœ¨çš„å¤„ç†å™¨.\nGoè¯­è¨€çš„è¿è¡Œæ—¶ä¼šåœ¨é€»è¾‘å¤„ç†å™¨ä¸Šè°ƒåº¦goroutineè¿è¡Œ. æ¯ä¸ªé€»è¾‘å¤„ç†å™¨éƒ½åˆ†åˆ«ç»‘å®šåˆ°å•ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹. Goè¯­è¨€çš„è¿è¡Œæ—¶é»˜è®¤ä¼šä¸ºæ¯ä¸ªå¯ç”¨çš„ç‰©ç†å¤„ç†å™¨åˆ†é…ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨.\nåˆ›å»ºä¸€ä¸ªgorouineå¹¶å‡†å¤‡è¿è¡Œ, è¿™ä¸ªgoroutineå°±ä¼šè¢«æ”¾åˆ°è°ƒåº¦å™¨çš„å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­. ä¹‹å, è°ƒåº¦å™¨å°±å°†è¿™äº›é˜Ÿåˆ—ä¸­çš„goroutineåˆ†é…ç»™ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨, å¹¶æ”¾åˆ°è¯¥é€»è¾‘å¤„ç†å™¨å¯¹åº”çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—, ç„¶ååœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«é€»è¾‘å¤„ç†å™¨æ‰§è¡Œ.\nå¦‚æœgoroutineæ‰§è¡Œäº†é˜»å¡çº¿ç¨‹çš„è°ƒç”¨, è°ƒåº¦å™¨ä¼šå°†è¿™ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸é€»è¾‘å¤„ç†å™¨åˆ†ç¦», å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ä¸é€»è¾‘å¤„ç†å™¨ç»‘å®š, ç„¶å. ä¸€æ—¦é˜»å¡çš„è°ƒç”¨å®Œæˆ, è¯¥goroutineä¼šå›åˆ°æœ¬åœ°è¿è¡Œé˜Ÿåˆ—.\nå¦‚æœé˜»å¡è°ƒç”¨æ˜¯ç½‘ç»œI/O, goroutineä¼šä¸é€»è¾‘å¤„ç†å™¨åˆ†ç¦», ç§»åˆ°é›†æˆäº†ç½‘ç»œè½®è¯¢å™¨çš„è¿è¡Œæ—¶. ä¸€æ—¦è½®è¯¢å™¨æŒ‡ç¤ºæŸä¸ªç½‘ç»œçš„è¯»æˆ–å†™æ“ä½œå·²ç»å°±ç»ª, å¯¹åº”çš„goroutineå°±ä¼šé‡æ–°åˆ†é…åˆ°é€»è¾‘å¤„ç†å™¨ä¸Šå®Œæˆæ“ä½œ.\nè°ƒåº¦å™¨å¯¹å¯ä»¥åˆ›å»ºçš„é€»è¾‘å¤„ç†å™¨çš„æ•°é‡æ²¡æœ‰é™åˆ¶, ä½†æ˜¯è¯­è¨€è¿è¡Œæ—¶é»˜è®¤é™åˆ¶æ¯ä¸ªç¨‹åºæœ€å¤šåˆ›å»º10000ä¸ªçº¿ç¨‹. å¯ä»¥é€šè¿‡è°ƒç”¨runtime/debugåŒ…çš„SetMaxThreadsæ–¹æ³•æ¥æ›´æ”¹.\nå¹¶å‘(concurrency)ä¸æ˜¯å¹¶è¡Œ(parallelism) å¹¶è¡Œæ˜¯è®©ä¸åŒçš„ä»£ç åŒæ—¶åœ¨ä¸åŒçš„ç‰©ç†å¤„ç†å™¨ä¸Šæ‰§è¡Œ. å¹¶è¡Œçš„å…³é”®æ˜¯åŒæ—¶åšå¾ˆå¤šäº‹. å¹¶å‘æ˜¯æŒ‡åŒæ—¶ç®¡ç†å¾ˆå¤šäº‹æƒ…, è¿™äº›äº‹æƒ…å¯èƒ½åªåšä¸€èˆ¬å°±å†æš‚åœå»åšåˆ«çš„äº‹æƒ…äº†.\nä½¿ç”¨è¾ƒå°‘çš„èµ„æºåšæ›´å¤šçš„äº‹æƒ…\nå¤šä¸ªé€»è¾‘å¤„ç†å™¨æ—¶, goroutineä¼šè¢«å¹³å‡åˆ†é…åˆ°æ¯ä¸ªé€»è¾‘å¤„ç†å™¨ä¸Š, è®©goroutineåœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šè¿è¡Œ.\ngoroutine import ( \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;runtime\u0026#34; ) func main() { //åˆ†é…ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨ç»™è°ƒåº¦å™¨ä½¿ç”¨ runtime.GOMAXPROCS(1) var wg sync.WaitGroup wg.Add(2) fmt.Printf(\u0026#34;%s\\n\u0026#34;, \u0026#34;Start\u0026#34;) go func(){ defer wg.Done() for i :=0 ; i \u0026lt; 3; i++ { for ch := \u0026#39;a\u0026#39;; ch \u0026lt; \u0026#39;a\u0026#39; + 26; ch ++ { fmt.Printf(\u0026#34;%c \u0026#34;, ch) } } }() go func(){ defer wg.Done() for i :=0 ; i \u0026lt; 3; i++ { for ch := \u0026#39;A\u0026#39;; ch \u0026lt; \u0026#39;A\u0026#39; + 26; ch ++ { fmt.Printf(\u0026#34;%c \u0026#34;, ch) } } }() fmt.Println(\u0026#34;Wait\u0026#34;) wg.Wait() fmt.Println(\u0026#34;\\nEnd\u0026#34;) } //ç»“æœ //Start //Wait //A B C D E F G H I J K L M N O P Q R S T U V W X Y Z A B C D E F G H I J K L M N O P Q R S T U V W X Y Z A B C D E F G H I J K L M N O P Q R S T U V W X Y Z a b c d e f g h i j k l m n o p q r s t u v w x y z a b c d e f g h i j k l m n o p q r s t u v w x y z a b c d e f g h i j k l m n o p q r s t u v w x y z //End //ç¬¬ä¸€ä¸ªgoroutineå®Œæˆæ‰€æœ‰æ˜¾ç¤ºéœ€è¦çš„æ—¶é—´å¤ªçŸ­, ä»¥è‡³äºåœ¨è°ƒåº¦å™¨åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªgoroutineä¹‹å‰å°±å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡. ç¨‹åºå¯ä»¥ä½¿ç”¨runtime.GOMAXPROCSæ¥æ›´æ”¹è°ƒåº¦å™¨å¯ä»¥ä¸‹ä½¿ç”¨çš„é€»è¾‘å¤„ç†å™¨çš„æ•°é‡. å¦‚æœä¸æƒ³ä»£ç é‡Œä½¿ç”¨, å¯ä»¥ä½¿ç”¨è·Ÿå‡½æ•°åŒåçš„ç¯å¢ƒå˜é‡(GOMAXPROCS)æ¥è®¾ç½®. ä½¿ç”¨runtime.NumCPU()å¯ä»¥è·å–ç‰©ç†å¤„ç†å™¨çš„ä¸ªæ•°.\nWaitGroupæ˜¯ä¸€ä¸ªè®¡æ•°ä¿¡å·é‡, å¯ä»¥ç”¨æ¥è®°å½•å¹¶ç»´æŠ¤è¿è¡Œçš„goroutine. ä½¿ç”¨deferåœ¨goroutineå‡½æ•°è°ƒç”¨å®Œæˆåè°ƒç”¨Doneæ–¹æ³•.\nä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„goroutineåœ¨å·¥ä½œç»“æŸå‰, å¯ä»¥è¢«åœæ­¢(å›åˆ°æœ¬åœ°é˜Ÿåˆ—)å¹¶é‡æ–°è°ƒåº¦. é˜²æ­¢æŸä¸ªgoroutineé•¿æ—¶é—´å ç”¨é€»è¾‘å¤„ç†å™¨.\nç«äº‰çŠ¶æ€ race condition: å¤šä¸ªgoroutineåœ¨æ²¡æœ‰äº’ç›¸åŒæ­¥çš„æƒ…å†µç³»å•Š, è®¿é—®æŸä¸ªå…±äº«çš„èµ„æº, å¹¶è¯•å›¾åŒæ—¶è¯»å’Œå†™è¿™ä¸ªèµ„æº, å­˜åœ¨ç«äº‰çš„çŠ¶æ€.\nimport ( \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;runtime\u0026#34; ) var ( counter int wg sync.WaitGroup ) func main() { wg.Add(2) go incCounter(1) go incCounter(2) wg.Wait() fmt.Println(\u0026#34;Final counter: \u0026#34;, counter) } func incCounter(id int) { defer wg.Done() for i:= 0; i \u0026lt; 2; i++ { val := counter //å½“å‰goroutineä»çº¿ç¨‹é€€å‡º, å¹¶å›åˆ°é˜Ÿåˆ— runtime.Gosched() val++ counter = val } } //ç»“æœ //Final counter: 2 éåŸå­æ“ä½œå¯¼è‡´æœ€åç»“æœä¸º2\né”ä½å…±äº«èµ„æº ä½¿ç”¨atomicå’ŒsyncåŒ…çš„å‡½æ•°\nåŸå­å‡½æ•° import ( \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;sync/atomic\u0026#34; \u0026#34;runtime\u0026#34; ) var ( counter int64 wg sync.WaitGroup ) func main() { wg.Add(2) go incCounter(1) go incCounter(2) wg.Wait() fmt.Println(\u0026#34;Final counter: \u0026#34;, counter) } func incCounter(id int) { defer wg.Done() for i:= 0; i \u0026lt; 2; i++ { //å®‰å…¨åœ°å¯¹counteråŠ 1 atomic.AddInt64(\u0026amp;counter, 1) //å½“å‰goroutineä»çº¿ç¨‹é€€å‡º, å¹¶å›åˆ°é˜Ÿåˆ— runtime.Gosched() } } atomicåŒ…çš„AddInt64å‡½æ•°, ä¼šåŒæ­¥æ•´å‹å€¼çš„åŠ æ³•, æ–¹æ³•æ˜¯å¼ºåˆ¶åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªgoroutineè¿è¡Œå¹¶å®Œæˆè¿™ä¸ªåŠ æ³•æ“ä½œ. è¿˜æœ‰LoadInt64å’ŒStoreInt64å‡½æ•°, æä¾›å®‰å…¨çš„è¯»å†™æ•´å‹å€¼çš„æ–¹å¼.\näº’æ–¥é” ä½¿ç”¨äº’æ–¥é”mutex, åå­—æ¥è‡ªäº’æ–¥mutual exclusionçš„æ¦‚å¿µ. åœ¨ä»£ç ä¸Šåˆ›å»ºä¸€ä¸ªé“¾æ¥å», ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªgoroutineå¯ä»¥æ‰§è¡Œè¿™ä¸ªä¸´ç•ŒåŒºçš„ä»£ç .\nä¸´ç•ŒåŒºçš„ä»£ç å¯ä»¥ä½¿ç”¨å¤§æ‹¬å·{}åŒ…å›´, æå‡å¯è¯»æ€§.\nimport ( \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;runtime\u0026#34; ) var ( counter int64 wg sync.WaitGroup mutex sync.Mutex ) func main() { wg.Add(2) go incCounter(1) go incCounter(2) wg.Wait() fmt.Println(\u0026#34;Final counter: \u0026#34;, counter) } func incCounter(id int) { defer wg.Done() for i:= 0; i \u0026lt; 2; i++ { //åˆ›å»ºä¸´ç•ŒåŒº mutex.Lock() { val := counter //å½“å‰goroutineä»çº¿ç¨‹é€€å‡º, å¹¶å›åˆ°é˜Ÿåˆ— runtime.Gosched() val++ counter = val } mutex.Unlock() } } é€šé“ å½“ä¸€ä¸ªèµ„æºéœ€è¦åœ¨goroutineä¹‹é—´å…±äº«æ—¶, é€šé“åœ¨goroutineä¹‹å‰æ¶èµ·äº†ä¸€ä¸ªç®¡é“, å¹¶æä¾›äº†ç¡®ä¿åŒæ­¥äº¤æ¢æ•°æ®çš„æœºåˆ¶.\nå£°æ˜é€šé“æ—¶éœ€è¦æŒ‡å®šè¦å…±äº«çš„æ•°æ®ç±»å‹, åŒ…æ‹¬å…±äº«å†…ç½®ç±»å‹, å‘½åç±»å‹, ç»“æ„ç±»å‹å’Œå¼•ç”¨ç±»å‹çš„å€¼æˆ–è€…æŒ‡é’ˆ.\néœ€è¦ä½¿ç”¨å…³é”®å­—makeåˆ›å»ºé€šé“. makeçš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦å…³é”®å­—chan, ä¹‹åè·Ÿç€äº¤æ¢çš„æ•°æ®çš„ç±»å‹. å¦‚æœæ˜¯åˆ›å»ºçš„æœ‰ç¼“å†²çš„é€šé“, ç¬¬äºŒä¸ªå‚æ•°è¦æŒ‡å®šé€šé“çš„ç¼“å†²åŒºçš„å¤§å°.\n//æ— ç¼“å†²çš„æ•´å½¢é€šé“ unbuffered := make(chan int) //æœ‰ç¼“å†²çš„å­—ç¬¦ä¸²é€šé“ buffered := make(chan string, 10) é€šé“æ“ä½œ\n//å†™å­—ç¬¦ä¸²åˆ°é€šé“ buffered \u0026lt;- \u0026#34;Gopher\u0026#34; //ä»é€šé“æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸² value := \u0026lt;- buffered æ— ç¼“å†²é€šé“ unbuffered channelæ˜¯æŒ‡åœ¨æ¥æ”¶å‰æ²¡æœ‰èƒ½åŠ›ä¿å­˜ä»»ä½•å€¼çš„é€šé“. è¿™ç§é€šé“è¦æ±‚å‘é€goroutineå’Œæ¥æ”¶goroutineåŒæ—¶å‡†å¤‡å¥½, æ‰èƒ½å®Œæˆå‘é€å’Œæ¥æ”¶æ“ä½œ. å¦‚æœæ²¡æœ‰åŒæ—¶å‡†å¤‡å¥½, ä¼šå¯¼è‡´å…ˆæ‰§è¡Œå‘é€æˆ–æ¥æ”¶æ“ä½œçš„goroutineé˜»å¡ç­‰å¾….\nimport ( \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; \u0026#34;math/rand\u0026#34; ) var wg sync.WaitGroup func init(){ rand.Seed(time.Now().UnixNano()) } func main() { wg.Add(2) court := make(chan int) go player(\u0026#34;Lisa\u0026#34;, court) go player(\u0026#34;Bill\u0026#34;, court) court \u0026lt;- 1 wg.Wait() } func player(name string, court chan int) { defer wg.Done() for { ball, ok := \u0026lt;- court if !ok { fmt.Printf(\u0026#34;Player %s Won\\n\u0026#34;, name) return } n := rand.Intn(100) if n%13 == 0 { fmt.Printf(\u0026#34;Player %s missed\\n\u0026#34;, name) close(court) return } fmt.Printf(\u0026#34;Player %s Hit %d\\n\u0026#34;, name, ball) ball++ court \u0026lt;- ball } } æœ‰ç¼“å†²é€šé“ buffered channelæ˜¯ä¸€ç§åœ¨è¢«æ¥æ”¶å‰èƒ½å­˜å‚¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªå€¼çš„é€šé“. å¹¶ä¸è¦æ±‚goroutineä¹‹é—´å¿…é¡»åŒæ—¶å®Œæˆå‘é€å’Œæ¥æ”¶.\nåªæœ‰åœ¨ç¼“å†²åŒºé‡Œæ²¡æœ‰æ•°æ®çš„æ—¶å€™æ¥æ”¶æ‰ä¼šé˜»å¡; åŒæ ·åªæœ‰ç¼“å†²åŒºæ»¡çš„æ—¶å€™å‘é€æ‰ä¼šé˜»å¡.\nimport ( \u0026#34;sync\u0026#34; \u0026#34;math/rand\u0026#34; \u0026#34;time\u0026#34; \u0026#34;fmt\u0026#34; ) const ( workers = 4 taskLoad = 10 ) var wg sync.WaitGroup func init() { rand.Seed(time.Now().UnixNano()) } func main() { tasks := make(chan string, taskLoad) wg.Add(workers) for i := 0; i \u0026lt; workers; i++ { go worker(tasks, i) } for i := 0; i \u0026lt; taskLoad; i++ { tasks \u0026lt;- fmt.Sprintf(\u0026#34;Task : %d\u0026#34;, i) } close(tasks) wg.Wait() } func worker(tasks chan string, id int) { defer wg.Done() for { task, ok := \u0026lt;-tasks if !ok { fmt.Printf(\u0026#34;Work %d shutting down\\n\u0026#34;, id) return } fmt.Printf(\u0026#34;Worker: %d : Started %s\\n\u0026#34;, id, task) sleep := rand.Int63n(100) time.Sleep(time.Duration(sleep) * time.Millisecond) fmt.Printf(\u0026#34;Worker : %d : Completed %s\\n\u0026#34;, id, task) } } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/go-in-action-three/","tags":["Go"],"title":"Go In Action è¯»ä¹¦ç¬”è®° ä¸‰"},{"categories":["ç¬”è®°"],"contents":"Goè¯­è¨€çš„ç±»å‹ç³»ç»Ÿ Goè¯­è¨€æ˜¯é™æ€ç±»å‹çš„å˜æˆè¯­è¨€. ç¼–è¯‘çš„æ—¶å€™éœ€è¦ç¡®å®šç±»å‹.\nç”¨æˆ·å®šä¹‰çš„ç±»å‹ type user struct { name string email string ext int privileged bool } ä½¿ç”¨ é›¶å€¼å’Œç»“æ„å­—é¢é‡åˆå§‹åŒ–\n//å¼•ç”¨ç±»å‹, å„ä¸ªå­—æ®µåˆå§‹åŒ–ä¸ºå¯¹åº”çš„é›¶å€¼ var bill user #{ 0 false} //åˆ›å»ºå¹¶åˆå§‹åŒ–, ä½¿ç”¨ç»“æ„å­—é¢é‡ lisa := user{ //{Lisa lisa@email.com 123 true} name: \u0026#34;Lisa\u0026#34;, email: \u0026#34;lisa@email.com\u0026#34;, ext: 123, privileged: true, } ç»“æ„å­—é¢é‡çš„èµ‹å€¼æ–¹å¼:\nä¸åŒè¡Œå£°æ˜æ¯ä¸€ä¸ªå­—æ®µå’Œå¯¹åº”çš„å€¼, å­—æ®µåå’Œå­—æ®µä»¥:åˆ†éš”, æœ«å°¾ä»¥,ç»“å°¾ ä¸é€‚ç”¨å­—æ®µå, åªå£°æ˜å¯¹åº”çš„å€¼. å†™åœ¨ä¸€è¡Œé‡Œ, ä»¥,åˆ†éš”, ç»“å°¾ä¸éœ€è¦,. è¦ä¿è¯é¡ºåº lisa := {\u0026#34;Lisa\u0026#34;, \u0026#34;lisa@email.com\u0026#34;, 123, true} ä½¿ç”¨å…¶ä»–ç±»å‹ç»“æ„å£°æ˜å­—æ®µ\ntype admin struct { person user level string } fred := admin{ //{{Fred fred@email.com 123 true} super} person: user{ name: \u0026#34;Fred\u0026#34;, email: \u0026#34;fred@email.com\u0026#34;, ext: 123, privileged: true, }, level: \u0026#34;super\u0026#34;, } å¦ä¸€ç§å£°æ˜ç”¨æˆ·å®šä¹‰çš„ç±»å‹çš„æ–¹æ³•æ˜¯, åŸºäºä¸€ä¸ªå·²æœ‰çš„ç±»å‹, å°†å…¶ä½œä¸ºæ–°ç±»å‹çš„ç±»å‹è¯´æ˜ æ–°çš„ç±»å‹æ˜¯ç‹¬ç«‹çš„ç±»å‹, å€¼äº’ç›¸å…¼å®¹, ä½†ä¸èƒ½äº’ç›¸èµ‹å€¼.\ntype Duration int64 var d Duration //d = int64(1000) #ç¼–è¯‘é”™è¯¯cannot use int64(1000) (type int64) as type Duration in assignment d = Duration(1000) æ–¹æ³• æè¿°ç”¨æˆ·è‡ªå®šä¹‰ç±»å‹çš„è¡Œä¸º, å®é™…ä¸ºå‡½æ•°. åªæ˜¯åœ¨å£°æ˜çš„æ—¶å€™åœ¨funcå’Œæ–¹æ³•åä¹‹é—´å¢åŠ äº†ä¸€ä¸ªå‚æ•°(æ¥æ”¶è€…), å°†å‡½æ•°å’Œæ¥æ”¶è€…çš„ç±»å‹ç»‘å®šåˆ°ä¸€èµ·.\ntype user struct { name string email string } func (u user) notify() { fmt.Printf(\u0026#34;Sending User Email To %s\u0026lt;%s\u0026gt;\\n\u0026#34;, u.name, u.email) } func (u *user) changeEmail(email string) { u.email = email } func main() { bill := user{\u0026#34;Bill\u0026#34;, \u0026#34;bill@email.com\u0026#34;} bill.notify() lisa := \u0026amp;user{\u0026#34;Lisa\u0026#34;, \u0026#34;lisa@email.com\u0026#34;} lisa.notify() //å®é™…æ‰§è¡Œ (*lisa).notify() bill.changeEmail(\u0026#34;bill@newDomain.com\u0026#34;) //å®é™…æ‰§è¡Œ (\u0026amp;bill).changeEmail(\u0026#34;bill@newDomain.com\u0026#34;) bill.notify() lisa.changeEmail(\u0026#34;lisa@newDomain.com\u0026#34;) lisa.notify() //å®é™…æ‰§è¡Œ (*lisa).notify() } //Sending User Email To Bill\u0026lt;bill@email.com\u0026gt; //Sending User Email To Lisa\u0026lt;lisa@email.com\u0026gt; //Sending User Email To Bill\u0026lt;bill@newDomain.com\u0026gt; //Sending User Email To Lisa\u0026lt;lisa@newDomain.com\u0026gt; Goè¯­è¨€é‡Œæœ‰ä¸¤ç§ç±»å‹çš„æ¥æ”¶è€…: å€¼æ¥æ”¶è€…å’ŒæŒ‡é’ˆæ¥æ”¶è€….\nå¦‚æœä½¿ç”¨å€¼æ¥æ”¶è€…, è°ƒç”¨çš„æ—¶å€™ä¼šä½¿ç”¨å€¼çš„å‰¯æœ¬æ¥æ‰§è¡Œ å¦‚æœä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…, è°ƒç”¨çš„æ—¶å€™è¿™ä¸ªæ–¹æ³•ä¼šå…±äº«è°ƒç”¨æ–¹æ³•æ—¶æ¥æ”¶è€…æ‰€æŒ‡å‘çš„å€¼ ç±»å‹çš„æœ¬è´¨ å£°æ˜ç±»å‹çš„æ–¹æ³•å‰è¦ç¡®å®šè¯¥æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªæ–°å€¼(ä½¿ç”¨å€¼æ¥æ”¶è€…), è¿˜æ˜¯ä¿®æ”¹å½“å‰å€¼(ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…)\nå†…ç½®ç±»å‹ ç”±è¯­è¨€æä¾›: æ•°å€¼ç±»å‹, å¸ƒå°”ç±»å‹, å­—ç¬¦ä¸²ç±»å‹. æœ¬è´¨ä¸Šæ˜¯åŸå§‹ç±»å‹. å¯¹è¿™äº›å€¼å¢åŠ æˆ–åˆ é™¤æ“ä½œçš„æ­»å, éƒ½ä¼šåˆ›å»ºæ–°çš„å€¼.\nå¦‚ golang.org/src/strings/strings.goçš„Trimå‡½æ•°ä¼ å…¥å­—ç¬¦ä¸²å€¼, è¿”å›æ–°çš„å­—ç¬¦ä¸².\nfunc Trim(s string, cutset string) string { if s == \u0026#34;\u0026#34; || cutset == \u0026#34;\u0026#34; { return s } return TrimFunc(s, makeCutsetFunc(cutset)) } å¼•ç”¨ç±»å‹ Goè¯­è¨€é‡Œæœ‰å‡ ç§: åˆ‡ç‰‡, æ˜ å°„, é€šé“, æ¥å£å’Œå‡½æ•°ç±»å‹.\nå£°æ˜ä¸Šè¿°ç±»å‹çš„å˜é‡æ—¶, åˆ›å»ºçš„å˜é‡è¢«ç§°ä½œæ ‡å¤´(header)å€¼. æ¯ä¸ªå¼•ç”¨ç±»å‹åˆ›å»ºçš„æ ‡å¤´å€¼æ˜¯åŒ…å«ä¸€ä¸ªæŒ‡å‘åº•å±‚æ•°æ®ç»“æ„çš„æŒ‡é’ˆ. æ ‡å¤´å€¼é‡ŒåŒ…å«ä¸€ä¸ªæŒ‡é’ˆ, é€šè¿‡å¤åˆ¶æ¥ä¼ é€’ä¸€ä¸ªå¼•ç”¨ç±»å‹çš„å€¼å¾—å‰¯æœ¬, æœ¬è´¨æ˜¯å°±æ˜¯åœ¨å…±äº«åº•å±‚æ•°æ®ç»“æ„.\ngolang.org/src/net/ip.go\ntype IP []byte ç»“æ„ç±»å‹ æè¿°ä¸€ç»„æ•°æ®å€¼, è¿™ç»„å€¼å¯ä»¥æ˜¯åŸå§‹ç±»å‹, ä¹Ÿå¯ä»¥æ˜¯éåŸå§‹çš„. ç»“æ„ç±»å‹çš„æœ¬è´¨æ˜¯éåŸå§‹çš„. å¯¹è¿™ä¸ªç±»å‹çš„å€¼åšå¢åŠ æˆ–è€…åˆ é™¤çš„æ“ä½œåº”è¯¥æ›´æ”¹å€¼æœ¬èº«. å½“éœ€è¦ä¿®æ”¹å€¼æœ¬èº«æ—¶, åœ¨ç¨‹åºä¸­å…¶ä»–åœ°æ–¹, éœ€è¦ä½¿ç”¨æŒ‡é’ˆæ¥å…±äº«è¿™ä¸ªå€¼.\ngolang.org/time/time.go\ntype Time struct{ wall uint64 ext int64 loc *Location } func Now() Time{ ... } //å€¼æ¥æ”¶è€…, è¿”å›æ–°çš„Time func (time Time) Add(d Duration) Time{ ... } func (time Time) String() string{ ... } //æŒ‡é’ˆæ¥æ”¶è€… func (t *Time) UnmarshalBinary(data []byte) error { ... } å¦‚æœä¸€ä¸ªåˆ›å»ºç”¨çš„å·¥å‚å‡½æ•°è¿”å›äº†ä¸€ä¸ªæŒ‡é’ˆ, å°±è¡¨ç¤ºè¿™ä¸ªè¢«è¿”å›çš„å€¼çš„æœ¬è´¨æ˜¯éåŸå§‹çš„. golang.org/src/os/file.goçš„openå‡½æ•°.\ntype File struct { *file //å†…åµŒç±»å‹: åµŒå…¥çš„æŒ‡é’ˆ, æŒ‡å‘ä¸€ä¸ªæœªå…¬å¼€çš„ç±»å‹ //ä¸€ç§ä¿æŠ¤çš„æ–¹å¼ } type file struct { pfd poll.FD name string dirinfo *dirInfo // nil unless directory being read nonblock bool // whether we set nonblocking mode } func OpenFile(name string, flag int, perm FileMode) (*File, error) { ... } æ¥å£ å¤šæ€æ˜¯æŒ‡ä»£ç å¯ä»¥æ ¹æ®ç±»å‹çš„å…·ä½“å®ç°é‡‡å–ä¸åŒè¡Œä¸ºçš„èƒ½åŠ›. å¦‚æœä¸€ä¸ªç±»å‹å®ç°äº†æŸä¸ªæ¥å£, æ‰€æœ‰ä½¿ç”¨è¿™ä¸ªæ¥å£çš„åœ°æ–¹, éƒ½å¯ä»¥æ”¯æŒè¿™ç§ç±»å‹çš„å€¼.\næ ‡å‡†åº“ golang.org/src/io/io.go\ntype Reader interface { Read(p []byte) (n int, err error) } type Writer interface { Write(p []byte) (n int, err error) } type WriterTo interface { WriteTo(w Writer) (n int64, err error) } func main() { //bytes.Bufferå®ç°äº†io.Reader, io.WriteToæ¥å£ var b bytes.Buffer b.Write([]byte(\u0026#34;Hello\u0026#34;)) fmt.Fprintf(\u0026amp;b, \u0026#34;World!\u0026#34;) //os.Stdoutå®ç°äº†io.Writeræ¥å£\tio.Copy(os.Stdout, \u0026amp;b) } å®ç° æ¥å£æ˜¯å®šä¹‰è¡Œä¸ºçš„ç±»å‹, å…·ä½“çš„å®ç°ç”±ç”¨æˆ·å®šä¹‰çš„ç±»å‹å®Œæˆ. ç”¨æˆ·å®šä¹‰çš„ç±»å‹é€šå¸¸ç§°ä½œå®ä½“ç±»å‹. å¦‚æœç”¨æˆ·å®šä¹‰çš„ç±»å‹å®ç°äº†æŸä¸ªæ¥å£ç±»å‹å£°æ˜çš„ä¸€ç»„æ–¹æ³•, é‚£ä¹ˆè¿™ä¸ªç”¨æˆ·å®šä¹‰çš„ç±»å‹çš„å€¼å°±å¯ä»¥èµ‹ç»™è¿™ä¸ªæ¥å£ç±»å‹çš„å€¼. è¿™ä¸ªèµ‹å€¼ä¼šæŠŠç”¨æˆ·å®šä¹‰çš„ç±»å‹çš„å€¼å­˜å…¥æ¥å£ç±»å‹çš„å€¼.\næ¥å£çš„å€¼æ˜¯ä¸€ä¸ªä¸¤ä¸ªå­—é•¿åº¦çš„æ•°æ®ç»“æ„:\nç¬¬ä¸€ä¸ªå­—åŒ…å«ä¸€ä¸ªæŒ‡å‘å†…éƒ¨è¡¨(iTable)çš„æŒ‡é’ˆ. å†…éƒ¨è¡¨åŒ…å«äº†æ‰€å­˜å‚¨çš„å€¼çš„ç±»å‹ä¿¡æ¯, è¿˜åŒ…å«äº†ä¸è¿™ä¸ªå€¼ç›¸å…³è”çš„ä¸€ç»„æ–¹æ³•. ç¬¬äºŒä¸ªå­—æ˜¯ä¸€ä¸ªæŒ‡å‘æ‰€å­˜å‚¨çš„å€¼çš„æŒ‡é’ˆ. è¿™éƒ¨åˆ†å¯ä»¥å‚è€ƒLaws of Reflecation\næ–¹æ³•é›† æ–¹æ³•é›†å®šä¹‰äº†æ¥å£çš„æ¥å—è§„åˆ™. æ–¹æ³•é›†å®šä¹‰äº†ä¸€ç»„å…³è”åˆ°ç»™å®šç±»å‹çš„å€¼æˆ–è€…æŒ‡é’ˆçš„æ–¹æ³•. å®šä¹‰æ–¹æ³•çš„æ—¶ä½¿ç”¨çš„æ¥æ”¶è€…çš„ç±»å‹å†³å®šäº†è¿™ä¸ªæ–¹æ³•æ˜¯å…³è”åˆ°å€¼è¿˜æ˜¯å…³è”åˆ°æŒ‡é’ˆ, è¿˜æ˜¯ä¸¤ä¸ªéƒ½å…³è”.\ntype notifier interface { notify() } type user struct { name string email string } //notifyæ˜¯ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…å®ç°çš„æ–¹æ³• func (u *user) notify() { fmt.Printf(\u0026#34;Send email to %s\u0026lt;%s\u0026gt;\\n\u0026#34;, u.name, u.email) } func main() { u := user{\u0026#34;Bill\u0026#34;, \u0026#34;bill@email.com\u0026#34;} //sendNotificationTo(u) //ç”¨è¿™ä¸€è¡Œä¼šæœ‰ç¼–è¯‘é”™è¯¯. useræ²¡æœ‰å®ç°notifieræ¥å£, èµ‹å€¼ç»™notifierä¼šå‘ç”Ÿé”™è¯¯ sendNotificationTo(\u0026amp;u) //ä¸Šé¢notifyæ–¹æ³•çš„å®ç°çš„æ¥æ”¶è€…ä¸º useræŒ‡é’ˆ, å› æ­¤åœ¨èµ‹å€¼çš„æ—¶å€™åªèƒ½æ¥å—useræŒ‡é’ˆ //æˆ–è€…ä¸Šé¢æ–¹æ³•å®ç°çš„æ¥æ”¶è€…æ”¹ä¸ºuser } //æ¥å—ä¸€ä¸ªå®ç°äº†notifierçš„å€¼ä½œä¸ºå‚æ•° func sendNotificationTo(n notifier) { n.notify() } Goè¯­è¨€è§„èŒƒé‡Œå®šä¹‰çš„æ–¹æ³•é›†çš„è§„åˆ™:\nValues Methods Receiver T (t T) *T (t T) and (t *T) Tç±»å‹çš„å€¼çš„æ–¹æ³•é›†åªåŒ…å«å€¼æ¥æ”¶è€…å£°æ˜çš„æ–¹æ³•. è€ŒæŒ‡å‘Tç±»å‹çš„æŒ‡é’ˆçš„æ–¹æ³•é›†æ—¢åŒ…æ‹¬æŒ‡é’ˆæ¥æ”¶è€…å£°æ˜çš„æ–¹æ³•, ä¹ŸåŒ…å«å€¼æ¥æ”¶è€…å£°æ˜çš„æ–¹æ³•.\nä¸Šé¢çš„ä»£ç ç¨å¾®åšä¸‹ä¿®æ”¹, æ›´åŠ æ¸…æ™°ä¸€äº›.\ntype notifier interface { notify() } type user struct { name string email string } //notifyæ˜¯ä½¿ç”¨å€¼æ¥æ”¶è€…å®ç°çš„æ–¹æ³• func (u user) notify() { fmt.Printf(\u0026#34;Send email to %s\u0026lt;%s\u0026gt;\\n\u0026#34;, u.name, u.email) } func main() { u := user{\u0026#34;Bill\u0026#34;, \u0026#34;bill@email.com\u0026#34;} sendNotificationTo(u) sendNotificationTo(\u0026amp;u) //\u0026amp;uèµ‹å€¼ç»™notifierçš„å˜é‡næ—¶, nçš„æ–¹æ³•é›†åŒ…å«äº†å€¼æ¥æ”¶è€…å®ç°çš„æ–¹æ³•. } func sendNotificationTo(n notifier) { n.notify() } æˆ–è€…æ¢ä¸ªè§’åº¦, ä»æ¥æ”¶è€…æ¥çœ‹.\nMethod Receiver Value (t T) T and *T (t *T) *T ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…å®ç°çš„æ¥å£, é‚£åªæœ‰æŒ‡å‘é‚£ä¸ªç±»å‹çš„æŒ‡é’ˆæ‰èƒ½å®ç°å¯¹åº”çš„æ¥å£. ä½¿ç”¨å€¼æ¥æ”¶è€…å®ç°çš„æ¥å£, é‚£ä¹ˆé‚£ä¸ªç±»å‹çš„å€¼å’ŒæŒ‡é’ˆéƒ½èƒ½å¤Ÿå®ç°å¯¹åº”çš„æ¥å£.\nå¤šæ€ ä¸Šé¢çš„å‡½æ•°sendNotificationToå…¶å®å°±æ˜¯ä¸€ä¸ªå¤šæ€å‡½æ•°.\nåµŒå…¥ç±»å‹ type embedding, Goè¯­è¨€å…è®¸ç”¨æˆ·æ‰©å±•æˆ–è€…ä¿®æ”¹å·²æœ‰ç±»å‹çš„è¡Œä¸º. å¯ç”¨äºä»£ç å¤ç”¨, æˆ–ä¿®æ”¹å·²æœ‰ç±»å‹ä»¥ç¬¦åˆæ–°ç±»å‹. åµŒå…¥ç±»å‹æ˜¯å°†å·²æœ‰ç±»å‹ç›´æ¥å£°æ˜åœ¨æ–°çš„ç»“æ„ç±»å‹é‡Œ. è¢«åµŒå…¥çš„ç±»å‹ç§°ä¸ºæ–°çš„å¤–éƒ¨ç±»å‹çš„å†…éƒ¨ç±»å‹.\né€šè¿‡åµŒå…¥ç±»å‹, ä¸å†…éƒ¨ç±»å‹ç›¸å…³çš„æ ‡è¯†ç¬¦ä¼šæå‡åˆ°å¤–éƒ¨ç±»å‹ä¸Š, ä¹Ÿæˆä¸ºå¤–éƒ¨ç±»å‹çš„ä¸€éƒ¨åˆ†. å¤–éƒ¨ç±»å‹ä¹Ÿå¯ä»¥é€šè¿‡å£°æ˜ç›¸åŒåç§°çš„æ ‡è¯†ç¬¦æ¥è¦†ç›–å†…éƒ¨ç±»å‹çš„æ ‡è¯†ç¬¦çš„å­—æ®µæˆ–è€…æ–¹æ³•, è¿™å°±æ˜¯ä¿®æ”¹å†…éƒ¨ç±»å‹çš„å±æ€§æˆ–è€…è¡Œä¸ºå®ç°. ä¹Ÿå¯ä»¥æ·»åŠ æ–°çš„å­—æ®µå’Œæ–¹æ³•.\ntype notifier interface { notify() } type user struct { name string email string } type admin struct { //å¤–éƒ¨ç±»å‹ user //å†…éƒ¨ç±»å‹ level string } func (u *user) notify() { fmt.Printf(\u0026#34;Send email to %s\u0026lt;%s\u0026gt;\\n\u0026#34;, u.name, u.email) } func main() { ad := admin { user: user{ name: \u0026#34;John\u0026#34;, email: \u0026#34;john@email.com\u0026#34;, }, level: \u0026#34;super\u0026#34;, } ad.user.notify() //å¯ä»¥ç›´æ¥è®¿é—®å†…éƒ¨ç±»å‹çš„æ–¹æ³• ad.notify() //å†…éƒ¨ç±»å‹çš„æ–¹æ³•ä¹Ÿè¢«æå‡åˆ°å¤–éƒ¨ç±»å‹ endNotificationTo(\u0026amp;ad) //ç”±äºå†…éƒ¨ç±»å‹çš„æå‡, å†…éƒ¨ç±»å‹å®ç°çš„æ¥å£ä¹Ÿè¢«æå‡åˆ°å¤–éƒ¨ç±»å‹. å¤–éƒ¨ç±»å‹ä¹Ÿå¯ä»¥æä¾›åŒåçš„æ–¹æ³•å®ç°, ä»¥è¾¾åˆ°è¦†ç›–çš„æ•ˆæœ. } func sendNotificationTo(n notifier) { n.notify() } å¦‚æœå¤–éƒ¨ç±»å‹åšäº†æ–¹æ³•è¦†ç›–, å¯¹å†…éƒ¨ç±»å‹æ–¹æ³•çš„è®¿é—®ä¹Ÿè¿˜æ˜¯ä¼šç»§ç»­æ‰§è¡Œå†…éƒ¨ç±»å‹çš„æ–¹æ³•\nfunc (ad *admin) notify() { ... } ad.user.notify() //æ‰§è¡Œå†…éƒ¨ç±»å‹çš„æ–¹æ³• ad.notify() //æ‰§è¡Œå¤–éƒ¨ç±»å‹çš„æ–¹æ³• å…¬å¼€æˆ–æœªå…¬å¼€çš„æ ‡è¯†ç¬¦ ä½¿ç”¨è§„åˆ™æ¥æ§åˆ¶å£°æ˜åçš„æ ‡è¯†ç¬¦çš„å¯è§æ€§. Goè¯­è¨€æ”¯æŒä»åŒ…é‡Œå…¬å¼€æˆ–è€…éšè—è¡¨ç¤º. è¿™é‡Œçš„æ ‡è¯†ç¬¦åŒ…æ‹¬ç±»å‹, å˜é‡, æ–¹æ³•. å½“ä¸€ä¸ªæ ‡è¯†ç¬¦çš„åå­—æ˜¯å°å†™å¼€å¤´çš„æ—¶å€™, è¿™ä¸ªæ ‡è¯†ç¬¦å°±æ˜¯æœªå…¬å¼€çš„. å¦‚æœæ˜¯å¤§å†™å­—æ¯å¼€å¤´å°±æ˜¯å…¬å¼€çš„, åŒ…å¤–çš„ä»£ç å¯è§.\npackage user type User struct{ Name string //å…¬å¼€å­—æ®µ email string //æœªå…¬å¼€å­—æ®µ } //æ„é€ å™¨ func New(name, email string) User { return user{name, email} } --------------- package another //åœ¨å¦ä¸€ä¸ªåŒ…é‡Œä½¿ç”¨Userç±»å‹ u := user{ Name: \u0026#34;Bill\u0026#34;, email: \u0026#34;bill@email.com\u0026#34;, //ç¼–è¯‘å™¨æŠ¥é”™, æ‰¾ä¸åˆ°emailå­—æ®µ. å› ä¸ºemailå­—æ®µæœªå…¬å¼€ } //ä½¿ç”¨æ„é€ å™¨ ur : user.New(\u0026#34;Bill\u0026#34;, \u0026#34;bill@email.com\u0026#34;) å…¬å¼€æˆ–è€…æœªå…¬å¼€çš„æ ‡è¯†ç¬¦, ä¸æ˜¯ä¸€ä¸ªå€¼ çŸ­å˜é‡å£°æ˜æ“ä½œç¬¦(:=), æœ‰èƒ½åŠ›æ•è·å¼•ç”¨çš„ç±»å‹, å¹¶åˆ›å»ºä¸€ä¸ªæœªå…¬å¼€çš„ç±»å‹çš„å˜é‡. package counter type alertCounter int //æœªå…¬å¼€ç±»å‹ --------------- package another import ( \u0026#34;fmt\u0026#34; ) func main() { //c = counter.alertCounter ç¼–è¯‘ä¼šæŠ¥é”™, æ— æ³•è®¿é—®æœªå…¬å¼€æ ‡è¯†ç¬¦ c := counter.alertCounter(20) fmt.Println(counter) // 20 } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/go-in-action-two/","tags":["Go"],"title":"Go In Action è¯»ä¹¦ç¬”è®° äºŒ"},{"categories":["ç¬”è®°"],"contents":"\nå…³é”®å­— var å˜é‡ä½¿ç”¨varå£°æ˜, å¦‚æœå˜é‡ä¸æ˜¯å®šä¹‰åœ¨ä»»ä½•ä¸€ä¸ªå‡½æ•°ä½œç”¨åŸŸå†…, è¿™ä¸ªå˜é‡å°±æ˜¯åŒ…çº§å˜é‡.\nGoè¯­è¨€ä¸­, æ‰€æœ‰å˜é‡éƒ½è¢«åˆå§‹åŒ–ä¸ºå…¶é›¶å€¼. å¯¹äºæ•°å€¼ç±»å‹, å…¶é›¶å€¼æ˜¯0; å¯¹äºå­—ç¬¦ä¸²ç±»å‹, å…¶é›¶å€¼æ˜¯ç©ºå­—ç¬¦ä¸²\u0026quot;\u0026quot;; å¯¹äºå¸ƒå°”ç±»å‹, å…¶é›¶å€¼æ˜¯false. å¯¹äºå¼•ç”¨ç±»å‹æ¥è¯´, åº•å±‚æ•°æ®ç»“æ„ä¼šè¢«åˆå§‹åŒ–å¯¹åº”çš„é›¶å€¼. ä½†æ˜¯è¢«ç”Ÿå‘½è¢«èµ·é›¶å€¼çš„å¼•ç”¨ç±»å‹çš„å˜é‡, ä¼šè¿”å›nilä½œä¸ºå…¶å€¼.\nconst å®šä¹‰å¸¸é‡\ninterface å£°æ˜æ¥å£\nfunc å£°æ˜å‡½æ•°\ndefer å®‰æ’åé¢çš„å‡½æ•°è°ƒç”¨åœ¨å½“å‰å‡½æ•°è¿”å›æ—¶æ‰æ‰§è¡Œ.\nfile, err = os.open(\u0026#34;filePath\u0026#34;) if err != nil return defer file.close() # more file operation go å¯åŠ¨åé¢çš„å‡½æ•°ä½œä¸ºgoroutine, å¦‚ä¸‹é¢å¯åŠ¨åŒ¿åå‡½æ•°ä½œä¸ºgoroutine\ngo func(){}() import å¯¼å…¥åŒ…, è®©ä½¿ç”¨è€…å¯ä»¥è®¿é—®å…¶ä¸­çš„æ ‡è¯†ç¬¦, å¦‚ç±»å‹, å‡½æ•°, å¸¸é‡å’Œæ¥å£. ç¼–è¯‘å™¨æŸ¥æ‰¾åŒ…æ—¶ä¼šä»GOROOTå’ŒGOPATHç¯å¢ƒå˜é‡å¼•ç”¨çš„ä½ç½®å»æŸ¥æ‰¾. å¦‚æœå¼•ç”¨çš„åŒ…åå‰ä½¿ç”¨ä¸‹åˆ’çº¿_, è¡¨æ˜ä¸ç›´æ¥ä½¿ç”¨åŒ…é‡Œçš„æ ‡è¯†ç¬¦, åªæ˜¯è°ƒç”¨å…¶initå‡½æ•°æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ\nimport ( \u0026#34;log\u0026#34; \u0026#34;fmt\u0026#34; _ package/hasNoPublicIdentifier package/hasPublicIdentifier ) range ç”¨äºè¿­ä»£æ•°ç»„, å­—ç¬¦ä¸², åˆ‡ç‰‡, æ˜ å°„å’Œé€šé“\nè¿­ä»£é€šé“æ—¶, å¦‚æœé€šé“ä¸­æ²¡æœ‰æ•°æ®æ—¶ä¼šé˜»å¡; æœ‰æ•°æ®å†™å…¥æ—¶ä¼šè§¦å‘æ‰§è¡Œåé¢çš„ä»£ç . å¦‚æœé€šé“å…³é—­, è¿­ä»£é€€å‡º.\ntype å£°æ˜ç»“æ„ç±»å‹\nstruct ç»“æ„ç±»å‹\nè¯­æ³• æ ‡è¯†ç¬¦ å°å†™å­—æ¯å¼€å¤´çš„æ ‡è¯†ç¬¦ä¸ä¼šæš´éœ², åªä¼šæš´éœ²å¤§å†™å­—æ¯å¼€å¤´çš„æ ‡è¯†ç¬¦\nmainåŒ… ç¨‹åºçš„å…¥å£å¯ä»¥åœ¨main.goæ–‡ä»¶é‡Œæ‰¾åˆ°. æ¯ä¸ªå¯æ‰§è¡Œçš„Goç¨‹åºæœ‰2ä¸ªç‰¹å¾: æœ‰mainå‡½æ•°, ç¨‹åºçš„ç¬¬01è¡ŒåŒ…åä¸ºmain\npackage main import () func init() {} func main() {} initå‡½æ•° initå‡½æ•°æ€»æ˜¯åœ¨mainå‡½æ•°è°ƒç”¨ä¹‹å‰è¢«è°ƒç”¨. å¸¸è§importä¸­ä½¿ç”¨ä¸‹åˆ’çº¿_å¼•å…¥æ²¡æœ‰æš´éœ²ä»»ä½•æ ‡è¯†ç¬¦çš„åŒ…, è°ƒç”¨å…¶initå‡½æ•°\nåŒ… æ‰€æœ‰å¤„äºåŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„ä»£ç æ–‡ä»¶, å¿…é¡»ä½¿ç”¨åŒæ ·çš„åŒ…å\nä¸€ä¸ªå‡½æ•°å¤šä¸ªè¿”å›å€¼ value, err := RetriveValue() ç®€åŒ–å£°æ˜å˜é‡è¿ç®—ç¬¦ (:=) å£°æ˜å˜é‡åŒæ—¶èµ‹å€¼, æ ¹æ®åé¢çš„ç±»å‹ç¡®å®šå˜é‡çš„ç±»å‹.\nval := make(map[string]string) å‡½æ•°é—´çš„å˜é‡ä¼ é€’ éƒ½æ˜¯å€¼ä¼ é€’\næ•°ç»„, åˆ‡ç‰‡å’Œæ˜ å°„ æ•°æ® é•¿åº¦å›ºå®šçš„æ•°æ®ç±»å‹. åœ¨å†…å­˜ä¸­çš„å ç”¨æ˜¯è¿ç»­çš„.\nå£°æ˜å’Œåˆå§‹åŒ– var array [5]int array :=[5]int{1,2,3,4,5} array :=[...]int{1,2,3,4,5} array :=[5]int{1: 1, 2: 2} #array[0]ä¸º0 ä½¿ç”¨ ä½¿ç”¨ç´¢å¼•è®¿é—®\narray[2] #2 array[2]=3 #ä¿®æ”¹ æŒ‡é’ˆæ•°ç»„ array := [5]*int{0: new(int), 1: new(int)} //å¤åˆ¶ *array[0]=1 *array[1]=2 å¤šç»´æ•°ç»„ array :=[4][2]int{0: {1, 2}, 1: {3,4}} å‡½æ•°é—´ä¼ é€’æ•°ç»„ å€¼ä¼ é€’\n//å£°æ˜ä¸€ä¸ªéœ€è¦8MBçš„æ•°ç»„ var array [1e6]int //ä¼ é€’æ•°ç»„ foo(array) //æ¥å—ä¸€ä¸ª100wä¸ªæ•´å½¢å€¼çš„æ•°ç»„ func foo(array [1e6]int){} ä½¿ç”¨æŒ‡é’ˆä¼ é€’\n//å£°æ˜ä¸€ä¸ªéœ€è¦8MBçš„æ•°ç»„ var array [1e6]int //ä¼ é€’æ•°ç»„ foo(\u0026amp;array) func foo(array *[1e6]int){} åˆ‡ç‰‡ ä¸€ç§æ•°æ®ç»“æ„, ä¾¿äºä½¿ç”¨å’Œç®¡ç†æ•°æ®é›†åˆ. æ˜¯å›´ç»•åŠ¨æ€æ•°ç»„çš„æ¦‚å¿µåˆ›å»ºçš„, å°±æ˜¯å¯å˜(å¢é•¿æˆ–ç¼©å°)æ•°ç»„. åˆ‡é¢çš„åº•å±‚å†…å­˜ä¹Ÿæ˜¯åœ¨è¿ç»­å¿«ä¸­åˆ†é…çš„, ä¹Ÿèƒ½è·å¾—ç´¢å¼•,è¿­ä»£. åˆ‡ç‰‡çš„åŠ¨æ€å¢é•¿æ˜¯é€šè¿‡å†…ç½®å‡½æ•°appendå®ç°çš„.\nåˆ‡ç‰‡æ˜¯ä¸€ä¸ªå¾ˆå°çš„å¯¹è±¡, å¯¹åº•å±‚æ•°ç»„è¿›è¡Œäº†æŠ½è±¡, å¹¶æä¾›æ“ä½œæ–¹æ³•. åŒ…å«ä¸‰ä¸ªå­—æ®µ: æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆ, å…ƒç´ ä¸ªæ•°(é•¿åº¦)å’Œå®¹é‡.\nåˆ›å»ºå’Œåˆå§‹åŒ– //æŒ‡å®šé•¿åº¦, é•¿åº¦ç­‰äºå®¹é‡ slice := make([]string, 5) //æŒ‡å®šé•¿åº¦å’Œå®¹é‡, åªèƒ½è®¿é—®3ä¸ª, å…¶ä½™2ä¸ªé€šè¿‡åæœŸæ“ä½œåˆå¹¶ slice := make([]string, 3, 5) slice := []int{1,2,3,4,5} nilå’Œç©ºåˆ‡ç‰‡ nilåˆ‡ç‰‡\nvar slice []int ç©ºåˆ‡ç‰‡, é•¿åº¦ä¸º0, å®¹é‡ä¸º0\nslice := make([]int, 0) slice := []int{} ä½¿ç”¨åˆ‡ç‰‡ ä½¿ç”¨ä¸€ä¸ªç´¢å¼•è®¿é—®æ•°ç»„å…ƒç´  slice[1]=10 slice[1] #10 ä½¿ç”¨åˆ‡ç‰‡åˆ›å»ºåˆ‡ç‰‡, æ–°æ—§åˆ‡ç‰‡å…±äº«åº•å±‚æ•°ç»„\nä½¿ç”¨ä¸¤ä¸ªç´¢å¼•åˆ›å»ºæ–°çš„ç´¢å¼•(å…±ç”¨åº•å±‚æ•°ç»„) //åº•å±‚æ•°ç»„é•¿åº¦ä¸º5 //é•¿åº¦ä¸º2 = 3 - 1 //å®¹é‡ä¸º4 = 5 - 1 newSlice := slice[1:3] å¢é•¿ ä½¿ç”¨å†…ç½®çš„appendæ–¹æ³•è¿½åŠ , è¿”å›ä¸€ä¸ªæ–°çš„åˆ‡ç‰‡(æ–°çš„åº•å±‚æ•°ç»„, æ•°ç»„æŒ‡é’ˆæ”¹å˜, é•¿åº¦æ”¹å˜, å®¹å™¨å¯èƒ½æ”¹å˜)\nnewSlice := appen(slice[1,3], 6) ä¸‰ä¸ªç´¢å¼• ä½¿ç”¨ä¸‰ä¸ªç´¢å¼•, ç¬¬ä¸€ä¸ªç´¢å¼•è¡¨ç¤ºèµ·å§‹ä½ç½®, ç¬¬äºŒä¸ªå…ƒç´ è¡¨ç¤ºèµ·å§‹ç´¢å¼•åŠ ä¸Šå¸Œæœ›åŒ…æ‹¬çš„å…ƒç´ ä¸ªæ•° 2 + 1 = 3. ç¬¬ä¸‰ä¸ªç´¢å¼•æ˜¯èµ·å§‹ç´¢å¼•åŠ ä¸Šå®¹é‡ 2 + 2 = 4.\n//ä»ç¬¬3ä¸ªå…ƒç´ å¼€å§‹æˆªå– //é•¿åº¦ä¸º1 = 3 - 2 //å®¹é‡ä¸º2 = 4 - 2 newSlice := slice[2,3,4] è¿­ä»£åˆ‡ç‰‡ ä½¿ç”¨å…³é”®å­—range\nslice := []int{1,2,3,4,5} for idx, val := range slice { fmt.Printf(\u0026#34;Index: %d Values: %d\\n\u0026#34;, idx, val) } //è¿”å›é•¿åº¦ len(slice) //è¿”å›å®¹é‡ cap(slice) å¤šç»´åˆ‡ç‰‡ å‡½æ•°é—´çš„åˆ‡ç‰‡ä¼ é€’ æ˜ å°„ å­˜å‚¨ä¸€ç³»åˆ—æ— åºé”®å€¼å¯¹çš„æ•°æ®ç»“æ„, å¯ä»¥åŸºäºé”®å¿«é€Ÿæ£€ç´¢.\næ˜¯ä¸€ä¸ªé›†åˆ, å¯ä»¥ä½¿ç”¨ç±»ä¼¼æ•°ç»„æˆ–åˆ‡ç‰‡çš„æ–¹å¼è¿­ä»£æ•°ç»„. ä½†æ˜¯æ˜¯æ— åºçš„, æ— æ³•é¢„æµ‹é”®å€¼å¯¹è¢«è¿”å›çš„é¡ºåº.\næ— åºçš„åŸå› æ˜¯æ˜ å°„ä½¿ç”¨äº†æ•£åˆ—è¡¨.\nå®ç°æ–¹å¼ æ¡¶çš„æ•°æ®ç»“æ„: ä¸¤ä¸ªæ•°ç»„. ä¸€ä¸ªå­˜å‚¨æ•£åˆ—é”®çš„é«˜å…«ä½å€¼, ç”¨æ¥åšæ¡¶å®šä½. å¦ä¸€ä¸ªæ˜¯å­—èŠ‚æ•°ç»„, ç”¨äºå­˜å‚¨é”®å€¼å¯¹. å…ˆä¸€æ¬¡å­˜å‚¨æ‰€æœ‰çš„é”®, å†ä¸€æ¬¡å­˜å‚¨æ‰€æœ‰çš„å€¼.\nå°†é”®é€šè¿‡æ•£åˆ—å‡½æ•°è®¡ç®—å‡ºæ•£åˆ—å€¼, ç„¶åé€šè¿‡æ•£åˆ—å€¼çš„é«˜å…«ä½å®šä½å‡ºæ¡¶, ç„¶ååœ¨æ¡¶çš„æ•°ç»„é‡Œè¿›è¡Œå­˜å‚¨, åˆ é™¤æˆ–è€…æŸ¥æ‰¾.\né”®å¯ä»¥æ˜¯ä»»ä½•ç±»å‹, åªè¦è¿™ä¸ªå€¼å¯ä»¥ä½¿ç”¨==è¿ç®—ç¬¦åšæ¯”è¾ƒ. åˆ‡ç‰‡, å‡½æ•°ä»¥åŠåŒ…å«åˆ‡ç‰‡çš„æœºæ„ç±»å‹ç”±äºå…·æœ‰å¼•ç”¨è¯­ä¹‰, ä¸èƒ½ä½œä¸ºæ˜ å°„çš„é”®.\nåˆ›å»ºå’Œåˆå§‹åŒ– dict := make(map[string]int) dict := map[string]string{\u0026#34;red\u0026#34;:\u0026#34;#da1337\u0026#34;, \u0026#34;orange\u0026#34;:\u0026#34;#e95a22\u0026#34;} //ç©ºæ˜ å°„ dict := map[string]int{} //ä½¿ç”¨åˆ‡ç‰‡ä½œä¸ºé”® dict := map[[]string]int{} #ç¼–è¯‘é”™è¯¯ invalid map key type []string ä½¿ç”¨ ç©ºæ˜ å°„\n#å£°æ˜ä¸€ä¸ªç©ºæ˜ å°„ colors := map[string]string[]{} colors[\u0026#34;red\u0026#34;] = \u0026#34;#da1337\u0026#34; nilæ˜ å°„\n//å£°æ˜ä¸ºnilæ˜ å°„ var colors map[string]string colors[\u0026#34;red\u0026#34;] = \u0026#34;#da1337\u0026#34; //è¿è¡Œæ—¶å‡ºé”™ assignment to entry in nil map åˆ¤æ–­æ˜¯å¦å­˜åœ¨é”®. å¦‚æœä¸å­˜åœ¨existä¸ºfalse, valueä¸ºé›¶å€¼. å¦‚æœå­˜åœ¨existä¸ºtrue, valueä¸ºå¯¹åº”çš„å€¼.\nvalue, exists = colors[\u0026#34;blue\u0026#34;] if exists { ... } éå†æ˜ å°„\nfor key, value range colors { fmt.printf(\u0026#34;Key: %s, Value %s\\n\u0026#34;, key, value) } åˆ é™¤é”®å€¼å¯¹\ndelete(colors, \u0026#34;red\u0026#34;) ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/go-in-action-one/","tags":["Go"],"title":"Go In Action è¯»ä¹¦ç¬”è®° ä¸€"},{"categories":["ç¬”è®°"],"contents":"æˆ‘çš„ç¯å¢ƒå˜é‡æ˜¯è¿™æ ·çš„:\nexport GOROOT=/usr/local/go export GOPATH=/Users/addo/Workspaces/go_w export GOBIN=$GOROOT/bin export PATH=$PATH:$GOBIN ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å®‰è£…æŠ¥é”™:\ngo get -v github.com/tools/godep\ngithub.com/tools/godep (download) github.com/tools/godep/vendor/github.com/pmezard/go-difflib/difflib github.com/tools/godep/vendor/github.com/kr/fs github.com/tools/godep/vendor/github.com/kr/text github.com/tools/godep/vendor/golang.org/x/tools/go/vcs github.com/tools/godep/vendor/github.com/kr/pretty github.com/tools/godep go install github.com/tools/godep: open /usr/local/go/bin/godep: permission denied\né»˜è®¤æ˜¯å®‰è£…åˆ°$GOBINç›®å½•ä¸‹, æƒé™ä¸å¤Ÿ.\nä½¿ç”¨:\nsudo go get -v github.com/tools/godep\nsudo go get -v github.com/tools/godep github.com/tools/godep (download) created GOPATH=/Users/addo/go; see \u0026lsquo;go help gopath\u0026rsquo; github.com/tools/godep/vendor/github.com/kr/fs github.com/tools/godep/vendor/github.com/kr/text github.com/tools/godep/vendor/github.com/pmezard/go-difflib/difflib github.com/tools/godep/vendor/golang.org/x/tools/go/vcs github.com/tools/godep/vendor/github.com/kr/pretty github.com/tools/godep\n$GOBINå¹¶æ²¡æœ‰æ‰¾åˆ°godef. è¾“å‡ºæç¤ºcreated GOPATH=/Users/addo/go; . å› ä¸ºsudoçš„æ—¶å€™æ‰¾ä¸åˆ°GOPATHå˜é‡, ä¾¿é‡æ–°åˆ›å»ºäº†ç›®å½•.\nè§£å†³æ–¹æ¡ˆä¸€:\nä¸´æ—¶ä¿®æ”¹GOBIN: export GOBIN=$GOPATH/bin è¿è¡Œgo get github.com/tools/godep å°†ç”Ÿæˆçš„godefå¤åˆ¶åˆ°GOROOT/binä¸‹ å›æ»šä¿®æ”¹export GOBIN=$GOROOT/bin; export PATH=$PATH:$GOBIN è§£å†³æ–¹æ¡ˆäºŒ:\nä¿®æ”¹GOROOT/binçš„å±ç»„å±ä¸», å®‰å…¨æ€§é—®é¢˜, ä¸æ¨è.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/install-godep-issue-in-custom-gopath/","tags":["Go"],"title":"è‡ªå®šä¹‰GOPATHä¸‹å®‰è£…godepå¤±è´¥"},{"categories":["ç¬”è®°"],"contents":"SpringBoot Applicationå¯åŠ¨éƒ¨åˆ†çš„æºç é˜…è¯».\nSpringApplication å¸¸ç”¨çš„SpringApplication.run(Class, Args)å¯åŠ¨Springåº”ç”¨, åˆ›å»ºæˆ–è€…æ›´æ–°ApplicationContext\né™æ€æ–¹æ³•run ä½¿ç”¨sourceç±»å®ä¾‹åŒ–ä¸€ä¸ªSpringApplicationå®ä¾‹, å¹¶è°ƒç”¨å®ä¾‹æ–¹æ³•run.\npublic static ConfigurableApplicationContext run(Object[] sources, String[] args) { return new SpringApplication(sources).run(args); } åˆå§‹åŒ–initialize å®ä¾‹åŒ–çš„æ—¶å€™é¦–å…ˆé€šè¿‡å°è¯•åŠ è½½javax.servlet.Servletå’Œorg.springframework.web.context.ConfigurableWebApplicationContextæ¨æ–­å½“å‰æ˜¯å¦æ˜¯webç¯å¢ƒ.\nç„¶åä»spring.factoriesè·å–ApplicationContextInitializerçš„å®ç°ç±».\nä»spring.factoriesè·å–ApplicationListenerçš„å®ç°ç±»\næ¨æ–­å‡ºåº”ç”¨çš„å¯åŠ¨ç±»(åŒ…å«mainæ–¹æ³•çš„ç±»): æ£€æŸ¥çº¿ç¨‹æ ˆä¸­å…ƒç´ çš„æ–¹æ³•åæ˜¯å¦æ˜¯main\nprivate Class\u0026lt;?\u0026gt; deduceMainApplicationClass() { try { //è·å–çº¿ç¨‹æ ˆæ•°æ® StackTraceElement[] stackTrace = new RuntimeException().getStackTrace(); for (StackTraceElement stackTraceElement : stackTrace) { if (\u0026#34;main\u0026#34;.equals(stackTraceElement.getMethodName())) { return Class.forName(stackTraceElement.getClassName()); } } } catch (ClassNotFoundException ex) { // Swallow and continue } return null; } åˆ°æ­¤å®ä¾‹åŒ–å°±å®Œæˆäº†.\nå®ä¾‹æ–¹æ³•run public ConfigurableApplicationContext run(String... args) { StopWatch stopWatch = new StopWatch(); stopWatch.start(); ConfigurableApplicationContext context = null; //é»˜è®¤è®¾ç½®java.awt.headlessä¸ºtrue configureHeadlessProperty(); //ä»spring.factoriesä¸­è·å–org.springframework.boot.SpringApplicationRunListenerçš„å®ç°ç±» SpringApplicationRunListeners listeners = getRunListeners(args); //é€šè¿‡EventPublishingRunListenerå‘å¸ƒstartedäº‹ä»¶ listeners.started(); try { ApplicationArguments applicationArguments = new DefaultApplicationArguments( args); //é‡ç‚¹: åˆ›å»ºæ›´æ–°ä¸Šä¸‹æ–‡å¯¹è±¡ context = createAndRefreshContext(listeners, applicationArguments); //ä¸Šä¸‹æ–‡å¯¹è±¡æ›´æ–°å®Œè°ƒç”¨ afterRefresh(context, applicationArguments); //é€šè¿‡EventPublishingRunListenerå‘å¸ƒfinishedäº‹ä»¶ listeners.finished(context, null); stopWatch.stop(); if (this.logStartupInfo) { new StartupInfoLogger(this.mainApplicationClass) .logStarted(getApplicationLog(), stopWatch); } return context; } catch (Throwable ex) { handleRunFailure(context, listeners, ex); throw new IllegalStateException(ex); } } SpringApplicationRunListener ç›‘å¬SpringApplicationçš„runæ–¹æ³•. é€šè¿‡SpringFactoriesLoaderåŠ è½½, å®ç°æ—¶éœ€è¦æä¾›publicçš„æ„é€ æ–¹æ³•æ¥å—SpringApplicationå’ŒString[]ä¸ºå‚æ•°. äº‹ä»¶çš„å‘ç”Ÿé¡ºåºä¸ºstarted -\u0026gt; environmentPrepared -\u0026gt; contextPrepared -\u0026gt; contextLoaded -\u0026gt; finished.\nSpringBooté»˜è®¤ä½¿ç”¨EventPublishingRunListenerè¿™ä¸ªå®ç°ç±», å°†å„ä¸ªäº‹ä»¶å°è£…å¹¶å‘å¸ƒå‡ºå», æœ€ç»ˆè¢«ApplicationListeneræ•è·.\npublic interface SpringApplicationRunListener { void started(); void environmentPrepared(ConfigurableEnvironment environment); void contextPrepared(ConfigurableApplicationContext context); void contextLoaded(ConfigurableApplicationContext context); void finished(ConfigurableApplicationContext context, Throwable exception); } åˆ›å»ºå¹¶æ›´æ–°ä¸Šä¸‹æ–‡å¯¹è±¡createAndRefreshContext private ConfigurableApplicationContext createAndRefreshContext(SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments) { ConfigurableApplicationContext context; // Create and configure the environment //è·å–æˆ–åˆ›å»ºç¯å¢ƒå®ä¾‹, webç¯å¢ƒä½¿ç”¨StandardServletEnvironment, éwebç¯å¢ƒä½¿ç”¨StandardEnvironment ConfigurableEnvironment environment = getOrCreateEnvironment(); //é…ç½®ç¯å¢ƒæ•°æ® //1. **commandLineArgs**å±æ€§ä»å¯åŠ¨å‚æ•°ä¸­è§£æ, æ ¼å¼\u0026#34;--name=value\u0026#34; //2. é…ç½®profiles. æœ‰æ•ˆçš„profile(é€šè¿‡**spring.profiles.active**é…ç½®) å’Œ é€šè¿‡SpringApplication.profiles()æŒ‡å®šçš„é¢å¤–profile configureEnvironment(environment, applicationArguments.getSourceArgs()); //é€šè¿‡EventPublishingRunListenerå‘å¸ƒenvironmentPreparedäº‹ä»¶ listeners.environmentPrepared(environment); //å¦‚æœæ˜¯webç¯å¢ƒ, å°†éwebç¯å¢ƒå®ä¾‹è½¬æ¢æˆwebç¯å¢ƒå®ä¾‹: //ä½¿ç”¨æœ‰æ•ˆçš„profileé…ç½®å’ŒjndiProperties, servletConfigInitParams, servletContextInitParamsçš„é…ç½®. if (isWebEnvironment(environment) \u0026amp;\u0026amp; !this.webEnvironment) { environment = convertToStandardEnvironment(environment); } //è¾“å‡ºbanner if (this.bannerMode != Banner.Mode.OFF) { printBanner(environment); } //åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡, æ²¡æœ‰æŒ‡å®šå®ç°ç±»çš„è¯(ä½¿ç”¨SpringApplicationBuilder.contextClass), ä½¿ç”¨é»˜è®¤contextç±». ç„¶åé€šè¿‡åå°„å®ä¾‹åŒ–ä¸Šä¸‹æ–‡å¯¹è±¡. //1. webç¯å¢ƒä½¿ç”¨org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext //2. org.springframework.context.annotation.AnnotationConfigApplicationContext //åˆå§‹åŒ–å®ä¾‹çš„æ—¶å€™ä¼šåšå¾ˆå¤šäº‹, //1. åˆ›å»ºAnnotatedBeanDefinitionReader. æ³¨å†Œç›¸å…³çš„Annotation Post Processor, åŒ…æ‹¬: ConfigurationClassPostProcessor(å¤„ç†@Configurationæ ‡æ³¨çš„ç±»), AutowiredAnnotationBeanPostProcessor, RequiredAnnotationBeanPostProcessor, CommonAnnotationBeanPostProcessor, PersistenceAnnotationBeanPostProcessor, EventListenerMethodProcessor, DefaultEventListenerFactory //2. åˆ›å»ºClassPathBeanDefinitionScanner. æ‰«æå™¨, æ‰«æé»˜è®¤çš„è¿‡æ»¤å™¨@Service, @Component, @Registry, @Controller. åŒæ—¶æ”¯æŒJ2EE6çš„@ManagedBeanå’Œ@Named // Create, load, refresh and run the ApplicationContext context = createApplicationContext(); //è®¾ç½®ç¯å¢ƒ context.setEnvironment(environment); //åç»­çš„å¤„ç† postProcessApplicationContext(context); //åº”ç”¨åˆå§‹åŒ–å™¨(ApplicationContextInitializerçš„å®ç°ç±»), å¯¹ä¸Šä¸‹æ–‡å¯¹è±¡åšæ›´å¤šåˆå§‹åŒ–çš„æ“ä½œ, æ¯”å¦‚: //1. æ·»åŠ BeanFactoryPostProcessor //2 .è®¾ç½®ä¸Šä¸‹æ–‡å¯¹è±¡id //3 .ä»£ç†é…ç½®ä¸­context.initializer.classesæŒ‡å®šçš„åˆå§‹åŒ–ç±» //4. æ·»åŠ listener, åœ¨webå®¹å™¨å¯åŠ¨åæ›´æ–°ç¯å¢ƒå˜é‡ä¸­çš„ç«¯å£å·(server.portsä¸­çš„local.server.port) applyInitializers(context); //é€šè¿‡EventPublishingRunListenerå‘å¸ƒcontextPreparedäº‹ä»¶ listeners.contextPrepared(context); //æ‰“å°å¯åŠ¨ä¿¡æ¯å’Œæœ‰æ•ˆçš„profileä¿¡æ¯ if (this.logStartupInfo) { logStartupInfo(context.getParent() == null); logStartupProfileInfo(context); } //å°†ApplicationArgumentså®ä¾‹æ³¨å†Œåˆ°BeanFactoryä¸­, åå­—ä¸ºspringApplicationArguments // Add boot specific singleton beans context.getBeanFactory().registerSingleton(\u0026#34;springApplicationArguments\u0026#34;, applicationArguments); //ä»source(å¯ä»¥æ˜¯Resource, Package, CharSequenceæˆ–è€…Class. ä»runæ–¹æ³•è¿›æ¥çš„ä¸ºClass)ç±»åŠ è½½Beanåˆ°ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ // Load the sources Set\u0026lt;Object\u0026gt; sources = getSources(); Assert.notEmpty(sources, \u0026#34;Sources must not be empty\u0026#34;); load(context, sources.toArray(new Object[sources.size()])); //é€šè¿‡EventPublishingRunListenerå‘å¸ƒcontextLoadedäº‹ä»¶ listeners.contextLoaded(context); //æ›´æ–°ä¸Šä¸‹æ–‡å¯¹è±¡, è°ƒç”¨ApplicationContext.refresh()æ–¹æ³• // Refresh the context refresh(context); if (this.registerShutdownHook) { try { context.registerShutdownHook(); } catch (AccessControlException ex) { // Not allowed in some environments. } } return context; } æ›´æ–°ä¸Šä¸‹æ–‡ ApplicationContext.refresh() prepareRefresh è®°å½•å¯åŠ¨æ—¶é—´, åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç¯å¢ƒä¿¡æ¯ä¸­çš„å ä½ç¬¦, æ£€æŸ¥å¿…é¡»çš„å±æ€§ obtainFreshBeanFactory é‡å»ºå†…ç½®çš„BeanFactory, å¹¶åŠ è½½beanå®šä¹‰ prepareBeanFactory åˆå§‹åŒ–BeanFactoryçš„æ ‡å‡†ä¸Šä¸‹æ–‡å±æ€§, å¦‚BeanClassLoader, ExpressionResolver, PropertyEditorRegistrar, BeanPostProcessor, LoadTimeWeaverAwarePostProcessorç­‰ç­‰. postProcessBeanFactory æ ‡å‡†åˆå§‹åŒ–åä¿®æ”¹ä¸Šä¸‹æ–‡å†…ç½®çš„BeanFactory invokeBeanFactoryPostProcessors å®ä¾‹åŒ–å¹¶è°ƒç”¨æ³¨å†Œçš„BeanFactoryPostProcessor, åŸºäºç²¾ç¡®çš„é¡ºåºå¦‚æœæŒ‡å®šäº†é¡ºåºçš„è¯. æœ‰äº›processoræ˜¯æ“ä½œBeanå®šä¹‰æ³¨å†Œè¡¨çš„(å¦‚@Configurationæ ‡æ³¨çš„ç±»beanåŒ…å«å…¶ä»–çš„beanå®šä¹‰), ä¼šåœ¨å¸¸è§„çš„BeanFactoryPostProcessorçš„æ£€æŸ¥å‘ç”Ÿä¹‹å‰. åœ¨ä¸Šä¸‹æ–‡å¯¹è±¡çš„beanå®šä¹‰æ³¨å†Œå™¨è¿›è¡Œäº†æ ‡å‡†åˆå§‹åŒ–ä¹‹åè¿›, æ‰€æœ‰çš„å¸¸è§„beanå®šä¹‰éƒ½å·²ç»è¢«åŠ è½½äº†, ä½†æ˜¯è¿˜æ²¡æœ‰beanè¢«å®ä¾‹åŒ–. åœ¨post-processiongä¹‹å‰å¯ä»¥æ·»åŠ æ›´å¤šçš„beanå®šä¹‰. @Configurationæ ‡æ³¨çš„ç±»ä¸­çš„beanå®šä¹‰ä¼šåœ¨æ­¤æ—¶å‡å¦‚åˆ°æ³¨å†Œå™¨ä¸­. registerBeanPostProcessors å®ä¾‹åŒ–å¹¶è°ƒç”¨æ³¨å†Œçš„BeanPostProcessor, å¦‚æœæœ‰é¡ºåºçš„è¯, æŒ‰ç…§é¡ºåºæ¥è°ƒç”¨. initMessageSource åˆå§‹åŒ–åä¸ºmessageSourceçš„MessageSourceå®ä¾‹. initApplicationEventMulticaster åˆå§‹åŒ–åä¸ºapplicationEventMulticasterçš„ApplicationEventMulticasterå®ä¾‹, åº”ç”¨å¯ä»¥ç”¨æ¥æ³¨å†Œåº”ç”¨äº‹ä»¶çš„ç›‘å¬. onRefresh ä¾›å­ç±»å®ç°æ·»åŠ æ›´å¤šçš„æ›´æ–°æ“ä½œ. registerListeners é€šè¿‡applicationEventMulticasteræ³¨å†ŒApplicationListenerå®ç°ç±»çš„ç›‘å¬å™¨. finishBeanFactoryInitialization è¿›è¡Œä¸Šä¸‹æ–‡çš„BeanFactoryåˆå§‹åŒ–çš„æ”¶å°¾. å¦‚æå‰åˆå§‹åŒ–LoadTimeWeaverAwareçš„bean, å†»ç»“é…ç½®ç¦æ­¢ä¿®æ”¹beanå®šä¹‰, å®ä¾‹åŒ–non-lazy-initçš„bean. finishRefresh å®Œæˆæ›´æ–°, è°ƒç”¨LifecycleProcessor.onRefresh(), å‘å¸ƒContextRefreshedEventäº‹ä»¶, å°†ä¸Šä¸‹æ–‡å®ä¾‹æš´éœ²åœ¨MBeanä¸­. ConfigurationClassPostProcessor BeanFactoryPostProcessorçš„å®ç°ç±», ç”¨äºå¼•å¯¼@Configurationç±». é»˜è®¤æƒ…å†µä¸‹é€šè¿‡ä½¿ç”¨\u0026lt;context:annotation-config/\u0026gt;æˆ–è€…\u0026lt;context:component-scan/\u0026gt;æ³¨å†Œ.\næ³¨è§£ @SpringBootApplication é›†åˆäº†@Configuration, @EnableAutoConfigurationå’Œ@ComponentScan å±æ€§: exclude, excludeName, scanBasePackage , scanBasePackageClass\n@Configuration ç±»ä¼¼æ—§ç‰ˆé…ç½®ä¸­çš„xmlé…ç½®æ–‡ä»¶, æä¾›Beançš„å®šä¹‰å’Œå¼•å…¥å…¶ä»–xmlé…ç½®. åˆ†åˆ«é€šè¿‡@Beanå’Œ@Importå®ç°. åœ¨ApplicationContext.refresh()æ—¶æ˜¯ç”¨ConfigurationClassPostProcessorè¿›è¡Œbeançš„å®ä¾‹åŒ–.\nå¯ä»¥ä¸@PropertySource, @Autowired, @Value, @Profileæ­é…ä½¿ç”¨.\n@Configuration @PropertySource(\u0026#34;classpath:/com/acme/app.properties\u0026#34;) public class AppConfig { @Value(\u0026#34;${bean.name}\u0026#34;) String beanName; @Autowired DataSource dataSource; @Bean public MyBean myBean() { return new MyBean(beanName); } @Configuration @Profile(\u0026#34;test\u0026#34;) static class DatabaseConfigTest { @Bean DataSource dataSource() { return new EmbeddedDatabaseBuilder().build(); } } @Configuration @Profile(\u0026#34;production\u0026#34;) static class DatabaseConfigProduction { @Bean DataSource dataSource() { return new EmbeddedDatabaseBuilder().build(); } } } @EnableAutoConfiguration å¼€å¯Springä¸Šä¸‹æ–‡å¯¹è±¡çš„è‡ªåŠ¨é…ç½®åŠŸèƒ½, å°è¯•å»çŒœæµ‹å’Œå®ä¾‹åŒ–ä½ å¯èƒ½éœ€è¦çš„bean. è¿™ä¸ªåŠŸèƒ½æ˜¯åŸºäºclassPathæ¥å®Œæˆçš„. æ¯”å¦‚: é¡¹ç›®ä¸­å¼•ç”¨äº†tomcat-embedded.jar, ä½ å¯èƒ½éœ€è¦ä¸€ä¸ªTomcatEmbeddedServletContainerFactoryå®ä¾‹, é™¤éå®šä¹‰äº†è‡ªå·±çš„EmbeddedServletContainerFactoryå®ä¾‹.\n@ComponentScan æ‰«æä½¿ç”¨@Configurationæ ‡æ³¨çš„ç±», ç±»ä¼¼äºSpring XMLçš„\u0026lt;context:component-scan\u0026gt;å…ƒç´ . ä½¿ç”¨basePackageså’ŒbasePackageClasseså±æ€§æ¥æŒ‡å®šè¦æ‰«æçš„åŒ…, å¦‚æœæ²¡æœ‰æŒ‡å®š, åˆ™é»˜è®¤ä»ä½¿ç”¨äº†è¯¥æ³¨è§£çš„ç±»çš„åŒ…å¼€å§‹æ‰«æ.\n@Import æç¤º@Configurationæœ‰æ›´å¤šçš„ç±»éœ€è¦å¼•å…¥, ç±»ä¼¼xmlä¸­çš„\u0026lt;import\u0026gt;æ ‡ç­¾. å¯ä»¥å¼•å…¥@Configurationç±», ImportSelectorçš„å®ç°ç±»å’ŒImportBeanDefinitionRegistrarçš„å®ç°ç±», è¿˜æœ‰å¸¸è§„çš„Componentç±».\nä¸‰è€…çš„å¤„ç†æ–¹å¼ä¸ä¸€æ ·:\n@Configurationå¸¸è§„æ–¹å¼ ImportSelectorä¼šæ ¹æ®æ³›å‹ç±»å‹ä»spring.factoriesæ‰¾åˆ°å¯¹åº”çš„é…ç½®ç±». ImportBeanDefinitionRegistrar å¯ä»¥å®ç°åœ¨bean definitionçº§åˆ«çš„å¤„ç† (@Beanå®ä¾‹çº§åˆ«) åœ¨å¼•å…¥@Configurationç±»ä¸­ä½¿ç”¨@Beanæ ‡æ³¨çš„å®ä¾‹, å¯ä»¥é€šè¿‡@Autowiredæ³¨å…¥. Beanå’Œå£°æ˜Beançš„Configurationç±»æœ¬èº«éƒ½å¯ä»¥é€šè¿‡@Autowiredæ³¨å…¥.\nå¼•å…¥XMLæˆ–è€…éConfiguration, ä½¿ç”¨@ImportResource.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/glance-over-spring-boot-source/","tags":["Spring","Java"],"title":"SpringBootæºç  - å¯åŠ¨"},{"categories":["ç¬”è®°"],"contents":"æœ€è¿‘åœ¨è°ƒæ•´ç³»ç»Ÿçš„æ€§èƒ½, ç³»ç»Ÿä¸­æ­£ä½¿ç”¨Jacksonä½œä¸ºåºåˆ—åŒ–å·¥å…·. åšäº†ä¸‹ä¸fastJson, Avro, ProtoStuffçš„åºåˆ—åŒ–ååå¯¹æ¯”.\nç”±äºåªæ˜¯åšæ¨ªå‘å¯¹æ¯”, æ²¡æœ‰ä¼˜åŒ–ç³»ç»Ÿæˆ–è€…JVMä»»ä½•å‚æ•°. æœåŠ¡å™¨ä¸€èˆ¬éƒ½ç”¨Linux, åœ¨Dockeré‡Œåšäº†Linuxç³»ç»Ÿçš„æµ‹è¯•.\nMac:\nBenchmark Mode Cnt Score Error Units JMHTest.avroSerializer thrpt 2 3124799.325 ops/s JMHTest.fastJsonSerializer thrpt 2 3122720.917 ops/s JMHTest.jacksonSerializer thrpt 2 2373347.208 ops/s JMHTest.protostuffSerializer thrpt 2 4196009.673 ops/s Docker:\nBenchmark Mode Cnt Score Error Units JMHTest.avroSerializer thrpt 2 3293260.676 ops/s JMHTest.fastJsonSerializer thrpt 2 2996908.084 ops/s JMHTest.jacksonSerializer thrpt 2 2189518.443 ops/s JMHTest.protostuffSerializer thrpt 2 3998265.173 ops/s ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/java-serval-serializer-benchmark/","tags":["Java"],"title":"Javaåºåˆ—åŒ–å·¥å…·æ€§èƒ½å¯¹æ¯”"},{"categories":["ç¬”è®°"],"contents":"Kafkaæä¾›çš„åŸºç¡€ä¿éšœå¯ä»¥ç”¨æ¥æ„å»ºå¯é çš„ç³»ç»Ÿ, å´æ— æ³•ä¿è¯å®Œå…¨å¯é . éœ€è¦åœ¨å¯é æ€§å’Œååä¹‹é—´åšå–èˆ.\nKafkaåœ¨åˆ†åŒºä¸Šæä¾›äº†æ¶ˆæ¯çš„é¡ºåºä¿è¯. ç”Ÿäº§çš„æ¶ˆæ¯åœ¨å†™å…¥åˆ°æ‰€æœ‰çš„åŒæ­¥åˆ†åŒºä¸Šåè¢«è®¤ä¸ºæ˜¯å·²æäº¤ (ä¸éœ€è¦åˆ·åˆ°ç¡¬ç›˜). ç”Ÿäº§è€…å¯ä»¥é€‰æ‹©åœ¨æ¶ˆæ¯æäº¤å®Œæˆåæ¥æ”¶brokerçš„ç¡®è®¤, æ˜¯å†™å…¥leaderä¹‹å, æˆ–è€…æ‰€æœ‰çš„å‰¯æœ¬ åªè¦æœ‰ä¸€ä¸ªå‰¯æœ¬å­˜åœ¨, æäº¤çš„æ¶ˆæ¯å°±ä¸ä¼šä¸¢å¤± æ¶ˆè´¹è€…åªèƒ½è¯»å–åˆ°å·²æäº¤çš„æ¶ˆæ¯ å¤åˆ¶ Kafkaçš„å¤åˆ¶æœºåˆ¶ä¿è¯æ¯ä¸ªåˆ†åŒºæœ‰å¤šä¸ªå‰¯æœ¬, æ¯ä¸ªå‰¯æœ¬å¯ä»¥ä½œä¸ºleaderæˆ–è€…followerçš„è§’è‰²å­˜åœ¨. ä¸ºäº†ä¿è¯å‰¯æœ¬çš„åŒæ­¥, éœ€è¦åšåˆ°:\nä¿æŒåˆ°zkçš„è¿æ¥ä¼šè¯: æ¯éš”6så‘zkå‘é€å¿ƒè·³, æ—¶é—´å¯é…ç½® æ¯éš”10så‘leaderæ‹‰å–æ¶ˆæ¯, æ—¶é—´å¯é…ç½® ä»leaderæ‹‰å–æœ€è¿‘10sçš„å†™å…¥çš„æ¶ˆæ¯. ä¿æŒä¸é—´æ–­çš„ä»leaderè·å–æ¶ˆæ¯æ˜¯ä¸å¤Ÿçš„, å¿…é¡»ä¿è¯å‡ ä¹æ²¡æœ‰å»¶è¿Ÿ Brokeré…ç½® å¤åˆ¶å› å­ default.replication.factor brokerçº§åˆ«çš„å‰¯æœ¬æ•°è®¾ç½®, é€šè¿‡è¿™ä¸ªé…ç½®æ¥æ§åˆ¶è‡ªåŠ¨åˆ›å»ºçš„topicçš„å‰¯æœ¬æ•°. ä¸ºNçš„æ—¶å€™, å¯ä»¥å®¹å¿å¤±å»N-1ä¸ªå‰¯æœ¬, ä¿è¯topicçš„å¯è¯»å†™.\nè„å‰¯æœ¬çš„leaderé€‰ä¸¾ unclean.leader.election.enable 0.11.0.0ä¹‹å‰çš„ç‰ˆæœ¬, é»˜è®¤ä¸ºtrue; ä¹‹åçš„ç‰ˆæœ¬é»˜è®¤ä¸ºfalse. è¿™ä¸ªè®¾ç½®æ§åˆ¶ä¸åŒæ­¥çš„å‰¯æœ¬èƒ½å¦å‚ä¸leaderçš„é€‰ä¸¾. å¦‚æœè®¾ç½®ä¸ºtrue, å½“æ²¡æœ‰åŒæ­¥å‰¯æœ¬å¯ç”¨çš„æ—¶å€™, ä¸åŒæ­¥çš„å‰¯æœ¬ä¼šæˆä¸ºleader, æ„å‘³ç€æœ‰æ•°æ®ä¸¢å¤±. å¦‚æœè®¾ç½®ä¸ºfalse, åˆ™æ„å‘³ç€ç³»ç»Ÿä¼šå¤„äºä¸å¯ç”¨çš„çŠ¶æ€, è¯¥éƒ¨åˆ†æ²¡æœ‰leaderæä¾›æœåŠ¡. éœ€è¦åœ¨å¯ç”¨æ€§å’Œä¸€è‡´æ€§ä¹‹é—´åšå–èˆ.\næœ€å°åŒæ­¥å‰¯æœ¬æ•° min.insync.replicas è¿™ä¸ªè®¾ç½®å¯ä»¥ä½œç”¨äºbrokerå’Œtopicçº§åˆ«. å‡å¦‚brokeræ•°ä¸º3, æœ€å°åŒæ­¥å‰¯æœ¬æ•°ä¸º2. å½“2ä¸ªåŒæ­¥å‰¯æœ¬ä¸­çš„ä¸€ä¸ªå‡ºç°é—®é¢˜, é›†ç¾¤ä¾¿ä¸ä¼šå†æ¥å—ç”Ÿäº§è€…çš„å‘é€æ¶ˆæ¯è¯·æ±‚. åŒäº‹å®¢æˆ·ç«¯ä¼šæ”¶åˆ°NotEnoughReplicasException. æ­¤æ—¶, æ¶ˆè´¹è€…è¿˜å¯ä»¥ç»§ç»­è¯»å–å­˜åœ¨çš„æ•°æ®. å”¯ä¸€çš„åŒæ­¥å‰¯æœ¬å˜æˆåªè¯».\nå¯é ç³»ç»Ÿä¸­ä½¿ç”¨ç”Ÿäº§è€… å‘é€ç¡®è®¤ acks å¯é€‰0, 1æˆ–è€…all. è®¾ç½®å½±å“ååå’Œä¸€è‡´æ€§.\nacks=0 æ„å‘³ç€æ¶ˆæ¯å‘é€å‡ºå»åå°±è®¤ä¸ºæ˜¯æˆåŠŸå†™å…¥topic. acks=1 å‘é€åç­‰å¾…leaderå†™å…¥åç¡®è®¤ acks=all å‘é€åç­‰å¾…æ‰€æœ‰å‰¯æœ¬å†™å…¥åç¡®è®¤ é‡è¯• retries æ¶ˆæ¯å‘é€åä¼šæ”¶åˆ°æˆåŠŸæˆ–è€…é”™è¯¯ç . é”™è¯¯æœ‰ä¸¤ç§, å¯é‡è¯•çš„å’Œä¸å¯é‡è¯•çš„. å¯¹äºå¯é‡è¯•çš„é”™è¯¯, ç”Ÿäº§è€…ä¼šé‡å¤å‘é€, è€Œretiesæ§åˆ¶é‡è¯•çš„æ¬¡æ•°. æ¯”å¦‚borkerè¿”å›LEADER_NOT_AVAILABLEé”™è¯¯, ç”Ÿäº§è€…ä¼šè‡ªåŠ¨è¿›è¡Œé‡è¯•(retriesä¸ç­‰äº0), å› ä¸ºbrokerä¹‹åä¼šé€‰æ‹©æ–°çš„leader. å¦‚æœè¿”å›INVALID_CONFIG, é‡è¯•ä¹Ÿä¸ä¼šè§£å†³é—®é¢˜. åŒæ—¶retriesæœ‰å¯èƒ½å¯¼è‡´æ¶ˆæ¯é‡å¤, è¿™å°±æ˜¯Kafkaæ¶ˆæ¯çš„at least onceä¿è¯. åœ¨0.11.0.0ä¹‹å, æä¾›äº†å¹‚ç­‰çš„ç‰¹æ€§, ä¿è¯æ¶ˆæ¯çš„exactly one. å¯¹äºè·¨æ•°æ®ä¸­å¿ƒçš„å¤åˆ¶(æ¯”å¦‚MirrorMaker), é»˜è®¤è®¾ç½®ä¸ºInteger.MAX_VALUE\né¢å¤–çš„é”™è¯¯å¤„ç† ä½¿ç”¨ç”Ÿäº§è€…å†…ç½®çš„é‡è¯•æ˜¯ä¸€ä¸ªæ­£ç¡®å¤„ç†å¤šç§é”™è¯¯è€Œä¸ä¸¢å¤±æ¶ˆæ¯çš„ç®€å•é€”å¾„. ä½†æ˜¯å¼€å‘è€…è¿˜éœ€è¦å¤„ç†å…¶ä»–çš„é”™è¯¯, æ¯”å¦‚:\nä¸å¯é‡è¯•é”™è¯¯ å‘é€ä¹‹å‰çš„é”™è¯¯ åœºè¯•å®Œæ‰€æœ‰çš„é‡è¯•æ¬¡æ•°åè¿˜æ˜¯æœªæˆåŠŸå‘é€. å¯é ç³»ç»Ÿä¸­ä½¿ç”¨æ¶ˆè´¹è€… å·²æäº¤æ¶ˆæ¯å’Œå·²æäº¤åç§»é‡ å®Œå…¨ä¸åŒçš„ä¸¤ä¸ªæ¦‚å¿µ, å‰è€…æ˜¯å¯¹ç”Ÿäº§è€…æœ‰æ•ˆ, åè€…æ˜¯å¯¹æ¶ˆè´¹è€…æœ‰æ•ˆ.\né‡è¦è®¾ç½® group.id ä¸¤ä¸ªæœ‰ç›¸åŒgroup.idå¹¶ä¸”è®¢é˜…åŒä¸€ä¸ªtopicçš„æ¶ˆè´¹è€…, ä¼šåˆ†é…åˆ°topicä¸‹åˆ†åŒºçš„ä¸€ä¸ªå­é›†, å¹¶ä¸”æ˜¯ç‹¬ç«‹çš„å­é›†. auto.offset.reset è¿™ä¸ªå‚æ•°æ§åˆ¶å½“brokerç«¯æ²¡æœ‰å‘ç°ä»»ä½•æäº¤çš„åç§»é‡çš„æ—¶å€™, æ¶ˆè´¹è€…åº”è¯¥ä»ä»€ä¹ˆä½ç½®å¼€å§‹è¯»å–æ¶ˆæ¯. æ¥å—earliestå’Œlatestä¸¤ç§è®¾ç½®. earliestæ„æ€æ˜¯ä¼šä»0å¼€å§‹è¯»å–, è€Œlatestæ„æ€æ˜¯ä»æœ€æœ«å°¾å¼€å§‹. enable.auto.commit æŒ‰ç…§æ—¶é—´è®¡åˆ’æäº¤åç§»é‡æˆ–è€…ä»£ç ä¸­æ‰‹åŠ¨æäº¤. å¯¹consumeræ¥è¯´è¿™æ˜¯ä¸€ä¸ªé‡å¤§çš„å†³å®š. è‡ªåŠ¨æäº¤ä¼šä¿è¯åªæäº¤å¾ªç¯ä¸­å·²ç»å¤„ç†çš„æ•°æ®, ä½†æ˜¯æœ‰å¯èƒ½ä¼šåœ¨ä¸‹æ¬¡æäº¤å§‹å‰ç³»ç»Ÿå´©æºƒ. è¿™å°±å¯¼è‡´å·²ç»è¢«å¤„ç†çš„æ¶ˆæ¯çš„åç§»é‡æ²¡æœ‰æäº¤åˆ°broker. ä¸‹æ¬¡æ‹‰å–çš„æ—¶å€™(consumeré‡æ–°ä¸Šçº¿æˆ–è€…rebalanceæ—¶å€™ç”±å…¶ä»–æ¶ˆè´¹è€…å¤„ç†è¯¥åˆ†åŒº)ä¼šé‡æ–°æ‹‰å–å·²ç»å¤„ç†è¿‡çš„æ¶ˆæ¯, é‡å¤æ¶ˆè´¹. å‡å¦‚ä½ æ˜¯å°†æ‹‰å–çš„æ¶ˆæ¯äº¤ç”±å…¶ä»–çš„çº¿ç¨‹å¤„ç†, é‚£è‡ªåŠ¨æäº¤å¯èƒ½ä¼šåˆ°æ—¶æ¶ˆæ¯è¢«æ‹‰å–, å´æ²¡æœ‰è¢«å¤„ç†. è‡ªåŠ¨æäº¤çš„å¥½å¤„æ˜¯ååé‡å¤§. auto.commit.interval.ms å½“enable.auto.commitè®¾ç½®ä¸ºtrueçš„æ—¶å€™, é€šè¿‡è¿™ä¸ªé…ç½®æ§åˆ¶è‡ªåŠ¨æäº¤çš„æ—¶é—´é—´éš”. è¶Šå¤§ååå°±è¶Šå¤§, ä¸€è‡´æ€§å°±è¶Šä½. è¶Šå°, åˆ™ä¼šå¢åŠ æäº¤çš„æ¬¡æ•°, å½±å“åå, ä½†æ˜¯ä¼šæé«˜ä¸€è‡´æ€§. å‡†ç¡®æäº¤åç§»é‡ æ€»æ˜¯æäº¤å·²ç»å¤„ç†è¿‡å¾—æ¶ˆæ¯ å‡å¦‚ä½ æ˜¯åœ¨å¾ªç¯ä¸­å¤„ç†æ‰€æœ‰çš„æ¶ˆæ¯, å¹¶ä¸”ä¸éœ€è¦ç»´æŠ¤è·¨å¤šæ¬¡è½®è¯¢çš„çŠ¶æ€, ä¼šæ¯”è¾ƒå®¹æ˜“å®ç°. å¯ä»¥ä½¿ç”¨è‡ªåŠ¨æäº¤, æˆ–è€…åœ¨è½®è¯¢å¾ªç¯çš„æœ«å°¾è¿›è¡Œåç§»é‡æäº¤.\næäº¤é¢‘ç‡æ˜¯æ€§èƒ½å’Œç³»ç»Ÿå´©æºƒæ—¶é‡å¤çš„æ¶ˆæ¯æ•°é‡é—´çš„å–èˆ ä¸€æ¬¡è½®è¯¢å¾ªç¯ä¸­å¯ä»¥è¿›è¡Œå¤šæ¬¡åç§»é‡æäº¤, ç”šè‡³æ¯å¤„ç†ä¸€æ¡æäº¤ä¸€æ¬¡. æˆ–è€…å‡ ä¸ªè½®è¯¢æäº¤ä¸€æ¬¡. æäº¤ä¼šæœ‰æ€§èƒ½ä¸Šçš„å¼€é”€, ç±»ä¼¼ç”Ÿäº§è€…çš„acks=all\nä¿è¯ä½ æ¸…æ¥šçš„äº†è§£å°†è¦æäº¤ä»€ä¹ˆåç§»é‡ å¸¸è§çš„ä¸€ä¸ªé™·é˜±å°±æ˜¯ä¸€æ¬¡è½®è¯¢å¾ªç¯ä¸­çš„åç§»é‡æäº¤äº†è¯»åˆ°çš„æœ€å¤§åç§»é‡, è€Œä¸æ˜¯å·²ç»å¤„ç†è¿‡å¾—æœ€å¤§åç§»é‡. ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±.\nå†å¹³è¡¡ å‡†ç¡®å¤„ç†consumerçš„å†å¹³è¡¡(consumerä¸Šçº¿æˆ–è€…ä¸‹çº¿). å†å¹³è¡¡ä¼šå¼•èµ·å…ˆä»æ¶ˆè´¹è€…ä¸Šæ‘˜å–æŸäº›åˆ†åŒº, ç„¶ååœ¨åˆ†é…æŸäº›åˆ†åŒº. é€šè¿‡å®ç°RebalanceListeneræ¥å£æ¥å®ç°æ§åˆ¶.\næ¶ˆè´¹è€…å¯èƒ½éœ€è¦é‡è¯• æŸäº›åœºæ™¯ä¸‹, æš‚æ—¶ä¸æäº¤åç§»é‡, ä¸‹æ¬¡è½®è¯¢çš„æ—¶å€™ä¼šé‡å¤æ‹‰å–æ¶ˆæ¯. æ¯”å¦‚æ•°æ®åº“è¿æ¥æš‚æ—¶ä¸å¯ç”¨çš„æƒ…å†µä¸‹.\næ¶ˆè´¹è€…å¯èƒ½éœ€è¦ç»´æŠ¤çŠ¶æ€ æŸäº›åœºæ™¯ä¸‹, éœ€è¦åœ¨å¤šä¸ªè½®è¯¢é—´å­˜åœ¨èšåˆè¿ç®—.\nå¤„ç†é•¿æ—¶é—´çš„å¤„ç† æœ‰äº›æ—¶å€™, æ¶ˆæ¯çš„å¤„ç†è€—æ—¶è¾ƒé•¿, æ¯”å¦‚ä¸å…¶ä»–ç³»ç»Ÿäº¤äº’æˆ–è€…è¿›è¡Œæ¯”è¾ƒå¤æ‚çš„è¿ç®—. æŸäº›Kafkaç‰ˆæœ¬çš„æ¶ˆè´¹è€…, ä¸¤æ¬¡è½®è¯¢çš„é—´éš”ä¸èƒ½å¤ªé•¿ (0.10.0.0ä¹‹å‰ç‰ˆæœ¬çš„æ¶ˆè´¹è€…æ²¡æœ‰å•ç‹¬çš„å¿ƒè·³è¿›ç¨‹, æ˜¯é€šè¿‡è½®è¯¢åŒæ—¶è¾¾åˆ°å¿ƒè·³ç›®çš„). å¤ªé•¿, æ¶ˆè´¹è€…åˆ™ä¼šè¢«è®¤ä¸ºæ˜¯ä¸‹çº¿, ä¼šå‘ç”Ÿå†å¹³è¡¡.\næœ‰ä¸”åªæœ‰ä¸€æ¬¡çš„æ¶ˆæ¯æŠ•é€’ æœ‰äº›åœºæ™¯éœ€è¦è‡³å°‘ä¸€æ¬¡çš„è¯­ä¹‰(æ²¡æœ‰æ¶ˆæ¯ä¸¢å¤±); è€ŒæŸäº›åœºæ™¯åˆ™éœ€è¦æœ‰äº›åªæœ‰ä¸€æ¬¡çš„è¯­ä¹‰. ä½†æ˜¯å½“å‰Kafkaæ²¡æœ‰æä¾›å®Œç¾çš„æœ‰ä¸”åªæœ‰ä¸€æ¬¡çš„æ”¯æŒ. éœ€è¦ä¸å…¶ä»–ç³»ç»Ÿç»“åˆä¸€èµ·å®ç°, æ¯”å¦‚ä½¿ç”¨å”¯ä¸€çš„keyå†™å…¥æ•°æ®åº“æˆ–è€…redisç­‰å­˜å‚¨ä¸­.\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/kafka-reliable-data-delivery/","tags":["Kafka"],"title":"Kafkaçš„æ¶ˆæ¯å¯é ä¼ é€’"},{"categories":["æºç è§£æ"],"contents":"å‡†å¤‡åšä¸ªSpring Cloudæºç åˆ†æç³»åˆ—, ä½œä¸ºSpring Cloudçš„æºç åˆ†æç¬”è®°.\nè¿™ä¸€ç¯‡æ˜¯Eurekaçš„å®¢æˆ·ç«¯.\nå®¢æˆ·ç«¯ ä¸¤ç§æ–¹å¼, æœ€ç»ˆçš„å®ç°åŸºæœ¬ä¸€æ ·.\næ˜¾ç¤ºæŒ‡å®šæœåŠ¡å‘ç°çš„å®ç°ç±»å‹ ä½¿ç”¨@EnableEurekaClientæ³¨è§£æ˜¾ç¤ºçš„æŒ‡å®šä½¿ç”¨Eurekaä½œä¸ºæœåŠ¡å‘ç°çš„å®ç°, å¹¶å®ä¾‹åŒ–EurekaClientå®ä¾‹. å®é™…ä¸Šä½¿ç”¨çš„æ˜¯@EnableDiscoveryClientæ³¨è§£.\n@Target(ElementType.TYPE) @Retention(RetentionPolicy.RUNTIME) @Documented @Inherited @EnableDiscoveryClient public @interface EnableEurekaClient { } åŠ¨æ€é…ç½®å®ç° ä½¿ç”¨@EnableDiscoveryClientæ³¨è§£æ¥é…ç½®æœåŠ¡å‘ç°çš„å®ç°.\næºç åˆ†æ EnableDiscoveryClient\n@Target(ElementType.TYPE) @Retention(RetentionPolicy.RUNTIME) @Documented @Inherited @Import(EnableDiscoveryClientImportSelector.class) public @interface EnableDiscoveryClient { } EnableDiscoveryClientæ³¨è§£çš„ä½œç”¨ä¸»è¦æ˜¯ç”¨æ¥å¼•å…¥EnableDiscoveryClientImportSelector\nEnableDiscoveryClientImportSelector\n@Order(Ordered.LOWEST_PRECEDENCE - 100) public class EnableDiscoveryClientImportSelector extends SpringFactoryImportSelector\u0026lt;EnableDiscoveryClient\u0026gt; { @Override protected boolean isEnabled() { return new RelaxedPropertyResolver(getEnvironment()).getProperty( \u0026#34;spring.cloud.discovery.enabled\u0026#34;, Boolean.class, Boolean.TRUE); } @Override protected boolean hasDefaultFactory() { return true; } } EnableDiscoveryClientImportSelectorç»§æ‰¿äº†SpringFactoryImportSelectorå¹¶æŒ‡å®šäº†æ³›å‹EnableDiscoveryClient. è¿™é‡Œçš„æ³›å‹æ˜¯é‡ç‚¹.\nSpringFactoryImportSelector\npublic abstract class SpringFactoryImportSelector\u0026lt;T\u0026gt; implements DeferredImportSelector, BeanClassLoaderAware, EnvironmentAware { private ClassLoader beanClassLoader; private Class\u0026lt;T\u0026gt; annotationClass; protected SpringFactoryImportSelector() { this.annotationClass = (Class\u0026lt;T\u0026gt;) GenericTypeResolver .resolveTypeArgument(this.getClass(), SpringFactoryImportSelector.class); } public String[] selectImports(AnnotationMetadata metadata) { ... } } è¿™é‡Œåªæˆªå–äº†éƒ¨åˆ†å˜é‡å’Œæ–¹æ³• SpringFactoryImportSelectoræ˜¯spring cloud commonåŒ…ä¸­çš„ä¸€ä¸ªæŠ½è±¡ç±», ä¸»è¦ä½œç”¨æ˜¯æ£€æŸ¥æ³›å‹Tæ˜¯å¦æœ‰æŒ‡å®šçš„factoryå®ç°, å³spring.factoriesä¸­æœ‰å¯¹åº”ç±»çš„é…ç½®.\nspring.factories\nåœ¨spring-cloud-netflix-eureka-client.jar!/META-INF/spring.factoriesä¸­EnableDiscoveryClientçš„æŒ‡å®šfactoryå®ç°æ˜¯\norg.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ org.springframework.cloud.netflix.eureka.config.EurekaClientConfigServerAutoConfiguration,\\ org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceAutoConfiguration,\\ org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration,\\ org.springframework.cloud.netflix.ribbon.eureka.RibbonEurekaAutoConfiguration org.springframework.cloud.bootstrap.BootstrapConfiguration=\\ org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceBootstrapConfiguration org.springframework.cloud.client.discovery.EnableDiscoveryClient=\\ org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration åŒæ—¶EnableAutoConfigurationä¸­åŒ…å«äº†org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration, EurekaClientAutoConfigurationä¼šä¸ºEurekaDiscoveryClientConfigurationçš„å®ä¾‹ä¾èµ–è¿›è¡Œåˆå§‹åŒ–, å¦‚EurekaClient. EurekaClientåœ¨æ„é€ æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªHeartBeatçº¿ç¨‹, çº¿ç¨‹åœ¨è¿è¡Œçš„æ—¶å€™ä¼šåšrenewçš„æ“ä½œ, å°†Applicationçš„ä¿¡æ¯æ³¨å†Œæ›´æ–°åˆ°Eurekaçš„æœåŠ¡ç«¯.\nEurekaDiscoveryClientConfiguration\n@Configuration @EnableConfigurationProperties @ConditionalOnClass(EurekaClientConfig.class) @ConditionalOnProperty(value = \u0026#34;eureka.client.enabled\u0026#34;, matchIfMissing = true) @CommonsLog public class EurekaDiscoveryClientConfiguration implements SmartLifecycle, Ordered { ... } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/spring-cloud-eureka-client-source-code-analysis/","tags":["Java","Spring"],"title":"Spring Cloud - Eureka Clientæºç åˆ†æ"},{"categories":["ç¬”è®°"],"contents":"Raft å¼ºä¸€è‡´æ€§ç®—æ³•\nåè¯ å¤åˆ¶çŠ¶æ€æœº å¤åˆ¶çŠ¶æ€æœºæ˜¯é€šè¿‡å¤åˆ¶æ—¥å¿—æ¥å®ç°çš„, æŒ‰ç…§æ—¥å¿—ä¸­çš„å‘½ä»¤çš„é¡ºåºæ¥æ‰§è¡Œè¿™äº›å‘½ä»¤. ç›¸åŒçš„çŠ¶æ€æœºæ‰§è¡Œç›¸åŒçš„æ—¥å¿—å‘½ä»¤, è·å¾—ç›¸åŒçš„æ‰§è¡Œç»“æœ.\nä»»æœŸå· (currentTerm) æ¯ä¸ªæˆå‘˜éƒ½ä¼šä¿å­˜ä¸€ä¸ªä»»æœŸå·, ç§°ä¸ºæœåŠ¡å™¨æœ€åçŸ¥é“çš„ä»»æœŸå·.\næŠ•ç¥¨çš„å€™é€‰äººid (votedFor) å½“å‰ä»»æœŸå†…, æŠ•ç¥¨çš„å€™é€‰äººid, å³å“åº”æŠ•ç¥¨è¯·æ±‚(è§ä¸‹æ–‡)è¿”å›trueæ—¶çš„å€™é€‰äººid.\nå·²è¢«æäº¤çš„æœ€å¤§æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼ (commitIndex) æ¯ä¸ªæˆå‘˜éƒ½ä¼šæŒæœ‰å·²è¢«æäº¤çš„æœ€å¤§æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼\nè¢«çŠ¶æ€æœºæ‰§è¡Œçš„æœ€â¼¤æ—¥å¿—æ¡â½¬çš„ç´¢å¼•å€¼ (lastApplied) æ¯ä¸ªæˆå‘˜éƒ½ä¼šæŒæœ‰è¢«çŠ¶æ€æœºæ‰§è¡Œçš„æœ€â¼¤æ—¥å¿—æ¡â½¬çš„ç´¢å¼•å€¼\nè¯·æ±‚ æ—¥å¿—å¤åˆ¶è¯·æ±‚ (AppendEntries RPC) ç”±é¢†å¯¼äººå‘é€ç»™å…¶ä»–æœåŠ¡å™¨, ä¹Ÿç”¨ä½œheartbeat\nè¯·æ±‚å†…å®¹\nterm é¢†å¯¼äººçš„ä»»æœŸå· leaderId é¢†å¯¼äººçš„id prevLogIndex å·²ç»è¢«çŠ¶æ€æœºæ‰§è¡Œçš„æœ€å¤§ç´¢å¼•å€¼, å³æœ€æ–°æ—¥å¿—ä¹‹å‰çš„æ—¥å¿—çš„ç´¢å¼•å€¼. preLogTerm æœ€æ–°æ—¥å¿—ä¹‹å‰çš„æ—¥å¿—çš„é¢†å¯¼äººçš„ä»»æœŸå· entries[] éœ€è¦è¢«å¤åˆ¶çš„æ—¥å¿—æ¡ç›® leaderCommit é¢†å¯¼äººæäº¤çš„æ—¥å¿—æ¡ç›®ç´¢å¼•å€¼ å“åº”å†…å®¹\nterm å½“å‰çš„ä»»æœŸå·, ç”¨äºé¢†å¯¼äººæ›´æ–°è‡ªå·±çš„ä»»æœŸå· success ç›®æ ‡æœåŠ¡å™¨æ˜¯å¦èƒ½å¤ŸåŒ¹é…prevLogIndexå’ŒpreLogTerm æ¥å—è€…çš„å¤„ç†\nå¦‚æœterm \u0026lt; currentTermè¿”å›false, å³å‘é€è¯·æ±‚çš„é¢†å¯¼äººä»»æœŸå·å°äºæœåŠ¡å™¨æœ€åçŸ¥é“çš„ä»»æœŸå·, æ„å‘³ç€é¢†å¯¼äººå‘ç”Ÿäº†å˜æ›´. å¦‚æœprevLogIndexå’ŒpreLogTermä¸åŒ¹é…, è¿”å›false. å³å‘é€è¯·æ±‚çš„é¢†å¯¼äººçš„æ—¥å¿—ä¸æ˜¯æœ€æ–°çš„, å¦‚æœæœ‰ä¸€æ¡å·²ç»å­˜åœ¨çš„â½‡å¿—ä¸æ–°çš„å†²çªï¼ˆindex ç›¸åŒä½†æ˜¯ä»»æœŸå· termä¸åŒï¼‰ï¼Œåˆ™åˆ é™¤å·²ç»å­˜åœ¨çš„â½‡å¿—å’Œå®ƒä¹‹åæ‰€æœ‰çš„æ—¥å¿— æ·»åŠ ä»»ä½•åœ¨å·²æœ‰çš„æ—¥å¿—ä¸­ä¸å­˜åœ¨çš„æ¡ç›® å¦‚æœleaderCommit \u0026gt; commitIndex, åˆ™æ›´æ–°commitIndexä¸ºleaderCommitå’Œæœ€æ–°æ—¥å¿—æ¡ç›®ç´¢å¼•å€¼ä¸­è¾ƒå°çš„ä¸€ä¸ª å‘èµ·æŠ•ç¥¨è¯·æ±‚ (RequestVote RPC) ç”±å€™é€‰äººå‘èµ·çš„, å‘ç»™é›†ç¾¤ä¸­å·²çŸ¥çš„å…¶ä»–æˆå‘˜\nè¯·æ±‚å†…å®¹\nterm å€™é€‰äººçš„ä»»æœŸå· (åœ¨å˜æ›´ä¸ºé¢†å¯¼äººä¹‹å‰çš„ä¿å­˜çš„ä»»æœŸå·çš„åŸºç¡€ä¸ŠåŠ 1) candidatedId è¯·æ±‚æŠ•ç¥¨çš„å€™é€‰äººid lastLogIndex å€™é€‰äººæœ€æ–°æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼ lastLogTerm å€™é€‰äººæœ€æ–°æ—¥å¿—æ¡ç›®å¯¹åº”çš„ä»»æœŸå· å“åº”å†…å®¹\nterm ç›®å‰çš„ä»»æœŸå·, ç”¨äºå€™é€‰äººæ›´æ–°è‡ªå·±çš„ä»»æœŸå· voteGranted æ”¶åˆ°é€‰ç¥¨ä¸ºtrue æ¥å—è€…çš„å¤„ç†\nå¦‚æœterm \u0026lt; currentTerm è¿”å›voteGrantedä¸ºfalse å¦‚æœvotedForä¸ºç©º, å¹¶ä¸”lastLogIndexå’ŒlastLogTermåŒ¹é…æˆåŠŸ, åˆ™ä¸ºè¯¥å€™é€‰äººæŠ•ç¥¨, è¿”å›voteGrantedä¸ºtrue. å¹¶æ›´æ–°ä¸ºå€™é€‰äººid å®‰è£…å¿«ç…§è¯·æ±‚ (InstalSnapshotRPC) åœ¨é¢†å¯¼äººå‘é€å¿«ç…§ç»™è·Ÿéšè€…æ—¶ä½¿ç”¨, æŒ‰é¡ºåºå‘é€.\nè¯·æ±‚å†…å®¹\nterm é¢†å¯¼äººçš„ä»»æœŸå· leaderId é¢†å¯¼äººid lastIncludedIndex å¿«ç…§ä¸­åŒ…å«çš„æœ€åæ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼ lastIncludedTerm å¿«ç…§ä¸­åŒ…å«çš„æœ€åæ—¥å¿—æ¡ç›®çš„ä»»æœŸå· offset åˆ†å—åœ¨å¿«ç…§å—ä¸­çš„åç§»é‡ data[] å¿«ç…§çš„åŸå§‹æ•°æ® done å¦‚æœæ˜¯æœ€åä¸€å—æ•°æ®åˆ™ä¸ºtrue å“åº”å†…å®¹\nterm ç›®æ ‡æœåŠ¡å™¨çš„currentTerm, ç”¨äºé¢†å¯¼äººæ›´æ–°è‡ªå·± æ¥å—è€…çš„å¤„ç†\nå¦‚æœterm \u0026lt; currentTerm ç«‹åˆ»å›å¤ å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªåˆ†å—(offsetä¸º0)åˆ™åˆ›å»ºæ–°çš„å¿«ç…§ åœ¨æŒ‡å®šçš„åç§»é‡å†™å…¥æ•°æ® å¦‚æœdoneæœªfalse, åˆ™å›å¤å¹¶ç»§ç»­ç­‰å¾…ä¹‹åçš„æ•°æ® ä¿å­˜å¿«ç…§æ–‡ä»¶, ä¸¢å¼ƒæ‰€æœ‰å­˜åœ¨çš„æˆ–è€…éƒ¨åˆ†æœ‰ç€æ›´æ–°ç´¢å¼•å·çš„å¿«ç…§ å¦‚æœç°å­˜çš„æ—¥å¿—æ‹¥æœ‰ç›¸åŒçš„æœ€åä»»æœŸå·å’Œç´¢å¼•å€¼, åˆ™åé¢çš„æ•°æ®ç»§ç»­ä¿ç•™å¹¶ä¸”å›å¤ ä¸¢å¼ƒå…¨éƒ¨æ—¥å¿— èƒ½å¤Ÿä½¿ç”¨å¿«ç…§æ¥æ¢å¤çŠ¶æ€æœº (å¹¶ä¸”è£…è½½å¿«ç…§ä¸­çš„é›†ç¾¤é…ç½®) çº¦æŸ/åŸåˆ™ é€‰ä¸¾å®‰å…¨åŸåˆ™ Election Safety: ä¸€ä¸ªä»»æœŸå†…æœ€å¤šåªæœ‰ä¸€ä¸ªé¢†å¯¼äººå½“é€‰ é¢†å¯¼äººåªå¢åŠ åŸåˆ™ Leader Append-Only: é¢†å¯¼äººæ°¸è¿œä¸ä¼šè¦†ç›–æˆ–è€…åˆ é™¤è‡ªå·±çš„æ—¥å¿—, å®ƒåªä¼šå¢åŠ æ¡ç›® æ—¥å¿—åŒ¹é…åŸåˆ™ Log Matching: å¦‚æœä¸¤ä¸ªæ—¥å¿—åœ¨ç›¸åŒçš„ç´¢å¼•ä½ç½®ä¸Šçš„æ—¥å¿—æ¡ç›®çš„ä»»æœŸå·ç›¸åŒ, é‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸ºæ—¥å¿—ä»å¤´åˆ°è¿™ä¸ªç´¢å¼•ä½ç½®ä¹‹é—´çš„æ¡ç›®å®Œå…¨ç›¸åŒ é¢†å¯¼äººå®Œå…¨åŸåˆ™ Leader Completeness: å¦‚æœä¸€ä¸ªæ—¥å¿—æ¡ç›®åœ¨ä¸€ä¸ªç»™å®šä»»æœŸå†…è¢«æäº¤, é‚£ä¹ˆè¿™ä¸ªæ¡ç›®ä¸€å®šä¼šå‡ºç°åœ¨æ‰€æœ‰ä»»æœŸå·æ›´å¤§çš„é¢†å¯¼äººä¸­ çŠ¶æ€æœºå®‰å…¨åŸåˆ™ State Machine Safety: å¦‚æœä¸€ä¸ªæœåŠ¡å™¨å·²ç»å°†ç»™å®šç´¢å¼•ä½ç½®çš„æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°çŠ¶æ€æœºä¸­, åˆ™æ‰€æœ‰çš„å…¶ä»–æœåŠ¡å™¨ä¸ä¼šåœ¨è¯¥ç´¢å¼•ä½ç½®åº”ç”¨ä¸åŒçš„æ¡ç›® é¢†å¯¼äººé€‰ä¸¾ (Leader election) é›†ç¾¤æˆå‘˜çš„çŠ¶æ€ é¢†å¯¼äºº å€™é€‰äºº è¿½éšè€…. åœ¨åŒä¸€æ—¶é—´, æˆå‘˜åªä¼šå±äºå…¶ä¸­çš„ä¸€ç§çŠ¶æ€. å¹¶ä¸”é›†ç¾¤ä¸­åªä¼šå­˜åœ¨ä¸€ä¸ªé¢†å¯¼äºº.\næœ‰é¢†å¯¼äººæ—¶: ä¸€ä¸ªé¢†å¯¼äºº, n-1ä¸ªè¿½éšè€… æ— é¢†å¯¼äººæ—¶: xä¸ªå€™é€‰äºº, n-xä¸ªè¿½éšè€…\nçº¦æŸ é›†ç¾¤ä¸­æœ€å¤šå­˜åœ¨ä¸€ä¸ªé¢†å¯¼äºº è¿½éšè€…ä¸ä¼šå‘é€è¯·æ±‚, åªä¼šæ¥å—æ¥è‡ªé¢†å¯¼äººçš„AppendEntries RPCè¯·æ±‚, å’Œå€™é€‰äººçš„RequestVote RPCè¯·æ±‚. AppendEntries RPCè¯·æ±‚åŒæ—¶æä¾›heartbeatæœºåˆ¶ é¢†å¯¼äººåªæ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ ä»»æœŸ æ—¶é—´è¢«åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªçš„ä»»æœŸ, æ¯ä¸€ä¸ªä»»æœŸçš„å¼€å§‹éƒ½æ˜¯é¢†å¯¼äººçš„é€‰ä¸¾.\néšæœºçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ ä¾‹å¦‚150~300æ¯«ç§’, é˜²æ­¢æ— é™é€‰ä¸¾å¤±è´¥.\næ—¥å¿—å¤åˆ¶ çº¦æŸ æ—¥å¿—çš„æµå‘åªä¼šæ˜¯ä»é¢†å¯¼äººåˆ°è¿½éšè€…. é¢†å¯¼äººä¸ä¼šè¦†ç›–è‡ªå·±çš„æ—¥å¿—.\næµç¨‹ é¢†å¯¼äººæ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚, æŠŠè¯·æ±‚ä¸­çš„å‘½ä»¤ä½œä¸ºæ—¥å¿—æ¡ç›®åŠ å…¥åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­, ç„¶åå‘è¿½éšè€…å‘é€AppendEnties RPCè¯·æ±‚, è¦æ±‚è¿½éšè€…å¤åˆ¶è¿™æ¡æ—¥å¿—æ¡ç›®. è¿½éšè€…å¤åˆ¶å®Œæˆåä¼šå“åº”é¢†å¯¼äºº. æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šå“åº”å, é¢†å¯¼äººä¼šå°†è¯¥æ¡ç›®åº”ç”¨åˆ°çŠ¶æ€æœºä¸­, å¹¶å“åº”å®¢æˆ·ç«¯. å‡å¦‚æœ‰è¿½éšè€…æ²¡æœ‰å“åº”, é¢†å¯¼äººä¼šæ— é™åœ°é‡è¯•AppendEnties RPCè¯·æ±‚ç›´åˆ°æ‰€æœ‰çš„è¿½éšè€…éƒ½å¤åˆ¶äº†è¯¥æ¡ç›®.\nå®‰å…¨æ€§ æ²¡æœ‰åŒ…å«å…¨éƒ¨æ—¥å¿—çš„æœåŠ¡å™¨ä¸ä¼šèµ¢å¾—é€‰ä¸¾, å³æŸäº›æŠ•ç¥¨è¯·æ±‚çš„å“åº”è¿”å›false.\næ—¥å¿—å‹ç¼© æŠŠå½“å‰çš„ç³»ç»ŸçŠ¶æ€å†™å…¥å¿«ç…§(snapshot)ä¸­, å¹¶æŒä¹…åŒ–åˆ°å­˜å‚¨ä¸­, ç„¶åä¸¢å¼ƒä¹‹å‰çš„å…¨éƒ¨æ—¥å¿—.\nå¿«ç…§ä¸­åŒ…å«äº†æœ€åçš„ç´¢å¼•å€¼å’Œä»»æœŸå·.\nå¢é‡å‹ç¼©(incremental approaches)\né¢†å¯¼äººå¿…é¡»å¶å°”åœ°å‘é€å¿«ç…§ç»™ä¸€äº›è½åçš„è·Ÿéšè€…. è¿è¡Œéå¸¸ç¼“æ…¢æˆ–è€…æ–°åŠ å…¥çš„è·Ÿéšè€…ä¸èƒ½ä¸é¢†å¯¼äººä¿æŒåŒæ­¥, å¯ä»¥é€šè¿‡å‘é€å¿«ç…§çš„æ–¹å¼è®©è·Ÿéšè€…æ›´æ–°åˆ°æœ€æ–°çš„çŠ¶æ€.\nå‚è€ƒ Raft ä¸€è‡´æ€§ç®—æ³•è®ºæ–‡è¯‘æ–‡\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/learning-raft/","tags":null,"title":"Raftç®—æ³•å­¦ä¹ "},{"categories":["ç¬”è®°"],"contents":"èƒŒæ™¯ Kafkaçš„æ€§èƒ½ä¼—æ‰€å‘¨çŸ¥ï¼ŒProduceræ”¯æŒacknowledgeæ¨¡å¼ã€‚å³Kafkaä¼šæƒ³Producerè¿”å›æ¶ˆæ¯å‘é€çš„ç»“æœã€‚ä½†æ˜¯åœ¨Java Clientä¸­ï¼Œacknowledgeçš„ç¡®è®¤æœ‰ä¸¤ç§ï¼šåŒæ­¥å’Œå¼‚æ­¥ã€‚ åŒæ­¥æ˜¯é€šè¿‡è°ƒç”¨future.get()å®ç°çš„ï¼›å¼‚æ­¥åˆ™æ˜¯é€šè¿‡æä¾›callbackæ–¹æ³•æ¥å®ç°ã€‚å†™äº†ä¸ªç®€å•çš„ç¨‹åºæµ‹è¯•ä¸€ä¸‹å•çº¿ç¨‹ä¸­ååå·®å¼‚èƒ½æœ‰å¤šå¤§ã€‚æ³¨æ„è¿™é‡Œåªè€ƒè™‘æ¨ªå‘å¯¹æ¯”ã€‚\nå‘é€ç«¯å•çº¿ç¨‹ Kafkaä¸ºå•é›†ç¾¤èŠ‚ç‚¹ topicçš„åˆ†åŒºæ•°ä¸º1 keyé•¿åº¦1 payloadé•¿åº¦100 æµ‹è¯•å·¥å…· JMeter Kafka Meter future.get() + batch size =1 future.get() + batch size = 16K callback + batch size = 16k callback + batch size = 1 ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/kafka-producer-acknowledge-benchmark/","tags":["Java","Kafka"],"title":"Kafkaå‘é€ä¸åŒç¡®è®¤æ–¹å¼çš„æ€§èƒ½å·®å¼‚"},{"categories":["ç¬”è®°"],"contents":"Kafkaæ¶ˆè´¹ç«¯çš„offsetä¸»è¦ç”±consumeræ¥æ§åˆ¶, Kafkaé™æ¯ä¸ªconsumeræ‰€ç›‘å¬çš„tocpicçš„partitionçš„offsetä¿å­˜åœ¨__consumer_offsetsä¸»é¢˜ä¸­. consumeréœ€è¦å°†å¤„ç†å®Œæˆçš„æ¶ˆæ¯çš„offsetæäº¤åˆ°æœåŠ¡ç«¯, ä¸»è¦æœ‰ConsumerCoordinatorå®Œæˆçš„.\næ¯æ¬¡ä»kafkaæ‹‰å–æ•°æ®ä¹‹å‰, å‡å¦‚æ˜¯å¼‚æ­¥æäº¤offset, ä¼šå…ˆè°ƒç”¨å·²ç»å®Œæˆçš„offset commitçš„callBack, ç„¶åæ£€æŸ¥ConsumerCoordinatorçš„è¿æ¥çŠ¶æ€. å¦‚æœè®¾ç½®äº†è‡ªåŠ¨æäº¤offset, ä¼šç»§ç»­ä¸Šæ¬¡ä»æœåŠ¡ç«¯è·å–çš„æ•°æ®çš„offsetå¼‚æ­¥æäº¤åˆ°æœåŠ¡ç«¯. è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ä¼šæœ‰å‡ ç§æƒ…å†µå‡ºç°:\næ¶ˆæ¯å¤„ç†è€—æ—¶è¾ƒå¤š, å‡å¦‚å¤„ç†å•æ¡æ¶ˆæ¯çš„è€—æ—¶ä¸ºt, æ‹‰å–çš„æ¶ˆæ¯ä¸ªæ•°ä¸ºn. t * n \u0026gt; auto_commit_interval_ms, ä¼šå¯¼è‡´æ²¡æœ‰å¤„ç†å®Œçš„æ¶ˆæ¯çš„offsetè¢«commitåˆ°æœåŠ¡ç«¯. å‡å¦‚æ­¤æ—¶æ¶ˆè´¹ç«¯æŒ‚æ‰, æ²¡æœ‰å¤„ç†å®Œçš„æ•°æ®å°†ä¼šä¸¢å¤±. å‡å¦‚æ¶ˆæ¯å¤„ç†å®Œæˆ, offsetè¿˜æœªcommitåˆ°æœåŠ¡ç«¯çš„æ—¶å€™æ¶ˆè´¹ç«¯æŒ‚æ‰, å·²ç»å¤„ç†å®Œçš„æ¶ˆæ¯ä¼šè¢«å†æ¬¡æ¶ˆè´¹. ä¸‹é¢é…ç½®å½±å“ç€æ•°æ®ä¸€è‡´æ€§å’Œæ€§èƒ½, å› æ­¤éœ€è¦ç»“åˆä¸šåŠ¡åœºæ™¯åˆç†é…ç½®ä¸€ä¸‹å‚æ•°, è¿›è¡Œå–èˆ.\nenable.auto.commit é»˜è®¤ä¸ºtrue\nauto.commit.interval.ms é»˜è®¤ä¸º5000 ms (5s)\nmax.poll.records é»˜è®¤ä¸º500\nfetch.max.bytes é»˜è®¤ä¸º52428800 bytes (50Mib).\nä¸€è‡´æ€§ è¿™é‡Œæˆ‘ä»¬é’ˆå¯¹å‰é¢å‡ºç°çš„ä¸¤ä¸ªé—®é¢˜ç»™å‡ºè§£å†³æ–¹æ¡ˆ.\nKafka Java Client æŠŠenable.auto.commitè®¾ç½®ä¸ºfalse, å¹¶åœ¨æ¯å¤„ç†å®Œä¸€æ¡æ•°æ®åæ‰‹åŠ¨æäº¤offset.\nè¿™é‡Œéœ€è¦ä¸»æ„çš„æ—¶, æäº¤çš„offsetæ˜¯å¯¹å½“å‰æ¶ˆæ¯çš„offsetåŸºç¡€ä¸Šè¿›è¡ŒåŠ 1.\npublic class ConsumerTest { public static void main(String[] args) throws InterruptedException { Properties props = new Properties(); props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, \u0026#34;192.168.31.186:9092\u0026#34;); props.put(ConsumerConfig.GROUP_ID_CONFIG, \u0026#34;test\u0026#34;); props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, OffsetResetStrategy.NONE.toString().toLowerCase(Locale.ROOT)); props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, \u0026#34;false\u0026#34;); props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, \u0026#34;org.apache.kafka.common.serialization.StringDeserializer\u0026#34;); props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, \u0026#34;org.apache.kafka.common.serialization.StringDeserializer\u0026#34;); KafkaConsumer\u0026lt;String, String\u0026gt; consumer = new KafkaConsumer\u0026lt;\u0026gt;(props); consumer.subscribe(Arrays.asList(\u0026#34;my-topic\u0026#34;)); while (true) { ConsumerRecords\u0026lt;String, String\u0026gt; records = consumer.poll(100); if (!records.isEmpty()) { for (ConsumerRecord\u0026lt;String, String\u0026gt; record : records) { System.out.printf(\u0026#34;offset = %d, key = %s, value = %s%n\u0026#34;, record.offset(), record.key(), record.value()); //Manually commit each record consumer.commitSync(Collections.singletonMap(new TopicPartition(record.topic(), record.partition()), new OffsetAndMetadata(record.offset() + 1))); } } } } } Spring Kafka æŠŠenable.auto.commitè®¾ç½®ä¸ºfalse\nè®¾ç½®ContainerPropertiesçš„ackModeä¸ºMANUAL_IMMEDIATE\nä½¿ç”¨AcknowledgingMessageListenerä½œä¸ºlistener, å¹¶åœ¨æ¶ˆæ¯å¤„ç†å®Œæˆåè°ƒç”¨acknowledgment.acknowledge().\npublic class SpringConsumerTest { public static void main(String[] args) { String bootstrapServer = \u0026#34;192.168.31.186:9092\u0026#34;; String groupId = \u0026#34;spring-consumer-group\u0026#34;; ContainerProperties containerProperties = new ContainerProperties(\u0026#34;my-topic\u0026#34;); containerProperties.setAckMode(AbstractMessageListenerContainer.AckMode.MANUAL_IMMEDIATE); containerProperties.setMessageListener( (AcknowledgingMessageListener\u0026lt;String, String\u0026gt;) (consumerRecord, acknowledgment) -\u0026gt; { System.out.println(consumerRecord); acknowledgment.acknowledge(); }); Map\u0026lt;String, Object\u0026gt; consumerConfigs = new HashMap\u0026lt;\u0026gt;(); consumerConfigs.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServer); consumerConfigs.put(ConsumerConfig.GROUP_ID_CONFIG, groupId); consumerConfigs.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, \u0026#34;false\u0026#34;); consumerConfigs.put(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, 10 * 1000); consumerConfigs.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, \u0026#34;earliest\u0026#34;); consumerConfigs.put(ConsumerConfig.METADATA_MAX_AGE_CONFIG, 10 * 1000); consumerConfigs.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class); consumerConfigs.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class); KafkaMessageListenerContainer\u0026lt;String, String\u0026gt; listenerContainer = new KafkaMessageListenerContainer\u0026lt;String, String\u0026gt;( new DefaultKafkaConsumerFactory(consumerConfigs), containerProperties); listenerContainer.start(); } } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/kafka-consumer-consistency/","tags":["Kafka"],"title":"Kafkaæ¶ˆæ¯æ¶ˆè´¹ä¸€è‡´æ€§"},{"categories":["ç¬”è®°"],"contents":"æ ¸å¿ƒæ€æƒ³ ç”Ÿäº§ç«¯ä¸€è‡´æ€§: å¼€å¯å¹‚ç­‰å’Œäº‹åŠ¡, åŒ…å«é‡è¯•, å‘é€ç¡®è®¤, åŒä¸€ä¸ªè¿æ¥çš„æœ€å¤§æœªç¡®è®¤è¯·æ±‚æ•°. æ¶ˆè´¹ç«¯ä¸€è‡´æ€§: é€šè¿‡è®¾ç½®è¯»å·²æäº¤çš„æ•°æ®å’ŒåŒæ—¶å¤„ç†å®Œæˆæ¯ä¸€æ¡æ¶ˆæ¯ä¹‹åæ‰‹åŠ¨æäº¤offset. ç”Ÿäº§ç«¯ public class ProducerTest { public static void main(String[] args) throws InterruptedException, ExecutionException { Properties props = new Properties(); props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, \u0026#34;192.168.31.186:9092\u0026#34;); props.put(ProducerConfig.TRANSACTIONAL_ID_CONFIG, \u0026#34;my-transactional-id\u0026#34;); props.put(ProducerConfig.ACKS_CONFIG, \u0026#34;all\u0026#34;); props.put(ProducerConfig.RETRIES_CONFIG, \u0026#34;3\u0026#34;); props.put(ProducerConfig.MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION, \u0026#34;1\u0026#34;); Producer\u0026lt;String, String\u0026gt; producer = new KafkaProducer\u0026lt;\u0026gt;(props, new StringSerializer(), new StringSerializer()); producer.initTransactions(); try { producer.beginTransaction(); for (int i = 0; i \u0026lt; 5; i++) { Future\u0026lt;RecordMetadata\u0026gt; send = producer .send(new ProducerRecord\u0026lt;\u0026gt;(\u0026#34;my-topic\u0026#34;, Integer.toString(i), Integer.toString(i))); System.out.println(send.get().offset()); TimeUnit.MILLISECONDS.sleep(1000L); } producer.commitTransaction(); } catch (ProducerFencedException | OutOfOrderSequenceException | AuthorizationException e) { // We can\u0026#39;t recover from these exceptions, so our only option is to close the producer and exit. producer.close(); } catch (KafkaException e) { // For all other exceptions, just abort the transaction and try again. producer.abortTransaction(); } producer.close(); } } æ¶ˆè´¹ç«¯ public class ConsumerTest { public static void main(String[] args) throws InterruptedException { Properties props = new Properties(); props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, \u0026#34;192.168.31.186:9092\u0026#34;); props.put(ConsumerConfig.GROUP_ID_CONFIG, \u0026#34;test\u0026#34;); props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, OffsetResetStrategy.NONE.toString().toLowerCase(Locale.ROOT)); props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, \u0026#34;false\u0026#34;); props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, \u0026#34;org.apache.kafka.common.serialization.StringDeserializer\u0026#34;); props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, \u0026#34;org.apache.kafka.common.serialization.StringDeserializer\u0026#34;); props.put(ConsumerConfig.ISOLATION_LEVEL_CONFIG, IsolationLevel.READ_COMMITTED.toString().toLowerCase(Locale.ROOT)); KafkaConsumer\u0026lt;String, String\u0026gt; consumer = new KafkaConsumer\u0026lt;\u0026gt;(props); consumer.subscribe(Arrays.asList(\u0026#34;my-topic\u0026#34;)); while (true) { ConsumerRecords\u0026lt;String, String\u0026gt; records = consumer.poll(100); if (!records.isEmpty()) { for (ConsumerRecord\u0026lt;String, String\u0026gt; record : records) { System.out.printf(\u0026#34;offset = %d, key = %s, value = %s%n\u0026#34;, record.offset(), record.key(), record.value()); //Manually commit each record consumer.commitSync(Collections.singletonMap(new TopicPartition(record.topic(), record.partition()), new OffsetAndMetadata(record.offset() + 1))); } } } } } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/kafka-exactly-once-delivery-and-transactional-messaging-example/","tags":["Kafka","Java"],"title":"Kafka æ°å¥½ä¸€æ¬¡å‘é€å’Œäº‹åŠ¡æ¶ˆè´¹ç¤ºä¾‹"},{"categories":["ç¬”è®°"],"contents":"Kafkaæä¾›â€œè‡³å°‘ä¸€æ¬¡â€äº¤ä»˜è¯­ä¹‰, è¿™æ„å‘³ç€å‘é€çš„æ¶ˆæ¯å¯ä»¥ä¼ é€ä¸€æ¬¡æˆ–å¤šæ¬¡. äººä»¬çœŸæ­£æƒ³è¦çš„æ˜¯â€œä¸€æ¬¡â€è¯­ä¹‰,å› ä¸ºé‡å¤çš„æ¶ˆæ¯æ²¡æœ‰è¢«ä¼ é€’ã€‚\næ™®éåœ°å‘å£°é‡å¤æ¶ˆæ¯çš„æƒ…å†µæœ‰ä¸¤ç§:\nå¦‚æœå®¢æˆ·ç«¯å°è¯•å‘é›†ç¾¤å‘é€æ¶ˆæ¯å¹¶è·å–ç½‘ç»œé”™è¯¯, åˆ™é‡è¯•å¯èƒ½ä¼šå¯¼è‡´é‡å¤. å¦‚æœåœ¨å‘é€æ¶ˆæ¯ä¹‹å‰å‘ç”Ÿç½‘ç»œé”™è¯¯, åˆ™ä¸ä¼šå‘ç”Ÿé‡å¤. ä½†æ˜¯, å¦‚æœåœ¨å°†æ¶ˆæ¯é™„åŠ åˆ°æ—¥å¿—ä¹‹åå‘ç”Ÿç½‘ç»œé”™è¯¯, ä½†åœ¨å°†å“åº”å‘é€ç»™å‘ä»¶äººä¹‹å‰, å‘ä»¶äººå°†ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ. å”¯ä¸€çš„é€‰æ‹©æ˜¯é‡è¯•å’Œå†’é™©é‡å¤æˆ–æ”¾å¼ƒå¹¶å£°æ˜æ¶ˆæ¯ä¸¢å¤±ã€‚ å¦‚æœå®¢æˆ·ç«¯å°è¯•å‘é›†ç¾¤å‘é€æ¶ˆæ¯å¹¶è·å–ç½‘ç»œé”™è¯¯, åˆ™é‡è¯•å¯èƒ½ä¼šå¯¼è‡´é‡å¤. å¦‚æœåœ¨å‘é€æ¶ˆæ¯ä¹‹å‰å‘ç”Ÿç½‘ç»œé”™è¯¯, åˆ™ä¸ä¼šå‘ç”Ÿé‡å¤. ä½†æ˜¯, å¦‚æœåœ¨å°†æ¶ˆæ¯é™„åŠ åˆ°æ—¥å¿—ä¹‹åå‘ç”Ÿç½‘ç»œé”™è¯¯, ä½†åœ¨å°†å“åº”å‘é€ç»™å‘ä»¶äººä¹‹å‰, å‘ä»¶äººå°†ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ. å”¯ä¸€çš„é€‰æ‹©æ˜¯é‡è¯•å’Œå†’é™©é‡å¤æˆ–æ”¾å¼ƒå¹¶å£°æ˜æ¶ˆæ¯ä¸¢å¤±ã€‚ ç¬¬äºŒç§æƒ…å†µå¯ä»¥é€šè¿‡ä½¿ç”¨Kafkaæä¾›çš„åç§»é‡ç”±æ¶ˆè´¹è€…å¤„ç†. ä»–ä»¬å¯ä»¥å°†åç§»é‡ä¸å…¶è¾“å‡ºè¿›è¡Œå­˜å‚¨, ç„¶åç¡®ä¿æ–°æ¶ˆè´¹è€…å§‹ç»ˆä»æœ€åå­˜å‚¨çš„åç§»é‡ä¸­æå–. æˆ–è€…, ä»–ä»¬å¯ä»¥ä½¿ç”¨åç§»é‡ä½œä¸ºä¸€ç§å…³é”®å­—, å¹¶ä½¿ç”¨å®ƒæ¥å¯¹å…¶è¾“å‡ºçš„ä»»ä½•æœ€ç»ˆç›®æ ‡ç³»ç»Ÿè¿›è¡Œé‡å¤æ•°æ®åˆ é™¤ã€‚\nProducer APIæ”¹åŠ¨ KafkaProducer.java\npublic interface Producer\u0026lt;K,V\u0026gt; extends Closeable { /** * Needs to be called before any of the other transaction methods. Assumes that * the transactional.id is specified in the producer configuration. * * This method does the following: * 1. Ensures any transactions initiated by previous instances of the producer * are completed. If the previous instance had failed with a transaction in * progress, it will be aborted. If the last transaction had begun completion, * but not yet finished, this method awaits its completion. * 2. Gets the internal producer id and epoch, used in all future transactional * messages issued by the producer. * * @throws IllegalStateException if the TransactionalId for the producer is not set * in the configuration. */ void initTransactions() throws IllegalStateException; /** * Should be called before the start of each new transaction. * * @throws ProducerFencedException if another producer is with the same * transactional.id is active. */ void beginTransaction() throws ProducerFencedException; /** * Sends a list of consumed offsets to the consumer group coordinator, and also marks * those offsets as part of the current transaction. These offsets will be considered * consumed only if the transaction is committed successfully. * * This method should be used when you need to batch consumed and produced messages * together, typically in a consume-transform-produce pattern. * * @throws ProducerFencedException if another producer is with the same * transactional.id is active. */ void sendOffsetsToTransaction(Map\u0026lt;TopicPartition, OffsetAndMetadata\u0026gt; offsets, String consumerGroupId) throws ProducerFencedException; /** * Commits the ongoing transaction. * * @throws ProducerFencedException if another producer is with the same * transactional.id is active. */ void commitTransaction() throws ProducerFencedException; /** * Aborts the ongoing transaction. * * @throws ProducerFencedException if another producer is with the same * transactional.id is active. */ void abortTransaction() throws ProducerFencedException; /** * Send the given record asynchronously and return a future which will eventually contain the response information. * * @param record The record to send * @return A future which will eventually contain the response information * */ public Future\u0026lt;RecordMetadata\u0026gt; send(ProducerRecord\u0026lt;K, V\u0026gt; record); /** * Send a record and invoke the given callback when the record has been acknowledged by the server */ public Future\u0026lt;RecordMetadata\u0026gt; send(ProducerRecord\u0026lt;K, V\u0026gt; record, Callback callback); } OutOfSequenceException å¦‚æœbrokeræ£€æµ‹åˆ°æ•°æ®ä¸¢å¤±ï¼Œç”Ÿäº§è€…å°†æŠ›å‡ºOutOfOrderSequenceExceptionã€‚ æ¢å¥è¯è¯´ï¼Œå¦‚æœå®ƒæ¥æ”¶åˆ°å¤§äºå…¶é¢„æœŸçš„åºåˆ—çš„åºåˆ—å·ã€‚ æœªæ¥å°†è¿”å›æ­¤å¼‚å¸¸ï¼Œå¹¶ä¼ é€’ç»™å›è°ƒï¼ˆå¦‚æœæœ‰ï¼‰ã€‚ è¿™æ˜¯ä¸€ä¸ªè‡´å‘½çš„å¼‚å¸¸ï¼Œæ–°çš„Produceræ–¹æ³•å¦‚sendï¼ŒbeginTransactionï¼ŒcommitTransactionç­‰å°†ä¼šæŠ›å‡ºIlegalStateExceptionã€‚\nåº”ç”¨ç¤ºä¾‹ public class KafkaTransactionsExample { public static void main(String args[]) { KafkaConsumer\u0026lt;String, String\u0026gt; consumer = new KafkaConsumer\u0026lt;\u0026gt;(consumerConfig); // Note that the â€˜transactional.idâ€™ configuration _must_ be specified in the // producer config in order to use transactions. KafkaProducer\u0026lt;String, String\u0026gt; producer = new KafkaProducer\u0026lt;\u0026gt;(producerConfig); // We need to initialize transactions once per producer instance. To use transactions, // it is assumed that the application id is specified in the config with the key // transactional.id. // // This method will recover or abort transactions initiated by previous instances of a // producer with the same app id. Any other transactional messages will report an error // if initialization was not performed. // // The response indicates success or failure. Some failures are irrecoverable and will // require a new producer instance. See the documentation for TransactionMetadata for a // list of error codes. producer.initTransactions(); while(true) { ConsumerRecords\u0026lt;String, String\u0026gt; records = consumer.poll(CONSUMER_POLL_TIMEOUT); if (!records.isEmpty()) { // Start a new transaction. This will begin the process of batching the consumed // records as well // as an records produced as a result of processing the input records. // // We need to check the response to make sure that this producer is able to initiate // a new transaction. producer.beginTransaction(); // Process the input records and send them to the output topic(s). List\u0026lt;ProducerRecord\u0026lt;String, String\u0026gt;\u0026gt; outputRecords = processRecords(records); for (ProducerRecord\u0026lt;String, String\u0026gt; outputRecord : outputRecords) { producer.send(outputRecord); } // To ensure that the consumed and produced messages are batched, we need to commit // the offsets through // the producer and not the consumer. // // If this returns an error, we should abort the transaction. sendOffsetsResult = producer.sendOffsetsToTransaction(getUncommittedOffsets()); // Now that we have consumed, processed, and produced a batch of messages, let\u0026#39;s // commit the results. // If this does not report success, then the transaction will be rolled back. producer.endTransaction(); } } } } æ–°å¢é…ç½® Brokeré…ç½® é…ç½® æè¿° transactional.id.timeout.ms äº‹åŠ¡åè°ƒå™¨åœ¨ä¸»åŠ¨è¿‡æœŸç”Ÿæˆå™¨TransactionalIdä¹‹å‰ç­‰å¾…çš„æœ€å¤§æ—¶é—´ï¼ˆä»¥msä¸ºå•ä½ï¼‰ï¼Œè€Œä¸ä»ä¸­æ¥æ”¶ä»»ä½•äº‹åŠ¡çŠ¶æ€æ›´æ–°ã€‚é»˜è®¤ä¸º604800000ï¼ˆ7å¤©ï¼‰ã€‚ è¿™å…è®¸å®šæœŸçš„æ¯å‘¨ç”Ÿäº§è€…å·¥ä½œæ¥ç»´æŠ¤å…¶IDã€‚ max.transaction.timeout.ms å…è®¸çš„æœ€å¤§çš„äº‹åŠ¡è¶…æ—¶æ—¶é—´. å¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯çš„äº‹åŠ¡è¯·æ±‚è¶…å‡ºè¿™ä¸ªè®¾ç½®, brokerä¼šåœ¨InitPidRequestçš„æ—¶å€™è¿”å›ä¸€ä¸ªInvalidTransactionTimeout. è¿™æ ·å¯ä»¥é˜²æ­¢å®¢æˆ·ç«¯å¤ªå¤§çš„è¶…æ—¶ï¼Œè¿™å¯èƒ½ä¼šå»¶è¿Ÿæ¶ˆè´¹è€…ä»åŒ…å«åœ¨äº‹åŠ¡ä¸­çš„ä¸»é¢˜ä¸­è¯»å–æ¶ˆæ¯. é»˜è®¤å€¼ä¸º900000ï¼ˆ15åˆ†é’Ÿï¼‰ã€‚ è¿™æ˜¯åœ¨æ¶ˆæ¯çš„äº¤æ˜“éœ€è¦å‘é€çš„æ—¶é—´æ®µå†…çš„ä¿å®ˆä¸Šé™ã€‚ transaction.state.log.replication.factor äº‹åŠ¡çŠ¶æ€ä¸»é¢˜(__transaction_state)çš„å‰¯æœ¬æ•°, é»˜è®¤ä¸º3 transaction.state.log.num.partitions äº‹åŠ¡çŠ¶æ€ä¸»é¢˜(__transaction_state)çš„çš„åˆ†åŒºæ•°, é»˜è®¤ä¸º50 transaction.state.log.min.isr äº‹åŠ¡çŠ¶æ€ä¸»é¢˜çš„æ¯ä¸ªåˆ†åŒºçš„æœ€å°æ•°é‡çš„å¼‚æ­¥å‰¯æœ¬éœ€è¦è¢«è§†ä¸ºè”æœºçš„ã€‚ é»˜è®¤ä¸º2 transaction.state.log.segment.bytes äº‹åŠ¡çŠ¶æ€ä¸»é¢˜çš„æ®µå¤§å°ã€‚é»˜è®¤å€¼ï¼š104857600å­—èŠ‚ã€‚100m ç”Ÿäº§è€…é…ç½® é…ç½® æè¿° enable.idempotence æ˜¯å¦å¯ç”¨å¹‚ç­‰ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸ºfalseï¼‰ã€‚ å¦‚æœç¦ç”¨ï¼Œç”Ÿäº§è€…å°†ä¸ä¼šåœ¨ç”Ÿæˆè¯·æ±‚ä¸­è®¾ç½®PIDå­—æ®µï¼Œå¹¶ä¸”å½“å‰çš„ç”Ÿäº§è€…ä¼ é€’è¯­ä¹‰å°†ç”Ÿæ•ˆã€‚ è¯·æ³¨æ„ï¼Œå¿…é¡»å¯ç”¨å¹‚ç­‰æ‰èƒ½ä½¿ç”¨äº‹åŠ¡ã€‚å½“å¯ç”¨å¹‚ç­‰æ—¶ï¼Œæˆ‘ä»¬å¼ºåˆ¶æ‰§è¡Œacks = allï¼Œretries\u0026gt; 1å’Œmax.inflight.requests.per.connection = 1ã€‚ æ²¡æœ‰è¿™äº›é…ç½®çš„è¿™äº›å€¼ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿è¯å¹‚ç­‰ã€‚ å¦‚æœè¿™äº›è®¾ç½®æœªè¢«åº”ç”¨ç¨‹åºæ˜¾å¼è¦†ç›–ï¼Œåˆ™åœ¨å¯ç”¨å¹‚ç­‰æ—¶ï¼Œç”Ÿäº§è€…å°†è®¾ç½®acks = allï¼Œretries = Integer.MAX_VALUEå’Œmax.inflight.requests.per.connection = 1ã€‚ transaction.timeout.ms åœ¨ä¸»åŠ¨ä¸­æ­¢æ­£åœ¨è¿›è¡Œçš„äº‹åŠ¡ä¹‹å‰ï¼Œäº‹åŠ¡åè°ƒå™¨å°†ç­‰å¾…ç”Ÿäº§è€…çš„äº‹åŠ¡çŠ¶æ€æ›´æ–°çš„æœ€é•¿æ—¶é—´ï¼ˆä»¥msä¸ºå•ä½ï¼‰ã€‚ transactional.id ç”¨äºäº‹åŠ¡ä¼ é€’çš„TransactionalIdã€‚ è¿™ä½¿å¾—å¯ä»¥è·¨è¶Šå¤šä¸ªç”Ÿäº§è€…ä¼šè¯çš„å¯é æ€§è¯­ä¹‰ï¼Œå› ä¸ºå®ƒå…è®¸å®¢æˆ·ç«¯ä¿è¯åœ¨å¼€å§‹ä»»ä½•æ–°äº‹åŠ¡ä¹‹å‰ä½¿ç”¨ç›¸åŒçš„TransactionalIdçš„äº‹åŠ¡å·²ç»å®Œæˆã€‚ å¦‚æœæ²¡æœ‰æä¾›TransactionalIdï¼Œåˆ™ç”Ÿäº§è€…è¢«é™åˆ¶ä¸ºå¹‚ç­‰ä¼ é€’ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœé…ç½®äº†TransactionalIdï¼Œåˆ™å¿…é¡»å¯ç”¨enable.idempotenceã€‚é»˜è®¤å€¼ä¸ºç©ºï¼Œè¿™æ„å‘³ç€æ— æ³•ä½¿ç”¨äº‹åŠ¡ã€‚ æ¶ˆè´¹è€…é…ç½® é…ç½® æè¿° isolation.level ä»¥ä¸‹æ˜¯å¯èƒ½çš„å€¼ï¼ˆé»˜è®¤ä¸ºread_uncommittedï¼‰ï¼šread_uncommittedï¼šåœ¨åç§»é¡ºåºä¸­æ¶ˆè´¹å·²æäº¤å’Œæœªæäº¤çš„æ¶ˆæ¯; read_committedï¼šä»…ä»¥åç§»é¡ºåºæ¶ˆè€—éäº‹åŠ¡æ€§æ¶ˆæ¯æˆ–å·²æäº¤äº‹åŠ¡æ¶ˆæ¯ã€‚ ä¸ºäº†ä¿æŒåç§»é¡ºåºï¼Œè¯¥è®¾ç½®æ„å‘³ç€æˆ‘ä»¬å¿…é¡»ç¼“å†²æ¶ˆè´¹è€…ä¸­çš„æ¶ˆæ¯ï¼Œç›´åˆ°æˆ‘ä»¬çœ‹åˆ°ç»™å®šäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ã€‚ 2 Idempotent Producer å¹‚ç­‰ç”Ÿäº§è€…ä¿éšœ ä¸ºäº†å®ç°å¹‚ç­‰ç”Ÿäº§è€…è¯­ä¹‰, å¼•å…¥äº†producer idçš„æ¦‚å¿µ, ä¸‹é¢ç§°PID. æ¯ä¸ªproduceråœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€PID. PIDçš„åˆ†é…å¯¹ç”¨æˆ·æ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„, ä¸”æ²¡æœ‰è¢«å®¢æˆ·ç«¯æš´éœ².\nPIDæ˜¯ä»0å¼€å§‹å•è°ƒé€’å¢çš„, è¿˜æœ‰ä¸€ä¸ªå°†è¦å°†è¦æ¥å—æ¶ˆæ¯çš„ä¸»é¢˜åˆ†åŒºçš„åºå·. åºå·ä¼šéšç€producerå‘brokerå‘é€æ¶ˆæ¯å¢é•¿. brokeråœ¨å†…å­˜ä¸­ç»´æŠ¤ç€ä»æ¯ä¸ªPIDä¸­å‘è¿‡æ¥çš„åºå·. å¦‚æœåºå·ä¸æ˜¯æ¯”ä¸Šæ¬¡æäº¤PID/TopicParitionç»„ä¸­çš„çš„åºå·å¤§ä¸€, brokerä¼šæ‹’ç»producerçš„è¯·æ±‚. å¸¦æœ‰è¾ƒå°åºå·çš„æ¶ˆæ¯ä¼šå¼•å‘é‡å¤é”™è¯¯, producerå¯ä»¥å¿½ç•¥è¯¥é”™è¯¯. å¸¦æœ‰è¾ƒå¤§çš„åºå·çš„æ¶ˆæ¯ä¼šå¯¼è‡´è¶…å‡ºåºå·çš„é”™è¯¯, æ„å‘³ç€å­˜åœ¨æ¶ˆæ¯ä¸¢å¤±, è¿™æ˜¯è‡´å‘½çš„é”™è¯¯.\nä¸ºäº†ä¿è¯æ¯æ¡æ¶ˆæ¯éƒ½è¢«æ°å¥½ä¸€æ¬¡åœ°æŒä¹…åŒ–åœ¨logä¸­, produceréœ€è¦åœ¨å¤±è´¥çš„æ—¶å€™é‡è¯•è¯·æ±‚. æ¯ä¸ªç”Ÿäº§è€…å®ä¾‹éƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„å”¯ä¸€çš„PID, å› æ­¤æˆ‘ä»¬åªèƒ½åœ¨å•ä¸€çš„ç”Ÿäº§è€…ä¼šè¯ä¸­ä¿è¯å¹‚ç­‰.\nè¿™äº›å¹‚ç­‰ç”Ÿæˆå™¨è¯­ä¹‰å¯¹äºæ— çŠ¶æ€åº”ç”¨ç¨‹åºï¼ˆå¦‚æŒ‡æ ‡è·Ÿè¸ªå’Œå®¡è®¡ï¼‰æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚\näº‹åŠ¡ä¿éšœ åœ¨æ ¸å¿ƒä¸Š, äº‹åŠ¡ä¿è¯ä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿä»¥åŸå­æ–¹å¼ç”Ÿæˆå¤šä¸ªä¸»é¢˜åˆ†åŒº, å¯¹è¿™äº›ä¸»é¢˜åˆ†åŒºçš„æ‰€æœ‰å†™å…¥å°†æˆåŠŸæˆ–å¤±è´¥ä½œä¸ºä¸€ä¸ªå•å…ƒã€‚\næ­¤å¤–, ç”±äºæ¶ˆè´¹è€…è¿›åº¦è¢«è®°å½•ä¸ºå¯¹åç§»ä¸»é¢˜çš„å†™å…¥, æ‰€ä»¥åˆ©ç”¨ä¸Šè¿°èƒ½åŠ›æ¥ä½¿å¾—åº”ç”¨èƒ½å¤Ÿå°†æ¶ˆè´¹å’Œäº§ç”Ÿçš„æ¶ˆæ¯æ‰¹é‡åŒ–æˆå•ä¸ªåŸå­å•å…ƒ. åªæœ‰æ•´ä¸ªâ€œæ¶ˆè´¹å˜æ¢äº§å“â€å…¨éƒ¨æ‰§è¡Œ, æ‰èƒ½å°†æ¶ˆæ¯é›†åˆè§†ä¸ºæ¶ˆè´¹ã€‚\nä¸ºäº†è·¨å¤šä¸ªç”Ÿäº§è€…ä¼šè¯å®ç°å¹‚ç­‰, éœ€è¦æä¾›ä¸€ä¸ªåœ¨åº”ç”¨å±‚é¢å¯ä»¥ç¨³å®šçš„è·¨å¤šä¸ªä¼šè¯çš„transactionalId. transactionalIdç”±ç”¨æˆ·æä¾›.\næœ‰transactionalIdå, Kafkaå¯ä»¥ä¿è¯:\nä¸€ä¸ªç»™å®šçš„transactionalIdåªæœ‰ä¸€ä¸ªæ´»è·ƒçš„producer. å¦‚æœæœ‰æ–°çš„ä½¿ç”¨åŒä¸€ä¸ªtransactionalIdçš„producerå®ä¾‹ä¸Šçº¿, æ—§çš„å®ä¾‹ä¼šè¢«éš”ç¦». è·¨åº”ç”¨ä¼šè¯çš„äº‹åŠ¡æ¢å¤, å½“ä¸€ä¸ªåº”ç”¨å®ä¾‹æ­»æ‰å, brokerä¼šç»“æŸ(å–æ¶ˆæˆ–è€…æäº¤)æœªå®Œæˆçš„äº‹åŠ¡ä»¥ä¿æŠ¤æ–°ä¸Šçº¿çš„å®ä¾‹, åœ¨æ¢å¤å·¥ä½œä¹‹å‰å°†æ–°å®ä¾‹ç½®äºå¹²å‡€çš„çŠ¶æ€. æ³¨æ„è¿™é‡Œæåˆ°çš„äº‹åŠ¡ä¿éšœæ˜¯ä»producerçš„è§’åº¦. åœ¨consumerç«¯, ä¿éšœå°±ä¼šå¼±ä¸€äº›. ç‰¹åˆ«æ˜¯, æˆ‘ä»¬ä¸èƒ½ä¿è¯æ‰¿è¯ºäº‹åŠ¡çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å°†ä¸€èµ·è¢«æ¶ˆè´¹ã€‚åŸå› å¦‚ä¸‹:\nå¯¹äºå‹ç¼©ä¸»é¢˜, äº‹åŠ¡çš„ä¸€äº›æ¶ˆæ¯å¯èƒ½è¢«è¾ƒæ–°ç‰ˆæœ¬è¦†ç›–ã€‚ äº‹åŠ¡å¯èƒ½è·¨è¶Šæ—¥å¿—æ®µ. å› æ­¤, å½“æ—§æ®µåˆ é™¤æ—¶, æˆ‘ä»¬å¯èƒ½ä¼šåœ¨äº‹åŠ¡çš„ç¬¬ä¸€éƒ¨åˆ†ä¸¢å¤±ä¸€äº›æ¶ˆæ¯ã€‚ æ¶ˆè´¹è€…å¯èƒ½ä¼šåœ¨äº‹åŠ¡ä¸­å¯»æ±‚ä»»æ„çš„offset, å› æ­¤ç¼ºå°‘ä¸€äº›åˆå§‹æ¶ˆæ¯ã€‚ æ¶ˆè´¹è€…å¯èƒ½ä¸ä¼šä»å‚ä¸äº‹åŠ¡çš„æ‰€æœ‰åˆ†åŒºä¸­æ¶ˆè´¹. å› æ­¤, ä»–ä»¬æ°¸è¿œæ— æ³•è¯»å–åŒ…å«è¯¥äº‹åŠ¡çš„æ‰€æœ‰æ¶ˆæ¯ã€‚ å…³é”®æ¦‚å¿µ å®ç°äº‹åŠ¡, å³ç¡®ä¿ä¸€ç»„æ¶ˆæ¯ä»¥åŸå­æ–¹å¼äº§ç”Ÿå’Œæ¶ˆè´¹, æˆ‘ä»¬ä»‹ç»å‡ ä¸ªæ–°æ¦‚å¿µï¼š\næˆ‘ä»¬å¼•è¿›ä¸€ä¸ªç§°ä¸ºäº‹åŠ¡åè°ƒå™¨(Transaction Coordinator)çš„æ–°å®ä½“ã€‚ä¸æ¶ˆè´¹è€…ç»„åè°ƒå™¨ç±»ä¼¼, æ¯ä¸ªç”Ÿäº§è€…éƒ½è¢«åˆ†é…ä¸€ä¸ªäº‹åŠ¡åè°ƒå™¨, æ‰€æœ‰åˆ†é…PIDå’Œç®¡ç†äº‹åŠ¡çš„é€»è¾‘éƒ½ç”±äº‹åŠ¡åè°ƒå™¨å®Œæˆã€‚ æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªåä¸ºäº‹åŠ¡æ—¥å¿—(Transaction Log)çš„æ–°çš„å†…éƒ¨kafkaä¸»é¢˜(__transaction_state)ã€‚ä¸Consumer Offsetsä¸»é¢˜(__consumer_offsets)ç±»ä¼¼, äº‹åŠ¡æ—¥å¿—æ˜¯æ¯ä¸ªäº‹åŠ¡çš„æŒä¹…å’Œå¤åˆ¶è®°å½•ã€‚äº‹åŠ¡æ—¥å¿—æ˜¯äº‹åŠ¡åè°ƒå™¨çš„çŠ¶æ€å­˜å‚¨, æœ€æ–°ç‰ˆæœ¬çš„æ—¥å¿—çš„å¿«ç…§å°è£…äº†æ¯ä¸ªæ´»åŠ¨äº‹åŠ¡çš„å½“å‰çŠ¶æ€ã€‚ æˆ‘ä»¬å¼•å…¥æ§åˆ¶æ¶ˆæ¯(Control Messages)çš„æ¦‚å¿µã€‚è¿™äº›æ˜¯å†™å…¥ç”¨æˆ·ä¸»é¢˜çš„ç‰¹æ®Šæ¶ˆæ¯, ç”±å®¢æˆ·ç«¯å¤„ç†, ä½†ä¸ä¼šæš´éœ²ç»™ç”¨æˆ·ã€‚ä¾‹å¦‚, å®ƒä»¬è¢«ç”¨äºè®©brokerå‘æ¶ˆè´¹è€…è¡¨æ˜å…ˆå‰æå–çš„æ¶ˆæ¯æ˜¯å¦å·²ç»åŸå­æ€§åœ°æäº¤ã€‚ä»¥å‰åœ¨è¿™é‡Œæå‡ºæ§åˆ¶æ¶ˆæ¯ã€‚ æˆ‘ä»¬å¼•å…¥äº†TransactionalIdçš„æ¦‚å¿µ, ä½¿ç”¨æˆ·èƒ½å¤Ÿä»¥æŒç»­çš„æ–¹å¼å”¯ä¸€åœ°è¯†åˆ«ç”Ÿäº§è€…ã€‚å…·æœ‰ç›¸åŒTransactionalIdçš„ç”Ÿäº§è€…çš„ä¸åŒå®ä¾‹å°†èƒ½å¤Ÿæ¢å¤ï¼ˆæˆ–ä¸­æ­¢ï¼‰ç”±ä¸Šä¸€ä¸ªå®ä¾‹å®ä¾‹åŒ–çš„ä»»ä½•äº‹åŠ¡ã€‚ æˆ‘ä»¬å¼•å…¥ç”Ÿäº§è€…ä»£(producer epoch)çš„æ¦‚å¿µ, è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿç¡®ä¿åªæœ‰ä¸€ä¸ªå…·æœ‰ç»™å®šçš„TransactionalIdçš„ç”Ÿäº§è€…çš„åˆæ³•æ´»åŠ¨å®ä¾‹, ä»è€Œä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨å‘ç”Ÿæ•…éšœçš„æƒ…å†µä¸‹ç»´æŠ¤äº‹åŠ¡ä¿è¯ã€‚ é™¤äº†ä¸Šè¿°æ–°æ¦‚å¿µä¹‹å¤–, æˆ‘ä»¬è¿˜å¼•å…¥äº†æ–°çš„è¯·æ±‚ç±»å‹, æ–°ç‰ˆæœ¬çš„ç°æœ‰è¯·æ±‚ä»¥åŠæ–°ç‰ˆæœ¬çš„æ ¸å¿ƒæ¶ˆæ¯æ ¼å¼, ä»¥æ”¯æŒäº‹åŠ¡ã€‚æ‰€æœ‰è¿™äº›çš„ç»†èŠ‚å°†æ¨è¿Ÿåˆ°å…¶ä»–æ–‡æ¡£ã€‚\næ•°æ®æµ åœ¨ä¸Šå›¾ä¸­, å°–é”çš„è¾¹æ¡†è¡¨ç¤ºä¸åŒçš„æœºå™¨. åº•éƒ¨çš„åœ†å½¢ç›’å­è¡¨ç¤ºKafka TopicPartitions, è€Œå¯¹è§’åœ†å½¢çš„æ¡†ä»£è¡¨åœ¨brokerå†…éƒ¨è¿è¡Œçš„é€»è¾‘å®ä½“ã€‚\næ¯ä¸ªç®­å¤´è¡¨ç¤ºRPCæˆ–å†™å…¥Kafkaä¸»é¢˜. è¿™äº›æ“ä½œæŒ‰ç…§æ¯ä¸ªç®­å¤´æ—è¾¹çš„æ•°å­—è¡¨ç¤ºçš„é¡ºåºè¿›è¡Œ. ä¸‹é¢çš„éƒ¨åˆ†ç¼–å·ä¸ºä¸ä¸Šå›¾ä¸­çš„æ“ä½œç›¸åŒ¹é…, å¹¶æè¿°ç›¸å…³æ“ä½œã€‚\n1. æŸ¥æ‰¾ä¸€ä¸ªäº‹åŠ¡åè°ƒå™¨ â€” FindCoordinatorRequest äº‹åŠ¡åè°ƒå™¨æ˜¯åˆ†é…PIDså’Œç®¡ç†äº‹åŠ¡çš„æ ¸å¿ƒç»„ä»¶, producerçš„ç¬¬ä¸€ä»¶äº‹æ˜¯å‘é€ä¸€ä¸ªFindCoordinatorRequestè¯·æ±‚(ä¹‹å‰è¢«ç§°ä¸ºGroupCoordinatorRequest, ä½†æ˜¯ç°åœ¨æ›´åä¸ºæ›´ä¸€èˆ¬çš„ç”¨æ³•)åˆ°brokerå»è·å–å…¶coordinatorçš„ä½ç½®. è¯‘è€…è¡¥å……æ¯”å¦‚ip, port.\n2. è·å–ä¸€ä¸ªProducer Id â€” InitPidRequest è·å–åˆ°coordinatorä½ç½®ä¹‹å, ä¸‹ä¸€æ­¥æ˜¯è·å–producerçš„PID. è¿™ä¸ªé€šè¿‡å‘é€InitPidRequestè¯·æ±‚åˆ°äº‹åŠ¡åè°ƒå™¨å®Œæˆ.\n2.1å½“æœ‰æŒ‡å®šTransactionlIdæ—¶ å¦‚æœæœ‰é…ç½®transactionl.id, TransactionalIdä¼šéšç€InitPidRequestè¯·æ±‚å‘å‡º, åŒæ—¶åœ¨2aä¸­å°†PIDå’ŒTransactionalIdçš„å¯¹åº”å…³ç³»ä¿å­˜åœ¨äº‹åŠ¡æ—¥å¿—ä¸­. è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†TransactionalIdè¿”å›ç›¸åŒçš„PIDç»™ç”Ÿäº§è€…çš„æœªæ¥å®ä¾‹, å› æ­¤å¯ä»¥æ¢å¤æˆ–ä¸­æ­¢ä»¥å‰ä¸å®Œæ•´çš„äº‹åŠ¡ã€‚\né™¤äº†è¿”å›PIDä¹‹å¤–, InitPidRequestè¿˜æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š\n1. æå‡PIDçš„ä»£, ä½¿ç”Ÿäº§è€…çš„ä»»ä½•ä¹‹å‰çš„åƒµå°¸å®ä¾‹è¢«éš”ç¦»èµ·æ¥, ä¸èƒ½å¤„ç†äº‹åŠ¡. 2. æ¢å¤(å‘å‰æ»šåŠ¨æˆ–å›æ»š)ç”±ç”Ÿäº§è€…çš„ä¸Šä¸€ä¸ªå®ä¾‹æ²¡æœ‰å®Œæˆçš„ä»»åŠ¡äº‹åŠ¡. InitPIDRequestçš„å¤„ç†æ˜¯åŒæ­¥å®Œæˆçš„. ä¸€æ—¦è¿”å›, producerå¯ä»¥å‘é€æ•°æ®å’Œå¼€å§‹æ–°çš„äº‹åŠ¡.\n2.2å½“æ²¡æœ‰æŒ‡å®šTransactionalId å¦‚æœæ²¡æœ‰é…ç½®TransactionalId, ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„PID. è¿™æ˜¯produceråªåœ¨å•ä¸€çš„sessionä¸­å®ç°äº†å¹‚ç­‰è¯­ä¹‰å’Œäº‹åŠ¡è¯­ä¹‰.\n3. å¯åŠ¨äº‹åŠ¡ â€” beginTransaction() API æ–°çš„KafkaProduceræœ‰ä¸€ä¸ªbeginTransaction()æ–¹æ³•ç”¨æ¥å‘å‡ºå¼€å§‹äº‹åŠ¡çš„ä¿¡å·. ç”Ÿäº§è€…è®°å½•æŒ‡ç¤ºäº¤æ˜“å·²ç»å¼€å§‹çš„æœ¬åœ°çŠ¶æ€, ä½†æ˜¯åœ¨å‘é€ç¬¬ä¸€æ¡è®°å½•ä¹‹å‰, åœ¨åè°ƒå™¨çœ‹æ¥äº‹åŠ¡è¿˜æ²¡æœ‰å¼€å§‹.\n4. æ¶ˆè´¹-è½¬æ¢-ç”Ÿäº§å¾ªç¯ åœ¨è¿™ä¸ªé˜¶æ®µ, producerå¼€å§‹æ‰§è¡Œç»„æˆäº‹åŠ¡æ¶ˆè´¹-è½¬æ¢-ç”Ÿäº§æ¶ˆæ¯çš„æµç¨‹. è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„é˜¶æ®µ, å¯èƒ½åŒ…å«å¤šä¸ªè¯·æ±‚\n4.1 AddPartitionsToTxnRequest ä½œä¸ºäº‹åŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œç”Ÿäº§è€…é¦–æ¬¡å°†æ–°çš„TopicPartitionä½œä¸ºäº‹åŠ¡çš„ä¸€éƒ¨åˆ†å‘é€ç»™äº‹åŠ¡åè°ƒå™¨ã€‚ åè°ƒå™¨åœ¨æ­¥éª¤4.1aä¸­è®°å½•äº†å°†æ­¤TopicPartitionæ·»åŠ åˆ°äº‹åŠ¡ä¸­ã€‚ æˆ‘ä»¬éœ€è¦è¿™äº›ä¿¡æ¯ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å°†æäº¤æˆ–ä¸­æ­¢æ ‡è®°å†™å…¥æ¯ä¸ªTopicPartitionï¼ˆæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…ç¬¬5.2èŠ‚ï¼‰ã€‚ å¦‚æœè¿™æ˜¯æ·»åŠ åˆ°äº‹åŠ¡çš„ç¬¬ä¸€ä¸ªåˆ†åŒºï¼Œåè°ƒå™¨ä¹Ÿå°†å¯åŠ¨äº‹åŠ¡è®¡æ—¶å™¨ã€‚\n4.2 ProduceRequest ç”Ÿäº§è€…é€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ªProduceRequestsï¼ˆä»ç”Ÿäº§è€…çš„å‘é€æ–¹æ³•è§¦å‘ï¼‰å‘ç”¨æˆ·çš„ä¸»é¢˜åˆ†åŒºå†™å…¥ä¸€å †æ¶ˆæ¯ã€‚ è¿™äº›è¯·æ±‚åŒ…æ‹¬å¦‚4.2aæ‰€ç¤ºçš„PIDï¼Œä»£å’Œåºå·ã€‚\n4.3 AddOffsetCommitsToTxnRequest ç”Ÿäº§è€…æœ‰ä¸€ä¸ªæ–°çš„KafkaProducer.sendOffsetsToTransaction APIæ–¹æ³•ï¼Œå®ƒå¯ä»¥æ‰¹é‡æ¶ˆè´¹å’Œç”Ÿæˆçš„æ¶ˆæ¯ã€‚ æ­¤æ–¹æ³•æ¥å—Map \u0026lt;TopicPartitionsï¼ŒOffsetAndMetadata\u0026gt;å’ŒgroupIdå‚æ•°ã€‚\nsendOffsetsToTransactionæ–¹æ³•å‘äº‹åŠ¡åè°ƒå™¨å‘é€ä¸€ä¸ªå¸¦æœ‰groupIdçš„AddOffsetCommitsToTxnRequestsï¼Œä»è€Œå¯ä»¥åœ¨å†…éƒ¨__consumer-offsetsä¸»é¢˜ä¸­æ¨å¯¼å‡ºè¯¥æ¶ˆè´¹è€…ç»„çš„TopicPartitionã€‚ äº‹åŠ¡åè°ƒå™¨å°†åœ¨æ­¥éª¤4.3aä¸­å°†è¯¥ä¸»é¢˜åˆ†åŒºæ·»åŠ åˆ°äº‹åŠ¡æ—¥å¿—ä¸­ã€‚\n4.4 TxnOffsetCommitRequest å¦å¤–ä½œä¸ºsendOffsetçš„ä¸€éƒ¨åˆ†ï¼Œç”Ÿäº§è€…å°†å‘æ¶ˆè´¹è€…åè°ƒå™¨å‘é€ä¸€ä¸ªTxnOffsetCommitRequestï¼Œä»¥åœ¨__consumer-offsetsä¸»é¢˜ä¸­ä¿ç•™åç§»é‡ï¼ˆæ­¥éª¤4.4aï¼‰ã€‚ æ¶ˆè´¹è€…åè°ƒå‘˜é€šè¿‡ä½¿ç”¨ä½œä¸ºè¯¥è¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€çš„PIDå’Œç”Ÿäº§è€…ä»£æ¥éªŒè¯ç”Ÿäº§è€…æ˜¯å¦å…è®¸å‘å‡ºè¯·æ±‚ï¼ˆè€Œä¸æ˜¯åƒµå°¸ï¼‰ã€‚\næ¶ˆè´¹çš„offsetsåœ¨äº‹åŠ¡æäº¤ä¹‹å‰ä¸å¯è§ï¼Œè¿™æ˜¯æˆ‘ä»¬ç°åœ¨å°†è®¨è®ºçš„è¿‡ç¨‹ã€‚\n5. æäº¤æˆ–è€…ç»ˆç»“äº‹åŠ¡ ä¸€æ—¦å†™å…¥æ•°æ®ï¼Œç”¨æˆ·å¿…é¡»è°ƒç”¨KafkaProducerçš„æ–°çš„commitTransactionæˆ–abortTransaction APIæ–¹æ³•ã€‚ è¿™äº›æ–¹æ³•å°†åˆ†åˆ«å¼€å§‹æäº¤æˆ–ä¸­æ­¢äº‹åŠ¡ã€‚\n5.1 EndTxnRquest å½“ç”Ÿäº§è€…å®Œæˆäº‹åŠ¡æ—¶ï¼Œå¿…é¡»è°ƒç”¨æ–°å¼•å…¥çš„KafkaProducer.endTransactionæˆ–KafkaProducer.abortTransaction APIæ–¹æ³•ã€‚ å‰è€…ä½¿å¾—æ­¥éª¤4ä¸­ç”Ÿäº§çš„æ•°æ®å¯ç”¨äºä¸‹æ¸¸æ¶ˆè´¹è€…ã€‚ åè€…æœ‰æ•ˆåœ°ä»æ—¥å¿—ä¸­æ“¦é™¤ç”Ÿæˆçš„æ•°æ®: ç”¨æˆ·æ°¸è¿œä¸å¯è®¿é—®ã€‚ ä¸‹æ¸¸æ¶ˆè´¹è€…å°†è¯»å–å¹¶ä¸¢å¼ƒå·²ä¸­æ­¢çš„æ¶ˆæ¯ã€‚\næ— è®ºè°ƒç”¨å“ªä¸ªç”Ÿäº§è€…æ–¹æ³•ï¼Œç”Ÿäº§è€…å‘äº‹åŠ¡åè°ƒå™¨å‘å‡ºä¸€ä¸ªEndTxnRequestè¯·æ±‚ï¼Œé™„åŠ æ•°æ®æŒ‡ç¤ºäº‹åŠ¡æ˜¯æäº¤è¿˜æ˜¯ä¸­æ­¢ã€‚ åœ¨æ”¶åˆ°æ­¤è¯·æ±‚åï¼Œåè°ƒå™¨ï¼š\nå°†PREPARE_COMMITæˆ–PREPARE_ABORTæ¶ˆæ¯å†™å…¥äº‹åŠ¡æ—¥å¿—ã€‚ (æ­¥éª¤5.1a) é€šè¿‡WriteTxnMarkerRequestå¼€å§‹å‘ç”¨æˆ·æ—¥å¿—å†™å…¥ç§°ä¸ºCOMMIT(æˆ–ABORT)æ ‡è®°çš„å‘½ä»¤æ¶ˆæ¯çš„è¿‡ç¨‹ã€‚ (è§ä¸‹æ–‡ç¬¬5.2èŠ‚)ã€‚ æœ€åå°†COMMITTEDï¼ˆæˆ–ABORTEDï¼‰æ¶ˆæ¯å†™å…¥äº‹åŠ¡æ—¥å¿—ã€‚ (è§ä¸‹æ–‡5.3)ã€‚ 5.2 WriteTxnMarkerRequest è¯¥è¯·æ±‚ç”±äº‹åŠ¡åè°ƒå™¨å‘é€ç»™ä½œä¸ºäº‹åŠ¡ä¸€éƒ¨åˆ†çš„æ¯ä¸ªä¸»é¢˜åˆ†é…çš„leader. åœ¨æ”¶åˆ°æ­¤è¯·æ±‚å, æ¯ä¸ªä»£ç†å°†å‘æ—¥å¿—å†™å…¥COMMIT(PID)æˆ–ABORT(PID)æ§åˆ¶æ¶ˆæ¯ã€‚ (æ­¥éª¤5.2a)\nè¯¥æ¶ˆæ¯å‘æ¶ˆè´¹è€…æŒ‡ç¤ºå…·æœ‰ç»™å®šPIDçš„æ¶ˆæ¯æ˜¯å¦å¿…é¡»ä¼ é€’ç»™ç”¨æˆ·æˆ–ä¸¢å¼ƒã€‚ å› æ­¤ï¼Œæ¶ˆè´¹è€…å°†ç¼“å†²å…·æœ‰PIDçš„æ¶ˆæ¯ï¼Œç›´åˆ°å®ƒè¯»å–ç›¸åº”çš„COMMITæˆ–ABORTæ¶ˆæ¯ï¼Œæ­¤æ—¶å®ƒå°†åˆ†åˆ«é€’é€æˆ–ä¸¢å¼ƒæ¶ˆæ¯ã€‚\nè¯·æ³¨æ„ï¼Œå¦‚æœ__consumer-offsetsä¸»é¢˜æ˜¯äº‹åŠ¡ä¸­çš„TopicPartitionä¹‹ä¸€ï¼Œåˆ™æäº¤ï¼ˆæˆ–ä¸­æ­¢ï¼‰æ ‡è®°ä¹Ÿå°†å†™å…¥æ—¥å¿—ï¼Œå¹¶ä¸”é€šçŸ¥æ¶ˆè´¹è€…åè°ƒå™¨ï¼Œä»¥ä¾¿åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å®ç°è¿™äº›åç§»é‡ åœ¨ä¸­æ­¢æƒ…å†µä¸‹æäº¤æˆ–å¿½ç•¥å®ƒä»¬ï¼ˆå·¦ä¾§çš„æ­¥éª¤5.2aï¼‰ã€‚\n5.3 Writing the final Commit or Abort Message åœ¨æ‰€æœ‰æäº¤æˆ–ä¸­æ­¢æ ‡è®°å†™å…¥æ•°æ®æ—¥å¿—ä¹‹åï¼Œäº‹åŠ¡åè°ƒå™¨å°†æœ€åçš„COMMITTEDæˆ–ABORTEDæ¶ˆæ¯å†™å…¥äº‹åŠ¡æ—¥å¿—ï¼ŒæŒ‡ç¤ºäº‹åŠ¡å®Œæˆï¼ˆå›¾ä¸­çš„æ­¥éª¤5.3ï¼‰ã€‚ æ­¤æ—¶ï¼Œå¯ä»¥åˆ é™¤ä¸äº‹åŠ¡æ—¥å¿—ä¸­çš„äº‹åŠ¡æœ‰å…³çš„å¤§å¤šæ•°æ¶ˆæ¯ã€‚\næˆ‘ä»¬åªéœ€è¦ä¿ç•™å®Œæˆçš„äº‹åŠ¡çš„PIDä»¥åŠæ—¶é—´æˆ³ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆå¯ä»¥åˆ é™¤ç”Ÿäº§è€…çš„TransactionalId-\u0026gt; PIDæ˜ å°„ã€‚ è¯·å‚é˜…ä¸‹é¢çš„è¿‡æœŸPIDéƒ¨åˆ†ã€‚\nç®€å•çš„å®ç°ä»£ç  è¿™é‡Œ\nå‚è€ƒèµ„æ–™ Exactly Once Delivery and Transactional Messaging ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/kafka-exactly-once-delivery-and-transactional-messaging/","tags":["Kafka"],"title":"æ°å¥½ä¸€æ¬¡å‘é€å’Œäº‹åŠ¡æ¶ˆæ¯(è¯‘)"},{"categories":["ç¬”è®°"],"contents":"æŒ‰ç…§é‡è¦æ€§åˆ†ç±», åŸºäºç‰ˆæœ¬0.11.0.0\né«˜ bootstrap.servers ä¸€ç»„hostå’Œportç”¨äºåˆå§‹åŒ–è¿æ¥. ä¸ç®¡è¿™é‡Œé…ç½®äº†å¤šå°‘å°server, éƒ½åªæ˜¯ç”¨ä½œå‘ç°æ•´ä¸ªé›†ç¾¤å…¨éƒ¨serverä¿¡æ¯. è¿™ä¸ªé…ç½®ä¸éœ€è¦åŒ…å«é›†ç¾¤æ‰€æœ‰çš„æœºå™¨ä¿¡æ¯. ä½†æ˜¯æœ€å¥½å¤šäºä¸€ä¸ª, ä»¥é˜²æœåŠ¡å™¨æŒ‚æ‰.\nkey.serializer ç”¨æ¥åºåˆ—åŒ–keyçš„Serializeræ¥å£çš„å®ç°ç±».\nvalue.serializer ç”¨æ¥åºåˆ—åŒ–valueçš„Serializeræ¥å£çš„å®ç°ç±»\nacks producerå¸Œæœ›leaderè¿”å›çš„ç”¨äºç¡®è®¤è¯·æ±‚å®Œæˆçš„ç¡®è®¤æ•°é‡. å¯é€‰å€¼ all, -1, 0 1. é»˜è®¤å€¼ä¸º1\nacks=0 ä¸éœ€è¦ç­‰å¾…æœåŠ¡å™¨çš„ç¡®è®¤. è¿™æ˜¯retriesè®¾ç½®æ— æ•ˆ. å“åº”é‡Œæ¥è‡ªæœåŠ¡ç«¯çš„offsetæ€»æ˜¯-1. produceråªç®¡å‘ä¸ç®¡å‘é€æˆåŠŸä¸å¦ã€‚å»¶è¿Ÿä½ï¼Œå®¹æ˜“ä¸¢å¤±æ•°æ®ã€‚ acks=1 è¡¨ç¤ºleaderå†™å…¥æˆåŠŸï¼ˆä½†æ˜¯å¹¶æ²¡æœ‰åˆ·æ–°åˆ°ç£ç›˜ï¼‰åå³å‘producerå“åº”ã€‚å»¶è¿Ÿä¸­ç­‰ï¼Œä¸€æ—¦leaderå‰¯æœ¬æŒ‚äº†ï¼Œå°±ä¼šä¸¢å¤±æ•°æ®ã€‚ acks=allç­‰å¾…æ•°æ®å®Œæˆå‰¯æœ¬çš„å¤åˆ¶, ç­‰åŒäº-1. å‡å¦‚éœ€è¦ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±, éœ€è¦ä½¿ç”¨è¯¥è®¾ç½®. åŒæ—¶éœ€è¦è®¾ç½®unclean.leader.election.enableä¸ºtrue, ä¿è¯å½“ISRåˆ—è¡¨ä¸ºç©ºæ—¶, é€‰æ‹©å…¶ä»–å­˜æ´»çš„å‰¯æœ¬ä½œä¸ºæ–°çš„leader. buffer.memory producerå¯ä»¥ä½¿ç”¨çš„æœ€å¤§å†…å­˜æ¥ç¼“å­˜ç­‰å¾…å‘é€åˆ°serverç«¯çš„æ¶ˆæ¯. å¦‚æœæ¶ˆæ¯é€Ÿåº¦å¤§äºproduceräº¤ä»˜åˆ°serverç«¯çš„é˜»å¡æ—¶é—´max.block.ms, å°†ä¼šæŠ›å‡ºå¼‚å¸¸. é»˜è®¤å€¼33554432 byte (32m). è¿™ä¸ªè®¾ç½®ä¸æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„è¾¹ç•Œ, å› ä¸ºproduceré™¤äº†ç”¨æ¥ç¼“å­˜æ¶ˆæ¯, è¿˜è¦ç”¨æ¥è¿›è¡Œå‹ç¼©.\ncompression.type producerå‹ç¼©æ•°æ®çš„ç±»å‹, é»˜è®¤ä¸ºnone, å°±æ˜¯ä¸å‹ç¼©. å¯é€‰none, gzip, snappy å’Œlz4. å‹ç¼©æ•´ä¸ªbatchçš„æ•°æ®, å› æ­¤batchçš„æ•ˆæœå¯¹å‹ç¼©ç‡ä¹Ÿæœ‰å½±å“. æ›´å¤šçš„æ‰¹å¤„ç†æ„å‘³ç€æ›´å¥½çš„å‹ç¼©\nretries è®¾ç½®å¤§äºé›¶çš„å€¼å°†å¯¼è‡´å®¢æˆ·ç«¯é‡æ–°å‘é€å…¶å‘é€å¤±è´¥å¹¶å‘ç”Ÿæ½œåœ¨çš„ç¬æ—¶é”™è¯¯çš„è®°å½•. ç›¸å½“äºclientåœ¨å‘é€å¤±è´¥çš„æ—¶å€™ä¼šé‡æ–°å‘è¡Œ. å¦‚æœè®¾ç½®äº†retriesè€Œæ²¡æœ‰å°†max.in.flight.request.per.connectionè®¾ç½®ä¸º1, åœ¨ä¸¤ä¸ªbatchå‘é€åˆ°åŒä¸€ä¸ªpartitionæ—¶æœ‰å¯èƒ½æ‰“ä¹±æ¶ˆæ¯çš„å‘é€é¡ºåº(ç¬¬ä¸€ä¸ªå‘é€å¤±è´¥, è€Œç¬¬äºŒä¸ªå‘é€æˆåŠŸ)\nä¸­ batch.size producerä¼šå°è¯•æ‰¹é‡å‘é€å±äºåŒä¸€ä¸ªpartitionçš„æ¶ˆæ¯ä»¥å‡å°‘è¯·æ±‚çš„æ•°é‡. è¿™æ ·å¯ä»¥æå‡å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æ€§èƒ½. é»˜è®¤å¤§å°æ˜¯16348 byte (16k).\nå‘é€åˆ°brokerçš„è¯·æ±‚å¯ä»¥åŒ…å«å¤šä¸ªbatch, æ¯ä¸ªbatchçš„æ•°æ®å±äºåŒä¸€ä¸ªpartition.\nå¤ªå°çš„batchä¼šé™ä½åå. å¤ªå¤§ä¼šæµªè´¹å†…å­˜.\nclient.id å‘é€è¯·æ±‚æ—¶ä¼ é€’ç»™æœåŠ¡ç«¯çš„idå­—ç¬¦. ç”¨æ¥è¿½æº¯è¯·æ±‚æº, é™¤äº†ä½¿ç”¨ip/port. æœåŠ¡ç«¯çš„è¯·æ±‚æ—¥å¿—ä¸­ä¼šåŒ…å«ä¸€ä¸ªåˆç†çš„åº”ç”¨å. é»˜è®¤ä¸ºç©º\nlinger.ms åœ¨æ­£å¸¸è´Ÿè½½çš„æƒ…å†µä¸‹, è¦æƒ³å‡å°‘è¯·æ±‚çš„æ•°é‡. åŠ ä¸Šä¸€ä¸ªè®¤ä¸ºçš„å»¶è¿Ÿ: ä¸æ˜¯ç«‹å³å‘é€æ¶ˆæ¯, è€Œæ˜¯å»¶è¿Ÿç­‰å¾…æ›´å¤šçš„æ¶ˆæ¯ä¸€èµ·æ‰¹é‡å‘é€. ç±»ä¼¼TCPä¸­çš„Nagleç®—æ³•. å½“è·å¾—äº†batch.sizeçš„åŒä¸€partitionçš„æ¶ˆæ¯ä¼šç«‹å³å‘é€, ä¸ç®¡linger.msçš„è®¾ç½®. å‡å¦‚è¦å‘é€çš„æ¶ˆæ¯æ¯”è¾ƒå°‘, ä¼šç­‰å¾…æŒ‡å®šçš„æ—¶é—´ä»¥è·å–æ›´å¤šçš„æ¶ˆæ¯.\né»˜è®¤è®¾ç½®ä¸º0 ms(æ²¡æœ‰å»¶è¿Ÿ).\nmax.block.ms æ§åˆ¶KafkaProducer.send()å’ŒKafkaProducer.partitionsFor()çš„é˜»å¡æ—¶é—´. è¿™äº›æ–¹æ³•ä¼šå› ä¸ºbufferæ»¡äº†æˆ–è€…metadataä¸å¯ç”¨è€Œé˜»å¡. ç”¨æˆ·è®¾ç½®åœ¨serializersæˆ–è€…partitionerä¸­çš„é˜»å¡ä¸ä¼šè®¡ç®—åœ¨å†….\nmax.request.size è¯·æ±‚çš„æœ€å¤§å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ æ­¤è®¾ç½®å°†é™åˆ¶ç”Ÿäº§è€…åœ¨å•ä¸ªè¯·æ±‚ä¸­å‘é€çš„è®°å½•æ‰¹æ¬¡æ•°ï¼Œä»¥é¿å…å‘é€å·¨å¤§çš„è¯·æ±‚ã€‚ è¿™ä¹Ÿæ˜¯æœ€å¤§è®°å½•æ‰¹é‡å¤§å°çš„ä¸Šé™ã€‚ è¯·æ³¨æ„ï¼ŒæœåŠ¡å™¨æ‹¥æœ‰è‡ªå·±çš„è®°å½•æ‰¹é‡å¤§å°ï¼Œå¯èƒ½ä¸æ­¤ä¸åŒã€‚\npartitioner.class Partitioneræ¥å£çš„å®ç°ç±», é»˜è®¤æ˜¯org.apache.kafka.clients.producer.internals.DefaultPartitioner. éœ€è¦å¤„ç†æ•°æ®å€¾æ–œç­‰åŸå› è°ƒæ•´åˆ†åŒºé€»è¾‘çš„æ—¶å€™ä½¿ç”¨.\nrequest.timeout.ms é…ç½®æ§åˆ¶å®¢æˆ·ç«¯ç­‰å¾…è¯·æ±‚å“åº”çš„æœ€é•¿æ—¶é—´ã€‚ å¦‚æœåœ¨è¶…æ—¶ä¹‹å‰æœªæ”¶åˆ°å“åº”ï¼Œå®¢æˆ·ç«¯å°†åœ¨å¿…è¦æ—¶é‡æ–°å‘é€è¯·æ±‚ï¼Œå¦‚æœé‡è¯•è€—å°½ï¼Œåˆ™è¯¥è¯·æ±‚å°†å¤±è´¥ã€‚ è¿™åº”è¯¥å¤§äºreplica.lag.time.max.ms(brokeré…ç½®)ï¼Œä»¥å‡å°‘ç”±äºä¸å¿…è¦çš„ç”Ÿäº§è€…é‡è¯•å¼•èµ·çš„æ¶ˆæ¯é‡å¤çš„å¯èƒ½æ€§ã€‚\nä½ enable.idempotence è®¾ç½®ä¸º\u0026rsquo;true\u0026rsquo;, å°†å¼€å¯exactly-onceæ¨¡å¼. è®¾ç½®ä¸º\u0026rsquo;false\u0026rsquo;(é»˜è®¤å€¼), producerä¼šå› ä¸ºborkerå¤±è´¥ç­‰åŸå› é‡è¯•å‘é€, å¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤.\nè®¾ç½®ä¸º\u0026rsquo;true\u0026rsquo;æ—¶éœ€è¦ç»“åˆmax.in.flight.requests.per.connectionè®¾ä¸º'1\u0026rsquo;å’Œretiresä¸èƒ½ä¸º'0\u0026rsquo;, åŒæ—¶ackséœ€è¦è®¾ç½®ä¸º\u0026rsquo;all\u0026rsquo;æˆ–è€…\u0026rsquo;\u0026rsquo;-1'.\ninterceptor.classes ä¸€ç»„ProducerInterceptoræ¥å£çš„å®ç°ç±», é»˜è®¤ä¸ºnull. å¯ä»¥é€šè¿‡è¯¥æ¥å£çš„å®ç°ç±»å»æ‹¦æˆª(å¯èƒ½éœ€è¦ä¿®æ”¹)producerè¦å‘é€çš„æ¶ˆæ¯åœ¨å‘é€åˆ°æœåŠ¡ç«¯ä¹‹å‰.\nmax.in.flight.requests.per.connection æ²¡æœ‰è¢«ç¡®è®¤unacknowledgeçš„batchæ•°, å¦‚æœè®¾ç½®å¤§äº1åœ¨retriesè®¾ç½®äº†çš„æƒ…å†µä¸‹ä¼šå‡ºç°æ¶ˆæ¯å‘é€é¡ºåºé”™è¯¯.\nretry.backoff.ms å¤±è´¥è¯·æ±‚é‡è¯•çš„é—´éš”æ—¶é—´. é»˜è®¤æ˜¯100æ¯«ç§’\ntransaction.timeout.ms äº‹åŠ¡åè°ƒå™¨ç­‰å¾…produceræ›´æ–°äº‹åŠ¡çŠ¶æ€çš„æœ€å¤§æ¯«ç§’æ•°, è¶…è¿‡çš„è¯äº‹åŠ¡åè°ƒå™¨ä¼šç»ˆæ­¢è¿›è¡Œä¸­çš„äº‹åŠ¡. å¦‚æœè®¾ç½®çš„æ—¶é—´å¤§äºbrokerçš„max.transaction.timeout.msä¼šæ”¶åˆ°InvalidTransactionTimeouté”™è¯¯.\ntransactional.id ç”¨äºäº‹åŠ¡ä¼ é€’çš„TransactionalIdã€‚ è¿™ä½¿å¾—å¯ä»¥è·¨è¶Šå¤šä¸ªç”Ÿäº§è€…ä¼šè¯çš„å¯é æ€§è¯­ä¹‰ï¼Œå› ä¸ºå®ƒå…è®¸å®¢æˆ·ç«¯ä¿è¯åœ¨å¼€å§‹ä»»ä½•æ–°äº‹åŠ¡ä¹‹å‰ä½¿ç”¨ç›¸åŒçš„TransactionalIdçš„äº‹åŠ¡å·²ç»å®Œæˆã€‚ å¦‚æœæ²¡æœ‰æä¾›TransactionalIdï¼Œåˆ™ç”Ÿäº§è€…è¢«é™åˆ¶ä¸ºå¹‚ç­‰ä¼ é€’ã€‚ è¯·æ³¨æ„ï¼Œå¦‚æœé…ç½®äº†TransactionalIdï¼Œåˆ™å¿…é¡»å¯ç”¨enable.idempotenceã€‚ é»˜è®¤å€¼ä¸ºç©ºï¼Œè¿™æ„å‘³ç€æ— æ³•ä½¿ç”¨äº‹åŠ¡ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/kafka-producer-config/","tags":["Kafka","Java"],"title":"Kafka Produceré…ç½®è§£è¯»"},{"categories":["ç¬”è®°"],"contents":"JSON Pathæ˜¯åœ¨ä½¿ç”¨Kubernetes APIçš„è¿‡ç¨‹ä¸­é¦–æ¬¡ä½¿ç”¨çš„. ä½¿ç”¨APIåšæ‰©ç¼©å®¹çš„æ—¶å€™, å‘é€æ•´ä¸ªDeploymentçš„å…¨æ–‡ä¸æ˜¯ä¸ªæ˜æ™ºçš„åšæ³•, è™½ç„¶å¯è¡Œ. å› æ­¤ä¾¿ä½¿ç”¨äº†JSON Patch.\nJsonObject item = new JsonObject(); item.add(\u0026#34;op\u0026#34;, new JsonPrimitive(\u0026#34;replace\u0026#34;)); item.add(\u0026#34;path\u0026#34;, new JsonPrimitive(\u0026#34;/spec/replicas\u0026#34;)); item.add(\u0026#34;value\u0026#34;, new JsonPrimitive(instances)); JsonArray body = new JsonArray(); body.add(item); appsV1beta1Api.patchNamespacedScaleScale(id, namespace, body, null); fabric8sæä¾›çš„kubernetes-clientä¸­ä½¿ç”¨çš„zjsonpatchåˆ™å°è£…äº†JSON Patchæ“ä½œ. ä¾‹å¦‚åœ¨åšæ‰©ç¼©å®¹çš„æ—¶å€™æˆ–è€…å½“å‰çš„deployment, ä¿®æ”¹replicasçš„å€¼. ç„¶åæ¯”è¾ƒå¯¹è±¡çš„ä¸åŒ(JsonDiff.asJson(sourceJsonNode, targetJsonNode)).\nä¸‹é¢çš„å†…å®¹éƒ¨åˆ†ç¿»è¯‘è‡ªJSON PATH, æœ‰å…´è¶£çš„å¯ä»¥è·³è½¬çœ‹åŸæ–‡.\nä»€ä¹ˆæ˜¯JSON Patch JSON Pathæ˜¯ä¸€ç›´æè¿°JSONæ–‡æ¡£å˜åŒ–çš„æ ¼å¼. ä½¿ç”¨å®ƒå¯ä»¥é¿å…åœ¨åªéœ€è¦ä¿®æ”¹æŸä¸€éƒ¨åˆ†çš„æ—¶å€™å‘é€æ•´ä¸ªæ–‡æ¡£å†…å®¹. å½“ä¸HTTP PATCHæ–¹æ³•æ··åˆä½¿ç”¨çš„æ—¶å€™, å®ƒå…è®¸åœ¨æ ‡å‡†è§„èŒƒçš„åŸºç¡€ä¸Šä½¿ç”¨HTTP APIsè¿›è¡Œéƒ¨åˆ†æ›´æ–°.\nè¡¥ä¸(Patch)å†…å®¹çš„æ ¼å¼ä¹Ÿæ˜¯JSON.\nJSON Patchç”±IETFåœ¨RFC 6902ä¸­è§„èŒƒ.\nç®€å•çš„ä¾‹å­ åŸå§‹æ–‡æ¡£ { \u0026#34;baz\u0026#34;: \u0026#34;qux\u0026#34;, \u0026#34;foo\u0026#34;: \u0026#34;bar\u0026#34; } è¡¥ä¸ [ { \u0026#34;op\u0026#34;: \u0026#34;replace\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/baz\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;boo\u0026#34; }, { \u0026#34;op\u0026#34;: \u0026#34;add\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/hello\u0026#34;, \u0026#34;value\u0026#34;: [\u0026#34;world\u0026#34;] }, { \u0026#34;op\u0026#34;: \u0026#34;remove\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/foo\u0026#34;} ] ç»“æœ { \u0026#34;baz\u0026#34;: \u0026#34;boo\u0026#34;, \u0026#34;hello\u0026#34;: [\u0026#34;world\u0026#34;] } å¦‚ä½•å®ç° ä¸€ä¸ªJSON Pathæ–‡æ¡£æ˜¯ä¸€ä¸ªåŒ…å«äº†ä¸€ç»„patchæ“ä½œçš„JSONæ–‡ä»¶. æ”¯æŒçš„patchæ“ä½œåŒ…æ‹¬\u0026quot;add\u0026quot;, \u0026ldquo;remove\u0026rdquo;, \u0026ldquo;replace\u0026rdquo;, \u0026ldquo;move\u0026rdquo;, \u0026ldquo;copy\u0026quot;å’Œ\u0026quot;test\u0026rdquo;. è¿™äº›patchæ“ä½œæ˜¯æŒ‰ç…§é¡ºåºåº”ç”¨çš„: å¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªæ“ä½œå¤±è´¥, æ•´ä¸ªpatchéƒ½ä¼šè¢«ç»ˆæ­¢.\nJSON Pointer(æŒ‡é’ˆ) JSONæŒ‡é’ˆIETF RFC 6901å®šä¹‰äº†ä¸€ä¸ªå¦‚ä½•åœ¨JSONæ–‡æ¡£ä¸­å®šä½æŒ‡å®šå€¼çš„å­—ç¬¦æ ¼å¼. ç”¨æ¥åœ¨æ‰€æœ‰çš„JSON Patchæ“ä½œä¸­æŒ‡å®šè¦ä¿®æ”¹çš„æ–‡æ¡£éƒ¨åˆ†.\nJSONæŒ‡é’ˆæ˜¯ä½¿ç”¨/åˆ†éš”çš„tokenå­—ç¬¦ä¸², è¿™äº›tokenæŒ‡å®šäº†å¯¹è±¡çš„keyæˆ–è€…æ˜¯æ•°ç»„çš„ç´¢å¼•. ä¾‹å¦‚, ç»™å®šJSON\n{ \u0026#34;biscuits\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;Digestive\u0026#34; }, { \u0026#34;name\u0026#34;: \u0026#34;Choco Leibniz\u0026#34; } ] } /biscuitså°†æŒ‡å‘æ•°ç»„biscuits, åŒæ—¶/biscuits/1/nameæŒ‡å‘Choco Leibniz.\nè¦æŒ‡å‘JSONæ–‡æ¡£çš„æ ¹è¦ä½¿ç”¨ä¸€ä¸ªç©ºçš„å­—ç¬¦ä¸²''. æŒ‡é’ˆ/å¹¶ä¸æ˜¯æŒ‡å‘æ ¹, è€Œæ˜¯æŒ‡å‘æ ¹ä¸Škeyä¸º\u0026quot;\u0026quot;çš„ä½ç½®(åœ¨JSONä¸­æ˜¯éæ³•çš„).\næ“ä½œ Add { \u0026#34;op\u0026#34;: \u0026#34;add\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/biscuits/1\u0026#34;, \u0026#34;value\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;Ginger Nut\u0026#34; } } åœ¨å¯¹è±¡ä¸Šå¢åŠ ä¸€ä¸ªå€¼, æˆ–è€…æ•°ç»„ä¸­æ’å…¥æ•°æ®. å¦‚æœæ˜¯æ•°ç»„, å€¼å°†è¢«æ’å…¥åˆ°ç»™å®šä½ç½®çš„å‰é¢. -ç”¨æ¥è¡¨ç¤ºæ’å…¥åˆ°æ•°ç»„çš„å°¾éƒ¨.\nRemove { \u0026#34;op\u0026#34;: \u0026#34;remove\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/biscuits\u0026#34; } åˆ é™¤å¯¹è±¡æˆ–è€…æ•°ç»„ä¸­çš„å€¼.\nReplace { \u0026#34;op\u0026#34;: \u0026#34;replace\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/biscuits/0/name\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;Chocolate Digestive\u0026#34; } æ›¿æ¢ä¸€ä¸ªå€¼. ç­‰åŒäºå…ˆåˆ é™¤å†å¢åŠ .\nCopy { \u0026#34;op\u0026#34;: \u0026#34;copy\u0026#34;, \u0026#34;from\u0026#34;: \u0026#34;/biscuits/0\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/best_biscuit\u0026#34; } ä»ä¸€ä¸ªä½ç½®(from)å¤åˆ¶æ•°æ®åˆ°æŒ‡å®šçš„ä½ç½®(path)ä¸Š. fromå’Œtoéƒ½æ˜¯JSONæŒ‡é’ˆ.\nMove { \u0026#34;op\u0026#34;: \u0026#34;move\u0026#34;, \u0026#34;from\u0026#34;: \u0026#34;/biscuits\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/cookies\u0026#34; } ä»ä¸€ä¸ªä½ç½®(from)ç§»åŠ¨æ•°æ®åˆ°æŒ‡å®šçš„ä½ç½®(path)ä¸Š. fromå’Œtoéƒ½æ˜¯JSONæŒ‡é’ˆ.\nTest { \u0026#34;op\u0026#34;: \u0026#34;test\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/best_biscuit/name\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;Choco Leibniz\u0026#34; } æ£€æŸ¥æŸä¸ªä½ç½®çš„å€¼æ˜¯å¦æ˜¯æŒ‡å®šçš„å€¼.å¦‚æœå¤±è´¥, æ•´ä¸ªPatchæ“ä½œå°±ä¼šç»ˆæ­¢.\nåº“ JavaScript jsonpatch.js jsonpatch-js jiff Fast-JSON-Patch JSON8 Patch JSON Patch Utils Python python-json-patch PHP json-patch-php php-jsonpatch/php-jsonpatch xp-forge/json-patch JSONPatch Ruby json_tools json_patch hana Perl perl-json-patch C cJSON (JSON library in C, includes JSON Patch support in cJSON_Utils) Java zjsonpatch json-patch Scala diffson C++ JSON C#### Ramone (a framework for consuming REST services, includes a JSON Patch implementation) JsonPatch (Adds JSON Patch support to ASP.NET Web API) Starcounter (In-memory Application Engine, uses JSON Patch with OT for client-server sync) Nancy.JsonPatch (Adds JSON Patch support to NancyFX) Go json-patch jsonpatch Haskell Haskell-JSON-Patch Erlang json-patch.erl Elm norpan/elm-json-patch æµ‹è¯•å¥—ä»¶ githubä¸Šç»´æŠ¤çš„ä¸€ç»„ä¸€è‡´æ€§æµ‹è¯• github.com/json-patch/json-patch-tests\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/json-patch/","tags":["Java"],"title":"JSON Patch"},{"categories":["ç¬”è®°"],"contents":"ä½¿ç”¨openshiftæ­å»ºçš„k8sçš„apiåˆ›å»ºDeploymentï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™æŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š\nInvalid value: \u0026ldquo;hostPath\u0026rdquo;: hostPath volumes are not allowed to be used]\nè§£å†³æ–¹æ¡ˆï¼š\nä¸€ä¸ªæ–¹æ¡ˆæ˜¯å°†useråŠ å…¥privileged sccä¸­ï¼Œå¦ä¸€ä¸ªæ–¹æ¡ˆå°±æ˜¯ï¼š\noc edit scc restricted #æ·»åŠ ä¸‹é¢è¿™è¡Œ allowHostDirVolumePlugin: true ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/how-to-use-hostpath-in-openshift/","tags":["Kubernetes","Openshift"],"title":"å¦‚ä½•åœ¨Openshiftä¸­ä½¿ç”¨hostPath"},{"categories":["ç¬”è®°","äº‘åŸç”Ÿ"],"contents":"Persistent Volume è¯‘è‡ªPersistent Volumes\nä»‹ç» ç®¡ç†å­˜å‚¨æ˜¯ç®¡ç†è®¡ç®—çš„ç‹¬ç‰¹é—®é¢˜ã€‚ PersistentVolumeå­ç³»ç»Ÿä¸ºç”¨æˆ·å’Œç®¡ç†å‘˜æä¾›äº†ä¸€ä¸ªAPIï¼Œå…¶ä¸­æä¾›äº†å¦‚ä½•ä»å¦‚ä½•ä½¿ç”¨å­˜å‚¨æä¾›å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä»‹ç»ä¸¤ç§æ–°çš„APIèµ„æºï¼šPersistentVolumeå’ŒPersistentVolumeClaimã€‚\nPersistentVolumeï¼ˆPVï¼‰æ˜¯ç”±ç®¡ç†å‘˜é…ç½®çš„é›†ç¾¤ä¸­çš„ä¸€æ®µå­˜å‚¨ã€‚å®ƒæ˜¯é›†ç¾¤ä¸­çš„ä¸€ç§èµ„æºå°±åƒä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªé›†ç¾¤çš„èµ„æºã€‚ PVæ˜¯ç±»ä¼¼Volumesçš„å·æ’ä»¶ï¼Œä½†æ˜¯å…·æœ‰ç‹¬ç«‹äºä½¿ç”¨PVçš„ä»»ä½•å•ä¸ªpodçš„ç”Ÿå‘½å‘¨æœŸã€‚è¯¥APIå¯¹è±¡æ•è·å­˜å‚¨çš„å®ç°ç»†èŠ‚ï¼Œå³NFSï¼ŒiSCSIæˆ–äº‘æä¾›å•†ç‰¹å®šçš„å­˜å‚¨ç³»ç»Ÿã€‚\nPersistentVolumeClaimï¼ˆPVCï¼‰æ˜¯ç”¨æˆ·å­˜å‚¨çš„è¯·æ±‚ã€‚å®ƒç±»ä¼¼äºpodã€‚ Podæ¶ˆè€—èŠ‚ç‚¹èµ„æºï¼ŒPVCæ¶ˆè€—PVèµ„æºã€‚Podså¯ä»¥è¯·æ±‚ç‰¹å®šçº§åˆ«çš„èµ„æºï¼ˆCPUå’Œå†…å­˜ï¼‰ã€‚å£°æ˜å¯ä»¥è¯·æ±‚ç‰¹å®šçš„å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼ˆä¾‹å¦‚ï¼Œä¸€æ¬¡è¯»å†™æˆ–è€…å¤šæ¬¡åªè¯»ï¼‰ã€‚\nè™½ç„¶PersistentVolumeClaimså…è®¸ç”¨æˆ·ä½¿ç”¨æŠ½è±¡å­˜å‚¨èµ„æºï¼Œä½†æ˜¯å¸¸è§çš„æ˜¯ï¼Œç”¨æˆ·éœ€è¦å…·æœ‰ä¸åŒå±æ€§ï¼ˆå¦‚æ€§èƒ½ï¼‰çš„PersistentVolumesï¼Œç”¨äºä¸åŒçš„é—®é¢˜ã€‚ é›†ç¾¤ç®¡ç†å‘˜éœ€è¦èƒ½å¤Ÿæä¾›å¤šç§å½¼æ­¤ä¸åŒçš„PersistentVolumesï¼Œè€Œä¸ä»…ä»…æ˜¯å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼Œè€Œä¸ä¼šä½¿ç”¨æˆ·äº†è§£è¿™äº›å·çš„å®ç°ç»†èŠ‚ã€‚ å¯¹äºè¿™äº›éœ€æ±‚ï¼Œæœ‰ä¸€ä¸ªStorageClassèµ„æºã€‚\nStorageClassä¸ºç®¡ç†å‘˜æä¾›äº†ä¸€ç§æè¿°ä»–ä»¬æä¾›çš„å­˜å‚¨çš„â€œç±»â€çš„æ–¹æ³•ã€‚ ä¸åŒçš„ç±»å¯èƒ½æ˜ å°„åˆ°æœåŠ¡è´¨é‡çº§åˆ«ï¼Œæˆ–å¤‡ä»½ç­–ç•¥ï¼Œæˆ–è€…ç”±ç¾¤é›†ç®¡ç†å‘˜ç¡®å®šçš„ä»»æ„ç­–ç•¥ã€‚ Kubernetesæœ¬èº«å¯¹äºä»€ä¹ˆç±»åˆ«ä»£è¡¨æ˜¯ä¸è¨€è€Œå–»çš„ã€‚ è¿™ä¸ªæ¦‚å¿µæœ‰æ—¶åœ¨å…¶ä»–å­˜å‚¨ç³»ç»Ÿä¸­ç§°ä¸ºâ€œé…ç½®æ–‡ä»¶â€ã€‚\nè¯·å‚é˜…è¯¦ç»†æ¼”ç»ƒä¸å·¥ä½œç¤ºä¾‹ã€‚\nå­˜å‚¨å’Œå£°æ˜çš„ç”Ÿå‘½å‘¨æœŸ PVsæ˜¯é›†ç¾¤ä¸­çš„èµ„æºï¼›PVCsæ˜¯å¯¹è¿™ç§èµ„æºçš„å£°æ˜ï¼ŒåŒæ—¶ä¹Ÿæ‰®æ¼”è€…å¯¹èµ„æºå£°æ˜çš„æ£€æŸ¥ã€‚PVså’ŒPVCsä¹‹å‰çš„äº¤äº’éµå¾ªç”Ÿå‘½å‘¨æœŸï¼šä¾›åº”ã€ç»‘å®šã€ä½¿ç”¨ä¸­ã€é‡æ–°ç”³è¯·ã€‚\né›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºå¤šä¸ªPVã€‚å®ƒä»¬æºå¸¦å¯ä¾›é›†ç¾¤ç”¨æˆ·ä½¿ç”¨çš„çœŸå®å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚å®ƒä»¬å­˜åœ¨äºKubernetes APIä¸­ï¼Œå¯ç”¨äºæ¶ˆè´¹ã€‚\nä¾›åº”(Provisioning) PVsä¼šä»¥ä¸¤ç§æ–¹å¼ä¾›åº”ï¼šé™æ€å’ŒåŠ¨æ€ã€‚\né™æ€ é›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºå¤šä¸ªPVã€‚ å®ƒä»¬æºå¸¦å¯ä¾›é›†ç¾¤ç”¨æˆ·ä½¿ç”¨çš„çœŸå®å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚ å®ƒä»¬å­˜åœ¨äºKubernetes APIä¸­ï¼Œå¯è¢«ä½¿ç”¨ã€‚\nåŠ¨æ€ å½“ç®¡ç†å‘˜åˆ›å»ºçš„é™æ€PVéƒ½ä¸åŒ¹é…ç”¨æˆ·çš„PersistentVolumeClaimæ—¶ï¼Œé›†ç¾¤å¯èƒ½ä¼šå°è¯•ä¸ºPVCæŒ‡å®šåŠ¨æ€é…ç½®å·ã€‚ æ­¤é…ç½®åŸºäºStorageClassesï¼šPVCå¿…é¡»æŒ‡å®šä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ç®¡ç†å‘˜å¿…é¡»å·²åˆ›å»ºå¹¶é…ç½®è¯¥ç±»æ‰èƒ½è¿›è¡ŒåŠ¨æ€é…ç½®ã€‚ è¦æ±‚è¯¥ç±»çš„å£°æ˜æœ‰æ•ˆåœ°ä¸ºè‡ªå·±ç¦ç”¨åŠ¨æ€é…ç½®ã€‚\nç»‘å®š(Binding) å½“ç”¨æˆ·åˆ›å»ºã€æˆ–å·²ç»åˆ›å»ºäº†ä¸€ä¸ªPersistenVolumenClaimå¹¶æŒ‡å®šå¤§å°å’Œè®¿é—®ç±»å‹ã€‚Masterä¸­çš„æ§åˆ¶å¾ªç¯ä¼šæ£€æµ‹æ–°çš„PVCï¼Œæ‰¾åˆ°ä¸€ä¸ªåŒ¹é…çš„PVï¼ˆå¦‚æœå¯èƒ½çš„è¯ï¼‰ï¼Œå¹¶å°†å®ƒä»¬ç»‘å®šåœ¨ä¸€èµ·ã€‚å¦‚æœä¸€ä¸ªPVè¢«åŠ¨æ€åœ°ä¾›åº”æŸä¸ªPVCï¼Œå¾ªç¯å°†æ€»æ˜¯æŠŠè¿™ä¸ªPVå’Œè¯¥PVCç»‘å®šã€‚å¦åˆ™ï¼Œç”¨æˆ·æ€»æ˜¯è‡³å°‘å¾—åˆ°ä»–ä»¬è¦æ±‚çš„å†…å®¹ï¼Œä½†æ˜¯å·å¯èƒ½è¶…å‡ºäº†è¦æ±‚ã€‚ä¸€æ—¦ç»‘å®šï¼ŒPersistentVolumeClaimç»‘å®šæ˜¯æ’ä»–çš„ï¼Œä¸ç®¡ç”¨äºç»‘å®šå®ƒä»¬çš„æ¨¡å¼ã€‚\nå¦‚æœåŒ¹é…çš„å·ä¸å­˜åœ¨ï¼Œè¯·æ±‚å°†æ— é™æœŸåœ°ä¿æŒã€‚ éšç€åŒ¹é…å·å˜å¾—å¯ç”¨ï¼Œè¯·æ±‚å°†è¢«ç»‘å®šã€‚ ä¾‹å¦‚ï¼Œæä¾›è®¸å¤š50Gi PVçš„é›†ç¾¤å°†ä¸åŒ¹é…è¦æ±‚100Giçš„PVCã€‚ å½“é›†ç¾¤ä¸­æ·»åŠ 100Gi PVæ—¶ï¼Œå¯ä»¥ç»‘å®šPVCã€‚\nä½¿ç”¨(ä½¿ç”¨) PODsæŠŠPVCå½“åšvolumeä½¿ç”¨ã€‚é›†ç¾¤æ£€æŸ¥å£°æ˜ä»¥æ‰¾åˆ°ç»‘å®šçš„å·å¹¶ä¸ºPODæŒ‚è½½è¯¥å·ã€‚ å¯¹äºæ”¯æŒå¤šç§è®¿é—®æ¨¡å¼çš„å·ï¼Œç”¨æˆ·åœ¨å°†å…¶å£°æ˜ç”¨ä½œpodä¸­çš„å·æ—¶æŒ‡å®šæ‰€éœ€çš„æ¨¡å¼ã€‚\nä¸€æ—¦ç”¨æˆ·æœ‰å£°æ˜å¹¶ä¸”è¯¥å£°æ˜è¢«ç»‘å®šï¼Œç»‘å®šçš„PVå±äºç”¨æˆ·ï¼Œåªè¦ä»–ä»¬éœ€è¦å®ƒã€‚ ç”¨æˆ·é€šè¿‡åœ¨å…¶Podçš„å·å—ä¸­åŒ…å«persistentVolumeClaimæ¥å®‰æ’Podså¹¶è®¿é—®å…¶å£°æ˜çš„PVã€‚ è¯·å‚é˜…ä¸‹é¢çš„è¯­æ³•è¯¦ç»†ä¿¡æ¯ï¼š\nkind: Pod apiVersion: v1 metadata: name: mypod spec: containers: - name: myfrontend image: dockerfile/nginx volumeMounts: - mountPath: \u0026#34;/var/www/html\u0026#34; name: mypd volumes: - name: mypd persistentVolumeClaim: claimName: myclaim å›æ”¶(Reclaiming) å½“ç”¨æˆ·ä½¿ç”¨å®Œvolumeï¼Œå¯ä»¥é€šè¿‡è¯·æ±‚å…è®¸å›æ”¶èµ„æºçš„APIæ¥åˆ é™¤è¯¥PVCå¯¹è±¡ã€‚PersistentVolumeçš„å›æ”¶ç­–ç•¥å‘Šè¯‰é›†ç¾¤å¦‚ä½•å¤„ç†å½“å£°æ˜é‡Šæ”¾PVåã€‚ç›®å‰ï¼Œå·å¯ä»¥è¢«ä¿ç•™ï¼Œå›æ”¶æˆ–åˆ é™¤ã€‚\nä¿ç•™(Retaining) ä¿ç•™å›æ”¶ç­–ç•¥å…è®¸æ‰‹åŠ¨å›æ”¶èµ„æºã€‚ å½“PersistentVolumeClaimè¢«åˆ é™¤æ—¶ï¼ŒPersistentVolumeä»ç„¶å­˜åœ¨ï¼Œå¹¶ä¸”è¯¥å·è¢«è®¤ä¸ºæ˜¯â€œé‡Šæ”¾çš„â€ã€‚ ä½†æ˜¯ï¼Œç”±äºä¸Šä¸€ä¸ªå£°æ˜è€…çš„æ•°æ®ä»ä¿ç•™åœ¨å·ä¸Šï¼Œå› æ­¤å°šä¸å¯ç”¨äºå…¶ä»–å£°æ˜ã€‚ ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨å›æ”¶å·ã€‚\nåˆ é™¤PersistentVolumeã€‚ åˆ é™¤PVåï¼Œå¤–éƒ¨åŸºç¡€è®¾æ–½ï¼ˆå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–Cinderå·ï¼‰ä¸­çš„å…³è”å­˜å‚¨èµ„äº§ä»ç„¶å­˜åœ¨ã€‚ ç›¸åº”åœ°æ‰‹åŠ¨æ¸…ç†ç›¸å…³å­˜å‚¨èµ„äº§ä¸Šçš„æ•°æ®ã€‚ æ‰‹åŠ¨åˆ é™¤å…³è”çš„å­˜å‚¨èµ„äº§ï¼Œæˆ–è€…å¦‚æœè¦é‡ç”¨ç›¸åŒçš„å­˜å‚¨èµ„äº§ï¼Œè¯·ä½¿ç”¨å­˜å‚¨èµ„äº§å®šä¹‰åˆ›å»ºä¸€ä¸ªæ–°çš„PersistentVolumeã€‚ å›æ”¶(Recycling) å¦‚æœå—ç›¸åº”çš„å·æ’ä»¶æ”¯æŒï¼Œå›æ”¶å°†å¯¹å·æ‰§è¡ŒåŸºæœ¬çš„æ“¦é™¤ï¼ˆrm -rf / thevolume / *ï¼‰ï¼Œå¹¶ä½¿å…¶å†æ¬¡å¯ç”¨äºæ–°çš„å£°æ˜ã€‚ ä½†æ˜¯ï¼Œç®¡ç†å‘˜å¯ä»¥ä½¿ç”¨Kubernetesæ§åˆ¶å™¨ç®¡ç†å™¨å‘½ä»¤è¡Œå‚æ•°æ¥é…ç½®è‡ªå®šä¹‰çš„å›æ”¶å™¨podæ¨¡æ¿ï¼Œå¦‚è¿™é‡Œæ‰€è¿°ã€‚ å®šåˆ¶å›æ”¶ç«™æ¨¡æ¿å¿…é¡»åŒ…å«å·è§„èŒƒï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š\napiVersion: v1 kind: Pod metadata: name: pv-recycler- namespace: default spec: restartPolicy: Never volumes: - name: vol hostPath: path: /any/path/it/will/be/replaced containers: - name: pv-recycler image: \u0026#34;gcr.io/google_containers/busybox\u0026#34; command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;test -e /scrub \u0026amp;\u0026amp; rm -rf /scrub/..?* /scrub/.[!.]* /scrub/* \u0026amp;\u0026amp; test -z \\\u0026#34;$(ls -A /scrub)\\\u0026#34; || exit 1\u0026#34;] volumeMounts: - name: vol mountPath: /scrub ä½†æ˜¯ï¼Œå·éƒ¨åˆ†ä¸­çš„è‡ªå®šä¹‰å›æ”¶å™¨podæ¨¡æ¿ä¸­æŒ‡å®šçš„ç‰¹å®šè·¯å¾„å°†æ›¿æ¢ä¸ºæ­£åœ¨å›æ”¶çš„å·çš„ç‰¹å®šè·¯å¾„ã€‚\nåˆ é™¤(Deleting) å¯¹äºæ”¯æŒâ€œåˆ é™¤å›æ”¶â€ç­–ç•¥çš„å·æ’ä»¶ï¼Œåˆ é™¤å°†ä»Kubernetesä¸­åˆ é™¤PersistentVolumeå¯¹è±¡ï¼Œå¹¶åˆ é™¤å¤–éƒ¨åŸºç¡€æ¶æ„ï¼ˆå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–Cinderå·ï¼‰ä¸­å…³è”çš„å­˜å‚¨èµ„äº§ã€‚ åŠ¨æ€é…ç½®çš„å·å§‹ç»ˆè¢«åˆ é™¤ã€‚ å¦‚æœä¸å¸Œæœ›è¿™æ ·åšï¼Œç›®å‰å”¯ä¸€çš„é€‰æ‹©æ˜¯åœ¨åˆ›å»ºPVä¹‹åç¼–è¾‘æˆ–ä¿®è¡¥PVã€‚ è¯·å‚é˜…æ›´æ”¹PersistentVolumeçš„å›æ”¶ç­–ç•¥ã€‚\nPersistent Volumeçš„ç±»å‹ GCEPersistentDisk AWSElasticBlockStore AzureFile AzureDisk FC (Fibre Channel) FlexVolume Flocker NFS iSCSI RBD (Ceph Block Device) CephFS Cinder (OpenStack block storage) Glusterfs VsphereVolume Quobyte Volumes HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster) VMware Photon Portworx Volumes ScaleIO Volumes StorageOS Persistent Volumes æ¯ä¸ªPVéƒ½åŒ…å«è§„æ ¼å’ŒçŠ¶æ€ï¼Œè¿™æ˜¯è§„æ ¼å’ŒçŠ¶æ€ã€‚\napiVersion: v1 kind: PersistentVolume metadata: name: pv0003 spec: capacity: storage: 5Gi accessModes: - ReadWriteOnce persistentVolumeReclaimPolicy: Recycle storageClassName: slow nfs: path: /tmp server: 172.17.0.2 å®¹é‡ é€šå¸¸ï¼ŒPVå°†å…·æœ‰ç‰¹å®šçš„å­˜å‚¨å®¹é‡ã€‚è¿™æ˜¯ä½¿ç”¨PVçš„capacityå±æ€§è®¾ç½®çš„ã€‚çœ‹åˆ°Kubernetesçš„èµ„æºæ¨¡å‹ï¼Œä»¥äº†è§£å®¹é‡ä½¿ç”¨çš„å•ä½ã€‚\nç›®å‰ï¼Œå­˜å‚¨å¤§å°æ˜¯å”¯ä¸€å¯ä»¥è®¾ç½®æˆ–è¯·æ±‚çš„èµ„æºã€‚æœªæ¥çš„å±æ€§å¯èƒ½åŒ…æ‹¬IOPSï¼Œååé‡ç­‰ã€‚\nè®¿é—®æ¨¡å¼ PersistentVolumeå¯ä»¥ä»¥èµ„æºæä¾›è€…æ”¯æŒçš„ä»»ä½•æ–¹å¼å®‰è£…åœ¨ä¸»æœºä¸Šã€‚ å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œæä¾›è€…å°†å…·æœ‰ä¸åŒçš„ç‰¹æ€§ï¼Œæ¯ä¸ªPVçš„è®¿é—®æ¨¡å¼éƒ½è¢«è®¾ç½®ä¸ºè¯¥ç‰¹å®šå·æ”¯æŒçš„ç‰¹å®šæ¨¡å¼ã€‚ ä¾‹å¦‚ï¼ŒNFSå¯ä»¥æ”¯æŒå¤šä¸ªè¯»/å†™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯ç‰¹å®šçš„NFS PVå¯èƒ½ä¼šä»¥åªè¯»æ–¹å¼åœ¨æœåŠ¡å™¨ä¸Šå¯¼å‡ºã€‚ æ¯ä¸ªPVéƒ½æœ‰è‡ªå·±çš„ä¸€ç»„è®¿é—®æ¨¡å¼æ¥æè¿°å…·ä½“çš„PVåŠŸèƒ½ã€‚\nè®¿é—®æ¨¡å¼ï¼š\nReadWriteOnce - å·å¯ä»¥ç”±å•ä¸ªèŠ‚ç‚¹ä½œä¸ºè¯»å†™è£…è½½ ReadOnlyMany - è®¸å¤šèŠ‚ç‚¹å¯ä»¥åªè¯»å®¹é‡ ReadWriteMany - å·å¯ä»¥é€šè¿‡è®¸å¤šèŠ‚ç‚¹çš„è¯»å†™è£…è½½ åœ¨CLIä¸­ï¼Œè®¿é—®æ¨¡å¼ç¼©å†™ä¸ºï¼š\nRWO - ReadWriteOnce ROX - ReadOnlyMany RWX - ReadWriteMany é‡è¦ï¼ä¸€ä¸ªå·åªèƒ½ä¸€æ¬¡ä½¿ç”¨ä¸€ç§è®¿é—®æ¨¡å¼è¿›è¡ŒæŒ‚è½½ï¼Œå³ä½¿å®ƒæ”¯æŒå¾ˆå¤šã€‚ä¾‹å¦‚ï¼ŒGCEPersistentDiskå¯ä»¥ç”±å•ä¸ªèŠ‚ç‚¹æŒ‚è½½ä¸ºReadWriteOnceæˆ–å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½ä¸ºReadOnlyManyï¼Œä½†ä¸èƒ½åŒæ—¶ä½¿ç”¨ä¸¤ç§ã€‚\nVolumeæ’ä»¶ å•èŠ‚ç‚¹è¯»å†™ å¤šä¸ªèŠ‚ç‚¹åªè¯» å¤šä¸ªèŠ‚ç‚¹è¯»å†™ AWSElasticBlockStore âœ“ - - AzureFile âœ“ âœ“ âœ“ AzureDisk âœ“ - - CephFS âœ“ âœ“ âœ“ Cinder âœ“ - - FC âœ“ âœ“ - FlexVolume âœ“ âœ“ - Flocker âœ“ - - GCEPersistentDisk âœ“ âœ“ - Glusterfs âœ“ âœ“ âœ“ HostPath âœ“ - - iSCSI âœ“ âœ“ - PhotonPersistentDisk âœ“ - - Quobyte âœ“ âœ“ âœ“ NFS âœ“ âœ“ âœ“ RBD âœ“ âœ“ - VsphereVolume âœ“ - - PortworxVolume âœ“ - âœ“ ScaleIO âœ“ âœ“ - StorageOS âœ“ - - ç±»å‹ PVå¯ä»¥æœ‰ä¸€ä¸ªç±»å‹ï¼Œé€šè¿‡å°†storageClassNameå±æ€§è®¾ç½®ä¸ºStorageClassçš„åç§°æ¥æŒ‡å®šã€‚ ç‰¹å®šç±»å‹çš„PVåªèƒ½ç»‘å®šåˆ°è¯·æ±‚è¯¥ç±»å‹çš„PVCã€‚ æ²¡æœ‰storageClassNameçš„PVæ²¡æœ‰ç±»å‹ï¼Œåªèƒ½ç»‘å®šåˆ°ä¸éœ€è¦ç‰¹å®šç±»å‹çš„PVCã€‚ åœ¨è¿‡å»ï¼Œä½¿ç”¨äº†æ³¨é‡Švolume.beta.kubernetes.io/storage-classè€Œä¸æ˜¯storageClassNameå±æ€§ã€‚ è¯¥æ³¨é‡Šä»ç„¶å¯ä»¥å·¥ä½œï¼Œä½†å°†æ¥Kubernetesç‰ˆæœ¬å°†ä¸å†é€‚ç”¨ã€‚\nå›æ”¶ç­–ç•¥ ç›®å‰çš„å›æ”¶ç­–ç•¥æ˜¯ï¼š\nRetain - æ‰‹åŠ¨å›æ”¶ Recycle - åŸºæœ¬æ“¦æ´—ï¼ˆâ€œrm -rf / thevolume / *â€ï¼‰ Delete - ç›¸å…³è”çš„å­˜å‚¨èµ„äº§ï¼Œå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–OpenStack Cinderå·è¢«åˆ é™¤ ç›®å‰ï¼Œåªæœ‰NFSå’ŒHostPathæ”¯æŒå›æ”¶ã€‚ AWS EBSï¼ŒGCE PDï¼ŒAzure Diskå’ŒCinderå·æ”¯æŒåˆ é™¤ã€‚\né˜¶æ®µ å·å°†å¤„äºä»¥ä¸‹é˜¶æ®µä¹‹ä¸€ï¼š\nAvailable å¯ç”¨ - ä¸€ä¸ªå°šæœªç»‘å®šåˆ°ç´¢èµ”çš„å…è´¹èµ„æº Bound ç»‘å®š - éŸ³é‡å¿…é¡»æ˜¯å£°æ˜ Released é‡Šæ”¾ - å£°æ˜å·²è¢«åˆ é™¤ï¼Œä½†èµ„æºå°šæœªè¢«é›†ç¾¤å›æ”¶ Failed å¤±è´¥ - å·è‡ªåŠ¨å›æ”¶å¤±è´¥ CLIå°†æ˜¾ç¤ºç»‘å®šåˆ°PVçš„PVCçš„åç§°ã€‚\næŒ‚è½½é€‰é¡¹ Kubernetesç®¡ç†å‘˜å¯ä»¥æŒ‡å®šåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸ŠæŒ‚è½½ä¸€ä¸ªæŒä¹…å·æ—¶çš„å…¶ä»–æŒ‚è½½é€‰é¡¹ã€‚\næ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨æŒä¹…å·ä¸Šçš„æ³¨é‡Švolume.beta.kubernetes.io/mount-optionsæ¥æŒ‡å®šå®‰è£…é€‰é¡¹ã€‚\nä¾‹å¦‚ï¼š\napiVersion: \u0026#34;v1\u0026#34; kind: \u0026#34;PersistentVolume\u0026#34; metadata: name: gce-disk-1 annotations: volume.beta.kubernetes.io/mount-options: \u0026#34;discard\u0026#34; spec: capacity: storage: \u0026#34;10Gi\u0026#34; accessModes: - \u0026#34;ReadWriteOnce\u0026#34; gcePersistentDisk: fsType: \u0026#34;ext4\u0026#34; pdName: \u0026#34;gce-disk-1\u0026#34; å®‰è£…é€‰é¡¹æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨å°†å·å®‰è£…åˆ°ç£ç›˜æ—¶å°†è¢«ç´¯ç§¯åœ°è¿æ¥å’Œä½¿ç”¨ã€‚\nè¯·æ³¨æ„ï¼Œå¹¶éæ‰€æœ‰Persistentå·ç±»å‹éƒ½æ”¯æŒæŒ‚è½½é€‰é¡¹ã€‚ åœ¨Kubernetes 1.6ç‰ˆä¸­ï¼Œä»¥ä¸‹å·ç±»å‹æ”¯æŒæŒ‚è½½é€‰é¡¹ã€‚\nGCEPersistentDisk AWSElasticBlockStore AzureFile AzureDisk NFS iSCSI RBD (Ceph Block Device) CephFS Cinder (OpenStack block storage) Glusterfs VsphereVolume Quobyte Volumes VMware Photon PersistentVolumeClaims æ¯ä¸ªPVCåŒ…å«è§„æ ¼å’ŒçŠ¶æ€ï¼Œè¿™æ˜¯å£°æ˜çš„è§„èŒƒå’ŒçŠ¶æ€ã€‚\nkind: PersistentVolumeClaim apiVersion: v1 metadata: name: myclaim spec: accessModes: - ReadWriteOnce resources: requests: storage: 8Gi storageClassName: slow selector: matchLabels: release: \u0026#34;stable\u0026#34; matchExpressions: - {key: environment, operator: In, values: [dev]} è®¿é—®æ¨¡å¼ å½“è¯·æ±‚å…·æœ‰ç‰¹å®šè®¿é—®æ¨¡å¼çš„å­˜å‚¨æ—¶ï¼Œå£°æ˜ä½¿ç”¨ä¸å·ç›¸åŒçš„çº¦å®šã€‚\nèµ„æº å£°æ˜ï¼ˆå°±åƒpodsï¼‰å¯ä»¥è¯·æ±‚ç‰¹å®šæ•°é‡çš„èµ„æºã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·æ±‚ç”¨äºå­˜å‚¨ã€‚ ç›¸åŒçš„èµ„æºæ¨¡å‹é€‚ç”¨äºå·å’Œå£°æ˜ã€‚\né€‰æ‹©å™¨ å£°æ˜å¯ä»¥æŒ‡å®šæ ‡ç­¾é€‰æ‹©å™¨ä»¥è¿›ä¸€æ­¥è¿‡æ»¤Volumesé›†ã€‚ åªæœ‰æ ‡ç­¾ä¸é€‰æ‹©å™¨åŒ¹é…çš„å·æ‰èƒ½ç»‘å®šåˆ°å£°æ˜ã€‚ é€‰æ‹©å™¨å¯ä»¥ç”±ä¸¤ä¸ªå­—æ®µç»„æˆï¼š\nmatchLabels - å·å¿…é¡»å…·æœ‰å¸¦æ­¤å€¼çš„æ ‡ç­¾ matchExpressions - é€šè¿‡æŒ‡å®šå…³é”®å­—å’Œå€¼çš„å…³é”®å­—ï¼Œå€¼åˆ—è¡¨å’Œè¿ç®—ç¬¦æ‰€åšçš„è¦æ±‚åˆ—è¡¨ã€‚ æœ‰æ•ˆè¿ç®—ç¬¦åŒ…æ‹¬Inï¼ŒNotInï¼ŒExistså’ŒDoesNotExistã€‚ æ‰€æœ‰æ¥è‡ªmatchLabelså’ŒmatchExpressionsçš„è¦æ±‚æ˜¯ç»„åˆåœ¨ä¸€èµ·çš„ï¼Œæ‰€æœ‰è¿™äº›è¦æ±‚éƒ½å¿…é¡»æ»¡è¶³æ‰èƒ½åŒ¹é…ã€‚\nç±»å‹ å£°æ˜å¯ä»¥é€šè¿‡ä½¿ç”¨å±æ€§storageClassNameæŒ‡å®šStorageClassçš„åç§°æ¥è¯·æ±‚ç‰¹å®šçš„ç±»å‹ã€‚åªæœ‰æ‰€è¯·æ±‚çš„ç±»å‹çš„PVï¼Œä¸PVCç›¸åŒçš„storageClassNameçš„PVå¯ä»¥ç»‘å®šåˆ°PVCã€‚\nPVCä¸ä¸€å®šè¦æ±‚ä¸€ä¸ªç±»å‹ã€‚ å®ƒçš„storageClassNameè®¾ç½®ä¸ºç­‰äºâ€œâ€çš„PVCæ€»æ˜¯è¢«è§£é‡Šä¸ºè¯·æ±‚æ²¡æœ‰ç±»å‹çš„PVï¼Œå› æ­¤å®ƒåªèƒ½ç»‘å®šåˆ°æ²¡æœ‰ç±»å‹çš„PVï¼ˆæ²¡æœ‰æ³¨é‡Šæˆ–ä¸€ä¸ªç­‰äºâ€œâ€ï¼‰ã€‚ æ²¡æœ‰storageClassNameçš„PVCä¸å®Œå…¨ç›¸åŒï¼Œå¹¶ä¸”æ ¹æ®æ˜¯å¦å¯ç”¨äº†DefaultStorageClass admissionæ’ä»¶ï¼Œé›†ç¾¤çš„å¤„ç†æ–¹å¼ä¸åŒã€‚\nå¦‚æœadmissionæ’ä»¶å·²æ‰“å¼€ï¼Œåˆ™ç®¡ç†å‘˜å¯ä»¥æŒ‡å®šé»˜è®¤çš„StorageClassã€‚ æ²¡æœ‰storageClassNameçš„æ‰€æœ‰PVCåªèƒ½ç»‘å®šåˆ°è¯¥é»˜è®¤çš„PVã€‚ é€šè¿‡å°†StorageClasså¯¹è±¡ä¸­çš„æ³¨è§£storageclass.kubernetes.io/is-default-classè®¾ç½®ä¸ºâ€œtrueâ€æ¥æŒ‡å®šé»˜è®¤çš„StorageClassã€‚ å¦‚æœç®¡ç†å‘˜æ²¡æœ‰æŒ‡å®šé»˜è®¤å€¼ï¼Œåˆ™é›†ç¾¤ä¼šå¯¹PVCåˆ›å»ºåšå‡ºå“åº”ï¼Œå°±åƒadmissionæ’ä»¶è¢«å…³é—­ä¸€æ ·ã€‚ å¦‚æœæŒ‡å®šäº†å¤šä¸ªé»˜è®¤å€¼ï¼Œåˆ™admissionæ’ä»¶ç¦æ­¢åˆ›å»ºæ‰€æœ‰PVCã€‚ å¦‚æœadmissionæ’ä»¶å·²å…³é—­ï¼Œåˆ™ä¸å­˜åœ¨é»˜è®¤StorageClassçš„æ¦‚å¿µã€‚ æ²¡æœ‰storageClassNameçš„æ‰€æœ‰PVCåªèƒ½ç»‘å®šåˆ°æ²¡æœ‰ç±»çš„PVã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ²¡æœ‰storageClassNameçš„PVCçš„å¤„ç†æ–¹å¼ä¸å°†å…¶storageClassNameè®¾ç½®ä¸ºâ€œâ€çš„PVCç›¸åŒã€‚ æ ¹æ®æŒ‚è½½æ–¹æ³•ï¼ŒæŒ‚è½½è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡addon manageråœ¨Kubernetesç¾¤é›†ä¸­éƒ¨ç½²é»˜è®¤çš„StorageClassã€‚\nå½“PVCæŒ‡å®šä¸€ä¸ªé€‰æ‹©å™¨ï¼Œé™¤äº†è¯·æ±‚ä¸€ä¸ªStorageClassä¹‹å¤–ï¼Œè¿™äº›è¦æ±‚è¢«ANDç»„åˆåœ¨ä¸€èµ·ï¼šåªæœ‰æ‰€è¯·æ±‚çš„ç±»å’Œæ‰€è¯·æ±‚çš„æ ‡ç­¾çš„PVå¯èƒ½è¢«ç»‘å®šåˆ°PVCã€‚ è¯·æ³¨æ„ï¼Œå½“å‰ï¼Œå…·æœ‰éç©ºé€‰æ‹©å™¨çš„PVCä¸èƒ½ä¸ºå…¶åŠ¨æ€é…ç½®PVã€‚\nåœ¨è¿‡å»ï¼Œä½¿ç”¨äº†æ³¨è§£volume.beta.kubernetes.io/storage-classï¼Œè€Œä¸æ˜¯storageClassNameå±æ€§ã€‚ è¯¥æ³¨è§£ä»ç„¶å¯ä»¥å·¥ä½œï¼Œä½†åœ¨æœªæ¥çš„Kubernetesç‰ˆæœ¬ä¸­å®ƒå°†ä¸è¢«æ”¯æŒã€‚\nClaims VS Volumes Podsé€šè¿‡å°†å£°æ˜ç”¨ä½œå·æ¥è®¿é—®å­˜å‚¨ã€‚ å£°æ˜å¿…é¡»å­˜åœ¨äºä¸ä½¿ç”¨å£°æ˜çš„podç›¸åŒçš„å‘½åç©ºé—´ä¸­ã€‚ é›†ç¾¤åœ¨podçš„å‘½åç©ºé—´ä¸­æŸ¥æ‰¾å£°æ˜ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥è·å–æ”¯æŒå£°æ˜çš„PersistentVolumeã€‚ ç„¶åå°†å·æŒ‚è½½åˆ°ä¸»æœºå¹¶è¿›å…¥podã€‚\nkind: Pod apiVersion: v1 metadata: name: mypod spec: containers: - name: myfrontend image: dockerfile/nginx volumeMounts: - mountPath: \u0026#34;/var/www/html\u0026#34; name: mypd volumes: - name: mypd persistentVolumeClaim: claimName: myclaim å…³äºå‘½åç©ºé—´çš„æ³¨æ„ PersistentVolumesç»‘å®šæ˜¯ç‹¬å çš„ï¼Œå¹¶ä¸”ç”±äºPersistentVolumeClaimsæ˜¯å‘½åç©ºé—´å¯¹è±¡ï¼Œå› æ­¤åªèƒ½åœ¨ä¸€ä¸ªå‘½åç©ºé—´å†…æŒ‚è½½â€œmanyâ€æ¨¡å¼ï¼ˆROXï¼ŒRWXï¼‰çš„å£°æ˜ã€‚\nStorageClasses æ¯ä¸ªStorageClassåŒ…å«å­—æ®µprovisioningerå’Œparameterï¼Œå½“å±äºç±»å‹çš„PersistentVolumeéœ€è¦åŠ¨æ€é…ç½®æ—¶ä½¿ç”¨ã€‚\nStorageClasså¯¹è±¡çš„åç§°å¾ˆé‡è¦ï¼Œç”¨æˆ·å¯ä»¥å¦‚ä½•è¯·æ±‚ç‰¹å®šçš„ç±»ã€‚ ç®¡ç†å‘˜åœ¨é¦–æ¬¡åˆ›å»ºStorageClasså¯¹è±¡æ—¶è®¾ç½®ç±»çš„åç§°å’Œå…¶ä»–å‚æ•°ï¼Œå¹¶ä¸”åœ¨åˆ›å»ºå¯¹è±¡åæ— æ³•æ›´æ–°å¯¹è±¡ã€‚\nç®¡ç†å‘˜å¯ä»¥ä»…ä¸ºä¸è¦æ±‚ä»»ä½•ç‰¹å®šç±»ç»‘å®šçš„PVCæŒ‡å®šé»˜è®¤çš„StorageClassï¼šæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…PersistentVolumeClaiméƒ¨åˆ†ã€‚\nkind: StorageClass apiVersion: storage.k8s.io/v1 metadata: name: standard provisioner: kubernetes.io/aws-ebs parameters: type: gp2 ä¾›åº”è€…(Provisioner) å­˜å‚¨ç±»æœ‰ä¸€ä¸ªä¾›åº”è€…ï¼Œå®ƒç¡®å®šç”¨äºé…ç½®PVçš„å·æ’ä»¶ã€‚å¿…é¡»æŒ‡å®šæ­¤å­—æ®µã€‚\nVolume Plugin Internal Provisioner Config Example AWSElasticBlockStore âœ“ AWS AzureFile âœ“ Azure File AzureDisk âœ“ Azure Disk CephFS - - Cinder âœ“ OpenStack Cinder FC - - FlexVolume - - Flocker âœ“ - GCEPersistentDisk âœ“ GCE Glusterfs âœ“ Glusterfs iSCSI - - PhotonPersistentDisk âœ“ - Quobyte âœ“ Quobyte NFS - - RBD âœ“ Ceph RBD VsphereVolume âœ“ vSphere PortworxVolume âœ“ Portworx Volume ScaleIO âœ“ ScaleIO ä½ ä¸é™äºæŒ‡å®šæ­¤å¤„åˆ—å‡ºçš„â€œinternalâ€ä¾›åº”è€…ï¼ˆå…¶åç§°å‰ç¼€ä¸ºâ€œkubernetes.ioâ€å¹¶ä¸Kubernetesä¸€èµ·å‘é€ï¼‰ã€‚ ä½ è¿˜å¯ä»¥è¿è¡Œå’ŒæŒ‡å®šå¤–éƒ¨æä¾›ç¨‹åºï¼Œå®ƒä»¬æ˜¯éµå¾ªKuberneteså®šä¹‰çš„è§„èŒƒçš„ç‹¬ç«‹ç¨‹åºã€‚ å¤–éƒ¨æä¾›è€…çš„ä½œè€…å¯¹ä»£ç çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¾›åº”å•†çš„è¿è¾“çŠ¶å†µï¼Œè¿è¡ŒçŠ¶å†µä»¥åŠä½¿ç”¨çš„å·æ’ä»¶ï¼ˆåŒ…æ‹¬Flexï¼‰ç­‰éƒ½æœ‰å……åˆ†çš„è‡ªä¸»æƒã€‚å­˜å‚¨åº“kubernetes-incubator /å¤–éƒ¨å­˜å‚¨åº“åŒ…å«ä¸€ä¸ªåº“ ç”¨äºç¼–å†™å®æ–½å¤§éƒ¨åˆ†è§„èŒƒçš„å¤–éƒ¨æä¾›è€…ä»¥åŠå„ç§ç¤¾åŒºç»´æŠ¤çš„å¤–éƒ¨æä¾›è€…ã€‚\nä¾‹å¦‚ï¼ŒNFSä¸æä¾›å†…éƒ¨æä¾›ç¨‹åºï¼Œä½†å¯ä»¥ä½¿ç”¨å¤–éƒ¨æä¾›ç¨‹åºã€‚ ä¸€äº›å¤–éƒ¨æä¾›è€…åˆ—åœ¨å­˜å‚¨åº“kubernetes-incubator/external-storageä¸­ã€‚ è¿˜æœ‰ç¬¬ä¸‰æ–¹å­˜å‚¨ä¾›åº”å•†æä¾›è‡ªå·±çš„å¤–éƒ¨ä¾›åº”å•†çš„æƒ…å†µã€‚\nå›æ”¶ç­–ç•¥ ç”±å­˜å‚¨ç±»åŠ¨æ€åˆ›å»ºçš„æŒä¹…å·å°†å…·æœ‰deleteçš„å›æ”¶ç­–ç•¥ã€‚ å¦‚æœä¸å¸Œæœ›è¿™æ ·åšï¼Œå”¯ä¸€çš„å½“å‰é€‰é¡¹æ˜¯åœ¨åˆ›å»ºPVä¹‹åç¼–è¾‘PVã€‚\né€šè¿‡å­˜å‚¨ç±»æ‰‹åŠ¨åˆ›å»ºå’Œç®¡ç†çš„æŒä¹…å·å°†å…·æœ‰åœ¨åˆ›å»ºæ—¶åˆ†é…çš„ä»»ä½•å›æ”¶ç­–ç•¥ã€‚\nå‚æ•° å­˜å‚¨ç±»å‹å…·æœ‰æè¿°å±äºå­˜å‚¨ç±»å‹çš„å·çš„å‚æ•°ã€‚ å–å†³äºä¾›åº”è€…ï¼Œå¯ä»¥æ¥å—ä¸åŒçš„å‚æ•°ã€‚ ä¾‹å¦‚ï¼Œå‚æ•°ç±»å‹çš„å€¼io1å’Œå‚æ•°iopsPerGBç‰¹å®šäºEBSã€‚ å½“çœç•¥å‚æ•°æ—¶ï¼Œä½¿ç”¨ä¸€äº›é»˜è®¤å€¼ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/kubernetes-persistent-volumes/","tags":["Kubernetes","äº‘åŸç”Ÿ"],"title":"Kubernetes â€” æŒä¹…å·"},{"categories":["äº‘åŸç”Ÿ"],"contents":"Kubernetes å®‰è£… macos æ£€æŸ¥ç¯å¢ƒ sysctl -a | grep machdep.cpu.features | grep VMX å®‰è£…VirtualBox http://download.virtualbox.org/virtualbox/5.1.26/Oracle_VM_VirtualBox_Extension_Pack-5.1.26-117224.vbox-extpack å®‰è£…minikube curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.21.0/minikube-darwin-amd64 \u0026amp;\u0026amp; chmod +x minikube \u0026amp;\u0026amp; sudo mv minikube /usr/local/bin/ åˆ›å»ºé›†ç¾¤ é»˜è®¤ä½¿ç”¨virtualboxã€‚\nä¸»æœºçš„ipæ˜¯192.168.31.186ï¼Œ 1087æ˜¯proxyçš„ç«¯å£ã€‚éœ€è¦å°†ssçš„httpä»£ç†ç›‘å¬åœ°å€ä»127.0.0.1æ”¹ä¸ºä¸»æœºçš„ipã€‚\n#å¯åŠ¨ minikube start #ä½¿ç”¨ç§æœ‰åº“ minikube start --insecure-registry=\u0026#34;192.168.31.34\u0026#34; #ä½¿ç”¨proxyï¼Œç”¨äºè·å–é•œåƒ minikube start --docker-env HTTP_PROXY=\u0026#34;192.168.31.186:1087\u0026#34; --docker-env HTTPS_PROXY=\u0026#34;192.168.31.186:1087\u0026#34; --docker-env NO_PROXY=192.168.99.0/24 å®‰è£…kubectl curl -Lo kubectl http://storage.googleapis.com/kubernetes-release/release/v1.7.3/bin/darwin/amd64/kubectl \u0026amp;\u0026amp; chmod +x kubectl \u0026amp;\u0026amp; sudo mv kubectl /usr/local/bin/ oh-my-zsh tab completion vi ~/.zshrc æ·»åŠ åˆ°pluginéƒ¨åˆ†\nplugins=(git zsh-completions kubectl)\nä½¿ç”¨ minikube æ£€æŸ¥ç‰ˆæœ¬ minikube version #minikube version: v0.21.0 kubectl version #Client Version: version.Info{Major:\u0026#34;1\u0026#34;, Minor:\u0026#34;3\u0026#34;, GitVersion:\u0026#34;v1.3.0\u0026#34;, GitCommit:\u0026#34;283137936a498aed572ee22af6774b6fb6e9fd94\u0026#34;, GitTreeState:\u0026#34;clean\u0026#34;, BuildDate:\u0026#34;2016-07-01T19:26:38Z\u0026#34;, GoVersion:\u0026#34;go1.6.2\u0026#34;, Compiler:\u0026#34;gc\u0026#34;, Platform:\u0026#34;darwin/amd64\u0026#34;} #Server Version: version.Info{Major:\u0026#34;1\u0026#34;, Minor:\u0026#34;7\u0026#34;, GitVersion:\u0026#34;v1.7.0\u0026#34;, GitCommit:\u0026#34;d3ada0119e776222f11ec7945e6d860061339aad\u0026#34;, GitTreeState:\u0026#34;clean\u0026#34;, BuildDate:\u0026#34;2017-07-26T00:12:31Z\u0026#34;, GoVersion:\u0026#34;go1.8.3\u0026#34;, Compiler:\u0026#34;gc\u0026#34;, Platform:\u0026#34;linux/amd64\u0026#34;} è·å–é›†ç¾¤åœ°å€ minikube ip 192.168.99.100 è·å–æœåŠ¡åˆ—è¡¨ minikube service list æ‰“å¼€dashboard minikube dashboard kubectl éƒ¨ç½²Dashboard UI é»˜è®¤minikubeä¼šè‡ªåŠ¨éƒ¨ç½²dashboard\nkubectl create -f https://rawgit.com/kubernetes/dashboard/master/src/deploy/kubernetes-dashboard.yaml å¯åŠ¨proxy kubectl proxy #Starting to serve on 127.0.0.1:8001 è·å–podä¿¡æ¯ kubectl get pods --namespace kube-system NAME READY STATUS RESTARTS AGE kube-addon-manager-minikube 0/1 Running 0 1h kubernetes-dashboard-3313488171-90s64 0/1 Running 0 20m å¦‚æœSTATUSä¸€ç›´å¤„äºContainerCreatingçŠ¶æ€ï¼Œåº”è¯¥æ˜¯pull imageå¤±è´¥ã€‚é»˜è®¤æ˜¯å»gcr.ioæ‹‰é•œåƒï¼Œè¢«å¢™äº†ã€‚éœ€è¦åœ¨å¯åŠ¨minikubeçš„æ—¶å€™è®¾ç½®dockerä½¿ç”¨çš„ä»£ç†ã€‚\nè·å–podè¯¦ç»†ä¿¡æ¯ kubectl describe pod kubernetes-dashboard-3313488171-90s64 --namespace kube-system æŸ¥çœ‹log kubectl logs -f kubernetes-dashboard-3313488171-90s64 ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/install-kubernetes-on-macos/","tags":["Kubernetes","macOS"],"title":"Kuberneteså­¦ä¹  â€” Macoså®‰è£…Kubernetes"},{"categories":["ç¬”è®°"],"contents":"åœæ­¢ï¼Œstopï¼Œè¿™é‡Œè¯´çš„æ˜¯çœŸçš„åœæ­¢ã€‚å¦‚ä½•ä¼˜é›…çš„ç»“æŸï¼Œè¿™é‡Œå°±ä¸æäº†ã€‚\nè¿™é‡Œè¦ç”¨Thread.stop()ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œstop()æ–¹æ³•åœ¨JDKä¸­æ˜¯åºŸå¼ƒçš„ã€‚\nè¯¥æ–¹æ³•å¤©ç”Ÿæ˜¯ä¸å®‰å…¨çš„ã€‚ä½¿ç”¨thread.stop()åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯¼è‡´é‡Šæ”¾ï¼ˆè§£é”ï¼‰æ‰€æœ‰è¯¥çº¿ç¨‹å·²ç»é”å®šçš„ç›‘è§†å™¨ï¼ˆå› æ²¿å †æ ˆå‘ä¸Šä¼ æ’­çš„æœªæ£€æŸ¥å¼‚å¸¸ThreadDeathè€Œè§£é”ï¼‰ã€‚å¦‚æœä¹‹å‰å—è¿™äº›ç›‘è§†å™¨ä¿æŠ¤çš„ä»»ä½•å¯¹è±¡å¤„äºä¸ä¸€è‡´çŠ¶æ€ï¼Œåˆ™ä¸ä¸€è‡´çŠ¶æ€çš„å¯¹è±¡ï¼ˆå—æŸå¯¹è±¡ï¼‰å°†å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼Œè¿™å¯èƒ½å¯¼è‡´ä»»æ„çš„è¡Œä¸ºã€‚\næœ‰æ—¶å€™æˆ‘ä»¬ä¼šæœ‰è¿™ç§éœ€æ±‚ï¼Œä¸éœ€è¦è€ƒè™‘çº¿ç¨‹æ‰§è¡Œåˆ°å“ªä¸€æ­¥ã€‚ä¸€èˆ¬è¿™ç§æƒ…å†µæ˜¯å¤–éƒ¨æ‰§è¡Œstopï¼Œæ¯”å¦‚æ‰§è¡Œä¸šåŠ¡çš„çº¿ç¨‹å› ä¸ºå„ç§åŸå› å‡æ­»æˆ–è€…è€—æ—¶è¾ƒé•¿ï¼Œç”±äºè®¾è®¡é—®é¢˜åˆæ— æ³•å“åº”ä¼˜é›…çš„åœæ­¢æŒ‡ä»¤ã€‚\nç°åœ¨å¤§å®¶åœ¨é¡¹ç›®ä¸­éƒ½å¾ˆå°‘ç›´æ¥ä½¿ç”¨çº¿ç¨‹ï¼Œè€Œæ˜¯é€šè¿‡concurrentåŒ…ä¸­çš„ç±»æ¥å®ç°å¤šçº¿ç¨‹ï¼Œä¾‹å¦‚ExecutorServiceçš„å„ç§å®ç°ç±»ã€‚\nä¸€ä¸ªç®€å•çš„åœæ­¢çº¿ç¨‹çš„ä¾‹å­ï¼š\npublic class ExecutorServiceTest { public static void main(String[] args) throws InterruptedException { ExecutorService executor = Executors.newSingleThreadExecutor(); final AtomicReference\u0026lt;Thread\u0026gt; t = new AtomicReference\u0026lt;\u0026gt;(); Future\u0026lt;?\u0026gt; firstFuture = executor.submit(new Runnable() { public void run() { Thread currentThread = Thread.currentThread(); t.set(currentThread); while (true) { } } }); try { firstFuture.get(500, TimeUnit.MILLISECONDS); } catch (Exception e) { while (t.get().isAlive()) { t.get().stop(); TimeUnit.MILLISECONDS.sleep(50); } } executor.submit(new Runnable() { @Override public void run() { System.out.println(\u0026#34;submit again\u0026#34;); } }); executor.shutdown(); } } å¦‚æœä½ è¿è¡Œäº†ä¸Šé¢çš„ä»£ç å°±ä¼šå‘ç°ç¨‹åºå‡æ­»äº†ï¼Œé€šè¿‡stack dumpçœ‹æ˜¯å‘ç”Ÿäº†æ­»é”ï¼š\n\u0026#34;pool-1-thread-2\u0026#34; #11 prio=5 os_prio=31 tid=0x00007fa91006e800 nid=0x5903 waiting on condition [0x00007000060f8000] java.lang.Thread.State: WAITING (parking) at sun.misc.Unsafe.park(Native Method) - parking to wait for \u0026lt;0x000000076ab76ea0\u0026gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync) at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175) at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836) at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:870) at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043) at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442) at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1067) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) at java.lang.Thread.run(Thread.java:745) æ­»é”å‘ç”Ÿåœ¨ç¬¬äºŒæ¬¡submitåï¼Œåœ¨LinkedBlockingQueue.take()æ—¶ï¼ŒLinkedBlockingQueueåœ¨ThreadPoolExecutorä¸­ç”¨æ¥æš‚å­˜taskçš„ã€‚çœŸæ­£æ‰§è¡Œä»»åŠ¡çº¿ç¨‹çš„æ—¶å€™å†ä»é˜Ÿåˆ—ä¸­å–å‡ºã€‚æˆ‘ä»¬éƒ½çŸ¥é“LinkedBlockingQueueæ˜¯çº¿ç¨‹çš„å®‰å…¨çš„ï¼Œå…¶é«˜å¹¶å‘å’Œçº¿ç¨‹å®‰å…¨æ˜¯é€šè¿‡ä¸€ä¸ªReentrantLockä»£æ›¿å†…ç½®é”æ¥å®ç°çš„ï¼ˆå‡å°äº†é”çš„ç²’åº¦ï¼‰ã€‚submitç¬¬äºŒä¸ªtaskæ—¶ï¼Œå†æ¬¡æ‰§è¡Œtakeä¼šå†æ¬¡è·å–é”ã€‚ä½†æ˜¯ç”±äºstopç›´æ¥æ€æ­»äº†çº¿ç¨‹ï¼Œæ²¡æœ‰é‡Šæ”¾å½“æ¬¡æ‰§è¡Œtakeæ–¹æ³•æ—¶è·å–ReentrantLocké”ï¼Œå¯¼è‡´äº†æ­»é”ã€‚\nstopç›´æ¥åœæ­¢äº†çº¿ç¨‹ï¼ŒæŠ›å‡ºäº†ThreadDeathã€‚ThreadDeathæ˜¯Errorï¼Œä¸æ˜¯Exceptionã€‚\npublic class ThreadDeath extends Error { private static final long serialVersionUID = -4417128565033088268L; } è¿™ç§æƒ…å†µä¸‹ï¼ŒåŸæœ‰çš„ExecutorServiceå®ä¾‹å°±ä¸èƒ½å†ä½¿ç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•é€šè¿‡ç¨‹åºæ¥é‡Šæ”¾æœªé‡Šæ”¾çš„é”ï¼ˆç”±è™šæ‹Ÿæœºçš„GCæ¥è§£å†³ï¼‰ã€‚å¦‚æ­¤ï¼Œä¾¿éœ€è¦é‡å»ºExecutorServiceå®ä¾‹ã€‚\nå¯¹ä¸Šé¢çš„ä»£ç åšäº†ä¿®æ”¹ï¼š\npublic class ExecutorServiceTest { public static void main(String[] args) throws InterruptedException { ExecutorService executor = Executors.newSingleThreadExecutor(); final AtomicReference\u0026lt;ExecutorService\u0026gt; es = new AtomicReference\u0026lt;\u0026gt;(); es.set(executor); final AtomicReference\u0026lt;Thread\u0026gt; t = new AtomicReference\u0026lt;\u0026gt;(); Future\u0026lt;?\u0026gt; future = es.get().submit(new Runnable() { public void run() { Thread currentThread = Thread.currentThread(); t.set(currentThread); currentThread.setUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() { public void uncaughtException(Thread t, Throwable e) { if (e instanceof ThreadDeath || e instanceof IllegalMonitorStateException) { e.printStackTrace(); es.get().shutdownNow(); es.set(Executors.newSingleThreadExecutor()); } } }); while (true) { } } }); try { future.get(500, TimeUnit.MILLISECONDS); } catch (Exception e) { while (t.get().isAlive()) { t.get().stop(); TimeUnit.MILLISECONDS.sleep(50); } } es.get().submit(new Runnable() { @Override public void run() { System.out.println(\u0026#34;submit again\u0026#34;); } }); es.get().shutdown(); } } æ³¨ï¼šè¿™ä¸ªä¾‹å­åªè€ƒè™‘äº†ExecutorServiceå®ä¾‹åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸­çš„ä½¿ç”¨ï¼Œå¦‚æœéœ€è¦åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­éœ€è¦è€ƒè™‘é‡å»ºå®ä¾‹æ—¶çš„æ’ä»–æ€§ã€‚\nä¿®æ”¹åçš„æ ¸å¿ƒæ˜¯UncaughtExceptionHandlerï¼š\nå½“çº¿ç¨‹ç”±äºæœªæ•è·çš„å¼‚å¸¸çªç„¶ç»ˆæ­¢è€Œè°ƒç”¨å¤„ç†ç¨‹åºçš„æ¥å£ã€‚ å½“çº¿ç¨‹ç”±äºæœªæ•è·çš„å¼‚å¸¸å³å°†ç»ˆæ­¢æ—¶ï¼ŒJavaè™šæ‹Ÿæœºå°†ä½¿ç”¨Thread.getUncaughtExceptionHandlerï¼ˆï¼‰å‘çº¿ç¨‹æŸ¥è¯¢å…¶UncaughtExceptionHandlerï¼Œå¹¶å°†è°ƒç”¨å¤„ç†ç¨‹åºçš„uncaughtExceptionæ–¹æ³•ï¼Œå°†çº¿ç¨‹å’Œå¼‚å¸¸ä½œä¸ºå‚æ•°ä¼ é€’ã€‚ å¦‚æœä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰æ˜¾ç¤ºå®ƒçš„UncaughtExceptionHandlerï¼Œé‚£ä¹ˆå®ƒçš„ThreadGroupå¯¹è±¡å……å½“å®ƒçš„UncaughtExceptionHandlerã€‚ å¦‚æœThreadGroupå¯¹è±¡æ²¡æœ‰å¤„ç†å¼‚å¸¸çš„ç‰¹æ®Šè¦æ±‚ï¼Œå®ƒå¯ä»¥å°†è°ƒç”¨è½¬å‘åˆ°é»˜è®¤çš„æœªæ•è·çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/stop-a-thread-of-executor-service/","tags":["Java"],"title":"æš´åŠ›åœæ­¢ExecutorServiceçš„çº¿ç¨‹"},{"categories":["ç¬”è®°"],"contents":"ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®è·µã€‹çš„æ³¨è§£ä¸­æœ‰æåˆ°è¿™ä¸€æ¦‚å¿µã€‚\nThe private constructor exists to avoid the race condition that would occur if the copy constructor were implemented as this (p.x, p.y); this is an example of the private constructor capture idiom (Bloch and Gafter, 2005).\nç»“åˆåŸæ–‡ä»£ç ï¼š\n@ThreadSafe public class SafePoint{ @GuardedBy(\u0026#34;this\u0026#34;) private int x,y; private SafePoint (int [] a) { this (a[0], a[1]); } public SafePoint(SafePoint p) { this (p.get()); } public SafePoint(int x, int y){ this.x = x; this.y = y; } public synchronized int[] get(){ return new int[] {x,y}; } public synchronized void set(int x, int y){ this.x = x; this.y = y; } } è¿™é‡Œçš„æ„é€ å™¨public SafePoint(SafePoint p) { this (p.get()); }æ˜¯ä¸ºäº†æ•è·å¦ä¸€ä¸ªå®ä¾‹çš„çŠ¶æ€ã€‚get()æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œä¸ºäº†é¿å…ç«æ€æ²¡æœ‰åˆ†åˆ«æä¾›xã€yçš„å…¬æœ‰getteræ–¹æ³•ã€‚\nä¸ºäº†ä¿è¯SafePointçš„å¤šçº¿ç¨‹å®‰å…¨æ€§ï¼Œåœ¨ä½¿ç”¨å¦ä¸€ä¸ªå®ä¾‹æ„é€ æ–°çš„å®ä¾‹æ—¶ï¼Œä½¿ç”¨äº†ä¸€ä¸ªç§æœ‰çš„æ„é€ å™¨ã€‚\né¦–å…ˆä¸ºä»€ä¹ˆä¸ç”¨ä¸‹é¢è¿™ç§ï¼Œè¿˜æ˜¯ä¸ºäº†é¿å…ç«æ€ï¼ˆp.xå’Œp.yè°ƒç”¨ä¸æ˜¯åŸå­æ“ä½œï¼‰ã€‚\npublic SafePoint(SafePoint p) { this(p.x, p.y) } åŒç†ï¼Œè¿™ç§ä¹Ÿä¸è¡Œï¼Œä¸¤æ¬¡è°ƒç”¨get()æ–¹æ³•ä¸æ˜¯åŸå­æ“ä½œã€‚\npublic SafePoint(SafePoint p) { this(p.get()[0], p.get()[1]) } ä¸ºä»€ä¹ˆä¸ç”¨ç›´æ¥ç”¨æ•°ç»„ï¼Œç¼–è¯‘ä¸é€šè¿‡ï¼šCall to \u0026quot;this()\u0026quot; must be first statement in constructor body\npublic SafePoint(SafePoint p) { int[] a = p.get(); this(a[0], a[1]); } ä¸ºä»€ä¹ˆæ¥å—æ•°ç»„ä¸ºå‚æ•°çš„æ„é€ å™¨ä¸èƒ½å…¬å¼€ï¼Œæ•°ç»„aæ˜¯æœ‰å¤–éƒ¨ä¼ å…¥çš„ï¼Œå¹¶ä¸èƒ½ä¿è¯æ•°ç»„å†…å®¹ä¸ä¼šå…¶ä»–çº¿ç¨‹ä¿®æ”¹ã€‚\npublic SafePoint (int [] a) { this (a[0], a[1]); } å½“ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ç§ä»£æ›¿ç§æœ‰çš„æ„é€ å™¨ï¼Œè¿™ç§æ–¹æ³•æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯ä¼šäº§ç”Ÿé‡å¤çš„åˆå§‹åŒ–ä»£ç ã€‚\npublic SafePoint(SafePoint p) { int[] a = p.get(); this.x = a[0]; this.y = a[1]; } å†å›å¤´çœ‹SafePointçš„çº¿ç¨‹å®‰å…¨æ€§ï¼ŒSafePointæœ‰ä¸¤ä¸ªçŠ¶æ€å˜é‡xã€yã€‚ä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ï¼Œæ²¡æœ‰ä¸ºå…¶åˆ†åˆ«æä¾›getterå’Œsetteræ–¹æ³•ï¼Œè€Œæ˜¯å°†å…¶å°è£…åå‘å¸ƒå¹¶ä½¿ç”¨å†…ç½®é”ä¿æŠ¤ã€‚\nå¯ä»¥å‚è€ƒstackoverflowä¸Šçš„ç¤ºä¾‹ä»£ç ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/private-constructor-capture-idiom/","tags":["Java"],"title":"ç§æœ‰æ„é€ å‡½æ•°æ•è·æ¨¡å¼"},{"categories":["ç¬”è®°"],"contents":"æ­å»ºCassandra ä½¿ç”¨dockeråˆ›å»ºCassandraï¼Œæ–¹ä¾¿å¿«æ·\ndocker pull cassandra:latest docker run -d --name cassandra -p 9042:9042 cassandra docker exec -it cassandra bash åˆ›å»ºkeyspaceã€table #cqlsh\u0026gt; #create keyspace CREATE KEYSPACE contacts WITH REPLICATION = { \u0026#39;class\u0026#39; : \u0026#39;SimpleStrategy\u0026#39;, \u0026#39;replication_factor\u0026#39; : 1 }; #use USE contacts; #create table CREATE TABLE contact ( id UUID, email TEXT PRIMARY KEY ); æŸ¥çœ‹è¡¨æ•°æ® cqlsh:contacts\u0026gt; SELECT * FROM contact; email | id -------+---- (0 rows) Javaå®¢æˆ·ç«¯ å¼•å…¥ä¾èµ– \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.datastax.cassandra\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;cassandra-driver-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; è¿æ¥åˆ°Cassandraå¹¶æ’å…¥æ•°æ® Cluster cluster = Cluster.builder().addContactPoint(\u0026#34;127.0.0.1\u0026#34;).build(); Session session = cluster.connect(\u0026#34;contacts\u0026#34;); String insert = \u0026#34;INSERT INTO contact (id, email) \u0026#34; + \u0026#34;VALUES (\u0026#34; + \u0026#34;bd297650-2885-11e4-8c21-0800200c9a66,\u0026#34; + \u0026#34;\u0026#39;contact@example.com\u0026#39; \u0026#34; + \u0026#34;);\u0026#34;; session.execute(insert); æŸ¥çœ‹è¡¨æ•°æ® cqlsh:contacts\u0026gt; SELECT * FROM contact; email | id ---------------------+-------------------------------------- contact@example.com | bd297650-2885-11e4-8c21-0800200c9a66 (1 rows) ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/java-operate-cassandra-deployed-in-docker/","tags":["Java","Docker"],"title":"Docker å¿«é€Ÿæ„å»º Cassandra å’Œ Java æ“ä½œ"},{"categories":["ç¬”è®°","æ•™ç¨‹"],"contents":"å‡è®¾å·²ç»å®‰è£…å¥½Docker\nSpringbootåº”ç”¨ pomæ·»åŠ ä¾èµ–å’Œæ„å»ºæ’ä»¶ \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.5.3.RELEASE\u0026lt;/version\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; åº”ç”¨ä»£ç  package com.atbug.spring.boot.test; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.boot.web.servlet.FilterRegistrationBean; import org.springframework.context.annotation.Bean; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; /** * Created by addo on 2017/5/15. */ @SpringBootApplication @RestController public class Application { @RequestMapping(\u0026#34;/\u0026#34;) public String home(){ return \u0026#34;Hello world!\u0026#34;; } public static void main(String[] args) { SpringApplication.run(Application.class, args); } } åº”ç”¨æ„å»º mvn clean package Centos 7 with Java8 è·å–Centos7 é•œåƒ docker pull centos:7 å‡†å¤‡centos-java8çš„dockerfile FROM centos:7 MAINTAINER Addo Zhang \u0026#34;duwasai@gmail.com\u0026#34; # Set correct environment variables. ENV\tHOME /root ENV\tLANG en_US.UTF-8 ENV\tLC_ALL en_US.UTF-8 RUN yum install -y curl; yum upgrade -y; yum update -y; yum clean all ENV JDK_VERSION 8u11 ENV JDK_BUILD_VERSION b12 RUN curl -LO \u0026#34;http://download.oracle.com/otn-pub/java/jdk/$JDK_VERSION-$JDK_BUILD_VERSION/jdk-$JDK_VERSION-linux-x64.rpm\u0026#34; -H \u0026#39;Cookie: oraclelicense=accept-securebackup-cookie\u0026#39; \u0026amp;\u0026amp; rpm -i jdk-$JDK_VERSION-linux-x64.rpm; rm -f jdk-$JDK_VERSION-linux-x64.rpm; yum clean all ENV JAVA_HOME /usr/java/default RUN yum remove curl; yum clean all åˆ›å»ºcentos-java8é•œåƒ docker build -t addo/centos-java8 . Dockerä¸­è¿è¡Œåº”ç”¨ å‡†å¤‡åº”ç”¨é•œåƒçš„dockerfile FROM addo/centos-java8 ADD target/boot-test-1.0-SNAPSHOT.jar /opt/app.jar EXPOSE 8080 CMD java -jar /opt/app.jar æ„å»ºåº”ç”¨é•œåƒ docker build -t temp/spring-boot-app . è¿è¡Œ docker run --name spring-boot-app -p 8080:8080 temp/spring-boot-app ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/run-spring-boot-app-in-docker/","tags":["Spring","Docker"],"title":"ä»é›¶å¼€å§‹ç”¨ docker è¿è¡Œ spring boot åº”ç”¨"},{"categories":["ç¬”è®°"],"contents":"æœ€è¿‘å› ä¸ºéœ€æ±‚åœ¨çœ‹CASç›¸å…³çš„åªæ˜¯ï¼Œç”±äºéœ€è¦åç«¯è°ƒç”¨ï¼Œç”¨åˆ°proxyï¼ˆä»£ç†ï¼‰æ¨¡å¼ã€‚æ•´ç†äº†ä¸‹web flowå’Œproxy web flowçš„æµç¨‹ã€‚\nWeb Flow Proxy Web Flow ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/jasig-cas-web-and-proxy-flow/","tags":null,"title":"Jasig CAS Web and Proxy flow"},{"categories":["ç¬”è®°"],"contents":"è¿™å‡ å¤©ç”Ÿäº§ä¸Šæœ‰å°æœºå™¨çš„Metaspaceä¸€ç›´åœ¨å‘Šè­¦ï¼ŒMetaspaceä½¿ç”¨è¾¾åˆ°äº†97%ã€‚ä½¿ç”¨-XX:MetaspaceSize=512mï¼Œå‘Šè­¦ä¹Ÿè¿˜åœ¨åœ¨æŒç»­ï¼ŒæŸ¥çœ‹MCåªæœ‰81536.0ï¼Œæ˜¾ç„¶è¿™ä¸ªå‚æ•°æ²¡èµ·ä½œç”¨ã€‚\nä¹Ÿæœ‰äººé‡åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼Œå¹¶åœ¨openjdkä¸Šæè¿‡ç±»ä¼¼çš„bugï¼Œå…¶å®æ˜¯ä¸€ä¸ªæ³¨é‡Šçš„bugï¼Œæœ€ç»ˆåœ¨JDK-8151845ä¸­ä¿®å¤äº†ã€‚\nClass metadata is deallocated when the corresponding Java class is unloaded. Java classes are unloaded as a result of garbage collection, and garbage collections may be induced in order to unload classes and deallocate class metadata. When the space committed for class metadata reaches a certain level (a high-water mark), a garbage collection is induced. After the garbage collection, the high-water mark may be raised or lowered depending on the amount of space freed from class metadata. The high-water mark would be raised so as not to induce another garbage collection too soon. The high-water mark is initially set to the value of the command-line option MetaspaceSize. It is raised or lowered based on the options MaxMetaspaceFreeRatio and MinMetaspaceFreeRatio. If the committed space available for class metadata as a percentage of the total committed space for class metadata is greater than MaxMetaspaceFreeRatio, then the high-water mark will be lowered. If it is less than MinMetaspaceFreeRatio, then the high-water mark will be raised.\næŸ¥çœ‹äº†Oracleçš„æ‰‹å†Œï¼ŒMetaspaceçš„GCä¼šåœ¨committed sizeè¾¾åˆ°high-water markä¹‹åå‘ç”Ÿã€‚å¹¶ä¸”GCä¹‹åhigh-water markä¼šå˜åŒ–ï¼šå˜å¤§æˆ–è€…å˜å°ï¼Œå˜å¤§çš„è¯ä¼šé˜²æ­¢ä¸‹æ¬¡GCå‘ç”Ÿå¾—å¤ªæ—©ã€‚high-water markçš„é»˜è®¤åˆå§‹å¤§å°20.8Mï¼Œé€šè¿‡MetaspaceSizeæ¥è®¾ç½®ï¼Œå¯è§MetaspaceSizeæ˜¯æ§åˆ¶Metaspaceå‘ç”ŸGCçš„é˜ˆå€¼ã€‚GCåhigh-water markçš„å˜åŒ–ï¼Œé€šè¿‡MaxMetaspaceFreeRatioå’ŒMinMetaspaceFreeRatioæ§åˆ¶ã€‚\nMaxMetaspaceSizeé»˜è®¤ä¸º-1ï¼Œæ— é™å¤§ã€‚ä¸è¿‡å¦‚æœæ²¡æœ‰é™åˆ¶çš„è¯ï¼Œä¸€ç›´å¢å¤§ä¼šè¢«ç³»ç»Ÿå¹²æ‰è¿›ç¨‹ã€‚æœ€å¥½è¿˜æ˜¯è®¾ç½®ä¸€ä¸‹ï¼Œæ¯”å¦‚1Gã€‚\nä¸‹é¢æ˜¯æˆ‘æµ‹è¯•äº†åˆ†åˆ«è®¾ç½®MetaspaceSizeã€MaxMetaspaceSizeã€InitialBootClassLoaderMetaspaceSizeä¸º1Gï¼ŒMetaspaceçš„å˜åŒ–ã€‚\n-XX:MetaspaceSize=1024m\ncommitted: 29360128 init: 0 max: -1 used: 28440648\n-XX:MaxMetaspaceSize=1024m\ncommitted: 29360128 init: 0 max: 1073741824 used: 28503552\n-XX:InitialBootClassLoaderMetaspaceSize=1024m\ncommitted: 1087635456 init: 0 max: -1 used: 28500344\nä¸‰ä¸ªå‚æ•°éƒ½æ˜¯æ²¡æœ‰æ”¹å˜initçš„å¤§å°ï¼Œä½†æ˜¯InitialBootClassLoaderMetaspaceSizeæ”¹å˜äº†committedçš„å¤§å°ï¼Œå…¶å®ä¹Ÿæ˜¯æœ€ç»ˆæˆ‘ä»¬è¦çš„è®¾ç½®ã€‚\nå…³äºè¿™ä¸ªå‚æ•°ï¼Œå¯ä»¥çœ‹ä½ å‡ç¬¨çš„å…³äºMetaspaceçš„æºç è§£è¯»ï¼Œå‘ç°çš„æœ‰ç‚¹æ™šäº†ã€‚\næœ€åçš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨è¿™ä¸ªé…ç½®ï¼š-XX:MaxMetaspaceSize=1024m -XX:InitialBootClassLoaderMetaspaceSize=256mã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/java8-metaspace-size-issue/","tags":["Java"],"title":"MetaspaceSizeçš„å‘"},{"categories":["ç¬”è®°"],"contents":"èƒŒæ™¯ ä¸€ä¸ªTomcatå®ä¾‹ä¸­è¿è¡Œäº†ä¸‰ä¸ªåº”ç”¨ï¼Œå…¶ä¸­ä¸€ä¸ªå¯¹æ¥äº†Apereoçš„CASç³»ç»Ÿã€‚ç°åœ¨è¦æ±‚å¦å¤–ä¸¤ä¸ªç³»ç»Ÿä¹Ÿå¯¹æ¥CASç³»ç»Ÿï¼Œé—®é¢˜å°±å‡ºç°äº†ï¼š\nåº”ç”¨å¯åŠ¨åæ‰“å¼€å…¶ä¸­ä¸¤ä¸ªåº”ç”¨çš„ä»»ä½•ä¸€ä¸ªï¼Œç™»å½•å®Œæˆåç³»ç»Ÿéƒ½æ²¡æœ‰é—®é¢˜ã€‚å”¯ç‹¬é¦–é€‰æ‰“å¼€ç¬¬ä¸‰ä¸ªï¼Œå…¶ä»–ä¸¤ä¸ªæŠ¥é”™ClassNotFoundException: org.apache.xerces.parsers.SAXParserã€‚\nå‘ç°è¿™ä¸ªç±»æ¥è‡ªxerces:xercesImpl:jar:2.6.2ï¼Œä½¿ç”¨mvn dependency:treeå‘ç°æ˜¯è¢«xom:xom:1.1ç®€æ´å¼•ç”¨ã€‚\nåˆ†æ CAS client jarä¸­ä½¿ç”¨XMLReaderFactoryåˆ›å»ºXMLReaderï¼Œé¦–æ¬¡åˆ›å»ºä¼šä»classpathä¸­æŸ¥æ‰¾META-INF/services/org.xml.sax.driveræ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œçš„å†…å®¹æ˜¯ä¸€ä¸ªç±»çš„å…¨åã€‚æ¯”å¦‚xercesImplä¸­è¯¥æ–‡ä»¶çš„å†…å®¹æ˜¯org.apache.xerces.parsers.SAXParserã€‚\næ‰¾åˆ°ä¹‹åä¼šå°†ç±»åä¿å­˜åœ¨XMLReaderFactoryçš„é™æ€å˜é‡_clsFromJarï¼Œå¹¶æ ‡è®°ä¸ä¼šå†æŸ¥æ‰¾org.xml.sax.driveræ–‡ä»¶ã€‚æ‰¾ä¸åˆ°çš„è¯åˆ™ä½¿ç”¨com.sun.org.apache.xerces.internal.parsers.SAXParserç±»ã€‚\nç„¶åå†ä½¿ç”¨å½“å‰çº¿ç¨‹çš„ContextClassLoaderå¯¹ç±»è¿›è¡ŒåŠ è½½ï¼Œè¿™é‡Œçš„çš„ContextClassLoaderæ˜¯ä¸€ä¸ªWebAppClassLoaderçš„å®ä¾‹ã€‚\nåŒæ—¶XMLReaderFactoryç±»æ˜¯è¢«BootStrapClassLoaderåŠ è½½çš„ï¼Œä¸ºä¸‰ä¸ªåº”ç”¨å…±äº«ã€‚\nTomcatç±»è®°è½½æœºåˆ¶ Tomcatä¸­æœ‰å››ä¸ªä½ç½®å¯ä»¥å­˜æ”¾Javaç±»åº“ï¼š/commonsã€/serverã€/sharedå’Œå„Webåº”ç”¨çš„WEB-INF/libç›®å½•ã€‚\n/commonsç›®å½•ä¸­çš„ç±»åº“å¯ä»¥è¢«Tomcatå’Œæ‰€æœ‰Webåº”ç”¨ä½¿ç”¨ /serverç›®å½•ä¸­çš„ç±»åº“åªèƒ½è¢«Tomcatä½¿ç”¨ /sharedç›®å½•ä¸­çš„å¯ä»¥è¢«æ‰€æœ‰Webåº”ç”¨çš„ä½¿ç”¨ï¼Œä½†æ˜¯å¯¹Tomcatä¸å¯è§ å„Webåº”ç”¨çš„WEB-INF/libç›®å½•ä¸­çš„ç±»åº“åˆ™åªèƒ½è¢«è¯¥çš„åº”ç”¨ä½¿ç”¨\nTomcatçš„ä½¿ç”¨CommonClassLoaderã€CatalinaClassLoaderã€SharedClassLoaderã€WebAPPClassLoaderåŠ è½½å¯¹åº”ç›®å½•ä¸­çš„ç±»åº“ã€‚\nBootstrapã€Extensionã€Applicationæ˜¯è™šæ‹Ÿæœºä½¿ç”¨çš„ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚\nç±»çš„åŠ è½½ä½¿ç”¨åŒäº²å§”æ´¾æœºåˆ¶(Parent-Delegation)ã€‚\nBootstrap | Extension | Application | System | Common / \\ Catalina Shared / \\ WebApp1 ... WebApp2 | | Jasper Jasper è§£å†³æ–¹æ¡ˆ åœ¨å¦å¤–ä¸¤ä¸ªåº”ç”¨ä¸­æ·»åŠ xerces:xercesImpl:jar:2.6.2ä¾èµ–ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/one-tomcat-class-load-issue/","tags":["Java"],"title":"ä¸€ä¸ªTomcatç±»åŠ è½½é—®é¢˜"},{"categories":["ç¬”è®°"],"contents":"è¿™é‡Œä¼šç”¨åˆ°å‡ ä¸ªæ¦‚å¿µé«˜é˜¶å‡½æ•°ã€å‡½æ•°å­—é¢é‡ã€å‚æ•°ç»„\né«˜é˜¶å‡½æ•° high-order function å‡½æ•°çš„ä¸€ç§ï¼Œç®€å•æ¥è¯´å®ƒåŒ…å«äº†ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å‚æ•°æˆ–è€…è¿”å›å€¼ã€‚\næ‰€è°“çš„é«˜é˜¶æ˜¯è·Ÿä¸€é˜¶å‡½æ•°ç›¸æ¯”ï¼Œæ·±å…¥ä¸€ä¸‹ï¼š\nä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°æ˜¯å‡½æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå€¼ã€‚ è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ²¡æœ‰å‚æ•°æ˜¯å‡½æ•°ã€‚ ä¸Šè¿°ä¸¤è€…å åŠ ï¼šä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°æ˜¯å‡½æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå‡½æ•°ã€‚ ç¤ºä¾‹ï¼š\ndef stringSafeOp(s: String, f: String =\u0026gt; String) = { if ( s != null) f(s) else s } //stringSafeOp: (s: String, f: String =\u0026gt; String)String def reverse(s: String) = s.reverse //reverse: (s: String)String stringSafeOp(\u0026#34;Ready\u0026#34;, reverse) //res86: String = ydaeR å‡½æ•°å­—é¢é‡ function literalï¼Œå…¶ä»–åå­—ï¼šåŒ¿åå‡½æ•°ã€Lambdaè¡¨è¾¾å¼ç­‰ã€‚ å‡½æ•°å­—é¢é‡å¯ä»¥å­˜å‚¨åœ¨å‡½æ•°å€¼å’Œå˜é‡ä¸­ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥å®šä¹‰ä¸ºé«˜é˜¶å‡½æ•°è°ƒç”¨çš„ä¸€éƒ¨åˆ†ã€‚åœ¨ä»»ä½•æ¥å—å‡½æ•°ç±»å‹çš„åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨å‡½æ•°å­—é¢é‡ã€‚\nreverseçš„å‡½æ•°å­—é¢é‡å®šä¹‰ï¼š\nval reverse = (s:String) =\u0026gt; s.reverse (s:String) =\u0026gt; s.reverseå®šä¹‰äº†ä¸€ä¸ªæœ‰ç±»å‹çš„è¾“å…¥å‚æ•°ï¼ˆs:Stringï¼‰å’Œå‡½æ•°ä½“ï¼ˆs.reverseï¼‰ã€‚\nå®šä¹‰ä¸ºé«˜é˜¶å‡½æ•°è°ƒç”¨çš„ä¸€éƒ¨åˆ†ï¼š\nstringSafeOp(\u0026#34;Ready\u0026#34;, (s:String) =\u0026gt; s.reverse) ç”±äºå·²ç»å®šä¹‰äº†å‚æ•°fçš„ç±»å‹String =\u0026gt; Stringï¼Œå¯ä»¥ä»å‡½æ•°å­—é¢é‡ä¸­åˆ é™¤æ˜¾ç¤ºç±»å‹ï¼Œäº¤ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼å…¶ç±»å‹ã€‚\nstringSafeOp(\u0026#34;Ready\u0026#34;, s =\u0026gt; s.reverse) å ä½ç¬¦è¯­æ³• Placeholder syntaxæ˜¯å‡½æ•°å­—é¢é‡çš„ä¸€ç§ç¼©å†™å½¢å¼ï¼Œå°†å‘½åå‚æ•°æ›¿æ¢ä¸ºé€šé…ç¬¦ï¼ˆ_ï¼‰ã€‚\nä½¿ç”¨æ¡ä»¶ï¼š\nå‡½æ•°çš„æ˜¾ç¤ºç±»å‹åœ¨å­—é¢é‡ä¹‹å¤–æŒ‡å®š\nå‚æ•°æœ€å¤šåªä½¿ç”¨ä¸€æ¬¡\nå‰é¢çš„ä¾‹å­æ­£å¥½ç¬¦åˆæ¡ä»¶ï¼š\nstringSafeOpå®šä¹‰ä¸­æŒ‡å®šäº†å­—é¢é‡çš„ç±»å‹ï¼ˆå­—é¢é‡ä¹‹å¤–ï¼‰ String =\u0026gt; String\nå‚æ•°såªä½¿ç”¨ä¸€æ¬¡ s.reverse\nstringSafeOp(\u0026#34;Ready\u0026#34;, _.reverse) å‚æ•°ç»„ parameter groups å‡½æ•°çš„å‚æ•°åˆ—è¡¨çš„å¦ä¸€ç§å½¢å¼ï¼šåˆ†è§£å¹¶ä½¿ç”¨å°æ‹¬å·åˆ†éš”ã€‚\nstringSafeOpçš„å‚æ•°ç»„è¡¨ç¤ºï¼š\ndef stringSafeOp(s: String)(f: String =\u0026gt; String) = { if ( s != null) f(s) else s } //stringSafeOp: (s: String)(f: String =\u0026gt; String)String ç”¨å‡½æ•°å­—é¢é‡å—è°ƒç”¨é«˜é˜¶å‡½æ•° ç»„åˆä¸Šé¢çš„ç‰¹æ€§ï¼Œå°±æœ‰äº†ç”¨å‡½æ•°å­—é¢é‡å—è°ƒç”¨é«˜é˜¶å‡½æ•°ã€‚\nval newStringSafeOp = stringSafeOp(\u0026#34;Ready\u0026#34;){_.reverse} è¿›é˜¶ def timer[A](f: =\u0026gt; A) = { def now = System.currentTimeMillis val start = now; val a = f; val end = now println(s\u0026#34;Executed int ${end - start} ms\u0026#34;) a } val veryRandomAmount = timer { util.Random.setSeed(System.currentTimeMillis) for (i \u0026lt;- 1 to 100000) util.Random.nextDouble util.Random.nextDouble } timeræ–¹æ³•å¯¹æ–¹æ³•è°ƒç”¨è¿›è¡Œæ—¶é—´è®°å½•ï¼Œå¯¹ç›®æ ‡ä»£ç æ²¡æœ‰ä¾µå…¥æ€§ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/call-high-order-function-in-function-literal/","tags":["Java"],"title":"Scalaç¬”è®°ï¼šç”¨å‡½æ•°å­—é¢é‡å—è°ƒç”¨é«˜é˜¶å‡½æ•°"},{"categories":["ç¬”è®°"],"contents":"åœ¨ç½‘ä¸Šæœç´¢GreenPlumï¼ˆGPDBï¼‰çš„æ•°æ®æºé…ç½®çš„æ—¶å€™ï¼Œå‘ç°æœç´¢ç»“æœéƒ½æ˜¯ç”¨postgresqlçš„é…ç½®ã€‚\nimport com.mchange.v2.c3p0.DataSources; import javax.sql.DataSource; import java.sql.*; import java.util.Properties; /** * Created by addo on 2017/4/10. */ public class JDBCTest { private static String POSTGRESQL_URL = \u0026#34;jdbc:postgresql://192.168.56.101:5432/example\u0026#34;; private static String POSTGRESQL_USERNAME = \u0026#34;dbuser\u0026#34;; private static String POSTGRESQL_PASSWORD = \u0026#34;password\u0026#34;; private static String GPDB_URL = \u0026#34;jdbc:pivotal:greenplum://192.168.56.101:5432;DatabaseName=test\u0026#34;; private static String GPDB_USERNAME = \u0026#34;dbuser\u0026#34;; private static String GPDB_PASSWORD = \u0026#34;password\u0026#34;; /** * Postgresql Connection * * @return * @throws ClassNotFoundException * @throws SQLException */ public static Connection postgresqlConnection() throws ClassNotFoundException, SQLException { Class.forName(\u0026#34;org.postgresql.Driver\u0026#34;); return DriverManager.getConnection(POSTGRESQL_URL, POSTGRESQL_USERNAME, POSTGRESQL_PASSWORD); } /** * GreenPlum Connection * * @return * @throws ClassNotFoundException * @throws SQLException */ public static Connection gpdbConnection() throws ClassNotFoundException, SQLException { Class.forName(\u0026#34;com.pivotal.jdbc.GreenplumDriver\u0026#34;); return DriverManager.getConnection(GPDB_URL, GPDB_USERNAME, GPDB_PASSWORD); } /** * GreenPlud C3P0 Datasource Connection * * @return * @throws SQLException */ public static Connection gpdbC3P0Connection() throws SQLException { Properties c3p0Props = new Properties(); c3p0Props.setProperty(\u0026#34;driverClass\u0026#34;, \u0026#34;com.pivotal.jdbc.GreenplumDriver\u0026#34;); c3p0Props.setProperty(\u0026#34;jdbcUrl\u0026#34;, GPDB_URL); c3p0Props.setProperty(\u0026#34;user\u0026#34;, GPDB_USERNAME); c3p0Props.setProperty(\u0026#34;password\u0026#34;, GPDB_PASSWORD); c3p0Props.setProperty(\u0026#34;acquireIncrement\u0026#34;, \u0026#34;5\u0026#34;); c3p0Props.setProperty(\u0026#34;initialPoolSize1\u0026#34;, \u0026#34;1\u0026#34;); c3p0Props.setProperty(\u0026#34;maxIdleTime\u0026#34;, \u0026#34;60\u0026#34;); c3p0Props.setProperty(\u0026#34;maxPoolSize\u0026#34;, \u0026#34;50\u0026#34;); c3p0Props.setProperty(\u0026#34;minPoolSize\u0026#34;, \u0026#34;1\u0026#34;); c3p0Props.setProperty(\u0026#34;idleConnectionTestPeriod\u0026#34;, \u0026#34;60\u0026#34;); return DataSources.unpooledDataSource(GPDB_URL, c3p0Props).getConnection(); } public static void main(String[] args) throws ClassNotFoundException, SQLException { Connection[] connections = new Connection[]{postgresqlConnection(), gpdbConnection(), gpdbC3P0Connection()}; for (Connection connection : connections) { CallableStatement callableStatement = connection.prepareCall(\u0026#34;select * from user\u0026#34;); boolean execute = callableStatement.execute(); ResultSet resultSet = callableStatement.getResultSet(); while (resultSet.next()) { System.out.println(resultSet.getString(\u0026#34;current_user\u0026#34;)); } callableStatement.close(); connection.close(); } } } æºä»£ç \n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/greenplum-jdbc-and-c3p0-datasource/","tags":["Java"],"title":"GreenPlum JDBCå’ŒC3P0æ•°æ®æº"},{"categories":["ç¬”è®°"],"contents":"å…ˆè¯´åŸç†ï¼š valä¿®é¥°çš„åœ¨å®šä¹‰çš„æ—¶å€™æ‰§è¡Œ\ndefä¿®é¥°çš„åœ¨è°ƒç”¨çš„æ—¶å€™æ‰§è¡Œ\nç›´è§‚çš„ä¾‹å­ï¼š //æ³¨é‡Šçš„è¡Œä¸ºREPLè¾“å‡º def test: () =\u0026gt; Int = { println(\u0026#34;def called\u0026#34;) val r = util.Random.nextInt () =\u0026gt; r } //test: () =\u0026gt; Int test() //def called //res82: Int = -950077410 test() //def called //res83: Int = 1027028032 val test: () =\u0026gt; Int = { println(\u0026#34;def called\u0026#34;) val r = util.Random.nextInt () =\u0026gt; r } //def called //test: () =\u0026gt; Int = $$Lambda$1382/338526071@42f2515d test() //res84: Int = 300588352 test() //res84: Int = 300588352 defåœ¨æ–¹æ³•å®šä¹‰çš„æ—¶å€™é™¤äº†æ–°çš„æ–¹æ³•æ²¡æœ‰ä»»ä½•è¾“å‡ºï¼›ä¹‹åæ¯æ¬¡è°ƒç”¨çš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œè€Œä¸”æ˜¯æ¯æ¬¡è°ƒç”¨éƒ½è·å¾—ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼ˆrandomå€¼ä¸åŒï¼‰\nvalåœ¨æ–¹æ³•å®šä¹‰çš„æ—¶å€™é™¤äº†æ–°çš„æ–¹æ³•ï¼Œè¿˜ä¼šæ‰§è¡Œå¹¶è·å¾—ä¸€ä¸ªæ–¹æ³•ï¼›ä¹‹åæ¯æ¬¡è°ƒç”¨éƒ½åªæ˜¯æ‰§è¡Œäº†å®šä¹‰çš„æ—¶å€™è·å¾—çš„æ–¹æ³•ï¼ˆ() =\u0026gt; rï¼Œrå€¼å›ºå®šï¼‰\nè¿›é˜¶ def timer[A](f: =\u0026gt; A) = { def now = System.currentTimeMillis val start = now; val a = f; val end = now println(s\u0026#34;Executed int ${end - start} ms\u0026#34;) a } val veryRandomAmount = timer { util.Random.setSeed(System.currentTimeMillis) for (i \u0026lt;- 1 to 100000) util.Random.nextDouble util.Random.nextDouble } çœ‹è¿‡ä¸Šé¢çš„ä¾‹å­å°±ä¸éš¾ç†è§£äº†ï¼Œé‡æ–°å®šä¹‰nowæ˜¯ä¸ºäº†ä½¿ç”¨ç®€æ´ä¼˜é›…çš„æ–¹å¼è·å–å½“å‰æ¯«ç§’æ•°ã€‚\nval start = now; ç”¨valä¿®é¥°ï¼Œè®°å½•æ–¹æ³•æ‰§è¡Œå‰çš„æ—¶é—´åˆ°startä¸­ã€‚ val a = f ç”¨valä¿®é¥°ï¼Œæ‰§è¡Œfæ–¹æ³•ï¼Œå¹¶ä¿å­˜æ•°æ®åˆ°aä¸­ã€‚ val end = now ç”¨vlaä¿®é¥°ï¼Œè®°å½•æ–¹æ³•æ‰§è¡Œç»“æŸæ—¶é—´åˆ°endä¸­ã€‚ æœ€åè¿”å›aï¼Œ ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/def-vs-val-in-scala/","tags":["Java"],"title":"Scalaç¬”è®°ï¼šdef VS val"},{"categories":["ç¬”è®°"],"contents":"ç‰ˆæœ¬ Centos7\nRedis3.2.8\nç¼–è¯‘å®‰è£… wget http://download.redis.io/releases/redis-3.2.8.tar.gz tar -zxvf redis-3.2.8.tar.gz cd redis-3.2.8 sudo make test sudo make install å¯åŠ¨ redis-server é—®é¢˜ /bin/sh: cc: command not found\n**åŸå› ï¼š**Centoså®‰è£…æ—¶é€‰æ‹©çš„ç±»å‹æ˜¯Infrastructureï¼Œæ²¡æœ‰c++çš„ç¼–è¯‘å·¥å…·ã€‚\nè§£å†³ï¼šsudo yum -y install gcc gcc-c++ libstdc++-devel\nmalloc.h:50:31: fatal error: jemalloc/jemalloc.h: No such file or directory\n**åŸå› ï¼š**Redisä½¿ç”¨çš„é»˜è®¤çš„memory allocatoræ˜¯libcï¼Œè€ŒLinuxç³»ç»Ÿä¸­é»˜è®¤çš„æ˜¯jemallocï¼Œéœ€è¦åˆ¶åŠ¨MALLOCå˜é‡ã€‚\nè§£å†³ï¼šsudo make MALLOC=libc install\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/install-redis-on-centos/","tags":["DevOps","Linux"],"title":"Centos ç¼–è¯‘å®‰è£… Redis"},{"categories":["ç¬”è®°"],"contents":"ç‰ˆæœ¬ Centos7\nPostgresql9.2\nEnable ssh service sshd start\nOpen firewall for 22 firewall-cmd â€”state\nfirewall-cmd â€”list-all\nfirewall-cmd â€”permanent â€”zone=public â€”add-port=22/tcp\nfirewall-cmd â€”reload\nInstall Postgresql yum install postgres\nsu postgres\npostgres â€”version\né»˜è®¤ä¼šåˆ›å»ºpostgres:postgresç”¨æˆ·å’Œç»„\nåˆ‡æ¢ç”¨æˆ· su - postgres\nåˆå§‹åŒ–æ•°æ®åº“ é€šè¿‡æŒ‡å®šæ•°æ®æ–‡ä»¶ç›®å½•åˆå§‹åŒ–db\ninitdb -D /var/lib/pgsql/data\nä¿®æ”¹ç«¯å£é˜²ç«å¢™ é»˜è®¤ç«¯å£æ˜¯5432ï¼Œéœ€è¦åœ¨é˜²ç«å¢™ä¸­æ‰“å¼€ç«¯å£\nfirewall-cmd \u0026ndash;permanent \u0026ndash;zone=public \u0026ndash;add-port=5432/tcp\nä¿®æ”¹ç›‘å¬çš„ip éœ€è¦å¤–éƒ¨è®¿é—®çš„è¯ï¼Œéœ€è¦ä¿®æ”¹postgresql.confä¸­çš„ç›‘å¬ipï¼Œ\u0026lsquo;0.0.0.0\u0026rsquo;å…è®¸æ‰€æœ‰ipv4çš„ipè®¿é—®ï¼Œ\u0026rsquo;\u0026rsquo;::\u0026lsquo;\u0026lsquo;å…è®¸æ‰€æœ‰ipv6çš„ipè®¿é—®\nlisten_addresses = \u0026ldquo;0.0.0.0\u0026rdquo;\nä¿®æ”¹éœ€è¦é‡å¯postgresql\nå¯åŠ¨ postgres -D /var/lib/pgsql/data \u0026gt;logfile 2\u0026gt;\u0026amp;1 \u0026amp;\nç™»å½•æ§åˆ¶å° ä¼šä½¿ç”¨å½“å‰ç³»ç»Ÿç”¨æˆ·postgresè®¿é—®ï¼Œç³»ç»Ÿæç¤ºç¬¦ä¼šå˜æˆ\u0026rsquo;postgres=#\u0026rsquo;\npsql\nä¿®æ”¹å¯†ç \n\\password postgres\nåˆ›å»ºç”¨æˆ·\nCREATE USER dbuser WITH PASSWORD \u0026lsquo;password\u0026rsquo;;\nCREATE DATABASE example OWNER dbuser;\nGRANT ALL PRIVILEGES ON DATABASE example to dbuser;\nå®¢æˆ·ç«¯æƒé™é…ç½®æ–‡ä»¶ é»˜è®¤åªå…è®¸æœ¬åœ°å®¢æˆ·ç«¯è¿æ¥ï¼Œéœ€è¦ä¿®æ”¹pg_hba.confæ–‡ä»¶ï¼Œ\nhost all all 127.0.0.1/32 trust\næ”¹ä¸º\nhost all all 0.0.0.0 /0 trust\nå®¢æˆ·ç«¯è¿æ¥ psql -U dbuser -d example -h 127.0.0.1 -p 5432\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/install-postgresql-on-centos/","tags":["DevOps","Linux"],"title":"Centos ä¸Šå®‰è£… Postgresql"},{"categories":["ç¬”è®°"],"contents":"æœ€è¿‘Redisçš„ä½¿ç”¨ä¸­ç”¨çš„åˆ°keyå¯èƒ½æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯Redisçš„å®˜æ–¹æ–‡æ¡£æ²¡æåˆ°keyé•¿åº¦å¯¹æ€§èƒ½çš„å½±å“ï¼Œæ•…ç®€å•åšäº†ä¸ªæµ‹è¯•ã€‚\nç¯å¢ƒ Rediså’Œæµ‹è¯•ç¨‹åºéƒ½æ˜¯è¿è¡Œåœ¨æœ¬åœ°ï¼Œä¸çœ‹å•æ¬¡çš„æ€§èƒ½ï¼Œåªçœ‹ä¸åŒçš„é•¿åº¦å †è¯»å†™æ€§èƒ½çš„å½±å“ã€‚\næµ‹è¯•æ–¹æ³• ä½¿ç”¨é•¿åº¦åˆ†åˆ«ä¸º10, 100, 500, 1000, 2500, 5000, 7500, 10,000, and 20,000çš„keyï¼Œvalueé•¿åº¦1000ï¼Œè¯»å†™1000æ¬¡ã€‚\nç»“æœ ä»ç»“æœæ¥çœ‹éšç€é•¿åº¦çš„å¢åŠ ï¼Œè¯»å†™çš„è€—æ—¶éƒ½éšä¹‹å¢åŠ ã€‚\né•¿åº¦ä¸º10ï¼šå†™å¹³å‡è€—æ—¶0.053msï¼Œè¯»0.040ms é•¿åº¦ä¸º20000ï¼šå†™å¹³å‡è€—æ—¶0.352msï¼Œè¯»0.084ms æµ‹è¯•ä»£ç  æºç \n/** * Created by addo on 2017/3/16. */ public class RedisTest { private static String[] keys = new String[1000]; private static String randomString(int length) { Random random = new Random(); char[] chars = \u0026#34;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\u0026#34;.toCharArray(); StringBuilder key = new StringBuilder(length); int i = length; while (i \u0026gt; 0) { key.append(chars[random.nextInt(chars.length)]); i--; } return key.toString(); } private static void write(Jedis jedis, int length) { long start = System.currentTimeMillis(); String key = null; String value = null; for (int i = 0; i \u0026lt; 1000; i++) { key = randomString(length); keys[i] = key; value = randomString(1000); jedis.set(key, value); } System.out.println(String.format(\u0026#34;put key length %d with value length 1000 in 1000 tims costs: %d ms\u0026#34;, length, System.currentTimeMillis() - start)); } private static void read(Jedis jedis, int length) { long start = System.currentTimeMillis(); for (int i = 0; i \u0026lt; keys.length; i++) { jedis.get(keys[i]); } System.out.println(String.format(\u0026#34;get key length %d with value length 1000 in 1000 tims costs: %d ms\u0026#34;, length, System.currentTimeMillis() - start)); } public static void main(String[] args) throws InterruptedException { Jedis jedis = new Jedis(\u0026#34;localhost\u0026#34;, 6379); int[] lengths = {10, 100, 500, 1000, 2500, 5000, 7500, 10000, 20000}; for (int i = 0; i \u0026lt; lengths.length; i++) { write(jedis, lengths[i]); read(jedis, lengths[i]); keys = new String[1000]; jedis.flushAll(); } System.out.println(); } } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/redis-performance-key-length/","tags":["Java"],"title":"Keyé•¿åº¦å¯¹Redisæ€§èƒ½å½±å“"},{"categories":["ç¬”è®°"],"contents":"å…¶å®æ ‡é¢˜æˆ‘æƒ³ç”¨ã€Šä¸ºä»€ä¹ˆforeachè¾¹å¾ªç¯è¾¹ç§»é™¤å…ƒç´ è¦ç”¨Iteratorï¼Ÿã€‹å¯æ˜¯å¤ªé•¿ã€‚\nä¸ç”¨Iteratorï¼Œç”¨Collection.remove()ï¼Œä¼šæŠ¥ConcurrentModificationExceptioné”™è¯¯ã€‚\nfor(Integer i : list) { list.remove(i); //Throw ConcurrentModificationException } å…¶å®ä½¿ç”¨foreachçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªIteratoræ¥éå†listã€‚ä¸åªæ˜¯removeï¼Œä½¿ç”¨addã€clearç­‰æ–¹æ³•ä¸€æ ·ä¼šå‡ºé”™ã€‚\næ‹¿ArrayListæ¥è¯´ï¼Œå®ƒæœ‰ä¸€ä¸ªç§æœ‰çš„Iteratoræ¥å£çš„å†…éƒ¨ç±»Itrï¼š\nprivate class Itr implements Iterator\u0026lt;E\u0026gt; { int cursor; // index of next element to return int lastRet = -1; // index of last element returned; -1 if no such int expectedModCount = modCount; //sevrval methods } ä½¿ç”¨Iteratoræ¥éå†ArrayListå®é™…ä¸Šæ˜¯é€šè¿‡ä¸¤ä¸ªæŒ‡é’ˆæ¥éå†ArrayListåº•å±‚çš„æ•°ç»„ï¼šcursoræ˜¯ä¸‹ä¸€ä¸ªè¿”å›çš„å…ƒç´ åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡ï¼›lastRetæ˜¯ä¸Šä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡ã€‚è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„expectedModCountä½¿ç”¨çš„æ˜¯ArrayListçš„modCountçš„ï¼ˆmodCountå…·ä½“æ˜¯ä»€ä¹ˆæ„æ€ä¸‹æ–‡ä¼šæåˆ°ï¼‰ã€‚\nä»Itrçš„å®ç°æ¥çœ‹ï¼Œæœ‰ä¸‰ç§æƒ…å†µä¼šæŠ›å‡ºConcurrentModificationExceptionï¼š\ncursorè¶…å‡ºäº†æ•°ç»„çš„æœ€å¤§ä¸‹æ ‡ expectedModCountä¸ç­‰äºmodCount åˆ é™¤å…ƒç´ æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ArrayListçš„removeæ–¹æ³•ï¼Œæ­¤æ–¹æ³•å¯èƒ½ä¼šæŠ›å‡ºIndexOutOfBoundsException expectedModCountä¸ç­‰äºmodCount å¼€å¤´æ‰€è¯´çš„é—®é¢˜æ­£æ˜¯æ˜¯ç¬¬äºŒç§æƒ…å†µä¸‹å‡ºç°çš„ã€‚modCountç®€å•è¯´è®°å½•äº†Collectionè¢«ä¿®æ”¹çš„æ¬¡æ•°ï¼šæ·»åŠ æˆ–è€…åˆ é™¤å…ƒç´ ã€‚\nå‡å¦‚åœ¨foreachå¾ªç¯ä¸­åˆ é™¤å…ƒç´ ï¼Œä¸”æ­¤æ—¶modCountç­‰2ï¼š\nå¾ªç¯å¼€å§‹åˆ›å»ºæ–°Itrå®ä¾‹ï¼ŒexpectedModCount=modCount=2 ä½¿ç”¨ArrayList.remove()åˆ é™¤å…ƒç´ ï¼ŒmodCountåŠ 1 ç»§ç»­è°ƒç”¨next()æ–¹æ³•æŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œæ­¤æ—¶æ£€æŸ¥expectedModCountæ˜¯å¦ç­‰äºmodCountï¼Œä¸ç­‰åˆ™æŠ›ConcurrentModificationException public E next() { checkForComodification(); int i = cursor; if (i \u0026gt;= size) throw new NoSuchElementException(); Object[] elementData = ArrayList.this.elementData; if (i \u0026gt;= elementData.length) throw new ConcurrentModificationException(); cursor = i + 1; return (E) elementData[lastRet = i]; } final void checkForComodification() { if (modCount != expectedModCount) throw new ConcurrentModificationException(); } ä¸Šé¢æåˆ°Iteratorçš„å®ç°ä¸­åˆ é™¤å…ƒç´ å®é™…è°ƒç”¨çš„è¿˜æ˜¯ArrayList.remove()æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆä¸ä¼šæŠ›é”™ï¼Ÿ\nItrçš„removeæ–¹æ³•åœ¨è°ƒç”¨ArrayList.remove()ä¹‹åï¼Œä¼šæ›´æ–°expectedModCountã€‚\npublic void remove() { if (lastRet \u0026lt; 0) throw new IllegalStateException(); checkForComodification(); try { ArrayList.this.remove(lastRet); cursor = lastRet; lastRet = -1; expectedModCount = modCount; } catch (IndexOutOfBoundsException ex) { throw new ConcurrentModificationException(); } } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/remove-element-while-looping-collection/","tags":["Java"],"title":"éå† Collection æ—¶åˆ é™¤å…ƒç´ "},{"categories":["ç¬”è®°"],"contents":"volatileé€šè¿‡ä¿è¯å¯¹å˜é‡çš„è¯»æˆ–å†™éƒ½æ˜¯ç›´æ¥ä»å†…å­˜ä¸­è¯»å–æˆ–ç›´æ¥å†™å…¥å†…å­˜ä¸­ï¼Œä¿è¯äº†å¯è§æ€§ï¼›ä½†æ˜¯volatileå¹¶ä¸è¶³ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå› ä¸ºæ— æ³•ä¿è¯åŸå­æ€§ï¼Œå¦‚count++æ“ä½œï¼š\nå°†å€¼ä»å†…å­˜è¯»å…¥å¯„å­˜å™¨ä¸­ è¿›è¡ŒåŠ 1æ“ä½œï¼Œå†…å­˜ä¿å­˜åˆ°å¯„å­˜å™¨ä¸­ ç»“æœä»å¯„å­˜å™¨flushåˆ°å†…å­˜ä¸­ å€Ÿç”¨ä¸€å¼ å›¾æ¥çœ‹ï¼š\nä¸æ˜¯volatileçš„å˜é‡çš„æŒ‡ä»¤æ‰§è¡Œé¡ºåºæ˜¯1-\u0026gt;2-\u0026gt;3ï¼›è€Œå£°æ˜ä¸ºvolatileçš„å˜é‡ï¼Œé¡ºåºæ˜¯1-\u0026gt;23ã€‚ä»è¿™é‡Œçœ‹ï¼Œvolatileä¿è¯äº†ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†volatileä¿®é¥°çš„å˜é‡ï¼Œå˜åŒ–ä¼šé©¬ä¸Šä½“ç°åœ¨å†…å­˜ä¸­ã€‚çº¿ç¨‹é—´çœ‹åˆ°çš„å€¼æ˜¯ä¸€æ ·çš„ã€‚\nä¸Šé¢è¯´äº†æ— æ³•ä¿è¯åŸå­æ€§æ˜¯æŒ‡ï¼šå¤šæ ¸cpuï¼Œçº¿ç¨‹Aæ‰§è¡Œäº†æŒ‡ä»¤1ï¼Œçº¿ç¨‹Bä¹Ÿæ‰§è¡Œäº†æŒ‡ä»¤1ã€‚Aè¿›è¡Œäº†åŠ 1æ“ä½œï¼Œç»“æœå†™å…¥å¯„å­˜å™¨åŒæ—¶flushåˆ°å†…å­˜ï¼›éšåBä¹Ÿæ‰§è¡Œäº†åŒæ ·çš„æ“ä½œã€‚countæœ¬æ¥åº”è¯¥çš„ç»“æœæ˜¯åŠ 2ï¼Œä½†æ˜¯å´åªåŠ äº†1ã€‚åŸå› å°±æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€æŒ‡çš„è¯»å’Œå†™ä¸æ˜¯åŸå­æ“ä½œã€‚æˆ‘ä»¬æœ€å¸Œæœ›çœ‹åˆ°çš„æ˜¯123åŒæ—¶æ‰§è¡Œï¼Œæ‰‹æ®µå°±æ˜¯sychronizedæˆ–è€…java.util.concurrentåŒ…ä¸­çš„åŸå­æ•°æ®ç±»å‹ã€‚\nç®€å•æ‹¿AtomicIntegeræ¥çœ‹ï¼Œå…¶ä¸­çš„ä¸€ä¸ªintç±»å‹çš„valueå­—æ®µå£°æ˜ä¸ºvolatileï¼Œä¿è¯äº†123åŒæ—¶æ‰§è¡Œã€‚\nå‚è€ƒï¼šJava Volatile\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/deep-in-java-volatile-keywork/","tags":["Java"],"title":"Java Volatileå…³é”®å­—"},{"categories":["ç¬”è®°"],"contents":"Haproxyä¸ºå¤šä¸ªåŸŸåé…ç½®SSL\nç”Ÿæˆè‡ªç­¾åè¯ä¹¦ sudo mkdir /etc/ssl/atbug.com sudo openssl genrsa -out /etc/ssl/atbug.com/atbug.com.key 1024 sudo openssl req -new -key /etc/ssl/atbug.com/atbug.com.key -out /etc/ssl/atbug.com/atbug.com.csr sudo openssl x509 -req -days 365 -in /etc/ssl/atbug.com/atbug.com.csr -singkey /etc/ssl/atbug.com/atbug.com.key -out /etc/ssl/atbug.com/atbug.com.crt sudo openssl x509 -req -days 365 -in /etc/ssl/atbug.com/atbug.com.csr -signkey /etc/ssl/atbug.com/atbug.com.key -out /etc/ssl/atbug.com/atbug.com.crt sudo cat /etc/ssl/atbug.com/atbug.com.crt /etc/ssl/atbug.com/atbug.com.key | sudo tee /etc/ssl/atbug.com/atbug.com.pem Haproxyé…ç½® frontend https bind *:443 ssl crt /etc/ssl/atbug.com/atbug.com.pem option tcplog mode http #option forwardfor ###atbug-https acl atbug-https hdr_beg(host) -i test.atbug.com use_backend rome-atbug-https-backend if atbug-https backend rome-atbug-https-backend balance roundrobin mode http option ssl-hello-chk server node-1 ip:port cookie dw2-vm-test-apps003 check inter 2000 rise 3 fall 3 weight 50 ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/haproxy-multi-host-with-ssl/","tags":["DevOps"],"title":"Haproxyè™šæ‹Ÿä¸»æœºSSL"},{"categories":["ç¬”è®°"],"contents":"è¿™æ˜¯å·¥ä½œä¸­é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼šæµ‹è¯•ç¯å¢ƒéƒ¨ç½²å‡ºé”™ï¼ŒæŠ¥äº†ä¸‹é¢çš„é—®é¢˜ã€‚\nCaused by: java.lang.IllegalArgumentException: Result Maps collection already contains value for xxx.xxx.xxxRepository.BaseResultMap at org.apache.ibatis.session.Configuration$StrictMap.put(Configuration.java:802) at org.apache.ibatis.session.Configuration$StrictMap.put(Configuration.java:774) at org.apache.ibatis.session.Configuration.addResultMap(Configuration.java:556) at org.apache.ibatis.builder.MapperBuilderAssistant.addResultMap(MapperBuilderAssistant.java:217) at org.apache.ibatis.builder.ResultMapResolver.resolve(ResultMapResolver.java:47) at org.apache.ibatis.builder.xml.XMLMapperBuilder.resultMapElement(XMLMapperBuilder.java:285) at org.apache.ibatis.builder.xml.XMLMapperBuilder.resultMapElement(XMLMapperBuilder.java:252) at org.apache.ibatis.builder.xml.XMLMapperBuilder.resultMapElements(XMLMapperBuilder.java:244) at org.apache.ibatis.builder.xml.XMLMapperBuilder.configurationElement(XMLMapperBuilder.java:116) æ£€æŸ¥äº†å¯¹åº”çš„mapperæ–‡ä»¶å’Œjavaæ–‡ä»¶ï¼Œå·²ç»8ä¸ªå¤šæœˆæ²¡æœ‰ä¿®æ”¹è¿‡äº†ã€‚ä¹Ÿæ£€æŸ¥äº†å†…å®¹ï¼Œæ²¡æœ‰å‘ç°é‡å¤çš„BaseResultMapï¼›selectä¸­ä¹ŸresultMapçš„å¼•ç”¨ä¹Ÿéƒ½æ­£ç¡®ã€‚\nå…¶å®åˆ°æœ€åå‘ç°è·Ÿä»£ç ä¸€ä¸ç‚¹å…³ç³»éƒ½æ²¡æœ‰ï¼Œæ˜¯éƒ¨ç½²çš„æ—¶å€™æ²¡æœ‰åˆ é™¤æ—§ç‰ˆæœ¬çš„ä»£ç å¯¼è‡´ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„jaråŒæ—¶å­˜åœ¨ï¼Œç›¸åº”çš„mapperæ–‡ä»¶ä¹Ÿæœ‰ä¸¤ä¸ªã€‚\nçœ‹äº†ä¸‹æºç ï¼Œmybatisåœ¨åˆ›å»ºSessionFactoryBeanè§£æxmlæ—¶å€™ï¼Œä¼šæŠŠxmlä¸­çš„resultMapæ”¾å…¥åˆ°ä¸€ä¸ªHashMapçš„å­ç±»StrictMapä¸­ï¼Œkeyæ˜¯mapperçš„namespaceä¸resultmapçš„idæ‹¼æ¥æˆçš„ã€‚\nStrictMapåœ¨putå…ƒç´ çš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥mapä¸­æ˜¯å¦å·²å­˜åœ¨keyã€‚\npublic void addResultMap(ResultMap rm) { resultMaps.put(rm.getId(), rm); checkLocallyForDiscriminatedNestedResultMaps(rm); checkGloballyForDiscriminatedNestedResultMaps(rm); } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/duplicate-resultmap-in-mybatis-mapper/","tags":["Java"],"title":"mybatisæŠ¥é”™â€œResult Maps collection already contains value for ***â€"},{"categories":["ç¬”è®°"],"contents":"è¿™æ˜¯å®é™…ä½¿ç”¨æ—¶é‡åˆ°çš„é—®é¢˜ï¼škafka apiçš„ç‰ˆæœ¬æ˜¯0.10ï¼Œå‘ç°æœ‰é‡å¤æ¶ˆè´¹é—®é¢˜ï¼›æ£€æŸ¥logåå‘ç°åœ¨commit offsetçš„æ—¶å€™å‘ç”Ÿè¶…æ—¶ã€‚\nAuto offset commit failed for group test: Commit cannot be completed since the group has already rebalanced and assigned the partitions to another member. This means that the time between subsequent calls to poll() was longer than the configured session.timeout.ms, which typically implies that the poll loop is spending too much time message processing. You can address this either by increasing the session timeout or by reducing the maximum size of batches returned in poll() with max.poll.records. 15:12:12.364 [main] WARN o.a.k.c.c.i.ConsumerCoordinator - Auto offset commit failed for group test: Commit offsets failed with retriable exception. You should retry committing offsets. çœ‹äº†Kafkaçš„APIæ–‡æ¡£ï¼Œå‘ç°0.10ä¸­æä¾›äº†æ–°çš„é…ç½®max.poll.recordsï¼š\nThe maximum number of records returned in a single call to poll(). type: int default: 2147483647 å¦‚æœç”Ÿäº§ç«¯å†™å…¥å¾ˆå¿«ï¼Œæ¶ˆè´¹ç«¯å¤„ç†è€—æ—¶ã€‚ä¸€ä¸ªbatchçš„å¤„ç†æ—¶é—´å¤§äºsession.timeout.msï¼Œä¼šå¯¼è‡´session time outï¼Œå¼•èµ·offset commitå¤±è´¥ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/offset-be-reset-when-consuming/","tags":["Kafka","Java"],"title":"æ¶ˆè´¹æ—¶offsetè¢«é‡ç½®å¯¼è‡´é‡å¤æ¶ˆè´¹"},{"categories":["ç¬”è®°"],"contents":"TheadPoolExecutoræºç åˆ†æ ThreadPoolExecutoræ˜¯å¤šçº¿ç¨‹ä¸­ç»å¸¸ç”¨åˆ°çš„ç±»ï¼Œå…¶ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ± æ‰§è¡Œæäº¤çš„ä»»åŠ¡ã€‚\nå®ç° æ²¡æœ‰ç‰¹æ®Šéœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œé€šå¸¸éƒ½æ˜¯ç”¨Executorsç±»çš„é™æ€æ–¹æ³•å¦‚newCachedThreadPollæ¥åˆå§‹åŒ–ThreadPoolExecutorå®ä¾‹ï¼š\npublic static ExecutorService newCachedThreadPool() { return new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS, new SynchronousQueue\u0026lt;Runnable\u0026gt;()); } ä»Executorsçš„æ–¹æ³•å®ç°ä¸­çœ‹å‡ºï¼ŒBlockingQueueä½¿ç”¨çš„SynchronousQueueï¼Œåº•å±‚ä½¿ç”¨äº†æ ˆçš„å®ç°ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªSynchronousQueueæ˜¯æ²¡æœ‰å®¹é‡é™åˆ¶çš„ï¼ŒExecutorsä¹Ÿå°†maximumPoolSizeè®¾ä¸ºInteger.MAX_VALUEã€‚\nThreadPoolExecutorçš„æ„é€ æ–¹æ³•ï¼š\næŒ‰ç…§javadocçš„è§£é‡Šï¼š\ncorePoolSizeæ˜¯æ± ä¸­é—²ç½®çš„æœ€å°çº¿ç¨‹æ•° maximumPoolSizeæ˜¯æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•° keepAliveTimeæ˜¯çº¿ç¨‹æ•°å¤§äºæœ€å°çº¿ç¨‹æ•°æ—¶ï¼Œè¿‡é‡é—²ç½®çº¿ç¨‹çš„æœ€å¤§å­˜æ´»æ—¶é—´ unitæ˜¯ä¸Šé¢å­˜æ´»æ—¶é—´çš„å•ä½ workQueueæ˜¯ç”¨æ¥æš‚æ—¶ä¿å­˜è¿è¡Œå‰çš„ä»»åŠ¡ public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue\u0026lt;Runnable\u0026gt; workQueue) public void execute(Runnable command) { if (command == null) throw new NullPointerException(); int c = ctl.get(); if (workerCountOf(c) \u0026lt; corePoolSize) { if (addWorker(command, true)) return; c = ctl.get(); } if (isRunning(c) \u0026amp;\u0026amp; workQueue.offer(command)) { int recheck = ctl.get(); if (! isRunning(recheck) \u0026amp;\u0026amp; remove(command)) reject(command); else if (workerCountOf(recheck) == 0) addWorker(null, false); } else if (!addWorker(command, false)) reject(command); } é™¤å»ç¬¬ä¸€ä¸ªåšä»»åŠ¡éç©ºæ£€æŸ¥çš„ifã€‚\nç¬¬äºŒä¸ªifï¼Œæ£€æŸ¥å½“å‰ä½¿ç”¨çš„çº¿ç¨‹æ•°æ˜¯å¦è¶…è¿‡corePoolSizeã€‚æœªè¶…è¿‡ï¼Œè°ƒç”¨addWorkerå¹¶æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°ä¸ºtrueã€‚addWorkerä¼šå†æ¬¡æ£€æŸ¥çº¿ç¨‹æ•°æ˜¯å¦è¶…è¿‡corePoolSizeï¼Œå¦‚æœè¿˜æœªè¶…è¿‡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚\nç¬¬ä¸‰ä¸ªifï¼Œå½“ç›®å‰ä½¿ç”¨çš„çº¿ç¨‹æ•°å¤§äºç­‰äºcorePoolSizeï¼Œå°†ä»»åŠ¡ä¿å­˜åˆ°workQueueä¸­ã€‚ä¿å­˜æˆåŠŸï¼Œå†æ¬¡æ£€æŸ¥æ˜¯å¦éœ€è¦å†åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚\næœ€åä¸€ä¸ªelseï¼Œè°ƒç”¨addWorkerå¹¶æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°ä¸ºfalseã€‚åœ¨åˆ›å»ºçº¿ç¨‹å‰ï¼Œæ£€æŸ¥å½“æ—¶çº¿ç¨‹æ•°æ˜¯å¦è¶…è¿‡maximumPoolSizeï¼Œä¸ºè¶…è¿‡åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚\nprivate boolean addWorker(Runnable firstTask, boolean core) { retry: for (;;) { int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs \u0026gt;= SHUTDOWN \u0026amp;\u0026amp; ! (rs == SHUTDOWN \u0026amp;\u0026amp; firstTask == null \u0026amp;\u0026amp; ! workQueue.isEmpty())) return false; for (;;) { int wc = workerCountOf(c); if (wc \u0026gt;= CAPACITY || wc \u0026gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop } } ... } é—®é¢˜ ä¸€èˆ¬åœºæ™¯ä¸‹ï¼Œä¸èƒ½ä½¿ç”¨Integer.MAX_VALUEå¦‚æ­¤å¤§çš„çº¿ç¨‹æ•°ã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨æ„é€ å™¨è‡ªå·±è¿›è¡Œå®ä¾‹åŒ–ã€‚\nå¦‚æŒ‡å®šcorePoolSize=5ã€maximumPoolSize=20\nã€keepAliveTime=60Lã€unit=TimeUnit.SECONDSã€workQueue=new SynchronousQueue()ã€‚\nä½†æ˜¯å®é™…æ‰§è¡Œçš„æ—¶å€™ï¼Œçº¿ç¨‹æ•°ä¸€ç›´æ˜¯5ã€‚\nå›å¤´çœ‹ThreadPoolExecutorçš„å®ç°ï¼Œå¦‚æœæƒ³è¦è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœéœ€è¦ç¨‹åºè¿›å…¥æœ€åçš„é‚£ä¸ªelseã€‚é‚£é‡ç‚¹å°±åœ¨ç¬¬ä¸‰ä¸ªifé‡Œçš„workQueue.offer(command)ã€‚\nçœ‹BlockingQueueæ¥å£ä¸­è¯¥æ–¹æ³•çš„æè¿°ï¼šå°†å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œæ²¡æœ‰è¶…è¿‡å®¹é‡é™åˆ¶åˆ™æ’å…¥å¹¶è¿”å›trueã€‚\nè€Œä½¿ç”¨çš„SynchronousQueueåº•å±‚å®ç°ä½¿ç”¨çš„æ ˆæ²¡æœ‰å®¹é‡é™åˆ¶ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸€ç›´æ˜¯corePoolSizeã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/threadpoolexecutor-sourcecode-analysis/","tags":["Java"],"title":"TheadPoolExecutoræºç åˆ†æ"},{"categories":["ç¬”è®°"],"contents":"\nProduceråˆå§‹åŒ– åˆå§‹åŒ–KafkaProducerå®ä¾‹ï¼ŒåŒæ—¶é€šè¿‡Configæ•°æ®åˆå§‹åŒ–MetaDataã€NetWorkClientã€Accumulatorå’ŒSenderçº¿ç¨‹ã€‚å¯åŠ¨Senderçº¿ç¨‹ã€‚\nMetaDataä¿¡æ¯ è®°å½•Clusterçš„ç›¸å…³ä¿¡æ¯ï¼Œç¬¬ä¸€æ¬¡é“¾æ¥ä½¿ç”¨Configè®¾ç½®ï¼Œä¹‹åä¼šä»è¿œç«¯pollä¿¡æ¯å›æ¥ï¼Œæ¯”å¦‚host.nameç­‰ä¿¡æ¯ã€‚\nAccumulatorå®ä¾‹ AccumulatoræŒæœ‰ä¸€ä¸ªMapå®ä¾‹ï¼Œkeyä¸ºTopicPartitionï¼ˆå°è£…äº†topicå’Œpartitionä¿¡æ¯ï¼‰å¯¹è±¡ï¼ŒValueä¸ºRecordBatchçš„Dequeé›†åˆã€‚\nNetworkClientå®ä¾‹ é€šè¿‡MetaDataä¿¡æ¯åˆå§‹åŒ–NetworkClientå®ä¾‹ï¼ŒNetworkClientä½¿ç”¨NIOæ¨¡å‹ã€‚\nSenderçº¿ç¨‹ senderæŒæœ‰NetworkClientå’ŒAccumulatorå®ä¾‹ï¼Œåœ¨Producerå®ä¾‹åˆå§‹åŒ–å®Œæˆä¹‹åï¼ŒæŒç»­åœ°å°†Accumulatorä¸­çš„Batchæ•°æ®drainåˆ°ä¸€ä¸ªListä¸­ï¼Œè°ƒç”¨NetworkClientè¿›è¡Œå‘é€ã€‚\nå‘é€ è°ƒç”¨Producerå®ä¾‹è¿›è¡Œæ¶ˆæ¯å‘é€ï¼Œé¦–å…ˆå°†æ¶ˆæ¯åºåˆ—åŒ–ä¹‹åè¿½åŠ åˆ°Accumulatorçš„Dequeçš„æœ€åä¸€ä¸ªbatchä¸­ï¼Œä¹‹åå”¤é†’sender-\u0026gt;client-\u0026gt;Selectorè¿›è¡Œæ¶ˆæ¯å‘é€ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/kafka-java-producer-model/","tags":["Java","Kafka"],"title":"Kafka Javaç”Ÿäº§è€…æ¨¡å‹"},{"categories":["ç¬”è®°"],"contents":"æœ€è¿‘æœ‰ä¸ªéœ€æ±‚éœ€è¦ä¸»åŠ¨çš„å»æ¸…ç†éƒ¨åˆ†ç¼“å­˜ï¼Œè€ƒè™‘çš„åŸå­æ€§çš„é—®é¢˜ï¼Œç”¨Luaè„šæœ¬è¿›è¡Œå®ç°ã€‚\nLuaè„šæœ¬\nlocal count = 0 for _,k in ipairs(redis.call(\u0026#39;KEYS\u0026#39;, ARGV[1])) do redis.call(\u0026#39;DEL\u0026#39;, k) count = count + 1 end return count shellè¿è¡Œ\nredis-cli --eval file.lua ,[KEY PATTERN] #sample: æ¸…ç†æ‰€æœ‰keyä»¥Testå¼€å¤´çš„è®°å½• redis-cli --eval clear.lua , Test* Java\nJedis jedis = new Jedis(\u0026#34;127.0.0.1\u0026#34;, 6379); URL resource = Resources.getResource(\u0026#34;META-INF/scripts/clear.lua\u0026#34;); String lua = Resources.toString(resource, Charsets.UTF_8); Object eval = jedis.eval(lua, 0, \u0026#34;Name*\u0026#34;); System.out.println(eval); ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/clean-speicified-keys-in-redis/","tags":["Java"],"title":"Redisæ¸…ç†ç¼“å­˜"},{"categories":["ç¬”è®°"],"contents":"æ¦‚è¿° å½“ä½¿ç”¨Flumeçš„æ—¶å€™ï¼Œæ¯ä¸ªæµç¨‹éƒ½åŒ…å«äº†è¾“å…¥æºã€é€šé“å’Œè¾“å‡ºã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯ä¸€ä¸ªwebæœåŠ¡å™¨å°†äº‹ä»¶é€šè¿‡RPCï¼ˆæ¬å…¥AvroSourceï¼‰å†™å…¥è¾“å…¥æºä¸­ï¼Œè¾“å…¥æºå°†å…¶å†™å…¥MemoryChannelï¼Œæœ€åHDFS Sinkæ¶ˆè´¹äº‹ä»¶å°†å…¶å†™å…¥HDFSä¸­ã€‚\nMemeoryChannelæä¾›äº†é«˜ååé‡ä½†æ˜¯åœ¨ç³»ç»Ÿå´©æºƒæˆ–è€…æ–­ç”µæ—¶ä¼šä¸¢å¤±æ•°æ®ã€‚å› æ­¤éœ€è¦å¼€å‘ä¸€ä¸ªå¯æŒä¹…è¯é€šé“ã€‚FileChannelæ˜¯åœ¨FLUME-1085é‡Œå®ç°çš„ã€‚ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªé«˜å¯ç”¨é«˜ååé‡çš„é€šé“ã€‚FileChannleä¿è¯äº†åœ¨å¤±è¯¯æäº¤ä¹‹åï¼Œåœ¨å´©æºƒæˆ–è€…æ–­ç”µåä¸ä¸¢å¤±æ•°æ®ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯FileChannelè‡ªå·±ä¸åšä»»ä½•çš„æ•°æ®å¤åˆ¶ï¼Œå› æ­¤å®ƒåªæ˜¯å’ŒåŸºæœ¬çš„ç£ç›˜ä¸€æ ·é«˜å¯ç”¨ã€‚ä½¿ç”¨FileChannleçš„ç”¨æˆ·éœ€è¦è´­ä¹°é…ç½®æ›´å¤šçš„ç¡¬ç›˜ã€‚ç¡¬ç›˜æœ€å¥½æ˜¯RAIDã€SANæˆ–è€…ç±»ä¼¼çš„ã€‚\nå¾ˆå¤šéœ€è¦é€šè¿‡æŸå¤±å°‘é‡çš„æ•°æ®ï¼ˆæ¯éš”å‡ ç§’å°†å†…å­˜æ•°æ®fsyncåˆ°ç¡¬ç›˜ï¼‰æ¢å–é«˜ååé‡ã€‚Flumeå›¢é˜Ÿå†³å®šä½¿ç”¨å¦ä¸€ç§æ–¹å¼å®ç°FileChannelã€‚Flueæ˜¯ä¸€ä¸ªäº‹åŠ¡å‹çš„ç³»ç»Ÿï¼Œåœ¨ä¸€æ¬¡å­˜æˆ–å–çš„äº‹åŠ¡ä¸­å¯ä»¥æ“ä½œå¤šä¸ªäº‹ä»¶ã€‚é€šè¿‡æ”¹å˜æ‰¹é‡å¤§å°æ¥æ§åˆ¶ååé‡ã€‚ä½¿ç”¨å¤§çš„æ‰¹é‡ï¼ŒFlumeå¯ä»¥ä»¥æ¯”è¾ƒé«˜çš„ååé‡ä¼ é€æ•°æ®ï¼ŒåŒæ—¶ä¸ä¸¢å¤±æ•°æ®ã€‚æ‰¹é‡çš„å¤§å°å®Œå…¨ç”±å®¢æˆ·ç«¯æ§åˆ¶ã€‚ä½¿ç”¨RDBMSçš„ç”¨æˆ·å¯¹è¿™ç§æ–¹å¼ä¼šæ¯”è¾ƒç†Ÿæ‚‰ã€‚\nä¸€ä¸ªFlumeäº‹åŠ¡ç”±å­˜æˆ–å–ç»„æˆï¼Œä½†ä¸èƒ½åŒæ—¶åšä¸¤ç§æ“ä½œï¼ŒåŒæ ·æäº¤å’Œå›æ»šä¹Ÿæ˜¯ä¸€æ ·ã€‚æ¯ä¸ªäº‹åŠ¡å®ç°äº†å­˜å’Œå–çš„æ–¹æ³•ã€‚æ•°æ®æºå°†äº‹ä»¶å­˜å…¥é€šé“ï¼Œè¾“å‡ºä»é€šé“ä¸­å°†äº‹ä»¶å–å‡ºã€‚\nè®¾è®¡ FileChannelåœ¨WALï¼ˆé¢„å†™å¼æ—¥å¿—ï¼‰çš„åŸºç¡€ä¸Šæ·»åŠ äº†ä¸€ä¸ªå†…å­˜é˜Ÿåˆ—ã€‚æ¯ä¸ªäº‹åŠ¡éƒ½è¢«å†™æˆä¸€ä¸ªåŸºäºäº‹åŠ¡ç±»å‹ï¼ˆå­˜æˆ–å–ï¼‰çš„WALï¼Œå†…å­˜é˜Ÿåˆ—ä¹Ÿç›¸åº”çš„è¢«æ›´æ–°ã€‚æ¯æ¬¡æ˜¯äº‹åŠ¡æäº¤ï¼Œæ­£ç¡®çš„æ–‡ä»¶è¢«fsyncä¿è¯æ•°æ®è¢«çœŸæ­£åœ°ä¿å­˜åˆ°ç£ç›˜ä¸Šï¼ŒåŒæ—¶è¯¥äº‹ä»¶çš„æŒ‡é’ˆä¹Ÿè¢«ä¿å­˜åˆ°äº†å†…å­˜é˜Ÿåˆ—ä¸­ã€‚è¿™ä¸ªé˜Ÿåˆ—æä¾›çš„åŠŸèƒ½è·Ÿå…¶ä»–é˜Ÿåˆ—æ²¡æœ‰åŒºåˆ«ï¼šç®¡ç†é‚£äº›è¿˜æ²¡æœ‰è¢«è¾“å‡ºæ¶ˆè´¹çš„äº‹ä»¶ã€‚åœ¨å–çš„è¿‡ç¨‹ä¸­ï¼ŒæŒ‡é’ˆè¢«ä»é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚äº‹ä»¶ç›´æ¥ä»WALä¸­è¯»å–ã€‚å¾—ç›Šäºå½“å‰å¤§å®¹é‡çš„RAMï¼Œä»æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç¼“å­˜ä¸­è¯»å–å¾ˆå¸¸è§ã€‚\nåœ¨ç³»ç»Ÿå´©æºƒä¹‹åï¼ŒWALå¯ä»¥è¢«é‡ç°åˆ°é˜Ÿåˆ—ä¸­ä¿æŒåŸæ¥çš„çŠ¶æ€ï¼Œæ²¡æœ‰è¢«æäº¤çš„äº‹åŠ¡ä¼šä¸¢å¤±ã€‚é‡ç°WALæ˜¯è€—æ—¶çš„ï¼Œå› æ­¤é˜Ÿåˆ—ä¹Ÿè¢«å‘¨æœŸæ€§åœ°å†™åˆ°ç£ç›˜ä¸Šã€‚å†™é˜Ÿåˆ—åˆ°ç£ç›˜è¢«ç§°ä½œcheckpointã€‚å´©æºƒåï¼Œä»ç£ç›˜è¯»å–é˜Ÿåˆ—ã€‚åªæœ‰é˜Ÿåˆ—ä¿å­˜åˆ°ç£ç›˜ä¹‹åæäº¤çš„äº‹åŠ¡è¢«é‡ç°ï¼Œè¿™æ ·å¯ä»¥æ˜¾è‘—çš„å‡å°‘éœ€è¦è¯»å–çš„WALçš„æ•°é‡ã€‚\nä¾‹å¦‚ï¼Œå¦‚ä¸‹æœ‰ä¸¤ä¸ªäº‹ä»¶çš„é€šé“ï¼š\nWALåŒ…å«äº†ä¸‰ä¸ªé‡è¦çš„å…ƒç´ ï¼šäº‹åŠ¡idã€åºåˆ—å·å’Œäº‹ä»¶æ•°æ®ã€‚æ¯ä¸ªäº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡idï¼Œæ¯ä¸ªäº‹ä»¶éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åºåˆ—å·ã€‚äº‹åŠ¡idåªè¢«ç”¨æ¥æ ‡è¯†äº‹åŠ¡ä¸­çš„ä¸€ç»„äº‹ä»¶ï¼Œåºåˆ—å·åœ¨é‡æ¼”æ—¥å¿—çš„æ—¶å€™è¢«ç”¨åˆ°ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œäº‹åŠ¡idæ˜¯1ï¼Œåºåˆ—å·æ˜¯1ã€2ã€3ã€‚\nå½“é˜Ÿåˆ—è¢«ä¿å­˜åˆ°ç¡¬ç›˜å \u0026ndash; ä¸€æ¬¡checkpoint \u0026ndash; åºåˆ—å·è‡ªåŠ¨å¢åŠ å¹¶åŒæ ·è¢«ä¿å­˜ã€‚åœ¨é‡å¯æ—¶ï¼Œé˜Ÿåˆ—æœ€å…ˆè¢«ä»ç¡¬ç›˜ä¸ŠåŠ è½½ï¼Œæ‰€æœ‰åºåˆ—å·å¤§äºé˜Ÿåˆ—çš„WALé¡¹è¢«é‡ç°ã€‚åœ¨checkpointæ“ä½œæ—¶ï¼Œchannleè¢«é”ä½ä»¥ä¿è¯æ²¡æœ‰å­˜å–æ“ä½œæ”¹å˜å®ƒçš„çŠ¶æ€ã€‚å¦‚æœå…è®¸ä¿®æ”¹ï¼Œä¼šå¯¼è‡´ä¿å­˜åˆ°ç¡¬ç›˜ä¸Šçš„é˜Ÿåˆ—å¿«ç…§ä¸ä¸€è‡´ã€‚\nä¸Šé¢ä¾‹å­ä¸­çš„é˜Ÿåˆ—ï¼Œcheckpointå‘é€åœ¨äº‹åŠ¡1æäº¤ä¹‹åï¼Œå› æ­¤äº‹ä»¶aã€bçš„æŒ‡é’ˆå’Œåºåˆ—å·4è¢«ä¿å­˜åˆ°ç¡¬ç›˜ã€‚\nä¹‹åï¼Œäº‹ä»¶aåœ¨äº‹åŠ¡2ä¸­è¢«ä»é˜Ÿåˆ—ä¸­å–å‡ºï¼š\nå¦‚æœè¿™æ—¶ç³»ç»Ÿå´©æºƒï¼Œé˜Ÿåˆ—çš„checkpointä»ç¡¬ç›˜ä¸­åŠ è½½ã€‚æ³¨æ„è¿™ä¸ªcheckpointå‘ç”Ÿåœ¨äº‹åŠ¡2ä¹‹å‰ï¼Œäº‹ä»¶aã€bçš„æŒ‡é’ˆå­˜åœ¨é˜Ÿåˆ—ä¸­ã€‚å› æ­¤WALä¸­åºåˆ—å·å¤§äº4çš„å·²æäº¤çš„äº‹åŠ¡è¢«é‡ç°ï¼Œäº‹ä»¶aæŒ‡é’ˆè¢«ä»é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚\nä¸Šé¢çš„è®¾è®¡æœ‰ä¸¤ç‚¹æ²¡æåˆ°ã€‚checkpointæ—¶å‘ç”Ÿçš„å­˜å’Œå–æ“ä½œä¼šä¸¢å¤±ã€‚å‡è®¾checkpointåœ¨å–äº‹ä»¶aä¹‹åå‘ç”Ÿï¼š\nå¦‚æœè¿™æ—¶ç³»ç»Ÿå´©æºƒï¼Œæ ¹æ®ä¸Šé¢çš„è®¾è®¡ï¼Œäº‹ä»¶bæŒ‡é’ˆä¿å­˜åœ¨é˜Ÿåˆ—ä¸­ï¼Œæ‰€æœ‰åºåˆ—å·å¤§äº5çš„WALé¡¹è¢«é‡ç°ï¼šäº‹åŠ¡2çš„å›æ»šè¢«é‡ç°ã€‚ä½†æ˜¯äº‹åŠ¡2çš„å–æ“ä½œä¸ä¼šè¢«é‡ç°ã€‚å› æ­¤äº‹ä»¶aæŒ‡é’ˆä¸ä¼šè¢«æ”¾å›é˜Ÿåˆ—å› è€Œå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚å­˜çš„åœºæ™¯ä¹Ÿç±»ä¼¼ã€‚å› æ­¤åœ¨é˜Ÿåˆ—checkpointçš„æ—¶å€™ï¼Œè¿›è¡Œä¸­çš„äº‹åŠ¡æ“ä½œä¹Ÿä¼šè¢«é‡ç°ï¼Œè¿™æ ·è¿™ç§æƒ…å†µèƒ½è¢«æ­£ç¡®å¤„ç†ã€‚\nå®ç° FileChannelè¢«ä¿å­˜åœ¨flumeé¡¹ç›®çš„flume-file-channelæ¨¡å—ä¸­ï¼Œä»–çš„javaåŒ…åæ˜¯org.apache.flume.channel.fileã€‚ä¸Šé¢æåˆ°é˜Ÿåˆ—è¢«å«åšFlumeEventQueueï¼ŒWALè¢«å«åšÂ Logã€‚é˜Ÿåˆ—æ˜¯ä¸€ä¸ªç¯å½¢æ•°ç»„ï¼Œä½¿ç”¨Memory Mapped Fileã€‚WALæ˜¯ä¸€ç»„ä»¥LogFileæˆ–å…¶å­ç±»åºåˆ—åŒ–çš„æ–‡ä»¶ã€‚\næ€»ç»“ FileChannleåœ¨ç¡¬ä»¶ã€è½¯ä»¶å’Œç³»ç»Ÿæ•…éšœä¸‹çš„æŒä¹…åŒ–å¹¶åŒæ—¶ä¿è¯é«˜ååé‡ã€‚å¦‚æœè¿™äº®ç‚¹éƒ½çœ‹ä¸­çš„è¯ï¼ŒFileChannelæ˜¯æ¨èä½¿ç”¨çš„é€šé“ã€‚\nåŸæ–‡\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/flume-filechannel-overview/","tags":["DevOps"],"title":"Flume - FileChannel ï¼ˆä¸€ï¼‰"},{"categories":["ç¬”è®°"],"contents":"AMQPConnection å®ä¾‹åˆå§‹åŒ– åˆ›å»ºConnectionæ—¶ä¼šé€šè¿‡FrameHandlerFacotryåˆ›å»ºä¸€ä¸ªSocketFrameHandlerï¼ŒSocketFrameHandlerå¯¹Socketè¿›è¡Œäº†å°è£…ã€‚\npublic AMQConnection(ConnectionParams params, FrameHandler frameHandler) { checkPreconditions(); this.username = params.getUsername(); this.password = params.getPassword(); this._frameHandler = frameHandler; this._virtualHost = params.getVirtualHost(); this._exceptionHandler = params.getExceptionHandler(); this._clientProperties = new HashMap\u0026lt;String, Object\u0026gt;(params.getClientProperties()); this.requestedFrameMax = params.getRequestedFrameMax(); this.requestedChannelMax = params.getRequestedChannelMax(); this.requestedHeartbeat = params.getRequestedHeartbeat(); this.shutdownTimeout = params.getShutdownTimeout(); this.saslConfig = params.getSaslConfig(); this.executor = params.getExecutor(); this.threadFactory = params.getThreadFactory(); this._channelManager = null; this._brokerInitiatedShutdown = false; this._inConnectionNegotiation = true; // we start out waiting for the first protocol response } å¯åŠ¨è¿æ¥ åˆå§‹åŒ–WorkServiceå’ŒHeartBeatSenderã€‚\nåˆ›å»ºä¸€ä¸ªchannel0çš„AMQChannelï¼Œè¿™ä¸ªchannelä¸ä¼šè¢«ChannelManagerç®¡ç†ã€‚\né¦–å…ˆchannel0ä¼šå°†ä¸€ä¸ªBlockingRpcContinuationä½œä¸ºå½“å‰æœªå®Œæˆçš„Rpcè¯·æ±‚ï¼Œç”¨äºæ¥æ”¶handshakeçš„å“åº”ã€‚\nç„¶åchannel0ä¼šå‘socketä¸­å†™å…¥ä¸€æ¡åªæœ‰headerçš„æ¶ˆæ¯ä½œä¸ºhandshakeï¼Œheaderä¸­åŒ…å«äº†å®¢æˆ·ç«¯çš„ç‰ˆæœ¬å·ã€‚\nç´§æ¥ç€ä¼šå¯åŠ¨ä¸»å¾ªç¯çº¿ç¨‹ï¼Œä¸»å¾ªç¯ä¼šé€šè¿‡SocketFrameHandlerä»socketæ¥æ”¶å­—èŠ‚æµã€‚æ­¤æ—¶æ¥æ”¶åˆ°çš„ç¬¬ä¸€æ¡æ•°æ®æ˜¯æœåŠ¡ç«¯å“åº”handshakeè¿”å›çš„Connection.Startä¿¡æ¯ï¼ˆåŒ…å«æœåŠ¡ç«¯ç‰ˆæœ¬ã€æœºåˆ¶ã€åŸºç¡€ä¿¡æ¯ï¼‰ã€‚\nä¸»å¾ªç¯çº¿ç¨‹å¯åŠ¨åï¼Œä¸»çº¿ç¨‹ä¼šé˜»å¡åœ°ç­‰å¾…æœåŠ¡ç«¯çš„handshakeå“åº”ã€‚æ‹¿åˆ°å“åº”ä¹‹åä¼šå¯¹æœåŠ¡å™¨å›ä¼ çš„ä¿¡æ¯è¿›è¡Œæ¯”å¯¹ï¼Œç„¶åå‘é€Connection.StartOKçš„ä¿¡æ¯å»æœåŠ¡ç«¯ï¼ˆè¿™ä¸ªè¯·æ±‚ä¹Ÿè¿˜æ˜¯é˜»å¡å¼çš„ï¼‰ï¼Œç­‰å¾…æœåŠ¡ç«¯å›ä¼ Connection.Tuneï¼ˆåŒ…å«æœ€å¤§channelæ•°ã€æœ€å¤§frameé•¿åº¦å’Œheartbeaté—´éš”ï¼‰ã€‚å°†è¿™äº›ä¿¡æ¯ä¸å®ä¾‹åˆå§‹åŒ–æ˜¯çš„è®¾ç½®ä¿¡æ¯è¿›è¡Œå¯¹æ¯”ï¼Œåˆå§‹åŒ–ChannelManager\nç´§æ¥ç€å‘é€Connection.TuneOkå’ŒConnection.Openæ¶ˆæ¯å»æœåŠ¡ç«¯ï¼Œå®Œæˆconnectionçš„å»ºç«‹ã€‚\nConnection \u0026gt; MainLoop \u0026gt; readFrame\næ¶ˆæ¯ä½“ Frameæ˜¯å¯¹AMQPæ¶ˆæ¯çš„å°è£…ï¼šåŒ…å«frameçš„typeã€channelå·ã€æ¶ˆæ¯å†…å®¹\ntype|channelNumber|payloadSize|payload|frameEndMarker\nPayloadåŒ…å«äº†æ¶ˆæ¯ç±»å‹ã€æ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä¸»é¢˜\nmethod|header|body\næ¶ˆæ¯å‘é€å’Œæ¥æ”¶ æ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶éƒ½è¦channelæ¥å®Œæˆã€‚\nåˆ›å»ºChannel é€šè¿‡Connectionçš„ChannelManageræ¥åˆ›å»ºChannelï¼Œé€šè¿‡æŒ‡å®šçš„ChannelNumberæˆ–è€…ç”±åˆ†é…å™¨åˆ†é…ã€‚åˆ›å»ºå¥½çš„Channelå®ä¾‹ä¼šæ”¾å…¥ChannelManagerçš„Mapä¸­ï¼Œkeyä¸ºChannelNumberã€‚ç”±æ­¤å¯è§Channelæ˜¯Connectionå”¯ä¸€çš„ã€‚\npublic ChannelN createChannel(AMQConnection connection); public ChannelN createChannel(AMQConnection connection, int channelNumber); private ChannelN addNewChannel(AMQConnection connection, int channelNumber); protected ChannelN instantiateChannel(AMQConnection connection, int channelNumber, ConsumerWorkService workService); Channelå®ä¾‹åŒ–ä¹‹åä¼šè°ƒç”¨Channel.openæ–¹æ³•ï¼Œå‘é€Channel.Openå»æœåŠ¡ç«¯ï¼ˆé˜»å¡å¼ï¼‰ï¼Œç­‰å¾…æœåŠ¡ç«¯å“åº”Channel.OpenOkã€‚\næ¶ˆæ¯å‘é€ Channel.transmit å‘é€æ¶ˆæ¯ï¼Œè°ƒç”¨AMQCommand.transmitå®Œæˆå‘é€ã€‚\nAMQCommand.transmitå°†æ¶ˆæ¯å°è£…æˆFrameï¼Œé€šè¿‡connectionçš„SocketFrameHandlerå†™å…¥OutpuStreamã€‚\næ¶ˆæ¯æ¥æ”¶ ä¸»å¾ªç¯çº¿ç¨‹åœ¨é“¾æ¥åˆ›å»ºå®Œæˆåä¼šç›‘å¬socketï¼Œä»InputStreamä¸­è¯»å–äºŒè¿›åˆ¶æµå°è£…æˆFrameã€‚é€šè¿‡Frameä¸­çš„ChannelNumberä»ChannelManagerä¸­è·å–å¯¹åº”çš„Channelå®ä¾‹å¤„ç†Frameã€‚\nwhile (_running) { Frame frame = _frameHandler.readFrame(); if (frame != null) { _missedHeartbeats = 0; if (frame.type == AMQP.FRAME_HEARTBEAT) { // Ignore it: we\u0026#39;ve already just reset the heartbeat counter. } else { if (frame.channel == 0) { // the special channel _channel0.handleFrame(frame); } else { if (isOpen()) { // If we\u0026#39;re still _running, but not isOpen(), then we // must be quiescing, which means any inbound frames // for non-zero channels (and any inbound commands on // channel zero that aren\u0026#39;t Connection.CloseOk) must // be discarded. ChannelManager cm = _channelManager; if (cm != null) { cm.getChannel(frame.channel).handleFrame(frame); } } } } } else { // Socket timeout waiting for a frame. // Maybe missed heartbeat. handleSocketTimeout(); } } Channelä¼šä½¿ç”¨å·²ç»å‡†å¤‡å¥½çš„AMQCommandå¤„ç†Frameï¼Œå¹¶æœªä¸‹ä¸€ä¸ªFrameå‡†å¤‡æ–°çš„AMQCommandã€‚\npublic void handleFrame(Frame frame) throws IOException { AMQCommand command = _command; if (command.handleFrame(frame)) { // a complete command has rolled off the assembly line _command = new AMQCommand(); // prepare for the next one handleCompleteInboundCommand(command); } } AMQCommadä¼šä½¿ç”¨CommandAssemblerä¾æ¬¡ä»Frameçš„payloadä¸­æ£€å‡ºå¯¹åº”çš„Methodã€Headerå’ŒBodyã€‚å¦‚æœæ£€å‡ºäº†Bodyï¼Œæ•´ä¸ªFrameä¼šè¢«æ£€å‡ºå®Œæˆã€‚å¦‚è¿‡æœªå®Œæˆï¼Œä¼šè¿›å…¥ä¸»å¾ªç¯å†æ¬¡å¤„ç†ç›´è‡³å®Œæˆã€‚\npublic synchronized boolean handleFrame(Frame f) throws IOException { switch (this.state) { case EXPECTING_METHOD: consumeMethodFrame(f); break; case EXPECTING_CONTENT_HEADER: consumeHeaderFrame(f); break; case EXPECTING_CONTENT_BODY: consumeBodyFrame(f); break; default: throw new AssertionError(\u0026#34;Bad Command State \u0026#34; + this.state); } return isComplete(); } Frameè¢«æ£€å‡ºå®Œåï¼Œä¼šæ ¹æ®Methodçš„ç±»å‹è¿›å…¥ä¸åŒçš„å¼‚æ­¥å¤„ç†æµç¨‹ã€‚\nMethodåœ¨channelæ‰“å¼€å’Œå…³é—­çš„æƒ…å†µä¸‹ä¼šä»¥ä¸‹çš„å¯èƒ½ï¼š\nChannelæ‰“å¼€ï¼šBasic.Deliver, Basic.Return, Basic.Flow, Basic.Ack, Basic.Nack, Basic.RecoveryOk, Basic.Cancel\nChannelå…³é—­ï¼šChannel.CloseOk\nç”Ÿäº§å’Œæ¶ˆè´¹ ç”Ÿäº§ è°ƒç”¨Channel.basicPublish()æ–¹æ³•ï¼ŒæŒ‡å®šexchangeã€routingKeyç­‰ä¿¡æ¯ï¼Œæ¶ˆæ¯å±æ€§ã€æ¶ˆæ¯ä½“ã€‚å°è£…æˆBaisc.Publishï¼Œæ”¾å…¥AMQCommandï¼Œæœ€åè°ƒç”¨transmitæ–¹æ³•å®Œæˆå‘é€ã€‚å‚è€ƒæ¶ˆæ¯å‘é€\npublic void basicPublish(String exchange, String routingKey, boolean mandatory, boolean immediate, BasicProperties props, byte[] body) throws IOException { if (nextPublishSeqNo \u0026gt; 0) { unconfirmedSet.add(getNextPublishSeqNo()); nextPublishSeqNo++; } BasicProperties useProps = props; if (props == null) { useProps = MessageProperties.MINIMAL_BASIC; } transmit(new AMQCommand(new Basic.Publish.Builder() .exchange(exchange) .routingKey(routingKey) .mandatory(mandatory) .immediate(immediate) .build(), useProps, body)); } æ¶ˆè´¹ åˆ›å»ºQueueingConsumerå®ä¾‹ï¼Œç„¶åè°ƒç”¨Channel.basicConsumeæ–¹æ³•ã€‚\nqueueingConsumer = new QueueingConsumer(channel); channel.basicConsume(\u0026#34;queue_name\u0026#34;, queueingConsumer); new Thread() { @Override public void run() { while (true) { try { final QueueingConsumer.Delivery delivery = queueingConsumer.nextDelivery(); new Thread() { @Override public void run() { try{ delivery.getEnvelope();//æ¶ˆæ¯å¤´ delivery.getProperties();//æ¶ˆæ¯å±æ€§ delivery.getBody()ï¼›//æ¶ˆæ¯ä½“ }finally{ //channel.basicAck(); //channel.basicNack() } } }.start(); } catch (InterruptedException e) { e.printStackTrace(); } } } }.start(); QueueingConsumerå®ç°äº†Consumeræ¥å£ã€‚\nChannel.basicConsumeæ–¹æ³•ä¼šå°è£…Channel.Consumeæ¶ˆæ¯å‘é€åˆ°æœåŠ¡ç«¯ï¼ˆé˜»å¡å¼ï¼‰ï¼Œç­‰å¾…æœåŠ¡ç«¯çš„Channel.ConsumeOkå“åº”ï¼ˆåŒ…å«äº†æœåŠ¡ç«¯ä¸ºConsumeråˆ†é…çš„ConsumerTagï¼‰ã€‚ç„¶åå°†QueueingConsumeræ”¾å…¥Mapä¸­ï¼Œkeyä¸ºConsumerTagã€‚consumeræ˜¯Channelå”¯ä¸€ã€‚\nå½“å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå‚è€ƒæ¶ˆæ¯æ¥æ”¶ã€‚Basic.Deliverç±»å‹çš„æ¶ˆæ¯ï¼ˆconsumerTagã€deliveryTagã€redeliveredã€exchangeã€routingKeyï¼‰ä¼šè¿›å…¥æ¶ˆè´¹å¤„ç†æµç¨‹ã€‚Channelæ ¹æ®ConsumerTagä»Mapä¸­è·å–å¯¹åº”çš„QueueConsumerå®ä¾‹ï¼Œç”±Channelçš„ConsumerDispatcheré€šè¿‡Connectionåˆå§‹åŒ–çš„WorkServiceåˆ›å»ºæ–°çš„å¤„ç†çº¿ç¨‹ï¼Œè°ƒç”¨QueueConsumerå®ä¾‹çš„handleDeliveryæ–¹æ³•ã€‚QueueConsumerå°†æ¶ˆæ¯å°è£…æˆDeliveryå¯¹è±¡ï¼Œæ”¾å…¥BlockingQueueä¸­ã€‚\næ¶ˆè´¹çº¿ç¨‹ç­‰å¾…æ–°çš„Deliveryï¼ˆé˜»å¡å¼ï¼‰ï¼Œä¹‹ååˆ›å»ºæ–°çš„çº¿ç¨‹å®Œæˆæ¶ˆæ¯çš„å¤„ç†ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/deep-in-rabbitmq-java-client/","tags":["Java"],"title":"æ¢ç´¢Rabbitmqçš„Javaå®¢æˆ·ç«¯"},{"categories":["ç¬”è®°"],"contents":"æœ€è¿‘åˆä¸ªé¡¹ç›®ï¼Œcheckoutä¹‹åï¼Œæ²¡åšä»»ä½•æ”¹åŠ¨å‰git statuså‘ç°å·²ç»æœ‰modifiedäº†ï¼Œé€šè¿‡git diffå‘ç°æœ‰ä¸¤ç§æ”¹åŠ¨ï¼š\n- warning: CRLF will be replaced by LF inÂ **\n- åˆ é™¤å¹¶æ·»åŠ çš„åŒæ ·çš„è¡Œ\nä½¿ç”¨git diff -wå´æ²¡æœ‰æ”¹åŠ¨ï¼›ä½¿ç”¨git diff â€“ws-error-highlight=new,oldå‘ç°è¡Œå°¾æœ‰**^M**\næˆ‘æœ¬äººç”¨çš„æ˜¯Linuxï¼Œå…¶ä»–åŒäº‹æœ‰ç”¨Windowsï¼Œé—®é¢˜å°±å‡ºåœ¨å¹³å°ä¸Šã€‚\nWindowsç”¨CR LFæ¥å®šä¹‰æ¢è¡Œï¼ŒLinuxç”¨LFã€‚CRå…¨ç§°æ˜¯Carriage Return ,æˆ–è€…è¡¨ç¤ºä¸º\\r, æ„æ€æ˜¯å›è½¦ã€‚ LFå…¨ç§°æ˜¯Line Feedï¼Œå®ƒæ‰æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æ¢è¡Œè¡¨ç¤ºç¬¦ã€‚\ngit configä¸­å…³äºCRLFæœ‰ä¸¤ä¸ªè®¾å®šï¼šcore.autocrlfå’Œcore.safecrlfã€‚\nä¸€ã€AutoCRLF\n#æäº¤æ—¶è½¬æ¢ä¸ºLFï¼Œæ£€å‡ºæ—¶è½¬æ¢ä¸ºCRLF\ngit config â€“global core.autocrlf true\n#æäº¤æ—¶è½¬æ¢ä¸ºLFï¼Œæ£€å‡ºæ—¶ä¸è½¬æ¢\ngit config â€“global core.autocrlf input\n#æäº¤æ£€å‡ºå‡ä¸è½¬æ¢\ngit config â€“global core.autocrlf false\näºŒã€SafeCRLF\n#æ‹’ç»æäº¤åŒ…å«æ··åˆæ¢è¡Œç¬¦çš„æ–‡ä»¶\ngit config â€“global core.safecrlf true\n#å…è®¸æäº¤åŒ…å«æ··åˆæ¢è¡Œç¬¦çš„æ–‡ä»¶\ngit config â€“global core.safecrlf false\n#æäº¤åŒ…å«æ··åˆæ¢è¡Œç¬¦çš„æ–‡ä»¶æ—¶ç»™å‡ºè­¦å‘Š\ngit config â€“global core.safecrlf warn\nè¿™ç§æƒ…å†µï¼ŒæŠŠautocrlfç½®ä¸ºfalseï¼Œsafecrlfä¹Ÿç½®ä¸ºfalseï¼Œå¯ä»¥å¿½ç•¥ä¸åŒå¹³å°ä¸Šå›è½¦æ¢è¡Œçš„å·®å¼‚ã€‚\nè®¾ç½®å®Œæˆåï¼Œå‘ç°ç¬¬äºŒä¸ªé—®é¢˜è¿˜æ˜¯å­˜åœ¨ã€‚è¿™æ—¶è¦æŸ¥çœ‹ä»£ç åº“ä¸­æ˜¯å¦å­˜åœ¨.gitattributesæ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨æ‰“å¼€.gitattributesã€‚\nåœ¨è¯¥é¡¹ç›®çš„.gitattributesä¸­æœ‰å‡ ç§è®¾å®šï¼š\n* text=auto !eol æ‰€æœ‰å¸¦æœ‰textå±æ€§çš„æ–‡ä»¶ä½¿ç”¨autoçš„EOLï¼Œä½†æ˜¯ä¸æŒ‡å®šEOLæ–¹å¼ï¼ˆCRLF or LFï¼‰ [path]/file -text å–æ¶ˆæ–‡ä»¶çš„textå±æ€§ å¦‚æœä¸æŒ‡å®šEOLï¼Œgitä¼šä½¿ç”¨configä¸­çš„core.eolã€‚å¦‚æœæœªè®¾ç½®core.eolï¼Œgitä¼šä½¿ç”¨å¹³å°é»˜è®¤çš„å›è½¦æ¢è¡Œã€‚\nä¼˜å…ˆçº§ core.autocrlf \u0026gt; text=auto + core.eolã€‚\nä»¥ä¸‹è®¾ç½®çš„ç»“æœç›¸åŒï¼š\ncore.autocrlf=true\ncore.eol=CRLF åŒæ—¶ * text=auto !eol\n* text=auto CRLF\n.gitattributesè®¾ç½®ä¼šå½±å“checkoutå’Œcheckin\næœ€åçš„è§£å†³æ–¹æ¡ˆæ˜¯ç›´æ¥æ¸…ç©ºäº†.gitattributeså†…å®¹ï¼Œè¿™ä¸ªé—®é¢˜åº”è¯¥æ˜¯åœ¨é¡¹ç›®ä»svnè¿ç§»åˆ°gitæ—¶è¿ç§»å·¥å…·è‡ªåŠ¨æ·»åŠ çš„ç»“æœã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/crlf-in-git/","tags":["DevOps"],"title":"Gitå›è½¦æ¢è¡Œ"},{"categories":["ç¬”è®°"],"contents":"HashSetæ˜¯ä¸€ä¸ªåŒ…å«éé‡å¤å…ƒç´ çš„é›†åˆï¼Œå¦‚ä½•å®ç°çš„ï¼Œè¦ä»åº•å±‚å®ç°ä»£ç çœ‹èµ·ã€‚\nèƒŒæ™¯ é¦–å…ˆéé‡å¤å…ƒç´ å¦‚ä½•å®šä¹‰ï¼Œçœ‹Setçš„æè¿°ï¼š\nMore formally, sets contain no pair of elements e1 and e2 such that e1.equals(e2), and at most one null element.\nSetä¸ä¼šæ‰¾åˆ°ä¸¤ä¸ªå…ƒç´ ï¼Œå¹¶ä¸”ä¸¤ä¸ªå…ƒç´ æ»¡è¶³e1.equals(e2)ä¸ºtrueï¼›å¹¶ä¸”æœ€å¤šåªæœ‰ä¸€ä¸ªnullå…ƒç´ ã€‚\nå¦‚æœæ²¡æœ‰é‡å†™equalsæ–¹æ³•ï¼ŒæŸ¥çœ‹Objectç±»ä¸­equalæ–¹æ³•çš„å®ç°ï¼Œ==æ¯”è¾ƒçš„å…¶å®æ˜¯ä¸¤ä¸ªå¯¹è±¡åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚\npublic boolean equals(Object obj) { return (this == obj); } è¯´èµ·equalsæ–¹æ³•ï¼Œå°±ä¸å¾—ä¸è¯´hashCodeæ–¹æ³•äº†ã€‚Javaä¸­å¯¹äºhashCodeæœ‰ä¸ªå¸¸è§„åå®š\nThe general contract of hashCode is:\nWhenever it is invoked on the same object more than once during an execution of a Java application, the hashCode method must consistently return the same integer, provided no information used in equals comparisons on the object is modified. This integer need not remain consistent from one execution of an application to another execution of the same application.\nIf two objects are equal according to the equals(Object) method, then calling the hashCode method on each of the two objects must produce the same integer result.\nIt is not required that if two objects are unequal according to the equals(java.lang.Object) method, then calling the hashCode method on each of the two objects must produce distinct integer results. However, the programmer should be aware that producing distinct integer results for unequal objects may improve the performance of hash tables.\nç¨‹åºæ‰§è¡ŒæœŸé—´ï¼Œåœ¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šæ‰§è¡Œå¤šæ¬¡hashCodeæ–¹æ³•ï¼Œéƒ½è¿”å›ç›¸åŒçš„æ•´æ•°ï¼Œå‰ææ˜¯equalsæ¯”è¾ƒä¸­æ‰€ä½¿ç”¨çš„å­—æ®µæ²¡æœ‰è¢«ä¿®æ”¹ã€‚è·¨åº”ç”¨ä¸­çš„hashCodeæ–¹æ³•è°ƒç”¨è¿”å›çš„æ•´æ•°ä¸è¦æ±‚ç›¸åŒã€‚\nå¦‚æœä¸¤ä¸ªå¯¹è±¡æ ¹æ®equalsæ–¹æ³•æ¯”è¾ƒç›¸åŒï¼Œé‚£hashCodeè¿”å›çš„æ•´æ•°ä¹Ÿå¿…é¡»ç›¸åŒã€‚\nå¦‚æœä¸¤ä¸ªå¯¹è±¡equalsæ–¹æ³•æ¯”è¾ƒä¸ç›¸åŒï¼Œè°ƒç”¨hashCodeè¿”å›çš„æ•´æ•°ä¸éœ€è¦ä¸åŒã€‚ä½†æ˜¯ç¨‹åºå‘˜åº”è¯¥çŸ¥é“ä¸ºä¸ç›¸ç­‰çš„å¯¹è±¡ç”Ÿæˆä¸åŒçš„æ•´æ•°å¯ä»¥æé«˜å“ˆå¸Œè¡¨çš„æ€§èƒ½ã€‚\nHashSetçš„åº•å±‚å®ç° HashSetçš„åº•å±‚æ˜¯é€šè¿‡HashMapå®ç°çš„ï¼Œå°†å…ƒç´ ä½œä¸ºmapçš„keyä»¥è¾¾åˆ°å»é‡çš„ç›®çš„ï¼Œvalueä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªè™šæ‹Ÿçš„Objectå®ä¾‹ã€‚\nprivate transient HashMap\u0026lt;E,Object\u0026gt; map; // Dummy value to associate with an Object in the backing Map private static final Object PRESENT = new Object(); public boolean add(E e) { return map.put(e, PRESENT)==null; } HashMapçš„åº•å±‚å®ç° {% asset_img hashmap-structure.jpg %}\nåˆ°æœ€åæˆ‘ä»¬è¦çœ‹HashMapçš„å®ç°äº†ï¼Œç®€å•è¯´å°±æ˜¯ä¸€ä¸ªæ•°ç»„+é“¾è¡¨çš„ç»“åˆã€‚\né»˜è®¤åˆå§‹å®¹é‡16 é»˜è®¤è´Ÿè·ç³»æ•°0.75 Entryæ•°ç»„ å¤§å° é˜ˆå€¼ï¼šåˆå§‹å€¼ç­‰äºåˆå§‹å®¹é‡ è´Ÿè·ç³»æ•° static final int DEFAULT_INITIAL_CAPACITY = 1 \u0026lt;\u0026lt; 4; static final float DEFAULT_LOAD_FACTOR = 0.75f; static final Entry\u0026lt;?,?\u0026gt;[] EMPTY_TABLE = {}; transient Entry\u0026lt;K,V\u0026gt;[] table = (Entry\u0026lt;K,V\u0026gt;[]) EMPTY_TABLE; transient int size; int threshold; final float loadFactor; Entryå…ƒç´  Entryæ˜¯é“¾è¡¨çš„ç»“æœï¼Œkeyä¸ºMapä¸­çš„keyï¼Œvalueä¸ºMapä¸­çš„valueï¼Œhashä¸ºkeyçš„hashç»“æœï¼Œnextä¸ºä¸‹ä¸€ä¸ªå…ƒç´ ã€‚\nstatic class Entry\u0026lt;K,V\u0026gt; implements Map.Entry\u0026lt;K,V\u0026gt; { final K key; V value; Entry\u0026lt;K,V\u0026gt; next; int hash; } æ·»åŠ å…ƒç´  å¦‚æœæ•°ç»„ä¸ºç©ºï¼ˆå³mapåˆå§‹åŒ–åç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ ï¼‰æ‰©å……table å¦‚æœkeyä¸ºnullï¼Œåˆ™è°ƒç”¨putForNullKeyæ–¹æ³•ï¼Œnullä½äºtableçš„ä¸‹æ ‡0å¤„ ç®—å‡ºkeyçš„hashå€¼ é€šè¿‡hashå€¼ç®—å‡ºå…ƒç´ åœ¨tableä¸­çš„ä¸‹æ ‡å€¼ å¦‚æœè¯¥ä½ç½®å…ƒç´ ä¸ä¸ºç©ºï¼Œç„¶åéœ€è¦æ¯”è¾ƒå…ƒç´ çš„hashå€¼å’Œä¸Šé¢ç®—å‡ºçš„hashå€¼æ˜¯å¦ç›¸ç­‰ï¼ŒåŒæ—¶å…ƒç´ çš„keyå¯¹è±¡å’Œè¦å‡ºå…¥çš„keyæ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡ï¼ˆç›¸åŒçš„åœ°å€ ==æ¯”è¾ƒä¸ºtrueï¼‰æˆ–è€…equalsæ–¹æ³•æ˜¯å¦ä¸ºtrueã€‚å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œåˆ™æ›´æ–°è¯¥entryçš„valueå€¼ï¼›è‹¥ä¸æ»¡è¶³åˆ™éå†æ•´ä¸ªé“¾è¡¨ã€‚ å¦‚æœä¸ºç©ºç›´æ¥æ·»åŠ æ–°çš„entryã€‚ JDK8æ­¤å¤„æœ‰æ›´æ–°ï¼Œè§æœ«å°¾\npublic V put(K key, V value) { if (table == EMPTY_TABLE) { inflateTable(threshold); } if (key == null) return putForNullKey(value); int hash = hash(key); int i = indexFor(hash, table.length); for (Entry\u0026lt;K,V\u0026gt; e = table[i]; e != null; e = e.next) { Object k; if (e.hash == hash \u0026amp;\u0026amp; ((k = e.key) == key || key.equals(k))) { V oldValue = e.value; e.value = value; e.recordAccess(this); return oldValue; } } modCount++; addEntry(hash, key, value, i); return null; } æ‰©å……table å¯¹toSzieç®—å‡ºæœ€å°çš„2çš„å¹‚å€¼ï¼Œç”¨äº†Integer.highestOneBit((toSize -1) \u0026laquo; 1)ã€‚å‡ä¸€ä¹‹åå·¦ç§»ä¸€ä½ï¼Œç„¶åå–æœ€é«˜ä½å€¼ï¼Œå…¶ä½™ä¸ºè¡¥0ã€‚\nä¸ºä»€ä¹ˆæ•°ç»„é•¿åº¦å¿…é¡»ä¸º2çš„å¹‚å€¼ï¼Œè¯·ç»§ç»­çœ‹ã€‚\n/** * æ‰©å……table **/ private void inflateTable(int toSize) { // Find a power of 2 \u0026gt;= toSize int capacity = roundUpToPowerOf2(toSize); threshold = (int) Math.min(capacity * loadFactor, MAXIMUM_CAPACITY + 1); table = new Entry[capacity]; initHashSeedAsNeeded(capacity); } è®¡ç®—hashå€¼ hashSeedå€¼ä¸º0ï¼Œå°†keyçš„hashCodeå€¼åšå¤šæ¬¡ä½ç§»å’Œå¼‚æˆ–è¿ç®—\nfinal int hash(Object k) { int h = hashSeed; if (0 != h \u0026amp;\u0026amp; k instanceof String) { return sun.misc.Hashing.stringHash32((String) k); } h ^= k.hashCode(); // This function ensures that hashCodes that differ only by // constant multiples at each bit position have a bounded // number of collisions (approximately 8 at default load factor). h ^= (h \u0026gt;\u0026gt;\u0026gt; 20) ^ (h \u0026gt;\u0026gt;\u0026gt; 12); return h ^ (h \u0026gt;\u0026gt;\u0026gt; 7) ^ (h \u0026gt;\u0026gt;\u0026gt; 4); } è®¡ç®—å…ƒç´ ä½ç½® è¿™é‡Œçš„é€»è¾‘å¾ˆç®€å•ï¼šå°†hashå€¼è·Ÿæ•°ç»„é•¿åº¦-1åšäº†æŒ‰ä½ä¸ã€‚\nåœ¨è¿›è¡ŒæŸ¥æ‰¾çš„æ—¶å€™æ˜¯é€šè¿‡keyçš„hashå€¼ï¼Œå¦‚æœæˆ‘ä»¬å°†å…ƒç´ çš„ä½ç½®åˆ†å¸ƒå¾—å°½é‡å‡åŒ€ä¸€äº›ï¼Œå°½é‡åšåˆ°æ¯ä¸ªä½ç½®ä¸Šåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œè¾¾åˆ°O(1)çš„æŸ¥æ‰¾ã€‚è¿™ç§æŸ¥æ‰¾é€šè¿‡å–ä½™å°±å¯ä»¥åšåˆ°ï¼Œåœ¨Javaä¸­å¦‚ä½•åšåˆ°æ¯”è¾ƒå¿«çš„å–ä½™å‘¢ï¼Œç­”æ¡ˆæ˜¯ä½ä¸è¿ç®—ã€‚\nä¸Šé¢æ‰©å……æ•°ç»„çš„æ—¶å€™æˆ‘ä»¬ä¿è¯é•¿åº¦ä¸º2çš„å¹‚å€¼ï¼Œé‚£å‡ä¸€ä¹‹åå°±æ˜¯æ¯ä½éƒ½æ˜¯1ã€‚åšä½ä¸è¿ç®—å°±èƒ½ä¿è¯ä½ä½ä¸åŒçš„hashå€¼ä¼šè½åœ¨ä¸åŒçš„ä½ç½®ä¸Šï¼Œé™ä½å†²çªï¼ˆç¢°æ’ï¼‰ï¼Œæœ€å¤§ç¨‹åº¦åšåˆ°å‡åŒ€åˆ†å¸ƒï¼Œå‡å°‘é“¾è¡¨çš„å‡ºç°ï¼ˆæŸ¥æ‰¾å˜æˆO(n)ï¼‰ã€‚\nstatic int indexFor(int h, int length) { // assert Integer.bitCount(length) == 1 : \u0026#34;length must be a non-zero power of 2\u0026#34;; return h \u0026amp; (length-1); } æ·»åŠ entry æ·»åŠ æ–°çš„å…ƒç´ æ—¶è¦æ£€æŸ¥å…ƒç´ ä¸ªæ•°æ˜¯å¦è¾¾åˆ°é˜ˆå€¼ï¼Œå¦åˆ™è¦åšæ‰©å®¹å¤„ç†ï¼Œæ–°tableçš„å®¹é‡ä¸ºå½“å‰tableé•¿åº¦çš„ä¸¤å€ã€‚\nvoid addEntry(int hash, K key, V value, int bucketIndex) { if ((size \u0026gt;= threshold) \u0026amp;\u0026amp; (null != table[bucketIndex])) { resize(2 * table.length); hash = (null != key) ? hash(key) : 0; bucketIndex = indexFor(hash, table.length); } createEntry(hash, key, value, bucketIndex); } resize æ–°tableçš„å®¹é‡ä¸ºå½“å‰tableé•¿åº¦çš„ä¸¤å€ï¼ˆtable.length \u0026gt;= sizeï¼‰ï¼Œå°†æ—§æ•°æ®ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ä¸­ï¼Œè¿ç§»çš„è¿‡ç¨‹ä¸­è¦é‡æ–°è®¡ç®—å…ƒç´ åœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½®ã€‚ç½‘ä¸Šå¾ˆå¤šåœ°æ–¹æåˆ°è¿™ä¸ªæ“ä½œrehashï¼Œä½†æˆ‘è§‰å¾—reindexåè€Œæ›´æ°å½“ä¸€äº›ã€‚JDKä¸­å¯¹rehashæœ‰é¢å¤–çš„å®šä¹‰ï¼Œå°±æ˜¯initHashSeedAsNeededã€‚å½“æ–°çš„å®¹é‡\u0026gt;=jdk.map.althashing.thresholdçš„é…ç½®æ—¶ï¼Œä¼šé‡æ–°è®¡ç®—keyçš„hashå€¼ï¼Œå³hash(e.key)ã€‚\nvoid resize(int newCapacity) { Entry[] oldTable = table; int oldCapacity = oldTable.length; if (oldCapacity == MAXIMUM_CAPACITY) { threshold = Integer.MAX_VALUE; return; } Entry[] newTable = new Entry[newCapacity]; transfer(newTable, initHashSeedAsNeeded(newCapacity)); table = newTable; threshold = (int)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + 1); } reindex void transfer(Entry[] newTable, boolean rehash) { int newCapacity = newTable.length; for (Entry\u0026lt;K,V\u0026gt; e : table) { while(null != e) { Entry\u0026lt;K,V\u0026gt; next = e.next; if (rehash) { e.hash = null == e.key ? 0 : hash(e.key); } int i = indexFor(e.hash, newCapacity); e.next = newTable[i]; newTable[i] = e; e = next; } } } JDK8 update æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œå¦‚æœå‘ç”Ÿå“ˆå¸Œå†²çªï¼Œä¼šéå†é“¾è¡¨ã€‚åŠ å…¥é“¾è¡¨çš„é•¿åº¦å¤§äºTREEIFY_THRESHOLDï¼ˆé»˜è®¤ä¸º8ï¼‰ï¼Œä¼šå°†é“¾è¡¨è½¬æˆçº¢é»‘æ ‘ã€‚\nfinal V putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict) { Node\u0026lt;K,V\u0026gt;[] tab; Node\u0026lt;K,V\u0026gt; p; int n, i; if ((tab = table) == null || (n = tab.length) == 0) n = (tab = resize()).length; if ((p = tab[i = (n - 1) \u0026amp; hash]) == null) tab[i] = newNode(hash, key, value, null); else { Node\u0026lt;K,V\u0026gt; e; K k; if (p.hash == hash \u0026amp;\u0026amp; ((k = p.key) == key || (key != null \u0026amp;\u0026amp; key.equals(k)))) e = p; else if (p instanceof TreeNode) e = ((TreeNode\u0026lt;K,V\u0026gt;)p).putTreeVal(this, tab, hash, key, value); else { for (int binCount = 0; ; ++binCount) { if ((e = p.next) == null) { p.next = newNode(hash, key, value, null); if (binCount \u0026gt;= TREEIFY_THRESHOLD - 1) // -1 for 1st treeifyBin(tab, hash); break; } if (e.hash == hash \u0026amp;\u0026amp; ((k = e.key) == key || (key != null \u0026amp;\u0026amp; key.equals(k)))) break; p = e; } } if (e != null) { // existing mapping for key V oldValue = e.value; if (!onlyIfAbsent || oldValue == null) e.value = value; afterNodeAccess(e); return oldValue; } } ++modCount; if (++size \u0026gt; threshold) resize(); afterNodeInsertion(evict); return null; } \u0026lt;!----\u0026gt; final void treeifyBin(Node\u0026lt;K,V\u0026gt;[] tab, int hash) { int n, index; Node\u0026lt;K,V\u0026gt; e; if (tab == null || (n = tab.length) \u0026lt; MIN_TREEIFY_CAPACITY) resize(); else if ((e = tab[index = (n - 1) \u0026amp; hash]) != null) { TreeNode\u0026lt;K,V\u0026gt; hd = null, tl = null; do { TreeNode\u0026lt;K,V\u0026gt; p = replacementTreeNode(e, null); if (tl == null) hd = p; else { p.prev = tl; tl.next = p; } tl = p; } while ((e = e.next) != null); if ((tab[index] = hd) != null) hd.treeify(tab); } } åŒæ ·ï¼Œget(key)çš„æ—¶å€™ä¹Ÿä¼šç›¸åº”çš„ä»æ ‘ä¸­æŸ¥æ‰¾å…ƒç´ ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/deep-in-implementation-of-hashset/","tags":["Java"],"title":"æ·±å…¥å‰–æ HashSet å’Œ HashMap å®ç°"},{"categories":["ç¬”è®°"],"contents":"å¤šçº¿ç¨‹ä¸‹çš„å•ä¾‹æ¨¡å¼çš„å®ç°ï¼Œé¡ºä¾¿åšäº†åæ±‡ç¼–ã€‚\npublic class MySingleton { private static MySingleton INSTANCE; private MySingleton() { } public static MySingleton getInstance() { if (INSTANCE == null) { synchronized (MySingleton.class) { INSTANCE = new MySingleton(); } } return INSTANCE; } } Compiled from \u0026#34;MySingleton.java\u0026#34; public class MySingleton { public static MySingleton getInstance(); Code: 0: getstatic #2 // Field INSTANCE:LMySingleton; //+è·å¾—ç±»çš„æŒ‡å®šåŸŸï¼Œå¹¶å‹å…¥æ ˆé¡¶ 3: ifnonnull 32\t//+ä¸ä¸ºnullæ—¶è·³è½¬åˆ°è¡Œå·32 6: ldc_w #3 // class MySingleton //+å¸¸é‡å€¼ä»å¸¸é‡æ± ä¸­æ¨é€è‡³æ ˆé¡¶ï¼ˆå®½ç´¢å¼•ï¼‰ï¼Œæ¨é€çš„ä¸ºåœ°å€ 9: dup //+å¤åˆ¶æ ˆé¡¶æ•°å€¼ï¼Œå¹¶ä¸”å¤åˆ¶å€¼è¿›æ ˆ 10: astore_0 //+å°†æ ˆé¡¶æ•°å€¼ï¼ˆobjectrefï¼‰å­˜å…¥å½“å‰ frameçš„å±€éƒ¨å˜é‡æ•°ç»„ä¸­æŒ‡å®šä¸‹æ ‡(indexï¼‰å¤„çš„å˜é‡ä¸­ï¼Œæ ˆé¡¶æ•°å€¼å‡ºæ ˆã€‚è¿™é‡Œå­˜çš„æ˜¯MySingletonç±»å®šä¹‰çš„åœ°å€ 11: monitorenter //+è·å¾—å¯¹è±¡é”å³MySingletonåœ°å€ 12: new #3 // class MySingleton //+åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”å…¶å¼•ç”¨è¿›æ ˆ 15: dup //+å¤åˆ¶æ ˆé¡¶æ•°å€¼ï¼Œå¹¶ä¸”å¤åˆ¶å€¼è¿›æ ˆ 16: invokespecial #4 // Method \u0026#34;\u0026lt;init\u0026gt;\u0026#34;:()V //+è°ƒç”¨è¶…ç±»æ„é€ æ–¹æ³•ã€å®ä¾‹åˆå§‹åŒ–æ–¹æ³•ã€ç§æœ‰æ–¹æ³• 19: putstatic #2 // Field INSTANCE:LMySingleton; //+ä¸ºæŒ‡å®šçš„ç±»çš„é™æ€åŸŸèµ‹å€¼ 22: aload_0 //+å½“å‰frameçš„å±€éƒ¨å˜é‡æ•°ç»„ä¸­ä¸‹æ ‡ä¸º indexçš„å¼•ç”¨å‹å±€éƒ¨å˜é‡è¿›æ ˆï¼Œè¿™é‡Œæ˜¯MySingletonç±»å®šä¹‰çš„åœ°å€ 23: monitorexit //+é‡Šæ”¾å¯¹è±¡é” 24: goto 32\t//+è·³è½¬åˆ°è¡Œå·32 27: astore_1 //+å°†æ ˆé¡¶æ•°å€¼ï¼ˆobjectrefï¼‰å­˜å…¥å½“å‰ frameçš„å±€éƒ¨å˜é‡æ•°ç»„ä¸­æŒ‡å®šä¸‹æ ‡(indexï¼‰å¤„çš„å˜é‡ä¸­ï¼Œæ ˆé¡¶æ•°å€¼å‡ºæ ˆã€‚ 28: aload_0 //+å½“å‰frameçš„å±€éƒ¨å˜é‡æ•°ç»„ä¸­ä¸‹æ ‡ä¸º 0çš„å¼•ç”¨å‹å±€éƒ¨å˜é‡è¿›æ ˆ 29: monitorexit //+//+é‡Šæ”¾å¯¹è±¡é” 30: aload_1 //+å½“å‰frameçš„å±€éƒ¨å˜é‡æ•°ç»„ä¸­ä¸‹æ ‡ä¸º 1çš„å¼•ç”¨å‹å±€éƒ¨å˜é‡è¿›æ ˆ 31: athrow //+å°†æ ˆé¡¶çš„æ•°å€¼ä½œä¸ºå¼‚å¸¸æˆ–é”™è¯¯æŠ›å‡º 32: getstatic #2 // Field INSTANCE:LMySingleton; //+è·å¾—ç±»çš„æŒ‡å®šåŸŸï¼Œå¹¶å‹å…¥æ ˆé¡¶ 35: areturn //+ä»æ–¹æ³•ä¸­è¿”å›ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ Exception table: from to target type 12 24 27 any 27 30 27 any } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/singleton-in-multi-threads-programming/","tags":["Java"],"title":"å¤šçº¿ç¨‹ä¸‹çš„å•ä¾‹æ¨¡å¼+åæ±‡ç¼–"},{"categories":["ç¬”è®°"],"contents":"spring amqpçš„åŸç”Ÿå¹¶æ²¡æœ‰å¯¹KryoåŠ ä»¥æ”¯æŒï¼ŒKryoçš„ä¼˜ç‚¹å°±ä¸å¤šè¯´äº†ã€‚\ngitåœ°å€ï¼šhttps://github.com/addozhang/spring-kryo-messaeg-converter\npublic class KryoMessageConverter extends AbstractMessageConverter { public static final String CONTENT_TYPE = \u0026#34;application/x-kryo\u0026#34;; public static final String DEFAULT_CHARSET = \u0026#34;UTF-8\u0026#34;; private String defaultCharset = DEFAULT_CHARSET; private KryoFactory kryoFactory = new DefaultKryoFactory(); /** * Crate a message from the payload object and message properties provided. The message id will be added to the * properties if necessary later. * * @param object the payload * @param messageProperties the message properties (headers) * @return a message */ @Override protected Message createMessage(Object object, MessageProperties messageProperties) { byte[] bytes = null; Kryo kryo = kryoFactory.create(); Output output = new ByteBufferOutput(4096, 1024 * 1024); try { kryo.writeClassAndObject(output, object); bytes = output.toBytes(); } finally { output.close(); } messageProperties.setContentType(CONTENT_TYPE); if (messageProperties.getContentEncoding() == null) { messageProperties.setContentEncoding(defaultCharset); } return new Message(bytes, messageProperties); } @Override public Object fromMessage(Message message) throws MessageConversionException { Object content = null; MessageProperties properties = message.getMessageProperties(); if (properties != null) { if (properties.getContentType() != null \u0026amp;amp;\u0026amp;amp; properties.getContentType().contains(\u0026#34;x-kryo\u0026#34;)) { Kryo kryo = kryoFactory.create(); content = kryo.readClassAndObject(new ByteBufferInput(message.getBody())); } else { throw new MessageConversionException(\u0026#34;Converter not applicable to this message\u0026#34;); } } return content; } private class DefaultKryoFactory implements KryoFactory { @Override public Kryo create() { Kryo kryo = new Kryo(); return kryo; } } } ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/use-kryo-in-spring-amqp-serialization/","tags":["Java","Spring"],"title":"ä½¿ç”¨Kryoæ›¿æ¢spring amqpçš„Javaåºåˆ—åŒ–"},{"categories":["ç¬”è®°"],"contents":"å·¥ä½œä¸­å¾ˆå¤šåœºæ™¯éœ€è¦ç”¨åˆ°å®šæ—¶ä»»åŠ¡ã€å»¶è¿Ÿä»»åŠ¡ï¼Œå¸¸ç”¨çš„æ–¹æ³•ç”¨crontab jobã€Springçš„Quartzï¼Œç„¶åæ‰«ææ•´å¼ æ•°æ®åº“è¡¨ï¼Œåˆ¤æ–­å“ªäº›æ•°æ®éœ€è¦å¤„ç†ã€‚æ§åˆ¶çš„ç²’åº¦æ²¡åŠæ³•åšåˆ°ç‰¹å®šæ•°æ®ä¸Šã€‚ åæ¥å°±æƒ³åˆ°äº†Rabbitmqï¼ŒRabbitmqæœ¬æ¥ä¸æ²¡æœ‰å»¶è¿Ÿé˜Ÿåˆ—çš„åŠŸèƒ½ï¼Œä½†æ˜¯æœ‰ä¸ª[Dead Letter Exchange](https://www.rabbitmq.com/dlx.html)åŠŸèƒ½ã€‚ DLXæ˜¯æŒ‡é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åœ¨ä¸‹é¢å‡ ç§æƒ…å†µä¸‹ä¼šå˜ä¸ºæ­»ä¿¡ï¼ˆdead letterï¼‰ï¼Œç„¶åä¼šè¢«å‘å¸ƒåˆ°å¦ä¸€ä¸ªexchangeä¸­ã€‚ åœ¨requeue=falseçš„æƒ…å†µç³»ï¼Œæ¶ˆæ¯è¢«client reject æ¶ˆæ¯è¿‡æœŸ é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é™åˆ¶ æœ‰äº†DLXï¼Œå°±å¯ä»¥å°†éœ€è¦å»¶è¿Ÿçš„æ“ä½œè®¾ç½®ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ï¼ˆå¦‚æ¶ˆæ¯çš„TTLæ—¶é—´ï¼‰æ”¾å…¥ä¸€ä¸ªå­˜å‚¨é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆæ¯è¿‡æœŸåä¼šç»ç”±DLXè¿›å…¥ç›‘å¬çš„é˜Ÿåˆ—ä¸­ã€‚æœ‰æ¶ˆè´¹æ–¹è¿›è¡Œç›¸å…³çš„æ“ä½œï¼Œç»“æŸæˆ–è€…å†æ¬¡è¿›å…¥å­˜å‚¨é˜Ÿåˆ—ä¸­ã€‚ Spring AMQPå®ç° Configuration: \u0026lt;rabbit:connection-factoryÂ id=\"rabbitMQConnectionFactory\"Â requested-heartbeat=\"\"Â host=\"${rabbit.host}\" port=\"${rabbit.port}\" username=\"${rabbit.username}\"Â password=\"${rabbit.password}\"Â publisher-confirms=\"true\" channel-cache-size=\"10\"/\u0026gt; \u0026lt;rabbit:adminÂ connection-factory=\"rabbitMQConnectionFactory\"/\u0026gt; \u0026lt;!--å£°æ˜å»¶æ—¶é˜Ÿåˆ—--\u0026gt; \u0026lt;rabbit:queueÂ id=\"delayQueue\"Â name=\"${rabbit.tracking.no.pre.track.delay.queue}\"\u0026gt; \u0026lt;rabbit:queue-arguments\u0026gt; \u0026lt;entryÂ key=\"x-dead-letter-exchange\"Â value=\"tracking_dead_exchange\"/\u0026gt; \u0026lt;/rabbit:queue-arguments\u0026gt; \u0026lt;/rabbit:queue\u0026gt; \u0026lt;!--å£°æ˜ç›‘å¬é˜Ÿåˆ—--\u0026gt; \u0026lt;rabbit:queueÂ id=\"preTrackingQueue\"Â name=\"${rabbit.tracking.no.pre.track.queue}\"/\u0026gt; \u0026lt;!--å£°æ˜DLX--\u0026gt; \u0026lt;rabbit:topic-exchangeÂ name=\"tracking_dead_exchange\"\u0026gt; \u0026lt;rabbit:bindings\u0026gt; \u0026lt;rabbit:bindingÂ pattern=\"#\"Â queue=\"${rabbit.tracking.no.pre.track.queue}\"/\u0026gt; \u0026lt;/rabbit:bindings\u0026gt; \u0026lt;/rabbit:topic-exchange\u0026gt; \u0026lt;rabbit:listener-containerÂ connection-factory=\"rabbitMQConnectionFactory\" concurrency=\"1\" prefetch=\"1\" acknowledge=\"auto\" message-converter=\"jackson2JsonMessageConverter\"\u0026gt; \u0026lt;rabbit:listenerÂ ref=\"trackingListener\"Â method=\"handleMessage\"Â queues=\"preTrackingQueue\"/\u0026gt; \u0026lt;/rabbit:listener-container\u0026gt; Code: @Component publicÂ classÂ TrackingListener{ privateÂ LoggerÂ LOGGERÂ =Â LoggerFactory.getLogger(TrackingListener.class); @Autowired privateÂ MessageConverterÂ jackson2JsonMessageConverter; @Autowired privateÂ RabbitTemplateÂ rabbitTemplate; @Autowired privateÂ QueueÂ delayQueue; publicÂ voidÂ handleMessage(TrackingMessageÂ trackingMessage){ LOGGER.info(\"InÂ Function:Â TrackingListener.handleMessage(trackingMessage={})\",Â newÂ Object[]{trackingMessage}); StringÂ expirationÂ =Â 60*60*1000Â +Â \"\"; if(trackingMessage.getRecordCount()Â ==Â 2Â \u0026amp;\u0026amp;Â trackingMessage.getStatus()Â ==Â 0){ //æ›´æ–°è¿å•åŠè®¢å•çŠ¶æ€ trackingMessage.setStatus(1); } MessagePropertiesÂ messagePropertiesÂ =Â newÂ MessageProperties(); messageProperties.setExpiration(expiration);Â //oneÂ hour messageProperties.setTimestamp(newÂ Date()); rabbitTemplate.send(delayQueue.getName(),Â jackson2JsonMessageConverter.toMessage(trackingMessage,Â messageProperties)); LOGGER.info(\"EndÂ Function:Â TrackingListener.handleMessage()\"); ","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/rabbitmq-delay-queue-implementation/","tags":["Java"],"title":"Rabbitmqå»¶è¿Ÿé˜Ÿåˆ—å®ç°"},{"categories":["ç¬”è®°"],"contents":"Springçš„åŠŸèƒ½è¶Šæ¥è¶Šå¼ºå¤§ï¼ŒåŒæ—¶ä¹Ÿè¶Šæ¥è¶Šè‡ƒè‚¿ã€‚æ¯”å¦‚æƒ³å¿«é€Ÿæ­å»ºä¸€ä¸ªåŸºäºSpringçš„é¡¹ç›®ï¼Œè§£å†³ä¾èµ–é—®é¢˜éå¸¸è€—æ—¶ã€‚Springçš„é¡¹ç›®æ¨¡æ¿çš„å‡ºç°å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡è¿™ä¸ªæè¿°æ–‡ä»¶ï¼Œå¯ä»¥å¿«é€Ÿçš„æ‰¾åˆ°ä½ æ‰€éœ€è¦çš„æ¨¡æ¿ã€‚\nç¬¬ä¸€æ¬¡è®¤è¯†SLF4Jå°±æ˜¯åœ¨è¿™äº›é¡¹ç›®æ¨¡æ¿é‡Œï¼Œå®ƒçš„å…¨ç§°æ˜¯Simple Logging Facade for Javaã€‚ä»å­—é¢ä¸Šå¯ä»¥çœ‹å‡ºå®ƒåªæ˜¯ä¸€ä¸ªFacadeï¼Œä¸æä¾›å…·ä½“çš„æ—¥å¿—è§£å†³æ–¹æ¡ˆï¼ŒåªæœåŠ¡äºå„ä¸ªæ—¥å¿—ç³»ç»Ÿã€‚ç®€å•è¯´æœ‰äº†å®ƒï¼Œæˆ‘ä»¬å°±å¯ä»¥éšæ„çš„æ›´æ¢æ—¥å¿—ç³»ç»Ÿï¼ˆå¦‚java.util.loggingã€logbackã€log4jï¼‰ã€‚æ¯”å¦‚åœ¨å¼€å‘çš„æ—¶å€™ä½¿ç”¨logbackï¼Œéƒ¨ç½²çš„æ—¶å€™å¯ä»¥åˆ‡æ¢åˆ°log4jï¼›å¦‚æœå…³é—­æ‰€æœ‰çš„logï¼Œåˆ‡æ¢åˆ°NOPå°±å¯ä»¥äº†ã€‚åªéœ€è¦æ›´æ”¹ä¾èµ–ï¼Œæä¾›æ—¥å¿—é…ç½®æ–‡ä»¶ï¼Œå…å»äº†ä¿®æ”¹ä»£ç çš„éº»çƒ¦ã€‚\né¦–å…ˆçœ‹å¦‚ä½•ä½¿ç”¨ï¼š\n[java] import org.slf4j.Logger; import org.slf4j.LoggerFactory;\npublic class HelloWorld { public static void main(String[] args) { Logger logger = LoggerFactory.getLogger(HelloWorld.class); logger.info(\u0026quot;Hello World\u0026quot;); } } [/java]\nSLF4Jå°è£…äº†ä½¿ç”¨èµ·æ¥å’Œå…¶ä»–æ—¥å¿—ç³»ç»Ÿä¸€æ ·ç®€å•ã€‚ä¸Šé¢æåˆ°è¿‡SLF4Jä¸æä¾›å…·ä½“çš„æ—¥å¿—è§£å†³æ–¹æ¡ˆï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ—¶å€™é™¤äº†è¦å¼•ç”¨SLF4JåŒ…ï¼Œè¿˜è¦å¼•ç”¨å…·ä½“çš„æ—¥å¿—è§£å†³æ–¹æ¡ˆåŒ…ï¼ˆlog4jã€logging\u0026ndash;JDKæä¾›ã€logbackï¼‰ï¼Œè¿˜æœ‰æ‰€å¯¹åº”çš„bindingåŒ…ï¼ˆslf4j-log4j_ã€slf4j-jdk14ã€logback-classic_ï¼‰ã€‚\nä»¥log4jä¸ºä¾‹ï¼Œæˆ‘ä»¬çœ‹SLF4Jçš„å®ç°æ–¹å¼ã€‚\nSLF4Jç±»åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šå°è¯•ä»ClassLoaderä¸­org/slf4j/impl/StaticLoggerBinder.classã€‚è¿™ä¸ªç±»æ¯”è¾ƒç‰¹æ®Šï¼Œæ¯ä¸ªbindingåŒ…é‡Œéƒ½æœ‰ã€‚ä¸åŒbindingåŒ…é‡Œçš„StaticLoggerBinderç±»ä¼šå»åˆå§‹åŒ–ä¸€ä¸ªç›¸åº”çš„å®ä¾‹ï¼Œå¦‚slf4j-log4jé‡Œï¼š\n[java] /**\næˆªå–çš„éƒ¨åˆ†ä»£ç  */ private StaticLoggerBinder() { loggerFactory = new Log4jLoggerFactory(); } [/java] è€ŒLog4jLoggerAdapterå®ç°äº†SLF4Jçš„Loggeræ¥å£ï¼Œä½¿ç”¨äº†Adapteræ¨¡å¼å¯¹Log4jçš„Loggerè¿›è¡Œäº†å°è£…å¹¶æš´éœ²äº†Loggerçš„æ¥å£ï¼ŒLog4jLoggerFactoryæŒæœ‰äº†Log4jLoggerAdapterçš„å®ä¾‹ã€‚\n[java] /**\næˆªå–çš„éƒ¨åˆ†ä»£ç  */ public class Log4jLoggerFactory implements ILoggerFactory { public Logger getLogger(String name) { Logger slf4jLogger = null; // protect against concurrent access of loggerMap synchronized (this) { slf4jLogger = (Logger) loggerMap.get(name); if (slf4jLogger == null) { org.apache.log4j.Logger log4jLogger; if(name.equalsIgnoreCase(Logger.ROOT_LOGGER_NAME)) { log4jLogger = LogManager.getRootLogger(); } else { log4jLogger = LogManager.getLogger(name); } slf4jLogger = new Log4jLoggerAdapter(log4jLogger); loggerMap.put(name, slf4jLogger); } } return slf4jLogger; } } [/java] å…·ä½“çš„Logè§£å†³æ–¹æ¡ˆå°±ä¸åšå‰–æäº†ã€‚\n","image":"https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/12/28/mocha.png","permalink":"https://atbug.com/about-slf4j/","tags":["Java"],"title":"å…³äºSLF4J"}]