<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Kubernetes on ä¹±ä¸–æµ®ç”Ÿ</title><link>https://atbug.com/tags/kubernetes/</link><description>Recent content in Kubernetes on ä¹±ä¸–æµ®ç”Ÿ</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Tue, 18 Jan 2022 12:03:59 +0800</lastBuildDate><atom:link href="https://atbug.com/tags/kubernetes/index.xml" rel="self" type="application/rss+xml"/><item><title>Kubernetes HPA åŸºäº Prometheus è‡ªå®šä¹‰æŒ‡æ ‡çš„å¯æ§å¼¹æ€§ä¼¸ç¼©</title><link>https://atbug.com/kubernetes-pod-autoscale-on-prometheus-metrics/</link><pubDate>Tue, 18 Jan 2022 12:03:59 +0800</pubDate><guid>https://atbug.com/kubernetes-pod-autoscale-on-prometheus-metrics/</guid><description>
&lt;p>åœ¨&lt;a href="https://mp.weixin.qq.com/s/GKS3DJHm4p0Tjtj8nJRGmA">ã€ŠKubernetes çš„è‡ªåŠ¨ä¼¸ç¼©ä½ ç”¨å¯¹äº†å—ï¼Ÿã€‹&lt;/a>
ä¸€æ–‡ä¸­è¯¦ç»†è¯´æ˜äº†å¦‚ä½•ä½¿ç”¨ Kubernetes çš„è‡ªåŠ¨ä¼¸ç¼©ã€‚åœ¨ Kubernetes ä¸­å¼¹æ€§ä¼¸ç¼©ä¸»è¦æœ‰ä¸‰ç§ï¼šHPAã€VPAã€CAã€‚æœ¬æ–‡ä¸å†è¯¦ç»†è¯´æ˜ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹é‚£ç¯‡æ–‡ç« ã€‚è¿™é‡Œä¸»è¦æ¥è¯´ä¸‹ Pod æ°´å¹³ç¼©æ”¾ &lt;a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">HPA&lt;/a>ã€‚&lt;/p>
&lt;p>éšç€ Kubernetes v1.23 çš„å‘å¸ƒï¼ŒHPA çš„ API æ¥åˆ°äº†ç¨³å®šç‰ˆ &lt;code>autoscaling/v2&lt;/code>ï¼š&lt;/p>
&lt;ul>
&lt;li>åŸºäºè‡ªå®šä¹‰æŒ‡æ ‡çš„ä¼¸ç¼©&lt;/li>
&lt;li>åŸºäºå¤šé¡¹æŒ‡æ ‡çš„ä¼¸ç¼©&lt;/li>
&lt;li>å¯é…ç½®çš„ä¼¸ç¼©è¡Œä¸º&lt;/li>
&lt;/ul>
&lt;p>ä»æœ€åˆçš„ v1 ç‰ˆæœ¬ HPA åªæ”¯æŒ CPUã€å†…å­˜åˆ©ç”¨ç‡çš„ä¼¸ç¼©ï¼Œåˆ°åæ¥çš„è‡ªå®šä¹‰æŒ‡æ ‡ã€èšåˆå±‚ API çš„æ”¯æŒï¼Œåˆ°äº† v1.18 ç‰ˆæœ¬åˆåŠ å…¥äº†é…ç½®ä¼¸ç¼©è¡Œä¸ºçš„æ”¯æŒï¼ŒHPA ä¹Ÿè¶Šæ¥è¶Šå¥½ç”¨ã€å¯é ã€‚&lt;/p>
&lt;p>ä¾é  CPU æˆ–è€…å†…å­˜æŒ‡æ ‡çš„æ‰©å®¹å¹¶éä½¿ç”¨æ‰€æœ‰ç³»ç»Ÿï¼Œçœ‹èµ·æ¥ä¹Ÿæ²¡é‚£ä¹ˆå¯é ã€‚å¯¹å¤§éƒ¨åˆ†çš„ web åç«¯ç³»ç»Ÿæ¥è¯´ï¼ŒåŸºäº RPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰çš„å¼¹æ€§ä¼¸ç¼©æ¥å¤„ç†çªå‘çš„æµé‡åˆ™ä¼šæ›´åŠ é è°±ã€‚&lt;/p>
&lt;p>Prometheus ä¹Ÿæ˜¯å½“ä¸‹æµè¡Œå¼€æºç›‘æ§ç³»ç»Ÿï¼Œé€šè¿‡ Prometheus å¯ä»¥è·å–åˆ°ç³»ç»Ÿçš„å®æ—¶æµé‡è´Ÿè½½æŒ‡æ ‡ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥å°è¯•ä¸‹åŸºäº Prometheus çš„è‡ªå®šä¹‰æŒ‡æ ‡è¿›è¡Œå¼¹æ€§ä¼¸ç¼©ã€‚&lt;/p>
&lt;p>&lt;strong>æ³¨ï¼šç›®å‰ HPA çš„ç¼©å®¹0 ï¼ˆscale to 0ï¼‰ï¼Œåˆ™éœ€è¦åœ¨ feature gate æ‰“å¼€ alpha ç‰ˆæœ¬çš„ &lt;code>HPAScaleToZero&lt;/code> ä»¥åŠé…ç½®ä¸€ä¸ªå¯¹è±¡æˆ–è€…å¤–éƒ¨æŒ‡æ ‡ã€‚å³ä½¿æ˜¯æ‰“å¼€äº†ï¼Œä» 0 åˆ° 1 çš„æ‰©å®¹éœ€è¦è°ƒåº¦ã€IP åˆ†é…ã€é•œåƒæ‹‰å–ç­‰è¿‡ç¨‹ï¼Œå­˜åœ¨ä¸€å®šçš„å¼€é”€ã€‚å¦‚æœé™ä½è¿™éƒ¨åˆ†å¼€é”€ï¼Œè¿™é‡Œå…ˆå–ä¸ªå…³å­ï¼Œåç»­çš„æ–‡ç« è¿›è¡Œè¡¥å……ã€‚&lt;/strong>&lt;/p>
&lt;p>æ–‡ç« ä¸­ä½¿ç”¨çš„æ‰€æœ‰ä»£ç éƒ½å¯ä»¥&lt;a href="https://github.com/addozhang/hpa-on-prometheus-metrics">ä»è¿™é‡Œä¸‹è½½&lt;/a>ã€‚&lt;/p>
&lt;h2 id="æ•´ä½“æ¶æ„">æ•´ä½“æ¶æ„&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/01/18/hpa2.png" alt="">&lt;/p>
&lt;p>HPA è¦è·å– Prometheus çš„æŒ‡æ ‡æ•°æ®ï¼Œè¿™é‡Œå¼•å…¥ &lt;a href="https://github.com/kubernetes-sigs/prometheus-adapter">Prometheus Adapter&lt;/a> ç»„ä»¶ã€‚Prometheus Adapter å®ç°äº† &lt;a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/instrumentation/resource-metrics-api.md">resource metrics&lt;/a>ã€&lt;a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/instrumentation/custom-metrics-api.md">custom metrics&lt;/a> å’Œ &lt;a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/instrumentation/external-metrics-api.md">external metrics APIs&lt;/a> APIï¼Œæ”¯æŒ &lt;em>autoscaling/v2&lt;/em> çš„ HPAã€‚&lt;/p>
&lt;p>è·å–åˆ°æŒ‡æ ‡æ•°æ®åï¼Œæ ¹æ®é¢„å®šä¹‰çš„è§„åˆ™å¯¹å·¥ä½œè´Ÿè½½çš„ç¤ºä¾‹æ•°è¿›è¡Œè°ƒæ•´ã€‚&lt;/p>
&lt;h2 id="ç¯å¢ƒæ­å»º">ç¯å¢ƒæ­å»º&lt;/h2>
&lt;h3 id="k3s">K3s&lt;/h3>
&lt;p>æˆ‘ä»¬ä½¿ç”¨æœ€æ–° 1.23 ç‰ˆæœ¬çš„ K3s ä½œä¸º Kubernetes ç¯å¢ƒã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nb">export&lt;/span> &lt;span class="nv">INSTALL_K3S_VERSION&lt;/span>&lt;span class="o">=&lt;/span>v1.23.1+k3s2
curl -sfL https://get.k3s.io &lt;span class="p">|&lt;/span> sh -s - --write-kubeconfig-mode &lt;span class="m">644&lt;/span> --write-kubeconfig ~/.kube/config
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ç¤ºä¾‹åº”ç”¨">ç¤ºä¾‹åº”ç”¨&lt;/h3>
&lt;p>æˆ‘ä»¬å‡†å¤‡ä¸€ä¸ªç®€å•çš„ web åº”ç”¨ï¼Œå¯ä»¥è®°å½•è¯·æ±‚æ¬¡æ•°å¹¶é€šè¿‡ &lt;code>/metrics&lt;/code> ç«¯ç‚¹è¾“å‡º Prometheus æ ¼å¼çš„æŒ‡æ ‡ &lt;code>http_requests_total&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">metrics&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">prometheus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewCounterVec&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">prometheus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CounterOpts&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;http_requests_total&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Help&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;Number of total http requests&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;status&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="nx">prometheus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MustRegister&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">metrics&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">path&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">URL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Path&lt;/span>
&lt;span class="nx">statusCode&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">200&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">path&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;/metrics&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">promhttp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Handler&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">ServeHTTP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">w&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WriteHeader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">statusCode&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">w&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello World!&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">metrics&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithLabelValues&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">strconv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Itoa&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">statusCode&lt;/span>&lt;span class="p">)).&lt;/span>&lt;span class="nf">Inc&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;:3000&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°†åº”ç”¨éƒ¨ç½²åˆ°é›†ç¾¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f kubernetes/sample-httpserver-deployment.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="prometheus">Prometheus&lt;/h3>
&lt;p>ä½¿ç”¨ Helm å®‰è£… Prometheusï¼Œå…ˆæ·»åŠ  prometheus çš„ chart ä»“åº“ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçš„æµ‹è¯•åªéœ€è¦ç”¨åˆ° prometheus-serverï¼Œå®‰è£…æ—¶ç¦ç”¨å…¶ä»–ç»„ä»¶ã€‚&lt;strong>åŒæ—¶ä¸ºäº†æ¼”ç¤ºæ•ˆæœçš„å®æ•ˆæ€§ï¼Œå°†æŒ‡æ ‡çš„æ‹‰å–é—´éš”è®¾ç½®ä¸º &lt;code>10s&lt;/code>&lt;/strong>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># install prometheus with some components disabled&lt;/span>
&lt;span class="c1"># set scrape interval to 10s&lt;/span>
helm install prometheus prometheus-community/prometheus -n default --set alertmanager.enabled&lt;span class="o">=&lt;/span>false,pushgateway.enabled&lt;span class="o">=&lt;/span>false,nodeExporter.enabled&lt;span class="o">=&lt;/span>false,kubeStateMetrics.enabled&lt;span class="o">=&lt;/span>false,server.global.scrape_interval&lt;span class="o">=&lt;/span>10s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šè¿‡ç«¯å£è½¬å‘ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—® web é¡µé¢ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># port forward&lt;/span>
kubectl port-forward svc/prometheus-server 9090:80 -n prometheus
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡ŒæŸ¥è¯¢ Pod çš„ RPS ä½¿ç”¨ &lt;code>sum(rate(http_requests_total[30s])) by (pod)&lt;/code> è¯­å¥æŸ¥è¯¢ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/01/18/20220118-at-112123.png" alt="">&lt;/p>
&lt;h3 id="prometheus-adapter">Prometheus Adapter&lt;/h3>
&lt;p>åŒæ ·ä½¿ç”¨ Helm å®‰è£… Produmetheus Adapterï¼Œè¿™é‡Œè¦è¿›è¡Œé¢å¤–çš„é…ç½®ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">helm install prometheus-adapter prometheus-community/prometheus-adapter -n default -f kubernetes/values-adapter.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é™¤äº†è¦é…ç½® Prometheus server çš„è®¿é—®æ–¹å¼å¤–ï¼Œè¿˜è¦é…ç½®è‡ªå®šä¹‰æŒ‡æ ‡çš„è®¡ç®—è§„åˆ™ï¼Œå‘Šè¯‰ adapter å¦‚ä½•ä» Prometheus è·å–æŒ‡æ ‡å¹¶è®¡ç®—å‡ºæˆ‘ä»¬éœ€è¦çš„æŒ‡æ ‡ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">rules:
default: false
custom:
- seriesQuery: &amp;#39;{__name__=~&amp;#34;^http_requests.*_total$&amp;#34;,container!=&amp;#34;POD&amp;#34;,namespace!=&amp;#34;&amp;#34;,pod!=&amp;#34;&amp;#34;}&amp;#39;
resources:
overrides:
namespace: { resource: &amp;#34;namespace&amp;#34; }
pod: { resource: &amp;#34;pod&amp;#34; }
name:
matches: &amp;#34;(.*)_total&amp;#34;
as: &amp;#34;${1}_qps&amp;#34;
metricsQuery: sum(rate(&amp;lt;&amp;lt;.Series&amp;gt;&amp;gt;{&amp;lt;&amp;lt;.LabelMatchers&amp;gt;&amp;gt;}[30s])) by (&amp;lt;&amp;lt;.GroupBy&amp;gt;&amp;gt;)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥å‚è€ƒè¯¦ç»†çš„ &lt;a href="https://github.com/kubernetes-sigs/prometheus-adapter/blob/master/docs/sample-config.yaml">Adapter é…ç½®&lt;/a>ã€‚&lt;/p>
&lt;p>å¾… promethues-adapter pod æˆåŠŸè¿è¡Œåï¼Œå¯ä»¥æ‰§è¡Œ &lt;code>custom.metrics.k8s.io&lt;/code> è¯·æ±‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get --raw &lt;span class="s1">&amp;#39;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/http_requests_qps&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> jq .
&lt;span class="o">{&lt;/span>
&lt;span class="s2">&amp;#34;kind&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;MetricValueList&amp;#34;&lt;/span>,
&lt;span class="s2">&amp;#34;apiVersion&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;custom.metrics.k8s.io/v1beta1&amp;#34;&lt;/span>,
&lt;span class="s2">&amp;#34;metadata&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;span class="s2">&amp;#34;selfLink&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/http_requests_qps&amp;#34;&lt;/span>
&lt;span class="o">}&lt;/span>,
&lt;span class="s2">&amp;#34;items&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;span class="o">{&lt;/span>
&lt;span class="s2">&amp;#34;describedObject&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;span class="s2">&amp;#34;kind&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;Pod&amp;#34;&lt;/span>,
&lt;span class="s2">&amp;#34;namespace&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;default&amp;#34;&lt;/span>,
&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;sample-httpserver-64c495844f-b58pl&amp;#34;&lt;/span>,
&lt;span class="s2">&amp;#34;apiVersion&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;/v1&amp;#34;&lt;/span>
&lt;span class="o">}&lt;/span>,
&lt;span class="s2">&amp;#34;metricName&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;http_requests_qps&amp;#34;&lt;/span>,
&lt;span class="s2">&amp;#34;timestamp&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;2022-01-18T03:32:51Z&amp;#34;&lt;/span>,
&lt;span class="s2">&amp;#34;value&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;100m&amp;#34;&lt;/span>,
&lt;span class="s2">&amp;#34;selector&amp;#34;&lt;/span>: null
&lt;span class="o">}&lt;/span>
&lt;span class="o">]&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ³¨æ„ï¼šè¿™é‡Œçš„ &lt;code>value: 100m&lt;/code>ï¼Œå€¼çš„åç¼€â€œmâ€ æ ‡è¯† &lt;code>milli-requests per seconds&lt;/code>ï¼Œæ‰€ä»¥è¿™é‡Œçš„ 100m çš„æ„æ€æ˜¯ 0.1/s æ¯ç§’0.1 ä¸ªè¯·æ±‚ã€‚&lt;/strong>&lt;/p>
&lt;h3 id="hpa">HPA&lt;/h3>
&lt;p>æœ€åå°±æ˜¯ HPA çš„é…ç½®äº†ï¼š&lt;/p>
&lt;ol>
&lt;li>æœ€å°æœ€å¤§çš„å‰¯æœ¬æ•°åˆ†åˆ«è®¾ç½® 1ã€10&lt;/li>
&lt;li>ä¸ºäº†æµ‹è¯•æ•ˆæœçš„å®æ•ˆæ€§ï¼Œè®¾ç½®æ‰©ç¼©å®¹çš„è¡Œä¸º &lt;code>behavior&lt;/code>&lt;/li>
&lt;li>æŒ‡å®šæŒ‡æ ‡ &lt;code>http_requests_qps&lt;/code>ã€ç±»å‹ &lt;code>Pods&lt;/code> ä»¥åŠç›®æ ‡å€¼ &lt;code>50000m&lt;/code>ï¼šè¡¨ç¤ºå¹³å‡æ¯ä¸ª pod çš„ RPS &lt;code>50&lt;/code> ã€‚æ¯”å¦‚ä»¥ 300 çš„ RPS è®¿é—®ï¼Œå‰¯æœ¬æ•°å°±æ˜¯ 300/50=6 ã€‚&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">HorizontalPodAutoscaler&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">autoscaling/v2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample-httpserver&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scaleTargetRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample-httpserver&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">minReplicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">maxReplicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">behavior&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scaleDown&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">stabilizationWindowSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">policies&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Percent&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">100&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">15&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scaleUp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">stabilizationWindowSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">policies&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Percent&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">100&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">15&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metrics&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pods&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">pods&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metric&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http_requests_qps&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">target&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">AverageValue&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">averageValue&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">50000m&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æµ‹è¯•">æµ‹è¯•&lt;/h2>
&lt;p>æµ‹è¯•å·¥å…·é€‰ç”¨ &lt;a href="https://github.com/tsenart/vegeta">&lt;code>vegeta&lt;/code>&lt;/a>ï¼Œå› ä¸ºå…¶å¯ä»¥æŒ‡å®š RPSã€‚&lt;/p>
&lt;p>å…ˆä¸ºåº”ç”¨åˆ›å»º NodePort serviceï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl expose deploy sample-httpserver --name sample-httpserver-host --type NodePort --target-port &lt;span class="m">3000&lt;/span>
kubectl get svc sample-httpserver-host
NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
sample-httpserver-host NodePort 10.43.66.206 &amp;lt;none&amp;gt; 3000:31617/TCP 12h
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ†åˆ«ä½¿ç”¨ &lt;code>240&lt;/code>ã€&lt;code>120&lt;/code>ã€&lt;code>40&lt;/code> çš„ RPS å‘èµ·è¯·æ±‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># 240&lt;/span>
&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;GET http://192.168.1.92:31617&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> vegeta attack -duration 60s -connections &lt;span class="m">10&lt;/span> -rate &lt;span class="m">240&lt;/span> &lt;span class="p">|&lt;/span> vegeta report
&lt;span class="c1"># 120&lt;/span>
&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;GET http://192.168.1.92:31617&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> vegeta attack -duration 60s -connections &lt;span class="m">10&lt;/span> -rate &lt;span class="m">120&lt;/span> &lt;span class="p">|&lt;/span> vegeta report
&lt;span class="c1"># 40&lt;/span>
&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;GET http://192.168.1.92:31617&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> vegeta attack -duration 60s -connections &lt;span class="m">10&lt;/span> -rate &lt;span class="m">40&lt;/span> &lt;span class="p">|&lt;/span> vegeta report
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä» Prometheus çš„ web ç•Œé¢ä¸Šè§‚å¯Ÿè¯·æ±‚é‡ä¸ç¤ºä¾‹æ•°çš„å˜åŒ–ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/01/18/20220118-at-091913.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2022/01/18/20220118-at-091941.png" alt="">&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl describe hpa sample-httpserver
Warning: autoscaling/v2beta2 HorizontalPodAutoscaler is deprecated in v1.23+, unavailable in v1.26+&lt;span class="p">;&lt;/span> use autoscaling/v2 HorizontalPodAutoscaler
Name: sample-httpserver
Namespace: default
Labels: &amp;lt;none&amp;gt;
Annotations: &amp;lt;none&amp;gt;
CreationTimestamp: Mon, &lt;span class="m">17&lt;/span> Jan &lt;span class="m">2022&lt;/span> 23:18:46 +0800
Reference: Deployment/sample-httpserver
Metrics: &lt;span class="o">(&lt;/span> current / target &lt;span class="o">)&lt;/span>
&lt;span class="s2">&amp;#34;http_requests_qps&amp;#34;&lt;/span> on pods: 100m / &lt;span class="m">50&lt;/span>
Min replicas: &lt;span class="m">1&lt;/span>
Max replicas: &lt;span class="m">10&lt;/span>
Behavior:
Scale Up:
Stabilization Window: &lt;span class="m">0&lt;/span> seconds
Select Policy: Max
Policies:
- Type: Percent Value: &lt;span class="m">100&lt;/span> Period: &lt;span class="m">15&lt;/span> seconds
Scale Down:
Stabilization Window: &lt;span class="m">30&lt;/span> seconds
Select Policy: Max
Policies:
- Type: Percent Value: &lt;span class="m">100&lt;/span> Period: &lt;span class="m">15&lt;/span> seconds
Deployment pods: &lt;span class="m">1&lt;/span> current / &lt;span class="m">1&lt;/span> desired
Conditions:
Type Status Reason Message
---- ------ ------ -------
AbleToScale True ReadyForNewScale recommended size matches current size
ScalingActive True ValidMetricFound the HPA was able to successfully calculate a replica count from pods metric http_requests_qps
ScalingLimited False DesiredWithinRange the desired count is within the acceptable range
Events:
Type Reason Age From Message
---- ------ ---- ---- -------
Normal SuccessfulRescale 25m horizontal-pod-autoscaler New size: 6&lt;span class="p">;&lt;/span> reason: pods metric http_requests_qps above target
Normal SuccessfulRescale 19m horizontal-pod-autoscaler New size: 4&lt;span class="p">;&lt;/span> reason: All metrics below target
Normal SuccessfulRescale 12m &lt;span class="o">(&lt;/span>x2 over 9h&lt;span class="o">)&lt;/span> horizontal-pod-autoscaler New size: 4&lt;span class="p">;&lt;/span> reason: pods metric http_requests_qps above target
Normal SuccessfulRescale 11m horizontal-pod-autoscaler New size: 5&lt;span class="p">;&lt;/span> reason: pods metric http_requests_qps above target
Normal SuccessfulRescale 9m40s &lt;span class="o">(&lt;/span>x2 over 12m&lt;span class="o">)&lt;/span> horizontal-pod-autoscaler New size: 2&lt;span class="p">;&lt;/span> reason: pods metric http_requests_qps above target
Normal SuccessfulRescale 9m24s &lt;span class="o">(&lt;/span>x4 over 10h&lt;span class="o">)&lt;/span> horizontal-pod-autoscaler New size: 3&lt;span class="p">;&lt;/span> reason: pods metric http_requests_qps above target
Normal SuccessfulRescale 7m54s &lt;span class="o">(&lt;/span>x3 over 9h&lt;span class="o">)&lt;/span> horizontal-pod-autoscaler New size: 2&lt;span class="p">;&lt;/span> reason: All metrics below target
Normal SuccessfulRescale 7m39s &lt;span class="o">(&lt;/span>x4 over 9h&lt;span class="o">)&lt;/span> horizontal-pod-autoscaler New size: 1&lt;span class="p">;&lt;/span> reason: All metrics below target
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>åŸºäºè‡ªå®šä¹‰æŒ‡æ ‡æ¯”å¦‚æ¯ç§’è¯·æ±‚é‡è¿›è¡Œåº”ç”¨çš„æ°´å¹³æ‰©å®¹ç›¸æ¯” CPU/å†…å­˜ ä½œä¸ºä¾æ®æ›´åŠ é è°±ï¼Œé€‚ç”¨äºå¤§éƒ¨åˆ†çš„ web ç³»ç»Ÿã€‚åœ¨çªå‘æµé‡æ—¶å¯ä»¥è¿›è¡Œå¿«é€Ÿæ‰©å®¹ï¼Œé€šè¿‡å¯¹ä¼¸ç¼©è¡Œä¸ºçš„æ§åˆ¶ï¼Œå¯ä»¥å‡å°‘å‰¯æœ¬æ•°çš„æŠ–åŠ¨ã€‚Promeheus ä½œä¸ºæµè¡Œåº”ç”¨çš„ç›‘æ§ç³»ç»Ÿï¼Œåœ¨ Adapter å’Œ Aggregate API çš„æ”¯æŒä¸‹ï¼Œå¯ä»¥ä½œä¸ºä¼¸ç¼©çš„æŒ‡æ ‡ã€‚&lt;/p>
&lt;p>ç›®å‰ HPA çš„ &lt;em>scale to 0&lt;/em> è¿˜åœ¨ alpha çš„é˜¶æ®µï¼Œè¿˜éœ€è¦å…³æ³¨å‰¯æœ¬ä» 0 åˆ° N çš„å®æ•ˆæ€§ã€‚å¦‚æœæœ€å°å‰¯æœ¬æ•°å¤§äº0 ï¼Œå¯¹æŸäº›æœåŠ¡æ¥è¯´åˆä¼šå ç”¨èµ„æºã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šä¸ºå°è¯•è§£å†³ 0 åˆ° N çš„æ€§èƒ½ï¼Œä»¥åŠèµ„æºå ç”¨çš„é—®é¢˜ã€‚&lt;/p></description></item><item><title>Colimaï¼šMacOS ä¸Šçš„æç®€å®¹å™¨è¿è¡Œæ—¶å’Œ Kubernetesï¼ˆæ”¯æŒ m1ï¼‰</title><link>https://atbug.com/containers-runtime-on-macos-with-colima/</link><pubDate>Sun, 26 Dec 2021 12:31:16 +0800</pubDate><guid>https://atbug.com/containers-runtime-on-macos-with-colima/</guid><description>
&lt;p>&lt;a href="https://github.com/abiosoft/colima">Colima&lt;/a> æ˜¯ä¸€ä¸ªä»¥æœ€å°åŒ–è®¾ç½®æ¥åœ¨MacOSä¸Šè¿è¡Œå®¹å™¨è¿è¡Œæ—¶å’Œ Kubernetes çš„å·¥å…·ã€‚æ”¯æŒ m1ï¼ˆæ–‡æœ«è®¨è®ºï¼‰ï¼ŒåŒæ ·ä¹Ÿæ”¯æŒ Linuxã€‚&lt;/p>
&lt;p>Colima çš„åå­—å–è‡ª Container on Limaã€‚&lt;a href="https://github.com/lima-vm/lima">Lima&lt;/a> æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºå·¥å…·ï¼Œå¯ä»¥å®ç°è‡ªåŠ¨çš„æ–‡ä»¶å…±äº«ã€ç«¯å£è½¬å‘ä»¥åŠ containerdã€‚&lt;/p>
&lt;p>Colima å®é™…ä¸Šæ˜¯é€šè¿‡ Lima å¯åŠ¨äº†åä¸º &lt;code>colima&lt;/code> çš„è™šæ‹Ÿæœºï¼Œä½¿ç”¨è™šæ‹Ÿæœºä¸­çš„ containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/26/colima.gif" alt="colima">&lt;/p>
&lt;h2 id="ä½¿ç”¨">ä½¿ç”¨&lt;/h2>
&lt;p>Colima çš„ä½¿ç”¨å¾ˆç®€å•ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥åˆ›å»ºè™šæ‹Ÿæœºï¼Œé»˜è®¤æ˜¯ Docker çš„è¿è¡Œæ—¶ã€‚&lt;/p>
&lt;p>åˆæ¬¡è¿è¡Œéœ€è¦ä¸‹è½½è™šæ‹Ÿæœºé•œåƒåˆ›å»ºè™šæ‹Ÿæœºï¼Œè€—æ—¶å› ç½‘ç»œæƒ…å†µæœ‰æ‰€å·®å¼‚ã€‚ä¹‹åï¼Œå¯åŠ¨è™šæ‹Ÿæœºå°±åªéœ€è¦ 30s å·¦å³çš„æ—¶é—´ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">colima start
INFO&lt;span class="o">[&lt;/span>0000&lt;span class="o">]&lt;/span> starting colima
INFO&lt;span class="o">[&lt;/span>0000&lt;span class="o">]&lt;/span> creating and starting ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>vm
INFO&lt;span class="o">[&lt;/span>0119&lt;span class="o">]&lt;/span> provisioning ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>docker
INFO&lt;span class="o">[&lt;/span>0119&lt;span class="o">]&lt;/span> provisioning in VM ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>docker
INFO&lt;span class="o">[&lt;/span>0133&lt;span class="o">]&lt;/span> restarting VM to &lt;span class="nb">complete&lt;/span> setup ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>docker
INFO&lt;span class="o">[&lt;/span>0133&lt;span class="o">]&lt;/span> stopping ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>vm
INFO&lt;span class="o">[&lt;/span>0136&lt;span class="o">]&lt;/span> starting ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>vm
INFO&lt;span class="o">[&lt;/span>0158&lt;span class="o">]&lt;/span> starting ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>docker
INFO&lt;span class="o">[&lt;/span>0159&lt;span class="o">]&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ­¤æ—¶ï¼Œåœ¨å®¿ä¸»æœºä¸Šå°±å¯ä»¥ä½¿ç”¨ Docker ç›¸å…³çš„å‘½ä»¤äº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
docker pull busybox
docker images
REPOSITORY TAG IMAGE ID CREATED SIZE
busybox latest b34806a1af7a &lt;span class="m">2&lt;/span> weeks ago 1.41MB
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå¯ä»¥ä½¿ç”¨ Lima çš„å‘½ä»¤è¡Œ &lt;code>limact&lt;/code>å·¥å…·æŸ¥çœ‹è™šæ‹Ÿæœºçš„æƒ…å†µï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">limactl list
NAME STATUS SSH ARCH CPUS MEMORY DISK DIR
colima Running 127.0.0.1:64505 aarch64 &lt;span class="m">2&lt;/span> 2GiB 60GiB /Users/addo/.lima/colima
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹æ“ä½œç³»ç»Ÿä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">uname -a
Darwin Addos-Macbook-Pro.local 21.2.0 Darwin Kernel Version 21.2.0: Sun Nov &lt;span class="m">28&lt;/span> 20:28:41 PST 2021&lt;span class="p">;&lt;/span> root:xnu-8019.61.5~1/RELEASE_ARM64_T6000 arm64
limactl shell colima uname -a
Linux lima-colima 5.13.0-22-generic &lt;span class="c1">#22-Ubuntu SMP Fri Nov 5 13:22:27 UTC 2021 aarch64 aarch64 aarch64 GNU/Linux&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…ä½¿ç”¨ Colima çš„ &lt;code>ssh&lt;/code> å‘½ä»¤è¿›å…¥è™šæ‹Ÿæœºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># on host&lt;/span>
colima ssh
&lt;span class="c1"># in vm&lt;/span>
uname -a
Linux lima-colima 5.13.0-22-generic &lt;span class="c1">#22-Ubuntu SMP Fri Nov 5 13:22:27 UTC 2021 aarch64 aarch64 aarch64 GNU/Linux&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å…¶ä»–è¿è¡Œæ—¶">å…¶ä»–è¿è¡Œæ—¶&lt;/h3>
&lt;p>ä¹Ÿå¯ä»¥åœ¨åˆ›å»ºçš„æ—¶å€™é€šè¿‡ &lt;code>--runtime containerd&lt;/code> å‚æ•°æŒ‡å®šä½¿ç”¨ Containerd ä½œä¸ºè¿è¡Œæ—¶ã€‚æ­¤æ—¶å°±éœ€è¦ä½¿ç”¨ &lt;code>colima nerdctl&lt;/code> æ¥ä½¿ç”¨ &lt;code>nerdctl&lt;/code> ä¸ Containerd è¿›è¡Œäº¤äº’ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">colima start --runtime containerd
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŒæ ·ï¼Œè¿˜å¯ä»¥åˆ›å»ºä¸€ä¸ª k3s ä½œä¸º Kubernetes è¿è¡Œæ—¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">colima start --with-kubernetes
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="demo">Demo&lt;/h2>
&lt;p>æˆ‘ä»¬å°è¯•å¯åŠ¨ä¸€ä¸ª nginx å®¹å™¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker run --rm -d --name nginx -p 8080:80 nginx:latest
docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
20d6c56e038b nginx:latest &lt;span class="s2">&amp;#34;/docker-entrypoint.â€¦&amp;#34;&lt;/span> &lt;span class="m">9&lt;/span> seconds ago Up &lt;span class="m">8&lt;/span> seconds 0.0.0.0:8080-&amp;gt;80/tcp, :::8080-&amp;gt;80/tcp nginx
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Colima ä¼šè‡ªåŠ¨é…ç½®ç«¯å£è½¬å‘ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -I http://localhost:8080
HTTP/1.1 &lt;span class="m">200&lt;/span> OK
Server: nginx/1.21.4
Date: Sun, &lt;span class="m">26&lt;/span> Dec &lt;span class="m">2021&lt;/span> 04:17:22 GMT
Content-Type: text/html
Content-Length: &lt;span class="m">615&lt;/span>
Last-Modified: Tue, &lt;span class="m">02&lt;/span> Nov &lt;span class="m">2021&lt;/span> 14:49:22 GMT
Connection: keep-alive
ETag: &lt;span class="s2">&amp;#34;61814ff2-267&amp;#34;&lt;/span>
Accept-Ranges: bytes
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="è™šæ‹Ÿæœºé…ç½®">è™šæ‹Ÿæœºé…ç½®&lt;/h2>
&lt;p>Colima å¯åŠ¨çš„è™šæ‹Ÿæœºé»˜è®¤æ˜¯ 2CPUã€2GiB å†…å­˜ å’Œ 60GiB å­˜å‚¨ã€‚å¯ä»¥åœ¨åˆ›å»ºæ—¶é€šè¿‡ &lt;code>--cpu&lt;/code> ã€&lt;code>--memory&lt;/code> å’Œ &lt;code>--disk&lt;/code> æ¥åˆ†é…æ›´å¤šèµ„æºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">colima start --cpu &lt;span class="m">4&lt;/span> --memory &lt;span class="m">16&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå¯ä»¥ä¿®æ”¹å½“å‰è™šæ‹Ÿæœºçš„é…ç½®ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">colima stop
colima start --cpu &lt;span class="m">4&lt;/span> --memory &lt;span class="m">16&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åŒç±»å·¥å…·æ¯”è¾ƒ">åŒç±»å·¥å…·æ¯”è¾ƒ&lt;/h2>
&lt;p>å…¶å®æœ‰ä¸å°‘ç±»ä¼¼çš„å·¥å…·ï¼Œæ¯”å¦‚ kindã€k3d å’Œ minikube ä¸‰ç§éƒ½æ˜¯ç”¨æ¥åˆ›å»º Kubernetes ç¯å¢ƒã€‚æˆ‘ä¸ªäººæ­¤å‰ç”¨çš„ k3d å°±æ¯”è¾ƒå¤šã€‚&lt;/p>
&lt;p>å¯¹äº Docker å®¹å™¨ç¯å¢ƒï¼Œè¿™ä¸‰ä¸ªå…¶å®éƒ½æ²¡æœ‰æä¾›ã€‚minikube çš„è™šæ‹Ÿæœºä¸­ä¹Ÿæœ‰å®¹å™¨è¿è¡Œæ—¶ï¼Œä½†æ˜¯æ— æ³•å•çº¯å®‰è£… Docker ç¯å¢ƒã€‚&lt;/p>
&lt;p>å¯¹äº Kubernetes ç¯å¢ƒæ¥è¯´ï¼Œè¿™å‡ ç§éƒ½é€‚åˆï¼Œç›¸æ¯” Colima æ¥è¯´è¿˜æ”¯æŒåˆ›å»ºå¤šä¸ªé›†ç¾¤ï¼ˆå½“å‰ Colima æœ€æ–°ç‰ˆæœ¬æ˜¯ 0.2.2ï¼Œå¤šé›†ç¾¤çš„æ”¯æŒä¹Ÿåœ¨å¼€å‘ä¸­ã€‚ä¼°è®¡ 0.3.0 ä¼šæä¾›ï¼Œæ¯•ç«Ÿåˆ›å»ºå¤šä¸ªè™šæ‹Ÿæœºå°±èƒ½å®ç°ï¼‰ã€‚ä½†ä½¿ç”¨ Colima çš„è¯ï¼ŒKubernetes å’Œ Docker å¯ä»¥å…±äº«é•œåƒï¼ˆæœ¬åœ°é•œåƒï¼‰å’Œè¿è¡Œæ—¶ã€‚&lt;/p>
&lt;h2 id="ä¸è¶³">ä¸è¶³&lt;/h2>
&lt;h3 id="å¤šé›†ç¾¤çš„æ”¯æŒ">å¤šé›†ç¾¤çš„æ”¯æŒ&lt;/h3>
&lt;p>å‰é¢æåˆ°ï¼Œç›®å‰è¿˜ä¸æ”¯æŒåˆ›å»ºå¤šä¸ª Kubernetes é›†ç¾¤ï¼Œä¼°è®¡ 0.3.0 ä¼šæä¾›ã€‚&lt;/p>
&lt;h3 id="m1-çš„æ”¯æŒ">m1 çš„æ”¯æŒ&lt;/h3>
&lt;p>è¿™é‡Œè¿˜æ˜¯è¦è¯´ä¸‹ m1ï¼Œæˆ‘ç°åœ¨ä¸»è¦ç”¨ m1 çš„ç”µè„‘ï¼Œæœ¬åœ°çš„å®¹å™¨è¿è¡Œæ—¶ç”¨çš„ Docker Desktopã€‚&lt;/p>
&lt;p>å‰é¢æˆ‘ä»¬æœ‰ç•™æ„åˆ°è™šæ‹Ÿæœºä½¿ç”¨çš„æ˜¯ &lt;code>aarch64&lt;/code> æ¶æ„ç³»ç»Ÿï¼Œ&lt;strong>å¯¹äºæŸäº›ä¸æ”¯æŒ arm64 çš„é•œåƒè¿˜æ˜¯æ— æ³•è¿è¡Œ&lt;/strong>ã€‚æ¯•ç«Ÿ Lima æ˜¯åŸç”Ÿæ”¯æŒ m1ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ Rosetta è½¬è¯‘çš„ Docker Desktopã€‚&lt;/p>
&lt;p>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å°è¯•ç”¨ Rosetta è½¬è¯‘ Limaã€‚&lt;/p></description></item><item><title>OpenFaaS - ä»¥è‡ªå·±çš„æ–¹å¼è¿è¡Œå®¹å™¨åŒ–å‡½æ•°</title><link>https://atbug.com/openfaas-case-study-zh/</link><pubDate>Fri, 17 Dec 2021 09:13:59 +0800</pubDate><guid>https://atbug.com/openfaas-case-study-zh/</guid><description>
&lt;p>&lt;strong>è¯‘è€…æ³¨ï¼š&lt;/strong>
æœ¬æ–‡ç¯‡å¹…è¾ƒé•¿ï¼Œæœ‰åŠ©äºäº†è§£ FaaS å’Œ OpenFaaSã€‚ä½œè€…åˆ†åˆ«ä»å¼€å‘äººå‘˜å’Œè¿ç»´äººå‘˜çš„è§†è§’æ¥äº†è§£ OpenFaaSï¼Œå¯¹äº†è§£æ–°çš„æŠ€æœ¯æ˜¯ä¸ªå¾ˆå¥½çš„æ–¹å¼ã€‚&lt;/p>
&lt;p>æœ¬æ–‡ç¿»è¯‘è‡ª &lt;a href="https://twitter.com/iximiuz">Ivan Velichko&lt;/a> çš„ &lt;a href="https://iximiuz.com/en/posts/openfaas-case-study/">OpenFaaS - Run Containerized Functions On Your Own Terms&lt;/a>ã€‚&lt;/p>
&lt;hr>
&lt;p>é•¿æœŸä»¥æ¥ï¼Œ&lt;em>æ— æœåŠ¡å™¨ï¼ˆserverlessï¼‰&lt;/em> å¯¹æˆ‘æ¥è¯´æ— éå°±æ˜¯ AWS Lambda çš„ä»£åè¯ã€‚Lambda æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„é€”å¾„ï¼Œå¯ä»¥å°†ä»»æ„ä»£ç é™„åŠ åˆ°å¹³å°äº‹ä»¶ï¼ˆäº‘å®ä¾‹çš„çŠ¶æ€å˜æ›´ã€DynamoDB è®°å½•çš„æ›´æ–°æˆ–æ–°çš„ SNS æ¶ˆæ¯ï¼‰ä¸­ã€‚ä½†æ˜¯ï¼Œæˆ‘æ—¶ä¸æ—¶ä¼šæƒ³åˆ°æŸä¸ªé€»è¾‘ï¼Œä½†å…¶åˆæ²¡å¤§åˆ°è¶³ä»¥æœ‰è‡ªå·±çš„æœåŠ¡ï¼ŒåŒæ—¶æœ‰ä¸é€‚åˆä»»ä½•ç°æœ‰æœåŠ¡çš„èŒƒå›´ã€‚å› æ­¤ï¼Œæˆ‘ç»å¸¸å°†å…¶æ”¾å…¥å‡½æ•°ä¸­ï¼Œä»¥ä¾¿æ—¥åä½¿ç”¨ CLI å‘½ä»¤æˆ–è€… HTTP è°ƒç”¨æ¥è°ƒç”¨å®ƒã€‚&lt;/p>
&lt;p>å‡ å¹´å‰ï¼Œæˆ‘æ¥å¼€äº† AWSï¼Œè‡ªé‚£ä»¥åï¼Œæˆ‘ä¸€ç›´æ€€å¿µéƒ¨ç½²æ— æœåŠ¡å™¨åŠŸèƒ½çš„ä¾¿åˆ©æ€§ã€‚å› æ­¤ï¼Œå½“æˆ‘å¾—çŸ¥ &lt;a href="https://www.openfaas.com">OpenFaaS&lt;/a>
é¡¹ç›®æ—¶æƒŠå–œä¸‡åˆ†ã€‚å®ƒå°†åœ¨ Kubernetes é›†ç¾¤ä¸Šéƒ¨ç½²å‡½æ•°å˜å¾—ç®€å•ï¼Œç”šè‡³ä»…éœ€è¦ Containerd å°±å¯ä»¥éƒ¨ç½²åˆ°è™šæ‹Ÿæœºä¸Šã€‚&lt;/p>
&lt;p>æœ‰å…´è¶£ï¼Ÿé‚£ä¹ˆç»§ç»­ï¼&lt;/p>
&lt;h2 id="æ— æœåŠ¡å™¨ä¸-faas">æ— æœåŠ¡å™¨ä¸ FaaS&lt;/h2>
&lt;p>&lt;a href="https://en.wikipedia.org/wiki/Serverless_computing">æ— æœåŠ¡å™¨&lt;/a> å·²æˆä¸ºä¸€ä¸ªæµè¡Œè¯ï¼Œç›®å‰å…¶å®é™…å«ä¹‰æ‰”ä¸å¤Ÿæ¸…æ™°ã€‚&lt;/p>
&lt;p>è®¸å¤šç°ä»£å¹³å°è¢«è§†ä¸º &lt;em>æ— æœåŠ¡å™¨&lt;/em> å¹³å°ã€‚åœ¨ AWS Fargate æˆ– GCP Cloud Run ä¸Šéƒ¨ç½²å®¹å™¨åŒ–æœåŠ¡ï¼Ÿæ— æœåŠ¡å™¨ï¼åœ¨ Heroku ä¸Šè¿è¡Œåº”ç”¨ç¨‹åºï¼Ÿä¹Ÿå¯èƒ½æ˜¯æ— æœåŠ¡å™¨çš„ã€‚&lt;/p>
&lt;p>åŒæ—¶ï¼Œæˆ‘æ›´å–œæ¬¢å°† &lt;a href="https://en.wikipedia.org/wiki/Function_as_a_service">FaaS&lt;/a> è§†ä¸ºä¸€ç§å…·ä½“çš„è®¾è®¡æ¨¡å¼ã€‚æŒ‰ç…§ FaaS èŒƒå¼ï¼Œå¯ä»¥éƒ¨ç½²ä»£ç ç‰‡æ®µï¼ˆå“åº”æŸäº›å¤–éƒ¨æ—¶é—´æ‰§è¡Œçš„&lt;em>å‡½æ•°&lt;/em>ï¼‰ã€‚è¿™äº›å‡½æ•°ä¸äº‹ä»¶é©±åŠ¨ç¨‹åºä¸­çš„å›è°ƒç±»ä¼¼ï¼Œä½†æ˜¯æ˜¯è¿è¡Œåœ¨å…¶ä»–äººçš„çš„æœåŠ¡å™¨ä¸Šã€‚ç”±äºæ“ä½œçš„æ˜¯å‡½æ•°è€Œä¸æ˜¯æœåŠ¡å™¨ï¼Œé¡¾åæ€ä¹‰ FaaS æ˜¯æ— æœåŠ¡å™¨çš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/17/20211217-at-001929.png" alt="">
&lt;em>&lt;a href="https://twitter.com/iximiuz/status/1465273596033609736?ref_src=twsrc%255Etfw%257Ctwcamp%255Etweetembed%257Ctwterm%255E1465273596033609736%257Ctwgr%255E%257Ctwcon%255Es1_&amp;amp;ref_url=https%253A%252F%252Fiximiuz.com%252Fen%252Fposts%252Fopenfaas-case-study%252F">source&lt;/a>&lt;/em>&lt;/p>
&lt;p>&lt;strong>OpenFaaS é¡¹ç›®æ—¨åœ¨å°† Kubernetes é›†ç¾¤æˆ–è€…ç‹¬ç«‹çš„è™šæ‹Ÿæœºç­‰ä½çº§åŸºç¡€è®¾æ–½è½¬åŒ–ä¸ºç®¡ç†æ— æœåŠ¡å™¨å‡½æ•°çš„é«˜çº§å¹³å°ã€‚&lt;/strong>&lt;/p>
&lt;p>&lt;strong>ç«™åœ¨å¼€å‘äººå‘˜çš„è§’åº¦&lt;/strong>ï¼Œè¿™æ ·ä¸€ä¸ªå¹³å°çœ‹èµ·æ¥æ˜¯çœŸçš„æ— æœåŠ¡å™¨çš„ &amp;ndash; ä½ åªéœ€è¦çŸ¥é“ç‰¹å®šçš„ CLI/UI/API æ¥å¤„ç† &lt;em>å‡½æ•°&lt;/em> æŠ½è±¡ã€‚ä½†&lt;strong>ç«™åœ¨è¿ç»´çš„è§’åº¦&lt;/strong>ï¼Œéœ€è¦äº†è§£ OpenFaaS å¦‚ä½•ä½¿ç”¨ &lt;em>æœåŠ¡å™¨&lt;/em> æ¥è¿è¡Œè¿™äº›å‡½æ•°ã€‚&lt;/p>
&lt;p>å°±æˆ‘è€Œè¨€ï¼Œæˆ‘ç»å¸¸æ—¢æ˜¯å¼€å‘åˆæ˜¯è¿ç»´ï¼Œä¸‹é¢æˆ‘å°†å°è¯•ä»äºŒè€…å±•å¼€è¯´æ˜ã€‚ç„¶è€Œï¼Œæˆ‘è®¤ä¸ºåœ¨è¯„ä¼° UX æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æ˜ç¡®åŒºåˆ†å®ƒä»¬ã€‚&lt;/p>
&lt;h2 id="å¼€å‘äººå‘˜çœ¼ä¸­çš„-openfaas">å¼€å‘äººå‘˜çœ¼ä¸­çš„ OpenFaaS&lt;/h2>
&lt;p>OpenFaaS åˆ›å»ºäº 2016 å¹´ï¼Œç°åœ¨ç½‘ä¸Šä¹Ÿæœ‰å¤§é‡çš„æ•™ç¨‹ã€‚è¿™é‡Œä¸ä¼šé‡å¤ä»‹ç»ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥äº†è§£ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.openfaas.com/deployment/">How to deploy OpenFaaS&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.openfaas.com/cli/templates/">Create Functions&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.openfaas.com/cli/build/">Build Functions&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.openfaas.com/cli/templates/#nodejs-12-node12-of-watchdog-template">Writing a Node.js function - step-by-step guide&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ç›¸åï¼Œæˆ‘å°†æè¿°æˆ‘æ‰€ç†è§£çš„ OpenFaaSã€‚æˆ‘å¸Œæœ›æœ‰åŠ©äºä¸€äº›éœ€è¦è¯„ä¼°è¯¥æŠ€æœ¯æ˜¯å¦è§£å†³å…¶é—®é¢˜çš„äººï¼Œä»¥åŠé‚£äº›å¸Œæœ›æ›´æœ‰æ•ˆåœ°ä½¿ç”¨è¯¥æŠ€æœ¯çš„äººã€‚&lt;/p>
&lt;h3 id="å‡½æ•°è¿è¡Œæ—¶">å‡½æ•°è¿è¡Œæ—¶&lt;/h3>
&lt;p>åœ¨è¿›å…¥æ­£å¼ç¼–ç ä¹‹å‰ï¼Œæœ‰å¿…è¦äº†è§£ä¸‹å…¶æœªæ¥çš„æ‰§è¡Œç¯å¢ƒï¼ˆåˆåè¿è¡Œæ—¶ï¼‰ã€‚æˆ–è€…ï¼Œç®€å•è¯´ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚ä½•å¯åŠ¨å‡½æ•°&lt;/li>
&lt;li>å¦‚ä½•ç»„ç»‡ I/O æ“ä½œ&lt;/li>
&lt;li>å¦‚ä½•é‡ç½® / ç»ˆæ­¢å‡½æ•°&lt;/li>
&lt;li>å¦‚ä½•éš”ç¦»å‡½æ•°å’Œè°ƒç”¨&lt;/li>
&lt;/ul>
&lt;p>OpenFaaS è‡ªå¸¦å¤šä¸ªè¿è¡Œæ—¶æ¨¡å¼ï¼Œè¿™äº›æ¨¡å¼é’ˆå¯¹ä¸åŒçš„åœºæ™¯å®šåˆ¶ã€‚å› æ­¤ï¼Œä¸åŒçš„åœºæ™¯ä¸‹ä¸Šè¿°é—®é¢˜çš„ç­”æ¡ˆä¼šç•¥æœ‰ä¸åŒã€‚&lt;/p>
&lt;p>&lt;strong>OpenFaaS å‡½æ•°åœ¨å®¹å™¨ä¸­è¿è¡Œ&lt;/strong>ï¼Œå¹¶ä¸”æ¯ä¸ªå®¹å™¨å¿…é¡»éµå®ˆ&lt;a href="https://docs.openfaas.com/reference/workloads/">ç®€å•çš„çº¦å®š&lt;/a> ï¼šå®ƒä½œä¸ºç›‘å¬åœ¨é¢„è®¾ç«¯å£ï¼ˆé»˜è®¤ä¸º &lt;em>8080&lt;/em>ï¼‰ä¸Šçš„ HTTP æœåŠ¡å™¨ï¼Œä¸´æ—¶å­˜å‚¨å¹¶ä¸”æ˜¯æ— çŠ¶æ€çš„ã€‚&lt;/p>
&lt;p>ç„¶è€Œï¼ŒOpenFaaS é€šè¿‡ &lt;em>å‡½æ•° watchdog&lt;/em>ï¼ˆè¯‘è€…æ³¨ï¼šwatchdog ä¸åšç¿»è¯‘ï¼‰æ¨¡å¼é¿å…äº†ç”¨æˆ·ç¼–å†™æ­¤ç±»æœåŠ¡å™¨ã€‚&lt;em>å‡½æ•° watchdog&lt;/em> æ˜¯ä¸€ç§è½»é‡çº§ HTTP æœåŠ¡å™¨ï¼Œå¯ä»¥æ„ŸçŸ¥å¦‚ä½•æ‰§è¡Œå®é™…å‡½æ•°ä¸šåŠ¡é€»è¾‘ã€‚å› æ­¤ï¼Œå®‰è£…åœ¨å®¹å™¨ä¸­çš„æ‰€æœ‰å†…å®¹åŠ ä¸Šä½œä¸ºå…¥å£ç‚¹çš„ watchdogï¼Œå°±æ„æˆäº†å‡½æ•°çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚&lt;/p>
&lt;h4 id="ç»å…¸-watchdog">ç»å…¸ watchdog&lt;/h4>
&lt;p>ä»&lt;strong>æœ€ç®€å•&lt;/strong>çš„å¼€å§‹ï¼Œæˆ–è€…åˆæ˜¯è¢«ç§°ä¸º&lt;a href="https://github.com/openfaas/classic-watchdog">&lt;em>ç»å…¸&lt;/em> watchdog&lt;/a>ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/17/16396730767429.png" alt="">&lt;/p>
&lt;p>è¿™ç§æ¨¡å¼ä¸‹ï¼Œwatchdog å¯åŠ¨äº†ç›‘å¬åœ¨ &lt;em>8080&lt;/em> ç«¯å£çš„è½»é‡çº§ HTTP æœåŠ¡å™¨ï¼Œæ¯ä¸ªè¿›æ¥çš„è¯·æ±‚éƒ½ä¼šï¼š&lt;/p>
&lt;ul>
&lt;li>è¯»å–è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“&lt;/li>
&lt;li>fork æˆ–è€… exec åŒ…å«å®é™…å‡½æ•°çš„å¯æ‰§è¡Œæ–‡ä»¶&lt;/li>
&lt;li>å°†è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“å†™å…¥åˆ°å‡½æ•°è¿›ç¨‹çš„ &lt;em>stdin&lt;/em>&lt;/li>
&lt;li>ç­‰å¾…å‡½æ•°è¿›ç¨‹çš„é€€å‡ºï¼ˆæˆ–è€…è¶…å¸‚ï¼‰&lt;/li>
&lt;li>è¯»å–å‡½æ•°è¿›ç¨‹çš„ &lt;em>stdout&lt;/em> å’Œ &lt;em>stderr&lt;/em>&lt;/li>
&lt;li>åœ¨ HTTP å“åº”ä¸­å°†å»è¯»çš„å­—èŠ‚å‘é€å›è°ƒç”¨æ–¹&lt;/li>
&lt;/ul>
&lt;p>ä¸Šè¿°é€»è¾‘ç±»ä¼¼äºä¼ ç»Ÿçš„ &lt;a href="https://en.wikipedia.org/wiki/Common_Gateway_Interface">é€šç”¨ç½‘å…³æ¥å£ï¼ˆCGIï¼‰&lt;/a>ã€‚ä¸€æ–¹é¢ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨éƒ½å¯åŠ¨å•ç‹¬çš„è¿›ç¨‹çœ‹èµ·æ¥ä¸å¤Ÿé«˜æ•ˆï¼Œè€Œå¦ä¸€æ–¹é¢ï¼Œå®ƒç¡®å®è¶…çº§æ–¹ä¾¿ï¼Œå› ä¸º &lt;strong>ä»»ä½•ä½¿ç”¨ &lt;em>stdio&lt;/em> æµè¿›è¡Œ I/O å¤„ç†çš„ç¨‹åºï¼ˆåŒ…æ‹¬æœ€å–œæ¬¢çš„ CLI å·¥å…·ï¼‰éƒ½å¯ä»¥éƒ¨ç½²ä¸º OpenFaaS å‡½æ•°&lt;/strong>ã€‚&lt;/p>
&lt;p>æèµ·&lt;strong>éš”ç¦»&lt;/strong>ï¼Œæˆ‘ä»¬æœ‰å¿…è¦åŒºåˆ†ä¸‹&lt;em>å‡½æ•°&lt;/em>å’Œ&lt;em>è°ƒç”¨&lt;/em>ï¼š&lt;/p>
&lt;ul>
&lt;li>OpenFaaS ä¸­çš„ä¸åŒå‡½æ•°å§‹ç»ˆåˆ†å¸ƒåœ¨ä¸åŒçš„å®¹å™¨ä¸­&lt;/li>
&lt;li>ä¸€ä¸ªå‡½æ•°å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ â€”â€” å–å†³äºç¼©æ”¾é€‰é¡¹&lt;/li>
&lt;li>åŒä¸€å‡½æ•°çš„ç‹¬ç«‹è°ƒç”¨å¯èƒ½ä¼šæœ€ç»ˆè¿›å…¥åŒä¸€ä¸ªå®¹å™¨&lt;/li>
&lt;li>åŒä¸€å‡½æ•°çš„ç‹¬ç«‹è°ƒç”¨å°†å§‹ç»ˆä½¿ç”¨ä¸åŒçš„è¿›ç¨‹è¿›è¡Œ&lt;/li>
&lt;/ul>
&lt;h4 id="åå‘ä»£ç†-watchdog">åå‘ä»£ç† watchdog&lt;/h4>
&lt;p>&lt;em>æ³¨æ„ï¼šä½¿ç”¨ OpenFaaS å®˜æ–¹æœ¯è¯­ï¼Œæœ¬èŠ‚è®¨è®ºåœ¨ HTTP æ¨¡å¼ä¸‹è¿è¡Œçš„ &lt;a href="https://github.com/openfaas/of-watchdog">of-watchdog&lt;/a>ã€‚ä½†æˆ‘ä¸ªäººè®¤ä¸ºç§°ä¹‹ä¸ºåå‘ä»£ç† watchdog æ›´åŠ å½¢è±¡ã€‚&lt;/em>&lt;/p>
&lt;p>å¦‚æœ &lt;strong>ç»å…¸&lt;/strong> è¿è¡Œæ—¶ç±»ä¼¼äº CGIï¼Œé‚£ä¹ˆè¿™ä¸ªè¿è¡Œæ—¶æ¨¡å¼ç±»ä¼¼äºåæ¥çš„ &lt;a href="https://en.wikipedia.org/wiki/FastCGI">FastCGI&lt;/a>ã€‚è¿è¡Œæ—¶å¸Œæœ›åœ¨ watchdog åé¢æœ‰ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„ HTTP æœåŠ¡å™¨ï¼Œè€Œä¸æ˜¯æ¯æ¬¡å‡½æ•°è°ƒç”¨æ—¶åˆ›å»ºæ–°çš„è¿›ç¨‹ã€‚è¿™æœ¬è´¨ä¸Šæ˜¯ &lt;a href="https://github.com/openfaas/of-watchdog/blob/a0289419078824f0a070860f84a6b383eb4f2169/README.md#1-http-modehttp">å°† watchdog ç»„ä»¶å˜æˆåå‘ä»£ç†&lt;/a>ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/17/16396740301372.png" alt="">&lt;/p>
&lt;p>å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œ&lt;strong>åå‘ä»£ç†&lt;/strong> watchdog ä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªç›‘å¬åœ¨ &lt;em>8080&lt;/em> ç«¯å£çš„è½»é‡çº§ HTTP æœåŠ¡å™¨ã€‚ç„¶è€Œï¼Œä¸ &lt;strong>ç»å…¸&lt;/strong> watchdog ä¸åŒçš„æ˜¯&lt;strong>åå‘ä»£ç†&lt;/strong>watchdog åªåˆ›å»ºä¸€æ¬¡å‡½æ•°çš„è¿›ç¨‹ï¼Œå¹¶å°†å…¶å½“æˆï¼ˆé•¿æœŸè¿è¡Œçš„ï¼‰ä¸Šæ¸¸æœåŠ¡å™¨ã€‚ç„¶åï¼Œå‡½æ•°è°ƒç”¨è½¬å˜æˆåˆ°è¯¥ä¸Šæ¸¸çš„ HTTP è¯·æ±‚ã€‚&lt;/p>
&lt;p>ç„¶è€Œï¼Œ&lt;strong>åå‘ä»£ç†&lt;/strong>æ¨¡å¼å¹¶ä¸ä¸ºäº†å–ä»£&lt;strong>ç»å…¸&lt;/strong>æ¨¡å¼ã€‚&lt;strong>ç»å…¸&lt;/strong>æ¨¡å¼çš„å¼ºé¡¹åœ¨äºå…¶å‡½æ•°çš„ç¼–å†™éå¸¸ç®€å•ã€‚è¿™ä¹Ÿæ˜¯æ²¡æœ‰ HTTP æœåŠ¡å™¨çš„ä»£ç çš„å”¯ä¸€é€‰æ‹©ã€‚æ¯”å¦‚ä½¿ç”¨ Cobolã€bash æˆ–è€… PowerShell è„šæœ¬ç­‰ç­‰ç¼–å†™çš„å‡½æ•°ã€‚&lt;/p>
&lt;p>ä½•æ—¶è¯¥ä½¿ç”¨&lt;strong>åå‘ä»£ç†&lt;/strong>è¿è¡Œæ—¶æ¨¡å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>å‡½æ•°éœ€è¦åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´ä¿æŒçŠ¶æ€ï¼š
&lt;ul>
&lt;li>ç¼“å­˜&lt;/li>
&lt;li>æŒä¹…è¿æ¥ï¼ˆä¾‹å¦‚ï¼Œä¿æŒä»å‡½æ•°åˆ°æ•°æ®åº“çš„è¿æ¥æ‰“å¼€ï¼‰&lt;/li>
&lt;li>æœ‰çŠ¶æ€å‡½æ•° ğŸ¥´&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>æ¯ä¸ªå‡½æ•°å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹å¯èƒ½å¼€é”€å¾ˆå¤§ï¼Œä¸ºæ¯ä¸ªè°ƒç”¨å¸¦æ¥äº†å»¶è¿Ÿ&lt;/li>
&lt;li>ä½ æƒ³è¿è¡Œä¸€ä¸ªï¼ˆå¾®ï¼‰æœåŠ¡ä½œä¸ºå‡½æ•° ğŸ¤”&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>æ ¹æ® OpenFaaS çš„åˆ›å»ºè€… &lt;a href="https://twitter.com/alexellisuk">Alex Ellis&lt;/a> çš„è§£é‡Šï¼Œ&lt;em>FaaS&lt;/em>ï¼Œç‰¹åˆ«æ˜¯ OpenFaaSï¼Œå¯ä»¥è¢«è§†ä¸ºåœ¨ä¸ä¾èµ–æœåŠ¡å™¨æŠ½è±¡çš„æƒ…å†µä¸‹ &lt;a href="https://blog.alexellis.io/introducing-functions-as-a-service/">éƒ¨ç½²å¾®æœåŠ¡çš„ç®€åŒ–æ–¹å¼&lt;/a>ã€‚å³ FaaS æ˜¯æ— æœåŠ¡å™¨æ¶æ„çš„è§„èŒƒç¤ºä¾‹ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å› æ­¤ï¼Œä½¿ç”¨åå‘ä»£ç†çš„æ–¹å¼ï¼Œå‡½æ•°å¯ä»¥è¢«çœ‹ä½œæ˜¯éƒ¨ç½²å¾®æœåŠ¡çš„å›ºæ‰§çš„æ–¹å¼ã€‚æ–¹ä¾¿ã€å¿«é€Ÿã€ç®€å•ã€‚ä½†ä½¿ç”¨æœ‰çŠ¶æ€å‡½æ•°æ—¶ï¼Œè¦ç•™æ„ç”±äºå¤šä¸ªè°ƒç”¨å¯èƒ½åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ç»“æŸè€Œå¯¼è‡´çš„è­¦å‘Šï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ç»“æŸçš„å¹¶å‘è°ƒç”¨å¯èƒ½ä¼šè§¦å‘ä»£ç ä¸­çš„ç«äº‰æ¡ä»¶ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªå¸¦æœ‰å…¨å±€å˜é‡çš„ Go å‡½æ•°ï¼Œè€Œå…¨å±€å˜é‡æ²¡æœ‰é”çš„ä¿æŠ¤ï¼‰ã€‚&lt;/li>
&lt;li>åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ç»“æŸçš„åç»­è°ƒç”¨å¯èƒ½ä¼šå¯¼è‡´äº¤å‰è°ƒç”¨æ•°æ®æ³„éœ²ï¼ˆå½“ç„¶ï¼Œå°±åƒä¼ ç»Ÿå¾®æœåŠ¡ä¸€æ ·ï¼‰ã€‚&lt;/li>
&lt;li>ç”±äºè¯¥è¿›ç¨‹åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´è¢«å¤ç”¨ï¼Œå› æ­¤ä»£ç ä¸­çš„ä»»ä½•å†…å­˜æ³„æ¼éƒ½ä¸ä¼šè¢«ç¼“è§£ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="å…¶ä»–è¿è¡Œæ—¶æ¨¡å¼">å…¶ä»–è¿è¡Œæ—¶æ¨¡å¼&lt;/h4>
&lt;p>&lt;strong>ç»å…¸&lt;strong>è¿è¡Œæ—¶æ¨¡å¼åœ¨å°†å‡½æ•°ç»“æœå‘é€å›è°ƒç”¨æ–¹ä¹‹å‰ç¼“å†²äº†å‡½æ•°çš„æ•´ä¸ªå“åº”ã€‚ä½†å¦‚æœå“åº”çš„å¤§å°è¶…å‡ºäº†å®¹å™¨çš„å†…å­˜æ€ä¹ˆåŠï¼ŸOpenFaaS æä¾›äº†&lt;/strong>å“åº”æµ&lt;/strong>&lt;a href="https://github.com/openfaas/of-watchdog/blob/a0289419078824f0a070860f84a6b383eb4f2169/README.md#3-streaming-fork-modestreaming---default">å¦ä¸€ç§è¿è¡Œæ—¶æ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä»ç„¶ä¸ºæ¯ä¸ªè°ƒç”¨åˆ›å»ºè¿›ç¨‹ï¼Œä½†æ·»åŠ äº†&lt;/a>ã€‚&lt;/p>
&lt;p>å¦ä¸€ä¸ªåˆå»çš„åœºæ™¯æ˜¯ä»å‡½æ•°ä¸­æä¾›é™æ€æ–‡ä»¶æœåŠ¡ã€‚&lt;a href="https://github.com/openfaas/of-watchdog/blob/a0289419078824f0a070860f84a6b383eb4f2169/README.md#4-static-modestatic">OpenFaaS ä¹Ÿæœ‰è§£å†³æ–¹æ¡ˆ&lt;/a>ã€‚&lt;/p>
&lt;p>è¿™å¯èƒ½æ˜¯æ‰€æœ‰çš„å†…ç½®è¿è¡Œæ—¶æ¨¡å¼ã€‚ä½†å¦‚æœä»æœªæ»¡è¶³éœ€æ±‚ï¼ŒOpenFaaS æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼çœ‹ä¸‹ç°æœ‰çš„watchdogï¼ˆ&lt;a href="https://github.com/openfaas/classic-watchdog">1&lt;/a>Â &amp;amp;Â &lt;a href="https://github.com/openfaas/of-watchdog">2&lt;/a>ï¼‰ï¼Œç®€æ´æ˜äº†ã€‚å› æ­¤ï¼Œå¯ä»¥éšæ—¶æäº¤ PR æˆ–è€… issueï¼Œè®©æ•´ä¸ªç¤¾åŒºå› ä½ çš„è´¡çŒ®æ”¶ç›Šã€‚&lt;/p>
&lt;h3 id="ç¼–å†™å‡½æ•°">ç¼–å†™å‡½æ•°&lt;/h3>
&lt;p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»äº†è§£å‡½æ•°å¦‚ä½•åœ¨é…å¤‡äº†å‡½æ•° watchdog çš„å®¹å™¨ä¸­è¿è¡Œã€‚é‚£ä¹ˆæœ€å°çš„å‡½æ•°æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ&lt;/p>
&lt;p>ä¸‹é¢çš„ç¤ºä¾‹å°†ç®€å•çš„ shell è„šæœ¬å°è£…åˆ° OpenFaaS å‡½æ•°ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-Dockerfile" data-lang="Dockerfile">&lt;span class="c">########################################################&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># WARNING: Not for Production - No Security Hardening! #&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c">########################################################&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># This FROM is just to get the watchdog executable.&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> ghcr.io/openfaas/classic-watchdog:0.2.0 as watchdog&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># FROM this line the actual runtime definion starts.&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> alpine:latest&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># Mandatory step - put the watchdog.&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --from&lt;span class="o">=&lt;/span>watchdog /fwatchdog /usr/bin/fwatchdog&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># Optionally - install extra packages, libs, tools, etc.&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># Function&amp;#39;s payload - script echoing its STDIN, a bit transformed.&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;#!/bin/sh&amp;#39;&lt;/span> &amp;gt; /echo.sh&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;cat | rev | tr &amp;#34;[:lower:]&amp;#34; &amp;#34;[:upper:]&amp;#34;&amp;#39;&lt;/span> &amp;gt;&amp;gt; /echo.sh&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> chmod +x /echo.sh&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># Point the watchdog to the actual thingy to run.&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">ENV&lt;/span> &lt;span class="nv">fprocess&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/echo.sh&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># Start the watchdog server.&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">CMD&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;fwatchdog&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“æ„å»ºã€éƒ¨ç½²å’Œè°ƒç”¨æ—¶ï¼Œä¸Šé¢çš„å‡½æ•°ä½œä¸º &lt;em>å›æ˜¾æœåŠ¡å™¨&lt;/em>ï¼Œå€’è½¬å¹¶å¤§å†™å…¶è¾“å…¥ã€‚&lt;/p>
&lt;p>ç¨å¾®é«˜çº§ç‚¹çš„ä¾‹å­ï¼šä¸€ä¸ª Node.js &lt;em>Hello World&lt;/em> è„šæœ¬ä½œä¸ºå‡½æ•°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-Dockerfile" data-lang="Dockerfile">&lt;span class="c">########################################################&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># WARNING: Not for Production - No Security Hardening! #&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c">########################################################&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> ghcr.io/openfaas/classic-watchdog:0.2.0 as watchdog&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> node:17-alpine&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --from&lt;span class="o">=&lt;/span>watchdog /fwatchdog /usr/bin/fwatchdog&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;console.log(&amp;#34;Hello World!&amp;#34;)&amp;#39;&lt;/span> &amp;gt; index.js&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">ENV&lt;/span> &lt;span class="nv">fprocess&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;node index.js&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">CMD&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;fwatchdog&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å› æ­¤ï¼Œè¦ç¼–å†™ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œåªéœ€è¦åœ¨ Dockerfile ä¸­åŠ å…¥ï¼š&lt;/p>
&lt;ul>
&lt;li>å®é™…è„šæœ¬ï¼ˆæˆ–å¯æ‰§è¡Œæ–‡ä»¶ï¼‰&lt;/li>
&lt;li>å®ƒçš„æ‰€æœ‰ä¾èµ–é¡¹â€”â€”è½¯ä»¶åŒ…ã€æ“ä½œç³»ç»Ÿåº“ç­‰&lt;/li>
&lt;li>é¦–é€‰çš„ watchdog&lt;/li>
&lt;/ul>
&lt;p>ç„¶åå°† watchdog æŒ‡å‘è¯¥è„šæœ¬ï¼ˆæˆ–å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ï¼Œå¹¶å°† watchdog ä½œä¸ºå…¥å£ã€‚æœ‰ç‚¹é…·ï¼Œå› ä¸ºï¼š&lt;/p>
&lt;ul>
&lt;li>å¯ä»¥å®Œå…¨æ§åˆ¶å‡½æ•°æœªæ¥çš„è¿è¡Œæ—¶&lt;/li>
&lt;li>å¯ä»¥éƒ¨ç½²ä»»ä½•å¯ä»¥åœ¨å®¹å™¨ä¸­ä½œä¸ºå‡½æ•°è¿è¡Œçš„ä¸œè¥¿&lt;/li>
&lt;/ul>
&lt;p>ä½†ä¸Šè¿°æ–¹æ³•æœ‰ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹ &amp;ndash; ä¸€ä¸ªç”Ÿäº§å°±ç»ªçš„ Dockerfile å¯èƒ½æœ‰ä¸Šç™¾è¡Œã€‚å¦‚æœæˆ‘åªæƒ³è¿è¡Œä¸€ä¸ªç®€å•çš„ Node.js/Python è„šæœ¬æˆ–è€…ä¸€ä¸ªå°çš„ Go ç¨‹åºä½œä¸ºå‡½æ•°ï¼Œè¦æ€ä¹ˆå¤„ç† Dockerfileï¼Ÿå°±ä¸èƒ½æœ‰ä¸€ä¸ªå ä½ç¬¦æ¥ç²˜è´´ä»£ç ç‰‡æ®µï¼Ÿ&lt;/p>
&lt;h4 id="åŠŸèƒ½æ¨¡æ¿">åŠŸèƒ½æ¨¡æ¿&lt;/h4>
&lt;p>OpenFaaS çš„ç¾å¦™ä¹‹å¤„åœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥ä¸¤è€…å…¼è€Œæœ‰ä¹‹ â€”â€” ä½¿ç”¨ Dockerfile è¿›è¡Œä½çº§ä¿®è¡¥æˆ–ç›®æ ‡è¯­è¨€ç¼–å†™é«˜çº§è„šæœ¬ï¼å¾—ç›Šäºä¸°å¯Œçš„åŠŸèƒ½æ¨¡æ¿åº“ï¼&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ faas-cli template store list
NAME SOURCE DESCRIPTION
csharp openfaas Classic C# template
dockerfile openfaas Classic Dockerfile template
go openfaas Classic Golang template
java8 openfaas Java &lt;span class="m">8&lt;/span> template
...
node14 openfaas HTTP-based Node &lt;span class="m">14&lt;/span> template
node12 openfaas HTTP-based Node &lt;span class="m">12&lt;/span> template
node openfaas Classic NodeJS &lt;span class="m">8&lt;/span> template
php7 openfaas Classic PHP &lt;span class="m">7&lt;/span> template
python openfaas Classic Python 2.7 template
python3 openfaas Classic Python 3.6 template
...
python3-flask openfaas Python 3.7 Flask template
python3-http openfaas Python 3.7 with Flask and HTTP
...
golang-http openfaas Golang HTTP template
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šè¿°åŠŸèƒ½æ¨¡æ¿ç”± OpenFaaS ä½œè€…å’Œç¤¾åŒºç²¾å¿ƒåªåšã€‚å…¸å‹çš„æ¨¡æ¿é™„å¸¦ä¸€ä¸ªå¤æ‚çš„ Dockerfileï¼ŒæŒ‡å‘è™šæ‹Ÿå¤„ç†ç¨‹åºå‡½æ•°ã€‚å½“å¼•å¯¼æ–°å‡½æ•°æ—¶ï¼Œé€šè¿‡ &lt;code>faas-cli new&lt;/code> å‘½ä»¤æ¥ä½¿ç”¨è¿™äº›æ¨¡æ¿ã€‚ä¾‹å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ faas-cli new --lang python my-fn
Folder: my-fn created.
Function created in folder: my-fn
Stack file written: my-fn.yml
$ cat my-fn/handler.py
def handle&lt;span class="o">(&lt;/span>req&lt;span class="o">)&lt;/span>:
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34; PUT YOUR BUSINESS LOGIC HERE &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">return&lt;/span> req
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å› æ­¤ï¼Œå¯¹äºæ¨¡æ¿ï¼Œç¼–å†™å‡½æ•°çš„å·¥ä½œå¯ä»¥å½’ç»“ä¸ºç®€å•åœ°å°†ä¸šåŠ¡é€»è¾‘æ”¾å…¥å“åº”çš„å¤„ç†ç¨‹åºæ–‡ä»¶ä¸­ã€‚&lt;/p>
&lt;p>ä½¿ç”¨æ¨¡æ¿æ—¶ï¼Œäº†è§£ä½¿ç”¨é‚£ç§ &lt;em>watchdog&lt;/em> å’Œ &lt;em>æ¨¡å¼&lt;/em> å¾ˆé‡è¦ï¼š&lt;/p>
&lt;ul>
&lt;li>ä½¿ç”¨&lt;strong>ç»å…¸çš„&lt;/strong>ç±»ä¼¼ CGI çš„ watchdogï¼Œå¤„ç†ç¨‹åºé€šå¸¸è¢«ç¼–å†™ä¸ºæ¥å—å’Œè¿”å›çº¯å­—ç¬¦ä¸²çš„å‡½æ•°ï¼ˆä¾‹å¦‚ï¼š&lt;a href="https://github.com/openfaas/templates/blob/d8893afe3d1072840174911859c6f5db2986e814/template/python3/function/handler.py">python3&lt;/a>ã€&lt;a href="https://github.com/openfaas/templates/blob/d8893afe3d1072840174911859c6f5db2986e814/template/php7/function/src/Handler.php">php7&lt;/a>ï¼‰&lt;/li>
&lt;li>åœ¨ &lt;strong>HTTP æ¨¡å¼ä¸‹&lt;/strong>ï¼Œä½¿ç”¨ &lt;strong>of-watchdog&lt;/strong>æ—¶ï¼Œå¤„ç†ç¨‹åºçœ‹èµ·æ¥æ›´åƒ HTTP å¤„ç†ç¨‹åºæ¥å—è¯·æ±‚å¹¶è¿”å›å“åº”ç»“æ„ï¼ˆä¾‹å¦‚ï¼š&lt;a href="https://github.com/openfaas/python-flask-template/blob/12db680950b42c7cfcc7d21ba036bd1397d62eb7/template/python3-http/function/handler.py">python3-http&lt;/a>ï¼Œ&lt;a href="https://github.com/openfaas/templates/blob/d8893afe3d1072840174911859c6f5db2986e814/template/node17/function/handler.js">node17&lt;/a>ï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="å‡½æ•°å•†åº—">å‡½æ•°å•†åº—&lt;/h4>
&lt;p>ä½ çš„æœ€ä½³å‡½æ•°æ˜¯ä»€ä¹ˆï¼Ÿå¯¹ï¼Œä½ ä¸éœ€è¦å†™ã€‚OpenFaaS æ¥å—è¿™ç§æƒ³æ³•ï¼Œå¹¶å¸¦æ¥äº†&lt;a href="https://github.com/openfaas/store">å‡½æ•°å•†åº—&lt;/a>ï¼ˆç»è¿‡ç¤¾åŒºæµ‹è¯•å¹¶æ ¹æ®è¿‡å¾€ç»éªŒé€‰æ‹©çš„ OpenFaaS å‡½æ•°ç²¾é€‰ç´¢å¼•ï¼‰ã€‚&lt;/p>
&lt;p>è¯¥å•†åº—åŒ…å«ä¸€äº›æœ‰è¶£çš„å‡½æ•°ï¼Œå¯ä»¥ä¸€é”®éƒ¨ç½²åˆ°ç°æœ‰çš„ OpenFaaS ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ faas-cli store list
FUNCTION DESCRIPTION
NodeInfo Get info about the machine that you&lt;span class="s1">&amp;#39;r...
&lt;/span>&lt;span class="s1">alpine An Alpine Linux shell, set the &amp;#34;fproc...
&lt;/span>&lt;span class="s1">env Print the environment variables prese...
&lt;/span>&lt;span class="s1">sleep Simulate a 2s duration or pass an X-S...
&lt;/span>&lt;span class="s1">shasum Generate a shasum for the given input
&lt;/span>&lt;span class="s1">Figlet Generate ASCII logos with the figlet CLI
&lt;/span>&lt;span class="s1">curl Use curl for network diagnostics, pas...
&lt;/span>&lt;span class="s1">SentimentAnalysis Python function provides a rating on ...
&lt;/span>&lt;span class="s1">hey HTTP load generator, ApacheBench (ab)...
&lt;/span>&lt;span class="s1">nslookup Query the nameserver for the IP addre...
&lt;/span>&lt;span class="s1">SSL/TLS cert info Returns SSL/TLS certificate informati...
&lt;/span>&lt;span class="s1">Colorization Turn black and white photos to color ...
&lt;/span>&lt;span class="s1">Inception This is a forked version of the work ...
&lt;/span>&lt;span class="s1">Have I Been Pwned The Have I Been Pwned function lets y...
&lt;/span>&lt;span class="s1">Face Detection with Pigo Detect faces in images using the Pigo...
&lt;/span>&lt;span class="s1">Tesseract OCR This function brings OCR - Optical Ch...
&lt;/span>&lt;span class="s1">Dockerhub Stats Golang function gives the count of re...
&lt;/span>&lt;span class="s1">QR Code Generator - Go QR Code generator using Go
&lt;/span>&lt;span class="s1">Nmap Security Scanner Tool for network discovery and securi...
&lt;/span>&lt;span class="s1">ASCII Cows Generate a random ASCII cow
&lt;/span>&lt;span class="s1">YouTube Video Downloader Download YouTube videos as a function
&lt;/span>&lt;span class="s1">OpenFaaS Text-to-Speech Generate an MP3 of text using Google&amp;#39;&lt;/span>...
Docker Image Manifest Query Query an image on the Docker Hub &lt;span class="k">for&lt;/span> ...
face-detect with OpenCV Detect faces in images. Send a URL as...
Face blur by Endre Simo Blur out faces detected in JPEGs. Inv...
Left-Pad left-pad on OpenFaaS
normalisecolor Automatically fix white-balance in ph...
mememachine Turn any image into a meme.
Business Strategy Generator Generates a Business Strategy &lt;span class="o">(&lt;/span>using ...
Image EXIF Reader Reads EXIF information from an URL or...
Open NSFW Model Score images &lt;span class="k">for&lt;/span> NSFW &lt;span class="o">(&lt;/span>nudity&lt;span class="o">)&lt;/span> content.
Identicon Generator Create an identicon from a provided s...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™äº›å‡½æ•°å®é™…ä¸Šæ˜¯å­˜å‚¨åœ¨ Docker Hub æˆ–è€… Quay ç­‰å…¬å…±åº“çš„å®¹å™¨é•œåƒï¼Œå¯ä»¥è‡ªç”±å¤ç”¨ã€‚&lt;/p>
&lt;p>åœºæ™¯ç¤ºä¾‹ï¼š&lt;/p>
&lt;ul>
&lt;li>ä½¿ç”¨ &lt;code>env&lt;/code> å‡½æ•°è°ƒè¯•å‡½æ•°æ¥æ”¶çš„HTTPæ ‡å¤´&lt;/li>
&lt;li>ä½¿ç”¨ &lt;code>curl&lt;/code> å‡½æ•°ä» OpenFaaS éƒ¨ç½²å†…éƒ¨æµ‹è¯•è¿æ¥&lt;/li>
&lt;li>ä»è¿è¡Œå¤šä¸ªå‰¯æœ¬çš„å‡½æ•°ä¸­ä½¿ç”¨ &lt;code>hey&lt;/code> æ¥å¢åŠ è´Ÿè½½&lt;/li>
&lt;/ul>
&lt;h3 id="å‡½æ•°çš„æ„å»ºå’Œéƒ¨ç½²">å‡½æ•°çš„æ„å»ºå’Œéƒ¨ç½²&lt;/h3>
&lt;p>ç”±äºå‡½æ•°æ˜¯åœ¨å®¹å™¨ä¸­è¿è¡Œçš„ï¼Œå› æ­¤éœ€è¦æœ‰äººä¸ºè¿™äº›å®¹å™¨æ„å»ºé•œåƒã€‚æ— è®ºä½ å–œä¸å–œæ¬¢ï¼Œè¿™éƒ½æ˜¯å¼€å‘äººå‘˜çš„äº‹æƒ…ã€‚OpenFaaS æä¾›äº†æ–¹ä¾¿çš„ &lt;code>faas-cli build&lt;/code> å‘½ä»¤ï¼Œä½†æ²¡æœ‰æœåŠ¡å™¨ç«¯æ„å»ºã€‚å› æ­¤ï¼Œè¦ä¹ˆéœ€è¦ï¼ˆåœ¨å®‰è£… Docker çš„æœºå™¨ä¸Šï¼‰æ‰‹åŠ¨è¿è¡Œ &lt;code>faas-cli build&lt;/code>ï¼Œè¦ä¹ˆä½¿ç”¨ CI/CD å®Œæˆã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥ï¼Œæ„å»ºå¥½çš„é•œåƒéœ€è¦é€šè¿‡ &lt;code>faas-cli push&lt;/code> åˆ°ä»“åº“ã€‚æ˜¾ç„¶ï¼Œè¿™ç§ä»“åº“ä¹Ÿåº”è¯¥å¯ä»¥ä» OpenFaaS æœåŠ¡å™¨ç«¯è®¿é—®ã€‚å¦åˆ™ï¼Œä½¿ ç”¨&lt;code>faas-cli deploy&lt;/code> éƒ¨ç½²å‡½æ•°æ—¶ä¼šå¤±è´¥ã€‚&lt;/p>
&lt;p>å¼€å‘äººå‘˜çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/17/16396975427765.png" alt="">&lt;/p>
&lt;h3 id="è°ƒç”¨å‡½æ•°">è°ƒç”¨å‡½æ•°&lt;/h3>
&lt;p>å‡½æ•°éƒ¨ç½²åï¼Œå¯ä»¥é€šè¿‡å‘ &lt;code>$API_HOST:$API_PORT/function/&amp;lt;fn-name&amp;gt;&lt;/code> ç«¯ç‚¹å‘é€ GETã€POSTã€PUT æˆ–è€… DELET HTTP è¯·æ±‚æ¥è°ƒç”¨å®ƒã€‚å¸¸è§çš„è°ƒç”¨æ–¹å¼æœ‰ï¼š&lt;/p>
&lt;ul>
&lt;li>å„ç§é’©å­ï¼ˆwebhookï¼‰&lt;/li>
&lt;li>&lt;code>faas-cli invoke&lt;/code>&lt;/li>
&lt;li>&lt;strong>event connectors&lt;/strong>ï¼&lt;/li>
&lt;/ul>
&lt;p>å‰ä¸¤ä¸ªé€‰é¡¹ç›¸å½“ç®€å•ã€‚ä½¿ç”¨å‡½æ•°ä½œä¸ºä½œä¸º webhook å¤„ç†å™¨ï¼ˆGitHubã€IFTTT ç­‰ï¼‰å¾ˆæ–¹ä¾¿ï¼Œæ¯ä¸ªå‡½æ•°å¼€å‘äººå‘˜éƒ½å·²ç»å®‰è£…äº† &lt;code>faas-cli&lt;/code>ï¼Œå› æ­¤å¯ä»¥æˆä¸ºæ—¥å¸¸è„šæœ¬ç¼–å†™çš„ç»„æˆéƒ¨åˆ†ã€‚&lt;/p>
&lt;h4 id="é‚£ä»€ä¹ˆæ˜¯äº‹ä»¶è¿æ¥å™¨">é‚£ä»€ä¹ˆæ˜¯äº‹ä»¶è¿æ¥å™¨ï¼Ÿ&lt;/h4>
&lt;p>åœ¨æœ¬æ–‡å¼€å¤´æ˜¯æˆ‘å¯¹ AWS Lambda ä¸ AWS å¹³å°äº‹ä»¶ç´§å¯†é›†æˆçš„æ¸©æš–å›å¿†ã€‚è¯·è®°ä½ï¼Œå¯ä»¥åœ¨å“åº”æ–° SQS/SNS æ¶ˆæ¯ã€æ–°çš„ Kinesis è®°å½•ã€EC2 å®ä¾‹ç”Ÿå‘½å‘¨æœŸç­‰äº‹ä»¶æ—¶è°ƒç”¨ Lambdaã€‚OpenFaaS å‡½æ•°æ˜¯å¦å­˜åœ¨ç±»ä¼¼çš„ä¸œè¥¿å‘¢ï¼Ÿ&lt;/p>
&lt;p>æ˜¾ç„¶ï¼ŒOpenFaaS æ— æ³•å¼€ç®±å³ç”¨åœ°ä¸ä»»ä½•ç”Ÿæ€ç³»ç»Ÿé›†æˆã€‚ç„¶è€Œï¼Œå®ƒæä¾›äº†ä¸€ç§åä¸º&lt;a href="https://docs.openfaas.com/reference/triggers/#event-connector-pattern">&lt;strong>äº‹ä»¶è¿æ¥å™¨&lt;/strong>&lt;/a>æ¨¡å¼çš„é€šç”¨è§£å†³æ–¹æ¡ˆã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/17/16396992441046.png" alt="">&lt;/p>
&lt;p>å®˜æ–¹æ”¯æŒçš„è¿æ¥å™¨ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/openfaas/cron-connector">Cron connector&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/openfaas/mqtt-connector">MQTT connector&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/openfaas/nats-connector">NATS connector&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.openfaas.com/reference/triggers/#apache-kafka-openfaas-pro">Kafka connector&lt;/a>Â (éœ€è¦&lt;strong>ä¸“ä¸šç‰ˆ&lt;/strong>è®¢é˜…)&lt;/li>
&lt;/ul>
&lt;p>OpenFaaS è¿˜æä¾›äº†å¾ˆå°çš„&lt;a href="https://github.com/openfaas/connector-sdk">&lt;strong>è¿æ¥å™¨-sdk&lt;/strong>&lt;/a>åº“æ¥ç®€åŒ–è¿æ¥å™¨çš„å¼€å‘ã€‚&lt;/p>
&lt;h2 id="è¿ç»´çœ¼ä¸­çš„-openfaas">è¿ç»´çœ¼ä¸­çš„ OpenFaaS&lt;/h2>
&lt;p>å¼€å‘çœ¼ä¸­çš„ OpenFaaS æ˜¯ä¸ªé»‘ç›’ï¼Œæä¾›ç®€å•çš„ API æ¥éƒ¨ç½²å’Œè°ƒç”¨å‡½æ•°ã€‚ç„¶è€Œï¼Œä½œä¸ºè¿ç»´å¯èƒ½ä¼šä»äº†è§£ ä¸€ç‚¹ OpenFaaS å†…éƒ¨åŸç†ä¸­å—ç›Šã€‚&lt;/p>
&lt;h3 id="openfaas-é€šç”¨æ¶æ„">OpenFaaS é€šç”¨æ¶æ„&lt;/h3>
&lt;p>OpenFaaS æœ‰ä¸€ä¸ªç®€å•ä½†å¼ºå¤§çš„æ¶æ„ï¼Œå…è®¸ä½¿ç”¨ä¸åŒçš„åŸºç¡€è®¾æ–½ä½œä¸ºåç«¯ã€‚å¦‚æœå·²ç»æœ‰äº† Kubernetes é›†ç¾¤ï¼Œå¯ä»¥é€šè¿‡&lt;a href="https://docs.openfaas.com/deployment/kubernetes/">åœ¨ä¸Šé¢éƒ¨ç½² OpenFaaS&lt;/a> è½»æ¾å°†å…¶å˜æˆ &lt;a href="https://docs.openfaas.com/deployment/kubernetes/">FaaS&lt;/a> è§£å†³æ–¹æ¡ˆã€‚ä½†æ˜¯å¦‚æœæ—§çš„è™šæ‹Ÿï¼ˆæˆ–ç‰©ç†ï¼‰æœºï¼Œä»ç„¶å¯ä»¥åœ¨ä¸Šé¢å®‰è£… OpenFaaSï¼Œå¹¶è·å¾—å·®ä¸å¤šåŠŸèƒ½çš„æ›´å°çš„ FaaS è§£å†³æ–¹æ¡ˆã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/17/16396997846325.png" alt="">&lt;/p>
&lt;p>ä¸Šé¢çš„æ¶æ„ä¸­å”¯ä¸€é¢å‘ç”¨æˆ·çš„ç»„ä»¶æ˜¯ &lt;a href="https://github.com/openfaas/faas/tree/fe152ba69c591d584b1f183f9f5f209e29a9b049/gateway">API ç½‘å…³&lt;/a>ã€‚OpenFaaS çš„ API ç½‘å…³ï¼š&lt;/p>
&lt;ul>
&lt;li>æš´éœ² API æ¥ç®¡ç†å’Œè°ƒç”¨å‡½æ•°&lt;/li>
&lt;li>æä¾›å†…ç½®çš„ UI æ¥ç®¡ç†å‡½æ•°&lt;/li>
&lt;li>å¤„ç†å‡½æ•°çš„è‡ªåŠ¨ç¼©æ”¾&lt;/li>
&lt;li>é¢„è®¡åé¢ä¼šæœ‰å…¼å®¹çš„ OpenFaaS æä¾›å•†&lt;/li>
&lt;/ul>
&lt;p>å› æ­¤ï¼Œå½“å¼€å‘äººå‘˜è¿è¡Œ &lt;code>faas-cli deploy&lt;/code>ã€&lt;code>faas-cli list&lt;/code> æˆ–ä½¿ç”¨ &lt;code>curl $API_URL/function/foobar&lt;/code> è°ƒç”¨å‡½æ•°ç­‰å†…å®¹æ—¶ï¼Œè¯·æ±‚å°†å‘é€åˆ°ä¸Šè¿°çš„ API ç½‘å…³ã€‚&lt;/p>
&lt;p>ä¸Šå›¾ä¸­çš„å¦ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†æ˜¯ Â &lt;a href="https://github.com/openfaas/faas-provider">faas-provider&lt;/a>ã€‚å®ƒä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„ç»„ä»¶ï¼Œè€Œæ›´åƒæ˜¯æ¥å£ã€‚ä»»ä½•å®ç°&lt;a href="https://github.com/openfaas/faas-provider/blob/36474d89ca995ea0a7c064493258d9edec88fe3f/serve.go#L32-L96">ï¼ˆéå¸¸ç®€æ´ï¼‰çš„æä¾›å•† API&lt;/a> çš„è½¯ä»¶éƒ½å¯ä»¥æˆä¸ºæä¾›å•†ã€‚OpenFaaS æä¾›å•†ï¼š&lt;/p>
&lt;ul>
&lt;li>ç®¡ç†åŠŸèƒ½ï¼ˆéƒ¨ç½²ã€åˆ—è¡¨ã€ç¼©æ”¾ã€åˆ é™¤ï¼‰&lt;/li>
&lt;li>è°ƒç”¨å‡½æ•°&lt;/li>
&lt;li>æš´éœ²ä¸€äº›ç³»ç»Ÿä¿¡æ¯&lt;/li>
&lt;/ul>
&lt;p>ä¸¤ä¸ªæœ€æ³¨æ˜çš„æä¾›å•†æ˜¯ &lt;a href="https://github.com/openfaas/faas-netes">faas-netes&lt;/a>ï¼ˆKubernetes ä¸Šçš„ OpenFaaSï¼‰å’Œ &lt;a href="https://github.com/openfaas/faasd">faasd&lt;/a>ï¼ˆContainerd ä¸Šçš„ OpenFaaSï¼‰ã€‚ä¸‹é¢ï¼Œå°†ä»‹ç»ä»–ä»¬çš„å®ç°ã€‚&lt;/p>
&lt;h3 id="kubernetes-ä¸Šçš„-openfaasfaas-nets">Kubernetes ä¸Šçš„ OpenFaaSï¼ˆfaas-netsï¼‰&lt;/h3>
&lt;p>&lt;a href="https://github.com/openfaas/faas-netes">å½“éƒ¨ç½²åœ¨ Kubernetes ä¸Šæ—¶&lt;/a>ï¼ŒOpenFaaS åˆ©ç”¨äº†è¯¥å¹³å°å¼€ç®±å³ç”¨çš„å¼ºå¤§åŸè¯­ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/17/16397005465805.png" alt="">&lt;/p>
&lt;p>å…³é”®è¦ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>API ç½‘å…³æˆä¸ºæ ‡å‡†ï¼ˆéƒ¨ç½²+æœåŠ¡ï¼‰å¯¹ã€‚å› æ­¤ï¼Œå¯ä»¥éšå¿ƒæ‰€æ¬²åœ°æ‰©å±•å®ƒã€‚ä¹Ÿå¯ä»¥éšå¿ƒæ‰€æ¬²åœ°æŠŠå®ƒæš´éœ²å‡ºæ¥&lt;/li>
&lt;li>æ¯ä¸ªå‡½æ•°ä¹Ÿæˆä¸ºï¼ˆéƒ¨ç½²+æœåŠ¡ï¼‰å¯¹ã€‚å¯èƒ½ä¸ä¼šç›´æ¥å¤„ç†å‡½æ•°ï¼Œä½†å¯¹äº faas-netesï¼Œç¼©æ”¾å˜å¾—å°±åƒè°ƒæ•´ç›¸åº”çš„å‰¯æœ¬æ•°ä¸€æ ·ç®€å•&lt;/li>
&lt;li>é«˜å¯ç”¨æ€§å’Œå¼€ç®±å³ç”¨çš„æ°´å¹³ç¼©æ”¾ - åŒä¸€åŠŸèƒ½çš„ pod å¯ä»¥ï¼ˆè€Œä¸”åº”è¯¥ï¼‰è·¨å¤šä¸ªé›†ç¾¤èŠ‚ç‚¹è¿è¡Œã€‚&lt;/li>
&lt;li>Kubernetes ä½œä¸ºä¸€ä¸ªæ•°æ®åº“å·¥ä½œï¼›ä¾‹å¦‚ï¼Œå½“è¿è¡Œ &lt;code>faas-cli list&lt;/code> ç­‰å‘½ä»¤æ¥è·å–å½“å‰éƒ¨ç½²çš„å‡½æ•°åˆ—è¡¨æ—¶ï¼Œfaas-netes åªä¼šå°†å…¶è½¬æ¢ä¸ºç›¸åº”çš„ Kubernetes API æŸ¥è¯¢&lt;/li>
&lt;/ul>
&lt;h3 id="containerd-ä¸Šçš„-openfaasfaasd">Containerd ä¸Šçš„ OpenFaaSï¼ˆfaasdï¼‰&lt;/h3>
&lt;p>å¯¹äºæ²¡æœ‰ä½¿ç”¨ Kubernetes é›†ç¾¤çš„äººæ¥è¯´ï¼ŒOpenFaaS æä¾›äº†åä¸º &lt;a href="https://github.com/openfaas/faasd">faasd&lt;/a> çš„æ›¿ä»£è½»é‡çº§æä¾›å•†ã€‚å®ƒå¯ä»¥å®‰è£…åœ¨ï¼ˆè™šæ‹Ÿæˆ–ç‰©ç†ï¼‰æœåŠ¡å™¨ä¸Šï¼Œï¼Œå¹¶åˆ©ç”¨ &lt;a href="https://iximiuz.com/en/posts/containerd-command-line-clients/">containerd&lt;/a> æ¥ç®¡ç†å®¹å™¨ã€‚&lt;a href="https://iximiuz.com/en/posts/journey-from-containerization-to-orchestration-and-beyond/#containerd">æ­£å¦‚æˆ‘ä¹‹å‰å†™çš„é‚£æ ·&lt;/a>ï¼Œå®¹å™¨æ˜¯ä¸€ä¸ªåœ¨ Docker å’Œ Kubernetes ä¸‹ä½¿ç”¨çš„è¾ƒä½çº§åˆ«çš„å®¹å™¨ç®¡ç†å™¨ã€‚ç»“åˆ &lt;a href="https://github.com/containernetworking/plugins">CNI æ’ä»¶&lt;/a>ï¼Œå®ƒæˆä¸ºç¼–å†™å®¹å™¨è°ƒåº¦å™¨çš„æ„å»ºç»„ä»¶ï¼ŒOpenFaaS çš„ faasd æ˜¯ä¸ªå¾ˆå¥½çš„è®²ç©¶æ¡ˆä¾‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/17/16397012181479.png" alt="">&lt;/p>
&lt;p>å…³é”®è¦ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>è¢«è®¾è®¡ä¸ºåœ¨ IoT è®¾å¤‡ä¸Šæˆ– VM ä¸­è¿è¡Œ&lt;/li>
&lt;li>ä½¿ç”¨ containerd çš„åŸç”ŸÂ &lt;code>pause&lt;/code>Â ï¼ˆé€šè¿‡&lt;em>cgroup freezers&lt;/em>ï¼‰å’Œè¶…å¿«é€Ÿå‡½æ•°å†·å¯åŠ¨å¿«é€Ÿæ‰©å±•åˆ°é›¶&lt;/li>
&lt;li>&lt;a href="https://metal.equinix.com/proximity/?wchannelid=ujj9b20qi5&amp;amp;wmediaid=hkkw4b4o5n">å®ƒå¯ä»¥åœ¨æ¯å°æœåŠ¡å™¨ä¸Šè¿è¡Œæ¯” faas-netes å¤šåå€çš„å‡½æ•°&lt;/a>ï¼Œå¹¶ä¸”å¯ä»¥æœ‰æ•ˆåœ°ä½¿ç”¨æ›´ä¾¿å®œçš„ç¡¬ä»¶ï¼ŒåŒ…æ‹¬æ ‘è“æ´¾&lt;/li>
&lt;li>containerd å’Œ faasd ä½œä¸º systemd æœåŠ¡è¿›è¡Œç®¡ç†ï¼Œå› æ­¤ä¼šè‡ªåŠ¨å¤„ç†æ—¥å¿—ã€é‡å¯ç­‰&lt;/li>
&lt;li>æ²¡æœ‰ Kubernetes DNSï¼Œä½† faasd ç¡®ä¿ DNS åœ¨å‡½æ•°ä¹‹é—´å…±äº«ä»¥ç®€åŒ–äº’æ“ä½œ&lt;/li>
&lt;li>containerd æ‰®æ¼”ç€æ•°æ®åº“çš„è§’è‰²ï¼ˆæ¯”å¦‚Â &lt;code>faas-cli list&lt;/code>Â å˜æˆäº†ç±»ä¼¼Â &lt;code>ctr container list&lt;/code>çš„æ“ä½œÂ ï¼‰ï¼Œæ‰€ä»¥å¦‚æœæœåŠ¡å™¨æŒ‚äº†ï¼Œæ‰€æœ‰çŠ¶æ€å°±ä¼šä¸¢å¤±ï¼Œæ¯ä¸ªå‡½æ•°éƒ½éœ€è¦é‡æ–°éƒ¨ç½²&lt;/li>
&lt;li>æ²¡æœ‰å¼€ç®±å³ç”¨çš„é«˜å¯ç”¨æ€§æˆ–æ°´å¹³æ‰©å±•ï¼ˆå‚è§ &lt;a href="https://github.com/openfaas/faasd/issues/225">issue/225&lt;/a>ï¼‰&lt;/li>
&lt;/ul>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>å¯¹ä½ æ‰€ä½¿ç”¨çš„è½¯ä»¶æœ‰ä¸ªå¥½çš„å¿ƒæ™ºæ¨¡å‹æ˜¯æ˜¯æœ‰ç›Šçš„ï¼Œå®ƒå¯ä»¥æé«˜å¼€å‘æ•ˆç‡ï¼Œé˜²æ­¢å•ä¾‹åœºæ™¯çš„å‘ç”Ÿï¼Œå¹¶ç®€åŒ–äº†æ•…éšœæ’æŸ¥ã€‚&lt;/p>
&lt;p>ä»¥ OpenFaaS ä¸ºä¾‹ï¼ŒåŒºåˆ†å¼€å‘äººå‘˜å’Œè¿ç»´äººå‘˜å¯¹ç³»ç»Ÿçš„çœ‹æ³•å¯èƒ½æ˜¯ä¸ªå¾ˆå¥½çš„æ€è·¯ã€‚ä»&lt;strong>å¼€å‘äººå‘˜è§’åº¦æ¥çœ‹&lt;/strong>ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„æ— æœåŠ¡å™¨è§£å†³æ–¹æ¡ˆï¼Œä¸»è¦å…³æ³¨ FaaS åœºæ™¯ã€‚è¯¥è§£å†³æ–¹æ¡ˆç”±ä¸€ä¸ªç”¨äºç®¡ç†å’Œè°ƒç”¨å‡½æ•°çš„ç®€æ´ APIã€ä¸€ä¸ªæ¶µç›–å¼€å‘äººå‘˜å·¥ä½œæµçš„å‘½ä»¤è¡Œå·¥å…·ä»¥åŠä¸€ä¸ªå‡½æ•°æ¨¡æ¿åº“ç»„æˆã€‚æ— æœåŠ¡å™¨å‡½æ•°ä»¥ä¸åŒçš„è¿è¡Œæ—¶æ¨¡å¼ï¼ˆç±» CGIã€åå‘ä»£ç†ï¼‰åœ¨å®¹å™¨ä¸­è¿è¡Œï¼Œå¹¶æä¾›ä¸åŒçš„éš”ç¦»å’ŒçŠ¶æ€ä¿éšœã€‚&lt;/p>
&lt;p>ä»&lt;strong>è¿ç»´äººå‘˜çš„è§’åº¦æ¥çœ‹&lt;/strong>ï¼ŒOpenFaaS æ˜¯ä¸€ä¸ªå…·æœ‰çµæ´»æ¶æ„çš„æ¨¡å—åŒ–ç³»ç»Ÿï¼Œå¯ä»¥éƒ¨ç½²åœ¨ä¸åŒç±»å‹çš„åŸºç¡€è®¾æ–½ä¹‹ä¸Šï¼šä»æ ‘è“æ´¾åˆ°è£¸æœºæˆ–è™šæ‹Ÿæœºã€ä»¥åŠæˆç†Ÿçš„ Kubernetesã€OpenShift æˆ– Docker Swarm é›†ç¾¤ã€‚å½“ç„¶ï¼Œæ¯ç§é€‰æ‹©éƒ½æœ‰å…¶ä¼˜ç¼ºç‚¹ï¼Œéœ€è¦è¯¦ç»†è¯„ä¼°å–èˆã€‚ä½†å³ä½¿ç°æœ‰é€‰é¡¹éƒ½ä¸åˆé€‚ï¼Œç®€å•çš„ &lt;em>faas-provider&lt;/em> æŠ½è±¡å…è®¸å¼€å‘è‡ªå·±çš„åç«¯æ¥è¿è¡Œæ— æœåŠ¡å™¨åŠŸèƒ½ã€‚&lt;/p>
&lt;p>ä¸Šè¿°å†…å®¹ä¸»è¦é›†ä¸­åœ¨ OpenFaaS åŸºç¡€çŸ¥è¯†ä¸Šã€‚ä½†æ˜¯ OpenFaaS ä¹Ÿæœ‰ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚é€šè¿‡ä»¥ä¸‹é“¾æ¥è¿›ä¸€æ­¥äº†è§£ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.openfaas.com/reference/async/">ä½¿ç”¨ NATS æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿçš„å¼‚æ­¥å‡½æ•°è°ƒç”¨&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.openfaas.com/architecture/autoscaling/">ä½¿ç”¨ Prometheus å’Œ AlertManager è‡ªåŠ¨ç¼©æ”¾åŠŸèƒ½&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/openfaas/faas-middleware/tree/ace4eb24749c0814850a56b23b0015232dd41c2a/concurrency-limiter">å‡½æ•°è°ƒç”¨é™åˆ¶&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://openfaas.gumroad.com/l/serverless-for-everyone-else">ä½¿ç”¨ docker-compose é€šè¿‡ faasd è¿è¡Œæœ‰çŠ¶æ€çš„å·¥ä½œè´Ÿè½½&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="èµ„æº">èµ„æº&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://docs.openfaas.com/">OpenFaaS å®˜æ–¹æ–‡æ¡£&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.alexellis.io/deploy-serverless-faasd-with-cloud-init/">ä¸€å †æ¸…æ™°çš„ OpenFaaS ç”¨ä¾‹&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.alexellis.io/cli-functions-with-openfaas/">ä½¿ç”¨ OpenFaaS å°†ä»»ä½• CLI è½¬æ¢ä¸ºå‡½æ•°&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.openfaas.com/blog/introducing-faasd/">faasd ä»‹ç»ã€åŠ¨æœºã€ä¸»è¦ç”¨ä¾‹&lt;/a>&lt;/li>
&lt;li>ğŸ“–&lt;a href="https://openfaas.gumroad.com/l/serverless-for-everyone-else">é¢å‘å…¶ä»–äººçš„æ— æœåŠ¡å™¨&lt;/a>- å°½ç®¡æœ‰é€šç”¨åç§°ï¼Œä½†å®ƒæ˜¯ faasd çš„ä¸€ä¸ªéå¸¸è¯¦ç»†çš„æŒ‡å—&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>ä½œè€…ä»‹ç»ï¼š
Ivan Velichko
Software Engineer at heart, SRE at day job, Tech Storyteller at night.&lt;/p>
&lt;/blockquote></description></item><item><title>ç­–ç•¥å³ä»£ç ï¼šä¸ºäº† OpenPolicyAgent å­¦ Regoï¼Ÿè¯•è¯• Javascript</title><link>https://atbug.com/policy-as-code-with-pipy/</link><pubDate>Wed, 08 Dec 2021 07:49:37 +0800</pubDate><guid>https://atbug.com/policy-as-code-with-pipy/</guid><description>
&lt;p>è·ç¦»ä¸Šä¸ªç‰ˆæœ¬ &lt;a href="https://mp.weixin.qq.com/s/uZ_Q5Fn3XpfUEHBOFxWdvg">ç”¨ Pipy å®ç° OPA&lt;/a>ï¼Œå·²ç»è¿‡å»å¿«åŠå¹´äº†ã€‚å½“åˆä½¿ç”¨Pipy å®ç°äº†å¯ä¿¡é•œåƒä»“åº“çš„æ£€æŸ¥ï¼Œé‚£æ—¶çš„ç‰ˆæœ¬å®ç°èµ·æ¥ä¼šç¨å¾®å¤æ‚ï¼Œä»ç­–ç•¥ä»“åº“åˆ°è¯ä¹¦åˆ›å»ºåˆ°Admission Webhook çš„åˆ›å»ºéƒ½éœ€è¦å¤§é‡çš„äººå·¥æ“ä½œï¼Œé…ç½®å’Œé€»è¾‘ä¹Ÿè¿˜æ˜¯è€¦åˆåœ¨ä¸€èµ·ã€‚&lt;/p>
&lt;p>è¿™ä¸ªç‰ˆæœ¬å®‰è£…å’Œä½¿ç”¨èµ·æ¥ä¼šæ›´åŠ ç®€å•ã€‚&lt;/p>
&lt;p>å½“åˆæˆ‘ç”¨â€œä¸åŠ¡æ­£ä¸šâ€æ¥å½¢å®¹ Pipy å®ç°å‡†å…¥æ§åˆ¶ï¼Œç­‰çœ‹å®Œè¿™ç¯‡æ–‡ç« ï¼Œæ¬¢è¿ç•™è¨€è¯´è¯´ä½ çš„çœ‹æ³•ã€‚&lt;/p>
&lt;h2 id="æ¶æ„">æ¶æ„&lt;/h2>
&lt;p>è¿˜æ˜¯ç»§ç»­ä¸Šæ¬¡çš„åœºæ™¯ï¼Œåœ¨ Pod åˆ›å»ºæ—¶å¯¹ Pod ä½¿ç”¨çš„é•œåƒæ‰€åœ¨ä»“åº“è¿›è¡Œæ£€æŸ¥ï¼Œä»¥åŠæ£€æŸ¥é•œåƒçš„ tag æ˜¯å¦&lt;em>åˆæ³•&lt;/em>ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/08/untitled.jpg" alt="Untitled">&lt;/p>
&lt;p>è¿™é‡Œå€ŸåŠ© Pipy Repo çš„èƒ½åŠ›ï¼Œå°†&lt;strong>ä»£è¡¨ç­–ç•¥çš„è„šæœ¬å’Œé…ç½®&lt;/strong>äº¤ç”± Repo è¿›è¡Œç®¡ç†ï¼›Pipy å®ä¾‹å®æ—¶ä» Pipy Repo åŒæ­¥&lt;strong>ç­–ç•¥&lt;/strong>ï¼Œå¹¶è¿›è¡Œ&lt;strong>åŠ¨æ€åŠ è½½&lt;/strong>ã€‚&lt;/p>
&lt;p>åŒæ—¶ Pipy Repo å¯¹å¤–æä¾› REST API æ¥ç®¡ç†ç­–ç•¥ï¼Œå¯¹ç­–ç•¥çš„ä¿®æ”¹æ›´å®¹æ˜“ã€‚ä¹Ÿæ–¹ä¾¿ä¸ä¼ä¸šç°æœ‰ç®¡ç†åå°è¿›è¡Œå¯¹æ¥ã€‚&lt;/p>
&lt;p>ä¸‹é¢å°±å¼€å§‹éƒ¨ç½²éªŒè¯ï¼Œè¿™é‡Œæ‰€ä½¿ç”¨çš„æ‰€æœ‰ä»£ç éƒ½å·²æäº¤åˆ°&lt;a href="https://github.com/flomesh-io/demo-policy-as-code"> GitHub ä»“åº“&lt;/a>ï¼šhttps://github.com/flomesh-io/demo-policy-as-codeã€‚&lt;/p>
&lt;h2 id="è¿è¡Œ">è¿è¡Œ&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">git clone https://github.com/flomesh-io/demo-policy-as-code.git
&lt;span class="nb">cd&lt;/span> demo-policy-as-code
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å‡†å¤‡">å‡†å¤‡&lt;/h3>
&lt;h4 id="ç¯å¢ƒ">ç¯å¢ƒ&lt;/h4>
&lt;p>ä½¿ç”¨ Kubernetes å‘è¡Œç‰ˆ K3s ä½œä¸ºé›†ç¾¤ç¯å¢ƒï¼Œé›†ç¾¤çš„æ­å»ºä¸åšè¿‡å¤šè¯´æ˜ã€‚æˆ‘ç”¨ &lt;a href="https://k3d.io%0A">k3d&lt;/a>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">k3d cluster create policy-as-code -p &lt;span class="s2">&amp;#34;6060:30060@server:0&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨ï¼šK3d æ˜¯åœ¨å®¹å™¨ä¸­è¿è¡Œ K3sï¼Œè¿™é‡Œåšäº†å°†å®¹å™¨çš„ &lt;code>30060&lt;/code> ç«¯å£æ˜ å°„åˆ°æœ¬åœ°çš„ &lt;code>6060&lt;/code> ç«¯å£ï¼Œåé¢ä¼šè¯¦ç»†è§£é‡Šã€‚&lt;/p>
&lt;h4 id="éƒ¨ç½²ç­–ç•¥æœåŠ¡å™¨">éƒ¨ç½²ç­–ç•¥æœåŠ¡å™¨&lt;/h4>
&lt;p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤éƒ¨ç½²ç­–ç•¥æœåŠ¡å™¨ Repoï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f repo/pipy-repo.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¡®ä¿ Pod æ­£å¸¸è¿è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get po -n pipy
NAME READY STATUS RESTARTS AGE
pipy-repo-697bbd9f4b-94pld 1/1 Running &lt;span class="m">0&lt;/span> 10s
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å‘å¸ƒç­–ç•¥">å‘å¸ƒç­–ç•¥&lt;/h4>
&lt;p>è¦ä½¿ç”¨çš„ç­–ç•¥ï¼ˆè„šæœ¬å’Œé…ç½®ï¼‰ä½äº &lt;code>./repo/scripts&lt;/code> ç›®å½•ä¸­ã€‚å‰é¢æåˆ° Repo æä¾›äº† REST API æ¥ç®¡ç† codebaseï¼ˆç­–ç•¥ï¼‰ã€‚&lt;/p>
&lt;p>è¿™é‡Œæä¾›äº†è„šæœ¬ &lt;code>init-codebase.sh&lt;/code>ï¼Œé€šè¿‡ &lt;code>curl&lt;/code> å‘½ä»¤å°†ç­–ç•¥å‘å¸ƒåˆ°ç­–ç•¥æœåŠ¡å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">./init-codebase.sh
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="éƒ¨ç½²ç­–ç•¥å¼•æ“">éƒ¨ç½²ç­–ç•¥å¼•æ“&lt;/h3>
&lt;p>è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨ helm chart å®Œæˆè¯ä¹¦çš„åˆ›å»ºã€æœåŠ¡çš„éƒ¨ç½²ä»¥åŠ Admission WebHook çš„æ³¨å†Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">helm install policy-as-code ./policy-as-code -n default
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¡®ä¿ Pod æ­£å¸¸è¿è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get po -n pipy
kubectl get po -n pipy
NAME READY STATUS RESTARTS AGE
pipy-repo-697bbd9f4b-94pld 1/1 Running &lt;span class="m">0&lt;/span> 2m
policy-as-code-5867f9cdb9-9vwks 1/1 Running &lt;span class="m">0&lt;/span> 8s
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æµ‹è¯•">æµ‹è¯•&lt;/h3>
&lt;p>åœ¨ &lt;code>./test&lt;/code> ç›®å½•ä¸­æœ‰ä¸‰ä¸ª yaml æ–‡ä»¶ç”¨äºæµ‹è¯•ã€‚&lt;/p>
&lt;p>&lt;strong>éæ³•çš„é•œåƒä»“åº“ï¼š&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f test/bad.yaml
Error from server &lt;span class="o">(&lt;/span>192.168.64.1:5000/hello-world:linux repo not start with any repo &lt;span class="o">[&lt;/span>docker.io, k8s.gcr.io&lt;span class="o">])&lt;/span>: error when creating &lt;span class="s2">&amp;#34;test/bad.yaml&amp;#34;&lt;/span>: admission webhook &lt;span class="s2">&amp;#34;validating-webhook.pipy.flomesh-io.cn&amp;#34;&lt;/span> denied the request: 192.168.64.1:5000/hello-world:linux repo not start with any repo &lt;span class="o">[&lt;/span>docker.io, k8s.gcr.io&lt;span class="o">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>éæ³•çš„é•œåƒ tagï¼š&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f test/bad2.yaml
Error from server &lt;span class="o">(&lt;/span>docker.io/library/hello-world:latest tag end with :latest&lt;span class="o">)&lt;/span>: error when creating &lt;span class="s2">&amp;#34;test/bad2.yaml&amp;#34;&lt;/span>: admission webhook &lt;span class="s2">&amp;#34;validating-webhook.pipy.flomesh-io.cn&amp;#34;&lt;/span> denied the request: docker.io/library/hello-world:latest tag end with :latest
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>åˆæ³•çš„é•œåƒ&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f test/ok.yaml
pod/hello-world-success created
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°±è¿™ä¹ˆç»“æŸäº†ï¼Ÿå½“ç„¶æ²¡æœ‰ï¼Œæˆ‘ä»¬è¿˜è¦å¯¹ç­–ç•¥è¿›è¡ŒåŠ¨æ€çš„è°ƒæ•´ã€‚&lt;/p>
&lt;p>ç»§ç»­ä¸‹é¢çš„æµ‹è¯•ä¹‹å‰ï¼Œæ‰§è¡Œ &lt;code>kubectl delete -f test/ok.yaml&lt;/code> æ¸…ç†åˆšæ‰åˆ›å»ºçš„ Podã€‚&lt;/p>
&lt;h3 id="ä¿®æ”¹ç­–ç•¥">ä¿®æ”¹ç­–ç•¥&lt;/h3>
&lt;p>ä¿®æ”¹ &lt;code>./repo/scripts/config.json&lt;/code>æ–‡ä»¶ï¼Œæ¸…ç©º &lt;code>invalidTagSuffixes&lt;/code> æ•°ç»„ä¸­çš„å†…å®¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;validRepoPrefixes&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="s2">&amp;#34;docker.io&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s2">&amp;#34;k8s.gcr.io&amp;#34;&lt;/span>
&lt;span class="p">],&lt;/span>
&lt;span class="nt">&amp;#34;invalidTagSuffixes&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>**æ³¨æ„ï¼š**è¿™é‡Œéœ€è¦æ‰§è¡Œè„šæœ¬ &lt;code>./init-codebase.sh&lt;/code> æ›´æ–°ç­–ç•¥ã€‚&lt;/p>
&lt;p>æ­¤æ—¶ï¼Œå†æ¬¡å°è¯• apply &lt;code>test/bad2.yaml&lt;/code>ã€‚ä½ ä¼šå‘ç°ï¼Œè¿™æ¬¡ Pod åˆ›å»ºæˆåŠŸäº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f test/bad2.yaml
pod/hello-world-bad-tag created
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬æ²¡æœ‰ä¿®æ”¹ä»»ä½•é€»è¾‘ä»£ç ï¼Œä»…ä»…ä¿®æ”¹äº†é…ç½®å°±å®Œæˆäº†å¯¹ Pod é•œåƒæ£€æŸ¥é€»è¾‘çš„è°ƒæ•´ã€‚å¯èƒ½æœ‰äººä¼šé—®ï¼Œå‘½ä»¤è¡Œå¤ªéº»çƒ¦è°ƒè¯•ä¸æ–¹ä¾¿ï¼Œæœ‰æ²¡æœ‰æ›´ç›´è§‚çš„æ–¹å¼ï¼Ÿ&lt;/p>
&lt;p>ç­”æ¡ˆæ˜¯ï¼šæœ‰ï¼&lt;/p>
&lt;h3 id="å›¾å½¢ç”¨æˆ·ç•Œé¢">å›¾å½¢ç”¨æˆ·ç•Œé¢&lt;/h3>
&lt;p>Pipy Repo æä¾›äº†å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼Œæ–¹ä¾¿è„šæœ¬çš„å¼€å‘å’Œè°ƒè¯•ã€‚è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒ&lt;a href="https://mp.weixin.qq.com/s/cDhPtNdng8_YZQpyFo5czw">å¿«é€Ÿå…¥é—¨ Pipy Repo&lt;/a>ï¼Œäº†è§£å›¾å½¢ç”¨æˆ·ç•Œé¢çš„ä½¿ç”¨ã€‚&lt;/p>
&lt;p>è¿˜è®°å¾—å¼€å¤´çš„åœ°æ–¹æˆ‘ä»¬ä¸º K3d å®¹å™¨åšäº†ç«¯å£æ˜ å°„ï¼š&lt;code>6060=&amp;gt;30060&lt;/code>ï¼Œç»†å¿ƒçš„ä½ ä¹Ÿå¯èƒ½å‘ç°æˆ‘ä»¬ä¸º Pipy Repo åˆ›å»ºäº† NodePort Servceï¼Œnode port ç«¯å£ä¸º &lt;code>30060&lt;/code>ã€‚&lt;/p>
&lt;p>æ­¤æ—¶ï¼Œæœ¬åœ°å¯åŠ¨ä¸€ä¸ª Pipyï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#k3d&lt;/span>
pipy http://localhost:6060 --admin-port&lt;span class="o">=&lt;/span>&lt;span class="m">6061&lt;/span>
&lt;span class="c1">#ä¸»æœºç›´æ¥éƒ¨ç½² k3s è¯·ä½¿ç”¨è¿™æ¡å‘½ä»¤&lt;/span>
pipy http://localhost:30060 --admin-port&lt;span class="o">=&lt;/span>&lt;span class="m">6061&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ &lt;code>http://localhost:6060&lt;/code>ï¼Œä½ ä¼šçœ‹åˆ°ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/08/20211208-at-003435.png" alt="">&lt;/p>
&lt;p>ç‚¹å‡»ä¸‹é¢æˆ‘ä»¬åˆ›å»ºçš„ codebase &lt;code>/image-verify&lt;/code>ï¼Œåœ¨å·¦ä¾§æ–‡ä»¶ç›®å½•ä¸­å¯ä»¥æ‰¾åˆ°æˆ‘ä»¬ä¿®æ”¹åçš„ &lt;code>config.json&lt;/code>:&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/08/20211208-at-003512.png" alt="">&lt;/p>
&lt;p>åœ¨ç¼–è¾‘å™¨ä¸­ç¼–è¾‘ï¼Œæ”¹å›åŸæ¥çš„é…ç½®ï¼Œç„¶åç‚¹å‡» 2 å’Œ 3 ä¸¤ä¸ªæŒ‰é’®&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/08/20211208-at-003659.png" alt="2021-12-08 at 00.36.59">&lt;/p>
&lt;h3 id="å†æ¬¡æµ‹è¯•">å†æ¬¡æµ‹è¯•&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#æ¸…ç†&lt;/span>
kubectl delete -f test/bad2.yaml
kubectl apply -f test/bad2.yaml
Error from server &lt;span class="o">(&lt;/span>docker.io/library/hello-world:latest tag end with :latest&lt;span class="o">)&lt;/span>: error when creating &lt;span class="s2">&amp;#34;test/bad2.yaml&amp;#34;&lt;/span>: admission webhook &lt;span class="s2">&amp;#34;validating-webhook.pipy.flomesh-io.cn&amp;#34;&lt;/span> denied the request: docker.io/library/hello-world:latest tag end with :latest
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œä¿®æ”¹çš„ç»“æœä½“ç°åœ¨é”™è¯¯ä¿¡æ¯é‡Œäº†ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>Open Policy Agent (OPA) ä¸ºç­–ç•¥å¼•æ“å¸¦æ¥äº†æ–°çš„å¤©åœ°ï¼Œä½†æ˜¯ä½¿ç”¨ Rego è¯­è¨€ç¼–å†™ç­–ç•¥ä¸ºä½¿ç”¨å¸¦æ¥äº†é—¨æ§›ã€‚Pipy ä»¥å…¶æµé‡ç¼–ç¨‹ã€æ˜“æ‰©å±•çš„ç‰¹æ€§ç»“åˆ Repo çš„ codebase ç®¡ç†ï¼Œå¯ä»¥è½»æ¾å®ç°ç­–ç•¥å³ä»£ç ã€‚åŒæ—¶ï¼Œèµ„æºæ¶ˆè€—æ›´å°‘ï¼Œæ€§èƒ½æ›´é«˜ï¼ˆä»£ç†åœºæ™¯çš„ç‰¹ç‚¹ï¼‰ã€‚&lt;/p></description></item><item><title>Kubernetes Deployment çš„æ•…éšœæ’æŸ¥å¯è§†åŒ–æŒ‡å—ï¼ˆ2021 ä¸­æ–‡ç‰ˆï¼‰</title><link>https://atbug.com/troubleshooting-kubernetes-deployment-zh-v2/</link><pubDate>Sat, 20 Nov 2021 18:29:19 +0800</pubDate><guid>https://atbug.com/troubleshooting-kubernetes-deployment-zh-v2/</guid><description>
&lt;p>å°†åº”ç”¨éƒ¨ç½²åˆ° Kubernetes æ—¶é€šå¸¸ä¼šä½¿ç”¨ Deploymentã€Serviceã€Ingressï¼Œæ•´ä¸ªåº”ç”¨ä»éƒ¨ç½²åˆ°æ­£å¸¸è¿è¡Œï¼Œç»å†çš„æµç¨‹å¾ˆé•¿ã€‚ä» kubectl apply YAML æ–‡ä»¶ï¼Œç»è¿‡ apiserverã€controller managerã€schedulerã€kubeletã€ä»¥åŠ CRIã€CNI ç­‰ä¼—å¤šç»„ä»¶çš„ååŒå·¥ä½œã€‚&lt;/p>
&lt;p>æ¼«é•¿çš„â€œè¡Œç¨‹â€ï¼ŒPod ä¹Ÿç»å†å„ç§æ­£å¸¸å’Œä¸æ­£å¸¸çš„çŠ¶æ€å˜åŒ–ï¼Œå³ä½¿æ­£å¸¸è¿è¡Œä¹Ÿä¼šå‡ºç°æœåŠ¡æ— æ³•è®¿é—®çš„é—®é¢˜ã€‚å¯¹äºåˆšå¼€å§‹åœ¨ Kubernetes å¹³å°å¼€å±•å·¥ä½œçš„åŒå­¦æ¥è¯´ï¼Œæ•…éšœçš„æ’æŸ¥ç¡®å®æ£˜æ‰‹ã€‚ä¹‹å‰å·¥ä½œçš„æ—¶å€™ï¼Œç»å¸¸è¦ååŠ©æ’æŸ¥å„ç§é—®é¢˜ã€‚å»å¹´åœ¨ Learnk8s ä¸Šçœ‹åˆ°äº†å…³äº Deployment æ•…éšœæ’æŸ¥çš„è§†å›¾ï¼Œæˆ‘è¿˜å‚è€ƒåšäº†å½“æ—¶æ•´ä¸ªå¹³å°çš„æ•…éšœæ’æŸ¥è§†å›¾ï¼ŒåŒ…æ‹¬äº†ä»é¡¹ç›®æºç ã€CICD æµæ°´çº¿ã€éƒ¨ç½²æ•´ä¸ªæµç¨‹çš„æ•…éšœæ’æŸ¥å‚è€ƒã€‚&lt;/p>
&lt;p>ç°åœ¨ Learnk8s çš„ Deployment æ’æŸ¥æŒ‡å—æ›´æ–°äº†ï¼Œä¹Ÿæœ‰äº†ä¸­æ–‡ç‰ˆæœ¬ã€‚&lt;/p>
&lt;hr>
&lt;p>å¹´ä¸­ç¿»è¯‘ Learnk8s çš„æ–‡ç« &lt;a href="https://mp.weixin.qq.com/s/GKS3DJHm4p0Tjtj8nJRGmA">ã€ŠKubernetes çš„è‡ªåŠ¨ä¼¸ç¼©ä½ ç”¨å¯¹äº†å—ï¼Ÿã€‹&lt;/a> æ—¶ï¼Œä¸ Daniele Polencic æ²Ÿé€šæ—¶è¢«é—®åŠæ˜¯å¦èƒ½ç¿»è¯‘æ•…éšœæ’æŸ¥çš„å¯è§†åŒ–æŒ‡å—ã€‚&lt;/p>
&lt;p>å¹´ä¸­çš„æ—¶å€™å°±ç¿»è¯‘å®Œäº†ï¼Œä»Šå¤©ç”µæŠ¥ä¸Šè¢«å‘ŠçŸ¥&lt;a href="https://learnk8s.io/troubleshooting-deployments">æ–‡ç«  A visual guide on troubleshooting Kubernetes deployments&lt;/a>å·²æ›´æ–°ï¼Œæ’æŸ¥è§†å›¾è¾ƒä¸Šä¸€ç‰ˆæœ‰äº†éƒ¨åˆ†çš„è°ƒæ•´ã€‚&lt;/p>
&lt;p>åŸæ–‡ï¼šhttps://learnk8s.io/troubleshooting-deployments&lt;/p>
&lt;p>ä¸­æ–‡ç‰ˆPDFï¼šhttps://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.zh_cn.v2.pdf&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/11/20/troubleshootingkuberneteszhcnv2.png" alt="troubleshooting-kubernetes.zh_cn.v2">&lt;/p></description></item><item><title>Kubernetes ä¸Šè°ƒè¯• distroless å®¹å™¨</title><link>https://atbug.com/debug-distroless-container-on-kubernetes/</link><pubDate>Wed, 03 Nov 2021 07:40:40 +0800</pubDate><guid>https://atbug.com/debug-distroless-container-on-kubernetes/</guid><description>
&lt;h2 id="tldr">TL;DR&lt;/h2>
&lt;p>æœ¬æ–‡å†…å®¹ï¼š&lt;/p>
&lt;ul>
&lt;li>ä»‹ç» distroless é•œåƒã€ä½œç”¨ä»¥åŠç®€å•çš„ä½¿ç”¨&lt;/li>
&lt;li>å¦‚ä½•é’ˆå¯¹ distroless å®¹å™¨çš„è¿›è¡Œè°ƒè¯•&lt;/li>
&lt;li>ä¸´æ—¶å®¹å™¨(v.1.18+)çš„ä½¿ç”¨&lt;/li>
&lt;/ul>
&lt;h2 id="distroless-é•œåƒ">Distroless é•œåƒ&lt;/h2>
&lt;p>Distroless å®¹å™¨ï¼Œé¡¾åæ€ä¹‰ä½¿ç”¨ &lt;a href="https://github.com/GoogleContainerTools/distroless">Distroless é•œåƒ&lt;/a>ä½œä¸ºåŸºç¡€é•œåƒè¿è¡Œçš„å®¹å™¨ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&amp;ldquo;Distroless&amp;rdquo; é•œåƒåªåŒ…å«äº†ä½ çš„åº”ç”¨ç¨‹åºä»¥åŠå…¶è¿è¡Œæ—¶æ‰€éœ€è¦çš„ä¾èµ–ã€‚ä¸åŒ…å«ä½ èƒ½åœ¨æ ‡å‡† Linxu å‘è¡Œç‰ˆé‡Œçš„å¯ä»¥æ‰¾åˆ°çš„åŒ…ç®¡ç†å™¨ã€shells æˆ–è€…å…¶ä»–ç¨‹åºã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="https://github.com/GoogleContainerTools/distroless">GoogleContainerTools/distroless&lt;/a> é’ˆå¯¹ä¸åŒè¯­è¨€æä¾›äº† distroless é•œåƒï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/GoogleContainerTools/distroless/blob/main/base/README.md">gcr.io/distroless/static-debian11&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/GoogleContainerTools/distroless/blob/main/base/README.md">gcr.io/distroless/base-debian11&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/GoogleContainerTools/distroless/blob/main/java/README.md">gcr.io/distroless/java-debian11&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/GoogleContainerTools/distroless/blob/main/cc/README.md">gcr.io/distroless/cc-debian11&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/GoogleContainerTools/distroless/blob/main/nodejs/README.md">gcr.io/distroless/nodejs-debian11&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/GoogleContainerTools/distroless/blob/main/experimental/python3/README.md">gcr.io/distroless/python3-debian11&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="distroless-é•œåƒæœ‰ä»€ä¹ˆç”¨">Distroless é•œåƒæœ‰ä»€ä¹ˆç”¨ï¼Ÿ&lt;/h2>
&lt;p>é‚£äº›å¯èƒ½æ˜¯æ„å»ºé•œåƒæ—¶éœ€è¦çš„ï¼Œä½†å¤§éƒ¨åˆ†å¹¶ä¸æ˜¯è¿è¡Œæ—¶éœ€è¦çš„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ&lt;a href="https://mp.weixin.qq.com/s/Y3GQI3hg5I8MHOV4iwVqiQ">ä¸Šç¯‡æ–‡ç« ä»‹ç» Buildpacks&lt;/a> æ—¶è¯´çš„ä¸€ä¸ª builder çš„ stack é•œåƒåŒ…å«æ„å»ºæ—¶åŸºç¡€é•œåƒå’Œè¿è¡Œæ—¶åŸºç¡€é•œåƒï¼Œè¿™æ ·å¯ä»¥åšåˆ°é•œåƒçš„æœ€å°åŒ–ã€‚&lt;/p>
&lt;p>å…¶å®æ§åˆ¶ä½“ç§¯å¹¶ä¸æ˜¯ distroless é•œåƒçš„ä¸»è¦ä½œç”¨ã€‚å°†è¿è¡Œæ—¶å®¹å™¨ä¸­çš„å†…å®¹é™åˆ¶ä¸ºåº”ç”¨ç¨‹åºæ‰€éœ€çš„ä¾èµ–ï¼Œæ­¤å¤–ä¸åº”è¯¥å®‰è£…ä»»ä½•ä¸œè¥¿ã€‚è¿™ç§æ–¹å¼å¯èƒ½æå¤§çš„æå‡å®¹å™¨çš„å®‰å…¨æ€§ï¼Œä¹Ÿæ˜¯ distroless é•œåƒçš„æœ€é‡è¦ä½œç”¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/11/02/16357706125816.jpg" alt="">&lt;/p>
&lt;p>&lt;strong>è¿™é‡Œå¹¶ä¸ä¼šå†æ·±å…¥æ¢ç©¶ distroless é•œåƒï¼Œè€Œæ˜¯å¦‚ä½•è°ƒè¯• distroless å®¹å™¨&lt;/strong>&lt;/p>
&lt;p>æ²¡æœ‰äº†åŒ…ç®¡ç†å™¨ï¼Œé•œåƒæ„å»ºå®Œæˆåå°±ä¸èƒ½å†ä½¿ç”¨ç±»ä¼¼ &lt;code>apt&lt;/code>ã€&lt;code>yum&lt;/code> çš„åŒ…ç®¡ç†å·¥å…·ï¼›æ²¡æœ‰äº† &lt;code>shell&lt;/code>ï¼Œå®¹å™¨è¿è¡Œåæ— æ³•å†è¿›å…¥å®¹å™¨ã€‚&lt;/p>
&lt;p>&lt;em>â€œå°±åƒä¸€ä¸ªæ²¡æœ‰ä»»ä½•é—¨çš„æˆ¿é—´ï¼Œä¹Ÿæ— æ³•å®‰è£…é—¨ã€‚â€&lt;/em> Distroless é•œåƒåœ¨æå‡å®¹å™¨å®‰å…¨æ€§çš„åŒæ—¶ï¼Œä¹Ÿä¸ºè°ƒè¯•å¢åŠ äº†éš¾åº¦ã€‚&lt;/p>
&lt;h2 id="ä½¿ç”¨-distroless-é•œåƒ">ä½¿ç”¨ distroless é•œåƒ&lt;/h2>
&lt;p>å†™ä¸ªå¾ˆç®€å•çš„ golang åº”ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;net/http&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">defaultHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Hello world!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">defaultHandler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¯”å¦‚ä½¿ç”¨ &lt;code>gcr.io/distroless/base-debian11&lt;/code> ä½œä¸º golang åº”ç”¨çš„åŸºç¡€é•œåƒï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> golang:1.12 as build-env&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /go/src/app&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> . /go/src/app&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go get -d -v ./...&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go build -o /go/bin/app&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> gcr.io/distroless/base-debian11&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --from&lt;span class="o">=&lt;/span>build-env /go/bin/app /&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">CMD&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/app&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨é•œåƒåˆ›å»º deployment&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl create deploy golang-distroless --image addozhang/golang-distroless-example:latest
$ kubectl get po
NAME READY STATUS RESTARTS AGE
golang-distroless-784bb4875-srmmr 1/1 Running &lt;span class="m">0&lt;/span> 3m2s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°è¯•è¿›å…¥å®¹å™¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl &lt;span class="nb">exec&lt;/span> -it golang-distroless-784bb4875-srmmr -- sh
error: Internal error occurred: error executing &lt;span class="nb">command&lt;/span> in container: failed to &lt;span class="nb">exec&lt;/span> in container: failed to start &lt;span class="nb">exec&lt;/span> &lt;span class="s2">&amp;#34;b76e800eafa85d39f909f39fcee4a4ba9fc2f37d5f674aa6620690b8e2939203&amp;#34;&lt;/span>: OCI runtime &lt;span class="nb">exec&lt;/span> failed: &lt;span class="nb">exec&lt;/span> failed: container_linux.go:380: starting container process caused: exec: &lt;span class="s2">&amp;#34;sh&amp;#34;&lt;/span>: executable file not found in &lt;span class="nv">$PATH&lt;/span>: unknown
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¦‚ä½•è°ƒè¯•-distroless-å®¹å™¨">å¦‚ä½•è°ƒè¯• Distroless å®¹å™¨&lt;/h2>
&lt;h3 id="1-ä½¿ç”¨-distroless-debug-é•œåƒ">1. ä½¿ç”¨ distroless debug é•œåƒ&lt;/h3>
&lt;p>GoogleContainerTools ä¸ºæ¯ä¸ª distroless é•œåƒéƒ½æä¾›äº† &lt;code>debug&lt;/code> tagï¼Œ&lt;strong>é€‚åˆåœ¨å¼€å‘é˜¶æ®µè¿›è¡Œè°ƒè¯•&lt;/strong>ã€‚å¦‚ä½•ä½¿ç”¨ï¼Ÿæ›¿æ¢å®¹å™¨çš„ base é•œåƒï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> golang:1.12 as build-env&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /go/src/app&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> . /go/src/app&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go get -d -v ./...&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go build -o /go/bin/app&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> gcr.io/distroless/base-debian11:debug # use debug tag here&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --from&lt;span class="o">=&lt;/span>build-env /go/bin/app /&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">CMD&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/app&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é‡æ–°æ„å»ºé•œåƒå¹¶éƒ¨ç½²ï¼Œå¾—ç›Šäº&lt;code>debug&lt;/code>é•œåƒä¸­æä¾›äº† busybox shell è®©æˆ‘ä»¬å¯ä»¥ exec åˆ°å®¹å™¨ä¸­ã€‚&lt;/p>
&lt;h3 id="2-debug-å®¹å™¨ä¸å…±äº«è¿›ç¨‹å‘½åç©ºé—´">2. debug å®¹å™¨ä¸å…±äº«è¿›ç¨‹å‘½åç©ºé—´&lt;/h3>
&lt;p>åŒä¸€ä¸ª pod ä¸­å¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œé€šè¿‡è®¾ç½® &lt;code>pod.spec.shareProcessNamespace&lt;/code> ä¸º &lt;code>true&lt;/code>ï¼Œæ¥è®©åŒä¸€ä¸ª Pod ä¸­çš„&lt;a href="https://kubernetes.io/docs/tasks/configure-pod-container/share-process-namespace/">å¤šå®¹å™¨å…±äº«åŒä¸€ä¸ªè¿›ç¨‹å‘½åç©ºé—´&lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Share a single process namespace between all of the containers in a pod.
When this is set containers will be able to view and signal processes from
other containers in the same pod, and the first process in each container
will not be assigned PID 1. HostPID and ShareProcessNamespace cannot both
be set. Optional: Default to false.&lt;/p>
&lt;/blockquote>
&lt;p>æ·»åŠ ä¸€ä¸ªä½¿ç”¨ &lt;code>ubuntu&lt;/code> é•œåƒçš„ &lt;code>debug&lt;/code> å®¹å™¨ï¼Œè¿™é‡Œä¸ºäº†æµ‹è¯•ï¼ˆåé¢è§£é‡Šï¼‰æˆ‘ä»¬ä¸ºåŸå®¹å™¨æ·»åŠ  &lt;code>securityContext.runAsUser: 1000&lt;/code>ï¼Œæ¨¡æ‹Ÿä¸¤ä¸ªå®¹å™¨ä½¿ç”¨ä¸åŒçš„ UID è¿è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">golang-distroless&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">golang-distroless&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">golang-distroless&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">strategy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">golang-distroless&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">shareProcessNamespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">addozhang/golang-distroless-example:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">golang-distroless-example&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">securityContext&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">runAsUser&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1000&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ubuntu&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">debug&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;sleep&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;1d&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">securityContext&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">capabilities&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">add&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">SYS_PTRACE&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ›´æ–° deployment ä¹‹åï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get po
NAME READY STATUS RESTARTS AGE
golang-distroless-85c4896c45-rkjwn 2/2 Running &lt;span class="m">0&lt;/span> 3m12s
$ kubectl get po -o json &lt;span class="p">|&lt;/span> jq -r &lt;span class="s1">&amp;#39;.items[].spec.containers[].name&amp;#39;&lt;/span>
golang-distroless-example
debug
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åé€šè¿‡ debug å®¹å™¨æ¥è¿›å…¥åˆ° pod ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl &lt;span class="nb">exec&lt;/span> -it golang-distroless-85c4896c45-rkjwn -c debug -- sh
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶ååœ¨å®¹å™¨ä¸­æ‰§è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ ps -ef
UID PID PPID C STIME TTY TIME CMD
root &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 14:54 ? 00:00:00 /pause &lt;span class="c1"># infra å®¹å™¨&lt;/span>
&lt;span class="m">1000&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 14:54 ? 00:00:00 /app &lt;span class="c1"># åŸå®¹å™¨ï¼ŒUID ä¸º 1000&lt;/span>
root &lt;span class="m">19&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 14:55 ? 00:00:00 sleep 1d &lt;span class="c1"># debug å®¹å™¨&lt;/span>
root &lt;span class="m">25&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 14:55 pts/0 00:00:00 sh
root &lt;span class="m">32&lt;/span> &lt;span class="m">25&lt;/span> &lt;span class="m">0&lt;/span> 14:55 pts/0 00:00:00 ps -ef
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°è¯•è®¿é—® è¿›ç¨‹ &lt;code>7&lt;/code> çš„è¿›ç¨‹ç©ºé—´ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ cat /proc/7/environ
$ cat: /proc/7/environ: Permission denied
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬éœ€è¦ä¸º &lt;code>debug&lt;/code> å®¹å™¨åŠ ä¸Šï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">securityContext&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">capabilities&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">add&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">SYS_PTRACE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹‹åå†è®¿é—®å°±æ­£å¸¸äº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ cat /proc/7/environ
&lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binHOSTNAME&lt;span class="o">=&lt;/span>golang-distroless-58b6c5f455-v9zkvSSL_CERT_FILE&lt;span class="o">=&lt;/span>/etc/ssl/certs/ca-certificates.crtKUBERNETES_PORT_443_TCP&lt;span class="o">=&lt;/span>tcp://10.43.0.1:443KUBERNETES_PORT_443_TCP_PROTO&lt;span class="o">=&lt;/span>&lt;span class="nv">tcpKUBERNETES_PORT_443_TCP_PORT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">443KUBERNETES_PORT_443_TCP_ADDR&lt;/span>&lt;span class="o">=&lt;/span>10.43.0.1KUBERNETES_SERVICE_HOST&lt;span class="o">=&lt;/span>10.43.0.1KUBERNETES_SERVICE_PORT&lt;span class="o">=&lt;/span>&lt;span class="nv">443KUBERNETES_SERVICE_PORT_HTTPS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">443KUBERNETES_PORT&lt;/span>&lt;span class="o">=&lt;/span>tcp://10.43.0.1:443HOME&lt;span class="o">=&lt;/span>/root
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŒæ ·æˆ‘ä»¬ä¹Ÿå¯ä»¥è®¿é—®è¿›ç¨‹çš„æ–‡ä»¶ç³»ç»Ÿï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-sh" data-lang="sh">$ &lt;span class="nb">cd&lt;/span> /proc/7/root
$ ls
app bin boot dev etc home lib lib64 proc root run sbin sys tmp usr var
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ— éœ€ä¿®æ”¹å®¹å™¨çš„åŸºç¡€é•œåƒï¼Œä½¿ç”¨ &lt;code>pod.spec.shareProcessNamespace: true&lt;/code> é…åˆå®‰å…¨é…ç½®ä¸­å¢åŠ  &lt;code>SYS_PTRACE&lt;/code> ç‰¹æ€§ï¼Œä¸º debug å®¹å™¨èµ‹äºˆå®Œæ•´çš„ shell è®¿é—®æ¥è°ƒè¯•åº”ç”¨ã€‚ä½†æ˜¯ä¿®æ”¹ YAML å’Œå®‰å…¨é…ç½®åªé€‚åˆåœ¨æµ‹è¯•ç¯å¢ƒä½¿ç”¨ï¼Œåˆ°äº†ç”Ÿäº§ç¯å¢ƒè¿™äº›éƒ½æ˜¯ä¸å…è®¸çš„ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ° &lt;code>kubectl debug&lt;/code> äº†ã€‚&lt;/p>
&lt;h3 id="3-kubectl-debug">3. Kubectl debug&lt;/h3>
&lt;p>é’ˆå¯¹ä¸åŒçš„èµ„æº &lt;code>kubectl debug&lt;/code> å¯ä»¥è¿›è¡Œä¸åŒæ“ä½œï¼š&lt;/p>
&lt;ul>
&lt;li>è´Ÿè½½ï¼šåˆ›å»ºä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ Pod çš„æ‹·è´ï¼Œå¹¶å¯ä»¥ä¿®æ”¹éƒ¨åˆ†å±æ€§ã€‚æ¯”å¦‚åœ¨æ‹·è´ä¸­ä½¿ç”¨æ–°ç‰ˆæœ¬çš„tagã€‚&lt;/li>
&lt;li>è´Ÿè½½ï¼šä¸ºè¿è¡Œä¸­çš„ Pod å¢åŠ ä¸€ä¸ªä¸´æ—¶å®¹å™¨ï¼ˆä¸‹é¢ä»‹ç»ï¼‰ï¼Œä½¿ç”¨ä¸´æ—¶å®¹å™¨ä¸­çš„å·¥å…·è°ƒè¯•ï¼Œæ— éœ€é‡å¯ Podã€‚&lt;/li>
&lt;li>èŠ‚ç‚¹ï¼šåœ¨èŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ª Pod è¿è¡Œåœ¨&lt;strong>èŠ‚ç‚¹çš„ host å‘½åç©ºé—´&lt;/strong>ï¼Œå¯ä»¥è®¿é—®èŠ‚ç‚¹çš„æ–‡ä»¶ç³»ç»Ÿã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="31-ä¸´æ—¶å®¹å™¨">3.1 ä¸´æ—¶å®¹å™¨&lt;/h4>
&lt;p>ä» Kubernetes 1.18 ä¹‹åå¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨ &lt;code>kubectl&lt;/code> ä¸ºè¿è¡Œçš„ pod æ·»åŠ ä¸€ä¸ªä¸´æ—¶å®¹å™¨ã€‚è¿™ä¸ªå‘½ä»¤è¿˜å¤„äº &lt;code>alpha&lt;/code> é˜¶æ®µï¼Œå› æ­¤éœ€è¦åœ¨&lt;a href="k3d%20cluster%20create%20test%20--k3s-arg%20%22--kube-apiserver-arg=feature-gates=EphemeralContainers=true%22@">â€œfeature gateâ€&lt;/a>ä¸­æ‰“å¼€ã€‚&lt;/p>
&lt;p>åœ¨ä½¿ç”¨ k3d åˆ›å»º k3s é›†ç¾¤æ—¶ï¼Œæ‰“å¼€ &lt;code>EphemeralContainers&lt;/code> featureï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ k3d cluster create &lt;span class="nb">test&lt;/span> --k3s-arg &lt;span class="s2">&amp;#34;--kube-apiserver-arg=feature-gates=EphemeralContainers=true&amp;#34;&lt;/span>@
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶ååˆ›å»ºä¸´æ—¶å®¹å™¨ï¼Œåˆ›å»ºå®Œæˆåä¼šç›´æ¥è¿›å…¥å®¹å™¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl debug golang-distroless-85c4896c45-rkjwn -it --image&lt;span class="o">=&lt;/span>ubuntu --image-pull-policy&lt;span class="o">=&lt;/span>IfNotPresent
&lt;span class="c1">#ä¸´æ—¶å®¹å™¨ shell&lt;/span>
$ apt update &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> apt install -y curl
$ curl localhost:8080
Hello world!
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/11/02/20211102110330.png" alt="ä¸´æ—¶å®¹å™¨">&lt;/p>
&lt;p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸´æ—¶å®¹å™¨æ— æ³•ä¸åŸå®¹å™¨å…±äº«è¿›ç¨‹å‘½åç©ºé—´ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ ps -ef
UID PID PPID C STIME TTY TIME CMD
root &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 02:59 pts/0 00:00:00 bash
root &lt;span class="m">3042&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> 03:02 pts/0 00:00:00 ps -ef
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥é€šè¿‡æ·»åŠ å‚æ•° &lt;code>--target=[container]&lt;/code> æ¥å°†ä¸´æ—¶å®¹å™¨æŒ‚æ¥åˆ°ç›®æ ‡å®¹å™¨ã€‚è¿™é‡Œä¸ &lt;code>pod.spec.shareProcessNamespace&lt;/code> å¹¶ä¸åŒï¼Œ&lt;strong>è¿›ç¨‹å·ä¸º 1 çš„è¿›ç¨‹æ˜¯ç›®æ ‡å®¹å™¨çš„è¿›ç¨‹&lt;/strong>ï¼Œè€Œåè€…çš„è¿›ç¨‹æ˜¯ infra å®¹å™¨çš„è¿›ç¨‹ &lt;code>/pause&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl debug golang-distroless-85c4896c45-rkjwn -it --image&lt;span class="o">=&lt;/span>ubuntu --image-pull-policy&lt;span class="o">=&lt;/span>IfNotPresent --target&lt;span class="o">=&lt;/span>golang-distroless-example
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„ï¼šç›®å‰çš„ç‰ˆæœ¬è¿˜ä¸æ”¯æŒåˆ é™¤ä¸´æ—¶å®¹å™¨ï¼Œå‚è€ƒ &lt;a href="https://github.com/kubernetes/kubernetes/issues/84764#issuecomment-872839644">issue&lt;/a>ï¼Œæ”¯æŒçš„ç‰ˆæœ¬ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/11/02/20211102111319.png" alt="">&lt;/p>
&lt;h4 id="32-æ‹·è´-pod-å¹¶æ·»åŠ å®¹å™¨">3.2 æ‹·è´ Pod å¹¶æ·»åŠ å®¹å™¨&lt;/h4>
&lt;p>é™¤äº†æ·»åŠ ä¸´æ—¶å®¹å™¨ä»¥å¤–ï¼Œå¦ä¸€ç§æ–¹å¼å°±æ˜¯åˆ›å»ºä¸€ä¸ª Pod çš„æ‹·è´ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªå®¹å™¨ã€‚&lt;strong>æ³¨æ„è¿™é‡Œçš„æ˜¯æ™®é€šå®¹å™¨ï¼Œä¸æ˜¯ä¸´æ—¶å®¹å™¨ã€‚&lt;/strong> æ³¨æ„è¿™é‡ŒåŠ ä¸Šäº† &lt;code>--share-processes&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl debug golang-distroless-85c4896c45-rkjwn -it --image&lt;span class="o">=&lt;/span>ubuntu --image-pull-policy&lt;span class="o">=&lt;/span>IfNotPresent --share-processes --copy-to&lt;span class="o">=&lt;/span>golang-distroless-debug
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„è¿™é‡ŒåŠ ä¸Šäº† &lt;code>--share-processes&lt;/code>ï¼Œä¼šè‡ªåŠ¨åŠ ä¸Š &lt;code>pod.spec.shareProcessNamespace=true&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get po golang-distroless-debug -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{.spec.shareProcessNamespace}&amp;#39;&lt;/span>
&lt;span class="nb">true&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ³¨æ„ï¼šä½¿ç”¨ &lt;code>kubectl debug&lt;/code> è°ƒè¯•ï¼Œå¹¶ä¸èƒ½ä¸º pod è‡ªåŠ¨åŠ ä¸Š &lt;code>SYS_PTRACE&lt;/code> å®‰å…¨ç‰¹æ€§ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœå®¹å™¨ä½¿ç”¨çš„ UID ä¸ä¸€è‡´ï¼Œå°±æ— æ³•è®¿é—®è¿›ç¨‹ç©ºé—´ã€‚&lt;/strong> æˆªæ­¢å‘æ–‡ï¼Œ&lt;a href="https://github.com/kubernetes/kubernetes/issues/97103#issuecomment-899382147">è®¡åˆ’åœ¨ &lt;code>1.23&lt;/code> ä¸­æ”¯æŒ&lt;/a>ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ç›®å‰ä¸Šé¢æ‰€æœ‰çš„éƒ½ä¸é€‚åˆåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œæ— æ³•åœ¨ä¸ä¿®æ”¹ Pod å®šä¹‰çš„æƒ…å†µä¸‹è¿›è¡Œè°ƒè¯•ã€‚&lt;/p>
&lt;p>æœŸæœ› Kubernetes 1.23 ç‰ˆæœ¬ä¹‹å &lt;code>debug&lt;/code> åŠŸèƒ½æ·»åŠ  &lt;code>SYS_PTRACE&lt;/code> çš„æ”¯æŒã€‚åˆ°æ—¶å€™ï¼Œå†å°è¯•ä¸€ä¸‹ã€‚&lt;/p></description></item><item><title>è‡ªåŠ¨æ›¿æ¢ Kubernetes é•œåƒ</title><link>https://atbug.com/kubernetes-images-swapper/</link><pubDate>Wed, 06 Oct 2021 08:01:41 +0800</pubDate><guid>https://atbug.com/kubernetes-images-swapper/</guid><description>
&lt;p>å‰å‡ å¤©æœ‰æœ‹å‹åœ¨é—®å¦‚ä½•åœ¨æŸäº‘ä¸Šæ‹‰å– Tekton çš„é•œåƒï¼Œè¿™ç§æƒ…å†µå…¶å®æ¯”è¾ƒæ™®éä¸åªæ˜¯æŸäº‘ã€‚å·¥ä½œä¸­ç»å¸¸è¦ç”¨åˆ°è¿‡æŸäº›é è¿æ°”æ‰èƒ½æ‹‰å–åˆ°çš„é•œåƒï¼Œè¿™å¯¹å·¥ä½œæ¥è¯´çœŸæ˜¯æåº¦çš„ä¸å‹å¥½ã€‚&lt;/p>
&lt;p>å› æ­¤ä¹ŸèŒç”Ÿäº†ä¸ªæƒ³æ³•ï¼Œç»´æŠ¤ä¸€ä¸ªåç½‘ç»œå‹å¥½çš„ä»“åº“é•œåƒï¼Œåœ¨ Pod åˆ›å»ºæ—¶å°†é•œåƒä»“åº“åˆ‡æ¢åˆ°è‡ªç»´æŠ¤çš„ä»“åº“ï¼Œä»è‡ªç»´æŠ¤çš„ä»“åº“æ‹‰å–é•œåƒã€‚&lt;/p>
&lt;p>å‰å‡ å¤©&lt;a href="https://mp.weixin.qq.com/s/SL_yBvyhb5p6Lm1HieJBbA">ä½“éªŒäº†æç‹Gitlab çš„å®¹å™¨é•œåƒåº“&lt;/a>ï¼Œä¾¿æ˜¯ä¸ºè¿™ä¸ªæƒ³æ³•åšçš„å‡†å¤‡ã€‚å½“ç„¶å…¶ä»–çš„äº‘å‚å•†ä¹Ÿæœ‰æä¾›é’ˆå¯¹ä¸ªäººç‰ˆçš„å…è´¹é•œåƒä»“åº“å’Œä¼ä¸šç‰ˆä»“åº“ã€‚&lt;/p>
&lt;p>æ­£å¥½ &lt;a href="https://mp.weixin.qq.com/s/uZ_Q5Fn3XpfUEHBOFxWdvg">Pipy ä½œä¸ºç­–ç•¥å¼•æ“&lt;/a>ï¼Œéå¸¸é€‚åˆå®ç°è¿™ç§ç­–ç•¥çš„æ‰§è¡Œã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/10/05/20211005212733.png" alt="">&lt;/p>
&lt;h2 id="å®ç°æ€è·¯">å®ç°æ€è·¯&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/10/05/20211005210725.png" alt="">&lt;/p>
&lt;h3 id="admission-webhook">Admission Webhook&lt;/h3>
&lt;p>&lt;a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers/">Kubernetes åŠ¨æ€å‡†å¤‡æ§åˆ¶&lt;/a> çš„ &lt;code>MutatingWebhookConfiguration&lt;/code> å¯ä»¥ hook Pod çš„åˆ›å»ºæˆ–è€…æ›´æ–°ï¼Œç„¶åè°ƒç”¨ç›®æ ‡æœåŠ¡å¯¹ Pod èµ„æºå¯¹è±¡è¿›è¡Œ patch æ“ä½œã€‚&lt;/p>
&lt;h3 id="ç­–ç•¥å¼•æ“">ç­–ç•¥å¼•æ“&lt;/h3>
&lt;p>Pipy ä½œä¸ºåº”ç”¨çš„æ ¸å¿ƒï¼Œä¹Ÿå°±æ˜¯ &lt;code>MutatingWebhookConfiguration&lt;/code> çš„ç›®æ ‡æœåŠ¡ï¼Œä»¥ç­–ç•¥å¼•æ“çš„è§’è‰²å®Œæˆç­–ç•¥çš„æ‰§è¡Œã€‚&lt;/p>
&lt;p>Pipy æ”¯æŒä»æ–‡ä»¶æˆ–è€… HTTP åœ°å€åŠ è½½è„šæœ¬ï¼Œè¿™é‡Œä¸ºäº†ä¾¿äºç­–ç•¥çš„æ›´æ–°ï¼Œä½¿ç”¨äº†åè€…ã€‚&lt;/p>
&lt;p>å¯¹äºä» HTTP åœ°å€åŠ è½½è„šæœ¬ï¼ŒHTTP åœ°å€è¿”å›å†…å®¹çš„ç¬¬ä¸€è¡Œä¼šä½œä¸º Pipy çš„ä¸»è„šæœ¬ï¼ŒPipy å¯åŠ¨æ—¶ä¼šåŠ è½½ä¸»è„šæœ¬ï¼Œå…¶ä»–çš„æ–‡ä»¶ä¹Ÿä¼šè¢«ç¼“å­˜åˆ°å†…å­˜ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#åœ°å€ http://localhost:6080/repo/registry-mirror/&lt;/span>
$ curl http://localhost:6080/repo/registry-mirror/
/main.js
/config.json
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Pipy ä¼šæ¯éš” 5s æ£€æŸ¥è„šæœ¬å’Œé…ç½®æ–‡ä»¶çš„ &lt;code>etag&lt;/code>ï¼ˆå°±æ˜¯æ–‡ä»¶çš„æœ€åæ›´æ–°æ—¶é—´ï¼‰ï¼Œå‡å¦‚ä¸å½“å‰æ–‡ä»¶çš„ etag ä¸ä¸€è‡´ï¼Œåˆ™ä¼šç¼“å­˜å¹¶é‡æ–°åŠ è½½ã€‚&lt;/p>
&lt;p>åˆ©ç”¨ Pipy çš„è¿™ä¸ªç‰¹æ€§ï¼Œä¾¿å¯ä»¥ç­–ç•¥å’Œé…ç½®çš„å‡†å®æ—¶æ›´æ–°ã€‚&lt;/p>
&lt;h3 id="ç­–ç•¥">ç­–ç•¥&lt;/h3>
&lt;p>å¯¹äºç­–ç•¥çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å…¶é€»è¾‘å’Œé…ç½®è¿›è¡Œäº†åˆ†ç¦»ã€‚é…ç½®éƒ¨åˆ†ï¼Œé…ç½®äº†éœ€è¦è¿›è¡Œæ›¿æ¢çš„é•œåƒçš„å‰ç¼€ï¼Œä»¥åŠæ›¿æ¢æˆçš„å†…å®¹ï¼›è€Œé€»è¾‘ï¼Œè¿™æ˜¯å¯¹ &lt;code>MutatingWebhookConfiguration&lt;/code> çš„ &lt;code>AdmissionReview&lt;/code> çš„å¯¹è±¡è¿›è¡Œæ£€æŸ¥ã€‚&lt;/p>
&lt;p>é…ç½®ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;registries&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;registry.gitlab.cn/flomesh/registry-mirror/tekton-pipeline&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¯”å¦‚è¯´ï¼Œå¯¹äºé•œåƒ &lt;code>gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/controller:v0.28.1&lt;/code>ï¼Œå°† &lt;code>gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd&lt;/code> æ›¿æ¢æˆ &lt;code>registry.gitlab.cn/addozhang/registry-mirror/tekton-pipeline&lt;/code>ã€‚&lt;/p>
&lt;h2 id="demo">Demo&lt;/h2>
&lt;p>æœ¬æ–‡ä½¿ç”¨æ‰€æœ‰çš„&lt;a href="https://github.com/addozhang/registry-mirror">æºç &lt;/a>éƒ½å·²ä¸Šä¼ åˆ°äº† githubã€‚&lt;/p>
&lt;h3 id="è„šæœ¬æœåŠ¡å™¨">è„šæœ¬æœåŠ¡å™¨&lt;/h3>
&lt;p>æ—¢ç„¶é€‰ç”¨äº† HTTP æ–¹å¼åŠ è½½ Pipy çš„è„šæœ¬ï¼Œé‚£å°±éœ€è¦å®ç°ä¸€ä¸ªè„šæœ¬æœåŠ¡å™¨ã€‚å®ç°çš„æ–¹å¼æœ‰ä¸¤ç§ï¼šä½¿ç”¨è„šæœ¬å®ç°è„šæœ¬æœåŠ¡å™¨å’Œä½¿ç”¨ Pipy å†…ç½®çš„ Codebaseã€‚&lt;/p>
&lt;h4 id="ä½¿ç”¨è„šæœ¬å®ç°è„šæœ¬æœåŠ¡å™¨">ä½¿ç”¨è„šæœ¬å®ç°è„šæœ¬æœåŠ¡å™¨&lt;/h4>
&lt;p>æ ¹æ®éœ€æ±‚å®šä¹‰ä¸¤ç§è·¯ç”±ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>/repo/registry-mirror/&lt;/code>ï¼šè¿”å›è„šæœ¬å’Œé…ç½®çš„æ–‡ä»¶åˆ—è¡¨&lt;/li>
&lt;li>&lt;code>/repo/registry-mirror/[File Name]&lt;/code>ï¼šè¿”å›å¯¹åº”çš„æ–‡ä»¶çš„å†…å®¹ï¼ŒåŒæ—¶éœ€è¦åœ¨å“åº”å¤´æ·»åŠ  &lt;code>etag&lt;/code>ï¼Œå€¼æ˜¯æ–‡ä»¶çš„æ›´æ–°æ—¶é—´&lt;/li>
&lt;/ul>
&lt;p>å…·ä½“è„šæœ¬å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="err">#&lt;/span>&lt;span class="nx">repo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">js&lt;/span>
&lt;span class="nx">pipy&lt;/span>&lt;span class="p">({&lt;/span>
&lt;span class="nx">_serveFile&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">type&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filename&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">filename&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">head&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">substring&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">22&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="nx">Message&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nx">bodiless&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">head&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">method&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;HEAD&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">headers&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="s1">&amp;#39;etag&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mtime&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;content-type&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">type&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">head&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">method&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;HEAD&amp;#39;&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">readFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">)&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="nx">Message&lt;/span>&lt;span class="p">({&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">404&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="sb">`file &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb"> not found`&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="nx">_router&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">algo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">URLRouter&lt;/span>&lt;span class="p">({&lt;/span>
&lt;span class="s1">&amp;#39;/repo/registry-mirror/&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Message&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;/main.js\n/config.json&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="s1">&amp;#39;/repo/registry-mirror/*&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">_serveFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;text/plain&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}),&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">6080&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">serveHTTP&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">_router&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">find&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">head&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">)&lt;/span>&lt;span class="o">%&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ pipy repo.js
2021-10-05 21:40:25 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span>
2021-10-05 21:40:25 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> Module /repo.js
2021-10-05 21:40:25 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> &lt;span class="o">===============&lt;/span>
2021-10-05 21:40:25 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span>
2021-10-05 21:40:25 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>Listen on :::6080&lt;span class="o">]&lt;/span>
2021-10-05 21:40:25 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> -----&amp;gt;&lt;span class="p">|&lt;/span>
2021-10-05 21:40:25 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> &lt;span class="p">|&lt;/span>
2021-10-05 21:40:25 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> serveHTTP
2021-10-05 21:40:25 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> &lt;span class="p">|&lt;/span>
2021-10-05 21:40:25 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> &amp;lt;-----&lt;span class="p">|&lt;/span>
2021-10-05 21:40:25 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span>
2021-10-05 21:40:25 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>listener&lt;span class="o">]&lt;/span> Listening on port &lt;span class="m">6080&lt;/span> at ::
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥è·¯ç”±ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ curl http://localhost:6080/repo/registry-mirror/
/main.js
/config.json
$ curl http://localhost:6080/repo/registry-mirror/main.js
&lt;span class="c1">#çœç•¥ main.js çš„å†…å®¹&lt;/span>
$ curl http://localhost:6080/repo/registry-mirror/config.json
&lt;span class="c1">#çœç•¥ config.json çš„å†…å®¹&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ä½¿ç”¨-pipy-å†…ç½®çš„-codebase">ä½¿ç”¨ Pipy å†…ç½®çš„ Codebase&lt;/h4>
&lt;p>åœ¨æœ€æ–°å‘å¸ƒçš„ Pipy å†…ç½®äº†ä¸€ä¸ª Codebaseï¼Œå¤§å®¶å¯ä»¥ç†è§£æˆè„šæœ¬ä»“åº“ï¼Œä½†æ˜¯æ¯”å•çº¯çš„ä»“åº“åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼ˆåé¢ä¼šæœ‰æ–‡æ¡£ä»‹ç»è¯¥ç‰¹æ€§ï¼‰ã€‚&lt;/p>
&lt;p>ç›®å‰ç‰ˆæœ¬çš„ Codebase è¿˜æœªæ”¯æŒæŒä¹…åŒ–çš„å­˜å‚¨ï¼Œæ•°æ®éƒ½æ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚åç»­ä¼šæä¾› KV store æˆ–è€… git ç±»å‹çš„æŒä¹…åŒ–æ”¯æŒã€‚&lt;/p>
&lt;p>å¯åŠ¨ Pipy çš„ Codebaseå¾ˆç®€å•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ pipy
2021-10-05 21:49:08 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>codebase&lt;span class="o">]&lt;/span> Starting codebase service...
2021-10-05 21:49:08 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>listener&lt;span class="o">]&lt;/span> Listening on port &lt;span class="m">6060&lt;/span> at ::
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/10/05/20211005215007.png" alt="">&lt;/p>
&lt;p>å¯¹äºæ–°çš„ Codebase æ§åˆ¶å°çš„ä½¿ç”¨ï¼Œè¿™é‡Œä¸åšè¿‡å¤šçš„ä»‹ç»ï¼Œç›´æ¥ä½¿ç”¨ REST API å®Œæˆè„šæœ¬çš„å†™å…¥ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#åˆ›å»º registry-mirror codebaseï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªç©ºçš„ main.js&lt;/span>
$ curl -X POST http://localhost:6060/api/v1/repo/registry-mirror
&lt;span class="c1">#æ›´æ–° main.js&lt;/span>
$ curl -X POST &lt;span class="s1">&amp;#39;http://localhost:6060/api/v1/repo/registry-mirror/main.js&amp;#39;&lt;/span> --data-binary &lt;span class="s1">&amp;#39;@scripts/main.js&amp;#39;&lt;/span>
&lt;span class="c1">#åˆ›å»º config.json&lt;/span>
$ curl -X POST &lt;span class="s1">&amp;#39;http://localhost:6060/api/v1/repo/registry-mirror/config.json&amp;#39;&lt;/span> --data-binary &lt;span class="s1">&amp;#39;@scripts/config.json&amp;#39;&lt;/span>
&lt;span class="c1">#æ£€æŸ¥ codebase çš„ç‰ˆæœ¬&lt;/span>
$ curl -s http://localhost:6060/api/v1/repo/registry-mirror &lt;span class="p">|&lt;/span> jq -r .version
&lt;span class="c1">#æ›´æ–°ç‰ˆæœ¬&lt;/span>
$ curl -X POST &lt;span class="s1">&amp;#39;http://localhost:6060/api/v1/repo/registry-mirror&amp;#39;&lt;/span> --data-raw &lt;span class="s1">&amp;#39;{&amp;#34;version&amp;#34;:2}&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…">å®‰è£…&lt;/h3>
&lt;p>è¿›å…¥åˆ°é¡¹ç›®çš„æ ¹ç›®å½•ä¸­ï¼Œæ‰§è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ helm install registry-mirror ./registry-mirror -n default
NAME: registry-mirror
LAST DEPLOYED: Tue Oct &lt;span class="m">5&lt;/span> 22:19:26 &lt;span class="m">2021&lt;/span>
NAMESPACE: default
STATUS: deployed
REVISION: &lt;span class="m">1&lt;/span>
TEST SUITE: None
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹ webhookï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get mutatingwebhookconfigurations
NAME WEBHOOKS AGE
registry-mirror-webhook &lt;span class="m">1&lt;/span> 2m6s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥ pod çš„å¯åŠ¨æ—¥å¿—ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl logs -n pipy -l &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>pipy
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>codebase&lt;span class="o">]&lt;/span> GET http://192.168.1.101:6060/repo/registry-mirror/ -&amp;gt; &lt;span class="m">21&lt;/span> bytes
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>codebase&lt;span class="o">]&lt;/span> GET /repo/registry-mirror/main.js -&amp;gt; &lt;span class="m">2213&lt;/span> bytes
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>codebase&lt;span class="o">]&lt;/span> GET /repo/registry-mirror/config.json -&amp;gt; &lt;span class="m">149&lt;/span> bytes
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span>
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> Module /main.js
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> &lt;span class="o">===============&lt;/span>
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span>
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>Listen on :::6443&lt;span class="o">]&lt;/span>
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> -----&amp;gt;&lt;span class="p">|&lt;/span>
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> &lt;span class="p">|&lt;/span>
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> acceptTLS
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> &lt;span class="p">|&lt;/span>
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> &lt;span class="p">|&lt;/span>--&amp;gt; &lt;span class="o">[&lt;/span>tls-offloaded&lt;span class="o">]&lt;/span>
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> decodeHTTPRequest
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> replaceMessage
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> encodeHTTPResponse --&amp;gt;&lt;span class="p">|&lt;/span>
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> &lt;span class="p">|&lt;/span>
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span> &amp;lt;---------------------------------&lt;span class="p">|&lt;/span>
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>config&lt;span class="o">]&lt;/span>
2021-10-05 14:19:28 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>listener&lt;span class="o">]&lt;/span> Listening on port &lt;span class="m">6443&lt;/span> at ::
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æµ‹è¯•">æµ‹è¯•&lt;/h3>
&lt;p>åœ¨&lt;a href="https://mp.weixin.qq.com/s/SL_yBvyhb5p6Lm1HieJBbA">ä¸Šä¸€ç¯‡&lt;/a>ä¸­æˆ‘å·²ç»æ¨é€äº† Tekton çš„ä¸¤ä¸ªé•œåƒåˆ°å®¹å™¨é•œåƒåº“ä¸­ï¼Œå› æ­¤è¿™é‡Œç›´æ¥å®‰è£… tekton è¿›è¡Œæµ‹è¯•ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/previous/v0.28.1/release.yaml
$ kubectl get pod -n tekton-pipelines
NAME READY STATUS RESTARTS AGE
tekton-pipelines-controller-75974fbfb8-f62dv 1/1 Running &lt;span class="m">0&lt;/span> 7m36s
tekton-pipelines-webhook-6cc478f7ff-mm5l9 1/1 Running &lt;span class="m">0&lt;/span> 7m36s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥ç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pod -o json -n tekton-pipelines -l &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>tekton-pipelines-controller &lt;span class="p">|&lt;/span> jq -r &lt;span class="s1">&amp;#39;.items[].spec.containers[].image&amp;#39;&lt;/span>
registry.gitlab.cn/flomesh/registry-mirror/tekton-pipeline/controller:v0.28.1
$ kubectl get pod -o json -n tekton-pipelines -l &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>tekton-pipelines-webhook &lt;span class="p">|&lt;/span> jq -r &lt;span class="s1">&amp;#39;.items[].spec.containers[].image&amp;#39;&lt;/span>
registry.gitlab.cn/flomesh/registry-mirror/tekton-pipeline/webhook:v0.28.1
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹åˆ°ç»“æœæ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>æ•´ä¸ªå®ç°çš„ç­–ç•¥éƒ¨åˆ†åŠ ä¸Šé…ç½®ï¼Œåªæœ‰ 70 å¤šè¡Œçš„ä»£ç ã€‚å¹¶ä¸”å®ç°äº†é€»è¾‘ä¸é…ç½®çš„åˆ†ç¦»ä¹‹åï¼Œåç»­çš„é…ç½®ä¹Ÿéƒ½å¯ä»¥åšåˆ°å®æ—¶çš„æ›´æ–°è€Œæ— éœ€ä¿®æ”¹ä»»ä½•é€»è¾‘ä»£ç ï¼Œæ›´æ— éœ€é‡æ–°éƒ¨ç½²ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ç›®å‰çš„å®ç°ï¼Œæ˜¯éœ€è¦æ‰‹åŠ¨æŠŠé•œåƒæ¨é€çš„è‡ªç»´æŠ¤çš„é•œåƒä»“åº“ä¸­ã€‚å®é™…ä¸Šç†æƒ³çš„æƒ…å†µæ˜¯æ£€æŸ¥è‡ªç»´æŠ¤çš„ä»“åº“ä¸­æ˜¯å¦å­˜åœ¨é•œåƒï¼ˆæ¯”å¦‚é€šè¿‡ REST APIï¼‰ï¼Œå¦‚æœæœªå‘ç°é•œåƒï¼Œå…ˆæŠŠé•œåƒæ‹‰å–åˆ°æœ¬åœ°ï¼Œ&lt;code>tag&lt;/code> åå†æ¨é€åˆ°è‡ªç»´æŠ¤çš„ä»“åº“ã€‚ä¸è¿‡è¿™ç§æ“ä½œï¼Œè¿˜æ˜¯éœ€è¦ç½‘ç»œçš„ç•…é€šã€‚å½“ç„¶ä¹Ÿå°è¯•è¿‡é€šè¿‡ REST API è§¦å‘ CICD Pipeline çš„æ‰§è¡Œæ‹‰å–é•œåƒå¹¶ tagï¼Œä½†æ˜¯æç‹Gitlab æ˜¯éƒ¨ç½²åœ¨æŸäº‘çš„ç¯å¢ƒä¸Šï¼ŒåŒæ ·ä¹Ÿå—å›°äºç½‘ç»œé—®é¢˜ã€‚&lt;/p></description></item><item><title>ARM64 å¹³å°åŸºäº openEuler + iSula ç¯å¢ƒéƒ¨ç½² Kubernetes</title><link>https://atbug.com/setup-kubernetes-running-with-isulad-on-openeuler/</link><pubDate>Thu, 02 Sep 2021 20:41:06 +0800</pubDate><guid>https://atbug.com/setup-kubernetes-running-with-isulad-on-openeuler/</guid><description>
&lt;p>ä¸ºä»€ä¹ˆè¦åœ¨ arm64 å¹³å°ä¸Šéƒ¨ç½² Kubernetesï¼Œè€Œä¸”è¿˜æ˜¯é²²é¹ 920 çš„æ¶æ„ã€‚è¯´æ¥è¯é•¿ ã€‚ã€‚ã€‚ æ­¤å¤„çœç•¥5000 å­—ã€‚&lt;/p>
&lt;p>ä»‹ç»ä¸‹ç³»ç»Ÿä¿¡æ¯ï¼›&lt;/p>
&lt;ul>
&lt;li>æ¶æ„ï¼šé²²é¹ 920(Kunpeng920)&lt;/li>
&lt;li>OSï¼šopenEuler 20.03 (LTS-SP1)&lt;/li>
&lt;li>CPUï¼š4c&lt;/li>
&lt;li>å†…å­˜ï¼š16G&lt;/li>
&lt;li>ç¡¬ç›˜ï¼šè‹¥å¹²&lt;/li>
&lt;/ul>
&lt;p>æ•´ä¸ªè¿‡ç¨‹è™½ç„¶å‚è€ƒäº†&lt;a href="https://bbs.huaweicloud.com/forum/thread-94271-1-1.html">é²²é¹è®ºå›çš„å¸–å­&lt;/a>ï¼Œä¸è¿‡è¿˜æ˜¯é¢‡è´¹å‘¨æŠ˜ã€‚&lt;/p>
&lt;h3 id="tldr">TL;DR&lt;/h3>
&lt;p>æ•´ä¸ªè¿‡ç¨‹ä¸­è¦æ³¨æ„ arm64 å¹³å°ä¸Šå®‰è£… Kubernetes åŠç½‘ç»œç»„ä»¶ï¼Œéœ€è¦ä½¿ç”¨ arm64 ç‰ˆæœ¬çš„é•œåƒã€‚&lt;/p>
&lt;h3 id="ç¯å¢ƒé…ç½®">ç¯å¢ƒé…ç½®&lt;/h3>
&lt;h4 id="1å…³é—­-selinux">1.å…³é—­ selinux&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#ä¸´æ—¶å…³é—­&lt;/span>
setenforce &lt;span class="m">0&lt;/span>
&lt;span class="c1">#æ°¸ä¹…å…³é—­ SELINUX=disabled&lt;/span>
vim /etc/sysconfig/selinux
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="2-å…³é—­swapåˆ†åŒº">2. å…³é—­swapåˆ†åŒº&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#ä¸´æ—¶å…³é—­&lt;/span>
swapoff -a
&lt;span class="c1">#æ°¸ä¹…å…³é—­ æ³¨é‡Š swap è¡Œ&lt;/span>
vim /etc/fstab
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-å…³é—­é˜²ç«å¢™">3. å…³é—­é˜²ç«å¢™&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">systemctl stop firewalld
ssystemctl disable firewalld
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="4-ç½‘ç»œé…ç½®">4. ç½‘ç»œé…ç½®&lt;/h4>
&lt;p>å¯¹iptableså†…éƒ¨çš„nf-calléœ€è¦æ‰“å¼€çš„å†…ç”Ÿçš„æ¡¥æ¥åŠŸèƒ½&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">vim /etc/sysctl.d/k8s.conf
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹å¦‚ä¸‹å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
net.ipv4.ip_forward=1
vm_swappiness=0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹å®Œæˆåæ‰§è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">modprobe br_netfilter
sysctl -p /etc/sysctl.d/k8s.conf
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="5-æ·»åŠ -kubernetes-æº">5. æ·»åŠ  Kubernetes æº&lt;/h4>
&lt;p>åœ¨æ–‡ä»¶ &lt;code>/etc/yum.repos.d/openEuler.repo&lt;/code> ä¸­è¿½åŠ å¦‚ä¸‹å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-aarch64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…é…ç½®-isula">å®‰è£…é…ç½® iSula&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">yum install -y iSulad
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹ iSula é…ç½®ï¼Œæ‰“å¼€æ–‡ä»¶ &lt;code>/etc/isulad/daemon.json&lt;/code>ï¼ŒæŒ‰ç…§ä¸‹é¢çš„éƒ¨åˆ†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;registry-mirrors&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="s2">&amp;#34;docker.io&amp;#34;&lt;/span>
&lt;span class="p">],&lt;/span>
&lt;span class="nt">&amp;#34;insecure-registries&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="s2">&amp;#34;rnd-dockerhub.huawei.com&amp;#34;&lt;/span>
&lt;span class="p">],&lt;/span>
&lt;span class="nt">&amp;#34;pod-sandbox-image&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;k8s.gcr.io/pause:3.2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="err">//&lt;/span> &lt;span class="err">æŒ‰ç…§å¯¹åº”&lt;/span> &lt;span class="err">Kubernetes&lt;/span> &lt;span class="err">ç‰ˆæœ¬è¿›è¡Œä¿®æ”¹ï¼Œåé¢ä¼šæœ‰è¯´æ˜&lt;/span>
&lt;span class="nt">&amp;#34;network-plugin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;cni&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;cni-bin-dir&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;cni-conf-dir&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;hosts&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="s2">&amp;#34;unix:///var/run/isulad.sock&amp;#34;&lt;/span>
&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹ä¹‹åé‡å¯ isulad&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">systemctl restart isulad
systemctl &lt;span class="nb">enable&lt;/span> isulad
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="kubernetes-éƒ¨ç½²">Kubernetes éƒ¨ç½²&lt;/h3>
&lt;h4 id="1-å®‰è£…-kubeletkubeadmkubectl">1. å®‰è£… kubeletã€kubeadmã€kubectl&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">yum install -y kubelet-1.20.0 kubeadm-1.20.0 kubectl-1.20.0
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="2-å‡†å¤‡é•œåƒ">2. å‡†å¤‡é•œåƒ&lt;/h4>
&lt;p>ç”±äºæŸç§æœªçŸ¥çš„ç½‘ç»œé—®æï¼Œä¼šå¯¼è‡´æ‹‰å– &lt;code>k8s.gcr.io&lt;/code> çš„é•œåƒå¤±è´¥ã€‚éœ€è¦æå‰ä¸‹è½½å¥½ã€‚&lt;/p>
&lt;p>é€šè¿‡ &lt;code>kubeadm config images list --kubernetes-version 1.20.0&lt;/code> å‘½ä»¤ï¼Œè·å–åˆå§‹åŒ–æ‰€éœ€çš„é•œåƒã€‚è¿™é‡Œéœ€è¦æ³¨æ„é€šè¿‡ &lt;code>--kubernetes-version&lt;/code> å‚æ•°æŒ‡å®šç‰ˆæœ¬å·ï¼Œå¦åˆ™ &lt;code>kubeadm&lt;/code> æ˜¯æ‰“å°å‡ºæœ€é«˜çš„ &lt;code>1.20.x&lt;/code> ç‰ˆæœ¬çš„åˆå§‹åŒ–é•œåƒï¼ˆæ¯”å¦‚ï¼Œ1.20.x çš„æœ€é«˜ç‰ˆæœ¬æ˜¯ 1.20.4ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">k8s.gcr.io/kube-apiserver:v1.20.0
k8s.gcr.io/kube-controller-manager:v1.20.0
k8s.gcr.io/kube-scheduler:v1.20.0
k8s.gcr.io/kube-proxy:v1.20.0
k8s.gcr.io/pause:3.2
k8s.gcr.io/etcd:3.4.13-0
k8s.gcr.io/coredns:1.7.
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹åº”çš„ arm64 ç‰ˆæœ¬é•œåƒä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">k8s.gcr.io/kube-apiserver-arm64:v1.20.0
k8s.gcr.io/kube-controller-manager-arm64:v1.20.0
k8s.gcr.io/kube-scheduler-arm64:v1.20.0
k8s.gcr.io/kube-proxy-arm64:v1.20.0
k8s.gcr.io/pause-arm64:3.2
k8s.gcr.io/etcd-arm64:3.4.2-0 #æ”¯æŒ arm64 çš„ 3.4.x çš„æœ€é«˜ç‰ˆæœ¬
k8s.gcr.io/coredns:1.7.0 #æ— éœ€ç‰¹åˆ«çš„ arm64 ç‰ˆæœ¬
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‡­â€œè¿æ°”â€ä¸‹è½½å¥½é•œåƒåï¼Œå†é€šè¿‡ &lt;code>isula tag&lt;/code> å‘½ä»¤ä¿®æ”¹æˆæˆ‘ä»¬éœ€è¦çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">isula tag k8s.gcr.io/kube-apiserver-arm64:v1.20.0 k8s.gcr.io/kube-apiserver:v1.20.0
isula tag k8s.gcr.io/kube-controller-manager-arm64:v1.20.0 k8s.gcr.io/kube-controller-manager:v1.20.0
isula tag k8s.gcr.io/kube-scheduler-arm64:v1.20.0 k8s.gcr.io/kube-scheduler:v1.20.0
isula tag k8s.gcr.io/kube-proxy-arm64:v1.20.0 k8s.gcr.io/kube-proxy:v1.20.0
isula tag k8s.gcr.io/pause-arm64:3.2 k8s.gcr.io/pause:3.2
isula tag k8s.gcr.io/etcd-arm64:3.4.2-0 k8s.gcr.io/etcd:3.4.13-0
isula tag k8s.gcr.io/coredns:1.7.0 k8s.gcr.io/coredns:1.7.0
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-åˆå§‹åŒ–-master-èŠ‚ç‚¹">3. åˆå§‹åŒ– master èŠ‚ç‚¹&lt;/h4>
&lt;p>æ³¨æ„éœ€è¦æŒ‡å®š &lt;code>--cri-socket&lt;/code> å‚æ•°ä½¿ç”¨ &lt;code>isulad&lt;/code> çš„ APIã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubeadm init --kubernetes-version v1.20.0 --cri-socket&lt;span class="o">=&lt;/span>/var/run/isulad.sock --pod-network-cidr&lt;span class="o">=&lt;/span>10.244.0.0/16
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®‰è£…æˆåŠŸçš„è¯ï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹çš„å†…å®¹&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">Your Kubernetes control-plane has initialized successfully!
To start using your cluster, you need to run the following as a regular user:
mkdir -p &lt;span class="nv">$HOME&lt;/span>/.kube
sudo cp -i /etc/kubernetes/admin.conf &lt;span class="nv">$HOME&lt;/span>/.kube/config
sudo chown &lt;span class="k">$(&lt;/span>id -u&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>id -g&lt;span class="k">)&lt;/span> &lt;span class="nv">$HOME&lt;/span>/.kube/config
Alternatively, &lt;span class="k">if&lt;/span> you are the root user, you can run:
&lt;span class="nb">export&lt;/span> &lt;span class="nv">KUBECONFIG&lt;/span>&lt;span class="o">=&lt;/span>/etc/kubernetes/admin.conf
You should now deploy a pod network to the cluster.
Run &lt;span class="s2">&amp;#34;kubectl apply -f [podnetwork].yaml&amp;#34;&lt;/span> with one of the options listed at:
https://kubernetes.io/docs/concepts/cluster-administration/addons/
Then you can join any number of worker nodes by running the following on each as root:
kubeadm join 12.0.0.9:6443 --token 0110xl.lqzlegbduz2qkdhr &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --discovery-token-ca-cert-hash sha256:42b13f5924a01128aac0d6e7b2487af990bc82701f233c8a6a4790187ea064af
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="4-é…ç½®é›†ç¾¤ç¯å¢ƒ">4. é…ç½®é›†ç¾¤ç¯å¢ƒ&lt;/h4>
&lt;p>ç„¶åæ ¹æ®ä¸Šé¢çš„è¾“å‡ºè¿›è¡Œé…ç½®&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">mkdir -p &lt;span class="nv">$HOME&lt;/span>/.kube
sudo cp -i /etc/kubernetes/admin.conf &lt;span class="nv">$HOME&lt;/span>/.kube/config
sudo chown &lt;span class="k">$(&lt;/span>id -u&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>id -g&lt;span class="k">)&lt;/span> &lt;span class="nv">$HOME&lt;/span>/.kube/config
&lt;span class="nb">export&lt;/span> &lt;span class="nv">KUBECONFIG&lt;/span>&lt;span class="o">=&lt;/span>/etc/kubernetes/admin.conf
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="5-å‘é›†ç¾¤æ·»åŠ -node-èŠ‚ç‚¹">5. å‘é›†ç¾¤æ·»åŠ  Node èŠ‚ç‚¹&lt;/h4>
&lt;p>é‡å¤å‰é¢çš„æ­¥éª¤ï¼š&lt;code>ç¯å¢ƒé…ç½®&lt;/code>ã€&lt;code>å®‰è£…é…ç½® iSula&lt;/code> ä»¥åŠ &lt;code>Kubernetes éƒ¨ç½²&lt;/code> çš„ 1 å’Œ 2ã€‚&lt;/p>
&lt;p>åŒæ ·ä½¿ç”¨ä¸Šé¢è¾“å‡ºçš„å‘½ä»¤ï¼Œå†åŠ ä¸Š &lt;code>--cri-socket&lt;/code> å‚æ•°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubeadm join 12.0.0.9:6443 --token 0110xl.lqzlegbduz2qkdhr &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --discovery-token-ca-cert-hash &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --cri-socket&lt;span class="o">=&lt;/span>/var/run/isulad.sock
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="é…ç½®ç½‘ç»œæ’ä»¶">é…ç½®ç½‘ç»œæ’ä»¶&lt;/h3>
&lt;p>å®Œæˆ master èŠ‚ç‚¹åˆå§‹åŒ–å¹¶é…ç½®å®Œé›†ç¾¤ç¯å¢ƒåå°±å¯ä»¥æ‰§è¡Œ &lt;code>kubectl&lt;/code> çš„å‘½ä»¤äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get nodes
NAME STATUS ROLES AGE VERSION
host-12-0-0-9 NotReady control-plane,master 178m v1.20.0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹ä¸‹èŠ‚ç‚¹ï¼Œå‘ç°èŠ‚ç‚¹æ˜¯ &lt;code>NotReady&lt;/code> çš„çŠ¶æ€ï¼Œè¿™æ˜¯å› ä¸ºç½‘ç»œæ’ä»¶è¿˜æ²¡å®‰è£…ã€‚å¦‚æœæ­¤æ—¶é€šè¿‡å‘½ä»¤ &lt;code>journalctl -uf kubelet&lt;/code> æŸ¥çœ‹ &lt;code>kubelet&lt;/code> çš„æ—¥å¿—ï¼Œä¼šçœ‹åˆ°æ—¥å¿—æç¤ºç½‘ç»œæ’ä»¶æ²¡æœ‰ readyã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubelet.go:2160] Container runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:iSulad: network plugin is not ready: cni config uninitialized
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿˜è®°å¾— isulad çš„é…ç½®ä¹ˆï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">&amp;#34;network-plugin&amp;#34;: &amp;#34;cni&amp;#34;,
&amp;#34;cni-bin-dir&amp;#34;: &amp;#34;&amp;#34;, //ä½¿ç”¨é»˜è®¤ /opt/cni/bin
&amp;#34;cni-conf-dir&amp;#34;: &amp;#34;&amp;#34;, //ä½¿ç”¨é»˜è®¤ /etc/cni/net.d
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®é™…ä¸Šä¸¤ä¸ªç›®å½•éƒ½æ˜¯ç©ºçš„å†…å®¹ï¼Œå¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">mkdir -p /opt/cni/bin
mkdir -p /etc/cni/net.d
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œä½¿ç”¨ &lt;code>calico&lt;/code> åšä¸ºç½‘ç»œæ’ä»¶ï¼Œå…ˆä¸‹è½½ manifestã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">wget https://docs.projectcalico.org/v3.14/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å› ä¸ºæ˜¯ arm64 çš„ç¡¬ä»¶ï¼ŒåŒæ ·éœ€è¦ä½¿ç”¨å¯¹åº” arm64 ç‰ˆæœ¬çš„é•œåƒï¼Œå…ˆæŸ¥çœ‹è¦ç”¨å“ªäº›é•œåƒï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">grep &lt;span class="s1">&amp;#39;image:&amp;#39;&lt;/span> calico.yaml &lt;span class="p">|&lt;/span> uniq
image: calico/cni:v3.14.2
image: calico/pod2daemon-flexvol:v3.14.2
image: calico/node:v3.14.2
image: calico/kube-controllers:v3.14.2
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹åº”çš„ arm64 ç‰ˆæœ¬ï¼Œæ“ä½œæ­¥éª¤å‚è€ƒä¸Šé¢ï¼Œä¸å†èµ˜è¿°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">calico/cni:v3.14.2-arm64
calico/pod2daemon-flexvol:v3.14.2-arm64
calico/node:v3.14.2-arm64
calico/kube-controllers:v3.14.2-arm64
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æå®šé•œåƒä¹‹åæ‰§è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f calico.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹‹åå°±å¯ä»¥çœ‹åˆ°èŠ‚ç‚¹å˜æˆäº† &lt;code>Ready&lt;/code> çŠ¶æ€ã€‚&lt;/p>
&lt;h3 id="æµ‹è¯•">æµ‹è¯•&lt;/h3>
&lt;p>é€šå¸¸éƒ½æ˜¯ç”¨ nginx çš„é•œåƒåˆ›å»º pod è¿›è¡Œæµ‹è¯•ï¼Œä½†æ˜¯ nginx å¹¶æ²¡æœ‰ arm64 çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œå°±ç”¨ docker å®˜æ–¹æä¾›çš„ &lt;code>hello-world&lt;/code> é•œåƒã€‚æ²¡é”™ï¼Œæ”¯æŒ arm64ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl run hello-world --image hello-world:latest --restart&lt;span class="o">=&lt;/span>Never
kubectl logs hello-world --previous
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">Hello from Docker!
This message shows that your installation appears to be working correctly.
To generate this message, Docker took the following steps:
1. The Docker client contacted the Docker daemon.
2. The Docker daemon pulled the &amp;#34;hello-world&amp;#34; image from the Docker Hub.
(arm64v8)
3. The Docker daemon created a new container from that image which runs the
executable that produces the output you are currently reading.
4. The Docker daemon streamed that output to the Docker client, which sent it
to your terminal.
To try something more ambitious, you can run an Ubuntu container with:
$ docker run -it ubuntu bash
Share images, automate workflows, and more with a free Docker ID:
https://hub.docker.com/
For more examples and ideas, visit:
https://docs.docker.com/get-started/
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†åœ¨é²²é¹å¹³å°ä¸ŠåŸºäº openEuler + iSula éƒ¨ç½² Kubernetes çš„å·¥ä½œã€‚&lt;/p></description></item><item><title>Kubernetes å¿…å¤‡å·¥å…·ï¼š2021</title><link>https://atbug.com/translation-kuberletes-essential-tools-2021/</link><pubDate>Thu, 15 Jul 2021 08:10:22 +0800</pubDate><guid>https://atbug.com/translation-kuberletes-essential-tools-2021/</guid><description>
&lt;p>æœ‰åˆ«äºå‰äº›å¤©çš„æ–‡ç«  - &lt;a href="https://mp.weixin.qq.com/s/uU2zmT5yyVcKZ5XmLSRqtg">å¸¸ç”¨çš„å‡ æ¬¾å·¥å…·è®© Kubernetes é›†ç¾¤ä¸Šçš„å·¥ä½œæ›´å®¹æ˜“&lt;/a> åé‡äºå·¥å…·ç±»æ¥æå‡å·¥ä½œæ•ˆç‡ï¼Œä»Šå¤©è¿™ç¯‡æ–‡ç« æ›´åŠ é€‚åˆç”¨æ¥åšé€‰å‹æ—¶çš„å‚è€ƒã€‚&lt;/p>
&lt;p>æ–‡æ¡£ç¿»è¯‘è‡ª &lt;a href="https://itnext.io/kubernetes-essential-tools-2021-def12e84c572">Kubernetes Essential Tools: 2021&lt;/a>ï¼Œç¯‡å¹…è¾ƒé•¿ï¼Œåšäº†éƒ¨åˆ†å¢åˆ ã€‚&lt;/p>
&lt;hr>
&lt;h2 id="ä»‹ç»">ä»‹ç»&lt;/h2>
&lt;p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å°è¯•æ€»ç»“æˆ‘æœ€å–œæ¬¢çš„ &lt;a href="https://kubernetes.io/">Kubernetes&lt;/a> å·¥å…·ï¼Œå¹¶ç‰¹åˆ«å¼ºè°ƒæœ€æ–°çš„å’Œé²œä¸ºäººçŸ¥ä½†æˆ‘è®¤ä¸ºä¼šéå¸¸æµè¡Œçš„å·¥å…·ã€‚&lt;/p>
&lt;p>è¿™åªæ˜¯æˆ‘æ ¹æ®æˆ‘çš„ç»éªŒå¾—å‡ºçš„ä¸ªäººæ¸…å•ï¼Œä½†ä¸ºäº†é¿å…åè§ï¼Œæˆ‘è¿˜å°†å°è¯•æåŠæ¯ç§å·¥å…·çš„æ›¿ä»£æ–¹æ¡ˆï¼Œä»¥ä¾¿ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è¿›è¡Œæ¯”è¾ƒå’Œå†³å®šã€‚æˆ‘å°†å°½å¯èƒ½ç¼©çŸ­è¿™ç¯‡æ–‡ç« å¹¶æä¾›é“¾æ¥ï¼Œä»¥ä¾¿ä½ å¯ä»¥è‡ªè¡Œæ¢ç´¢æ›´å¤šå†…å®¹ã€‚æˆ‘çš„ç›®æ ‡æ˜¯å›ç­”è¿™ä¸ªé—®é¢˜ï¼šâ€œæˆ‘å¦‚ä½•åœ¨ Kubernetes ä¸­åš Xï¼Ÿâ€ é€šè¿‡æè¿°ä¸åŒè½¯ä»¶å¼€å‘ä»»åŠ¡çš„å·¥å…·ã€‚&lt;/p>
&lt;h2 id="k3d">K3D&lt;/h2>
&lt;p>&lt;a href="https://k3d.io/">K3D&lt;/a> æ˜¯æˆ‘æœ€å–œæ¬¢çš„åœ¨ç¬”è®°æœ¬ç”µè„‘ä¸Šè¿è¡Œ Kubernetes (K8s) é›†ç¾¤çš„æ–¹å¼ã€‚å®ƒéå¸¸&lt;strong>è½»å·§ä¸”&lt;/strong>é€Ÿåº¦éå¸¸å¿«ã€‚å®ƒæ˜¯ä½¿ç”¨ &lt;strong>Docker&lt;/strong> å›´ç»• &lt;a href="https://k3s.io/">K3S&lt;/a> çš„åŒ…è£…å™¨ã€‚æ‰€ä»¥ï¼Œä½ åªéœ€è¦ Docker æ¥è¿è¡Œå®ƒå¹¶ä¸”èµ„æºä½¿ç”¨ç‡éå¸¸ä½ã€‚å”¯ä¸€çš„é—®é¢˜æ˜¯&lt;strong>å®ƒä¸å®Œå…¨ç¬¦åˆ K8s æ ‡å‡†&lt;/strong>ï¼Œä½†è¿™ä¸åº”è¯¥æ˜¯æœ¬åœ°å¼€å‘çš„é—®é¢˜ã€‚å¯¹äºæµ‹è¯•ç¯å¢ƒï¼Œä½ å¯ä»¥ä½¿ç”¨å…¶ä»–è§£å†³æ–¹æ¡ˆã€‚K3D æ¯” Kind å¿«ï¼Œä½† Kind å®Œå…¨å…¼å®¹ã€‚&lt;/p>
&lt;h3 id="å¤‡é€‰">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://k3s.io/">&lt;strong>K3S&lt;/strong>&lt;/a>Â ç‰©è”ç½‘æˆ–è€…è¾¹ç¼˜è®¡ç®—&lt;/li>
&lt;li>&lt;a href="https://kind.sigs.k8s.io/">&lt;strong>Kind&lt;/strong>&lt;/a> å®Œå…¨å…¼å®¹ Kubernetes çš„å¤‡é€‰&lt;/li>
&lt;li>&lt;a href="https://microk8s.io/">&lt;strong>MicroK8s&lt;/strong>&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://minikube.sigs.k8s.io/docs/">&lt;strong>MiniKube&lt;/strong>&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="krew">Krew&lt;/h2>
&lt;p>&lt;a href="https://krew.sigs.k8s.io/">Krew&lt;/a> æ˜¯ç®¡ç†çš„å¿…å¤‡å·¥å…· &lt;strong>Kubectl æ’ä»¶&lt;/strong>ï¼Œè¿™æ˜¯ä¸€ä¸ªå¿…é¡»æœ‰ä»»ä½• K8S ç”¨æˆ·ã€‚æˆ‘ä¸ä¼šè¯¦ç»†ä»‹ç»è¶…è¿‡ 145 ä¸ªå¯ç”¨&lt;a href="https://krew.sigs.k8s.io/plugins/">æ’ä»¶&lt;/a>ï¼Œä½†è‡³å°‘å®‰è£… &lt;a href="https://github.com/ahmetb/kubectx">&lt;strong>kubens&lt;/strong>&lt;/a> å’Œ &lt;a href="https://github.com/ahmetb/kubectx">&lt;strong>kubectx&lt;/strong>&lt;/a>ã€‚&lt;/p>
&lt;h2 id="lens">Lens&lt;/h2>
&lt;p>&lt;a href="https://k8slens.dev/">Lens&lt;/a> æ˜¯é€‚ç”¨äº SREã€Ops å’Œå¼€å‘äººå‘˜çš„ K8s &lt;strong>IDE&lt;/strong>ã€‚å®ƒé€‚ç”¨äºä»»ä½• Kubernetes å‘è¡Œç‰ˆï¼šæœ¬åœ°æˆ–äº‘ç«¯ã€‚å®ƒå¿«é€Ÿã€æ˜“äºä½¿ç”¨å¹¶æä¾›å®æ—¶å¯è§‚å¯Ÿæ€§ã€‚ä½¿ç”¨ Lens å¯ä»¥éå¸¸è½»æ¾åœ°ç®¡ç†å¤šä¸ªé›†ç¾¤ã€‚å¦‚æœä½ æ˜¯é›†ç¾¤æ“ä½œå‘˜ï¼Œè¿™æ˜¯å¿…é¡»çš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/15/16263041512885.jpg" alt="">&lt;/p>
&lt;h3 id="å¤‡é€‰-1">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>å¯¹äºé‚£äº›å–œæ¬¢è½»é‡çº§ç»ˆç«¯æ›¿ä»£å“çš„äººæ¥è¯´ï¼Œ&lt;a href="https://k9scli.io/">K9s&lt;/a> æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚K9s ä¼šæŒç»­è§‚å¯Ÿ Kubernetes çš„å˜åŒ–ï¼Œå¹¶æä¾›åç»­å‘½ä»¤æ¥ä¸ä½ è§‚å¯Ÿåˆ°çš„èµ„æºè¿›è¡Œäº¤äº’ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="helm">Helm&lt;/h2>
&lt;p>&lt;a href="https://helm.sh/">Helm&lt;/a> ä¸éœ€è¦ä»‹ç»ï¼Œå®ƒæ˜¯ Kubernetes æœ€è‘—åçš„åŒ…ç®¡ç†å™¨ã€‚ä½ åº”è¯¥åœ¨ K8s ä¸­ä½¿ç”¨åŒ…ç®¡ç†å™¨ï¼Œå°±åƒåœ¨ç¼–ç¨‹è¯­è¨€ä¸­ä½¿ç”¨å®ƒä¸€æ ·ã€‚Helm å…è®¸ä½ å°†åº”ç”¨ç¨‹åºæ‰“åŒ…åˆ° &lt;a href="https://artifacthub.io/">Charts&lt;/a> ä¸­ï¼Œå°†å¤æ‚çš„åº”ç”¨ç¨‹åºæŠ½è±¡ä¸ºæ˜“äºå®šä¹‰ã€å®‰è£…å’Œæ›´æ–°çš„å¯é‡ç”¨ç®€å•ç»„ä»¶ã€‚&lt;/p>
&lt;p>å®ƒè¿˜æä¾›äº†å¼ºå¤§çš„æ¨¡æ¿å¼•æ“ã€‚Helm å¾ˆæˆç†Ÿï¼Œæœ‰å¾ˆå¤šé¢„å®šä¹‰çš„ chartsï¼Œå¾ˆå¥½çš„æ”¯æŒï¼Œè€Œä¸”å¾ˆå®¹æ˜“ä½¿ç”¨ã€‚&lt;/p>
&lt;h3 id="å¤‡é€‰-2">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://kustomize.io/">&lt;strong>Kustomize&lt;/strong>&lt;/a> æ˜¯ helm çš„ä¸€ä¸ªæ›´æ–°å’Œä¼Ÿå¤§çš„æ›¿ä»£å“ï¼Œå®ƒä¸ä½¿ç”¨æ¨¡æ¿å¼•æ“ï¼Œè€Œæ˜¯ä¸€ä¸ªè¦†ç›–å¼•æ“ï¼Œåœ¨å…¶ä¸­ä½ æœ‰åŸºæœ¬çš„å®šä¹‰å’Œè¦†ç›–åœ¨å®ƒä»¬ä¹‹ä¸Šã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="argocd">ArgoCD&lt;/h2>
&lt;p>æˆ‘ç›¸ä¿¡ &lt;a href="https://www.gitops.tech/">GitOps&lt;/a> æ˜¯è¿‡å»åå¹´ä¸­æœ€å¥½çš„æƒ³æ³•ä¹‹ä¸€ã€‚åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨å•ä¸€çš„äº‹å®æ¥æºæ¥è·Ÿè¸ªæ„å»ºè½¯ä»¶æ‰€éœ€çš„æ‰€æœ‰ç§»åŠ¨éƒ¨åˆ†ï¼Œè€Œ &lt;strong>Git&lt;/strong> æ˜¯åšåˆ°è¿™ä¸€ç‚¹çš„å®Œç¾å·¥å…·ã€‚æˆ‘ä»¬çš„æƒ³æ³•æ˜¯æ‹¥æœ‰ä¸€ä¸ª Git å­˜å‚¨åº“ï¼Œå…¶ä¸­åŒ…å«åº”ç”¨ç¨‹åºä»£ç ä»¥åŠè¡¨ç¤ºæ‰€éœ€ç”Ÿäº§ç¯å¢ƒçŠ¶æ€çš„åŸºç¡€è®¾æ–½ (&lt;a href="https://en.wikipedia.org/wiki/Infrastructure_as_Code">IaC&lt;/a>) çš„å£°æ˜æ€§æè¿°ï¼›ä»¥åŠä½¿æ‰€éœ€ç¯å¢ƒä¸å­˜å‚¨åº“ä¸­æè¿°çš„çŠ¶æ€ç›¸åŒ¹é…çš„è‡ªåŠ¨åŒ–è¿‡ç¨‹ã€‚&lt;/p>
&lt;blockquote>
&lt;p>GitOps: versioned CI/CD on top of declarative infrastructure. Stop scripting and start shipping.&lt;/p>
&lt;p>â€” Kelsey Hightower&lt;/p>
&lt;/blockquote>
&lt;p>å°½ç®¡ä½¿ç”¨ &lt;a href="https://www.terraform.io/">Terraform&lt;/a> æˆ–ç±»ä¼¼å·¥å…·ï¼Œä½ å¯ä»¥å®ç°åŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆ&lt;a href="https://en.wikipedia.org/wiki/Infrastructure_as_code">IaC&lt;/a>ï¼‰ï¼Œä½†è¿™è¿˜ä¸è¶³ä»¥å°†ä½ åœ¨ Git ä¸­çš„æ‰€éœ€çŠ¶æ€ä¸ç”Ÿäº§åŒæ­¥ã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥æŒç»­ç›‘æ§ç¯å¢ƒå¹¶ç¡®ä¿æ²¡æœ‰é…ç½®æ¼‚ç§»ã€‚ä½¿ç”¨ Terraformï¼Œä½ å°†ä¸å¾—ä¸ç¼–å†™è„šæœ¬æ¥è¿è¡Œ&lt;code>terraform apply&lt;/code>å¹¶æ£€æŸ¥çŠ¶æ€æ˜¯å¦ä¸ Terraform çŠ¶æ€åŒ¹é…ï¼Œä½†è¿™æ—¢ä¹å‘³åˆéš¾ä»¥ç»´æŠ¤ã€‚&lt;/p>
&lt;p>Kubernetes ä»å¤´å¼€å§‹â€‹â€‹æ„å»ºæ§åˆ¶å¾ªç¯çš„æ€æƒ³ï¼Œè¿™æ„å‘³ç€ Kubernetes ä¸€ç›´åœ¨ç›‘è§†é›†ç¾¤çš„çŠ¶æ€ä»¥ç¡®ä¿å®ƒä¸æ‰€éœ€çš„çŠ¶æ€åŒ¹é…ï¼Œä¾‹å¦‚ï¼Œè¿è¡Œçš„å‰¯æœ¬æ•°é‡ä¸æ‰€éœ€çš„æ•°é‡ç›¸åŒ¹é…å¤åˆ¶å“ã€‚GitOps çš„æƒ³æ³•æ˜¯å°†å…¶æ‰©å±•åˆ°åº”ç”¨ç¨‹åºï¼Œå› æ­¤ä½ å¯ä»¥å°†ä½ çš„æœåŠ¡å®šä¹‰ä¸ºä»£ç ï¼Œä¾‹å¦‚ï¼Œé€šè¿‡å®šä¹‰ Helm Chartsï¼Œå¹¶ä½¿ç”¨åˆ©ç”¨ K8s åŠŸèƒ½çš„å·¥å…·æ¥ç›‘æ§ä½ çš„åº”ç”¨ç¨‹åºçš„çŠ¶æ€å¹¶ç›¸åº”åœ°è°ƒæ•´é›†ç¾¤ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ›´æ–°ä½ çš„ä»£ç å­˜å‚¨åº“æˆ–Helm Chartï¼Œç”Ÿäº§é›†ç¾¤ä¹Ÿä¼šæ›´æ–°ã€‚è¿™æ˜¯çœŸæ­£çš„&lt;a href="https://en.wikipedia.org/wiki/Continuous_deployment">æŒç»­éƒ¨ç½²&lt;/a>ã€‚æ ¸å¿ƒåŸåˆ™æ˜¯åº”ç”¨ç¨‹åºéƒ¨ç½²å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†åº”è¯¥è‡ªåŠ¨åŒ–ã€å¯å®¡è®¡ä¸”æ˜“äºç†è§£ã€‚&lt;/p>
&lt;p>å¯¹æˆ‘æ¥è¯´ï¼Œè¿™ä¸ªæƒ³æ³•æ˜¯é©å‘½æ€§çš„ï¼Œå¦‚æœåšå¾—å¥½ï¼Œå°†ä½¿ç»„ç»‡èƒ½å¤Ÿæ›´å¤šåœ°å…³æ³¨åŠŸèƒ½ï¼Œè€Œä¸æ˜¯ç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬ã€‚è¿™ä¸ªæ¦‚å¿µå¯ä»¥æ‰©å±•åˆ°è½¯ä»¶å¼€å‘çš„å…¶ä»–é¢†åŸŸï¼Œä¾‹å¦‚ï¼Œä½ å¯ä»¥å°†æ–‡æ¡£å­˜å‚¨åœ¨ä»£ç ä¸­ä»¥è·Ÿè¸ªæ›´æ”¹çš„å†å²å¹¶ç¡®ä¿æ–‡æ¡£æ˜¯æœ€æ–°çš„ï¼›æˆ–ä½¿ç”¨&lt;a href="https://github.com/jamesmh/architecture_decision_record">ADR&lt;/a>è·Ÿè¸ªæ¶æ„å†³ç­–ã€‚&lt;/p>
&lt;p>åœ¨æˆ‘çœ‹æ¥ï¼Œåœ¨æœ€å¥½çš„ GitOps å·¥å…· &lt;strong>Kubernetes&lt;/strong> æ˜¯ &lt;a href="https://argoproj.github.io/argo-cd/">ArgoCD&lt;/a>ã€‚ä½ å¯ä»¥åœ¨&lt;a href="https://argoproj.github.io/argo-cd/core_concepts/">æ­¤å¤„&lt;/a>é˜…è¯»æ›´å¤šä¿¡æ¯ã€‚ArgoCD æ˜¯ &lt;strong>Argo&lt;/strong> ç”Ÿæ€ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€äº›å…¶ä»–å¾ˆæ£’çš„å·¥å…·ï¼Œå…¶ä¸­ä¸€äº›æˆ‘ä»¬å°†åœ¨ç¨åè®¨è®ºã€‚&lt;/p>
&lt;p>ä½¿ç”¨ &lt;strong>ArgoCD&lt;/strong>ï¼Œä½ å¯ä»¥åœ¨ä»£ç å­˜å‚¨åº“ä¸­æ‹¥æœ‰æ¯ä¸ªç¯å¢ƒï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­å®šä¹‰è¯¥ç¯å¢ƒçš„æ‰€æœ‰é…ç½®ã€‚Argo CD åœ¨æŒ‡å®šçš„ç›®æ ‡ç¯å¢ƒä¸­è‡ªåŠ¨éƒ¨ç½²æ‰€éœ€çš„åº”ç”¨ç¨‹åºçŠ¶æ€ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/15/16263046811430.jpg" alt="">&lt;/p>
&lt;p>ArgoCD è¢«å®ç°ä¸ºä¸€ä¸ª kubernetes æ§åˆ¶å™¨ï¼Œå®ƒæŒç»­ç›‘æ§æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºå¹¶å°†å½“å‰çš„å®æ—¶çŠ¶æ€ä¸æ‰€éœ€çš„ç›®æ ‡çŠ¶æ€ï¼ˆå¦‚ Git å­˜å‚¨åº“ä¸­æŒ‡å®šçš„ï¼‰è¿›è¡Œæ¯”è¾ƒã€‚ArgoCD æŠ¥å‘Šå¹¶å¯è§†åŒ–å·®å¼‚ï¼Œå¹¶ä¸”å¯ä»¥è‡ªåŠ¨æˆ–æ‰‹åŠ¨å°†å®æ—¶çŠ¶æ€åŒæ­¥å›æ‰€éœ€çš„ç›®æ ‡çŠ¶æ€ã€‚&lt;/p>
&lt;h3 id="å¤‡é€‰-3">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://fluxcd.io/">Flux&lt;/a> åˆšåˆšå‘å¸ƒäº†ä¸€ä¸ªå…·æœ‰è®¸å¤šæ”¹è¿›çš„æ–°ç‰ˆæœ¬ã€‚å®ƒæä¾›äº†éå¸¸ç›¸ä¼¼çš„åŠŸèƒ½ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="argo-å·¥ä½œæµworkflowså’Œ-argo-äº‹ä»¶events">Argo å·¥ä½œæµï¼ˆWorkflowsï¼‰å’Œ Argo äº‹ä»¶ï¼ˆEventsï¼‰&lt;/h2>
&lt;p>åœ¨ Kubernetes ä¸­ï¼Œä½ å¯èƒ½è¿˜éœ€è¦è¿è¡Œæ‰¹å¤„ç†ä½œä¸šæˆ–å¤æ‚çš„å·¥ä½œæµã€‚è¿™å¯èƒ½æ˜¯ä½ çš„æ•°æ®ç®¡é“ã€å¼‚æ­¥æµç¨‹ç”šè‡³ CI/CD çš„ä¸€éƒ¨åˆ†ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œä½ ç”šè‡³å¯èƒ½éœ€è¦è¿è¡Œå¯¹æŸäº›äº‹ä»¶åšå‡ºååº”çš„é©±åŠ¨å¾®æœåŠ¡ï¼Œä¾‹å¦‚æ–‡ä»¶ä¸Šä¼ æˆ–æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—ã€‚å¯¹äºæ‰€æœ‰è¿™äº›ï¼Œæˆ‘ä»¬æœ‰ &lt;a href="https://argoproj.github.io/argo-workflows/">Argo Workflows&lt;/a> å’Œ &lt;a href="https://argoproj.github.io/argo-events/">Argo Events&lt;/a>ã€‚&lt;/p>
&lt;p>å°½ç®¡å®ƒä»¬æ˜¯ç‹¬ç«‹çš„é¡¹ç›®ï¼Œä½†å®ƒä»¬å¾€å¾€ä¼šè¢«éƒ¨ç½²åœ¨ä¸€èµ·ã€‚&lt;/p>
&lt;p>Argo Workflows æ˜¯ä¸€ä¸ªç±»ä¼¼äº &lt;a href="https://airflow.apache.org/">Apache Airflow&lt;/a> çš„ç¼–æ’å¼•æ“ï¼Œä½†å®ƒæ˜¯ Kubernetes åŸç”Ÿçš„ã€‚å®ƒä½¿ç”¨è‡ªå®šä¹‰ CRD æ¥å®šä¹‰å¤æ‚çš„å·¥ä½œæµç¨‹ï¼Œä½¿ç”¨ YAML çš„æ­¥éª¤æˆ– &lt;strong>DAG&lt;/strong>ï¼Œè¿™åœ¨ K8s ä¸­æ„Ÿè§‰æ›´è‡ªç„¶ã€‚å®ƒæœ‰ä¸€ä¸ªæ¼‚äº®çš„ UIã€é‡è¯•æœºåˆ¶ã€åŸºäº cron çš„ä½œä¸šã€è¾“å…¥å’Œè¾“å‡ºè·Ÿè¸ªç­‰ç­‰ã€‚ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥ç¼–æ’æ•°æ®ç®¡é“ã€æ‰¹å¤„ç†ä½œä¸šç­‰ç­‰ã€‚&lt;/p>
&lt;p>æœ‰æ—¶ï¼Œä½ å¯èƒ½å¸Œæœ›å°†ç®¡é“ä¸å¼‚æ­¥æœåŠ¡ï¼ˆå¦‚ &lt;strong>Kafka&lt;/strong> ç­‰æµå¼•æ“ã€é˜Ÿåˆ—ã€webhooks æˆ–æ·±åº¦å­˜å‚¨æœåŠ¡ï¼‰é›†æˆã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½æƒ³è¦å¯¹ä¸Šä¼ åˆ° S3 çš„æ–‡ä»¶ç­‰äº‹ä»¶åšå‡ºååº”ã€‚ä¸ºæ­¤ï¼Œä½ å°†ä½¿ç”¨ &lt;a href="https://argoproj.github.io/argo-events/">Argo äº‹ä»¶ï¼ˆEventï¼‰&lt;/a>ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/15/16263049343226.jpg" alt="">&lt;/p>
&lt;p>è¿™ä¸¤ä¸ªå·¥å…·ç»„åˆä¸ºä½ çš„æ‰€æœ‰ç®¡é“éœ€æ±‚æä¾›äº†ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ CI/CD ç®¡é“ï¼Œå®ƒå…è®¸ä½ åœ¨ Kubernetes ä¸­æœ¬åœ°è¿è¡Œ CI/CD ç®¡é“ã€‚&lt;/p>
&lt;h3 id="å¤‡é€‰-4">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>å¯¹äº ML ç®¡é“ï¼Œä½ å¯ä»¥ä½¿ç”¨ &lt;a href="https://www.kubeflow.org/">Kubeflow&lt;/a>ã€‚&lt;/li>
&lt;li>å¯¹äº CI/CD ç®¡é“ï¼Œä½ å¯ä»¥ä½¿ç”¨ &lt;a href="https://tekton.dev/docs/pipelines/pipelines/">Tekton&lt;/a>ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="kaniko">Kaniko&lt;/h2>
&lt;p>æˆ‘ä»¬åˆšåˆšçœ‹åˆ°äº†å¦‚ä½•ä½¿ç”¨ Argo Workflows è¿è¡Œ Kubernetes åŸç”Ÿ &lt;strong>CI/CD&lt;/strong> ç®¡é“ã€‚ä¸€ä¸ªå¸¸è§çš„ä»»åŠ¡æ˜¯æ„å»º &lt;strong>Docker é•œåƒ&lt;/strong>ï¼Œè¿™åœ¨ Kubernetes ä¸­é€šå¸¸æ˜¯ä¹å‘³çš„ï¼Œå› ä¸ºæ„å»ºè¿‡ç¨‹å®é™…ä¸Šæ˜¯åœ¨å®¹å™¨æœ¬èº«ä¸Šè¿è¡Œçš„ï¼Œä½ éœ€è¦ä½¿ç”¨å˜é€šæ–¹æ³•æ¥ä½¿ç”¨ä¸»æœºçš„ Docker å¼•æ“ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/15/16263050297533.jpg" alt="">&lt;/p>
&lt;p>åº•çº¿æ˜¯ä½ ä¸åº”è¯¥ä½¿ç”¨ &lt;strong>Docker&lt;/strong> æ¥æ„å»ºä½ çš„é•œåƒï¼šæ”¹ç”¨ &lt;a href="https://github.com/GoogleContainerTools/kaniko">&lt;strong>Kanico&lt;/strong>&lt;/a>ã€‚Kaniko ä¸ä¾èµ–äº Docker å®ˆæŠ¤è¿›ç¨‹ï¼Œè€Œæ˜¯å®Œå…¨åœ¨ç”¨æˆ·ç©ºé—´ä¸­æ‰§è¡Œ Dockerfile ä¸­çš„æ¯ä¸ªå‘½ä»¤ã€‚è¿™ä½¿å¾—åœ¨æ— æ³•è½»æ¾æˆ–å®‰å…¨åœ°è¿è¡Œ Docker å®ˆæŠ¤ç¨‹åºçš„ç¯å¢ƒä¸­æ„å»ºå®¹å™¨é•œåƒæˆä¸ºå¯èƒ½ï¼Œä¾‹å¦‚æ ‡å‡†çš„ Kubernetes é›†ç¾¤ã€‚è¿™æ¶ˆé™¤äº†åœ¨ K8s é›†ç¾¤ä¸­æ„å»ºé•œåƒçš„æ‰€æœ‰é—®é¢˜ã€‚&lt;/p>
&lt;h2 id="istio">Istio&lt;/h2>
&lt;p>&lt;a href="https://istio.io/">Istio&lt;/a> æ˜¯å¸‚åœºä¸Šæœ€è‘—åçš„&lt;a href="https://en.wikipedia.org/wiki/Service_mesh">æœåŠ¡ç½‘æ ¼&lt;/a>ï¼Œå®ƒæ˜¯å¼€æºçš„å¹¶ä¸”éå¸¸å—æ¬¢è¿ã€‚æˆ‘ä¸ä¼šè¯¦ç»†ä»‹ç»ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå·¨å¤§çš„è¯é¢˜ï¼Œä½†æ˜¯å¦‚æœä½ æ­£åœ¨æ„å»º&lt;a href="https://microservices.io/">å¾®æœåŠ¡&lt;/a>ï¼Œå¹¶ä¸”å¯èƒ½åº”è¯¥è¿™æ ·åšï¼Œé‚£ä¹ˆä½ å°†éœ€è¦ä¸€ä¸ªæœåŠ¡ç½‘æ ¼æ¥ç®¡ç†é€šä¿¡ã€å¯è§‚å¯Ÿæ€§ã€é”™è¯¯å¤„ç†ã€å®‰å…¨æ€§ã€‚ä¸å…¶ç”¨é‡å¤çš„é€»è¾‘æ±¡æŸ“æ¯ä¸ªå¾®æœåŠ¡çš„ä»£ç ï¼ˆè¯‘è€…ï¼šSDK ä¾µå…¥ï¼‰ï¼Œä¸å¦‚åˆ©ç”¨æœåŠ¡ç½‘æ ¼ä¸ºä½ åšè¿™ä»¶äº‹ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/15/16263052962147.jpg" alt="">&lt;/p>
&lt;p>ç®€è€Œè¨€ä¹‹ï¼ŒæœåŠ¡ç½‘æ ¼æ˜¯ä¸€ä¸ªä¸“ç”¨çš„åŸºç¡€è®¾æ–½å±‚ï¼Œä½ å¯ä»¥å°†å…¶æ·»åŠ åˆ°ä½ çš„åº”ç”¨ç¨‹åºä¸­ã€‚å®ƒå…è®¸ä½ é€æ˜åœ°æ·»åŠ å¯è§‚å¯Ÿæ€§ã€æµé‡ç®¡ç†å’Œå®‰å…¨æ€§ç­‰åŠŸèƒ½ï¼Œè€Œæ— éœ€å°†å®ƒä»¬æ·»åŠ åˆ°ä½ è‡ªå·±çš„ä»£ç ä¸­ã€‚&lt;/p>
&lt;p>å¦‚æœ &lt;strong>Istio&lt;/strong> ç”¨äºè¿è¡Œå¾®æœåŠ¡ï¼Œå°½ç®¡ä½ å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œ Istio å¹¶ä½¿ç”¨å¾®æœåŠ¡ï¼Œä½† Kubernetes å·²è¢«ä¸€æ¬¡åˆä¸€æ¬¡åœ°è¯æ˜æ˜¯è¿è¡Œå®ƒä»¬çš„æœ€ä½³å¹³å°ã€‚&lt;strong>Istio&lt;/strong> è¿˜å¯ä»¥å°†ä½ çš„ K8s é›†ç¾¤æ‰©å±•åˆ°å…¶ä»–æœåŠ¡ï¼Œä¾‹å¦‚ VMï¼Œå…è®¸ä½ æ‹¥æœ‰åœ¨è¿ç§»åˆ° Kubernetes æ—¶éå¸¸æœ‰ç”¨çš„æ··åˆç¯å¢ƒã€‚&lt;/p>
&lt;h3 id="å¤‡é€‰-5">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://linkerd.io/">&lt;strong>Linkerd&lt;/strong>&lt;/a> æ˜¯ä¸€ç§æ›´è½»å·§ä¸”å¯èƒ½æ›´å¿«çš„æœåŠ¡ç½‘æ ¼ã€‚Linkerd ä»å¤´å¼€å§‹â€‹â€‹ä¸ºå®‰å…¨æ€§è€Œæ„å»ºï¼ŒåŒ…æ‹¬&lt;a href="https://linkerd.io/2.10/features/automatic-mtls/">é»˜è®¤ mTLS&lt;/a>ã€&lt;a href="https://github.com/linkerd/linkerd2-proxy">ä½¿ç”¨ Rust æ„å»ºçš„æ•°æ®å¹³é¢&lt;/a>ã€&lt;a href="https://github.com/linkerd/linkerd2-proxy">å†…å­˜å®‰å…¨è¯­è¨€&lt;/a>å’Œ&lt;a href="https://github.com/linkerd/linkerd2/blob/main/SECURITY_AUDIT.pdf">å®šæœŸå®‰å…¨å®¡è®¡&lt;/a>ç­‰åŠŸèƒ½&lt;/li>
&lt;li>&lt;a href="https://www.consul.io/">&lt;strong>Consul&lt;/strong>&lt;/a> æ˜¯ä¸ºä»»ä½•è¿è¡Œæ—¶å’Œäº‘æä¾›å•†æ„å»ºçš„æœåŠ¡ç½‘æ ¼ï¼Œå› æ­¤å®ƒéå¸¸é€‚åˆè·¨ K8s å’Œäº‘æä¾›å•†çš„æ··åˆéƒ¨ç½²ã€‚å¦‚æœä¸æ˜¯æ‰€æœ‰çš„å·¥ä½œè´Ÿè½½éƒ½åœ¨ Kubernetes ä¸Šè¿è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="argo-rollouts">Argo Rollouts&lt;/h2>
&lt;p>æˆ‘ä»¬å·²ç»æåˆ°ï¼Œä½ å¯ä»¥ä½¿ç”¨ Kubernetes ä½¿ç”¨ Argo Workflows æˆ–ä½¿ç”¨ Kanico æ„å»ºå›¾åƒçš„ç±»ä¼¼å·¥å…·æ¥è¿è¡Œ CI/CD ç®¡é“ã€‚ä¸‹ä¸€ä¸ªåˆä¹é€»è¾‘çš„æ­¥éª¤æ˜¯ç»§ç»­å¹¶è¿›è¡ŒæŒç»­éƒ¨ç½²ã€‚ç”±äºæ¶‰åŠé«˜é£é™©ï¼Œè¿™åœ¨çœŸå®åœºæ™¯ä¸­æ˜¯æå…·æŒ‘æˆ˜æ€§çš„ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•°å…¬å¸åªåšæŒç»­äº¤ä»˜ï¼Œè¿™æ„å‘³ç€ä»–ä»¬å·²ç»å®ç°äº†è‡ªåŠ¨åŒ–ï¼Œä½†ä»–ä»¬ä»ç„¶éœ€è¦æ‰‹åŠ¨æ‰¹å‡†å’ŒéªŒè¯ï¼Œè¿™ä¸ªæ‰‹åŠ¨æ­¥éª¤æ˜¯è¿™æ˜¯å› ä¸ºå›¢é˜Ÿ&lt;strong>ä¸èƒ½å®Œå…¨ä¿¡ä»»ä»–ä»¬çš„è‡ªåŠ¨åŒ–&lt;/strong>ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆï¼Œä½ å¦‚ä½•å»ºç«‹è¿™ç§ä¿¡ä»»ä»¥æ‘†è„±æ‰€æœ‰è„šæœ¬å¹¶å®Œå…¨è‡ªåŠ¨åŒ–ä»æºä»£ç åˆ°ç”Ÿäº§çš„æ‰€æœ‰å†…å®¹ï¼Ÿç­”æ¡ˆæ˜¯ï¼šå¯è§‚å¯Ÿæ€§ã€‚ä½ éœ€è¦å°†èµ„æºæ›´å¤šåœ°é›†ä¸­åœ¨æŒ‡æ ‡ä¸Šï¼Œå¹¶æ”¶é›†å‡†ç¡®è¡¨ç¤ºåº”ç”¨ç¨‹åºçŠ¶æ€æ‰€éœ€çš„æ‰€æœ‰æ•°æ®ã€‚ç›®æ ‡æ˜¯ä½¿ç”¨ä¸€ç»„æŒ‡æ ‡æ¥å»ºç«‹è¿™ç§ä¿¡ä»»ã€‚å¦‚æœä½ åœ¨ &lt;a href="https://prometheus.io/">Prometheus&lt;/a> ä¸­æ‹¥æœ‰æ‰€æœ‰æ•°æ®ï¼Œé‚£ä¹ˆä½ å¯ä»¥è‡ªåŠ¨éƒ¨ç½²ï¼Œå› ä¸ºä½ å¯ä»¥æ ¹æ®è¿™äº›æŒ‡æ ‡è‡ªåŠ¨é€æ­¥æ¨å‡ºåº”ç”¨ç¨‹åºã€‚&lt;/p>
&lt;p>ç®€è€Œè¨€ä¹‹ï¼Œä½ éœ€è¦æ¯” K8s å¼€ç®±å³ç”¨çš„&lt;a href="https://www.educative.io/blog/kubernetes-deployments-strategies">&lt;strong>æ»šåŠ¨æ›´æ–°&lt;/strong>&lt;/a>æ›´é«˜çº§çš„éƒ¨ç½²æŠ€æœ¯ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨&lt;a href="https://semaphoreci.com/blog/what-is-canary-deployment">é‡‘ä¸é›€éƒ¨ç½²&lt;/a>è¿›è¡Œæ¸è¿›å¼äº¤ä»˜ã€‚ç›®æ ‡æ˜¯é€æ­¥å°†æµé‡è·¯ç”±åˆ°åº”ç”¨ç¨‹åºçš„æ–°ç‰ˆæœ¬ï¼Œç­‰å¾…æ”¶é›†æŒ‡æ ‡ï¼Œåˆ†æå®ƒä»¬å¹¶å°†å®ƒä»¬ä¸é¢„å®šä¹‰çš„è§„åˆ™è¿›è¡ŒåŒ¹é…ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæˆ‘ä»¬å¢åŠ æµé‡ï¼›å¦‚æœæœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šå›æ»šéƒ¨ç½²ã€‚
è¦åœ¨ Kubernetes ä¸­æ‰§è¡Œæ­¤æ“ä½œï¼Œä½ å¯ä»¥ä½¿ç”¨æä¾› Canary å‘å¸ƒç­‰çš„ Argo Rollouts ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;a href="https://kubernetes.io/docs/concepts/architecture/controller/">Argo Rollouts&lt;/a> æ˜¯ä¸€ä¸ª &lt;a href="https://kubernetes.io/docs/concepts/architecture/controller/">Kubernetes æ§åˆ¶å™¨&lt;/a>å’Œä¸€ç»„ &lt;a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">CRD&lt;/a>ï¼Œå¯æä¾›é«˜çº§éƒ¨ç½²åŠŸèƒ½ï¼Œä¾‹å¦‚è“ç»¿ã€é‡‘ä¸é›€ã€é‡‘ä¸é›€åˆ†æã€å®éªŒå’Œå‘ Kubernetes çš„æ¸è¿›å¼äº¤ä»˜åŠŸèƒ½ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å°½ç®¡åƒ &lt;a href="https://istio.io/">Istio&lt;/a> è¿™æ ·çš„æœåŠ¡ç½‘æ ¼æä¾› Canary å‘å¸ƒï¼Œä½† Argo Rollouts ä½¿è¿™ä¸ªè¿‡ç¨‹å˜å¾—æ›´åŠ å®¹æ˜“å¹¶ä¸”ä»¥å¼€å‘äººå‘˜ä¸ºä¸­å¿ƒï¼Œå› ä¸ºå®ƒæ˜¯ä¸“é—¨ä¸ºæ­¤ç›®çš„è€Œæ„å»ºçš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒArgo Rollouts å¯ä»¥ä¸ä»»ä½•æœåŠ¡ç½‘æ ¼é›†æˆã€‚&lt;/p>
&lt;p>Argo Rollouts åŠŸèƒ½ï¼š&lt;/p>
&lt;ul>
&lt;li>è“ç»¿æ›´æ–°ç­–ç•¥&lt;/li>
&lt;li>é‡‘ä¸é›€æ›´æ–°ç­–ç•¥&lt;/li>
&lt;li>ç»†ç²’åº¦ã€åŠ æƒçš„æµé‡è½¬ç§»&lt;/li>
&lt;li>è‡ªåŠ¨å›æ»šå’Œä¿ƒé”€æˆ–äººå·¥åˆ¤æ–­&lt;/li>
&lt;li>å¯å®šåˆ¶çš„æŒ‡æ ‡æŸ¥è¯¢å’Œä¸šåŠ¡ KPI åˆ†æ&lt;/li>
&lt;li>å…¥å£æ§åˆ¶å™¨é›†æˆï¼šNGINXã€ALB&lt;/li>
&lt;li>æœåŠ¡ç½‘æ ¼é›†æˆï¼šIstioã€Linkerdã€SMI&lt;/li>
&lt;li>æŒ‡æ ‡æä¾›è€…é›†æˆï¼šPrometheusã€Wavefrontã€Kayentaã€Webã€Kubernetes Jobs&lt;/li>
&lt;/ul>
&lt;h3 id="å¤‡é€‰-6">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://istio.io/">Istio&lt;/a> ä½œä¸º Canary ç‰ˆæœ¬çš„æœåŠ¡ç½‘æ ¼ã€‚Istio ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ¸è¿›å¼äº¤ä»˜å·¥å…·ï¼Œå®ƒè¿˜æ˜¯ä¸€ä¸ªå®Œæ•´çš„æœåŠ¡ç½‘æ ¼ã€‚Istio ä¸ä¼šè‡ªåŠ¨éƒ¨ç½²ï¼ŒArgo Rollouts å¯ä»¥ä¸ Istio é›†æˆæ¥å®ç°è¿™ä¸€ç‚¹ã€‚&lt;/li>
&lt;li>&lt;a href="https://flagger.app/">Flagger&lt;/a> ä¸ Argo Rollouts éå¸¸ç›¸ä¼¼ï¼Œå¹¶ä¸”ä¸ &lt;a href="https://fluxcd.io/">Flux&lt;/a> å¾ˆå¥½åœ°é›†æˆåœ¨ä¸€èµ·ï¼Œå› æ­¤å¦‚æœä½ ä½¿ç”¨ Fluxï¼Œè¯·è€ƒè™‘ä½¿ç”¨ Flaggerã€‚&lt;/li>
&lt;li>&lt;a href="https://spinnaker.io/">Spinnaker&lt;/a> æ˜¯ Kubernetes çš„ç¬¬ä¸€ä¸ªæŒç»­äº¤ä»˜å·¥å…·ï¼Œå®ƒå…·æœ‰è®¸å¤šåŠŸèƒ½ï¼Œä½†ä½¿ç”¨å’Œè®¾ç½®èµ·æ¥æœ‰ç‚¹å¤æ‚ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="crossplane">Crossplane&lt;/h2>
&lt;p>&lt;a href="https://crossplane.io/">&lt;strong>Crossplane&lt;/strong>&lt;/a> æ˜¯æˆ‘æœ€å–œæ¬¢çš„ K8s å·¥å…·ï¼Œæˆ‘å¯¹è¿™ä¸ªé¡¹ç›®æ„Ÿåˆ°éå¸¸å…´å¥‹ï¼Œå› ä¸ºå®ƒç»™ Kubernetes å¸¦æ¥äº†ä¸€ä¸ªå…³é”®çš„ç¼ºå¤±éƒ¨åˆ†ï¼šåƒç®¡ç† K8s èµ„æºä¸€æ ·ç®¡ç†ç¬¬ä¸‰æ–¹æœåŠ¡ã€‚è¿™æ„å‘³ç€ï¼Œä½ å¯ä»¥ä½¿ç”¨ &lt;strong>YAML&lt;/strong> ä¸­å®šä¹‰çš„ K8s èµ„æºæ¥é…ç½®äº‘æä¾›å•†æ•°æ®åº“ï¼Œä¾‹å¦‚ &lt;a href="https://aws.amazon.com/rds/">&lt;strong>AWS RDS&lt;/strong>&lt;/a> æˆ– &lt;strong>GCP Cloud SQL&lt;/strong>ï¼Œå°±åƒä½ åœ¨ K8s ä¸­é…ç½®æ•°æ®åº“ä¸€æ ·ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/15/16263059248680.jpg" alt="">&lt;/p>
&lt;p>ä½¿ç”¨ Crossplaneï¼Œæ— éœ€ä½¿ç”¨ä¸åŒçš„å·¥å…·å’Œæ–¹æ³•åˆ†ç¦»åŸºç¡€è®¾æ–½å’Œä»£ç ã€‚&lt;strong>ä½ å¯ä»¥ä½¿ç”¨ K8s èµ„æºå®šä¹‰ä¸€åˆ‡&lt;/strong>ã€‚è¿™æ ·ï¼Œä½ å°±æ— éœ€å­¦ä¹  &lt;a href="https://www.terraform.io/">Terraform&lt;/a> ç­‰æ–°å·¥å…·å¹¶å°†å®ƒä»¬åˆ†å¼€ä¿å­˜ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Crossplane æ˜¯ä¸€ä¸ªå¼€æº Kubernetes é™„åŠ ç»„ä»¶ï¼Œå®ƒä½¿å¹³å°å›¢é˜Ÿèƒ½å¤Ÿç»„è£…æ¥è‡ªå¤šä¸ªä¾›åº”å•†çš„åŸºç¡€è®¾æ–½ï¼Œå¹¶å…¬å¼€æ›´é«˜çº§åˆ«çš„è‡ªåŠ© API ä¾›åº”ç”¨ç¨‹åºå›¢é˜Ÿä½¿ç”¨ï¼Œè€Œæ— éœ€ç¼–å†™ä»»ä½•ä»£ç ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>Crossplane&lt;/strong> æ‰©å±•äº†ä½ çš„ Kubernetes é›†ç¾¤ï¼Œä¸ºä½ æä¾›é€‚ç”¨äºä»»ä½•åŸºç¡€æ¶æ„æˆ–æ‰˜ç®¡äº‘æœåŠ¡çš„ &lt;strong>CRD&lt;/strong>ã€‚æ­¤å¤–ï¼Œå®ƒå…è®¸ä½ å®Œå…¨å®ç°æŒç»­éƒ¨ç½²ï¼Œå› ä¸ºä¸ Terraform ç­‰å…¶ä»–å·¥å…·ç›¸åï¼ŒCrossplane ä½¿ç”¨ç°æœ‰çš„ K8s åŠŸèƒ½ï¼ˆä¾‹å¦‚æ§åˆ¶å¾ªç¯ï¼‰æ¥æŒç»­è§‚å¯Ÿä½ çš„é›†ç¾¤å¹¶è‡ªåŠ¨æ£€æµ‹ä»»ä½•å¯¹å…¶èµ·ä½œç”¨çš„é…ç½®æ¼‚ç§»ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ å®šä¹‰äº†ä¸€ä¸ªæ‰˜ç®¡æ•°æ®åº“å®ä¾‹å¹¶ä¸”æœ‰äººæ‰‹åŠ¨æ›´æ”¹å®ƒï¼ŒCrossplane å°†è‡ªåŠ¨æ£€æµ‹é—®é¢˜å¹¶å°†å…¶è®¾ç½®å›ä»¥å‰çš„å€¼ã€‚è¿™å°†å®æ–½åŸºç¡€è®¾æ–½å³ä»£ç å’Œ GitOps åŸåˆ™ã€‚Crossplane ä¸ ArgoCD é…åˆä½¿ç”¨æ•ˆæœå¾ˆå¥½ï¼Œå®ƒå¯ä»¥æŸ¥çœ‹æºä»£ç å¹¶ç¡®ä¿ä½ çš„ä»£ç å­˜å‚¨åº“æ˜¯å”¯ä¸€çš„çœŸå®æ¥æºï¼Œå¹¶ä¸”ä»£ç ä¸­çš„ä»»ä½•æ›´æ”¹éƒ½ä¼šä¼ æ’­åˆ°é›†ç¾¤ä»¥åŠå¤–éƒ¨äº‘æœåŠ¡ã€‚å¦‚æœæ²¡æœ‰ Crossplaneï¼Œä½ åªèƒ½åœ¨ K8s æœåŠ¡ä¸­å®ç° GitOpsï¼Œè€Œä¸èƒ½åœ¨ä¸ä½¿ç”¨å•ç‹¬è¿›ç¨‹çš„æƒ…å†µä¸‹åœ¨äº‘æœåŠ¡ä¸­å®ç°ï¼Œç°åœ¨ä½ å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œè¿™å¤ªæ£’äº†ã€‚&lt;/p>
&lt;h3 id="å¤‡é€‰-7">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.terraform.io/">Terraform&lt;/a> æ˜¯æœ€è‘—åçš„ IaC å·¥å…·ï¼Œä½†å®ƒä¸æ˜¯ K8s åŸç”Ÿçš„ï¼Œéœ€è¦æ–°æŠ€èƒ½å¹¶ä¸”ä¸ä¼šè‡ªåŠ¨ç›‘è§†é…ç½®æ¼‚ç§»ã€‚&lt;/li>
&lt;li>&lt;a href="https://www.pulumi.com/">Pulumi&lt;/a> æ˜¯ä¸€ç§ Terraform æ›¿ä»£å“ï¼Œå®ƒä½¿ç”¨å¼€å‘äººå‘˜å¯ä»¥æµ‹è¯•å’Œç†è§£çš„ç¼–ç¨‹è¯­è¨€å·¥ä½œã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="knative">Knative&lt;/h2>
&lt;p>å¦‚æœä½ åœ¨äº‘ä¸­å¼€å‘åº”ç”¨ç¨‹åºï¼Œä½ å¯èƒ½å·²ç»ä½¿ç”¨äº†ä¸€äº›æ— æœåŠ¡å™¨æŠ€æœ¯ï¼Œä¾‹å¦‚ &lt;a href="https://aws.amazon.com/lambda/">AWS Lambda &lt;/a>ï¼Œå®ƒæ˜¯ä¸€ç§ç§°ä¸º &lt;a href="https://en.wikipedia.org/wiki/Function_as_a_service">FaaS&lt;/a> çš„äº‹ä»¶é©±åŠ¨èŒƒä¾‹ã€‚&lt;/p>
&lt;p>æˆ‘è¿‡å»å·²ç»è®¨è®ºè¿‡ &lt;a href="https://en.wikipedia.org/wiki/Serverless_computing">Serverless&lt;/a>ï¼Œå› æ­¤è¯·æŸ¥çœ‹æˆ‘&lt;a href="https://itnext.io/scaling-my-app-serverless-vs-kubernetes-cdb8adf446e1">ä¹‹å‰çš„æ–‡ç« &lt;/a>ä»¥äº†è§£æ›´å¤šä¿¡æ¯ã€‚Serverless çš„é—®é¢˜åœ¨äºå®ƒä¸äº‘æä¾›å•†ç´§å¯†è€¦åˆï¼Œå› ä¸ºæä¾›å•†å¯ä»¥ä¸ºäº‹ä»¶é©±åŠ¨çš„åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªå¾ˆå¥½çš„ç”Ÿæ€ç³»ç»Ÿã€‚&lt;/p>
&lt;p>å¯¹äº Kubernetesï¼Œå¦‚æœä½ å¸Œæœ›å°†å‡½æ•°ä½œä¸ºä»£ç è¿è¡Œå¹¶ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œé‚£ä¹ˆä½ æœ€å¥½çš„é€‰æ‹©æ˜¯ &lt;a href="https://itnext.io/scaling-my-app-serverless-vs-kubernetes-cdb8adf446e1">Knative&lt;/a>ã€‚Knative æ—¨åœ¨åœ¨ Kubernetes ä¸Šè¿è¡Œå‡½æ•°ï¼Œåœ¨ Pod ä¹‹ä¸Šåˆ›å»ºä¸€ä¸ªæŠ½è±¡ã€‚&lt;/p>
&lt;p>ç‰¹ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>é’ˆå¯¹å¸¸è§åº”ç”¨ç¨‹åºç”¨ä¾‹çš„å…·æœ‰æ›´é«˜çº§åˆ«æŠ½è±¡çš„é‡ç‚¹ APIã€‚&lt;/li>
&lt;li>åœ¨å‡ ç§’é’Ÿå†…å»ºç«‹ä¸€ä¸ªå¯æ‰©å±•ã€å®‰å…¨ã€æ— çŠ¶æ€çš„æœåŠ¡ã€‚&lt;/li>
&lt;li>æ¾æ•£è€¦åˆçš„åŠŸèƒ½è®©ä½ å¯ä»¥ä½¿ç”¨æ‰€éœ€çš„éƒ¨åˆ†ã€‚&lt;/li>
&lt;li>å¯æ’æ‹”ç»„ä»¶è®©ä½ å¯ä»¥ä½¿ç”¨è‡ªå·±çš„æ—¥å¿—è®°å½•å’Œç›‘æ§ã€ç½‘ç»œå’ŒæœåŠ¡ç½‘æ ¼ã€‚&lt;/li>
&lt;li>Knative æ˜¯å¯ç§»æ¤çš„ï¼šåœ¨ Kubernetes è¿è¡Œçš„ä»»ä½•åœ°æ–¹è¿è¡Œå®ƒï¼Œä¸ç”¨æ‹…å¿ƒä¾›åº”å•†é”å®šã€‚&lt;/li>
&lt;li>æƒ¯ç”¨çš„å¼€å‘è€…ä½“éªŒï¼Œæ”¯æŒ GitOpsã€DockerOpsã€ManualOps ç­‰å¸¸ç”¨æ¨¡å¼ã€‚&lt;/li>
&lt;li>Knative å¯ä»¥ä¸å¸¸è§çš„å·¥å…·å’Œæ¡†æ¶ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚ Djangoã€Ruby on Railsã€Spring ç­‰ç­‰ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="å¤‡é€‰-8">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://argoproj.github.io/argo-events/">Argo Events&lt;/a> ä¸º Kubernetes æä¾›äº†ä¸€ä¸ªäº‹ä»¶é©±åŠ¨çš„å·¥ä½œæµå¼•æ“ï¼Œå¯ä»¥ä¸ AWS Lambda ç­‰äº‘å¼•æ“é›†æˆã€‚å®ƒä¸æ˜¯ FaaSï¼Œè€Œæ˜¯ä¸º Kubernetes æä¾›äº†ä¸€ä¸ªäº‹ä»¶é©±åŠ¨çš„æ¶æ„ã€‚&lt;/li>
&lt;li>&lt;a href="https://www.openfaas.com/">OpenFaas&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="kyverno">Kyverno&lt;/h2>
&lt;p>Kubernetes æä¾›äº†æå¤§çš„çµæ´»æ€§ï¼Œä»¥èµ‹äºˆæ•æ·çš„è‡ªæ²»å›¢é˜ŸæƒåŠ›ï¼Œä½†èƒ½åŠ›è¶Šå¤§ï¼Œè´£ä»»è¶Šå¤§ã€‚å¿…é¡»æœ‰ä¸€ç»„&lt;strong>æœ€ä½³å®è·µå’Œè§„åˆ™&lt;/strong>ï¼Œä»¥ç¡®ä¿ä»¥ä¸€è‡´ä¸”æœ‰å‡èšåŠ›çš„æ–¹å¼æ¥éƒ¨ç½²å’Œç®¡ç†ç¬¦åˆå…¬å¸æ”¿ç­–å’Œå®‰å…¨è¦æ±‚çš„å·¥ä½œè´Ÿè½½ã€‚&lt;/p>
&lt;p>æœ‰å‡ ç§å·¥å…·å¯ä»¥å®ç°è¿™ä¸€ç‚¹ï¼Œä½†æ²¡æœ‰ä¸€ä¸ªæ˜¯ Kubernetes åŸç”Ÿçš„â€¦â€¦ ç›´åˆ°ç°åœ¨ã€‚&lt;a href="https://kyverno.io/">Kyverno&lt;/a> æ˜¯ä¸º Kubernetes è®¾è®¡çš„ç­–ç•¥å¼•æ“ï¼Œç­–ç•¥ä½œä¸º Kubernetes èµ„æºè¿›è¡Œç®¡ç†ï¼Œå¹¶ä¸”ä¸éœ€è¦æ–°çš„è¯­è¨€æ¥ç¼–å†™ç­–ç•¥ã€‚Kyverno ç­–ç•¥å¯ä»¥éªŒè¯ã€æ”¹å˜å’Œç”Ÿæˆ Kubernetes èµ„æºã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/15/16263062593080.jpg" alt="">&lt;/p>
&lt;p>ä½ å¯ä»¥åº”ç”¨æœ‰å…³æœ€ä½³å®è·µã€ç½‘ç»œæˆ–å®‰å…¨æ€§çš„ä»»ä½•ç±»å‹çš„ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥å¼ºåˆ¶æ‰€æœ‰æœåŠ¡éƒ½æœ‰æ ‡ç­¾æˆ–æ‰€æœ‰å®¹å™¨éƒ½ä»¥é root èº«ä»½è¿è¡Œã€‚ä½ å¯ä»¥åœ¨&lt;a href="https://github.com/kyverno/policies/">æ­¤å¤„&lt;/a>æŸ¥çœ‹ä¸€äº›æ”¿ç­–ç¤ºä¾‹ã€‚ç­–ç•¥å¯ä»¥åº”ç”¨äºæ•´ä¸ªé›†ç¾¤æˆ–ç»™å®šçš„å‘½åç©ºé—´ã€‚ä½ è¿˜å¯ä»¥é€‰æ‹©æ˜¯åªæƒ³å®¡æ ¸ç­–ç•¥è¿˜æ˜¯å¼ºåˆ¶æ‰§è¡Œå®ƒä»¬ä»¥é˜»æ­¢ç”¨æˆ·éƒ¨ç½²èµ„æºã€‚&lt;/p>
&lt;h3 id="å¤‡é€‰-9">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.openpolicyagent.org/">Open Policy Agent&lt;/a> æ˜¯è‘—åçš„äº‘åŸç”ŸåŸºäºç­–ç•¥çš„æ§åˆ¶å¼•æ“ã€‚å®ƒä½¿ç”¨è‡ªå·±çš„å£°æ˜æ€§è¯­è¨€ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è®¸å¤šç¯å¢ƒä¸­è¿è¡Œï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨ Kubernetes ä¸Šã€‚å®ƒæ¯” &lt;a href="https://kyverno.io/">Kyverno&lt;/a> æ›´éš¾ç®¡ç†ï¼Œä½†æ›´å¼ºå¤§ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="kubevela">Kubevela&lt;/h2>
&lt;p>Kubernetes çš„ä¸€ä¸ªé—®é¢˜æ˜¯å¼€å‘äººå‘˜éœ€è¦éå¸¸äº†è§£å’Œç†è§£å¹³å°å’Œé›†ç¾¤é…ç½®ã€‚è®¸å¤šäººä¼šäº‰è¾©è¯´ &lt;strong>K8s çš„æŠ½è±¡çº§åˆ«å¤ªä½&lt;/strong>ï¼Œè¿™ä¼šç»™åªæƒ³ä¸“æ³¨äºç¼–å†™å’Œäº¤ä»˜åº”ç”¨ç¨‹åºçš„å¼€å‘äººå‘˜å¸¦æ¥å¾ˆå¤šæ‘©æ“¦ã€‚&lt;/p>
&lt;p>åœ¨å¼€æ”¾å¼åº”ç”¨ç¨‹åºæ¨¡å‹ï¼ˆ&lt;a href="https://oam.dev/">OAM&lt;/a>ï¼‰çš„è®¾ç«‹æ˜¯ä¸ºäº†å…‹æœè¿™ä¸ªé—®é¢˜ã€‚è¿™ä¸ªæƒ³æ³•æ˜¯å›´ç»•åº”ç”¨ç¨‹åºåˆ›å»ºæ›´é«˜çº§åˆ«çš„æŠ½è±¡ï¼Œå®ƒç‹¬ç«‹äºåº•å±‚è¿è¡Œæ—¶ã€‚ä½ å¯ä»¥åœ¨æ­¤å¤„é˜…è¯»è§„èŒƒã€‚&lt;/p>
&lt;blockquote>
&lt;p>ä¸“æ³¨äºåº”ç”¨ç¨‹åºè€Œä¸æ˜¯å®¹å™¨æˆ–åè°ƒå™¨ï¼Œå¼€æ”¾åº”ç”¨ç¨‹åºæ¨¡å‹ [OAM] å¸¦æ¥äº†æ¨¡å—åŒ–ã€å¯æ‰©å±•å’Œå¯ç§»æ¤çš„è®¾è®¡ï¼Œç”¨äºä½¿ç”¨æ›´é«˜çº§åˆ«ä½†ä¸€è‡´çš„ API å¯¹åº”ç”¨ç¨‹åºéƒ¨ç½²è¿›è¡Œå»ºæ¨¡ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="https://kubevela.io/">Kubevela&lt;/a> æ˜¯ OAM æ¨¡å‹çš„ä¸€ä¸ªå®ç°ã€‚KubeVela ä¸è¿è¡Œæ—¶æ— å…³ï¼Œå¯æœ¬åœ°æ‰©å±•ï¼Œä½†æœ€é‡è¦çš„æ˜¯ï¼Œä»¥åº”ç”¨ç¨‹åºä¸ºä¸­å¿ƒ ã€‚åœ¨ Kubevela ä¸­ï¼Œåº”ç”¨ç¨‹åºæ˜¯ä½œä¸º Kubernetes èµ„æºå®ç°çš„ä¸€ç­‰å…¬æ°‘ã€‚**é›†ç¾¤è¿è¥å•†ï¼ˆPlatform Teamï¼‰å’Œå¼€å‘è€…ï¼ˆApplication Teamï¼‰**æ˜¯æœ‰åŒºåˆ«çš„ã€‚é›†ç¾¤æ“ä½œå‘˜é€šè¿‡å®šä¹‰ç»„ä»¶ï¼ˆç»„æˆåº”ç”¨ç¨‹åºçš„å¯éƒ¨ç½²/å¯é…ç½®å®ä½“ï¼Œå¦‚ Helm Chartï¼‰å’Œç‰¹å¾æ¥ç®¡ç†é›†ç¾¤å’Œä¸åŒçš„ç¯å¢ƒã€‚å¼€å‘äººå‘˜é€šè¿‡ç»„è£…ç»„ä»¶å’Œç‰¹å¾æ¥å®šä¹‰åº”ç”¨ç¨‹åºã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/15/16263064905339.jpg" alt="">&lt;/p>
&lt;p>KubeVela æ˜¯ä¸€ä¸ª&lt;a href="https://cncf.io/">äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š&lt;/a>æ²™ç®±é¡¹ç›®ï¼Œè™½ç„¶å®ƒä»å¤„äºèµ·æ­¥é˜¶æ®µï¼Œä½†å®ƒå¯ä»¥åœ¨ä¸ä¹…çš„å°†æ¥æ”¹å˜æˆ‘ä»¬ä½¿ç”¨ Kubernetes çš„æ–¹å¼ï¼Œè®©å¼€å‘äººå‘˜æ— éœ€æˆä¸º Kubernetes ä¸“å®¶å³å¯ä¸“æ³¨äºåº”ç”¨ç¨‹åºã€‚ä½†æ˜¯ï¼Œæˆ‘ç¡®å®å¯¹ &lt;strong>OAM&lt;/strong> åœ¨ç°å®ä¸–ç•Œä¸­çš„é€‚ç”¨æ€§æœ‰ä¸€äº›æ‹…å¿§ï¼Œå› ä¸ºç³»ç»Ÿåº”ç”¨ç¨‹åºã€ML æˆ–å¤§æ•°æ®è¿‡ç¨‹ç­‰ä¸€äº›æœåŠ¡åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºä½çº§ç»†èŠ‚ï¼Œè¿™äº›ç»†èŠ‚å¯èƒ½å¾ˆéš¾èå…¥ OAM æ¨¡å‹ä¸­ã€‚&lt;/p>
&lt;h3 id="å¤‡é€‰-10">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.shipa.io/getting-started/">Shipa&lt;/a> éµå¾ªç±»ä¼¼çš„æ–¹æ³•ï¼Œä½¿å¹³å°å’Œå¼€å‘å›¢é˜Ÿèƒ½å¤ŸååŒå·¥ä½œï¼Œè½»æ¾å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Kubernetesã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="snyk">Snyk&lt;/h2>
&lt;p>ä»»ä½•å¼€å‘è¿‡ç¨‹ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹é¢æ˜¯å®‰å…¨æ€§ï¼Œè¿™ä¸€ç›´æ˜¯ Kubernetes çš„ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºæƒ³è¦è¿ç§»åˆ° Kubernetes çš„å…¬å¸æ— æ³•è½»æ¾å®ç°å…¶å½“å‰çš„å®‰å…¨åŸåˆ™ã€‚&lt;/p>
&lt;p>&lt;a href="https://snyk.io/">Snyk&lt;/a> è¯•å›¾é€šè¿‡æä¾›ä¸€ä¸ªå¯ä»¥è½»æ¾ä¸ Kubernetes é›†æˆçš„å®‰å…¨æ¡†æ¶æ¥ç¼“è§£è¿™ç§æƒ…å†µã€‚å®ƒå¯ä»¥æ£€æµ‹å®¹å™¨æ˜ åƒã€ä½ çš„ä»£ç ã€å¼€æºé¡¹ç›®ç­‰ä¸­çš„æ¼æ´ã€‚&lt;/p>
&lt;h3 id="å¤‡é€‰-11">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://falco.org/">Falco&lt;/a> æ˜¯ Kubernetes çš„è¿è¡Œæ—¶å®‰å…¨çº¿ç¨‹æ£€æµ‹å·¥å…·ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="velero">Velero&lt;/h2>
&lt;p>å¦‚æœä½ åœ¨ Kubernetes ä¸­è¿è¡Œå·¥ä½œè´Ÿè½½å¹¶ä½¿ç”¨å·æ¥å­˜å‚¨æ•°æ®ï¼Œåˆ™éœ€è¦åˆ›å»ºå’Œç®¡ç†å¤‡ä»½ã€‚&lt;a href="https://velero.io/">Velero&lt;/a> æä¾›ç®€å•çš„å¤‡ä»½/æ¢å¤è¿‡ç¨‹ã€ç¾éš¾æ¢å¤æœºåˆ¶å’Œæ•°æ®è¿ç§»ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/15/16263066379840.jpg" alt="">&lt;/p>
&lt;p>ä¸å…¶ä»–ç›´æ¥è®¿é—® Kubernetes etcd æ•°æ®åº“æ‰§è¡Œå¤‡ä»½å’Œæ¢å¤çš„å·¥å…·ä¸åŒï¼ŒVelero ä½¿ç”¨ Kubernetes API æ¥æ•è·é›†ç¾¤èµ„æºçš„çŠ¶æ€å¹¶åœ¨å¿…è¦æ—¶æ¢å¤å®ƒä»¬ã€‚æ­¤å¤–ï¼ŒVelero ä½¿ä½ èƒ½å¤Ÿåœ¨é…ç½®çš„åŒæ—¶å¤‡ä»½å’Œæ¢å¤ä½ çš„åº”ç”¨ç¨‹åºæŒä¹…æ•°æ®ã€‚&lt;/p>
&lt;h2 id="schema-hero">Schema Hero&lt;/h2>
&lt;p>è½¯ä»¶å¼€å‘ä¸­çš„å¦ä¸€ä¸ªå¸¸è§è¿‡ç¨‹æ˜¯åœ¨ä½¿ç”¨å…³ç³»æ•°æ®åº“æ—¶ç®¡ç†&lt;strong>æ¨¡å¼æ¼”å˜&lt;/strong>ã€‚&lt;/p>
&lt;p>&lt;a href="https://schemahero.io/">SchemaHero&lt;/a> æ˜¯ä¸€ç§å¼€æºæ•°æ®åº“æ¶æ„è¿ç§»å·¥å…·ï¼Œå¯å°†æ¶æ„å®šä¹‰è½¬æ¢ä¸ºå¯åº”ç”¨äºä»»ä½•ç¯å¢ƒçš„è¿ç§»è„šæœ¬ã€‚å®ƒä½¿ç”¨ Kubernetes å£°æ˜æ€§æ¥ç®¡ç†æ•°æ®åº“æ¨¡å¼è¿ç§»ã€‚ä½ åªéœ€æŒ‡å®šæ‰€éœ€çš„çŠ¶æ€ï¼Œç„¶å &lt;strong>SchemaHero&lt;/strong> ç®¡ç†å…¶ä½™çš„ã€‚&lt;/p>
&lt;h3 id="å¤‡é€‰-12">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.liquibase.org/">LiquidBase&lt;/a> æ˜¯æœ€è‘—åçš„æ›¿ä»£å“ã€‚å®ƒæ›´éš¾ä½¿ç”¨ï¼Œä¸”ä¸æ˜¯ Kubernetes åŸç”Ÿçš„ï¼Œä½†å®ƒå…·æœ‰æ›´å¤šåŠŸèƒ½ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="bitnami-sealed-secrets">Bitnami Sealed Secrets&lt;/h2>
&lt;p>æˆ‘ä»¬å·²ç»ä»‹ç»äº†è®¸å¤š &lt;strong>GitOps&lt;/strong> å·¥å…·ï¼Œä¾‹å¦‚ &lt;a href="https://argoproj.github.io/argo-cd/">ArgoCD&lt;/a>ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†æ‰€æœ‰å†…å®¹ä¿ç•™åœ¨ Git ä¸­ï¼Œå¹¶ä½¿ç”¨ Kubernetes å£°æ˜æ€§æ¥ä¿æŒç¯å¢ƒåŒæ­¥ã€‚æˆ‘ä»¬åˆšåˆšçœ‹åˆ°æˆ‘ä»¬å¦‚ä½•ï¼ˆå¹¶ä¸”åº”è¯¥ï¼‰åœ¨ Git ä¸­ä¿ç•™çœŸå®æ¥æºï¼Œå¹¶è®©è‡ªåŠ¨åŒ–æµç¨‹å¤„ç†é…ç½®æ›´æ”¹ã€‚&lt;/p>
&lt;p>åœ¨ Git ä¸­é€šå¸¸å¾ˆéš¾ä¿ç•™çš„ä¸€ä»¶äº‹æ˜¯è¯¸å¦‚æ•°æ®åº“å¯†ç æˆ– API å¯†é’¥ä¹‹ç±»çš„ç§˜å¯†ï¼Œè¿™æ˜¯å› ä¸ºä½ æ°¸è¿œä¸åº”è¯¥åœ¨ä»£ç å­˜å‚¨åº“ä¸­å­˜å‚¨ç§˜å¯†ã€‚ä¸€ç§å¸¸è§çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨å¤–éƒ¨ä¿ç®¡åº“ï¼ˆä¾‹å¦‚ &lt;a href="https://aws.amazon.com/secrets-manager/">AWS Secret Manager&lt;/a> æˆ– &lt;a href="https://www.vaultproject.io/">HashiCorp Vault&lt;/a>ï¼‰æ¥å­˜å‚¨æœºå¯†ï¼Œä½†è¿™ä¼šäº§ç”Ÿå¾ˆå¤šæ‘©æ“¦ï¼Œå› ä¸ºä½ éœ€è¦æœ‰ä¸€ä¸ªå•ç‹¬çš„æµç¨‹æ¥å¤„ç†æœºå¯†ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥åƒä»»ä½•å…¶ä»–èµ„æºä¸€æ ·å®‰å…¨åœ°åœ¨ Git ä¸­å­˜å‚¨æœºå¯†ã€‚&lt;/p>
&lt;p>&lt;a href="https://github.com/bitnami-labs/sealed-secrets">&lt;strong>Sealed Secrets&lt;/strong>&lt;/a> æ—¨åœ¨å…‹æœè¿™ä¸ªé—®é¢˜ï¼Œå…è®¸ä½ ä½¿ç”¨å¼ºåŠ å¯†å°†æ•æ„Ÿæ•°æ®å­˜å‚¨åœ¨ Git ä¸­ã€‚Bitnami &lt;strong>Sealed Secrets&lt;/strong> æœ¬åœ°é›†æˆåœ¨ Kubernetes ä¸­ï¼Œå…è®¸ä½ ä»…é€šè¿‡åœ¨ Kubernetes ä¸­è¿è¡Œçš„ Kubernetes æ§åˆ¶å™¨è€Œä¸æ˜¯å…¶ä»–ä»»ä½•äººæ¥è§£å¯†å¯†é’¥ã€‚æ§åˆ¶å™¨å°†è§£å¯†æ•°æ®å¹¶åˆ›å»ºå®‰å…¨å­˜å‚¨çš„åŸç”Ÿ K8s æœºå¯†ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†æ‰€æœ‰å†…å®¹ä½œä¸ºä»£ç å­˜å‚¨åœ¨æˆ‘ä»¬çš„ repo ä¸­ï¼Œä»è€Œå…è®¸æˆ‘ä»¬å®‰å…¨åœ°æ‰§è¡ŒæŒç»­éƒ¨ç½²ï¼Œè€Œæ— éœ€ä»»ä½•å¤–éƒ¨ä¾èµ–ã€‚&lt;/p>
&lt;p>Sealed Secrets ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š&lt;/p>
&lt;ul>
&lt;li>é›†ç¾¤ç«¯æ§åˆ¶å™¨&lt;/li>
&lt;li>å®¢æˆ·ç«¯å®ç”¨ç¨‹åºï¼š&lt;code>kubeseal&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>è¯¥ &lt;code>kubeseal&lt;/code> å®ç”¨ç¨‹åºä½¿ç”¨éå¯¹ç§°åŠ å¯†æ¥åŠ å¯†åªæœ‰æ§åˆ¶å™¨æ‰èƒ½è§£å¯†çš„æœºå¯†ã€‚è¿™äº›åŠ å¯†çš„ç§˜å¯†è¢«ç¼–ç åœ¨ä¸€ä¸ª &lt;code>SealedSecret&lt;/code> K8s èµ„æºä¸­ï¼Œä½ å¯ä»¥å°†å…¶å­˜å‚¨åœ¨ Git ä¸­ã€‚&lt;/p>
&lt;h3 id="å¤‡é€‰-13">å¤‡é€‰&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://aws.amazon.com/secrets-manager/">AWS Secret Manager&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vaultproject.io/">HashiCorp Vault&lt;/a>ï¼‰&lt;/li>
&lt;/ul>
&lt;h2 id="capsule">Capsule&lt;/h2>
&lt;p>è®¸å¤šå…¬å¸ä½¿ç”¨&lt;strong>å¤šç§Ÿæˆ·&lt;/strong>æ¥ç®¡ç†ä¸åŒçš„å®¢æˆ·ã€‚è¿™åœ¨è½¯ä»¶å¼€å‘ä¸­å¾ˆå¸¸è§ï¼Œä½†åœ¨ Kubernetes ä¸­å¾ˆéš¾å®ç°ã€‚&lt;strong>å‘½åç©ºé—´&lt;/strong>æ˜¯å°†é›†ç¾¤çš„é€»è¾‘åˆ†åŒºåˆ›å»ºä¸ºéš”ç¦»åˆ‡ç‰‡çš„å¥½æ–¹æ³•ï¼Œä½†è¿™ä¸è¶³ä»¥å®‰å…¨åœ°éš”ç¦»å®¢æˆ·ï¼Œæˆ‘ä»¬éœ€è¦å¼ºåˆ¶æ‰§è¡Œç½‘ç»œç­–ç•¥ã€é…é¢ç­‰ã€‚ä½ å¯ä»¥ä¸ºæ¯ä¸ªåç§°ç©ºé—´åˆ›å»ºç½‘ç»œç­–ç•¥å’Œè§„åˆ™ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªéš¾ä»¥æ‰©å±•çš„ä¹å‘³è¿‡ç¨‹ã€‚æ­¤å¤–ï¼Œç§Ÿæˆ·å°†ä¸èƒ½ä½¿ç”¨å¤šä¸ªå‘½åç©ºé—´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é™åˆ¶ã€‚&lt;/p>
&lt;p>åˆ›å»º&lt;strong>åˆ†å±‚å‘½åç©ºé—´&lt;/strong>æ˜¯ä¸ºäº†å…‹æœå…¶ä¸­ä¸€äº›é—®é¢˜ã€‚è¿™ä¸ªæƒ³æ³•æ˜¯ä¸ºæ¯ä¸ªç§Ÿæˆ·æ‹¥æœ‰ä¸€ä¸ªçˆ¶å‘½åç©ºé—´ï¼Œä¸ºç§Ÿæˆ·æä¾›å…¬å…±ç½‘ç»œç­–ç•¥å’Œé…é¢ï¼Œå¹¶å…è®¸åˆ›å»ºå­å‘½åç©ºé—´ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ”¹è¿›ï¼Œä½†å®ƒåœ¨å®‰å…¨å’Œæ²»ç†æ–¹é¢æ²¡æœ‰å¯¹ç§Ÿæˆ·çš„æœ¬åœ°æ”¯æŒã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æ²¡æœ‰è¾¾åˆ°ç”Ÿäº§çŠ¶æ€ï¼Œä½† 1.0 ç‰ˆé¢„è®¡å°†åœ¨æœªæ¥å‡ ä¸ªæœˆå†…å‘å¸ƒã€‚&lt;/p>
&lt;p>å½“å‰è§£å†³æ­¤é—®é¢˜çš„å¸¸ç”¨æ–¹æ³•æ˜¯ä¸ºæ¯ä¸ªå®¢æˆ·åˆ›å»ºä¸€ä¸ªé›†ç¾¤ï¼Œè¿™æ˜¯å®‰å…¨çš„å¹¶æä¾›ç§Ÿæˆ·æ‰€éœ€çš„ä¸€åˆ‡ï¼Œä½†è¿™å¾ˆéš¾ç®¡ç†ä¸”éå¸¸æ˜‚è´µã€‚&lt;/p>
&lt;p>&lt;a href="https://github.com/clastix/capsule">&lt;strong>Capsule&lt;/strong>&lt;/a> æ˜¯ä¸€ç§ä¸ºå•ä¸ªé›†ç¾¤ä¸­çš„å¤šä¸ªç§Ÿæˆ·æä¾›åŸç”Ÿ Kubernetes æ”¯æŒçš„å·¥å…·ã€‚ä½¿ç”¨ Capsuleï¼Œä½ å¯ä»¥ä¸ºæ‰€æœ‰ç§Ÿæˆ·æ‹¥æœ‰ä¸€ä¸ªé›†ç¾¤ã€‚Capsule å°†ä¸ºç§Ÿæˆ·æä¾› â€œå‡ ä¹â€ åŸç”Ÿä½“éªŒï¼ˆæœ‰ä¸€äº›å°é™åˆ¶ï¼‰ï¼Œä»–ä»¬å°†èƒ½å¤Ÿåˆ›å»ºå¤šä¸ªå‘½åç©ºé—´å¹¶ä½¿ç”¨é›†ç¾¤ï¼Œå› ä¸ºå®ƒä»¬å®Œå…¨å¯ç”¨ï¼Œéšè—äº†é›†ç¾¤å®é™…ä¸Šæ˜¯å…±äº«çš„äº‹å®ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/15/16263070902872.jpg" alt="Capsule æ¶æ„">&lt;/p>
&lt;p>åœ¨å•ä¸ªé›†ç¾¤ä¸­ï¼ŒCapsule Controller åœ¨ç§°ä¸º &lt;strong>Tenant&lt;/strong> çš„è½»é‡çº§ Kubernetes æŠ½è±¡ä¸­èšåˆå¤šä¸ªå‘½åç©ºé—´ï¼Œè¿™æ˜¯ä¸€ç»„ Kubernetes å‘½åç©ºé—´ã€‚åœ¨æ¯ä¸ªç§Ÿæˆ·å†…ï¼Œç”¨æˆ·å¯ä»¥è‡ªç”±åˆ›å»ºä»–ä»¬çš„å‘½åç©ºé—´å¹¶å…±äº«æ‰€æœ‰åˆ†é…çš„èµ„æºï¼Œè€Œç­–ç•¥å¼•æ“åˆ™ä½¿ä¸åŒçš„ç§Ÿæˆ·å½¼æ­¤éš”ç¦»ã€‚&lt;/p>
&lt;p>ç§Ÿæˆ·çº§åˆ«å®šä¹‰çš„ç½‘ç»œå’Œå®‰å…¨ç­–ç•¥ã€èµ„æºé…é¢ã€é™åˆ¶èŒƒå›´ã€RBAC å’Œå…¶ä»–ç­–ç•¥ç”±ç§Ÿæˆ·ä¸­çš„æ‰€æœ‰å‘½åç©ºé—´è‡ªåŠ¨ç»§æ‰¿ï¼Œç±»ä¼¼äºåˆ†å±‚å‘½åç©ºé—´ã€‚ç„¶åç”¨æˆ·å¯ä»¥è‡ªç”±åœ°è‡ªæ²»æ“ä½œä»–ä»¬çš„ç§Ÿæˆ·ï¼Œè€Œæ— éœ€é›†ç¾¤ç®¡ç†å‘˜çš„å¹²é¢„ã€‚
Capsule æ˜¯ GitOps å°±ç»ªçš„ï¼Œå› ä¸ºå®ƒæ˜¯å£°æ˜æ€§çš„ï¼Œå¹¶ä¸”æ‰€æœ‰é…ç½®éƒ½å¯ä»¥å­˜å‚¨åœ¨ Git ä¸­ã€‚&lt;/p>
&lt;h2 id="vcluster">vCluster&lt;/h2>
&lt;p>&lt;a href="https://www.vcluster.com/">vCluster&lt;/a> åœ¨å¤šç§Ÿæˆ·æ–¹é¢æ›´è¿›äº†ä¸€æ­¥ï¼Œå®ƒåœ¨ Kubernetes é›†ç¾¤å†…æä¾›äº†è™šæ‹Ÿé›†ç¾¤ã€‚æ¯ä¸ªé›†ç¾¤éƒ½åœ¨ä¸€ä¸ªå¸¸è§„å‘½åç©ºé—´ä¸Šè¿è¡Œï¼Œå¹¶ä¸”æ˜¯å®Œå…¨éš”ç¦»çš„ã€‚è™šæ‹Ÿé›†ç¾¤æœ‰è‡ªå·±çš„ API æœåŠ¡å™¨å’Œç‹¬ç«‹çš„æ•°æ®å­˜å‚¨ï¼Œæ‰€ä»¥ä½ åœ¨ vCluster ä¸­åˆ›å»ºçš„æ¯ä¸ª Kubernetes å¯¹è±¡éƒ½åªå­˜åœ¨äº vcluster å†…éƒ¨ã€‚æ­¤å¤–ï¼Œæ‚¨å¯ä»¥å°† kube ä¸Šä¸‹æ–‡ä¸è™šæ‹Ÿé›†ç¾¤ä¸€èµ·ä½¿ç”¨ï¼Œä»¥åƒä½¿ç”¨å¸¸è§„é›†ç¾¤ä¸€æ ·ä½¿ç”¨å®ƒä»¬ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/15/16263071651487.jpg" alt="">&lt;/p>
&lt;p>åªè¦æ‚¨å¯ä»¥åœ¨å•ä¸ªå‘½åç©ºé—´å†…åˆ›å»ºéƒ¨ç½²ï¼Œæ‚¨å°±å¯ä»¥åˆ›å»ºè™šæ‹Ÿé›†ç¾¤å¹¶æˆä¸ºè¯¥è™šæ‹Ÿé›†ç¾¤çš„ç®¡ç†å‘˜ï¼Œç§Ÿæˆ·å¯ä»¥åˆ›å»ºå‘½åç©ºé—´ã€å®‰è£… CRDã€é…ç½®æƒé™ç­‰ç­‰ã€‚&lt;/p>
&lt;p>&lt;strong>vCluster&lt;/strong> ä½¿ç”¨ &lt;a href="https://k3s.io/">&lt;strong>k3s&lt;/strong>&lt;/a> ä½œä¸ºå…¶ API æœåŠ¡å™¨ï¼Œä½¿è™šæ‹Ÿé›†ç¾¤è¶…è½»é‡çº§ä¸”ç»æµé«˜æ•ˆï¼›ç”±äº k3s é›†ç¾¤ 100% åˆè§„ï¼Œè™šæ‹Ÿé›†ç¾¤ä¹Ÿ 100% åˆè§„ã€‚&lt;strong>vClusters&lt;/strong> æ˜¯è¶…è½»é‡çº§çš„ï¼ˆ1 ä¸ª podï¼‰ï¼Œæ¶ˆè€—å¾ˆå°‘çš„èµ„æºå¹¶ä¸”å¯ä»¥åœ¨ä»»ä½• Kubernetes é›†ç¾¤ä¸Šè¿è¡Œï¼Œè€Œæ— éœ€å¯¹åº•å±‚é›†ç¾¤è¿›è¡Œç‰¹æƒè®¿é—®ã€‚ä¸ &lt;strong>Capsule&lt;/strong> ç›¸æ¯”ï¼Œå®ƒç¡®å®ä½¿ç”¨äº†æ›´å¤šçš„èµ„æºï¼Œä½†å®ƒæä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå› ä¸ºå¤šç§Ÿæˆ·åªæ˜¯ç”¨ä¾‹ä¹‹ä¸€ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/15/16263072079021.jpg" alt="">&lt;/p>
&lt;h2 id="å…¶ä»–å·¥å…·">å…¶ä»–å·¥å…·&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://github.com/cloud-bulldozer/kube-burner">kube-burner&lt;/a> ç”¨äº&lt;strong>å‹åŠ›æµ‹è¯•&lt;/strong>ã€‚å®ƒæä¾›æŒ‡æ ‡å’Œè­¦æŠ¥ã€‚&lt;/li>
&lt;li>æ··æ²Œå·¥ç¨‹çš„ &lt;a href="https://github.com/litmuschaos/litmus">Litmus&lt;/a>ã€‚&lt;/li>
&lt;li>&lt;a href="https://github.com/bitnami-labs/kubewatch">kubewatch&lt;/a> ç”¨äºç›‘æ§ï¼Œä½†ä¸»è¦å…³æ³¨åŸºäº Kubernetes äº‹ä»¶ï¼ˆå¦‚èµ„æºåˆ›å»ºæˆ–åˆ é™¤ï¼‰çš„æ¨é€é€šçŸ¥ã€‚å®ƒå¯ä»¥ä¸ Slack ç­‰è®¸å¤šå·¥å…·é›†æˆã€‚&lt;/li>
&lt;li>&lt;a href="https://www.botkube.io/">BotKube&lt;/a> æ˜¯ä¸€ä¸ªæ¶ˆæ¯æœºå™¨äººï¼Œç”¨äºç›‘æ§å’Œè°ƒè¯• Kubernetes é›†ç¾¤ã€‚ä¸ kubewatch ç±»ä¼¼ï¼Œä½†æ›´æ–°å¹¶å…·æœ‰æ›´å¤šåŠŸèƒ½ã€‚&lt;/li>
&lt;li>&lt;a href="https://getmizu.io/">Mizu&lt;/a> æ˜¯ä¸€ä¸ª API æµé‡æŸ¥çœ‹å™¨å’Œè°ƒè¯•å™¨ã€‚&lt;/li>
&lt;li>&lt;a href="https://github.com/senthilrch/kube-fledged">kube-fledged&lt;/a> æ˜¯ä¸€ä¸ª Kubernetes æ’ä»¶ï¼Œç”¨äºç›´æ¥åœ¨ Kubernetes é›†ç¾¤çš„å·¥ä½œèŠ‚ç‚¹ä¸Šåˆ›å»ºå’Œç®¡ç†å®¹å™¨é•œåƒçš„ç¼“å­˜ã€‚å› æ­¤ï¼Œ&lt;strong>åº”ç”¨ç¨‹åº pod å‡ ä¹ç«‹å³å¯åŠ¨&lt;/strong>ï¼Œå› ä¸ºä¸éœ€è¦ä»æ³¨å†Œè¡¨ä¸­æå–å›¾åƒã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å›é¡¾äº†æˆ‘æœ€å–œæ¬¢çš„ Kubernetes å·¥å…·ã€‚æˆ‘ä¸“æ³¨äºå¯ä»¥åˆå¹¶åˆ°ä»»ä½• Kubernetes å‘è¡Œç‰ˆä¸­çš„å¼€æºé¡¹ç›®ã€‚æˆ‘æ²¡æœ‰æ¶µç›–è¯¸å¦‚ &lt;a href="https://www.openshift.com/">OpenShift&lt;/a> æˆ– Cloud Providers Add-Ons ä¹‹ç±»çš„å•†ä¸šè§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºæˆ‘æƒ³è®©å®ƒä¿æŒé€šç”¨æ€§ï¼Œä½†æˆ‘é¼“åŠ±æ‚¨æ¢ç´¢å¦‚æœæ‚¨åœ¨äº‘ä¸Šè¿è¡Œ Kubernetes æˆ–ä½¿ç”¨å•†ä¸šå·¥å…·ï¼Œæ‚¨çš„äº‘æä¾›å•†å¯ä»¥ä¸ºæ‚¨æä¾›ä»€ä¹ˆã€‚&lt;/p>
&lt;p>æˆ‘çš„ç›®æ ‡æ˜¯å‘æ‚¨å±•ç¤ºæ‚¨å¯ä»¥åœ¨ &lt;strong>Kubernetes&lt;/strong> ä¸­å®Œæˆæ‚¨åœ¨æœ¬åœ°æ‰€åšçš„ä¸€åˆ‡ã€‚æˆ‘è¿˜æ›´å¤šåœ°å…³æ³¨é²œä¸ºäººçŸ¥çš„å·¥å…·ï¼Œæˆ‘è®¤ä¸ºè¿™äº›å·¥å…·å¯èƒ½å…·æœ‰å¾ˆå¤§çš„æ½œåŠ›ï¼Œä¾‹å¦‚ &lt;a href="https://crossplane.io/">Crossplane&lt;/a>ã€&lt;a href="https://kubevela.io/">Argo Rollouts&lt;/a>æˆ– &lt;a href="https://kubevela.io/">Kubevela&lt;/a>ã€‚æˆ‘æ›´æ„Ÿå…´è¶£çš„å·¥å…·æ˜¯ &lt;a href="https://www.vcluster.com/">vCluster&lt;/a>ã€&lt;a href="https://crossplane.io/">Crossplane&lt;/a> å’Œ ArgoCD/Workflowsã€‚&lt;/p></description></item><item><title>Rego ä¸å¥½ç”¨ï¼Ÿç”¨ Pipy å®ç° OPA</title><link>https://atbug.com/pipy-implement-kubernetes-admission-control/</link><pubDate>Tue, 13 Jul 2021 08:44:56 +0800</pubDate><guid>https://atbug.com/pipy-implement-kubernetes-admission-control/</guid><description>
&lt;p>è¿˜ä¸çŸ¥é“ Pipy æ˜¯ä»€ä¹ˆçš„åŒå­¦å¯ä»¥çœ‹ä¸‹ &lt;a href="https://github.com/flomesh-io/pipy">GitHub&lt;/a> ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Pipy æ˜¯ä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½ã€é«˜ç¨³å®šã€å¯ç¼–ç¨‹çš„ç½‘ç»œä»£ç†ã€‚Pipy æ ¸å¿ƒæ¡†æ¶ä½¿ç”¨ C++ å¼€å‘ï¼Œç½‘ç»œ IO é‡‡ç”¨ ASIO åº“ã€‚ Pipy çš„å¯æ‰§è¡Œæ–‡ä»¶ä»…æœ‰ 5M å·¦å³ï¼Œè¿è¡ŒæœŸçš„å†…å­˜å ç”¨ 10M å·¦å³ï¼Œå› æ­¤ Pipy éå¸¸é€‚åˆåš Sidecar proxyã€‚&lt;/p>
&lt;p>Pipy å†…ç½®äº†è‡ªç ”çš„ pjs ä½œä¸ºè„šæœ¬æ‰©å±•ï¼Œä½¿å¾—Pipy å¯ä»¥ç”¨ JS è„šæœ¬æ ¹æ®ç‰¹å®šéœ€æ±‚å¿«é€Ÿå®šåˆ¶é€»è¾‘ä¸åŠŸèƒ½ã€‚&lt;/p>
&lt;p>Pipy é‡‡ç”¨äº†æ¨¡å—åŒ–ã€é“¾å¼çš„å¤„ç†æ¶æ„ï¼Œç”¨é¡ºåºæ‰§è¡Œçš„æ¨¡å—æ¥å¯¹ç½‘ç»œæ•°æ®å—è¿›è¡Œå¤„ç†ã€‚è¿™ç§ç®€å•çš„æ¶æ„ä½¿å¾— Pipy åº•å±‚ç®€å•å¯é ï¼ŒåŒæ—¶å…·å¤‡äº†åŠ¨æ€ç¼–æ’æµé‡çš„èƒ½åŠ›ï¼Œå…¼é¡¾äº†ç®€å•å’Œçµæ´»ã€‚é€šè¿‡ä½¿ç”¨ REUSE_PORT çš„æœºåˆ¶ï¼ˆä¸»æµ Linux å’Œ BSD ç‰ˆæœ¬éƒ½æ”¯æŒè¯¥åŠŸèƒ½ï¼‰ï¼ŒPipy å¯ä»¥ä»¥å¤šè¿›ç¨‹æ¨¡å¼è¿è¡Œï¼Œä½¿å¾— Pipy ä¸ä»…é€‚ç”¨äº Sidecar æ¨¡å¼ï¼Œä¹Ÿé€‚ç”¨äºå¤§è§„æ¨¡çš„æµé‡å¤„ç†åœºæ™¯ã€‚ åœ¨å®è·µä¸­ï¼ŒPipy ç‹¬ç«‹éƒ¨ç½²çš„æ—¶å€™ç”¨ä½œâ€œè½¯è´Ÿè½½â€ï¼Œå¯ä»¥åœ¨ä½å»¶è¿Ÿçš„æƒ…å†µä¸‹ï¼Œå®ç°åª²ç¾ç¡¬ä»¶çš„è´Ÿè½½å‡è¡¡ååèƒ½åŠ›ï¼ŒåŒæ—¶å…·æœ‰çµæ´»çš„æ‰©å±•æ€§ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨ç©è¿‡å‡ æ¬¡ Pipy å¹¶æ¢ç©¶å…¶å·¥ä½œåŸç†åï¼Œåˆæœ‰äº†æ›´å¤šçš„æƒ³æ³•ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/l8JzYRn350fjuCAOoo8pcg">åˆæ¢å¯ç¼–ç¨‹ç½‘å…³ Pipy&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/_IeRXp9EJnVsvDfg8tUr1A">å¯ç¼–ç¨‹ç½‘å…³ Pipy ç¬¬äºŒå¼¹ï¼šç¼–ç¨‹å®ç° Metrics åŠæºç è§£è¯»&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/iQWunpazsw86X3kEkB1rJw">å¯ç¼–ç¨‹ç½‘å…³ Pipy ç¬¬ä¸‰å¼¹ï¼šäº‹ä»¶æ¨¡å‹è®¾è®¡&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>åœ¨ä½¿ç”¨OPAçš„æ—¶å€™ï¼Œä¸€ç›´è§‰å¾—Regoä¸æ˜¯é‚£ä¹ˆé¡ºæ‰‹ï¼Œä½¿ç”¨pipy jsæ¥å†™è§„åˆ™çš„æƒ³æ³•æ²¹ç„¶è€Œç”Ÿã€‚ä»Šå¤©å°±ä¸€èµ·è¯•è¯•è¿™ä¸ªæ€è·¯ã€‚æœç„¶ï¼Œä¸è¯•ä¸çŸ¥é“ï¼Œä¸€è¯•å‘ç°å¤ªå¤šçš„æƒŠå–œï½Pipyä¸æ­¢äºâ€œä»£ç†â€ï¼Œæ›´æœ‰å¾ˆå¤šå¯ä»¥é€‚ç”¨çš„åœºæ™¯ï¼š&lt;/p>
&lt;ul>
&lt;li>æå°çš„å•ä¸€å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆsingle binaryï¼‰ä½¿å¾— pipy å¯èƒ½æ˜¯æœ€å¥½çš„ â€œäº‘åŸç”Ÿ sidecarâ€&lt;/li>
&lt;li>sidecar ä¸ä»…ä»…æ˜¯ä»£ç†ï¼Œè¿˜å¯ä»¥åšæ§åˆ¶å™¨ï¼Œåšè¿ç®—å•å…ƒ&lt;/li>
&lt;li>proxy çš„ä¸²è·¯ç»“æ„é€‚åˆå„ç§ç®¡æ§ç±»çš„æ“ä½œï¼Œæ¯”å¦‚è®¿é—®æ§åˆ¶&lt;/li>
&lt;li>Pipy js çš„æ‰©å±•èƒ½åŠ›å’Œå¿«é€Ÿç¼–ç¨‹èƒ½åŠ›ï¼Œå¾ˆé€‚åˆåš â€œè§„åˆ™å¼•æ“â€ï¼Œæˆ–è€…ç”¨æœ€è¿‘æµè¡Œçš„è¯´æ³• â€œäº‘åŸç”Ÿçš„è§„åˆ™å¼•æ“â€ã€‚å¯¹æ¯” OPA æˆ‘è®¤ä¸ºå®ƒå®Œå…¨å¤Ÿæ ¼åšä¸€ä¸ª â€œç¾½é‡çº§è§„åˆ™æ‰§è¡Œå¼•æ“â€&lt;/li>
&lt;/ul>
&lt;p>ç°åœ¨æˆ‘æ›´å€¾å‘äºå®šä¹‰ pipy æ˜¯ä¸€ä¸ª â€œäº‘åŸç”Ÿçš„æµé‡ç¼–ç¨‹æ¡†æ¶â€ï¼Œä»£ç†åªæ˜¯å…¶åº•å±‚çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œå åŠ äº† pipy js ä»¥åï¼Œä¸Šå±‚å¯ä»¥åšçš„äº‹æƒ…å¾ˆå¤šï¼Œâ€œæµé‡æ»‹å…»ä¸‡ç‰©â€ã€‚&lt;/p>
&lt;p>åœ¨ &lt;a href="https://mp.weixin.qq.com/s/RvqCVAhClJY3o_46ALu1bQ">ä½¿ç”¨ Open Policy Agent å®ç°å¯ä¿¡é•œåƒä»“åº“æ£€æŸ¥&lt;/a> ä¹‹åï¼Œå°±åœ¨æƒ³ Pipy æ˜¯å¦ä¸€æ ·å¯ä»¥åšåˆ°ï¼Œå°†å†…æ ¸æ›¿æ¢æˆ Pipy + è§„åˆ™ã€‚æ‰€ä»¥ä»Šå¤©å¤§éƒ¨åˆ†å†…å®¹å’Œä¸Šé¢è¿™ç¯‡æ˜¯ç›¸ä¼¼çš„ã€‚&lt;/p>
&lt;p>æ¥ï¼Œä¸€èµ·çœ‹çœ‹è¿™ä¸ªâ€œä¸åŠ¡æ­£ä¸šâ€çš„ Pipy å¦‚ä½•å®ç° Kubernetes çš„å‡†å…¥æ§åˆ¶å™¨ æ¥åšé•œåƒçš„æ£€æŸ¥ã€‚&lt;/p>
&lt;h2 id="ç¯å¢ƒ">ç¯å¢ƒ&lt;/h2>
&lt;p>ç»§ç»­ä½¿ç”¨ minikube&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube start
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆ›å»ºéƒ¨ç½²-pipy-çš„å‘½åç©ºé—´">åˆ›å»ºéƒ¨ç½² Pipy çš„å‘½åç©ºé—´&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create namespace pipy
kubens pipy
kubectl label ns pipy pipy/webhook&lt;span class="o">=&lt;/span>ignore &lt;span class="c1">#åé¢è§£é‡Š&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="è§„åˆ™">è§„åˆ™&lt;/h2>
&lt;p>åœ¨ OPA ä¸­ï¼Œé€šè¿‡ &lt;code>kube-mgmt&lt;/code> å®¹å™¨ç›‘æ§ &lt;code>configmap&lt;/code> çš„æ”¹åŠ¨ï¼Œå°† Policy æ¨é€åˆ°åŒ pod çš„ opa å®¹å™¨ä¸­ã€‚&lt;/p>
&lt;p>å¯¹äº Pipy ä¸ºäº†æ¸å˜ï¼Œç›´æ¥ä½¿ç”¨æŒ‚è½½çš„æ–¹å¼å°†ä¿å­˜äº†è§„åˆ™çš„ &lt;code>configmap&lt;/code> æŒ‚è½½åˆ° Pipy
çš„å®¹å™¨ä¸­ã€‚&lt;/p>
&lt;p>&lt;em>å®é™…çš„ä½¿ç”¨ä¸­ï¼ŒPipy æ”¯æŒè½®è®­çš„æ–¹å¼æ£€æŸ¥æ§åˆ¶å¹³é¢ä¸­è§„åˆ™çš„å˜æ›´ï¼Œå¹¶å®æ—¶åŠ è½½ï¼›ä¹Ÿå¯ä»¥å®ç°ä¸ OPA çš„ kube-mgmt åŒæ ·çš„é€»è¾‘ã€‚&lt;/em>&lt;/p>
&lt;p>å®ç°äº†&lt;a href="https://atbug.com/image-trusted-repository-with-open-policy-agent/">ä¸Šä¸€è®²åŠŸèƒ½&lt;/a>çš„ pipy è§„åˆ™å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">cat &amp;gt; pipy-rule.js &lt;span class="s">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;span class="s">pipy({
&lt;/span>&lt;span class="s"> _repoPrefix: &amp;#39;192.168.64.1&amp;#39;, //192.168.64.1:5000 æ˜¯ç¬”è€…æœ¬åœ°å®¹å™¨è¿è¡Œçš„ä¸€ä¸ªç§æœ‰ä»“åº“ã€‚
&lt;/span>&lt;span class="s"> _tagSuffix: &amp;#39;:latest&amp;#39;,
&lt;/span>&lt;span class="s">})
&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">.listen(6443, {
&lt;/span>&lt;span class="s"> tls: {
&lt;/span>&lt;span class="s"> cert: os.readFile(&amp;#39;/certs/tls.crt&amp;#39;).toString(),
&lt;/span>&lt;span class="s"> key: os.readFile(&amp;#39;/certs/tls.key&amp;#39;).toString(),
&lt;/span>&lt;span class="s"> },
&lt;/span>&lt;span class="s">})
&lt;/span>&lt;span class="s"> .decodeHttpRequest()
&lt;/span>&lt;span class="s"> .replaceMessage(
&lt;/span>&lt;span class="s"> msg =&amp;gt; (
&lt;/span>&lt;span class="s"> ((req, result, invalids, reason) =&amp;gt; (
&lt;/span>&lt;span class="s"> req = JSON.decode(msg.body),
&lt;/span>&lt;span class="s"> invalids = req.request.object.spec.containers.find(container =&amp;gt; (
&lt;/span>&lt;span class="s"> (!container.image.startsWith(_repoPrefix) ? (
&lt;/span>&lt;span class="s"> reason = `${container.image} repo not start with ${_repoPrefix}`,
&lt;/span>&lt;span class="s"> console.log(reason),
&lt;/span>&lt;span class="s"> true
&lt;/span>&lt;span class="s"> ) : (false))
&lt;/span>&lt;span class="s"> ||
&lt;/span>&lt;span class="s"> (container.image.endsWith(_tagSuffix) ? (
&lt;/span>&lt;span class="s"> reason = `${container.image} tag end with ${_tagSuffix}`,
&lt;/span>&lt;span class="s"> console.log(reason),
&lt;/span>&lt;span class="s"> true
&lt;/span>&lt;span class="s"> ) : (false)
&lt;/span>&lt;span class="s"> ))),
&lt;/span>&lt;span class="s"> invalids != undefined ? (
&lt;/span>&lt;span class="s"> result = {
&lt;/span>&lt;span class="s"> &amp;#34;apiVersion&amp;#34;: &amp;#34;admission.k8s.io/v1beta1&amp;#34;,
&lt;/span>&lt;span class="s"> &amp;#34;kind&amp;#34;: &amp;#34;AdmissionReview&amp;#34;,
&lt;/span>&lt;span class="s"> &amp;#34;response&amp;#34;: {
&lt;/span>&lt;span class="s"> &amp;#34;allowed&amp;#34;: false,
&lt;/span>&lt;span class="s"> &amp;#34;uid&amp;#34;: req.request.uid,
&lt;/span>&lt;span class="s"> &amp;#34;status&amp;#34;: {
&lt;/span>&lt;span class="s"> &amp;#34;reason&amp;#34;: reason,
&lt;/span>&lt;span class="s"> },
&lt;/span>&lt;span class="s"> },
&lt;/span>&lt;span class="s"> }
&lt;/span>&lt;span class="s"> ) : (
&lt;/span>&lt;span class="s"> result = {
&lt;/span>&lt;span class="s"> &amp;#34;apiVersion&amp;#34;: &amp;#34;admission.k8s.io/v1beta1&amp;#34;,
&lt;/span>&lt;span class="s"> &amp;#34;kind&amp;#34;: &amp;#34;AdmissionReview&amp;#34;,
&lt;/span>&lt;span class="s"> &amp;#34;response&amp;#34;: {
&lt;/span>&lt;span class="s"> &amp;#34;allowed&amp;#34;: true,
&lt;/span>&lt;span class="s"> &amp;#34;uid&amp;#34;: req.request.uid
&lt;/span>&lt;span class="s"> },
&lt;/span>&lt;span class="s"> }
&lt;/span>&lt;span class="s"> ),
&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s"> console.log(JSON.encode(result)),
&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s"> new Message({
&lt;/span>&lt;span class="s"> &amp;#39;status&amp;#39; : 200,
&lt;/span>&lt;span class="s"> &amp;#39;headers&amp;#39;: {
&lt;/span>&lt;span class="s"> &amp;#39;Content-Type&amp;#39;: &amp;#39;application/json&amp;#39;
&lt;/span>&lt;span class="s"> }
&lt;/span>&lt;span class="s"> }, JSON.encode(result))
&lt;/span>&lt;span class="s"> ))()
&lt;/span>&lt;span class="s"> )
&lt;/span>&lt;span class="s"> )
&lt;/span>&lt;span class="s"> .encodeHttpResponse()
&lt;/span>&lt;span class="s">EOF&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°†è§„åˆ™ä¿å­˜åœ¨ configmap ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create configmap pipy-rule --from-file&lt;span class="o">=&lt;/span>pipy-rule.js
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åœ¨-kubernetes-ä¸Šéƒ¨ç½²-pipy">åœ¨ Kubernetes ä¸Šéƒ¨ç½² Pipy&lt;/h2>
&lt;p>Kubernetes ä¸å‡†å…¥æ§åˆ¶å™¨ï¼ˆ&lt;a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/">Admission Controller&lt;/a>ï¼‰çš„é€šä¿¡éœ€è¦ä½¿ç”¨ TLSã€‚é…ç½® TLSï¼Œä½¿ç”¨ &lt;code>openssl&lt;/code> åˆ›å»ºè¯ä¹¦é¢å‘æœºæ„ï¼ˆcertificate authority CAï¼‰å’Œ OPA çš„è¯ä¹¦/ç§˜é’¥å¯¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">openssl genrsa -out ca.key &lt;span class="m">2048&lt;/span>
openssl req -x509 -new -nodes -key ca.key -days &lt;span class="m">100000&lt;/span> -out ca.crt -subj &lt;span class="s2">&amp;#34;/CN=admission_ca&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸º OPA åˆ›å»º TLS ç§˜é’¥å’Œè¯ä¹¦ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">cat &amp;gt;server.conf &lt;span class="s">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;span class="s">[req]
&lt;/span>&lt;span class="s">req_extensions = v3_req
&lt;/span>&lt;span class="s">distinguished_name = req_distinguished_name
&lt;/span>&lt;span class="s">prompt = no
&lt;/span>&lt;span class="s">[req_distinguished_name]
&lt;/span>&lt;span class="s">CN = pipy.pipy.svc
&lt;/span>&lt;span class="s">[ v3_req ]
&lt;/span>&lt;span class="s">basicConstraints = CA:FALSE
&lt;/span>&lt;span class="s">keyUsage = nonRepudiation, digitalSignature, keyEncipherment
&lt;/span>&lt;span class="s">extendedKeyUsage = clientAuth, serverAuth
&lt;/span>&lt;span class="s">subjectAltName = @alt_names
&lt;/span>&lt;span class="s">[alt_names]
&lt;/span>&lt;span class="s">DNS.1 = pipy.pipy.svc
&lt;/span>&lt;span class="s">EOF&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>æ³¨æ„ &lt;code>CN&lt;/code> å’Œ &lt;code>alt_names&lt;/code> å¿…é¡»ä¸åé¢åˆ›å»º Pipy service çš„åŒ¹é…ã€‚&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">openssl genrsa -out server.key &lt;span class="m">2048&lt;/span>
openssl req -new -key server.key -out server.csr -config server.conf
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days &lt;span class="m">100000&lt;/span> -extensions v3_req -extfile server.conf
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸º OPA åˆ›å»ºä¿å­˜ TLS å‡­è¯çš„ Secretï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create secret tls pipy-server --cert&lt;span class="o">=&lt;/span>server.crt --key&lt;span class="o">=&lt;/span>server.key
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°† Pipy éƒ¨ç½²ä¸ºå‡†å…¥æ§åˆ¶å™¨ï¼ˆadmission controllerï¼‰ã€‚ä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œæˆ‘ä»¬ä½¿ç”¨å¯åŠ¨ Pipy çš„æ—¶å€™æ‰“å¼€äº†æ§åˆ¶å°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">443&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">6443&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gui&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># æ–¹ä¾¿è°ƒè¯•&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">6060&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">6060&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">6080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">6080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">IfNotPresent&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;pipy&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;/opt/data/pipy-rule.js&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;--gui-port=6060&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># æ–¹ä¾¿è°ƒè¯•&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># - &amp;#34;--log-level=debug&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gui&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containerPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">6060&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containerPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">6080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP &lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containerPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">6443&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">readOnly&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/certs&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">readOnly&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/opt/data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy-rule&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secret&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy-rule&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">configMap&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipy-rule&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æš´éœ²æ§åˆ¶å°çš„è®¿é—®ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl expose deploy pipy --name pipy-node --type NodePort
kubectl get svc pipy-port
minikube service --url pipy-node -n pipy
&lt;span class="c1"># æ‰¾åˆ°æ§åˆ¶å°ç«¯å£&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ä¸‹æ¥ï¼Œç”Ÿæˆå°†ç”¨äºå°† Pipy æ³¨å†Œä¸ºå‡†å…¥æ§åˆ¶å™¨çš„ manifestã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">cat &amp;gt; webhook-configuration.yaml &lt;span class="s">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;span class="s">kind: ValidatingWebhookConfiguration
&lt;/span>&lt;span class="s">apiVersion: admissionregistration.k8s.io/v1beta1
&lt;/span>&lt;span class="s">metadata:
&lt;/span>&lt;span class="s"> name: pipy-validating-webhook
&lt;/span>&lt;span class="s">webhooks:
&lt;/span>&lt;span class="s"> - name: validating-webhook.pipy.flomesh-io.cn
&lt;/span>&lt;span class="s"> namespaceSelector:
&lt;/span>&lt;span class="s"> matchExpressions:
&lt;/span>&lt;span class="s"> - key: pipy/webhook
&lt;/span>&lt;span class="s"> operator: NotIn
&lt;/span>&lt;span class="s"> values:
&lt;/span>&lt;span class="s"> - ignore
&lt;/span>&lt;span class="s"> rules:
&lt;/span>&lt;span class="s"> - operations: [&amp;#34;CREATE&amp;#34;, &amp;#34;UPDATE&amp;#34;]
&lt;/span>&lt;span class="s"> apiGroups: [&amp;#34;*&amp;#34;]
&lt;/span>&lt;span class="s"> apiVersions: [&amp;#34;*&amp;#34;]
&lt;/span>&lt;span class="s"> resources: [&amp;#34;pods&amp;#34;]
&lt;/span>&lt;span class="s"> clientConfig:
&lt;/span>&lt;span class="s"> caBundle: $(cat ca.crt | base64 | tr -d &amp;#39;\n&amp;#39;)
&lt;/span>&lt;span class="s"> service:
&lt;/span>&lt;span class="s"> namespace: pipy
&lt;/span>&lt;span class="s"> name: pipy
&lt;/span>&lt;span class="s">EOF&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”Ÿæˆçš„é…ç½®æ–‡ä»¶åŒ…å« CA è¯ä¹¦çš„ base64 ç¼–ç ï¼Œä»¥ä¾¿å¯ä»¥åœ¨ Kubernetes API æœåŠ¡å™¨å’Œ OPA ä¹‹é—´å»ºç«‹ TLS è¿æ¥ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f webhook-configuration.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æµ‹è¯•">æµ‹è¯•&lt;/h2>
&lt;p>&lt;code>pod-bad-repo.yaml&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">web-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">web-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx:1.21.1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">web-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterFirst&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f pod-bad-repo.yaml
Error from server &lt;span class="o">(&lt;/span>nginx:1.21.1 repo not start with 192.168.64.1&lt;span class="o">)&lt;/span>: error when creating &lt;span class="s2">&amp;#34;pod-bad-repo.yaml&amp;#34;&lt;/span>: admission webhook &lt;span class="s2">&amp;#34;validating-webhook.pipy.flomesh-io.cn&amp;#34;&lt;/span> denied the request: nginx:1.21.1 repo not start with 192.168.64.1
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>pod-bad-tag.yaml&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">web-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">web-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">192.168.64.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">5000&lt;/span>&lt;span class="l">/nginx:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">web-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterFirst&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f pod-bad-tag.yaml
Error from server &lt;span class="o">(&lt;/span>192.168.64.1:5000/nginx:latest tag end with :latest&lt;span class="o">)&lt;/span>: error when creating &lt;span class="s2">&amp;#34;pod-bad-tag.yaml&amp;#34;&lt;/span>: admission webhook &lt;span class="s2">&amp;#34;validating-webhook.pipy.flomesh-io.cn&amp;#34;&lt;/span> denied the request: 192.168.64.1:5000/nginx:latest tag end with :latest
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>pod-ok.yaml&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">web-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">web-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">192.168.64.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">5000&lt;/span>&lt;span class="l">/nginx:1.21.1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">web-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterFirst&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f pod-ok.yaml
pod/web-server created
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>OPA å“ªå“ªéƒ½å¥½ï¼Œå”¯ä¸€ç¼ºç‚¹å°±æ˜¯å…¶å¼•è¿›çš„ &lt;code>Rego&lt;/code> è¯­è¨€æŠ¬é«˜äº†ä½¿ç”¨çš„é—¨æ§›ã€‚è€Œ Pipy çš„è§„åˆ™æ˜¯é€šè¿‡ JavaScrip æ¥ç¼–å†™çš„ï¼Œå‰ç«¯çš„åŒå­¦ä¸€æ ·å¯ä»¥å®Œæˆè§„åˆ™çš„ç¼–å†™ã€‚å®Œå…¨æ›¿ä»£å¯èƒ½å¤¸å¼ äº†ä¸€äº›ï¼Œä½†ç¡®å®åœ¨éƒ¨åˆ†åœºæ™¯ä¸‹å¯ä»¥æ›¿ä»£ OPAã€‚&lt;/p>
&lt;p>ç©åˆ°è¿™é‡Œï¼Œä½ ä¼šå‘ç°æœ‰äº†è§„åˆ™ï¼ŒåŠ ä¸ŠåŠŸèƒ½å¼ºå¤§çš„è¿‡æ»¤å™¨ï¼ˆç°åœ¨æˆ‘å–œæ¬¢å«ä»–ä»¬ Hook äº†ï¼‰ï¼ŒPipy çš„å¯ç©æ€§éå¸¸å¼ºã€‚&lt;/p>
&lt;p>æ¯”å¦‚&lt;a href="https://mp.weixin.qq.com/s/lfU3XKP2oAPOLNkxdR2KVg">OPA: Kubernetes å‡†å…¥æ§åˆ¶ç­–ç•¥ Top 5&lt;/a>ï¼Œæ¯”å¦‚&amp;hellip;ã€‚å¤§èƒ†çš„æƒ³è±¡å§ã€‚&lt;/p>
&lt;p>æƒ³å†™ä¸€ä¸ªç³»åˆ—ï¼Œå°±å«â€œå¦‚ä½•æŠŠ Pipy ç©åâ€ï¼Ÿ&lt;/p></description></item><item><title>Kubernetes çš„é­”åŠ›åœ¨äºä¼ä¸šæ ‡å‡†åŒ–ï¼Œè€Œä¸æ˜¯åº”ç”¨ç¨‹åºçš„å¯ç§»æ¤æ€§</title><link>https://atbug.com/translation-kubernetes-magic-is-in-enterprise-standardization-not-app-portability/</link><pubDate>Sun, 11 Jul 2021 08:05:42 +0800</pubDate><guid>https://atbug.com/translation-kubernetes-magic-is-in-enterprise-standardization-not-app-portability/</guid><description>
&lt;p>ç¬”è€…ï¼šKubernetes æŠ½è±¡äº†èµ„æºå’Œå·¥ä½œè´Ÿè½½çš„æ“ä½œæ¨¡å¼ï¼Œç»Ÿä¸€äº†å·¥å…·é›†ï¼Œå®ç°äººæœºæ¥å£çš„æ ‡å‡†åŒ–ã€‚æ­£å¦‚ç±» Docker å·¥å…·æä¾›äº†åº”ç”¨è¿è¡Œæ—¶çš„æ“ä½œæ¨¡å¼ï¼›Spring Framework æä¾›äº† Java åº”ç”¨çš„å¼€å‘æ¨¡å¼ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Kubernetes æ˜¯å…³äºè·¨äº‘çš„æŠ€èƒ½ã€å·¥å…·å’Œå®è·µçš„å¯ç§»æ¤æ€§ã€‚ä¸æ˜¯å·¥ä½œè´Ÿè½½çš„å¯ç§»æ¤æ€§ã€‚ &amp;ndash; Bilgin Lbryam @bibryam&lt;/p>
&lt;/blockquote>
&lt;p>æœ¬æ–‡ç¿»è¯‘è‡ª &lt;a href="https://www.techrepublic.com/google-amp/article/kubernetes-magic-is-in-enterprise-standardization-not-app-portability">Kubernetes magic is in enterprise standardization, not app portability&lt;/a>&lt;/p>
&lt;hr>
&lt;blockquote>
&lt;p>Kubernetes ä¸ä¼šç¥å¥‡åœ°ä½¿ä½ çš„åº”ç”¨ç¨‹åºå…·æœ‰å¯ç§»æ¤æ€§ï¼Œä½†å®ƒå¯èƒ½ä¼šç»™ä½ å¸¦æ¥æ›´å¥½çš„ä¸œè¥¿ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>äº‘ä¸ºä¼ä¸šæä¾›äº†çœ‹ä¼¼æ— é™çš„é€‰æ‹©ã€‚ç„¶è€Œï¼Œæ ¹æ® &lt;a href="https://juju.is/cloud-native-kubernetes-usage-report-2021">Canonical-sponsored çš„ä¸€é¡¹è°ƒæŸ¥&lt;/a>ï¼Œè¿™å¹¶ä¸æ˜¯å¤§å¤šæ•°ä¼ä¸šé‡‡ç”¨ &lt;a href="https://www.techrepublic.com/article/kubernetes-the-smart-persons-guide/">Kubernetes&lt;/a> ç­‰äº‘å‹å¥½æŠ€æœ¯çš„åŸå› ã€‚ç›¸åï¼ŒKubernetes çš„ä¸»è¦ç›®æ ‡æ˜¯æ ‡å‡†åŒ–â€”â€”å¤–è§‚å’Œæ“ä½œä¸å…¶ä»–äººä¸€æ ·ã€‚&lt;/p>
&lt;h2 id="å¯ç§»æ¤æ€§ä¸æ˜¯ç›®æ ‡">å¯ç§»æ¤æ€§ä¸æ˜¯ç›®æ ‡&lt;/h2>
&lt;p>æˆ‘ä¹‹å‰å·²ç»è®¨è®ºè¿‡è¿™ä¸ªé—®é¢˜ï¼Œå‚è€ƒäº† Gartner å…³äº Kubernetes å’Œå¯ç§»æ¤æ€§çš„æŒ‡å—ã€‚è®¸å¤šäººè®¤ä¸º Kubernetesï¼ˆå’Œ&lt;a href="https://www.techrepublic.com/article/containers-the-smart-persons-guide">å®¹å™¨&lt;/a>ï¼‰å¯ä»¥è®©ä»–ä»¬åœ¨äº‘ä¹‹é—´è½»æ¾ç§»æ¤ï¼Œä½†äº‹å®è¯æ˜å¹¶ä¸æ˜¯è¿™æ ·çš„ã€‚æ­£å¦‚ Gartner åˆ†æå¸ˆ &lt;a href="https://blogs.gartner.com/marco-meinardi/2020/09/04/adopting-kubernetes-application-portability-not-good-idea/">Marco Meinardi æ‰€å†™&lt;/a>ï¼Œå½“è¢«é—®åŠå…¬å¸æ˜¯å¦åº”è¯¥é‡‡ç”¨â€œKubernetes ä½¿ä»–ä»¬çš„åº”ç”¨ç¨‹åºå¯ç§»æ¤&amp;hellip;&amp;hellip;ç­”æ¡ˆæ˜¯ï¼šä¸ã€‚â€ å†è¯´ä¸€æ¬¡ï¼Ÿ&lt;/p>
&lt;blockquote>
&lt;p>è°ƒæŸ¥æ˜¾ç¤ºï¼Œ[åœ¨äº‘æä¾›å•†ä¹‹é—´ç§»åŠ¨åº”ç”¨ç¨‹åº] çš„å¯èƒ½æ€§å®é™…ä¸Šéå¸¸ä½ã€‚ä¸€æ—¦éƒ¨ç½²åœ¨ä¾›åº”å•†ä¸­ï¼Œåº”ç”¨ç¨‹åºå¾€å¾€ä¼šç•™åœ¨é‚£é‡Œã€‚è¿™æ˜¯å› ä¸ºæ•°æ®æ¹–éš¾ä»¥ç§»æ¤ä¸”æˆæœ¬é«˜æ˜‚ï¼Œå› æ­¤æœ€ç»ˆæˆä¸ºè¿ç§»çš„é‡å¿ƒã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å› æ­¤ Kubernetes é€šå¸¸ä¸ä¼šè¢«å…¬å¸æ¥å—ï¼Œä»¥å¢å¼ºåº”ç”¨ç¨‹åºçš„å¯ç§»æ¤æ€§ï¼›ç›¸åï¼Œè°ˆè®ºäººå‘˜å¯ç§»æ¤æ€§æˆ–æ¢è¨€ä¹‹ï¼ŒæŠ€èƒ½å¯ç§»æ¤æ€§æ›´æ¥è¿‘äº‹å®ã€‚Weaveworks é¦–å¸­æ‰§è¡Œå®˜äºšå†å…‹è¥¿æ–¯Â·ç†æŸ¥æ£®ï¼ˆAlexis Richardsonï¼‰&lt;a href="https://twitter.com/monadic/status/1302257531025264642">å°†è¿™ä¸ªä¸»é¢˜æ‰“å›å®¶&lt;/a>ï¼š&lt;/p>
&lt;blockquote>
&lt;p>é‡ç‚¹æ˜¯â€œæŠ€èƒ½å¯ç§»æ¤æ€§â€ï¼Œå› ä¸ºä½¿ç”¨æ ‡å‡†æ“ä½œæ¨¡å‹å’Œå·¥å…·é“¾ã€‚å¤§å‹ç»„ç»‡å¸Œæœ›å¼€å‘äººå‘˜ä½¿ç”¨æ ‡å‡†çš„å·¥ä½œæ–¹å¼ï¼Œå› ä¸ºè¿™å¯ä»¥é™ä½åŸ¹è®­æˆæœ¬ï¼Œå¹¶æ¶ˆé™¤å‘˜å·¥åœ¨ä¸åŒé¡¹ç›®ä¹‹é—´è½¬ç§»çš„éšœç¢ã€‚å¦‚æœä½ çš„â€œå¹³å°â€ï¼ˆæˆ–å¤šä¸ªå¹³å°ï¼‰åŸºäºç›¸åŒçš„æ ¸å¿ƒäº‘åŸç”Ÿå·¥å…·é›†ï¼Œé‚£ä¹ˆå®ƒä¹Ÿå¯ä»¥æ›´è½»æ¾ã€æ›´ä¾¿å®œåœ°åº”ç”¨ç­–ç•¥ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>è¿™è®©æˆ‘ä»¬å›åˆ°è§„èŒƒè°ƒæŸ¥ã€‚&lt;/p>
&lt;h2 id="samesies">Samesies&lt;/h2>
&lt;p>å½“è¢«é—®åŠç¡®å®šä¸é‡‡ç”¨ Kubernetes ç­‰äº‘åŸç”ŸæŠ€æœ¯ç›¸å…³çš„æŠ€æœ¯ç›®æ ‡æ—¶ï¼Œè°ƒæŸ¥å—è®¿è€…å°†å¯ç§»æ¤æ€§æ’åœ¨æœ€åï¼Œå°†æ›´ç›´æ¥çš„é—®é¢˜æ’åœ¨ç¬¬ä¸€ä½ï¼š&lt;/p>
&lt;ul>
&lt;li>æ”¹è¿›ç»´æŠ¤ã€ç›‘æ§å’Œè‡ªåŠ¨åŒ– - 64.6%ã€‚&lt;/li>
&lt;li>åŸºç¡€è®¾æ–½ç°ä»£åŒ– - 46.4%ã€‚&lt;/li>
&lt;li>æ›´å¿«çš„ä¸Šçº¿æ—¶é—´ - 26.5%ã€‚&lt;/li>
&lt;li>åˆ é™¤ä¾›åº”å•†ä¾èµ–é¡¹ - 12.8%ã€‚&lt;/li>
&lt;li>å…¨çƒè¦†ç›–ç‡ - 12.5%ã€‚&lt;/li>
&lt;li>å›´ç»•æµé‡é«˜å³°çš„æ•æ·æ€§ - 9.2%ã€‚&lt;/li>
&lt;li>ç¡®ä¿ä¾¿æºæ€§ - 8.9%&lt;/li>
&lt;/ul>
&lt;p>æˆ‘å–œæ¬¢ Google Cloud çš„å¼€å‘è€…å€¡å¯¼è€… Kelsey Hightower åœ¨è°ƒæŸ¥æŠ¥å‘Šä¸­è¯„è®ºè¿™äº›ç»“æœçš„æ–¹å¼ï¼š&lt;/p>
&lt;blockquote>
&lt;p>å¾ˆå¤šäººè®¤ä¸ºç»„ç»‡è½¬å‘ Kubernetes æ˜¯å› ä¸ºè§„æ¨¡ï¼Œæˆ–è€…å› ä¸ºä»–ä»¬æƒ³æˆä¸ºè¶…å¤§è§„æ¨¡è€…ï¼Œæˆ–è€…ä¸ Twitter æ‹¥æœ‰ç›¸åŒçš„æµé‡æ°´å¹³ã€‚å¯¹äºå¤§å¤šæ•°ç»„ç»‡è€Œè¨€ï¼Œæƒ…å†µå¹¶éä¸€å®šå¦‚æ­¤ã€‚å¾ˆå¤šäººéƒ½å–œæ¬¢ K8s ä¸­å†…ç½®äº†è®¸å¤šå†³ç­–ï¼Œä¾‹å¦‚æ—¥å¿—è®°å½•ã€ç›‘æ§å’Œè´Ÿè½½å¹³è¡¡ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>äººä»¬å¾€å¾€ä¼šå¿˜è®°äº‹æƒ…æœ‰å¤šä¹ˆå¤æ‚ï¼Œåªæ˜¯ä¸ºäº†æ„å»ºä¸€ä¸ªæ²¡æœ‰æ‰€æœ‰è‡ªåŠ¨åŒ–çš„åº”ç”¨ç¨‹åºã€‚å¦‚æœä½ åœ¨å…¬æœ‰äº‘ä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›æœ¬æœºé›†æˆå’Œå·¥å…·ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ åœ¨æœ¬åœ°ï¼Œé‚£ä¸æ˜¯ç»™å®šçš„â€”â€”ä½ å¿…é¡»è‡ªå·±å°†è§£å†³æ–¹æ¡ˆç²˜åˆåœ¨ä¸€èµ·ã€‚ä½¿ç”¨ Kubernetesï¼Œä½ å‡ ä¹å°† 25 ç§ä¸åŒçš„å·¥å…·åˆäºŒä¸ºä¸€ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>è¿™å°±æ˜¯äººä»¬æ‰€è¯´çš„â€œç°ä»£åŸºç¡€è®¾æ–½â€çš„æ„æ€â€”â€”ä»–ä»¬å¹¶ä¸æ˜¯åœ¨è°ˆè®ºåšä¸€äº›ä»¥å‰ä»æœªåšè¿‡çš„äº‹æƒ…ã€‚ä»–ä»¬è°ˆè®ºçš„æ˜¯è¿‡å» 10 å¹´æˆ– 15 å¹´ä¸€ç›´åœ¨ç”Ÿäº§çš„ä¸œè¥¿ã€‚Kubernetes æ˜¯å½“ä»Šæ‰€æœ‰â€œç°ä»£æ¨¡å¼â€çš„æ£€æŸ¥ç«™ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ¢å¥è¯è¯´ï¼Œäººä»¬çœŸæ­£æƒ³è¦ä» Kubernetes è·å¾—çš„æ˜¯ä¸€ç§æ ‡å‡†çš„åŸºç¡€è®¾æ–½æ€è€ƒæ–¹å¼ã€‚å›åˆ° Richardson ä¹‹å‰çš„è§‚ç‚¹ï¼Œè™½ç„¶ Kubernetes å’Œäº‘åŸç”ŸæŠ€æœ¯ä½¿å…¬å¸èƒ½å¤Ÿä»¥æ›´é«˜çš„é€Ÿåº¦è¿è¥ï¼Œä½†æœ€å¤§çš„å¥½å¤„å¯èƒ½æ˜¯ä½¿æŠ€èƒ½åœ¨ç»„ç»‡ä¹‹é—´å¯ä»¥äº’æ¢â€”â€”è¿™ä¸ºé›‡ä¸»å’Œå‘˜å·¥éƒ½åˆ›é€ äº†å·¨å¤§çš„ç»©æ•ˆæ”¶ç›Šã€‚è¿™æ˜¯ä¼ä¸šä¸æ–­å¢åŠ å¯¹ Kubernetes æŠ•èµ„çš„å¦ä¸€ä¸ªåŸå› ã€‚&lt;/p>
&lt;p>&lt;em>å£°æ˜ï¼šæˆ‘ä¸º AWS å·¥ä½œï¼Œä½†æ­¤å¤„è¡¨è¾¾çš„è§‚ç‚¹æ˜¯æˆ‘çš„ã€‚&lt;/em>&lt;/p></description></item><item><title>Kubernetes CKA è¯ä¹¦å¤‡è€ƒç¬”è®°</title><link>https://atbug.com/notes-for-cka-preparation/</link><pubDate>Fri, 02 Jul 2021 08:02:15 +0800</pubDate><guid>https://atbug.com/notes-for-cka-preparation/</guid><description>
&lt;p>Kubernetes ä½¿ç”¨æœ‰å¥½å‡ å¹´äº†ï¼Œä½†åœ¨ä»Šå¹´ 5 æœˆæ‰å®Œæˆ CKA çš„è€ƒè¯•ã€‚è™½è¯´ç”¨äº†å‡ å¹´ï¼Œè¿˜æ˜¯æå‰åˆ·äº†éƒ¨åˆ†é¢˜ç†Ÿæ‚‰ä¸‹ã€‚&lt;/p>
&lt;p>ç»å¤§éƒ¨åˆ†é¢˜éƒ½æ˜¯æœ‰åœ¨ minikube çš„ç¯å¢ƒä¸Šæ“ä½œè¿‡ï¼Œåªæœ‰éƒ¨åˆ†æ¯”å¦‚å‡çº§é›†ç¾¤å—é™äºç¯å¢ƒé—®é¢˜æ²¡æœ‰å®åœ°æ“ä½œã€‚&lt;/p>
&lt;h2 id="å†™åœ¨æœ€å‰">å†™åœ¨æœ€å‰&lt;/h2>
&lt;ol>
&lt;li>ä¿å­˜å¸¸ç”¨æ–‡æ¡£è¿›ä¹¦ç­¾ï¼Œå¦‚æœæœ‰ Alfred å¯ç”¨æµè§ˆå™¨ä¹¦ç­¾ workflowã€‚æ•ˆæœè§ä¸‹å›¾&lt;/li>
&lt;li>kubectl è‡ªåŠ¨è¡¥å…¨ &lt;code>echo &amp;quot;source &amp;lt;(kubectl completion bash)&amp;quot; &amp;gt;&amp;gt; ~/.bashrc; source ~/.bashrc&lt;/code>&lt;/li>
&lt;li>æ¯é“é¢˜å¼€å§‹å‰è¦åˆ‡æ¢ context å’Œ namespaceï¼Œç›´æ¥å¤åˆ¶é¢˜ç›®é‡Œçš„å‘½ä»¤å³å¯&lt;/li>
&lt;li>å¿…è¦çš„ alias&lt;/li>
&lt;li>å–„ç”¨ &lt;code>--dry-run=client -o yaml&lt;/code> é¿å…æ‰‹åŠ¨æ•²å¤ªå¤š&lt;/li>
&lt;li>å–„ç”¨ &lt;code>kubectl explain [resource[.field]]&lt;/code>&lt;/li>
&lt;li>çœ‹æ‡‚é¢˜ç›®æœ€é‡è¦ï¼Œè¾“å‡ºæ­£ç¡®çš„ç»“æœæ›´é‡è¦ï¼ˆé‡è¦çš„äº‹è®²ä¸‰éï¼‰&lt;/li>
&lt;li>çœ‹æ‡‚é¢˜ç›®æœ€é‡è¦ï¼Œè¾“å‡ºæ­£ç¡®çš„ç»“æœæ›´é‡è¦ï¼ˆé‡è¦çš„äº‹è®²ä¸‰éï¼‰&lt;/li>
&lt;li>çœ‹æ‡‚é¢˜ç›®æœ€é‡è¦ï¼Œè¾“å‡ºæ­£ç¡®çš„ç»“æœæ›´é‡è¦ï¼ˆé‡è¦çš„äº‹è®²ä¸‰éï¼‰&lt;/li>
&lt;/ol>
&lt;p>ä¹¦ç­¾åœ°å€ï¼š&lt;a href="https://gist.github.com/addozhang/3ca950ce9b38930abfe7c5fb067e74de">K8s-CKA-CAKD-Bookmarks.html&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/07/01/20210630162758.png" alt="alfred-bookmarks-workflow">&lt;/p>
&lt;h2 id="å®‰å…¨rbac">å®‰å…¨ï¼šRBAC&lt;/h2>
&lt;blockquote>
&lt;p>åœ¨é»˜è®¤å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ªåä¸º dev-sa çš„æœåŠ¡å¸æˆ·ï¼Œdev-sa å¯ä»¥åœ¨ dev å‘½åç©ºé—´ä¸­åˆ›å»ºä»¥ä¸‹ç»„ä»¶ï¼š
&lt;code>Deployment&lt;/code>ã€&lt;code>StatefulSet&lt;/code>ã€&lt;code>DaemonSet&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>role&lt;/li>
&lt;li>sa&lt;/li>
&lt;li>rolebinding&lt;/li>
&lt;li>auth can-i&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š
&lt;a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#command-line-utilities">https://kubernetes.io/docs/reference/access-authn-authz/rbac/#command-line-utilities&lt;/a>&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯">è§£é¢˜æ€è·¯&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl create sa dev-sa
$ kubectl create role dev-role --verb&lt;span class="o">=&lt;/span>create --resource&lt;span class="o">=&lt;/span>deployment,statefulset,daemonset
&lt;span class="c1">#æ£€æŸ¥&lt;/span>
$ kubectl describe role dev-role
Name: dev-role
Labels: &amp;lt;none&amp;gt;
Annotations: &amp;lt;none&amp;gt;
PolicyRule:
Resources Non-Resource URLs Resource Names Verbs
--------- ----------------- -------------- -----
daemonsets.apps &lt;span class="o">[]&lt;/span> &lt;span class="o">[]&lt;/span> &lt;span class="o">[&lt;/span>create&lt;span class="o">]&lt;/span>
deployments.apps &lt;span class="o">[]&lt;/span> &lt;span class="o">[]&lt;/span> &lt;span class="o">[&lt;/span>create&lt;span class="o">]&lt;/span>
statefulsets.apps &lt;span class="o">[]&lt;/span> &lt;span class="o">[]&lt;/span> &lt;span class="o">[&lt;/span>create&lt;span class="o">]&lt;/span>
$ kubectl create rolebinding dev --serviceaccount default:dev-sa --role dev-role
&lt;span class="c1">#æ£€æŸ¥&lt;/span>
$ kubectl auth can-i create deployment --as system:serviceaccount:default:dev-sa
yes
$ kubectl auth can-i create statefulset --as system:serviceaccount:default:dev-sa
yes
$ kubectl auth can-i create daemonset --as system:serviceaccount:default:dev-sa
yes
$ kubectl auth can-i create pod --as system:serviceaccount:default:dev-sa
no
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¤šå®¹å™¨-pod">å¤šå®¹å™¨ Pod&lt;/h2>
&lt;blockquote>
&lt;p>åˆ›å»ºä¸€ä¸ªpodåç§°æ—¥å¿—ï¼Œå®¹å™¨åç§° &lt;code>log-pro&lt;/code> ä½¿ç”¨image &lt;code>busybox&lt;/code>ï¼Œåœ¨ &lt;code>/log/data/output.log&lt;/code> è¾“å‡ºé‡è¦ä¿¡æ¯ã€‚ç„¶åå¦ä¸€ä¸ªå®¹å™¨åç§° &lt;code>log-cus&lt;/code> ä½¿ç”¨ image &lt;code>busybox&lt;/code>ï¼Œåœ¨ &lt;code>/log/data/output.log&lt;/code> åŠ è½½ &lt;code>output.log&lt;/code> å¹¶æ‰“å°å®ƒã€‚ è¯·æ³¨æ„ï¼Œæ­¤æ—¥å¿—æ–‡ä»¶åªèƒ½åœ¨ pod å†…å…±äº«ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-1">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>pod&lt;/li>
&lt;li>volume: emptyDir&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š
&lt;a href="https://kubernetes.io/docs/concepts/storage/volumes/#emptydir">https://kubernetes.io/docs/concepts/storage/volumes/#emptydir&lt;/a>&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-1">è§£é¢˜æ€è·¯&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl run log --image busybox --dry-run&lt;span class="o">=&lt;/span>client -o yaml &amp;gt; log.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹ log.yaml&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">log&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">log&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">sh&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">c&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">echo important information &amp;gt; /log/data/output.log; sleep 1d&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">busybox&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">log-pro&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">IfNotPresent&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/log/data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">log&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">sh&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">c&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">tail -f /log/data/output.log&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">busybox&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">log-cus&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">IfNotPresent&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/log/data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">log&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterFirst&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">log&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">emptyDir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œåˆ›å»º &lt;code>kubectl apply -f log.yaml&lt;/code>&lt;/p>
&lt;p>æ£€æŸ¥&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl logs log -c log-cus
important information
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å®‰å…¨ç½‘ç»œç­–ç•¥-networkpolicy">å®‰å…¨ï¼šç½‘ç»œç­–ç•¥ NetworkPolicy&lt;/h2>
&lt;blockquote>
&lt;p>åªæœ‰å‘½åç©ºé—´ &lt;code>mysql&lt;/code> çš„ pod åªèƒ½è¢«å¦ä¸€ä¸ªå‘½åç©ºé—´ &lt;code>internal&lt;/code> çš„ pod é€šè¿‡ 8080 ç«¯å£è¿›è¡Œè®¿é—®&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-2">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>NetworkPolicy&lt;/li>
&lt;li>Ingress&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š
&lt;a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/#the-networkpolicy-resource">https://kubernetes.io/docs/concepts/services-networking/network-policies/#the-networkpolicy-resource&lt;/a>&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-2">è§£é¢˜æ€è·¯&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">networking.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NetworkPolicy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cka-network&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">target&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#ç›®çš„å‘½åç©ºé—´&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">podSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">policyTypes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">Ingress&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#ç­–ç•¥å½±å“å…¥æ ˆæµé‡&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ingress&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">from&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#å…è®¸æµé‡çš„æ¥æº&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">namespaceSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ns&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#æºå‘½åç©ºé—´çš„ label&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#å…è®¸è®¿é—®çš„ç«¯å£&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="èŠ‚ç‚¹çŠ¶æ€åŠæ±¡ç‚¹">èŠ‚ç‚¹çŠ¶æ€åŠæ±¡ç‚¹&lt;/h2>
&lt;blockquote>
&lt;p>ç»Ÿè®¡è¿™ä¸ªé›†ç¾¤ä¸­æ²¡æœ‰æ±¡æŸ“çš„å°±ç»ªèŠ‚ç‚¹ï¼Œå¹¶è¾“å‡ºåˆ°æ–‡ä»¶ &lt;code>/root/cka/readyNode.txt&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-3">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>Node&lt;/li>
&lt;li>Taintï¼ˆæ±¡ç‚¹ï¼‰&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-3">è§£é¢˜æ€è·¯&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># Ready çŠ¶æ€çš„æ•°é‡&lt;/span>
$ kubectl get node &lt;span class="p">|&lt;/span> grep -w Ready &lt;span class="p">|&lt;/span> wc -l
&lt;span class="c1"># æŸ¥çœ‹å«æœ‰ Taint çš„æ•°é‡ï¼Œéœ€è¦æ’é™¤æ‰è¿™äº›&lt;/span>
$ kubectl describe node &lt;span class="p">|&lt;/span> grep Taints &lt;span class="p">|&lt;/span> grep -i NoSchedule &lt;span class="p">|&lt;/span> wc -l
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="èµ„æº">èµ„æº&lt;/h2>
&lt;blockquote>
&lt;p>å°†å ç”¨CPUèµ„æºæœ€å¤šçš„podåç§°è¾“å‡ºåˆ°æ–‡ä»¶ &lt;code>/root/cka/name.txt&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-4">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>kubectl top å‘½ä»¤&lt;/li>
&lt;li>metrics&lt;/li>
&lt;/ul>
&lt;h3 id="è§£é¢˜æ€è·¯-4">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>å¦‚æœæ˜¯ minikube ç¯å¢ƒï¼ŒæŠ¥é”™ &lt;code>error: Metrics API not available&lt;/code>ï¼Œå¯ä»¥æ‰§è¡Œ &lt;code>minikube addons enable metrics-server&lt;/code> å‘½ä»¤å¼€å¯ metrics serverã€‚&lt;/p>
&lt;p>é€šè¿‡ &lt;code>kubectl top&lt;/code> å‘½ä»¤æ‰¾åˆ° cpu æœ€é«˜çš„ podï¼Œå°†å…¶åå­—å†™å…¥ &lt;code>/root/cka/name.txt&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl top pod
&lt;span class="c1"># æˆ–è€…&lt;/span>
$ kubectl top pod &lt;span class="p">|&lt;/span> sort -k &lt;span class="m">2&lt;/span> -n
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ç½‘ç»œdns">ç½‘ç»œï¼šDNS&lt;/h2>
&lt;blockquote>
&lt;p>æœ‰ pod åç§° &lt;code>pod-nginx&lt;/code>ï¼Œåˆ›å»ºæœåŠ¡åç§° &lt;code>service-nginx&lt;/code>ï¼Œä½¿ç”¨ &lt;code>nodePort&lt;/code> æš´éœ²podã€‚ ç„¶ååˆ›å»ºä¸€ä¸ª pod ä½¿ç”¨ image &lt;code>busybox&lt;/code> æ¥ &lt;code>nslookup&lt;/code> pod &lt;code>pod-nginx&lt;/code> å’Œ service &lt;code>service-nginx&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-5">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>service with nodePort&lt;/li>
&lt;li>kubectl expose&lt;/li>
&lt;li>kubectl run&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/concepts/services-networking/dns-pod-service/&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-5">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>ä½¿ç”¨ &lt;code>kubectl expose&lt;/code> åˆ›å»º serviceã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># åˆ›å»º service&lt;/span>
kubectl expose pod pod-nginx --name service-nginx --type NodePort --target-port &lt;span class="m">80&lt;/span>
&lt;span class="c1"># åˆ›å»º pod&lt;/span>
kubectl run busybox --image busybox:latest --command sleep 1h
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è·å– pod çš„ ip åœ°å€ï¼Œpod çš„ dns lookup éœ€è¦ç”¨ç”¨åˆ° ipã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get po -o wide
NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
busybox 1/1 Running &lt;span class="m">0&lt;/span> 2m17s 172.17.0.5 cka &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
pod-nginx 1/1 Running &lt;span class="m">0&lt;/span> 59m 172.17.0.4 cka &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œ nslookup&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl &lt;span class="nb">exec&lt;/span> busybox -it -- nslookup 172.17.0.4
4.0.17.172.in-addr.arpa &lt;span class="nv">name&lt;/span> &lt;span class="o">=&lt;/span> 172-17-0-4.service-nginx.default.svc.cluster.local.
$ kubectl &lt;span class="nb">exec&lt;/span> busybox -it -- nslookup service-nginx
Server: 10.96.0.10
Address: 10.96.0.10#53
Name: service-nginx.default.svc.cluster.local
Address: 10.110.253.70
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å·¥ä½œè´Ÿè½½æ‰©å®¹">å·¥ä½œè´Ÿè½½ï¼šæ‰©å®¹&lt;/h2>
&lt;blockquote>
&lt;p>å°†å‘½åç©ºé—´ &lt;code>dev&lt;/code> ä¸­çš„ Deployment &lt;code>scale-deploy&lt;/code> ç¼©æ”¾åˆ°ä¸‰ä¸ª pod å¹¶è®°å½•ä¸‹æ¥ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/concepts/workloads/controllers/deployment/#scaling-a-deployment&lt;/p>
&lt;h3 id="çŸ¥è¯†ç‚¹-6">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>deployment scale up&lt;/li>
&lt;li>kubectl scale&lt;/li>
&lt;/ul>
&lt;h3 id="è§£é¢˜æ€è·¯-6">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>&lt;code>kubectl scale&lt;/code> çš„ä½¿ç”¨ï¼Œéœ€è¦å‚æ•° &lt;code>--record&lt;/code> è¿›è¡Œè®°å½•ï¼ˆå°†æ“ä½œå‘½ä»¤è®°å½•åˆ° deployment çš„ &lt;code>kubernetes.io/change-cause&lt;/code> annotation ä¸­ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl scale deployment scale-deploy --replicas &lt;span class="m">3&lt;/span> --record
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="é›†ç¾¤å¤‡ä»½åŠæ¢å¤">é›†ç¾¤å¤‡ä»½åŠæ¢å¤&lt;/h2>
&lt;blockquote>
&lt;p>å¤‡ä»½ etcd å¹¶å°†å…¶ä¿å­˜åœ¨ä¸»èŠ‚ç‚¹ä¸Šçš„ &lt;code>/root/cka/etcd-backup.db&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æœ€åæ¢å¤å¤‡ä»½ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-7">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>etcd çš„å¤‡ä»½åŠæ¢å¤&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-7">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>Kubernetes çš„æ‰€æœ‰æ•°æ®éƒ½è®°å½•åœ¨ etcd ä¸­ï¼Œå¯¹ etcd è¿›è¡Œå¤‡ä»½å°±æ˜¯å¯¹é›†ç¾¤è¿›è¡Œå¤‡ä»½ã€‚&lt;/p>
&lt;p>è¿æ¥ etcd éœ€è¦è¯ä¹¦ï¼Œè¯ä¹¦å¯ä»¥ä» apiserver è·å–ï¼Œå› ä¸º apiserver éœ€è¦è¿æ¥ etcdã€‚æ–°ç‰ˆæœ¬çš„ apiserver éƒ½æ˜¯ä»¥ static pod çš„æ–¹å¼è¿è¡Œï¼Œè¯ä¹¦æ˜¯é€šè¿‡ volume æŒ‚è½½åˆ° pod ä¸­çš„ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ minikube ç¯å¢ƒï¼Œè¯ä¹¦æ˜¯ä» node èŠ‚ç‚¹çš„ &lt;code>/var/lib/minikube/certs&lt;/code> æŒ‚è½½è¿›å»çš„ã€‚&lt;/p>
&lt;p>è¦å…ˆ ssh åˆ° master èŠ‚ç‚¹ä¸Šã€‚å‘½ä»¤çš„æ‰§è¡Œéå¸¸å¿«ï¼Œå¦‚æœé•¿æ—¶é—´æ²¡ç»“æŸï¼Œé‚£å°±è¯´åæœ‰é—®é¢˜äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#å¤‡ä»½&lt;/span>
$ &lt;span class="nv">ETCDCTL_API&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span> etcdctl snapshot save /root/cka/etcd-backup.db &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--endpoints&lt;span class="o">=&lt;/span>https://127.0.0.1:2379 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--cacert&lt;span class="o">=&lt;/span>/var/lib/minikube/certs/etcd/ca.crt &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--cert&lt;span class="o">=&lt;/span>/var/lib/minikube/certs/apiserver-etcd-client.crt &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--key&lt;span class="o">=&lt;/span>/var/lib/minikube/certs/apiserver-etcd-client.key
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±äºåªè¯´äº† restoreï¼Œæ‰€ä»¥å°±æ‰§è¡Œ restore çš„å‘½ä»¤ï¼Œé»˜è®¤ä¼šæ¢å¤åˆ°å½“å‰ç›®å½•çš„ &lt;code>default.etcd&lt;/code> ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#æ¢å¤&lt;/span>
$ &lt;span class="nv">ETCDCTL_API&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span> etcdctl snapshot restore /root/cka/etcd-backup.db &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--endpoints&lt;span class="o">=&lt;/span>https://127.0.0.1:2379 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--cacert&lt;span class="o">=&lt;/span>/var/lib/minikube/certs/etcd/ca.crt &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--cert&lt;span class="o">=&lt;/span>/var/lib/minikube/certs/apiserver-etcd-client.crt &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--key&lt;span class="o">=&lt;/span>/var/lib/minikube/certs/apiserver-etcd-client.key
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="é›†ç¾¤èŠ‚ç‚¹å‡çº§">é›†ç¾¤èŠ‚ç‚¹å‡çº§&lt;/h2>
&lt;blockquote>
&lt;p>å°†masterèŠ‚ç‚¹ç‰ˆæœ¬ä» 1.20.0 å‡çº§åˆ° 1.21.0ï¼Œç¡®ä¿ master èŠ‚ç‚¹ä¸Šçš„ pod é‡æ–°è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œå‡çº§å®Œæˆåï¼Œä½¿ master èŠ‚ç‚¹å¯ç”¨ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-8">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>drain&lt;/li>
&lt;li>cordon&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/#upgrading-control-plane-nodes&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-8">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>å—é™äºç¯å¢ƒï¼Œæ²¡æœ‰å®åœ°æ“ä½œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># å°†èŠ‚ç‚¹è®¾ç½®ä¸ºä¸å¯è°ƒåº¦&lt;/span>
$ kubectl cordon master
&lt;span class="c1"># é©±é€ master èŠ‚ç‚¹ä¸Šçš„ pod&lt;/span>
$ kubectl drain master --ignore-daemonsets
&lt;span class="c1"># è¿›è¡Œå‡çº§&lt;/span>
$ apt-mark unhold kubelet kubectl &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>apt-get update &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> apt-get install -y &lt;span class="nv">kubelet&lt;/span>&lt;span class="o">=&lt;/span>1.21.0-00 &lt;span class="nv">kubectl&lt;/span>&lt;span class="o">=&lt;/span>1.21.0-00 &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>apt-mark hold kubelet kubectl
&lt;span class="c1"># é‡æ–°å¯åŠ¨kubelet&lt;/span>
$ systemctl daemon-reload
$ systemctl restart kubelet
&lt;span class="c1"># å°†èŠ‚ç‚¹è®¾ç½®ä¸ºå¯è°ƒåº¦&lt;/span>
$ kubectl uncordon master
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="é›†ç¾¤èŠ‚ç‚¹æ•…éšœæ’æŸ¥">é›†ç¾¤ï¼šèŠ‚ç‚¹æ•…éšœæ’æŸ¥&lt;/h2>
&lt;blockquote>
&lt;p>ç°åœ¨ node01 è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œè¯·æ‰¾å‡ºæ ¹æœ¬åŸå› å¹¶ä½¿å…¶å‡†å¤‡å¥½ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç¡®ä¿å®ƒåœ¨ node01 ä¸Šè¿è¡Œçš„ podã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-9">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>èŠ‚ç‚¹æ•…éšœæ’æŸ¥&lt;/li>
&lt;/ul>
&lt;h3 id="è§£é¢˜æ€è·¯-9">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>è¿™ç§é—®é¢˜å¤§æ¦‚ç‡é—®é¢˜å‡ºåœ¨ kubelet ä¸Š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">ssh node01
systemctl status kubelet
systemctl restart kubelet
&lt;span class="c1"># å†æ£€æŸ¥nodeçŠ¶æ€&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ’æ’­ä¸€ä¸ªæ•…éšœï¼Œæœ¬åœ°å®‰è£… 2 ä¸ªèŠ‚ç‚¹çš„ minikube é›†ç¾¤æ—¶ï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹æŒç»­ &lt;code>NotReady&lt;/code>ã€‚ä½¿ç”¨ &lt;code>systemctl status kubelet&lt;/code> çœ‹åˆ° &lt;code>unable to update cni config: no networks found in /etc/cni/net.mk&lt;/code>ã€‚&lt;/p>
&lt;p>æ£€æŸ¥è¯¥ç›®å½•ç¡®å®æ²¡æœ‰æ–‡ä»¶ï¼Œä» master èŠ‚ç‚¹å¤åˆ¶åˆ°è¯¥èŠ‚ç‚¹åé‡å¯ kubelet è§£å†³ã€‚&lt;/p>
&lt;h2 id="å­˜å‚¨æŒä¹…åŒ–å·">å­˜å‚¨ï¼šæŒä¹…åŒ–å·&lt;/h2>
&lt;blockquote>
&lt;p>é›†ç¾¤ä¸­æœ‰ä¸€ä¸ªæŒä¹…å·åç§° &lt;code>dev-pv&lt;/code>ï¼Œåˆ›å»ºä¸€ä¸ªæŒä¹…å·å£°æ˜åç§° &lt;code>dev-pvc&lt;/code>ï¼Œç¡®ä¿è¿™ä¸ªæŒä¹…å·å£°æ˜ä¼šç»‘å®šæŒä¹…å·ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª pod åç§° &lt;code>test-pvc&lt;/code>ï¼Œå°†è¿™ä¸ª pvc æŒ‚è½½åˆ° path &lt;code>/tmp/data&lt;/code>ï¼Œä½¿ç”¨ nginx é•œåƒã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-10">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>PersistentVolume&lt;/li>
&lt;li>PersistentVolumeClaim&lt;/li>
&lt;li>Mount Volume&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolume&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-10">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>åˆ›å»º pvc å‰å…ˆè·å– pvçš„ä¿¡æ¯&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pv dev-pv -o yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»º pv&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ cat &amp;gt; pvc.yaml &lt;span class="s">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;span class="s">apiVersion: v1
&lt;/span>&lt;span class="s">kind: PersistentVolumeClaim
&lt;/span>&lt;span class="s">metadata:
&lt;/span>&lt;span class="s"> name: dev-pvc
&lt;/span>&lt;span class="s">spec:
&lt;/span>&lt;span class="s"> accessModes:
&lt;/span>&lt;span class="s"> - ReadWriteOnce
&lt;/span>&lt;span class="s"> resources:
&lt;/span>&lt;span class="s"> requests:
&lt;/span>&lt;span class="s"> storage: 1Gi
&lt;/span>&lt;span class="s">EOF&lt;/span>
$ kubectl apply -f pvc.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»º pod çš„ manifestï¼Œè®°å¾—ä½¿ç”¨ &lt;code>kubectl run --dry-run=client -o yaml&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl run test-pvc --image nginx --dry-run&lt;span class="o">=&lt;/span>client -o yaml &amp;gt; test-pvc.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹ä¹‹åå¾—åˆ°æœ€ç»ˆçš„ pod yaml&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test-pvc&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test-pvc&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeClaim&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">claimName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dev-pvc&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test-pvc&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/tmp/data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterFirst&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Always&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç†è®ºä¸Šåªè¦ pod èƒ½è¿è¡Œï¼Œå°±è¯´æ˜æˆåŠŸã€‚ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥ç¡®è®¤æŒ‚è½½æ˜¯å¦æˆåŠŸï¼Œåœ¨ pod çš„ &lt;code>/tmp/data&lt;/code> ä¸­ touch ä¸ªæ–‡ä»¶ï¼Œç„¶ååˆ°èŠ‚ç‚¹çš„ç›®å½•ä¸­æŸ¥çœ‹æ˜¯æœ‰è¯¥æ–‡ä»¶ã€‚&lt;/p>
&lt;h2 id="å·¥ä½œè´Ÿè½½å¤šå®¹å™¨çš„-deployment">å·¥ä½œè´Ÿè½½ï¼šå¤šå®¹å™¨çš„ Deployment&lt;/h2>
&lt;blockquote>
&lt;p>åˆ›å»ºä¸€ä¸ªåä¸º &lt;code>deploy-important&lt;/code> çš„ Deploymentï¼Œæ ‡ç­¾ä¸º &lt;code>id=very-important&lt;/code>ï¼ˆpod ä¹Ÿåº”è¯¥æœ‰è¿™ä¸ªæ ‡ç­¾ï¼‰å’Œå‘½åç©ºé—´ dev ä¸­çš„ 3 ä¸ªå‰¯æœ¬ã€‚ å®ƒåº”è¯¥åŒ…å«ä¸¤ä¸ªå®¹å™¨ï¼Œç¬¬ä¸€ä¸ªåä¸º &lt;code>container1&lt;/code> å¹¶å¸¦æœ‰é•œåƒï¼Œç¬¬äºŒä¸ªåä¸º container2 çš„å›¾åƒä¸º &lt;code>kubernetes/pause&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>åœ¨ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šåº”è¯¥åªè¿è¡Œè¯¥éƒ¨ç½²çš„ä¸€ä¸ª Podã€‚ æˆ‘ä»¬æœ‰ä¸¤ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼š&lt;code>cluster1-worker1&lt;/code> å’Œ &lt;code>cluster1-worker2&lt;/code>ã€‚ å› ä¸º Deployment æœ‰ä¸‰ä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥ç»“æœåº”è¯¥æ˜¯åœ¨ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰ä¸€ä¸ª Pod æ­£åœ¨è¿è¡Œã€‚ ä¸ä¼šè°ƒåº¦ç¬¬ä¸‰ä¸ª Podï¼Œé™¤éæ·»åŠ æ–°çš„å·¥ä½œèŠ‚ç‚¹ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-11">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>deployment&lt;/li>
&lt;li>pod label&lt;/li>
&lt;li>replicas&lt;/li>
&lt;li>multi container pod&lt;/li>
&lt;li>pod anti affinity&lt;/li>
&lt;/ul>
&lt;p>å®˜æ–¹æ–‡æ¡£å‚è€ƒï¼šhttps://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#never-co-located-in-the-same-node&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-11">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>å…ˆåˆ›å»ºæ¨¡æ¿&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl create deployment deploy-important --image nginx --replicas &lt;span class="m">3&lt;/span> --dry-run&lt;span class="o">=&lt;/span>client -o yaml &amp;gt; deploy-important.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹åçš„ yaml&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-important&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">very-important&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-important&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-important&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">very-important&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">strategy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-important&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">very-important&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">affinity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">podAntiAffinity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requiredDuringSchedulingIgnoredDuringExecution&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">labelSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">id&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">In&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">values&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">very-important&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">topologyKey&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubernetes.io/hostname&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">container1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubernetes/pause&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">container2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>minikube ä¸Šæµ‹è¯•åªèƒ½è°ƒåº¦ä¸€ä¸ª podï¼Œç¬¦åˆé¢„æœŸ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kgpo
NAME READY STATUS RESTARTS AGE
deploy-important-659d54fc47-6cp8r 0/2 Pending &lt;span class="m">0&lt;/span> 3h10m
deploy-important-659d54fc47-92z4d 2/2 Running &lt;span class="m">0&lt;/span> 3h10m
deploy-important-659d54fc47-c6llc 0/2 Pending &lt;span class="m">0&lt;/span> 3h10m
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å­˜å‚¨secretçš„ä½¿ç”¨">å­˜å‚¨ï¼šSecretçš„ä½¿ç”¨&lt;/h2>
&lt;blockquote>
&lt;p>åœ¨ &lt;code>secret&lt;/code> å‘½åç©ºé—´ä¸‹ï¼Œä½¿ç”¨é•œåƒ &lt;code> busybox:1.31.1&lt;/code> åˆ›å»ºä¸€ä¸ªåä¸º &lt;code>secret-pod&lt;/code> çš„ podï¼Œå¹¶ä¿è¯ pod è¿è¡Œä¸€æ®µæ—¶é—´&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æœ‰ä¸ªåä¸º &lt;code>sercret1.yaml&lt;/code> çš„ Secret æ–‡ä»¶ï¼Œåœ¨ &lt;code>secret&lt;/code> å‘½åç©ºé—´ä¸‹åˆ›å»º Secretï¼Œå¹¶ä»¥åªè¯»çš„æ–¹å¼æŒ‚åœ¨åˆ° Pod çš„ &lt;code>/tmp/secret1&lt;/code> ç›®å½•
åˆ›å»ºä¸€ä¸ªæ–°çš„ Secret &lt;code>secret2&lt;/code> åŒ…å« &lt;code>user=user1&lt;/code> å’Œ &lt;code>pass=1234&lt;/code>ï¼Œåˆ†åˆ«ä»¥ç¼“è§£å˜é‡ &lt;code>APP_USER&lt;/code> å’Œ &lt;code>APP_PASS&lt;/code> è¾“å…¥åˆ° Pod ä¸­&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-12">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>secret&lt;/li>
&lt;li>toleration&lt;/li>
&lt;li>taints&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š
&lt;a href="https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets">https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets&lt;/a>
&lt;a href="https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets-as-environment-variables">https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets-as-environment-variables&lt;/a>&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-12">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>åˆ›å»º namespace&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl create ns secret
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»º pod æ¨¡æ¿&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">$ kubectl run secret-pod --image busybox:1.31.1 --dry-run=client -o yaml --command -- sleep 1d &amp;gt; secret-pod.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹ secret1.yamlï¼Œä½¿ç”¨ secret namespace&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">halt&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">IyEvYmluL2Jhc2g=&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Secret&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2021-05-15T07:48:02Z&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">secret1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">secret&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Opaque&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»º secret2&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl create secret generic secret2 --from-literal &lt;span class="nv">user&lt;/span>&lt;span class="o">=&lt;/span>user1 --from-literal &lt;span class="nv">pass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1234&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹æ¨¡æ¿&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">secret-pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">secret-pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">1d&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">busybox:1.31.1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">secret-pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">env&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">APP_USER&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">valueFrom&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secretKeyRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">secret2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">user&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">APP_PASS&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">valueFrom&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secretKeyRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">secret2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pass&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/tmp/secret1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sec&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterFirst&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sec&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secret&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">secret1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥ç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl &lt;span class="nb">exec&lt;/span> secret-pod -- cat /tmp/secret1/halt
&lt;span class="c1">#!/bin/bash&lt;/span>
$ kubectl &lt;span class="nb">exec&lt;/span> secret-pod -- env &lt;span class="p">|&lt;/span> grep &lt;span class="s1">&amp;#39;APP_&amp;#39;&lt;/span>
&lt;span class="nv">APP_USER&lt;/span>&lt;span class="o">=&lt;/span>user1
&lt;span class="nv">APP_PASS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1234&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å·¥ä½œè´Ÿè½½é™æ€-pod">å·¥ä½œè´Ÿè½½ï¼šé™æ€ Pod&lt;/h2>
&lt;blockquote>
&lt;p>åœ¨ &lt;code>cluster3-master1&lt;/code> ä¸Šçš„ &lt;code>default&lt;/code> å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ªåä¸º &lt;code>my-static-pod&lt;/code> çš„é™æ€ Podã€‚ ä½¿ç”¨é•œåƒ &lt;code>nginx:1.16-alpine&lt;/code> å¹¶åˆ†é… 10m CPU å’Œ 20Mi å†…å­˜çš„èµ„æºã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>Then create a NodePort Service named static-pod-service which exposes that static Pod on port 80 and check if it has Endpoints and if its reachable through the cluster3-master1 internal IP address. You can connect to the internal node IPs from your main terminal.
ç„¶ååˆ›å»ºä¸€ä¸ªåä¸º&lt;code> static-pod-service&lt;/code> çš„ NodePort Serviceï¼Œè¯¥æœåŠ¡åœ¨ç«¯å£ 80 ä¸Šå…¬å¼€è¯¥é™æ€ Podï¼Œå¹¶æ£€æŸ¥å®ƒæ˜¯å¦å…·æœ‰ç«¯ç‚¹ä»¥åŠæ˜¯å¦å¯ä»¥é€šè¿‡ &lt;code>cluster3-master1&lt;/code> å†…éƒ¨ IP åœ°å€è®¿é—®å®ƒã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-13">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>static pod&lt;/li>
&lt;li>resource&lt;/li>
&lt;li>nodeport service&lt;/li>
&lt;li>endpoints&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/">https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory">https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="è§£é¢˜æ€è·¯-13">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>åˆ›å»ºpodæ¨¡æ¿&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl run my-static-pod --image nginx:1.16-alpine --dry-run&lt;span class="o">=&lt;/span>client -o yaml &amp;gt; static-pod.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹æ¨¡æ¿ï¼Œå¢åŠ èµ„æºé…ç½®&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">my-static-pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">my-static-pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx:1.16-alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">my-static-pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;10m&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;20Mi&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterFirst&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ssh åˆ°ä¸»æœºï¼Œæ‰¾åˆ° kubelet é…ç½®æ–‡ä»¶çš„ä½ç½® &lt;code>ps -ef | grep kubelet&lt;/code>&lt;/p>
&lt;p>æŸ¥çœ‹é…ç½®æ–‡ä»¶ï¼ˆminikubeï¼š/var/lib/kubelet/config.yamlï¼‰ä¸­ &lt;code>staticPodPath&lt;/code> é…ç½®çš„å°±æ˜¯é™æ€ pod çš„ manifest çš„ä½ç½®ï¼ˆminikubeï¼š/etc/kubernetes/manifestsï¼‰&lt;/p>
&lt;p>å°† &lt;code>static-pod.yaml&lt;/code> æ”¾åˆ°æ­£ç¡®çš„æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åé‡å¯ kubelet&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ systemctl restart kubelet
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥podæ˜¯å¦æ­£ç¡®è¿è¡Œ&lt;/p>
&lt;p>åˆ›å»º node port&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl expose pod my-static-pod --name static-pod-service --type NodePort --port &lt;span class="m">80&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥æ˜¯å¦åˆ›å»ºæˆåŠŸ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get svc
NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
static-pod-service NodePort 10.97.248.99 &amp;lt;none&amp;gt; 80:31938/TCP 68s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è·å– node çš„ ip&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get node -o wide
NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME
cka Ready master 10h v1.18.8 192.168.64.3 &amp;lt;none&amp;gt; Buildroot 2020.02.10 4.19.171 docker://20.10.4
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ minikube çš„ç¯å¢ƒä¸‹å¯ç›´æ¥é€šè¿‡ &lt;code>minikube ip&lt;/code> è·å–&lt;/p>
&lt;p>æµ‹è¯•&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ http 192.168.64.3:31938 --headers
HTTP/1.1 &lt;span class="m">200&lt;/span> OK
Accept-Ranges: bytes
Connection: keep-alive
Content-Length: &lt;span class="m">612&lt;/span>
Content-Type: text/html
Date: Sat, &lt;span class="m">15&lt;/span> May &lt;span class="m">2021&lt;/span> 08:35:11 GMT
ETag: &lt;span class="s2">&amp;#34;5d52db33-264&amp;#34;&lt;/span>
Last-Modified: Tue, &lt;span class="m">13&lt;/span> Aug &lt;span class="m">2019&lt;/span> 15:45:55 GMT
Server: nginx/1.16.1
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="è°ƒåº¦æ±¡ç‚¹å’Œå®¹å¿åº¦">è°ƒåº¦ï¼šæ±¡ç‚¹å’Œå®¹å¿åº¦&lt;/h2>
&lt;blockquote>
&lt;p>åœ¨å‘½åç©ºé—´ &lt;code>default&lt;/code> ä¸­åˆ›å»ºå›¾åƒ &lt;code>httpd:2.4.41-alpine&lt;/code> çš„å•ä¸ª Podã€‚Pod åº”å‘½åä¸º &lt;code>pod1&lt;/code>ï¼Œå®¹å™¨åä¸º &lt;code>pod1-container&lt;/code>ã€‚åœ¨ä¸ç»™ä»»ä½•èŠ‚ç‚¹æ·»åŠ æ–°æ ‡ç­¾çš„å‰æä¸‹ï¼Œå°†è¯¥ pod è°ƒåº¦åˆ°ä¸»èŠ‚ç‚¹ä¸Šã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-14">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>Taint&lt;/li>
&lt;li>Label&lt;/li>
&lt;li>Tolerance&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-14">è§£é¢˜æ€è·¯&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">#æ‰¾å‡ºmasterèŠ‚ç‚¹ï¼ˆä¸€èˆ¬è€ƒè¯•åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼‰
$ kubectl get node
#æ‰¾åˆ° master èŠ‚ç‚¹çš„ taintsï¼Œéœ€è¦åœ¨ pod çš„ .spec.tolerations æ’é™¤æ‰
$ kubectl describe node xxxx | grep -w Taints
#æ‰¾åˆ° master èŠ‚ç‚¹çš„ labels
$ kubectl describe node xxxx | grep -w Labels -A10
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»ºpodæ¨¡æ¿&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl run pod1 --image httpd:2.4.41-alpine --dry-run&lt;span class="o">=&lt;/span>client -o yaml &amp;gt; pod1.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹æ¨¡æ¿ï¼š è¿™é‡Œå‡è®¾ä¸»èŠ‚ç‚¹çš„ Taint ä¸º &lt;code>node-role.kubernetes.io/master=:NoSchedule&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># minikube é›†ç¾¤åä¸º ckaï¼Œä¸»èŠ‚ç‚¹åŒå&lt;/span>
$ kubectl describe node cka &lt;span class="p">|&lt;/span> grep -i taint
Taints: node-role.kubernetes.io/master:NoSchedule
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€ç»ˆçš„ pod å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pod1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pod1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">httpd:2.4.41-alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pod1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterFirst&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tolerations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">node-role.kubernetes.io/master&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">effect&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NoSchedule&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">nodeSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">node-role.kubernetes.io/master&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åæ£€æŸ¥ä¸‹æ˜¯å¦è°ƒåº¦åˆ°ä¸»èŠ‚ç‚¹ä¸Šï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pod -o wide
NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
pod1 1/1 Running &lt;span class="m">0&lt;/span> 102s 10.244.0.3 cka &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="kubectl-å‘½ä»¤å’Œæ’åº">kubectl å‘½ä»¤å’Œæ’åº&lt;/h2>
&lt;blockquote>
&lt;p>æ‰€æœ‰å‘½åç©ºé—´ä¸­éƒ½æœ‰å„ç§ Podã€‚ å°†å‘½ä»¤å†™å…¥ /opt/course/5/find_pods.shï¼Œå…¶ä¸­åˆ—å‡ºæ‰€æœ‰æŒ‰ AGE æ’åºçš„ Podï¼ˆmetadata.creationTimestampï¼‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>å°†ç¬¬äºŒä¸ªå‘½ä»¤å†™å…¥ /opt/course/5/find_pods_uid.shï¼Œå…¶ä¸­åˆ—å‡ºæŒ‰å­—æ®µ metadata.uid æ’åºçš„æ‰€æœ‰ Podã€‚å¯¹è¿™ä¸¤ä¸ªå‘½ä»¤éƒ½ä½¿ç”¨ kubectl æ’åºã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-15">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>kubectl å‘½ä»¤çš„ä½¿ç”¨ï¼Œä¸»è¦æ˜¯ &lt;code>--all-namespaces&lt;/code> ï¼ˆç¼©å†™ &lt;code>-A&lt;/code>ï¼‰ å’Œ &lt;code>--sort-by&lt;/code>&lt;/li>
&lt;/ul>
&lt;h3 id="è§£é¢˜æ€è·¯-15">è§£é¢˜æ€è·¯&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ cat &amp;gt; /opt/course/5/find_pods.sh &lt;span class="s">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;span class="s">kubectl get pod -A --sort-by &amp;#39;.metadata.creationTimestamp&amp;#39;
&lt;/span>&lt;span class="s">EOF&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ cat &amp;gt; /opt/course/5/find_pods_uid.sh &lt;span class="s">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;span class="s">kubectl get pod -A --sort-by &amp;#39;.metadata.uid&amp;#39;
&lt;/span>&lt;span class="s">EOF&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å­˜å‚¨æŒä¹…åŒ–å·å’ŒæŒ‚è½½">å­˜å‚¨ï¼šæŒä¹…åŒ–å·å’ŒæŒ‚è½½&lt;/h2>
&lt;blockquote>
&lt;p>åˆ›å»ºä¸€ä¸ªåä¸º &lt;code>safari-pv&lt;/code> çš„æ–° &lt;code>PersistentVolume&lt;/code>ã€‚å®ƒåº”è¯¥å…·æœ‰ 2Gi çš„å®¹é‡ã€&lt;code>accessMode&lt;/code> &lt;code>ReadWriteOnce&lt;/code>ã€&lt;code>hostPath&lt;/code> &lt;code>/Volumes/Data&lt;/code> å¹¶ä¸”æ²¡æœ‰å®šä¹‰ &lt;code>storageClassName&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æ¥ä¸‹æ¥åœ¨å‘½åç©ºé—´ &lt;code>project-tiger&lt;/code> ä¸­åˆ›å»ºä¸€ä¸ªåä¸º &lt;code>safari-pvc&lt;/code> çš„æ–° &lt;code>PersistentVolumeClaim&lt;/code>ã€‚ å®ƒåº”è¯¥è¯·æ±‚ 2Gi å­˜å‚¨ï¼Œ&lt;code>accessMode&lt;/code> &lt;code>ReadWriteOnce&lt;/code> å¹¶ä¸”ä¸åº”å®šä¹‰ &lt;code>storageClassName&lt;/code>ã€‚ PVC åº”è¯¥æ­£ç¡®ç»‘å®šåˆ° PVã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æœ€ååœ¨å‘½åç©ºé—´ &lt;code>project-tiger&lt;/code> ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ Deployment &lt;code>safari&lt;/code>ï¼Œå®ƒå°†è¯¥å·æŒ‚è½½åˆ° &lt;code>/tmp/safari-data&lt;/code>ã€‚è¯¥ Deployment çš„ Pod åº”è¯¥æ˜¯é•œåƒ httpd:2.4.41-alpineã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-16">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>pv&lt;/li>
&lt;li>pvc&lt;/li>
&lt;li>pod ä½¿ç”¨ pvc&lt;/li>
&lt;li>deployment&lt;/li>
&lt;li>mount PVC volume&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolume">https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolume&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolumeclaim">https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolumeclaim&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#claims-as-volumes">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#claims-as-volumes&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="è§£é¢˜æ€è·¯-16">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>åˆ›å»º pv&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolume&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">safari-pv&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">local&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">capacity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/Volumes/Data&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»º pvc&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolumeClaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">safari-pvc&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥æ˜¯å¦ç»‘å®šæˆåŠŸ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pvc
NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE
safari-pvc Bound pvc-d4c15825-2de3-470f-8ed0-9519cacaad21 2Gi RWO standard 24s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»º deployment æ¨¡æ¿&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl create deployment safari --image httpd:2.4.41-alpine --dry-run&lt;span class="o">=&lt;/span>client -o yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€ç»ˆçš„yaml&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">safari&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">safari&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">safari&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">strategy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">safari&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">httpd:2.4.41-alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">httpd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/tmp/safari-data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeClaim&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">claimName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">safari-pvc&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="kubectl-å‘½ä»¤å’Œ-context">kubectl å‘½ä»¤å’Œ context&lt;/h2>
&lt;blockquote>
&lt;p>å¯ä»¥é€šè¿‡ kubectl ä¸Šä¸‹æ–‡ä»ä¸»ç»ˆç«¯è®¿é—®å¤šä¸ªé›†ç¾¤ã€‚å°†æ‰€æœ‰è¿™äº›ä¸Šä¸‹æ–‡åç§°å†™å…¥ /opt/course/1/contextsã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æ¥ä¸‹æ¥åœ¨ /opt/course/1/context_default_kubectl.sh ä¸­å†™ä¸€ä¸ªæ˜¾ç¤ºå½“å‰ä¸Šä¸‹æ–‡çš„å‘½ä»¤ï¼Œè¯¥å‘½ä»¤åº”è¯¥ä½¿ç”¨kubectlã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æœ€ååœ¨ /opt/course/1/context_default_no_kubectl.sh ä¸­å†™å…¥ç¬¬äºŒä¸ªæ‰§è¡Œç›¸åŒæ“ä½œçš„å‘½ä»¤ï¼Œä½†ä¸ä½¿ç”¨ kubectlã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-17">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;p>kubectl config ç›¸å…³å‘½ä»¤çš„ä½¿ç”¨&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-17">è§£é¢˜æ€è·¯&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl config get-contexts -o name &amp;gt; /opt/course/1/contexts
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">cat &amp;gt; /opt/course/1/context_default_kubectl.sh &lt;span class="s">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;span class="s">kubectl config current-context
&lt;/span>&lt;span class="s">EOF&lt;/span>
chmod +x /opt/course/1/context_default_kubectl.sh
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">cat ~/.kube/config &lt;span class="p">|&lt;/span> grep current-context &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å·¥ä½œè´Ÿè½½ç¼©å®¹">å·¥ä½œè´Ÿè½½ï¼šç¼©å®¹&lt;/h2>
&lt;blockquote>
&lt;p>å‘½åç©ºé—´ &lt;code>project-c13&lt;/code> ä¸­æœ‰ä¸¤ä¸ªåä¸º &lt;code>o3db-*&lt;/code> çš„ Podã€‚ C13 ç®¡ç†å±‚è¦æ±‚å°† Pod ç¼©å‡ä¸ºä¸€ä¸ªå‰¯æœ¬ä»¥èŠ‚çœèµ„æºã€‚ è®°å½•åŠ¨ä½œã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-18">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>scale&lt;/li>
&lt;li>deploy&lt;/li>
&lt;li>statefulset&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š
&lt;a href="https://kubernetes.io/zh/docs/tasks/run-application/scale-stateful-set/">https://kubernetes.io/zh/docs/tasks/run-application/scale-stateful-set/&lt;/a>
&lt;a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/#scaling-a-deployment">https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/#scaling-a-deployment&lt;/a>&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-18">è§£é¢˜æ€è·¯&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl scale &amp;lt;resource&amp;gt; xxx --replicas&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>scale å‘½ä»¤éœ€è¦ç¡®è®¤èµ„æºç±»å‹ï¼šdeployment/statefulset&lt;/p>
&lt;h2 id="åº”ç”¨å°±ç»ªå’Œæ¢æ´»">åº”ç”¨å°±ç»ªå’Œæ¢æ´»&lt;/h2>
&lt;blockquote>
&lt;p>åœ¨å‘½åç©ºé—´ &lt;code>default&lt;/code> ä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚ä¸º &lt;code>nginx:1.16.1-alpine&lt;/code> åˆ›å»ºä¸€ä¸ªåä¸º &lt;code>ready-if-service-ready&lt;/code> çš„ Podã€‚é…ç½®ä¸€ä¸ª &lt;code>LivenessProbe&lt;/code>ï¼Œå®ƒåªæ˜¯è¿è¡Œ &lt;code>true&lt;/code>ã€‚è¿˜è¦é…ç½®ä¸€ä¸ª &lt;code>ReadinessProbe&lt;/code> æ¥æ£€æŸ¥ &lt;code>url&lt;/code> &lt;code>http://service-am-i-ready:80&lt;/code> æ˜¯å¦å¯è¾¾ï¼Œå¯ä»¥ä½¿ç”¨ &lt;code>wget -T2 -O- http://service-am-i-ready:80&lt;/code>ã€‚ å¯åŠ¨ Pod å¹¶ç¡®è®¤å®ƒå› ä¸º &lt;code>ReadinessProbe&lt;/code> è€Œæ²¡æœ‰å‡†å¤‡å¥½ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>åˆ›å»ºç¬¬äºŒä¸ªåä¸º &lt;code>am-i-ready&lt;/code> çš„ Pod é•œåƒ &lt;code>nginx:1.16.1-alpine&lt;/code>ï¼Œæ ‡ç­¾ &lt;code>id:cross-server-ready&lt;/code>ã€‚å·²ç»å­˜åœ¨çš„æœåŠ¡ &lt;code>service-am-i-ready&lt;/code> ç°åœ¨åº”è¯¥æœ‰ç¬¬äºŒä¸ª Pod ä½œä¸ºç«¯ç‚¹ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-19">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>probe&lt;/li>
&lt;li>pod&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š
&lt;a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/&lt;/a>&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-19">è§£é¢˜æ€è·¯&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl run ready-if-service-ready --image nginx:1.16.1-alpine --dry-run=client -o yaml &amp;gt; ready-if-service-ready.yaml
kubectl run am-i-ready --image nginx:1.16.1-alpine --labels id=cross-server-ready --dry-run=client -o yaml &amp;gt; am-i-ready.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ·»åŠ  probes&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ready-if-service-ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ready-if-service-ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx:1.16.1-alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ready-if-service-ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">livenessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">exec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">echo&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">hi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">readinessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">exec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">wget&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">T2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">O-&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">http://service-am-i-ready:80&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterFirst&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="é›†ç¾¤æ§åˆ¶å¹³é¢">é›†ç¾¤ï¼šæ§åˆ¶å¹³é¢&lt;/h2>
&lt;blockquote>
&lt;p>ä½¿ç”¨ &lt;code>ssh cluster1-master1&lt;/code> ssh è¿›å…¥ä¸»èŠ‚ç‚¹ã€‚æ£€æŸ¥ master ç»„ä»¶ kubeletã€kube-apiserverã€kube-schedulerã€kube-controller-manager å’Œ etcd å¦‚ä½•åœ¨ master èŠ‚ç‚¹ä¸Šå¯åŠ¨/å®‰è£…ã€‚è¿˜è¦æ‰¾å‡º DNS åº”ç”¨çš„åç§°ä»¥åŠå®ƒæ˜¯å¦‚ä½•åœ¨ä¸»èŠ‚ç‚¹ä¸Šå¯åŠ¨/å®‰è£…çš„ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>å°†ç»“æœå†™å…¥æ–‡ä»¶ /opt/course/8/master-components.txtã€‚è¯¥æ–‡ä»¶çš„ç»“æ„åº”å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback"># /opt/course/8/master-components.txt
kubelet: [TYPE]
kube-apiserver: [TYPE]
kube-scheduler: [TYPE]
kube-controller-manager: [TYPE]
etcd: [TYPE]
dns: [TYPE] [NAME]
&lt;/code>&lt;/pre>&lt;/div>&lt;/blockquote>
&lt;blockquote>
&lt;p>Choices of [TYPE] are: not-installed, process, static-pod, pod&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-20">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;p>Kubernetes components çš„å®‰è£…æ–¹å¼&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-20">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>å½“å‰æ¯”è¾ƒçš„ç»„ä»¶éƒ½æ˜¯ä»¥static podçš„å½¢å¼è¿è¡Œçš„ï¼Œè€Œ static pod éƒ½æ˜¯ç”± Kubelet ç®¡ç†çš„ï¼Œæ‰€ä»¥ä» kubelet å¤„å…¥æ‰‹ã€‚&lt;/p>
&lt;p>ä»¥ minikube ä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ ps -ef &lt;span class="p">|&lt;/span> grep -w kubelet
root &lt;span class="m">140597&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> May15 ? 00:36:00 /var/lib/minikube/binaries/v1.18.8/kubelet --bootstrap-kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/bootstrap-kubelet.conf --config&lt;span class="o">=&lt;/span>/var/lib/kubelet/config.yaml --container-runtime&lt;span class="o">=&lt;/span>docker --hostname-override&lt;span class="o">=&lt;/span>cka --kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/kubelet.conf --node-ip&lt;span class="o">=&lt;/span>192.168.64.3
$ systemctl is-active kubelet
active
&lt;span class="c1">#kubelet: process&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ ¹æ®å‰é¢è¿›ç¨‹ä¸­çš„ä¿¡æ¯ï¼ŒæŸ¥çœ‹ &lt;code>/var/lib/kubelet/config.yaml&lt;/code>ä¸­çš„å†…å®¹ã€‚å¯ä»¥å¾—åˆ°ï¼š&lt;/p>
&lt;p>etcd: static-pod
kube-apiserver: static-pod
kube-controller-manager: static-pod&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ cat /var/lib/kubelet/config.yaml &lt;span class="p">|&lt;/span> grep -i staticpod
staticPodPath: /etc/kubernetes/manifests
ls /etc/kubernetes/manifests
etcd.yaml kube-apiserver.yaml kube-controller-manager.yaml kube-scheduler.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åä¸Šä¸‹dnsï¼ŒæŸ¥çœ‹ä¸‹podï¼Œå¾—çŸ¥ dns: pod&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pod -A &lt;span class="p">|&lt;/span> grep dns
kube-system coredns-66bff467f8-6k2br 1/1 Running &lt;span class="m">0&lt;/span> 32h
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åå°†ä¸Šé¢çš„ç»“æœå†™å…¥åˆ° &lt;code>/opt/course/8/master-components.txt&lt;/code>ï¼Œä¸èƒ½å‰åŠŸå°½å¼ƒã€‚&lt;/p>
&lt;h2 id="é›†ç¾¤pod-è°ƒåº¦">é›†ç¾¤ï¼šPod è°ƒåº¦&lt;/h2>
&lt;blockquote>
&lt;p>ä½¿ç”¨ &lt;code>ssh cluster2-master1&lt;/code> ssh è¿›å…¥ä¸»èŠ‚ç‚¹ã€‚æš‚æ—¶åœæ­¢ &lt;code>kube-scheduler&lt;/code>ï¼Œè¿™æ„å‘³ç€å¯ä»¥åœ¨ä¹‹åå†æ¬¡å¯åŠ¨å®ƒã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>ä¸ºé•œåƒ &lt;code>httpd:2.4-alpine&lt;/code> åˆ›å»ºä¸€ä¸ªåä¸º &lt;code>manual-schedule&lt;/code> çš„ Podï¼Œç¡®è®¤å®ƒå·²å¯åŠ¨ä½†æœªåœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šè°ƒåº¦ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>ç°åœ¨æ‚¨æ˜¯è°ƒåº¦ç¨‹åºå¹¶æ‹¥æœ‰æ‰€æœ‰æƒåŠ›ï¼Œåœ¨èŠ‚ç‚¹ &lt;code>cluster2-master1&lt;/code> ä¸Šæ‰‹åŠ¨è°ƒåº¦è¯¥ Podã€‚ ç¡®ä¿å®ƒæ­£åœ¨è¿è¡Œã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>å†æ¬¡å¯åŠ¨ &lt;code>kube-scheduler&lt;/code> å¹¶é€šè¿‡åœ¨é•œåƒ &lt;code>httpd:2.4-alpine&lt;/code> åˆ›å»ºç¬¬äºŒä¸ªåä¸º &lt;code>manual-schedule2&lt;/code> çš„ Pod å¹¶æ£€æŸ¥å®ƒæ˜¯å¦åœ¨ &lt;code>cluster2-worker1&lt;/code> ä¸Šè¿è¡Œæ¥ç¡®è®¤å…¶è¿è¡Œæ­£å¸¸ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-21">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>kubernetes ç»„ä»¶çš„è¿è¡Œæ–¹å¼&lt;/li>
&lt;li>åˆ›å»º pod&lt;/li>
&lt;li>pod è°ƒåº¦&lt;/li>
&lt;/ul>
&lt;h3 id="è§£é¢˜æ€è·¯-21">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>kube-scheduler æ˜¯ä»¥ static pod çš„æ–¹å¼è¿è¡Œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ ssh åˆ°èŠ‚ç‚¹ä¸Šï¼Œå°† scheduler çš„ yaml ç§»å‡ºï¼ˆè®°ä½ä¸è¦åˆ æ‰ï¼Œè¿˜è¦è¿˜åŸå›å»ï¼‰ï¼Œé‡å¯ kubelet&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ ps -ef &lt;span class="p">|&lt;/span> grep -w kubelet
root &lt;span class="m">140597&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> May15 ? 00:36:00 /var/lib/minikube/binaries/v1.18.8/kubelet --bootstrap-kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/bootstrap-kubelet.conf --config&lt;span class="o">=&lt;/span>/var/lib/kubelet/config.yaml --container-runtime&lt;span class="o">=&lt;/span>docker --hostname-override&lt;span class="o">=&lt;/span>cka --kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/kubelet.conf --node-ip&lt;span class="o">=&lt;/span>192.168.64.3
$ cat /var/lib/kubelet/config.yaml &lt;span class="p">|&lt;/span> grep -i staticpod
staticPodPath: /etc/kubernetes/manifests
$ ls /etc/kubernetes/manifests
etcd.yaml kube-apiserver.yaml kube-controller-manager.yaml kube-scheduler.yaml
$ mv /etc/kubernetes/manifests/kube-scheduler.yaml /etc/kubernetes
$ systemctl restart kubelet
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥ä¸‹ schedule pod æ²¡æœ‰è¿è¡Œï¼Œç„¶åå°è¯•åˆ›å»º podï¼Œå¹¶æŸ¥çœ‹ pod å¤„äº pending çŠ¶æ€ï¼Œå³æ²¡æœ‰ kube-scheduler ä¸ºå…¶è°ƒåº¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl run manual-schedule --image httpd:2.4-alpine
$ kubectl get pod &lt;span class="p">|&lt;/span> grep manual-schedule
manual-schedule 0/1 Pending &lt;span class="m">0&lt;/span> 16s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰‹åŠ¨è°ƒåº¦ï¼Œå³ä¸º pod æŒ‡å®šä¸€ä¸ª &lt;code>nodeName&lt;/code>ï¼Œæˆ‘çš„ minikube åªæœ‰ä¸€ä¸ª node åä¸º ckaï¼Œä¿®æ”¹podï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pod manual-schedule -o yaml &amp;gt; manual-schedule.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ·»åŠ  nodeName ä¹‹å&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2021-05-16T07:27:16Z&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">manual-schedule&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">manual-schedule&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dev&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resourceVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;84805&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selfLink&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/api/v1/namespaces/dev/pods/manual-schedule&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">uid&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">c4b592f6-1e07-4911-a7fe-867d813c7a55&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">httpd:2.4-alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">IfNotPresent&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">manual-schedule&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">terminationMessagePath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/dev/termination-log&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">terminationMessagePolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">File&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/var/run/secrets/kubernetes.io/serviceaccount&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default-token-v7f28&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">readOnly&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterFirst&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">nodeName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cka&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#node name here&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">enableServiceLinks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">priority&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">schedulerName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default-scheduler&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">securityContext&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceAccount&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceAccountName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">terminationGracePeriodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tolerations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">effect&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NoExecute&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">node.kubernetes.io/not-ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Exists&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tolerationSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">300&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">effect&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NoExecute&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">node.kubernetes.io/unreachable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Exists&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tolerationSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">300&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default-token-v7f28&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secret&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">defaultMode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">420&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default-token-v7f28&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">phase&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pending&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">qosClass&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">BestEffort&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¼ºåˆ¶æ›´æ–° podï¼ˆè¿è¡Œæ—¶åªèƒ½ä¿®æ”¹éƒ¨åˆ†å†…å®¹ï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl replace -f manual-schedule.yaml --force
pod &lt;span class="s2">&amp;#34;manual-schedule&amp;#34;&lt;/span> deleted
pod/manual-schedule replaced
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†æ¬¡æ£€æŸ¥&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pod &lt;span class="p">|&lt;/span> grep manual-schedule
manual-schedule 1/1 Running &lt;span class="m">0&lt;/span> 15s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¢å¤ kube-scheduler çš„è¿è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ mv /etc/kubernetes/kube-scheduler.yaml /etc/kubernetes/manifests
$ systemctl restart kubelet
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥æ˜¯å¦è¿è¡Œ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pod -A &lt;span class="p">|&lt;/span> grep kube-scheduler
kube-system kube-scheduler-cka 1/1 Running &lt;span class="m">0&lt;/span> 66s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»ºç¬¬äºŒä¸ªpodï¼Œå¹¶æ£€æŸ¥æ˜¯å¦åœ¨è¿è¡Œï¼ˆrunningï¼‰çŠ¶æ€&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl run manual-schedule2 --image httpd:2.4-alpine
pod/manual-schedule2 created
kubectl get pod manual-schedule2
NAME READY STATUS RESTARTS AGE
manual-schedule2 1/1 Running &lt;span class="m">0&lt;/span> 6s
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="é›†ç¾¤å¤‡ä»½åŠæ¢å¤-1">é›†ç¾¤ï¼šå¤‡ä»½åŠæ¢å¤&lt;/h2>
&lt;blockquote>
&lt;p>å¯¹åœ¨ &lt;code>cluster3-master1&lt;/code> ä¸Šè¿è¡Œçš„ etcd è¿›è¡Œå¤‡ä»½ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨ä¸»èŠ‚ç‚¹ä¸Šçš„ &lt;code>/tmp/etcd-backup.db&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>ç„¶ååœ¨é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªä½ å–œæ¬¢çš„ Podã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æœ€åæ¢å¤å¤‡ä»½ï¼Œç¡®è®¤é›†ç¾¤ä»åœ¨å·¥ä½œå¹¶ä¸”åˆ›å»ºçš„ Pod ä¸å†ä¸æˆ‘ä»¬åœ¨ä¸€èµ·ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-22">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>etc çš„ä½œç”¨ï¼šå­˜å‚¨é›†ç¾¤çš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬ pod ä¿¡æ¯&lt;/li>
&lt;li>etc çš„å¤‡ä»½å’Œæ¢å¤&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š
&lt;a href="https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster">https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster&lt;/a>&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-22">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>etcdçš„å‘½ä»¤æ‰§è¡Œï¼Œè®°å¾—è®¾ç½®APIçš„ç‰ˆæœ¬ &lt;code>ETCDCTL_API=3&lt;/code>&lt;/p>
&lt;p>æ“ä½œ etcd éœ€è¦ &lt;code>endpoints&lt;/code>ã€&lt;code>cacert&lt;/code>ã€&lt;code>cert&lt;/code>ã€&lt;code>key&lt;/code>ã€‚Kubernetes çš„æ‰€æœ‰ç»„ä»¶ä¸ etcd çš„æ•°æ®äº¤äº’éƒ½æ˜¯é€šè¿‡ api-server å®Œæˆçš„ï¼Œæˆ‘åªéœ€è¦æ‰¾åˆ° api-server çš„è¿è¡Œå‘½ä»¤å°±è¡Œï¼Œä¸¤ç§æ–¹å¼ï¼šåˆ° master ä¸»æœºæŸ¥çœ‹ api-server çš„è¿›ç¨‹ï¼›æˆ–è€…å» api-server çš„ pod æŸ¥çœ‹ &lt;code>.spec.containers[].command&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#ssh to master&lt;/span>
$ ps -ef &lt;span class="p">|&lt;/span> grep kube-apiserver
$ kubectl get pod -n kube-system kube-apiserver-cka -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{.spec.containers[].command}&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>etcd å¤‡ä»½ï¼Œå‘½ä»¤ç›´æ¥ä» Kubernetes å®˜æ–¹æ–‡æ¡£å¤åˆ¶å†ä¿®æ”¹&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#ssh to master&lt;/span>
&lt;span class="nv">$ETCDCTL_API&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span> etcdctl --endpoints&lt;span class="o">=&lt;/span>https://127.0.0.1:2379 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --cacert&lt;span class="o">=&lt;/span>/var/lib/minikube/certs/etcd/ca.crt --cert&lt;span class="o">=&lt;/span>/var/lib/minikube/certs/apiserver-etcd-client.crt --key&lt;span class="o">=&lt;/span>/var/lib/minikube/certs/apiserver-etcd-client.key &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> snapshot save /tmp/etcd-backup.db
Snapshot saved at /tmp/etcd-backup.db
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»º pod&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl run sleep1d --image busybox --command -- sleep 1d
&lt;span class="c1">#æ£€æŸ¥ pod è¿è¡Œæƒ…å†µ&lt;/span>
$ kubectl get pod
NAME READY STATUS RESTARTS AGE
sleep1d 1/1 Running &lt;span class="m">0&lt;/span> 10s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¢å¤ etcd çš„å¤‡ä»½ï¼Œå¤åˆ¶å‰é¢çš„å‘½ä»¤å¹¶ä¿®æ”¹ï¼Œæ¢å¤å¤‡ä»½åˆ° &lt;code>/var/lib/etcd-backup&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ &lt;span class="nv">ETCDCTL_API&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span> etcdctl --endpoints&lt;span class="o">=&lt;/span>https://127.0.0.1:2379 --cacert&lt;span class="o">=&lt;/span>/var/lib/minikube/certs/etcd/ca.crt --cert&lt;span class="o">=&lt;/span>/var/lib/minikube/certs/apiserver-etcd-client.crt --key&lt;span class="o">=&lt;/span>/var/lib/minikube/certs/apiserver-etcd-client.key snapshot restore /tmp/etcd-backup.db --data-dir /var/lib/etcd-backup
2021-05-16 08:09:17.797061 I &lt;span class="p">|&lt;/span> mvcc: restore compact to &lt;span class="m">85347&lt;/span>
2021-05-16 08:09:17.803208 I &lt;span class="p">|&lt;/span> etcdserver/membership: added member 8e9e05c52164694d &lt;span class="o">[&lt;/span>http://localhost:2380&lt;span class="o">]&lt;/span> to cluster cdf818194e3a8c32
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹ etcd çš„é…ç½®ï¼Œ &lt;code>/etc/kubernetes/manifests/etcd.yaml&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/var/lib/minikube/certs/etcd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">DirectoryOrCreate&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">etcd-certs&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/var/lib/etcd-backup &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#åŸæ¥æ˜¯/var/lib/minikube/etcd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">DirectoryOrCreate&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">etcd-data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿å­˜åé‡å¯kubelet&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ systemctl restart kubelet
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥podæ˜¯å¦å­˜åœ¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pod sleep1d
Error from server &lt;span class="o">(&lt;/span>NotFound&lt;span class="o">)&lt;/span>: pods &lt;span class="s2">&amp;#34;sleep1d&amp;#34;&lt;/span> not found
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å®‰å…¨ç½‘ç»œç­–ç•¥">å®‰å…¨ï¼šç½‘ç»œç­–ç•¥&lt;/h2>
&lt;blockquote>
&lt;p>å‘ç”Ÿäº†ä¸€èµ·å®‰å…¨äº‹ä»¶ï¼Œå…¥ä¾µè€…èƒ½å¤Ÿä»ä¸€ä¸ªè¢«é»‘çš„åç«¯ Pod è®¿é—®æ•´ä¸ªé›†ç¾¤ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œåœ¨å‘½åç©ºé—´ &lt;code>project-snake&lt;/code> ä¸­åˆ›å»ºä¸€ä¸ªåä¸º &lt;code>np-backend&lt;/code> çš„ &lt;code>NetworkPolicy&lt;/code>ã€‚å®ƒåº”è¯¥åªå…è®¸ &lt;code>backend-*&lt;/code> Podsï¼š&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>è¿æ¥åˆ°ç«¯å£ &lt;code>1111&lt;/code> ä¸Šçš„ &lt;code>db1-*&lt;/code> Pod
è¿æ¥åˆ°ç«¯å£ &lt;code>2222&lt;/code> ä¸Šçš„ &lt;code>db2-*&lt;/code> Pod
åœ¨ç­–ç•¥ä¸­ä½¿ç”¨ Pod çš„åº”ç”¨ç¨‹åºæ ‡ç­¾ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>å®æ–½åï¼Œä¾‹å¦‚ï¼Œç«¯å£ 3333 ä¸Šä» &lt;code>backend-*&lt;/code> Pod åˆ° &lt;code>vault-*&lt;/code> Pod çš„è¿æ¥åº”è¯¥ä¸å†æœ‰æ•ˆã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-23">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>NetworkPolicy&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š
&lt;a href="https://kubernetes.io/docs/concepts/services-networking/network-policies">https://kubernetes.io/docs/concepts/services-networking/network-policies&lt;/a>&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-23">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>ä¸º backend-* pod è®¾ç½® egress çš„ NetworkPolicyï¼Œåªå…è®¸å…¶è®¿é—® db1-* çš„ 1111 ç«¯å£å’Œ db2-* çš„ 2222 ç«¯å£ï¼Œç­–ç•¥ä¸­ä½¿ç”¨ app label æ¥è¿›è¡ŒåŒ¹é…ã€‚&lt;/p>
&lt;p>ä» Kubernetes å®˜ç½‘æ–‡æ¡£ä¸­å¤åˆ¶ä¸€æ®µyamlé…ç½®è¿›è¡Œä¿®æ”¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">networking.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NetworkPolicy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">np-backend&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">project-snake&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">podSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">backend&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">policyTypes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">Egress&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">egress&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">to&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">podSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">db1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1111&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">to&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">podSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">db2 &lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">2222&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‡è®¾ backend pod çš„ app label ä¸º backendï¼Œdb1 çš„ ä¸º db1ï¼Œdb2 çš„ä¸º db2ã€‚&lt;/p>
&lt;p>åˆ›å»ºç¯å¢ƒï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl run backend --image nginx --labels &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>backend
$ kubectl run db1 --image nginx --labels &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>db1
$ kubectl run db2 --image nginx --labels &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>db2
$ kubectl run vault --image nginx --labels &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>vault
$ kubectl get pod -L app
NAME READY STATUS RESTARTS AGE APP
backend 1/1 Running &lt;span class="m">0&lt;/span> 13s backend
db1 1/1 Running &lt;span class="m">0&lt;/span> 66s db1
db2 1/1 Running &lt;span class="m">0&lt;/span> 71s db2
vault 1/1 Running &lt;span class="m">0&lt;/span> 79s vault
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±äºæˆ‘ä»¬ç”¨çš„ nginx é•œåƒï¼Œå°†å‰é¢çš„ NetworkPolicy ç«¯å£ä¿®æ”¹ä¸€ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">networking.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NetworkPolicy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">np-backend&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">podSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">backend&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">policyTypes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">Egress&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">egress&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">to&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">podSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">db1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">to&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">podSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">db2 &lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥ä¸€ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get networkpolicy
NAME POD-SELECTOR AGE
np-backend &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>backend 31s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æµ‹è¯•ä¸‹ç½‘ç»œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#è·å–pod ip&lt;/span>
$ kubectl get pod -o wide
NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
backend 1/1 Running &lt;span class="m">0&lt;/span> 3m15s 172.17.0.7 cka &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
db1 1/1 Running &lt;span class="m">0&lt;/span> 4m8s 172.17.0.6 cka &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
db2 1/1 Running &lt;span class="m">0&lt;/span> 4m13s 172.17.0.3 cka &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
vault 1/1 Running &lt;span class="m">0&lt;/span> 4m21s 172.17.0.4 cka &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="é›†ç¾¤kubelet-å¯åŠ¨æ–¹å¼">é›†ç¾¤ï¼škubelet å¯åŠ¨æ–¹å¼&lt;/h2>
&lt;blockquote>
&lt;p>èŠ‚ç‚¹ &lt;code>cluster2-worker1&lt;/code> å·²ä½¿ç”¨ kubeadm å’Œ TLS å¼•å¯¼æ·»åŠ åˆ°é›†ç¾¤ä¸­ã€‚
æ‰¾åˆ° &lt;code>cluster2-worker1&lt;/code> çš„ â€œIssuerâ€ å’Œ â€œExtended Key Usageâ€ å€¼ï¼š
kubelet å®¢æˆ·ç«¯è¯ä¹¦ï¼Œç”¨äºå‘å¤–è¿æ¥åˆ° kube-apiserver çš„è¯ä¹¦ã€‚
kubelet æœåŠ¡å™¨è¯ä¹¦ï¼Œç”¨äºæ¥è‡ª kube-apiserver çš„ä¼ å…¥è¿æ¥ã€‚
å°†ä¿¡æ¯å†™å…¥æ–‡ä»¶ &lt;code>/opt/course/23/certificate-info.txt&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="çŸ¥è¯†ç‚¹-24">çŸ¥è¯†ç‚¹&lt;/h2>
&lt;ul>
&lt;li>kubelet çš„åŠŸèƒ½ï¼šè¿æ¥ api-serverï¼›æ¥å—æ¥è‡ª api-server çš„å“åº”ã€‚ä¸¤ç§æƒ…å†µéƒ½éœ€è¦ TLS&lt;/li>
&lt;/ul>
&lt;h3 id="è§£é¢˜æ€è·¯-24">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>kubelet è¿æ¥ apiserver çš„æ–¹å¼åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå…ˆæ‰¾å‡ºé…ç½®æ–‡ä»¶çš„ä¿å­˜ä½ç½®ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># ssh åˆ°èŠ‚ç‚¹ä¸Šï¼ŒæŸ¥çœ‹ kubelet çš„å¯åŠ¨å‘½ä»¤&lt;/span>
$ ps -ef &lt;span class="p">|&lt;/span> grep kubelet
root &lt;span class="m">3935&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> 12:54 ? 00:00:23 /var/lib/minikube/binaries/v1.20.0/kubelet --bootstrap-kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/bootstrap-kubelet.conf --cni-conf-dir&lt;span class="o">=&lt;/span>/etc/cni/net.mk --config&lt;span class="o">=&lt;/span>/var/lib/kubelet/config.yaml --container-runtime&lt;span class="o">=&lt;/span>docker --hostname-override&lt;span class="o">=&lt;/span>cka-m02 --kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/kubelet.conf --network-plugin&lt;span class="o">=&lt;/span>cni --node-ip&lt;span class="o">=&lt;/span>192.168.64.9
docker &lt;span class="m">13653&lt;/span> &lt;span class="m">13616&lt;/span> &lt;span class="m">0&lt;/span> 13:22 pts/0 00:00:00 grep kubelet
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#kubelet è¿æ¥ api server çš„ä¿¡æ¯ï¼Œ client cert çš„é…ç½®æ‰€åœ¨ /var/lib/kubelet/pki/kubelet-client-current.pem&lt;/span>
cat /var/lib/kubelet/config.yaml
&lt;span class="c1">#kubelet çš„å¯åŠ¨ä¿¡æ¯ï¼Œ servert cert çš„é…ç½®æ‰€åœ¨ /var/lib/minikube/certs/ca.crt&lt;/span>
cat /etc/kubernetes/kubelet.conf
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ openssl x509 -noout -text -in /var/lib/kubelet/pki/kubelet-client-current.pem &lt;span class="p">|&lt;/span> grep -i issuer
Issuer: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> minikubeCA
$ openssl x509 -noout -text -in /var/lib/kubelet/pki/kubelet-client-current.pem &lt;span class="p">|&lt;/span> grep -i -A1 extended
X509v3 Extended Key Usage:
TLS Web Client Authentication
$ openssl x509 -noout -text -in /var/lib/minikube/certs/ca.crt &lt;span class="p">|&lt;/span> grep -i issuer
Issuer: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> minikubeCA
$ openssl x509 -noout -text -in /var/lib/minikube/certs/ca.crt &lt;span class="p">|&lt;/span> grep -i -A1 extended
X509v3 Extended Key Usage:
TLS Web Client Authentication, TLS Web Server Authentication
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åè®°å¾—å°†ä¿¡æ¯å†™å…¥åˆ° &lt;code>/opt/course/23/certificate-info.txt&lt;/code>&lt;/p>
&lt;h2 id="é›†ç¾¤è¯ä¹¦">é›†ç¾¤ï¼šè¯ä¹¦&lt;/h2>
&lt;blockquote>
&lt;p>æ£€æŸ¥ kube-apiserver æœåŠ¡å™¨è¯ä¹¦åœ¨ &lt;code>cluster2-master1&lt;/code> ä¸Šçš„æœ‰æ•ˆæœŸã€‚ä½¿ç”¨ openssl æˆ– cfssl æ‰§è¡Œæ­¤æ“ä½œã€‚å°†åˆ°æœŸæ—¥æœŸå†™å…¥ &lt;code>/opt/course/22/expiration&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>åŒæ—¶è¿è¡Œæ­£ç¡®çš„ kubeadm å‘½ä»¤ä»¥åˆ—å‡ºåˆ°æœŸæ—¥æœŸå¹¶ç¡®è®¤ä¸¤ç§æ–¹æ³•æ˜¾ç¤ºç›¸åŒçš„æ—¥æœŸã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>å°†æ›´æ–° apiserver æœåŠ¡å™¨è¯ä¹¦çš„æ­£ç¡® kubeadm å‘½ä»¤å†™å…¥ &lt;code>/opt/course/22/kubeadm-renew-certs.sh&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-25">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>api-server&lt;/li>
&lt;li>openssl&lt;/li>
&lt;li>kubeadm&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#check-certificate-expiration&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-25">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>é€šè¿‡ kube-apiserver pod çš„å¯åŠ¨å‘½ä»¤ï¼Œæˆ–è€… ssh åˆ° master æ¥æŸ¥çœ‹å‘½ä»¤å‚æ•°ï¼Œ&lt;code>tls-cert-file=/var/lib/minikube/certs/apiserver.crt&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ openssl x509 -noout -text -in /var/lib/minikube/certs/apiserver.crt &lt;span class="p">|&lt;/span> grep -i valid -A2
Validity
Not Before: May &lt;span class="m">13&lt;/span> 22:33:43 &lt;span class="m">2021&lt;/span> GMT
Not After : May &lt;span class="m">14&lt;/span> 22:33:43 &lt;span class="m">2022&lt;/span> GMT
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°† &lt;code>May 14 22:33:43 2022 GMT&lt;/code> å†™å…¥ &lt;code>/opt/course/22/expiration&lt;/code>&lt;/p>
&lt;p>é€šè¿‡ kubeadm æ¥æ£€æŸ¥&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">$ kubeadm certs check-expiration | grep -i apiserver
#macos æ— æ³•å®‰è£… kubeadm
#minikube æ— æ³•ä½¿ç”¨ kubeadm æ£€æŸ¥
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°† &lt;code>kubeadm certs renew apiserver&lt;/code> å†™å…¥ /opt/course/22/kubeadm-renew-certs.sh&lt;/p>
&lt;h2 id="é›†ç¾¤å‡çº§èŠ‚ç‚¹">é›†ç¾¤ï¼šå‡çº§èŠ‚ç‚¹&lt;/h2>
&lt;blockquote>
&lt;p>ä½ çš„åŒäº‹è¯´èŠ‚ç‚¹ &lt;code>cluster3-worker2&lt;/code> è¿è¡Œçš„æ˜¯è¾ƒæ—§çš„ Kubernetes ç‰ˆæœ¬ï¼Œç”šè‡³ä¸å±äºé›†ç¾¤çš„ä¸€éƒ¨åˆ†ã€‚å°† kubectl å’Œ kubeadm æ›´æ–°ä¸ºåœ¨ &lt;code>cluster3-master1&lt;/code> ä¸Šè¿è¡Œçš„ç¡®åˆ‡ç‰ˆæœ¬ã€‚ç„¶åå°†æ­¤èŠ‚ç‚¹æ·»åŠ åˆ°é›†ç¾¤ä¸­ï¼Œæ‚¨å¯ä»¥ä¸ºæ­¤ä½¿ç”¨kubeadmã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-26">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>kubeadm å‡çº§é›†ç¾¤&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š&lt;/p>
&lt;h3 id="è§£é¢˜æ€è·¯-26">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>æ£€æŸ¥node&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get nodes
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥å½“å‰ç»„ä»¶ç‰ˆæœ¬&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ ssh cluster3-worker2
$ kubeadm version
$ kubectl version --short
Client Version: vx.xx.x
Server Version: vx.xx.x
$ kubelet --version
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">#ä½¿ç”¨å‘½ä»¤å¹¶å‡çº§å„ä¸ªç»„ä»¶ï¼Œå¹¶é‡å¯ kubelet
#å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œä¸€èˆ¬æ˜¯éœ€è¦tokenè¿æ¥åˆ°api-serverï¼Œéœ€è¦sshåˆ°masterä¸Šè¿è¡Œ kubeadm create token --print-join-command
#å†sshåˆ° nodeä¸Šï¼Œæ‰§è¡Œæ‰“å°çš„å‘½ä»¤ï¼Œé‡å¯kubeletå¹¶æ£€æŸ¥è£…å¡«
#æœ€åæ£€æŸ¥nodeæ˜¯å¦æˆåŠŸåŠ å…¥é›†ç¾¤
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="docker-å‘½ä»¤">Docker å‘½ä»¤&lt;/h2>
&lt;blockquote>
&lt;p>åœ¨å‘½åç©ºé—´ &lt;code>project-tiger&lt;/code> ä¸­åˆ›å»ºä¸€ä¸ªåä¸º &lt;code>Tigers-reunite&lt;/code> çš„ Pod é•œåƒ &lt;code>httpd:2.4.41-alpine&lt;/code>ï¼Œæ ‡ç­¾ä¸º &lt;code>pod=container&lt;/code> å’Œ &lt;code>container=pod&lt;/code>ã€‚æ‰¾å‡º Pod è¢«å®‰æ’åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šã€‚ssh è¿›å…¥è¯¥èŠ‚ç‚¹å¹¶æ‰¾åˆ°å±äºè¯¥ Pod çš„ docker å®¹å™¨ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>å°†å®¹å™¨çš„ docker ID å’Œè¿™äº›æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹/å‘½ä»¤å†™å…¥ &lt;code>/opt/course/17/pod-container.txt&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æœ€åï¼Œä½¿ç”¨ docker å‘½ä»¤å°†ä¸» Docker å®¹å™¨ï¼ˆæ¥è‡ª yaml ä¸­æŒ‡å®šçš„é‚£ä¸ªï¼‰çš„æ—¥å¿—å†™å…¥ &lt;code>/opt/course/17/pod-container.log&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çŸ¥è¯†ç‚¹-27">çŸ¥è¯†ç‚¹&lt;/h3>
&lt;ul>
&lt;li>docker å‘½ä»¤ï¼špsã€logsã€inspect&lt;/li>
&lt;/ul>
&lt;h3 id="è§£é¢˜æ€è·¯-27">è§£é¢˜æ€è·¯&lt;/h3>
&lt;p>åˆ›å»º pod&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl run tigers-reunite --image httpd:2.4.41-alpine --labels &lt;span class="nv">pod&lt;/span>&lt;span class="o">=&lt;/span>container,container&lt;span class="o">=&lt;/span>pod
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥ pod çš„ä¿¡æ¯&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pods --show-labels
NAME READY STATUS RESTARTS AGE LABELS
tigers-reunite 1/1 Running &lt;span class="m">0&lt;/span> 34s &lt;span class="nv">container&lt;/span>&lt;span class="o">=&lt;/span>pod,pod&lt;span class="o">=&lt;/span>container
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è·å–podæ‰€åœ¨çš„èŠ‚ç‚¹&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pod tigers-reunite -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{.spec.nodeName}&amp;#39;&lt;/span>
cka
&lt;/code>&lt;/pre>&lt;/div>&lt;p>sshåˆ°èŠ‚ç‚¹ä¸Š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker ps &lt;span class="p">|&lt;/span> grep tigers-reunite
e6ff69b437bc 54b0995a6305 &lt;span class="s2">&amp;#34;httpd-foreground&amp;#34;&lt;/span> About a minute ago Up About a minute k8s_tigers-reunite_tigers-reunite_dev_53391212-911d-4275-a19d-e8f8b0f85a98_0
06d3ca65eb08 k8s.gcr.io/pause:3.2 &lt;span class="s2">&amp;#34;/pause&amp;#34;&lt;/span> About a minute ago Up About a minute k8s_POD_tigers-reunite_dev_53391212-911d-4275-a19d-e8f8b0f85a98_0
&lt;span class="c1">#ä½¿ç”¨docker inspect æˆ–è€… è¿›å…¥å®¹å™¨ç›´æ¥æŸ¥çœ‹è¿›ç¨‹&lt;/span>
$ docker inspect e6ff69b437bc &lt;span class="p">|&lt;/span> grep -i &lt;span class="s1">&amp;#39;cmd\|entrypoint&amp;#39;&lt;/span> -A1
&lt;span class="s2">&amp;#34;Cmd&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;span class="s2">&amp;#34;httpd-foreground&amp;#34;&lt;/span>
--
&lt;span class="s2">&amp;#34;Entrypoint&amp;#34;&lt;/span>: null,
&lt;span class="s2">&amp;#34;OnBuild&amp;#34;&lt;/span>: null,
$ docker inspect 06d3ca65eb08 &lt;span class="p">|&lt;/span> grep -i &lt;span class="s1">&amp;#39;cmd\|entrypoint&amp;#39;&lt;/span> -A1
&lt;span class="s2">&amp;#34;Cmd&amp;#34;&lt;/span>: null,
&lt;span class="s2">&amp;#34;Image&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;k8s.gcr.io/pause:3.2&amp;#34;&lt;/span>,
--
&lt;span class="s2">&amp;#34;Entrypoint&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;span class="s2">&amp;#34;/pause&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æœå†™å…¥æ–‡ä»¶&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">e6ff69b437bc httpd-foreground
06d3ca65eb08 pause
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†™æ—¥å¿—åˆ°æ–‡ä»¶&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="l">docker logs e6ff69b437bc &amp;gt; /opt/course/17/pod-container.log&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>å¸¸ç”¨çš„å‡ æ¬¾å·¥å…·è®© Kubernetes é›†ç¾¤ä¸Šçš„å·¥ä½œæ›´å®¹æ˜“</title><link>https://atbug.com/tools-accelerate-work-on-kubernetes-cluster/</link><pubDate>Sat, 26 Jun 2021 12:16:28 +0800</pubDate><guid>https://atbug.com/tools-accelerate-work-on-kubernetes-cluster/</guid><description>
&lt;p>ä¹‹å‰å†™è¿‡ä¸€ç¯‡ &lt;a href="https://mp.weixin.qq.com/s/CXJ1zUoktdI3c3CHVju0gA">ä»‹ç»äº†å·¥å…·åŠ é€Ÿäº‘åŸç”Ÿ Java å¼€å‘&lt;/a>ã€‚&lt;/p>
&lt;p>å…¶å®æ—¥å¸¸å·¥ä½œä¸­åœ¨é›†ç¾¤ä¸Šçš„æ“ä½œä¹Ÿéå¸¸å¤šï¼Œä»Šå¤©å°±æ¥ä»‹ç»æˆ‘æ‰€ä½¿ç”¨çš„å·¥å…·ã€‚&lt;/p>
&lt;h2 id="kubectl-alias">kubectl-alias&lt;/h2>
&lt;p>ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„å·¥å…·ï¼Œæˆ‘è‡ªå·±ç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹ï¼ŒåŠ å…¥äº† &lt;code>StatefulSet&lt;/code> çš„æ”¯æŒã€‚&lt;/p>
&lt;p>è¿™ä¸ªæ˜¯æˆ‘çš„ &lt;a href="https://github.com/addozhang/kubectl-aliases">https://github.com/addozhang/kubectl-aliases&lt;/a>ï¼ŒåŸºäº &lt;a href="https://github.com/ahmetb/kubectl-aliases">https://github.com/ahmetb/kubectl-aliases&lt;/a>ã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¾“å‡ºæŸä¸ª pod çš„ jsonï¼Œ&lt;code>kgpoojson xxx&lt;/code> ç­‰åŒäº &lt;code>kubectl get pod xxx -o json&lt;/code>ã€‚&lt;/p>
&lt;p>ç»“åˆ &lt;a href="https://stedolan.github.io/jq/">jq&lt;/a> ä½¿ç”¨æ•ˆæœæ›´å¥½ ğŸ˜‚ã€‚&lt;/p>
&lt;h3 id="è¯­æ³•è§£è¯»">è¯­æ³•è§£è¯»&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>&lt;code>k&lt;/code>&lt;/strong>=&lt;code>kubectl&lt;/code>
&lt;ul>
&lt;li>&lt;strong>&lt;code>sys&lt;/code>&lt;/strong>=&lt;code>--namespace kube-system&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>commands:
&lt;ul>
&lt;li>&lt;strong>&lt;code>g&lt;/code>&lt;/strong>=&lt;code>get&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>d&lt;/code>&lt;/strong>=&lt;code>describe&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>rm&lt;/code>&lt;/strong>=&lt;code>delete&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>a&lt;/code>&lt;/strong>:&lt;code>apply -f&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>ak&lt;/code>&lt;/strong>:&lt;code>apply -k&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>k&lt;/code>&lt;/strong>:&lt;code>kustomize&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>ex&lt;/code>&lt;/strong>:Â &lt;code>exec -i -t&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>lo&lt;/code>&lt;/strong>:Â &lt;code>logs -f&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>resources:
&lt;ul>
&lt;li>&lt;strong>&lt;code>po&lt;/code>&lt;/strong>=pod,Â &lt;strong>&lt;code>dep&lt;/code>&lt;/strong>=&lt;code>deployment&lt;/code>,Â &lt;strong>&lt;code>ing&lt;/code>&lt;/strong>=&lt;code>ingress&lt;/code>,Â &lt;strong>&lt;code>svc&lt;/code>&lt;/strong>=&lt;code>service&lt;/code>,Â &lt;strong>&lt;code>cm&lt;/code>&lt;/strong>=&lt;code>configmap&lt;/code>,Â &lt;strong>&lt;code>sec&lt;/code>=&lt;code>secret&lt;/code>&lt;/strong>,&lt;strong>&lt;code>ns&lt;/code>&lt;/strong>=&lt;code>namespace&lt;/code>,Â &lt;strong>&lt;code>no&lt;/code>&lt;/strong>=&lt;code>node&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>flags:
&lt;ul>
&lt;li>output format:Â &lt;strong>&lt;code>oyaml&lt;/code>&lt;/strong>,Â &lt;strong>&lt;code>ojson&lt;/code>&lt;/strong>,Â &lt;strong>&lt;code>owide&lt;/code>&lt;/strong>&lt;/li>
&lt;li>&lt;strong>&lt;code>all&lt;/code>&lt;/strong>:Â &lt;code>--all&lt;/code>Â orÂ &lt;code>--all-namespaces&lt;/code>Â depending on the command&lt;/li>
&lt;li>&lt;strong>&lt;code>sl&lt;/code>&lt;/strong>:Â &lt;code>--show-labels&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>w&lt;/code>&lt;/strong>=&lt;code>-w/--watch&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>value flags (should be at the end):
&lt;ul>
&lt;li>&lt;strong>&lt;code>n&lt;/code>&lt;/strong>=&lt;code>-n/--namespace&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>f&lt;/code>&lt;/strong>=&lt;code>-f/--filename&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>l&lt;/code>&lt;/strong>=&lt;code>-l/--selector&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="kubectx--kubens">kubectx + kubens&lt;/h2>
&lt;p>&lt;a href="https://github.com/ahmetb/kubectx#installation">å®‰è£…çœ‹è¿™é‡Œ&lt;/a>&lt;/p>
&lt;p>&lt;code>kubectx&lt;/code> ç”¨äºåœ¨ä¸åŒçš„é›†ç¾¤é—´è¿›è¡Œå¿«é€Ÿåˆ‡æ¢ã€‚å‡å¦‚ç”¨ &lt;code>kubectl&lt;/code>ï¼Œä½ éœ€è¦ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># context åˆ—è¡¨&lt;/span>
kubectl config current-context
&lt;span class="c1"># è®¾ç½® context&lt;/span>
kubectl config use-context coffee
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/kubectxdemo.gif" alt="kubectx-demo">&lt;/p>
&lt;p>&lt;code>kubens&lt;/code> å°±æ˜¯åœ¨ä¸åŒ namespace é—´å¿«é€Ÿåˆ‡æ¢çš„å·¥å…·ã€‚ç”¨ &lt;code>kubectl&lt;/code> çš„è¯ï¼Œéœ€è¦ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># namespace åˆ—è¡¨&lt;/span>
kbuectl get ns
&lt;span class="c1"># kubectl config set-context --current --namespace=kube-system&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/kubensdemo.gif" alt="kubens-demo">&lt;/p>
&lt;h2 id="k9s">k9s&lt;/h2>
&lt;p>æ²¡é”™ï¼Œåªæ¯” k8s å¤šäº†ä¸ª 1 ğŸ˜‚ã€‚&lt;/p>
&lt;p>&lt;a href="https://github.com/derailed/k9s">k9s&lt;/a> æä¾›äº†ç»ˆç«¯ UI ä¸ Kubernetes é›†ç¾¤è¿›è¡Œç¼–è¾‘äº¤äº’ã€‚æœ¬äººå¸¸ç”¨çš„æ¯”å¦‚ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>F&lt;/code> é…ç½®ç«¯å£è½¬å‘&lt;/li>
&lt;li>&lt;code>l&lt;/code> è¾“å‡º pod æ—¥å¿—&lt;/li>
&lt;li>&lt;code>e&lt;/code> ä¿®æ”¹èµ„æºå¯¹è±¡&lt;/li>
&lt;li>&lt;code>s&lt;/code> pod ç»ˆç«¯äº¤äº’æ¨¡å¼&lt;/li>
&lt;li>&lt;code>y&lt;/code> yaml æ–¹å¼è¾“å‡ºèµ„æºå¯¹è±¡&lt;/li>
&lt;li>&lt;code>d&lt;/code> describe èµ„æºå¯¹è±¡&lt;/li>
&lt;li>&lt;code>ctrl+d&lt;/code> åˆ é™¤ pod&lt;/li>
&lt;/ul>
&lt;p>å¯åŠ¨æ–¹å¼&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># æŒ‡å®š namespace è¿è¡Œ&lt;/span>
k9s -n mycoolns
&lt;span class="c1"># æŒ‡å®š context è¿è¡Œ&lt;/span>
k9s --context coolCtx
&lt;span class="c1"># åªè¯»æ¨¡å¼è¿è¡Œ&lt;/span>
k9s --readonly
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626102731.png" alt="k9s-pod">&lt;/p>
&lt;p>é”®å…¥é—®å·â€œ?â€ å°±å¯ä»¥æ‰“å¼€å¿«æ·æ“ä½œæŒ‡å¼•ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626103012.png" alt="help">&lt;/p>
&lt;h2 id="stern">stern&lt;/h2>
&lt;p>&lt;a href="https://github.com/wercker/stern">stern&lt;/a> å¯ä»¥ç”¨æ¥ &lt;code>tail&lt;/code> é›†ç¾¤ä¸Šçš„å¤šä¸ª pod å’Œ pod ä¸­å¤šä¸ªå®¹å™¨çš„æ—¥å¿—ã€‚ä¸åŒçš„ pod å’Œå®¹å™¨ä»¥ä¸åŒçš„é¢œè‰²åŒºåˆ†ï¼Œæ–¹ä¾¿ debugã€‚&lt;/p>
&lt;p>æ¯”å¦‚ä½¿ç”¨å‘½ä»¤ &lt;code>stern -l tier=control-plane -n kube-system&lt;/code> å¯ä»¥è¾“å‡º &lt;code>kube-system&lt;/code> å‘½åç©ºé—´ä¸‹æ§åˆ¶å¹³é¢ï¼ˆ&lt;code>label&lt;/code> ä¸º &lt;code>tier=control-plane&lt;/code>ï¼‰ pod çš„æ—¥å¿—ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626104458.png" alt="stern-control-plane">&lt;/p>
&lt;p>å‘½ä»¤è¡Œé€‰é¡¹&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">Tail multiple pods and containers from Kubernetes
Usage:
stern pod-query &lt;span class="o">[&lt;/span>flags&lt;span class="o">]&lt;/span>
Flags:
-A, --all-namespaces If present, tail across all namespaces. A specific namespace is ignored even &lt;span class="k">if&lt;/span> specified with --namespace.
--color string Color output. Can be &lt;span class="s1">&amp;#39;always&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;never&amp;#39;&lt;/span>, or &lt;span class="s1">&amp;#39;auto&amp;#39;&lt;/span> &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;auto&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
--completion string Outputs stern command-line completion code &lt;span class="k">for&lt;/span> the specified shell. Can be &lt;span class="s1">&amp;#39;bash&amp;#39;&lt;/span> or &lt;span class="s1">&amp;#39;zsh&amp;#39;&lt;/span>
-c, --container string Container name when multiple containers in pod &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;.*&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
--container-state string If present, tail containers with status in running, waiting or terminated. Default to running. &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;running&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
--context string Kubernetes context to use. Default to current context configured in kubeconfig.
-e, --exclude strings Regex of log lines to exclude
-E, --exclude-container string Exclude a Container name
--field-selector string Selector &lt;span class="o">(&lt;/span>field query&lt;span class="o">)&lt;/span> to filter on. If present, default to &lt;span class="s2">&amp;#34;.*&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> the pod-query.
-h, --help &lt;span class="nb">help&lt;/span> &lt;span class="k">for&lt;/span> stern
-i, --include strings Regex of log lines to include
--init-containers Include or exclude init containers &lt;span class="o">(&lt;/span>default &lt;span class="nb">true&lt;/span>&lt;span class="o">)&lt;/span>
--kubeconfig string Path to kubeconfig file to use
-n, --namespace strings Kubernetes namespace to use. Default to namespace configured in Kubernetes context. To specify multiple namespaces, repeat this or &lt;span class="nb">set&lt;/span> comma-separated value.
-o, --output string Specify predefined template. Currently support: &lt;span class="o">[&lt;/span>default, raw, json&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;default&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
-l, --selector string Selector &lt;span class="o">(&lt;/span>label query&lt;span class="o">)&lt;/span> to filter on. If present, default to &lt;span class="s2">&amp;#34;.*&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> the pod-query.
-s, --since duration Return logs newer than a relative duration like 5s, 2m, or 3h. Defaults to 48h.
--tail int The number of lines from the end of the logs to show. Defaults to -1, showing all logs. &lt;span class="o">(&lt;/span>default -1&lt;span class="o">)&lt;/span>
--template string Template to use &lt;span class="k">for&lt;/span> log lines, leave empty to use --output flag
-t, --timestamps Print timestamps
--timezone string Set timestamps to specific timezone &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;Local&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
-v, --version Print the version and &lt;span class="nb">exit&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="lens">Lens&lt;/h2>
&lt;p>&lt;a href="https://k8slens.dev/">Lens&lt;/a> æ˜¯ç”¨æ¥æ§åˆ¶ Kubernetes çš„ IDEï¼Œå¼€æºä¸”å…è´¹ã€‚&lt;/p>
&lt;p>æ¶ˆé™¤äº†é›†ç¾¤æ“ä½œçš„å¤æ‚æ€§ã€æä¾›äº†å®æ—¶çš„å¯è§‚å¯Ÿæ€§ã€æ–¹ä¾¿æ•…éšœæ’æŸ¥ã€æ”¯æŒå¤šç³»ç»Ÿçš„æ¡Œé¢å®¢æˆ·ç«¯ã€å…¼å®¹å¤šç§é›†ç¾¤ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626113853.png" alt="Lens">&lt;/p>
&lt;h2 id="infra-app">Infra App&lt;/h2>
&lt;p>&lt;a href="https://infra.app/">Infra App&lt;/a> è·Ÿ Lens å·®ä¸å¤šï¼ŒUI è¾ƒ Lens å¥½äº›ï¼Œä½†æ˜¯åŠŸèƒ½å°±å¼±å¾ˆå¤šï¼Œç±»ä¼¼ Lens çš„åªè¯»æ¨¡å¼ã€‚&lt;/p>
&lt;p>å…è´¹ç‰ˆæ¯”æ”¶è´¹ç‰ˆçš„åŒºåˆ«åªåœ¨äºæ”¯æŒçš„é›†ç¾¤æ•°é‡ï¼Œå…è´¹ç‰ˆåªæ”¯æŒä¸€ä¸ªé›†ç¾¤ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626114417.png" alt="Infra">&lt;/p>
&lt;h2 id="kubefwd">kubefwd&lt;/h2>
&lt;p>&lt;a href="https://github.com/txn2/kubefwd">kubefwd&lt;/a>ï¼Œè¿™ä¸ªä¸€ç›´æœ‰å®‰è£…ä½†æ˜¯ä½¿ç”¨æ¬¡æ•°å¯¥å¯¥ï¼Œå› ä¸ºåº”ç”¨ä¹‹é—´çš„è®¿é—®æ²¡æœ‰èµ° serviceï¼Œä¸è¿‡å¶å°”åšäº›å®éªŒçš„æ—¶å€™ä¼šç”¨çš„ä¸Šã€‚&lt;/p>
&lt;blockquote>
&lt;p>kubefwd æ˜¯ä¸€ä¸ªç”¨äºç«¯å£è½¬å‘Kubernetesä¸­æŒ‡å®šnamespaceä¸‹çš„å…¨éƒ¨æˆ–è€…éƒ¨åˆ†podçš„å‘½ä»¤è¡Œå·¥å…·ã€‚ kubefwd ä½¿ç”¨æœ¬åœ°çš„ç¯å›IPåœ°å€è½¬å‘éœ€è¦è®¿é—®çš„serviceï¼Œå¹¶ä¸”ä½¿ç”¨ä¸serviceç›¸åŒçš„ç«¯å£ã€‚ kubefwd ä¼šä¸´æ—¶å°†serviceçš„åŸŸæ¡ç›®æ·»åŠ åˆ° /etc/hosts æ–‡ä»¶ä¸­ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>å¯åŠ¨kubefwdåï¼Œåœ¨æœ¬åœ°å°±èƒ½åƒåœ¨Kubernetesé›†ç¾¤ä¸­ä¸€æ ·ä½¿ç”¨serviceåå­—ä¸ç«¯å£è®¿é—®å¯¹åº”çš„åº”ç”¨ç¨‹åºã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/kubefwdani.gif" alt="kubefwd_ani">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/16246803227515.jpg" alt="">&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>å–„ç”¨å·¥å…·å¯ä»¥æå‡æ•ˆç‡ï¼Œä½†å¹¶ä¸æ˜¯ä¸å¯æˆ–ç¼ºçš„ã€‚&lt;/p>
&lt;p>å¦‚æœä½ æœ‰å…¶ä»–çš„å·¥å…·ï¼Œæ¬¢è¿ç•™è¨€æå‡ºã€‚&lt;/p></description></item><item><title>Jenkins å¦‚ä½•ä¸ Kubernetes é›†ç¾¤çš„ Tekton Pipeline äº¤äº’ï¼Ÿ</title><link>https://atbug.com/jenkins-interact-with-tekton-pipelines-via-plugin/</link><pubDate>Wed, 23 Jun 2021 07:58:45 +0800</pubDate><guid>https://atbug.com/jenkins-interact-with-tekton-pipelines-via-plugin/</guid><description>
&lt;p>æœ¬æ–‡è¯¦ç»†ä»‹ç»äº† Jenkins å¦‚ä½•é€šè¿‡ &lt;a href="https://github.com/jenkinsci/tekton-client-plugin">tekton-client-plugin&lt;/a> å®ç°ä¸ Kubernetes ä¸Šçš„ Tekton Pipeline äº¤äº’ï¼ŒåŒ…æ‹¬ Kubernetes ä¸Šå®‰è£… Jenkinsã€Tekton Pipelines ç­‰ã€‚&lt;/p>
&lt;p>å…³äºå¦‚ä½•ä½¿ç”¨ Tekton Pipeline å®ç° CICD å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç«  &lt;a href="https://atbug.com/tekton-pipeline-practice/">äº‘åŸç”Ÿ CICD: Tekton Pipeline å®æˆ˜&lt;/a>&lt;/p>
&lt;p>æœ¬æ–‡ç”¨äºæ„å»ºçš„é¡¹ç›®ä»¥åŠæ‰€æœ‰ manifest yaml éƒ½åœ¨å¯ä»¥åœ¨&lt;a href="https://github.com/addozhang/tekton-test">è¿™é‡Œ&lt;/a>ä¸‹è½½ã€‚&lt;/p>
&lt;h2 id="tldr">TL;DR&lt;/h2>
&lt;p>æƒ¯ä¾‹ï¼Œå…ˆä¸Šæ€»ç»“ã€‚&lt;code>tekton-client-plugin&lt;/code> è™½ç„¶è¿˜æ˜¯å¤„äºåˆæœŸé˜¶æ®µï¼Œä½†æ˜¯ &lt;em>å…¶ä»·å€¼éå¸¸æ˜æ˜¾ï¼Œå°¤å…¶æ˜¯å¯¹å…ˆç”¨ä½¿ç”¨ Jenkins ä½œä¸º CICD å®ç°çš„ç”¨æˆ·æ¥è¯´ã€‚ä» Jenkins è¿ç§»åˆ°äº‘åŸç”Ÿçš„ Tekton æ—¶ï¼Œå¯ä»¥çœæ‰ç”¨æˆ·ç•Œé¢çš„å¼€å‘æˆæœ¬ï¼Œè€Œä¸”å°½å¯èƒ½å°‘çš„æ”¹å˜ç”¨æˆ·ä¹ æƒ¯&lt;/em> ï¼Œä¾é ç‰ˆæœ¬ç®¡ç†å¯ä»¥æ§åˆ¶è¿ç§»çš„èŠ‚å¥ã€‚&lt;/p>
&lt;p>&lt;code>tekton-client-plugin&lt;/code> åœ¨ä»Šå¹´ 5 æœˆ 7 æ—¥å‘å¸ƒçš„ &lt;code>1.0.0&lt;/code> ç‰ˆæœ¬ï¼Œç›®å‰ä¸º &lt;code>1.0.02&lt;/code>ã€‚ç›®å‰è¿˜å¤„äºåˆæœŸé˜¶æ®µï¼Œæˆ‘ä¸ªäººæ„Ÿè§‰ç›®å‰ä»…ä»…ç®—æ˜¯æ‰“é€š Jenkins ä¸ Tekton äº¤äº’è¿™æ¡è·¯ï¼Œæ‰©å±•æ€§è¿˜ä¸å¤Ÿå¥½ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ç›®å‰ä»…ä»…æ”¯æŒå¦‚ä¸‹å‡ ä¸ªå‚æ•°æ³¨å…¥åˆ° &lt;code>PipelineRun&lt;/code> ä¸­ï¼Œéš¾ä»¥æ”¯æ’‘å¤æ‚çš„æµç¨‹æ§åˆ¶ï¼Œ&lt;a href="https://github.com/jenkinsci/tekton-client-plugin/blob/1.0.2/src/main/java/org/waveywaves/jenkins/plugins/tekton/client/build/create/CreateRaw.java#L292">æ”¯æŒçš„ Pipeline å‚æ•° hardcode åœ¨ä»£ç ä¸­&lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>BUILD_ID - the build id/number of the Jenkins job&lt;/li>
&lt;li>JOB_NAME - the name of the jenkins job that triggered this pipeline&lt;/li>
&lt;li>PULL_BASE_REF - name of the base branch&lt;/li>
&lt;li>PULL_PULL_SHA - the commit sha of the pull request or branch&lt;/li>
&lt;li>REPO_NAME - name of the repository&lt;/li>
&lt;li>REPO_OWNER - owner of the repository&lt;/li>
&lt;li>REPO_URL - the URL of the repository&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>å¸Œæœ›åé¢ä¼šæ”¯æŒè‡ªå®šä¹‰å‚æ•°ï¼Œæ¯”å¦‚å°†æ›´å¤šçš„é¡¹ç›®å…ƒæ•°æ®ä¿¡æ¯æ³¨å†Œåˆ° &lt;code>Pipeline&lt;/code> ä¸­ã€‚&lt;/p>
&lt;p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ&lt;code>tekton-client-plugin&lt;/code> æä¾›äº†å¯¹ Job DSL çš„æ”¯æŒï¼Œæœ¬æ–‡åé¢æ²¡æœ‰ç”¨è¿™ç§æ–¹å¼ï¼Œè€Œæ˜¯ç”¨çš„ FreeStyle Projectã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">pipeline {
agent any
stages {
stage(&amp;#39;Stage&amp;#39;) {
steps {
checkout scm
tektonCreateRaw(inputType: &amp;#39;FILE&amp;#39;, input: &amp;#39;.tekton/pipeline.yaml&amp;#39;)
}
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‰ç½®æ¡ä»¶">å‰ç½®æ¡ä»¶&lt;/h2>
&lt;h3 id="ç¯å¢ƒ">ç¯å¢ƒ&lt;/h3>
&lt;ul>
&lt;li>Kubernetesï¼šæ¨è minikube&lt;/li>
&lt;li>Jenkinsï¼šå»ºè®®åœ¨ Kubernetes ä¸Šå®‰è£…&lt;/li>
&lt;li>Tekton&lt;/li>
&lt;li>ç”¨äºæ„å»ºçš„é¡¹ç›®&lt;/li>
&lt;/ul>
&lt;h3 id="å·¥å…·">å·¥å…·&lt;/h3>
&lt;ul>
&lt;li>kubectl&lt;/li>
&lt;li>tektoncd-cli&lt;/li>
&lt;li>&lt;a href="https://github.com/ahmetb/kubectx">kubectxã€kubens&lt;/a>&lt;/li>
&lt;li>helm&lt;/li>
&lt;/ul>
&lt;h2 id="kubernetes-ä¸Šå®‰è£…-jenkinshelm">Kubernetes ä¸Šå®‰è£… Jenkinsï¼ˆHelmï¼‰&lt;/h2>
&lt;p>Jenkins è¿™é‡Œä½¿ç”¨ Helm å®‰è£…åˆ° Kubernetes ä¸Šã€‚&lt;/p>
&lt;p>åˆå§‹åŒ–å‘½åç©ºé—´ã€æŒä¹…åŒ–å·ã€ServiceAccount ç­‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create namespace jenkins
kubens jenkins
&lt;span class="c1"># æŒä¹…åŒ–å­˜å‚¨ï¼Œç¬”è€…å°†å®¹é‡ä¿®æ”¹ä¸º 5G&lt;/span>
http https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/doc/tutorials/kubernetes/installing-jenkins-on-kubernetes/jenkins-volume.yaml --body &amp;gt; jenkins-volume.yaml
&lt;span class="c1"># åˆ›å»º PV&lt;/span>
kubectl apply -f jenkins-volume.yaml
&lt;span class="c1"># åˆ›å»º service account&lt;/span>
kubectl apply -f https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/doc/tutorials/kubernetes/installing-jenkins-on-kubernetes/jenkins-sa.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å‡†å¤‡-helm-ç¯å¢ƒå¹¶æ·»åŠ -jenkins-chartrepo">å‡†å¤‡ helm ç¯å¢ƒå¹¶æ·»åŠ  Jenkins ChartRepo&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># homebrew å®‰è£… helm&lt;/span>
brew install helm
&lt;span class="c1"># æ·»åŠ  jenkins chart repo&lt;/span>
helm repo add jenkinsci https://charts.jenkins.io
helm repo update
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="é…ç½®-jenkins-chart">é…ç½® Jenkins Chart&lt;/h3>
&lt;ol>
&lt;li>ä¸‹è½½å®˜æ–¹çš„ values yamlè¿›è¡Œä¿®æ”¹ï¼š&lt;code>http https://raw.githubusercontent.com/jenkinsci/helm-charts/main/charts/jenkins/values.yaml &amp;gt; jenkins-values.yaml&lt;/code>&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>serviceType&lt;/code> ä¸º &lt;code>NodePort&lt;/code>ï¼Œå¹¶å¢åŠ  &lt;code>nodePort: 32000&lt;/code>ã€‚ç”¨äºä» minikube å¤–è®¿é—® Jenkins&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>storageClass&lt;/code> ä¸º &lt;code>jenkins-pv&lt;/code>ã€‚å‰é¢åˆ›å»º PV çš„æ—¶å€™ä½¿ç”¨äº† &lt;code>jenkins-pv&lt;/code> ä½œä¸º &lt;a href="https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/">Dynamic Volume Provisioning&lt;/a> çš„ &lt;code>storageClass&lt;/code>&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>serviceAccount&lt;/code> éƒ¨åˆ†ï¼Œå°† &lt;code>create&lt;/code> è®¾ç½®ä¸º &lt;code>false&lt;/code>ï¼ˆä¸Šé¢å·²ç»åˆ›å»ºäº† &lt;code>serviceAccount&lt;/code>ï¼‰ï¼ŒåŒæ—¶å°† &lt;code>name&lt;/code> æŒ‡å®šä¸ºå‰é¢çš„ sa åå­— &lt;code>jenkins&lt;/code>&lt;/li>
&lt;li>&lt;code>installPlugins&lt;/code> ä¸‹å¢åŠ  &lt;code>tekton-client:1.0.2&lt;/code>&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>adminPassword&lt;/code> ä¸º &lt;code>admin&lt;/code>ã€‚æŒ‡å®šåˆå§‹å¯†ç ï¼ˆä¸æŒ‡å®šä¹Ÿå¯ä»¥é€šè¿‡å®‰è£…è¾“å‡ºçš„è¯´æ˜è·å–åˆå§‹å¯†ç ï¼‰&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>persistence&lt;/code> çš„ &lt;code>size&lt;/code> ä¸º &lt;code>5Gi&lt;/code> ï¼ˆæˆ‘çš„ minikube çš„è™šæ‹Ÿæœºåªæœ‰ 20Gi å¤§å°ï¼‰&lt;/li>
&lt;/ol>
&lt;p>ä¿®æ”¹åçš„æ–‡ä»¶åœ¨&lt;a href="https://github.com/addozhang/tekton-test/blob/main/tekton-client-sample/jenkins-values.yaml">è¿™é‡Œ jenkins-values.yaml&lt;/a>ã€‚&lt;/p>
&lt;h3 id="æ‰§è¡Œå®‰è£…">æ‰§è¡Œå®‰è£…&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">chart&lt;/span>&lt;span class="o">=&lt;/span>jenkinsci/jenkins
helm install jenkins -n jenkins -f jenkins-values.yaml &lt;span class="nv">$chart&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">NAME: jenkins
LAST DEPLOYED: Sun Jun 20 22:05:53 2021
NAMESPACE: jenkins
STATUS: deployed
REVISION: 1
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è·å– Jenkins çš„è®¿é—®åœ°å€ &lt;code>echo $(minikube ip):$(kubectl get svc jenkins -o jsonpath=&amp;quot;{.spec.ports[0].nodePort}&amp;quot;)&lt;/code>ï¼Œç„¶åä½¿ç”¨å‰é¢è®¾ç½®çš„è´¦å·ç™»å½•ã€‚&lt;/p>
&lt;h2 id="tekton-å®‰è£…">Tekton å®‰è£…&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create ns tekton-pipelines
kubens tekton-pipelines
kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…-cli">å®‰è£… CLI&lt;/h3>
&lt;p>&lt;code>brew install tektoncd-cli&lt;/code>&lt;/p>
&lt;h3 id="rbac">RBAC&lt;/h3>
&lt;p>Tekton Pipeline å®‰è£…å®Œæˆåï¼Œéœ€è¦ç»™å‰é¢åˆ›å»ºçš„ ServiceAccount &lt;code>jenkins&lt;/code> å¢åŠ  tekon èµ„æºçš„æ“ä½œæƒé™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="l">//tekton-role.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Role&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-role&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pods&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pods/log&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">verbs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">get&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">list&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">watch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">tekton.dev&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">tasks&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">taskruns&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pipelineruns&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">verbs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">create&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">delete&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">deletecollection&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">get&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">list&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">patch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">update&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">watch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">RoleBinding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-role-binding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">roleRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Role&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-role&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">subjects&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ServiceAccount&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jenkins&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jenkins&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="jenkins-ä¸-tekton-äº¤äº’">Jenkins ä¸ Tekton äº¤äº’&lt;/h2>
&lt;p>å‰é¢å¤§ç¯‡å¹…çš„éƒ½åªæ˜¯å‡†å¤‡å·¥ä½œï¼ŒJenkins å®‰è£…æ—¶æˆ‘ä»¬å·²ç»æ·»åŠ äº† &lt;code>tekton-client-plugin&lt;/code> æ’ä»¶ã€‚&lt;/p>
&lt;p>æ·»åŠ ä¸€ä¸ªåä¸º &lt;code>tekton-client-sample&lt;/code> çš„ &lt;code>FreeStyle project&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622-151450.png" alt="åˆ›å»ºä½œä¸š">&lt;/p>
&lt;p>SCM è¿™é‡Œå¡«å…¥ç”¨äºæ„å»ºçš„é¡¹ç›®ä»“åº“åœ°å€ä»¥åŠåˆ†æ”¯ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622-151523.png" alt="é…ç½®ä»£ç ä»“åº“">&lt;/p>
&lt;p>Build æ¨¡å—ä¸­é€‰æ‹© &lt;code>Tekton: Create Resource (RAW)&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622-151544.png" alt="å¢åŠ  Tekton step">&lt;/p>
&lt;p>è¿™é‡Œé€‰æ‹© &lt;code>FILE&lt;/code> ç±»å‹ï¼Œå› ä¸ºæˆ‘å·²ç»å°† &lt;code>PipelineRun&lt;/code> çš„ yaml æ”¾è¿›äº†ä»£ç ä»“åº“ä¸­äº†ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622151734.png" alt="é…ç½® Resource">&lt;/p>
&lt;p>æ‰§è¡Œä¸€æ¬¡æ„å»º&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622153535.png" alt="æ„å»ºç»“æŸ">&lt;/p>
&lt;p>æ£€æŸ¥ä¸‹åº”ç”¨&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pod &lt;span class="p">|&lt;/span> grep tekton-test
tekton-test-75975dcc88-xkzb6 1/1 Running &lt;span class="m">0&lt;/span> 3m13s
tekton-test-c26lw-deploy-to-k8s-28trp-pod-w8tgc 0/1 Completed &lt;span class="m">0&lt;/span> 3m18s
tekton-test-c26lw-fetch-from-git-pv66g-pod-nm5qh 0/1 Completed &lt;span class="m">0&lt;/span> 6m30s
tekton-test-c26lw-source-to-image-k8mpg-pod-qh7g4 0/2 Completed &lt;span class="m">0&lt;/span> 6m15s
$ curl &lt;span class="k">$(&lt;/span>minikube ip&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>kubectl get svc tekton-test -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;{.spec.ports[0].nodePort}&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>/hi
hello world
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://www.jenkins.io/doc/book/installing/kubernetes/">Jenkins on Kubernetes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/jenkinsci/tekton-client-plugin/blob/master/docs/tutorial.md">Tekton Client Plugin Tutorial&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.jenkins.io/blog/2021/04/21/tekton-plugin/#easily-reuse-tekton-and-jenkins-x-from-jenkins">Easily reuse Tekton and Jenkins X from Jenkins&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>äº‘åŸç”Ÿ CICD: Tekton Pipeline å®æˆ˜</title><link>https://atbug.com/tekton-pipeline-practice/</link><pubDate>Tue, 22 Jun 2021 07:19:33 +0800</pubDate><guid>https://atbug.com/tekton-pipeline-practice/</guid><description>
&lt;p>æ›´æ–°å†å²ï¼š&lt;/p>
&lt;ul>
&lt;li>v1ï¼š2020.1.21 åŸºäº Tekton Pipline &lt;a href="https://github.com/tektoncd/pipeline/tree/v0.9.0/docs#tekton-pipelines">v0.9.0&lt;/a>&lt;/li>
&lt;li>v2ï¼ˆå½“å‰ï¼‰ï¼š2021.6.22 åŸºäº Tekton Pipeline &lt;a href="https://github.com/tektoncd/pipeline/tree/v0.25.0/docs#tekton-pipelines">v0.25.0&lt;/a>&lt;/li>
&lt;/ul>
&lt;hr>
&lt;p>Tekton æ˜¯ Google å¼€æºçš„ Kubernetes åŸç”ŸCI/CD ç³»ç»Ÿ, åŠŸèƒ½å¼ºå¤§æ‰©å±•æ€§å¼º. å‰èº«æ˜¯ Knavite é‡Œçš„ build-pipeline é¡¹ç›®, åæœŸå­µåŒ–æˆ&lt;a href="https://github.com/tektoncd/pipeline">ç‹¬ç«‹çš„é¡¹ç›®&lt;/a>. å¹¶æˆä¸º &lt;a href="https://cd.foundation/projects/">CDF&lt;/a> ä¸‹çš„å››ä¸ªé¡¹ç›®ä¹‹ä¸€, å…¶ä»–ä¸‰ä¸ªåˆ†åˆ«æ˜¯ Jenkins, Jenkins X, Spinnaker.&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆè¯´ Tekton æ˜¯ Kubernetes åŸç”Ÿçš„, ä»¥å†…å…¶åŸºäº Kubernetes çš„ CRD å®šä¹‰äº† Pipeline æµæ°´çº¿.&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/bquuTV.jpg" alt="">&lt;/p>
&lt;p>CRD åŠè¯´æ˜:&lt;/p>
&lt;ul>
&lt;li>Task: æ„å»ºä»»åŠ¡, å¯ä»¥å®šä¹‰ä¸€äº›åˆ—çš„ steps. æ¯ä¸ª step ç”±ä¸€ä¸ª container æ‰§è¡Œ.&lt;/li>
&lt;li>TaskRun: task å®é™…çš„æ‰§è¡Œ, å¹¶æä¾›æ‰§è¡Œæ‰€éœ€çš„å‚æ•°. è¿™ä¸ªå¯¹è±¡åˆ›å»ºå, å°±ä¼šæœ‰ pod è¢«åˆ›å»º.&lt;/li>
&lt;li>Pipeline: å®šä¹‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª task çš„æ‰§è¡Œ, ä»¥åŠ PipelineResource å’Œå„ç§å®šä¹‰å‚æ•°çš„é›†åˆ&lt;/li>
&lt;li>PipelineRun: ç±»ä¼¼ task å’Œ taskrun çš„å…³ç³»: ä¸€ä¸ªå®šä¹‰ä¸€ä¸ªæ‰§è¡Œ. PipelineRun åˆ™æ˜¯ pipeline çš„å®é™…æ‰§è¡Œ. åˆ›å»ºåä¹Ÿä¼šåˆ›å»º pod æ¥æ‰§è¡Œå„ä¸ª task.&lt;/li>
&lt;li>&lt;del>PipelineResource: æµæ°´çº¿çš„è¾“å…¥èµ„æº, æ¯”å¦‚ github/gitlab çš„æºç , æŸç§å­˜å‚¨æœåŠ¡çš„æ–‡ä»¶, æˆ–è€…é•œåƒç­‰. æ‰§è¡Œæ—¶, ä¹Ÿä¼šä½œä¸º pod çš„å…¶ä¸­ä¸€ä¸ª container æ¥è¿è¡Œ(æ¯”å¦‚æ‹‰å–ä»£ç ).&lt;/del> PipelineResource ç›®å‰å¤„äº Alahaï¼Œè‡³äºåŸå› å¯ä»¥çœ‹&lt;a href="https://github.com/tektoncd/pipeline/blob/v0.25.0/docs/resources.md#why-arent-pipelineresources-in-beta">Why Aren&amp;rsquo;t PipelineResources in Beta?&lt;/a>&lt;/li>
&lt;li>Condition: åœ¨ pipeline çš„ task æ‰§è¡Œæ—¶é€šè¿‡æ·»åŠ  condition æ¥å¯¹æ¡ä»¶è¿›è¡Œè¯„ä¼°, è¿›è€Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œ task. ç›®å‰æ˜¯WIPçš„çŠ¶æ€, å¾…&lt;a href="https://github.com/tektoncd/pipeline/issues/1137">#1137&lt;/a>çš„å®Œæˆ.&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ç»„ä»¶:&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;code>tekton-pipelines-controller&lt;/code>: ç›‘æ§ CRD å¯¹è±¡(TaskRun, PipelineRun)çš„åˆ›å»º, ä¸ºè¯¥æ¬¡æ‰§è¡Œåˆ›å»º pod.&lt;/li>
&lt;li>&lt;code>tekton-pipelines-webhook&lt;/code>: å¯¹ apiserver æä¾› http æ¥å£åš CRD å¯¹è±¡çš„æ ¡éªŒ.&lt;/li>
&lt;/ul>
&lt;h2 id="å‰ç½®æ¡ä»¶">å‰ç½®æ¡ä»¶&lt;/h2>
&lt;p>æ–‡ä¸­ä½¿ç”¨çš„ä¸€äº›å·¥å…·ï¼ŒåŸºæœ¬éƒ½å¯ä»¥é€šè¿‡ homebrew å®‰è£…ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://stedolan.github.io/jq/">jq&lt;/a> ï¼šæ“ä½œ json çš„å‘½ä»¤è¡Œå·¥å…·&lt;/li>
&lt;li>&lt;a href="https://httpie.io/">httpie&lt;/a>ï¼šHTTP å®¢æˆ·ç«¯å‘½ä»¤è¡Œå·¥å…·&lt;/li>
&lt;li>&lt;a href="https://minikube.sigs.k8s.io/docs/start/">minikube ç¯å¢ƒ&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>æ–‡ä¸­çš„ Java é¡¹ç›®ä»¥åŠ tekton çš„ç›¸å…³ yaml éƒ½å·²ç»æäº¤åˆ°äº† &lt;a href="https://github.com/addozhang/tekton-test">tekton-test&lt;/a>.&lt;/p>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;p>å‚è€ƒ&lt;a href="https://atbug.com/tekton-installation-and-sample/">ä¸Šä¸€ç¯‡æ–‡ç« &lt;/a>, æ–‡ç« ä¸­æœ‰ä¸ªç®€å•çš„&amp;quot;hello world&amp;quot;.&lt;/p>
&lt;h2 id="å®è·µ">å®è·µ&lt;/h2>
&lt;p>åˆ°äº†è¿™é‡Œç›¸ä¿¡å·²ç»å®‰è£…å¥½äº† Tekton. æˆ‘ä»¬ä½¿ç”¨&lt;a href="https://start.spring.io/">Spring Initializer&lt;/a>ç”Ÿæˆçš„é¡¹ç›®ä¸ºä¾‹, æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Tekton å®ç° CICD.&lt;/p>
&lt;p>å¼€å§‹ä¹‹å‰ç®€å•æ•´ç†ä¸‹è¿™ä¸ªé¡¹ç›®çš„ CICD æµç¨‹:&lt;/p>
&lt;ol>
&lt;li>æ‹‰å–ä»£ç &lt;/li>
&lt;li>maven æ‰“åŒ…&lt;/li>
&lt;li>æ„å»ºé•œåƒå¹¶æ¨é€&lt;/li>
&lt;li>éƒ¨ç½²&lt;/li>
&lt;/ol>
&lt;p>&lt;em>æ³¨: æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åœ¨ &lt;code>tekton-pipelines&lt;/code> namespace ä¸‹æ“ä½œ&lt;/em>&lt;/p>
&lt;h3 id="0x00-æ·»åŠ -dockerfile-å’Œéƒ¨ç½²ç”¨çš„-yaml">0x00 æ·»åŠ  Dockerfile å’Œéƒ¨ç½²ç”¨çš„ yaml&lt;/h3>
&lt;p>ç”¨äºæ„å»ºé•œåƒçš„Dockerfile&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">FROM openjdk:8-jdk-alpine
RUN mkdir /app
WORKDIR /app
COPY target/*.jar /app/app.jar
ENTRYPOINT [&amp;#34;sh&amp;#34;, &amp;#34;-c&amp;#34;, &amp;#34;java -Xmx128m -Xms64m -jar app.jar&amp;#34;]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”¨äºéƒ¨ç½² K8s Deployment çš„ deployment.ymlï¼ŒåŒæ—¶é€šè¿‡åˆ›å»º &lt;code>NodePort&lt;/code> ç±»å‹çš„ Service ç”¨äºè®¿é—®åº”ç”¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;apps/v1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Deployment&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addozhang/tekton-test:latest&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Always&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">livenessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">failureThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/actuator/info&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initialDelaySeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">60&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">successThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeoutSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">containerPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;TCP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">readinessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">failureThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/actuator/info&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initialDelaySeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">successThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeoutSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NodePort &lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x01-rbac">0x01 RBAC&lt;/h3>
&lt;p>åˆ›å»º ServiceAccount ç”¨äº Pipeline çš„è¿è¡Œã€‚&lt;/p>
&lt;p>&lt;strong>æ³¨ï¼šè¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆäºˆäº† &lt;code>ClusterRole&lt;/code> &lt;code>admin&lt;/code>ã€‚&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="c"># serviceaccount.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ServiceAccount&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-build&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterRoleBinding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipeline-admin-binding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">roleRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterRole&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">admin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># user cluster role admin&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">subjects&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ServiceAccount&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-build&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x02-æ‹‰å–ä»£ç ">0x02 æ‹‰å–ä»£ç &lt;/h3>
&lt;p>ä»£ç ä½œä¸ºæ„å»ºçš„è¾“å…¥, éœ€è¦æä¾›ä¸€ä¸ª Pipeline CRD å¯¹è±¡æ¥è¡¨ç¤ºè¾“å…¥æ˜¯ä» git ä»“åº“æ¥è·å–ä»£ç ã€‚&lt;/p>
&lt;p>è®¿é—® Tekton Hub å¯ä»¥æ‰¾åˆ°ç°æˆçš„ &lt;a href="https://hub.tekton.dev/tekton/task/git-clone">git-clone task&lt;/a>ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ kubectl å®‰è£…ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f https://raw.githubusercontent.com/tektoncd/catalog/main/task/git-clone/0.4/git-clone.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…ä½¿ç”¨ tekton-cli å®‰è£…ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">tkn hub install task git-clone
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x03-maven-æ‰“åŒ…">0x03 maven æ‰“åŒ…&lt;/h3>
&lt;p>Task &lt;code>source-to-image.yaml&lt;/code>çš„ step &lt;code>maven&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.5.0-jdk-8-alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workingDir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(workspaces.source.path)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mvn&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">clean&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">install&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">DskipTests&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/root/.m2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/home/docker/.m2 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>è¯´æ˜:&lt;/strong>&lt;/p>
&lt;p>æœ‰äº†ä»£ç ä¸‹ä¸€æ­¥å°±æ˜¯æ‰§è¡Œ maven çš„ç¼–è¯‘æ‰“åŒ…, åœ¨&lt;code>maven:3.5.0-jdk-8-alpine&lt;/code>é•œåƒä¸­æ‰§è¡Œ&lt;code>mvn&lt;/code>çš„ç›¸å…³å‘½ä»¤.&lt;/p>
&lt;p>è¿™é‡ŒæŒ‚åœ¨äº†ä¸€ä¸ªæœ¬åœ°çš„volume, é¿å…æ¯æ¬¡æ„å»ºé‡å¤ä¸‹è½½ä¾èµ–åŒ…, åŒæ—¶é‡Œé¢è¿˜æœ‰&lt;code> settings.xml&lt;/code>&lt;/p>
&lt;p>&lt;em>æ³¨æ„: å¯¹äº minikube, hostPath è¯·ä½¿ç”¨/data/.m2, å¦åˆ™minikubeé‡å¯åæ— æ³•æŒä¹…åŒ–&lt;/em>&lt;/p>
&lt;h3 id="0x04-æ„å»ºé•œåƒå¹¶æ¨é€">0x04 æ„å»ºé•œåƒå¹¶æ¨é€&lt;/h3>
&lt;p>Task &lt;code>source-to-image.yaml&lt;/code> çš„ step &lt;code>build-and-push&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">spec:
params:
- name: pathToDockerFile
description: The path to the dockerfile to build (relative to the context)
default: Dockerfile
- name: imageUrl
description: Url of image repository
- name: imageTag
description: Tag to apply to the built image
default: latest
workspaces:
- name: source
- name: dockerconfig
mountPath: /kaniko/.docker # config.json çš„æŒ‚è½½ç›®å½•
steps:
- name: build-and-push
image: gcr.io/kaniko-project/executor:v1.6.0-debug
command:
- /kaniko/executor
args:
- --dockerfile=$(params.pathToDockerFile)
- --destination=$(params.imageUrl):$(params.imageTag)
- --context=$(workspaces.source.path)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>è¯´æ˜:&lt;/strong>&lt;/p>
&lt;p>é•œåƒçš„æ„å»º, æˆ‘ä»¬é‡‡ç”¨äº† kanikoã€‚&lt;/p>
&lt;p>é•œåƒä»“åº“æˆ‘ä»¬é€‰æ‹©äº†Docker Hub, æ¨é€çš„æ—¶å€™éœ€è¦ä½¿ç”¨ credentialsã€‚&lt;/p>
&lt;p>kaniko éœ€è¦å°† docker config çš„æ–‡ä»¶å­˜åœ¨äº &lt;code>/kanika/.docker&lt;/code> ç›®å½•ä¸‹ã€‚è¿™é‡Œçš„æ€è·¯æ˜¯å°† docker çš„ &lt;code>config.json&lt;/code>ï¼Œä»¥ &lt;code>secret&lt;/code> çš„æ–¹å¼æŒä¹…åŒ–ï¼Œåœ¨é€šè¿‡å…ˆæ·»åŠ &lt;code> docker-registry&lt;/code>ç±»å‹çš„ &lt;code>secret&lt;/code>ï¼Œç„¶åé€šè¿‡ &lt;code>workspace&lt;/code> çš„æ–¹å¼è¾“å…¥åˆ° kaniko è¿è¡Œç¯å¢ƒä¸­ã€‚&lt;/p>
&lt;p>&lt;code>config.json&lt;/code> é‡Œé¢ä¿å­˜çš„ json ç»“æ„åŒ–çš„æ•°æ®ï¼Œä¸ºäº†æ–¹ä¾¿é€šè¿‡ dry run åˆ›å»º&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create secret docker-registry dockerhub --docker-server&lt;span class="o">=&lt;/span>https://index.docker.io/v1/ --docker-username&lt;span class="o">=[&lt;/span>USERNAME&lt;span class="o">]&lt;/span> --docker-password&lt;span class="o">=[&lt;/span>PASSWORD&lt;span class="o">]&lt;/span> --dry-run&lt;span class="o">=&lt;/span>client -o json &lt;span class="p">|&lt;/span> jq -r &lt;span class="s1">&amp;#39;.data.&amp;#34;.dockerconfigjson&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> base64 -d &amp;gt; /tmp/config.json &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> kubectl create secret generic docker-config --from-file&lt;span class="o">=&lt;/span>/tmp/config.json &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> rm -f /tmp/config.json
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ‰§è¡Œ:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f tasks/source-to-image.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x05-éƒ¨ç½²">0x05 éƒ¨ç½²&lt;/h3>
&lt;p>deploy-to-k8s.yaml:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Task&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-to-k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">inputs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pathToYamlFile&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The path to the yaml file to deploy within the git source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deployment.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">run-kubectl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">lachlanevenson/k8s-kubectl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;kubectl&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;apply&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;-f&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;/workspace/git-source/$(inputs.params.pathToYamlFile)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>è¯´æ˜:&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>pathToYamlFile: æŒ‡å®šéƒ¨ç½²åº”ç”¨çš„ yamlã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>æ‰§è¡Œ:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f tasks/deploy-to-k8s.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x06-ç»„è£…æµæ°´çº¿">0x06 ç»„è£…æµæ°´çº¿&lt;/h3>
&lt;p>&lt;code>build-pipeline.yaml&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pipeline&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build-pipeline&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pathToContext&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The path to the build context, used by Kaniko - within the workspace&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageUrl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Url of image repository&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageTag&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Tag to apply to the built image&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">fetch-from-git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-clone&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$(params.git-url)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$(params.git-revision)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">output&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source-to-image&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source-to-image&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageUrl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$(params.imageUrl)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageTag&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$(params.imageTag)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dockerconfig&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">runAfter&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">fetch-from-git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-to-k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-to-k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pathToYamlFile&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deployment.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">runAfter&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">source-to-image&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ‰§è¡Œ:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f tasks/deploy-to-k8s.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x07-æ‰§è¡Œæµæ°´çº¿">0x07 æ‰§è¡Œæµæ°´çº¿&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PipelineRun&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">generateName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">generic-pr-&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">generic-pipeline-run&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">pipelineRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build-pipeline&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">main&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://github.com/addozhang/tekton-test.git &lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageUrl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">addozhang/tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageTag&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeClaimTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">1Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secret&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceAccountName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-build&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ‰§è¡Œ:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f run/run.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x08-ç»“æœ">0x08 ç»“æœ&lt;/h3>
&lt;p>æ‰§è¡Œæµæ°´çº¿å, å¯ä»¥çœ‹åˆ°åˆ†åˆ«åˆ›å»ºäº†ä¸‹é¢çš„å‡ ä¸ª pod:&lt;/p>
&lt;ul>
&lt;li>generic-pipeline-run-deploy-to-k8s-xxx&lt;/li>
&lt;li>generic-pipeline-run-fetch-from-git-xxx&lt;/li>
&lt;li>generic-pipeline-run-source-to-image-xxx&lt;/li>
&lt;/ul>
&lt;p>ä»¥åŠæˆ‘ä»¬çš„åº”ç”¨ &lt;code>tekton-test-xxx&lt;/code>ï¼Œå‘èµ·è¯·æ±‚æµ‹è¯•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ http &lt;span class="k">$(&lt;/span>minikube ip&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>kubectl get svc tekton-test -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;{.spec.ports[0].nodePort}&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>/hi --body
hello world
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ç›®å‰ Tekton è¿›å…¥ beta é˜¶æ®µ, æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ &lt;code>0.25.0&lt;/code>ã€‚åŸºäº CRD çš„å®ç°è®© Tekton åœ¨å®é™…ä½¿ç”¨ä¸­å¯ä»¥çµæ´»çš„è®¾è®¡è‡ªå·±çš„ CICD æµç¨‹.&lt;/p>
&lt;p>ç”Ÿæ€ä¹Ÿè¶Šæ¥è¶Šå®Œå–„ï¼Œæ¯”å¦‚ &lt;a href="https://hub.tekton.dev/">Tekton Hub&lt;/a> æä¾›äº†å¤§é‡çš„å¯é‡ç”¨æœ€ä½³å®ç°çš„ Task å’Œ Pipelineã€‚&lt;/p>
&lt;p>ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°è¯•ä¸‹å¦‚ä½•åœ¨ Jenkins ä¸­ä¸ Tekton Pipeline è¿›è¡Œäº¤äº’ã€‚&lt;/p>
&lt;p>æ›´å¤šæ–‡ç« :&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/_hK6bqODJv3LrwnQaou-hA">Tekton çš„å·¥ä½œåŸç†&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://atbug.com/tekton-dashboard-installation/">Tekton Dashboard å®‰è£…&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://atbug.com/tekton-trigger-glance/">Tekton Trigger ä»‹ç»&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://atbug.com/tekton-trigger-practice/">Tekton Trigger å®æˆ˜&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>æºç è§£æï¼šä¸€æ–‡è¯»æ‡‚ Kubelet</title><link>https://atbug.com/kubelet-source-code-analysis/</link><pubDate>Tue, 15 Jun 2021 08:25:25 +0800</pubDate><guid>https://atbug.com/kubelet-source-code-analysis/</guid><description>
&lt;p>æœ¬æ–‡ä¸»è¦ä»‹ç» kubelet åŠŸèƒ½ã€æ ¸å¿ƒç»„ä»¶ï¼Œä»¥åŠå¯åŠ¨æµç¨‹çš„æºç åˆ†æï¼Œæ€»ç»“äº† kubelet çš„å·¥ä½œåŸç†ã€‚&lt;/p>
&lt;h2 id="kubelet-ç®€ä»‹">kubelet ç®€ä»‹&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/15/20210613091144.png" alt="Kubernetes çš„æ¶æ„å›¾">&lt;/p>
&lt;p>ä»å®˜æ–¹çš„æ¶æ„å›¾ä¸­å¾ˆå®¹æ˜“å°±èƒ½æ‰¾åˆ° &lt;code>kubelet&lt;/code>&lt;/p>
&lt;p>æ‰§è¡Œ &lt;code>kubelet -h&lt;/code> çœ‹åˆ° kubelet çš„åŠŸèƒ½ä»‹ç»ï¼š&lt;/p>
&lt;ul>
&lt;li>kubelet æ˜¯æ¯ä¸ª Node èŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œçš„ä¸»è¦â€œèŠ‚ç‚¹ä»£ç†â€ã€‚ä½¿ç”¨å¦‚ä¸‹çš„ä¸€ä¸ªå‘ apiserver æ³¨å†Œ Node èŠ‚ç‚¹ï¼šä¸»æœºçš„ &lt;code>hostname&lt;/code>ï¼›è¦†ç›– &lt;code>host&lt;/code> çš„å‚æ•°ï¼›æˆ–è€…äº‘æä¾›å•†æŒ‡å®šçš„é€»è¾‘ã€‚&lt;/li>
&lt;li>kubelet åŸºäº &lt;code>PodSpec&lt;/code> å·¥ä½œã€‚&lt;code>PodSpec&lt;/code> æ˜¯ç”¨ &lt;code>YAML&lt;/code> æˆ–è€… &lt;code>JSON&lt;/code> å¯¹è±¡æ¥æè¿° Podã€‚Kubelet æ¥å—é€šè¿‡å„ç§æœºåˆ¶ï¼ˆä¸»è¦æ˜¯ apiserverï¼‰æä¾›çš„ä¸€ç»„ &lt;code>PodSpec&lt;/code>ï¼Œå¹¶ç¡®ä¿é‡Œé¢æè¿°çš„å®¹å™¨è‰¯å¥½è¿è¡Œã€‚&lt;/li>
&lt;/ul>
&lt;p>é™¤äº†ç”± apiserver æä¾› &lt;code>PodSpec&lt;/code>ï¼Œè¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æä¾›ï¼š&lt;/p>
&lt;ul>
&lt;li>æ–‡ä»¶&lt;/li>
&lt;li>HTTP ç«¯ç‚¹&lt;/li>
&lt;li>HTTP æœåŠ¡å™¨&lt;/li>
&lt;/ul>
&lt;p>kubelet åŠŸèƒ½å½’çº³ä¸€ä¸‹å°±æ˜¯ä¸ŠæŠ¥ Node èŠ‚ç‚¹ä¿¡æ¯ï¼Œå’Œç®¡ç†ï¼ˆåˆ›å»ºã€é”€æ¯ï¼‰Podã€‚ åŠŸèƒ½çœ‹ä¼¼ç®€å•ï¼Œå®é™…ä¸ç„¶ã€‚æ¯ä¸€ä¸ªç‚¹æ‹¿å‡ºæ¥éƒ½éœ€è¦å¾ˆå¤§çš„ç¯‡å¹…æ¥è®²ï¼Œæ¯”å¦‚ Node èŠ‚ç‚¹çš„è®¡ç®—èµ„æºï¼Œé™¤äº†ä¼ ç»Ÿçš„ CPUã€å†…å­˜ã€ç¡¬ç›˜ï¼Œè¿˜æä¾›æ‰©å±•æ¥æ”¯æŒç±»ä¼¼ GPU ç­‰èµ„æºï¼›Pod ä¸ä»…ä»…æœ‰å®¹å™¨ï¼Œè¿˜æœ‰ç›¸å…³çš„ç½‘ç»œã€å®‰å…¨ç­–ç•¥ç­‰ã€‚&lt;/p>
&lt;h2 id="kubelet-æ¶æ„">kubelet æ¶æ„&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/15/20210614215508.png" alt="2021-06-14-21-55-08">&lt;/p>
&lt;h3 id="é‡è¦ç»„ä»¶">é‡è¦ç»„ä»¶&lt;/h3>
&lt;p>kubelet çš„æ¶æ„ç”± N å¤šçš„ç»„ä»¶ç»„æˆï¼Œä¸‹é¢ç®€å•ä»‹ç»ä¸‹æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªï¼š&lt;/p>
&lt;h4 id="pleg">PLEG&lt;/h4>
&lt;p>å³ &lt;strong>Pod Lifecycle Event Generator&lt;/strong>ï¼Œå­—é¢æ„æ€ Pod ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆ&lt;code>ContainerStarted&lt;/code>ã€&lt;code>ContainerDied&lt;/code>ã€&lt;code>ContainerRemoved&lt;/code>ã€&lt;code>ContainerChanged&lt;/code>ï¼‰ç”Ÿæˆå™¨ã€‚&lt;/p>
&lt;p>å…¶ç»´æŠ¤ç€ Pod ç¼“å­˜ï¼›å®šæœŸé€šè¿‡ &lt;code>ContainerRuntime&lt;/code> è·å– Pod çš„ä¿¡æ¯ï¼Œä¸ç¼“å­˜ä¸­çš„ä¿¡æ¯æ¯”è¾ƒï¼Œç”Ÿæˆå¦‚ä¸Šçš„äº‹ä»¶ï¼›å°†äº‹ä»¶å†™å…¥å…¶ç»´æŠ¤çš„é€šé“ï¼ˆchannelï¼‰ä¸­ã€‚&lt;/p>
&lt;h4 id="podworkers">PodWorkers&lt;/h4>
&lt;p>å¤„ç†äº‹ä»¶ä¸­ Pod çš„åŒæ­¥ã€‚æ ¸å¿ƒæ–¹æ³• &lt;code>managePodLoop()&lt;/code> é—´æ¥è°ƒç”¨ &lt;code>kubelet.syncPod()&lt;/code> å®Œæˆ Pod çš„åŒæ­¥ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœ Pod æ­£åœ¨è¢«åˆ›å»ºï¼Œè®°å½•å…¶å»¶è¿Ÿ&lt;/li>
&lt;li>ç”Ÿæˆ Pod çš„ API Statusï¼Œå³ &lt;code>v1.PodStatus&lt;/code>ï¼šä»è¿è¡Œæ—¶çš„ status è½¬æ¢æˆ api status&lt;/li>
&lt;li>è®°å½• Pod ä» &lt;code>pending&lt;/code> åˆ° &lt;code>running&lt;/code> çš„è€—æ—¶&lt;/li>
&lt;li>åœ¨ &lt;code>StatusManager&lt;/code> ä¸­æ›´æ–° pod çš„çŠ¶æ€&lt;/li>
&lt;li>æ€æ‰ä¸åº”è¯¥è¿è¡Œçš„ Pod&lt;/li>
&lt;li>å¦‚æœç½‘ç»œæ’ä»¶æœªå°±ç»ªï¼Œåªå¯åŠ¨ä½¿ç”¨äº†ä¸»æœºç½‘ç»œï¼ˆhost networkï¼‰çš„ Pod&lt;/li>
&lt;li>å¦‚æœ static pod ä¸å­˜åœ¨ï¼Œä¸ºå…¶åˆ›å»ºé•œåƒï¼ˆMirrorï¼‰Pod&lt;/li>
&lt;li>ä¸º Pod åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•ï¼šPod ç›®å½•ã€å·ç›®å½•ã€æ’ä»¶ç›®å½•&lt;/li>
&lt;li>ä½¿ç”¨ &lt;code>VolumeManager&lt;/code> ä¸º Pod æŒ‚è½½å·&lt;/li>
&lt;li>è·å– image pull secrets&lt;/li>
&lt;li>è°ƒç”¨å®¹å™¨è¿è¡Œæ—¶ï¼ˆcontainer runtimeï¼‰çš„ &lt;code>#SyncPod()&lt;/code> æ–¹æ³•&lt;/li>
&lt;/ul>
&lt;h4 id="podmanager">PodManager&lt;/h4>
&lt;p>å­˜å‚¨ Pod çš„æœŸæœ›çŠ¶æ€ï¼Œkubelet æœåŠ¡çš„ä¸åŒæ¸ é“çš„ Pod&lt;/p>
&lt;h4 id="statsprovider">StatsProvider&lt;/h4>
&lt;p>æä¾›èŠ‚ç‚¹å’Œå®¹å™¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œæœ‰ &lt;code>cAdvisor&lt;/code> å’Œ &lt;code>CRI&lt;/code> ä¸¤ç§å®ç°ã€‚&lt;/p>
&lt;h4 id="containerruntime">ContainerRuntime&lt;/h4>
&lt;p>é¡¾åæ€ä¹‰ï¼Œå®¹å™¨è¿è¡Œæ—¶ã€‚ä¸éµå¾ª CRI è§„èŒƒçš„é«˜çº§å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ã€‚&lt;/p>
&lt;h4 id="depspodconfig">Deps.PodConfig&lt;/h4>
&lt;p>PodConfig æ˜¯ä¸€ä¸ªé…ç½®å¤šè·¯å¤ç”¨å™¨ï¼Œå®ƒå°†è®¸å¤š Pod é…ç½®æºåˆå¹¶æˆä¸€ä¸ªå•ä¸€çš„ä¸€è‡´ç»“æ„ï¼Œç„¶åæŒ‰é¡ºåºå‘ç›‘å¬å™¨ä¼ é€’å¢é‡å˜æ›´é€šçŸ¥ã€‚&lt;/p>
&lt;p>é…ç½®æºæœ‰ï¼šæ–‡ä»¶ã€apiserverã€HTTP&lt;/p>
&lt;h4 id="syncloop">&lt;code>#syncLoop&lt;/code>&lt;/h4>
&lt;p>æ¥æ”¶æ¥è‡ª &lt;code>PodConfig&lt;/code> çš„ Pod å˜æ›´é€šçŸ¥ã€å®šæ—¶ä»»åŠ¡ã€&lt;code>PLEG&lt;/code> çš„äº‹ä»¶ï¼Œä»¥åŠ &lt;code>ProbeManager&lt;/code> çš„äº‹ä»¶ï¼Œå°† Pod åŒæ­¥åˆ°&lt;strong>æœŸæœ›çŠ¶æ€&lt;/strong>ã€‚&lt;/p>
&lt;h4 id="podadmithandlers">PodAdmitHandlers&lt;/h4>
&lt;p>Pod admission è¿‡ç¨‹ä¸­è°ƒç”¨çš„ä¸€ç³»åˆ—å¤„ç†å™¨ï¼Œæ¯”å¦‚ eviction handlerï¼ˆèŠ‚ç‚¹å†…å­˜æœ‰å‹åŠ›æ—¶ï¼Œä¸ä¼šé©±é€ QoS è®¾ç½®ä¸º &lt;code>BestEffort&lt;/code> çš„ Podï¼‰ã€shutdown admit handlerï¼ˆå½“èŠ‚ç‚¹å…³é—­æ—¶ï¼Œä¸å¤„ç† pod çš„åŒæ­¥æ“ä½œï¼‰ç­‰ã€‚&lt;/p>
&lt;h4 id="oomwatcher">OOMWatcher&lt;/h4>
&lt;p>ä»ç³»ç»Ÿæ—¥å¿—ä¸­è·å–å®¹å™¨çš„ OOM æ—¥å¿—ï¼Œå°†å…¶å°è£…æˆäº‹ä»¶å¹¶è®°å½•ã€‚&lt;/p>
&lt;h4 id="volumemanger">VolumeManger&lt;/h4>
&lt;p>VolumeManager è¿è¡Œä¸€ç»„å¼‚æ­¥å¾ªç¯ï¼Œæ ¹æ®åœ¨æ­¤èŠ‚ç‚¹ä¸Šè°ƒåº¦çš„ pod ç¡®å®šéœ€è¦é™„åŠ /æŒ‚è½½/å¸è½½/åˆ†ç¦»å“ªäº›å·å¹¶æ‰§è¡Œæ“ä½œã€‚&lt;/p>
&lt;h4 id="certificatemanager">CertificateManager&lt;/h4>
&lt;p>å¤„ç†è¯ä¹¦è½®æ¢ã€‚&lt;/p>
&lt;h4 id="probemanager">ProbeManager&lt;/h4>
&lt;p>å®é™…ä¸ŠåŒ…å«äº†ä¸‰ç§ Probeï¼Œæä¾› probe ç»“æœç¼“å­˜å’Œé€šé“ã€‚&lt;/p>
&lt;ul>
&lt;li>LivenessManager&lt;/li>
&lt;li>ReadinessManager&lt;/li>
&lt;li>StartupManager&lt;/li>
&lt;/ul>
&lt;h4 id="evictionmanager">EvictionManager&lt;/h4>
&lt;p>ç›‘æ§ Node èŠ‚ç‚¹çš„èµ„æºå ç”¨æƒ…å†µï¼Œæ ¹æ®é©±é€è§„åˆ™é©±é€ Pod é‡Šæ”¾èµ„æºï¼Œç¼“è§£èŠ‚ç‚¹çš„å‹åŠ›ã€‚&lt;/p>
&lt;h4 id="pluginmanager">PluginManager&lt;/h4>
&lt;p>PluginManager è¿è¡Œä¸€ç»„å¼‚æ­¥å¾ªç¯ï¼Œæ ¹æ®æ­¤èŠ‚ç‚¹ç¡®å®šå“ªäº›æ’ä»¶éœ€è¦æ³¨å†Œ/å–æ¶ˆæ³¨å†Œå¹¶æ‰§è¡Œã€‚å¦‚ CSI é©±åŠ¨å’Œè®¾å¤‡ç®¡ç†å™¨æ’ä»¶ï¼ˆDevice Pluginï¼‰ã€‚&lt;/p>
&lt;h5 id="csi">CSI&lt;/h5>
&lt;p>Container Storage Interfaceï¼Œç”±å­˜å‚¨å‚å•†å®ç°çš„å­˜å‚¨é©±åŠ¨ã€‚&lt;/p>
&lt;h5 id="è®¾å¤‡ç®¡ç†å™¨æ’ä»¶device-plugin">è®¾å¤‡ç®¡ç†å™¨æ’ä»¶ï¼ˆDevice Pluginï¼‰&lt;/h5>
&lt;p>Kubernetes æä¾›äº†ä¸€ä¸ª è®¾å¤‡æ’ä»¶æ¡†æ¶ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥å°†ç³»ç»Ÿç¡¬ä»¶èµ„æºå‘å¸ƒåˆ° Kubeletã€‚&lt;/p>
&lt;p>ä¾›åº”å•†å¯ä»¥å®ç°è®¾å¤‡æ’ä»¶ï¼Œç”±ä½ æ‰‹åŠ¨éƒ¨ç½²æˆ–ä½œä¸º DaemonSet æ¥éƒ¨ç½²ï¼Œè€Œä¸å¿…å®šåˆ¶ Kubernetes æœ¬èº«çš„ä»£ç ã€‚ç›®æ ‡è®¾å¤‡åŒ…æ‹¬ GPUã€é«˜æ€§èƒ½ NICã€FPGAã€ InfiniBand é€‚é…å™¨ä»¥åŠå…¶ä»–ç±»ä¼¼çš„ã€å¯èƒ½éœ€è¦ç‰¹å®šäºä¾›åº”å•†çš„åˆå§‹åŒ–å’Œè®¾ç½®çš„è®¡ç®—èµ„æºã€‚&lt;/p>
&lt;h2 id="kubelet-çš„å¯åŠ¨æµç¨‹">kubelet çš„å¯åŠ¨æµç¨‹&lt;/h2>
&lt;p>è¦åˆ†æ kubelet çš„å¯åŠ¨æµç¨‹ï¼Œå¯ä»¥ä» kubelet è¿è¡Œæ–¹å¼ç€æ‰‹ã€‚æ‰¾ä¸€ä¸ª Node èŠ‚ç‚¹ï¼Œå¾ˆå®¹æ˜“å°±èƒ½æ‰¾åˆ° kubelet çš„è¿›ç¨‹ã€‚ç”±äºå…¶æ˜¯ä»¥ &lt;code>systemd&lt;/code> çš„æ–¹å¼å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ &lt;code>systemctl&lt;/code> æŸ¥çœ‹å…¶çŠ¶æ€ã€‚&lt;/p>
&lt;h3 id="kubelet-å¯åŠ¨å‘½ä»¤">kubelet å¯åŠ¨å‘½ä»¤&lt;/h3>
&lt;p>kubelet çš„å¯åŠ¨å‘½ä»¤ï¼ˆminikube ç¯å¢ƒï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ ps -aux &lt;span class="p">|&lt;/span> grep &lt;span class="s1">&amp;#39;/kubelet&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> grep -v grep
root &lt;span class="m">4917&lt;/span> 2.6 0.3 &lt;span class="m">1857652&lt;/span> &lt;span class="m">106152&lt;/span> ? Ssl 01:34 13:05 /var/lib/minikube/binaries/v1.21.0/kubelet --bootstrap-kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/bootstrap-kubelet.conf --config&lt;span class="o">=&lt;/span>/var/lib/kubelet/config.yaml --container-runtime&lt;span class="o">=&lt;/span>docker --hostname-override&lt;span class="o">=&lt;/span>1.21.0 --kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/kubelet.conf --node-ip&lt;span class="o">=&lt;/span>192.168.64.5
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ systemctl status kubelet.service
â— kubelet.service - kubelet: The Kubernetes Node Agent
Loaded: loaded &lt;span class="o">(&lt;/span>/usr/lib/systemd/system/kubelet.service&lt;span class="p">;&lt;/span> disabled&lt;span class="p">;&lt;/span> vendor preset: enabled&lt;span class="o">)&lt;/span>
Drop-In: /etc/systemd/system/kubelet.service.d
â””â”€10-kubeadm.conf
Active: active &lt;span class="o">(&lt;/span>running&lt;span class="o">)&lt;/span> since Sun 2021-06-13 01:34:42 UTC&lt;span class="p">;&lt;/span> 11h ago
Docs: http://kubernetes.io/docs/
Main PID: &lt;span class="m">4917&lt;/span> &lt;span class="o">(&lt;/span>kubelet&lt;span class="o">)&lt;/span>
Tasks: &lt;span class="m">15&lt;/span> &lt;span class="o">(&lt;/span>limit: 38314&lt;span class="o">)&lt;/span>
Memory: 39.4M
CGroup: /system.slice/kubelet.service
â””â”€4917 /var/lib/minikube/binaries/v1.21.0/kubelet --bootstrap-kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/bootstrap-kubelet.conf --config&lt;span class="o">=&lt;/span>/var/lib/kubelet/config.yaml --container-runtime&lt;span class="o">=&lt;/span>docker --hostname-override&lt;span class="o">=&lt;/span>1.21.0 --kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/kubelet.conf --node-ip&lt;span class="o">=&lt;/span>192.168.64
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æºç åˆ†æ">æºç åˆ†æ&lt;/h3>
&lt;p>ä» &lt;code>git@github.com:kubernetes/kubernetes.git&lt;/code> ä»“åº“è·å–ä»£ç ï¼Œä½¿ç”¨æœ€æ–°çš„ &lt;code>release-1.21&lt;/code> åˆ†æ”¯ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>cmd/kubelet/kubelet.go:35&lt;/code> çš„ &lt;code>main&lt;/code> æ–¹æ³•ä¸ºç¨‹åºå…¥å£ã€‚
&lt;ul>
&lt;li>è°ƒç”¨ &lt;code>NewKubeletCommand&lt;/code> æ–¹æ³•ï¼Œåˆ›å»º command&lt;/li>
&lt;li>æ‰§è¡Œ command
&lt;ul>
&lt;li>&lt;code>cmd/kubelet/app/server.go:434&lt;/code> çš„ &lt;code>Run&lt;/code> æ–¹æ³•ã€‚
&lt;ul>
&lt;li>è°ƒç”¨ &lt;code>RunKubelet&lt;/code> æ–¹æ³•ã€‚
&lt;ul>
&lt;li>è°ƒç”¨ &lt;code>createAndInitKubelet&lt;/code> æ–¹æ³•ï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ– kubelet
&lt;ul>
&lt;li>&lt;code>pkg/kubelet/kubelet.go&lt;/code> çš„ &lt;code>NewMainKubelet&lt;/code> æ–¹æ³•ï¼Œåˆ›å»º kubeletçš„ å„ç§ç»„ä»¶ã€‚å…±åå‡ ä¸ªç»„ä»¶ï¼Œè§ &lt;a href="#kubelet-%E6%9E%B6%E6%9E%84">kubelet çš„æ„æ¶&lt;/a>ã€‚&lt;/li>
&lt;li>è°ƒç”¨ &lt;code>BirtyCry&lt;/code> æ–¹æ³•ï¼šæ”¾å‡º &lt;code>Starting&lt;/code> äº‹ä»¶&lt;/li>
&lt;li>è°ƒç”¨ &lt;code>StartGarbageCollection&lt;/code> æ–¹æ³•ï¼Œå¼€å¯ &lt;code>ContainerGC&lt;/code> å’Œ &lt;code>ImageGC&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>è°ƒç”¨ &lt;code>startKubelet&lt;/code> æ–¹æ³•ï¼ˆå¤§é‡ä½¿ç”¨ goroutine å’Œé€šé“ï¼‰
&lt;ul>
&lt;li>goroutineï¼š&lt;code>kubelet.Run()&lt;/code>
&lt;ul>
&lt;li>åˆå§‹åŒ–æ¨¡å—
&lt;ul>
&lt;li>metrics ç›¸å…³&lt;/li>
&lt;li>åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•ç›®å½•&lt;/li>
&lt;li>åˆ›å»ºå®¹å™¨æ—¥å¿—ç›®å½•&lt;/li>
&lt;li>å¯åŠ¨ &lt;code>ImageGCManager&lt;/code>&lt;/li>
&lt;li>å¯åŠ¨ &lt;code>ServerCertificateManager&lt;/code>&lt;/li>
&lt;li>å¯åŠ¨ &lt;code>OOMWatcher&lt;/code>&lt;/li>
&lt;li>å¯åŠ¨ &lt;code>ResourceAnalyzer&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>goroutineï¼š&lt;code>VolumeManager.Run()&lt;/code> å¼€å§‹å¤„ç† Pod Volume çš„å¸è½½å’ŒæŒ‚è½½&lt;/li>
&lt;li>goroutineï¼šçŠ¶æ€æ›´æ–° &lt;code>fastStatusUpdateOnce()&lt;/code> ï¼ˆæ›´æ–° Pod CIDR -&amp;gt; æ›´æ–° &lt;code>ContainerRuntime&lt;/code> çŠ¶æ€ -&amp;gt; æ›´æ–° Node èŠ‚ç‚¹çŠ¶æ€ï¼‰&lt;/li>
&lt;li>goroutineï¼š &lt;code>NodeLeaseController.Run()&lt;/code> æ›´æ–°èŠ‚ç‚¹ç§Ÿçº¦&lt;/li>
&lt;li>goroutineï¼š&lt;code>podKiller.PerformPodKillingWork&lt;/code> æ€æ‰æœªè¢«æ­£ç¡®å¤„ç†çš„ pod&lt;/li>
&lt;li>&lt;code>StatusManager.Start()&lt;/code> å¼€å§‹å‘ apiserver æ›´æ–° Pod çŠ¶æ€&lt;/li>
&lt;li>&lt;code>RuntimeClassManager.Start()&lt;/code>&lt;/li>
&lt;li>&lt;code>PLEG.Start()&lt;/code>ï¼šæŒç»­ä» &lt;code>ContainerRuntime&lt;/code> è·å– Pod/å®¹å™¨çš„çŠ¶æ€ï¼Œå¹¶ä¸ kubelet æœ¬åœ° cache ä¸­çš„æ¯”è¾ƒï¼Œç”Ÿæˆå¯¹åº”çš„ &lt;code>Event&lt;/code>&lt;/li>
&lt;li>&lt;code>syncLoop()&lt;/code> é‡ç‚¹ï¼Œ&lt;strong>&lt;em>æŒç»­ç›‘æ§å¹¶å¤„ç†æ¥è‡ªæ–‡ä»¶ã€apiserverã€http çš„å˜æ›´&lt;/em>&lt;/strong>ã€‚åŒ…æ‹¬ Pod çš„å¢åŠ ã€æ›´æ–°ã€ä¼˜é›…åˆ é™¤ã€éä¼˜é›…åˆ é™¤ã€è°ƒå’Œã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>å¯åŠ¨ serverï¼Œæš´éœ² &lt;code>/healthz&lt;/code> ç«¯ç‚¹&lt;/li>
&lt;li>é€šçŸ¥ &lt;code>systemd&lt;/code> &lt;code>kuberlet&lt;/code> æœåŠ¡å·²ç»å¯åŠ¨&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="kubelet-çš„å·¥ä½œåŸç†">kubelet çš„å·¥ä½œåŸç†&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/15/20210615000611.png" alt="">&lt;/p>
&lt;ol>
&lt;li>æ¥é™æ€æ–‡ä»¶ã€apiserver ä»¥åŠ HTTP è¯·æ±‚çš„ Pod é…ç½®å˜æ›´ï¼Œè¢«å‘é€åˆ° &lt;code>kubelet.syncLoop&lt;/code>&lt;/li>
&lt;li>PLEG ä¼šå®šæœŸé€šè¿‡å®¹å™¨è¿è¡Œæ—¶è·å–èŠ‚ç‚¹ä¸Š Pod çš„çŠ¶æ€ï¼Œä¸å…¶ç¼“å­˜ä¸­çš„ Pod ä¿¡æ¯è¿›è¡Œæ¯”è¾ƒï¼Œå°è£…æˆäº‹ä»¶ï¼Œè¿›å…¥ PLEG çš„é€šé“&lt;/li>
&lt;li>å®šæœŸæ£€æŸ¥å·¥ä½œé˜Ÿåˆ—ä¸­çš„ Pod&lt;/li>
&lt;li>ProbeManager çš„é€šé“ä¸­çš„ Pod&lt;/li>
&lt;li>ä»¥ä¸Š 1~4ï¼Œéƒ½ä¼šè¿›å…¥ &lt;code>syncLoopIteration&lt;/code>ï¼Œå¹¶ä»å¯¹åº”çš„é€šé“ä¸­è·å–åˆ°å¯¹åº” Podï¼Œå°† Pod çš„ä¿¡æ¯ä¿å­˜åˆ° &lt;code>PodManager&lt;/code>ï¼›ç„¶ååˆ†å‘ç»™ &lt;code>PodWorker&lt;/code>ï¼Œ&lt;a href="#PodWorkers">å®Œæˆä¸€äº›åˆ—çš„åŒæ­¥å·¥ä½œ&lt;/a>ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>kubelet å¯åŠ¨æµé‡å°±è®²åˆ°è¿™é‡Œï¼Œè™½ç„¶å¤æ‚ï¼Œè¿˜æ˜¯æœ‰è¿¹å¯å¾ªã€‚åªè¦äº†è§£äº† kubelet åœ¨ Kubernetes ä¸­çš„å®šä½åŠè§’è‰²ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£å…¶å·¥ä½œæµé‡ã€‚&lt;/p>
&lt;p>åé¢ä¼šå†æ·±å…¥åˆ†æ Pod åˆ›å»ºåŠå¯åŠ¨æµç¨‹ã€‚&lt;/p></description></item><item><title>Kubernetes ä¸Šå¦‚ä½•æ§åˆ¶å®¹å™¨çš„å¯åŠ¨é¡ºåºï¼Ÿ</title><link>https://atbug.com/k8s-1.18-container-start-sequence-control/</link><pubDate>Fri, 30 Apr 2021 07:43:54 +0800</pubDate><guid>https://atbug.com/k8s-1.18-container-start-sequence-control/</guid><description>
&lt;p>å»å¹´å†™è¿‡ä¸€ç¯‡åšå®¢ï¼š&lt;a href="https://mp.weixin.qq.com/s/5UXhXpwPDBh2xuGKq9Nqig">æ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº&lt;/a>ï¼Œåˆ†æäº† &lt;a href="https://github.com/tektoncd">TektonCD&lt;/a> çš„å®¹å™¨å¯åŠ¨æ§åˆ¶çš„åŸç†ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆè¦åšå®¹å™¨å¯åŠ¨é¡ºåºæ§åˆ¶ï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“ Pod ä¸­é™¤äº† &lt;code>init-container&lt;/code> ä¹‹å¤–ï¼Œæ˜¯å…è®¸æ·»åŠ å¤šä¸ªå®¹å™¨çš„ã€‚ç±»ä¼¼ TektonCD ä¸­ &lt;code>task&lt;/code> å’Œ &lt;code>step&lt;/code> çš„æ¦‚å¿µå°±åˆ†åˆ«ä¸ &lt;code>pod&lt;/code> å’Œ &lt;code>container&lt;/code> å¯¹åº”ï¼Œè€Œ &lt;code>step&lt;/code> æ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œçš„ã€‚æ­¤å¤–è¿˜æœ‰æœåŠ¡ç½‘æ ¼çš„åœºæ™¯ï¼Œsidecar å®¹å™¨éœ€è¦åœ¨æœåŠ¡å®¹å™¨å¯åŠ¨ä¹‹å‰å®Œæˆé…ç½®çš„åŠ è½½ï¼Œä¹Ÿéœ€è¦å¯¹å®¹å™¨çš„å¯åŠ¨é¡ºåºåŠ ä»¥æ§åˆ¶ã€‚å¦åˆ™ï¼ŒæœåŠ¡å®¹å™¨å…ˆå¯åŠ¨ï¼Œè€Œ sidecar è¿˜æ— æ³•æä¾›ç½‘ç»œä¸Šçš„æ”¯æŒã€‚&lt;/p>
&lt;h3 id="ç°å®">ç°å®&lt;/h3>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/sidecarlifecycle1.gif" alt="sidecar-lifecycle-1">&lt;/p>
&lt;h3 id="æœŸæœ›">æœŸæœ›&lt;/h3>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/sidecarlifecycle2.gif" alt="sidecar-lifecycle-2">&lt;/p>
&lt;p>åˆ°äº†è¿™é‡Œè‚¯å®šæœ‰åŒå­¦ä¼šé—®ï¼Œ&lt;code>spec.containers[]&lt;/code> æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„æ˜¯æœ‰é¡ºåºçš„ã€‚Kubernetes ä¹Ÿç¡®å®æ˜¯æŒ‰ç…§é¡ºåºæ¥åˆ›å»ºå’Œå¯åŠ¨å®¹å™¨ï¼Œä½†æ˜¯ &lt;strong>å®¹å™¨å¯åŠ¨æˆåŠŸï¼Œå¹¶ä¸è¡¨ç¤ºå®¹å™¨å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡&lt;/strong>ã€‚&lt;/p>
&lt;p>åœ¨ Kubernetes 1.18 éæ­£å¼ç‰ˆä¸­æ›¾åœ¨ Lifecycle å±‚é¢æä¾›äº†å¯¹ &lt;code>sidecar ç±»å‹å®¹å™¨çš„&lt;/code> æ”¯æŒï¼Œä½†æ˜¯æœ€ç»ˆè¯¥åŠŸèƒ½å¹¶&lt;a href="https://github.com/kubernetes/enhancements/issues/753#issuecomment-713471597">æ²¡æœ‰è½åœ°&lt;/a>ã€‚&lt;/p>
&lt;p>é‚£åˆ°åº•è¯¥æ€ä¹ˆåšï¼Ÿ&lt;/p>
&lt;h2 id="tldr">TL;DR&lt;/h2>
&lt;p>ç¬”è€…å‡†å¤‡äº†ä¸€ä¸ªç®€å•çš„ &lt;a href="https://github.com/addozhang/k8s-container-sequence-sample">go é¡¹ç›®&lt;/a>ï¼Œç”¨äºæ¨¡æ‹Ÿ sidecar çš„å¯åŠ¨åŠé…ç½®åŠ è½½ã€‚&lt;/p>
&lt;p>å…‹éš†ä»£ç åå¯ä»¥é€šè¿‡ &lt;code>make build&lt;/code> æ„å»ºå‡ºé•œåƒï¼Œå‡å¦‚ä½ æ˜¯ç”¨çš„ minikube è¿›è¡Œçš„å®éªŒï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ &lt;code>make load-2-minikube&lt;/code> å°†é•œåƒåŠ è½½åˆ° minikube èŠ‚ç‚¹ä¸­ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ Deployment çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ï¼Œç›´æ¥ç”¨ Pod ä¹Ÿå¯ä»¥ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">strategy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">addozhang/k8s-container-sequence-sidecar:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sidecar&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">IfNotPresent&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">lifecycle&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">postStart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">exec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">wait&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">busybox:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">app&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">IfNotPresent&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/bin/sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;-c&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;date; echo &amp;#39;app container started&amp;#39;; tail -f /dev/null&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸‹é¢çš„æˆªå›¾ä¸­ï¼Œæ¼”ç¤ºäº†åœ¨ &lt;code>sample&lt;/code> å‘½åç©ºé—´ä¸­ï¼Œpod å†…ä¸¤ä¸ªå®¹å™¨çš„æ‰§è¡Œé¡ºåºã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/20210430-062819.gif" alt="2021-04-30 06.28.19">&lt;/p>
&lt;h2 id="kubernetes-æºç ">Kubernetes æºç &lt;/h2>
&lt;p>åœ¨ kubelet çš„æºç  &lt;code>pkg/kubelet/kuberuntime/kuberuntime_manager.go&lt;/code> ä¸­ï¼Œ&lt;code>#SyncPod&lt;/code> æ–¹æ³•ç”¨äºåˆ›å»º Podï¼Œæ­¥éª¤æ¯”è¾ƒç¹çï¼Œç›´æ¥çœ‹ç¬¬ 7 æ­¥ï¼šåˆ›å»ºæ™®é€šå®¹å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// SyncPod syncs the running pod into the desired pod by executing following steps:
&lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">// 1. Compute sandbox and container changes.
&lt;/span>&lt;span class="c1">// 2. Kill pod sandbox if necessary.
&lt;/span>&lt;span class="c1">// 3. Kill any containers that should not be running.
&lt;/span>&lt;span class="c1">// 4. Create sandbox if necessary.
&lt;/span>&lt;span class="c1">// 5. Create ephemeral containers.
&lt;/span>&lt;span class="c1">// 6. Create init containers.
&lt;/span>&lt;span class="c1">// 7. Create normal containers.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubeGenericRuntimeManager&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SyncPod&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pod&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podStatus&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubecontainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodStatus&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pullSecrets&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Secret&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">backOff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">flowcontrol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Backoff&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span> &lt;span class="nx">kubecontainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodSyncResult&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="c1">// Step 7: start containers in podContainerChanges.ContainersToStart.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">idx&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">podContainerChanges&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ContainersToStart&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;container&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">containerStartSpec&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">pod&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Containers&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">idx&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ &lt;code>#start&lt;/code> æ–¹æ³•ä¸­è°ƒç”¨äº† &lt;code>#startContainer&lt;/code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå¯åŠ¨å®¹å™¨ï¼Œå¹¶è¿”å›å®¹å™¨å¯åŠ¨çš„ç»“æœã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ç»“æœè¿˜ &lt;strong>åŒ…å«äº†å®¹å™¨çš„ Lifecycle hooks è°ƒç”¨&lt;/strong>ã€‚&lt;/p>
&lt;p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚å®¹å™¨çš„ &lt;code>PostStart&lt;/code> hook æ²¡æœ‰æ­£ç¡®çš„è¿”å›ï¼Œkubelet ä¾¿ä¸ä¼šå»åˆ›å»ºä¸‹ä¸€ä¸ªå®¹å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// startContainer starts a container and returns a message indicates why it is failed on error.
&lt;/span>&lt;span class="c1">// It starts the container through the following steps:
&lt;/span>&lt;span class="c1">// * pull the image
&lt;/span>&lt;span class="c1">// * create the container
&lt;/span>&lt;span class="c1">// * start the container
&lt;/span>&lt;span class="c1">// * run the post start lifecycle hooks (if applicable)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubeGenericRuntimeManager&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">startContainer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">podSandboxID&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podSandboxConfig&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">runtimeapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodSandboxConfig&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">spec&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">startSpec&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pod&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podStatus&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubecontainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodStatus&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pullSecrets&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Secret&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podIP&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podIPs&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="c1">// Step 4: execute the post start hook.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lifecycle&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lifecycle&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PostStart&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">kubeContainerID&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">kubecontainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ContainerID&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">runtimeName&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">containerID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">handlerErr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">runner&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">kubeContainerID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lifecycle&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PostStart&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">handlerErr&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">recordContainerEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">kubeContainerID&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventTypeWarning&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">events&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FailedPostStartHook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">killContainer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">kubeContainerID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;FailedPostStartHook&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reasonFailedPostStartHook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ErrorS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%s: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ErrPostStartHook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">handlerErr&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;Failed to kill container&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;pod&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">KObj&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pod&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="s">&amp;#34;podUID&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pod&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;containerName&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;containerID&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">kubeContainerID&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%s: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ErrPostStartHook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">handlerErr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å®ç°æ–¹æ¡ˆ">å®ç°æ–¹æ¡ˆ&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/16197365667225.jpg" alt="">&lt;/p>
&lt;p>&lt;a href="https://github.com/addozhang/k8s-container-sequence-sample/blob/main/cmd/entrypoint/wait.go#L26">cmd/entrypoint/wait.go#L26&lt;/a> ï¼ˆè¿™é‡Œå‚è€ƒäº† Istio çš„ pilot-agent å®ç° ï¼‰&lt;/p>
&lt;p>åœ¨ &lt;code>PostStart&lt;/code> ä¸­æŒç»­çš„å»æ£€æŸ¥ &lt;code>/ready&lt;/code> æ–­ç‚¹ï¼Œå¯ä»¥ hold ä½å½“å‰å®¹å™¨çš„åˆ›å»ºæµç¨‹ã€‚ä¿è¯ &lt;code>/ready&lt;/code> è¿”å› &lt;code>200&lt;/code> åï¼Œkubelet æ‰ä¼šå»åˆ›å»ºä¸‹ä¸€ä¸ªå®¹å™¨ã€‚&lt;/p>
&lt;p>è¿™æ ·å°±è¾¾åˆ°äº†å‰é¢æˆªå›¾ä¸­æ¼”ç¤ºçš„æ•ˆæœã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Before&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">timeoutAt&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">checkIfReady&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">url&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sidecar is ready&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sidecar is not ready&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">periodMillis&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Millisecond&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sidecar is not ready in %d second(s)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">timeoutSeconds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://banzaicloud.com/blog/k8s-sidecars/">Sidecar container lifecycle changes in Kubernetes 1.18&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://medium.com/@marko.luksa/delaying-application-start-until-sidecar-is-ready-2ec2d21a7b74">Delaying application start until sidecar is ready&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>æœåŠ¡ç½‘æ ¼å¹³ç¨³è½åœ°ï¼šIstio ä¸­ç²¾å‡†æ§åˆ¶ Sidecar çš„æ³¨å…¥</title><link>https://atbug.com/how-to-control-istio-sidecar-injection/</link><pubDate>Wed, 21 Apr 2021 08:13:04 +0800</pubDate><guid>https://atbug.com/how-to-control-istio-sidecar-injection/</guid><description>
&lt;h2 id="ä¸ºä»€ä¹ˆ">ä¸ºä»€ä¹ˆ&lt;/h2>
&lt;p>è¯´èµ·æœåŠ¡ç½‘æ ¼ï¼Œè¿™å¹…å›¾å¤§å®¶è‚¯å®šä¸ä¼šé™Œç”Ÿã€‚è¿™å°±æ˜¯æœåŠ¡ç½‘æ ¼çš„ç½‘ç»œï¼Œä¹Ÿæ˜¯ç½‘æ ¼æ¶æ„çš„ç»ˆæå½¢æ€ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/21/cleanshot-20210420-at-2314142x.png" alt="">&lt;/p>
&lt;p>é‚£åœ¨è¿ç§»åˆ°ç½‘æ ¼æ¶æ„ä¹‹å‰ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/21/cleanshot-20210420-at-2316432x.png" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬çš„ç³»ç»Ÿåœ¨æ¼”è¿›çš„è¿‡ç¨‹ä¸­ï¼Œä¸å¯é¿å…çš„ä¼šé‡åˆ°å„ç§ 0 åˆ° 1 è¿‡ç¨‹ä¸­çš„ä¸­é—´æ€ã€‚æ¯”å¦‚ä¸‹é¢è¿™ç§ï¼Œå¯ä»¥æ¯”è¾ƒç›´è§‚çš„çœ‹å‡º Istio æˆ–è€…ç½‘æ ¼æ˜¯éƒ¨åˆ†è¦†ç›–çš„ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¹³æ»‘ã€å¯æ§çš„æ¨è¿›ï¼Œæ‰èƒ½åœ¨ä¿éšœç³»ç»Ÿå¯ç”¨æ€§çš„å‰æä¸‹è¿›è¡Œæ¶æ„çš„æ¼”è¿›ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/21/cleanshot-20210420-at-2318242x.png" alt="">&lt;/p>
&lt;h2 id="æ€ä¹ˆåš">æ€ä¹ˆåš&lt;/h2>
&lt;p>Sidecar çš„æ³¨å…¥åˆ†ä¸¤ç§ï¼šæ‰‹åŠ¨å’Œè‡ªåŠ¨ã€‚&lt;/p>
&lt;h3 id="æ‰‹åŠ¨">æ‰‹åŠ¨&lt;/h3>
&lt;p>æ‰‹åŠ¨å°±æ˜¯åˆ©ç”¨ Istio çš„ cli å·¥å…· &lt;code>istioctl kube-inject&lt;/code> å¯¹èµ„æº yaml è¿›è¡Œä¿®æ”¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ istioctl kube-inject -f samples/sleep/sleep.yaml &lt;span class="p">|&lt;/span> kubectl apply -f -
serviceaccount/sleep created
service/sleep created
deployment.apps/sleep created
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰‹åŠ¨çš„æ–¹å¼æ¯”è¾ƒé€‚åˆå¼€å‘é˜¶æ®µä½¿ç”¨ã€‚&lt;/p>
&lt;h3 id="è‡ªåŠ¨">è‡ªåŠ¨&lt;/h3>
&lt;p>sidecar çš„è‡ªåŠ¨æ³¨å…¥åˆ™æ˜¯é€šè¿‡ &lt;a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/">mutating webhook admission controller&lt;/a> å®ç°çš„ã€‚å…¶åŸç†ç®€å•è¯´å°±æ˜¯æ‹¦æˆª podçš„åˆ›å»ºè¯·æ±‚æ¥å¯¹ pod çš„èµ„æºå®šä¹‰è¿›è¡Œä¿®æ”¹ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯¹æˆªå–äº† &lt;code>istio-sidecar-injector&lt;/code> &lt;code>MutatingWebhookConfiguration&lt;/code> çš„éƒ¨åˆ†å†…å®¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">webhooks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Exact&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sidecar-injector.istio.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespaceSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">istio-injection&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">enabled&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">objectSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sidecar.istio.io/inject&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NotIn&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">values&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#4&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiVersions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">operations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">CREATE&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pods&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scope&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>è¿™é‡Œçš„ &lt;code>matchPolicy: Exact&lt;/code> é’ˆå¯¹çš„æ˜¯ #4 ä¸­çš„ &lt;code>apiGroups&lt;/code>ä¸&lt;code>apiVersions&lt;/code> çš„ç»„åˆï¼Œå³ç²¾ç¡®åŒ¹é… &lt;code>v1/pods&lt;/code> çš„ &lt;code>CREATE&lt;/code> è¯·æ±‚&lt;/li>
&lt;li>é¡¾åæ€ä¹‰ï¼ŒåŒ¹é…ç¬¦åˆæ¡ä»¶çš„ &lt;code>namespace&lt;/code>&lt;/li>
&lt;li>åŒ2ï¼ŒåŒ¹é…ç¬¦åˆæ¡ä»¶çš„ &lt;code>object&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>æ³¨ï¼š #2ã€#3 æ”¯æŒ Kubernetes çš„&lt;a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/">æ ‡ç­¾é€‰æ‹©è¯­æ³•&lt;/a>&lt;/p>
&lt;p>æŒ‰ç…§å‰é¢çš„è¯´æ˜ï¼Œè¿™ä¸ª hook ä¼šæ‹¦æˆªæ‰“äº† &lt;code>istio-injection: enabled&lt;/code> label çš„ namespace ä¸‹ï¼Œæ²¡æœ‰æ‰“ &lt;code>sidecar.istio.io/inject: false&lt;/code> æ ‡ç­¾çš„ &lt;code>v1/pod&lt;/code> çš„åˆ›å»ºã€‚é€šè¿‡ &lt;code>https://istiod.istio-system:443/inject&lt;/code> ç«¯ç‚¹å¯¹ pod çš„å®šä¹‰è¿›è¡Œå®šåˆ¶ï¼ˆæ·»åŠ  &lt;code>init-container&lt;/code>ã€sidecar å®¹å™¨ç­‰ï¼‰ã€‚&lt;/p>
&lt;p>æœ‰äººå¯èƒ½ä¼šè¯´è¿™æ ·è¿˜ä¸å¤Ÿç²¾å‡†ï¼Œå› ä¸ºå¯èƒ½æŸä¸ª namespace ä¸‹åªæœ‰éƒ¨åˆ†å¯¹è±¡æ‰ä¼šæ³¨å…¥ sidecarã€‚&lt;/p>
&lt;p>è¿™å°±éœ€è¦å€ŸåŠ© &lt;code>istiod&lt;/code> çš„é€»è¾‘äº†ã€‚&lt;/p>
&lt;h3 id="åªé’ˆå¯¹ç‰¹å®š-pod-æ³¨å…¥sidecar-æˆ–å¿½ç•¥æ³¨å…¥">åªé’ˆå¯¹ç‰¹å®š pod æ³¨å…¥sidecar æˆ–å¿½ç•¥æ³¨å…¥&lt;/h3>
&lt;p>åœ¨ &lt;code>configmap&lt;/code> &lt;code>istio-sidecar-injector&lt;/code> ä¸­æœ‰ä¸¤ä¸ªå­—æ®µ &lt;code>alwaysInjectSelector&lt;/code> å’Œ &lt;code>neverInjectSelector&lt;/code>ã€‚ä»åå­—æ¥çœ‹è¿™ä¸¤ä¸ªåˆ†åˆ«æä¾›äº†ç™½åå•ã€é»‘åå•çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">alwaysInjectSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="l">neverInjectSelector:[]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬åªéœ€å¦‚ä¸‹è°ƒæ•´ï¼ˆéœ€è¦é‡å¯ istiodï¼‰ï¼Œç„¶åä¸ºéœ€è¦æ³¨å…¥ sidecar çš„èµ„æºæ‰“ä¸Šç›¸åº”çš„æ ‡ç­¾å³å¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">alwaysInjectSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sidecar.istio.io/inject&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">In&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">values&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;true&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;enabled&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;yes&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨ Kubernetes ä¸Šçš„è¿›åŒ–</title><link>https://atbug.com/translation-distributed-systems-kubernetes/</link><pubDate>Mon, 29 Mar 2021 23:11:25 +0800</pubDate><guid>https://atbug.com/translation-distributed-systems-kubernetes/</guid><description>
&lt;p>æœ¬æ–‡è¯‘è‡ª &lt;a href="https://www.infoq.com/articles/distributed-systems-kubernetes/">The Evolution of Distributed Systems on Kubernetes&lt;/a>&lt;/p>
&lt;p>åœ¨ 3 æœˆä»½çš„ QCon ä¸Šï¼Œæˆ‘åšäº†ä¸€ä¸ªå…³äº Kubernetes çš„åˆ†å¸ƒå¼ç³»ç»Ÿè¿›åŒ–çš„æ¼”è®²ã€‚é¦–å…ˆï¼Œæˆ‘æƒ³å…ˆé—®ä¸€ä¸ªé—®é¢˜ï¼Œå¾®æœåŠ¡ä¹‹åæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ç›¸ä¿¡å¤§å®¶éƒ½æœ‰å„è‡ªçš„ç­”æ¡ˆï¼Œæˆ‘ä¹Ÿæœ‰æˆ‘çš„ç­”æ¡ˆã€‚ä½ ä¼šåœ¨æœ€åå‘ç°æˆ‘çš„æƒ³æ³•æ˜¯ä»€ä¹ˆã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæˆ‘å»ºè®®å¤§å®¶çœ‹çœ‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Ÿä»¥åŠè¿™äº›éœ€æ±‚åœ¨è¿‡å»æ˜¯å¦‚ä½•å‘å±•çš„ï¼Œä»å•ä½“åº”ç”¨å¼€å§‹åˆ° Kubernetesï¼Œå†åˆ°æœ€è¿‘çš„ Daprã€Istioã€Knative ç­‰é¡¹ç›®ï¼Œå®ƒä»¬æ˜¯å¦‚ä½•æ”¹å˜æˆ‘ä»¬åšåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ–¹å¼ã€‚æˆ‘ä»¬å°†å°è¯•å¯¹æœªæ¥åšä¸€äº›é¢„æµ‹ã€‚&lt;/p>
&lt;h2 id="ç°ä»£åˆ†å¸ƒå¼åº”ç”¨">ç°ä»£åˆ†å¸ƒå¼åº”ç”¨&lt;/h2>
&lt;p>ä¸ºäº†ç»™è¿™ä¸ªè¯é¢˜æä¾›æ›´å¤šçš„èƒŒæ™¯ä¿¡æ¯ï¼Œæˆ‘è®¤ä¸ºçš„åˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ç”±æ•°ç™¾ä¸ªç»„ä»¶ç»„æˆçš„ç³»ç»Ÿã€‚è¿™äº›ç»„ä»¶å¯ä»¥æ˜¯æœ‰çŠ¶æ€çš„ã€æ— çŠ¶æ€çš„æˆ–è€…æ— æœåŠ¡å™¨çš„ã€‚æ­¤å¤–ï¼Œè¿™äº›ç»„ä»¶å¯ä»¥ç”¨ä¸åŒçš„è¯­è¨€åˆ›å»ºï¼Œè¿è¡Œåœ¨æ··åˆç¯å¢ƒä¸Šï¼Œå¹¶å¼€å‘å¼€æºæŠ€æœ¯ã€å¼€æ”¾æ ‡å‡†å’Œäº’æ“ä½œæ€§ã€‚æˆ‘ç›¸ä¿¡ä½ å¯ä»¥ä½¿ç”¨é—­æºè½¯ä»¶æ¥æ„å»ºè¿™æ ·çš„ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥åœ¨ AWS å’Œå…¶ä»–åœ°æ–¹æ„å»ºã€‚å…·ä½“åˆ°è¿™æ¬¡æ¼”è®²ï¼Œæˆ‘å°†å…³æ³¨ Kubernetes ç”Ÿæ€ç³»ç»Ÿï¼Œä»¥åŠä½ å¦‚ä½•åœ¨ Kubernetes å¹³å°ä¸Šæ„å»ºè¿™æ ·ä¸€ä¸ªç³»ç»Ÿã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä»åˆ†å¸ƒå¼ç³»ç»Ÿçš„éœ€æ±‚è®²èµ·ã€‚æˆ‘è®¤ä¸ºæ˜¯æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªåº”ç”¨æˆ–è€…æœåŠ¡ï¼Œå¹¶å†™ä¸€äº›ä¸šåŠ¡é€»è¾‘ã€‚é‚£ä»è¿è¡Œæ—¶çš„å¹³å°åˆ°æ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä»€ä¹ˆå‘¢ï¼Ÿåœ¨åº•å±‚ï¼Œæœ€å¼€å§‹æ˜¯æˆ‘ä»¬è¦ä¸€äº›ç”Ÿå‘½å‘¨æœŸçš„èƒ½åŠ›ã€‚å½“ä½ ç”¨ä»»ä¸€è¯­è¨€å¼€å‘ä½ çš„åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰èƒ½åŠ›æŠŠè¿™ä¸ªåº”ç”¨å¯é åœ°æ‰“åŒ…å’Œéƒ¨ç½²ã€å›æ»šã€å¥åº·æ£€æŸ¥ã€‚å¹¶ä¸”èƒ½å¤ŸæŠŠåº”ç”¨éƒ¨ç½²åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œå¹¶å®ç°èµ„æºéš”ç¦»ã€æ‰©å±•ã€é…ç½®ç®¡ç†ï¼Œä»¥åŠæ‰€æœ‰è¿™äº›ã€‚è¿™äº›éƒ½æ˜¯ä½ åˆ›å»ºåˆ†å¸ƒå¼åº”ç”¨æ‰€éœ€è¦çš„ç¬¬ä¸€ç‚¹ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/55image0011616431697020.jpg" alt="">&lt;/p>
&lt;p>ç¬¬äºŒç‚¹æ˜¯å›´ç»•ç½‘ç»œã€‚æˆ‘ä»¬æœ‰äº†åº”ç”¨ä¹‹åï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒèƒ½å¤Ÿå¯é åœ°è¿æ¥åˆ°å…¶ä»–æœåŠ¡ï¼Œæ— è®ºè¯¥æœåŠ¡æ˜¯åœ¨é›†ç¾¤å†…éƒ¨è¿˜æ˜¯åœ¨å¤–éƒ¨ã€‚æˆ‘ä»¬å¸Œæœ›å…¶å…·æœ‰æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ã€‚ä¸ºäº†ä¸åŒçš„å‘å¸ƒç­–ç•¥æˆ–æ˜¯å…¶ä»–çš„ä¸€äº›åŸå› çš„æˆ‘ä»¬å¸Œæœ›æœ‰æµé‡è½¬ç§»çš„èƒ½åŠ›ã€‚ç„¶åæˆ‘ä»¬è¿˜å¸Œæœ›å…¶å…·æœ‰ä¸å…¶ä»–ç³»ç»Ÿè¿›è¡Œå¼¹æ€§é€šä¿¡çš„èƒ½åŠ›ï¼Œæ— è®ºæ˜¯é€šè¿‡é‡è¯•ã€è¶…æ—¶è¿˜æ˜¯æ–­è·¯å™¨ã€‚è¦æœ‰é€‚å½“çš„å®‰å…¨ä¿éšœï¼Œå¹¶ä¸”è¦æœ‰è¶³å¤Ÿçš„ç›‘æ§ã€è¿½è¸ªã€å¯è§‚å¯Ÿæ€§ç­‰ç­‰ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/25image0021616431698392.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬æœ‰äº†ç½‘ç»œä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬å¸Œæœ›æœ‰èƒ½åŠ›ä¸ä¸åŒçš„ API å’Œç«¯ç‚¹äº¤äº’ï¼Œå³èµ„æºç»‘å®š&amp;ndash;ä¸å…¶ä»–åè®®å’Œä¸åŒçš„æ•°æ®æ ¼å¼äº¤äº’ã€‚ç”šè‡³èƒ½å¤Ÿä»ä¸€ç§æ•°æ®æ ¼å¼è½¬æ¢æˆå¦ä¸€ç§æ•°æ®æ ¼å¼ã€‚æˆ‘è¿˜ä¼šåœ¨è¿™é‡ŒåŠ å…¥è¯¸å¦‚æ»¤å…‰çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬è®¢é˜…ä¸€ä¸ªä¸»é¢˜æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè®¸åªå¯¹æŸäº›äº‹ä»¶æ„Ÿå…´è¶£ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/45image0031616431697873.jpg" alt="">&lt;/p>
&lt;p>ä½ è®¤ä¸ºæœ€åä¸€ç±»æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯çŠ¶æ€ã€‚å½“æˆ‘åœ¨è¯´çŠ¶æ€å’Œæœ‰çŠ¶æ€çš„æŠ½è±¡æ—¶ï¼Œæˆ‘å¹¶ä¸æ˜¯åœ¨è°ˆè®ºå®é™…çš„çŠ¶æ€ç®¡ç†ï¼Œæ¯”å¦‚æ•°æ®åº“æˆ–è€…æ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½ã€‚æˆ‘è¦è¯´çš„æ›´å¤šæ˜¯æœ‰å…³å¹•åä¾èµ–çŠ¶æ€çš„å¼€å‘äººå‘˜æŠ½è±¡ã€‚å¯èƒ½ï¼Œä½ éœ€è¦å…·æœ‰å·¥ä½œæµç®¡ç†çš„èƒ½åŠ›ã€‚ä¹Ÿè®¸ä½ æƒ³ç®¡ç†è¿è¡Œæ—¶é—´é•¿çš„è¿›ç¨‹æˆ–è€…åšä¸´æ—¶è°ƒåº¦æˆ–è€…æŸäº›å®šæ—¶ä»»åŠ¡æ¥å®šæœŸè¿è¡ŒæœåŠ¡ã€‚ä¹Ÿè®¸ä½ è¿˜æƒ³è¿›è¡Œåˆ†å¸ƒå¼ç¼“å­˜ï¼Œå…·æœ‰å¹‚ç­‰æ€§æˆ–è€…æ”¯æŒå›æ»šã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯å¼€å‘äººå‘˜çº§çš„åŸè¯­ï¼Œä½†åœ¨å¹•åï¼Œå®ƒä»¬ä¾èµ–äºå…·æœ‰æŸç§çŠ¶æ€ã€‚ä½ æƒ³éšæ„ä½¿ç”¨è¿™äº›æŠ½è±¡ä¿©åˆ›å»ºå®Œå–„çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/26image0041616431697348.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªåˆ†å¸ƒå¼ç³»ç»ŸåŸè¯­çš„æ¡†æ¶æ¥è¯„ä¼°å®ƒä»¬åœ¨ Kubernetes å’Œå…¶ä»–é¡¹ç›®ä¸Šçš„å˜åŒ–æƒ…å†µã€‚&lt;/p>
&lt;h2 id="å•ä½“æ¶æ„----ä¼ ç»Ÿä¸­é—´ä»¶åŠŸèƒ½">å•ä½“æ¶æ„ &amp;ndash; ä¼ ç»Ÿä¸­é—´ä»¶åŠŸèƒ½&lt;/h2>
&lt;p>å‡è®¾æˆ‘ä»¬ä»å•ä½“æ¶æ„ä»¥åŠå¦‚ä½•è·å¾—è¿™äº›èƒ½åŠ›å¼€å§‹ã€‚åœ¨é‚£ç§æƒ…å†µä¸‹ï¼Œé¦–å…ˆæ˜¯å½“æˆ‘è¯´å•ä½“çš„æ—¶å€™ï¼Œåœ¨åˆ†å¸ƒå¼åº”ç”¨çš„æƒ…å†µä¸‹æˆ‘æƒ³åˆ°çš„æ˜¯ ESBã€‚ESB æ˜¯ç›¸å½“å¼ºå¤§çš„ï¼Œå½“æˆ‘ä»¬æ£€æŸ¥æˆ‘ä»¬çš„éœ€æ±‚åˆ—è¡¨æ—¶ï¼Œæˆ‘ä»¬ä¼šè¯´ ESB å¯¹æ‰€æœ‰æœ‰çŠ¶æ€çš„æŠ½è±¡æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚&lt;/p>
&lt;p>ä½¿ç”¨ ESBï¼Œä½ å¯ä»¥è¿›è¡Œé•¿æ—¶é—´è¿è¡Œçš„æµç¨‹çš„ç¼–æ’ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€å›æ»šå’Œå¹‚ç­‰ã€‚æ­¤å¤–ï¼ŒESB è¿˜æä¾›äº†å‡ºè‰²çš„èµ„æºç»‘å®šèƒ½åŠ›ï¼Œå¹¶ä¸”æœ‰æ•°ç™¾ä¸ªè¿æ¥å™¨ï¼Œæ”¯æŒè½¬æ¢ã€ç¼–æ’ï¼Œç”šè‡³æœ‰è”ç½‘åŠŸèƒ½ã€‚æœ€åï¼ŒESB ç”šè‡³å¯ä»¥åšæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚&lt;/p>
&lt;p>å®ƒå…·æœ‰å›´ç»•ç½‘ç»œè¿æ¥çš„å¼¹æ€§çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå› æ­¤å®ƒå¯ä»¥è¿›è¡Œé‡è¯•ã€‚å¯èƒ½ ESB æœ¬è´¨ä¸Šä¸æ˜¯å¾ˆåˆ†å¸ƒå¼ï¼Œæ‰€ä»¥å®ƒä¸éœ€è¦éå¸¸é«˜çº§çš„ç½‘ç»œå’Œå‘å¸ƒèƒ½åŠ›ã€‚ESB æ¬ ç¼ºçš„ä¸»è¦æ˜¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚å› ä¸ºå®ƒæ˜¯å•ä¸€è¿è¡Œæ—¶ï¼Œæ‰€ä»¥ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ä½ åªèƒ½ä½¿ç”¨ä¸€ç§è¯­è¨€ã€‚é€šå¸¸æ˜¯åˆ›å»ºå®é™…è¿è¡Œæ—¶çš„è¯­è¨€ï¼ŒJavaã€.NETã€æˆ–è€…å…¶ä»–çš„è¯­è¨€ã€‚ç„¶åï¼Œå› ä¸ºæ˜¯å•ä¸€è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½è½»æ¾åœ°è¿›è¡Œå£°æ˜å¼çš„éƒ¨ç½²æˆ–è€…è‡ªåŠ¨é˜²æ­¢ã€‚éƒ¨ç½²æ˜¯ç›¸å½“å¤§ä¸”éå¸¸é‡çš„ï¼Œæ‰€ä»¥å®ƒé€šå¸¸æ¶‰åŠåˆ°äººæœºäº¤äº’ã€‚è¿™ç§å•ä½“æ¶æ„çš„å¦ä¸€ä¸ªéš¾ç‚¹æ˜¯æ‰©å±•ï¼šâ€œæˆ‘ä»¬æ— æ³•æ‰©å±•å•ä¸ªç»„ä»¶ã€‚â€&lt;/p>
&lt;p>æœ€åå´å¹¶éæœ€ä¸é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œå›´ç»•éš”ç¦»ï¼Œæ— è®ºæ˜¯èµ„æºéš”ç¦»è¿˜æ˜¯æ•…éšœéš”ç¦»ã€‚ä½¿ç”¨å•ä½“æ¶æ„æ— æ³•å®Œæˆæ‰€æœ‰è¿™äº›å·¥ä½œã€‚ä»æˆ‘ä»¬çš„éœ€æ±‚æ¡†æ¶æ¥çœ‹ï¼ŒESB çš„å•ä½“æ¶æ„ä¸ç¬¦åˆæ¡ä»¶ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/40image0051616431696438.jpg" alt="">&lt;/p>
&lt;h2 id="äº‘åŸç”Ÿæ¶æ„----å¾®æœåŠ¡å’Œ-kubernetes">äº‘åŸç”Ÿæ¶æ„ &amp;ndash; å¾®æœåŠ¡å’Œ Kubernetes&lt;/h2>
&lt;p>æ¥ä¸‹æ¥ï¼Œæˆ‘å»ºè®®æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹äº‘åŸç”Ÿæ¶æ„ä»¥åŠè¿™äº›éœ€æ±‚æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚å¦‚æœæˆ‘ä»¬ä»ä¸€ä¸ªéå¸¸é«˜çš„å±‚é¢æ¥çœ‹ï¼Œè¿™äº›æ¶æ„æ˜¯å¦‚ä½•å‘ç”Ÿå˜åŒ–çš„ï¼Œäº‘åŸç”Ÿå¯èƒ½å§‹äºå¾®æœåŠ¡è¿åŠ¨ã€‚å¾®æœåŠ¡ä½¿æˆ‘ä»¬å¯ä»¥æŒ‰ä¸šåŠ¡é¢†åŸŸè¿›è¡Œæ‹†åˆ†å•ä½“åº”ç”¨ã€‚äº‹å®è¯æ˜ï¼Œå®¹å™¨å’Œ Kubernetes å®é™…ä¸Šæ˜¯ç®¡ç†è¿™äº›å¾®æœåŠ¡çš„ä¼˜ç§€å¹³å°ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Kubernetes å¯¹äºå¾®æœåŠ¡ç‰¹åˆ«æœ‰å¸å¼•åŠ›çš„ä¸€äº›å…·ä½“ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/13image0061616431699209.jpg" alt="">&lt;/p>
&lt;p>ä»ä¸€å¼€å§‹ï¼Œè¿›è¡Œå¥åº·çŠ¶å†µæ¢æµ‹çš„èƒ½åŠ›å°±æ˜¯ Kubernetes å—æ¬¢è¿çš„åŸå› ã€‚åœ¨å®è·µä¸­ï¼Œè¿™æ„å‘³ç€å½“ä½ å°†å®¹å™¨éƒ¨ç½²åˆ° Pod ä¸­æ—¶ï¼ŒKubernetes ä¼šæ£€æŸ¥è¿›ç¨‹çš„è¿è¡ŒçŠ¶å†µã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¯¥è¿‡ç¨‹æ¨¡å‹è¿˜ä¸å¤Ÿå¥½ã€‚ä½ å¯èƒ½ä»ç„¶æœ‰ä¸€ä¸ªå·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œä½†æ˜¯å®ƒå¹¶ä¸å¥åº·ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿˜å¯ä»¥ä½¿ç”¨å°±ç»ªåº¦å’Œå­˜æ´»åº¦æ£€æŸ¥çš„åŸå› ã€‚Kubernetes ä¼šåšä¸€ä¸ªå°±ç»ªåº¦æ£€æŸ¥ï¼Œä»¥ç¡®å®šä½ çš„åº”ç”¨åœ¨å¯åŠ¨æœŸé—´ä½•æ—¶å‡†å¤‡æ¥å—æµé‡ã€‚å®ƒå°†è¿›è¡Œæ´»è·ƒåº¦æ£€æŸ¥ï¼Œä»¥æ£€æŸ¥æœåŠ¡çš„è¿è¡ŒçŠ¶å†µã€‚åœ¨ Kubernetes ä¹‹å‰ï¼Œè¿™å¹¶ä¸æ˜¯å¾ˆæµè¡Œï¼Œä½†ä»Šå¤©å‡ ä¹æ‰€æœ‰è¯­è¨€ã€æ‰€æœ‰æ¡†æ¶ã€æ‰€æœ‰è¿è¡Œæ—¶éƒ½æœ‰å¥åº·æ£€æŸ¥åŠŸèƒ½ï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­å¿«é€Ÿå¯åŠ¨ç«¯ç‚¹ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/29image0071616431696697.jpg" alt="">&lt;/p>
&lt;p>Kubernetes å¼•å…¥çš„ä¸‹ä¸€ä¸ªç‰¹æ€§æ˜¯å›´ç»•åº”ç”¨ç¨‹åºçš„æ‰˜ç®¡ç”Ÿå‘½å‘¨æœŸ&amp;ndash;æˆ‘çš„æ„æ€æ˜¯ï¼Œä½ ä¸å†æ§åˆ¶ä½•æ—¶å¯åŠ¨ã€ä½•æ—¶å…³é—­æœåŠ¡ã€‚ä½ ç›¸ä¿¡å¹³å°å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚Kubernetes å¯ä»¥å¯åŠ¨ä½ çš„åº”ç”¨ï¼›å®ƒå¯ä»¥å°†å…¶å…³é—­ï¼Œç„¶ååœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šç§»åŠ¨å®ƒã€‚ä¸ºæ­¤ï¼Œä½ å¿…é¡»æ­£ç¡®æ‰§è¡Œå¹³å°åœ¨åº”ç”¨å¯åŠ¨å’Œå…³é—­æœŸé—´å‘Šè¯‰ä½ çš„äº‹ä»¶ã€‚&lt;/p>
&lt;p>Kubernetes åˆ˜å…´çš„å¦ä¸€ä»¶ç‰¹æ€§æ˜¯å›´ç»•ç€å£°æ˜å¼éƒ¨ç½²ã€‚è¿™æ„å‘³ç€ä½ ä¸å†éœ€è¦å¯åŠ¨æœåŠ¡ï¼›æ£€æŸ¥æ—¥å¿—æ˜¯å¦å·²ç»å¯åŠ¨ã€‚ä½ ä¸å¿…æ‰‹åŠ¨å‡çº§å®ä¾‹&amp;ndash;æ”¯æŒå£°æ˜å¼éƒ¨ç½²çš„ Kubernetes å¯ä»¥ä¸ºä½ åšåˆ°è¿™ä¸€ç‚¹ã€‚æ ¹æ®ä½ é€‰æ‹©çš„ç­–ç•¥ï¼Œå®ƒå¯ä»¥åœæ­¢æ—§å®ä¾‹å¹¶å¯åŠ¨æ–°å®ä¾‹ã€‚æ­¤å¤–ï¼Œå¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥è¿›è¡Œå›æ»šã€‚&lt;/p>
&lt;p>å¦å¤–å°±æ˜¯å£°æ˜ä½ çš„èµ„æºéœ€æ±‚ã€‚åˆ›å»ºæœåŠ¡æ—¶ï¼Œå°†å…¶å®¹å™¨åŒ–ã€‚æœ€å¥½å‘Šè¯‰å¹³å°è¯¥æœåŠ¡å°†éœ€è¦å¤šå°‘ CPU å’Œå†…å­˜ã€‚Kubernetes åˆ©ç”¨è¿™äº›ä¿¡æ¯ä¸ºä½ çš„å·¥ä½œè´Ÿè½½æ‰¾åˆ°æœ€ä½³èŠ‚ç‚¹ã€‚åœ¨ä½¿ç”¨ Kubernetes ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»æ ¹æ®æˆ‘ä»¬çš„æ ‡å‡†å°†å®ä¾‹æ‰‹åŠ¨æ”¾ç½®åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„åå¥½æ¥æŒ‡å¯¼ Kubernetesï¼Œå®ƒå°†ä¸ºæˆ‘ä»¬åšå‡ºæœ€ä½³çš„å†³ç­–ã€‚&lt;/p>
&lt;p>å¦‚ä»Šï¼Œåœ¨ Kubernetes ä¸Šï¼Œä½ å¯ä»¥è¿›è¡Œå¤šè¯­è¨€é…ç½®ç®¡ç†ã€‚æ— éœ€åœ¨åº”ç”¨ç¨‹åºè¿è¡Œæ—¶è¿›è¡Œé…ç½®æŸ¥æ‰¾å°±å¯ä»¥è¿›è¡Œä»»ä½•æ“ä½œã€‚Kubernetes ä¼šç¡®ä¿é…ç½®æœ€ç»ˆåœ¨å·¥ä½œè´Ÿè½½æ‰€åœ¨çš„åŒä¸€èŠ‚ç‚¹ä¸Šã€‚è¿™äº›é…ç½®è¢«æ˜ å°„ä¸ºå·æˆ–ç¯å¢ƒå˜é‡ï¼Œä»¥ä¾›ä½ çš„åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚&lt;/p>
&lt;p>äº‹å®è¯æ˜ï¼Œæˆ‘åˆšæ‰è°ˆåˆ°çš„é‚£äº›ç‰¹å®šåŠŸèƒ½ä¹Ÿæ˜¯ç›¸å…³çš„ã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æœè¦è¿›è¡Œè‡ªåŠ¨æ”¾ç½®ï¼Œåˆ™å¿…é¡»å‘Šè¯‰ Kubernetes æœåŠ¡çš„èµ„æºéœ€æ±‚ã€‚ç„¶åï¼Œä½ å¿…é¡»å‘Šè¯‰å®ƒè¦ä½¿ç”¨çš„éƒ¨ç½²ç­–ç•¥ã€‚ä¸ºäº†è®©ç­–ç•¥æ­£ç¡®è¿è¡Œï¼Œä½ çš„åº”ç”¨ç¨‹åºå¿…é¡»æ‰§è¡Œæ¥è‡ªç¯å¢ƒçš„äº‹ä»¶ã€‚å®ƒå¿…é¡»æ‰§è¡Œå¥åº·æ£€æŸ¥ã€‚ä¸€æ—¦é‡‡ç”¨äº†æ‰€æœ‰è¿™äº›æœ€ä½³å®è·µå¹¶ä½¿ç”¨æ‰€æœ‰è¿™äº›åŠŸèƒ½ï¼Œä½ çš„åº”ç”¨å°±ä¼šæˆä¸ºå‡ºè‰²çš„äº‘åŸç”Ÿå…¬æ°‘ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ Kubernetes ä¸Šå®ç°è‡ªåŠ¨åŒ–äº†ï¼ˆè¿™æ˜¯åœ¨ Kubernetes ä¸Šè¿è¡Œå·¥ä½œè´Ÿè½½çš„åŸºæœ¬æ¨¡å¼ï¼‰ã€‚æœ€åï¼Œè¿˜æœ‰å›´ç»•ç€æ„å»º Pod ä¸­çš„å®¹å™¨ã€é…ç½®ç®¡ç†å’Œè¡Œä¸ºï¼Œè¿˜æœ‰å…¶ä»–æ¨¡å¼ã€‚&lt;/p>
&lt;p>æˆ‘è¦ç®€è¦ä»‹ç»çš„ä¸‹ä¸€ä¸ªä¸»é¢˜æ˜¯å·¥ä½œè´Ÿè½½ã€‚ä»ç”Ÿå‘½å‘¨æœŸçš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè¿è¡Œä¸åŒçš„å·¥ä½œè´Ÿè½½ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ Kubernetes ä¸Šåšåˆ°è¿™ä¸€ç‚¹ã€‚è¿è¡ŒåäºŒè¦ç´ åº”ç”¨ç¨‹åºå’Œæ— çŠ¶æ€å¾®æœåŠ¡éå¸¸ç®€å•ã€‚Kubernetes å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚è¿™ä¸æ˜¯ä½ å°†è¦æ‰¿æ‹…çš„å”¯ä¸€å·¥ä½œé‡ã€‚å¯èƒ½ä½ è¿˜æœ‰æœ‰çŠ¶æ€çš„å·¥ä½œè´Ÿè½½ï¼Œä½ å¯ä»¥ä½¿ç”¨æœ‰çŠ¶æ€é›†åœ¨ Kubernetes ä¸Šå®Œæˆæ­¤å·¥ä½œã€‚&lt;/p>
&lt;p>ä½ å¯èƒ½è¿˜æœ‰çš„å¦ä¸€ä¸ªå·¥ä½œè´Ÿè½½æ˜¯å•ä¾‹ã€‚ä¹Ÿè®¸ä½ å¸Œæœ›æŸä¸ªåº”ç”¨ç¨‹åºçš„å®ä¾‹æ˜¯æ•´ä¸ªé›†ç¾¤ä¸­åº”ç”¨ç¨‹åºçš„å”¯ä¸€ä¸€ä¸ªå®ä¾‹&amp;ndash;ä½ å¸Œæœ›å®ƒæˆä¸ºå¯é çš„å•ä¾‹ã€‚å¦‚æœå¤±è´¥ï¼Œåˆ™é‡æ–°å¯åŠ¨ã€‚å› æ­¤ï¼Œä½ å¯ä»¥æ ¹æ®éœ€æ±‚ä»¥åŠæ˜¯å¦å¸Œæœ›å•ä¾‹è‡³å°‘å…·æœ‰ä¸€ç§æˆ–æœ€å¤šä¸€ç§è¯­ä¹‰æ¥åœ¨æœ‰çŠ¶æ€é›†å’Œå‰¯æœ¬é›†ä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚ä½ å¯èƒ½è¿˜æœ‰çš„å¦ä¸€ä¸ªå·¥ä½œè´Ÿè½½æ˜¯å›´ç»•ä½œä¸šå’Œå®šæ—¶ä½œä¸š&amp;ndash;æœ‰äº† Kubernetesï¼Œä½ ä¹Ÿå¯ä»¥å®ç°è¿™äº›ã€‚&lt;/p>
&lt;p>å¦‚æœæˆ‘ä»¬å°†æ‰€æœ‰è¿™äº› Kubernetes åŠŸèƒ½æ˜ å°„åˆ°æˆ‘ä»¬çš„éœ€æ±‚ï¼Œåˆ™ Kubernetes å¯ä»¥æ»¡è¶³ç”Ÿå‘½å‘¨æœŸéœ€æ±‚ã€‚æˆ‘é€šå¸¸åˆ›å»ºçš„éœ€æ±‚åˆ—è¡¨ä¸»è¦æ˜¯ç”± Kubernetes ä»Šå¤©æä¾›ç»™æˆ‘ä»¬çš„ã€‚è¿™äº›æ˜¯ä»»ä½•å¹³å°ä¸Šçš„é¢„æœŸåŠŸèƒ½ï¼Œè€Œ Kubernetes å¯ä»¥ä¸ºä½ çš„éƒ¨ç½²åšçš„æ˜¯é…ç½®ç®¡ç†ã€èµ„æºéš”ç¦»å’Œæ•…éšœéš”ç¦»ã€‚æ­¤å¤–ï¼Œé™¤äº†æ— æœåŠ¡å™¨æœ¬èº«ä¹‹å¤–ï¼Œå®ƒè¿˜æ”¯æŒå…¶ä»–å·¥ä½œè´Ÿè½½ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/12image0081616431698134.jpg" alt="">&lt;/p>
&lt;p>ç„¶åï¼Œå¦‚æœè¿™å°±æ˜¯ Kubernetes ç»™å¼€å‘è€…æä¾›çš„å…¨éƒ¨åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•æ‰©å±• Kubernetes å‘¢ï¼Ÿä»¥åŠå¦‚ä½•ä½¿å®ƒå…·æœ‰æ›´å¤šåŠŸèƒ½ï¼Ÿå› æ­¤ï¼Œæˆ‘æƒ³æè¿°å½“ä»Šä½¿ç”¨çš„ä¸¤ç§å¸¸ç”¨æ–¹æ³•ã€‚&lt;/p>
&lt;h2 id="è¿›ç¨‹å¤–æ‰©å±•æœºåˆ¶">è¿›ç¨‹å¤–æ‰©å±•æœºåˆ¶&lt;/h2>
&lt;p>é¦–å…ˆæ˜¯ Pod çš„æ¦‚å¿µï¼ŒPod æ˜¯ç”¨äºåœ¨èŠ‚ç‚¹ä¸Šéƒ¨ç½²å®¹å™¨çš„æŠ½è±¡ã€‚æ­¤å¤–ï¼ŒPod ç»™æˆ‘ä»¬æä¾›äº†ä¸¤ç»„ä¿è¯ï¼š&lt;/p>
&lt;ul>
&lt;li>ç¬¬ä¸€ç»„æ˜¯éƒ¨ç½²ä¿è¯ &amp;ndash; Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å§‹ç»ˆä½äºåŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚è¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥é€šè¿‡ localhost ç›¸äº’é€šä¿¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæˆ–é€šè¿‡å…¶ä»– IPC æœºåˆ¶è¿›è¡Œå¼‚æ­¥é€šä¿¡ã€‚&lt;/li>
&lt;li>Pod ç»™æˆ‘ä»¬çš„å¦ä¸€ç»„ä¿è¯æ˜¯å›´ç»•ç”Ÿå‘½å‘¨æœŸçš„ã€‚Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å¹¶ééƒ½ç›¸ç­‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/22image0091616431698660.jpg" alt="">&lt;/p>
&lt;p>æ ¹æ®ä½¿ç”¨çš„æ˜¯ init å®¹å™¨è¿˜æ˜¯åº”ç”¨ç¨‹åºå®¹å™¨ï¼Œä½ ä¼šè·å¾—ä¸åŒçš„ä¿è¯ã€‚ä¾‹å¦‚ï¼Œinit å®¹å™¨åœ¨å¼€å§‹æ—¶è¿è¡Œï¼›å½“ Pod å¯åŠ¨æ—¶ï¼Œå®ƒæŒ‰é¡ºåºä¸€ä¸ªæ¥ä¸€ä¸ªåœ°è¿è¡Œã€‚ä»–ä»¬ä»…åœ¨ä¹‹å‰çš„å®¹å™¨å·²æˆåŠŸå®Œæˆæ—¶è¿è¡Œã€‚å®ƒä»¬æœ‰åŠ©äºå®ç°ç”±å®¹å™¨é©±åŠ¨çš„ç±»ä¼¼å·¥ä½œæµçš„é€»è¾‘ã€‚&lt;/p>
&lt;p>å¦ä¸€æ–¹é¢ï¼Œåº”ç”¨ç¨‹åºå®¹å™¨æ˜¯å¹¶è¡Œè¿è¡Œçš„ã€‚å®ƒä»¬åœ¨æ•´ä¸ª Pod çš„ç”Ÿå‘½å‘¨æœŸä¸­è¿è¡Œï¼Œè¿™ä¹Ÿæ˜¯ sidecar æ¨¡å¼çš„åŸºç¡€ã€‚sidecar å¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œè¿™äº›å®¹å™¨å¯ä»¥åä½œå¹¶å…±åŒä¸ºç”¨æˆ·æä¾›ä»·å€¼ã€‚è¿™ä¹Ÿæ˜¯å½“ä»Šæˆ‘ä»¬çœ‹åˆ°çš„æ‰©å±• Kubernetes é™„åŠ åŠŸèƒ½çš„ä¸»è¦æœºåˆ¶ä¹‹ä¸€ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/9image0101616431695489.jpg" alt="">&lt;/p>
&lt;p>ä¸ºäº†è§£é‡Šä»¥ä¸‹åŠŸèƒ½ï¼Œæˆ‘å¿…é¡»ç®€è¦åœ°å‘Šè¯‰ä½  Kubernetes å†…éƒ¨çš„å·¥ä½œæ–¹å¼ã€‚å®ƒæ˜¯åŸºäºè°ƒè°å¾ªç¯çš„ã€‚è°ƒè°å¾ªç¯çš„æ€æƒ³æ˜¯å°†æœŸæœ›çŠ¶æ€é©±åŠ¨åˆ°å®é™…çŠ¶æ€ã€‚åœ¨ Kubernetes ä¸­ï¼Œå¾ˆå¤šåŠŸèƒ½éƒ½æ˜¯é è¿™ä¸ªæ¥å®ç°çš„ã€‚ä¾‹å¦‚ï¼Œå½“ä½ è¯´æˆ‘è¦ä¸¤ä¸ª Pod å®ä¾‹ï¼Œè¿™ç³»ç»Ÿçš„æœŸæœ›çŠ¶æ€ã€‚æœ‰ä¸€ä¸ªæ§åˆ¶å¾ªç¯ä¸æ–­åœ°è¿è¡Œï¼Œå¹¶æ£€æŸ¥ä½ çš„ Pod æ˜¯å¦æœ‰ä¸¤ä¸ªå®ä¾‹ã€‚å¦‚æœä¸å­˜åœ¨ä¸¤ä¸ªå®ä¾‹ï¼Œå®ƒå°†è®¡ç®—å·®å€¼ã€‚å®ƒå°†ç¡®ä¿å­˜åœ¨ä¸¤ä¸ªå®ä¾‹ã€‚&lt;/p>
&lt;p>è¿™æ–¹é¢çš„ä¾‹å­æœ‰å¾ˆå¤šã€‚ä¸€äº›æ˜¯å‰¯æœ¬é›†æˆ–æœ‰çŠ¶æ€é›†ã€‚èµ„æºå®šä¹‰æ˜ å°„åˆ°æ§åˆ¶å™¨æ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸”æ¯ä¸ªèµ„æºå®šä¹‰éƒ½æœ‰ä¸€ä¸ªæ§åˆ¶å™¨ã€‚è¯¥æ§åˆ¶å™¨ç¡®ä¿ç°å®ä¸–ç•Œä¸æ‰€éœ€æ§åˆ¶å™¨ç›¸åŒ¹é…ï¼Œä½ ç”šè‡³å¯ä»¥ç¼–å†™è‡ªå·±çš„è‡ªå®šä¹‰æ§åˆ¶å™¨ã€‚&lt;/p>
&lt;p>å½“åœ¨ Pod ä¸­è¿è¡Œåº”ç”¨ç¨‹åºæ—¶ï¼Œä½ å°†æ— æ³•åœ¨è¿è¡Œæ—¶åŠ è½½ä»»ä½•é…ç½®æ–‡ä»¶æ›´æ”¹ã€‚ç„¶è€Œï¼Œä½ å¯ä»¥ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰æ§åˆ¶å™¨ï¼Œæ£€æµ‹ config map çš„å˜åŒ–ï¼Œé‡æ–°å¯åŠ¨ Pod å’Œåº”ç”¨ç¨‹åº&amp;ndash;ä»è€Œè·å–é…ç½®æ›´æ”¹ã€‚&lt;/p>
&lt;p>äº‹å®è¯æ˜ï¼Œå³ä½¿ Kubernetes æ‹¥æœ‰ä¸°å¯Œçš„èµ„æºé›†åˆï¼Œä½†å®ƒä»¬å¹¶ä¸èƒ½æ»¡è¶³ä½ çš„æ‰€æœ‰ä¸åŒéœ€æ±‚ã€‚Kubernetes å¼•å…¥äº†è‡ªå®šä¹‰èµ„æºå®šä¹‰çš„æ¦‚å¿µã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å¯¹éœ€æ±‚è¿›è¡Œå»ºæ¨¡å¹¶å®šä¹‰é€‚ç”¨äº Kubernetes çš„ APIã€‚å®ƒä¸å…¶ä»– Kubernetes åŸç”Ÿèµ„æºå…±å­˜ã€‚ä½ å¯ä»¥ç”¨èƒ½ç†è§£æ¨¡å‹çš„ä»»ä½•è¯­è¨€ç¼–å†™è‡ªå·±çš„æ§åˆ¶å™¨ã€‚ä½ å¯ä»¥è®¾è®¡ä¸€ä¸ªç”¨ Java å®ç°çš„ ConfigWatcherï¼Œæè¿°æˆ‘ä»¬å‰é¢æ‰€è§£é‡Šçš„å†…å®¹ã€‚è¿™å°±æ˜¯ operator æ¨¡å¼ï¼Œå³ä¸è‡ªå®šä¹‰èµ„æºå®šä¹‰ä¸€èµ·ä½¿ç”¨çš„æ§åˆ¶å™¨ã€‚å¦‚ä»Šï¼Œæˆ‘ä»¬çœ‹åˆ°å¾ˆå¤š operator å‡å¦‚ï¼Œè¿™å°±æ˜¯ç¬¬äºŒç§æ‰©å±• Kubernetes é™„åŠ åŠŸèƒ½çš„æ–¹å¼ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥ï¼Œæˆ‘æƒ³ç®€å•ä»‹ç»ä¸€ä¸‹åŸºäº Kubernetes æ„å»ºçš„ä¸€äº›å¹³å°ï¼Œè¿™äº›å¹³å°å¤§é‡ä½¿ç”¨ sidecar å’Œ operator æ¥ç»™å¼€å‘è€…æä¾›é¢å¤–çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼">ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Ÿ&lt;/h2>
&lt;p>è®©æˆ‘ä»¬ä»æœåŠ¡ç½‘æ ¼å¼€å§‹ï¼Œä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Ÿ&lt;/p>
&lt;p>æˆ‘ä»¬æœ‰ä¸¤ä¸ªæœåŠ¡ï¼ŒæœåŠ¡ A è¦è°ƒç”¨æœåŠ¡ Bï¼Œå¹¶ä¸”å¯ä»¥ç”¨ä»»ä½•è¯­è¨€ã€‚æŠŠè¿™ä¸ªå½“åšæ˜¯æˆ‘ä»¬çš„åº”ç”¨å·¥ä½œè´Ÿè½½ã€‚æœåŠ¡ç½‘æ ¼ä½¿ç”¨ sidecar æ§åˆ¶å™¨ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„æœåŠ¡æ—è¾¹æ³¨å…¥ä¸€ä¸ªä»£ç†ã€‚ä½ æœ€ç»ˆä¼šåœ¨ Pod ä¸­å¾—åˆ°ä¸¤ä¸ªå®¹å™¨ã€‚ä»£ç†æ˜¯ä¸€ä¸ªé€æ˜çš„ä»£ç†ï¼Œä½ çš„åº”ç”¨å¯¹è¿™ä¸ªä»£ç†å®Œå…¨æ— æ„ŸçŸ¥&amp;ndash;å®ƒæ‹¦æˆªæ‰€æœ‰ä¼ å…¥å’Œä¼ å‡ºçš„æµé‡ã€‚æ­¤å¤–ï¼Œä»£ç†è¿˜å……å½“æ•°æ®é˜²ç«å¢™ã€‚&lt;/p>
&lt;p>è¿™äº›æœåŠ¡ä»£ç†çš„é›†åˆä»£è¡¨äº†ä½ çš„æ•°æ®å¹³é¢ï¼Œå¹¶ä¸”å¾ˆå°ä¸”æ— çŠ¶æ€ã€‚ä¸ºäº†è·å¾—æ‰€æœ‰çŠ¶æ€å’Œé…ç½®ï¼Œå®ƒä»¬ä¾èµ–äºæ§åˆ¶å¹³é¢ã€‚æ§åˆ¶å¹³é¢æ˜¯ä¿æŒæ‰€æœ‰é…ç½®ï¼Œæ”¶é›†æŒ‡æ ‡ï¼Œåšå‡ºå†³å®šå¹¶ä¸æ•°æ®å¹³é¢è¿›è¡Œäº¤äº’çš„æœ‰çŠ¶æ€éƒ¨åˆ†ã€‚æ­¤å¤–ï¼Œå®ƒä»¬æ˜¯ä¸åŒæ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢çš„æ­£ç¡®é€‰æ‹©ã€‚äº‹å®è¯æ˜ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç»„ä»¶-ä¸€ä¸ª API ç½‘å…³ï¼Œä»¥å°†æ•°æ®è·å–åˆ°æˆ‘ä»¬çš„é›†ç¾¤ä¸­ã€‚ä¸€äº›æœåŠ¡ç½‘æ ¼å…·æœ‰è‡ªå·±çš„ API ç½‘å…³ï¼Œè€ŒæŸäº›ä½¿ç”¨ç¬¬ä¸‰æ–¹ã€‚å¦‚æœä½ ç ”ç©¶ä¸‹æ‰€æœ‰è¿™äº›ç»„ä»¶ï¼Œå®ƒä»¬å°†æä¾›æˆ‘ä»¬æ‰€éœ€çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>API ç½‘å…³ä¸»è¦ä¸“æ³¨äºæŠ½è±¡æˆ‘ä»¬æœåŠ¡çš„å®ç°ã€‚å®ƒéšè—ç»†èŠ‚å¹¶æä¾›è¾¹ç•ŒåŠŸèƒ½ã€‚æœåŠ¡ç½‘æ ¼åˆ™ç›¸åã€‚åœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œå®ƒå¢å¼ºäº†æœåŠ¡å†…çš„å¯è§æ€§å’Œå¯é æ€§ã€‚å¯ä»¥è¯´ï¼ŒAPI ç½‘å…³å’ŒæœåŠ¡ç½‘æ ¼å…±åŒæä¾›äº†æ‰€æœ‰ç½‘ç»œéœ€æ±‚ã€‚è¦åœ¨ Kubernetes ä¸Šè·å¾—ç½‘ç»œåŠŸèƒ½ï¼Œä»…ä½¿ç”¨æœåŠ¡æ˜¯ä¸å¤Ÿçš„ï¼šâ€œä½ éœ€è¦ä¸€äº›æœåŠ¡ç½‘æ ¼ã€‚â€&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/19image0111616431696146.jpg" alt="">&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯-knative">ä»€ä¹ˆæ˜¯ Knativeï¼Ÿ&lt;/h2>
&lt;p>æˆ‘è¦è®¨è®ºçš„ä¸‹ä¸€ä¸ªä¸»é¢˜æ˜¯ Knativeï¼Œè¿™æ˜¯ Google å‡ å¹´å‰å¯åŠ¨çš„ä¸€ä¸ªé¡¹ç›®ã€‚å®ƒæ˜¯ Kubernetes ä¹‹ä¸Šçš„ä¸€å±‚ï¼Œå¯ä¸ºæ‚¨æä¾›æ— æœåŠ¡å™¨åŠŸèƒ½ï¼Œå¹¶å…·æœ‰ä¸¤ä¸ªä¸»è¦æ¨¡å—ï¼š&lt;/p>
&lt;ul>
&lt;li>Knative æœåŠ¡ - å›´ç»•ç€è¯·æ±‚-åº”ç­”äº¤äº’ï¼Œä»¥åŠ&lt;/li>
&lt;li>Knative Eventing - æ›´å¤šçš„æ˜¯ç”¨äºäº‹ä»¶é©±åŠ¨çš„äº¤äº’ã€‚&lt;/li>
&lt;/ul>
&lt;p>åªæ˜¯è®©ä½ æ„Ÿå—ä¸€ä¸‹ï¼ŒKnative Serving æ˜¯ä»€ä¹ˆï¼Ÿé€šè¿‡ Knative Servingï¼Œä½ å¯ä»¥å®šä¹‰æœåŠ¡ï¼Œä½†è¿™ä¸åŒäº Kubernetes æœåŠ¡ã€‚è¿™æ˜¯ Knative æœåŠ¡ã€‚ä½¿ç”¨ Knative æœåŠ¡å®šä¹‰å·¥ä½œè´Ÿè½½åï¼Œä½ å°±ä¼šå¾—åˆ°å…·æœ‰æ— æœåŠ¡å™¨çš„ç‰¹å¾çš„éƒ¨ç½²ã€‚ä½ ä¸éœ€è¦æœ‰å¯åŠ¨å¹¶è¿è¡Œå®ä¾‹ã€‚å®ƒå¯ä»¥åœ¨è¯·æ±‚åˆ°è¾¾æ—¶ä»é›¶å¼€å§‹ã€‚ä½ å¾—åˆ°çš„æ˜¯æ— æœåŠ¡å™¨çš„èƒ½åŠ›ï¼›å®ƒå¯ä»¥è¿…é€Ÿæ‰©å®¹ï¼Œä¹Ÿå¯ä»¥ç¼©å®¹åˆ°é›¶ã€‚&lt;/p>
&lt;p>Knative Eventing ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå®Œå…¨å£°æ˜å¼çš„äº‹ä»¶ç®¡ç†ç³»ç»Ÿã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€äº›è¦ä¸ä¹‹é›†æˆçš„å¤–éƒ¨ç³»ç»Ÿï¼Œä»¥åŠä¸€äº›å¤–éƒ¨çš„äº‹ä»¶ç”Ÿäº§è€…ã€‚åœ¨åº•éƒ¨ï¼Œæˆ‘ä»¬å°†åº”ç”¨ç¨‹åºæ”¾åœ¨å…·æœ‰ HTTP ç«¯ç‚¹çš„å®¹å™¨ä¸­ã€‚å€ŸåŠ© Knative Eventingï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ä»£ç†ï¼Œè¯¥ä»£ç†å¯ä»¥è§¦å‘ Kafka æ˜ å°„çš„ä»£ç†ï¼Œä¹Ÿå¯ä»¥åœ¨å†…å­˜æˆ–è€…æŸäº›äº‘æœåŠ¡ä¸­ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨è¿æ¥åˆ°å¤–éƒ¨ç³»ç»Ÿçš„å¯¼å…¥å™¨ï¼Œå¹¶å°†äº‹ä»¶å¯¼å…¥åˆ°æˆ‘ä»¬çš„ä»£ç†ä¸­ã€‚è¿™äº›å¯¼å…¥å™¨å¯ä»¥åŸºäºï¼Œä¾‹å¦‚ï¼Œå…·æœ‰æ•°ç™¾ä¸ªè¿æ¥å™¨çš„ Apache Camelã€‚&lt;/p>
&lt;p>ä¸€æ—¦æˆ‘ä»¬å°†äº‹ä»¶å‘é€ç»™ä»£ç†ï¼Œç„¶åç”¨ YAML æ–‡ä»¶å£°æ˜ï¼Œæˆ‘ä»¬å¯ä»¥è®©å®¹å™¨è®¢é˜…è¿™äº›äº‹ä»¶ã€‚åœ¨æˆ‘ä»¬çš„å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä»»ä½•æ¶ˆæ¯å®¢æˆ·ç«¯&amp;ndash;æ¯”å¦‚ Kafka å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬çš„å®¹å™¨å°†ä½¿ç”¨äº‘äº‹ä»¶é€šè¿‡ HTTP POST è·å–äº‹ä»¶ã€‚è¿™æ˜¯ä¸€ä¸ªå®Œå…¨å¹³å°ç®¡ç†çš„æ¶ˆæ¯ä¼ é€’åŸºç¡€è®¾æ–½ã€‚ä½œä¸ºå¼€å‘äººå‘˜ï¼Œä½ å¿…é¡»åœ¨å®¹å™¨ä¸­ç¼–å†™ä¸šåŠ¡ä»£ç ï¼Œå¹¶ä¸”ä¸å¤„ç†ä»»ä½•æ¶ˆæ¯ä¼ é€’é€»è¾‘ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/8image0121616431698919.jpg" alt="">&lt;/p>
&lt;p>ä»æˆ‘ä»¬çš„éœ€æ±‚çš„è§’åº¦æ¥çœ‹ï¼ŒKnative å¯ä»¥æ»¡è¶³å…¶ä¸­çš„ä¸€äº›è¦æ±‚ã€‚ä»ç”Ÿå‘½å‘¨æœŸçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒä¸ºæˆ‘ä»¬çš„å·¥ä½œè´Ÿè½½æä¾›äº†æ— æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œå› æ­¤èƒ½å¤Ÿå°†å…¶æ‰©å±•åˆ°é›¶ï¼Œå¹¶ä»é›¶å¼€å§‹æ¿€æ´»ã€‚ä»ç½‘ç»œçš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœæœåŠ¡ç½‘æ ¼ä¹‹é—´å­˜åœ¨æŸäº›é‡å ï¼Œåˆ™ Knative ä¹Ÿå¯ä»¥è¿›è¡Œæµé‡è½¬ç§»ã€‚ä»ç»‘å®šçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒå¯¹ä½¿ç”¨ Knative å¯¼å…¥ç¨‹åºè¿›è¡Œç»‘å®šæä¾›äº†å¾ˆå¥½çš„æ”¯æŒã€‚å®ƒå¯ä»¥ä½¿æˆ‘ä»¬è¿›è¡Œå‘å¸ƒ/è®¢é˜…ï¼Œæˆ–ç‚¹å¯¹ç‚¹äº¤äº’ï¼Œç”šè‡³å¯ä»¥è¿›è¡Œä¸€äº›æ’åºã€‚å®ƒå¯ä»¥æ»¡è¶³å‡ ç±»éœ€æ±‚ã€‚&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯-dapr">ä»€ä¹ˆæ˜¯ Daprï¼Ÿ&lt;/h2>
&lt;p>å¦ä¸€ä¸ªä½¿ç”¨ sidecar å’Œ operator çš„é¡¹ç›®æ˜¯ &lt;a href="https://dapr.io/">Dapr&lt;/a>ï¼Œå®ƒæ˜¯å¾®è½¯å‡ ä¸ªæœˆå‰æ‰å¼€å§‹å¹¶ä¸”æ­£åœ¨è¿…é€Ÿæµè¡Œèµ·æ¥ã€‚æ­¤å¤–ï¼Œ1.0 ç‰ˆæœ¬ &lt;a href="https://www.infoq.com/news/2021/02/dapr-production-ready/">è¢«è®¤ä¸ºæ˜¯ç”Ÿäº§å¯ç”¨çš„&lt;/a>ã€‚å®ƒæ˜¯ä¸€ä¸ªä½œä¸º sidecar çš„åˆ†å¸ƒå¼ç³»ç»Ÿå·¥å…·åŒ…&amp;ndash;Dapr ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯ä½œä¸º sidecar æä¾›çš„ï¼Œå¹¶ä¸”æœ‰ä¸€å¥—ä»–ä»¬æ‰€è°“çš„æ„ä»¶æˆ–åŠŸèƒ½é›†çš„é›†åˆã€‚&lt;/p>
&lt;p>è¿™äº›åŠŸèƒ½æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç¬¬ä¸€ç»„åŠŸèƒ½æ˜¯å›´ç»•ç½‘ç»œã€‚Dapr å¯ä»¥è¿›è¡ŒæœåŠ¡å‘ç°å’ŒæœåŠ¡ä¹‹é—´çš„ç‚¹å¯¹ç‚¹é›†æˆã€‚åŒæ ·ï¼Œå®ƒä¹Ÿå¯ä»¥è¿›è¡ŒæœåŠ¡ç½‘æ ¼çš„è¿½è¸ªã€å¯é é€šä¿¡ã€é‡è¯•å’Œæ¢å¤ã€‚ç¬¬äºŒå¥—åŠŸèƒ½æ˜¯å›´ç»•èµ„æºç»‘å®šï¼š&lt;/p>
&lt;ul>
&lt;li>å®ƒæœ‰å¾ˆå¤šäº‘ APIã€ä¸åŒç³»ç»Ÿçš„è¿æ¥å™¨ï¼Œä»¥åŠ&lt;/li>
&lt;li>ä¹Ÿå¯ä»¥åšæ¶ˆæ¯å‘å¸ƒ/è®¢é˜…å’Œå…¶ä»–é€»è¾‘ã€‚&lt;/li>
&lt;/ul>
&lt;p>æœ‰è¶£çš„æ˜¯ï¼ŒDapr è¿˜å¼•å…¥äº†çŠ¶æ€ç®¡ç†çš„æ¦‚å¿µã€‚é™¤äº† Knative å’ŒæœåŠ¡ç½‘æ ¼æä¾›çš„åŠŸèƒ½å¤–ï¼ŒDapr åœ¨çŠ¶æ€å­˜å‚¨ä¹‹ä¸Šè¿›è¡Œäº†æŠ½è±¡ã€‚æ­¤å¤–ï¼Œä½ é€šè¿‡å­˜å‚¨æœºåˆ¶æ”¯æŒä¸ Dapr è¿›è¡ŒåŸºäºé”®å€¼çš„äº¤äº’ã€‚&lt;/p>
&lt;p>åœ¨è¾ƒé«˜çš„å±‚æ¬¡ä¸Šï¼Œæ¶æ„æ˜¯ä½ çš„åº”ç”¨ç¨‹åºä½äºé¡¶éƒ¨ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•è¯­è¨€ã€‚ä½ å¯ä»¥ä½¿ç”¨ Dapr æä¾›çš„å®¢æˆ·ç«¯åº“ï¼Œä½†ä½ ä¸å¿…è¿™æ ·åšã€‚ä½ å¯ä»¥ä½¿ç”¨è¯­è¨€åŠŸèƒ½æ¥æ‰§è¡Œç§°ä¸º sidecar çš„ HTTP å’Œ gRPCã€‚ä¸ æœåŠ¡ç½‘æ ¼çš„åŒºåˆ«åœ¨äºï¼Œè¿™é‡Œçš„ Dapr sidecar ä¸æ˜¯ä¸€ä¸ªé€æ˜çš„ä»£ç†ã€‚å®ƒæ˜¯ä¸€ä¸ªæ˜¾å¼ä»£ç†ï¼Œä½ å¿…é¡»ä»ä½ çš„åº”ç”¨ä¸­è°ƒç”¨å®ƒï¼Œå¹¶é€šè¿‡ HTTP æˆ– gRPC ä¸ä¹‹äº¤äº’ã€‚æ ¹æ®ä½ éœ€è¦çš„åŠŸèƒ½ï¼ŒDapr å¯ä»¥ä¸å…¶ä»–å¦‚äº‘æœåŠ¡çš„ç³»ç»Ÿå¯¹è¯ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/18image0131616431699532.jpg" alt="">&lt;/p>
&lt;p>åœ¨ Kubernetes ä¸Šï¼ŒDapr æ˜¯ä½œä¸º sidecar éƒ¨ç½²çš„ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ Kubernetes ä¹‹å¤–å·¥ä½œï¼ˆä¸ä»…ä»…æ˜¯ Kubernetesï¼‰ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª operator &amp;ndash; è€Œ sidecar å’Œ Operator æ˜¯ä¸»è¦çš„æ‰©å±•æœºåˆ¶ã€‚å…¶ä»–ä¸€äº›ç»„ä»¶ç®¡ç†è¯ä¹¦ã€å¤„ç†åŸºäº actor çš„å»ºæ¨¡å¹¶æ³¨å…¥ sidecarã€‚ä½ çš„å·¥ä½œè´Ÿè½½ä¸ sidecar äº¤äº’ï¼Œå¹¶å°½å…¶æ‰€èƒ½ä¸å…¶ä»–æœåŠ¡å¯¹è¯ï¼Œè®©ä½ ä¸ä¸åŒçš„äº‘æä¾›å•†è¿›è¡Œäº’æ“ä½œã€‚å®ƒè¿˜ä¸ºä½ æä¾›äº†é¢å¤–çš„åˆ†å¸ƒå¼ç³»ç»ŸåŠŸèƒ½ã€‚&lt;/p>
&lt;p>ç»¼ä¸Šæ‰€è¿°ï¼Œè¿™äº›é¡¹ç›®æ‰€æä¾›çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥è¯´ ESB æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—©æœŸåŒ–èº«ï¼Œå…¶ä¸­æˆ‘ä»¬æœ‰é›†ä¸­å¼çš„æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢&amp;ndash;ä½†æ˜¯æ‰©å±•æ€§ä¸å¥½ã€‚åœ¨äº‘åŸç”Ÿä¸­ï¼Œé›†ä¸­å¼æ§åˆ¶å¹³é¢ä»ç„¶å­˜åœ¨ï¼Œä½†æ˜¯æ•°æ®å¹³é¢æ˜¯åˆ†æ•£çš„&amp;ndash;å¹¶ä¸”å…·æœ‰éš”éŸ³åŠŸèƒ½å’Œé«˜åº¦çš„å¯æ‰©å±•æ€§ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å§‹ç»ˆéœ€è¦ Kubernetes æ¥åšè‰¯å¥½çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä½ å¯èƒ½è¿˜éœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ªé™„åŠ ç»„ä»¶ã€‚ä½ å¯èƒ½éœ€è¦ Istio æ¥è¿›è¡Œé«˜çº§è”ç½‘ã€‚ä½ å¯èƒ½ä¼šä½¿ç”¨ Knative æ¥è¿›è¡Œæ— æœåŠ¡å™¨å·¥ä½œè´Ÿè½½ï¼Œæˆ–è€…ä½¿ç”¨ Dapr æ¥åšé›†æˆã€‚è¿™äº›æ¡†æ¶å¯ä¸ Istio å’Œ Envoy å¾ˆå¥½çš„é…åˆä½¿ç”¨ã€‚ä» Dapr å’Œ Knative çš„è§’åº¦æ¥çœ‹ï¼Œä½ å¯èƒ½å¿…é¡»é€‰æ‹©ä¸€ä¸ªã€‚å®ƒä»¬å…±åŒä»¥äº‘åŸç”Ÿçš„æ–¹å¼æä¾›äº†æˆ‘ä»¬è¿‡å»åœ¨ ESB ä¸Šæ‹¥æœ‰çš„ä¸œè¥¿ã€‚&lt;/p>
&lt;h2 id="æœªæ¥äº‘åŸç”Ÿè¶‹åŠ¿--ç”Ÿå‘½å‘¨æœŸè¶‹åŠ¿">æœªæ¥äº‘åŸç”Ÿè¶‹åŠ¿&amp;ndash;ç”Ÿå‘½å‘¨æœŸè¶‹åŠ¿&lt;/h2>
&lt;p>åœ¨æ¥ä¸‹æ¥çš„éƒ¨åˆ†ï¼Œæˆ‘åˆ—å‡ºäº†ä¸€äº›æˆ‘è®¤ä¸ºåœ¨è¿™äº›é¢†åŸŸæ­£åœ¨å‘ç”Ÿä»¤äººæŒ¯å¥‹çš„å‘å±•çš„é¡¹ç›®ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/8image0141616431695762.jpg" alt="">&lt;/p>
&lt;p>æˆ‘æƒ³ä»ç”Ÿå‘½å‘¨æœŸå¼€å§‹ã€‚é€šè¿‡ Kubernetesï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºåº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ªæœ‰ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™å¯èƒ½ä¸è¶³ä»¥è¿›è¡Œæ›´å¤æ‚çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªæ›´å¤æ‚çš„æœ‰çŠ¶æ€åº”ç”¨ï¼Œåˆ™å¯èƒ½ä¼šæœ‰è¿™æ ·çš„åœºæ™¯ï¼Œå…¶ä¸­ Kubernetes ä¸­çš„éƒ¨ç½²åŸè¯­ä¸è¶³ä»¥ä¸ºåº”ç”¨æä¾›æ”¯æŒã€‚&lt;/p>
&lt;p>åœ¨è¿™äº›åœºæ™¯ä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ operator æ¨¡å¼ã€‚ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ª operator æ¥è¿›è¡Œéƒ¨ç½²å’Œå‡çº§ï¼Œè¿˜å¯ä»¥å°† S3 ä½œä¸ºæœåŠ¡å¤‡ä»½çš„å­˜å‚¨ä»‹è´¨ã€‚æ­¤å¤–ï¼Œä½ å¯èƒ½è¿˜ä¼šå‘ç° Kubernetes çš„å®é™…å¥åº·æ£€æŸ¥æœºåˆ¶ä¸å¤Ÿå¥½ã€‚å‡è®¾å­˜æ´»æ£€æŸ¥å’Œå°±ç»ªæ£€æŸ¥ä¸å¤Ÿå¥½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ operator å¯¹ä½ çš„åº”ç”¨è¿›è¡Œæ›´æ™ºèƒ½çš„å­˜æ´»å’Œå°±ç»ªæ£€æŸ¥ï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ¢å¤ã€‚&lt;/p>
&lt;p>ç¬¬ä¸‰ä¸ªé¢†åŸŸå°±æ˜¯è‡ªåŠ¨ä¼¸ç¼©å’Œè°ƒæ•´ã€‚ä½ å¯ä»¥è®© operator æ›´å¥½çš„äº†è§£ä½ çš„åº”ç”¨ï¼Œå¹¶åœ¨å¹³å°ä¸Šè¿›è¡Œè‡ªåŠ¨è°ƒæ•´ã€‚ç›®å‰ï¼Œç¼–å†™ operator çš„æ¡†æ¶ä¸»è¦æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ Kubernetes ç‰¹åˆ«å…´è¶£å°ç»„çš„ Kubebuilderï¼Œå¦ä¸€ä¸ªæ˜¯çº¢å¸½åˆ›å»ºçš„ operator æ¡†æ¶çš„ä¸€éƒ¨åˆ†&amp;ndash;operator SDKã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„å†…å®¹ï¼š&lt;/p>
&lt;p>Operator SDK è®©ä½ å¯ä»¥ç¼–å†™ operator &amp;ndash; operator ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨æ¥ç®¡ç† operator çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠå¯ä»¥å‘å¸ƒä½ çš„ operator åˆ° OperatorHubã€‚å¦‚ä»Šåœ¨ OperatorHubï¼Œä½ ä¼šçœ‹åˆ° 100 å¤šä¸ª operator ç”¨äºç®¡ç†æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—å’Œç›‘æ§å·¥å…·ã€‚ä»ç”Ÿå‘½å‘¨æœŸç©ºé—´æ¥çœ‹ï¼Œoperator å¯èƒ½æ˜¯ Kubernetes ç”Ÿæ€ç³»ç»Ÿä¸­å‘å±•æœ€æ´»è·ƒçš„é¢†åŸŸã€‚&lt;/p>
&lt;h2 id="ç½‘ç»œè¶‹åŠ¿---envoy">ç½‘ç»œè¶‹åŠ¿ - Envoy&lt;/h2>
&lt;p>æˆ‘é€‰çš„å¦ä¸€ä¸ªé¡¹ç›®æ˜¯ &lt;a href="https://www.envoyproxy.io/">Envoy&lt;/a>ã€‚æœåŠ¡ç½‘æ ¼æ¥å£è§„èŒƒçš„å¼•å…¥å°†ä½¿ä½ æ›´è½»æ¾åœ°åˆ‡æ¢ä¸åŒçš„æœåŠ¡ç½‘æ ¼å®ç°ã€‚åœ¨éƒ¨ç½²ä¸Š Istio å¯¹æ¶æ„è¿›è¡Œäº†ä¸€äº›æ•´åˆã€‚ä½ ä¸å†éœ€è¦ä¸ºæ§åˆ¶å¹³é¢éƒ¨ç½² 7 ä¸ª Podï¼›ç°åœ¨ï¼Œä½ åªéœ€è¦éƒ¨ç½²ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚æ›´æœ‰è¶£çš„æ˜¯åœ¨ Envoy é¡¹ç›®çš„æ•°æ®å¹³é¢ä¸Šæ‰€æ­£åœ¨å‘ç”Ÿçš„ï¼šè¶Šæ¥è¶Šå¤šçš„ç¬¬ 7 å±‚åè®®è¢«æ·»åŠ åˆ° Envoy ä¸­ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/11image0151616431697613.jpg" alt="">&lt;/p>
&lt;p>æœåŠ¡ç½‘æ ¼å¢åŠ äº†å¯¹æ›´å¤šåè®®çš„æ”¯æŒï¼Œæ¯”å¦‚ MongoDBã€ZooKeeperã€MySQLã€Redisï¼Œè€Œæœ€æ–°çš„åè®®æ˜¯ Kafkaã€‚æˆ‘çœ‹åˆ° Kafka ç¤¾åŒºç°åœ¨æ­£åœ¨è¿›ä¸€æ­¥æ”¹è¿›ä»–ä»¬çš„åè®®ï¼Œä½¿å…¶å¯¹æœåŠ¡ç½‘æ ¼æ›´åŠ å‹å¥½ã€‚æˆ‘ä»¬å¯ä»¥é¢„æ–™å°†ä¼šæœ‰æ›´ç´§å¯†çš„é›†æˆã€æ›´å¤šçš„åŠŸèƒ½ã€‚æœ€æœ‰å¯èƒ½çš„æ˜¯ï¼Œä¼šæœ‰ä¸€äº›æ¡¥æ¥çš„èƒ½åŠ›ã€‚ä½ å¯ä»¥ä»æœåŠ¡ä¸­åœ¨ä½ çš„åº”ç”¨æœ¬åœ°åšä¸€ä¸ª HTTP è°ƒç”¨ï¼Œè€Œä»£ç†å°†åœ¨åå°ä½¿ç”¨ Kafkaã€‚ä½ å¯ä»¥åœ¨åº”ç”¨å¤–éƒ¨ï¼Œåœ¨ sidecar ä¸­é’ˆå¯¹ Kafka åè®®è¿›è¡Œè½¬æ¢å’ŒåŠ å¯†ã€‚&lt;/p>
&lt;p>å¦ä¸€ä¸ªä»¤äººå…´å¥‹çš„å‘å±•æ˜¯å¼•å…¥äº† HTTP ç¼“å­˜ã€‚ç°åœ¨ Envoy å¯ä»¥è¿›è¡Œ HTTP ç¼“å­˜ã€‚ä½ ä¸å¿…åœ¨ä½ çš„åº”ç”¨ä¸­ä½¿ç”¨ç¼“å­˜å®¢æˆ·ç«¯ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯åœ¨ sidecar ä¸­é€æ˜åœ°å®Œæˆçš„ã€‚æœ‰äº† tap è¿‡æ»¤å™¨ï¼Œä½ å¯ä»¥ tap æµé‡å¹¶è·å¾—æµé‡çš„å‰¯æœ¬ã€‚æœ€è¿‘ï¼ŒWebAssembly çš„å¼•å…¥ï¼Œæ„å‘³ç€å¦‚æœä½ è¦ä¸º Envoy ç¼–å†™ä¸€äº›è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ï¼Œä½ ä¸å¿…ç”¨ C++ ç¼–å†™ï¼Œä¹Ÿä¸å¿…ç¼–è¯‘æ•´ä¸ª Envoy è¿è¡Œæ—¶ã€‚ä½ å¯ä»¥ç”¨ WebAssembly å†™ä½ çš„è¿‡æ»¤å™¨ï¼Œç„¶ååœ¨è¿è¡Œæ—¶è¿›è¡Œéƒ¨ç½²ã€‚è¿™äº›å¤§å¤šæ•°è¿˜åœ¨è¿›è¡Œä¸­ã€‚å®ƒä»¬ä¸å­˜åœ¨ï¼Œè¯´æ˜æ•°æ®å¹³é¢å’ŒæœåŠ¡ç½‘æ ¼æ— æ„åœæ­¢ï¼Œä»…æ”¯æŒ HTTP å’Œ gRPCã€‚ä»–ä»¬æœ‰å…´è¶£æ”¯æŒæ›´å¤šçš„åº”ç”¨å±‚åè®®ï¼Œä¸ºä½ æä¾›æ›´å¤šçš„åŠŸèƒ½ï¼Œä»¥å®ç°æ›´å¤šçš„ç”¨ä¾‹ã€‚æœ€ä¸»è¦çš„æ˜¯ï¼Œéšç€ WebAssembly çš„å¼•å…¥ï¼Œä½ ç°åœ¨å¯ä»¥åœ¨ sidecar ä¸­ç¼–å†™è‡ªå®šä¹‰é€»è¾‘ã€‚åªè¦ä½ æ²¡æœ‰åœ¨å…¶ä¸­æ·»åŠ ä¸€äº›ä¸šåŠ¡é€»è¾‘å°±å¯ä»¥äº†ã€‚&lt;/p>
&lt;h2 id="ç»‘å®šè¶‹åŠ¿---apache-camel">ç»‘å®šè¶‹åŠ¿ - Apache Camel&lt;/h2>
&lt;p>&lt;a href="https://camel.apache.org/">Apache Camel&lt;/a> æ˜¯ä¸€ä¸ªç”¨äºé›†æˆçš„é¡¹ç›®ï¼Œå®ƒå…·æœ‰å¾ˆå¤šä½¿ç”¨ä¼ä¸šé›†æˆæ¨¡å¼è¿æ¥åˆ°ä¸åŒç³»ç»Ÿçš„è¿æ¥å™¨ã€‚Â æ¯”å¦‚ &lt;a href="https://camel.apache.org/releases/release-3.0.0/">Camel version 3&lt;/a> å°±æ·±åº¦é›†æˆåˆ°äº† Kubernetes ä¸­ï¼Œå¹¶ä¸”ä½¿ç”¨äº†æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢æ‰€è®²çš„é‚£äº›åŸè¯­ï¼Œæ¯”å¦‚ operatorã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/7image0161616431694981.jpg" alt="">&lt;/p>
&lt;p>ä½ å¯ä»¥åœ¨ Camel ä¸­ç”¨ Javaã€JavaScript æˆ– YAML ç­‰è¯­è¨€ç¼–å†™ä½ çš„é›†æˆé€»è¾‘ã€‚æœ€æ–°çš„ç‰ˆæœ¬å¼•å…¥äº†ä¸€ä¸ª Camel operatorï¼Œå®ƒåœ¨ Kubernetes ä¸­è¿è¡Œå¹¶ç†è§£ä½ çš„é›†æˆã€‚å½“ä½ å†™å¥½ Camel åº”ç”¨ï¼Œå°†å…¶éƒ¨ç½²åˆ°è‡ªå®šä¹‰èµ„æºä¸­ï¼Œoperator å°±çŸ¥é“å¦‚ä½•æ„å»ºå®¹å™¨æˆ–æŸ¥æ‰¾ä¾èµ–é¡¹ã€‚æ ¹æ®å¹³å°çš„èƒ½åŠ›ï¼Œä¸ç®¡æ˜¯åªç”¨ Kubernetesï¼Œè¿˜æ˜¯å¸¦æœ‰ Knative çš„ Kubernetesï¼Œå®ƒéƒ½å¯ä»¥å†³å®šè¦ä½¿ç”¨çš„æœåŠ¡ä»¥åŠå¦‚ä½•å®ç°é›†æˆã€‚åœ¨è¿è¡Œæ—¶ä¹‹å¤–æœ‰ç›¸å½“å¤šçš„æ™ºèƒ½ &amp;ndash; åŒ…æ‹¬ operator &amp;ndash; æ‰€æœ‰è¿™äº›éƒ½éå¸¸å¿«åœ°å‘ç”Ÿã€‚ä¸ºä»€ä¹ˆæˆ‘ä¼šè¯´è¿™æ˜¯ä¸€ä¸ªç»‘å®šçš„è¶‹åŠ¿ï¼Ÿä¸»è¦æ˜¯å› ä¸º Apache Camel æä¾›çš„è¿æ¥å™¨çš„åŠŸèƒ½ã€‚è¿™é‡Œæœ‰è¶£çš„ä¸€ç‚¹æ˜¯å®ƒå¦‚ä½•ä¸ Kubernetes æ·±åº¦é›†æˆã€‚&lt;/p>
&lt;h2 id="çŠ¶æ€è¶‹åŠ¿---cloudstate">çŠ¶æ€è¶‹åŠ¿ - Cloudstate&lt;/h2>
&lt;p>å¦ä¸€ä¸ªæˆ‘æƒ³è®¨è®ºçš„é¡¹ç›®æ˜¯ &lt;a href="https://cloudstate.io/">Cloudstate&lt;/a> å’Œä¸çŠ¶æ€ç›¸å…³çš„è¶‹åŠ¿ã€‚Cloudstate æ˜¯ Lightbend çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä¸»è¦è‡´åŠ›äºæ— æœåŠ¡å™¨å’ŒåŠŸèƒ½é©±åŠ¨çš„å¼€å‘ã€‚æœ€æ–°å‘å¸ƒçš„ç‰ˆæœ¬ï¼Œæ­£åœ¨ä½¿ç”¨ sidecar å’Œ operator ä¸ Kubernetes è¿›è¡Œæ·±åº¦é›†æˆã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/8image0171616431996943.jpg" alt="">&lt;/p>
&lt;p>è¿™ä¸ªåˆ›æ„æ˜¯ï¼Œå½“ä½ ç¼–å†™ä½ çš„åŠŸèƒ½æ—¶ï¼Œä½ åœ¨åŠŸèƒ½ä¸­è¦åšçš„å°±æ˜¯ä½¿ç”¨ gRPC æ¥è·å–çŠ¶æ€å¹¶ä¸ä¹‹è¿›è¡Œäº¤äº’ã€‚æ•´ä¸ªçŠ¶æ€ç®¡ç†åœ¨ä¸å…¶ä»– sidecar ç¾¤é›†çš„ sidear ä¸­è¿›è¡Œã€‚å®ƒä½¿ä½ èƒ½å¤Ÿè¿›è¡Œäº‹ä»¶æº¯æºã€CQRSã€é”®å€¼æŸ¥è¯¢ã€æ¶ˆæ¯ä¼ é€’ã€‚&lt;/p>
&lt;p>ä»åº”ç”¨ç¨‹åºè§’åº¦æ¥çœ‹ï¼Œä½ å¹¶ä¸äº†è§£æ‰€æœ‰è¿™äº›å¤æ‚æ€§ã€‚ä½ æ‰€åšçš„åªæ˜¯è°ƒç”¨ä¸€ä¸ªæœ¬åœ°çš„ sidecarï¼Œè€Œ sidecar ä¼šå¤„ç†è¿™äº›å¤æ‚çš„äº‹æƒ…ã€‚å®ƒå¯ä»¥åœ¨åå°ä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„æ•°æ®æºã€‚è€Œä¸”å®ƒæ‹¥æœ‰å¼€å‘äººå‘˜æ‰€éœ€çš„æ‰€æœ‰æœ‰çŠ¶æ€æŠ½è±¡ã€‚&lt;/p>
&lt;p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†äº‘åŸç”Ÿç”Ÿæ€ç³»ç»Ÿä¸­çš„æœ€æ–°æŠ€æœ¯ä»¥åŠä¸€äº›ä»åœ¨è¿›è¡Œä¸­çš„å¼€å‘ã€‚æˆ‘ä»¬å¦‚ä½•ç†è§£è¿™ä¸€åˆ‡ï¼Ÿ&lt;/p>
&lt;h2 id="å¤šè¿è¡Œæ—¶å¾®æœåŠ¡å·²ç»åˆ°æ¥">å¤šè¿è¡Œæ—¶å¾®æœåŠ¡å·²ç»åˆ°æ¥&lt;/h2>
&lt;p>å¦‚æœä½ çœ‹å¾®æœåŠ¡åœ¨ Kubernetes ä¸Šçš„æ ·å­ï¼Œåˆ™å°†éœ€è¦ä½¿ç”¨æŸäº›å¹³å°åŠŸèƒ½ã€‚æ­¤å¤–ï¼Œä½ å°†éœ€è¦é¦–å…ˆä½¿ç”¨ Kubernetes çš„åŠŸèƒ½è¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ç„¶åï¼Œå¾ˆæœ‰å¯èƒ½é€æ˜åœ°ï¼Œä½ çš„æœåŠ¡ä¼šä½¿ç”¨æŸäº›æœåŠ¡ç½‘æ ¼ï¼ˆä¾‹å¦‚ Envoyï¼‰æ¥è·å¾—å¢å¼ºçš„ç½‘ç»œåŠŸèƒ½ï¼Œæ— è®ºæ˜¯æµé‡è·¯ç”±ã€å¼¹æ€§ã€å¢å¼ºçš„å®‰å…¨æ€§ï¼Œç”šè‡³å‡ºäºç›‘æ§çš„ç›®çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ ¹æ®ä½ çš„åœºæ™¯å’Œä½¿ç”¨çš„å·¥ä½œè´Ÿè½½å¯èƒ½éœ€è¦ Dapr æˆ–è€… Knativeã€‚æ‰€æœ‰è¿™äº›éƒ½ä»£è¡¨äº†è¿›ç¨‹å¤–é™„åŠ çš„åŠŸèƒ½ã€‚å‰©ä¸‹çš„å°±æ˜¯ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ˜¯æ”¾åœ¨æœ€ä¸Šé¢è€Œæ˜¯ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„è¿è¡Œæ—¶æ¥ç¼–å†™ã€‚æœªæ¥çš„å¾®æœåŠ¡å¾ˆæœ‰å¯èƒ½å°†æ˜¯ç”±å¤šä¸ªå®¹å™¨ç»„æˆçš„è¿™ç§å¤šè¿è¡Œæ—¶ã€‚æœ‰äº›æ˜¯é€æ˜çš„ï¼Œæœ‰äº›åˆ™æ˜¯éå¸¸æ˜ç¡®çš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/6image0181616431996411.jpg" alt="">&lt;/p>
&lt;h2 id="æ™ºèƒ½çš„-sidecar-å’Œæ„šè ¢çš„ç®¡é“">æ™ºèƒ½çš„ sidecar å’Œæ„šè ¢çš„ç®¡é“&lt;/h2>
&lt;p>å¦‚æœæ›´æ·±å…¥åœ°çœ‹ï¼Œé‚£å¯èƒ½æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›é«˜çº§è¯­è¨€ç¼–å†™ä¸šåŠ¡é€»è¾‘ã€‚æ˜¯ä»€ä¹ˆå¹¶ä¸é‡è¦ï¼Œä¸å¿…ä»…æ˜¯ Javaï¼Œå› ä¸ºä½ å¯ä»¥ä½¿ç”¨ä»»ä½•å…¶ä»–è¯­è¨€å¹¶åœ¨å†…éƒ¨å¼€å‘è‡ªå®šä¹‰é€»è¾‘ã€‚&lt;/p>
&lt;p>ä½ çš„ä¸šåŠ¡é€»è¾‘ä¸å¤–éƒ¨ä¸–ç•Œçš„æ‰€æœ‰äº¤äº’éƒ½æ˜¯é€šè¿‡ sidecar å‘ç”Ÿçš„ï¼Œå¹¶ä¸å¹³å°é›†æˆè¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚å®ƒä¸ºå¤–éƒ¨ç³»ç»Ÿæ‰§è¡Œç½‘ç»œæŠ½è±¡ï¼Œä¸ºä½ æä¾›é«˜çº§çš„ç»‘å®šåŠŸèƒ½å’ŒçŠ¶æ€æŠ½è±¡ã€‚sidecar æ˜¯ä½ ä¸éœ€è¦å¼€å‘çš„ä¸œè¥¿ã€‚ä½ å¯ä»¥ä»è´§æ¶ä¸Šæ‹¿åˆ°å®ƒã€‚ä½ ç”¨ä¸€ç‚¹ YAML æˆ– JSON é…ç½®å®ƒï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨å®ƒã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥è½»æ¾åœ°æ›´æ–° sidecarï¼Œå› ä¸ºå®ƒä¸å†è¢«åµŒå…¥åˆ°ä½ çš„è¿è¡Œæ—¶ã€‚è¿™ä½¿å¾—æ‰“è¡¥ä¸ã€æ›´æ–°å˜å¾—æ›´åŠ æ›´å®¹æ˜“ã€‚å®ƒä¸ºæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘å¯ç”¨äº†å¤šè¯­è¨€è¿è¡Œæ—¶ã€‚&lt;/p>
&lt;h2 id="å¾®æœåŠ¡ä¹‹åæ˜¯ä»€ä¹ˆ">å¾®æœåŠ¡ä¹‹åæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/h2>
&lt;p>è¿™è®©æˆ‘æƒ³åˆ°äº†æœ€åˆçš„é—®é¢˜ï¼Œå¾®æœåŠ¡ä¹‹åæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/6image0201616431995910.jpg" alt="">&lt;/p>
&lt;p>å¦‚æœæˆ‘ä»¬çœ‹ä¸‹æ¶æ„çš„å‘å±•å†ç¨‹ï¼Œåº”ç”¨æ¶æ„åœ¨å¾ˆé«˜çš„å±‚é¢ä¸Šæ˜¯ä»å•ä½“åº”ç”¨å¼€å§‹çš„ã€‚ç„¶è€Œå¾®æœåŠ¡ç»™æˆ‘ä»¬æä¾›äº†å¦‚ä½•æŠŠä¸€ä¸ªå•ä½“åº”ç”¨æ‹†åˆ†æˆç‹¬ç«‹çš„ä¸šåŠ¡åŸŸçš„æŒ‡å¯¼åŸåˆ™ã€‚ä¹‹ååˆå‡ºç°äº†æ— æœåŠ¡å™¨å’ŒåŠŸèƒ½å³æœåŠ¡ï¼ˆFaaSï¼‰ï¼Œæˆ‘ä»¬è¯´è¿‡å¯ä»¥æŒ‰æ“ä½œå°†å…¶è¿›ä¸€æ­¥æ‹†åˆ†ï¼Œä»è€Œå®ç°æé«˜çš„å¯æ‰©å±•æ€§-å› ä¸ºæˆ‘ä»¬å¯ä»¥åˆ†åˆ«æ‰©å±•æ¯ä¸ªæ“ä½œã€‚&lt;/p>
&lt;p>æˆ‘æƒ³è¯´çš„æ˜¯ FaaS å¹¶ä¸æ˜¯æœ€å¥½çš„æ¨¡å¼ &amp;ndash; å› ä¸ºåŠŸèƒ½å¹¶ä¸æ˜¯å®ç°åˆç†çš„å¤æ‚æœåŠ¡çš„æœ€ä½³æ¨¡å¼ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å¤šä¸ªæ“ä½œå¿…é¡»ä¸åŒä¸€ä¸ªæ•°æ®é›†è¿›è¡Œäº¤äº’æ—¶ï¼Œä½ å¸Œæœ›å®ƒä»¬é©»ç•™åœ¨ä¸€èµ·ã€‚å¯èƒ½æ˜¯å¤šè¿è¡Œæ—¶ï¼ˆæˆ‘æŠŠå®ƒç§°ä¸º &lt;a href="https://www.infoq.com/articles/multi-runtime-microservice-architecture/">Mecha æ¶æ„&lt;/a>ï¼‰ï¼Œåœ¨è¯¥æ¶æ„ä¸­ä½ å°†ä¸šåŠ¡é€»è¾‘æ”¾åœ¨ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œè€Œæ‰€æœ‰ä¸åŸºç¡€è®¾æ–½ç›¸å…³çš„å…³æ³¨ç‚¹ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å®¹å™¨å­˜åœ¨ã€‚å®ƒä»¬å…±åŒä»£è¡¨å¤šè¿è¡Œæ—¶å¾®æœåŠ¡ã€‚ä¹Ÿè®¸è¿™æ˜¯ä¸€ä¸ªæ›´åˆé€‚çš„æ¨¡å‹ï¼Œå› ä¸ºå®ƒæœ‰æ›´å¥½çš„å±æ€§ã€‚&lt;/p>
&lt;p>ä½ å¯ä»¥è·å¾—å¾®æœåŠ¡çš„æ‰€æœ‰å¥½å¤„ã€‚ä»ç„¶å°†æ‰€æœ‰åŸŸå’Œæ‰€æœ‰é™ç•Œä¸Šä¸‹æ–‡æ”¾åœ¨ä¸€å¤„ã€‚ä½ å°†æ‰€æœ‰çš„åŸºç¡€è®¾æ–½å’Œåˆ†å¸ƒå¼åº”ç”¨éœ€æ±‚æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„å®¹å™¨ä¸­ï¼Œå¹¶åœ¨è¿è¡Œæ—¶å°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ã€‚å¤§æ¦‚ï¼Œç°åœ¨æœ€æ¥è¿‘è¿™ç§æ¨¡å‹çš„æ˜¯ Daprã€‚ä»–ä»¬æ­£åœ¨éµå¾ªè¿™ç§æ¨¡å‹ã€‚å¦‚æœä½ ä»…å¯¹ç½‘ç»œæ–¹é¢æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆå¯èƒ½ä½¿ç”¨ Envoy ä¹Ÿä¼šæ¥è¿‘è¿™ç§æ¨¡å‹ã€‚&lt;/p>
&lt;h2 id="å…³äºä½œè€…">å…³äºä½œè€…&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/21bilgin-ibryam15886810412341616480845087.jpeg" alt="">&lt;/p>
&lt;p>&lt;strong>Bilgin Ibryam&lt;/strong> æ˜¯çº¢å¸½å…¬å¸çš„äº§å“ç»ç†å’Œå‰æ¶æ„å¸ˆã€æäº¤äººï¼Œå¹¶ä¸”æ˜¯ Apache è½¯ä»¶åŸºé‡‘ä¼šçš„æˆå‘˜ã€‚ä»–æ˜¯å¼€æºå¸ƒé“è€…ï¼Œç»å¸¸å†™åšå®¢ã€å‘è¡¨æ¼”è®²ï¼Œæ˜¯ &lt;a href="https://k8spatterns.io/">Kubernetes Patterns&lt;/a> å’Œ Camel Design Patterns ä¹¦ç±çš„ä½œè€…ã€‚Bilgin ç›®å‰çš„å·¥ä½œä¸»è¦é›†ä¸­åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿã€äº‹ä»¶é©±åŠ¨æ¶æ„ä»¥åŠå¯é‡å¤çš„äº‘åŸç”Ÿåº”ç”¨å¼€å‘æ¨¡å¼å’Œå®è·µä¸Šã€‚è¯·å…³æ³¨ä»– @bibryam äº†è§£æœªæ¥ç±»ä¼¼ä¸»é¢˜çš„æ›´æ–°ã€‚&lt;/p></description></item><item><title>Kubernetes æºç è§£æ - Informer</title><link>https://atbug.com/kubernetes-source-code-how-informer-work/</link><pubDate>Sun, 16 Aug 2020 23:32:38 +0800</pubDate><guid>https://atbug.com/kubernetes-source-code-how-informer-work/</guid><description>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/wY8ZevIHIH7CD-fWGZecPQ">ä¸Šç¯‡&lt;/a>æ‰’äº† HPA çš„æºç ï¼Œä½†æ˜¯æ²¡æ·±å…¥ç»†èŠ‚ï¼Œä»Šå¤©å¾€ç»†èŠ‚æ·±å…¥ã€‚&lt;/p>
&lt;p>å¼€å±€å…ˆç¥­å‡ºä¸€å¼ å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/08/16/15975802542217.png" alt="">&lt;/p>
&lt;h2 id="ä¸ºä»€ä¹ˆè¦æœ‰-informer">ä¸ºä»€ä¹ˆè¦æœ‰ Informerï¼Ÿ&lt;/h2>
&lt;p>Kubernetes ä¸­çš„æŒä¹…åŒ–æ•°æ®ä¿å­˜åœ¨ etcdä¸­ï¼Œå„ä¸ªç»„ä»¶å¹¶ä¸ä¼šç›´æ¥è®¿é—® etcdï¼Œè€Œæ˜¯é€šè¿‡ api-serveræš´éœ²çš„ RESTful æ¥å£å¯¹é›†ç¾¤è¿›è¡Œè®¿é—®å’Œæ§åˆ¶ã€‚&lt;/p>
&lt;p>èµ„æºçš„æ§åˆ¶å™¨ï¼ˆå›¾ä¸­å³ä¾§ç°è‰²çš„éƒ¨åˆ†ï¼‰è¯»å–æ•°æ®ä¹Ÿå¹¶ä¸ä¼šç›´æ¥ä» api-server ä¸­è·å–èµ„æºä¿¡æ¯ï¼ˆè¿™æ ·ä¼šå¢åŠ  api-server çš„å‹åŠ›ï¼‰ï¼Œè€Œæ˜¯ä»å…¶â€œæœ¬åœ°ç¼“å­˜â€ä¸­è¯»å–ã€‚è¿™ä¸ªâ€œæœ¬åœ°ç¼“å­˜â€åªæ˜¯è¡¨è±¡çš„å­˜åœ¨ï¼ŒåŠ ä¸Šç¼“å­˜çš„åŒæ­¥é€»è¾‘å°±æ˜¯ä»Šå¤©è¦æ˜¯è¯´çš„&lt;code>Informer&lt;/code>ï¼ˆç°è‰²åŒºåŸŸä¸­çš„ç¬¬ä¸€ä¸ªè“è‰²å—ï¼‰æ‰€æä¾›çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ° Informer çš„å‡ ä¸ªç»„ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>Reflectorï¼šä¸ &lt;code>api-server&lt;/code>äº¤äº’ï¼Œç›‘å¬èµ„æºçš„å˜æ›´ã€‚&lt;/li>
&lt;li>Delta FIFO Queueï¼šå¢é‡çš„ FIFO é˜Ÿåˆ—ï¼Œä¿å­˜ Reflector ç›‘å¬åˆ°çš„èµ„æºå˜æ›´ï¼ˆç®€å•çš„å°è£…ï¼‰ã€‚&lt;/li>
&lt;li>Indexerï¼šInformer çš„æœ¬åœ°ç¼“å­˜ï¼ŒFIFO é˜Ÿåˆ—ä¸­çš„æ•°æ®æ ¹æ®ä¸åŒçš„å˜æ›´ç±»å‹ï¼Œåœ¨è¯¥ç¼“å­˜ä¸­è¿›è¡Œæ“ä½œã€‚
&lt;ul>
&lt;li>Local Storeï¼š&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/wY8ZevIHIH7CD-fWGZecPQ">ä¸Šç¯‡&lt;/a> æåˆ°äº†æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©çš„æ§åˆ¶å™¨&lt;code>HorizontalController&lt;/code>ï¼Œå…¶æ„é€ æ–¹æ³•å°±éœ€è¦æä¾› &lt;code>Informer&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//pkg/controller/podautoscaler/horizontal.go
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalController&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">scaleNamespacer&lt;/span> &lt;span class="nx">scaleclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ScalesGetter&lt;/span>
&lt;span class="nx">hpaNamespacer&lt;/span> &lt;span class="nx">autoscalingclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalersGetter&lt;/span>
&lt;span class="nx">mapper&lt;/span> &lt;span class="nx">apimeta&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RESTMapper&lt;/span>
&lt;span class="nx">replicaCalc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ReplicaCalculator&lt;/span>
&lt;span class="nx">eventRecorder&lt;/span> &lt;span class="nx">record&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventRecorder&lt;/span>
&lt;span class="nx">downscaleStabilisationWindow&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>
&lt;span class="nx">hpaLister&lt;/span> &lt;span class="nx">autoscalinglisters&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerLister&lt;/span>
&lt;span class="nx">hpaListerSynced&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InformerSynced&lt;/span>
&lt;span class="nx">podLister&lt;/span> &lt;span class="nx">corelisters&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodLister&lt;/span>
&lt;span class="nx">podListerSynced&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InformerSynced&lt;/span>
&lt;span class="nx">queue&lt;/span> &lt;span class="nx">workqueue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RateLimitingInterface&lt;/span>
&lt;span class="nx">recommendations&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">][]&lt;/span>&lt;span class="nx">timestampedRecommendation&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewHorizontalController&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">evtNamespacer&lt;/span> &lt;span class="nx">v1core&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventsGetter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">scaleNamespacer&lt;/span> &lt;span class="nx">scaleclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ScalesGetter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">hpaNamespacer&lt;/span> &lt;span class="nx">autoscalingclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalersGetter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">mapper&lt;/span> &lt;span class="nx">apimeta&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RESTMapper&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">metricsClient&lt;/span> &lt;span class="nx">metricsclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MetricsClient&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="c1">//ä»HorizontalPodAutoscalerInformer è·å–hpa å®ä¾‹ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">hpaInformer&lt;/span> &lt;span class="nx">autoscalinginformers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerInformer&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="c1">//ä»PodInformer ä¸­è·å– pod ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">podInformer&lt;/span> &lt;span class="nx">coreinformers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodInformer&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">resyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">downscaleStabilisationWindow&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">tolerance&lt;/span> &lt;span class="kt">float64&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">cpuInitializationPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">delayOfInitialReadinessStatus&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">......&lt;/span>
&lt;span class="nx">hpaInformer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Informer&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">AddEventHandlerWithResyncPeriod&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="c1">//æ·»åŠ äº‹ä»¶å¤„ç†å™¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResourceEventHandlerFuncs&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">AddFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">hpaController&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">enqueueHPA&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">UpdateFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">hpaController&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">updateHPA&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">DeleteFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">hpaController&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">deleteHPA&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="o">......&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerInformer&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Informer&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SharedIndexInformer&lt;/span>
&lt;span class="nf">Lister&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerLister&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>HorizontalPodAutoscalerInformer&lt;/code>çš„å®ä¾‹åŒ–æ–¹æ³•ä¸­å°±å‡ºç°äº†ä»Šå¤©çš„æ­£ä¸»&lt;code>cache.NewSharedIndexInformer()&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/informers/autoscaling/v1/horizontalpodautoscaler.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewFilteredHorizontalPodAutoscalerInformer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span> &lt;span class="nx">kubernetes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">namespace&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexers&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Indexers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tweakListOptions&lt;/span> &lt;span class="nx">internalinterfaces&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TweakListOptionsFunc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SharedIndexInformer&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewSharedIndexInformer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="c1">//ç”¨äº list å’Œ watch api-server ä¸­çš„èµ„æºã€‚æ¯”å¦‚ç”¨æ¥åˆ›å»º Reflector
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListWatch&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">ListFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListOptions&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">tweakListOptions&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">tweakListOptions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ä½¿ç”¨ HPA API è·å– HPAèµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AutoscalingV1&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">HorizontalPodAutoscalers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">namespace&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">List&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nx">WatchFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListOptions&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">watch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">tweakListOptions&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">tweakListOptions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ä½¿ç”¨ HPA API ç›‘æ§ HPAèµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AutoscalingV1&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">HorizontalPodAutoscalers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">namespace&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Watch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">autoscalingv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscaler&lt;/span>&lt;span class="p">{},&lt;/span>
&lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">indexers&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆå§‹åŒ–">åˆå§‹åŒ–&lt;/h2>
&lt;h3 id="informer">Informer&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/index.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Indexers&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">IndexFunc&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">IndexFunc&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">obj&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®ä¾‹åŒ– Indexers &lt;code>cache.Indexers{cache.NamespaceIndex: cache.MetaNamespaceIndexFunc}&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/shared_informer.go
&lt;/span>&lt;span class="c1">// ListerWatcher ç”¨äº list å’Œwatch api-server ä¸Šçš„èµ„æº
&lt;/span>&lt;span class="c1">//runtime.Objectè¦ç›‘æ§çš„èµ„æºçš„è¿è¡Œæ—¶å¯¹è±¡
&lt;/span>&lt;span class="c1">//time.DurationåŒæ­¥çš„é—´éš”æ—¶é—´
&lt;/span>&lt;span class="c1">//Indexers æä¾›ä¸åŒèµ„æºçš„ç´¢å¼•æ•°æ®çš„ä¿¡æ¯æŸ¥è¯¢æ–¹æ³•ï¼Œå¦‚ namespace =&amp;gt; MetaNamespaceIndexFunc
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewSharedIndexInformer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lw&lt;/span> &lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">objType&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">defaultEventHandlerResyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexers&lt;/span> &lt;span class="nx">Indexers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">SharedIndexInformer&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">realClock&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RealClock&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">sharedIndexInformer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sharedIndexInformer&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">processor&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sharedProcessor&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">realClock&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="nx">indexer&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">NewIndexer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">DeletionHandlingMetaNamespaceKeyFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexers&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="c1">//åˆå§‹åŒ– Indexer
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">listerWatcher&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">lw&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">objectType&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">objType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">resyncCheckPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">defaultEventHandlerResyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">defaultEventHandlerResyncPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">defaultEventHandlerResyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">cacheMutationDetector&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">NewCacheMutationDetector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%T&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">objType&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="nx">clock&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">realClock&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">sharedIndexInformer&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="indexer">Indexer&lt;/h3>
&lt;p>&lt;code>Indexer&lt;/code>æä¾›äº†æœ¬åœ°ç¼“å­˜çš„å®ç°ï¼šè®¡ç®— key å’Œå¯¹æ•°æ®è¿›è¡Œæ§åˆ¶ï¼ˆé€šè¿‡è°ƒç”¨&lt;code>ThreadSafeStore&lt;/code>çš„æ¥å£ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Indexer&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Store&lt;/span>
&lt;span class="nf">Index&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexName&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">IndexKeys&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexedValue&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">ListIndexFuncValues&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexName&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="nf">ByIndex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexedValue&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">GetIndexers&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Indexers&lt;/span>
&lt;span class="nf">AddIndexers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newIndexers&lt;/span> &lt;span class="nx">Indexers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Indexer&lt;/code> çš„åˆ›å»º&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/store.go
&lt;/span>&lt;span class="c1">//keyFuncï¼škey çš„ç”Ÿæˆè§„åˆ™
&lt;/span>&lt;span class="c1">//indexersï¼šæä¾›äº†ç´¢å¼•èµ„æºçš„ä¸åŒä¿¡æ¯çš„è®¿é—®æ–¹æ³•ï¼Œå¦‚ç”¨äºæŸ¥è¯¢å‘½åç©ºé—´çš„ namespace =&amp;gt; MetaNamespaceIndexFunc
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewIndexer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">keyFunc&lt;/span> &lt;span class="nx">KeyFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexers&lt;/span> &lt;span class="nx">Indexers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Indexer&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">cacheStorage&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">NewThreadSafeStore&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Indices&lt;/span>&lt;span class="p">{}),&lt;/span>
&lt;span class="nx">keyFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">keyFunc&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="threadsafestore">&lt;code>ThreadSafeStore&lt;/code>&lt;/h4>
&lt;p>ThreadSafeStoreæä¾›äº†å¯¹å­˜å‚¨çš„å¹¶å‘è®¿é—®æ¥å£&lt;/p>
&lt;p>æ³¨æ„äº‹é¡¹ï¼šä¸èƒ½ä¿®æ”¹Getæˆ–Listè¿”å›çš„ä»»ä½•å†…å®¹ï¼Œå› ä¸ºå®ƒä¸ä»…ä¼šç ´åçº¿ç¨‹å®‰å…¨ï¼Œè¿˜ä¼šç ´åç´¢å¼•åŠŸèƒ½ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/thread_safe_store.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewThreadSafeStore&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexers&lt;/span> &lt;span class="nx">Indexers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indices&lt;/span> &lt;span class="nx">Indices&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">ThreadSafeStore&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">threadSafeMap&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">items&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{},&lt;/span>
&lt;span class="nx">indexers&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">indexers&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">indices&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">indices&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">threadSafeMap&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">lock&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RWMutex&lt;/span>
&lt;span class="nx">items&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}&lt;/span> &lt;span class="c1">//key =&amp;gt; value
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">indexers&lt;/span> &lt;span class="nx">Indexers&lt;/span> &lt;span class="c1">//value çš„ä¿¡æ¯çš„è®¿é—®æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">indices&lt;/span> &lt;span class="nx">Indices&lt;/span> &lt;span class="c1">//ç´¢å¼•
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="reflector">Reflector&lt;/h3>
&lt;p>&lt;code>Reflector&lt;/code>é€šè¿‡&lt;code> ListerWatcher&lt;/code>ï¼ˆAPIï¼‰ä¸&lt;code>api-server&lt;/code>äº¤äº’ï¼Œå¯¹èµ„æºè¿›è¡Œç›‘æ§ã€‚å°†èµ„æºå®ä¾‹çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ç­‰æ—¶é—´å°è£…åä¿å­˜åœ¨&lt;code>Informer&lt;/code>çš„FIFO é˜Ÿåˆ—ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/reflector.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewReflector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lw&lt;/span> &lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">expectedType&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">store&lt;/span> &lt;span class="nx">Store&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Reflector&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">NewNamedReflector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">naming&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetNameFromCallsite&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">internalPackages&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">lw&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">expectedType&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">store&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// NewNamedReflector same as NewReflector, but with a specified name for logging
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewNamedReflector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">lw&lt;/span> &lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">expectedType&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">store&lt;/span> &lt;span class="nx">Store&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Reflector&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">r&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Reflector&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">listerWatcher&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">lw&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">store&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">store&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">//FIFOé˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">period&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">clock&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RealClock&lt;/span>&lt;span class="p">{},&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">setExpectedType&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">expectedType&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">r&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ·»åŠ åŒæ­¥äº‹ä»¶ç›‘å¬å™¨">æ·»åŠ åŒæ­¥äº‹ä»¶ç›‘å¬å™¨&lt;/h3>
&lt;p>é€šè¿‡&lt;code>sharedIndexInformer#AddEventHandlerWithResyncPeriod()&lt;/code>æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ã€‚&lt;/p>
&lt;p>ä»¥å‰é¢çš„ HorizontalControllerä¸ºä¾‹ï¼Œåˆ›å»º informer çš„æ—¶å€™æ·»åŠ äº†ä¸‰ä¸ªå¤„ç†æ–¹æ³•ï¼š&lt;code>AddFunc&lt;/code>ã€&lt;code>UpdateFunc&lt;/code>ã€&lt;code>DeleteFunc&lt;/code>ã€‚è¿™ä¸‰ä¸ªæ–¹æ³•çš„å®ç°æ˜¯å°†å¯¹åº”çš„å…ƒç´ çš„ keyï¼ˆå›ºå®šæ ¼å¼ &lt;code>namespace/name&lt;/code>ï¼‰ä»&lt;code> workequeue&lt;/code>ä¸­è¿›è¡Œå…¥é˜Ÿã€å‡ºé˜Ÿçš„æ“ä½œã€‚ï¼ˆèµ„æºæ§åˆ¶å™¨ç›‘å¬äº†è¯¥ &lt;code>workqueue&lt;/code>ï¼‰&lt;/p>
&lt;h2 id="è¿è¡Œ">è¿è¡Œ&lt;/h2>
&lt;h3 id="controller-manager">&lt;code>controller-manager&lt;/code>&lt;/h3>
&lt;p>åœ¨é€šè¿‡&lt;code>InformerFactory&lt;/code>åˆ›å»º&lt;code>Informer&lt;/code>å®Œæˆåï¼Œéƒ½ä¼šå°†æ–°å»ºçš„&lt;code> Informer&lt;/code>åŠ å…¥åˆ°&lt;code>InformerFactory&lt;/code>çš„ä¸€ä¸ª&lt;code>map&lt;/code>ä¸­ã€‚&lt;/p>
&lt;p>åœ¨&lt;code>controller-manager&lt;/code>åœ¨å®Œæˆæ‰€æœ‰çš„æ§åˆ¶å™¨ï¼ˆå„ç§&lt;code>Controller&lt;/code>ï¼ŒåŒ…æ‹¬ CRDï¼‰åï¼Œä¼šè°ƒç”¨&lt;code>InformerFactory#Start()&lt;/code>æ¥å¯åŠ¨&lt;code>InformerFactory&lt;/code>çš„&lt;code>map&lt;/code>ä¸­çš„æ‰€æœ‰&lt;code> Informer&lt;/code>ï¼ˆè°ƒç”¨&lt;code>Informer#Run()&lt;/code>æ–¹æ³•ï¼‰&lt;/p>
&lt;h3 id="sharedindexinformerrun">&lt;code>sharedIndexInformer#Run()&lt;/code>&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/shared_informer.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sharedIndexInformer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleCrash&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">//åˆ›å»ºä¸€ä¸ªå¢é‡çš„ FIFOé˜Ÿåˆ—ï¼šDeltaFIFO
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">fifo&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">NewDeltaFIFO&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">MetaNamespaceKeyFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cfg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Queue&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">fifo&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">listerWatcher&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ObjectType&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">objectType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">FullResyncPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resyncCheckPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">RetryOnError&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ShouldResync&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">shouldResync&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Process&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HandleDeltas&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//å¯åŠ¨å‰çš„åˆå§‹åŒ–ï¼Œåˆ›å»º Controller
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startedLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startedLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">controller&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cfg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">controller&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">controller&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">clock&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">started&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="nx">processorStopCh&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Group&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// Wait for Processor to stop
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">defer&lt;/span> &lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">processorStopCh&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// Tell Processor to stop
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartWithChannel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">processorStopCh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheMutationDetector&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Run&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartWithChannel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">processorStopCh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">run&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//é€€å‡ºæ—¶çš„çŠ¶æ€æ¸…ç†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startedLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startedLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stopped&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span> &lt;span class="c1">// Don&amp;#39;t want any new listeners
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}()&lt;/span>
&lt;span class="c1">//å®è¡Œæ§åˆ¶é€»è¾‘
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">controller&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="controllerrun">&lt;code>controller#Run()&lt;/code>&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/controller.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">controller&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleCrash&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">stopCh&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="c1">//åˆ›å»ºä¸€ä¸ª Reflectorï¼Œç”¨äºä» api-server list å’Œ watch èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">NewReflector&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Queue&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FullResyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ShouldResync&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ShouldResync&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span>
&lt;span class="c1">//ä¸º controller æŒ‡å®š Reflector
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">reflectorMutex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">reflector&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">r&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">reflectorMutex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Group&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">//æ‰§è¡ŒReflector#Run()ï¼šä¼šå¯åŠ¨ä¸€ä¸ªgoroutineå¼€å§‹ç›‘æ§èµ„æºï¼Œå°† watch åˆ°çš„æ•°æ®å†™å…¥åˆ°queueï¼ˆFIFO é˜Ÿåˆ—ï¼‰ä¸­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartWithChannel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Run&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//æŒç»­ä» queueï¼ˆFIFO é˜Ÿåˆ—ï¼‰ è·å–æ•°æ®å¹¶è¿›è¡Œå¤„ç†ï¼Œå¤„ç†çš„é€»è¾‘åœ¨sharedIndexInformer#HandleDeltas()
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Until&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processLoop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stopCh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="sharedindexinformerhandledeltas">&lt;code>sharedIndexInformer#HandleDeltas()&lt;/code>&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/shared_informer.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sharedIndexInformer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">HandleDeltas&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">obj&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">blockDeltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">blockDeltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// from oldest to newest
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">d&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">obj&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">Deltas&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//å¾ªç¯å¤„ç† FIFO é˜Ÿåˆ—ä¸­å–å‡ºçš„èµ„æºå®ä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">switch&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Type&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">Sync&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Added&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Updated&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1">//åŒæ­¥ï¼ˆåé¢è¯¦ç»†è§£è¯»ï¼‰ã€æ–°å¢ã€æ›´æ–°äº‹ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">isSync&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Type&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">Sync&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheMutationDetector&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">old&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">exists&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">exists&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//å¦‚æœ indexer ä¸­å·²ç»å­˜åœ¨ï¼Œæ›´æ‰ç”¨ update æ–¹æ³•è¿›è¡Œæ›´æ–°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//æ›´æ–°æˆåŠŸåå‘é€â€œæ›´æ–°â€é€šçŸ¥ï¼šåŒ…å«äº†æ–°ã€æ—§èµ„æºå®ä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">distribute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">updateNotification&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">oldObj&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">old&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">newObj&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="nx">isSync&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//å¦‚æœ indexer ä¸­æ²¡æœ‰è¯¥èµ„æºå®ä¾‹ï¼Œåˆ™æ”¾å…¥ indexer ä¸­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//æ·»åŠ æˆåŠŸåï¼Œå‘é€â€œæ–°å¢â€é€šçŸ¥ï¼šåŒ…å«äº†æ–°åŠ çš„èµ„æºå®ä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">distribute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addNotification&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">newObj&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="nx">isSync&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">Deleted&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1">//åˆ é™¤äº‹ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="c1">//ä» indexer ä¸­åˆ é™¤
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//åˆ é™¤æˆåŠŸåï¼Œå‘é€â€œåˆ é™¤é€šçŸ¥â€ï¼šåŒ…å«äº†åˆ é™¤çš„èµ„æºå®ä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">distribute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">deleteNotification&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">oldObj&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>Informer çš„å®ç°ä¸ç®—å¤æ‚ï¼Œå´åœ¨ Kubernetes ä¸­å¾ˆå¸¸è§ï¼Œæ¯ç§èµ„æºçš„æ§åˆ¶ä¹Ÿéƒ½é€šè¿‡ Informer æ¥è·å–&lt;code>api-server&lt;/code>çš„èµ„æºå®ä¾‹çš„å˜æ›´ã€‚&lt;/p></description></item><item><title>Kubernetes æºç è§£æ - HPA æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©å¦‚ä½•å·¥ä½œ</title><link>https://atbug.com/kubernetes-source-code-how-hpa-work/</link><pubDate>Sat, 15 Aug 2020 02:09:37 +0800</pubDate><guid>https://atbug.com/kubernetes-source-code-how-hpa-work/</guid><description>
&lt;p>HPA - Horizontal Pod Autoscaler çš„ç¼©å†™ï¼ŒPod æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ã€‚é€šè¿‡å¯¹ Pod è´Ÿè½½çš„ç›‘æ§ï¼Œæ¥è‡ªåŠ¨å¢åŠ æˆ–è€…å‡å°‘ Pod çš„å‰¯æœ¬æ•°é‡ã€‚&lt;/p>
&lt;p>ä»å­—é¢æ„æ€æ¥çœ‹ï¼Œå…¶ä¸»è¦åŒ…å«äº†ä¸¤éƒ¨åˆ†ï¼š&lt;/p>
&lt;ul>
&lt;li>ç›‘æ§ Pod çš„è´Ÿè½½&lt;/li>
&lt;li>æ§åˆ¶ Pod çš„å‰¯æœ¬æ•°é‡&lt;/li>
&lt;/ul>
&lt;p>é‚£å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿä»¥ä¸‹åŸºäº1.17 æºç ï¼Œæ¥åˆ†æä¸‹ HPA å¦‚ä½•å·¥ä½œã€‚&lt;/p>
&lt;p>&lt;strong>æ³¨æ„ï¼šæ–‡ç« ä¸­çš„ä»£ç åœ¨æºç çš„åŸºç¡€ä¸Šè¿›è¡Œäº†ç²¾ç®€ï¼šåˆ æ‰äº†æ³¨é‡Šã€åºåˆ—åŒ–ç­‰ä¿¡æ¯ï¼Œæˆ–ä¿ç•™äº†éƒ¨åˆ†æ ¸å¿ƒä»£ç ï¼ŒåŠ ä¸Šæ–°çš„æ³¨é‡Šã€‚&lt;/strong>&lt;/p>
&lt;h2 id="èµ„æº">èµ„æº&lt;/h2>
&lt;p>HPA çš„èµ„æºæ˜¯&lt;code>HorizontalPodAutoscaler&lt;/code>ï¼Œåœ¨&lt;code>v1&lt;/code>ç‰ˆæœ¬ä¸­ï¼Œåªæ”¯æŒåŸºäº CPU æŒ‡æ ‡çš„è®¡ç®—ï¼›åœ¨&lt;code>v2beta2&lt;/code>ç‰ˆæœ¬ä¸­åŠ å…¥äº†åŸºäºå†…å­˜å’Œè‡ªå®šä¹‰æŒ‡æ ‡çš„è®¡ç®—ã€‚&lt;/p>
&lt;h3 id="v1">v1&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/api/autoscaling/v1/types.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscaler&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TypeMeta&lt;/span>
&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span>
&lt;span class="nx">Spec&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span>
&lt;span class="nx">Status&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerStatus&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ScaleTargetRef&lt;/span> &lt;span class="nx">CrossVersionObjectReference&lt;/span> &lt;span class="c1">//ç›‘æ§çš„ç›®æ ‡èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">MinReplicas&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span> &lt;span class="c1">//æœ€å°å‰¯æœ¬æ•°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">MaxReplicas&lt;/span> &lt;span class="kt">int32&lt;/span> &lt;span class="c1">//æœ€å¤§å‰¯æœ¬æ•°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">TargetCPUUtilizationPercentage&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span> &lt;span class="c1">//è§¦å‘è°ƒæ•´çš„CPU ä½¿ç”¨ç‡
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="v2">v2&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/api/autoscaling/v2beta2/types.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscaler&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TypeMeta&lt;/span>
&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span>
&lt;span class="nx">Spec&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span>
&lt;span class="nx">Status&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerStatus&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ScaleTargetRef&lt;/span> &lt;span class="nx">CrossVersionObjectReference&lt;/span> &lt;span class="c1">//ç›‘æ§çš„ç›®æ ‡èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">MinReplicas&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span>
&lt;span class="nx">MaxReplicas&lt;/span> &lt;span class="kt">int32&lt;/span>
&lt;span class="nx">Metrics&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">MetricSpec&lt;/span> &lt;span class="c1">//æ–°åŠ å…¥çš„è‡ªå®šä¹‰æŒ‡æ ‡
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">MetricSpec&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Type&lt;/span> &lt;span class="nx">MetricSourceType&lt;/span> &lt;span class="c1">//æŒ‡æ ‡æºçš„ç±»å‹ï¼šObjectï¼ˆåŸºäºæŸä¸ªå¯¹è±¡ï¼‰ã€Podsï¼ˆåŸºäºpod æ•°ï¼‰ã€Resourceï¼ˆåŸºäºèµ„æºä½¿ç”¨è®¡ç®—ï¼Œæ¯”å¦‚v1 ç‰ˆæœ¬ä¸­cpuï¼‰ã€Externalï¼ˆåŸºäºå¤–éƒ¨çš„æŒ‡æ ‡ï¼‰ã€‚å¯¹åº” MetricsClient æ¥å£çš„å››ä¸ªæ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Object&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ObjectMetricSource&lt;/span> &lt;span class="c1">//å¯¹åº” Object ç±»å‹çš„æŒ‡æ ‡æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Pods&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PodsMetricSource&lt;/span> &lt;span class="c1">//å¯¹åº” Pod ç±»å‹çš„æŒ‡æ ‡æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Resource&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ResourceMetricSource&lt;/span> &lt;span class="c1">//å¯¹åº” Resource ç±»å‹çš„æŒ‡æ ‡æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">External&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExternalMetricSource&lt;/span> &lt;span class="c1">//å¯¹åº” External ç±»å‹çš„æŒ‡æ ‡æº
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">ObjectMetricSource&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">DescribedObject&lt;/span> &lt;span class="nx">CrossVersionObjectReference&lt;/span> &lt;span class="c1">//ç›®æ ‡å¯¹è±¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Target&lt;/span> &lt;span class="nx">MetricTarget&lt;/span> &lt;span class="c1">//æŒ‡å®šæŒ‡æ ‡çš„ç›®æ ‡å€¼ã€å¹³å‡å€¼æˆ–è€…å¹³å‡ä½¿ç”¨ç‡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Metric&lt;/span> &lt;span class="nx">MetricIdentifier&lt;/span> &lt;span class="c1">//æŒ‡æ ‡æ ‡è¯†ï¼šåå­—ã€labelé€‰æ‹©å™¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">PodsMetricSource&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Metric&lt;/span> &lt;span class="nx">MetricIdentifier&lt;/span>
&lt;span class="nx">Target&lt;/span> &lt;span class="nx">MetricTarget&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">ResourceMetricSource&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span> &lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResourceName&lt;/span>
&lt;span class="nx">Target&lt;/span> &lt;span class="nx">MetricTarget&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">ExternalMetricSource&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Metric&lt;/span> &lt;span class="nx">MetricIdentifier&lt;/span>
&lt;span class="nx">Target&lt;/span> &lt;span class="nx">MetricTarget&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">MetricTarget&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Type&lt;/span> &lt;span class="nx">MetricTargetType&lt;/span> &lt;span class="c1">//ç±»å‹ï¼šUtilizationã€Valueã€AverageValue
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">resource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Quantity&lt;/span>
&lt;span class="nx">AverageValue&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">resource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Quantity&lt;/span>
&lt;span class="nx">AverageUtilization&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ§åˆ¶å™¨-horizontalcontroller">æ§åˆ¶å™¨ &lt;code>HorizontalController&lt;/code>&lt;/h2>
&lt;p>&lt;code>HorizontalController&lt;/code>è¢«é€šè¿‡ key &lt;code>horizontalpodautoscaling&lt;/code> åŠ å…¥åˆ° controller manager ä¸­ã€‚ç”¨æ¥æ§åˆ¶&lt;code>HorizontalPodAutoscaler&lt;/code>å®ä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">///cmd/kube-controller-manager/app/controllermanager.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewControllerInitializers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">loopMode&lt;/span> &lt;span class="nx">ControllerLoopMode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">InitFunc&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="nx">controllers&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;horizontalpodautoscaling&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">startHPAController&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è·å–è´Ÿè½½æŒ‡æ ‡">è·å–è´Ÿè½½æŒ‡æ ‡&lt;/h3>
&lt;p>æ—¢ç„¶ Pod å‰¯æœ¬æ•°é‡çš„è®¡ç®—æ˜¯åŸºäº Pod çš„è´Ÿè½½æƒ…å†µï¼Œé‚£è¾¹éœ€è¦é€”å¾„è·å–è´Ÿè½½æ•°æ®ï¼Œè¿™ä¸ªé€”å¾„å°±æ˜¯&lt;code>MetricsClient&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>MetricsClient&lt;/code>æœ‰ä¸¤ç§å®ç°ï¼šREST æ–¹å¼å’Œä¼ ç»Ÿï¼ˆLegacyï¼‰æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯&lt;code>restMetricsClient&lt;/code>å’Œ&lt;code>HeapsterMetricsClient&lt;/code>ã€‚ä¸€ä¸ªæ˜¯REST å®ç°ä»¥æ”¯æŒè‡ªå®šä¹‰çš„æŒ‡æ ‡ï¼›ä¸€ä¸ªæ˜¯ä¼ ç»Ÿçš„ Heapster æŒ‡æ ‡ï¼ˆheapster å·²ç»ä» 1.13 ç‰ˆæœ¬å¼€å§‹è¢«åºŸå¼ƒäº†ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//cmd/kube-controller-manager/app/autoscaling.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">startHPAController&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">ControllerContext&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AvailableResources&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GroupVersionResource&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Group&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;autoscaling&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Version&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;v1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Resource&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;horizontalpodautoscalers&amp;#34;&lt;/span>&lt;span class="p">}]&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ComponentConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HPAController&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerUseRESTClients&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// use the new-style clients if support for custom metrics is enabled
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nf">startHPAControllerWithRESTClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">startHPAControllerWithLegacyClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ§åˆ¶å™¨é€»è¾‘horizontalcontrollerrun">æ§åˆ¶å™¨é€»è¾‘&lt;code>HorizontalController#Run()&lt;/code>&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//pkg/controller/podautoscaler/horizontal.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleCrash&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ShutDown&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Starting HPA controller&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Shutting down HPA controller&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// ç­‰å¾… informer å®ŒæˆHorizontalPodAutoscalerç›¸å…³äº‹ä»¶çš„åŒæ­¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WaitForNamedCacheSync&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;HPA&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stopCh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">hpaListerSynced&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">podListerSynced&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// start a single worker (we may wish to start more in the future)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//æ‰§è¡Œ worker é€»è¾‘ï¼Œç›´åˆ°æ”¶åˆ°é€€å‡ºæŒ‡ä»¤
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">go&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Until&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">worker&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stopCh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">stopCh&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>worker&lt;/code>çš„æ ¸å¿ƒæ˜¯ä»å·¥ä½œé˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ª keyï¼ˆæ ¼å¼ä¸ºï¼šnamespace/nameï¼‰ï¼Œç„¶åå¯¹ key è¿›è¡Œ reconcileï¼ˆè¿™ä¸ªè¯æ˜¯Kubernetes çš„æ ¸å¿ƒï¼Œç¿»è¯‘ä¸ºâ€œè°ƒå’Œâ€ã€â€œå’Œè§£â€ã€‚ä¸ªäººæ›´å–œæ¬¢â€œè°ƒæ•´â€ï¼Œå³&lt;strong>å°†å®ä¾‹çš„çŠ¶æ€è°ƒæ•´ä¸ºæœŸæœ›çš„çŠ¶æ€&lt;/strong>ã€‚æ­¤å¤„ï¼Œå¯¹äº hpa çš„å®ä¾‹çš„æ¯ä¸ªäº‹ä»¶ï¼Œéƒ½ä¼šæŒ‰ç…§ç‰¹å®šçš„é€»è¾‘è°ƒæ•´ç›®æ ‡å®ä¾‹çš„ Pod çš„å‰¯æœ¬æ•°é‡ã€‚ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//pkg/controller/podautoscaler/horizontal.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">worker&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">processNextWorkItem&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;horizontal pod autoscaler controller worker shutting down&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">processNextWorkItem&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">quit&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">quit&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">deleted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">reconcileKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">deleted&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddRateLimited&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹ key è¿›è¡Œ reconcile çš„è°ƒç”¨æ ˆï¼š&lt;code>HorizontalController#reconcileKey -&amp;gt; HorizontalController#reconcileAutoscaler -&amp;gt; HorizontalController#computeReplicasForMetrics -&amp;gt; ScaleInterface#Update&lt;/code>&lt;/p>
&lt;p>ç®€å•æ¥è¯´å°±æ˜¯å…ˆä»&lt;code>Informer&lt;/code>ä¸­æ‹¿åˆ° key å¯¹åº”çš„&lt;code>HorizontalPodAutoscaler&lt;/code>èµ„æºå®ä¾‹ï¼›ç„¶åé€šè¿‡&lt;code>HorizontalPodAutoscaler&lt;/code>å®ä¾‹ä¸­çš„ä¿¡æ¯ï¼Œæ£€æŸ¥ç›®æ ‡èµ„æºçš„Pod è´Ÿè½½ä»¥åŠå½“å‰çš„å‰¯æœ¬æ•°ï¼Œå¾—åˆ°æœŸæœ›çš„ Pod å‰¯æœ¬æ•°ï¼›æœ€ç»ˆé€šè¿‡ Scale API æ¥è°ƒæ•´ Pod çš„å‰¯æœ¬æ•°ã€‚æœ€åä¼šå°†è°ƒæ•´çš„åŸå› ã€è®¡ç®—çš„ç»“æœç­‰ä¿¡æ¯å†™å…¥&lt;code>HorizontalPodAutoscaler&lt;/code>å®ä¾‹çš„ condition ä¸­ã€‚&lt;/p>
&lt;h3 id="è®¡ç®—æœŸæœ›çš„å‰¯æœ¬æ•°">è®¡ç®—æœŸæœ›çš„å‰¯æœ¬æ•°&lt;/h3>
&lt;p>å¯¹æ¯ä¸ªæŒ‡æ ‡è¿›è¡Œè®¡ç®—ï¼Œéƒ½ä¼šå¾—åˆ°å»ºè®®çš„å‰¯æœ¬æ•°ï¼Œç„¶åæœ€å¤§çš„é‚£ä¸ªå°±æ˜¯æœ€ç»ˆçš„æœŸæœ›å‰¯æœ¬æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//pkg/controller/podautoscaler/horizontal.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">computeReplicasForMetrics&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hpa&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">autoscalingv2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscaler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scale&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">autoscalingv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Scale&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">metricSpecs&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">autoscalingv2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MetricSpec&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">replicas&lt;/span> &lt;span class="kt">int32&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metric&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">statuses&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">autoscalingv2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MetricStatus&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">timestamp&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">......&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricSpec&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">metricSpecs&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">replicaCountProposal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricNameProposal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">timestampProposal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">condition&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">computeReplicasForMetric&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hpa&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricSpec&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">specReplicas&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">statusReplicas&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">selector&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">statuses&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">invalidMetricsCount&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">invalidMetricCondition&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">condition&lt;/span>
&lt;span class="nx">invalidMetricError&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">invalidMetricsCount&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">replicas&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">replicaCountProposal&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="nx">replicas&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">timestamp&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">timestampProposal&lt;/span>
&lt;span class="nx">replicas&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">replicaCountProposal&lt;/span>
&lt;span class="nx">metric&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">metricNameProposal&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">......&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>#computeStatusForObjectMetric&lt;/code>ï¼ˆæ³¨æ„è¿™ä¸ªæ–¹æ³•åå°‘äº†ä¸ª &amp;ldquo;s&amp;rdquo;ï¼‰ä½¿ç”¨&lt;code>MetricsClient&lt;/code>å¾—åˆ°æŒ‡å®šæŒ‡æ ‡çš„å€¼ã€‚&lt;/p>
&lt;p>è¿™ä¸ªæµç¨‹çš„ç»†èŠ‚è¿˜å¯ä»¥ç»§ç»­æ·±æŒ–ï¼Œä½†åˆ°æ­¤å·²å¤Ÿæˆ‘ä»¬ç†è§£ HPAâ€‹ çš„å®ç°æ–¹å¼äº†ã€‚â€‹&lt;/p></description></item><item><title>Tekton çš„å·¥ä½œåŸç†</title><link>https://atbug.com/how-tekton-works/</link><pubDate>Sat, 23 May 2020 22:47:14 +0800</pubDate><guid>https://atbug.com/how-tekton-works/</guid><description>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/24/tekton.jpeg" alt="tekton">&lt;/p>
&lt;p>&lt;em>è¿™ç¯‡æ–‡ç« æ˜¯åŸºäº Tekton Pipeline çš„æœ€æ–°ç‰ˆæœ¬&lt;code>v0.12.1&lt;/code>ç‰ˆæœ¬ã€‚&lt;/em>&lt;/p>
&lt;p>å¿«é€Ÿå…¥é—¨è¯·å‚è€ƒï¼š&lt;a href="https://atbug.com/tekton-trigger-practice/">äº‘åŸç”Ÿ CICD: Tekton Pipeline å®æˆ˜&lt;/a> ï¼Œ&lt;em>å®æˆ˜æ˜¯åŸºäºç‰ˆæœ¬ v0.10.x&lt;/em>ã€‚&lt;/p>
&lt;h2 id="pipeline-crd-ä¸æ ¸å¿ƒèµ„æºçš„å…³ç³»">Pipeline CRD ä¸æ ¸å¿ƒèµ„æºçš„å…³ç³»&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ k api-resources --api-group&lt;span class="o">=&lt;/span>tekton.dev
NAME SHORTNAMES APIGROUP NAMESPACED KIND
clustertasks tekton.dev &lt;span class="nb">false&lt;/span> ClusterTask
conditions tekton.dev &lt;span class="nb">true&lt;/span> Condition
pipelineresources tekton.dev &lt;span class="nb">true&lt;/span> PipelineResource
pipelineruns pr,prs tekton.dev &lt;span class="nb">true&lt;/span> PipelineRun
pipelines tekton.dev &lt;span class="nb">true&lt;/span> Pipeline
taskruns tr,trs tekton.dev &lt;span class="nb">true&lt;/span> TaskRun
tasks tekton.dev &lt;span class="nb">true&lt;/span> Task
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Tekton Pipelinesæä¾›äº†ä¸Šé¢çš„CRDï¼Œå…¶ä¸­éƒ¨åˆ†CRDä¸k8s coreä¸­èµ„æºç›¸å¯¹åº”&lt;/p>
&lt;ul>
&lt;li>Task =&amp;gt; Pod&lt;/li>
&lt;li>Task.Step =&amp;gt; Container&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/15902164552270.jpg" alt="">&lt;/p>
&lt;h2 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/15902280074872.jpg" alt="">
(å›¾ç‰‡æ¥è‡ª)&lt;/p>
&lt;p>Tekton Pipeline æ˜¯åŸºäº Knative çš„å®ç°ï¼Œpod &lt;code>tekton-pipelines-controller&lt;/code> ä¸­æœ‰ä¸¤ä¸ª &lt;a href="https://knative.dev/docs/eventing/samples/writing-receive-adapter-source/03-controller/">Knative Controller&lt;/a>çš„å®ç°ï¼šPipelineRun å’Œ TaskRunã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/15902270934199.jpg" alt="">&lt;/p>
&lt;h3 id="taskçš„æ‰§è¡Œé¡ºåº">Taskçš„æ‰§è¡Œé¡ºåº&lt;/h3>
&lt;p>PipelineRun Controller çš„ &lt;code>#reconcile()&lt;/code>æ–¹æ³•ï¼Œç›‘æ§åˆ°æœ‰&lt;code>PipelineRun&lt;/code>è¢«åˆ›å»ºã€‚ç„¶åä»&lt;code>PipelineSpec&lt;/code>çš„ tasks åˆ—è¡¨ï¼Œæ„å»ºå‡ºä¸€ä¸ªå›¾ï¼ˆ&lt;code>graph&lt;/code>ï¼‰ï¼Œç”¨äºæè¿°&lt;code>Pipeline&lt;/code>ä¸­ Task é—´çš„ä¾èµ–å…³ç³»ã€‚ä¾èµ–å…³ç³»æ˜¯é€šè¿‡&lt;code>runAfter&lt;/code>å’Œ&lt;code>from&lt;/code>ï¼Œè¿›è€Œæ§åˆ¶&lt;a href="#Task%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F">Taskçš„æ‰§è¡Œé¡ºåº&lt;/a>ã€‚ä¸æ­¤åŒæ—¶ï¼Œå‡†å¤‡&lt;code>PipelineRun&lt;/code>ä¸­å®šä¹‰çš„&lt;code>PipelineResources&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Node represents a Task in a pipeline.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Node&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Task represent the PipelineTask in Pipeline
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Task&lt;/span> &lt;span class="nx">Task&lt;/span>
&lt;span class="c1">// Prev represent all the Previous task Nodes for the current Task
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Prev&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Node&lt;/span>
&lt;span class="c1">// Next represent all the Next task Nodes for the current Task
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Next&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Node&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Graph represents the Pipeline Graph
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Graph&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//Nodes represent map of PipelineTask name to Node in Pipeline Graph
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Nodes&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Node&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Build&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tasks&lt;/span> &lt;span class="nx">Tasks&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Graph&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>PipelineRun&lt;/code>ä¸­å®šä¹‰çš„å‚æ•°ï¼ˆparametersï¼‰ä¹Ÿä¼šæ³¨å…¥åˆ°&lt;code>PipelineSpec&lt;/code>ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">pipelineSpec&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">resources&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ApplyParameters&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pipelineSpec&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨&lt;code>dag#GetSchedulable()&lt;/code>æ–¹æ³•ï¼Œè·å–æœªå®Œæˆï¼ˆé€šè¿‡TaskçŠ¶æ€åˆ¤æ–­ï¼‰çš„ Task åˆ—è¡¨ï¼›&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">GetSchedulable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Graph&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">doneTasks&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">struct&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸º Task A åˆ›å»º&lt;code>TaskRun&lt;/code>ï¼Œå‡å¦‚&lt;code>Task&lt;/code>é…ç½®äº†&lt;code>Condition&lt;/code>ã€‚ä¼šå…ˆä¸º conditionåˆ›å»ºä¸€ä¸ª&lt;code>TaskRun&lt;/code>ï¼Œåªæœ‰åœ¨ condition çš„&lt;code>TaskRun&lt;/code>è¿è¡ŒæˆåŠŸï¼Œæ‰ä¼šè¿è¡Œ A çš„&lt;code>TaskRun&lt;/code>ï¼›å¦åˆ™å°±è·³è¿‡ã€‚&lt;/p>
&lt;h3 id="stepçš„æ‰§è¡Œé¡ºåº">Stepçš„æ‰§è¡Œé¡ºåº&lt;/h3>
&lt;p>è¿™ä¸€éƒ¨åˆ†ç¯‡å¹…è¾ƒé•¿ï¼Œä¹‹å‰çš„æ–‡ç«  &lt;a href="https://atbug.com/control-process-order-of-pod-containers/">æ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº&lt;/a> ä¸­æåˆ°è¿‡ã€‚&lt;/p>
&lt;p>è¿™é‡Œè¡¥å……ä¸€ä¸‹&lt;a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/#the-downward-api">Kubernetes Downward API&lt;/a>çš„ä½¿ç”¨ï¼ŒKubernetes Downward APIçš„å¼•å…¥ï¼Œæ§åˆ¶ç€ &lt;code>Task&lt;/code> çš„ç¬¬ä¸€ä¸ª &lt;code>Step&lt;/code> åœ¨ä½•æ—¶æ‰§è¡Œã€‚&lt;/p>
&lt;p>&lt;code>TaskRun&lt;/code> Controller åœ¨ reconciling çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨ç›¸åº”çš„ &lt;code>Pod&lt;/code> çŠ¶æ€å˜ä¸º&lt;code>Running&lt;/code>æ—¶ï¼Œä¼šå°†&lt;code>tekton.dev/ready=READY&lt;/code>å†™å…¥åˆ° Pod çš„ annotation ä¸­ï¼Œæ¥é€šçŸ¥ç¬¬ä¸€ä¸ª&lt;code>Step&lt;/code>çš„æ‰§è¡Œã€‚&lt;/p>
&lt;p>Podçš„éƒ¨åˆ†å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">wait_file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/downward/ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">wait_file_content&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">post_file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/tools/0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">termination_path&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/termination&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/ko-app/git-init&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- --&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ssh://git@gitlab.nip.io:8022/addozhang/logan-pulse.git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">develop&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">path&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/workspace/git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/tools/entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/tekton/downward&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-internal-downward&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">downwardAPI&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">defaultMode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">420&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">items&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">fieldRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">metadata.annotations[&amp;#39;tekton.dev/ready&amp;#39;]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-internal-downward&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹åŸç”Ÿçš„æ’åºstep containerè¿›ä¸€æ­¥å¤„ç†ï¼šå¯åŠ¨å‘½ä»¤ä½¿ç”¨&lt;code>entrypoint&lt;/code>æä¾›ï¼Œå¹¶è®¾ç½®æ‰§è¡Œå‚æ•°ï¼š&lt;/p>
&lt;p>&lt;code>entrypoint.go&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">orderContainers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">entrypointImage&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">steps&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">results&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">v1alpha1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TaskResult&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">initContainer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;place-tools&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Image&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">entrypointImage&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Command&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;cp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;/ko-app/entrypoint&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">entrypointBinary&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="nx">VolumeMounts&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumeMount&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">toolsMount&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">steps&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;No steps specified&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">steps&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">argsForEntrypoint&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">argsForEntrypoint&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="c1">// First step waits for the Downward volume file.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="s">&amp;#34;-wait_file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">downwardMountPoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">downwardMountReadyFile&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="s">&amp;#34;-wait_file_content&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// Wait for file contents, not just an empty file.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// Start next step.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="s">&amp;#34;-post_file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mountPoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="s">&amp;#34;-termination_path&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">terminationPath&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1">// All other steps wait for previous file, write next file.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">argsForEntrypoint&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="s">&amp;#34;-wait_file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mountPoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="s">&amp;#34;-post_file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mountPoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="s">&amp;#34;-termination_path&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">terminationPath&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è‡ªåŠ¨è¿è¡Œçš„å®¹å™¨">è‡ªåŠ¨è¿è¡Œçš„å®¹å™¨&lt;/h3>
&lt;p>è¿™äº›è‡ªåŠ¨è¿è¡Œçš„å®¹å™¨ä½œä¸º pod çš„&lt;code>initContainer&lt;/code>ä¼šåœ¨ step å®¹å™¨è¿è¡Œä¹‹å‰è¿è¡Œ&lt;/p>
&lt;h4 id="credential-initializer">&lt;code>credential-initializer&lt;/code>&lt;/h4>
&lt;p>ç”¨äºå°† &lt;code>ServiceAccount&lt;/code> çš„ç›¸å…³secretsæŒä¹…åŒ–åˆ°å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚æ¯”å¦‚ ssh ç›¸å…³ç§˜é’¥ã€configæ–‡ä»¶ä»¥åŠknow_hostsæ–‡ä»¶ï¼›docker registry ç›¸å…³çš„å‡­è¯åˆ™ä¼šè¢«å†™å…¥åˆ° docker çš„é…ç½®æ–‡ä»¶ä¸­ã€‚&lt;/p>
&lt;h4 id="working-dir-initializer">&lt;code>working-dir-initializer&lt;/code>&lt;/h4>
&lt;p>æ”¶é›†&lt;code>Task&lt;/code>å†…çš„å„ä¸ª&lt;code>Step&lt;/code>çš„&lt;code>workingDir&lt;/code>é…ç½®ï¼Œåˆå§‹åŒ–ç›®å½•ç»“æ„&lt;/p>
&lt;h4 id="place-scripts">&lt;code>place-scripts&lt;/code>&lt;/h4>
&lt;p>å‡å¦‚&lt;code>Step&lt;/code>ä½¿ç”¨çš„æ˜¯&lt;code>script&lt;/code>é…ç½®ï¼ˆä¸command+argsç›¸å¯¹ï¼‰ï¼Œè¿™ä¸ªå®¹å™¨ä¼šå°†è„šæœ¬ä»£ç ï¼ˆ&lt;code>script&lt;/code>å­—æ®µçš„å†…å®¹ï¼‰æŒä¹…åŒ–åˆ°&lt;code>/tekton/scripts&lt;/code>ç›®å½•ä¸­ã€‚&lt;/p>
&lt;p>æ³¨ï¼šæ‰€æœ‰çš„è„šæœ¬ä¼šè‡ªåŠ¨åŠ ä¸Š&lt;code>#!/bin/sh\nset -xe\n&lt;/code>ï¼Œæ‰€ä»¥&lt;code>script&lt;/code>å­—æ®µé‡Œå°±ä¸å¿…å†™äº†ã€‚&lt;/p>
&lt;h4 id="place-tools">&lt;code>place-tools&lt;/code>&lt;/h4>
&lt;p>å°†&lt;code>entrypoint&lt;/code>çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¤åˆ¶åˆ°&lt;code>/tekton/tools/entrypoint&lt;/code>.&lt;/p>
&lt;h3 id="taskstepé—´çš„æ•°æ®ä¼ é€’">Task/Stepé—´çš„æ•°æ®ä¼ é€’&lt;/h3>
&lt;p>é’ˆå¯¹ä¸åŒçš„æ•°æ®ï¼Œæœ‰å¤šç§ä¸åŒçš„é€‰æ‹©ã€‚æ¯”å¦‚&lt;code>Workspace&lt;/code>ã€&lt;code>Result&lt;/code>ã€&lt;code>PipelineResource&lt;/code>ã€‚å¯¹äºç”±äº&lt;code>Task&lt;/code>çš„æ‰§è¡Œæ˜¯é€šè¿‡&lt;code>Pod&lt;/code>æ¥å®Œæˆçš„ï¼Œè€Œ&lt;code>Pod&lt;/code>ä¼šè°ƒåº¦åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šã€‚å› æ­¤&lt;code>Task&lt;/code>é—´çš„æ•°æ®ä¼ é€’ï¼Œéœ€è¦ç”¨åˆ°æŒä¹…åŒ–çš„å·ã€‚&lt;/p>
&lt;p>è€Œ&lt;code>Step&lt;/code>ä½œä¸º&lt;code>Pod&lt;/code>ä¸­çš„å®¹å™¨æ¥è¿è¡Œï¼Œ&lt;/p>
&lt;h4 id="workspace">Workspace&lt;/h4>
&lt;p>å·¥ä½œåŒºï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæŒ‚åœ¨åˆ°å®¹å™¨ä¸Šçš„å·ï¼Œç”¨äºæ–‡ä»¶çš„ä¼ é€’ã€‚&lt;/p>
&lt;h5 id="persistentvolumeclaim">&lt;code>persistentVolumeClaim&lt;/code>&lt;/h5>
&lt;p>å¼•ç”¨å·²å­˜åœ¨&lt;code>persistentVolumeClaim&lt;/code>å·ï¼ˆvolumeï¼‰ã€‚è¿™ç§å·¥ä½œç©ºé—´ï¼Œå¯å¤šæ¬¡ä½¿ç”¨ï¼Œéœ€è¦å…ˆè¿›è¡Œåˆ›å»ºã€‚æ¯”å¦‚ Java é¡¹ç›®çš„ &lt;code>maven&lt;/code>ï¼Œç¼–è¯‘éœ€è¦æœ¬åœ°ä¾èµ–åº“ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœæ¯æ¬¡ç¼–è¯‘éƒ½è¦ä¸‹è½½ä¾èµ–åŒ…çš„æˆæœ¬ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeClaim&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">claimName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2-pv-claim&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolume&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2-pv&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">local&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">manual&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">capacity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">10Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteMany&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/data/.m2&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolumeClaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2-pv-claim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">manual&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># volumeName: m2-pv&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteMany&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">10Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="volumeclaimtemplate">&lt;code>volumeClaimTemplate&lt;/code>&lt;/h5>
&lt;p>ä¸ºæ¯ä¸ª&lt;code>PipelineRun&lt;/code>æˆ–è€…&lt;code>TaskRun&lt;/code>åˆ›å»º&lt;code>PersistentVolumeClaim&lt;/code>å·ï¼ˆvolumeï¼‰çš„æ¨¡æ¿ã€‚æ¯”å¦‚ä¸€æ¬¡æ„å»ºéœ€è¦ä» git ä»“åº“å…‹éš†ä»£ç ï¼Œè€Œé’ˆå¯¹ä¸åŒçš„æµæ°´çº¿ä»£ç ä»“åº“æ˜¯ä¸åŒçš„ã€‚è¿™é‡Œå°±ä¼šç”¨åˆ°&lt;code>volumeClaimTemplate&lt;/code>ï¼Œä¸ºæ¯æ¬¡æ„å»ºåˆ›å»ºä¸€ä¸ª&lt;code>PersistentVolumeClaim&lt;/code>å·ã€‚ï¼ˆä»0.12.0å¼€å§‹ï¼‰&lt;/p>
&lt;p>ç”Ÿå‘½å‘¨æœŸåŒ&lt;code>PipelineRun&lt;/code>æˆ–è€…&lt;code>TaskRun&lt;/code>ï¼Œè¿è¡Œä¹‹åé‡Šæ”¾ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeClaimTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteMany&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">1Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç›¸è¾ƒäº&lt;code>persistantVolumeClain&lt;/code>ç±»å‹çš„workspaceï¼Œ&lt;code>volumeClaimTemplate&lt;/code>ä¸éœ€è¦åœ¨æ¯æ¬¡åœ¨&lt;code>PipelineRun&lt;/code>å®Œæˆåæ¸…ç†å·¥ä½œåŒºï¼›å¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚&lt;/p>
&lt;h5 id="emptydir">&lt;code>emptyDir&lt;/code>&lt;/h5>
&lt;p>å¼•ç”¨&lt;code>emptyDir&lt;/code>å·ï¼Œè·Ÿéš&lt;code>Task&lt;/code>ç”Ÿå‘½å‘¨æœŸçš„ä¸´æ—¶ç›®å½•ã€‚é€‚åˆåœ¨&lt;code>Task&lt;/code>çš„&lt;code>Step&lt;/code>é—´å…±äº«æ•°æ®ï¼Œæ— æ³•åœ¨å¤šä¸ª&lt;code>Task&lt;/code>é—´å…±äº«ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">temp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">emptyDir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="configmap">&lt;code>configMap&lt;/code>&lt;/h5>
&lt;p>å¼•ç”¨ä¸€ä¸ª&lt;code>configMap&lt;/code>å·ï¼Œå°†&lt;code>configMap&lt;/code>å·ä½œä¸ºå·¥ä½œåŒºï¼Œæœ‰å¦‚ä¸‹é™åˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>æŒ‚è½½çš„å·æ˜¯&lt;code>åªè¯»&lt;/code>çš„&lt;/li>
&lt;li>éœ€è¦æå‰åˆ›å»º&lt;code>configMap&lt;/code>&lt;/li>
&lt;li>&lt;code>configMap&lt;/code>çš„&lt;a href="https://github.com/kubernetes/kubernetes/blob/f16bfb069a22241a5501f6fe530f5d4e2a82cf0e/pkg/apis/core/validation/validation.go#L5042">å¤§å°é™åˆ¶ä¸º1MBï¼ˆK8sçš„é™åˆ¶ï¼‰&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ä½¿ç”¨åœºæ™¯ï¼Œæ¯”å¦‚ä½¿ç”¨&lt;code>maven&lt;/code>ç¼–è¯‘Javaé¡¹ç›®ï¼Œé…ç½®æ–‡ä»¶&lt;code>settings.xml&lt;/code>å¯ä»¥ä½¿ç”¨&lt;code>configMap&lt;/code>ä½œä¸ºå·¥ä½œåŒº&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven-settings&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">configmap&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven-settings&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="secret">&lt;code>secret&lt;/code>&lt;/h5>
&lt;p>ç”¨äºå¼•ç”¨&lt;code>secret&lt;/code>å·ï¼ŒåŒ&lt;code>configMap&lt;/code>å·¥ä½œåŒºä¸€æ ·ï¼Œä¹Ÿæœ‰é™åˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>æŒ‚è½½çš„å·æ˜¯&lt;code>åªè¯»&lt;/code>çš„&lt;/li>
&lt;li>éœ€è¦æå‰åˆ›å»º&lt;code>secret&lt;/code>&lt;/li>
&lt;li>&lt;code>secret&lt;/code>çš„&lt;a href="https://github.com/kubernetes/kubernetes/blob/f16bfb069a22241a5501f6fe530f5d4e2a82cf0e/pkg/apis/core/validation/validation.go#L5042">å¤§å°é™åˆ¶ä¸º1MBï¼ˆK8sçš„é™åˆ¶ï¼‰&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="result">Result&lt;/h4>
&lt;p>&lt;code>results&lt;/code>å­—æ®µå¯ä»¥ç”¨æ¥é…ç½®å¤šä¸ªæ–‡ä»¶ç”¨æ¥å­˜å‚¨&lt;code>Tasks&lt;/code>çš„æ‰§è¡Œç»“æœï¼Œè¿™äº›æ–‡ä»¶ä¿å­˜åœ¨&lt;code>/tekton/results&lt;/code>ç›®å½•ä¸­ã€‚&lt;/p>
&lt;p>åœ¨&lt;code>Pipeline&lt;/code>ä¸­ï¼Œå¯ä»¥é€šè¿‡&lt;code>tasks.[task-nanme].results.[result-name]&lt;/code>æ³¨å…¥åˆ°å…¶ä»–&lt;code>Task&lt;/code>çš„å‚æ•°ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Task&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">A simple task that prints the date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">results&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-unix-timestamp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The current date in unix timestamp format&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-human-readable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The current date in human readable format&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date-unix-timestamp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">bash:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> #!/usr/bin/env bash
&lt;/span>&lt;span class="sd"> date +%s | tee $(results.current-date-unix-timestamp.path)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date-humman-readable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">bash:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> #!/usr/bin/env bash
&lt;/span>&lt;span class="sd"> date | tee $(results.current-date-human-readable.path)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PipelineRun&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pass-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">pipelineSpec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">read-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">runAfter&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#é…ç½®æ‰§è¡Œé¡ºåº&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">print-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskSpec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-unix-timestamp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">string&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-human-readable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">string&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">read&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">busybox&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> echo $(params.current-date-unix-timestamp)
&lt;/span>&lt;span class="sd"> echo $(params.current-date-human-readable)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-unix-timestamp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(tasks.print-date.results.current-date-unix-timestamp)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># æ³¨å…¥å‚æ•°&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-human-readable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(tasks.print-date.results.current-date-human-readable)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># æ³¨å…¥å‚æ•° &lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">â”Œâ”€â”€â”€â”€â”€â”€Logs(tekton-pipelines/pass-date-read-date-rhlf2-pod-9b2sk)[all] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ place-scripts stream closed â”‚â”‚ step-read 1590242170 â”‚
â”‚ step-read Sat May 23 13:56:10 UTC 2020 â”‚â”‚ step-read + echo 1590242170 â”‚
â”‚ step-read + echo Sat May 23 13:56:10 UTC 2020 â”‚
â”‚ place-tools stream closed â”‚
â”‚ step-read stream closed â”‚
â”‚
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="pipelineresource">PipelineResource&lt;/h4>
&lt;p>&lt;code>PipelineResource&lt;/code>åœ¨æœ€åæï¼Œå› ä¸ºç›®å‰åªæ˜¯&lt;code>alpha&lt;/code>ç‰ˆæœ¬ï¼Œä½•æ—¶ä¼šè¿›å…¥&lt;code>beta&lt;/code>æˆ–è€…å¼ƒç”¨ç›®å‰è¿˜æ˜¯æœªçŸ¥æ•°ã€‚æœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸‹è¿™é‡Œï¼š&lt;a href="https://tekton.dev/docs/pipelines/resources/#why-aren-t-pipelineresources-in-beta">Why Arenâ€™t PipelineResources in Beta?&lt;/a>&lt;/p>
&lt;p>ç®€å•æ¥è¯´ï¼Œ&lt;code>PipelineResource&lt;/code>å¯ä»¥é€šè¿‡å…¶ä»–çš„æ–¹å¼å®ç°ï¼Œè€Œå…¶æœ¬èº«ä¹Ÿå­˜åœ¨å¼Šç«¯ï¼šæ¯”å¦‚å®ç°ä¸é€æ˜ï¼Œdebugæœ‰éš¾åº¦ï¼›åŠŸèƒ½ä¸å¤Ÿå¼ºï¼›é™ä½äº†Taskçš„é‡ç”¨æ€§ç­‰ã€‚&lt;/p>
&lt;p>æ¯”å¦‚&lt;code>git&lt;/code>ç±»å‹çš„&lt;code>PipelineResource&lt;/code>ï¼Œå¯ä»¥é€šè¿‡&lt;code>workspace&lt;/code>å’Œ&lt;code>git-clone&lt;/code> Taskæ¥å®ç°ï¼›å­˜å‚¨ç±»å‹çš„ï¼Œä¹Ÿå¯ä»¥é€šè¿‡&lt;code>workspace&lt;/code>æ¥å®ç°ã€‚&lt;/p>
&lt;p>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ&lt;a href="#Workspace">ä¸Šé¢ä»‹ç»workspaceçš„ç¯‡å¹…&lt;/a>æ¯”è¾ƒå¤§ã€‚ä¸ªäººä¹Ÿåå‘äºä½¿ç”¨&lt;code>workspace&lt;/code>ï¼Œçµæ´»åº¦é«˜ï¼›ä½¿ç”¨workspaceçš„Taské‡ç”¨æ€§å¼ºã€‚&lt;/p>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://atbug.com/tekton-trigger-practice">äº‘åŸç”Ÿ CICD: Tekton Pipeline å®æˆ˜&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://atbug.com/control-process-order-of-pod-containers">æ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://knative.dev/docs/eventing/samples/writing-receive-adapter-source/03-controller">Knative Controller&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tekton.dev/docs/pipelines/resources/#why-aren-t-pipelineresources-in-beta">Why Arenâ€™t PipelineResources in Beta?&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>æ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº</title><link>https://atbug.com/control-process-order-of-pod-containers/</link><pubDate>Thu, 12 Mar 2020 22:05:16 +0800</pubDate><guid>https://atbug.com/control-process-order-of-pod-containers/</guid><description>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/screenshot-20210430-at-092623.png" alt="">&lt;/p>
&lt;p>2021.4.30 æ›´æ–°ï¼š&lt;/p>
&lt;p>æœ€æ–°çš„æ–¹æ¡ˆï¼Œè¯·è·³è½¬æ–°ç¯‡ &lt;a href="https://mp.weixin.qq.com/s/8DqF_N_fjiM9AOouvddvgA">Kubernetes ä¸Šå¦‚ä½•æ§åˆ¶å®¹å™¨çš„å¯åŠ¨é¡ºåº&lt;/a>ã€‚&lt;/p>
&lt;hr>
&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>ä¼—æ‰€å‘¨çŸ¥, Kubernetes Pod å†…æœ‰ä¸¤ç§å®¹å™¨: åˆå§‹åŒ–å®¹å™¨(init container)å’Œåº”ç”¨å®¹å™¨(app container). å…¶ä¸­åˆå§‹åŒ–å®¹å™¨çš„æ‰§è¡Œå…ˆäºåº”ç”¨å®¹å™¨, å¹¶ä¸”åˆå§‹åŒ–å®¹å™¨å’Œåº”ç”¨å®¹å™¨çš„ä¸ªæ•°åˆ†åˆ«ä¸º &lt;code>0~n&lt;/code> å’Œ &lt;code>1~n&lt;/code>.&lt;/p>
&lt;p>åˆå§‹åŒ–å®¹å™¨ä¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œ, é¡ºåºæ‰§è¡Œçš„å‰ææ˜¯åˆå§‹åŒ–å®¹å™¨å§‹ç»ˆä¼šè¿è¡Œåˆ°å®Œæˆ(completed)çŠ¶æ€. è€Œåº”ç”¨å®¹å™¨æ°å¥½ç›¸å: å¯åŠ¨é¡ºåºéšæœº, å¹¶å§‹ç»ˆä¿æŒè¿è¡Œ(running)çŠ¶æ€.&lt;/p>
&lt;h2 id="é—®é¢˜">é—®é¢˜&lt;/h2>
&lt;p>å·¥ä½œä¸­æœ‰ä¸ªæ¶æ„çš„æ–¹æ¡ˆä½¿ç”¨åˆ°äº† sidecar å®¹å™¨: å°†åŸºç¡€ç»„ä»¶åŠŸèƒ½ä»å®¹å™¨è½¬ç§»åˆ° sidecar å®¹å™¨ä¸­, å…¶ä¸­æœ‰ä¸ªåŠŸèƒ½æ˜¯ä»è¿œç¨‹é…ç½®ä¸­å¿ƒè·å–é…ç½®å¹¶ä¿æŒå®æ—¶æ›´æ–°. ä¿è¯å®æ—¶æ›´æ–°æ²¡æœ‰é—®é¢˜, ä½†æ˜¯é…ç½®æ–‡ä»¶éœ€è¦åœ¨ app å¯åŠ¨ä¹‹å‰å®Œæˆåˆå§‹åŒ–.&lt;/p>
&lt;p>å¯¹äºåŒä¸º&amp;quot;åº”ç”¨å®¹å™¨&amp;quot;ç±»å‹çš„ sidecar å®¹å™¨æ¥è¯´, ç”±äºå®¹å™¨å¯åŠ¨é¡ºåºéšæœºè€Œæ— æ³•åšåˆ°è¿™ä¸€ç‚¹.&lt;/p>
&lt;p>å½“æ—¶æˆ‘ä»¬ç»™å®šçš„æ–¹æ¡ˆæ˜¯å¢åŠ ä¸€ä¸ªåˆå§‹åŒ–å®¹å™¨è¿›è¡Œé…ç½®çš„åˆå§‹åŒ–, ä¸å¯é¿å…çš„æˆ‘ä»¬éœ€è¦å¢åŠ ä¸€ä¸ªé¢å¤–çš„å®¹å™¨, å³ä½¿æ˜¯è¿™ä¸ªå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸéå¸¸çŸ­.&lt;/p>
&lt;p>è¿½æ±‚æè‡´çš„æˆ‘ä»¬æ€»æ˜¯å¯¹è¿™ä¸ªé¢å¤–å¢åŠ çš„å®¹å™¨è€¿è€¿äºæ€€: å‡å¦‚èƒ½æ§åˆ¶åº”ç”¨å®¹å™¨çš„å¯åŠ¨é¡ºåº&amp;hellip;&lt;/p>
&lt;h3 id="æ–°å‘ç°">æ–°å‘ç°&lt;/h3>
&lt;p>è¿‘æœŸåœ¨ç ”ç©¶ CDF (Continuous Delivery Foundation)ä¸‹çš„ &lt;a href="https://github.com/tektoncd">Tekton&lt;/a>, å…¶ä¸­æœ‰ä¸ªæ¦‚å¿µæ˜¯å…¶å°†æµæ°´çº¿(pipeline)ä¸­çš„å„ä¸ªæ­¥éª¤(step)ä½œä¸ºåº”ç”¨å®¹å™¨åœ¨åŒä¸€ä¸ª Pod ä¸­è¿è¡Œ.&lt;/p>
&lt;p>æˆ‘ä»¬éƒ½çŸ¥é“æµæ°´çº¿ä¸­çš„æ­¥éª¤æ˜¯æŒ‰ç…§å®šä¹‰çš„é¡ºåºæ‰§è¡Œçš„, é‚£ä¹ˆ Tekton æ˜¯å¦‚ä½•ä¿è¯åº”ç”¨å®¹å™¨çš„æ‰§è¡Œé¡ºåºçš„?&lt;/p>
&lt;p>æŸ¥çœ‹ pod çš„ manifest ä¹‹åå‘ç°äº†ä¸‹é¢çš„å®¹å™¨é…ç½® (è¿™ä¸ªå®¹å™¨çš„ä½œç”¨ä» git ä»“åº“å…‹éš†ä»£ç )&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">wait_file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/downward/ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">wait_file_content&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">post_file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/tools/0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">termination_path&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/termination&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/ko-app/git-init&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- --&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">http://gitlab.nip.io:8088/addozhang/tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">develop&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">path&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/workspace/git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/tools/entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…‹éš†ä»£ç çš„å‘½ä»¤æ˜¯:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">git-init -url http://gitlab.nip.io:8088/addozhang/tekton-test -revision develop -path /workspace/git-source
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯å®¹å™¨çš„å¯åŠ¨å‘½ä»¤æ˜¯&lt;code>/tekton/tools/entrypoint&lt;/code>å¹¶å¸¦ä¸Šäº†ä¸€å¨çš„å‚æ•°(æ­¤å¤„ç•¥è¿‡, åé¢åˆ†æ).&lt;/p>
&lt;p>ç¿»çœ‹äº†ä¸‹&lt;a href="https://github.com/tektoncd/pipeline/tree/master/cmd/entrypoint">æ–‡æ¡£&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>This binary is used to override the entrypoint of a container by wrapping it. In tektoncd/pipeline this is used to make sure Task&amp;rsquo;s steps are executed in order, or for sidecars.&lt;/p>
&lt;p>è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶è¢«ç”¨äºé€šè¿‡åŒ…è£…çš„æ–¹å¼æ¥è¦†ç›–å®¹å™¨çš„å…¥å£ç‚¹. åœ¨ tektoncd/pipeline ä¸­ç¡®ä¿ä»»åŠ¡ä¸­çš„æ­¥éª¤æˆ–è€… sidecar è¢«é¡ºåºåœ°æ‰§è¡Œ.&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>&lt;code>-entrypoint&lt;/code>: åŸå§‹çš„å®¹å™¨å¯åŠ¨å‘½ä»¤, ä½œä¸º &lt;code>entrypoint&lt;/code> çš„å­è¿›ç¨‹è¿è¡Œ. å³ä¸Šé¢çš„ &lt;code>git-init XXXX&lt;/code>&lt;/li>
&lt;li>&lt;code>-post_file&lt;/code>: å­è¿›ç¨‹è¿è¡Œç»“æŸåå†™çš„æ–‡ä»¶è·¯å¾„(å³ä¸Šé¢çš„&lt;code>/tekton/tools/0&lt;/code>). å¦‚æœå­è¿›ç¨‹æ‰§è¡Œå¤±è´¥, åˆ™å†™ä¸€ä¸ª&lt;code>{{post_file}}.err&lt;/code>æ–‡ä»¶, è€Œä¸æ˜¯&lt;code>{{post_file}}&lt;/code>&lt;/li>
&lt;li>&lt;code>-wait_file&lt;/code>: å¯åŠ¨å­è¿›ç¨‹&lt;strong>å‰&lt;/strong>ç›‘æ§çš„æ–‡ä»¶è·¯å¾„(å³ä¸Šé¢çš„&lt;code>/tekton/downward/ready&lt;/code>). é€šè¿‡ç›‘æ§åˆ°çš„&lt;code>{{watch_file}}&lt;/code>æˆ–è€…&lt;code>{{watch_file}}.err&lt;/code>æ–‡ä»¶æ¥å†³å®šæ‰§è¡Œå­è¿›ç¨‹, è¿˜æ˜¯è·³è¿‡æ‰§è¡Œç„¶åå†™å…¥&lt;code>{{post_file}}.err&lt;/code>æ–‡ä»¶å¹¶è¿”å›é”™è¯¯ç (&lt;code>exitCode&lt;/code> &amp;gt;= 0)&lt;/li>
&lt;li>&lt;code>-wait_file_content&lt;/code>: ç­‰å¾…&lt;code>wait_file&lt;/code>æœ‰å®é™…å†…å®¹å†™å…¥, æŒç»­ç›‘æ§&lt;code>wait_file&lt;/code>ç›´åˆ°æœ‰å†…å®¹å†™å…¥.&lt;/li>
&lt;/ul>
&lt;p>å›å¤´çœ‹ä¸Šé¢å®¹å™¨é…ç½®:&lt;/p>
&lt;ol>
&lt;li>å®¹å™¨çš„&lt;code>entrypoint&lt;/code>å¯åŠ¨è¿›ç¨‹&lt;/li>
&lt;li>ç›‘æ§åˆ°&lt;code>/tekton/downward/ready&lt;/code>æ–‡ä»¶çš„åˆ›å»º, å¹¶ç­‰å¾…æ–‡ä»¶å†…å®¹çš„å†™å…¥&lt;/li>
&lt;li>æ‰§è¡Œ&lt;code>git-init&lt;/code>å­è¿›ç¨‹, ä» git ä»“åº“å…‹éš†æºç &lt;/li>
&lt;li>åˆ›å»º&lt;code>/tekton/tools/0&lt;/code>æ–‡ä»¶&lt;/li>
&lt;/ol>
&lt;h3 id="å®é™…åº”ç”¨">å®é™…åº”ç”¨&lt;/h3>
&lt;p>è¿™ä¸ªæ–¹æ¡ˆæ˜¯å¦èƒ½è§£å†³æˆ‘ä»¬çš„é—®é¢˜, è¿˜æ˜¯æœ‰ä¸€å®šçš„å±€é™æ€§çš„.&lt;/p>
&lt;p>é¦–å…ˆéœ€è¦åº”ç”¨å®¹å™¨çš„å¯åŠ¨å‘½ä»¤è¿›è¡Œé‡æ–°çš„ç¼–æ’, è¿™ä¸ªå­˜åœ¨ä¸€å®šçš„æŒ‘æˆ˜. éœ€è¦ç»Ÿä¸€åº”ç”¨çš„å¯åŠ¨å‘½ä»¤æ‰èƒ½åšåˆ°è§„æ¨¡åŒ–+è‡ªåŠ¨åŒ–.&lt;/p>
&lt;p>å…¶æ¬¡å¼•å…¥å¯ç”¨äºç›‘æ§çš„æ–‡ä»¶, éœ€è¦é¢å¤–å¢åŠ &lt;code>Volume&lt;/code>ç”¨äºè·¨å®¹å™¨çš„æ–‡ä»¶è®¿é—®. å½“ç„¶é€šè¿‡å¢åŠ &lt;code>emptyDir&lt;/code>çš„&lt;code>Volume&lt;/code>å³å¯.&lt;/p>
&lt;p>åŒæ—¶ sidecar å®¹å™¨éœ€è¦åœ¨å®Œæˆå¯åŠ¨ååˆ›å»º&lt;code>post_file&lt;/code>, åº”ç”¨å®¹å™¨å¯ä»¥ä½¿ç”¨è¿™ä¸ª&lt;code>entrypoint&lt;/code>è¿›è¡ŒåŒ…è£….&lt;/p>
&lt;p>å¦‚æœè¦çªç ´è¿™ä¸ªå±€é™, CRD æ— éæ˜¯ä¸ªä¼˜ç§€çš„æ–¹æ¡ˆ. ä¸‹ä¸€ç¯‡, æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ CRD æ¥å®ç°.&lt;/p></description></item><item><title>Tekton Trigger ä»‹ç»</title><link>https://atbug.com/tekton-trigger-glance/</link><pubDate>Wed, 05 Feb 2020 18:03:15 +0800</pubDate><guid>https://atbug.com/tekton-trigger-glance/</guid><description>
&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>Tekton çš„ä»‹ç»è¯·å‚è€ƒ&lt;a href="https://atbug.com/tekton-pipeline-practice/">Tekton Pipeline å®æˆ˜&lt;/a>.&lt;/p>
&lt;p>é€šå¸¸, CI/CD äº‹ä»¶åº”è¯¥åŒ…å«å¦‚ä¸‹ä¿¡æ¯:&lt;/p>
&lt;ul>
&lt;li>ç¡®å®šäº‹ä»¶çš„ç±»å‹(æ¯”å¦‚ GitHub Push, GitLab Issue, Docker Hub Webhook ç­‰)&lt;/li>
&lt;li>å¯ä»ç‰¹å®šç®¡é“è®¿é—®å¹¶æ˜ å°„åˆ°ç‰¹å®šç®¡é“ (ä»äº‹ä»¶è´Ÿè½½ä¸­è·å– SHA ä¿¡æ¯, ç„¶ååœ¨ç®¡é“ä¸­ä½¿ç”¨)&lt;/li>
&lt;li>å‡†ç¡®åœ°è§¦å‘ç®¡é“ (åŸºäºæœ‰æ•ˆè´Ÿè½½å€¼è§¦å‘ç®¡é“)&lt;/li>
&lt;/ul>
&lt;p>Tekton API çš„è®¾è®¡åˆ†ç¦»äº†é…ç½®(æ¯”å¦‚ PipelineRun VS Pipeline), ä¿è¯äº† step å¯ä»¥è¢«é‡ç”¨. ä½†æ˜¯æ²¡æœ‰æä¾›åŠ¨æ€å°è£…é…ç½®çš„æœºåˆ¶æ¥ç”Ÿæˆèµ„æº(å°¤å…¶æ˜¯ PipelineRun å’Œ PipelineResource). &lt;a href="https://github.com/tektoncd/triggers">Triggers&lt;/a> é€šè¿‡ä¸‹é¢çš„ CRDs åœ¨æ¶æ„ä¸Šå¯¹ Tekton è¿›è¡Œäº†æ‰©å±•:&lt;/p>
&lt;ul>
&lt;li>&lt;code>TriggerTemplate&lt;/code>: åˆ›å»ºèµ„æºçš„æ¨¡æ¿(æ¯”å¦‚ç”¨æ¥åˆ›å»º PipelineResource å’Œ PipelineRun)&lt;/li>
&lt;li>&lt;code>TriggerBinding&lt;/code>: æ ¡éªŒäº‹ä»¶å¹¶æå–è´Ÿè½½å­—æ®µ&lt;/li>
&lt;li>&lt;code>EventListener&lt;/code>: è¿æ¥&lt;code>TriggerBinding&lt;/code>å’Œ&lt;code>TriggerTemplate&lt;/code>åˆ°å¯å¯»å€çš„ç«¯ç‚¹(äº‹ä»¶æ¥æ”¶å™¨). ä½¿ç”¨ä»å„ä¸ª&lt;code> TriggerBinding&lt;/code>ä¸­æå–çš„å‚æ•°æ¥åˆ›å»º&lt;code>TriggerTemplate&lt;/code>ä¸­æŒ‡å®šçš„ resources. åŒæ ·é€šè¿‡&lt;code> interceptor&lt;/code>å­—æ®µæ¥æŒ‡å®šå¤–éƒ¨æœåŠ¡æ¥å¯¹äº‹ä»¶è´Ÿè½½è¿›è¡Œé¢„å¤„ç†.&lt;/li>
&lt;li>&lt;code>ClusterTriggerBinding&lt;/code>: clusterçº§åˆ«çš„&lt;code>TriggerBinding&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/rymZ0w.jpg" alt="">&lt;/p>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl apply --filename https://storage.googleapis.com/tekton-releases/triggers/latest/release.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥æ–°å¢çš„ CRD: &lt;code>kubectl api-resources | grep tekton&lt;/code>. Triggers å¼•å…¥äº† 3 ä¸ª CRD: &lt;code>TriggerTemplate&lt;/code>, &lt;code>TriggerBinding&lt;/code>,&lt;code>EventListener&lt;/code>.&lt;/p>
&lt;p>æ£€æŸ¥æ–°å¢çš„ deployment: &lt;code>tekton-triggers-webhook&lt;/code>, &lt;code>tekton-triggers-controller&lt;/code>.&lt;/p></description></item><item><title>Tekton Dashboard å®‰è£…</title><link>https://atbug.com/tekton-dashboard-installation/</link><pubDate>Sat, 01 Feb 2020 12:39:28 +0800</pubDate><guid>https://atbug.com/tekton-dashboard-installation/</guid><description>
&lt;p>Tekton æä¾›äº†&lt;a href="https://github.com/tektoncd/dashboard">dashboard&lt;/a>æ–¹ä¾¿ç”¨æˆ·ç®¡ç†å’ŒæŸ¥çœ‹ Tekton PipelineRun å’Œ TaskRun ä»¥åŠåˆ›å»º, æ‰§è¡Œå’Œå®Œæˆè¿‡ç¨‹ä¸­æ¶‰åŠçš„èµ„æº. å®ƒè¿˜å…è®¸æŒ‰æ ‡ç­¾è¿‡æ»¤ PipelineRun å’Œ TaskRun.&lt;/p>
&lt;h3 id="å®‰è£…æ–¹æ³•">å®‰è£…æ–¹æ³•&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply --filename https://github.com/tektoncd/dashboard/releases/download/v0.4.1/dashboard_latest_release.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥dashboardçš„è¿è¡Œæƒ…å†µ, &lt;code>STATUS&lt;/code>ä¸º&lt;code>Running&lt;/code>çš„è¯åˆ™è¯´æ˜è¿è¡ŒæˆåŠŸ.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get pods --namespace tekton-pipelines
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è®¿é—®">è®¿é—®&lt;/h3>
&lt;p>è®¿é—®Tektonçš„Dashboardæœ‰ä¸¤ç§æ–¹å¼, ä¸€ç§æ˜¯é€šè¿‡&lt;code>port-forward&lt;/code>, å¦ä¸€ç§æ˜¯é€šè¿‡&lt;code>ingress&lt;/code>æ¥è®¿é—®.&lt;/p>
&lt;h4 id="port-forward">port-forward&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl port-forward svc/tekton-dashboard &lt;span class="m">9097&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ingress">ingress&lt;/h4>
&lt;p>å…ˆæ£€æŸ¥ingressæ˜¯å¦å¼€å¯.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube addon list
...
- ingress: enabled
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœæ˜¯disabledçš„è¯, é€šè¿‡å‘½ä»¤&lt;code>minikube addons enable ingress&lt;/code>.&lt;/p>
&lt;p>&lt;em>æ³¨æ„: è¿™é‡Œæ‹‰å–&lt;code>quay.io/kubernetes-ingress-controller/nginx-ingress-controller&lt;/code>é•œåƒå¯èƒ½æ¯”è¾ƒæ…¢, å»ºè®®ä½¿ç”¨å›½å†…çš„é•œåƒ, æ¯”å¦‚&lt;code>quay.mirrors.ustc.edu.cn/kubernetes-ingress-controller/nginx-ingress-controller&lt;/code>&lt;/em>&lt;/p>
&lt;p>ä¿®æ”¹&lt;code>basic-dashboard-ingress.yaml&lt;/code>ä¸­çš„&lt;code>host&lt;/code>åœ°å€:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">extensions/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Ingress&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-dashboard&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-dashboard.nip.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">paths&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">backend&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-dashboard&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">servicePort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">9097&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œ&lt;code>kubectl apply -f basic-dashboard-ingress.yaml&lt;/code>.&lt;/p>
&lt;p>è¿˜æœ‰æœ€åä¸€æ­¥, åœ¨&lt;code>/etc/hosts&lt;/code>ä¸­æ·»åŠ ä¸€æ¡è§£æ&lt;code>x.x.x.x tekton-dashboard.nip.io&lt;/code>, ipåœ°å€é€šè¿‡&lt;code>minikube ip&lt;/code>æ¥è·å–&lt;/p>
&lt;p>æµè§ˆå™¨ä¸­æ‰“å¼€&lt;code> tekton-dashboard.nip.io&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/6weoXL.jpg" alt="">&lt;/p></description></item><item><title>Tektonå®‰è£…åŠHello world</title><link>https://atbug.com/tekton-installation-and-sample/</link><pubDate>Fri, 17 Jan 2020 19:17:14 +0800</pubDate><guid>https://atbug.com/tekton-installation-and-sample/</guid><description>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥å®‰è£…çš„tektonç›¸å…³çš„CRD:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl api-resources &lt;span class="p">|&lt;/span> grep tekton
clustertasks tekton.dev &lt;span class="nb">false&lt;/span> ClusterTask
conditions tekton.dev &lt;span class="nb">true&lt;/span> Condition
pipelineresources tekton.dev &lt;span class="nb">true&lt;/span> PipelineResource
pipelineruns pr,prs tekton.dev &lt;span class="nb">true&lt;/span> PipelineRun
pipelines tekton.dev &lt;span class="nb">true&lt;/span> Pipeline
taskruns tr,trs tekton.dev &lt;span class="nb">true&lt;/span> TaskRun
tasks tekton.dev &lt;span class="nb">true&lt;/span> Task
&lt;/code>&lt;/pre>&lt;/div>&lt;p>tektonçš„ä¸¤ä¸ªpod:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get pods --namespace tekton-pipelines
NAME READY STATUS RESTARTS AGE
tekton-pipelines-controller-556d8f4494-2qthv 1/1 Running &lt;span class="m">0&lt;/span> 11m
tekton-pipelines-webhook-849cff5cf-8m5qq 1/1 Running &lt;span class="m">0&lt;/span> 11m
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…cli">å®‰è£…CLI&lt;/h3>
&lt;p>cli: &lt;a href="https://github.com/tektoncd/cli#installing-tkn">https://github.com/tektoncd/cli#installing-tkn&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">brew install tektoncd-cli
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="tekton-hello-world">Tekton: hello world&lt;/h2>
&lt;p>åˆ›å»ºä¸€ä¸ªç®€å•çš„&lt;code>Task&lt;/code>, åªæœ‰ä¸€ä¸ª&lt;code>step&lt;/code>å°±æ˜¯æ‰“å°å‡º&amp;quot;hello world&amp;quot;&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Task&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo-hello-world&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">echo&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;hello world&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»ºä¸€ä¸ª&lt;code>TaskRun&lt;/code>æ‰§è¡Œä¸Šé¢çš„&lt;code>Task&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TaskRun&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo-hello-world-task-run&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo-hello-world&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡Œtask:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f &amp;lt;name-of-file.yaml&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥&lt;code>TaskRun&lt;/code>çš„è¾“å‡º, æ‰§è¡Œå‘½ä»¤:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">tkn taskrun describe echo-hello-world-task-run
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">Name: echo-hello-world-task-run
Namespace: tekton-pipelines
Task Ref: echo-hello-world
Status
STARTED DURATION STATUS
21 minutes ago 1 minute Succeeded
Input Resources
No resources
Output Resources
No resources
Params
No params
Steps
NAME STATUS
echo Completed
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Succeeded&lt;/code>çŠ¶æ€è¡¨ç¤ºtaskæ‰§è¡ŒæˆåŠŸ.&lt;/p>
&lt;p>æŸ¥çœ‹å®é™…çš„è¾“å‡º, æ‰§è¡Œå‘½ä»¤:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">tkn taskrun logs echo-hello-world-task-run
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æœ:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">[echo] hello world
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Minikubeå®‰è£…istio</title><link>https://atbug.com/install-istio-on-minikube/</link><pubDate>Fri, 17 Jan 2020 08:02:42 +0800</pubDate><guid>https://atbug.com/install-istio-on-minikube/</guid><description>
&lt;h2 id="å‡†å¤‡">å‡†å¤‡&lt;/h2>
&lt;p>&lt;strong>æ³¨æ„: istioctlçš„å®‰è£…è¦ä½¿ç”¨å®‰è£…é‡Œçš„, ä¸è¦æ˜¯ç”¨homebrewé‡Œçš„. &lt;a href="https://github.com/istio/istio/issues/19029">github issue&lt;/a>&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -L https://istio.io/downloadIstio &lt;span class="p">|&lt;/span> sh -
&lt;span class="nb">cd&lt;/span> istio-1.4.2
cp bin/istioctl /usr/local/bin/istioctl
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…å‰æ£€æŸ¥">å®‰è£…å‰æ£€æŸ¥&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">istioctl verify-install
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœæ£€æŸ¥æ²¡é—®é¢˜, ä¼šçœ‹åˆ°&lt;code>Install Pre-Check passed! The cluster is ready for Istio installation.&lt;/code>&lt;/p>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;p>istioæœ‰5ç§å†…å»ºçš„å®‰è£…é…ç½®&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>: remote, sds, default, demo, minimal&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">istioctl profile list
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>minimal: ä½¿ç”¨istioçš„æµé‡ç®¡ç†æ‰€éœ€ç»„ä»¶çš„æœ€å°åŒ–å®‰è£…&lt;/li>
&lt;li>default: æ ¹æ®IstioControlPlane APIçš„é»˜è®¤è®¾ç½®(å»ºè®®ç”¨äºç”Ÿäº§éƒ¨ç½²)å¯ç”¨ç»„ä»¶. æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œå‘½ä»¤istioctl profile dumpæ˜¾ç¤ºé»˜è®¤è®¾ç½®.&lt;/li>
&lt;li>demo: å‡ ä¹å®‰è£…æ‰€æœ‰çš„ç‰¹æ€§, åŒ…æ‹¬loggingå’Œtracingçš„æ¯”ä¾‹ä¸º100%. ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ, è´Ÿè½½å¤ªé‡&lt;/li>
&lt;/ul>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;/th>
&lt;th>default&lt;/th>
&lt;th>demo&lt;/th>
&lt;th>minimal&lt;/th>
&lt;th>sds&lt;/th>
&lt;th>remote&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Core components&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-citadel&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-egressgateway&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-galley&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-ingressgateway&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-nodeagent&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-pilot&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-policy&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-sidecar-injector&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-telemetry&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Addons&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>grafana&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-tracing&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>kiali&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>prometheus&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;code>demo&lt;/code> profileå®‰è£…&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">istioctl manifest apply --set &lt;span class="nv">profile&lt;/span>&lt;span class="o">=&lt;/span>demo
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éªŒè¯å®‰è£…ç»“æœ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">istioctl manifest generate --set &lt;span class="nv">profile&lt;/span>&lt;span class="o">=&lt;/span>demo &amp;gt; /tmp/generated-manifest.yaml
istioctl verify-install -f /tmp/generated-manifest.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>&amp;hellip;&amp;hellip;
Checked 23 crds
Checked 9 Istio Deployments
Istio is installed successfully&lt;/p>
&lt;/blockquote>
&lt;h2 id="å¸è½½">å¸è½½&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">helm template install/kubernetes/helm/istio --namespace istio-system &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --values install/kubernetes/helm/istio/values-istio-demo.yaml &lt;span class="p">|&lt;/span> kubectl delete -f -
kubectl delete namespace istio-system
&lt;span class="c1">#delete all CRDs&lt;/span>
kubectl delete -f install/kubernetes/helm/istio-init/files
&lt;/code>&lt;/pre>&lt;/div>&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>&lt;a href="https://istio.io/docs/setup/additional-setup/config-profiles/">è¿™é‡Œ&lt;/a>å¯ä»¥æŸ¥çœ‹å„ä¸ªé…ç½®çš„è¯¦ç»†è¯´æ˜ &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>åŠ é€Ÿäº‘åŸç”Ÿçš„ Java å¼€å‘</title><link>https://atbug.com/speed-up-java-development-on-kubernetes/</link><pubDate>Sat, 21 Dec 2019 20:45:22 +0800</pubDate><guid>https://atbug.com/speed-up-java-development-on-kubernetes/</guid><description>
&lt;p>ä»Šå¤©æ¥è¯´è¯´æ—¥å¸¸åœ¨Kuberneteså¼€å‘Javaé¡¹ç›®é‡åˆ°çš„é—®é¢˜.&lt;/p>
&lt;p>å½“æˆ‘ä»¬æ–°å»ºä¸€ä¸ªé¡¹ç›®çš„æ—¶å€™, æ€»æ˜¯é¢ä¸´éœ€è¦æ–°å»ºmanifest, å¹³æ—¶éƒ½æ˜¯&lt;code>copy+paste+modify&lt;/code>. èƒ½å¦ä»¥å˜æˆçš„æ–¹å¼æ¥ç”Ÿæˆ?&lt;/p>
&lt;p>å¼€å‘æ—¶çš„æ­¥éª¤ä¹Ÿæ¯”è¾ƒç¹ç: &lt;code>docker build&lt;/code>, &lt;code>docker push&lt;/code>, &lt;code>kubectl apple&lt;/code>, &lt;code>kubectl delete pod&lt;/code>. å¯¹äºä¸€ä¸ªJavaåº”ç”¨æ¥è¯´è¿˜å¤šäº†ä¸€æ­¥ç¼–è¯‘. æ“ä½œä¸€æ¬¡è¿˜ok, ä½†æ˜¯ä¸€å¤©åå‡ æ¬¡æ€»ä¼šæœ‰æƒ³åçš„æ„Ÿè§‰. è¿™äº›æ­¥éª¤èƒ½å¦ç®€åŒ–æˆä¸€ä¸ªå‘½ä»¤, ç”šè‡³ä¿®æ”¹äº†ä»£ç è‡ªåŠ¨å°±å®Œæˆä¸Šé¢ä¸€ç³»åˆ—çš„æ“ä½œ?&lt;/p>
&lt;p>å®ç°è¿™äº›æˆ‘ä»¬éœ€è¦å‡ ä¸ªå·¥å…·: &lt;a href="https://github.com/dekorateio/dekorate">dekorate&lt;/a>, &lt;a href="https://github.com/GoogleContainerTools/jib">Jib&lt;/a>, &lt;a href="https://github.com/GoogleContainerTools/skaffold">Skaffold&lt;/a>. å…¶ä¸­Jibä¹Ÿåœ¨ä¸Šä¸€ç¯‡æ–‡ç« &lt;a href="https://atbug.com/build-docker-or-oci-image-with-jib-for-java/">ä½¿ç”¨Jibä¸ºJavaåº”ç”¨æ„å»ºé•œåƒ&lt;/a>ä¸­ä»‹ç»è¿‡.&lt;/p>
&lt;h2 id="dekorate">dekorate&lt;/h2>
&lt;blockquote>
&lt;p>Dekorate is a collection of Java compile-time generators and decorators for Kubernetes/OpenShift manifests.
Dekorateæ˜¯Javaç¼–è¯‘æ—¶ç”Ÿæˆå’Œè£…é¥°Kubernetes/OpenShiftçš„manifestsçš„å·¥å…·&lt;/p>
&lt;/blockquote>
&lt;h3 id="å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹&lt;/h3>
&lt;h4 id="1-é€šè¿‡ä½¿ç”¨spring-initializerhttpsstartspringioç”Ÿæˆä¸€ä¸ªé¡¹ç›®spring-boot-222-å¹¶åŠ å…¥ä¾èµ–">1. é€šè¿‡ä½¿ç”¨&lt;a href="https://start.spring.io">Spring Initializer&lt;/a>ç”Ÿæˆä¸€ä¸ªé¡¹ç›®(Spring Boot 2.2.2), å¹¶åŠ å…¥ä¾èµ–:&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>io.dekorate&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>kubernetes-spring-starter&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>0.10.0&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="2-åŠ å…¥ä¸€ä¸ªç®€å•çš„controller">2. åŠ å…¥ä¸€ä¸ªç®€å•çš„&lt;code>Controller&lt;/code>:&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * @author Addo.Zhang
&lt;/span>&lt;span class="cm"> * @date 2019/12/22
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="nd">@RestController&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">DekorateExampleController&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@GetMapping&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">hi&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;Hello World&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-æ‰§è¡Œå‘½ä»¤mvn-clean-install-ç„¶ååœ¨targetclassesmeta-infdekorateç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°kubernetesjsonå’Œkubernetesymlä¸¤ä¸ªæ–‡ä»¶">3. æ‰§è¡Œå‘½ä»¤&lt;code>mvn clean install&lt;/code>, ç„¶ååœ¨&lt;code>target/classes/META-INF/dekorate&lt;/code>ç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°&lt;code>kubernetes.json&lt;/code>å’Œ&lt;code>kubernetes.yml&lt;/code>ä¸¤ä¸ªæ–‡ä»¶.&lt;/h4>
&lt;p>&lt;code>kubernetes.yml&lt;/code>çš„å†…å®¹:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;v1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Service&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;ClusterIP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;apps/v1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Deployment&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">env&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;KUBERNETES_NAMESPACE&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">valueFrom&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;metadata.namespace&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo/dekorate-example:0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;IfNotPresent&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">livenessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">failureThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/actuator/info&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initialDelaySeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">successThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeoutSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">containerPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;TCP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">readinessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">failureThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/actuator/health&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initialDelaySeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">successThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeoutSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ymlä¸­åŒ…å«äº†&lt;code>Service&lt;/code>å’Œ&lt;code>Deployment&lt;/code>ä¸¤éƒ¨åˆ†, dekorateå®Œç¾å…¼å®¹çš„Spring:&lt;/p>
&lt;ul>
&lt;li>&lt;code>app: dekorate-example&lt;/code>: é¡¹ç›®å&lt;/li>
&lt;li>&lt;code>version: 0.0.1-SNAPSHOT&lt;/code>: é¡¹ç›®å½“å‰ç‰ˆæœ¬&lt;/li>
&lt;li>&lt;code>group: addo&lt;/code>: æ˜¯æˆ‘ç³»ç»Ÿå½“å‰ç”¨æˆ·å&lt;/li>
&lt;li>&lt;code>/actuator/health&lt;/code>: Spring Boot 2.2åactuatorçš„health endpoint, ä½œä¸º&lt;code>readinessProbe&lt;/code>&lt;/li>
&lt;li>&lt;code>/actuator/info&lt;/code>: Spring Boot 2.2åactuatorçš„endpoint, ä½œä¸º&lt;code>livenessProbe&lt;/code>&lt;/li>
&lt;/ul>
&lt;h3 id="è¿›é˜¶">è¿›é˜¶&lt;/h3>
&lt;p>&lt;strong>å‰é¢ymlçš„å†…å®¹éƒ½æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„, å‡å¦‚æœ‰äº›ç‰¹æ®Šçš„éœ€æ±‚. æ¯”å¦‚ä¿®æ”¹é•œåƒçš„&lt;code>repository&lt;/code>å³è¿™é‡Œçš„&lt;code>group&lt;/code>, å¦‚ä½•æ“ä½œ?&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">dekorate.kubernetes.group = addozhang
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æœ:&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/5zgkfl.jpg" alt="Change Image Repository">&lt;/p>
&lt;p>&lt;strong>æˆ–è€…ä¿®æ”¹Serviceçš„ç±»å‹ä¸ºNodePort&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">dekorate.kubernetes.service-type = NodePort
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/vIen3M.jpg" alt="NodePort Service">&lt;/p>
&lt;h4 id="é…ç½®">é…ç½®&lt;/h4>
&lt;p>dekorationæä¾›äº†&lt;a href="https://github.com/dekorateio/dekorate/blob/master/assets/config.md">ä¸°å¯Œçš„é…ç½®&lt;/a>æ¥ä¸ªæ€§åŒ–manifest.&lt;/p>
&lt;p>é™¤äº†ä¸Šé¢ä½¿ç”¨çš„é…ç½®æ–‡ä»¶(properties/yaml)çš„æ–¹å¼, è¿˜æä¾›äº†&lt;code>Annotation&lt;/code>æ³¨è§£é…ç½®æ–¹å¼.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">import&lt;/span> &lt;span class="nn">io.dekorate.kubernetes.annotation.Env&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">io.dekorate.kubernetes.annotation.KubernetesApplication&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@KubernetesApplication&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">envVars&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nd">@Env&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;key1&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;var1&amp;#34;&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Main&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//Your code goes here
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/exQoxy.jpg" alt="@KubernetesApplication Annotation">&lt;/p>
&lt;h2 id="jib">Jib&lt;/h2>
&lt;p>Jibçš„è¯´æ˜è¯·çœ‹ä¸Šä¸€ç¯‡æ–‡ç« :&lt;a href="https://atbug.com/build-docker-or-oci-image-with-jib-for-java/">ä½¿ç”¨Jibä¸ºJavaåº”ç”¨æ„å»ºé•œåƒ&lt;/a>&lt;/p>
&lt;h3 id="æ’ä»¶é…ç½®">æ’ä»¶é…ç½®&lt;/h3>
&lt;p>ä¸‹é¢æ˜¯é’ˆå¯¹è¯¥é¡¹ç›®æ·»åŠ çš„é…ç½®:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="nt">&amp;lt;plugin&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.google.cloud.tools&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>jib-maven-plugin&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>1.8.0&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;configuration&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;container&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-Xmx128m&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-Xms64m&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/jvmFlags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;labels&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;Author&amp;gt;&lt;/span>Addo.Zhang&lt;span class="nt">&amp;lt;/Author&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/labels&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;creationTime&amp;gt;&lt;/span>USE_CURRENT_TIMESTAMP&lt;span class="nt">&amp;lt;/creationTime&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/container&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;from&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;image&amp;gt;&lt;/span>openjdk:8-jdk-alpine&lt;span class="nt">&amp;lt;/image&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/from&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;to&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;image&amp;gt;&lt;/span>addo/dekorate-example&lt;span class="nt">&amp;lt;/image&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;tags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;tag&amp;gt;&lt;/span>latest&lt;span class="nt">&amp;lt;/tag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/tags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/to&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;allowInsecureRegistries&amp;gt;&lt;/span>true&lt;span class="nt">&amp;lt;/allowInsecureRegistries&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/configuration&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/plugin&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œå‘½ä»¤&lt;code>mvn compile jib:dockerBuild&lt;/code>ä¾¿å¯ä»¥ç¼–è¯‘ä»£ç , æ„å»ºé•œåƒå¹¶æ¨é€åˆ°é•œåƒä»“åº“.&lt;/p>
&lt;h2 id="skaffold">Skaffold&lt;/h2>
&lt;p>&lt;a href="https://github.com/GoogleContainerTools/skaffold">Skaffold&lt;/a>ä¹Ÿæ˜¯GoogleContainerToolsä¸­çš„ä¸€ä¸ªå·¥å…·.&lt;/p>
&lt;blockquote>
&lt;p>Skaffold is a command line tool that facilitates continuous development for Kubernetes applications. You can iterate on your application source code locally then deploy to local or remote Kubernetes clusters. Skaffold handles the workflow for building, pushing and deploying your application. It also provides building blocks and describe customizations for a CI/CD pipeline.
Skaffoldæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·, å¯ä¿ƒè¿›Kubernetesåº”ç”¨ç¨‹åºçš„æŒç»­å¼€å‘. å¯ä»¥åœ¨æœ¬åœ°è¿­ä»£åº”ç”¨ç¨‹åºæºä»£ç , ç„¶åéƒ¨ç½²åˆ°æœ¬åœ°æˆ–è¿œç¨‹Kubernetesé›†ç¾¤. Skaffoldå¤„ç†æ„å»º, æ¨é€å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºçš„å·¥ä½œæµç¨‹. å®ƒè¿˜æä¾›äº†æ„å»ºå—å¹¶æè¿°äº†CI/CDç®¡é“çš„è‡ªå®šä¹‰.&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­, é€šè¿‡ä¸Jibçš„è”åŠ¨, å®Œæˆç¼–è¯‘ä»£ç , æ„å»ºé•œåƒ, æ¨é€é•œåƒ, éƒ¨ç½²ä¸€ç³»åˆ—æ“ä½œ.&lt;/p>
&lt;p>![Run](&lt;a href="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/2019-12-23">https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/2019-12-23&lt;/a> 15.12.24.gif)&lt;/p>
&lt;p>æˆªå±ä¸­çš„æ“ä½œ, å› ä¸ºæ²¡æœ‰ä»£ç æ”¹åŠ¨è€Œä¸ç»­æ„å»ºé•œåƒ, Skaffoldç›´æ¥ä»cacheä¸­è·å–é•œåƒå¹¶éƒ¨ç½²åˆ°Kubernetesä¸­.&lt;/p>
&lt;h3 id="skaffoldæ“ä½œ">Skaffoldæ“ä½œ&lt;/h3>
&lt;h4 id="1-æ‰§è¡Œå‘½ä»¤skaffold-init---xxenablejibinitå¹¶åœ¨æç¤ºå‡ºè¾“å…¥y">1. æ‰§è¡Œå‘½ä»¤&lt;code>skaffold init --XXenableJibInit&lt;/code>å¹¶åœ¨æç¤ºå‡ºè¾“å…¥&lt;code>y&lt;/code>&lt;/h4>
&lt;h4 id="2-è¯¥å‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ªåä¸ºskaffoldyamlçš„æ–‡ä»¶">2. è¯¥å‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ªåä¸º&lt;code>skaffold.yaml&lt;/code>çš„æ–‡ä»¶&lt;/h4>
&lt;p>ç”±äº&lt;code>dekorate&lt;/code>åŒæ—¶ç”Ÿæˆäº†&lt;code>json&lt;/code>å’Œ&lt;code>yaml&lt;/code>æ ¼å¼çš„manifest, è¢«&lt;code>skaffold&lt;/code>æ£€æµ‹åˆ°. å®é™…æ“ä½œä¸­åªéœ€è¦å…¶ä¸­ä¸€ä¸ªå³å¯.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">skaffold/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dekorate-example&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">artifacts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">addo/dekorate-example&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">jib&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kubectl&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">manifests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">target/classes/META-INF/dekorate/kubernetes.json&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">target/classes/META-INF/dekorate/kubernetes.yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-æ‰§è¡Œskaffold-run">3. æ‰§è¡Œ&lt;code>skaffold run&lt;/code>&lt;/h4>
&lt;h4 id="4-podå¯åŠ¨å®Œæˆå-é€šè¿‡kubectl-port-forward-podname-here-8081">4. podå¯åŠ¨å®Œæˆå, é€šè¿‡&lt;code>kubectl port-forward PODNAME-HERE 8081&lt;/code>&lt;/h4>
&lt;h4 id="5-è¯·æ±‚http-httplocalhost8081">5. è¯·æ±‚&lt;code>http http://localhost:8081&lt;/code>&lt;/h4>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/wt2BVU.jpg" alt="">&lt;/p>
&lt;h3 id="è¿›é˜¶-1">è¿›é˜¶&lt;/h3>
&lt;p>Skaffoldçš„åŠŸèƒ½å¼ºå¤§, ç›®å‰ä¸ªäººä½¿ç”¨çš„æœ‰é™, æœ‰æ—¶é—´æ–°å¼€ä¸€ç¯‡æ¥å­¦ä¹ ä¸€ä¸‹.&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/FXu4Hy.jpg" alt="">&lt;/p>
&lt;h4 id="cli">CLI&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">âœ ~ skaffold &lt;span class="nb">help&lt;/span>
A tool that facilitates continuous development &lt;span class="k">for&lt;/span> Kubernetes applications.
Find more information at: https://skaffold.dev/docs/getting-started/
End-to-end pipelines:
run Run a pipeline
dev Run a pipeline in development mode
debug &lt;span class="o">[&lt;/span>beta&lt;span class="o">]&lt;/span> Run a pipeline in debug mode
Pipeline building blocks &lt;span class="k">for&lt;/span> CI/CD:
build Build the artifacts
deploy Deploy pre-built artifacts
delete Delete the deployed application
render &lt;span class="o">[&lt;/span>alpha&lt;span class="o">]&lt;/span> Perform all image builds, and output rendered Kubernetes manifests
Getting started with a new project:
init &lt;span class="o">[&lt;/span>alpha&lt;span class="o">]&lt;/span> Generate configuration &lt;span class="k">for&lt;/span> deploying an application
fix Update old configuration to newest schema version
Other Commands:
completion Output shell completion &lt;span class="k">for&lt;/span> the given shell &lt;span class="o">(&lt;/span>bash or zsh&lt;span class="o">)&lt;/span>
config Interact with the Skaffold configuration
credits Export third party notices to given path &lt;span class="o">(&lt;/span>./skaffold-credits by default&lt;span class="o">)&lt;/span>
diagnose Run a diagnostic on Skaffold
version Print the version information
Usage:
skaffold &lt;span class="o">[&lt;/span>flags&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>options&lt;span class="o">]&lt;/span>
Use &lt;span class="s2">&amp;#34;skaffold &amp;lt;command&amp;gt; --help&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> more information about a given command.
Use &lt;span class="s2">&amp;#34;skaffold options&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> a list of global command-line options &lt;span class="o">(&lt;/span>applies to all commands&lt;span class="o">)&lt;/span>.
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="yamlé…ç½®">Yamlé…ç½®&lt;/h4>
&lt;p>å‚è€ƒ&lt;a href="https://skaffold.dev/docs/references/yaml/">skaffold.yaml&lt;/a>&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>æ–‡ç« çš„å¼€å¤´æˆ‘ä»¬æåˆ°å¦‚ä½•åšåˆ°ä¿®æ”¹ä»£ç åè‡ªåŠ¨å®Œæˆä¸€äº›åˆ—çš„æ“ä½œ, é€šè¿‡&lt;code>skaffold dev&lt;/code>å°±å¯ä»¥å®ç°.&lt;/p>
&lt;p>æ–‡ç« ä¸­ä½¿ç”¨çš„&lt;code>dekoration-example&lt;/code>å¯åœ¨&lt;a href="https://github.com/addozhang/dekorate-example">GitHub&lt;/a>ä¸Šæ‰¾åˆ°.&lt;/p></description></item><item><title>Kubernetesä¸­çš„NginxåŠ¨æ€è§£æ</title><link>https://atbug.com/nginx-dynamic-domain-parse-in-kubernetes/</link><pubDate>Wed, 30 May 2018 12:10:32 +0000</pubDate><guid>https://atbug.com/nginx-dynamic-domain-parse-in-kubernetes/</guid><description>
&lt;h3 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h3>
&lt;p>Nginxè¿è¡Œåœ¨kubernetsä¸­, åå‘ä»£ç†serviceæä¾›æœåŠ¡.&lt;/p>
&lt;p>kubernetesç‰ˆæœ¬v1.9.1+a0ce1bc657.&lt;/p>
&lt;h3 id="é—®é¢˜">é—®é¢˜:&lt;/h3>
&lt;p>é…ç½®å¦‚ä¸‹:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">location ^~/info {
proxy_pass: http://serviceName:port;
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ é™¤å¹¶é‡å»ºServiceçš„æ—¶å€™, nginxä¼šå‡ºç°ä¸‹é¢çš„é—®é¢˜:&lt;/p>
&lt;blockquote>
&lt;p>connect() failed (113: No route to host) &amp;hellip; upstream: &amp;ldquo;xxxxx&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;h3 id="åˆ†æ">åˆ†æ&lt;/h3>
&lt;p>é€šè¿‡googleå‘ç°, æ˜¯nginxçš„dnsè§£ææ–¹æ¡ˆçš„é—®é¢˜.&lt;/p>
&lt;p>nginxå®˜æ–¹çš„è¯´æ˜:&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>If the domain name canâ€™t be resolved, NGINX fails to start or reload its configuration.&lt;/li>
&lt;li>NGINX caches the DNS records until the next restart or configuration reload, ignoring the recordsâ€™ TTL values.&lt;/li>
&lt;li>We canâ€™t specify another loadâ€‘balancing algorithm, nor can we configure passive health checks or other features defined by parameters to the server directive, which weâ€™ll describe in the next section.&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>æ„æ€æ˜¯è¯´, nginxåœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šè§£æ&lt;code>proxy_pass&lt;/code>åçš„åŸŸå, å¹¶æŠŠ&lt;code>ip&lt;/code>ç¼“å­˜ä¸‹æ¥, è€Œä¸”æ²¡æœ‰TTL. åªæœ‰åœ¨restartæˆ–è€…reloadçš„æ—¶å€™æ‰ä¼šå†æ¬¡è§£æ.&lt;/p>
&lt;h3 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ&lt;/h3>
&lt;p>ä½¿ç”¨nginx podçš„è§£ææœåŠ¡å™¨ä½œä¸ºresolver:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">#nginx conf
resolver NAME_SERVER valid=30s ipv6=off;
set $service &amp;#34;http://serviceName:port&amp;#34;;
location ^~/info {
proxy_pass: $service;
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨shellè·å–podä¸­ä½¿ç”¨çš„è§£ææœåŠ¡å™¨&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">NAME_SERVER&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>cat /etc/resolv.conf &lt;span class="p">|&lt;/span> grep &lt;span class="s2">&amp;#34;nameserver&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> tr &lt;span class="s1">&amp;#39;\n&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="sb">`&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‚è€ƒ:
&lt;a href="https://stackoverflow.com/questions/17685674/nginx-proxy-pass-with-remote-addr">Nginx proxy_pass with $remote_addr&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://tenzer.dk/nginx-with-dynamic-upstreams/">Nginx with dynamic upstreams&lt;/a>&lt;/p>
&lt;h3 id="å¦ä¸€ä¸ªé—®é¢˜">å¦ä¸€ä¸ªé—®é¢˜&lt;/h3>
&lt;blockquote>
&lt;p>serviceName could not be resolved (3: Host not found)&lt;/p>
&lt;/blockquote>
&lt;p>serviceçš„çŸ­åç§°æ˜¯è§£æä¸äº†çš„, éœ€è¦ä½¿ç”¨serviceName.namespace.svc.clusterName.&lt;/p></description></item><item><title>Kubernetes â€” æŒä¹…å·</title><link>https://atbug.com/kubernetes-persistent-volumes/</link><pubDate>Sun, 20 Aug 2017 22:25:40 +0000</pubDate><guid>https://atbug.com/kubernetes-persistent-volumes/</guid><description>
&lt;h1 id="persistent-volume">Persistent Volume&lt;/h1>
&lt;p>è¯‘è‡ª&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Persistent Volumes&lt;/a>&lt;/p>
&lt;h2 id="ä»‹ç»">ä»‹ç»&lt;/h2>
&lt;p>ç®¡ç†å­˜å‚¨æ˜¯ç®¡ç†è®¡ç®—çš„ç‹¬ç‰¹é—®é¢˜ã€‚ PersistentVolumeå­ç³»ç»Ÿä¸ºç”¨æˆ·å’Œç®¡ç†å‘˜æä¾›äº†ä¸€ä¸ªAPIï¼Œå…¶ä¸­æä¾›äº†å¦‚ä½•ä»å¦‚ä½•ä½¿ç”¨å­˜å‚¨æä¾›å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä»‹ç»ä¸¤ç§æ–°çš„APIèµ„æºï¼šPersistentVolumeå’ŒPersistentVolumeClaimã€‚&lt;/p>
&lt;p>PersistentVolumeï¼ˆPVï¼‰æ˜¯ç”±ç®¡ç†å‘˜é…ç½®çš„é›†ç¾¤ä¸­çš„ä¸€æ®µå­˜å‚¨ã€‚å®ƒæ˜¯é›†ç¾¤ä¸­çš„ä¸€ç§èµ„æºå°±åƒä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªé›†ç¾¤çš„èµ„æºã€‚ PVæ˜¯ç±»ä¼¼Volumesçš„å·æ’ä»¶ï¼Œä½†æ˜¯å…·æœ‰ç‹¬ç«‹äºä½¿ç”¨PVçš„ä»»ä½•å•ä¸ªpodçš„ç”Ÿå‘½å‘¨æœŸã€‚è¯¥APIå¯¹è±¡æ•è·å­˜å‚¨çš„å®ç°ç»†èŠ‚ï¼Œå³NFSï¼ŒiSCSIæˆ–äº‘æä¾›å•†ç‰¹å®šçš„å­˜å‚¨ç³»ç»Ÿã€‚&lt;/p>
&lt;p>PersistentVolumeClaimï¼ˆPVCï¼‰æ˜¯ç”¨æˆ·å­˜å‚¨çš„è¯·æ±‚ã€‚å®ƒç±»ä¼¼äºpodã€‚ Podæ¶ˆè€—èŠ‚ç‚¹èµ„æºï¼ŒPVCæ¶ˆè€—PVèµ„æºã€‚Podså¯ä»¥è¯·æ±‚ç‰¹å®šçº§åˆ«çš„èµ„æºï¼ˆCPUå’Œå†…å­˜ï¼‰ã€‚å£°æ˜å¯ä»¥è¯·æ±‚ç‰¹å®šçš„å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼ˆä¾‹å¦‚ï¼Œä¸€æ¬¡è¯»å†™æˆ–è€…å¤šæ¬¡åªè¯»ï¼‰ã€‚&lt;/p>
&lt;p>è™½ç„¶PersistentVolumeClaimså…è®¸ç”¨æˆ·ä½¿ç”¨æŠ½è±¡å­˜å‚¨èµ„æºï¼Œä½†æ˜¯å¸¸è§çš„æ˜¯ï¼Œç”¨æˆ·éœ€è¦å…·æœ‰ä¸åŒå±æ€§ï¼ˆå¦‚æ€§èƒ½ï¼‰çš„PersistentVolumesï¼Œç”¨äºä¸åŒçš„é—®é¢˜ã€‚ é›†ç¾¤ç®¡ç†å‘˜éœ€è¦èƒ½å¤Ÿæä¾›å¤šç§å½¼æ­¤ä¸åŒçš„PersistentVolumesï¼Œè€Œä¸ä»…ä»…æ˜¯å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼Œè€Œä¸ä¼šä½¿ç”¨æˆ·äº†è§£è¿™äº›å·çš„å®ç°ç»†èŠ‚ã€‚ å¯¹äºè¿™äº›éœ€æ±‚ï¼Œæœ‰ä¸€ä¸ªStorageClassèµ„æºã€‚&lt;/p>
&lt;p>StorageClassä¸ºç®¡ç†å‘˜æä¾›äº†ä¸€ç§æè¿°ä»–ä»¬æä¾›çš„å­˜å‚¨çš„â€œç±»â€çš„æ–¹æ³•ã€‚ ä¸åŒçš„ç±»å¯èƒ½æ˜ å°„åˆ°æœåŠ¡è´¨é‡çº§åˆ«ï¼Œæˆ–å¤‡ä»½ç­–ç•¥ï¼Œæˆ–è€…ç”±ç¾¤é›†ç®¡ç†å‘˜ç¡®å®šçš„ä»»æ„ç­–ç•¥ã€‚ Kubernetesæœ¬èº«å¯¹äºä»€ä¹ˆç±»åˆ«ä»£è¡¨æ˜¯ä¸è¨€è€Œå–»çš„ã€‚ è¿™ä¸ªæ¦‚å¿µæœ‰æ—¶åœ¨å…¶ä»–å­˜å‚¨ç³»ç»Ÿä¸­ç§°ä¸ºâ€œé…ç½®æ–‡ä»¶â€ã€‚&lt;/p>
&lt;p>è¯·å‚é˜…&lt;a href="https://kubernetes.io/docs/user-guide/persistent-volumes/walkthrough/">è¯¦ç»†æ¼”ç»ƒä¸å·¥ä½œç¤ºä¾‹&lt;/a>ã€‚&lt;/p>
&lt;h2 id="å­˜å‚¨å’Œå£°æ˜çš„ç”Ÿå‘½å‘¨æœŸ">å­˜å‚¨å’Œå£°æ˜çš„ç”Ÿå‘½å‘¨æœŸ&lt;/h2>
&lt;p>PVsæ˜¯é›†ç¾¤ä¸­çš„èµ„æºï¼›PVCsæ˜¯å¯¹è¿™ç§èµ„æºçš„å£°æ˜ï¼ŒåŒæ—¶ä¹Ÿæ‰®æ¼”è€…å¯¹èµ„æºå£°æ˜çš„æ£€æŸ¥ã€‚PVså’ŒPVCsä¹‹å‰çš„äº¤äº’éµå¾ªç”Ÿå‘½å‘¨æœŸï¼šä¾›åº”ã€ç»‘å®šã€ä½¿ç”¨ä¸­ã€é‡æ–°ç”³è¯·ã€‚&lt;/p>
&lt;p>é›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºå¤šä¸ªPVã€‚å®ƒä»¬æºå¸¦å¯ä¾›é›†ç¾¤ç”¨æˆ·ä½¿ç”¨çš„çœŸå®å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚å®ƒä»¬å­˜åœ¨äºKubernetes APIä¸­ï¼Œå¯ç”¨äºæ¶ˆè´¹ã€‚&lt;/p>
&lt;h3 id="ä¾›åº”provisioning">ä¾›åº”(Provisioning)&lt;/h3>
&lt;p>PVsä¼šä»¥ä¸¤ç§æ–¹å¼ä¾›åº”ï¼šé™æ€å’ŒåŠ¨æ€ã€‚&lt;/p>
&lt;h4 id="é™æ€">é™æ€&lt;/h4>
&lt;p>é›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºå¤šä¸ªPVã€‚ å®ƒä»¬æºå¸¦å¯ä¾›é›†ç¾¤ç”¨æˆ·ä½¿ç”¨çš„çœŸå®å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚ å®ƒä»¬å­˜åœ¨äºKubernetes APIä¸­ï¼Œå¯è¢«ä½¿ç”¨ã€‚&lt;/p>
&lt;h4 id="åŠ¨æ€">åŠ¨æ€&lt;/h4>
&lt;p>å½“ç®¡ç†å‘˜åˆ›å»ºçš„é™æ€PVéƒ½ä¸åŒ¹é…ç”¨æˆ·çš„PersistentVolumeClaimæ—¶ï¼Œé›†ç¾¤å¯èƒ½ä¼šå°è¯•ä¸ºPVCæŒ‡å®šåŠ¨æ€é…ç½®å·ã€‚ æ­¤é…ç½®åŸºäºStorageClassesï¼šPVCå¿…é¡»æŒ‡å®šä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ç®¡ç†å‘˜å¿…é¡»å·²åˆ›å»ºå¹¶é…ç½®è¯¥ç±»æ‰èƒ½è¿›è¡ŒåŠ¨æ€é…ç½®ã€‚ è¦æ±‚è¯¥ç±»çš„å£°æ˜æœ‰æ•ˆåœ°ä¸ºè‡ªå·±ç¦ç”¨åŠ¨æ€é…ç½®ã€‚&lt;/p>
&lt;h3 id="ç»‘å®šbinding">ç»‘å®š(Binding)&lt;/h3>
&lt;p>å½“ç”¨æˆ·åˆ›å»ºã€æˆ–å·²ç»åˆ›å»ºäº†ä¸€ä¸ªPersistenVolumenClaimå¹¶æŒ‡å®šå¤§å°å’Œè®¿é—®ç±»å‹ã€‚Masterä¸­çš„æ§åˆ¶å¾ªç¯ä¼šæ£€æµ‹æ–°çš„PVCï¼Œæ‰¾åˆ°ä¸€ä¸ªåŒ¹é…çš„PVï¼ˆå¦‚æœå¯èƒ½çš„è¯ï¼‰ï¼Œå¹¶å°†å®ƒä»¬ç»‘å®šåœ¨ä¸€èµ·ã€‚å¦‚æœä¸€ä¸ªPVè¢«åŠ¨æ€åœ°ä¾›åº”æŸä¸ªPVCï¼Œå¾ªç¯å°†æ€»æ˜¯æŠŠè¿™ä¸ªPVå’Œè¯¥PVCç»‘å®šã€‚å¦åˆ™ï¼Œç”¨æˆ·æ€»æ˜¯è‡³å°‘å¾—åˆ°ä»–ä»¬è¦æ±‚çš„å†…å®¹ï¼Œä½†æ˜¯å·å¯èƒ½è¶…å‡ºäº†è¦æ±‚ã€‚ä¸€æ—¦ç»‘å®šï¼ŒPersistentVolumeClaimç»‘å®šæ˜¯æ’ä»–çš„ï¼Œä¸ç®¡ç”¨äºç»‘å®šå®ƒä»¬çš„æ¨¡å¼ã€‚&lt;/p>
&lt;p>å¦‚æœåŒ¹é…çš„å·ä¸å­˜åœ¨ï¼Œè¯·æ±‚å°†æ— é™æœŸåœ°ä¿æŒã€‚ éšç€åŒ¹é…å·å˜å¾—å¯ç”¨ï¼Œè¯·æ±‚å°†è¢«ç»‘å®šã€‚ ä¾‹å¦‚ï¼Œæä¾›è®¸å¤š50Gi PVçš„é›†ç¾¤å°†ä¸åŒ¹é…è¦æ±‚100Giçš„PVCã€‚ å½“é›†ç¾¤ä¸­æ·»åŠ 100Gi PVæ—¶ï¼Œå¯ä»¥ç»‘å®šPVCã€‚&lt;/p>
&lt;h3 id="ä½¿ç”¨ä½¿ç”¨">ä½¿ç”¨(ä½¿ç”¨)&lt;/h3>
&lt;p>PODsæŠŠPVCå½“åšvolumeä½¿ç”¨ã€‚é›†ç¾¤æ£€æŸ¥å£°æ˜ä»¥æ‰¾åˆ°ç»‘å®šçš„å·å¹¶ä¸ºPODæŒ‚è½½è¯¥å·ã€‚ å¯¹äºæ”¯æŒå¤šç§è®¿é—®æ¨¡å¼çš„å·ï¼Œç”¨æˆ·åœ¨å°†å…¶å£°æ˜ç”¨ä½œpodä¸­çš„å·æ—¶æŒ‡å®šæ‰€éœ€çš„æ¨¡å¼ã€‚&lt;/p>
&lt;p>ä¸€æ—¦ç”¨æˆ·æœ‰å£°æ˜å¹¶ä¸”è¯¥å£°æ˜è¢«ç»‘å®šï¼Œç»‘å®šçš„PVå±äºç”¨æˆ·ï¼Œåªè¦ä»–ä»¬éœ€è¦å®ƒã€‚ ç”¨æˆ·é€šè¿‡åœ¨å…¶Podçš„å·å—ä¸­åŒ…å«persistentVolumeClaimæ¥å®‰æ’Podså¹¶è®¿é—®å…¶å£°æ˜çš„PVã€‚ è¯·å‚é˜…ä¸‹é¢çš„è¯­æ³•è¯¦ç»†ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myfrontend&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dockerfile/nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/var/www/html&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeClaim&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">claimName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myclaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å›æ”¶reclaiming">å›æ”¶(Reclaiming)&lt;/h3>
&lt;p>å½“ç”¨æˆ·ä½¿ç”¨å®Œvolumeï¼Œå¯ä»¥é€šè¿‡è¯·æ±‚å…è®¸å›æ”¶èµ„æºçš„APIæ¥åˆ é™¤è¯¥PVCå¯¹è±¡ã€‚PersistentVolumeçš„å›æ”¶ç­–ç•¥å‘Šè¯‰é›†ç¾¤å¦‚ä½•å¤„ç†å½“å£°æ˜é‡Šæ”¾PVåã€‚ç›®å‰ï¼Œå·å¯ä»¥è¢«ä¿ç•™ï¼Œå›æ”¶æˆ–åˆ é™¤ã€‚&lt;/p>
&lt;h4 id="ä¿ç•™retaining">ä¿ç•™(Retaining)&lt;/h4>
&lt;p>ä¿ç•™å›æ”¶ç­–ç•¥å…è®¸æ‰‹åŠ¨å›æ”¶èµ„æºã€‚ å½“PersistentVolumeClaimè¢«åˆ é™¤æ—¶ï¼ŒPersistentVolumeä»ç„¶å­˜åœ¨ï¼Œå¹¶ä¸”è¯¥å·è¢«è®¤ä¸ºæ˜¯â€œé‡Šæ”¾çš„â€ã€‚ ä½†æ˜¯ï¼Œç”±äºä¸Šä¸€ä¸ªå£°æ˜è€…çš„æ•°æ®ä»ä¿ç•™åœ¨å·ä¸Šï¼Œå› æ­¤å°šä¸å¯ç”¨äºå…¶ä»–å£°æ˜ã€‚ ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨å›æ”¶å·ã€‚&lt;/p>
&lt;ul>
&lt;li>åˆ é™¤PersistentVolumeã€‚ åˆ é™¤PVåï¼Œå¤–éƒ¨åŸºç¡€è®¾æ–½ï¼ˆå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–Cinderå·ï¼‰ä¸­çš„å…³è”å­˜å‚¨èµ„äº§ä»ç„¶å­˜åœ¨ã€‚&lt;/li>
&lt;li>ç›¸åº”åœ°æ‰‹åŠ¨æ¸…ç†ç›¸å…³å­˜å‚¨èµ„äº§ä¸Šçš„æ•°æ®ã€‚&lt;/li>
&lt;li>æ‰‹åŠ¨åˆ é™¤å…³è”çš„å­˜å‚¨èµ„äº§ï¼Œæˆ–è€…å¦‚æœè¦é‡ç”¨ç›¸åŒçš„å­˜å‚¨èµ„äº§ï¼Œè¯·ä½¿ç”¨å­˜å‚¨èµ„äº§å®šä¹‰åˆ›å»ºä¸€ä¸ªæ–°çš„PersistentVolumeã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="å›æ”¶recycling">å›æ”¶(Recycling)&lt;/h4>
&lt;p>å¦‚æœå—ç›¸åº”çš„å·æ’ä»¶æ”¯æŒï¼Œå›æ”¶å°†å¯¹å·æ‰§è¡ŒåŸºæœ¬çš„æ“¦é™¤ï¼ˆrm -rf / thevolume / *ï¼‰ï¼Œå¹¶ä½¿å…¶å†æ¬¡å¯ç”¨äºæ–°çš„å£°æ˜ã€‚
ä½†æ˜¯ï¼Œç®¡ç†å‘˜å¯ä»¥ä½¿ç”¨Kubernetesæ§åˆ¶å™¨ç®¡ç†å™¨å‘½ä»¤è¡Œå‚æ•°æ¥é…ç½®è‡ªå®šä¹‰çš„å›æ”¶å™¨podæ¨¡æ¿ï¼Œå¦‚&lt;a href="https://kubernetes.io/docs/admin/kube-controller-manager/">è¿™é‡Œ&lt;/a>æ‰€è¿°ã€‚ å®šåˆ¶å›æ”¶ç«™æ¨¡æ¿å¿…é¡»åŒ…å«å·è§„èŒƒï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pv-recycler-&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Never&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">vol&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/any/path/it/will/be/replaced&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pv-recycler&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;gcr.io/google_containers/busybox&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/bin/sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;-c&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;test -e /scrub &amp;amp;&amp;amp; rm -rf /scrub/..?* /scrub/.[!.]* /scrub/* &amp;amp;&amp;amp; test -z \&amp;#34;$(ls -A /scrub)\&amp;#34; || exit 1&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">vol&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/scrub&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯ï¼Œå·éƒ¨åˆ†ä¸­çš„è‡ªå®šä¹‰å›æ”¶å™¨podæ¨¡æ¿ä¸­æŒ‡å®šçš„ç‰¹å®šè·¯å¾„å°†æ›¿æ¢ä¸ºæ­£åœ¨å›æ”¶çš„å·çš„ç‰¹å®šè·¯å¾„ã€‚&lt;/p>
&lt;h4 id="åˆ é™¤deleting">åˆ é™¤(Deleting)&lt;/h4>
&lt;p>å¯¹äºæ”¯æŒâ€œåˆ é™¤å›æ”¶â€ç­–ç•¥çš„å·æ’ä»¶ï¼Œåˆ é™¤å°†ä»Kubernetesä¸­åˆ é™¤PersistentVolumeå¯¹è±¡ï¼Œå¹¶åˆ é™¤å¤–éƒ¨åŸºç¡€æ¶æ„ï¼ˆå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–Cinderå·ï¼‰ä¸­å…³è”çš„å­˜å‚¨èµ„äº§ã€‚ åŠ¨æ€é…ç½®çš„å·å§‹ç»ˆè¢«åˆ é™¤ã€‚ å¦‚æœä¸å¸Œæœ›è¿™æ ·åšï¼Œç›®å‰å”¯ä¸€çš„é€‰æ‹©æ˜¯åœ¨åˆ›å»ºPVä¹‹åç¼–è¾‘æˆ–ä¿®è¡¥PVã€‚ è¯·å‚é˜…&lt;a href="https://kubernetes.io/docs/tasks/administer-cluster/change-pv-reclaim-policy/">æ›´æ”¹PersistentVolumeçš„å›æ”¶ç­–ç•¥&lt;/a>ã€‚&lt;/p>
&lt;h3 id="persistent-volumeçš„ç±»å‹">Persistent Volumeçš„ç±»å‹&lt;/h3>
&lt;ul>
&lt;li>GCEPersistentDisk&lt;/li>
&lt;li>AWSElasticBlockStore&lt;/li>
&lt;li>AzureFile&lt;/li>
&lt;li>AzureDisk&lt;/li>
&lt;li>FC (Fibre Channel)&lt;/li>
&lt;li>FlexVolume&lt;/li>
&lt;li>Flocker&lt;/li>
&lt;li>NFS&lt;/li>
&lt;li>iSCSI&lt;/li>
&lt;li>RBD (Ceph Block Device)&lt;/li>
&lt;li>CephFS&lt;/li>
&lt;li>Cinder (OpenStack block storage)&lt;/li>
&lt;li>Glusterfs&lt;/li>
&lt;li>VsphereVolume&lt;/li>
&lt;li>Quobyte Volumes&lt;/li>
&lt;li>HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)&lt;/li>
&lt;li>VMware Photon&lt;/li>
&lt;li>Portworx Volumes&lt;/li>
&lt;li>ScaleIO Volumes&lt;/li>
&lt;li>StorageOS&lt;/li>
&lt;/ul>
&lt;h2 id="persistent-volumes">Persistent Volumes&lt;/h2>
&lt;p>æ¯ä¸ªPVéƒ½åŒ…å«è§„æ ¼å’ŒçŠ¶æ€ï¼Œè¿™æ˜¯è§„æ ¼å’ŒçŠ¶æ€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolume&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pv0003&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">capacity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">5Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeReclaimPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Recycle&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">slow&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">nfs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/tmp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">172.17.0.2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®¹é‡">å®¹é‡&lt;/h3>
&lt;p>é€šå¸¸ï¼ŒPVå°†å…·æœ‰ç‰¹å®šçš„å­˜å‚¨å®¹é‡ã€‚è¿™æ˜¯ä½¿ç”¨PVçš„&lt;code>capacity&lt;/code>å±æ€§è®¾ç½®çš„ã€‚çœ‹åˆ°Kubernetesçš„&lt;a href="https://git.k8s.io/community/contributors/design-proposals/resources.md">èµ„æºæ¨¡å‹&lt;/a>ï¼Œä»¥äº†è§£å®¹é‡ä½¿ç”¨çš„å•ä½ã€‚&lt;/p>
&lt;p>ç›®å‰ï¼Œå­˜å‚¨å¤§å°æ˜¯å”¯ä¸€å¯ä»¥è®¾ç½®æˆ–è¯·æ±‚çš„èµ„æºã€‚æœªæ¥çš„å±æ€§å¯èƒ½åŒ…æ‹¬IOPSï¼Œååé‡ç­‰ã€‚&lt;/p>
&lt;h3 id="è®¿é—®æ¨¡å¼">è®¿é—®æ¨¡å¼&lt;/h3>
&lt;p>PersistentVolumeå¯ä»¥ä»¥èµ„æºæä¾›è€…æ”¯æŒçš„ä»»ä½•æ–¹å¼å®‰è£…åœ¨ä¸»æœºä¸Šã€‚ å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œæä¾›è€…å°†å…·æœ‰ä¸åŒçš„ç‰¹æ€§ï¼Œæ¯ä¸ªPVçš„è®¿é—®æ¨¡å¼éƒ½è¢«è®¾ç½®ä¸ºè¯¥ç‰¹å®šå·æ”¯æŒçš„ç‰¹å®šæ¨¡å¼ã€‚ ä¾‹å¦‚ï¼ŒNFSå¯ä»¥æ”¯æŒå¤šä¸ªè¯»/å†™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯ç‰¹å®šçš„NFS PVå¯èƒ½ä¼šä»¥åªè¯»æ–¹å¼åœ¨æœåŠ¡å™¨ä¸Šå¯¼å‡ºã€‚ æ¯ä¸ªPVéƒ½æœ‰è‡ªå·±çš„ä¸€ç»„è®¿é—®æ¨¡å¼æ¥æè¿°å…·ä½“çš„PVåŠŸèƒ½ã€‚&lt;/p>
&lt;p>è®¿é—®æ¨¡å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>ReadWriteOnce - å·å¯ä»¥ç”±å•ä¸ªèŠ‚ç‚¹ä½œä¸ºè¯»å†™è£…è½½&lt;/li>
&lt;li>ReadOnlyMany - è®¸å¤šèŠ‚ç‚¹å¯ä»¥åªè¯»å®¹é‡&lt;/li>
&lt;li>ReadWriteMany - å·å¯ä»¥é€šè¿‡è®¸å¤šèŠ‚ç‚¹çš„è¯»å†™è£…è½½&lt;/li>
&lt;/ul>
&lt;p>åœ¨CLIä¸­ï¼Œè®¿é—®æ¨¡å¼ç¼©å†™ä¸ºï¼š&lt;/p>
&lt;ul>
&lt;li>RWO - ReadWriteOnce&lt;/li>
&lt;li>ROX - ReadOnlyMany&lt;/li>
&lt;li>RWX - ReadWriteMany&lt;/li>
&lt;/ul>
&lt;p>é‡è¦ï¼ä¸€ä¸ªå·åªèƒ½ä¸€æ¬¡ä½¿ç”¨ä¸€ç§è®¿é—®æ¨¡å¼è¿›è¡ŒæŒ‚è½½ï¼Œå³ä½¿å®ƒæ”¯æŒå¾ˆå¤šã€‚ä¾‹å¦‚ï¼ŒGCEPersistentDiskå¯ä»¥ç”±å•ä¸ªèŠ‚ç‚¹æŒ‚è½½ä¸ºReadWriteOnceæˆ–å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½ä¸ºReadOnlyManyï¼Œä½†ä¸èƒ½åŒæ—¶ä½¿ç”¨ä¸¤ç§ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Volumeæ’ä»¶&lt;/th>
&lt;th>å•èŠ‚ç‚¹è¯»å†™&lt;/th>
&lt;th>å¤šä¸ªèŠ‚ç‚¹åªè¯»&lt;/th>
&lt;th>å¤šä¸ªèŠ‚ç‚¹è¯»å†™&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>AWSElasticBlockStore&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AzureFile&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AzureDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>CephFS&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Cinder&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>FC&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>FlexVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Flocker&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GCEPersistentDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Glusterfs&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>HostPath&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>iSCSI&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PhotonPersistentDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Quobyte&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>NFS&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>RBD&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>VsphereVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PortworxVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ScaleIO&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>StorageOS&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="ç±»å‹">ç±»å‹&lt;/h3>
&lt;p>PVå¯ä»¥æœ‰ä¸€ä¸ªç±»å‹ï¼Œé€šè¿‡å°†storageClassNameå±æ€§è®¾ç½®ä¸ºStorageClassçš„åç§°æ¥æŒ‡å®šã€‚ ç‰¹å®šç±»å‹çš„PVåªèƒ½ç»‘å®šåˆ°è¯·æ±‚è¯¥ç±»å‹çš„PVCã€‚ æ²¡æœ‰storageClassNameçš„PVæ²¡æœ‰ç±»å‹ï¼Œåªèƒ½ç»‘å®šåˆ°ä¸éœ€è¦ç‰¹å®šç±»å‹çš„PVCã€‚
åœ¨è¿‡å»ï¼Œä½¿ç”¨äº†æ³¨é‡Švolume.beta.kubernetes.io/storage-classè€Œä¸æ˜¯storageClassNameå±æ€§ã€‚ è¯¥æ³¨é‡Šä»ç„¶å¯ä»¥å·¥ä½œï¼Œä½†å°†æ¥Kubernetesç‰ˆæœ¬å°†ä¸å†é€‚ç”¨ã€‚&lt;/p>
&lt;h3 id="å›æ”¶ç­–ç•¥">å›æ”¶ç­–ç•¥&lt;/h3>
&lt;p>ç›®å‰çš„å›æ”¶ç­–ç•¥æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>Retain - æ‰‹åŠ¨å›æ”¶&lt;/li>
&lt;li>Recycle - åŸºæœ¬æ“¦æ´—ï¼ˆâ€œrm -rf / thevolume / *â€ï¼‰&lt;/li>
&lt;li>Delete - ç›¸å…³è”çš„å­˜å‚¨èµ„äº§ï¼Œå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–OpenStack Cinderå·è¢«åˆ é™¤&lt;/li>
&lt;/ul>
&lt;p>ç›®å‰ï¼Œåªæœ‰NFSå’ŒHostPathæ”¯æŒå›æ”¶ã€‚ AWS EBSï¼ŒGCE PDï¼ŒAzure Diskå’ŒCinderå·æ”¯æŒåˆ é™¤ã€‚&lt;/p>
&lt;h3 id="é˜¶æ®µ">é˜¶æ®µ&lt;/h3>
&lt;p>å·å°†å¤„äºä»¥ä¸‹é˜¶æ®µä¹‹ä¸€ï¼š&lt;/p>
&lt;ul>
&lt;li>Available å¯ç”¨ - ä¸€ä¸ªå°šæœªç»‘å®šåˆ°ç´¢èµ”çš„å…è´¹èµ„æº&lt;/li>
&lt;li>Bound ç»‘å®š - éŸ³é‡å¿…é¡»æ˜¯å£°æ˜&lt;/li>
&lt;li>Released é‡Šæ”¾ - å£°æ˜å·²è¢«åˆ é™¤ï¼Œä½†èµ„æºå°šæœªè¢«é›†ç¾¤å›æ”¶&lt;/li>
&lt;li>Failed å¤±è´¥ - å·è‡ªåŠ¨å›æ”¶å¤±è´¥&lt;/li>
&lt;/ul>
&lt;p>CLIå°†æ˜¾ç¤ºç»‘å®šåˆ°PVçš„PVCçš„åç§°ã€‚&lt;/p>
&lt;h3 id="æŒ‚è½½é€‰é¡¹">æŒ‚è½½é€‰é¡¹&lt;/h3>
&lt;p>Kubernetesç®¡ç†å‘˜å¯ä»¥æŒ‡å®šåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸ŠæŒ‚è½½ä¸€ä¸ªæŒä¹…å·æ—¶çš„å…¶ä»–æŒ‚è½½é€‰é¡¹ã€‚&lt;/p>
&lt;p>æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨æŒä¹…å·ä¸Šçš„æ³¨é‡Švolume.beta.kubernetes.io/mount-optionsæ¥æŒ‡å®šå®‰è£…é€‰é¡¹ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;v1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;PersistentVolume&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gce-disk-1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volume.beta.kubernetes.io/mount-options&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;discard&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">capacity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;10Gi&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;ReadWriteOnce&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">gcePersistentDisk&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fsType&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;ext4&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">pdName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;gce-disk-1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®‰è£…é€‰é¡¹æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨å°†å·å®‰è£…åˆ°ç£ç›˜æ—¶å°†è¢«ç´¯ç§¯åœ°è¿æ¥å’Œä½¿ç”¨ã€‚&lt;/p>
&lt;p>è¯·æ³¨æ„ï¼Œå¹¶éæ‰€æœ‰Persistentå·ç±»å‹éƒ½æ”¯æŒæŒ‚è½½é€‰é¡¹ã€‚ åœ¨Kubernetes 1.6ç‰ˆä¸­ï¼Œä»¥ä¸‹å·ç±»å‹æ”¯æŒæŒ‚è½½é€‰é¡¹ã€‚&lt;/p>
&lt;ul>
&lt;li>GCEPersistentDisk&lt;/li>
&lt;li>AWSElasticBlockStore&lt;/li>
&lt;li>AzureFile&lt;/li>
&lt;li>AzureDisk&lt;/li>
&lt;li>NFS&lt;/li>
&lt;li>iSCSI&lt;/li>
&lt;li>RBD (Ceph Block Device)&lt;/li>
&lt;li>CephFS&lt;/li>
&lt;li>Cinder (OpenStack block storage)&lt;/li>
&lt;li>Glusterfs&lt;/li>
&lt;li>VsphereVolume&lt;/li>
&lt;li>Quobyte Volumes&lt;/li>
&lt;li>VMware Photon&lt;/li>
&lt;/ul>
&lt;h2 id="persistentvolumeclaims">PersistentVolumeClaims&lt;/h2>
&lt;p>æ¯ä¸ªPVCåŒ…å«è§„æ ¼å’ŒçŠ¶æ€ï¼Œè¿™æ˜¯å£°æ˜çš„è§„èŒƒå’ŒçŠ¶æ€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolumeClaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myclaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">8Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">slow&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">release&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;stable&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- {&lt;span class="nt">key: environment, operator: In, values&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="l">dev]}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è®¿é—®æ¨¡å¼-1">è®¿é—®æ¨¡å¼&lt;/h3>
&lt;p>å½“è¯·æ±‚å…·æœ‰ç‰¹å®šè®¿é—®æ¨¡å¼çš„å­˜å‚¨æ—¶ï¼Œå£°æ˜ä½¿ç”¨ä¸å·ç›¸åŒçš„çº¦å®šã€‚&lt;/p>
&lt;h3 id="èµ„æº">èµ„æº&lt;/h3>
&lt;p>å£°æ˜ï¼ˆå°±åƒpodsï¼‰å¯ä»¥è¯·æ±‚ç‰¹å®šæ•°é‡çš„èµ„æºã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·æ±‚ç”¨äºå­˜å‚¨ã€‚ ç›¸åŒçš„èµ„æºæ¨¡å‹é€‚ç”¨äºå·å’Œå£°æ˜ã€‚&lt;/p>
&lt;h3 id="é€‰æ‹©å™¨">é€‰æ‹©å™¨&lt;/h3>
&lt;p>å£°æ˜å¯ä»¥æŒ‡å®šæ ‡ç­¾é€‰æ‹©å™¨ä»¥è¿›ä¸€æ­¥è¿‡æ»¤Volumesé›†ã€‚ åªæœ‰æ ‡ç­¾ä¸é€‰æ‹©å™¨åŒ¹é…çš„å·æ‰èƒ½ç»‘å®šåˆ°å£°æ˜ã€‚ é€‰æ‹©å™¨å¯ä»¥ç”±ä¸¤ä¸ªå­—æ®µç»„æˆï¼š&lt;/p>
&lt;ul>
&lt;li>matchLabels - å·å¿…é¡»å…·æœ‰å¸¦æ­¤å€¼çš„æ ‡ç­¾&lt;/li>
&lt;li>matchExpressions - é€šè¿‡æŒ‡å®šå…³é”®å­—å’Œå€¼çš„å…³é”®å­—ï¼Œå€¼åˆ—è¡¨å’Œè¿ç®—ç¬¦æ‰€åšçš„è¦æ±‚åˆ—è¡¨ã€‚ æœ‰æ•ˆè¿ç®—ç¬¦åŒ…æ‹¬Inï¼ŒNotInï¼ŒExistså’ŒDoesNotExistã€‚&lt;/li>
&lt;/ul>
&lt;p>æ‰€æœ‰æ¥è‡ªmatchLabelså’ŒmatchExpressionsçš„è¦æ±‚æ˜¯ç»„åˆåœ¨ä¸€èµ·çš„ï¼Œæ‰€æœ‰è¿™äº›è¦æ±‚éƒ½å¿…é¡»æ»¡è¶³æ‰èƒ½åŒ¹é…ã€‚&lt;/p>
&lt;h3 id="ç±»å‹-1">ç±»å‹&lt;/h3>
&lt;p>å£°æ˜å¯ä»¥é€šè¿‡ä½¿ç”¨å±æ€§storageClassNameæŒ‡å®šStorageClassçš„åç§°æ¥è¯·æ±‚ç‰¹å®šçš„ç±»å‹ã€‚åªæœ‰æ‰€è¯·æ±‚çš„ç±»å‹çš„PVï¼Œä¸PVCç›¸åŒçš„storageClassNameçš„PVå¯ä»¥ç»‘å®šåˆ°PVCã€‚&lt;/p>
&lt;p>PVCä¸ä¸€å®šè¦æ±‚ä¸€ä¸ªç±»å‹ã€‚ å®ƒçš„storageClassNameè®¾ç½®ä¸ºç­‰äºâ€œâ€çš„PVCæ€»æ˜¯è¢«è§£é‡Šä¸ºè¯·æ±‚æ²¡æœ‰ç±»å‹çš„PVï¼Œå› æ­¤å®ƒåªèƒ½ç»‘å®šåˆ°æ²¡æœ‰ç±»å‹çš„PVï¼ˆæ²¡æœ‰æ³¨é‡Šæˆ–ä¸€ä¸ªç­‰äºâ€œâ€ï¼‰ã€‚ æ²¡æœ‰storageClassNameçš„PVCä¸å®Œå…¨ç›¸åŒï¼Œå¹¶ä¸”æ ¹æ®æ˜¯å¦å¯ç”¨äº†DefaultStorageClass admissionæ’ä»¶ï¼Œé›†ç¾¤çš„å¤„ç†æ–¹å¼ä¸åŒã€‚&lt;/p>
&lt;ul>
&lt;li>å¦‚æœadmissionæ’ä»¶å·²æ‰“å¼€ï¼Œåˆ™ç®¡ç†å‘˜å¯ä»¥æŒ‡å®šé»˜è®¤çš„StorageClassã€‚ æ²¡æœ‰storageClassNameçš„æ‰€æœ‰PVCåªèƒ½ç»‘å®šåˆ°è¯¥é»˜è®¤çš„PVã€‚ é€šè¿‡å°†StorageClasså¯¹è±¡ä¸­çš„æ³¨è§£storageclass.kubernetes.io/is-default-classè®¾ç½®ä¸ºâ€œtrueâ€æ¥æŒ‡å®šé»˜è®¤çš„StorageClassã€‚ å¦‚æœç®¡ç†å‘˜æ²¡æœ‰æŒ‡å®šé»˜è®¤å€¼ï¼Œåˆ™é›†ç¾¤ä¼šå¯¹PVCåˆ›å»ºåšå‡ºå“åº”ï¼Œå°±åƒadmissionæ’ä»¶è¢«å…³é—­ä¸€æ ·ã€‚ å¦‚æœæŒ‡å®šäº†å¤šä¸ªé»˜è®¤å€¼ï¼Œåˆ™admissionæ’ä»¶ç¦æ­¢åˆ›å»ºæ‰€æœ‰PVCã€‚&lt;/li>
&lt;li>å¦‚æœadmissionæ’ä»¶å·²å…³é—­ï¼Œåˆ™ä¸å­˜åœ¨é»˜è®¤StorageClassçš„æ¦‚å¿µã€‚ æ²¡æœ‰&lt;code>storageClassName&lt;/code>çš„æ‰€æœ‰PVCåªèƒ½ç»‘å®šåˆ°æ²¡æœ‰ç±»çš„PVã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ²¡æœ‰&lt;code>storageClassName&lt;/code>çš„PVCçš„å¤„ç†æ–¹å¼ä¸å°†å…¶&lt;code>storageClassName&lt;/code>è®¾ç½®ä¸ºâ€œâ€çš„PVCç›¸åŒã€‚&lt;/li>
&lt;/ul>
&lt;p>æ ¹æ®æŒ‚è½½æ–¹æ³•ï¼ŒæŒ‚è½½è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡addon manageråœ¨Kubernetesç¾¤é›†ä¸­éƒ¨ç½²é»˜è®¤çš„&lt;code>StorageClass&lt;/code>ã€‚&lt;/p>
&lt;p>å½“PVCæŒ‡å®šä¸€ä¸ªé€‰æ‹©å™¨ï¼Œé™¤äº†è¯·æ±‚ä¸€ä¸ª&lt;code>StorageClass&lt;/code>ä¹‹å¤–ï¼Œè¿™äº›è¦æ±‚è¢«ANDç»„åˆåœ¨ä¸€èµ·ï¼šåªæœ‰æ‰€è¯·æ±‚çš„ç±»å’Œæ‰€è¯·æ±‚çš„æ ‡ç­¾çš„PVå¯èƒ½è¢«ç»‘å®šåˆ°PVCã€‚ è¯·æ³¨æ„ï¼Œå½“å‰ï¼Œå…·æœ‰éç©ºé€‰æ‹©å™¨çš„PVCä¸èƒ½ä¸ºå…¶åŠ¨æ€é…ç½®PVã€‚&lt;/p>
&lt;p>åœ¨è¿‡å»ï¼Œä½¿ç”¨äº†æ³¨è§£&lt;code>volume.beta.kubernetes.io/storage-class&lt;/code>ï¼Œè€Œä¸æ˜¯&lt;code>storageClassName&lt;/code>å±æ€§ã€‚ è¯¥æ³¨è§£ä»ç„¶å¯ä»¥å·¥ä½œï¼Œä½†åœ¨æœªæ¥çš„Kubernetesç‰ˆæœ¬ä¸­å®ƒå°†ä¸è¢«æ”¯æŒã€‚&lt;/p>
&lt;h2 id="claims-vs-volumes">Claims VS Volumes&lt;/h2>
&lt;p>Podsé€šè¿‡å°†å£°æ˜ç”¨ä½œå·æ¥è®¿é—®å­˜å‚¨ã€‚ å£°æ˜å¿…é¡»å­˜åœ¨äºä¸ä½¿ç”¨å£°æ˜çš„podç›¸åŒçš„å‘½åç©ºé—´ä¸­ã€‚ é›†ç¾¤åœ¨podçš„å‘½åç©ºé—´ä¸­æŸ¥æ‰¾å£°æ˜ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥è·å–æ”¯æŒå£°æ˜çš„&lt;code>PersistentVolume&lt;/code>ã€‚ ç„¶åå°†å·æŒ‚è½½åˆ°ä¸»æœºå¹¶è¿›å…¥podã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myfrontend&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dockerfile/nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/var/www/html&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeClaim&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">claimName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myclaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å…³äºå‘½åç©ºé—´çš„æ³¨æ„">å…³äºå‘½åç©ºé—´çš„æ³¨æ„&lt;/h3>
&lt;p>&lt;code>PersistentVolumes&lt;/code>ç»‘å®šæ˜¯ç‹¬å çš„ï¼Œå¹¶ä¸”ç”±äº&lt;code>PersistentVolumeClaims&lt;/code>æ˜¯å‘½åç©ºé—´å¯¹è±¡ï¼Œå› æ­¤åªèƒ½åœ¨ä¸€ä¸ªå‘½åç©ºé—´å†…æŒ‚è½½â€œmanyâ€æ¨¡å¼ï¼ˆROXï¼ŒRWXï¼‰çš„å£°æ˜ã€‚&lt;/p>
&lt;h2 id="storageclasses">StorageClasses&lt;/h2>
&lt;p>æ¯ä¸ª&lt;code>StorageClass&lt;/code>åŒ…å«å­—æ®µ&lt;code>provisioninger&lt;/code>å’Œ&lt;code>parameter&lt;/code>ï¼Œå½“å±äºç±»å‹çš„&lt;code>PersistentVolume&lt;/code>éœ€è¦åŠ¨æ€é…ç½®æ—¶ä½¿ç”¨ã€‚&lt;/p>
&lt;p>&lt;code>StorageClass&lt;/code>å¯¹è±¡çš„åç§°å¾ˆé‡è¦ï¼Œç”¨æˆ·å¯ä»¥å¦‚ä½•è¯·æ±‚ç‰¹å®šçš„ç±»ã€‚ ç®¡ç†å‘˜åœ¨é¦–æ¬¡åˆ›å»º&lt;code>StorageClass&lt;/code>å¯¹è±¡æ—¶è®¾ç½®ç±»çš„åç§°å’Œå…¶ä»–å‚æ•°ï¼Œå¹¶ä¸”åœ¨åˆ›å»ºå¯¹è±¡åæ— æ³•æ›´æ–°å¯¹è±¡ã€‚&lt;/p>
&lt;p>ç®¡ç†å‘˜å¯ä»¥ä»…ä¸ºä¸è¦æ±‚ä»»ä½•ç‰¹å®šç±»ç»‘å®šçš„PVCæŒ‡å®šé»˜è®¤çš„StorageClassï¼šæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">PersistentVolumeClaim&lt;/a>éƒ¨åˆ†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">StorageClass&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">storage.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">standard&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">provisioner&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubernetes.io/aws-ebs&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">parameters&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gp2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ä¾›åº”è€…provisioner">ä¾›åº”è€…(Provisioner)&lt;/h3>
&lt;p>å­˜å‚¨ç±»æœ‰ä¸€ä¸ªä¾›åº”è€…ï¼Œå®ƒç¡®å®šç”¨äºé…ç½®PVçš„å·æ’ä»¶ã€‚å¿…é¡»æŒ‡å®šæ­¤å­—æ®µã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Volume Plugin&lt;/th>
&lt;th>Internal Provisioner&lt;/th>
&lt;th>Config Example&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>AWSElasticBlockStore&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#aws">AWS&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AzureFile&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#azure-file">Azure File&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AzureDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#azure-disk">Azure Disk&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>CephFS&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Cinder&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#openstack-cinder">OpenStack Cinder&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>FC&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>FlexVolume&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Flocker&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GCEPersistentDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#gce">GCE&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Glusterfs&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#glusterfs">Glusterfs&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>iSCSI&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PhotonPersistentDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Quobyte&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#quobyte">Quobyte&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>NFS&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>RBD&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#ceph-rbd">Ceph RBD&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>VsphereVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#vsphere">vSphere&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PortworxVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#portworx-volume">Portworx Volume&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ScaleIO&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#scaleio">ScaleIO&lt;/a>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>ä½ ä¸é™äºæŒ‡å®šæ­¤å¤„åˆ—å‡ºçš„â€œinternalâ€ä¾›åº”è€…ï¼ˆå…¶åç§°å‰ç¼€ä¸ºâ€œkubernetes.ioâ€å¹¶ä¸Kubernetesä¸€èµ·å‘é€ï¼‰ã€‚ ä½ è¿˜å¯ä»¥è¿è¡Œå’ŒæŒ‡å®šå¤–éƒ¨æä¾›ç¨‹åºï¼Œå®ƒä»¬æ˜¯éµå¾ªKuberneteså®šä¹‰çš„è§„èŒƒçš„ç‹¬ç«‹ç¨‹åºã€‚ å¤–éƒ¨æä¾›è€…çš„ä½œè€…å¯¹ä»£ç çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¾›åº”å•†çš„è¿è¾“çŠ¶å†µï¼Œè¿è¡ŒçŠ¶å†µä»¥åŠä½¿ç”¨çš„å·æ’ä»¶ï¼ˆåŒ…æ‹¬Flexï¼‰ç­‰éƒ½æœ‰å……åˆ†çš„è‡ªä¸»æƒã€‚å­˜å‚¨åº“kubernetes-incubator /å¤–éƒ¨å­˜å‚¨åº“åŒ…å«ä¸€ä¸ªåº“ ç”¨äºç¼–å†™å®æ–½å¤§éƒ¨åˆ†è§„èŒƒçš„å¤–éƒ¨æä¾›è€…ä»¥åŠå„ç§ç¤¾åŒºç»´æŠ¤çš„å¤–éƒ¨æä¾›è€…ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼ŒNFSä¸æä¾›å†…éƒ¨æä¾›ç¨‹åºï¼Œä½†å¯ä»¥ä½¿ç”¨å¤–éƒ¨æä¾›ç¨‹åºã€‚ ä¸€äº›å¤–éƒ¨æä¾›è€…åˆ—åœ¨å­˜å‚¨åº“kubernetes-incubator/external-storageä¸­ã€‚ è¿˜æœ‰ç¬¬ä¸‰æ–¹å­˜å‚¨ä¾›åº”å•†æä¾›è‡ªå·±çš„å¤–éƒ¨ä¾›åº”å•†çš„æƒ…å†µã€‚&lt;/p>
&lt;h3 id="å›æ”¶ç­–ç•¥-1">å›æ”¶ç­–ç•¥&lt;/h3>
&lt;p>ç”±å­˜å‚¨ç±»åŠ¨æ€åˆ›å»ºçš„æŒä¹…å·å°†å…·æœ‰&lt;code>delete&lt;/code>çš„å›æ”¶ç­–ç•¥ã€‚ å¦‚æœä¸å¸Œæœ›è¿™æ ·åšï¼Œå”¯ä¸€çš„å½“å‰é€‰é¡¹æ˜¯åœ¨åˆ›å»ºPVä¹‹åç¼–è¾‘PVã€‚&lt;/p>
&lt;p>é€šè¿‡å­˜å‚¨ç±»æ‰‹åŠ¨åˆ›å»ºå’Œç®¡ç†çš„æŒä¹…å·å°†å…·æœ‰åœ¨åˆ›å»ºæ—¶åˆ†é…çš„ä»»ä½•å›æ”¶ç­–ç•¥ã€‚&lt;/p>
&lt;h3 id="å‚æ•°">å‚æ•°&lt;/h3>
&lt;p>å­˜å‚¨ç±»å‹å…·æœ‰æè¿°å±äºå­˜å‚¨ç±»å‹çš„å·çš„å‚æ•°ã€‚ å–å†³äºä¾›åº”è€…ï¼Œå¯ä»¥æ¥å—ä¸åŒçš„å‚æ•°ã€‚ ä¾‹å¦‚ï¼Œå‚æ•°ç±»å‹çš„å€¼io1å’Œå‚æ•°iopsPerGBç‰¹å®šäºEBSã€‚ å½“çœç•¥å‚æ•°æ—¶ï¼Œä½¿ç”¨ä¸€äº›é»˜è®¤å€¼ã€‚&lt;/p></description></item><item><title>Kuberneteså­¦ä¹  â€” Macoså®‰è£…Kubernetes</title><link>https://atbug.com/install-kubernetes-on-macos/</link><pubDate>Thu, 17 Aug 2017 09:44:17 +0000</pubDate><guid>https://atbug.com/install-kubernetes-on-macos/</guid><description>
&lt;h1 id="kubernetes">Kubernetes&lt;/h1>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;h2 id="macos">macos&lt;/h2>
&lt;h3 id="æ£€æŸ¥ç¯å¢ƒ">æ£€æŸ¥ç¯å¢ƒ&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">sysctl -a &lt;span class="p">|&lt;/span> grep machdep.cpu.features &lt;span class="p">|&lt;/span> grep VMX
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…virtualbox">å®‰è£…VirtualBox&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">http://download.virtualbox.org/virtualbox/5.1.26/Oracle_VM_VirtualBox_Extension_Pack-5.1.26-117224.vbox-extpack
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…minikube">å®‰è£…minikube&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.21.0/minikube-darwin-amd64 &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> chmod +x minikube &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> sudo mv minikube /usr/local/bin/
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ›å»ºé›†ç¾¤">åˆ›å»ºé›†ç¾¤&lt;/h3>
&lt;p>é»˜è®¤ä½¿ç”¨virtualboxã€‚&lt;/p>
&lt;p>ä¸»æœºçš„ipæ˜¯&lt;code>192.168.31.186&lt;/code>ï¼Œ &lt;code>1087&lt;/code>æ˜¯proxyçš„ç«¯å£ã€‚éœ€è¦å°†ssçš„httpä»£ç†ç›‘å¬åœ°å€ä»&lt;code>127.0.0.1&lt;/code>æ”¹ä¸ºä¸»æœºçš„ipã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#å¯åŠ¨&lt;/span>
minikube start
&lt;span class="c1">#ä½¿ç”¨ç§æœ‰åº“&lt;/span>
minikube start --insecure-registry&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.31.34&amp;#34;&lt;/span>
&lt;span class="c1">#ä½¿ç”¨proxyï¼Œç”¨äºè·å–é•œåƒ&lt;/span>
minikube start --docker-env &lt;span class="nv">HTTP_PROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.31.186:1087&amp;#34;&lt;/span> --docker-env &lt;span class="nv">HTTPS_PROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.31.186:1087&amp;#34;&lt;/span> --docker-env &lt;span class="nv">NO_PROXY&lt;/span>&lt;span class="o">=&lt;/span>192.168.99.0/24
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…kubectl">å®‰è£…kubectl&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -Lo kubectl http://storage.googleapis.com/kubernetes-release/release/v1.7.3/bin/darwin/amd64/kubectl &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> chmod +x kubectl &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> sudo mv kubectl /usr/local/bin/
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="oh-my-zsh-tab-completion">oh-my-zsh tab completion&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">vi ~/.zshrc
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>æ·»åŠ åˆ°pluginéƒ¨åˆ†&lt;br>
plugins=(git zsh-completions kubectl)&lt;/p>
&lt;/blockquote>
&lt;h2 id="ä½¿ç”¨">ä½¿ç”¨&lt;/h2>
&lt;h3 id="minikube">minikube&lt;/h3>
&lt;h4 id="æ£€æŸ¥ç‰ˆæœ¬">æ£€æŸ¥ç‰ˆæœ¬&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube version
&lt;span class="c1">#minikube version: v0.21.0&lt;/span>
kubectl version
&lt;span class="c1">#Client Version: version.Info{Major:&amp;#34;1&amp;#34;, Minor:&amp;#34;3&amp;#34;, GitVersion:&amp;#34;v1.3.0&amp;#34;, GitCommit:&amp;#34;283137936a498aed572ee22af6774b6fb6e9fd94&amp;#34;, GitTreeState:&amp;#34;clean&amp;#34;, BuildDate:&amp;#34;2016-07-01T19:26:38Z&amp;#34;, GoVersion:&amp;#34;go1.6.2&amp;#34;, Compiler:&amp;#34;gc&amp;#34;, Platform:&amp;#34;darwin/amd64&amp;#34;}&lt;/span>
&lt;span class="c1">#Server Version: version.Info{Major:&amp;#34;1&amp;#34;, Minor:&amp;#34;7&amp;#34;, GitVersion:&amp;#34;v1.7.0&amp;#34;, GitCommit:&amp;#34;d3ada0119e776222f11ec7945e6d860061339aad&amp;#34;, GitTreeState:&amp;#34;clean&amp;#34;, BuildDate:&amp;#34;2017-07-26T00:12:31Z&amp;#34;, GoVersion:&amp;#34;go1.8.3&amp;#34;, Compiler:&amp;#34;gc&amp;#34;, Platform:&amp;#34;linux/amd64&amp;#34;}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="è·å–é›†ç¾¤åœ°å€">è·å–é›†ç¾¤åœ°å€&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube ip
192.168.99.100
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="è·å–æœåŠ¡åˆ—è¡¨">è·å–æœåŠ¡åˆ—è¡¨&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube service list
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ‰“å¼€dashboard">æ‰“å¼€dashboard&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube dashboard
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="kubectl">kubectl&lt;/h2>
&lt;h4 id="éƒ¨ç½²dashboard-ui">éƒ¨ç½²Dashboard UI&lt;/h4>
&lt;p>é»˜è®¤minikubeä¼šè‡ªåŠ¨éƒ¨ç½²dashboard&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create -f https://rawgit.com/kubernetes/dashboard/master/src/deploy/kubernetes-dashboard.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å¯åŠ¨proxy">å¯åŠ¨proxy&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl proxy
&lt;span class="c1">#Starting to serve on 127.0.0.1:8001&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="è·å–podä¿¡æ¯">è·å–podä¿¡æ¯&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get pods --namespace kube-system
NAME READY STATUS RESTARTS AGE
kube-addon-manager-minikube 0/1 Running &lt;span class="m">0&lt;/span> 1h
kubernetes-dashboard-3313488171-90s64 0/1 Running &lt;span class="m">0&lt;/span> 20m
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœSTATUSä¸€ç›´å¤„äº&lt;strong>ContainerCreating&lt;/strong>çŠ¶æ€ï¼Œåº”è¯¥æ˜¯pull imageå¤±è´¥ã€‚é»˜è®¤æ˜¯å»gcr.ioæ‹‰é•œåƒï¼Œè¢«å¢™äº†ã€‚éœ€è¦åœ¨å¯åŠ¨minikubeçš„æ—¶å€™è®¾ç½®dockerä½¿ç”¨çš„ä»£ç†ã€‚&lt;/p>
&lt;h4 id="è·å–podè¯¦ç»†ä¿¡æ¯">è·å–podè¯¦ç»†ä¿¡æ¯&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl describe pod kubernetes-dashboard-3313488171-90s64 --namespace kube-system
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="æŸ¥çœ‹log">æŸ¥çœ‹log&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl logs -f kubernetes-dashboard-3313488171-90s64
&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>