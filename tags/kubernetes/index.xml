<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Kubernetes on ä¹±ä¸–æµ®ç”Ÿ</title><link>https://atbug.com/tags/kubernetes/</link><description>Recent content in Kubernetes on ä¹±ä¸–æµ®ç”Ÿ</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Sat, 26 Jun 2021 12:16:28 +0800</lastBuildDate><atom:link href="https://atbug.com/tags/kubernetes/index.xml" rel="self" type="application/rss+xml"/><item><title>å¸¸ç”¨çš„å‡ æ¬¾å·¥å…·è®© Kubernetes é›†ç¾¤ä¸Šçš„å·¥ä½œæ›´å®¹æ˜“</title><link>https://atbug.com/tools-accelerate-work-on-kubernetes-cluster/</link><pubDate>Sat, 26 Jun 2021 12:16:28 +0800</pubDate><guid>https://atbug.com/tools-accelerate-work-on-kubernetes-cluster/</guid><description>
&lt;p>ä¹‹å‰å†™è¿‡ä¸€ç¯‡ &lt;a href="https://mp.weixin.qq.com/s/CXJ1zUoktdI3c3CHVju0gA">ä»‹ç»äº†å·¥å…·åŠ é€Ÿäº‘åŽŸç”Ÿ Java å¼€å‘&lt;/a>ã€‚&lt;/p>
&lt;p>å…¶å®žæ—¥å¸¸å·¥ä½œä¸­åœ¨é›†ç¾¤ä¸Šçš„æ“ä½œä¹Ÿéžå¸¸å¤šï¼Œä»Šå¤©å°±æ¥ä»‹ç»æˆ‘æ‰€ä½¿ç”¨çš„å·¥å…·ã€‚&lt;/p>
&lt;h2 id="kubectl-alias">kubectl-alias&lt;/h2>
&lt;p>ä½¿ç”¨é¢‘çŽ‡æœ€é«˜çš„å·¥å…·ï¼Œæˆ‘è‡ªå·±ç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹ï¼ŒåŠ å…¥äº† &lt;code>StatefulSet&lt;/code> çš„æ”¯æŒã€‚&lt;/p>
&lt;p>è¿™ä¸ªæ˜¯æˆ‘çš„ &lt;a href="https://github.com/addozhang/kubectl-aliases">https://github.com/addozhang/kubectl-aliases&lt;/a>ï¼ŒåŸºäºŽ &lt;a href="https://github.com/ahmetb/kubectl-aliases">https://github.com/ahmetb/kubectl-aliases&lt;/a>ã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¾“å‡ºæŸä¸ª pod çš„ jsonï¼Œ&lt;code>kgpoojson xxx&lt;/code> ç­‰åŒäºŽ &lt;code>kubectl get pod xxx -o json&lt;/code>ã€‚&lt;/p>
&lt;p>ç»“åˆ &lt;a href="https://stedolan.github.io/jq/">jq&lt;/a> ä½¿ç”¨æ•ˆæžœæ›´å¥½ ðŸ˜‚ã€‚&lt;/p>
&lt;h3 id="è¯­æ³•è§£è¯»">è¯­æ³•è§£è¯»&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>&lt;code>k&lt;/code>&lt;/strong>=&lt;code>kubectl&lt;/code>
&lt;ul>
&lt;li>&lt;strong>&lt;code>sys&lt;/code>&lt;/strong>=&lt;code>--namespace kube-system&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>commands:
&lt;ul>
&lt;li>&lt;strong>&lt;code>g&lt;/code>&lt;/strong>=&lt;code>get&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>d&lt;/code>&lt;/strong>=&lt;code>describe&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>rm&lt;/code>&lt;/strong>=&lt;code>delete&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>a&lt;/code>&lt;/strong>:&lt;code>apply -f&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>ak&lt;/code>&lt;/strong>:&lt;code>apply -k&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>k&lt;/code>&lt;/strong>:&lt;code>kustomize&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>ex&lt;/code>&lt;/strong>:Â &lt;code>exec -i -t&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>lo&lt;/code>&lt;/strong>:Â &lt;code>logs -f&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>resources:
&lt;ul>
&lt;li>&lt;strong>&lt;code>po&lt;/code>&lt;/strong>=pod,Â &lt;strong>&lt;code>dep&lt;/code>&lt;/strong>=&lt;code>deployment&lt;/code>,Â &lt;strong>&lt;code>ing&lt;/code>&lt;/strong>=&lt;code>ingress&lt;/code>,Â &lt;strong>&lt;code>svc&lt;/code>&lt;/strong>=&lt;code>service&lt;/code>,Â &lt;strong>&lt;code>cm&lt;/code>&lt;/strong>=&lt;code>configmap&lt;/code>,Â &lt;strong>&lt;code>sec&lt;/code>=&lt;code>secret&lt;/code>&lt;/strong>,&lt;strong>&lt;code>ns&lt;/code>&lt;/strong>=&lt;code>namespace&lt;/code>,Â &lt;strong>&lt;code>no&lt;/code>&lt;/strong>=&lt;code>node&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>flags:
&lt;ul>
&lt;li>output format:Â &lt;strong>&lt;code>oyaml&lt;/code>&lt;/strong>,Â &lt;strong>&lt;code>ojson&lt;/code>&lt;/strong>,Â &lt;strong>&lt;code>owide&lt;/code>&lt;/strong>&lt;/li>
&lt;li>&lt;strong>&lt;code>all&lt;/code>&lt;/strong>:Â &lt;code>--all&lt;/code>Â orÂ &lt;code>--all-namespaces&lt;/code>Â depending on the command&lt;/li>
&lt;li>&lt;strong>&lt;code>sl&lt;/code>&lt;/strong>:Â &lt;code>--show-labels&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>w&lt;/code>&lt;/strong>=&lt;code>-w/--watch&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>value flags (should be at the end):
&lt;ul>
&lt;li>&lt;strong>&lt;code>n&lt;/code>&lt;/strong>=&lt;code>-n/--namespace&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>f&lt;/code>&lt;/strong>=&lt;code>-f/--filename&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>l&lt;/code>&lt;/strong>=&lt;code>-l/--selector&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="kubectx--kubens">kubectx + kubens&lt;/h2>
&lt;p>&lt;a href="https://github.com/ahmetb/kubectx#installation">å®‰è£…çœ‹è¿™é‡Œ&lt;/a>&lt;/p>
&lt;p>&lt;code>kubectx&lt;/code> ç”¨äºŽåœ¨ä¸åŒçš„é›†ç¾¤é—´è¿›è¡Œå¿«é€Ÿåˆ‡æ¢ã€‚å‡å¦‚ç”¨ &lt;code>kubectl&lt;/code>ï¼Œä½ éœ€è¦ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># context åˆ—è¡¨&lt;/span>
kubectl config current-context
&lt;span class="c1"># è®¾ç½® context&lt;/span>
kubectl config use-context coffee
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/kubectxdemo.gif" alt="kubectx-demo">&lt;/p>
&lt;p>&lt;code>kubens&lt;/code> å°±æ˜¯åœ¨ä¸åŒ namespace é—´å¿«é€Ÿåˆ‡æ¢çš„å·¥å…·ã€‚ç”¨ &lt;code>kubectl&lt;/code> çš„è¯ï¼Œéœ€è¦ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># namespace åˆ—è¡¨&lt;/span>
kbuectl get ns
&lt;span class="c1"># kubectl config set-context --current --namespace=kube-system&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/kubensdemo.gif" alt="kubens-demo">&lt;/p>
&lt;h2 id="k9s">k9s&lt;/h2>
&lt;p>æ²¡é”™ï¼Œåªæ¯” k8s å¤šäº†ä¸ª 1 ðŸ˜‚ã€‚&lt;/p>
&lt;p>&lt;a href="https://github.com/derailed/k9s">k9s&lt;/a> æä¾›äº†ç»ˆç«¯ UI ä¸Ž Kubernetes é›†ç¾¤è¿›è¡Œç¼–è¾‘äº¤äº’ã€‚æœ¬äººå¸¸ç”¨çš„æ¯”å¦‚ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>F&lt;/code> é…ç½®ç«¯å£è½¬å‘&lt;/li>
&lt;li>&lt;code>l&lt;/code> è¾“å‡º pod æ—¥å¿—&lt;/li>
&lt;li>&lt;code>e&lt;/code> ä¿®æ”¹èµ„æºå¯¹è±¡&lt;/li>
&lt;li>&lt;code>s&lt;/code> pod ç»ˆç«¯äº¤äº’æ¨¡å¼&lt;/li>
&lt;li>&lt;code>y&lt;/code> yaml æ–¹å¼è¾“å‡ºèµ„æºå¯¹è±¡&lt;/li>
&lt;li>&lt;code>d&lt;/code> describe èµ„æºå¯¹è±¡&lt;/li>
&lt;li>&lt;code>ctrl+d&lt;/code> åˆ é™¤ pod&lt;/li>
&lt;/ul>
&lt;p>å¯åŠ¨æ–¹å¼&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># æŒ‡å®š namespace è¿è¡Œ&lt;/span>
k9s -n mycoolns
&lt;span class="c1"># æŒ‡å®š context è¿è¡Œ&lt;/span>
k9s --context coolCtx
&lt;span class="c1"># åªè¯»æ¨¡å¼è¿è¡Œ&lt;/span>
k9s --readonly
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626102731.png" alt="k9s-pod">&lt;/p>
&lt;p>é”®å…¥é—®å·â€œ?â€ å°±å¯ä»¥æ‰“å¼€å¿«æ·æ“ä½œæŒ‡å¼•ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626103012.png" alt="help">&lt;/p>
&lt;h2 id="stern">stern&lt;/h2>
&lt;p>&lt;a href="https://github.com/wercker/stern">stern&lt;/a> å¯ä»¥ç”¨æ¥ &lt;code>tail&lt;/code> é›†ç¾¤ä¸Šçš„å¤šä¸ª pod å’Œ pod ä¸­å¤šä¸ªå®¹å™¨çš„æ—¥å¿—ã€‚ä¸åŒçš„ pod å’Œå®¹å™¨ä»¥ä¸åŒçš„é¢œè‰²åŒºåˆ†ï¼Œæ–¹ä¾¿ debugã€‚&lt;/p>
&lt;p>æ¯”å¦‚ä½¿ç”¨å‘½ä»¤ &lt;code>stern -l tier=control-plane -n kube-system&lt;/code> å¯ä»¥è¾“å‡º &lt;code>kube-system&lt;/code> å‘½åç©ºé—´ä¸‹æŽ§åˆ¶å¹³é¢ï¼ˆ&lt;code>label&lt;/code> ä¸º &lt;code>tier=control-plane&lt;/code>ï¼‰ pod çš„æ—¥å¿—ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626104458.png" alt="stern-control-plane">&lt;/p>
&lt;p>å‘½ä»¤è¡Œé€‰é¡¹&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">Tail multiple pods and containers from Kubernetes
Usage:
stern pod-query &lt;span class="o">[&lt;/span>flags&lt;span class="o">]&lt;/span>
Flags:
-A, --all-namespaces If present, tail across all namespaces. A specific namespace is ignored even &lt;span class="k">if&lt;/span> specified with --namespace.
--color string Color output. Can be &lt;span class="s1">&amp;#39;always&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;never&amp;#39;&lt;/span>, or &lt;span class="s1">&amp;#39;auto&amp;#39;&lt;/span> &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;auto&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
--completion string Outputs stern command-line completion code &lt;span class="k">for&lt;/span> the specified shell. Can be &lt;span class="s1">&amp;#39;bash&amp;#39;&lt;/span> or &lt;span class="s1">&amp;#39;zsh&amp;#39;&lt;/span>
-c, --container string Container name when multiple containers in pod &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;.*&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
--container-state string If present, tail containers with status in running, waiting or terminated. Default to running. &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;running&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
--context string Kubernetes context to use. Default to current context configured in kubeconfig.
-e, --exclude strings Regex of log lines to exclude
-E, --exclude-container string Exclude a Container name
--field-selector string Selector &lt;span class="o">(&lt;/span>field query&lt;span class="o">)&lt;/span> to filter on. If present, default to &lt;span class="s2">&amp;#34;.*&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> the pod-query.
-h, --help &lt;span class="nb">help&lt;/span> &lt;span class="k">for&lt;/span> stern
-i, --include strings Regex of log lines to include
--init-containers Include or exclude init containers &lt;span class="o">(&lt;/span>default &lt;span class="nb">true&lt;/span>&lt;span class="o">)&lt;/span>
--kubeconfig string Path to kubeconfig file to use
-n, --namespace strings Kubernetes namespace to use. Default to namespace configured in Kubernetes context. To specify multiple namespaces, repeat this or &lt;span class="nb">set&lt;/span> comma-separated value.
-o, --output string Specify predefined template. Currently support: &lt;span class="o">[&lt;/span>default, raw, json&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;default&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
-l, --selector string Selector &lt;span class="o">(&lt;/span>label query&lt;span class="o">)&lt;/span> to filter on. If present, default to &lt;span class="s2">&amp;#34;.*&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> the pod-query.
-s, --since duration Return logs newer than a relative duration like 5s, 2m, or 3h. Defaults to 48h.
--tail int The number of lines from the end of the logs to show. Defaults to -1, showing all logs. &lt;span class="o">(&lt;/span>default -1&lt;span class="o">)&lt;/span>
--template string Template to use &lt;span class="k">for&lt;/span> log lines, leave empty to use --output flag
-t, --timestamps Print timestamps
--timezone string Set timestamps to specific timezone &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;Local&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
-v, --version Print the version and &lt;span class="nb">exit&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="lens">Lens&lt;/h2>
&lt;p>&lt;a href="https://k8slens.dev/">Lens&lt;/a> æ˜¯ç”¨æ¥æŽ§åˆ¶ Kubernetes çš„ IDEï¼Œå¼€æºä¸”å…è´¹ã€‚&lt;/p>
&lt;p>æ¶ˆé™¤äº†é›†ç¾¤æ“ä½œçš„å¤æ‚æ€§ã€æä¾›äº†å®žæ—¶çš„å¯è§‚å¯Ÿæ€§ã€æ–¹ä¾¿æ•…éšœæŽ’æŸ¥ã€æ”¯æŒå¤šç³»ç»Ÿçš„æ¡Œé¢å®¢æˆ·ç«¯ã€å…¼å®¹å¤šç§é›†ç¾¤ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626113853.png" alt="Lens">&lt;/p>
&lt;h2 id="infra-app">Infra App&lt;/h2>
&lt;p>&lt;a href="https://infra.app/">Infra App&lt;/a> è·Ÿ Lens å·®ä¸å¤šï¼ŒUI è¾ƒ Lens å¥½äº›ï¼Œä½†æ˜¯åŠŸèƒ½å°±å¼±å¾ˆå¤šï¼Œç±»ä¼¼ Lens çš„åªè¯»æ¨¡å¼ã€‚&lt;/p>
&lt;p>å…è´¹ç‰ˆæ¯”æ”¶è´¹ç‰ˆçš„åŒºåˆ«åªåœ¨äºŽæ”¯æŒçš„é›†ç¾¤æ•°é‡ï¼Œå…è´¹ç‰ˆåªæ”¯æŒä¸€ä¸ªé›†ç¾¤ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626114417.png" alt="Infra">&lt;/p>
&lt;h2 id="kubefwd">kubefwd&lt;/h2>
&lt;p>&lt;a href="https://github.com/txn2/kubefwd">kubefwd&lt;/a>ï¼Œè¿™ä¸ªä¸€ç›´æœ‰å®‰è£…ä½†æ˜¯ä½¿ç”¨æ¬¡æ•°å¯¥å¯¥ï¼Œå› ä¸ºåº”ç”¨ä¹‹é—´çš„è®¿é—®æ²¡æœ‰èµ° serviceï¼Œä¸è¿‡å¶å°”åšäº›å®žéªŒçš„æ—¶å€™ä¼šç”¨çš„ä¸Šã€‚&lt;/p>
&lt;blockquote>
&lt;p>kubefwd æ˜¯ä¸€ä¸ªç”¨äºŽç«¯å£è½¬å‘Kubernetesä¸­æŒ‡å®šnamespaceä¸‹çš„å…¨éƒ¨æˆ–è€…éƒ¨åˆ†podçš„å‘½ä»¤è¡Œå·¥å…·ã€‚ kubefwd ä½¿ç”¨æœ¬åœ°çš„çŽ¯å›žIPåœ°å€è½¬å‘éœ€è¦è®¿é—®çš„serviceï¼Œå¹¶ä¸”ä½¿ç”¨ä¸Žserviceç›¸åŒçš„ç«¯å£ã€‚ kubefwd ä¼šä¸´æ—¶å°†serviceçš„åŸŸæ¡ç›®æ·»åŠ åˆ° /etc/hosts æ–‡ä»¶ä¸­ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>å¯åŠ¨kubefwdåŽï¼Œåœ¨æœ¬åœ°å°±èƒ½åƒåœ¨Kubernetesé›†ç¾¤ä¸­ä¸€æ ·ä½¿ç”¨serviceåå­—ä¸Žç«¯å£è®¿é—®å¯¹åº”çš„åº”ç”¨ç¨‹åºã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/kubefwdani.gif" alt="kubefwd_ani">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/16246803227515.jpg" alt="">&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>å–„ç”¨å·¥å…·å¯ä»¥æå‡æ•ˆçŽ‡ï¼Œä½†å¹¶ä¸æ˜¯ä¸å¯æˆ–ç¼ºçš„ã€‚&lt;/p>
&lt;p>å¦‚æžœä½ æœ‰å…¶ä»–çš„å·¥å…·ï¼Œæ¬¢è¿Žç•™è¨€æå‡ºã€‚&lt;/p></description></item><item><title>Jenkins å¦‚ä½•ä¸Ž Kubernetes é›†ç¾¤çš„ Tekton Pipeline äº¤äº’ï¼Ÿ</title><link>https://atbug.com/jenkins-interact-with-tekton-pipelines-via-plugin/</link><pubDate>Wed, 23 Jun 2021 07:58:45 +0800</pubDate><guid>https://atbug.com/jenkins-interact-with-tekton-pipelines-via-plugin/</guid><description>
&lt;p>æœ¬æ–‡è¯¦ç»†ä»‹ç»äº† Jenkins å¦‚ä½•é€šè¿‡ &lt;a href="https://github.com/jenkinsci/tekton-client-plugin">tekton-client-plugin&lt;/a> å®žçŽ°ä¸Ž Kubernetes ä¸Šçš„ Tekton Pipeline äº¤äº’ï¼ŒåŒ…æ‹¬ Kubernetes ä¸Šå®‰è£… Jenkinsã€Tekton Pipelines ç­‰ã€‚&lt;/p>
&lt;p>å…³äºŽå¦‚ä½•ä½¿ç”¨ Tekton Pipeline å®žçŽ° CICD å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç«  &lt;a href="https://atbug.com/tekton-pipeline-practice/">äº‘åŽŸç”Ÿ CICD: Tekton Pipeline å®žæˆ˜&lt;/a>&lt;/p>
&lt;p>æœ¬æ–‡ç”¨äºŽæž„å»ºçš„é¡¹ç›®ä»¥åŠæ‰€æœ‰ manifest yaml éƒ½åœ¨å¯ä»¥åœ¨&lt;a href="https://github.com/addozhang/tekton-test">è¿™é‡Œ&lt;/a>ä¸‹è½½ã€‚&lt;/p>
&lt;h2 id="tldr">TL;DR&lt;/h2>
&lt;p>æƒ¯ä¾‹ï¼Œå…ˆä¸Šæ€»ç»“ã€‚&lt;code>tekton-client-plugin&lt;/code> è™½ç„¶è¿˜æ˜¯å¤„äºŽåˆæœŸé˜¶æ®µï¼Œä½†æ˜¯ &lt;em>å…¶ä»·å€¼éžå¸¸æ˜Žæ˜¾ï¼Œå°¤å…¶æ˜¯å¯¹å…ˆç”¨ä½¿ç”¨ Jenkins ä½œä¸º CICD å®žçŽ°çš„ç”¨æˆ·æ¥è¯´ã€‚ä»Ž Jenkins è¿ç§»åˆ°äº‘åŽŸç”Ÿçš„ Tekton æ—¶ï¼Œå¯ä»¥çœæŽ‰ç”¨æˆ·ç•Œé¢çš„å¼€å‘æˆæœ¬ï¼Œè€Œä¸”å°½å¯èƒ½å°‘çš„æ”¹å˜ç”¨æˆ·ä¹ æƒ¯&lt;/em> ï¼Œä¾é ç‰ˆæœ¬ç®¡ç†å¯ä»¥æŽ§åˆ¶è¿ç§»çš„èŠ‚å¥ã€‚&lt;/p>
&lt;p>&lt;code>tekton-client-plugin&lt;/code> åœ¨ä»Šå¹´ 5 æœˆ 7 æ—¥å‘å¸ƒçš„ &lt;code>1.0.0&lt;/code> ç‰ˆæœ¬ï¼Œç›®å‰ä¸º &lt;code>1.0.02&lt;/code>ã€‚ç›®å‰è¿˜å¤„äºŽåˆæœŸé˜¶æ®µï¼Œæˆ‘ä¸ªäººæ„Ÿè§‰ç›®å‰ä»…ä»…ç®—æ˜¯æ‰“é€š Jenkins ä¸Ž Tekton äº¤äº’è¿™æ¡è·¯ï¼Œæ‰©å±•æ€§è¿˜ä¸å¤Ÿå¥½ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ç›®å‰ä»…ä»…æ”¯æŒå¦‚ä¸‹å‡ ä¸ªå‚æ•°æ³¨å…¥åˆ° &lt;code>PipelineRun&lt;/code> ä¸­ï¼Œéš¾ä»¥æ”¯æ’‘å¤æ‚çš„æµç¨‹æŽ§åˆ¶ï¼Œ&lt;a href="https://github.com/jenkinsci/tekton-client-plugin/blob/1.0.2/src/main/java/org/waveywaves/jenkins/plugins/tekton/client/build/create/CreateRaw.java#L292">æ”¯æŒçš„ Pipeline å‚æ•° hardcode åœ¨ä»£ç ä¸­&lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>BUILD_ID - the build id/number of the Jenkins job&lt;/li>
&lt;li>JOB_NAME - the name of the jenkins job that triggered this pipeline&lt;/li>
&lt;li>PULL_BASE_REF - name of the base branch&lt;/li>
&lt;li>PULL_PULL_SHA - the commit sha of the pull request or branch&lt;/li>
&lt;li>REPO_NAME - name of the repository&lt;/li>
&lt;li>REPO_OWNER - owner of the repository&lt;/li>
&lt;li>REPO_URL - the URL of the repository&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>å¸Œæœ›åŽé¢ä¼šæ”¯æŒè‡ªå®šä¹‰å‚æ•°ï¼Œæ¯”å¦‚å°†æ›´å¤šçš„é¡¹ç›®å…ƒæ•°æ®ä¿¡æ¯æ³¨å†Œåˆ° &lt;code>Pipeline&lt;/code> ä¸­ã€‚&lt;/p>
&lt;p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ&lt;code>tekton-client-plugin&lt;/code> æä¾›äº†å¯¹ Job DSL çš„æ”¯æŒï¼Œæœ¬æ–‡åŽé¢æ²¡æœ‰ç”¨è¿™ç§æ–¹å¼ï¼Œè€Œæ˜¯ç”¨çš„ FreeStyle Projectã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">pipeline {
agent any
stages {
stage(&amp;#39;Stage&amp;#39;) {
steps {
checkout scm
tektonCreateRaw(inputType: &amp;#39;FILE&amp;#39;, input: &amp;#39;.tekton/pipeline.yaml&amp;#39;)
}
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‰ç½®æ¡ä»¶">å‰ç½®æ¡ä»¶&lt;/h2>
&lt;h3 id="çŽ¯å¢ƒ">çŽ¯å¢ƒ&lt;/h3>
&lt;ul>
&lt;li>Kubernetesï¼šæŽ¨è minikube&lt;/li>
&lt;li>Jenkinsï¼šå»ºè®®åœ¨ Kubernetes ä¸Šå®‰è£…&lt;/li>
&lt;li>Tekton&lt;/li>
&lt;li>ç”¨äºŽæž„å»ºçš„é¡¹ç›®&lt;/li>
&lt;/ul>
&lt;h3 id="å·¥å…·">å·¥å…·&lt;/h3>
&lt;ul>
&lt;li>kubectl&lt;/li>
&lt;li>tektoncd-cli&lt;/li>
&lt;li>&lt;a href="https://github.com/ahmetb/kubectx">kubectxã€kubens&lt;/a>&lt;/li>
&lt;li>helm&lt;/li>
&lt;/ul>
&lt;h2 id="kubernetes-ä¸Šå®‰è£…-jenkinshelm">Kubernetes ä¸Šå®‰è£… Jenkinsï¼ˆHelmï¼‰&lt;/h2>
&lt;p>Jenkins è¿™é‡Œä½¿ç”¨ Helm å®‰è£…åˆ° Kubernetes ä¸Šã€‚&lt;/p>
&lt;p>åˆå§‹åŒ–å‘½åç©ºé—´ã€æŒä¹…åŒ–å·ã€ServiceAccount ç­‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create namespace jenkins
kubens jenkins
&lt;span class="c1"># æŒä¹…åŒ–å­˜å‚¨ï¼Œç¬”è€…å°†å®¹é‡ä¿®æ”¹ä¸º 5G&lt;/span>
http https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/doc/tutorials/kubernetes/installing-jenkins-on-kubernetes/jenkins-volume.yaml --body &amp;gt; jenkins-volume.yaml
&lt;span class="c1"># åˆ›å»º PV&lt;/span>
kubectl apply -f jenkins-volume.yaml
&lt;span class="c1"># åˆ›å»º service account&lt;/span>
kubectl apply -f https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/doc/tutorials/kubernetes/installing-jenkins-on-kubernetes/jenkins-sa.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å‡†å¤‡-helm-çŽ¯å¢ƒå¹¶æ·»åŠ -jenkins-chartrepo">å‡†å¤‡ helm çŽ¯å¢ƒå¹¶æ·»åŠ  Jenkins ChartRepo&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># homebrew å®‰è£… helm&lt;/span>
brew install helm
&lt;span class="c1"># æ·»åŠ  jenkins chart repo&lt;/span>
helm repo add jenkinsci https://charts.jenkins.io
helm repo update
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="é…ç½®-jenkins-chart">é…ç½® Jenkins Chart&lt;/h3>
&lt;ol>
&lt;li>ä¸‹è½½å®˜æ–¹çš„ values yamlè¿›è¡Œä¿®æ”¹ï¼š&lt;code>http https://raw.githubusercontent.com/jenkinsci/helm-charts/main/charts/jenkins/values.yaml &amp;gt; jenkins-values.yaml&lt;/code>&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>serviceType&lt;/code> ä¸º &lt;code>NodePort&lt;/code>ï¼Œå¹¶å¢žåŠ  &lt;code>nodePort: 32000&lt;/code>ã€‚ç”¨äºŽä»Ž minikube å¤–è®¿é—® Jenkins&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>storageClass&lt;/code> ä¸º &lt;code>jenkins-pv&lt;/code>ã€‚å‰é¢åˆ›å»º PV çš„æ—¶å€™ä½¿ç”¨äº† &lt;code>jenkins-pv&lt;/code> ä½œä¸º &lt;a href="https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/">Dynamic Volume Provisioning&lt;/a> çš„ &lt;code>storageClass&lt;/code>&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>serviceAccount&lt;/code> éƒ¨åˆ†ï¼Œå°† &lt;code>create&lt;/code> è®¾ç½®ä¸º &lt;code>false&lt;/code>ï¼ˆä¸Šé¢å·²ç»åˆ›å»ºäº† &lt;code>serviceAccount&lt;/code>ï¼‰ï¼ŒåŒæ—¶å°† &lt;code>name&lt;/code> æŒ‡å®šä¸ºå‰é¢çš„ sa åå­— &lt;code>jenkins&lt;/code>&lt;/li>
&lt;li>&lt;code>installPlugins&lt;/code> ä¸‹å¢žåŠ  &lt;code>tekton-client:1.0.2&lt;/code>&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>adminPassword&lt;/code> ä¸º &lt;code>admin&lt;/code>ã€‚æŒ‡å®šåˆå§‹å¯†ç ï¼ˆä¸æŒ‡å®šä¹Ÿå¯ä»¥é€šè¿‡å®‰è£…è¾“å‡ºçš„è¯´æ˜ŽèŽ·å–åˆå§‹å¯†ç ï¼‰&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>persistence&lt;/code> çš„ &lt;code>size&lt;/code> ä¸º &lt;code>5Gi&lt;/code> ï¼ˆæˆ‘çš„ minikube çš„è™šæ‹Ÿæœºåªæœ‰ 20Gi å¤§å°ï¼‰&lt;/li>
&lt;/ol>
&lt;p>ä¿®æ”¹åŽçš„æ–‡ä»¶åœ¨&lt;a href="https://github.com/addozhang/tekton-test/blob/main/tekton-client-sample/jenkins-values.yaml">è¿™é‡Œ jenkins-values.yaml&lt;/a>ã€‚&lt;/p>
&lt;h3 id="æ‰§è¡Œå®‰è£…">æ‰§è¡Œå®‰è£…&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">chart&lt;/span>&lt;span class="o">=&lt;/span>jenkinsci/jenkins
helm install jenkins -n jenkins -f jenkins-values.yaml &lt;span class="nv">$chart&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºç»“æžœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">NAME: jenkins
LAST DEPLOYED: Sun Jun 20 22:05:53 2021
NAMESPACE: jenkins
STATUS: deployed
REVISION: 1
&lt;/code>&lt;/pre>&lt;/div>&lt;p>èŽ·å– Jenkins çš„è®¿é—®åœ°å€ &lt;code>echo $(minikube ip):$(kubectl get svc jenkins -o jsonpath=&amp;quot;{.spec.ports[0].nodePort}&amp;quot;)&lt;/code>ï¼Œç„¶åŽä½¿ç”¨å‰é¢è®¾ç½®çš„è´¦å·ç™»å½•ã€‚&lt;/p>
&lt;h2 id="tekton-å®‰è£…">Tekton å®‰è£…&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create ns tekton-pipelines
kubens tekton-pipelines
kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…-cli">å®‰è£… CLI&lt;/h3>
&lt;p>&lt;code>brew install tektoncd-cli&lt;/code>&lt;/p>
&lt;h3 id="rbac">RBAC&lt;/h3>
&lt;p>Tekton Pipeline å®‰è£…å®ŒæˆåŽï¼Œéœ€è¦ç»™å‰é¢åˆ›å»ºçš„ ServiceAccount &lt;code>jenkins&lt;/code> å¢žåŠ  tekon èµ„æºçš„æ“ä½œæƒé™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="l">//tekton-role.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Role&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-role&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pods&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pods/log&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">verbs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">get&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">list&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">watch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">tekton.dev&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">tasks&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">taskruns&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pipelineruns&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">verbs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">create&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">delete&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">deletecollection&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">get&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">list&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">patch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">update&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">watch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">RoleBinding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-role-binding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">roleRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Role&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-role&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">subjects&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ServiceAccount&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jenkins&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jenkins&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="jenkins-ä¸Ž-tekton-äº¤äº’">Jenkins ä¸Ž Tekton äº¤äº’&lt;/h2>
&lt;p>å‰é¢å¤§ç¯‡å¹…çš„éƒ½åªæ˜¯å‡†å¤‡å·¥ä½œï¼ŒJenkins å®‰è£…æ—¶æˆ‘ä»¬å·²ç»æ·»åŠ äº† &lt;code>tekton-client-plugin&lt;/code> æ’ä»¶ã€‚&lt;/p>
&lt;p>æ·»åŠ ä¸€ä¸ªåä¸º &lt;code>tekton-client-sample&lt;/code> çš„ &lt;code>FreeStyle project&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622-151450.png" alt="åˆ›å»ºä½œä¸š">&lt;/p>
&lt;p>SCM è¿™é‡Œå¡«å…¥ç”¨äºŽæž„å»ºçš„é¡¹ç›®ä»“åº“åœ°å€ä»¥åŠåˆ†æ”¯ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622-151523.png" alt="é…ç½®ä»£ç ä»“åº“">&lt;/p>
&lt;p>Build æ¨¡å—ä¸­é€‰æ‹© &lt;code>Tekton: Create Resource (RAW)&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622-151544.png" alt="å¢žåŠ  Tekton step">&lt;/p>
&lt;p>è¿™é‡Œé€‰æ‹© &lt;code>FILE&lt;/code> ç±»åž‹ï¼Œå› ä¸ºæˆ‘å·²ç»å°† &lt;code>PipelineRun&lt;/code> çš„ yaml æ”¾è¿›äº†ä»£ç ä»“åº“ä¸­äº†ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622151734.png" alt="é…ç½® Resource">&lt;/p>
&lt;p>æ‰§è¡Œä¸€æ¬¡æž„å»º&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622153535.png" alt="æž„å»ºç»“æŸ">&lt;/p>
&lt;p>æ£€æŸ¥ä¸‹åº”ç”¨&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pod &lt;span class="p">|&lt;/span> grep tekton-test
tekton-test-75975dcc88-xkzb6 1/1 Running &lt;span class="m">0&lt;/span> 3m13s
tekton-test-c26lw-deploy-to-k8s-28trp-pod-w8tgc 0/1 Completed &lt;span class="m">0&lt;/span> 3m18s
tekton-test-c26lw-fetch-from-git-pv66g-pod-nm5qh 0/1 Completed &lt;span class="m">0&lt;/span> 6m30s
tekton-test-c26lw-source-to-image-k8mpg-pod-qh7g4 0/2 Completed &lt;span class="m">0&lt;/span> 6m15s
$ curl &lt;span class="k">$(&lt;/span>minikube ip&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>kubectl get svc tekton-test -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;{.spec.ports[0].nodePort}&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>/hi
hello world
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://www.jenkins.io/doc/book/installing/kubernetes/">Jenkins on Kubernetes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/jenkinsci/tekton-client-plugin/blob/master/docs/tutorial.md">Tekton Client Plugin Tutorial&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.jenkins.io/blog/2021/04/21/tekton-plugin/#easily-reuse-tekton-and-jenkins-x-from-jenkins">Easily reuse Tekton and Jenkins X from Jenkins&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>äº‘åŽŸç”Ÿ CICD: Tekton Pipeline å®žæˆ˜</title><link>https://atbug.com/tekton-pipeline-practice/</link><pubDate>Tue, 22 Jun 2021 07:19:33 +0800</pubDate><guid>https://atbug.com/tekton-pipeline-practice/</guid><description>
&lt;p>æ›´æ–°åŽ†å²ï¼š&lt;/p>
&lt;ul>
&lt;li>v1ï¼š2020.1.21 åŸºäºŽ Tekton Pipline &lt;a href="https://github.com/tektoncd/pipeline/tree/v0.9.0/docs#tekton-pipelines">v0.9.0&lt;/a>&lt;/li>
&lt;li>v2ï¼ˆå½“å‰ï¼‰ï¼š2021.6.22 åŸºäºŽ Tekton Pipeline &lt;a href="https://github.com/tektoncd/pipeline/tree/v0.25.0/docs#tekton-pipelines">v0.25.0&lt;/a>&lt;/li>
&lt;/ul>
&lt;hr>
&lt;p>Tekton æ˜¯ Google å¼€æºçš„ Kubernetes åŽŸç”ŸCI/CD ç³»ç»Ÿ, åŠŸèƒ½å¼ºå¤§æ‰©å±•æ€§å¼º. å‰èº«æ˜¯ Knavite é‡Œçš„ build-pipeline é¡¹ç›®, åŽæœŸå­µåŒ–æˆ&lt;a href="https://github.com/tektoncd/pipeline">ç‹¬ç«‹çš„é¡¹ç›®&lt;/a>. å¹¶æˆä¸º &lt;a href="https://cd.foundation/projects/">CDF&lt;/a> ä¸‹çš„å››ä¸ªé¡¹ç›®ä¹‹ä¸€, å…¶ä»–ä¸‰ä¸ªåˆ†åˆ«æ˜¯ Jenkins, Jenkins X, Spinnaker.&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆè¯´ Tekton æ˜¯ Kubernetes åŽŸç”Ÿçš„, ä»¥å†…å…¶åŸºäºŽ Kubernetes çš„ CRD å®šä¹‰äº† Pipeline æµæ°´çº¿.&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/bquuTV.jpg" alt="">&lt;/p>
&lt;p>CRD åŠè¯´æ˜Ž:&lt;/p>
&lt;ul>
&lt;li>Task: æž„å»ºä»»åŠ¡, å¯ä»¥å®šä¹‰ä¸€äº›åˆ—çš„ steps. æ¯ä¸ª step ç”±ä¸€ä¸ª container æ‰§è¡Œ.&lt;/li>
&lt;li>TaskRun: task å®žé™…çš„æ‰§è¡Œ, å¹¶æä¾›æ‰§è¡Œæ‰€éœ€çš„å‚æ•°. è¿™ä¸ªå¯¹è±¡åˆ›å»ºåŽ, å°±ä¼šæœ‰ pod è¢«åˆ›å»º.&lt;/li>
&lt;li>Pipeline: å®šä¹‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª task çš„æ‰§è¡Œ, ä»¥åŠ PipelineResource å’Œå„ç§å®šä¹‰å‚æ•°çš„é›†åˆ&lt;/li>
&lt;li>PipelineRun: ç±»ä¼¼ task å’Œ taskrun çš„å…³ç³»: ä¸€ä¸ªå®šä¹‰ä¸€ä¸ªæ‰§è¡Œ. PipelineRun åˆ™æ˜¯ pipeline çš„å®žé™…æ‰§è¡Œ. åˆ›å»ºåŽä¹Ÿä¼šåˆ›å»º pod æ¥æ‰§è¡Œå„ä¸ª task.&lt;/li>
&lt;li>&lt;del>PipelineResource: æµæ°´çº¿çš„è¾“å…¥èµ„æº, æ¯”å¦‚ github/gitlab çš„æºç , æŸç§å­˜å‚¨æœåŠ¡çš„æ–‡ä»¶, æˆ–è€…é•œåƒç­‰. æ‰§è¡Œæ—¶, ä¹Ÿä¼šä½œä¸º pod çš„å…¶ä¸­ä¸€ä¸ª container æ¥è¿è¡Œ(æ¯”å¦‚æ‹‰å–ä»£ç ).&lt;/del> PipelineResource ç›®å‰å¤„äºŽ Alahaï¼Œè‡³äºŽåŽŸå› å¯ä»¥çœ‹&lt;a href="https://github.com/tektoncd/pipeline/blob/v0.25.0/docs/resources.md#why-arent-pipelineresources-in-beta">Why Aren&amp;rsquo;t PipelineResources in Beta?&lt;/a>&lt;/li>
&lt;li>Condition: åœ¨ pipeline çš„ task æ‰§è¡Œæ—¶é€šè¿‡æ·»åŠ  condition æ¥å¯¹æ¡ä»¶è¿›è¡Œè¯„ä¼°, è¿›è€Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œ task. ç›®å‰æ˜¯WIPçš„çŠ¶æ€, å¾…&lt;a href="https://github.com/tektoncd/pipeline/issues/1137">#1137&lt;/a>çš„å®Œæˆ.&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ç»„ä»¶:&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;code>tekton-pipelines-controller&lt;/code>: ç›‘æŽ§ CRD å¯¹è±¡(TaskRun, PipelineRun)çš„åˆ›å»º, ä¸ºè¯¥æ¬¡æ‰§è¡Œåˆ›å»º pod.&lt;/li>
&lt;li>&lt;code>tekton-pipelines-webhook&lt;/code>: å¯¹ apiserver æä¾› http æŽ¥å£åš CRD å¯¹è±¡çš„æ ¡éªŒ.&lt;/li>
&lt;/ul>
&lt;h2 id="å‰ç½®æ¡ä»¶">å‰ç½®æ¡ä»¶&lt;/h2>
&lt;p>æ–‡ä¸­ä½¿ç”¨çš„ä¸€äº›å·¥å…·ï¼ŒåŸºæœ¬éƒ½å¯ä»¥é€šè¿‡ homebrew å®‰è£…ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://stedolan.github.io/jq/">jq&lt;/a> ï¼šæ“ä½œ json çš„å‘½ä»¤è¡Œå·¥å…·&lt;/li>
&lt;li>&lt;a href="https://httpie.io/">httpie&lt;/a>ï¼šHTTP å®¢æˆ·ç«¯å‘½ä»¤è¡Œå·¥å…·&lt;/li>
&lt;li>&lt;a href="https://minikube.sigs.k8s.io/docs/start/">minikube çŽ¯å¢ƒ&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>æ–‡ä¸­çš„ Java é¡¹ç›®ä»¥åŠ tekton çš„ç›¸å…³ yaml éƒ½å·²ç»æäº¤åˆ°äº† &lt;a href="https://github.com/addozhang/tekton-test">tekton-test&lt;/a>.&lt;/p>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;p>å‚è€ƒ&lt;a href="https://atbug.com/tekton-installation-and-sample/">ä¸Šä¸€ç¯‡æ–‡ç« &lt;/a>, æ–‡ç« ä¸­æœ‰ä¸ªç®€å•çš„&amp;quot;hello world&amp;quot;.&lt;/p>
&lt;h2 id="å®žè·µ">å®žè·µ&lt;/h2>
&lt;p>åˆ°äº†è¿™é‡Œç›¸ä¿¡å·²ç»å®‰è£…å¥½äº† Tekton. æˆ‘ä»¬ä½¿ç”¨&lt;a href="https://start.spring.io/">Spring Initializer&lt;/a>ç”Ÿæˆçš„é¡¹ç›®ä¸ºä¾‹, æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Tekton å®žçŽ° CICD.&lt;/p>
&lt;p>å¼€å§‹ä¹‹å‰ç®€å•æ•´ç†ä¸‹è¿™ä¸ªé¡¹ç›®çš„ CICD æµç¨‹:&lt;/p>
&lt;ol>
&lt;li>æ‹‰å–ä»£ç &lt;/li>
&lt;li>maven æ‰“åŒ…&lt;/li>
&lt;li>æž„å»ºé•œåƒå¹¶æŽ¨é€&lt;/li>
&lt;li>éƒ¨ç½²&lt;/li>
&lt;/ol>
&lt;p>&lt;em>æ³¨: æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åœ¨ &lt;code>tekton-pipelines&lt;/code> namespace ä¸‹æ“ä½œ&lt;/em>&lt;/p>
&lt;h3 id="0x00-æ·»åŠ -dockerfile-å’Œéƒ¨ç½²ç”¨çš„-yaml">0x00 æ·»åŠ  Dockerfile å’Œéƒ¨ç½²ç”¨çš„ yaml&lt;/h3>
&lt;p>ç”¨äºŽæž„å»ºé•œåƒçš„Dockerfile&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">FROM openjdk:8-jdk-alpine
RUN mkdir /app
WORKDIR /app
COPY target/*.jar /app/app.jar
ENTRYPOINT [&amp;#34;sh&amp;#34;, &amp;#34;-c&amp;#34;, &amp;#34;java -Xmx128m -Xms64m -jar app.jar&amp;#34;]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”¨äºŽéƒ¨ç½² K8s Deployment çš„ deployment.ymlï¼ŒåŒæ—¶é€šè¿‡åˆ›å»º &lt;code>NodePort&lt;/code> ç±»åž‹çš„ Service ç”¨äºŽè®¿é—®åº”ç”¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;apps/v1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Deployment&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addozhang/tekton-test:latest&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Always&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">livenessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">failureThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/actuator/info&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initialDelaySeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">60&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">successThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeoutSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">containerPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;TCP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">readinessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">failureThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/actuator/info&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initialDelaySeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">successThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeoutSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NodePort &lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x01-rbac">0x01 RBAC&lt;/h3>
&lt;p>åˆ›å»º ServiceAccount ç”¨äºŽ Pipeline çš„è¿è¡Œã€‚&lt;/p>
&lt;p>&lt;strong>æ³¨ï¼šè¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼ŒæŽˆäºˆäº† &lt;code>ClusterRole&lt;/code> &lt;code>admin&lt;/code>ã€‚&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="c"># serviceaccount.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ServiceAccount&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-build&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterRoleBinding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipeline-admin-binding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">roleRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterRole&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">admin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># user cluster role admin&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">subjects&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ServiceAccount&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-build&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x02-æ‹‰å–ä»£ç ">0x02 æ‹‰å–ä»£ç &lt;/h3>
&lt;p>ä»£ç ä½œä¸ºæž„å»ºçš„è¾“å…¥, éœ€è¦æä¾›ä¸€ä¸ª Pipeline CRD å¯¹è±¡æ¥è¡¨ç¤ºè¾“å…¥æ˜¯ä»Ž git ä»“åº“æ¥èŽ·å–ä»£ç ã€‚&lt;/p>
&lt;p>è®¿é—® Tekton Hub å¯ä»¥æ‰¾åˆ°çŽ°æˆçš„ &lt;a href="https://hub.tekton.dev/tekton/task/git-clone">git-clone task&lt;/a>ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ kubectl å®‰è£…ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f https://raw.githubusercontent.com/tektoncd/catalog/main/task/git-clone/0.4/git-clone.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…ä½¿ç”¨ tekton-cli å®‰è£…ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">tkn hub install task git-clone
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x03-maven-æ‰“åŒ…">0x03 maven æ‰“åŒ…&lt;/h3>
&lt;p>Task &lt;code>source-to-image.yaml&lt;/code>çš„ step &lt;code>maven&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.5.0-jdk-8-alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workingDir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(workspaces.source.path)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mvn&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">clean&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">install&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">DskipTests&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/root/.m2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/home/docker/.m2 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>è¯´æ˜Ž:&lt;/strong>&lt;/p>
&lt;p>æœ‰äº†ä»£ç ä¸‹ä¸€æ­¥å°±æ˜¯æ‰§è¡Œ maven çš„ç¼–è¯‘æ‰“åŒ…, åœ¨&lt;code>maven:3.5.0-jdk-8-alpine&lt;/code>é•œåƒä¸­æ‰§è¡Œ&lt;code>mvn&lt;/code>çš„ç›¸å…³å‘½ä»¤.&lt;/p>
&lt;p>è¿™é‡ŒæŒ‚åœ¨äº†ä¸€ä¸ªæœ¬åœ°çš„volume, é¿å…æ¯æ¬¡æž„å»ºé‡å¤ä¸‹è½½ä¾èµ–åŒ…, åŒæ—¶é‡Œé¢è¿˜æœ‰&lt;code> settings.xml&lt;/code>&lt;/p>
&lt;p>&lt;em>æ³¨æ„: å¯¹äºŽ minikube, hostPath è¯·ä½¿ç”¨/data/.m2, å¦åˆ™minikubeé‡å¯åŽæ— æ³•æŒä¹…åŒ–&lt;/em>&lt;/p>
&lt;h3 id="0x04-æž„å»ºé•œåƒå¹¶æŽ¨é€">0x04 æž„å»ºé•œåƒå¹¶æŽ¨é€&lt;/h3>
&lt;p>Task &lt;code>source-to-image.yaml&lt;/code> çš„ step &lt;code>build-and-push&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">spec:
params:
- name: pathToDockerFile
description: The path to the dockerfile to build (relative to the context)
default: Dockerfile
- name: imageUrl
description: Url of image repository
- name: imageTag
description: Tag to apply to the built image
default: latest
workspaces:
- name: source
- name: dockerconfig
mountPath: /kaniko/.docker # config.json çš„æŒ‚è½½ç›®å½•
steps:
- name: build-and-push
image: gcr.io/kaniko-project/executor:v1.6.0-debug
command:
- /kaniko/executor
args:
- --dockerfile=$(params.pathToDockerFile)
- --destination=$(params.imageUrl):$(params.imageTag)
- --context=$(workspaces.source.path)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>è¯´æ˜Ž:&lt;/strong>&lt;/p>
&lt;p>é•œåƒçš„æž„å»º, æˆ‘ä»¬é‡‡ç”¨äº† kanikoã€‚&lt;/p>
&lt;p>é•œåƒä»“åº“æˆ‘ä»¬é€‰æ‹©äº†Docker Hub, æŽ¨é€çš„æ—¶å€™éœ€è¦ä½¿ç”¨ credentialsã€‚&lt;/p>
&lt;p>kaniko éœ€è¦å°† docker config çš„æ–‡ä»¶å­˜åœ¨äºŽ &lt;code>/kanika/.docker&lt;/code> ç›®å½•ä¸‹ã€‚è¿™é‡Œçš„æ€è·¯æ˜¯å°† docker çš„ &lt;code>config.json&lt;/code>ï¼Œä»¥ &lt;code>secret&lt;/code> çš„æ–¹å¼æŒä¹…åŒ–ï¼Œåœ¨é€šè¿‡å…ˆæ·»åŠ &lt;code> docker-registry&lt;/code>ç±»åž‹çš„ &lt;code>secret&lt;/code>ï¼Œç„¶åŽé€šè¿‡ &lt;code>workspace&lt;/code> çš„æ–¹å¼è¾“å…¥åˆ° kaniko è¿è¡ŒçŽ¯å¢ƒä¸­ã€‚&lt;/p>
&lt;p>&lt;code>config.json&lt;/code> é‡Œé¢ä¿å­˜çš„ json ç»“æž„åŒ–çš„æ•°æ®ï¼Œä¸ºäº†æ–¹ä¾¿é€šè¿‡ dry run åˆ›å»º&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create secret docker-registry dockerhub --docker-server&lt;span class="o">=&lt;/span>https://index.docker.io/v1/ --docker-username&lt;span class="o">=[&lt;/span>USERNAME&lt;span class="o">]&lt;/span> --docker-password&lt;span class="o">=[&lt;/span>PASSWORD&lt;span class="o">]&lt;/span> --dry-run&lt;span class="o">=&lt;/span>client -o json &lt;span class="p">|&lt;/span> jq -r &lt;span class="s1">&amp;#39;.data.&amp;#34;.dockerconfigjson&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> base64 -d &amp;gt; /tmp/config.json &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> kubectl create secret generic docker-config --from-file&lt;span class="o">=&lt;/span>/tmp/config.json &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> rm -f /tmp/config.json
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ‰§è¡Œ:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f tasks/source-to-image.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x05-éƒ¨ç½²">0x05 éƒ¨ç½²&lt;/h3>
&lt;p>deploy-to-k8s.yaml:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Task&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-to-k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">inputs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pathToYamlFile&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The path to the yaml file to deploy within the git source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deployment.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">run-kubectl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">lachlanevenson/k8s-kubectl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;kubectl&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;apply&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;-f&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;/workspace/git-source/$(inputs.params.pathToYamlFile)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>è¯´æ˜Ž:&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>pathToYamlFile: æŒ‡å®šéƒ¨ç½²åº”ç”¨çš„ yamlã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>æ‰§è¡Œ:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f tasks/deploy-to-k8s.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x06-ç»„è£…æµæ°´çº¿">0x06 ç»„è£…æµæ°´çº¿&lt;/h3>
&lt;p>&lt;code>build-pipeline.yaml&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pipeline&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build-pipeline&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pathToContext&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The path to the build context, used by Kaniko - within the workspace&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageUrl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Url of image repository&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageTag&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Tag to apply to the built image&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">fetch-from-git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-clone&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$(params.git-url)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$(params.git-revision)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">output&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source-to-image&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source-to-image&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageUrl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$(params.imageUrl)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageTag&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$(params.imageTag)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dockerconfig&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">runAfter&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">fetch-from-git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-to-k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-to-k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pathToYamlFile&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deployment.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">runAfter&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">source-to-image&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ‰§è¡Œ:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f tasks/deploy-to-k8s.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x07-æ‰§è¡Œæµæ°´çº¿">0x07 æ‰§è¡Œæµæ°´çº¿&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PipelineRun&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">generateName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">generic-pr-&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">generic-pipeline-run&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">pipelineRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build-pipeline&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">main&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://github.com/addozhang/tekton-test.git &lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageUrl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">addozhang/tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageTag&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeClaimTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">1Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secret&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceAccountName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-build&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ‰§è¡Œ:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f run/run.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x08-ç»“æžœ">0x08 ç»“æžœ&lt;/h3>
&lt;p>æ‰§è¡Œæµæ°´çº¿åŽ, å¯ä»¥çœ‹åˆ°åˆ†åˆ«åˆ›å»ºäº†ä¸‹é¢çš„å‡ ä¸ª pod:&lt;/p>
&lt;ul>
&lt;li>generic-pipeline-run-deploy-to-k8s-xxx&lt;/li>
&lt;li>generic-pipeline-run-fetch-from-git-xxx&lt;/li>
&lt;li>generic-pipeline-run-source-to-image-xxx&lt;/li>
&lt;/ul>
&lt;p>ä»¥åŠæˆ‘ä»¬çš„åº”ç”¨ &lt;code>tekton-test-xxx&lt;/code>ï¼Œå‘èµ·è¯·æ±‚æµ‹è¯•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ http &lt;span class="k">$(&lt;/span>minikube ip&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>kubectl get svc tekton-test -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;{.spec.ports[0].nodePort}&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>/hi --body
hello world
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ç›®å‰ Tekton è¿›å…¥ beta é˜¶æ®µ, æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ &lt;code>0.25.0&lt;/code>ã€‚åŸºäºŽ CRD çš„å®žçŽ°è®© Tekton åœ¨å®žé™…ä½¿ç”¨ä¸­å¯ä»¥çµæ´»çš„è®¾è®¡è‡ªå·±çš„ CICD æµç¨‹.&lt;/p>
&lt;p>ç”Ÿæ€ä¹Ÿè¶Šæ¥è¶Šå®Œå–„ï¼Œæ¯”å¦‚ &lt;a href="https://hub.tekton.dev/">Tekton Hub&lt;/a> æä¾›äº†å¤§é‡çš„å¯é‡ç”¨æœ€ä½³å®žçŽ°çš„ Task å’Œ Pipelineã€‚&lt;/p>
&lt;p>ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°è¯•ä¸‹å¦‚ä½•åœ¨ Jenkins ä¸­ä¸Ž Tekton Pipeline è¿›è¡Œäº¤äº’ã€‚&lt;/p>
&lt;p>æ›´å¤šæ–‡ç« :&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/_hK6bqODJv3LrwnQaou-hA">Tekton çš„å·¥ä½œåŽŸç†&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://atbug.com/tekton-dashboard-installation/">Tekton Dashboard å®‰è£…&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://atbug.com/tekton-trigger-glance/">Tekton Trigger ä»‹ç»&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://atbug.com/tekton-trigger-practice/">Tekton Trigger å®žæˆ˜&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>æºç è§£æžï¼šä¸€æ–‡è¯»æ‡‚ Kubelet</title><link>https://atbug.com/kubelet-source-code-analysis/</link><pubDate>Tue, 15 Jun 2021 08:25:25 +0800</pubDate><guid>https://atbug.com/kubelet-source-code-analysis/</guid><description>
&lt;p>æœ¬æ–‡ä¸»è¦ä»‹ç» kubelet åŠŸèƒ½ã€æ ¸å¿ƒç»„ä»¶ï¼Œä»¥åŠå¯åŠ¨æµç¨‹çš„æºç åˆ†æžï¼Œæ€»ç»“äº† kubelet çš„å·¥ä½œåŽŸç†ã€‚&lt;/p>
&lt;h2 id="kubelet-ç®€ä»‹">kubelet ç®€ä»‹&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/15/20210613091144.png" alt="Kubernetes çš„æž¶æž„å›¾">&lt;/p>
&lt;p>ä»Žå®˜æ–¹çš„æž¶æž„å›¾ä¸­å¾ˆå®¹æ˜“å°±èƒ½æ‰¾åˆ° &lt;code>kubelet&lt;/code>&lt;/p>
&lt;p>æ‰§è¡Œ &lt;code>kubelet -h&lt;/code> çœ‹åˆ° kubelet çš„åŠŸèƒ½ä»‹ç»ï¼š&lt;/p>
&lt;ul>
&lt;li>kubelet æ˜¯æ¯ä¸ª Node èŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œçš„ä¸»è¦â€œèŠ‚ç‚¹ä»£ç†â€ã€‚ä½¿ç”¨å¦‚ä¸‹çš„ä¸€ä¸ªå‘ apiserver æ³¨å†Œ Node èŠ‚ç‚¹ï¼šä¸»æœºçš„ &lt;code>hostname&lt;/code>ï¼›è¦†ç›– &lt;code>host&lt;/code> çš„å‚æ•°ï¼›æˆ–è€…äº‘æä¾›å•†æŒ‡å®šçš„é€»è¾‘ã€‚&lt;/li>
&lt;li>kubelet åŸºäºŽ &lt;code>PodSpec&lt;/code> å·¥ä½œã€‚&lt;code>PodSpec&lt;/code> æ˜¯ç”¨ &lt;code>YAML&lt;/code> æˆ–è€… &lt;code>JSON&lt;/code> å¯¹è±¡æ¥æè¿° Podã€‚Kubelet æŽ¥å—é€šè¿‡å„ç§æœºåˆ¶ï¼ˆä¸»è¦æ˜¯ apiserverï¼‰æä¾›çš„ä¸€ç»„ &lt;code>PodSpec&lt;/code>ï¼Œå¹¶ç¡®ä¿é‡Œé¢æè¿°çš„å®¹å™¨è‰¯å¥½è¿è¡Œã€‚&lt;/li>
&lt;/ul>
&lt;p>é™¤äº†ç”± apiserver æä¾› &lt;code>PodSpec&lt;/code>ï¼Œè¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æä¾›ï¼š&lt;/p>
&lt;ul>
&lt;li>æ–‡ä»¶&lt;/li>
&lt;li>HTTP ç«¯ç‚¹&lt;/li>
&lt;li>HTTP æœåŠ¡å™¨&lt;/li>
&lt;/ul>
&lt;p>kubelet åŠŸèƒ½å½’çº³ä¸€ä¸‹å°±æ˜¯ä¸ŠæŠ¥ Node èŠ‚ç‚¹ä¿¡æ¯ï¼Œå’Œç®¡ç†ï¼ˆåˆ›å»ºã€é”€æ¯ï¼‰Podã€‚ åŠŸèƒ½çœ‹ä¼¼ç®€å•ï¼Œå®žé™…ä¸ç„¶ã€‚æ¯ä¸€ä¸ªç‚¹æ‹¿å‡ºæ¥éƒ½éœ€è¦å¾ˆå¤§çš„ç¯‡å¹…æ¥è®²ï¼Œæ¯”å¦‚ Node èŠ‚ç‚¹çš„è®¡ç®—èµ„æºï¼Œé™¤äº†ä¼ ç»Ÿçš„ CPUã€å†…å­˜ã€ç¡¬ç›˜ï¼Œè¿˜æä¾›æ‰©å±•æ¥æ”¯æŒç±»ä¼¼ GPU ç­‰èµ„æºï¼›Pod ä¸ä»…ä»…æœ‰å®¹å™¨ï¼Œè¿˜æœ‰ç›¸å…³çš„ç½‘ç»œã€å®‰å…¨ç­–ç•¥ç­‰ã€‚&lt;/p>
&lt;h2 id="kubelet-æž¶æž„">kubelet æž¶æž„&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/15/20210614215508.png" alt="2021-06-14-21-55-08">&lt;/p>
&lt;h3 id="é‡è¦ç»„ä»¶">é‡è¦ç»„ä»¶&lt;/h3>
&lt;p>kubelet çš„æž¶æž„ç”± N å¤šçš„ç»„ä»¶ç»„æˆï¼Œä¸‹é¢ç®€å•ä»‹ç»ä¸‹æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªï¼š&lt;/p>
&lt;h4 id="pleg">PLEG&lt;/h4>
&lt;p>å³ &lt;strong>Pod Lifecycle Event Generator&lt;/strong>ï¼Œå­—é¢æ„æ€ Pod ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆ&lt;code>ContainerStarted&lt;/code>ã€&lt;code>ContainerDied&lt;/code>ã€&lt;code>ContainerRemoved&lt;/code>ã€&lt;code>ContainerChanged&lt;/code>ï¼‰ç”Ÿæˆå™¨ã€‚&lt;/p>
&lt;p>å…¶ç»´æŠ¤ç€ Pod ç¼“å­˜ï¼›å®šæœŸé€šè¿‡ &lt;code>ContainerRuntime&lt;/code> èŽ·å– Pod çš„ä¿¡æ¯ï¼Œä¸Žç¼“å­˜ä¸­çš„ä¿¡æ¯æ¯”è¾ƒï¼Œç”Ÿæˆå¦‚ä¸Šçš„äº‹ä»¶ï¼›å°†äº‹ä»¶å†™å…¥å…¶ç»´æŠ¤çš„é€šé“ï¼ˆchannelï¼‰ä¸­ã€‚&lt;/p>
&lt;h4 id="podworkers">PodWorkers&lt;/h4>
&lt;p>å¤„ç†äº‹ä»¶ä¸­ Pod çš„åŒæ­¥ã€‚æ ¸å¿ƒæ–¹æ³• &lt;code>managePodLoop()&lt;/code> é—´æŽ¥è°ƒç”¨ &lt;code>kubelet.syncPod()&lt;/code> å®Œæˆ Pod çš„åŒæ­¥ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æžœ Pod æ­£åœ¨è¢«åˆ›å»ºï¼Œè®°å½•å…¶å»¶è¿Ÿ&lt;/li>
&lt;li>ç”Ÿæˆ Pod çš„ API Statusï¼Œå³ &lt;code>v1.PodStatus&lt;/code>ï¼šä»Žè¿è¡Œæ—¶çš„ status è½¬æ¢æˆ api status&lt;/li>
&lt;li>è®°å½• Pod ä»Ž &lt;code>pending&lt;/code> åˆ° &lt;code>running&lt;/code> çš„è€—æ—¶&lt;/li>
&lt;li>åœ¨ &lt;code>StatusManager&lt;/code> ä¸­æ›´æ–° pod çš„çŠ¶æ€&lt;/li>
&lt;li>æ€æŽ‰ä¸åº”è¯¥è¿è¡Œçš„ Pod&lt;/li>
&lt;li>å¦‚æžœç½‘ç»œæ’ä»¶æœªå°±ç»ªï¼Œåªå¯åŠ¨ä½¿ç”¨äº†ä¸»æœºç½‘ç»œï¼ˆhost networkï¼‰çš„ Pod&lt;/li>
&lt;li>å¦‚æžœ static pod ä¸å­˜åœ¨ï¼Œä¸ºå…¶åˆ›å»ºé•œåƒï¼ˆMirrorï¼‰Pod&lt;/li>
&lt;li>ä¸º Pod åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•ï¼šPod ç›®å½•ã€å·ç›®å½•ã€æ’ä»¶ç›®å½•&lt;/li>
&lt;li>ä½¿ç”¨ &lt;code>VolumeManager&lt;/code> ä¸º Pod æŒ‚è½½å·&lt;/li>
&lt;li>èŽ·å– image pull secrets&lt;/li>
&lt;li>è°ƒç”¨å®¹å™¨è¿è¡Œæ—¶ï¼ˆcontainer runtimeï¼‰çš„ &lt;code>#SyncPod()&lt;/code> æ–¹æ³•&lt;/li>
&lt;/ul>
&lt;h4 id="podmanager">PodManager&lt;/h4>
&lt;p>å­˜å‚¨ Pod çš„æœŸæœ›çŠ¶æ€ï¼Œkubelet æœåŠ¡çš„ä¸åŒæ¸ é“çš„ Pod&lt;/p>
&lt;h4 id="statsprovider">StatsProvider&lt;/h4>
&lt;p>æä¾›èŠ‚ç‚¹å’Œå®¹å™¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œæœ‰ &lt;code>cAdvisor&lt;/code> å’Œ &lt;code>CRI&lt;/code> ä¸¤ç§å®žçŽ°ã€‚&lt;/p>
&lt;h4 id="containerruntime">ContainerRuntime&lt;/h4>
&lt;p>é¡¾åæ€ä¹‰ï¼Œå®¹å™¨è¿è¡Œæ—¶ã€‚ä¸Žéµå¾ª CRI è§„èŒƒçš„é«˜çº§å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ã€‚&lt;/p>
&lt;h4 id="depspodconfig">Deps.PodConfig&lt;/h4>
&lt;p>PodConfig æ˜¯ä¸€ä¸ªé…ç½®å¤šè·¯å¤ç”¨å™¨ï¼Œå®ƒå°†è®¸å¤š Pod é…ç½®æºåˆå¹¶æˆä¸€ä¸ªå•ä¸€çš„ä¸€è‡´ç»“æž„ï¼Œç„¶åŽæŒ‰é¡ºåºå‘ç›‘å¬å™¨ä¼ é€’å¢žé‡å˜æ›´é€šçŸ¥ã€‚&lt;/p>
&lt;p>é…ç½®æºæœ‰ï¼šæ–‡ä»¶ã€apiserverã€HTTP&lt;/p>
&lt;h4 id="syncloop">&lt;code>#syncLoop&lt;/code>&lt;/h4>
&lt;p>æŽ¥æ”¶æ¥è‡ª &lt;code>PodConfig&lt;/code> çš„ Pod å˜æ›´é€šçŸ¥ã€å®šæ—¶ä»»åŠ¡ã€&lt;code>PLEG&lt;/code> çš„äº‹ä»¶ï¼Œä»¥åŠ &lt;code>ProbeManager&lt;/code> çš„äº‹ä»¶ï¼Œå°† Pod åŒæ­¥åˆ°&lt;strong>æœŸæœ›çŠ¶æ€&lt;/strong>ã€‚&lt;/p>
&lt;h4 id="podadmithandlers">PodAdmitHandlers&lt;/h4>
&lt;p>Pod admission è¿‡ç¨‹ä¸­è°ƒç”¨çš„ä¸€ç³»åˆ—å¤„ç†å™¨ï¼Œæ¯”å¦‚ eviction handlerï¼ˆèŠ‚ç‚¹å†…å­˜æœ‰åŽ‹åŠ›æ—¶ï¼Œä¸ä¼šé©±é€ QoS è®¾ç½®ä¸º &lt;code>BestEffort&lt;/code> çš„ Podï¼‰ã€shutdown admit handlerï¼ˆå½“èŠ‚ç‚¹å…³é—­æ—¶ï¼Œä¸å¤„ç† pod çš„åŒæ­¥æ“ä½œï¼‰ç­‰ã€‚&lt;/p>
&lt;h4 id="oomwatcher">OOMWatcher&lt;/h4>
&lt;p>ä»Žç³»ç»Ÿæ—¥å¿—ä¸­èŽ·å–å®¹å™¨çš„ OOM æ—¥å¿—ï¼Œå°†å…¶å°è£…æˆäº‹ä»¶å¹¶è®°å½•ã€‚&lt;/p>
&lt;h4 id="volumemanger">VolumeManger&lt;/h4>
&lt;p>VolumeManager è¿è¡Œä¸€ç»„å¼‚æ­¥å¾ªçŽ¯ï¼Œæ ¹æ®åœ¨æ­¤èŠ‚ç‚¹ä¸Šè°ƒåº¦çš„ pod ç¡®å®šéœ€è¦é™„åŠ /æŒ‚è½½/å¸è½½/åˆ†ç¦»å“ªäº›å·å¹¶æ‰§è¡Œæ“ä½œã€‚&lt;/p>
&lt;h4 id="certificatemanager">CertificateManager&lt;/h4>
&lt;p>å¤„ç†è¯ä¹¦è½®æ¢ã€‚&lt;/p>
&lt;h4 id="probemanager">ProbeManager&lt;/h4>
&lt;p>å®žé™…ä¸ŠåŒ…å«äº†ä¸‰ç§ Probeï¼Œæä¾› probe ç»“æžœç¼“å­˜å’Œé€šé“ã€‚&lt;/p>
&lt;ul>
&lt;li>LivenessManager&lt;/li>
&lt;li>ReadinessManager&lt;/li>
&lt;li>StartupManager&lt;/li>
&lt;/ul>
&lt;h4 id="evictionmanager">EvictionManager&lt;/h4>
&lt;p>ç›‘æŽ§ Node èŠ‚ç‚¹çš„èµ„æºå ç”¨æƒ…å†µï¼Œæ ¹æ®é©±é€è§„åˆ™é©±é€ Pod é‡Šæ”¾èµ„æºï¼Œç¼“è§£èŠ‚ç‚¹çš„åŽ‹åŠ›ã€‚&lt;/p>
&lt;h4 id="pluginmanager">PluginManager&lt;/h4>
&lt;p>PluginManager è¿è¡Œä¸€ç»„å¼‚æ­¥å¾ªçŽ¯ï¼Œæ ¹æ®æ­¤èŠ‚ç‚¹ç¡®å®šå“ªäº›æ’ä»¶éœ€è¦æ³¨å†Œ/å–æ¶ˆæ³¨å†Œå¹¶æ‰§è¡Œã€‚å¦‚ CSI é©±åŠ¨å’Œè®¾å¤‡ç®¡ç†å™¨æ’ä»¶ï¼ˆDevice Pluginï¼‰ã€‚&lt;/p>
&lt;h5 id="csi">CSI&lt;/h5>
&lt;p>Container Storage Interfaceï¼Œç”±å­˜å‚¨åŽ‚å•†å®žçŽ°çš„å­˜å‚¨é©±åŠ¨ã€‚&lt;/p>
&lt;h5 id="è®¾å¤‡ç®¡ç†å™¨æ’ä»¶device-plugin">è®¾å¤‡ç®¡ç†å™¨æ’ä»¶ï¼ˆDevice Pluginï¼‰&lt;/h5>
&lt;p>Kubernetes æä¾›äº†ä¸€ä¸ª è®¾å¤‡æ’ä»¶æ¡†æž¶ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥å°†ç³»ç»Ÿç¡¬ä»¶èµ„æºå‘å¸ƒåˆ° Kubeletã€‚&lt;/p>
&lt;p>ä¾›åº”å•†å¯ä»¥å®žçŽ°è®¾å¤‡æ’ä»¶ï¼Œç”±ä½ æ‰‹åŠ¨éƒ¨ç½²æˆ–ä½œä¸º DaemonSet æ¥éƒ¨ç½²ï¼Œè€Œä¸å¿…å®šåˆ¶ Kubernetes æœ¬èº«çš„ä»£ç ã€‚ç›®æ ‡è®¾å¤‡åŒ…æ‹¬ GPUã€é«˜æ€§èƒ½ NICã€FPGAã€ InfiniBand é€‚é…å™¨ä»¥åŠå…¶ä»–ç±»ä¼¼çš„ã€å¯èƒ½éœ€è¦ç‰¹å®šäºŽä¾›åº”å•†çš„åˆå§‹åŒ–å’Œè®¾ç½®çš„è®¡ç®—èµ„æºã€‚&lt;/p>
&lt;h2 id="kubelet-çš„å¯åŠ¨æµç¨‹">kubelet çš„å¯åŠ¨æµç¨‹&lt;/h2>
&lt;p>è¦åˆ†æž kubelet çš„å¯åŠ¨æµç¨‹ï¼Œå¯ä»¥ä»Ž kubelet è¿è¡Œæ–¹å¼ç€æ‰‹ã€‚æ‰¾ä¸€ä¸ª Node èŠ‚ç‚¹ï¼Œå¾ˆå®¹æ˜“å°±èƒ½æ‰¾åˆ° kubelet çš„è¿›ç¨‹ã€‚ç”±äºŽå…¶æ˜¯ä»¥ &lt;code>systemd&lt;/code> çš„æ–¹å¼å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ &lt;code>systemctl&lt;/code> æŸ¥çœ‹å…¶çŠ¶æ€ã€‚&lt;/p>
&lt;h3 id="kubelet-å¯åŠ¨å‘½ä»¤">kubelet å¯åŠ¨å‘½ä»¤&lt;/h3>
&lt;p>kubelet çš„å¯åŠ¨å‘½ä»¤ï¼ˆminikube çŽ¯å¢ƒï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ ps -aux &lt;span class="p">|&lt;/span> grep &lt;span class="s1">&amp;#39;/kubelet&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> grep -v grep
root &lt;span class="m">4917&lt;/span> 2.6 0.3 &lt;span class="m">1857652&lt;/span> &lt;span class="m">106152&lt;/span> ? Ssl 01:34 13:05 /var/lib/minikube/binaries/v1.21.0/kubelet --bootstrap-kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/bootstrap-kubelet.conf --config&lt;span class="o">=&lt;/span>/var/lib/kubelet/config.yaml --container-runtime&lt;span class="o">=&lt;/span>docker --hostname-override&lt;span class="o">=&lt;/span>1.21.0 --kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/kubelet.conf --node-ip&lt;span class="o">=&lt;/span>192.168.64.5
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ systemctl status kubelet.service
â— kubelet.service - kubelet: The Kubernetes Node Agent
Loaded: loaded &lt;span class="o">(&lt;/span>/usr/lib/systemd/system/kubelet.service&lt;span class="p">;&lt;/span> disabled&lt;span class="p">;&lt;/span> vendor preset: enabled&lt;span class="o">)&lt;/span>
Drop-In: /etc/systemd/system/kubelet.service.d
â””â”€10-kubeadm.conf
Active: active &lt;span class="o">(&lt;/span>running&lt;span class="o">)&lt;/span> since Sun 2021-06-13 01:34:42 UTC&lt;span class="p">;&lt;/span> 11h ago
Docs: http://kubernetes.io/docs/
Main PID: &lt;span class="m">4917&lt;/span> &lt;span class="o">(&lt;/span>kubelet&lt;span class="o">)&lt;/span>
Tasks: &lt;span class="m">15&lt;/span> &lt;span class="o">(&lt;/span>limit: 38314&lt;span class="o">)&lt;/span>
Memory: 39.4M
CGroup: /system.slice/kubelet.service
â””â”€4917 /var/lib/minikube/binaries/v1.21.0/kubelet --bootstrap-kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/bootstrap-kubelet.conf --config&lt;span class="o">=&lt;/span>/var/lib/kubelet/config.yaml --container-runtime&lt;span class="o">=&lt;/span>docker --hostname-override&lt;span class="o">=&lt;/span>1.21.0 --kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/kubelet.conf --node-ip&lt;span class="o">=&lt;/span>192.168.64
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æºç åˆ†æž">æºç åˆ†æž&lt;/h3>
&lt;p>ä»Ž &lt;code>git@github.com:kubernetes/kubernetes.git&lt;/code> ä»“åº“èŽ·å–ä»£ç ï¼Œä½¿ç”¨æœ€æ–°çš„ &lt;code>release-1.21&lt;/code> åˆ†æ”¯ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>cmd/kubelet/kubelet.go:35&lt;/code> çš„ &lt;code>main&lt;/code> æ–¹æ³•ä¸ºç¨‹åºå…¥å£ã€‚
&lt;ul>
&lt;li>è°ƒç”¨ &lt;code>NewKubeletCommand&lt;/code> æ–¹æ³•ï¼Œåˆ›å»º command&lt;/li>
&lt;li>æ‰§è¡Œ command
&lt;ul>
&lt;li>&lt;code>cmd/kubelet/app/server.go:434&lt;/code> çš„ &lt;code>Run&lt;/code> æ–¹æ³•ã€‚
&lt;ul>
&lt;li>è°ƒç”¨ &lt;code>RunKubelet&lt;/code> æ–¹æ³•ã€‚
&lt;ul>
&lt;li>è°ƒç”¨ &lt;code>createAndInitKubelet&lt;/code> æ–¹æ³•ï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ– kubelet
&lt;ul>
&lt;li>&lt;code>pkg/kubelet/kubelet.go&lt;/code> çš„ &lt;code>NewMainKubelet&lt;/code> æ–¹æ³•ï¼Œåˆ›å»º kubeletçš„ å„ç§ç»„ä»¶ã€‚å…±åå‡ ä¸ªç»„ä»¶ï¼Œè§ &lt;a href="#kubelet-%E6%9E%B6%E6%9E%84">kubelet çš„æž„æž¶&lt;/a>ã€‚&lt;/li>
&lt;li>è°ƒç”¨ &lt;code>BirtyCry&lt;/code> æ–¹æ³•ï¼šæ”¾å‡º &lt;code>Starting&lt;/code> äº‹ä»¶&lt;/li>
&lt;li>è°ƒç”¨ &lt;code>StartGarbageCollection&lt;/code> æ–¹æ³•ï¼Œå¼€å¯ &lt;code>ContainerGC&lt;/code> å’Œ &lt;code>ImageGC&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>è°ƒç”¨ &lt;code>startKubelet&lt;/code> æ–¹æ³•ï¼ˆå¤§é‡ä½¿ç”¨ goroutine å’Œé€šé“ï¼‰
&lt;ul>
&lt;li>goroutineï¼š&lt;code>kubelet.Run()&lt;/code>
&lt;ul>
&lt;li>åˆå§‹åŒ–æ¨¡å—
&lt;ul>
&lt;li>metrics ç›¸å…³&lt;/li>
&lt;li>åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•ç›®å½•&lt;/li>
&lt;li>åˆ›å»ºå®¹å™¨æ—¥å¿—ç›®å½•&lt;/li>
&lt;li>å¯åŠ¨ &lt;code>ImageGCManager&lt;/code>&lt;/li>
&lt;li>å¯åŠ¨ &lt;code>ServerCertificateManager&lt;/code>&lt;/li>
&lt;li>å¯åŠ¨ &lt;code>OOMWatcher&lt;/code>&lt;/li>
&lt;li>å¯åŠ¨ &lt;code>ResourceAnalyzer&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>goroutineï¼š&lt;code>VolumeManager.Run()&lt;/code> å¼€å§‹å¤„ç† Pod Volume çš„å¸è½½å’ŒæŒ‚è½½&lt;/li>
&lt;li>goroutineï¼šçŠ¶æ€æ›´æ–° &lt;code>fastStatusUpdateOnce()&lt;/code> ï¼ˆæ›´æ–° Pod CIDR -&amp;gt; æ›´æ–° &lt;code>ContainerRuntime&lt;/code> çŠ¶æ€ -&amp;gt; æ›´æ–° Node èŠ‚ç‚¹çŠ¶æ€ï¼‰&lt;/li>
&lt;li>goroutineï¼š &lt;code>NodeLeaseController.Run()&lt;/code> æ›´æ–°èŠ‚ç‚¹ç§Ÿçº¦&lt;/li>
&lt;li>goroutineï¼š&lt;code>podKiller.PerformPodKillingWork&lt;/code> æ€æŽ‰æœªè¢«æ­£ç¡®å¤„ç†çš„ pod&lt;/li>
&lt;li>&lt;code>StatusManager.Start()&lt;/code> å¼€å§‹å‘ apiserver æ›´æ–° Pod çŠ¶æ€&lt;/li>
&lt;li>&lt;code>RuntimeClassManager.Start()&lt;/code>&lt;/li>
&lt;li>&lt;code>PLEG.Start()&lt;/code>ï¼šæŒç»­ä»Ž &lt;code>ContainerRuntime&lt;/code> èŽ·å– Pod/å®¹å™¨çš„çŠ¶æ€ï¼Œå¹¶ä¸Ž kubelet æœ¬åœ° cache ä¸­çš„æ¯”è¾ƒï¼Œç”Ÿæˆå¯¹åº”çš„ &lt;code>Event&lt;/code>&lt;/li>
&lt;li>&lt;code>syncLoop()&lt;/code> é‡ç‚¹ï¼Œ&lt;strong>&lt;em>æŒç»­ç›‘æŽ§å¹¶å¤„ç†æ¥è‡ªæ–‡ä»¶ã€apiserverã€http çš„å˜æ›´&lt;/em>&lt;/strong>ã€‚åŒ…æ‹¬ Pod çš„å¢žåŠ ã€æ›´æ–°ã€ä¼˜é›…åˆ é™¤ã€éžä¼˜é›…åˆ é™¤ã€è°ƒå’Œã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>å¯åŠ¨ serverï¼Œæš´éœ² &lt;code>/healthz&lt;/code> ç«¯ç‚¹&lt;/li>
&lt;li>é€šçŸ¥ &lt;code>systemd&lt;/code> &lt;code>kuberlet&lt;/code> æœåŠ¡å·²ç»å¯åŠ¨&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="kubelet-çš„å·¥ä½œåŽŸç†">kubelet çš„å·¥ä½œåŽŸç†&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/15/20210615000611.png" alt="">&lt;/p>
&lt;ol>
&lt;li>æ¥é™æ€æ–‡ä»¶ã€apiserver ä»¥åŠ HTTP è¯·æ±‚çš„ Pod é…ç½®å˜æ›´ï¼Œè¢«å‘é€åˆ° &lt;code>kubelet.syncLoop&lt;/code>&lt;/li>
&lt;li>PLEG ä¼šå®šæœŸé€šè¿‡å®¹å™¨è¿è¡Œæ—¶èŽ·å–èŠ‚ç‚¹ä¸Š Pod çš„çŠ¶æ€ï¼Œä¸Žå…¶ç¼“å­˜ä¸­çš„ Pod ä¿¡æ¯è¿›è¡Œæ¯”è¾ƒï¼Œå°è£…æˆäº‹ä»¶ï¼Œè¿›å…¥ PLEG çš„é€šé“&lt;/li>
&lt;li>å®šæœŸæ£€æŸ¥å·¥ä½œé˜Ÿåˆ—ä¸­çš„ Pod&lt;/li>
&lt;li>ProbeManager çš„é€šé“ä¸­çš„ Pod&lt;/li>
&lt;li>ä»¥ä¸Š 1~4ï¼Œéƒ½ä¼šè¿›å…¥ &lt;code>syncLoopIteration&lt;/code>ï¼Œå¹¶ä»Žå¯¹åº”çš„é€šé“ä¸­èŽ·å–åˆ°å¯¹åº” Podï¼Œå°† Pod çš„ä¿¡æ¯ä¿å­˜åˆ° &lt;code>PodManager&lt;/code>ï¼›ç„¶åŽåˆ†å‘ç»™ &lt;code>PodWorker&lt;/code>ï¼Œ&lt;a href="#PodWorkers">å®Œæˆä¸€äº›åˆ—çš„åŒæ­¥å·¥ä½œ&lt;/a>ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>kubelet å¯åŠ¨æµé‡å°±è®²åˆ°è¿™é‡Œï¼Œè™½ç„¶å¤æ‚ï¼Œè¿˜æ˜¯æœ‰è¿¹å¯å¾ªã€‚åªè¦äº†è§£äº† kubelet åœ¨ Kubernetes ä¸­çš„å®šä½åŠè§’è‰²ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£å…¶å·¥ä½œæµé‡ã€‚&lt;/p>
&lt;p>åŽé¢ä¼šå†æ·±å…¥åˆ†æž Pod åˆ›å»ºåŠå¯åŠ¨æµç¨‹ã€‚&lt;/p></description></item><item><title>Kubernetes ä¸Šå¦‚ä½•æŽ§åˆ¶å®¹å™¨çš„å¯åŠ¨é¡ºåºï¼Ÿ</title><link>https://atbug.com/k8s-1.18-container-start-sequence-control/</link><pubDate>Fri, 30 Apr 2021 07:43:54 +0800</pubDate><guid>https://atbug.com/k8s-1.18-container-start-sequence-control/</guid><description>
&lt;p>åŽ»å¹´å†™è¿‡ä¸€ç¯‡åšå®¢ï¼š&lt;a href="https://mp.weixin.qq.com/s/5UXhXpwPDBh2xuGKq9Nqig">æŽ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº&lt;/a>ï¼Œåˆ†æžäº† &lt;a href="https://github.com/tektoncd">TektonCD&lt;/a> çš„å®¹å™¨å¯åŠ¨æŽ§åˆ¶çš„åŽŸç†ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆè¦åšå®¹å™¨å¯åŠ¨é¡ºåºæŽ§åˆ¶ï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“ Pod ä¸­é™¤äº† &lt;code>init-container&lt;/code> ä¹‹å¤–ï¼Œæ˜¯å…è®¸æ·»åŠ å¤šä¸ªå®¹å™¨çš„ã€‚ç±»ä¼¼ TektonCD ä¸­ &lt;code>task&lt;/code> å’Œ &lt;code>step&lt;/code> çš„æ¦‚å¿µå°±åˆ†åˆ«ä¸Ž &lt;code>pod&lt;/code> å’Œ &lt;code>container&lt;/code> å¯¹åº”ï¼Œè€Œ &lt;code>step&lt;/code> æ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œçš„ã€‚æ­¤å¤–è¿˜æœ‰æœåŠ¡ç½‘æ ¼çš„åœºæ™¯ï¼Œsidecar å®¹å™¨éœ€è¦åœ¨æœåŠ¡å®¹å™¨å¯åŠ¨ä¹‹å‰å®Œæˆé…ç½®çš„åŠ è½½ï¼Œä¹Ÿéœ€è¦å¯¹å®¹å™¨çš„å¯åŠ¨é¡ºåºåŠ ä»¥æŽ§åˆ¶ã€‚å¦åˆ™ï¼ŒæœåŠ¡å®¹å™¨å…ˆå¯åŠ¨ï¼Œè€Œ sidecar è¿˜æ— æ³•æä¾›ç½‘ç»œä¸Šçš„æ”¯æŒã€‚&lt;/p>
&lt;h3 id="çŽ°å®ž">çŽ°å®ž&lt;/h3>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/sidecarlifecycle1.gif" alt="sidecar-lifecycle-1">&lt;/p>
&lt;h3 id="æœŸæœ›">æœŸæœ›&lt;/h3>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/sidecarlifecycle2.gif" alt="sidecar-lifecycle-2">&lt;/p>
&lt;p>åˆ°äº†è¿™é‡Œè‚¯å®šæœ‰åŒå­¦ä¼šé—®ï¼Œ&lt;code>spec.containers[]&lt;/code> æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„æ˜¯æœ‰é¡ºåºçš„ã€‚Kubernetes ä¹Ÿç¡®å®žæ˜¯æŒ‰ç…§é¡ºåºæ¥åˆ›å»ºå’Œå¯åŠ¨å®¹å™¨ï¼Œä½†æ˜¯ &lt;strong>å®¹å™¨å¯åŠ¨æˆåŠŸï¼Œå¹¶ä¸è¡¨ç¤ºå®¹å™¨å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡&lt;/strong>ã€‚&lt;/p>
&lt;p>åœ¨ Kubernetes 1.18 éžæ­£å¼ç‰ˆä¸­æ›¾åœ¨ Lifecycle å±‚é¢æä¾›äº†å¯¹ &lt;code>sidecar ç±»åž‹å®¹å™¨çš„&lt;/code> æ”¯æŒï¼Œä½†æ˜¯æœ€ç»ˆè¯¥åŠŸèƒ½å¹¶&lt;a href="https://github.com/kubernetes/enhancements/issues/753#issuecomment-713471597">æ²¡æœ‰è½åœ°&lt;/a>ã€‚&lt;/p>
&lt;p>é‚£åˆ°åº•è¯¥æ€Žä¹ˆåšï¼Ÿ&lt;/p>
&lt;h2 id="tldr">TL;DR&lt;/h2>
&lt;p>ç¬”è€…å‡†å¤‡äº†ä¸€ä¸ªç®€å•çš„ &lt;a href="https://github.com/addozhang/k8s-container-sequence-sample">go é¡¹ç›®&lt;/a>ï¼Œç”¨äºŽæ¨¡æ‹Ÿ sidecar çš„å¯åŠ¨åŠé…ç½®åŠ è½½ã€‚&lt;/p>
&lt;p>å…‹éš†ä»£ç åŽå¯ä»¥é€šè¿‡ &lt;code>make build&lt;/code> æž„å»ºå‡ºé•œåƒï¼Œå‡å¦‚ä½ æ˜¯ç”¨çš„ minikube è¿›è¡Œçš„å®žéªŒï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ &lt;code>make load-2-minikube&lt;/code> å°†é•œåƒåŠ è½½åˆ° minikube èŠ‚ç‚¹ä¸­ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ Deployment çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ï¼Œç›´æŽ¥ç”¨ Pod ä¹Ÿå¯ä»¥ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">strategy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">addozhang/k8s-container-sequence-sidecar:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sidecar&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">IfNotPresent&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">lifecycle&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">postStart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">exec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">wait&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">busybox:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">app&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">IfNotPresent&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/bin/sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;-c&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;date; echo &amp;#39;app container started&amp;#39;; tail -f /dev/null&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸‹é¢çš„æˆªå›¾ä¸­ï¼Œæ¼”ç¤ºäº†åœ¨ &lt;code>sample&lt;/code> å‘½åç©ºé—´ä¸­ï¼Œpod å†…ä¸¤ä¸ªå®¹å™¨çš„æ‰§è¡Œé¡ºåºã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/20210430-062819.gif" alt="2021-04-30 06.28.19">&lt;/p>
&lt;h2 id="kubernetes-æºç ">Kubernetes æºç &lt;/h2>
&lt;p>åœ¨ kubelet çš„æºç  &lt;code>pkg/kubelet/kuberuntime/kuberuntime_manager.go&lt;/code> ä¸­ï¼Œ&lt;code>#SyncPod&lt;/code> æ–¹æ³•ç”¨äºŽåˆ›å»º Podï¼Œæ­¥éª¤æ¯”è¾ƒç¹çï¼Œç›´æŽ¥çœ‹ç¬¬ 7 æ­¥ï¼šåˆ›å»ºæ™®é€šå®¹å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// SyncPod syncs the running pod into the desired pod by executing following steps:
&lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">// 1. Compute sandbox and container changes.
&lt;/span>&lt;span class="c1">// 2. Kill pod sandbox if necessary.
&lt;/span>&lt;span class="c1">// 3. Kill any containers that should not be running.
&lt;/span>&lt;span class="c1">// 4. Create sandbox if necessary.
&lt;/span>&lt;span class="c1">// 5. Create ephemeral containers.
&lt;/span>&lt;span class="c1">// 6. Create init containers.
&lt;/span>&lt;span class="c1">// 7. Create normal containers.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubeGenericRuntimeManager&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SyncPod&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pod&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podStatus&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubecontainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodStatus&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pullSecrets&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Secret&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">backOff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">flowcontrol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Backoff&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span> &lt;span class="nx">kubecontainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodSyncResult&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="c1">// Step 7: start containers in podContainerChanges.ContainersToStart.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">idx&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">podContainerChanges&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ContainersToStart&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;container&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">containerStartSpec&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">pod&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Containers&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">idx&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ &lt;code>#start&lt;/code> æ–¹æ³•ä¸­è°ƒç”¨äº† &lt;code>#startContainer&lt;/code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå¯åŠ¨å®¹å™¨ï¼Œå¹¶è¿”å›žå®¹å™¨å¯åŠ¨çš„ç»“æžœã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ç»“æžœè¿˜ &lt;strong>åŒ…å«äº†å®¹å™¨çš„ Lifecycle hooks è°ƒç”¨&lt;/strong>ã€‚&lt;/p>
&lt;p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚å®¹å™¨çš„ &lt;code>PostStart&lt;/code> hook æ²¡æœ‰æ­£ç¡®çš„è¿”å›žï¼Œkubelet ä¾¿ä¸ä¼šåŽ»åˆ›å»ºä¸‹ä¸€ä¸ªå®¹å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// startContainer starts a container and returns a message indicates why it is failed on error.
&lt;/span>&lt;span class="c1">// It starts the container through the following steps:
&lt;/span>&lt;span class="c1">// * pull the image
&lt;/span>&lt;span class="c1">// * create the container
&lt;/span>&lt;span class="c1">// * start the container
&lt;/span>&lt;span class="c1">// * run the post start lifecycle hooks (if applicable)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubeGenericRuntimeManager&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">startContainer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">podSandboxID&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podSandboxConfig&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">runtimeapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodSandboxConfig&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">spec&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">startSpec&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pod&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podStatus&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubecontainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodStatus&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pullSecrets&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Secret&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podIP&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podIPs&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="c1">// Step 4: execute the post start hook.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lifecycle&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lifecycle&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PostStart&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">kubeContainerID&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">kubecontainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ContainerID&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">runtimeName&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">containerID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">handlerErr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">runner&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">kubeContainerID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lifecycle&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PostStart&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">handlerErr&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">recordContainerEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">kubeContainerID&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventTypeWarning&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">events&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FailedPostStartHook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">killContainer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">kubeContainerID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;FailedPostStartHook&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reasonFailedPostStartHook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ErrorS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%s: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ErrPostStartHook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">handlerErr&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;Failed to kill container&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;pod&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">KObj&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pod&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="s">&amp;#34;podUID&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pod&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;containerName&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;containerID&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">kubeContainerID&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%s: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ErrPostStartHook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">handlerErr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å®žçŽ°æ–¹æ¡ˆ">å®žçŽ°æ–¹æ¡ˆ&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/16197365667225.jpg" alt="">&lt;/p>
&lt;p>&lt;a href="https://github.com/addozhang/k8s-container-sequence-sample/blob/main/cmd/entrypoint/wait.go#L26">cmd/entrypoint/wait.go#L26&lt;/a> ï¼ˆè¿™é‡Œå‚è€ƒäº† Istio çš„ pilot-agent å®žçŽ° ï¼‰&lt;/p>
&lt;p>åœ¨ &lt;code>PostStart&lt;/code> ä¸­æŒç»­çš„åŽ»æ£€æŸ¥ &lt;code>/ready&lt;/code> æ–­ç‚¹ï¼Œå¯ä»¥ hold ä½å½“å‰å®¹å™¨çš„åˆ›å»ºæµç¨‹ã€‚ä¿è¯ &lt;code>/ready&lt;/code> è¿”å›ž &lt;code>200&lt;/code> åŽï¼Œkubelet æ‰ä¼šåŽ»åˆ›å»ºä¸‹ä¸€ä¸ªå®¹å™¨ã€‚&lt;/p>
&lt;p>è¿™æ ·å°±è¾¾åˆ°äº†å‰é¢æˆªå›¾ä¸­æ¼”ç¤ºçš„æ•ˆæžœã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Before&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">timeoutAt&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">checkIfReady&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">url&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sidecar is ready&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sidecar is not ready&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">periodMillis&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Millisecond&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sidecar is not ready in %d second(s)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">timeoutSeconds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://banzaicloud.com/blog/k8s-sidecars/">Sidecar container lifecycle changes in Kubernetes 1.18&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://medium.com/@marko.luksa/delaying-application-start-until-sidecar-is-ready-2ec2d21a7b74">Delaying application start until sidecar is ready&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>æœåŠ¡ç½‘æ ¼å¹³ç¨³è½åœ°ï¼šIstio ä¸­ç²¾å‡†æŽ§åˆ¶ Sidecar çš„æ³¨å…¥</title><link>https://atbug.com/how-to-control-istio-sidecar-injection/</link><pubDate>Wed, 21 Apr 2021 08:13:04 +0800</pubDate><guid>https://atbug.com/how-to-control-istio-sidecar-injection/</guid><description>
&lt;h2 id="ä¸ºä»€ä¹ˆ">ä¸ºä»€ä¹ˆ&lt;/h2>
&lt;p>è¯´èµ·æœåŠ¡ç½‘æ ¼ï¼Œè¿™å¹…å›¾å¤§å®¶è‚¯å®šä¸ä¼šé™Œç”Ÿã€‚è¿™å°±æ˜¯æœåŠ¡ç½‘æ ¼çš„ç½‘ç»œï¼Œä¹Ÿæ˜¯ç½‘æ ¼æž¶æž„çš„ç»ˆæžå½¢æ€ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/21/cleanshot-20210420-at-2314142x.png" alt="">&lt;/p>
&lt;p>é‚£åœ¨è¿ç§»åˆ°ç½‘æ ¼æž¶æž„ä¹‹å‰ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/21/cleanshot-20210420-at-2316432x.png" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬çš„ç³»ç»Ÿåœ¨æ¼”è¿›çš„è¿‡ç¨‹ä¸­ï¼Œä¸å¯é¿å…çš„ä¼šé‡åˆ°å„ç§ 0 åˆ° 1 è¿‡ç¨‹ä¸­çš„ä¸­é—´æ€ã€‚æ¯”å¦‚ä¸‹é¢è¿™ç§ï¼Œå¯ä»¥æ¯”è¾ƒç›´è§‚çš„çœ‹å‡º Istio æˆ–è€…ç½‘æ ¼æ˜¯éƒ¨åˆ†è¦†ç›–çš„ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¹³æ»‘ã€å¯æŽ§çš„æŽ¨è¿›ï¼Œæ‰èƒ½åœ¨ä¿éšœç³»ç»Ÿå¯ç”¨æ€§çš„å‰æä¸‹è¿›è¡Œæž¶æž„çš„æ¼”è¿›ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/21/cleanshot-20210420-at-2318242x.png" alt="">&lt;/p>
&lt;h2 id="æ€Žä¹ˆåš">æ€Žä¹ˆåš&lt;/h2>
&lt;p>Sidecar çš„æ³¨å…¥åˆ†ä¸¤ç§ï¼šæ‰‹åŠ¨å’Œè‡ªåŠ¨ã€‚&lt;/p>
&lt;h3 id="æ‰‹åŠ¨">æ‰‹åŠ¨&lt;/h3>
&lt;p>æ‰‹åŠ¨å°±æ˜¯åˆ©ç”¨ Istio çš„ cli å·¥å…· &lt;code>istioctl kube-inject&lt;/code> å¯¹èµ„æº yaml è¿›è¡Œä¿®æ”¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ istioctl kube-inject -f samples/sleep/sleep.yaml &lt;span class="p">|&lt;/span> kubectl apply -f -
serviceaccount/sleep created
service/sleep created
deployment.apps/sleep created
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰‹åŠ¨çš„æ–¹å¼æ¯”è¾ƒé€‚åˆå¼€å‘é˜¶æ®µä½¿ç”¨ã€‚&lt;/p>
&lt;h3 id="è‡ªåŠ¨">è‡ªåŠ¨&lt;/h3>
&lt;p>sidecar çš„è‡ªåŠ¨æ³¨å…¥åˆ™æ˜¯é€šè¿‡ &lt;a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/">mutating webhook admission controller&lt;/a> å®žçŽ°çš„ã€‚å…¶åŽŸç†ç®€å•è¯´å°±æ˜¯æ‹¦æˆª podçš„åˆ›å»ºè¯·æ±‚æ¥å¯¹ pod çš„èµ„æºå®šä¹‰è¿›è¡Œä¿®æ”¹ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯¹æˆªå–äº† &lt;code>istio-sidecar-injector&lt;/code> &lt;code>MutatingWebhookConfiguration&lt;/code> çš„éƒ¨åˆ†å†…å®¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">webhooks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Exact&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sidecar-injector.istio.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespaceSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">istio-injection&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">enabled&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">objectSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sidecar.istio.io/inject&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NotIn&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">values&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#4&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiVersions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">operations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">CREATE&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pods&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scope&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>è¿™é‡Œçš„ &lt;code>matchPolicy: Exact&lt;/code> é’ˆå¯¹çš„æ˜¯ #4 ä¸­çš„ &lt;code>apiGroups&lt;/code>ä¸Ž&lt;code>apiVersions&lt;/code> çš„ç»„åˆï¼Œå³ç²¾ç¡®åŒ¹é… &lt;code>v1/pods&lt;/code> çš„ &lt;code>CREATE&lt;/code> è¯·æ±‚&lt;/li>
&lt;li>é¡¾åæ€ä¹‰ï¼ŒåŒ¹é…ç¬¦åˆæ¡ä»¶çš„ &lt;code>namespace&lt;/code>&lt;/li>
&lt;li>åŒ2ï¼ŒåŒ¹é…ç¬¦åˆæ¡ä»¶çš„ &lt;code>object&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>æ³¨ï¼š #2ã€#3 æ”¯æŒ Kubernetes çš„&lt;a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/">æ ‡ç­¾é€‰æ‹©è¯­æ³•&lt;/a>&lt;/p>
&lt;p>æŒ‰ç…§å‰é¢çš„è¯´æ˜Žï¼Œè¿™ä¸ª hook ä¼šæ‹¦æˆªæ‰“äº† &lt;code>istio-injection: enabled&lt;/code> label çš„ namespace ä¸‹ï¼Œæ²¡æœ‰æ‰“ &lt;code>sidecar.istio.io/inject: false&lt;/code> æ ‡ç­¾çš„ &lt;code>v1/pod&lt;/code> çš„åˆ›å»ºã€‚é€šè¿‡ &lt;code>https://istiod.istio-system:443/inject&lt;/code> ç«¯ç‚¹å¯¹ pod çš„å®šä¹‰è¿›è¡Œå®šåˆ¶ï¼ˆæ·»åŠ  &lt;code>init-container&lt;/code>ã€sidecar å®¹å™¨ç­‰ï¼‰ã€‚&lt;/p>
&lt;p>æœ‰äººå¯èƒ½ä¼šè¯´è¿™æ ·è¿˜ä¸å¤Ÿç²¾å‡†ï¼Œå› ä¸ºå¯èƒ½æŸä¸ª namespace ä¸‹åªæœ‰éƒ¨åˆ†å¯¹è±¡æ‰ä¼šæ³¨å…¥ sidecarã€‚&lt;/p>
&lt;p>è¿™å°±éœ€è¦å€ŸåŠ© &lt;code>istiod&lt;/code> çš„é€»è¾‘äº†ã€‚&lt;/p>
&lt;h3 id="åªé’ˆå¯¹ç‰¹å®š-pod-æ³¨å…¥sidecar-æˆ–å¿½ç•¥æ³¨å…¥">åªé’ˆå¯¹ç‰¹å®š pod æ³¨å…¥sidecar æˆ–å¿½ç•¥æ³¨å…¥&lt;/h3>
&lt;p>åœ¨ &lt;code>configmap&lt;/code> &lt;code>istio-sidecar-injector&lt;/code> ä¸­æœ‰ä¸¤ä¸ªå­—æ®µ &lt;code>alwaysInjectSelector&lt;/code> å’Œ &lt;code>neverInjectSelector&lt;/code>ã€‚ä»Žåå­—æ¥çœ‹è¿™ä¸¤ä¸ªåˆ†åˆ«æä¾›äº†ç™½åå•ã€é»‘åå•çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">alwaysInjectSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="l">neverInjectSelector:[]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬åªéœ€å¦‚ä¸‹è°ƒæ•´ï¼ˆéœ€è¦é‡å¯ istiodï¼‰ï¼Œç„¶åŽä¸ºéœ€è¦æ³¨å…¥ sidecar çš„èµ„æºæ‰“ä¸Šç›¸åº”çš„æ ‡ç­¾å³å¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">alwaysInjectSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sidecar.istio.io/inject&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">In&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">values&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;true&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;enabled&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;yes&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨ Kubernetes ä¸Šçš„è¿›åŒ–</title><link>https://atbug.com/translation-distributed-systems-kubernetes/</link><pubDate>Mon, 29 Mar 2021 23:11:25 +0800</pubDate><guid>https://atbug.com/translation-distributed-systems-kubernetes/</guid><description>
&lt;p>æœ¬æ–‡è¯‘è‡ª &lt;a href="https://www.infoq.com/articles/distributed-systems-kubernetes/">The Evolution of Distributed Systems on Kubernetes&lt;/a>&lt;/p>
&lt;p>åœ¨ 3 æœˆä»½çš„ QCon ä¸Šï¼Œæˆ‘åšäº†ä¸€ä¸ªå…³äºŽ Kubernetes çš„åˆ†å¸ƒå¼ç³»ç»Ÿè¿›åŒ–çš„æ¼”è®²ã€‚é¦–å…ˆï¼Œæˆ‘æƒ³å…ˆé—®ä¸€ä¸ªé—®é¢˜ï¼Œå¾®æœåŠ¡ä¹‹åŽæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ç›¸ä¿¡å¤§å®¶éƒ½æœ‰å„è‡ªçš„ç­”æ¡ˆï¼Œæˆ‘ä¹Ÿæœ‰æˆ‘çš„ç­”æ¡ˆã€‚ä½ ä¼šåœ¨æœ€åŽå‘çŽ°æˆ‘çš„æƒ³æ³•æ˜¯ä»€ä¹ˆã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæˆ‘å»ºè®®å¤§å®¶çœ‹çœ‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Ÿä»¥åŠè¿™äº›éœ€æ±‚åœ¨è¿‡åŽ»æ˜¯å¦‚ä½•å‘å±•çš„ï¼Œä»Žå•ä½“åº”ç”¨å¼€å§‹åˆ° Kubernetesï¼Œå†åˆ°æœ€è¿‘çš„ Daprã€Istioã€Knative ç­‰é¡¹ç›®ï¼Œå®ƒä»¬æ˜¯å¦‚ä½•æ”¹å˜æˆ‘ä»¬åšåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ–¹å¼ã€‚æˆ‘ä»¬å°†å°è¯•å¯¹æœªæ¥åšä¸€äº›é¢„æµ‹ã€‚&lt;/p>
&lt;h2 id="çŽ°ä»£åˆ†å¸ƒå¼åº”ç”¨">çŽ°ä»£åˆ†å¸ƒå¼åº”ç”¨&lt;/h2>
&lt;p>ä¸ºäº†ç»™è¿™ä¸ªè¯é¢˜æä¾›æ›´å¤šçš„èƒŒæ™¯ä¿¡æ¯ï¼Œæˆ‘è®¤ä¸ºçš„åˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ç”±æ•°ç™¾ä¸ªç»„ä»¶ç»„æˆçš„ç³»ç»Ÿã€‚è¿™äº›ç»„ä»¶å¯ä»¥æ˜¯æœ‰çŠ¶æ€çš„ã€æ— çŠ¶æ€çš„æˆ–è€…æ— æœåŠ¡å™¨çš„ã€‚æ­¤å¤–ï¼Œè¿™äº›ç»„ä»¶å¯ä»¥ç”¨ä¸åŒçš„è¯­è¨€åˆ›å»ºï¼Œè¿è¡Œåœ¨æ··åˆçŽ¯å¢ƒä¸Šï¼Œå¹¶å¼€å‘å¼€æºæŠ€æœ¯ã€å¼€æ”¾æ ‡å‡†å’Œäº’æ“ä½œæ€§ã€‚æˆ‘ç›¸ä¿¡ä½ å¯ä»¥ä½¿ç”¨é—­æºè½¯ä»¶æ¥æž„å»ºè¿™æ ·çš„ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥åœ¨ AWS å’Œå…¶ä»–åœ°æ–¹æž„å»ºã€‚å…·ä½“åˆ°è¿™æ¬¡æ¼”è®²ï¼Œæˆ‘å°†å…³æ³¨ Kubernetes ç”Ÿæ€ç³»ç»Ÿï¼Œä»¥åŠä½ å¦‚ä½•åœ¨ Kubernetes å¹³å°ä¸Šæž„å»ºè¿™æ ·ä¸€ä¸ªç³»ç»Ÿã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä»Žåˆ†å¸ƒå¼ç³»ç»Ÿçš„éœ€æ±‚è®²èµ·ã€‚æˆ‘è®¤ä¸ºæ˜¯æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªåº”ç”¨æˆ–è€…æœåŠ¡ï¼Œå¹¶å†™ä¸€äº›ä¸šåŠ¡é€»è¾‘ã€‚é‚£ä»Žè¿è¡Œæ—¶çš„å¹³å°åˆ°æž„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä»€ä¹ˆå‘¢ï¼Ÿåœ¨åº•å±‚ï¼Œæœ€å¼€å§‹æ˜¯æˆ‘ä»¬è¦ä¸€äº›ç”Ÿå‘½å‘¨æœŸçš„èƒ½åŠ›ã€‚å½“ä½ ç”¨ä»»ä¸€è¯­è¨€å¼€å‘ä½ çš„åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰èƒ½åŠ›æŠŠè¿™ä¸ªåº”ç”¨å¯é åœ°æ‰“åŒ…å’Œéƒ¨ç½²ã€å›žæ»šã€å¥åº·æ£€æŸ¥ã€‚å¹¶ä¸”èƒ½å¤ŸæŠŠåº”ç”¨éƒ¨ç½²åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œå¹¶å®žçŽ°èµ„æºéš”ç¦»ã€æ‰©å±•ã€é…ç½®ç®¡ç†ï¼Œä»¥åŠæ‰€æœ‰è¿™äº›ã€‚è¿™äº›éƒ½æ˜¯ä½ åˆ›å»ºåˆ†å¸ƒå¼åº”ç”¨æ‰€éœ€è¦çš„ç¬¬ä¸€ç‚¹ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/55image0011616431697020.jpg" alt="">&lt;/p>
&lt;p>ç¬¬äºŒç‚¹æ˜¯å›´ç»•ç½‘ç»œã€‚æˆ‘ä»¬æœ‰äº†åº”ç”¨ä¹‹åŽï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒèƒ½å¤Ÿå¯é åœ°è¿žæŽ¥åˆ°å…¶ä»–æœåŠ¡ï¼Œæ— è®ºè¯¥æœåŠ¡æ˜¯åœ¨é›†ç¾¤å†…éƒ¨è¿˜æ˜¯åœ¨å¤–éƒ¨ã€‚æˆ‘ä»¬å¸Œæœ›å…¶å…·æœ‰æœåŠ¡å‘çŽ°ã€è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ã€‚ä¸ºäº†ä¸åŒçš„å‘å¸ƒç­–ç•¥æˆ–æ˜¯å…¶ä»–çš„ä¸€äº›åŽŸå› çš„æˆ‘ä»¬å¸Œæœ›æœ‰æµé‡è½¬ç§»çš„èƒ½åŠ›ã€‚ç„¶åŽæˆ‘ä»¬è¿˜å¸Œæœ›å…¶å…·æœ‰ä¸Žå…¶ä»–ç³»ç»Ÿè¿›è¡Œå¼¹æ€§é€šä¿¡çš„èƒ½åŠ›ï¼Œæ— è®ºæ˜¯é€šè¿‡é‡è¯•ã€è¶…æ—¶è¿˜æ˜¯æ–­è·¯å™¨ã€‚è¦æœ‰é€‚å½“çš„å®‰å…¨ä¿éšœï¼Œå¹¶ä¸”è¦æœ‰è¶³å¤Ÿçš„ç›‘æŽ§ã€è¿½è¸ªã€å¯è§‚å¯Ÿæ€§ç­‰ç­‰ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/25image0021616431698392.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬æœ‰äº†ç½‘ç»œä¹‹åŽï¼ŒæŽ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬å¸Œæœ›æœ‰èƒ½åŠ›ä¸Žä¸åŒçš„ API å’Œç«¯ç‚¹äº¤äº’ï¼Œå³èµ„æºç»‘å®š&amp;ndash;ä¸Žå…¶ä»–åè®®å’Œä¸åŒçš„æ•°æ®æ ¼å¼äº¤äº’ã€‚ç”šè‡³èƒ½å¤Ÿä»Žä¸€ç§æ•°æ®æ ¼å¼è½¬æ¢æˆå¦ä¸€ç§æ•°æ®æ ¼å¼ã€‚æˆ‘è¿˜ä¼šåœ¨è¿™é‡ŒåŠ å…¥è¯¸å¦‚æ»¤å…‰çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬è®¢é˜…ä¸€ä¸ªä¸»é¢˜æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè®¸åªå¯¹æŸäº›äº‹ä»¶æ„Ÿå…´è¶£ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/45image0031616431697873.jpg" alt="">&lt;/p>
&lt;p>ä½ è®¤ä¸ºæœ€åŽä¸€ç±»æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯çŠ¶æ€ã€‚å½“æˆ‘åœ¨è¯´çŠ¶æ€å’Œæœ‰çŠ¶æ€çš„æŠ½è±¡æ—¶ï¼Œæˆ‘å¹¶ä¸æ˜¯åœ¨è°ˆè®ºå®žé™…çš„çŠ¶æ€ç®¡ç†ï¼Œæ¯”å¦‚æ•°æ®åº“æˆ–è€…æ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½ã€‚æˆ‘è¦è¯´çš„æ›´å¤šæ˜¯æœ‰å…³å¹•åŽä¾èµ–çŠ¶æ€çš„å¼€å‘äººå‘˜æŠ½è±¡ã€‚å¯èƒ½ï¼Œä½ éœ€è¦å…·æœ‰å·¥ä½œæµç®¡ç†çš„èƒ½åŠ›ã€‚ä¹Ÿè®¸ä½ æƒ³ç®¡ç†è¿è¡Œæ—¶é—´é•¿çš„è¿›ç¨‹æˆ–è€…åšä¸´æ—¶è°ƒåº¦æˆ–è€…æŸäº›å®šæ—¶ä»»åŠ¡æ¥å®šæœŸè¿è¡ŒæœåŠ¡ã€‚ä¹Ÿè®¸ä½ è¿˜æƒ³è¿›è¡Œåˆ†å¸ƒå¼ç¼“å­˜ï¼Œå…·æœ‰å¹‚ç­‰æ€§æˆ–è€…æ”¯æŒå›žæ»šã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯å¼€å‘äººå‘˜çº§çš„åŽŸè¯­ï¼Œä½†åœ¨å¹•åŽï¼Œå®ƒä»¬ä¾èµ–äºŽå…·æœ‰æŸç§çŠ¶æ€ã€‚ä½ æƒ³éšæ„ä½¿ç”¨è¿™äº›æŠ½è±¡ä¿©åˆ›å»ºå®Œå–„çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/26image0041616431697348.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªåˆ†å¸ƒå¼ç³»ç»ŸåŽŸè¯­çš„æ¡†æž¶æ¥è¯„ä¼°å®ƒä»¬åœ¨ Kubernetes å’Œå…¶ä»–é¡¹ç›®ä¸Šçš„å˜åŒ–æƒ…å†µã€‚&lt;/p>
&lt;h2 id="å•ä½“æž¶æž„----ä¼ ç»Ÿä¸­é—´ä»¶åŠŸèƒ½">å•ä½“æž¶æž„ &amp;ndash; ä¼ ç»Ÿä¸­é—´ä»¶åŠŸèƒ½&lt;/h2>
&lt;p>å‡è®¾æˆ‘ä»¬ä»Žå•ä½“æž¶æž„ä»¥åŠå¦‚ä½•èŽ·å¾—è¿™äº›èƒ½åŠ›å¼€å§‹ã€‚åœ¨é‚£ç§æƒ…å†µä¸‹ï¼Œé¦–å…ˆæ˜¯å½“æˆ‘è¯´å•ä½“çš„æ—¶å€™ï¼Œåœ¨åˆ†å¸ƒå¼åº”ç”¨çš„æƒ…å†µä¸‹æˆ‘æƒ³åˆ°çš„æ˜¯ ESBã€‚ESB æ˜¯ç›¸å½“å¼ºå¤§çš„ï¼Œå½“æˆ‘ä»¬æ£€æŸ¥æˆ‘ä»¬çš„éœ€æ±‚åˆ—è¡¨æ—¶ï¼Œæˆ‘ä»¬ä¼šè¯´ ESB å¯¹æ‰€æœ‰æœ‰çŠ¶æ€çš„æŠ½è±¡æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚&lt;/p>
&lt;p>ä½¿ç”¨ ESBï¼Œä½ å¯ä»¥è¿›è¡Œé•¿æ—¶é—´è¿è¡Œçš„æµç¨‹çš„ç¼–æŽ’ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€å›žæ»šå’Œå¹‚ç­‰ã€‚æ­¤å¤–ï¼ŒESB è¿˜æä¾›äº†å‡ºè‰²çš„èµ„æºç»‘å®šèƒ½åŠ›ï¼Œå¹¶ä¸”æœ‰æ•°ç™¾ä¸ªè¿žæŽ¥å™¨ï¼Œæ”¯æŒè½¬æ¢ã€ç¼–æŽ’ï¼Œç”šè‡³æœ‰è”ç½‘åŠŸèƒ½ã€‚æœ€åŽï¼ŒESB ç”šè‡³å¯ä»¥åšæœåŠ¡å‘çŽ°å’Œè´Ÿè½½å‡è¡¡ã€‚&lt;/p>
&lt;p>å®ƒå…·æœ‰å›´ç»•ç½‘ç»œè¿žæŽ¥çš„å¼¹æ€§çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå› æ­¤å®ƒå¯ä»¥è¿›è¡Œé‡è¯•ã€‚å¯èƒ½ ESB æœ¬è´¨ä¸Šä¸æ˜¯å¾ˆåˆ†å¸ƒå¼ï¼Œæ‰€ä»¥å®ƒä¸éœ€è¦éžå¸¸é«˜çº§çš„ç½‘ç»œå’Œå‘å¸ƒèƒ½åŠ›ã€‚ESB æ¬ ç¼ºçš„ä¸»è¦æ˜¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚å› ä¸ºå®ƒæ˜¯å•ä¸€è¿è¡Œæ—¶ï¼Œæ‰€ä»¥ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ä½ åªèƒ½ä½¿ç”¨ä¸€ç§è¯­è¨€ã€‚é€šå¸¸æ˜¯åˆ›å»ºå®žé™…è¿è¡Œæ—¶çš„è¯­è¨€ï¼ŒJavaã€.NETã€æˆ–è€…å…¶ä»–çš„è¯­è¨€ã€‚ç„¶åŽï¼Œå› ä¸ºæ˜¯å•ä¸€è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½è½»æ¾åœ°è¿›è¡Œå£°æ˜Žå¼çš„éƒ¨ç½²æˆ–è€…è‡ªåŠ¨é˜²æ­¢ã€‚éƒ¨ç½²æ˜¯ç›¸å½“å¤§ä¸”éžå¸¸é‡çš„ï¼Œæ‰€ä»¥å®ƒé€šå¸¸æ¶‰åŠåˆ°äººæœºäº¤äº’ã€‚è¿™ç§å•ä½“æž¶æž„çš„å¦ä¸€ä¸ªéš¾ç‚¹æ˜¯æ‰©å±•ï¼šâ€œæˆ‘ä»¬æ— æ³•æ‰©å±•å•ä¸ªç»„ä»¶ã€‚â€&lt;/p>
&lt;p>æœ€åŽå´å¹¶éžæœ€ä¸é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œå›´ç»•éš”ç¦»ï¼Œæ— è®ºæ˜¯èµ„æºéš”ç¦»è¿˜æ˜¯æ•…éšœéš”ç¦»ã€‚ä½¿ç”¨å•ä½“æž¶æž„æ— æ³•å®Œæˆæ‰€æœ‰è¿™äº›å·¥ä½œã€‚ä»Žæˆ‘ä»¬çš„éœ€æ±‚æ¡†æž¶æ¥çœ‹ï¼ŒESB çš„å•ä½“æž¶æž„ä¸ç¬¦åˆæ¡ä»¶ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/40image0051616431696438.jpg" alt="">&lt;/p>
&lt;h2 id="äº‘åŽŸç”Ÿæž¶æž„----å¾®æœåŠ¡å’Œ-kubernetes">äº‘åŽŸç”Ÿæž¶æž„ &amp;ndash; å¾®æœåŠ¡å’Œ Kubernetes&lt;/h2>
&lt;p>æŽ¥ä¸‹æ¥ï¼Œæˆ‘å»ºè®®æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹äº‘åŽŸç”Ÿæž¶æž„ä»¥åŠè¿™äº›éœ€æ±‚æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚å¦‚æžœæˆ‘ä»¬ä»Žä¸€ä¸ªéžå¸¸é«˜çš„å±‚é¢æ¥çœ‹ï¼Œè¿™äº›æž¶æž„æ˜¯å¦‚ä½•å‘ç”Ÿå˜åŒ–çš„ï¼Œäº‘åŽŸç”Ÿå¯èƒ½å§‹äºŽå¾®æœåŠ¡è¿åŠ¨ã€‚å¾®æœåŠ¡ä½¿æˆ‘ä»¬å¯ä»¥æŒ‰ä¸šåŠ¡é¢†åŸŸè¿›è¡Œæ‹†åˆ†å•ä½“åº”ç”¨ã€‚äº‹å®žè¯æ˜Žï¼Œå®¹å™¨å’Œ Kubernetes å®žé™…ä¸Šæ˜¯ç®¡ç†è¿™äº›å¾®æœåŠ¡çš„ä¼˜ç§€å¹³å°ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Kubernetes å¯¹äºŽå¾®æœåŠ¡ç‰¹åˆ«æœ‰å¸å¼•åŠ›çš„ä¸€äº›å…·ä½“ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/13image0061616431699209.jpg" alt="">&lt;/p>
&lt;p>ä»Žä¸€å¼€å§‹ï¼Œè¿›è¡Œå¥åº·çŠ¶å†µæŽ¢æµ‹çš„èƒ½åŠ›å°±æ˜¯ Kubernetes å—æ¬¢è¿Žçš„åŽŸå› ã€‚åœ¨å®žè·µä¸­ï¼Œè¿™æ„å‘³ç€å½“ä½ å°†å®¹å™¨éƒ¨ç½²åˆ° Pod ä¸­æ—¶ï¼ŒKubernetes ä¼šæ£€æŸ¥è¿›ç¨‹çš„è¿è¡ŒçŠ¶å†µã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¯¥è¿‡ç¨‹æ¨¡åž‹è¿˜ä¸å¤Ÿå¥½ã€‚ä½ å¯èƒ½ä»ç„¶æœ‰ä¸€ä¸ªå·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œä½†æ˜¯å®ƒå¹¶ä¸å¥åº·ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿˜å¯ä»¥ä½¿ç”¨å°±ç»ªåº¦å’Œå­˜æ´»åº¦æ£€æŸ¥çš„åŽŸå› ã€‚Kubernetes ä¼šåšä¸€ä¸ªå°±ç»ªåº¦æ£€æŸ¥ï¼Œä»¥ç¡®å®šä½ çš„åº”ç”¨åœ¨å¯åŠ¨æœŸé—´ä½•æ—¶å‡†å¤‡æŽ¥å—æµé‡ã€‚å®ƒå°†è¿›è¡Œæ´»è·ƒåº¦æ£€æŸ¥ï¼Œä»¥æ£€æŸ¥æœåŠ¡çš„è¿è¡ŒçŠ¶å†µã€‚åœ¨ Kubernetes ä¹‹å‰ï¼Œè¿™å¹¶ä¸æ˜¯å¾ˆæµè¡Œï¼Œä½†ä»Šå¤©å‡ ä¹Žæ‰€æœ‰è¯­è¨€ã€æ‰€æœ‰æ¡†æž¶ã€æ‰€æœ‰è¿è¡Œæ—¶éƒ½æœ‰å¥åº·æ£€æŸ¥åŠŸèƒ½ï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­å¿«é€Ÿå¯åŠ¨ç«¯ç‚¹ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/29image0071616431696697.jpg" alt="">&lt;/p>
&lt;p>Kubernetes å¼•å…¥çš„ä¸‹ä¸€ä¸ªç‰¹æ€§æ˜¯å›´ç»•åº”ç”¨ç¨‹åºçš„æ‰˜ç®¡ç”Ÿå‘½å‘¨æœŸ&amp;ndash;æˆ‘çš„æ„æ€æ˜¯ï¼Œä½ ä¸å†æŽ§åˆ¶ä½•æ—¶å¯åŠ¨ã€ä½•æ—¶å…³é—­æœåŠ¡ã€‚ä½ ç›¸ä¿¡å¹³å°å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚Kubernetes å¯ä»¥å¯åŠ¨ä½ çš„åº”ç”¨ï¼›å®ƒå¯ä»¥å°†å…¶å…³é—­ï¼Œç„¶åŽåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šç§»åŠ¨å®ƒã€‚ä¸ºæ­¤ï¼Œä½ å¿…é¡»æ­£ç¡®æ‰§è¡Œå¹³å°åœ¨åº”ç”¨å¯åŠ¨å’Œå…³é—­æœŸé—´å‘Šè¯‰ä½ çš„äº‹ä»¶ã€‚&lt;/p>
&lt;p>Kubernetes åˆ˜å…´çš„å¦ä¸€ä»¶ç‰¹æ€§æ˜¯å›´ç»•ç€å£°æ˜Žå¼éƒ¨ç½²ã€‚è¿™æ„å‘³ç€ä½ ä¸å†éœ€è¦å¯åŠ¨æœåŠ¡ï¼›æ£€æŸ¥æ—¥å¿—æ˜¯å¦å·²ç»å¯åŠ¨ã€‚ä½ ä¸å¿…æ‰‹åŠ¨å‡çº§å®žä¾‹&amp;ndash;æ”¯æŒå£°æ˜Žå¼éƒ¨ç½²çš„ Kubernetes å¯ä»¥ä¸ºä½ åšåˆ°è¿™ä¸€ç‚¹ã€‚æ ¹æ®ä½ é€‰æ‹©çš„ç­–ç•¥ï¼Œå®ƒå¯ä»¥åœæ­¢æ—§å®žä¾‹å¹¶å¯åŠ¨æ–°å®žä¾‹ã€‚æ­¤å¤–ï¼Œå¦‚æžœå‡ºçŽ°é—®é¢˜ï¼Œå¯ä»¥è¿›è¡Œå›žæ»šã€‚&lt;/p>
&lt;p>å¦å¤–å°±æ˜¯å£°æ˜Žä½ çš„èµ„æºéœ€æ±‚ã€‚åˆ›å»ºæœåŠ¡æ—¶ï¼Œå°†å…¶å®¹å™¨åŒ–ã€‚æœ€å¥½å‘Šè¯‰å¹³å°è¯¥æœåŠ¡å°†éœ€è¦å¤šå°‘ CPU å’Œå†…å­˜ã€‚Kubernetes åˆ©ç”¨è¿™äº›ä¿¡æ¯ä¸ºä½ çš„å·¥ä½œè´Ÿè½½æ‰¾åˆ°æœ€ä½³èŠ‚ç‚¹ã€‚åœ¨ä½¿ç”¨ Kubernetes ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»æ ¹æ®æˆ‘ä»¬çš„æ ‡å‡†å°†å®žä¾‹æ‰‹åŠ¨æ”¾ç½®åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚çŽ°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„åå¥½æ¥æŒ‡å¯¼ Kubernetesï¼Œå®ƒå°†ä¸ºæˆ‘ä»¬åšå‡ºæœ€ä½³çš„å†³ç­–ã€‚&lt;/p>
&lt;p>å¦‚ä»Šï¼Œåœ¨ Kubernetes ä¸Šï¼Œä½ å¯ä»¥è¿›è¡Œå¤šè¯­è¨€é…ç½®ç®¡ç†ã€‚æ— éœ€åœ¨åº”ç”¨ç¨‹åºè¿è¡Œæ—¶è¿›è¡Œé…ç½®æŸ¥æ‰¾å°±å¯ä»¥è¿›è¡Œä»»ä½•æ“ä½œã€‚Kubernetes ä¼šç¡®ä¿é…ç½®æœ€ç»ˆåœ¨å·¥ä½œè´Ÿè½½æ‰€åœ¨çš„åŒä¸€èŠ‚ç‚¹ä¸Šã€‚è¿™äº›é…ç½®è¢«æ˜ å°„ä¸ºå·æˆ–çŽ¯å¢ƒå˜é‡ï¼Œä»¥ä¾›ä½ çš„åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚&lt;/p>
&lt;p>äº‹å®žè¯æ˜Žï¼Œæˆ‘åˆšæ‰è°ˆåˆ°çš„é‚£äº›ç‰¹å®šåŠŸèƒ½ä¹Ÿæ˜¯ç›¸å…³çš„ã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æžœè¦è¿›è¡Œè‡ªåŠ¨æ”¾ç½®ï¼Œåˆ™å¿…é¡»å‘Šè¯‰ Kubernetes æœåŠ¡çš„èµ„æºéœ€æ±‚ã€‚ç„¶åŽï¼Œä½ å¿…é¡»å‘Šè¯‰å®ƒè¦ä½¿ç”¨çš„éƒ¨ç½²ç­–ç•¥ã€‚ä¸ºäº†è®©ç­–ç•¥æ­£ç¡®è¿è¡Œï¼Œä½ çš„åº”ç”¨ç¨‹åºå¿…é¡»æ‰§è¡Œæ¥è‡ªçŽ¯å¢ƒçš„äº‹ä»¶ã€‚å®ƒå¿…é¡»æ‰§è¡Œå¥åº·æ£€æŸ¥ã€‚ä¸€æ—¦é‡‡ç”¨äº†æ‰€æœ‰è¿™äº›æœ€ä½³å®žè·µå¹¶ä½¿ç”¨æ‰€æœ‰è¿™äº›åŠŸèƒ½ï¼Œä½ çš„åº”ç”¨å°±ä¼šæˆä¸ºå‡ºè‰²çš„äº‘åŽŸç”Ÿå…¬æ°‘ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ Kubernetes ä¸Šå®žçŽ°è‡ªåŠ¨åŒ–äº†ï¼ˆè¿™æ˜¯åœ¨ Kubernetes ä¸Šè¿è¡Œå·¥ä½œè´Ÿè½½çš„åŸºæœ¬æ¨¡å¼ï¼‰ã€‚æœ€åŽï¼Œè¿˜æœ‰å›´ç»•ç€æž„å»º Pod ä¸­çš„å®¹å™¨ã€é…ç½®ç®¡ç†å’Œè¡Œä¸ºï¼Œè¿˜æœ‰å…¶ä»–æ¨¡å¼ã€‚&lt;/p>
&lt;p>æˆ‘è¦ç®€è¦ä»‹ç»çš„ä¸‹ä¸€ä¸ªä¸»é¢˜æ˜¯å·¥ä½œè´Ÿè½½ã€‚ä»Žç”Ÿå‘½å‘¨æœŸçš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè¿è¡Œä¸åŒçš„å·¥ä½œè´Ÿè½½ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ Kubernetes ä¸Šåšåˆ°è¿™ä¸€ç‚¹ã€‚è¿è¡ŒåäºŒè¦ç´ åº”ç”¨ç¨‹åºå’Œæ— çŠ¶æ€å¾®æœåŠ¡éžå¸¸ç®€å•ã€‚Kubernetes å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚è¿™ä¸æ˜¯ä½ å°†è¦æ‰¿æ‹…çš„å”¯ä¸€å·¥ä½œé‡ã€‚å¯èƒ½ä½ è¿˜æœ‰æœ‰çŠ¶æ€çš„å·¥ä½œè´Ÿè½½ï¼Œä½ å¯ä»¥ä½¿ç”¨æœ‰çŠ¶æ€é›†åœ¨ Kubernetes ä¸Šå®Œæˆæ­¤å·¥ä½œã€‚&lt;/p>
&lt;p>ä½ å¯èƒ½è¿˜æœ‰çš„å¦ä¸€ä¸ªå·¥ä½œè´Ÿè½½æ˜¯å•ä¾‹ã€‚ä¹Ÿè®¸ä½ å¸Œæœ›æŸä¸ªåº”ç”¨ç¨‹åºçš„å®žä¾‹æ˜¯æ•´ä¸ªé›†ç¾¤ä¸­åº”ç”¨ç¨‹åºçš„å”¯ä¸€ä¸€ä¸ªå®žä¾‹&amp;ndash;ä½ å¸Œæœ›å®ƒæˆä¸ºå¯é çš„å•ä¾‹ã€‚å¦‚æžœå¤±è´¥ï¼Œåˆ™é‡æ–°å¯åŠ¨ã€‚å› æ­¤ï¼Œä½ å¯ä»¥æ ¹æ®éœ€æ±‚ä»¥åŠæ˜¯å¦å¸Œæœ›å•ä¾‹è‡³å°‘å…·æœ‰ä¸€ç§æˆ–æœ€å¤šä¸€ç§è¯­ä¹‰æ¥åœ¨æœ‰çŠ¶æ€é›†å’Œå‰¯æœ¬é›†ä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚ä½ å¯èƒ½è¿˜æœ‰çš„å¦ä¸€ä¸ªå·¥ä½œè´Ÿè½½æ˜¯å›´ç»•ä½œä¸šå’Œå®šæ—¶ä½œä¸š&amp;ndash;æœ‰äº† Kubernetesï¼Œä½ ä¹Ÿå¯ä»¥å®žçŽ°è¿™äº›ã€‚&lt;/p>
&lt;p>å¦‚æžœæˆ‘ä»¬å°†æ‰€æœ‰è¿™äº› Kubernetes åŠŸèƒ½æ˜ å°„åˆ°æˆ‘ä»¬çš„éœ€æ±‚ï¼Œåˆ™ Kubernetes å¯ä»¥æ»¡è¶³ç”Ÿå‘½å‘¨æœŸéœ€æ±‚ã€‚æˆ‘é€šå¸¸åˆ›å»ºçš„éœ€æ±‚åˆ—è¡¨ä¸»è¦æ˜¯ç”± Kubernetes ä»Šå¤©æä¾›ç»™æˆ‘ä»¬çš„ã€‚è¿™äº›æ˜¯ä»»ä½•å¹³å°ä¸Šçš„é¢„æœŸåŠŸèƒ½ï¼Œè€Œ Kubernetes å¯ä»¥ä¸ºä½ çš„éƒ¨ç½²åšçš„æ˜¯é…ç½®ç®¡ç†ã€èµ„æºéš”ç¦»å’Œæ•…éšœéš”ç¦»ã€‚æ­¤å¤–ï¼Œé™¤äº†æ— æœåŠ¡å™¨æœ¬èº«ä¹‹å¤–ï¼Œå®ƒè¿˜æ”¯æŒå…¶ä»–å·¥ä½œè´Ÿè½½ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/12image0081616431698134.jpg" alt="">&lt;/p>
&lt;p>ç„¶åŽï¼Œå¦‚æžœè¿™å°±æ˜¯ Kubernetes ç»™å¼€å‘è€…æä¾›çš„å…¨éƒ¨åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•æ‰©å±• Kubernetes å‘¢ï¼Ÿä»¥åŠå¦‚ä½•ä½¿å®ƒå…·æœ‰æ›´å¤šåŠŸèƒ½ï¼Ÿå› æ­¤ï¼Œæˆ‘æƒ³æè¿°å½“ä»Šä½¿ç”¨çš„ä¸¤ç§å¸¸ç”¨æ–¹æ³•ã€‚&lt;/p>
&lt;h2 id="è¿›ç¨‹å¤–æ‰©å±•æœºåˆ¶">è¿›ç¨‹å¤–æ‰©å±•æœºåˆ¶&lt;/h2>
&lt;p>é¦–å…ˆæ˜¯ Pod çš„æ¦‚å¿µï¼ŒPod æ˜¯ç”¨äºŽåœ¨èŠ‚ç‚¹ä¸Šéƒ¨ç½²å®¹å™¨çš„æŠ½è±¡ã€‚æ­¤å¤–ï¼ŒPod ç»™æˆ‘ä»¬æä¾›äº†ä¸¤ç»„ä¿è¯ï¼š&lt;/p>
&lt;ul>
&lt;li>ç¬¬ä¸€ç»„æ˜¯éƒ¨ç½²ä¿è¯ &amp;ndash; Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å§‹ç»ˆä½äºŽåŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚è¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥é€šè¿‡ localhost ç›¸äº’é€šä¿¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæˆ–é€šè¿‡å…¶ä»– IPC æœºåˆ¶è¿›è¡Œå¼‚æ­¥é€šä¿¡ã€‚&lt;/li>
&lt;li>Pod ç»™æˆ‘ä»¬çš„å¦ä¸€ç»„ä¿è¯æ˜¯å›´ç»•ç”Ÿå‘½å‘¨æœŸçš„ã€‚Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å¹¶éžéƒ½ç›¸ç­‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/22image0091616431698660.jpg" alt="">&lt;/p>
&lt;p>æ ¹æ®ä½¿ç”¨çš„æ˜¯ init å®¹å™¨è¿˜æ˜¯åº”ç”¨ç¨‹åºå®¹å™¨ï¼Œä½ ä¼šèŽ·å¾—ä¸åŒçš„ä¿è¯ã€‚ä¾‹å¦‚ï¼Œinit å®¹å™¨åœ¨å¼€å§‹æ—¶è¿è¡Œï¼›å½“ Pod å¯åŠ¨æ—¶ï¼Œå®ƒæŒ‰é¡ºåºä¸€ä¸ªæŽ¥ä¸€ä¸ªåœ°è¿è¡Œã€‚ä»–ä»¬ä»…åœ¨ä¹‹å‰çš„å®¹å™¨å·²æˆåŠŸå®Œæˆæ—¶è¿è¡Œã€‚å®ƒä»¬æœ‰åŠ©äºŽå®žçŽ°ç”±å®¹å™¨é©±åŠ¨çš„ç±»ä¼¼å·¥ä½œæµçš„é€»è¾‘ã€‚&lt;/p>
&lt;p>å¦ä¸€æ–¹é¢ï¼Œåº”ç”¨ç¨‹åºå®¹å™¨æ˜¯å¹¶è¡Œè¿è¡Œçš„ã€‚å®ƒä»¬åœ¨æ•´ä¸ª Pod çš„ç”Ÿå‘½å‘¨æœŸä¸­è¿è¡Œï¼Œè¿™ä¹Ÿæ˜¯ sidecar æ¨¡å¼çš„åŸºç¡€ã€‚sidecar å¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œè¿™äº›å®¹å™¨å¯ä»¥åä½œå¹¶å…±åŒä¸ºç”¨æˆ·æä¾›ä»·å€¼ã€‚è¿™ä¹Ÿæ˜¯å½“ä»Šæˆ‘ä»¬çœ‹åˆ°çš„æ‰©å±• Kubernetes é™„åŠ åŠŸèƒ½çš„ä¸»è¦æœºåˆ¶ä¹‹ä¸€ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/9image0101616431695489.jpg" alt="">&lt;/p>
&lt;p>ä¸ºäº†è§£é‡Šä»¥ä¸‹åŠŸèƒ½ï¼Œæˆ‘å¿…é¡»ç®€è¦åœ°å‘Šè¯‰ä½  Kubernetes å†…éƒ¨çš„å·¥ä½œæ–¹å¼ã€‚å®ƒæ˜¯åŸºäºŽè°ƒè°å¾ªçŽ¯çš„ã€‚è°ƒè°å¾ªçŽ¯çš„æ€æƒ³æ˜¯å°†æœŸæœ›çŠ¶æ€é©±åŠ¨åˆ°å®žé™…çŠ¶æ€ã€‚åœ¨ Kubernetes ä¸­ï¼Œå¾ˆå¤šåŠŸèƒ½éƒ½æ˜¯é è¿™ä¸ªæ¥å®žçŽ°çš„ã€‚ä¾‹å¦‚ï¼Œå½“ä½ è¯´æˆ‘è¦ä¸¤ä¸ª Pod å®žä¾‹ï¼Œè¿™ç³»ç»Ÿçš„æœŸæœ›çŠ¶æ€ã€‚æœ‰ä¸€ä¸ªæŽ§åˆ¶å¾ªçŽ¯ä¸æ–­åœ°è¿è¡Œï¼Œå¹¶æ£€æŸ¥ä½ çš„ Pod æ˜¯å¦æœ‰ä¸¤ä¸ªå®žä¾‹ã€‚å¦‚æžœä¸å­˜åœ¨ä¸¤ä¸ªå®žä¾‹ï¼Œå®ƒå°†è®¡ç®—å·®å€¼ã€‚å®ƒå°†ç¡®ä¿å­˜åœ¨ä¸¤ä¸ªå®žä¾‹ã€‚&lt;/p>
&lt;p>è¿™æ–¹é¢çš„ä¾‹å­æœ‰å¾ˆå¤šã€‚ä¸€äº›æ˜¯å‰¯æœ¬é›†æˆ–æœ‰çŠ¶æ€é›†ã€‚èµ„æºå®šä¹‰æ˜ å°„åˆ°æŽ§åˆ¶å™¨æ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸”æ¯ä¸ªèµ„æºå®šä¹‰éƒ½æœ‰ä¸€ä¸ªæŽ§åˆ¶å™¨ã€‚è¯¥æŽ§åˆ¶å™¨ç¡®ä¿çŽ°å®žä¸–ç•Œä¸Žæ‰€éœ€æŽ§åˆ¶å™¨ç›¸åŒ¹é…ï¼Œä½ ç”šè‡³å¯ä»¥ç¼–å†™è‡ªå·±çš„è‡ªå®šä¹‰æŽ§åˆ¶å™¨ã€‚&lt;/p>
&lt;p>å½“åœ¨ Pod ä¸­è¿è¡Œåº”ç”¨ç¨‹åºæ—¶ï¼Œä½ å°†æ— æ³•åœ¨è¿è¡Œæ—¶åŠ è½½ä»»ä½•é…ç½®æ–‡ä»¶æ›´æ”¹ã€‚ç„¶è€Œï¼Œä½ å¯ä»¥ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰æŽ§åˆ¶å™¨ï¼Œæ£€æµ‹ config map çš„å˜åŒ–ï¼Œé‡æ–°å¯åŠ¨ Pod å’Œåº”ç”¨ç¨‹åº&amp;ndash;ä»Žè€ŒèŽ·å–é…ç½®æ›´æ”¹ã€‚&lt;/p>
&lt;p>äº‹å®žè¯æ˜Žï¼Œå³ä½¿ Kubernetes æ‹¥æœ‰ä¸°å¯Œçš„èµ„æºé›†åˆï¼Œä½†å®ƒä»¬å¹¶ä¸èƒ½æ»¡è¶³ä½ çš„æ‰€æœ‰ä¸åŒéœ€æ±‚ã€‚Kubernetes å¼•å…¥äº†è‡ªå®šä¹‰èµ„æºå®šä¹‰çš„æ¦‚å¿µã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å¯¹éœ€æ±‚è¿›è¡Œå»ºæ¨¡å¹¶å®šä¹‰é€‚ç”¨äºŽ Kubernetes çš„ APIã€‚å®ƒä¸Žå…¶ä»– Kubernetes åŽŸç”Ÿèµ„æºå…±å­˜ã€‚ä½ å¯ä»¥ç”¨èƒ½ç†è§£æ¨¡åž‹çš„ä»»ä½•è¯­è¨€ç¼–å†™è‡ªå·±çš„æŽ§åˆ¶å™¨ã€‚ä½ å¯ä»¥è®¾è®¡ä¸€ä¸ªç”¨ Java å®žçŽ°çš„ ConfigWatcherï¼Œæè¿°æˆ‘ä»¬å‰é¢æ‰€è§£é‡Šçš„å†…å®¹ã€‚è¿™å°±æ˜¯ operator æ¨¡å¼ï¼Œå³ä¸Žè‡ªå®šä¹‰èµ„æºå®šä¹‰ä¸€èµ·ä½¿ç”¨çš„æŽ§åˆ¶å™¨ã€‚å¦‚ä»Šï¼Œæˆ‘ä»¬çœ‹åˆ°å¾ˆå¤š operator å‡å¦‚ï¼Œè¿™å°±æ˜¯ç¬¬äºŒç§æ‰©å±• Kubernetes é™„åŠ åŠŸèƒ½çš„æ–¹å¼ã€‚&lt;/p>
&lt;p>æŽ¥ä¸‹æ¥ï¼Œæˆ‘æƒ³ç®€å•ä»‹ç»ä¸€ä¸‹åŸºäºŽ Kubernetes æž„å»ºçš„ä¸€äº›å¹³å°ï¼Œè¿™äº›å¹³å°å¤§é‡ä½¿ç”¨ sidecar å’Œ operator æ¥ç»™å¼€å‘è€…æä¾›é¢å¤–çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼">ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Ÿ&lt;/h2>
&lt;p>è®©æˆ‘ä»¬ä»ŽæœåŠ¡ç½‘æ ¼å¼€å§‹ï¼Œä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Ÿ&lt;/p>
&lt;p>æˆ‘ä»¬æœ‰ä¸¤ä¸ªæœåŠ¡ï¼ŒæœåŠ¡ A è¦è°ƒç”¨æœåŠ¡ Bï¼Œå¹¶ä¸”å¯ä»¥ç”¨ä»»ä½•è¯­è¨€ã€‚æŠŠè¿™ä¸ªå½“åšæ˜¯æˆ‘ä»¬çš„åº”ç”¨å·¥ä½œè´Ÿè½½ã€‚æœåŠ¡ç½‘æ ¼ä½¿ç”¨ sidecar æŽ§åˆ¶å™¨ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„æœåŠ¡æ—è¾¹æ³¨å…¥ä¸€ä¸ªä»£ç†ã€‚ä½ æœ€ç»ˆä¼šåœ¨ Pod ä¸­å¾—åˆ°ä¸¤ä¸ªå®¹å™¨ã€‚ä»£ç†æ˜¯ä¸€ä¸ªé€æ˜Žçš„ä»£ç†ï¼Œä½ çš„åº”ç”¨å¯¹è¿™ä¸ªä»£ç†å®Œå…¨æ— æ„ŸçŸ¥&amp;ndash;å®ƒæ‹¦æˆªæ‰€æœ‰ä¼ å…¥å’Œä¼ å‡ºçš„æµé‡ã€‚æ­¤å¤–ï¼Œä»£ç†è¿˜å……å½“æ•°æ®é˜²ç«å¢™ã€‚&lt;/p>
&lt;p>è¿™äº›æœåŠ¡ä»£ç†çš„é›†åˆä»£è¡¨äº†ä½ çš„æ•°æ®å¹³é¢ï¼Œå¹¶ä¸”å¾ˆå°ä¸”æ— çŠ¶æ€ã€‚ä¸ºäº†èŽ·å¾—æ‰€æœ‰çŠ¶æ€å’Œé…ç½®ï¼Œå®ƒä»¬ä¾èµ–äºŽæŽ§åˆ¶å¹³é¢ã€‚æŽ§åˆ¶å¹³é¢æ˜¯ä¿æŒæ‰€æœ‰é…ç½®ï¼Œæ”¶é›†æŒ‡æ ‡ï¼Œåšå‡ºå†³å®šå¹¶ä¸Žæ•°æ®å¹³é¢è¿›è¡Œäº¤äº’çš„æœ‰çŠ¶æ€éƒ¨åˆ†ã€‚æ­¤å¤–ï¼Œå®ƒä»¬æ˜¯ä¸åŒæŽ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢çš„æ­£ç¡®é€‰æ‹©ã€‚äº‹å®žè¯æ˜Žï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç»„ä»¶-ä¸€ä¸ª API ç½‘å…³ï¼Œä»¥å°†æ•°æ®èŽ·å–åˆ°æˆ‘ä»¬çš„é›†ç¾¤ä¸­ã€‚ä¸€äº›æœåŠ¡ç½‘æ ¼å…·æœ‰è‡ªå·±çš„ API ç½‘å…³ï¼Œè€ŒæŸäº›ä½¿ç”¨ç¬¬ä¸‰æ–¹ã€‚å¦‚æžœä½ ç ”ç©¶ä¸‹æ‰€æœ‰è¿™äº›ç»„ä»¶ï¼Œå®ƒä»¬å°†æä¾›æˆ‘ä»¬æ‰€éœ€çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>API ç½‘å…³ä¸»è¦ä¸“æ³¨äºŽæŠ½è±¡æˆ‘ä»¬æœåŠ¡çš„å®žçŽ°ã€‚å®ƒéšè—ç»†èŠ‚å¹¶æä¾›è¾¹ç•ŒåŠŸèƒ½ã€‚æœåŠ¡ç½‘æ ¼åˆ™ç›¸åã€‚åœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œå®ƒå¢žå¼ºäº†æœåŠ¡å†…çš„å¯è§æ€§å’Œå¯é æ€§ã€‚å¯ä»¥è¯´ï¼ŒAPI ç½‘å…³å’ŒæœåŠ¡ç½‘æ ¼å…±åŒæä¾›äº†æ‰€æœ‰ç½‘ç»œéœ€æ±‚ã€‚è¦åœ¨ Kubernetes ä¸ŠèŽ·å¾—ç½‘ç»œåŠŸèƒ½ï¼Œä»…ä½¿ç”¨æœåŠ¡æ˜¯ä¸å¤Ÿçš„ï¼šâ€œä½ éœ€è¦ä¸€äº›æœåŠ¡ç½‘æ ¼ã€‚â€&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/19image0111616431696146.jpg" alt="">&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯-knative">ä»€ä¹ˆæ˜¯ Knativeï¼Ÿ&lt;/h2>
&lt;p>æˆ‘è¦è®¨è®ºçš„ä¸‹ä¸€ä¸ªä¸»é¢˜æ˜¯ Knativeï¼Œè¿™æ˜¯ Google å‡ å¹´å‰å¯åŠ¨çš„ä¸€ä¸ªé¡¹ç›®ã€‚å®ƒæ˜¯ Kubernetes ä¹‹ä¸Šçš„ä¸€å±‚ï¼Œå¯ä¸ºæ‚¨æä¾›æ— æœåŠ¡å™¨åŠŸèƒ½ï¼Œå¹¶å…·æœ‰ä¸¤ä¸ªä¸»è¦æ¨¡å—ï¼š&lt;/p>
&lt;ul>
&lt;li>Knative æœåŠ¡ - å›´ç»•ç€è¯·æ±‚-åº”ç­”äº¤äº’ï¼Œä»¥åŠ&lt;/li>
&lt;li>Knative Eventing - æ›´å¤šçš„æ˜¯ç”¨äºŽäº‹ä»¶é©±åŠ¨çš„äº¤äº’ã€‚&lt;/li>
&lt;/ul>
&lt;p>åªæ˜¯è®©ä½ æ„Ÿå—ä¸€ä¸‹ï¼ŒKnative Serving æ˜¯ä»€ä¹ˆï¼Ÿé€šè¿‡ Knative Servingï¼Œä½ å¯ä»¥å®šä¹‰æœåŠ¡ï¼Œä½†è¿™ä¸åŒäºŽ Kubernetes æœåŠ¡ã€‚è¿™æ˜¯ Knative æœåŠ¡ã€‚ä½¿ç”¨ Knative æœåŠ¡å®šä¹‰å·¥ä½œè´Ÿè½½åŽï¼Œä½ å°±ä¼šå¾—åˆ°å…·æœ‰æ— æœåŠ¡å™¨çš„ç‰¹å¾çš„éƒ¨ç½²ã€‚ä½ ä¸éœ€è¦æœ‰å¯åŠ¨å¹¶è¿è¡Œå®žä¾‹ã€‚å®ƒå¯ä»¥åœ¨è¯·æ±‚åˆ°è¾¾æ—¶ä»Žé›¶å¼€å§‹ã€‚ä½ å¾—åˆ°çš„æ˜¯æ— æœåŠ¡å™¨çš„èƒ½åŠ›ï¼›å®ƒå¯ä»¥è¿…é€Ÿæ‰©å®¹ï¼Œä¹Ÿå¯ä»¥ç¼©å®¹åˆ°é›¶ã€‚&lt;/p>
&lt;p>Knative Eventing ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå®Œå…¨å£°æ˜Žå¼çš„äº‹ä»¶ç®¡ç†ç³»ç»Ÿã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€äº›è¦ä¸Žä¹‹é›†æˆçš„å¤–éƒ¨ç³»ç»Ÿï¼Œä»¥åŠä¸€äº›å¤–éƒ¨çš„äº‹ä»¶ç”Ÿäº§è€…ã€‚åœ¨åº•éƒ¨ï¼Œæˆ‘ä»¬å°†åº”ç”¨ç¨‹åºæ”¾åœ¨å…·æœ‰ HTTP ç«¯ç‚¹çš„å®¹å™¨ä¸­ã€‚å€ŸåŠ© Knative Eventingï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ä»£ç†ï¼Œè¯¥ä»£ç†å¯ä»¥è§¦å‘ Kafka æ˜ å°„çš„ä»£ç†ï¼Œä¹Ÿå¯ä»¥åœ¨å†…å­˜æˆ–è€…æŸäº›äº‘æœåŠ¡ä¸­ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨è¿žæŽ¥åˆ°å¤–éƒ¨ç³»ç»Ÿçš„å¯¼å…¥å™¨ï¼Œå¹¶å°†äº‹ä»¶å¯¼å…¥åˆ°æˆ‘ä»¬çš„ä»£ç†ä¸­ã€‚è¿™äº›å¯¼å…¥å™¨å¯ä»¥åŸºäºŽï¼Œä¾‹å¦‚ï¼Œå…·æœ‰æ•°ç™¾ä¸ªè¿žæŽ¥å™¨çš„ Apache Camelã€‚&lt;/p>
&lt;p>ä¸€æ—¦æˆ‘ä»¬å°†äº‹ä»¶å‘é€ç»™ä»£ç†ï¼Œç„¶åŽç”¨ YAML æ–‡ä»¶å£°æ˜Žï¼Œæˆ‘ä»¬å¯ä»¥è®©å®¹å™¨è®¢é˜…è¿™äº›äº‹ä»¶ã€‚åœ¨æˆ‘ä»¬çš„å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä»»ä½•æ¶ˆæ¯å®¢æˆ·ç«¯&amp;ndash;æ¯”å¦‚ Kafka å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬çš„å®¹å™¨å°†ä½¿ç”¨äº‘äº‹ä»¶é€šè¿‡ HTTP POST èŽ·å–äº‹ä»¶ã€‚è¿™æ˜¯ä¸€ä¸ªå®Œå…¨å¹³å°ç®¡ç†çš„æ¶ˆæ¯ä¼ é€’åŸºç¡€è®¾æ–½ã€‚ä½œä¸ºå¼€å‘äººå‘˜ï¼Œä½ å¿…é¡»åœ¨å®¹å™¨ä¸­ç¼–å†™ä¸šåŠ¡ä»£ç ï¼Œå¹¶ä¸”ä¸å¤„ç†ä»»ä½•æ¶ˆæ¯ä¼ é€’é€»è¾‘ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/8image0121616431698919.jpg" alt="">&lt;/p>
&lt;p>ä»Žæˆ‘ä»¬çš„éœ€æ±‚çš„è§’åº¦æ¥çœ‹ï¼ŒKnative å¯ä»¥æ»¡è¶³å…¶ä¸­çš„ä¸€äº›è¦æ±‚ã€‚ä»Žç”Ÿå‘½å‘¨æœŸçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒä¸ºæˆ‘ä»¬çš„å·¥ä½œè´Ÿè½½æä¾›äº†æ— æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œå› æ­¤èƒ½å¤Ÿå°†å…¶æ‰©å±•åˆ°é›¶ï¼Œå¹¶ä»Žé›¶å¼€å§‹æ¿€æ´»ã€‚ä»Žç½‘ç»œçš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æžœæœåŠ¡ç½‘æ ¼ä¹‹é—´å­˜åœ¨æŸäº›é‡å ï¼Œåˆ™ Knative ä¹Ÿå¯ä»¥è¿›è¡Œæµé‡è½¬ç§»ã€‚ä»Žç»‘å®šçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒå¯¹ä½¿ç”¨ Knative å¯¼å…¥ç¨‹åºè¿›è¡Œç»‘å®šæä¾›äº†å¾ˆå¥½çš„æ”¯æŒã€‚å®ƒå¯ä»¥ä½¿æˆ‘ä»¬è¿›è¡Œå‘å¸ƒ/è®¢é˜…ï¼Œæˆ–ç‚¹å¯¹ç‚¹äº¤äº’ï¼Œç”šè‡³å¯ä»¥è¿›è¡Œä¸€äº›æŽ’åºã€‚å®ƒå¯ä»¥æ»¡è¶³å‡ ç±»éœ€æ±‚ã€‚&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯-dapr">ä»€ä¹ˆæ˜¯ Daprï¼Ÿ&lt;/h2>
&lt;p>å¦ä¸€ä¸ªä½¿ç”¨ sidecar å’Œ operator çš„é¡¹ç›®æ˜¯ &lt;a href="https://dapr.io/">Dapr&lt;/a>ï¼Œå®ƒæ˜¯å¾®è½¯å‡ ä¸ªæœˆå‰æ‰å¼€å§‹å¹¶ä¸”æ­£åœ¨è¿…é€Ÿæµè¡Œèµ·æ¥ã€‚æ­¤å¤–ï¼Œ1.0 ç‰ˆæœ¬ &lt;a href="https://www.infoq.com/news/2021/02/dapr-production-ready/">è¢«è®¤ä¸ºæ˜¯ç”Ÿäº§å¯ç”¨çš„&lt;/a>ã€‚å®ƒæ˜¯ä¸€ä¸ªä½œä¸º sidecar çš„åˆ†å¸ƒå¼ç³»ç»Ÿå·¥å…·åŒ…&amp;ndash;Dapr ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯ä½œä¸º sidecar æä¾›çš„ï¼Œå¹¶ä¸”æœ‰ä¸€å¥—ä»–ä»¬æ‰€è°“çš„æž„ä»¶æˆ–åŠŸèƒ½é›†çš„é›†åˆã€‚&lt;/p>
&lt;p>è¿™äº›åŠŸèƒ½æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç¬¬ä¸€ç»„åŠŸèƒ½æ˜¯å›´ç»•ç½‘ç»œã€‚Dapr å¯ä»¥è¿›è¡ŒæœåŠ¡å‘çŽ°å’ŒæœåŠ¡ä¹‹é—´çš„ç‚¹å¯¹ç‚¹é›†æˆã€‚åŒæ ·ï¼Œå®ƒä¹Ÿå¯ä»¥è¿›è¡ŒæœåŠ¡ç½‘æ ¼çš„è¿½è¸ªã€å¯é é€šä¿¡ã€é‡è¯•å’Œæ¢å¤ã€‚ç¬¬äºŒå¥—åŠŸèƒ½æ˜¯å›´ç»•èµ„æºç»‘å®šï¼š&lt;/p>
&lt;ul>
&lt;li>å®ƒæœ‰å¾ˆå¤šäº‘ APIã€ä¸åŒç³»ç»Ÿçš„è¿žæŽ¥å™¨ï¼Œä»¥åŠ&lt;/li>
&lt;li>ä¹Ÿå¯ä»¥åšæ¶ˆæ¯å‘å¸ƒ/è®¢é˜…å’Œå…¶ä»–é€»è¾‘ã€‚&lt;/li>
&lt;/ul>
&lt;p>æœ‰è¶£çš„æ˜¯ï¼ŒDapr è¿˜å¼•å…¥äº†çŠ¶æ€ç®¡ç†çš„æ¦‚å¿µã€‚é™¤äº† Knative å’ŒæœåŠ¡ç½‘æ ¼æä¾›çš„åŠŸèƒ½å¤–ï¼ŒDapr åœ¨çŠ¶æ€å­˜å‚¨ä¹‹ä¸Šè¿›è¡Œäº†æŠ½è±¡ã€‚æ­¤å¤–ï¼Œä½ é€šè¿‡å­˜å‚¨æœºåˆ¶æ”¯æŒä¸Ž Dapr è¿›è¡ŒåŸºäºŽé”®å€¼çš„äº¤äº’ã€‚&lt;/p>
&lt;p>åœ¨è¾ƒé«˜çš„å±‚æ¬¡ä¸Šï¼Œæž¶æž„æ˜¯ä½ çš„åº”ç”¨ç¨‹åºä½äºŽé¡¶éƒ¨ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•è¯­è¨€ã€‚ä½ å¯ä»¥ä½¿ç”¨ Dapr æä¾›çš„å®¢æˆ·ç«¯åº“ï¼Œä½†ä½ ä¸å¿…è¿™æ ·åšã€‚ä½ å¯ä»¥ä½¿ç”¨è¯­è¨€åŠŸèƒ½æ¥æ‰§è¡Œç§°ä¸º sidecar çš„ HTTP å’Œ gRPCã€‚ä¸Ž æœåŠ¡ç½‘æ ¼çš„åŒºåˆ«åœ¨äºŽï¼Œè¿™é‡Œçš„ Dapr sidecar ä¸æ˜¯ä¸€ä¸ªé€æ˜Žçš„ä»£ç†ã€‚å®ƒæ˜¯ä¸€ä¸ªæ˜¾å¼ä»£ç†ï¼Œä½ å¿…é¡»ä»Žä½ çš„åº”ç”¨ä¸­è°ƒç”¨å®ƒï¼Œå¹¶é€šè¿‡ HTTP æˆ– gRPC ä¸Žä¹‹äº¤äº’ã€‚æ ¹æ®ä½ éœ€è¦çš„åŠŸèƒ½ï¼ŒDapr å¯ä»¥ä¸Žå…¶ä»–å¦‚äº‘æœåŠ¡çš„ç³»ç»Ÿå¯¹è¯ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/18image0131616431699532.jpg" alt="">&lt;/p>
&lt;p>åœ¨ Kubernetes ä¸Šï¼ŒDapr æ˜¯ä½œä¸º sidecar éƒ¨ç½²çš„ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ Kubernetes ä¹‹å¤–å·¥ä½œï¼ˆä¸ä»…ä»…æ˜¯ Kubernetesï¼‰ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª operator &amp;ndash; è€Œ sidecar å’Œ Operator æ˜¯ä¸»è¦çš„æ‰©å±•æœºåˆ¶ã€‚å…¶ä»–ä¸€äº›ç»„ä»¶ç®¡ç†è¯ä¹¦ã€å¤„ç†åŸºäºŽ actor çš„å»ºæ¨¡å¹¶æ³¨å…¥ sidecarã€‚ä½ çš„å·¥ä½œè´Ÿè½½ä¸Ž sidecar äº¤äº’ï¼Œå¹¶å°½å…¶æ‰€èƒ½ä¸Žå…¶ä»–æœåŠ¡å¯¹è¯ï¼Œè®©ä½ ä¸Žä¸åŒçš„äº‘æä¾›å•†è¿›è¡Œäº’æ“ä½œã€‚å®ƒè¿˜ä¸ºä½ æä¾›äº†é¢å¤–çš„åˆ†å¸ƒå¼ç³»ç»ŸåŠŸèƒ½ã€‚&lt;/p>
&lt;p>ç»¼ä¸Šæ‰€è¿°ï¼Œè¿™äº›é¡¹ç›®æ‰€æä¾›çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥è¯´ ESB æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—©æœŸåŒ–èº«ï¼Œå…¶ä¸­æˆ‘ä»¬æœ‰é›†ä¸­å¼çš„æŽ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢&amp;ndash;ä½†æ˜¯æ‰©å±•æ€§ä¸å¥½ã€‚åœ¨äº‘åŽŸç”Ÿä¸­ï¼Œé›†ä¸­å¼æŽ§åˆ¶å¹³é¢ä»ç„¶å­˜åœ¨ï¼Œä½†æ˜¯æ•°æ®å¹³é¢æ˜¯åˆ†æ•£çš„&amp;ndash;å¹¶ä¸”å…·æœ‰éš”éŸ³åŠŸèƒ½å’Œé«˜åº¦çš„å¯æ‰©å±•æ€§ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å§‹ç»ˆéœ€è¦ Kubernetes æ¥åšè‰¯å¥½çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä½ å¯èƒ½è¿˜éœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ªé™„åŠ ç»„ä»¶ã€‚ä½ å¯èƒ½éœ€è¦ Istio æ¥è¿›è¡Œé«˜çº§è”ç½‘ã€‚ä½ å¯èƒ½ä¼šä½¿ç”¨ Knative æ¥è¿›è¡Œæ— æœåŠ¡å™¨å·¥ä½œè´Ÿè½½ï¼Œæˆ–è€…ä½¿ç”¨ Dapr æ¥åšé›†æˆã€‚è¿™äº›æ¡†æž¶å¯ä¸Ž Istio å’Œ Envoy å¾ˆå¥½çš„é…åˆä½¿ç”¨ã€‚ä»Ž Dapr å’Œ Knative çš„è§’åº¦æ¥çœ‹ï¼Œä½ å¯èƒ½å¿…é¡»é€‰æ‹©ä¸€ä¸ªã€‚å®ƒä»¬å…±åŒä»¥äº‘åŽŸç”Ÿçš„æ–¹å¼æä¾›äº†æˆ‘ä»¬è¿‡åŽ»åœ¨ ESB ä¸Šæ‹¥æœ‰çš„ä¸œè¥¿ã€‚&lt;/p>
&lt;h2 id="æœªæ¥äº‘åŽŸç”Ÿè¶‹åŠ¿--ç”Ÿå‘½å‘¨æœŸè¶‹åŠ¿">æœªæ¥äº‘åŽŸç”Ÿè¶‹åŠ¿&amp;ndash;ç”Ÿå‘½å‘¨æœŸè¶‹åŠ¿&lt;/h2>
&lt;p>åœ¨æŽ¥ä¸‹æ¥çš„éƒ¨åˆ†ï¼Œæˆ‘åˆ—å‡ºäº†ä¸€äº›æˆ‘è®¤ä¸ºåœ¨è¿™äº›é¢†åŸŸæ­£åœ¨å‘ç”Ÿä»¤äººæŒ¯å¥‹çš„å‘å±•çš„é¡¹ç›®ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/8image0141616431695762.jpg" alt="">&lt;/p>
&lt;p>æˆ‘æƒ³ä»Žç”Ÿå‘½å‘¨æœŸå¼€å§‹ã€‚é€šè¿‡ Kubernetesï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºåº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ªæœ‰ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™å¯èƒ½ä¸è¶³ä»¥è¿›è¡Œæ›´å¤æ‚çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚æ¯”å¦‚ï¼Œå¦‚æžœä½ æœ‰ä¸€ä¸ªæ›´å¤æ‚çš„æœ‰çŠ¶æ€åº”ç”¨ï¼Œåˆ™å¯èƒ½ä¼šæœ‰è¿™æ ·çš„åœºæ™¯ï¼Œå…¶ä¸­ Kubernetes ä¸­çš„éƒ¨ç½²åŽŸè¯­ä¸è¶³ä»¥ä¸ºåº”ç”¨æä¾›æ”¯æŒã€‚&lt;/p>
&lt;p>åœ¨è¿™äº›åœºæ™¯ä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ operator æ¨¡å¼ã€‚ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ª operator æ¥è¿›è¡Œéƒ¨ç½²å’Œå‡çº§ï¼Œè¿˜å¯ä»¥å°† S3 ä½œä¸ºæœåŠ¡å¤‡ä»½çš„å­˜å‚¨ä»‹è´¨ã€‚æ­¤å¤–ï¼Œä½ å¯èƒ½è¿˜ä¼šå‘çŽ° Kubernetes çš„å®žé™…å¥åº·æ£€æŸ¥æœºåˆ¶ä¸å¤Ÿå¥½ã€‚å‡è®¾å­˜æ´»æ£€æŸ¥å’Œå°±ç»ªæ£€æŸ¥ä¸å¤Ÿå¥½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ operator å¯¹ä½ çš„åº”ç”¨è¿›è¡Œæ›´æ™ºèƒ½çš„å­˜æ´»å’Œå°±ç»ªæ£€æŸ¥ï¼Œç„¶åŽåœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ¢å¤ã€‚&lt;/p>
&lt;p>ç¬¬ä¸‰ä¸ªé¢†åŸŸå°±æ˜¯è‡ªåŠ¨ä¼¸ç¼©å’Œè°ƒæ•´ã€‚ä½ å¯ä»¥è®© operator æ›´å¥½çš„äº†è§£ä½ çš„åº”ç”¨ï¼Œå¹¶åœ¨å¹³å°ä¸Šè¿›è¡Œè‡ªåŠ¨è°ƒæ•´ã€‚ç›®å‰ï¼Œç¼–å†™ operator çš„æ¡†æž¶ä¸»è¦æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ Kubernetes ç‰¹åˆ«å…´è¶£å°ç»„çš„ Kubebuilderï¼Œå¦ä¸€ä¸ªæ˜¯çº¢å¸½åˆ›å»ºçš„ operator æ¡†æž¶çš„ä¸€éƒ¨åˆ†&amp;ndash;operator SDKã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„å†…å®¹ï¼š&lt;/p>
&lt;p>Operator SDK è®©ä½ å¯ä»¥ç¼–å†™ operator &amp;ndash; operator ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨æ¥ç®¡ç† operator çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠå¯ä»¥å‘å¸ƒä½ çš„ operator åˆ° OperatorHubã€‚å¦‚ä»Šåœ¨ OperatorHubï¼Œä½ ä¼šçœ‹åˆ° 100 å¤šä¸ª operator ç”¨äºŽç®¡ç†æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—å’Œç›‘æŽ§å·¥å…·ã€‚ä»Žç”Ÿå‘½å‘¨æœŸç©ºé—´æ¥çœ‹ï¼Œoperator å¯èƒ½æ˜¯ Kubernetes ç”Ÿæ€ç³»ç»Ÿä¸­å‘å±•æœ€æ´»è·ƒçš„é¢†åŸŸã€‚&lt;/p>
&lt;h2 id="ç½‘ç»œè¶‹åŠ¿---envoy">ç½‘ç»œè¶‹åŠ¿ - Envoy&lt;/h2>
&lt;p>æˆ‘é€‰çš„å¦ä¸€ä¸ªé¡¹ç›®æ˜¯ &lt;a href="https://www.envoyproxy.io/">Envoy&lt;/a>ã€‚æœåŠ¡ç½‘æ ¼æŽ¥å£è§„èŒƒçš„å¼•å…¥å°†ä½¿ä½ æ›´è½»æ¾åœ°åˆ‡æ¢ä¸åŒçš„æœåŠ¡ç½‘æ ¼å®žçŽ°ã€‚åœ¨éƒ¨ç½²ä¸Š Istio å¯¹æž¶æž„è¿›è¡Œäº†ä¸€äº›æ•´åˆã€‚ä½ ä¸å†éœ€è¦ä¸ºæŽ§åˆ¶å¹³é¢éƒ¨ç½² 7 ä¸ª Podï¼›çŽ°åœ¨ï¼Œä½ åªéœ€è¦éƒ¨ç½²ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚æ›´æœ‰è¶£çš„æ˜¯åœ¨ Envoy é¡¹ç›®çš„æ•°æ®å¹³é¢ä¸Šæ‰€æ­£åœ¨å‘ç”Ÿçš„ï¼šè¶Šæ¥è¶Šå¤šçš„ç¬¬ 7 å±‚åè®®è¢«æ·»åŠ åˆ° Envoy ä¸­ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/11image0151616431697613.jpg" alt="">&lt;/p>
&lt;p>æœåŠ¡ç½‘æ ¼å¢žåŠ äº†å¯¹æ›´å¤šåè®®çš„æ”¯æŒï¼Œæ¯”å¦‚ MongoDBã€ZooKeeperã€MySQLã€Redisï¼Œè€Œæœ€æ–°çš„åè®®æ˜¯ Kafkaã€‚æˆ‘çœ‹åˆ° Kafka ç¤¾åŒºçŽ°åœ¨æ­£åœ¨è¿›ä¸€æ­¥æ”¹è¿›ä»–ä»¬çš„åè®®ï¼Œä½¿å…¶å¯¹æœåŠ¡ç½‘æ ¼æ›´åŠ å‹å¥½ã€‚æˆ‘ä»¬å¯ä»¥é¢„æ–™å°†ä¼šæœ‰æ›´ç´§å¯†çš„é›†æˆã€æ›´å¤šçš„åŠŸèƒ½ã€‚æœ€æœ‰å¯èƒ½çš„æ˜¯ï¼Œä¼šæœ‰ä¸€äº›æ¡¥æŽ¥çš„èƒ½åŠ›ã€‚ä½ å¯ä»¥ä»ŽæœåŠ¡ä¸­åœ¨ä½ çš„åº”ç”¨æœ¬åœ°åšä¸€ä¸ª HTTP è°ƒç”¨ï¼Œè€Œä»£ç†å°†åœ¨åŽå°ä½¿ç”¨ Kafkaã€‚ä½ å¯ä»¥åœ¨åº”ç”¨å¤–éƒ¨ï¼Œåœ¨ sidecar ä¸­é’ˆå¯¹ Kafka åè®®è¿›è¡Œè½¬æ¢å’ŒåŠ å¯†ã€‚&lt;/p>
&lt;p>å¦ä¸€ä¸ªä»¤äººå…´å¥‹çš„å‘å±•æ˜¯å¼•å…¥äº† HTTP ç¼“å­˜ã€‚çŽ°åœ¨ Envoy å¯ä»¥è¿›è¡Œ HTTP ç¼“å­˜ã€‚ä½ ä¸å¿…åœ¨ä½ çš„åº”ç”¨ä¸­ä½¿ç”¨ç¼“å­˜å®¢æˆ·ç«¯ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯åœ¨ sidecar ä¸­é€æ˜Žåœ°å®Œæˆçš„ã€‚æœ‰äº† tap è¿‡æ»¤å™¨ï¼Œä½ å¯ä»¥ tap æµé‡å¹¶èŽ·å¾—æµé‡çš„å‰¯æœ¬ã€‚æœ€è¿‘ï¼ŒWebAssembly çš„å¼•å…¥ï¼Œæ„å‘³ç€å¦‚æžœä½ è¦ä¸º Envoy ç¼–å†™ä¸€äº›è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ï¼Œä½ ä¸å¿…ç”¨ C++ ç¼–å†™ï¼Œä¹Ÿä¸å¿…ç¼–è¯‘æ•´ä¸ª Envoy è¿è¡Œæ—¶ã€‚ä½ å¯ä»¥ç”¨ WebAssembly å†™ä½ çš„è¿‡æ»¤å™¨ï¼Œç„¶åŽåœ¨è¿è¡Œæ—¶è¿›è¡Œéƒ¨ç½²ã€‚è¿™äº›å¤§å¤šæ•°è¿˜åœ¨è¿›è¡Œä¸­ã€‚å®ƒä»¬ä¸å­˜åœ¨ï¼Œè¯´æ˜Žæ•°æ®å¹³é¢å’ŒæœåŠ¡ç½‘æ ¼æ— æ„åœæ­¢ï¼Œä»…æ”¯æŒ HTTP å’Œ gRPCã€‚ä»–ä»¬æœ‰å…´è¶£æ”¯æŒæ›´å¤šçš„åº”ç”¨å±‚åè®®ï¼Œä¸ºä½ æä¾›æ›´å¤šçš„åŠŸèƒ½ï¼Œä»¥å®žçŽ°æ›´å¤šçš„ç”¨ä¾‹ã€‚æœ€ä¸»è¦çš„æ˜¯ï¼Œéšç€ WebAssembly çš„å¼•å…¥ï¼Œä½ çŽ°åœ¨å¯ä»¥åœ¨ sidecar ä¸­ç¼–å†™è‡ªå®šä¹‰é€»è¾‘ã€‚åªè¦ä½ æ²¡æœ‰åœ¨å…¶ä¸­æ·»åŠ ä¸€äº›ä¸šåŠ¡é€»è¾‘å°±å¯ä»¥äº†ã€‚&lt;/p>
&lt;h2 id="ç»‘å®šè¶‹åŠ¿---apache-camel">ç»‘å®šè¶‹åŠ¿ - Apache Camel&lt;/h2>
&lt;p>&lt;a href="https://camel.apache.org/">Apache Camel&lt;/a> æ˜¯ä¸€ä¸ªç”¨äºŽé›†æˆçš„é¡¹ç›®ï¼Œå®ƒå…·æœ‰å¾ˆå¤šä½¿ç”¨ä¼ä¸šé›†æˆæ¨¡å¼è¿žæŽ¥åˆ°ä¸åŒç³»ç»Ÿçš„è¿žæŽ¥å™¨ã€‚Â æ¯”å¦‚ &lt;a href="https://camel.apache.org/releases/release-3.0.0/">Camel version 3&lt;/a> å°±æ·±åº¦é›†æˆåˆ°äº† Kubernetes ä¸­ï¼Œå¹¶ä¸”ä½¿ç”¨äº†æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢æ‰€è®²çš„é‚£äº›åŽŸè¯­ï¼Œæ¯”å¦‚ operatorã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/7image0161616431694981.jpg" alt="">&lt;/p>
&lt;p>ä½ å¯ä»¥åœ¨ Camel ä¸­ç”¨ Javaã€JavaScript æˆ– YAML ç­‰è¯­è¨€ç¼–å†™ä½ çš„é›†æˆé€»è¾‘ã€‚æœ€æ–°çš„ç‰ˆæœ¬å¼•å…¥äº†ä¸€ä¸ª Camel operatorï¼Œå®ƒåœ¨ Kubernetes ä¸­è¿è¡Œå¹¶ç†è§£ä½ çš„é›†æˆã€‚å½“ä½ å†™å¥½ Camel åº”ç”¨ï¼Œå°†å…¶éƒ¨ç½²åˆ°è‡ªå®šä¹‰èµ„æºä¸­ï¼Œoperator å°±çŸ¥é“å¦‚ä½•æž„å»ºå®¹å™¨æˆ–æŸ¥æ‰¾ä¾èµ–é¡¹ã€‚æ ¹æ®å¹³å°çš„èƒ½åŠ›ï¼Œä¸ç®¡æ˜¯åªç”¨ Kubernetesï¼Œè¿˜æ˜¯å¸¦æœ‰ Knative çš„ Kubernetesï¼Œå®ƒéƒ½å¯ä»¥å†³å®šè¦ä½¿ç”¨çš„æœåŠ¡ä»¥åŠå¦‚ä½•å®žçŽ°é›†æˆã€‚åœ¨è¿è¡Œæ—¶ä¹‹å¤–æœ‰ç›¸å½“å¤šçš„æ™ºèƒ½ &amp;ndash; åŒ…æ‹¬ operator &amp;ndash; æ‰€æœ‰è¿™äº›éƒ½éžå¸¸å¿«åœ°å‘ç”Ÿã€‚ä¸ºä»€ä¹ˆæˆ‘ä¼šè¯´è¿™æ˜¯ä¸€ä¸ªç»‘å®šçš„è¶‹åŠ¿ï¼Ÿä¸»è¦æ˜¯å› ä¸º Apache Camel æä¾›çš„è¿žæŽ¥å™¨çš„åŠŸèƒ½ã€‚è¿™é‡Œæœ‰è¶£çš„ä¸€ç‚¹æ˜¯å®ƒå¦‚ä½•ä¸Ž Kubernetes æ·±åº¦é›†æˆã€‚&lt;/p>
&lt;h2 id="çŠ¶æ€è¶‹åŠ¿---cloudstate">çŠ¶æ€è¶‹åŠ¿ - Cloudstate&lt;/h2>
&lt;p>å¦ä¸€ä¸ªæˆ‘æƒ³è®¨è®ºçš„é¡¹ç›®æ˜¯ &lt;a href="https://cloudstate.io/">Cloudstate&lt;/a> å’Œä¸ŽçŠ¶æ€ç›¸å…³çš„è¶‹åŠ¿ã€‚Cloudstate æ˜¯ Lightbend çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä¸»è¦è‡´åŠ›äºŽæ— æœåŠ¡å™¨å’ŒåŠŸèƒ½é©±åŠ¨çš„å¼€å‘ã€‚æœ€æ–°å‘å¸ƒçš„ç‰ˆæœ¬ï¼Œæ­£åœ¨ä½¿ç”¨ sidecar å’Œ operator ä¸Ž Kubernetes è¿›è¡Œæ·±åº¦é›†æˆã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/8image0171616431996943.jpg" alt="">&lt;/p>
&lt;p>è¿™ä¸ªåˆ›æ„æ˜¯ï¼Œå½“ä½ ç¼–å†™ä½ çš„åŠŸèƒ½æ—¶ï¼Œä½ åœ¨åŠŸèƒ½ä¸­è¦åšçš„å°±æ˜¯ä½¿ç”¨ gRPC æ¥èŽ·å–çŠ¶æ€å¹¶ä¸Žä¹‹è¿›è¡Œäº¤äº’ã€‚æ•´ä¸ªçŠ¶æ€ç®¡ç†åœ¨ä¸Žå…¶ä»– sidecar ç¾¤é›†çš„ sidear ä¸­è¿›è¡Œã€‚å®ƒä½¿ä½ èƒ½å¤Ÿè¿›è¡Œäº‹ä»¶æº¯æºã€CQRSã€é”®å€¼æŸ¥è¯¢ã€æ¶ˆæ¯ä¼ é€’ã€‚&lt;/p>
&lt;p>ä»Žåº”ç”¨ç¨‹åºè§’åº¦æ¥çœ‹ï¼Œä½ å¹¶ä¸äº†è§£æ‰€æœ‰è¿™äº›å¤æ‚æ€§ã€‚ä½ æ‰€åšçš„åªæ˜¯è°ƒç”¨ä¸€ä¸ªæœ¬åœ°çš„ sidecarï¼Œè€Œ sidecar ä¼šå¤„ç†è¿™äº›å¤æ‚çš„äº‹æƒ…ã€‚å®ƒå¯ä»¥åœ¨åŽå°ä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„æ•°æ®æºã€‚è€Œä¸”å®ƒæ‹¥æœ‰å¼€å‘äººå‘˜æ‰€éœ€çš„æ‰€æœ‰æœ‰çŠ¶æ€æŠ½è±¡ã€‚&lt;/p>
&lt;p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†äº‘åŽŸç”Ÿç”Ÿæ€ç³»ç»Ÿä¸­çš„æœ€æ–°æŠ€æœ¯ä»¥åŠä¸€äº›ä»åœ¨è¿›è¡Œä¸­çš„å¼€å‘ã€‚æˆ‘ä»¬å¦‚ä½•ç†è§£è¿™ä¸€åˆ‡ï¼Ÿ&lt;/p>
&lt;h2 id="å¤šè¿è¡Œæ—¶å¾®æœåŠ¡å·²ç»åˆ°æ¥">å¤šè¿è¡Œæ—¶å¾®æœåŠ¡å·²ç»åˆ°æ¥&lt;/h2>
&lt;p>å¦‚æžœä½ çœ‹å¾®æœåŠ¡åœ¨ Kubernetes ä¸Šçš„æ ·å­ï¼Œåˆ™å°†éœ€è¦ä½¿ç”¨æŸäº›å¹³å°åŠŸèƒ½ã€‚æ­¤å¤–ï¼Œä½ å°†éœ€è¦é¦–å…ˆä½¿ç”¨ Kubernetes çš„åŠŸèƒ½è¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ç„¶åŽï¼Œå¾ˆæœ‰å¯èƒ½é€æ˜Žåœ°ï¼Œä½ çš„æœåŠ¡ä¼šä½¿ç”¨æŸäº›æœåŠ¡ç½‘æ ¼ï¼ˆä¾‹å¦‚ Envoyï¼‰æ¥èŽ·å¾—å¢žå¼ºçš„ç½‘ç»œåŠŸèƒ½ï¼Œæ— è®ºæ˜¯æµé‡è·¯ç”±ã€å¼¹æ€§ã€å¢žå¼ºçš„å®‰å…¨æ€§ï¼Œç”šè‡³å‡ºäºŽç›‘æŽ§çš„ç›®çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ ¹æ®ä½ çš„åœºæ™¯å’Œä½¿ç”¨çš„å·¥ä½œè´Ÿè½½å¯èƒ½éœ€è¦ Dapr æˆ–è€… Knativeã€‚æ‰€æœ‰è¿™äº›éƒ½ä»£è¡¨äº†è¿›ç¨‹å¤–é™„åŠ çš„åŠŸèƒ½ã€‚å‰©ä¸‹çš„å°±æ˜¯ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ˜¯æ”¾åœ¨æœ€ä¸Šé¢è€Œæ˜¯ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„è¿è¡Œæ—¶æ¥ç¼–å†™ã€‚æœªæ¥çš„å¾®æœåŠ¡å¾ˆæœ‰å¯èƒ½å°†æ˜¯ç”±å¤šä¸ªå®¹å™¨ç»„æˆçš„è¿™ç§å¤šè¿è¡Œæ—¶ã€‚æœ‰äº›æ˜¯é€æ˜Žçš„ï¼Œæœ‰äº›åˆ™æ˜¯éžå¸¸æ˜Žç¡®çš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/6image0181616431996411.jpg" alt="">&lt;/p>
&lt;h2 id="æ™ºèƒ½çš„-sidecar-å’Œæ„šè ¢çš„ç®¡é“">æ™ºèƒ½çš„ sidecar å’Œæ„šè ¢çš„ç®¡é“&lt;/h2>
&lt;p>å¦‚æžœæ›´æ·±å…¥åœ°çœ‹ï¼Œé‚£å¯èƒ½æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›é«˜çº§è¯­è¨€ç¼–å†™ä¸šåŠ¡é€»è¾‘ã€‚æ˜¯ä»€ä¹ˆå¹¶ä¸é‡è¦ï¼Œä¸å¿…ä»…æ˜¯ Javaï¼Œå› ä¸ºä½ å¯ä»¥ä½¿ç”¨ä»»ä½•å…¶ä»–è¯­è¨€å¹¶åœ¨å†…éƒ¨å¼€å‘è‡ªå®šä¹‰é€»è¾‘ã€‚&lt;/p>
&lt;p>ä½ çš„ä¸šåŠ¡é€»è¾‘ä¸Žå¤–éƒ¨ä¸–ç•Œçš„æ‰€æœ‰äº¤äº’éƒ½æ˜¯é€šè¿‡ sidecar å‘ç”Ÿçš„ï¼Œå¹¶ä¸Žå¹³å°é›†æˆè¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚å®ƒä¸ºå¤–éƒ¨ç³»ç»Ÿæ‰§è¡Œç½‘ç»œæŠ½è±¡ï¼Œä¸ºä½ æä¾›é«˜çº§çš„ç»‘å®šåŠŸèƒ½å’ŒçŠ¶æ€æŠ½è±¡ã€‚sidecar æ˜¯ä½ ä¸éœ€è¦å¼€å‘çš„ä¸œè¥¿ã€‚ä½ å¯ä»¥ä»Žè´§æž¶ä¸Šæ‹¿åˆ°å®ƒã€‚ä½ ç”¨ä¸€ç‚¹ YAML æˆ– JSON é…ç½®å®ƒï¼Œç„¶åŽå°±å¯ä»¥ä½¿ç”¨å®ƒã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥è½»æ¾åœ°æ›´æ–° sidecarï¼Œå› ä¸ºå®ƒä¸å†è¢«åµŒå…¥åˆ°ä½ çš„è¿è¡Œæ—¶ã€‚è¿™ä½¿å¾—æ‰“è¡¥ä¸ã€æ›´æ–°å˜å¾—æ›´åŠ æ›´å®¹æ˜“ã€‚å®ƒä¸ºæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘å¯ç”¨äº†å¤šè¯­è¨€è¿è¡Œæ—¶ã€‚&lt;/p>
&lt;h2 id="å¾®æœåŠ¡ä¹‹åŽæ˜¯ä»€ä¹ˆ">å¾®æœåŠ¡ä¹‹åŽæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/h2>
&lt;p>è¿™è®©æˆ‘æƒ³åˆ°äº†æœ€åˆçš„é—®é¢˜ï¼Œå¾®æœåŠ¡ä¹‹åŽæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/6image0201616431995910.jpg" alt="">&lt;/p>
&lt;p>å¦‚æžœæˆ‘ä»¬çœ‹ä¸‹æž¶æž„çš„å‘å±•åŽ†ç¨‹ï¼Œåº”ç”¨æž¶æž„åœ¨å¾ˆé«˜çš„å±‚é¢ä¸Šæ˜¯ä»Žå•ä½“åº”ç”¨å¼€å§‹çš„ã€‚ç„¶è€Œå¾®æœåŠ¡ç»™æˆ‘ä»¬æä¾›äº†å¦‚ä½•æŠŠä¸€ä¸ªå•ä½“åº”ç”¨æ‹†åˆ†æˆç‹¬ç«‹çš„ä¸šåŠ¡åŸŸçš„æŒ‡å¯¼åŽŸåˆ™ã€‚ä¹‹åŽåˆå‡ºçŽ°äº†æ— æœåŠ¡å™¨å’ŒåŠŸèƒ½å³æœåŠ¡ï¼ˆFaaSï¼‰ï¼Œæˆ‘ä»¬è¯´è¿‡å¯ä»¥æŒ‰æ“ä½œå°†å…¶è¿›ä¸€æ­¥æ‹†åˆ†ï¼Œä»Žè€Œå®žçŽ°æžé«˜çš„å¯æ‰©å±•æ€§-å› ä¸ºæˆ‘ä»¬å¯ä»¥åˆ†åˆ«æ‰©å±•æ¯ä¸ªæ“ä½œã€‚&lt;/p>
&lt;p>æˆ‘æƒ³è¯´çš„æ˜¯ FaaS å¹¶ä¸æ˜¯æœ€å¥½çš„æ¨¡å¼ &amp;ndash; å› ä¸ºåŠŸèƒ½å¹¶ä¸æ˜¯å®žçŽ°åˆç†çš„å¤æ‚æœåŠ¡çš„æœ€ä½³æ¨¡å¼ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å¤šä¸ªæ“ä½œå¿…é¡»ä¸ŽåŒä¸€ä¸ªæ•°æ®é›†è¿›è¡Œäº¤äº’æ—¶ï¼Œä½ å¸Œæœ›å®ƒä»¬é©»ç•™åœ¨ä¸€èµ·ã€‚å¯èƒ½æ˜¯å¤šè¿è¡Œæ—¶ï¼ˆæˆ‘æŠŠå®ƒç§°ä¸º &lt;a href="https://www.infoq.com/articles/multi-runtime-microservice-architecture/">Mecha æž¶æž„&lt;/a>ï¼‰ï¼Œåœ¨è¯¥æž¶æž„ä¸­ä½ å°†ä¸šåŠ¡é€»è¾‘æ”¾åœ¨ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œè€Œæ‰€æœ‰ä¸ŽåŸºç¡€è®¾æ–½ç›¸å…³çš„å…³æ³¨ç‚¹ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å®¹å™¨å­˜åœ¨ã€‚å®ƒä»¬å…±åŒä»£è¡¨å¤šè¿è¡Œæ—¶å¾®æœåŠ¡ã€‚ä¹Ÿè®¸è¿™æ˜¯ä¸€ä¸ªæ›´åˆé€‚çš„æ¨¡åž‹ï¼Œå› ä¸ºå®ƒæœ‰æ›´å¥½çš„å±žæ€§ã€‚&lt;/p>
&lt;p>ä½ å¯ä»¥èŽ·å¾—å¾®æœåŠ¡çš„æ‰€æœ‰å¥½å¤„ã€‚ä»ç„¶å°†æ‰€æœ‰åŸŸå’Œæ‰€æœ‰é™ç•Œä¸Šä¸‹æ–‡æ”¾åœ¨ä¸€å¤„ã€‚ä½ å°†æ‰€æœ‰çš„åŸºç¡€è®¾æ–½å’Œåˆ†å¸ƒå¼åº”ç”¨éœ€æ±‚æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„å®¹å™¨ä¸­ï¼Œå¹¶åœ¨è¿è¡Œæ—¶å°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ã€‚å¤§æ¦‚ï¼ŒçŽ°åœ¨æœ€æŽ¥è¿‘è¿™ç§æ¨¡åž‹çš„æ˜¯ Daprã€‚ä»–ä»¬æ­£åœ¨éµå¾ªè¿™ç§æ¨¡åž‹ã€‚å¦‚æžœä½ ä»…å¯¹ç½‘ç»œæ–¹é¢æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆå¯èƒ½ä½¿ç”¨ Envoy ä¹Ÿä¼šæŽ¥è¿‘è¿™ç§æ¨¡åž‹ã€‚&lt;/p>
&lt;h2 id="å…³äºŽä½œè€…">å…³äºŽä½œè€…&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/21bilgin-ibryam15886810412341616480845087.jpeg" alt="">&lt;/p>
&lt;p>&lt;strong>Bilgin Ibryam&lt;/strong> æ˜¯çº¢å¸½å…¬å¸çš„äº§å“ç»ç†å’Œå‰æž¶æž„å¸ˆã€æäº¤äººï¼Œå¹¶ä¸”æ˜¯ Apache è½¯ä»¶åŸºé‡‘ä¼šçš„æˆå‘˜ã€‚ä»–æ˜¯å¼€æºå¸ƒé“è€…ï¼Œç»å¸¸å†™åšå®¢ã€å‘è¡¨æ¼”è®²ï¼Œæ˜¯ &lt;a href="https://k8spatterns.io/">Kubernetes Patterns&lt;/a> å’Œ Camel Design Patterns ä¹¦ç±çš„ä½œè€…ã€‚Bilgin ç›®å‰çš„å·¥ä½œä¸»è¦é›†ä¸­åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿã€äº‹ä»¶é©±åŠ¨æž¶æž„ä»¥åŠå¯é‡å¤çš„äº‘åŽŸç”Ÿåº”ç”¨å¼€å‘æ¨¡å¼å’Œå®žè·µä¸Šã€‚è¯·å…³æ³¨ä»– @bibryam äº†è§£æœªæ¥ç±»ä¼¼ä¸»é¢˜çš„æ›´æ–°ã€‚&lt;/p></description></item><item><title>Kubernetes æºç è§£æž - Informer</title><link>https://atbug.com/kubernetes-source-code-how-informer-work/</link><pubDate>Sun, 16 Aug 2020 23:32:38 +0800</pubDate><guid>https://atbug.com/kubernetes-source-code-how-informer-work/</guid><description>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/wY8ZevIHIH7CD-fWGZecPQ">ä¸Šç¯‡&lt;/a>æ‰’äº† HPA çš„æºç ï¼Œä½†æ˜¯æ²¡æ·±å…¥ç»†èŠ‚ï¼Œä»Šå¤©å¾€ç»†èŠ‚æ·±å…¥ã€‚&lt;/p>
&lt;p>å¼€å±€å…ˆç¥­å‡ºä¸€å¼ å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/08/16/15975802542217.png" alt="">&lt;/p>
&lt;h2 id="ä¸ºä»€ä¹ˆè¦æœ‰-informer">ä¸ºä»€ä¹ˆè¦æœ‰ Informerï¼Ÿ&lt;/h2>
&lt;p>Kubernetes ä¸­çš„æŒä¹…åŒ–æ•°æ®ä¿å­˜åœ¨ etcdä¸­ï¼Œå„ä¸ªç»„ä»¶å¹¶ä¸ä¼šç›´æŽ¥è®¿é—® etcdï¼Œè€Œæ˜¯é€šè¿‡ api-serveræš´éœ²çš„ RESTful æŽ¥å£å¯¹é›†ç¾¤è¿›è¡Œè®¿é—®å’ŒæŽ§åˆ¶ã€‚&lt;/p>
&lt;p>èµ„æºçš„æŽ§åˆ¶å™¨ï¼ˆå›¾ä¸­å³ä¾§ç°è‰²çš„éƒ¨åˆ†ï¼‰è¯»å–æ•°æ®ä¹Ÿå¹¶ä¸ä¼šç›´æŽ¥ä»Ž api-server ä¸­èŽ·å–èµ„æºä¿¡æ¯ï¼ˆè¿™æ ·ä¼šå¢žåŠ  api-server çš„åŽ‹åŠ›ï¼‰ï¼Œè€Œæ˜¯ä»Žå…¶â€œæœ¬åœ°ç¼“å­˜â€ä¸­è¯»å–ã€‚è¿™ä¸ªâ€œæœ¬åœ°ç¼“å­˜â€åªæ˜¯è¡¨è±¡çš„å­˜åœ¨ï¼ŒåŠ ä¸Šç¼“å­˜çš„åŒæ­¥é€»è¾‘å°±æ˜¯ä»Šå¤©è¦æ˜¯è¯´çš„&lt;code>Informer&lt;/code>ï¼ˆç°è‰²åŒºåŸŸä¸­çš„ç¬¬ä¸€ä¸ªè“è‰²å—ï¼‰æ‰€æä¾›çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>ä»Žå›¾ä¸­å¯ä»¥çœ‹åˆ° Informer çš„å‡ ä¸ªç»„ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>Reflectorï¼šä¸Ž &lt;code>api-server&lt;/code>äº¤äº’ï¼Œç›‘å¬èµ„æºçš„å˜æ›´ã€‚&lt;/li>
&lt;li>Delta FIFO Queueï¼šå¢žé‡çš„ FIFO é˜Ÿåˆ—ï¼Œä¿å­˜ Reflector ç›‘å¬åˆ°çš„èµ„æºå˜æ›´ï¼ˆç®€å•çš„å°è£…ï¼‰ã€‚&lt;/li>
&lt;li>Indexerï¼šInformer çš„æœ¬åœ°ç¼“å­˜ï¼ŒFIFO é˜Ÿåˆ—ä¸­çš„æ•°æ®æ ¹æ®ä¸åŒçš„å˜æ›´ç±»åž‹ï¼Œåœ¨è¯¥ç¼“å­˜ä¸­è¿›è¡Œæ“ä½œã€‚
&lt;ul>
&lt;li>Local Storeï¼š&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/wY8ZevIHIH7CD-fWGZecPQ">ä¸Šç¯‡&lt;/a> æåˆ°äº†æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©çš„æŽ§åˆ¶å™¨&lt;code>HorizontalController&lt;/code>ï¼Œå…¶æž„é€ æ–¹æ³•å°±éœ€è¦æä¾› &lt;code>Informer&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//pkg/controller/podautoscaler/horizontal.go
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalController&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">scaleNamespacer&lt;/span> &lt;span class="nx">scaleclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ScalesGetter&lt;/span>
&lt;span class="nx">hpaNamespacer&lt;/span> &lt;span class="nx">autoscalingclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalersGetter&lt;/span>
&lt;span class="nx">mapper&lt;/span> &lt;span class="nx">apimeta&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RESTMapper&lt;/span>
&lt;span class="nx">replicaCalc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ReplicaCalculator&lt;/span>
&lt;span class="nx">eventRecorder&lt;/span> &lt;span class="nx">record&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventRecorder&lt;/span>
&lt;span class="nx">downscaleStabilisationWindow&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>
&lt;span class="nx">hpaLister&lt;/span> &lt;span class="nx">autoscalinglisters&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerLister&lt;/span>
&lt;span class="nx">hpaListerSynced&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InformerSynced&lt;/span>
&lt;span class="nx">podLister&lt;/span> &lt;span class="nx">corelisters&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodLister&lt;/span>
&lt;span class="nx">podListerSynced&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InformerSynced&lt;/span>
&lt;span class="nx">queue&lt;/span> &lt;span class="nx">workqueue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RateLimitingInterface&lt;/span>
&lt;span class="nx">recommendations&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">][]&lt;/span>&lt;span class="nx">timestampedRecommendation&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewHorizontalController&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">evtNamespacer&lt;/span> &lt;span class="nx">v1core&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventsGetter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">scaleNamespacer&lt;/span> &lt;span class="nx">scaleclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ScalesGetter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">hpaNamespacer&lt;/span> &lt;span class="nx">autoscalingclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalersGetter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">mapper&lt;/span> &lt;span class="nx">apimeta&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RESTMapper&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">metricsClient&lt;/span> &lt;span class="nx">metricsclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MetricsClient&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="c1">//ä»ŽHorizontalPodAutoscalerInformer èŽ·å–hpa å®žä¾‹ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">hpaInformer&lt;/span> &lt;span class="nx">autoscalinginformers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerInformer&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="c1">//ä»ŽPodInformer ä¸­èŽ·å– pod ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">podInformer&lt;/span> &lt;span class="nx">coreinformers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodInformer&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">resyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">downscaleStabilisationWindow&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">tolerance&lt;/span> &lt;span class="kt">float64&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">cpuInitializationPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">delayOfInitialReadinessStatus&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">......&lt;/span>
&lt;span class="nx">hpaInformer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Informer&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">AddEventHandlerWithResyncPeriod&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="c1">//æ·»åŠ äº‹ä»¶å¤„ç†å™¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResourceEventHandlerFuncs&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">AddFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">hpaController&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">enqueueHPA&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">UpdateFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">hpaController&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">updateHPA&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">DeleteFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">hpaController&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">deleteHPA&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="o">......&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerInformer&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Informer&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SharedIndexInformer&lt;/span>
&lt;span class="nf">Lister&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerLister&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>HorizontalPodAutoscalerInformer&lt;/code>çš„å®žä¾‹åŒ–æ–¹æ³•ä¸­å°±å‡ºçŽ°äº†ä»Šå¤©çš„æ­£ä¸»&lt;code>cache.NewSharedIndexInformer()&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/informers/autoscaling/v1/horizontalpodautoscaler.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewFilteredHorizontalPodAutoscalerInformer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span> &lt;span class="nx">kubernetes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">namespace&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexers&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Indexers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tweakListOptions&lt;/span> &lt;span class="nx">internalinterfaces&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TweakListOptionsFunc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SharedIndexInformer&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewSharedIndexInformer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="c1">//ç”¨äºŽ list å’Œ watch api-server ä¸­çš„èµ„æºã€‚æ¯”å¦‚ç”¨æ¥åˆ›å»º Reflector
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListWatch&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">ListFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListOptions&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">tweakListOptions&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">tweakListOptions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ä½¿ç”¨ HPA API èŽ·å– HPAèµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AutoscalingV1&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">HorizontalPodAutoscalers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">namespace&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">List&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nx">WatchFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListOptions&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">watch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">tweakListOptions&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">tweakListOptions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ä½¿ç”¨ HPA API ç›‘æŽ§ HPAèµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AutoscalingV1&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">HorizontalPodAutoscalers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">namespace&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Watch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">autoscalingv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscaler&lt;/span>&lt;span class="p">{},&lt;/span>
&lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">indexers&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆå§‹åŒ–">åˆå§‹åŒ–&lt;/h2>
&lt;h3 id="informer">Informer&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/index.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Indexers&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">IndexFunc&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">IndexFunc&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">obj&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®žä¾‹åŒ– Indexers &lt;code>cache.Indexers{cache.NamespaceIndex: cache.MetaNamespaceIndexFunc}&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/shared_informer.go
&lt;/span>&lt;span class="c1">// ListerWatcher ç”¨äºŽ list å’Œwatch api-server ä¸Šçš„èµ„æº
&lt;/span>&lt;span class="c1">//runtime.Objectè¦ç›‘æŽ§çš„èµ„æºçš„è¿è¡Œæ—¶å¯¹è±¡
&lt;/span>&lt;span class="c1">//time.DurationåŒæ­¥çš„é—´éš”æ—¶é—´
&lt;/span>&lt;span class="c1">//Indexers æä¾›ä¸åŒèµ„æºçš„ç´¢å¼•æ•°æ®çš„ä¿¡æ¯æŸ¥è¯¢æ–¹æ³•ï¼Œå¦‚ namespace =&amp;gt; MetaNamespaceIndexFunc
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewSharedIndexInformer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lw&lt;/span> &lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">objType&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">defaultEventHandlerResyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexers&lt;/span> &lt;span class="nx">Indexers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">SharedIndexInformer&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">realClock&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RealClock&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">sharedIndexInformer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sharedIndexInformer&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">processor&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sharedProcessor&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">realClock&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="nx">indexer&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">NewIndexer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">DeletionHandlingMetaNamespaceKeyFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexers&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="c1">//åˆå§‹åŒ– Indexer
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">listerWatcher&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">lw&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">objectType&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">objType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">resyncCheckPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">defaultEventHandlerResyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">defaultEventHandlerResyncPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">defaultEventHandlerResyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">cacheMutationDetector&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">NewCacheMutationDetector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%T&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">objType&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="nx">clock&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">realClock&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">sharedIndexInformer&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="indexer">Indexer&lt;/h3>
&lt;p>&lt;code>Indexer&lt;/code>æä¾›äº†æœ¬åœ°ç¼“å­˜çš„å®žçŽ°ï¼šè®¡ç®— key å’Œå¯¹æ•°æ®è¿›è¡ŒæŽ§åˆ¶ï¼ˆé€šè¿‡è°ƒç”¨&lt;code>ThreadSafeStore&lt;/code>çš„æŽ¥å£ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Indexer&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Store&lt;/span>
&lt;span class="nf">Index&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexName&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">IndexKeys&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexedValue&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">ListIndexFuncValues&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexName&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="nf">ByIndex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexedValue&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">GetIndexers&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Indexers&lt;/span>
&lt;span class="nf">AddIndexers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newIndexers&lt;/span> &lt;span class="nx">Indexers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Indexer&lt;/code> çš„åˆ›å»º&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/store.go
&lt;/span>&lt;span class="c1">//keyFuncï¼škey çš„ç”Ÿæˆè§„åˆ™
&lt;/span>&lt;span class="c1">//indexersï¼šæä¾›äº†ç´¢å¼•èµ„æºçš„ä¸åŒä¿¡æ¯çš„è®¿é—®æ–¹æ³•ï¼Œå¦‚ç”¨äºŽæŸ¥è¯¢å‘½åç©ºé—´çš„ namespace =&amp;gt; MetaNamespaceIndexFunc
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewIndexer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">keyFunc&lt;/span> &lt;span class="nx">KeyFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexers&lt;/span> &lt;span class="nx">Indexers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Indexer&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">cacheStorage&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">NewThreadSafeStore&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Indices&lt;/span>&lt;span class="p">{}),&lt;/span>
&lt;span class="nx">keyFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">keyFunc&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="threadsafestore">&lt;code>ThreadSafeStore&lt;/code>&lt;/h4>
&lt;p>ThreadSafeStoreæä¾›äº†å¯¹å­˜å‚¨çš„å¹¶å‘è®¿é—®æŽ¥å£&lt;/p>
&lt;p>æ³¨æ„äº‹é¡¹ï¼šä¸èƒ½ä¿®æ”¹Getæˆ–Listè¿”å›žçš„ä»»ä½•å†…å®¹ï¼Œå› ä¸ºå®ƒä¸ä»…ä¼šç ´åçº¿ç¨‹å®‰å…¨ï¼Œè¿˜ä¼šç ´åç´¢å¼•åŠŸèƒ½ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/thread_safe_store.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewThreadSafeStore&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexers&lt;/span> &lt;span class="nx">Indexers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indices&lt;/span> &lt;span class="nx">Indices&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">ThreadSafeStore&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">threadSafeMap&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">items&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{},&lt;/span>
&lt;span class="nx">indexers&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">indexers&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">indices&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">indices&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">threadSafeMap&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">lock&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RWMutex&lt;/span>
&lt;span class="nx">items&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}&lt;/span> &lt;span class="c1">//key =&amp;gt; value
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">indexers&lt;/span> &lt;span class="nx">Indexers&lt;/span> &lt;span class="c1">//value çš„ä¿¡æ¯çš„è®¿é—®æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">indices&lt;/span> &lt;span class="nx">Indices&lt;/span> &lt;span class="c1">//ç´¢å¼•
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="reflector">Reflector&lt;/h3>
&lt;p>&lt;code>Reflector&lt;/code>é€šè¿‡&lt;code> ListerWatcher&lt;/code>ï¼ˆAPIï¼‰ä¸Ž&lt;code>api-server&lt;/code>äº¤äº’ï¼Œå¯¹èµ„æºè¿›è¡Œç›‘æŽ§ã€‚å°†èµ„æºå®žä¾‹çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ç­‰æ—¶é—´å°è£…åŽä¿å­˜åœ¨&lt;code>Informer&lt;/code>çš„FIFO é˜Ÿåˆ—ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/reflector.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewReflector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lw&lt;/span> &lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">expectedType&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">store&lt;/span> &lt;span class="nx">Store&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Reflector&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">NewNamedReflector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">naming&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetNameFromCallsite&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">internalPackages&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">lw&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">expectedType&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">store&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// NewNamedReflector same as NewReflector, but with a specified name for logging
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewNamedReflector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">lw&lt;/span> &lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">expectedType&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">store&lt;/span> &lt;span class="nx">Store&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Reflector&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">r&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Reflector&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">listerWatcher&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">lw&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">store&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">store&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">//FIFOé˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">period&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">clock&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RealClock&lt;/span>&lt;span class="p">{},&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">setExpectedType&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">expectedType&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">r&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ·»åŠ åŒæ­¥äº‹ä»¶ç›‘å¬å™¨">æ·»åŠ åŒæ­¥äº‹ä»¶ç›‘å¬å™¨&lt;/h3>
&lt;p>é€šè¿‡&lt;code>sharedIndexInformer#AddEventHandlerWithResyncPeriod()&lt;/code>æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ã€‚&lt;/p>
&lt;p>ä»¥å‰é¢çš„ HorizontalControllerä¸ºä¾‹ï¼Œåˆ›å»º informer çš„æ—¶å€™æ·»åŠ äº†ä¸‰ä¸ªå¤„ç†æ–¹æ³•ï¼š&lt;code>AddFunc&lt;/code>ã€&lt;code>UpdateFunc&lt;/code>ã€&lt;code>DeleteFunc&lt;/code>ã€‚è¿™ä¸‰ä¸ªæ–¹æ³•çš„å®žçŽ°æ˜¯å°†å¯¹åº”çš„å…ƒç´ çš„ keyï¼ˆå›ºå®šæ ¼å¼ &lt;code>namespace/name&lt;/code>ï¼‰ä»Ž&lt;code> workequeue&lt;/code>ä¸­è¿›è¡Œå…¥é˜Ÿã€å‡ºé˜Ÿçš„æ“ä½œã€‚ï¼ˆèµ„æºæŽ§åˆ¶å™¨ç›‘å¬äº†è¯¥ &lt;code>workqueue&lt;/code>ï¼‰&lt;/p>
&lt;h2 id="è¿è¡Œ">è¿è¡Œ&lt;/h2>
&lt;h3 id="controller-manager">&lt;code>controller-manager&lt;/code>&lt;/h3>
&lt;p>åœ¨é€šè¿‡&lt;code>InformerFactory&lt;/code>åˆ›å»º&lt;code>Informer&lt;/code>å®ŒæˆåŽï¼Œéƒ½ä¼šå°†æ–°å»ºçš„&lt;code> Informer&lt;/code>åŠ å…¥åˆ°&lt;code>InformerFactory&lt;/code>çš„ä¸€ä¸ª&lt;code>map&lt;/code>ä¸­ã€‚&lt;/p>
&lt;p>åœ¨&lt;code>controller-manager&lt;/code>åœ¨å®Œæˆæ‰€æœ‰çš„æŽ§åˆ¶å™¨ï¼ˆå„ç§&lt;code>Controller&lt;/code>ï¼ŒåŒ…æ‹¬ CRDï¼‰åŽï¼Œä¼šè°ƒç”¨&lt;code>InformerFactory#Start()&lt;/code>æ¥å¯åŠ¨&lt;code>InformerFactory&lt;/code>çš„&lt;code>map&lt;/code>ä¸­çš„æ‰€æœ‰&lt;code> Informer&lt;/code>ï¼ˆè°ƒç”¨&lt;code>Informer#Run()&lt;/code>æ–¹æ³•ï¼‰&lt;/p>
&lt;h3 id="sharedindexinformerrun">&lt;code>sharedIndexInformer#Run()&lt;/code>&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/shared_informer.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sharedIndexInformer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleCrash&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">//åˆ›å»ºä¸€ä¸ªå¢žé‡çš„ FIFOé˜Ÿåˆ—ï¼šDeltaFIFO
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">fifo&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">NewDeltaFIFO&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">MetaNamespaceKeyFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cfg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Queue&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">fifo&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">listerWatcher&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ObjectType&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">objectType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">FullResyncPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resyncCheckPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">RetryOnError&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ShouldResync&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">shouldResync&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Process&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HandleDeltas&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//å¯åŠ¨å‰çš„åˆå§‹åŒ–ï¼Œåˆ›å»º Controller
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startedLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startedLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">controller&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cfg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">controller&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">controller&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">clock&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">started&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="nx">processorStopCh&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Group&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// Wait for Processor to stop
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">defer&lt;/span> &lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">processorStopCh&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// Tell Processor to stop
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartWithChannel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">processorStopCh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheMutationDetector&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Run&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartWithChannel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">processorStopCh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">run&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//é€€å‡ºæ—¶çš„çŠ¶æ€æ¸…ç†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startedLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startedLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stopped&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span> &lt;span class="c1">// Don&amp;#39;t want any new listeners
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}()&lt;/span>
&lt;span class="c1">//å®žè¡ŒæŽ§åˆ¶é€»è¾‘
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">controller&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="controllerrun">&lt;code>controller#Run()&lt;/code>&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/controller.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">controller&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleCrash&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">stopCh&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="c1">//åˆ›å»ºä¸€ä¸ª Reflectorï¼Œç”¨äºŽä»Ž api-server list å’Œ watch èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">NewReflector&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Queue&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FullResyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ShouldResync&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ShouldResync&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span>
&lt;span class="c1">//ä¸º controller æŒ‡å®š Reflector
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">reflectorMutex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">reflector&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">r&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">reflectorMutex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Group&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">//æ‰§è¡ŒReflector#Run()ï¼šä¼šå¯åŠ¨ä¸€ä¸ªgoroutineå¼€å§‹ç›‘æŽ§èµ„æºï¼Œå°† watch åˆ°çš„æ•°æ®å†™å…¥åˆ°queueï¼ˆFIFO é˜Ÿåˆ—ï¼‰ä¸­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartWithChannel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Run&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//æŒç»­ä»Ž queueï¼ˆFIFO é˜Ÿåˆ—ï¼‰ èŽ·å–æ•°æ®å¹¶è¿›è¡Œå¤„ç†ï¼Œå¤„ç†çš„é€»è¾‘åœ¨sharedIndexInformer#HandleDeltas()
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Until&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processLoop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stopCh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="sharedindexinformerhandledeltas">&lt;code>sharedIndexInformer#HandleDeltas()&lt;/code>&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/shared_informer.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sharedIndexInformer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">HandleDeltas&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">obj&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">blockDeltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">blockDeltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// from oldest to newest
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">d&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">obj&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">Deltas&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//å¾ªçŽ¯å¤„ç† FIFO é˜Ÿåˆ—ä¸­å–å‡ºçš„èµ„æºå®žä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">switch&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Type&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">Sync&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Added&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Updated&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1">//åŒæ­¥ï¼ˆåŽé¢è¯¦ç»†è§£è¯»ï¼‰ã€æ–°å¢žã€æ›´æ–°äº‹ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">isSync&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Type&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">Sync&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheMutationDetector&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">old&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">exists&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">exists&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//å¦‚æžœ indexer ä¸­å·²ç»å­˜åœ¨ï¼Œæ›´æŽ‰ç”¨ update æ–¹æ³•è¿›è¡Œæ›´æ–°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//æ›´æ–°æˆåŠŸåŽå‘é€â€œæ›´æ–°â€é€šçŸ¥ï¼šåŒ…å«äº†æ–°ã€æ—§èµ„æºå®žä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">distribute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">updateNotification&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">oldObj&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">old&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">newObj&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="nx">isSync&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//å¦‚æžœ indexer ä¸­æ²¡æœ‰è¯¥èµ„æºå®žä¾‹ï¼Œåˆ™æ”¾å…¥ indexer ä¸­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//æ·»åŠ æˆåŠŸåŽï¼Œå‘é€â€œæ–°å¢žâ€é€šçŸ¥ï¼šåŒ…å«äº†æ–°åŠ çš„èµ„æºå®žä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">distribute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addNotification&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">newObj&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="nx">isSync&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">Deleted&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1">//åˆ é™¤äº‹ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="c1">//ä»Ž indexer ä¸­åˆ é™¤
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//åˆ é™¤æˆåŠŸåŽï¼Œå‘é€â€œåˆ é™¤é€šçŸ¥â€ï¼šåŒ…å«äº†åˆ é™¤çš„èµ„æºå®žä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">distribute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">deleteNotification&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">oldObj&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>Informer çš„å®žçŽ°ä¸ç®—å¤æ‚ï¼Œå´åœ¨ Kubernetes ä¸­å¾ˆå¸¸è§ï¼Œæ¯ç§èµ„æºçš„æŽ§åˆ¶ä¹Ÿéƒ½é€šè¿‡ Informer æ¥èŽ·å–&lt;code>api-server&lt;/code>çš„èµ„æºå®žä¾‹çš„å˜æ›´ã€‚&lt;/p></description></item><item><title>Kubernetes æºç è§£æž - HPA æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©å¦‚ä½•å·¥ä½œ</title><link>https://atbug.com/kubernetes-source-code-how-hpa-work/</link><pubDate>Sat, 15 Aug 2020 02:09:37 +0800</pubDate><guid>https://atbug.com/kubernetes-source-code-how-hpa-work/</guid><description>
&lt;p>HPA - Horizontal Pod Autoscaler çš„ç¼©å†™ï¼ŒPod æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ã€‚é€šè¿‡å¯¹ Pod è´Ÿè½½çš„ç›‘æŽ§ï¼Œæ¥è‡ªåŠ¨å¢žåŠ æˆ–è€…å‡å°‘ Pod çš„å‰¯æœ¬æ•°é‡ã€‚&lt;/p>
&lt;p>ä»Žå­—é¢æ„æ€æ¥çœ‹ï¼Œå…¶ä¸»è¦åŒ…å«äº†ä¸¤éƒ¨åˆ†ï¼š&lt;/p>
&lt;ul>
&lt;li>ç›‘æŽ§ Pod çš„è´Ÿè½½&lt;/li>
&lt;li>æŽ§åˆ¶ Pod çš„å‰¯æœ¬æ•°é‡&lt;/li>
&lt;/ul>
&lt;p>é‚£å…·ä½“æ˜¯å¦‚ä½•å®žçŽ°çš„å‘¢ï¼Ÿä»¥ä¸‹åŸºäºŽ1.17 æºç ï¼Œæ¥åˆ†æžä¸‹ HPA å¦‚ä½•å·¥ä½œã€‚&lt;/p>
&lt;p>&lt;strong>æ³¨æ„ï¼šæ–‡ç« ä¸­çš„ä»£ç åœ¨æºç çš„åŸºç¡€ä¸Šè¿›è¡Œäº†ç²¾ç®€ï¼šåˆ æŽ‰äº†æ³¨é‡Šã€åºåˆ—åŒ–ç­‰ä¿¡æ¯ï¼Œæˆ–ä¿ç•™äº†éƒ¨åˆ†æ ¸å¿ƒä»£ç ï¼ŒåŠ ä¸Šæ–°çš„æ³¨é‡Šã€‚&lt;/strong>&lt;/p>
&lt;h2 id="èµ„æº">èµ„æº&lt;/h2>
&lt;p>HPA çš„èµ„æºæ˜¯&lt;code>HorizontalPodAutoscaler&lt;/code>ï¼Œåœ¨&lt;code>v1&lt;/code>ç‰ˆæœ¬ä¸­ï¼Œåªæ”¯æŒåŸºäºŽ CPU æŒ‡æ ‡çš„è®¡ç®—ï¼›åœ¨&lt;code>v2beta2&lt;/code>ç‰ˆæœ¬ä¸­åŠ å…¥äº†åŸºäºŽå†…å­˜å’Œè‡ªå®šä¹‰æŒ‡æ ‡çš„è®¡ç®—ã€‚&lt;/p>
&lt;h3 id="v1">v1&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/api/autoscaling/v1/types.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscaler&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TypeMeta&lt;/span>
&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span>
&lt;span class="nx">Spec&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span>
&lt;span class="nx">Status&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerStatus&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ScaleTargetRef&lt;/span> &lt;span class="nx">CrossVersionObjectReference&lt;/span> &lt;span class="c1">//ç›‘æŽ§çš„ç›®æ ‡èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">MinReplicas&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span> &lt;span class="c1">//æœ€å°å‰¯æœ¬æ•°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">MaxReplicas&lt;/span> &lt;span class="kt">int32&lt;/span> &lt;span class="c1">//æœ€å¤§å‰¯æœ¬æ•°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">TargetCPUUtilizationPercentage&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span> &lt;span class="c1">//è§¦å‘è°ƒæ•´çš„CPU ä½¿ç”¨çŽ‡
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="v2">v2&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/api/autoscaling/v2beta2/types.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscaler&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TypeMeta&lt;/span>
&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span>
&lt;span class="nx">Spec&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span>
&lt;span class="nx">Status&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerStatus&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ScaleTargetRef&lt;/span> &lt;span class="nx">CrossVersionObjectReference&lt;/span> &lt;span class="c1">//ç›‘æŽ§çš„ç›®æ ‡èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">MinReplicas&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span>
&lt;span class="nx">MaxReplicas&lt;/span> &lt;span class="kt">int32&lt;/span>
&lt;span class="nx">Metrics&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">MetricSpec&lt;/span> &lt;span class="c1">//æ–°åŠ å…¥çš„è‡ªå®šä¹‰æŒ‡æ ‡
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">MetricSpec&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Type&lt;/span> &lt;span class="nx">MetricSourceType&lt;/span> &lt;span class="c1">//æŒ‡æ ‡æºçš„ç±»åž‹ï¼šObjectï¼ˆåŸºäºŽæŸä¸ªå¯¹è±¡ï¼‰ã€Podsï¼ˆåŸºäºŽpod æ•°ï¼‰ã€Resourceï¼ˆåŸºäºŽèµ„æºä½¿ç”¨è®¡ç®—ï¼Œæ¯”å¦‚v1 ç‰ˆæœ¬ä¸­cpuï¼‰ã€Externalï¼ˆåŸºäºŽå¤–éƒ¨çš„æŒ‡æ ‡ï¼‰ã€‚å¯¹åº” MetricsClient æŽ¥å£çš„å››ä¸ªæ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Object&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ObjectMetricSource&lt;/span> &lt;span class="c1">//å¯¹åº” Object ç±»åž‹çš„æŒ‡æ ‡æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Pods&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PodsMetricSource&lt;/span> &lt;span class="c1">//å¯¹åº” Pod ç±»åž‹çš„æŒ‡æ ‡æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Resource&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ResourceMetricSource&lt;/span> &lt;span class="c1">//å¯¹åº” Resource ç±»åž‹çš„æŒ‡æ ‡æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">External&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExternalMetricSource&lt;/span> &lt;span class="c1">//å¯¹åº” External ç±»åž‹çš„æŒ‡æ ‡æº
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">ObjectMetricSource&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">DescribedObject&lt;/span> &lt;span class="nx">CrossVersionObjectReference&lt;/span> &lt;span class="c1">//ç›®æ ‡å¯¹è±¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Target&lt;/span> &lt;span class="nx">MetricTarget&lt;/span> &lt;span class="c1">//æŒ‡å®šæŒ‡æ ‡çš„ç›®æ ‡å€¼ã€å¹³å‡å€¼æˆ–è€…å¹³å‡ä½¿ç”¨çŽ‡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Metric&lt;/span> &lt;span class="nx">MetricIdentifier&lt;/span> &lt;span class="c1">//æŒ‡æ ‡æ ‡è¯†ï¼šåå­—ã€labelé€‰æ‹©å™¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">PodsMetricSource&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Metric&lt;/span> &lt;span class="nx">MetricIdentifier&lt;/span>
&lt;span class="nx">Target&lt;/span> &lt;span class="nx">MetricTarget&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">ResourceMetricSource&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span> &lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResourceName&lt;/span>
&lt;span class="nx">Target&lt;/span> &lt;span class="nx">MetricTarget&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">ExternalMetricSource&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Metric&lt;/span> &lt;span class="nx">MetricIdentifier&lt;/span>
&lt;span class="nx">Target&lt;/span> &lt;span class="nx">MetricTarget&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">MetricTarget&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Type&lt;/span> &lt;span class="nx">MetricTargetType&lt;/span> &lt;span class="c1">//ç±»åž‹ï¼šUtilizationã€Valueã€AverageValue
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">resource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Quantity&lt;/span>
&lt;span class="nx">AverageValue&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">resource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Quantity&lt;/span>
&lt;span class="nx">AverageUtilization&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æŽ§åˆ¶å™¨-horizontalcontroller">æŽ§åˆ¶å™¨ &lt;code>HorizontalController&lt;/code>&lt;/h2>
&lt;p>&lt;code>HorizontalController&lt;/code>è¢«é€šè¿‡ key &lt;code>horizontalpodautoscaling&lt;/code> åŠ å…¥åˆ° controller manager ä¸­ã€‚ç”¨æ¥æŽ§åˆ¶&lt;code>HorizontalPodAutoscaler&lt;/code>å®žä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">///cmd/kube-controller-manager/app/controllermanager.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewControllerInitializers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">loopMode&lt;/span> &lt;span class="nx">ControllerLoopMode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">InitFunc&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="nx">controllers&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;horizontalpodautoscaling&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">startHPAController&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="èŽ·å–è´Ÿè½½æŒ‡æ ‡">èŽ·å–è´Ÿè½½æŒ‡æ ‡&lt;/h3>
&lt;p>æ—¢ç„¶ Pod å‰¯æœ¬æ•°é‡çš„è®¡ç®—æ˜¯åŸºäºŽ Pod çš„è´Ÿè½½æƒ…å†µï¼Œé‚£è¾¹éœ€è¦é€”å¾„èŽ·å–è´Ÿè½½æ•°æ®ï¼Œè¿™ä¸ªé€”å¾„å°±æ˜¯&lt;code>MetricsClient&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>MetricsClient&lt;/code>æœ‰ä¸¤ç§å®žçŽ°ï¼šREST æ–¹å¼å’Œä¼ ç»Ÿï¼ˆLegacyï¼‰æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯&lt;code>restMetricsClient&lt;/code>å’Œ&lt;code>HeapsterMetricsClient&lt;/code>ã€‚ä¸€ä¸ªæ˜¯REST å®žçŽ°ä»¥æ”¯æŒè‡ªå®šä¹‰çš„æŒ‡æ ‡ï¼›ä¸€ä¸ªæ˜¯ä¼ ç»Ÿçš„ Heapster æŒ‡æ ‡ï¼ˆheapster å·²ç»ä»Ž 1.13 ç‰ˆæœ¬å¼€å§‹è¢«åºŸå¼ƒäº†ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//cmd/kube-controller-manager/app/autoscaling.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">startHPAController&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">ControllerContext&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AvailableResources&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GroupVersionResource&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Group&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;autoscaling&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Version&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;v1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Resource&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;horizontalpodautoscalers&amp;#34;&lt;/span>&lt;span class="p">}]&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ComponentConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HPAController&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerUseRESTClients&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// use the new-style clients if support for custom metrics is enabled
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nf">startHPAControllerWithRESTClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">startHPAControllerWithLegacyClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æŽ§åˆ¶å™¨é€»è¾‘horizontalcontrollerrun">æŽ§åˆ¶å™¨é€»è¾‘&lt;code>HorizontalController#Run()&lt;/code>&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//pkg/controller/podautoscaler/horizontal.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleCrash&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ShutDown&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Starting HPA controller&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Shutting down HPA controller&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// ç­‰å¾… informer å®ŒæˆHorizontalPodAutoscalerç›¸å…³äº‹ä»¶çš„åŒæ­¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WaitForNamedCacheSync&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;HPA&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stopCh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">hpaListerSynced&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">podListerSynced&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// start a single worker (we may wish to start more in the future)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//æ‰§è¡Œ worker é€»è¾‘ï¼Œç›´åˆ°æ”¶åˆ°é€€å‡ºæŒ‡ä»¤
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">go&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Until&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">worker&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stopCh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">stopCh&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>worker&lt;/code>çš„æ ¸å¿ƒæ˜¯ä»Žå·¥ä½œé˜Ÿåˆ—ä¸­èŽ·å–ä¸€ä¸ª keyï¼ˆæ ¼å¼ä¸ºï¼šnamespace/nameï¼‰ï¼Œç„¶åŽå¯¹ key è¿›è¡Œ reconcileï¼ˆè¿™ä¸ªè¯æ˜¯Kubernetes çš„æ ¸å¿ƒï¼Œç¿»è¯‘ä¸ºâ€œè°ƒå’Œâ€ã€â€œå’Œè§£â€ã€‚ä¸ªäººæ›´å–œæ¬¢â€œè°ƒæ•´â€ï¼Œå³&lt;strong>å°†å®žä¾‹çš„çŠ¶æ€è°ƒæ•´ä¸ºæœŸæœ›çš„çŠ¶æ€&lt;/strong>ã€‚æ­¤å¤„ï¼Œå¯¹äºŽ hpa çš„å®žä¾‹çš„æ¯ä¸ªäº‹ä»¶ï¼Œéƒ½ä¼šæŒ‰ç…§ç‰¹å®šçš„é€»è¾‘è°ƒæ•´ç›®æ ‡å®žä¾‹çš„ Pod çš„å‰¯æœ¬æ•°é‡ã€‚ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//pkg/controller/podautoscaler/horizontal.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">worker&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">processNextWorkItem&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;horizontal pod autoscaler controller worker shutting down&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">processNextWorkItem&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">quit&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">quit&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">deleted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">reconcileKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">deleted&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddRateLimited&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹ key è¿›è¡Œ reconcile çš„è°ƒç”¨æ ˆï¼š&lt;code>HorizontalController#reconcileKey -&amp;gt; HorizontalController#reconcileAutoscaler -&amp;gt; HorizontalController#computeReplicasForMetrics -&amp;gt; ScaleInterface#Update&lt;/code>&lt;/p>
&lt;p>ç®€å•æ¥è¯´å°±æ˜¯å…ˆä»Ž&lt;code>Informer&lt;/code>ä¸­æ‹¿åˆ° key å¯¹åº”çš„&lt;code>HorizontalPodAutoscaler&lt;/code>èµ„æºå®žä¾‹ï¼›ç„¶åŽé€šè¿‡&lt;code>HorizontalPodAutoscaler&lt;/code>å®žä¾‹ä¸­çš„ä¿¡æ¯ï¼Œæ£€æŸ¥ç›®æ ‡èµ„æºçš„Pod è´Ÿè½½ä»¥åŠå½“å‰çš„å‰¯æœ¬æ•°ï¼Œå¾—åˆ°æœŸæœ›çš„ Pod å‰¯æœ¬æ•°ï¼›æœ€ç»ˆé€šè¿‡ Scale API æ¥è°ƒæ•´ Pod çš„å‰¯æœ¬æ•°ã€‚æœ€åŽä¼šå°†è°ƒæ•´çš„åŽŸå› ã€è®¡ç®—çš„ç»“æžœç­‰ä¿¡æ¯å†™å…¥&lt;code>HorizontalPodAutoscaler&lt;/code>å®žä¾‹çš„ condition ä¸­ã€‚&lt;/p>
&lt;h3 id="è®¡ç®—æœŸæœ›çš„å‰¯æœ¬æ•°">è®¡ç®—æœŸæœ›çš„å‰¯æœ¬æ•°&lt;/h3>
&lt;p>å¯¹æ¯ä¸ªæŒ‡æ ‡è¿›è¡Œè®¡ç®—ï¼Œéƒ½ä¼šå¾—åˆ°å»ºè®®çš„å‰¯æœ¬æ•°ï¼Œç„¶åŽæœ€å¤§çš„é‚£ä¸ªå°±æ˜¯æœ€ç»ˆçš„æœŸæœ›å‰¯æœ¬æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//pkg/controller/podautoscaler/horizontal.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">computeReplicasForMetrics&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hpa&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">autoscalingv2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscaler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scale&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">autoscalingv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Scale&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">metricSpecs&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">autoscalingv2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MetricSpec&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">replicas&lt;/span> &lt;span class="kt">int32&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metric&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">statuses&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">autoscalingv2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MetricStatus&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">timestamp&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">......&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricSpec&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">metricSpecs&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">replicaCountProposal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricNameProposal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">timestampProposal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">condition&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">computeReplicasForMetric&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hpa&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricSpec&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">specReplicas&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">statusReplicas&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">selector&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">statuses&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">invalidMetricsCount&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">invalidMetricCondition&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">condition&lt;/span>
&lt;span class="nx">invalidMetricError&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">invalidMetricsCount&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">replicas&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">replicaCountProposal&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="nx">replicas&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">timestamp&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">timestampProposal&lt;/span>
&lt;span class="nx">replicas&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">replicaCountProposal&lt;/span>
&lt;span class="nx">metric&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">metricNameProposal&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">......&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>#computeStatusForObjectMetric&lt;/code>ï¼ˆæ³¨æ„è¿™ä¸ªæ–¹æ³•åå°‘äº†ä¸ª &amp;ldquo;s&amp;rdquo;ï¼‰ä½¿ç”¨&lt;code>MetricsClient&lt;/code>å¾—åˆ°æŒ‡å®šæŒ‡æ ‡çš„å€¼ã€‚&lt;/p>
&lt;p>è¿™ä¸ªæµç¨‹çš„ç»†èŠ‚è¿˜å¯ä»¥ç»§ç»­æ·±æŒ–ï¼Œä½†åˆ°æ­¤å·²å¤Ÿæˆ‘ä»¬ç†è§£ HPAâ€‹ çš„å®žçŽ°æ–¹å¼äº†ã€‚â€‹&lt;/p></description></item><item><title>Tekton çš„å·¥ä½œåŽŸç†</title><link>https://atbug.com/how-tekton-works/</link><pubDate>Sat, 23 May 2020 22:47:14 +0800</pubDate><guid>https://atbug.com/how-tekton-works/</guid><description>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/24/tekton.jpeg" alt="tekton">&lt;/p>
&lt;p>&lt;em>è¿™ç¯‡æ–‡ç« æ˜¯åŸºäºŽ Tekton Pipeline çš„æœ€æ–°ç‰ˆæœ¬&lt;code>v0.12.1&lt;/code>ç‰ˆæœ¬ã€‚&lt;/em>&lt;/p>
&lt;p>å¿«é€Ÿå…¥é—¨è¯·å‚è€ƒï¼š&lt;a href="https://atbug.com/tekton-trigger-practice/">äº‘åŽŸç”Ÿ CICD: Tekton Pipeline å®žæˆ˜&lt;/a> ï¼Œ&lt;em>å®žæˆ˜æ˜¯åŸºäºŽç‰ˆæœ¬ v0.10.x&lt;/em>ã€‚&lt;/p>
&lt;h2 id="pipeline-crd-ä¸Žæ ¸å¿ƒèµ„æºçš„å…³ç³»">Pipeline CRD ä¸Žæ ¸å¿ƒèµ„æºçš„å…³ç³»&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ k api-resources --api-group&lt;span class="o">=&lt;/span>tekton.dev
NAME SHORTNAMES APIGROUP NAMESPACED KIND
clustertasks tekton.dev &lt;span class="nb">false&lt;/span> ClusterTask
conditions tekton.dev &lt;span class="nb">true&lt;/span> Condition
pipelineresources tekton.dev &lt;span class="nb">true&lt;/span> PipelineResource
pipelineruns pr,prs tekton.dev &lt;span class="nb">true&lt;/span> PipelineRun
pipelines tekton.dev &lt;span class="nb">true&lt;/span> Pipeline
taskruns tr,trs tekton.dev &lt;span class="nb">true&lt;/span> TaskRun
tasks tekton.dev &lt;span class="nb">true&lt;/span> Task
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Tekton Pipelinesæä¾›äº†ä¸Šé¢çš„CRDï¼Œå…¶ä¸­éƒ¨åˆ†CRDä¸Žk8s coreä¸­èµ„æºç›¸å¯¹åº”&lt;/p>
&lt;ul>
&lt;li>Task =&amp;gt; Pod&lt;/li>
&lt;li>Task.Step =&amp;gt; Container&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/15902164552270.jpg" alt="">&lt;/p>
&lt;h2 id="å·¥ä½œåŽŸç†">å·¥ä½œåŽŸç†&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/15902280074872.jpg" alt="">
(å›¾ç‰‡æ¥è‡ª)&lt;/p>
&lt;p>Tekton Pipeline æ˜¯åŸºäºŽ Knative çš„å®žçŽ°ï¼Œpod &lt;code>tekton-pipelines-controller&lt;/code> ä¸­æœ‰ä¸¤ä¸ª &lt;a href="https://knative.dev/docs/eventing/samples/writing-receive-adapter-source/03-controller/">Knative Controller&lt;/a>çš„å®žçŽ°ï¼šPipelineRun å’Œ TaskRunã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/15902270934199.jpg" alt="">&lt;/p>
&lt;h3 id="taskçš„æ‰§è¡Œé¡ºåº">Taskçš„æ‰§è¡Œé¡ºåº&lt;/h3>
&lt;p>PipelineRun Controller çš„ &lt;code>#reconcile()&lt;/code>æ–¹æ³•ï¼Œç›‘æŽ§åˆ°æœ‰&lt;code>PipelineRun&lt;/code>è¢«åˆ›å»ºã€‚ç„¶åŽä»Ž&lt;code>PipelineSpec&lt;/code>çš„ tasks åˆ—è¡¨ï¼Œæž„å»ºå‡ºä¸€ä¸ªå›¾ï¼ˆ&lt;code>graph&lt;/code>ï¼‰ï¼Œç”¨äºŽæè¿°&lt;code>Pipeline&lt;/code>ä¸­ Task é—´çš„ä¾èµ–å…³ç³»ã€‚ä¾èµ–å…³ç³»æ˜¯é€šè¿‡&lt;code>runAfter&lt;/code>å’Œ&lt;code>from&lt;/code>ï¼Œè¿›è€ŒæŽ§åˆ¶&lt;a href="#Task%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F">Taskçš„æ‰§è¡Œé¡ºåº&lt;/a>ã€‚ä¸Žæ­¤åŒæ—¶ï¼Œå‡†å¤‡&lt;code>PipelineRun&lt;/code>ä¸­å®šä¹‰çš„&lt;code>PipelineResources&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Node represents a Task in a pipeline.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Node&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Task represent the PipelineTask in Pipeline
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Task&lt;/span> &lt;span class="nx">Task&lt;/span>
&lt;span class="c1">// Prev represent all the Previous task Nodes for the current Task
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Prev&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Node&lt;/span>
&lt;span class="c1">// Next represent all the Next task Nodes for the current Task
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Next&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Node&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Graph represents the Pipeline Graph
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Graph&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//Nodes represent map of PipelineTask name to Node in Pipeline Graph
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Nodes&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Node&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Build&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tasks&lt;/span> &lt;span class="nx">Tasks&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Graph&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>PipelineRun&lt;/code>ä¸­å®šä¹‰çš„å‚æ•°ï¼ˆparametersï¼‰ä¹Ÿä¼šæ³¨å…¥åˆ°&lt;code>PipelineSpec&lt;/code>ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">pipelineSpec&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">resources&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ApplyParameters&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pipelineSpec&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŽ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨&lt;code>dag#GetSchedulable()&lt;/code>æ–¹æ³•ï¼ŒèŽ·å–æœªå®Œæˆï¼ˆé€šè¿‡TaskçŠ¶æ€åˆ¤æ–­ï¼‰çš„ Task åˆ—è¡¨ï¼›&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">GetSchedulable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Graph&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">doneTasks&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">struct&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸º Task A åˆ›å»º&lt;code>TaskRun&lt;/code>ï¼Œå‡å¦‚&lt;code>Task&lt;/code>é…ç½®äº†&lt;code>Condition&lt;/code>ã€‚ä¼šå…ˆä¸º conditionåˆ›å»ºä¸€ä¸ª&lt;code>TaskRun&lt;/code>ï¼Œåªæœ‰åœ¨ condition çš„&lt;code>TaskRun&lt;/code>è¿è¡ŒæˆåŠŸï¼Œæ‰ä¼šè¿è¡Œ A çš„&lt;code>TaskRun&lt;/code>ï¼›å¦åˆ™å°±è·³è¿‡ã€‚&lt;/p>
&lt;h3 id="stepçš„æ‰§è¡Œé¡ºåº">Stepçš„æ‰§è¡Œé¡ºåº&lt;/h3>
&lt;p>è¿™ä¸€éƒ¨åˆ†ç¯‡å¹…è¾ƒé•¿ï¼Œä¹‹å‰çš„æ–‡ç«  &lt;a href="https://atbug.com/control-process-order-of-pod-containers/">æŽ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº&lt;/a> ä¸­æåˆ°è¿‡ã€‚&lt;/p>
&lt;p>è¿™é‡Œè¡¥å……ä¸€ä¸‹&lt;a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/#the-downward-api">Kubernetes Downward API&lt;/a>çš„ä½¿ç”¨ï¼ŒKubernetes Downward APIçš„å¼•å…¥ï¼ŒæŽ§åˆ¶ç€ &lt;code>Task&lt;/code> çš„ç¬¬ä¸€ä¸ª &lt;code>Step&lt;/code> åœ¨ä½•æ—¶æ‰§è¡Œã€‚&lt;/p>
&lt;p>&lt;code>TaskRun&lt;/code> Controller åœ¨ reconciling çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨ç›¸åº”çš„ &lt;code>Pod&lt;/code> çŠ¶æ€å˜ä¸º&lt;code>Running&lt;/code>æ—¶ï¼Œä¼šå°†&lt;code>tekton.dev/ready=READY&lt;/code>å†™å…¥åˆ° Pod çš„ annotation ä¸­ï¼Œæ¥é€šçŸ¥ç¬¬ä¸€ä¸ª&lt;code>Step&lt;/code>çš„æ‰§è¡Œã€‚&lt;/p>
&lt;p>Podçš„éƒ¨åˆ†å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">wait_file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/downward/ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">wait_file_content&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">post_file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/tools/0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">termination_path&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/termination&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/ko-app/git-init&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- --&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ssh://git@gitlab.nip.io:8022/addozhang/logan-pulse.git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">develop&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">path&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/workspace/git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/tools/entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/tekton/downward&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-internal-downward&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">downwardAPI&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">defaultMode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">420&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">items&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">fieldRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">metadata.annotations[&amp;#39;tekton.dev/ready&amp;#39;]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-internal-downward&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹åŽŸç”Ÿçš„æŽ’åºstep containerè¿›ä¸€æ­¥å¤„ç†ï¼šå¯åŠ¨å‘½ä»¤ä½¿ç”¨&lt;code>entrypoint&lt;/code>æä¾›ï¼Œå¹¶è®¾ç½®æ‰§è¡Œå‚æ•°ï¼š&lt;/p>
&lt;p>&lt;code>entrypoint.go&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">orderContainers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">entrypointImage&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">steps&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">results&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">v1alpha1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TaskResult&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">initContainer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;place-tools&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Image&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">entrypointImage&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Command&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;cp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;/ko-app/entrypoint&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">entrypointBinary&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="nx">VolumeMounts&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumeMount&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">toolsMount&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">steps&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;No steps specified&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">steps&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">argsForEntrypoint&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">argsForEntrypoint&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="c1">// First step waits for the Downward volume file.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="s">&amp;#34;-wait_file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">downwardMountPoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">downwardMountReadyFile&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="s">&amp;#34;-wait_file_content&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// Wait for file contents, not just an empty file.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// Start next step.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="s">&amp;#34;-post_file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mountPoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="s">&amp;#34;-termination_path&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">terminationPath&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1">// All other steps wait for previous file, write next file.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">argsForEntrypoint&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="s">&amp;#34;-wait_file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mountPoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="s">&amp;#34;-post_file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mountPoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="s">&amp;#34;-termination_path&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">terminationPath&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è‡ªåŠ¨è¿è¡Œçš„å®¹å™¨">è‡ªåŠ¨è¿è¡Œçš„å®¹å™¨&lt;/h3>
&lt;p>è¿™äº›è‡ªåŠ¨è¿è¡Œçš„å®¹å™¨ä½œä¸º pod çš„&lt;code>initContainer&lt;/code>ä¼šåœ¨ step å®¹å™¨è¿è¡Œä¹‹å‰è¿è¡Œ&lt;/p>
&lt;h4 id="credential-initializer">&lt;code>credential-initializer&lt;/code>&lt;/h4>
&lt;p>ç”¨äºŽå°† &lt;code>ServiceAccount&lt;/code> çš„ç›¸å…³secretsæŒä¹…åŒ–åˆ°å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚æ¯”å¦‚ ssh ç›¸å…³ç§˜é’¥ã€configæ–‡ä»¶ä»¥åŠknow_hostsæ–‡ä»¶ï¼›docker registry ç›¸å…³çš„å‡­è¯åˆ™ä¼šè¢«å†™å…¥åˆ° docker çš„é…ç½®æ–‡ä»¶ä¸­ã€‚&lt;/p>
&lt;h4 id="working-dir-initializer">&lt;code>working-dir-initializer&lt;/code>&lt;/h4>
&lt;p>æ”¶é›†&lt;code>Task&lt;/code>å†…çš„å„ä¸ª&lt;code>Step&lt;/code>çš„&lt;code>workingDir&lt;/code>é…ç½®ï¼Œåˆå§‹åŒ–ç›®å½•ç»“æž„&lt;/p>
&lt;h4 id="place-scripts">&lt;code>place-scripts&lt;/code>&lt;/h4>
&lt;p>å‡å¦‚&lt;code>Step&lt;/code>ä½¿ç”¨çš„æ˜¯&lt;code>script&lt;/code>é…ç½®ï¼ˆä¸Žcommand+argsç›¸å¯¹ï¼‰ï¼Œè¿™ä¸ªå®¹å™¨ä¼šå°†è„šæœ¬ä»£ç ï¼ˆ&lt;code>script&lt;/code>å­—æ®µçš„å†…å®¹ï¼‰æŒä¹…åŒ–åˆ°&lt;code>/tekton/scripts&lt;/code>ç›®å½•ä¸­ã€‚&lt;/p>
&lt;p>æ³¨ï¼šæ‰€æœ‰çš„è„šæœ¬ä¼šè‡ªåŠ¨åŠ ä¸Š&lt;code>#!/bin/sh\nset -xe\n&lt;/code>ï¼Œæ‰€ä»¥&lt;code>script&lt;/code>å­—æ®µé‡Œå°±ä¸å¿…å†™äº†ã€‚&lt;/p>
&lt;h4 id="place-tools">&lt;code>place-tools&lt;/code>&lt;/h4>
&lt;p>å°†&lt;code>entrypoint&lt;/code>çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¤åˆ¶åˆ°&lt;code>/tekton/tools/entrypoint&lt;/code>.&lt;/p>
&lt;h3 id="taskstepé—´çš„æ•°æ®ä¼ é€’">Task/Stepé—´çš„æ•°æ®ä¼ é€’&lt;/h3>
&lt;p>é’ˆå¯¹ä¸åŒçš„æ•°æ®ï¼Œæœ‰å¤šç§ä¸åŒçš„é€‰æ‹©ã€‚æ¯”å¦‚&lt;code>Workspace&lt;/code>ã€&lt;code>Result&lt;/code>ã€&lt;code>PipelineResource&lt;/code>ã€‚å¯¹äºŽç”±äºŽ&lt;code>Task&lt;/code>çš„æ‰§è¡Œæ˜¯é€šè¿‡&lt;code>Pod&lt;/code>æ¥å®Œæˆçš„ï¼Œè€Œ&lt;code>Pod&lt;/code>ä¼šè°ƒåº¦åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šã€‚å› æ­¤&lt;code>Task&lt;/code>é—´çš„æ•°æ®ä¼ é€’ï¼Œéœ€è¦ç”¨åˆ°æŒä¹…åŒ–çš„å·ã€‚&lt;/p>
&lt;p>è€Œ&lt;code>Step&lt;/code>ä½œä¸º&lt;code>Pod&lt;/code>ä¸­çš„å®¹å™¨æ¥è¿è¡Œï¼Œ&lt;/p>
&lt;h4 id="workspace">Workspace&lt;/h4>
&lt;p>å·¥ä½œåŒºï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæŒ‚åœ¨åˆ°å®¹å™¨ä¸Šçš„å·ï¼Œç”¨äºŽæ–‡ä»¶çš„ä¼ é€’ã€‚&lt;/p>
&lt;h5 id="persistentvolumeclaim">&lt;code>persistentVolumeClaim&lt;/code>&lt;/h5>
&lt;p>å¼•ç”¨å·²å­˜åœ¨&lt;code>persistentVolumeClaim&lt;/code>å·ï¼ˆvolumeï¼‰ã€‚è¿™ç§å·¥ä½œç©ºé—´ï¼Œå¯å¤šæ¬¡ä½¿ç”¨ï¼Œéœ€è¦å…ˆè¿›è¡Œåˆ›å»ºã€‚æ¯”å¦‚ Java é¡¹ç›®çš„ &lt;code>maven&lt;/code>ï¼Œç¼–è¯‘éœ€è¦æœ¬åœ°ä¾èµ–åº“ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœæ¯æ¬¡ç¼–è¯‘éƒ½è¦ä¸‹è½½ä¾èµ–åŒ…çš„æˆæœ¬ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeClaim&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">claimName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2-pv-claim&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolume&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2-pv&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">local&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">manual&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">capacity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">10Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteMany&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/data/.m2&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolumeClaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2-pv-claim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">manual&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># volumeName: m2-pv&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteMany&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">10Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="volumeclaimtemplate">&lt;code>volumeClaimTemplate&lt;/code>&lt;/h5>
&lt;p>ä¸ºæ¯ä¸ª&lt;code>PipelineRun&lt;/code>æˆ–è€…&lt;code>TaskRun&lt;/code>åˆ›å»º&lt;code>PersistentVolumeClaim&lt;/code>å·ï¼ˆvolumeï¼‰çš„æ¨¡æ¿ã€‚æ¯”å¦‚ä¸€æ¬¡æž„å»ºéœ€è¦ä»Ž git ä»“åº“å…‹éš†ä»£ç ï¼Œè€Œé’ˆå¯¹ä¸åŒçš„æµæ°´çº¿ä»£ç ä»“åº“æ˜¯ä¸åŒçš„ã€‚è¿™é‡Œå°±ä¼šç”¨åˆ°&lt;code>volumeClaimTemplate&lt;/code>ï¼Œä¸ºæ¯æ¬¡æž„å»ºåˆ›å»ºä¸€ä¸ª&lt;code>PersistentVolumeClaim&lt;/code>å·ã€‚ï¼ˆä»Ž0.12.0å¼€å§‹ï¼‰&lt;/p>
&lt;p>ç”Ÿå‘½å‘¨æœŸåŒ&lt;code>PipelineRun&lt;/code>æˆ–è€…&lt;code>TaskRun&lt;/code>ï¼Œè¿è¡Œä¹‹åŽé‡Šæ”¾ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeClaimTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteMany&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">1Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç›¸è¾ƒäºŽ&lt;code>persistantVolumeClain&lt;/code>ç±»åž‹çš„workspaceï¼Œ&lt;code>volumeClaimTemplate&lt;/code>ä¸éœ€è¦åœ¨æ¯æ¬¡åœ¨&lt;code>PipelineRun&lt;/code>å®ŒæˆåŽæ¸…ç†å·¥ä½œåŒºï¼›å¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä¼šå‡ºçŽ°é—®é¢˜ã€‚&lt;/p>
&lt;h5 id="emptydir">&lt;code>emptyDir&lt;/code>&lt;/h5>
&lt;p>å¼•ç”¨&lt;code>emptyDir&lt;/code>å·ï¼Œè·Ÿéš&lt;code>Task&lt;/code>ç”Ÿå‘½å‘¨æœŸçš„ä¸´æ—¶ç›®å½•ã€‚é€‚åˆåœ¨&lt;code>Task&lt;/code>çš„&lt;code>Step&lt;/code>é—´å…±äº«æ•°æ®ï¼Œæ— æ³•åœ¨å¤šä¸ª&lt;code>Task&lt;/code>é—´å…±äº«ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">temp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">emptyDir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="configmap">&lt;code>configMap&lt;/code>&lt;/h5>
&lt;p>å¼•ç”¨ä¸€ä¸ª&lt;code>configMap&lt;/code>å·ï¼Œå°†&lt;code>configMap&lt;/code>å·ä½œä¸ºå·¥ä½œåŒºï¼Œæœ‰å¦‚ä¸‹é™åˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>æŒ‚è½½çš„å·æ˜¯&lt;code>åªè¯»&lt;/code>çš„&lt;/li>
&lt;li>éœ€è¦æå‰åˆ›å»º&lt;code>configMap&lt;/code>&lt;/li>
&lt;li>&lt;code>configMap&lt;/code>çš„&lt;a href="https://github.com/kubernetes/kubernetes/blob/f16bfb069a22241a5501f6fe530f5d4e2a82cf0e/pkg/apis/core/validation/validation.go#L5042">å¤§å°é™åˆ¶ä¸º1MBï¼ˆK8sçš„é™åˆ¶ï¼‰&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ä½¿ç”¨åœºæ™¯ï¼Œæ¯”å¦‚ä½¿ç”¨&lt;code>maven&lt;/code>ç¼–è¯‘Javaé¡¹ç›®ï¼Œé…ç½®æ–‡ä»¶&lt;code>settings.xml&lt;/code>å¯ä»¥ä½¿ç”¨&lt;code>configMap&lt;/code>ä½œä¸ºå·¥ä½œåŒº&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven-settings&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">configmap&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven-settings&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="secret">&lt;code>secret&lt;/code>&lt;/h5>
&lt;p>ç”¨äºŽå¼•ç”¨&lt;code>secret&lt;/code>å·ï¼ŒåŒ&lt;code>configMap&lt;/code>å·¥ä½œåŒºä¸€æ ·ï¼Œä¹Ÿæœ‰é™åˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>æŒ‚è½½çš„å·æ˜¯&lt;code>åªè¯»&lt;/code>çš„&lt;/li>
&lt;li>éœ€è¦æå‰åˆ›å»º&lt;code>secret&lt;/code>&lt;/li>
&lt;li>&lt;code>secret&lt;/code>çš„&lt;a href="https://github.com/kubernetes/kubernetes/blob/f16bfb069a22241a5501f6fe530f5d4e2a82cf0e/pkg/apis/core/validation/validation.go#L5042">å¤§å°é™åˆ¶ä¸º1MBï¼ˆK8sçš„é™åˆ¶ï¼‰&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="result">Result&lt;/h4>
&lt;p>&lt;code>results&lt;/code>å­—æ®µå¯ä»¥ç”¨æ¥é…ç½®å¤šä¸ªæ–‡ä»¶ç”¨æ¥å­˜å‚¨&lt;code>Tasks&lt;/code>çš„æ‰§è¡Œç»“æžœï¼Œè¿™äº›æ–‡ä»¶ä¿å­˜åœ¨&lt;code>/tekton/results&lt;/code>ç›®å½•ä¸­ã€‚&lt;/p>
&lt;p>åœ¨&lt;code>Pipeline&lt;/code>ä¸­ï¼Œå¯ä»¥é€šè¿‡&lt;code>tasks.[task-nanme].results.[result-name]&lt;/code>æ³¨å…¥åˆ°å…¶ä»–&lt;code>Task&lt;/code>çš„å‚æ•°ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Task&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">A simple task that prints the date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">results&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-unix-timestamp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The current date in unix timestamp format&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-human-readable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The current date in human readable format&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date-unix-timestamp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">bash:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> #!/usr/bin/env bash
&lt;/span>&lt;span class="sd"> date +%s | tee $(results.current-date-unix-timestamp.path)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date-humman-readable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">bash:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> #!/usr/bin/env bash
&lt;/span>&lt;span class="sd"> date | tee $(results.current-date-human-readable.path)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PipelineRun&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pass-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">pipelineSpec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">read-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">runAfter&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#é…ç½®æ‰§è¡Œé¡ºåº&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">print-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskSpec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-unix-timestamp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">string&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-human-readable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">string&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">read&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">busybox&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> echo $(params.current-date-unix-timestamp)
&lt;/span>&lt;span class="sd"> echo $(params.current-date-human-readable)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-unix-timestamp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(tasks.print-date.results.current-date-unix-timestamp)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># æ³¨å…¥å‚æ•°&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-human-readable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(tasks.print-date.results.current-date-human-readable)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># æ³¨å…¥å‚æ•° &lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œç»“æžœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">â”Œâ”€â”€â”€â”€â”€â”€Logs(tekton-pipelines/pass-date-read-date-rhlf2-pod-9b2sk)[all] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ place-scripts stream closed â”‚â”‚ step-read 1590242170 â”‚
â”‚ step-read Sat May 23 13:56:10 UTC 2020 â”‚â”‚ step-read + echo 1590242170 â”‚
â”‚ step-read + echo Sat May 23 13:56:10 UTC 2020 â”‚
â”‚ place-tools stream closed â”‚
â”‚ step-read stream closed â”‚
â”‚
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="pipelineresource">PipelineResource&lt;/h4>
&lt;p>&lt;code>PipelineResource&lt;/code>åœ¨æœ€åŽæï¼Œå› ä¸ºç›®å‰åªæ˜¯&lt;code>alpha&lt;/code>ç‰ˆæœ¬ï¼Œä½•æ—¶ä¼šè¿›å…¥&lt;code>beta&lt;/code>æˆ–è€…å¼ƒç”¨ç›®å‰è¿˜æ˜¯æœªçŸ¥æ•°ã€‚æœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸‹è¿™é‡Œï¼š&lt;a href="https://tekton.dev/docs/pipelines/resources/#why-aren-t-pipelineresources-in-beta">Why Arenâ€™t PipelineResources in Beta?&lt;/a>&lt;/p>
&lt;p>ç®€å•æ¥è¯´ï¼Œ&lt;code>PipelineResource&lt;/code>å¯ä»¥é€šè¿‡å…¶ä»–çš„æ–¹å¼å®žçŽ°ï¼Œè€Œå…¶æœ¬èº«ä¹Ÿå­˜åœ¨å¼Šç«¯ï¼šæ¯”å¦‚å®žçŽ°ä¸é€æ˜Žï¼Œdebugæœ‰éš¾åº¦ï¼›åŠŸèƒ½ä¸å¤Ÿå¼ºï¼›é™ä½Žäº†Taskçš„é‡ç”¨æ€§ç­‰ã€‚&lt;/p>
&lt;p>æ¯”å¦‚&lt;code>git&lt;/code>ç±»åž‹çš„&lt;code>PipelineResource&lt;/code>ï¼Œå¯ä»¥é€šè¿‡&lt;code>workspace&lt;/code>å’Œ&lt;code>git-clone&lt;/code> Taskæ¥å®žçŽ°ï¼›å­˜å‚¨ç±»åž‹çš„ï¼Œä¹Ÿå¯ä»¥é€šè¿‡&lt;code>workspace&lt;/code>æ¥å®žçŽ°ã€‚&lt;/p>
&lt;p>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ&lt;a href="#Workspace">ä¸Šé¢ä»‹ç»workspaceçš„ç¯‡å¹…&lt;/a>æ¯”è¾ƒå¤§ã€‚ä¸ªäººä¹Ÿåå‘äºŽä½¿ç”¨&lt;code>workspace&lt;/code>ï¼Œçµæ´»åº¦é«˜ï¼›ä½¿ç”¨workspaceçš„Taské‡ç”¨æ€§å¼ºã€‚&lt;/p>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://atbug.com/tekton-trigger-practice">äº‘åŽŸç”Ÿ CICD: Tekton Pipeline å®žæˆ˜&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://atbug.com/control-process-order-of-pod-containers">æŽ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://knative.dev/docs/eventing/samples/writing-receive-adapter-source/03-controller">Knative Controller&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tekton.dev/docs/pipelines/resources/#why-aren-t-pipelineresources-in-beta">Why Arenâ€™t PipelineResources in Beta?&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>æŽ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº</title><link>https://atbug.com/control-process-order-of-pod-containers/</link><pubDate>Thu, 12 Mar 2020 22:05:16 +0800</pubDate><guid>https://atbug.com/control-process-order-of-pod-containers/</guid><description>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/screenshot-20210430-at-092623.png" alt="">&lt;/p>
&lt;p>2021.4.30 æ›´æ–°ï¼š&lt;/p>
&lt;p>æœ€æ–°çš„æ–¹æ¡ˆï¼Œè¯·è·³è½¬æ–°ç¯‡ &lt;a href="https://mp.weixin.qq.com/s/8DqF_N_fjiM9AOouvddvgA">Kubernetes ä¸Šå¦‚ä½•æŽ§åˆ¶å®¹å™¨çš„å¯åŠ¨é¡ºåº&lt;/a>ã€‚&lt;/p>
&lt;hr>
&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>ä¼—æ‰€å‘¨çŸ¥, Kubernetes Pod å†…æœ‰ä¸¤ç§å®¹å™¨: åˆå§‹åŒ–å®¹å™¨(init container)å’Œåº”ç”¨å®¹å™¨(app container). å…¶ä¸­åˆå§‹åŒ–å®¹å™¨çš„æ‰§è¡Œå…ˆäºŽåº”ç”¨å®¹å™¨, å¹¶ä¸”åˆå§‹åŒ–å®¹å™¨å’Œåº”ç”¨å®¹å™¨çš„ä¸ªæ•°åˆ†åˆ«ä¸º &lt;code>0~n&lt;/code> å’Œ &lt;code>1~n&lt;/code>.&lt;/p>
&lt;p>åˆå§‹åŒ–å®¹å™¨ä¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œ, é¡ºåºæ‰§è¡Œçš„å‰ææ˜¯åˆå§‹åŒ–å®¹å™¨å§‹ç»ˆä¼šè¿è¡Œåˆ°å®Œæˆ(completed)çŠ¶æ€. è€Œåº”ç”¨å®¹å™¨æ°å¥½ç›¸å: å¯åŠ¨é¡ºåºéšæœº, å¹¶å§‹ç»ˆä¿æŒè¿è¡Œ(running)çŠ¶æ€.&lt;/p>
&lt;h2 id="é—®é¢˜">é—®é¢˜&lt;/h2>
&lt;p>å·¥ä½œä¸­æœ‰ä¸ªæž¶æž„çš„æ–¹æ¡ˆä½¿ç”¨åˆ°äº† sidecar å®¹å™¨: å°†åŸºç¡€ç»„ä»¶åŠŸèƒ½ä»Žå®¹å™¨è½¬ç§»åˆ° sidecar å®¹å™¨ä¸­, å…¶ä¸­æœ‰ä¸ªåŠŸèƒ½æ˜¯ä»Žè¿œç¨‹é…ç½®ä¸­å¿ƒèŽ·å–é…ç½®å¹¶ä¿æŒå®žæ—¶æ›´æ–°. ä¿è¯å®žæ—¶æ›´æ–°æ²¡æœ‰é—®é¢˜, ä½†æ˜¯é…ç½®æ–‡ä»¶éœ€è¦åœ¨ app å¯åŠ¨ä¹‹å‰å®Œæˆåˆå§‹åŒ–.&lt;/p>
&lt;p>å¯¹äºŽåŒä¸º&amp;quot;åº”ç”¨å®¹å™¨&amp;quot;ç±»åž‹çš„ sidecar å®¹å™¨æ¥è¯´, ç”±äºŽå®¹å™¨å¯åŠ¨é¡ºåºéšæœºè€Œæ— æ³•åšåˆ°è¿™ä¸€ç‚¹.&lt;/p>
&lt;p>å½“æ—¶æˆ‘ä»¬ç»™å®šçš„æ–¹æ¡ˆæ˜¯å¢žåŠ ä¸€ä¸ªåˆå§‹åŒ–å®¹å™¨è¿›è¡Œé…ç½®çš„åˆå§‹åŒ–, ä¸å¯é¿å…çš„æˆ‘ä»¬éœ€è¦å¢žåŠ ä¸€ä¸ªé¢å¤–çš„å®¹å™¨, å³ä½¿æ˜¯è¿™ä¸ªå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸéžå¸¸çŸ­.&lt;/p>
&lt;p>è¿½æ±‚æžè‡´çš„æˆ‘ä»¬æ€»æ˜¯å¯¹è¿™ä¸ªé¢å¤–å¢žåŠ çš„å®¹å™¨è€¿è€¿äºŽæ€€: å‡å¦‚èƒ½æŽ§åˆ¶åº”ç”¨å®¹å™¨çš„å¯åŠ¨é¡ºåº&amp;hellip;&lt;/p>
&lt;h3 id="æ–°å‘çŽ°">æ–°å‘çŽ°&lt;/h3>
&lt;p>è¿‘æœŸåœ¨ç ”ç©¶ CDF (Continuous Delivery Foundation)ä¸‹çš„ &lt;a href="https://github.com/tektoncd">Tekton&lt;/a>, å…¶ä¸­æœ‰ä¸ªæ¦‚å¿µæ˜¯å…¶å°†æµæ°´çº¿(pipeline)ä¸­çš„å„ä¸ªæ­¥éª¤(step)ä½œä¸ºåº”ç”¨å®¹å™¨åœ¨åŒä¸€ä¸ª Pod ä¸­è¿è¡Œ.&lt;/p>
&lt;p>æˆ‘ä»¬éƒ½çŸ¥é“æµæ°´çº¿ä¸­çš„æ­¥éª¤æ˜¯æŒ‰ç…§å®šä¹‰çš„é¡ºåºæ‰§è¡Œçš„, é‚£ä¹ˆ Tekton æ˜¯å¦‚ä½•ä¿è¯åº”ç”¨å®¹å™¨çš„æ‰§è¡Œé¡ºåºçš„?&lt;/p>
&lt;p>æŸ¥çœ‹ pod çš„ manifest ä¹‹åŽå‘çŽ°äº†ä¸‹é¢çš„å®¹å™¨é…ç½® (è¿™ä¸ªå®¹å™¨çš„ä½œç”¨ä»Ž git ä»“åº“å…‹éš†ä»£ç )&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">wait_file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/downward/ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">wait_file_content&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">post_file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/tools/0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">termination_path&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/termination&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/ko-app/git-init&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- --&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">http://gitlab.nip.io:8088/addozhang/tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">develop&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">path&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/workspace/git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/tools/entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…‹éš†ä»£ç çš„å‘½ä»¤æ˜¯:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">git-init -url http://gitlab.nip.io:8088/addozhang/tekton-test -revision develop -path /workspace/git-source
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯å®¹å™¨çš„å¯åŠ¨å‘½ä»¤æ˜¯&lt;code>/tekton/tools/entrypoint&lt;/code>å¹¶å¸¦ä¸Šäº†ä¸€å¨çš„å‚æ•°(æ­¤å¤„ç•¥è¿‡, åŽé¢åˆ†æž).&lt;/p>
&lt;p>ç¿»çœ‹äº†ä¸‹&lt;a href="https://github.com/tektoncd/pipeline/tree/master/cmd/entrypoint">æ–‡æ¡£&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>This binary is used to override the entrypoint of a container by wrapping it. In tektoncd/pipeline this is used to make sure Task&amp;rsquo;s steps are executed in order, or for sidecars.&lt;/p>
&lt;p>è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶è¢«ç”¨äºŽé€šè¿‡åŒ…è£…çš„æ–¹å¼æ¥è¦†ç›–å®¹å™¨çš„å…¥å£ç‚¹. åœ¨ tektoncd/pipeline ä¸­ç¡®ä¿ä»»åŠ¡ä¸­çš„æ­¥éª¤æˆ–è€… sidecar è¢«é¡ºåºåœ°æ‰§è¡Œ.&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>&lt;code>-entrypoint&lt;/code>: åŽŸå§‹çš„å®¹å™¨å¯åŠ¨å‘½ä»¤, ä½œä¸º &lt;code>entrypoint&lt;/code> çš„å­è¿›ç¨‹è¿è¡Œ. å³ä¸Šé¢çš„ &lt;code>git-init XXXX&lt;/code>&lt;/li>
&lt;li>&lt;code>-post_file&lt;/code>: å­è¿›ç¨‹è¿è¡Œç»“æŸåŽå†™çš„æ–‡ä»¶è·¯å¾„(å³ä¸Šé¢çš„&lt;code>/tekton/tools/0&lt;/code>). å¦‚æžœå­è¿›ç¨‹æ‰§è¡Œå¤±è´¥, åˆ™å†™ä¸€ä¸ª&lt;code>{{post_file}}.err&lt;/code>æ–‡ä»¶, è€Œä¸æ˜¯&lt;code>{{post_file}}&lt;/code>&lt;/li>
&lt;li>&lt;code>-wait_file&lt;/code>: å¯åŠ¨å­è¿›ç¨‹&lt;strong>å‰&lt;/strong>ç›‘æŽ§çš„æ–‡ä»¶è·¯å¾„(å³ä¸Šé¢çš„&lt;code>/tekton/downward/ready&lt;/code>). é€šè¿‡ç›‘æŽ§åˆ°çš„&lt;code>{{watch_file}}&lt;/code>æˆ–è€…&lt;code>{{watch_file}}.err&lt;/code>æ–‡ä»¶æ¥å†³å®šæ‰§è¡Œå­è¿›ç¨‹, è¿˜æ˜¯è·³è¿‡æ‰§è¡Œç„¶åŽå†™å…¥&lt;code>{{post_file}}.err&lt;/code>æ–‡ä»¶å¹¶è¿”å›žé”™è¯¯ç (&lt;code>exitCode&lt;/code> &amp;gt;= 0)&lt;/li>
&lt;li>&lt;code>-wait_file_content&lt;/code>: ç­‰å¾…&lt;code>wait_file&lt;/code>æœ‰å®žé™…å†…å®¹å†™å…¥, æŒç»­ç›‘æŽ§&lt;code>wait_file&lt;/code>ç›´åˆ°æœ‰å†…å®¹å†™å…¥.&lt;/li>
&lt;/ul>
&lt;p>å›žå¤´çœ‹ä¸Šé¢å®¹å™¨é…ç½®:&lt;/p>
&lt;ol>
&lt;li>å®¹å™¨çš„&lt;code>entrypoint&lt;/code>å¯åŠ¨è¿›ç¨‹&lt;/li>
&lt;li>ç›‘æŽ§åˆ°&lt;code>/tekton/downward/ready&lt;/code>æ–‡ä»¶çš„åˆ›å»º, å¹¶ç­‰å¾…æ–‡ä»¶å†…å®¹çš„å†™å…¥&lt;/li>
&lt;li>æ‰§è¡Œ&lt;code>git-init&lt;/code>å­è¿›ç¨‹, ä»Ž git ä»“åº“å…‹éš†æºç &lt;/li>
&lt;li>åˆ›å»º&lt;code>/tekton/tools/0&lt;/code>æ–‡ä»¶&lt;/li>
&lt;/ol>
&lt;h3 id="å®žé™…åº”ç”¨">å®žé™…åº”ç”¨&lt;/h3>
&lt;p>è¿™ä¸ªæ–¹æ¡ˆæ˜¯å¦èƒ½è§£å†³æˆ‘ä»¬çš„é—®é¢˜, è¿˜æ˜¯æœ‰ä¸€å®šçš„å±€é™æ€§çš„.&lt;/p>
&lt;p>é¦–å…ˆéœ€è¦åº”ç”¨å®¹å™¨çš„å¯åŠ¨å‘½ä»¤è¿›è¡Œé‡æ–°çš„ç¼–æŽ’, è¿™ä¸ªå­˜åœ¨ä¸€å®šçš„æŒ‘æˆ˜. éœ€è¦ç»Ÿä¸€åº”ç”¨çš„å¯åŠ¨å‘½ä»¤æ‰èƒ½åšåˆ°è§„æ¨¡åŒ–+è‡ªåŠ¨åŒ–.&lt;/p>
&lt;p>å…¶æ¬¡å¼•å…¥å¯ç”¨äºŽç›‘æŽ§çš„æ–‡ä»¶, éœ€è¦é¢å¤–å¢žåŠ &lt;code>Volume&lt;/code>ç”¨äºŽè·¨å®¹å™¨çš„æ–‡ä»¶è®¿é—®. å½“ç„¶é€šè¿‡å¢žåŠ &lt;code>emptyDir&lt;/code>çš„&lt;code>Volume&lt;/code>å³å¯.&lt;/p>
&lt;p>åŒæ—¶ sidecar å®¹å™¨éœ€è¦åœ¨å®Œæˆå¯åŠ¨åŽåˆ›å»º&lt;code>post_file&lt;/code>, åº”ç”¨å®¹å™¨å¯ä»¥ä½¿ç”¨è¿™ä¸ª&lt;code>entrypoint&lt;/code>è¿›è¡ŒåŒ…è£….&lt;/p>
&lt;p>å¦‚æžœè¦çªç ´è¿™ä¸ªå±€é™, CRD æ— éžæ˜¯ä¸ªä¼˜ç§€çš„æ–¹æ¡ˆ. ä¸‹ä¸€ç¯‡, æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ CRD æ¥å®žçŽ°.&lt;/p></description></item><item><title>Tekton Trigger ä»‹ç»</title><link>https://atbug.com/tekton-trigger-glance/</link><pubDate>Wed, 05 Feb 2020 18:03:15 +0800</pubDate><guid>https://atbug.com/tekton-trigger-glance/</guid><description>
&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>Tekton çš„ä»‹ç»è¯·å‚è€ƒ&lt;a href="https://atbug.com/tekton-pipeline-practice/">Tekton Pipeline å®žæˆ˜&lt;/a>.&lt;/p>
&lt;p>é€šå¸¸, CI/CD äº‹ä»¶åº”è¯¥åŒ…å«å¦‚ä¸‹ä¿¡æ¯:&lt;/p>
&lt;ul>
&lt;li>ç¡®å®šäº‹ä»¶çš„ç±»åž‹(æ¯”å¦‚ GitHub Push, GitLab Issue, Docker Hub Webhook ç­‰)&lt;/li>
&lt;li>å¯ä»Žç‰¹å®šç®¡é“è®¿é—®å¹¶æ˜ å°„åˆ°ç‰¹å®šç®¡é“ (ä»Žäº‹ä»¶è´Ÿè½½ä¸­èŽ·å– SHA ä¿¡æ¯, ç„¶åŽåœ¨ç®¡é“ä¸­ä½¿ç”¨)&lt;/li>
&lt;li>å‡†ç¡®åœ°è§¦å‘ç®¡é“ (åŸºäºŽæœ‰æ•ˆè´Ÿè½½å€¼è§¦å‘ç®¡é“)&lt;/li>
&lt;/ul>
&lt;p>Tekton API çš„è®¾è®¡åˆ†ç¦»äº†é…ç½®(æ¯”å¦‚ PipelineRun VS Pipeline), ä¿è¯äº† step å¯ä»¥è¢«é‡ç”¨. ä½†æ˜¯æ²¡æœ‰æä¾›åŠ¨æ€å°è£…é…ç½®çš„æœºåˆ¶æ¥ç”Ÿæˆèµ„æº(å°¤å…¶æ˜¯ PipelineRun å’Œ PipelineResource). &lt;a href="https://github.com/tektoncd/triggers">Triggers&lt;/a> é€šè¿‡ä¸‹é¢çš„ CRDs åœ¨æž¶æž„ä¸Šå¯¹ Tekton è¿›è¡Œäº†æ‰©å±•:&lt;/p>
&lt;ul>
&lt;li>&lt;code>TriggerTemplate&lt;/code>: åˆ›å»ºèµ„æºçš„æ¨¡æ¿(æ¯”å¦‚ç”¨æ¥åˆ›å»º PipelineResource å’Œ PipelineRun)&lt;/li>
&lt;li>&lt;code>TriggerBinding&lt;/code>: æ ¡éªŒäº‹ä»¶å¹¶æå–è´Ÿè½½å­—æ®µ&lt;/li>
&lt;li>&lt;code>EventListener&lt;/code>: è¿žæŽ¥&lt;code>TriggerBinding&lt;/code>å’Œ&lt;code>TriggerTemplate&lt;/code>åˆ°å¯å¯»å€çš„ç«¯ç‚¹(äº‹ä»¶æŽ¥æ”¶å™¨). ä½¿ç”¨ä»Žå„ä¸ª&lt;code> TriggerBinding&lt;/code>ä¸­æå–çš„å‚æ•°æ¥åˆ›å»º&lt;code>TriggerTemplate&lt;/code>ä¸­æŒ‡å®šçš„ resources. åŒæ ·é€šè¿‡&lt;code> interceptor&lt;/code>å­—æ®µæ¥æŒ‡å®šå¤–éƒ¨æœåŠ¡æ¥å¯¹äº‹ä»¶è´Ÿè½½è¿›è¡Œé¢„å¤„ç†.&lt;/li>
&lt;li>&lt;code>ClusterTriggerBinding&lt;/code>: clusterçº§åˆ«çš„&lt;code>TriggerBinding&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/rymZ0w.jpg" alt="">&lt;/p>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl apply --filename https://storage.googleapis.com/tekton-releases/triggers/latest/release.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥æ–°å¢žçš„ CRD: &lt;code>kubectl api-resources | grep tekton&lt;/code>. Triggers å¼•å…¥äº† 3 ä¸ª CRD: &lt;code>TriggerTemplate&lt;/code>, &lt;code>TriggerBinding&lt;/code>,&lt;code>EventListener&lt;/code>.&lt;/p>
&lt;p>æ£€æŸ¥æ–°å¢žçš„ deployment: &lt;code>tekton-triggers-webhook&lt;/code>, &lt;code>tekton-triggers-controller&lt;/code>.&lt;/p></description></item><item><title>Tekton Dashboard å®‰è£…</title><link>https://atbug.com/tekton-dashboard-installation/</link><pubDate>Sat, 01 Feb 2020 12:39:28 +0800</pubDate><guid>https://atbug.com/tekton-dashboard-installation/</guid><description>
&lt;p>Tekton æä¾›äº†&lt;a href="https://github.com/tektoncd/dashboard">dashboard&lt;/a>æ–¹ä¾¿ç”¨æˆ·ç®¡ç†å’ŒæŸ¥çœ‹ Tekton PipelineRun å’Œ TaskRun ä»¥åŠåˆ›å»º, æ‰§è¡Œå’Œå®Œæˆè¿‡ç¨‹ä¸­æ¶‰åŠçš„èµ„æº. å®ƒè¿˜å…è®¸æŒ‰æ ‡ç­¾è¿‡æ»¤ PipelineRun å’Œ TaskRun.&lt;/p>
&lt;h3 id="å®‰è£…æ–¹æ³•">å®‰è£…æ–¹æ³•&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply --filename https://github.com/tektoncd/dashboard/releases/download/v0.4.1/dashboard_latest_release.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥dashboardçš„è¿è¡Œæƒ…å†µ, &lt;code>STATUS&lt;/code>ä¸º&lt;code>Running&lt;/code>çš„è¯åˆ™è¯´æ˜Žè¿è¡ŒæˆåŠŸ.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get pods --namespace tekton-pipelines
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è®¿é—®">è®¿é—®&lt;/h3>
&lt;p>è®¿é—®Tektonçš„Dashboardæœ‰ä¸¤ç§æ–¹å¼, ä¸€ç§æ˜¯é€šè¿‡&lt;code>port-forward&lt;/code>, å¦ä¸€ç§æ˜¯é€šè¿‡&lt;code>ingress&lt;/code>æ¥è®¿é—®.&lt;/p>
&lt;h4 id="port-forward">port-forward&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl port-forward svc/tekton-dashboard &lt;span class="m">9097&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ingress">ingress&lt;/h4>
&lt;p>å…ˆæ£€æŸ¥ingressæ˜¯å¦å¼€å¯.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube addon list
...
- ingress: enabled
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æžœæ˜¯disabledçš„è¯, é€šè¿‡å‘½ä»¤&lt;code>minikube addons enable ingress&lt;/code>.&lt;/p>
&lt;p>&lt;em>æ³¨æ„: è¿™é‡Œæ‹‰å–&lt;code>quay.io/kubernetes-ingress-controller/nginx-ingress-controller&lt;/code>é•œåƒå¯èƒ½æ¯”è¾ƒæ…¢, å»ºè®®ä½¿ç”¨å›½å†…çš„é•œåƒ, æ¯”å¦‚&lt;code>quay.mirrors.ustc.edu.cn/kubernetes-ingress-controller/nginx-ingress-controller&lt;/code>&lt;/em>&lt;/p>
&lt;p>ä¿®æ”¹&lt;code>basic-dashboard-ingress.yaml&lt;/code>ä¸­çš„&lt;code>host&lt;/code>åœ°å€:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">extensions/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Ingress&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-dashboard&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-dashboard.nip.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">paths&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">backend&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-dashboard&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">servicePort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">9097&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œ&lt;code>kubectl apply -f basic-dashboard-ingress.yaml&lt;/code>.&lt;/p>
&lt;p>è¿˜æœ‰æœ€åŽä¸€æ­¥, åœ¨&lt;code>/etc/hosts&lt;/code>ä¸­æ·»åŠ ä¸€æ¡è§£æž&lt;code>x.x.x.x tekton-dashboard.nip.io&lt;/code>, ipåœ°å€é€šè¿‡&lt;code>minikube ip&lt;/code>æ¥èŽ·å–&lt;/p>
&lt;p>æµè§ˆå™¨ä¸­æ‰“å¼€&lt;code> tekton-dashboard.nip.io&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/6weoXL.jpg" alt="">&lt;/p></description></item><item><title>Tektonå®‰è£…åŠHello world</title><link>https://atbug.com/tekton-installation-and-sample/</link><pubDate>Fri, 17 Jan 2020 19:17:14 +0800</pubDate><guid>https://atbug.com/tekton-installation-and-sample/</guid><description>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥å®‰è£…çš„tektonç›¸å…³çš„CRD:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl api-resources &lt;span class="p">|&lt;/span> grep tekton
clustertasks tekton.dev &lt;span class="nb">false&lt;/span> ClusterTask
conditions tekton.dev &lt;span class="nb">true&lt;/span> Condition
pipelineresources tekton.dev &lt;span class="nb">true&lt;/span> PipelineResource
pipelineruns pr,prs tekton.dev &lt;span class="nb">true&lt;/span> PipelineRun
pipelines tekton.dev &lt;span class="nb">true&lt;/span> Pipeline
taskruns tr,trs tekton.dev &lt;span class="nb">true&lt;/span> TaskRun
tasks tekton.dev &lt;span class="nb">true&lt;/span> Task
&lt;/code>&lt;/pre>&lt;/div>&lt;p>tektonçš„ä¸¤ä¸ªpod:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get pods --namespace tekton-pipelines
NAME READY STATUS RESTARTS AGE
tekton-pipelines-controller-556d8f4494-2qthv 1/1 Running &lt;span class="m">0&lt;/span> 11m
tekton-pipelines-webhook-849cff5cf-8m5qq 1/1 Running &lt;span class="m">0&lt;/span> 11m
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…cli">å®‰è£…CLI&lt;/h3>
&lt;p>cli: &lt;a href="https://github.com/tektoncd/cli#installing-tkn">https://github.com/tektoncd/cli#installing-tkn&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">brew install tektoncd-cli
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="tekton-hello-world">Tekton: hello world&lt;/h2>
&lt;p>åˆ›å»ºä¸€ä¸ªç®€å•çš„&lt;code>Task&lt;/code>, åªæœ‰ä¸€ä¸ª&lt;code>step&lt;/code>å°±æ˜¯æ‰“å°å‡º&amp;quot;hello world&amp;quot;&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Task&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo-hello-world&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">echo&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;hello world&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»ºä¸€ä¸ª&lt;code>TaskRun&lt;/code>æ‰§è¡Œä¸Šé¢çš„&lt;code>Task&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TaskRun&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo-hello-world-task-run&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo-hello-world&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡Œtask:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f &amp;lt;name-of-file.yaml&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥&lt;code>TaskRun&lt;/code>çš„è¾“å‡º, æ‰§è¡Œå‘½ä»¤:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">tkn taskrun describe echo-hello-world-task-run
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">Name: echo-hello-world-task-run
Namespace: tekton-pipelines
Task Ref: echo-hello-world
Status
STARTED DURATION STATUS
21 minutes ago 1 minute Succeeded
Input Resources
No resources
Output Resources
No resources
Params
No params
Steps
NAME STATUS
echo Completed
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Succeeded&lt;/code>çŠ¶æ€è¡¨ç¤ºtaskæ‰§è¡ŒæˆåŠŸ.&lt;/p>
&lt;p>æŸ¥çœ‹å®žé™…çš„è¾“å‡º, æ‰§è¡Œå‘½ä»¤:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">tkn taskrun logs echo-hello-world-task-run
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æžœ:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">[echo] hello world
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Minikubeå®‰è£…istio</title><link>https://atbug.com/install-istio-on-minikube/</link><pubDate>Fri, 17 Jan 2020 08:02:42 +0800</pubDate><guid>https://atbug.com/install-istio-on-minikube/</guid><description>
&lt;h2 id="å‡†å¤‡">å‡†å¤‡&lt;/h2>
&lt;p>&lt;strong>æ³¨æ„: istioctlçš„å®‰è£…è¦ä½¿ç”¨å®‰è£…é‡Œçš„, ä¸è¦æ˜¯ç”¨homebrewé‡Œçš„. &lt;a href="https://github.com/istio/istio/issues/19029">github issue&lt;/a>&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -L https://istio.io/downloadIstio &lt;span class="p">|&lt;/span> sh -
&lt;span class="nb">cd&lt;/span> istio-1.4.2
cp bin/istioctl /usr/local/bin/istioctl
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…å‰æ£€æŸ¥">å®‰è£…å‰æ£€æŸ¥&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">istioctl verify-install
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æžœæ£€æŸ¥æ²¡é—®é¢˜, ä¼šçœ‹åˆ°&lt;code>Install Pre-Check passed! The cluster is ready for Istio installation.&lt;/code>&lt;/p>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;p>istioæœ‰5ç§å†…å»ºçš„å®‰è£…é…ç½®&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>: remote, sds, default, demo, minimal&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">istioctl profile list
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>minimal: ä½¿ç”¨istioçš„æµé‡ç®¡ç†æ‰€éœ€ç»„ä»¶çš„æœ€å°åŒ–å®‰è£…&lt;/li>
&lt;li>default: æ ¹æ®IstioControlPlane APIçš„é»˜è®¤è®¾ç½®(å»ºè®®ç”¨äºŽç”Ÿäº§éƒ¨ç½²)å¯ç”¨ç»„ä»¶. æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œå‘½ä»¤istioctl profile dumpæ˜¾ç¤ºé»˜è®¤è®¾ç½®.&lt;/li>
&lt;li>demo: å‡ ä¹Žå®‰è£…æ‰€æœ‰çš„ç‰¹æ€§, åŒ…æ‹¬loggingå’Œtracingçš„æ¯”ä¾‹ä¸º100%. ä¸é€‚åˆç”Ÿäº§çŽ¯å¢ƒ, è´Ÿè½½å¤ªé‡&lt;/li>
&lt;/ul>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;/th>
&lt;th>default&lt;/th>
&lt;th>demo&lt;/th>
&lt;th>minimal&lt;/th>
&lt;th>sds&lt;/th>
&lt;th>remote&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Core components&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-citadel&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-egressgateway&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-galley&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-ingressgateway&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-nodeagent&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-pilot&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-policy&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-sidecar-injector&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-telemetry&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Addons&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>grafana&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-tracing&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>kiali&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>prometheus&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;code>demo&lt;/code> profileå®‰è£…&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">istioctl manifest apply --set &lt;span class="nv">profile&lt;/span>&lt;span class="o">=&lt;/span>demo
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éªŒè¯å®‰è£…ç»“æžœ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">istioctl manifest generate --set &lt;span class="nv">profile&lt;/span>&lt;span class="o">=&lt;/span>demo &amp;gt; /tmp/generated-manifest.yaml
istioctl verify-install -f /tmp/generated-manifest.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>&amp;hellip;&amp;hellip;
Checked 23 crds
Checked 9 Istio Deployments
Istio is installed successfully&lt;/p>
&lt;/blockquote>
&lt;h2 id="å¸è½½">å¸è½½&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">helm template install/kubernetes/helm/istio --namespace istio-system &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --values install/kubernetes/helm/istio/values-istio-demo.yaml &lt;span class="p">|&lt;/span> kubectl delete -f -
kubectl delete namespace istio-system
&lt;span class="c1">#delete all CRDs&lt;/span>
kubectl delete -f install/kubernetes/helm/istio-init/files
&lt;/code>&lt;/pre>&lt;/div>&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>&lt;a href="https://istio.io/docs/setup/additional-setup/config-profiles/">è¿™é‡Œ&lt;/a>å¯ä»¥æŸ¥çœ‹å„ä¸ªé…ç½®çš„è¯¦ç»†è¯´æ˜Ž &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>åŠ é€Ÿäº‘åŽŸç”Ÿçš„ Java å¼€å‘</title><link>https://atbug.com/speed-up-java-development-on-kubernetes/</link><pubDate>Sat, 21 Dec 2019 20:45:22 +0800</pubDate><guid>https://atbug.com/speed-up-java-development-on-kubernetes/</guid><description>
&lt;p>ä»Šå¤©æ¥è¯´è¯´æ—¥å¸¸åœ¨Kuberneteså¼€å‘Javaé¡¹ç›®é‡åˆ°çš„é—®é¢˜.&lt;/p>
&lt;p>å½“æˆ‘ä»¬æ–°å»ºä¸€ä¸ªé¡¹ç›®çš„æ—¶å€™, æ€»æ˜¯é¢ä¸´éœ€è¦æ–°å»ºmanifest, å¹³æ—¶éƒ½æ˜¯&lt;code>copy+paste+modify&lt;/code>. èƒ½å¦ä»¥å˜æˆçš„æ–¹å¼æ¥ç”Ÿæˆ?&lt;/p>
&lt;p>å¼€å‘æ—¶çš„æ­¥éª¤ä¹Ÿæ¯”è¾ƒç¹ç: &lt;code>docker build&lt;/code>, &lt;code>docker push&lt;/code>, &lt;code>kubectl apple&lt;/code>, &lt;code>kubectl delete pod&lt;/code>. å¯¹äºŽä¸€ä¸ªJavaåº”ç”¨æ¥è¯´è¿˜å¤šäº†ä¸€æ­¥ç¼–è¯‘. æ“ä½œä¸€æ¬¡è¿˜ok, ä½†æ˜¯ä¸€å¤©åå‡ æ¬¡æ€»ä¼šæœ‰æƒ³åçš„æ„Ÿè§‰. è¿™äº›æ­¥éª¤èƒ½å¦ç®€åŒ–æˆä¸€ä¸ªå‘½ä»¤, ç”šè‡³ä¿®æ”¹äº†ä»£ç è‡ªåŠ¨å°±å®Œæˆä¸Šé¢ä¸€ç³»åˆ—çš„æ“ä½œ?&lt;/p>
&lt;p>å®žçŽ°è¿™äº›æˆ‘ä»¬éœ€è¦å‡ ä¸ªå·¥å…·: &lt;a href="https://github.com/dekorateio/dekorate">dekorate&lt;/a>, &lt;a href="https://github.com/GoogleContainerTools/jib">Jib&lt;/a>, &lt;a href="https://github.com/GoogleContainerTools/skaffold">Skaffold&lt;/a>. å…¶ä¸­Jibä¹Ÿåœ¨ä¸Šä¸€ç¯‡æ–‡ç« &lt;a href="https://atbug.com/build-docker-or-oci-image-with-jib-for-java/">ä½¿ç”¨Jibä¸ºJavaåº”ç”¨æž„å»ºé•œåƒ&lt;/a>ä¸­ä»‹ç»è¿‡.&lt;/p>
&lt;h2 id="dekorate">dekorate&lt;/h2>
&lt;blockquote>
&lt;p>Dekorate is a collection of Java compile-time generators and decorators for Kubernetes/OpenShift manifests.
Dekorateæ˜¯Javaç¼–è¯‘æ—¶ç”Ÿæˆå’Œè£…é¥°Kubernetes/OpenShiftçš„manifestsçš„å·¥å…·&lt;/p>
&lt;/blockquote>
&lt;h3 id="å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹&lt;/h3>
&lt;h4 id="1-é€šè¿‡ä½¿ç”¨spring-initializerhttpsstartspringioç”Ÿæˆä¸€ä¸ªé¡¹ç›®spring-boot-222-å¹¶åŠ å…¥ä¾èµ–">1. é€šè¿‡ä½¿ç”¨&lt;a href="https://start.spring.io">Spring Initializer&lt;/a>ç”Ÿæˆä¸€ä¸ªé¡¹ç›®(Spring Boot 2.2.2), å¹¶åŠ å…¥ä¾èµ–:&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>io.dekorate&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>kubernetes-spring-starter&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>0.10.0&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="2-åŠ å…¥ä¸€ä¸ªç®€å•çš„controller">2. åŠ å…¥ä¸€ä¸ªç®€å•çš„&lt;code>Controller&lt;/code>:&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * @author Addo.Zhang
&lt;/span>&lt;span class="cm"> * @date 2019/12/22
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="nd">@RestController&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">DekorateExampleController&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@GetMapping&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">hi&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;Hello World&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-æ‰§è¡Œå‘½ä»¤mvn-clean-install-ç„¶åŽåœ¨targetclassesmeta-infdekorateç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°kubernetesjsonå’Œkubernetesymlä¸¤ä¸ªæ–‡ä»¶">3. æ‰§è¡Œå‘½ä»¤&lt;code>mvn clean install&lt;/code>, ç„¶åŽåœ¨&lt;code>target/classes/META-INF/dekorate&lt;/code>ç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°&lt;code>kubernetes.json&lt;/code>å’Œ&lt;code>kubernetes.yml&lt;/code>ä¸¤ä¸ªæ–‡ä»¶.&lt;/h4>
&lt;p>&lt;code>kubernetes.yml&lt;/code>çš„å†…å®¹:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;v1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Service&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;ClusterIP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;apps/v1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Deployment&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">env&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;KUBERNETES_NAMESPACE&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">valueFrom&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;metadata.namespace&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo/dekorate-example:0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;IfNotPresent&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">livenessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">failureThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/actuator/info&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initialDelaySeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">successThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeoutSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">containerPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;TCP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">readinessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">failureThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/actuator/health&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initialDelaySeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">successThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeoutSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ymlä¸­åŒ…å«äº†&lt;code>Service&lt;/code>å’Œ&lt;code>Deployment&lt;/code>ä¸¤éƒ¨åˆ†, dekorateå®Œç¾Žå…¼å®¹çš„Spring:&lt;/p>
&lt;ul>
&lt;li>&lt;code>app: dekorate-example&lt;/code>: é¡¹ç›®å&lt;/li>
&lt;li>&lt;code>version: 0.0.1-SNAPSHOT&lt;/code>: é¡¹ç›®å½“å‰ç‰ˆæœ¬&lt;/li>
&lt;li>&lt;code>group: addo&lt;/code>: æ˜¯æˆ‘ç³»ç»Ÿå½“å‰ç”¨æˆ·å&lt;/li>
&lt;li>&lt;code>/actuator/health&lt;/code>: Spring Boot 2.2åŽactuatorçš„health endpoint, ä½œä¸º&lt;code>readinessProbe&lt;/code>&lt;/li>
&lt;li>&lt;code>/actuator/info&lt;/code>: Spring Boot 2.2åŽactuatorçš„endpoint, ä½œä¸º&lt;code>livenessProbe&lt;/code>&lt;/li>
&lt;/ul>
&lt;h3 id="è¿›é˜¶">è¿›é˜¶&lt;/h3>
&lt;p>&lt;strong>å‰é¢ymlçš„å†…å®¹éƒ½æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„, å‡å¦‚æœ‰äº›ç‰¹æ®Šçš„éœ€æ±‚. æ¯”å¦‚ä¿®æ”¹é•œåƒçš„&lt;code>repository&lt;/code>å³è¿™é‡Œçš„&lt;code>group&lt;/code>, å¦‚ä½•æ“ä½œ?&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">dekorate.kubernetes.group = addozhang
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æžœ:&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/5zgkfl.jpg" alt="Change Image Repository">&lt;/p>
&lt;p>&lt;strong>æˆ–è€…ä¿®æ”¹Serviceçš„ç±»åž‹ä¸ºNodePort&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">dekorate.kubernetes.service-type = NodePort
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/vIen3M.jpg" alt="NodePort Service">&lt;/p>
&lt;h4 id="é…ç½®">é…ç½®&lt;/h4>
&lt;p>dekorationæä¾›äº†&lt;a href="https://github.com/dekorateio/dekorate/blob/master/assets/config.md">ä¸°å¯Œçš„é…ç½®&lt;/a>æ¥ä¸ªæ€§åŒ–manifest.&lt;/p>
&lt;p>é™¤äº†ä¸Šé¢ä½¿ç”¨çš„é…ç½®æ–‡ä»¶(properties/yaml)çš„æ–¹å¼, è¿˜æä¾›äº†&lt;code>Annotation&lt;/code>æ³¨è§£é…ç½®æ–¹å¼.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">import&lt;/span> &lt;span class="nn">io.dekorate.kubernetes.annotation.Env&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">io.dekorate.kubernetes.annotation.KubernetesApplication&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@KubernetesApplication&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">envVars&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nd">@Env&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;key1&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;var1&amp;#34;&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Main&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//Your code goes here
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/exQoxy.jpg" alt="@KubernetesApplication Annotation">&lt;/p>
&lt;h2 id="jib">Jib&lt;/h2>
&lt;p>Jibçš„è¯´æ˜Žè¯·çœ‹ä¸Šä¸€ç¯‡æ–‡ç« :&lt;a href="https://atbug.com/build-docker-or-oci-image-with-jib-for-java/">ä½¿ç”¨Jibä¸ºJavaåº”ç”¨æž„å»ºé•œåƒ&lt;/a>&lt;/p>
&lt;h3 id="æ’ä»¶é…ç½®">æ’ä»¶é…ç½®&lt;/h3>
&lt;p>ä¸‹é¢æ˜¯é’ˆå¯¹è¯¥é¡¹ç›®æ·»åŠ çš„é…ç½®:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="nt">&amp;lt;plugin&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.google.cloud.tools&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>jib-maven-plugin&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>1.8.0&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;configuration&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;container&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-Xmx128m&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-Xms64m&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/jvmFlags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;labels&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;Author&amp;gt;&lt;/span>Addo.Zhang&lt;span class="nt">&amp;lt;/Author&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/labels&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;creationTime&amp;gt;&lt;/span>USE_CURRENT_TIMESTAMP&lt;span class="nt">&amp;lt;/creationTime&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/container&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;from&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;image&amp;gt;&lt;/span>openjdk:8-jdk-alpine&lt;span class="nt">&amp;lt;/image&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/from&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;to&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;image&amp;gt;&lt;/span>addo/dekorate-example&lt;span class="nt">&amp;lt;/image&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;tags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;tag&amp;gt;&lt;/span>latest&lt;span class="nt">&amp;lt;/tag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/tags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/to&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;allowInsecureRegistries&amp;gt;&lt;/span>true&lt;span class="nt">&amp;lt;/allowInsecureRegistries&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/configuration&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/plugin&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œå‘½ä»¤&lt;code>mvn compile jib:dockerBuild&lt;/code>ä¾¿å¯ä»¥ç¼–è¯‘ä»£ç , æž„å»ºé•œåƒå¹¶æŽ¨é€åˆ°é•œåƒä»“åº“.&lt;/p>
&lt;h2 id="skaffold">Skaffold&lt;/h2>
&lt;p>&lt;a href="https://github.com/GoogleContainerTools/skaffold">Skaffold&lt;/a>ä¹Ÿæ˜¯GoogleContainerToolsä¸­çš„ä¸€ä¸ªå·¥å…·.&lt;/p>
&lt;blockquote>
&lt;p>Skaffold is a command line tool that facilitates continuous development for Kubernetes applications. You can iterate on your application source code locally then deploy to local or remote Kubernetes clusters. Skaffold handles the workflow for building, pushing and deploying your application. It also provides building blocks and describe customizations for a CI/CD pipeline.
Skaffoldæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·, å¯ä¿ƒè¿›Kubernetesåº”ç”¨ç¨‹åºçš„æŒç»­å¼€å‘. å¯ä»¥åœ¨æœ¬åœ°è¿­ä»£åº”ç”¨ç¨‹åºæºä»£ç , ç„¶åŽéƒ¨ç½²åˆ°æœ¬åœ°æˆ–è¿œç¨‹Kubernetesé›†ç¾¤. Skaffoldå¤„ç†æž„å»º, æŽ¨é€å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºçš„å·¥ä½œæµç¨‹. å®ƒè¿˜æä¾›äº†æž„å»ºå—å¹¶æè¿°äº†CI/CDç®¡é“çš„è‡ªå®šä¹‰.&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­, é€šè¿‡ä¸ŽJibçš„è”åŠ¨, å®Œæˆç¼–è¯‘ä»£ç , æž„å»ºé•œåƒ, æŽ¨é€é•œåƒ, éƒ¨ç½²ä¸€ç³»åˆ—æ“ä½œ.&lt;/p>
&lt;p>![Run](&lt;a href="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/2019-12-23">https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/2019-12-23&lt;/a> 15.12.24.gif)&lt;/p>
&lt;p>æˆªå±ä¸­çš„æ“ä½œ, å› ä¸ºæ²¡æœ‰ä»£ç æ”¹åŠ¨è€Œä¸ç»­æž„å»ºé•œåƒ, Skaffoldç›´æŽ¥ä»Žcacheä¸­èŽ·å–é•œåƒå¹¶éƒ¨ç½²åˆ°Kubernetesä¸­.&lt;/p>
&lt;h3 id="skaffoldæ“ä½œ">Skaffoldæ“ä½œ&lt;/h3>
&lt;h4 id="1-æ‰§è¡Œå‘½ä»¤skaffold-init---xxenablejibinitå¹¶åœ¨æç¤ºå‡ºè¾“å…¥y">1. æ‰§è¡Œå‘½ä»¤&lt;code>skaffold init --XXenableJibInit&lt;/code>å¹¶åœ¨æç¤ºå‡ºè¾“å…¥&lt;code>y&lt;/code>&lt;/h4>
&lt;h4 id="2-è¯¥å‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ªåä¸ºskaffoldyamlçš„æ–‡ä»¶">2. è¯¥å‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ªåä¸º&lt;code>skaffold.yaml&lt;/code>çš„æ–‡ä»¶&lt;/h4>
&lt;p>ç”±äºŽ&lt;code>dekorate&lt;/code>åŒæ—¶ç”Ÿæˆäº†&lt;code>json&lt;/code>å’Œ&lt;code>yaml&lt;/code>æ ¼å¼çš„manifest, è¢«&lt;code>skaffold&lt;/code>æ£€æµ‹åˆ°. å®žé™…æ“ä½œä¸­åªéœ€è¦å…¶ä¸­ä¸€ä¸ªå³å¯.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">skaffold/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dekorate-example&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">artifacts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">addo/dekorate-example&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">jib&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kubectl&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">manifests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">target/classes/META-INF/dekorate/kubernetes.json&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">target/classes/META-INF/dekorate/kubernetes.yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-æ‰§è¡Œskaffold-run">3. æ‰§è¡Œ&lt;code>skaffold run&lt;/code>&lt;/h4>
&lt;h4 id="4-podå¯åŠ¨å®ŒæˆåŽ-é€šè¿‡kubectl-port-forward-podname-here-8081">4. podå¯åŠ¨å®ŒæˆåŽ, é€šè¿‡&lt;code>kubectl port-forward PODNAME-HERE 8081&lt;/code>&lt;/h4>
&lt;h4 id="5-è¯·æ±‚http-httplocalhost8081">5. è¯·æ±‚&lt;code>http http://localhost:8081&lt;/code>&lt;/h4>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/wt2BVU.jpg" alt="">&lt;/p>
&lt;h3 id="è¿›é˜¶-1">è¿›é˜¶&lt;/h3>
&lt;p>Skaffoldçš„åŠŸèƒ½å¼ºå¤§, ç›®å‰ä¸ªäººä½¿ç”¨çš„æœ‰é™, æœ‰æ—¶é—´æ–°å¼€ä¸€ç¯‡æ¥å­¦ä¹ ä¸€ä¸‹.&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/FXu4Hy.jpg" alt="">&lt;/p>
&lt;h4 id="cli">CLI&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">âžœ ~ skaffold &lt;span class="nb">help&lt;/span>
A tool that facilitates continuous development &lt;span class="k">for&lt;/span> Kubernetes applications.
Find more information at: https://skaffold.dev/docs/getting-started/
End-to-end pipelines:
run Run a pipeline
dev Run a pipeline in development mode
debug &lt;span class="o">[&lt;/span>beta&lt;span class="o">]&lt;/span> Run a pipeline in debug mode
Pipeline building blocks &lt;span class="k">for&lt;/span> CI/CD:
build Build the artifacts
deploy Deploy pre-built artifacts
delete Delete the deployed application
render &lt;span class="o">[&lt;/span>alpha&lt;span class="o">]&lt;/span> Perform all image builds, and output rendered Kubernetes manifests
Getting started with a new project:
init &lt;span class="o">[&lt;/span>alpha&lt;span class="o">]&lt;/span> Generate configuration &lt;span class="k">for&lt;/span> deploying an application
fix Update old configuration to newest schema version
Other Commands:
completion Output shell completion &lt;span class="k">for&lt;/span> the given shell &lt;span class="o">(&lt;/span>bash or zsh&lt;span class="o">)&lt;/span>
config Interact with the Skaffold configuration
credits Export third party notices to given path &lt;span class="o">(&lt;/span>./skaffold-credits by default&lt;span class="o">)&lt;/span>
diagnose Run a diagnostic on Skaffold
version Print the version information
Usage:
skaffold &lt;span class="o">[&lt;/span>flags&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>options&lt;span class="o">]&lt;/span>
Use &lt;span class="s2">&amp;#34;skaffold &amp;lt;command&amp;gt; --help&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> more information about a given command.
Use &lt;span class="s2">&amp;#34;skaffold options&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> a list of global command-line options &lt;span class="o">(&lt;/span>applies to all commands&lt;span class="o">)&lt;/span>.
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="yamlé…ç½®">Yamlé…ç½®&lt;/h4>
&lt;p>å‚è€ƒ&lt;a href="https://skaffold.dev/docs/references/yaml/">skaffold.yaml&lt;/a>&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>æ–‡ç« çš„å¼€å¤´æˆ‘ä»¬æåˆ°å¦‚ä½•åšåˆ°ä¿®æ”¹ä»£ç åŽè‡ªåŠ¨å®Œæˆä¸€äº›åˆ—çš„æ“ä½œ, é€šè¿‡&lt;code>skaffold dev&lt;/code>å°±å¯ä»¥å®žçŽ°.&lt;/p>
&lt;p>æ–‡ç« ä¸­ä½¿ç”¨çš„&lt;code>dekoration-example&lt;/code>å¯åœ¨&lt;a href="https://github.com/addozhang/dekorate-example">GitHub&lt;/a>ä¸Šæ‰¾åˆ°.&lt;/p></description></item><item><title>Kubernetesä¸­çš„NginxåŠ¨æ€è§£æž</title><link>https://atbug.com/nginx-dynamic-domain-parse-in-kubernetes/</link><pubDate>Wed, 30 May 2018 12:10:32 +0000</pubDate><guid>https://atbug.com/nginx-dynamic-domain-parse-in-kubernetes/</guid><description>
&lt;h3 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h3>
&lt;p>Nginxè¿è¡Œåœ¨kubernetsä¸­, åå‘ä»£ç†serviceæä¾›æœåŠ¡.&lt;/p>
&lt;p>kubernetesç‰ˆæœ¬v1.9.1+a0ce1bc657.&lt;/p>
&lt;h3 id="é—®é¢˜">é—®é¢˜:&lt;/h3>
&lt;p>é…ç½®å¦‚ä¸‹:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">location ^~/info {
proxy_pass: http://serviceName:port;
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ é™¤å¹¶é‡å»ºServiceçš„æ—¶å€™, nginxä¼šå‡ºçŽ°ä¸‹é¢çš„é—®é¢˜:&lt;/p>
&lt;blockquote>
&lt;p>connect() failed (113: No route to host) &amp;hellip; upstream: &amp;ldquo;xxxxx&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;h3 id="åˆ†æž">åˆ†æž&lt;/h3>
&lt;p>é€šè¿‡googleå‘çŽ°, æ˜¯nginxçš„dnsè§£æžæ–¹æ¡ˆçš„é—®é¢˜.&lt;/p>
&lt;p>nginxå®˜æ–¹çš„è¯´æ˜Ž:&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>If the domain name canâ€™t be resolved, NGINX fails to start or reload its configuration.&lt;/li>
&lt;li>NGINX caches the DNS records until the next restart or configuration reload, ignoring the recordsâ€™ TTL values.&lt;/li>
&lt;li>We canâ€™t specify another loadâ€‘balancing algorithm, nor can we configure passive health checks or other features defined by parameters to the server directive, which weâ€™ll describe in the next section.&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>æ„æ€æ˜¯è¯´, nginxåœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šè§£æž&lt;code>proxy_pass&lt;/code>åŽçš„åŸŸå, å¹¶æŠŠ&lt;code>ip&lt;/code>ç¼“å­˜ä¸‹æ¥, è€Œä¸”æ²¡æœ‰TTL. åªæœ‰åœ¨restartæˆ–è€…reloadçš„æ—¶å€™æ‰ä¼šå†æ¬¡è§£æž.&lt;/p>
&lt;h3 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ&lt;/h3>
&lt;p>ä½¿ç”¨nginx podçš„è§£æžæœåŠ¡å™¨ä½œä¸ºresolver:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">#nginx conf
resolver NAME_SERVER valid=30s ipv6=off;
set $service &amp;#34;http://serviceName:port&amp;#34;;
location ^~/info {
proxy_pass: $service;
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨shellèŽ·å–podä¸­ä½¿ç”¨çš„è§£æžæœåŠ¡å™¨&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">NAME_SERVER&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>cat /etc/resolv.conf &lt;span class="p">|&lt;/span> grep &lt;span class="s2">&amp;#34;nameserver&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> tr &lt;span class="s1">&amp;#39;\n&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="sb">`&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‚è€ƒ:
&lt;a href="https://stackoverflow.com/questions/17685674/nginx-proxy-pass-with-remote-addr">Nginx proxy_pass with $remote_addr&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://tenzer.dk/nginx-with-dynamic-upstreams/">Nginx with dynamic upstreams&lt;/a>&lt;/p>
&lt;h3 id="å¦ä¸€ä¸ªé—®é¢˜">å¦ä¸€ä¸ªé—®é¢˜&lt;/h3>
&lt;blockquote>
&lt;p>serviceName could not be resolved (3: Host not found)&lt;/p>
&lt;/blockquote>
&lt;p>serviceçš„çŸ­åç§°æ˜¯è§£æžä¸äº†çš„, éœ€è¦ä½¿ç”¨serviceName.namespace.svc.clusterName.&lt;/p></description></item><item><title>Kubernetes â€” æŒä¹…å·</title><link>https://atbug.com/kubernetes-persistent-volumes/</link><pubDate>Sun, 20 Aug 2017 22:25:40 +0000</pubDate><guid>https://atbug.com/kubernetes-persistent-volumes/</guid><description>
&lt;h1 id="persistent-volume">Persistent Volume&lt;/h1>
&lt;p>è¯‘è‡ª&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Persistent Volumes&lt;/a>&lt;/p>
&lt;h2 id="ä»‹ç»">ä»‹ç»&lt;/h2>
&lt;p>ç®¡ç†å­˜å‚¨æ˜¯ç®¡ç†è®¡ç®—çš„ç‹¬ç‰¹é—®é¢˜ã€‚ PersistentVolumeå­ç³»ç»Ÿä¸ºç”¨æˆ·å’Œç®¡ç†å‘˜æä¾›äº†ä¸€ä¸ªAPIï¼Œå…¶ä¸­æä¾›äº†å¦‚ä½•ä»Žå¦‚ä½•ä½¿ç”¨å­˜å‚¨æä¾›å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä»‹ç»ä¸¤ç§æ–°çš„APIèµ„æºï¼šPersistentVolumeå’ŒPersistentVolumeClaimã€‚&lt;/p>
&lt;p>PersistentVolumeï¼ˆPVï¼‰æ˜¯ç”±ç®¡ç†å‘˜é…ç½®çš„é›†ç¾¤ä¸­çš„ä¸€æ®µå­˜å‚¨ã€‚å®ƒæ˜¯é›†ç¾¤ä¸­çš„ä¸€ç§èµ„æºå°±åƒä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªé›†ç¾¤çš„èµ„æºã€‚ PVæ˜¯ç±»ä¼¼Volumesçš„å·æ’ä»¶ï¼Œä½†æ˜¯å…·æœ‰ç‹¬ç«‹äºŽä½¿ç”¨PVçš„ä»»ä½•å•ä¸ªpodçš„ç”Ÿå‘½å‘¨æœŸã€‚è¯¥APIå¯¹è±¡æ•èŽ·å­˜å‚¨çš„å®žçŽ°ç»†èŠ‚ï¼Œå³NFSï¼ŒiSCSIæˆ–äº‘æä¾›å•†ç‰¹å®šçš„å­˜å‚¨ç³»ç»Ÿã€‚&lt;/p>
&lt;p>PersistentVolumeClaimï¼ˆPVCï¼‰æ˜¯ç”¨æˆ·å­˜å‚¨çš„è¯·æ±‚ã€‚å®ƒç±»ä¼¼äºŽpodã€‚ Podæ¶ˆè€—èŠ‚ç‚¹èµ„æºï¼ŒPVCæ¶ˆè€—PVèµ„æºã€‚Podså¯ä»¥è¯·æ±‚ç‰¹å®šçº§åˆ«çš„èµ„æºï¼ˆCPUå’Œå†…å­˜ï¼‰ã€‚å£°æ˜Žå¯ä»¥è¯·æ±‚ç‰¹å®šçš„å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼ˆä¾‹å¦‚ï¼Œä¸€æ¬¡è¯»å†™æˆ–è€…å¤šæ¬¡åªè¯»ï¼‰ã€‚&lt;/p>
&lt;p>è™½ç„¶PersistentVolumeClaimså…è®¸ç”¨æˆ·ä½¿ç”¨æŠ½è±¡å­˜å‚¨èµ„æºï¼Œä½†æ˜¯å¸¸è§çš„æ˜¯ï¼Œç”¨æˆ·éœ€è¦å…·æœ‰ä¸åŒå±žæ€§ï¼ˆå¦‚æ€§èƒ½ï¼‰çš„PersistentVolumesï¼Œç”¨äºŽä¸åŒçš„é—®é¢˜ã€‚ é›†ç¾¤ç®¡ç†å‘˜éœ€è¦èƒ½å¤Ÿæä¾›å¤šç§å½¼æ­¤ä¸åŒçš„PersistentVolumesï¼Œè€Œä¸ä»…ä»…æ˜¯å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼Œè€Œä¸ä¼šä½¿ç”¨æˆ·äº†è§£è¿™äº›å·çš„å®žçŽ°ç»†èŠ‚ã€‚ å¯¹äºŽè¿™äº›éœ€æ±‚ï¼Œæœ‰ä¸€ä¸ªStorageClassèµ„æºã€‚&lt;/p>
&lt;p>StorageClassä¸ºç®¡ç†å‘˜æä¾›äº†ä¸€ç§æè¿°ä»–ä»¬æä¾›çš„å­˜å‚¨çš„â€œç±»â€çš„æ–¹æ³•ã€‚ ä¸åŒçš„ç±»å¯èƒ½æ˜ å°„åˆ°æœåŠ¡è´¨é‡çº§åˆ«ï¼Œæˆ–å¤‡ä»½ç­–ç•¥ï¼Œæˆ–è€…ç”±ç¾¤é›†ç®¡ç†å‘˜ç¡®å®šçš„ä»»æ„ç­–ç•¥ã€‚ Kubernetesæœ¬èº«å¯¹äºŽä»€ä¹ˆç±»åˆ«ä»£è¡¨æ˜¯ä¸è¨€è€Œå–»çš„ã€‚ è¿™ä¸ªæ¦‚å¿µæœ‰æ—¶åœ¨å…¶ä»–å­˜å‚¨ç³»ç»Ÿä¸­ç§°ä¸ºâ€œé…ç½®æ–‡ä»¶â€ã€‚&lt;/p>
&lt;p>è¯·å‚é˜…&lt;a href="https://kubernetes.io/docs/user-guide/persistent-volumes/walkthrough/">è¯¦ç»†æ¼”ç»ƒä¸Žå·¥ä½œç¤ºä¾‹&lt;/a>ã€‚&lt;/p>
&lt;h2 id="å­˜å‚¨å’Œå£°æ˜Žçš„ç”Ÿå‘½å‘¨æœŸ">å­˜å‚¨å’Œå£°æ˜Žçš„ç”Ÿå‘½å‘¨æœŸ&lt;/h2>
&lt;p>PVsæ˜¯é›†ç¾¤ä¸­çš„èµ„æºï¼›PVCsæ˜¯å¯¹è¿™ç§èµ„æºçš„å£°æ˜Žï¼ŒåŒæ—¶ä¹Ÿæ‰®æ¼”è€…å¯¹èµ„æºå£°æ˜Žçš„æ£€æŸ¥ã€‚PVså’ŒPVCsä¹‹å‰çš„äº¤äº’éµå¾ªç”Ÿå‘½å‘¨æœŸï¼šä¾›åº”ã€ç»‘å®šã€ä½¿ç”¨ä¸­ã€é‡æ–°ç”³è¯·ã€‚&lt;/p>
&lt;p>é›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºå¤šä¸ªPVã€‚å®ƒä»¬æºå¸¦å¯ä¾›é›†ç¾¤ç”¨æˆ·ä½¿ç”¨çš„çœŸå®žå­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚å®ƒä»¬å­˜åœ¨äºŽKubernetes APIä¸­ï¼Œå¯ç”¨äºŽæ¶ˆè´¹ã€‚&lt;/p>
&lt;h3 id="ä¾›åº”provisioning">ä¾›åº”(Provisioning)&lt;/h3>
&lt;p>PVsä¼šä»¥ä¸¤ç§æ–¹å¼ä¾›åº”ï¼šé™æ€å’ŒåŠ¨æ€ã€‚&lt;/p>
&lt;h4 id="é™æ€">é™æ€&lt;/h4>
&lt;p>é›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºå¤šä¸ªPVã€‚ å®ƒä»¬æºå¸¦å¯ä¾›é›†ç¾¤ç”¨æˆ·ä½¿ç”¨çš„çœŸå®žå­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚ å®ƒä»¬å­˜åœ¨äºŽKubernetes APIä¸­ï¼Œå¯è¢«ä½¿ç”¨ã€‚&lt;/p>
&lt;h4 id="åŠ¨æ€">åŠ¨æ€&lt;/h4>
&lt;p>å½“ç®¡ç†å‘˜åˆ›å»ºçš„é™æ€PVéƒ½ä¸åŒ¹é…ç”¨æˆ·çš„PersistentVolumeClaimæ—¶ï¼Œé›†ç¾¤å¯èƒ½ä¼šå°è¯•ä¸ºPVCæŒ‡å®šåŠ¨æ€é…ç½®å·ã€‚ æ­¤é…ç½®åŸºäºŽStorageClassesï¼šPVCå¿…é¡»æŒ‡å®šä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ç®¡ç†å‘˜å¿…é¡»å·²åˆ›å»ºå¹¶é…ç½®è¯¥ç±»æ‰èƒ½è¿›è¡ŒåŠ¨æ€é…ç½®ã€‚ è¦æ±‚è¯¥ç±»çš„å£°æ˜Žæœ‰æ•ˆåœ°ä¸ºè‡ªå·±ç¦ç”¨åŠ¨æ€é…ç½®ã€‚&lt;/p>
&lt;h3 id="ç»‘å®šbinding">ç»‘å®š(Binding)&lt;/h3>
&lt;p>å½“ç”¨æˆ·åˆ›å»ºã€æˆ–å·²ç»åˆ›å»ºäº†ä¸€ä¸ªPersistenVolumenClaimå¹¶æŒ‡å®šå¤§å°å’Œè®¿é—®ç±»åž‹ã€‚Masterä¸­çš„æŽ§åˆ¶å¾ªçŽ¯ä¼šæ£€æµ‹æ–°çš„PVCï¼Œæ‰¾åˆ°ä¸€ä¸ªåŒ¹é…çš„PVï¼ˆå¦‚æžœå¯èƒ½çš„è¯ï¼‰ï¼Œå¹¶å°†å®ƒä»¬ç»‘å®šåœ¨ä¸€èµ·ã€‚å¦‚æžœä¸€ä¸ªPVè¢«åŠ¨æ€åœ°ä¾›åº”æŸä¸ªPVCï¼Œå¾ªçŽ¯å°†æ€»æ˜¯æŠŠè¿™ä¸ªPVå’Œè¯¥PVCç»‘å®šã€‚å¦åˆ™ï¼Œç”¨æˆ·æ€»æ˜¯è‡³å°‘å¾—åˆ°ä»–ä»¬è¦æ±‚çš„å†…å®¹ï¼Œä½†æ˜¯å·å¯èƒ½è¶…å‡ºäº†è¦æ±‚ã€‚ä¸€æ—¦ç»‘å®šï¼ŒPersistentVolumeClaimç»‘å®šæ˜¯æŽ’ä»–çš„ï¼Œä¸ç®¡ç”¨äºŽç»‘å®šå®ƒä»¬çš„æ¨¡å¼ã€‚&lt;/p>
&lt;p>å¦‚æžœåŒ¹é…çš„å·ä¸å­˜åœ¨ï¼Œè¯·æ±‚å°†æ— é™æœŸåœ°ä¿æŒã€‚ éšç€åŒ¹é…å·å˜å¾—å¯ç”¨ï¼Œè¯·æ±‚å°†è¢«ç»‘å®šã€‚ ä¾‹å¦‚ï¼Œæä¾›è®¸å¤š50Gi PVçš„é›†ç¾¤å°†ä¸åŒ¹é…è¦æ±‚100Giçš„PVCã€‚ å½“é›†ç¾¤ä¸­æ·»åŠ 100Gi PVæ—¶ï¼Œå¯ä»¥ç»‘å®šPVCã€‚&lt;/p>
&lt;h3 id="ä½¿ç”¨ä½¿ç”¨">ä½¿ç”¨(ä½¿ç”¨)&lt;/h3>
&lt;p>PODsæŠŠPVCå½“åšvolumeä½¿ç”¨ã€‚é›†ç¾¤æ£€æŸ¥å£°æ˜Žä»¥æ‰¾åˆ°ç»‘å®šçš„å·å¹¶ä¸ºPODæŒ‚è½½è¯¥å·ã€‚ å¯¹äºŽæ”¯æŒå¤šç§è®¿é—®æ¨¡å¼çš„å·ï¼Œç”¨æˆ·åœ¨å°†å…¶å£°æ˜Žç”¨ä½œpodä¸­çš„å·æ—¶æŒ‡å®šæ‰€éœ€çš„æ¨¡å¼ã€‚&lt;/p>
&lt;p>ä¸€æ—¦ç”¨æˆ·æœ‰å£°æ˜Žå¹¶ä¸”è¯¥å£°æ˜Žè¢«ç»‘å®šï¼Œç»‘å®šçš„PVå±žäºŽç”¨æˆ·ï¼Œåªè¦ä»–ä»¬éœ€è¦å®ƒã€‚ ç”¨æˆ·é€šè¿‡åœ¨å…¶Podçš„å·å—ä¸­åŒ…å«persistentVolumeClaimæ¥å®‰æŽ’Podså¹¶è®¿é—®å…¶å£°æ˜Žçš„PVã€‚ è¯·å‚é˜…ä¸‹é¢çš„è¯­æ³•è¯¦ç»†ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myfrontend&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dockerfile/nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/var/www/html&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeClaim&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">claimName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myclaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å›žæ”¶reclaiming">å›žæ”¶(Reclaiming)&lt;/h3>
&lt;p>å½“ç”¨æˆ·ä½¿ç”¨å®Œvolumeï¼Œå¯ä»¥é€šè¿‡è¯·æ±‚å…è®¸å›žæ”¶èµ„æºçš„APIæ¥åˆ é™¤è¯¥PVCå¯¹è±¡ã€‚PersistentVolumeçš„å›žæ”¶ç­–ç•¥å‘Šè¯‰é›†ç¾¤å¦‚ä½•å¤„ç†å½“å£°æ˜Žé‡Šæ”¾PVåŽã€‚ç›®å‰ï¼Œå·å¯ä»¥è¢«ä¿ç•™ï¼Œå›žæ”¶æˆ–åˆ é™¤ã€‚&lt;/p>
&lt;h4 id="ä¿ç•™retaining">ä¿ç•™(Retaining)&lt;/h4>
&lt;p>ä¿ç•™å›žæ”¶ç­–ç•¥å…è®¸æ‰‹åŠ¨å›žæ”¶èµ„æºã€‚ å½“PersistentVolumeClaimè¢«åˆ é™¤æ—¶ï¼ŒPersistentVolumeä»ç„¶å­˜åœ¨ï¼Œå¹¶ä¸”è¯¥å·è¢«è®¤ä¸ºæ˜¯â€œé‡Šæ”¾çš„â€ã€‚ ä½†æ˜¯ï¼Œç”±äºŽä¸Šä¸€ä¸ªå£°æ˜Žè€…çš„æ•°æ®ä»ä¿ç•™åœ¨å·ä¸Šï¼Œå› æ­¤å°šä¸å¯ç”¨äºŽå…¶ä»–å£°æ˜Žã€‚ ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨å›žæ”¶å·ã€‚&lt;/p>
&lt;ul>
&lt;li>åˆ é™¤PersistentVolumeã€‚ åˆ é™¤PVåŽï¼Œå¤–éƒ¨åŸºç¡€è®¾æ–½ï¼ˆå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–Cinderå·ï¼‰ä¸­çš„å…³è”å­˜å‚¨èµ„äº§ä»ç„¶å­˜åœ¨ã€‚&lt;/li>
&lt;li>ç›¸åº”åœ°æ‰‹åŠ¨æ¸…ç†ç›¸å…³å­˜å‚¨èµ„äº§ä¸Šçš„æ•°æ®ã€‚&lt;/li>
&lt;li>æ‰‹åŠ¨åˆ é™¤å…³è”çš„å­˜å‚¨èµ„äº§ï¼Œæˆ–è€…å¦‚æžœè¦é‡ç”¨ç›¸åŒçš„å­˜å‚¨èµ„äº§ï¼Œè¯·ä½¿ç”¨å­˜å‚¨èµ„äº§å®šä¹‰åˆ›å»ºä¸€ä¸ªæ–°çš„PersistentVolumeã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="å›žæ”¶recycling">å›žæ”¶(Recycling)&lt;/h4>
&lt;p>å¦‚æžœå—ç›¸åº”çš„å·æ’ä»¶æ”¯æŒï¼Œå›žæ”¶å°†å¯¹å·æ‰§è¡ŒåŸºæœ¬çš„æ“¦é™¤ï¼ˆrm -rf / thevolume / *ï¼‰ï¼Œå¹¶ä½¿å…¶å†æ¬¡å¯ç”¨äºŽæ–°çš„å£°æ˜Žã€‚
ä½†æ˜¯ï¼Œç®¡ç†å‘˜å¯ä»¥ä½¿ç”¨KubernetesæŽ§åˆ¶å™¨ç®¡ç†å™¨å‘½ä»¤è¡Œå‚æ•°æ¥é…ç½®è‡ªå®šä¹‰çš„å›žæ”¶å™¨podæ¨¡æ¿ï¼Œå¦‚&lt;a href="https://kubernetes.io/docs/admin/kube-controller-manager/">è¿™é‡Œ&lt;/a>æ‰€è¿°ã€‚ å®šåˆ¶å›žæ”¶ç«™æ¨¡æ¿å¿…é¡»åŒ…å«å·è§„èŒƒï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pv-recycler-&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Never&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">vol&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/any/path/it/will/be/replaced&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pv-recycler&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;gcr.io/google_containers/busybox&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/bin/sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;-c&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;test -e /scrub &amp;amp;&amp;amp; rm -rf /scrub/..?* /scrub/.[!.]* /scrub/* &amp;amp;&amp;amp; test -z \&amp;#34;$(ls -A /scrub)\&amp;#34; || exit 1&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">vol&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/scrub&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯ï¼Œå·éƒ¨åˆ†ä¸­çš„è‡ªå®šä¹‰å›žæ”¶å™¨podæ¨¡æ¿ä¸­æŒ‡å®šçš„ç‰¹å®šè·¯å¾„å°†æ›¿æ¢ä¸ºæ­£åœ¨å›žæ”¶çš„å·çš„ç‰¹å®šè·¯å¾„ã€‚&lt;/p>
&lt;h4 id="åˆ é™¤deleting">åˆ é™¤(Deleting)&lt;/h4>
&lt;p>å¯¹äºŽæ”¯æŒâ€œåˆ é™¤å›žæ”¶â€ç­–ç•¥çš„å·æ’ä»¶ï¼Œåˆ é™¤å°†ä»ŽKubernetesä¸­åˆ é™¤PersistentVolumeå¯¹è±¡ï¼Œå¹¶åˆ é™¤å¤–éƒ¨åŸºç¡€æž¶æž„ï¼ˆå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–Cinderå·ï¼‰ä¸­å…³è”çš„å­˜å‚¨èµ„äº§ã€‚ åŠ¨æ€é…ç½®çš„å·å§‹ç»ˆè¢«åˆ é™¤ã€‚ å¦‚æžœä¸å¸Œæœ›è¿™æ ·åšï¼Œç›®å‰å”¯ä¸€çš„é€‰æ‹©æ˜¯åœ¨åˆ›å»ºPVä¹‹åŽç¼–è¾‘æˆ–ä¿®è¡¥PVã€‚ è¯·å‚é˜…&lt;a href="https://kubernetes.io/docs/tasks/administer-cluster/change-pv-reclaim-policy/">æ›´æ”¹PersistentVolumeçš„å›žæ”¶ç­–ç•¥&lt;/a>ã€‚&lt;/p>
&lt;h3 id="persistent-volumeçš„ç±»åž‹">Persistent Volumeçš„ç±»åž‹&lt;/h3>
&lt;ul>
&lt;li>GCEPersistentDisk&lt;/li>
&lt;li>AWSElasticBlockStore&lt;/li>
&lt;li>AzureFile&lt;/li>
&lt;li>AzureDisk&lt;/li>
&lt;li>FC (Fibre Channel)&lt;/li>
&lt;li>FlexVolume&lt;/li>
&lt;li>Flocker&lt;/li>
&lt;li>NFS&lt;/li>
&lt;li>iSCSI&lt;/li>
&lt;li>RBD (Ceph Block Device)&lt;/li>
&lt;li>CephFS&lt;/li>
&lt;li>Cinder (OpenStack block storage)&lt;/li>
&lt;li>Glusterfs&lt;/li>
&lt;li>VsphereVolume&lt;/li>
&lt;li>Quobyte Volumes&lt;/li>
&lt;li>HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)&lt;/li>
&lt;li>VMware Photon&lt;/li>
&lt;li>Portworx Volumes&lt;/li>
&lt;li>ScaleIO Volumes&lt;/li>
&lt;li>StorageOS&lt;/li>
&lt;/ul>
&lt;h2 id="persistent-volumes">Persistent Volumes&lt;/h2>
&lt;p>æ¯ä¸ªPVéƒ½åŒ…å«è§„æ ¼å’ŒçŠ¶æ€ï¼Œè¿™æ˜¯è§„æ ¼å’ŒçŠ¶æ€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolume&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pv0003&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">capacity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">5Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeReclaimPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Recycle&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">slow&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">nfs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/tmp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">172.17.0.2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®¹é‡">å®¹é‡&lt;/h3>
&lt;p>é€šå¸¸ï¼ŒPVå°†å…·æœ‰ç‰¹å®šçš„å­˜å‚¨å®¹é‡ã€‚è¿™æ˜¯ä½¿ç”¨PVçš„&lt;code>capacity&lt;/code>å±žæ€§è®¾ç½®çš„ã€‚çœ‹åˆ°Kubernetesçš„&lt;a href="https://git.k8s.io/community/contributors/design-proposals/resources.md">èµ„æºæ¨¡åž‹&lt;/a>ï¼Œä»¥äº†è§£å®¹é‡ä½¿ç”¨çš„å•ä½ã€‚&lt;/p>
&lt;p>ç›®å‰ï¼Œå­˜å‚¨å¤§å°æ˜¯å”¯ä¸€å¯ä»¥è®¾ç½®æˆ–è¯·æ±‚çš„èµ„æºã€‚æœªæ¥çš„å±žæ€§å¯èƒ½åŒ…æ‹¬IOPSï¼Œåžåé‡ç­‰ã€‚&lt;/p>
&lt;h3 id="è®¿é—®æ¨¡å¼">è®¿é—®æ¨¡å¼&lt;/h3>
&lt;p>PersistentVolumeå¯ä»¥ä»¥èµ„æºæä¾›è€…æ”¯æŒçš„ä»»ä½•æ–¹å¼å®‰è£…åœ¨ä¸»æœºä¸Šã€‚ å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œæä¾›è€…å°†å…·æœ‰ä¸åŒçš„ç‰¹æ€§ï¼Œæ¯ä¸ªPVçš„è®¿é—®æ¨¡å¼éƒ½è¢«è®¾ç½®ä¸ºè¯¥ç‰¹å®šå·æ”¯æŒçš„ç‰¹å®šæ¨¡å¼ã€‚ ä¾‹å¦‚ï¼ŒNFSå¯ä»¥æ”¯æŒå¤šä¸ªè¯»/å†™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯ç‰¹å®šçš„NFS PVå¯èƒ½ä¼šä»¥åªè¯»æ–¹å¼åœ¨æœåŠ¡å™¨ä¸Šå¯¼å‡ºã€‚ æ¯ä¸ªPVéƒ½æœ‰è‡ªå·±çš„ä¸€ç»„è®¿é—®æ¨¡å¼æ¥æè¿°å…·ä½“çš„PVåŠŸèƒ½ã€‚&lt;/p>
&lt;p>è®¿é—®æ¨¡å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>ReadWriteOnce - å·å¯ä»¥ç”±å•ä¸ªèŠ‚ç‚¹ä½œä¸ºè¯»å†™è£…è½½&lt;/li>
&lt;li>ReadOnlyMany - è®¸å¤šèŠ‚ç‚¹å¯ä»¥åªè¯»å®¹é‡&lt;/li>
&lt;li>ReadWriteMany - å·å¯ä»¥é€šè¿‡è®¸å¤šèŠ‚ç‚¹çš„è¯»å†™è£…è½½&lt;/li>
&lt;/ul>
&lt;p>åœ¨CLIä¸­ï¼Œè®¿é—®æ¨¡å¼ç¼©å†™ä¸ºï¼š&lt;/p>
&lt;ul>
&lt;li>RWO - ReadWriteOnce&lt;/li>
&lt;li>ROX - ReadOnlyMany&lt;/li>
&lt;li>RWX - ReadWriteMany&lt;/li>
&lt;/ul>
&lt;p>é‡è¦ï¼ä¸€ä¸ªå·åªèƒ½ä¸€æ¬¡ä½¿ç”¨ä¸€ç§è®¿é—®æ¨¡å¼è¿›è¡ŒæŒ‚è½½ï¼Œå³ä½¿å®ƒæ”¯æŒå¾ˆå¤šã€‚ä¾‹å¦‚ï¼ŒGCEPersistentDiskå¯ä»¥ç”±å•ä¸ªèŠ‚ç‚¹æŒ‚è½½ä¸ºReadWriteOnceæˆ–å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½ä¸ºReadOnlyManyï¼Œä½†ä¸èƒ½åŒæ—¶ä½¿ç”¨ä¸¤ç§ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Volumeæ’ä»¶&lt;/th>
&lt;th>å•èŠ‚ç‚¹è¯»å†™&lt;/th>
&lt;th>å¤šä¸ªèŠ‚ç‚¹åªè¯»&lt;/th>
&lt;th>å¤šä¸ªèŠ‚ç‚¹è¯»å†™&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>AWSElasticBlockStore&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AzureFile&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AzureDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>CephFS&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Cinder&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>FC&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>FlexVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Flocker&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GCEPersistentDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Glusterfs&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>HostPath&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>iSCSI&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PhotonPersistentDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Quobyte&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>NFS&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>RBD&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>VsphereVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PortworxVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ScaleIO&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>StorageOS&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="ç±»åž‹">ç±»åž‹&lt;/h3>
&lt;p>PVå¯ä»¥æœ‰ä¸€ä¸ªç±»åž‹ï¼Œé€šè¿‡å°†storageClassNameå±žæ€§è®¾ç½®ä¸ºStorageClassçš„åç§°æ¥æŒ‡å®šã€‚ ç‰¹å®šç±»åž‹çš„PVåªèƒ½ç»‘å®šåˆ°è¯·æ±‚è¯¥ç±»åž‹çš„PVCã€‚ æ²¡æœ‰storageClassNameçš„PVæ²¡æœ‰ç±»åž‹ï¼Œåªèƒ½ç»‘å®šåˆ°ä¸éœ€è¦ç‰¹å®šç±»åž‹çš„PVCã€‚
åœ¨è¿‡åŽ»ï¼Œä½¿ç”¨äº†æ³¨é‡Švolume.beta.kubernetes.io/storage-classè€Œä¸æ˜¯storageClassNameå±žæ€§ã€‚ è¯¥æ³¨é‡Šä»ç„¶å¯ä»¥å·¥ä½œï¼Œä½†å°†æ¥Kubernetesç‰ˆæœ¬å°†ä¸å†é€‚ç”¨ã€‚&lt;/p>
&lt;h3 id="å›žæ”¶ç­–ç•¥">å›žæ”¶ç­–ç•¥&lt;/h3>
&lt;p>ç›®å‰çš„å›žæ”¶ç­–ç•¥æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>Retain - æ‰‹åŠ¨å›žæ”¶&lt;/li>
&lt;li>Recycle - åŸºæœ¬æ“¦æ´—ï¼ˆâ€œrm -rf / thevolume / *â€ï¼‰&lt;/li>
&lt;li>Delete - ç›¸å…³è”çš„å­˜å‚¨èµ„äº§ï¼Œå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–OpenStack Cinderå·è¢«åˆ é™¤&lt;/li>
&lt;/ul>
&lt;p>ç›®å‰ï¼Œåªæœ‰NFSå’ŒHostPathæ”¯æŒå›žæ”¶ã€‚ AWS EBSï¼ŒGCE PDï¼ŒAzure Diskå’ŒCinderå·æ”¯æŒåˆ é™¤ã€‚&lt;/p>
&lt;h3 id="é˜¶æ®µ">é˜¶æ®µ&lt;/h3>
&lt;p>å·å°†å¤„äºŽä»¥ä¸‹é˜¶æ®µä¹‹ä¸€ï¼š&lt;/p>
&lt;ul>
&lt;li>Available å¯ç”¨ - ä¸€ä¸ªå°šæœªç»‘å®šåˆ°ç´¢èµ”çš„å…è´¹èµ„æº&lt;/li>
&lt;li>Bound ç»‘å®š - éŸ³é‡å¿…é¡»æ˜¯å£°æ˜Ž&lt;/li>
&lt;li>Released é‡Šæ”¾ - å£°æ˜Žå·²è¢«åˆ é™¤ï¼Œä½†èµ„æºå°šæœªè¢«é›†ç¾¤å›žæ”¶&lt;/li>
&lt;li>Failed å¤±è´¥ - å·è‡ªåŠ¨å›žæ”¶å¤±è´¥&lt;/li>
&lt;/ul>
&lt;p>CLIå°†æ˜¾ç¤ºç»‘å®šåˆ°PVçš„PVCçš„åç§°ã€‚&lt;/p>
&lt;h3 id="æŒ‚è½½é€‰é¡¹">æŒ‚è½½é€‰é¡¹&lt;/h3>
&lt;p>Kubernetesç®¡ç†å‘˜å¯ä»¥æŒ‡å®šåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸ŠæŒ‚è½½ä¸€ä¸ªæŒä¹…å·æ—¶çš„å…¶ä»–æŒ‚è½½é€‰é¡¹ã€‚&lt;/p>
&lt;p>æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨æŒä¹…å·ä¸Šçš„æ³¨é‡Švolume.beta.kubernetes.io/mount-optionsæ¥æŒ‡å®šå®‰è£…é€‰é¡¹ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;v1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;PersistentVolume&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gce-disk-1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volume.beta.kubernetes.io/mount-options&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;discard&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">capacity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;10Gi&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;ReadWriteOnce&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">gcePersistentDisk&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fsType&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;ext4&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">pdName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;gce-disk-1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®‰è£…é€‰é¡¹æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨å°†å·å®‰è£…åˆ°ç£ç›˜æ—¶å°†è¢«ç´¯ç§¯åœ°è¿žæŽ¥å’Œä½¿ç”¨ã€‚&lt;/p>
&lt;p>è¯·æ³¨æ„ï¼Œå¹¶éžæ‰€æœ‰Persistentå·ç±»åž‹éƒ½æ”¯æŒæŒ‚è½½é€‰é¡¹ã€‚ åœ¨Kubernetes 1.6ç‰ˆä¸­ï¼Œä»¥ä¸‹å·ç±»åž‹æ”¯æŒæŒ‚è½½é€‰é¡¹ã€‚&lt;/p>
&lt;ul>
&lt;li>GCEPersistentDisk&lt;/li>
&lt;li>AWSElasticBlockStore&lt;/li>
&lt;li>AzureFile&lt;/li>
&lt;li>AzureDisk&lt;/li>
&lt;li>NFS&lt;/li>
&lt;li>iSCSI&lt;/li>
&lt;li>RBD (Ceph Block Device)&lt;/li>
&lt;li>CephFS&lt;/li>
&lt;li>Cinder (OpenStack block storage)&lt;/li>
&lt;li>Glusterfs&lt;/li>
&lt;li>VsphereVolume&lt;/li>
&lt;li>Quobyte Volumes&lt;/li>
&lt;li>VMware Photon&lt;/li>
&lt;/ul>
&lt;h2 id="persistentvolumeclaims">PersistentVolumeClaims&lt;/h2>
&lt;p>æ¯ä¸ªPVCåŒ…å«è§„æ ¼å’ŒçŠ¶æ€ï¼Œè¿™æ˜¯å£°æ˜Žçš„è§„èŒƒå’ŒçŠ¶æ€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolumeClaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myclaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">8Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">slow&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">release&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;stable&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- {&lt;span class="nt">key: environment, operator: In, values&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="l">dev]}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è®¿é—®æ¨¡å¼-1">è®¿é—®æ¨¡å¼&lt;/h3>
&lt;p>å½“è¯·æ±‚å…·æœ‰ç‰¹å®šè®¿é—®æ¨¡å¼çš„å­˜å‚¨æ—¶ï¼Œå£°æ˜Žä½¿ç”¨ä¸Žå·ç›¸åŒçš„çº¦å®šã€‚&lt;/p>
&lt;h3 id="èµ„æº">èµ„æº&lt;/h3>
&lt;p>å£°æ˜Žï¼ˆå°±åƒpodsï¼‰å¯ä»¥è¯·æ±‚ç‰¹å®šæ•°é‡çš„èµ„æºã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·æ±‚ç”¨äºŽå­˜å‚¨ã€‚ ç›¸åŒçš„èµ„æºæ¨¡åž‹é€‚ç”¨äºŽå·å’Œå£°æ˜Žã€‚&lt;/p>
&lt;h3 id="é€‰æ‹©å™¨">é€‰æ‹©å™¨&lt;/h3>
&lt;p>å£°æ˜Žå¯ä»¥æŒ‡å®šæ ‡ç­¾é€‰æ‹©å™¨ä»¥è¿›ä¸€æ­¥è¿‡æ»¤Volumesé›†ã€‚ åªæœ‰æ ‡ç­¾ä¸Žé€‰æ‹©å™¨åŒ¹é…çš„å·æ‰èƒ½ç»‘å®šåˆ°å£°æ˜Žã€‚ é€‰æ‹©å™¨å¯ä»¥ç”±ä¸¤ä¸ªå­—æ®µç»„æˆï¼š&lt;/p>
&lt;ul>
&lt;li>matchLabels - å·å¿…é¡»å…·æœ‰å¸¦æ­¤å€¼çš„æ ‡ç­¾&lt;/li>
&lt;li>matchExpressions - é€šè¿‡æŒ‡å®šå…³é”®å­—å’Œå€¼çš„å…³é”®å­—ï¼Œå€¼åˆ—è¡¨å’Œè¿ç®—ç¬¦æ‰€åšçš„è¦æ±‚åˆ—è¡¨ã€‚ æœ‰æ•ˆè¿ç®—ç¬¦åŒ…æ‹¬Inï¼ŒNotInï¼ŒExistså’ŒDoesNotExistã€‚&lt;/li>
&lt;/ul>
&lt;p>æ‰€æœ‰æ¥è‡ªmatchLabelså’ŒmatchExpressionsçš„è¦æ±‚æ˜¯ç»„åˆåœ¨ä¸€èµ·çš„ï¼Œæ‰€æœ‰è¿™äº›è¦æ±‚éƒ½å¿…é¡»æ»¡è¶³æ‰èƒ½åŒ¹é…ã€‚&lt;/p>
&lt;h3 id="ç±»åž‹-1">ç±»åž‹&lt;/h3>
&lt;p>å£°æ˜Žå¯ä»¥é€šè¿‡ä½¿ç”¨å±žæ€§storageClassNameæŒ‡å®šStorageClassçš„åç§°æ¥è¯·æ±‚ç‰¹å®šçš„ç±»åž‹ã€‚åªæœ‰æ‰€è¯·æ±‚çš„ç±»åž‹çš„PVï¼Œä¸ŽPVCç›¸åŒçš„storageClassNameçš„PVå¯ä»¥ç»‘å®šåˆ°PVCã€‚&lt;/p>
&lt;p>PVCä¸ä¸€å®šè¦æ±‚ä¸€ä¸ªç±»åž‹ã€‚ å®ƒçš„storageClassNameè®¾ç½®ä¸ºç­‰äºŽâ€œâ€çš„PVCæ€»æ˜¯è¢«è§£é‡Šä¸ºè¯·æ±‚æ²¡æœ‰ç±»åž‹çš„PVï¼Œå› æ­¤å®ƒåªèƒ½ç»‘å®šåˆ°æ²¡æœ‰ç±»åž‹çš„PVï¼ˆæ²¡æœ‰æ³¨é‡Šæˆ–ä¸€ä¸ªç­‰äºŽâ€œâ€ï¼‰ã€‚ æ²¡æœ‰storageClassNameçš„PVCä¸å®Œå…¨ç›¸åŒï¼Œå¹¶ä¸”æ ¹æ®æ˜¯å¦å¯ç”¨äº†DefaultStorageClass admissionæ’ä»¶ï¼Œé›†ç¾¤çš„å¤„ç†æ–¹å¼ä¸åŒã€‚&lt;/p>
&lt;ul>
&lt;li>å¦‚æžœadmissionæ’ä»¶å·²æ‰“å¼€ï¼Œåˆ™ç®¡ç†å‘˜å¯ä»¥æŒ‡å®šé»˜è®¤çš„StorageClassã€‚ æ²¡æœ‰storageClassNameçš„æ‰€æœ‰PVCåªèƒ½ç»‘å®šåˆ°è¯¥é»˜è®¤çš„PVã€‚ é€šè¿‡å°†StorageClasså¯¹è±¡ä¸­çš„æ³¨è§£storageclass.kubernetes.io/is-default-classè®¾ç½®ä¸ºâ€œtrueâ€æ¥æŒ‡å®šé»˜è®¤çš„StorageClassã€‚ å¦‚æžœç®¡ç†å‘˜æ²¡æœ‰æŒ‡å®šé»˜è®¤å€¼ï¼Œåˆ™é›†ç¾¤ä¼šå¯¹PVCåˆ›å»ºåšå‡ºå“åº”ï¼Œå°±åƒadmissionæ’ä»¶è¢«å…³é—­ä¸€æ ·ã€‚ å¦‚æžœæŒ‡å®šäº†å¤šä¸ªé»˜è®¤å€¼ï¼Œåˆ™admissionæ’ä»¶ç¦æ­¢åˆ›å»ºæ‰€æœ‰PVCã€‚&lt;/li>
&lt;li>å¦‚æžœadmissionæ’ä»¶å·²å…³é—­ï¼Œåˆ™ä¸å­˜åœ¨é»˜è®¤StorageClassçš„æ¦‚å¿µã€‚ æ²¡æœ‰&lt;code>storageClassName&lt;/code>çš„æ‰€æœ‰PVCåªèƒ½ç»‘å®šåˆ°æ²¡æœ‰ç±»çš„PVã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ²¡æœ‰&lt;code>storageClassName&lt;/code>çš„PVCçš„å¤„ç†æ–¹å¼ä¸Žå°†å…¶&lt;code>storageClassName&lt;/code>è®¾ç½®ä¸ºâ€œâ€çš„PVCç›¸åŒã€‚&lt;/li>
&lt;/ul>
&lt;p>æ ¹æ®æŒ‚è½½æ–¹æ³•ï¼ŒæŒ‚è½½è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡addon manageråœ¨Kubernetesç¾¤é›†ä¸­éƒ¨ç½²é»˜è®¤çš„&lt;code>StorageClass&lt;/code>ã€‚&lt;/p>
&lt;p>å½“PVCæŒ‡å®šä¸€ä¸ªé€‰æ‹©å™¨ï¼Œé™¤äº†è¯·æ±‚ä¸€ä¸ª&lt;code>StorageClass&lt;/code>ä¹‹å¤–ï¼Œè¿™äº›è¦æ±‚è¢«ANDç»„åˆåœ¨ä¸€èµ·ï¼šåªæœ‰æ‰€è¯·æ±‚çš„ç±»å’Œæ‰€è¯·æ±‚çš„æ ‡ç­¾çš„PVå¯èƒ½è¢«ç»‘å®šåˆ°PVCã€‚ è¯·æ³¨æ„ï¼Œå½“å‰ï¼Œå…·æœ‰éžç©ºé€‰æ‹©å™¨çš„PVCä¸èƒ½ä¸ºå…¶åŠ¨æ€é…ç½®PVã€‚&lt;/p>
&lt;p>åœ¨è¿‡åŽ»ï¼Œä½¿ç”¨äº†æ³¨è§£&lt;code>volume.beta.kubernetes.io/storage-class&lt;/code>ï¼Œè€Œä¸æ˜¯&lt;code>storageClassName&lt;/code>å±žæ€§ã€‚ è¯¥æ³¨è§£ä»ç„¶å¯ä»¥å·¥ä½œï¼Œä½†åœ¨æœªæ¥çš„Kubernetesç‰ˆæœ¬ä¸­å®ƒå°†ä¸è¢«æ”¯æŒã€‚&lt;/p>
&lt;h2 id="claims-vs-volumes">Claims VS Volumes&lt;/h2>
&lt;p>Podsé€šè¿‡å°†å£°æ˜Žç”¨ä½œå·æ¥è®¿é—®å­˜å‚¨ã€‚ å£°æ˜Žå¿…é¡»å­˜åœ¨äºŽä¸Žä½¿ç”¨å£°æ˜Žçš„podç›¸åŒçš„å‘½åç©ºé—´ä¸­ã€‚ é›†ç¾¤åœ¨podçš„å‘½åç©ºé—´ä¸­æŸ¥æ‰¾å£°æ˜Žï¼Œå¹¶ä½¿ç”¨å®ƒæ¥èŽ·å–æ”¯æŒå£°æ˜Žçš„&lt;code>PersistentVolume&lt;/code>ã€‚ ç„¶åŽå°†å·æŒ‚è½½åˆ°ä¸»æœºå¹¶è¿›å…¥podã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myfrontend&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dockerfile/nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/var/www/html&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeClaim&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">claimName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myclaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å…³äºŽå‘½åç©ºé—´çš„æ³¨æ„">å…³äºŽå‘½åç©ºé—´çš„æ³¨æ„&lt;/h3>
&lt;p>&lt;code>PersistentVolumes&lt;/code>ç»‘å®šæ˜¯ç‹¬å çš„ï¼Œå¹¶ä¸”ç”±äºŽ&lt;code>PersistentVolumeClaims&lt;/code>æ˜¯å‘½åç©ºé—´å¯¹è±¡ï¼Œå› æ­¤åªèƒ½åœ¨ä¸€ä¸ªå‘½åç©ºé—´å†…æŒ‚è½½â€œmanyâ€æ¨¡å¼ï¼ˆROXï¼ŒRWXï¼‰çš„å£°æ˜Žã€‚&lt;/p>
&lt;h2 id="storageclasses">StorageClasses&lt;/h2>
&lt;p>æ¯ä¸ª&lt;code>StorageClass&lt;/code>åŒ…å«å­—æ®µ&lt;code>provisioninger&lt;/code>å’Œ&lt;code>parameter&lt;/code>ï¼Œå½“å±žäºŽç±»åž‹çš„&lt;code>PersistentVolume&lt;/code>éœ€è¦åŠ¨æ€é…ç½®æ—¶ä½¿ç”¨ã€‚&lt;/p>
&lt;p>&lt;code>StorageClass&lt;/code>å¯¹è±¡çš„åç§°å¾ˆé‡è¦ï¼Œç”¨æˆ·å¯ä»¥å¦‚ä½•è¯·æ±‚ç‰¹å®šçš„ç±»ã€‚ ç®¡ç†å‘˜åœ¨é¦–æ¬¡åˆ›å»º&lt;code>StorageClass&lt;/code>å¯¹è±¡æ—¶è®¾ç½®ç±»çš„åç§°å’Œå…¶ä»–å‚æ•°ï¼Œå¹¶ä¸”åœ¨åˆ›å»ºå¯¹è±¡åŽæ— æ³•æ›´æ–°å¯¹è±¡ã€‚&lt;/p>
&lt;p>ç®¡ç†å‘˜å¯ä»¥ä»…ä¸ºä¸è¦æ±‚ä»»ä½•ç‰¹å®šç±»ç»‘å®šçš„PVCæŒ‡å®šé»˜è®¤çš„StorageClassï¼šæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">PersistentVolumeClaim&lt;/a>éƒ¨åˆ†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">StorageClass&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">storage.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">standard&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">provisioner&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubernetes.io/aws-ebs&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">parameters&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gp2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ä¾›åº”è€…provisioner">ä¾›åº”è€…(Provisioner)&lt;/h3>
&lt;p>å­˜å‚¨ç±»æœ‰ä¸€ä¸ªä¾›åº”è€…ï¼Œå®ƒç¡®å®šç”¨äºŽé…ç½®PVçš„å·æ’ä»¶ã€‚å¿…é¡»æŒ‡å®šæ­¤å­—æ®µã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Volume Plugin&lt;/th>
&lt;th>Internal Provisioner&lt;/th>
&lt;th>Config Example&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>AWSElasticBlockStore&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#aws">AWS&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AzureFile&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#azure-file">Azure File&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AzureDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#azure-disk">Azure Disk&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>CephFS&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Cinder&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#openstack-cinder">OpenStack Cinder&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>FC&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>FlexVolume&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Flocker&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GCEPersistentDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#gce">GCE&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Glusterfs&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#glusterfs">Glusterfs&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>iSCSI&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PhotonPersistentDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Quobyte&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#quobyte">Quobyte&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>NFS&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>RBD&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#ceph-rbd">Ceph RBD&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>VsphereVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#vsphere">vSphere&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PortworxVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#portworx-volume">Portworx Volume&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ScaleIO&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#scaleio">ScaleIO&lt;/a>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>ä½ ä¸é™äºŽæŒ‡å®šæ­¤å¤„åˆ—å‡ºçš„â€œinternalâ€ä¾›åº”è€…ï¼ˆå…¶åç§°å‰ç¼€ä¸ºâ€œkubernetes.ioâ€å¹¶ä¸ŽKubernetesä¸€èµ·å‘é€ï¼‰ã€‚ ä½ è¿˜å¯ä»¥è¿è¡Œå’ŒæŒ‡å®šå¤–éƒ¨æä¾›ç¨‹åºï¼Œå®ƒä»¬æ˜¯éµå¾ªKuberneteså®šä¹‰çš„è§„èŒƒçš„ç‹¬ç«‹ç¨‹åºã€‚ å¤–éƒ¨æä¾›è€…çš„ä½œè€…å¯¹ä»£ç çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¾›åº”å•†çš„è¿è¾“çŠ¶å†µï¼Œè¿è¡ŒçŠ¶å†µä»¥åŠä½¿ç”¨çš„å·æ’ä»¶ï¼ˆåŒ…æ‹¬Flexï¼‰ç­‰éƒ½æœ‰å……åˆ†çš„è‡ªä¸»æƒã€‚å­˜å‚¨åº“kubernetes-incubator /å¤–éƒ¨å­˜å‚¨åº“åŒ…å«ä¸€ä¸ªåº“ ç”¨äºŽç¼–å†™å®žæ–½å¤§éƒ¨åˆ†è§„èŒƒçš„å¤–éƒ¨æä¾›è€…ä»¥åŠå„ç§ç¤¾åŒºç»´æŠ¤çš„å¤–éƒ¨æä¾›è€…ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼ŒNFSä¸æä¾›å†…éƒ¨æä¾›ç¨‹åºï¼Œä½†å¯ä»¥ä½¿ç”¨å¤–éƒ¨æä¾›ç¨‹åºã€‚ ä¸€äº›å¤–éƒ¨æä¾›è€…åˆ—åœ¨å­˜å‚¨åº“kubernetes-incubator/external-storageä¸­ã€‚ è¿˜æœ‰ç¬¬ä¸‰æ–¹å­˜å‚¨ä¾›åº”å•†æä¾›è‡ªå·±çš„å¤–éƒ¨ä¾›åº”å•†çš„æƒ…å†µã€‚&lt;/p>
&lt;h3 id="å›žæ”¶ç­–ç•¥-1">å›žæ”¶ç­–ç•¥&lt;/h3>
&lt;p>ç”±å­˜å‚¨ç±»åŠ¨æ€åˆ›å»ºçš„æŒä¹…å·å°†å…·æœ‰&lt;code>delete&lt;/code>çš„å›žæ”¶ç­–ç•¥ã€‚ å¦‚æžœä¸å¸Œæœ›è¿™æ ·åšï¼Œå”¯ä¸€çš„å½“å‰é€‰é¡¹æ˜¯åœ¨åˆ›å»ºPVä¹‹åŽç¼–è¾‘PVã€‚&lt;/p>
&lt;p>é€šè¿‡å­˜å‚¨ç±»æ‰‹åŠ¨åˆ›å»ºå’Œç®¡ç†çš„æŒä¹…å·å°†å…·æœ‰åœ¨åˆ›å»ºæ—¶åˆ†é…çš„ä»»ä½•å›žæ”¶ç­–ç•¥ã€‚&lt;/p>
&lt;h3 id="å‚æ•°">å‚æ•°&lt;/h3>
&lt;p>å­˜å‚¨ç±»åž‹å…·æœ‰æè¿°å±žäºŽå­˜å‚¨ç±»åž‹çš„å·çš„å‚æ•°ã€‚ å–å†³äºŽä¾›åº”è€…ï¼Œå¯ä»¥æŽ¥å—ä¸åŒçš„å‚æ•°ã€‚ ä¾‹å¦‚ï¼Œå‚æ•°ç±»åž‹çš„å€¼io1å’Œå‚æ•°iopsPerGBç‰¹å®šäºŽEBSã€‚ å½“çœç•¥å‚æ•°æ—¶ï¼Œä½¿ç”¨ä¸€äº›é»˜è®¤å€¼ã€‚&lt;/p></description></item><item><title>Kuberneteså­¦ä¹  â€” Macoså®‰è£…Kubernetes</title><link>https://atbug.com/install-kubernetes-on-macos/</link><pubDate>Thu, 17 Aug 2017 09:44:17 +0000</pubDate><guid>https://atbug.com/install-kubernetes-on-macos/</guid><description>
&lt;h1 id="kubernetes">Kubernetes&lt;/h1>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;h2 id="macos">macos&lt;/h2>
&lt;h3 id="æ£€æŸ¥çŽ¯å¢ƒ">æ£€æŸ¥çŽ¯å¢ƒ&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">sysctl -a &lt;span class="p">|&lt;/span> grep machdep.cpu.features &lt;span class="p">|&lt;/span> grep VMX
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…virtualbox">å®‰è£…VirtualBox&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">http://download.virtualbox.org/virtualbox/5.1.26/Oracle_VM_VirtualBox_Extension_Pack-5.1.26-117224.vbox-extpack
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…minikube">å®‰è£…minikube&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.21.0/minikube-darwin-amd64 &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> chmod +x minikube &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> sudo mv minikube /usr/local/bin/
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ›å»ºé›†ç¾¤">åˆ›å»ºé›†ç¾¤&lt;/h3>
&lt;p>é»˜è®¤ä½¿ç”¨virtualboxã€‚&lt;/p>
&lt;p>ä¸»æœºçš„ipæ˜¯&lt;code>192.168.31.186&lt;/code>ï¼Œ &lt;code>1087&lt;/code>æ˜¯proxyçš„ç«¯å£ã€‚éœ€è¦å°†ssçš„httpä»£ç†ç›‘å¬åœ°å€ä»Ž&lt;code>127.0.0.1&lt;/code>æ”¹ä¸ºä¸»æœºçš„ipã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#å¯åŠ¨&lt;/span>
minikube start
&lt;span class="c1">#ä½¿ç”¨ç§æœ‰åº“&lt;/span>
minikube start --insecure-registry&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.31.34&amp;#34;&lt;/span>
&lt;span class="c1">#ä½¿ç”¨proxyï¼Œç”¨äºŽèŽ·å–é•œåƒ&lt;/span>
minikube start --docker-env &lt;span class="nv">HTTP_PROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.31.186:1087&amp;#34;&lt;/span> --docker-env &lt;span class="nv">HTTPS_PROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.31.186:1087&amp;#34;&lt;/span> --docker-env &lt;span class="nv">NO_PROXY&lt;/span>&lt;span class="o">=&lt;/span>192.168.99.0/24
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…kubectl">å®‰è£…kubectl&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -Lo kubectl http://storage.googleapis.com/kubernetes-release/release/v1.7.3/bin/darwin/amd64/kubectl &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> chmod +x kubectl &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> sudo mv kubectl /usr/local/bin/
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="oh-my-zsh-tab-completion">oh-my-zsh tab completion&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">vi ~/.zshrc
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>æ·»åŠ åˆ°pluginéƒ¨åˆ†&lt;br>
plugins=(git zsh-completions kubectl)&lt;/p>
&lt;/blockquote>
&lt;h2 id="ä½¿ç”¨">ä½¿ç”¨&lt;/h2>
&lt;h3 id="minikube">minikube&lt;/h3>
&lt;h4 id="æ£€æŸ¥ç‰ˆæœ¬">æ£€æŸ¥ç‰ˆæœ¬&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube version
&lt;span class="c1">#minikube version: v0.21.0&lt;/span>
kubectl version
&lt;span class="c1">#Client Version: version.Info{Major:&amp;#34;1&amp;#34;, Minor:&amp;#34;3&amp;#34;, GitVersion:&amp;#34;v1.3.0&amp;#34;, GitCommit:&amp;#34;283137936a498aed572ee22af6774b6fb6e9fd94&amp;#34;, GitTreeState:&amp;#34;clean&amp;#34;, BuildDate:&amp;#34;2016-07-01T19:26:38Z&amp;#34;, GoVersion:&amp;#34;go1.6.2&amp;#34;, Compiler:&amp;#34;gc&amp;#34;, Platform:&amp;#34;darwin/amd64&amp;#34;}&lt;/span>
&lt;span class="c1">#Server Version: version.Info{Major:&amp;#34;1&amp;#34;, Minor:&amp;#34;7&amp;#34;, GitVersion:&amp;#34;v1.7.0&amp;#34;, GitCommit:&amp;#34;d3ada0119e776222f11ec7945e6d860061339aad&amp;#34;, GitTreeState:&amp;#34;clean&amp;#34;, BuildDate:&amp;#34;2017-07-26T00:12:31Z&amp;#34;, GoVersion:&amp;#34;go1.8.3&amp;#34;, Compiler:&amp;#34;gc&amp;#34;, Platform:&amp;#34;linux/amd64&amp;#34;}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="èŽ·å–é›†ç¾¤åœ°å€">èŽ·å–é›†ç¾¤åœ°å€&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube ip
192.168.99.100
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="èŽ·å–æœåŠ¡åˆ—è¡¨">èŽ·å–æœåŠ¡åˆ—è¡¨&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube service list
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ‰“å¼€dashboard">æ‰“å¼€dashboard&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube dashboard
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="kubectl">kubectl&lt;/h2>
&lt;h4 id="éƒ¨ç½²dashboard-ui">éƒ¨ç½²Dashboard UI&lt;/h4>
&lt;p>é»˜è®¤minikubeä¼šè‡ªåŠ¨éƒ¨ç½²dashboard&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create -f https://rawgit.com/kubernetes/dashboard/master/src/deploy/kubernetes-dashboard.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å¯åŠ¨proxy">å¯åŠ¨proxy&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl proxy
&lt;span class="c1">#Starting to serve on 127.0.0.1:8001&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="èŽ·å–podä¿¡æ¯">èŽ·å–podä¿¡æ¯&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get pods --namespace kube-system
NAME READY STATUS RESTARTS AGE
kube-addon-manager-minikube 0/1 Running &lt;span class="m">0&lt;/span> 1h
kubernetes-dashboard-3313488171-90s64 0/1 Running &lt;span class="m">0&lt;/span> 20m
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æžœSTATUSä¸€ç›´å¤„äºŽ&lt;strong>ContainerCreating&lt;/strong>çŠ¶æ€ï¼Œåº”è¯¥æ˜¯pull imageå¤±è´¥ã€‚é»˜è®¤æ˜¯åŽ»gcr.ioæ‹‰é•œåƒï¼Œè¢«å¢™äº†ã€‚éœ€è¦åœ¨å¯åŠ¨minikubeçš„æ—¶å€™è®¾ç½®dockerä½¿ç”¨çš„ä»£ç†ã€‚&lt;/p>
&lt;h4 id="èŽ·å–podè¯¦ç»†ä¿¡æ¯">èŽ·å–podè¯¦ç»†ä¿¡æ¯&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl describe pod kubernetes-dashboard-3313488171-90s64 --namespace kube-system
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="æŸ¥çœ‹log">æŸ¥çœ‹log&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl logs -f kubernetes-dashboard-3313488171-90s64
&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>