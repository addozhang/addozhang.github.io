<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Mybatis on 乱世浮生</title><link>https://atbug.com/tags/mybatis/</link><description>Recent content in Mybatis on 乱世浮生</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Wed, 22 Feb 2017 14:12:18 +0000</lastBuildDate><atom:link href="https://atbug.com/tags/mybatis/index.xml" rel="self" type="application/rss+xml"/><item><title>mybatis报错“Result Maps collection already contains value for ***”</title><link>https://atbug.com/duplicate-resultmap-in-mybatis-mapper/</link><pubDate>Wed, 22 Feb 2017 14:12:18 +0000</pubDate><guid>https://atbug.com/duplicate-resultmap-in-mybatis-mapper/</guid><description>
&lt;p>这是工作中遇到的一个问题：测试环境部署出错，报了下面的问题。&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">Caused&lt;/span> &lt;span class="n">by&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">java&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lang&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">IllegalArgumentException&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">Result&lt;/span> &lt;span class="n">Maps&lt;/span> &lt;span class="n">collection&lt;/span> &lt;span class="n">already&lt;/span> &lt;span class="n">contains&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">xxx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">xxx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">xxxRepository&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">BaseResultMap&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Configuration$StrictMap&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">802&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Configuration$StrictMap&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">774&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">addResultMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">556&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MapperBuilderAssistant&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">addResultMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MapperBuilderAssistant&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">217&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ResultMapResolver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">resolve&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ResultMapResolver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">47&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">xml&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">resultMapElement&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">285&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">xml&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">resultMapElement&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">252&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">xml&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">resultMapElements&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">244&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">xml&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">configurationElement&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">116&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>检查了对应的mapper文件和java文件，已经8个多月没有修改过了。也检查了内容，没有发现重复的BaseResultMap；select中也resultMap的引用也都正确。&lt;/p>
&lt;p>其实到最后发现跟代码一丁点关系都没有，是部署的时候没有删除旧版本的代码导致两个不同版本的jar同时存在，相应的mapper文件也有两个。&lt;/p>
&lt;p>看了下源码，mybatis在创建SessionFactoryBean解析xml时候，会把xml中的resultMap放入到一个HashMap的子类StrictMap中，key是&lt;strong>mapper的namespace与resultmap的id&lt;/strong>拼接成的。&lt;/p>
&lt;p>StrictMap在put元素的时候，会检查map中是否已存在key。&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">addResultMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ResultMap&lt;/span> &lt;span class="n">rm&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">resultMaps&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">rm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">rm&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">checkLocallyForDiscriminatedNestedResultMaps&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">rm&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">checkGloballyForDiscriminatedNestedResultMaps&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">rm&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>