<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Envoy on 乱世浮生</title><link>https://atbug.com/tags/envoy/</link><description>Recent content in Envoy on 乱世浮生</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Wed, 09 Dec 2020 20:00:00 +0800</lastBuildDate><atom:link href="https://atbug.com/tags/envoy/index.xml" rel="self" type="application/rss+xml"/><item><title>Envoy listener filter times out 问题</title><link>https://atbug.com/envoy-listener-filter-times-out/</link><pubDate>Wed, 09 Dec 2020 20:00:00 +0800</pubDate><guid>https://atbug.com/envoy-listener-filter-times-out/</guid><description>
最近在看 openservicemesh 相关内容，这周更新了 main 分支的代码之后。发现原本 v0.5.0 时可以正常代理的 mysql 流量，在新的 commit 中无法代理了。 开启 envoy 的 filter debug 日志后发现出现了超时。 [2020-12-09 08:54:42.285][15][debug][filter] [source/extensions/filters/listener/original_dst/original_dst.cc:18] original_dst: New connection accepted [2020-12-09 08:54:42.285][15][debug][filter] [source/extensions/filters/listener/http_inspector/http_inspector.cc:38] http inspector: new connection accepted [2020-12-09 08:54:42.285][15][trace][filter] [source/extensions/filters/listener/http_inspector/http_inspector.cc:105] http inspector: recv: 0 [2020-12-09 08:54:57.286][15][debug][conn_handler] [source/server/connection_handler_impl.cc:273] listener filter times out after 15000 ms 贴一下 outbound listener 的配置片段: { &amp;#34;@type&amp;#34;: &amp;#34;type.googleapis.com/envoy.admin.v3.ListenersConfigDump&amp;#34;, &amp;#34;version_info&amp;#34;: &amp;#34;1&amp;#34;, &amp;#34;dynamic_listeners&amp;#34;: [{ &amp;#34;name&amp;#34;: &amp;#34;outbound_listener&amp;#34;, &amp;#34;active_state&amp;#34;: { &amp;#34;version_info&amp;#34;: &amp;#34;1&amp;#34;, &amp;#34;listener&amp;#34;: { &amp;#34;@type&amp;#34;: &amp;#34;type.googleapis.com/envoy.config.listener.v3.Listener&amp;#34;, &amp;#34;name&amp;#34;: &amp;#34;outbound_listener&amp;#34;, &amp;#34;address&amp;#34;: { &amp;#34;socket_address&amp;#34;: { &amp;#34;address&amp;#34;: &amp;#34;0.0.0.0&amp;#34;, &amp;#34;port_value&amp;#34;: 15001 } }, &amp;#34;filter_chains&amp;#34;: [ //省略其他 filter chain { &amp;#34;filters&amp;#34;: [{ &amp;#34;name&amp;#34;: &amp;#34;envoy.filters.network.tcp_proxy&amp;#34;, &amp;#34;typed_config&amp;#34;: { &amp;#34;@type&amp;#34;: &amp;#34;type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy&amp;#34;, &amp;#34;stat_prefix&amp;#34;: &amp;#34;passthrough-outbound&amp;#34;, &amp;#34;cluster&amp;#34;: &amp;#34;passthrough-outbound&amp;#34; } }], &amp;#34;name&amp;#34;: &amp;#34;outbound-egress-filter-chain&amp;#34; }], &amp;#34;listener_filters&amp;#34;: [{ &amp;#34;name&amp;#34;: &amp;#34;envoy.filters.listener.original_dst&amp;#34; }, { &amp;#34;name&amp;#34;: &amp;#34;envoy.filters.listener.http_inspector&amp;#34; } ], &amp;#34;traffic_direction&amp;#34;: &amp;#34;OUTBOUND&amp;#34; }, &amp;#34;last_updated&amp;#34;: &amp;#34;2020-12-08T10:07:41.191Z&amp;#34; } }] } 分析 Envoy 那边看到了有个 issue，为此增加了 timeout 的设置，默认 15s。 listener_filters_timeout：默认 15s。等待 listener filter 完成的超时时间，如果设置为 0，则不超时。如果没有设置下面的配置为true，则会直接关闭连接。</description></item></channel></rss>