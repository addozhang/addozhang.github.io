<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.57.2" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>TheadPoolExecutor源码分析 &middot; 乱世浮生</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://atbug.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://atbug.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://atbug.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://atbug.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="../favicon.png">

  
  
</head>

  <body class="theme-base-08 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://atbug.com/"><h1>乱世浮生</h1></a>
      <p class="lead">
       知我者谓我何忧 不知我者谓我何求. 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://atbug.com/">Home</a> </li>
        <li><a href="../post/"> Archives </a></li><li><a href="../tags/"> Tags </a></li><li><a href="../categories/"> Categories </a></li><li><a href="../about/"> About </a></li>
      </ul>
    </nav>

    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>TheadPoolExecutor源码分析</h1>
  <time datetime=2017-02-20T09:56:07Z class="post-date">Mon, Feb 20, 2017</time>
  

<h1 id="theadpoolexecutor源码分析">TheadPoolExecutor源码分析</h1>

<p>ThreadPoolExecutor是多线程中经常用到的类，其使用一个线程池执行提交的任务。</p>

<h2 id="实现">实现</h2>

<p>没有特殊需求的情况下，通常都是用Executors类的静态方法如newCachedThreadPoll来初始化ThreadPoolExecutor实例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">static</span> <span class="n">ExecutorService</span> <span class="nf">newCachedThreadPool</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">0</span><span class="p">,</span> <span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">,</span>
                                  <span class="n">60L</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">,</span>
                                  <span class="k">new</span> <span class="n">SynchronousQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span><span class="p">());</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>从Executors的方法实现中看出，BlockingQueue使用的SynchronousQueue，底层使用了栈的实现。值得注意的是，这个SynchronousQueue是没有容量限制的，Executors也将maximumPoolSize设为Integer.MAX_VALUE。</p>

<p>ThreadPoolExecutor的构造方法：</p>

<p>按照javadoc的解释：</p>

<ul>
<li>corePoolSize是池中闲置的最小线程数</li>
<li>maximumPoolSize是池中允许的最大线程数</li>
<li>keepAliveTime是线程数大于最小线程数时，过量闲置线程的最大存活时间</li>
<li>unit是上面存活时间的单位</li>

<li><p>workQueue是用来暂时保存运行前的任务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="p">(</span><span class="kt">int</span> <span class="nf">corePoolSize</span><span class="p">,</span>
                          <span class="kt">int</span> <span class="nf">maximumPoolSize</span><span class="p">,</span>
                          <span class="kt">long</span> <span class="nf">keepAliveTime</span><span class="p">,</span>
                          <span class="n">TimeUnit</span> <span class="nf">unit</span><span class="p">,</span>
                          <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="nf">workQueue</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">void</span> <span class="n">execute</span><span class="p">(</span><span class="n">Runnable</span> <span class="nf">command</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">workerCountOf</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">corePoolSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addWorker</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">isRunning</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">workQueue</span><span class="p">.</span><span class="na">offer</span><span class="p">(</span><span class="n">command</span><span class="p">))</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="nf">recheck</span> <span class="o">=</span> <span class="n">ctl</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">isRunning</span><span class="p">(</span><span class="n">recheck</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">remove</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
        <span class="n">reject</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">workerCountOf</span><span class="p">(</span><span class="n">recheck</span><span class="p">)</span> <span class="o">==</span> <span class="n">0</span><span class="p">)</span>
        <span class="n">addWorker</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addWorker</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="kc">false</span><span class="p">))</span>
    <span class="n">reject</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>

<p>除去第一个做任务非空检查的if。</p>

<p>第二个if，检查当前使用的线程数是否超过corePoolSize。未超过，调用addWorker并指定第二个参数为true。addWorker会再次检查线程数是否超过corePoolSize，如果还未超过，则创建一个新的线程执行任务。</p>

<p>第三个if，当目前使用的线程数大于等于corePoolSize，将任务保存到workQueue中。保存成功，再次检查是否需要再创建一个线程。</p>

<p>最后一个else，调用addWorker并指定第二个参数为false。在创建线程前，检查当时线程数是否超过maximumPoolSize，为超过则创建一个新的线程。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nf">boolean</span> <span class="n">addWorker</span><span class="p">(</span><span class="n">Runnable</span> <span class="nf">firstTask</span><span class="p">,</span> <span class="kt">boolean</span> <span class="nf">core</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">retry</span><span class="o">:</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="nf">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="kt">int</span> <span class="nf">rs</span> <span class="o">=</span> <span class="n">runStateOf</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
        <span class="c1">// Check if queue empty only if necessary.
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">rs</span> <span class="o">&gt;=</span> <span class="n">SHUTDOWN</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span> <span class="p">(</span><span class="n">rs</span> <span class="o">==</span> <span class="n">SHUTDOWN</span> <span class="o">&amp;&amp;</span>
               <span class="n">firstTask</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
               <span class="o">!</span> <span class="n">workQueue</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">()))</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="nf">wc</span> <span class="o">=</span> <span class="n">workerCountOf</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">wc</span> <span class="o">&gt;=</span> <span class="n">CAPACITY</span> <span class="o">||</span>
                <span class="n">wc</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">core</span> <span class="o">?</span> <span class="n">corePoolSize</span> <span class="o">:</span> <span class="n">maximumPoolSize</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">compareAndIncrementWorkerCount</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="k">break</span> <span class="n">retry</span><span class="p">;</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>  <span class="c1">// Re-read ctl
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">runStateOf</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rs</span><span class="p">)</span>
                <span class="k">continue</span> <span class="n">retry</span><span class="p">;</span>
            <span class="c1">// else CAS failed due to workerCount change; retry inner loop
</span><span class="c1"></span>        <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="问题">问题</h2>

<p>一般场景下，不能使用Integer.MAX_VALUE如此大的线程数。所以需要使用构造器自己进行实例化。</p>

<p>如指定corePoolSize=5、maximumPoolSize=20</p>

<p>、keepAliveTime=60L、unit=TimeUnit.SECONDS、workQueue=new SynchronousQueue<Runnable>()。</p>

<p>但是实际执行的时候，线程数一直是5。</p>

<p>回头看ThreadPoolExecutor的实现，如果想要达到我们想要的效果需要程序进入最后的那个else。那重点就在第三个if里的workQueue.offer(command)。</p>

<p>看BlockingQueue接口中该方法的描述：将元素插入到队列中，没有超过容量限制则插入并返回true。</p>

<p>而使用的SynchronousQueue底层实现使用的栈没有容量限制，这就是为什么线程池中的线程数一直是corePoolSize。</p>

</div>

<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "addozhang" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-47966140-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
