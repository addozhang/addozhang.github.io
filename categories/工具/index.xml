<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>å·¥å…· on ä¹±ä¸–æµ®ç”Ÿ</title><link>https://atbug.com/categories/%E5%B7%A5%E5%85%B7/</link><description>Recent content in å·¥å…· on ä¹±ä¸–æµ®ç”Ÿ</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Sun, 26 Dec 2021 12:31:16 +0800</lastBuildDate><atom:link href="https://atbug.com/categories/%E5%B7%A5%E5%85%B7/index.xml" rel="self" type="application/rss+xml"/><item><title>Colimaï¼šMacOS ä¸Šçš„æç®€å®¹å™¨è¿è¡Œæ—¶å’Œ Kubernetesï¼ˆæ”¯æŒ m1ï¼‰</title><link>https://atbug.com/containers-runtime-on-macos-with-colima/</link><pubDate>Sun, 26 Dec 2021 12:31:16 +0800</pubDate><guid>https://atbug.com/containers-runtime-on-macos-with-colima/</guid><description>
&lt;p>&lt;a href="https://github.com/abiosoft/colima">Colima&lt;/a> æ˜¯ä¸€ä¸ªä»¥æœ€å°åŒ–è®¾ç½®æ¥åœ¨MacOSä¸Šè¿è¡Œå®¹å™¨è¿è¡Œæ—¶å’Œ Kubernetes çš„å·¥å…·ã€‚æ”¯æŒ m1ï¼ˆæ–‡æœ«è®¨è®ºï¼‰ï¼ŒåŒæ ·ä¹Ÿæ”¯æŒ Linuxã€‚&lt;/p>
&lt;p>Colima çš„åå­—å–è‡ª Container on Limaã€‚&lt;a href="https://github.com/lima-vm/lima">Lima&lt;/a> æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºå·¥å…·ï¼Œå¯ä»¥å®ç°è‡ªåŠ¨çš„æ–‡ä»¶å…±äº«ã€ç«¯å£è½¬å‘ä»¥åŠ containerdã€‚&lt;/p>
&lt;p>Colima å®é™…ä¸Šæ˜¯é€šè¿‡ Lima å¯åŠ¨äº†åä¸º &lt;code>colima&lt;/code> çš„è™šæ‹Ÿæœºï¼Œä½¿ç”¨è™šæ‹Ÿæœºä¸­çš„ containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/12/26/colima.gif" alt="colima">&lt;/p>
&lt;h2 id="ä½¿ç”¨">ä½¿ç”¨&lt;/h2>
&lt;p>Colima çš„ä½¿ç”¨å¾ˆç®€å•ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥åˆ›å»ºè™šæ‹Ÿæœºï¼Œé»˜è®¤æ˜¯ Docker çš„è¿è¡Œæ—¶ã€‚&lt;/p>
&lt;p>åˆæ¬¡è¿è¡Œéœ€è¦ä¸‹è½½è™šæ‹Ÿæœºé•œåƒåˆ›å»ºè™šæ‹Ÿæœºï¼Œè€—æ—¶å› ç½‘ç»œæƒ…å†µæœ‰æ‰€å·®å¼‚ã€‚ä¹‹åï¼Œå¯åŠ¨è™šæ‹Ÿæœºå°±åªéœ€è¦ 30s å·¦å³çš„æ—¶é—´ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">colima start
INFO&lt;span class="o">[&lt;/span>0000&lt;span class="o">]&lt;/span> starting colima
INFO&lt;span class="o">[&lt;/span>0000&lt;span class="o">]&lt;/span> creating and starting ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>vm
INFO&lt;span class="o">[&lt;/span>0119&lt;span class="o">]&lt;/span> provisioning ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>docker
INFO&lt;span class="o">[&lt;/span>0119&lt;span class="o">]&lt;/span> provisioning in VM ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>docker
INFO&lt;span class="o">[&lt;/span>0133&lt;span class="o">]&lt;/span> restarting VM to &lt;span class="nb">complete&lt;/span> setup ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>docker
INFO&lt;span class="o">[&lt;/span>0133&lt;span class="o">]&lt;/span> stopping ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>vm
INFO&lt;span class="o">[&lt;/span>0136&lt;span class="o">]&lt;/span> starting ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>vm
INFO&lt;span class="o">[&lt;/span>0158&lt;span class="o">]&lt;/span> starting ... &lt;span class="nv">context&lt;/span>&lt;span class="o">=&lt;/span>docker
INFO&lt;span class="o">[&lt;/span>0159&lt;span class="o">]&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ­¤æ—¶ï¼Œåœ¨å®¿ä¸»æœºä¸Šå°±å¯ä»¥ä½¿ç”¨ Docker ç›¸å…³çš„å‘½ä»¤äº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
docker pull busybox
docker images
REPOSITORY TAG IMAGE ID CREATED SIZE
busybox latest b34806a1af7a &lt;span class="m">2&lt;/span> weeks ago 1.41MB
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå¯ä»¥ä½¿ç”¨ Lima çš„å‘½ä»¤è¡Œ &lt;code>limact&lt;/code>å·¥å…·æŸ¥çœ‹è™šæ‹Ÿæœºçš„æƒ…å†µï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">limactl list
NAME STATUS SSH ARCH CPUS MEMORY DISK DIR
colima Running 127.0.0.1:64505 aarch64 &lt;span class="m">2&lt;/span> 2GiB 60GiB /Users/addo/.lima/colima
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹æ“ä½œç³»ç»Ÿä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">uname -a
Darwin Addos-Macbook-Pro.local 21.2.0 Darwin Kernel Version 21.2.0: Sun Nov &lt;span class="m">28&lt;/span> 20:28:41 PST 2021&lt;span class="p">;&lt;/span> root:xnu-8019.61.5~1/RELEASE_ARM64_T6000 arm64
limactl shell colima uname -a
Linux lima-colima 5.13.0-22-generic &lt;span class="c1">#22-Ubuntu SMP Fri Nov 5 13:22:27 UTC 2021 aarch64 aarch64 aarch64 GNU/Linux&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…ä½¿ç”¨ Colima çš„ &lt;code>ssh&lt;/code> å‘½ä»¤è¿›å…¥è™šæ‹Ÿæœºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># on host&lt;/span>
colima ssh
&lt;span class="c1"># in vm&lt;/span>
uname -a
Linux lima-colima 5.13.0-22-generic &lt;span class="c1">#22-Ubuntu SMP Fri Nov 5 13:22:27 UTC 2021 aarch64 aarch64 aarch64 GNU/Linux&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å…¶ä»–è¿è¡Œæ—¶">å…¶ä»–è¿è¡Œæ—¶&lt;/h3>
&lt;p>ä¹Ÿå¯ä»¥åœ¨åˆ›å»ºçš„æ—¶å€™é€šè¿‡ &lt;code>--runtime containerd&lt;/code> å‚æ•°æŒ‡å®šä½¿ç”¨ Containerd ä½œä¸ºè¿è¡Œæ—¶ã€‚æ­¤æ—¶å°±éœ€è¦ä½¿ç”¨ &lt;code>colima nerdctl&lt;/code> æ¥ä½¿ç”¨ &lt;code>nerdctl&lt;/code> ä¸ Containerd è¿›è¡Œäº¤äº’ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">colima start --runtime containerd
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŒæ ·ï¼Œè¿˜å¯ä»¥åˆ›å»ºä¸€ä¸ª k3s ä½œä¸º Kubernetes è¿è¡Œæ—¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">colima start --with-kubernetes
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="demo">Demo&lt;/h2>
&lt;p>æˆ‘ä»¬å°è¯•å¯åŠ¨ä¸€ä¸ª nginx å®¹å™¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker run --rm -d --name nginx -p 8080:80 nginx:latest
docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
20d6c56e038b nginx:latest &lt;span class="s2">&amp;#34;/docker-entrypoint.â€¦&amp;#34;&lt;/span> &lt;span class="m">9&lt;/span> seconds ago Up &lt;span class="m">8&lt;/span> seconds 0.0.0.0:8080-&amp;gt;80/tcp, :::8080-&amp;gt;80/tcp nginx
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Colima ä¼šè‡ªåŠ¨é…ç½®ç«¯å£è½¬å‘ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -I http://localhost:8080
HTTP/1.1 &lt;span class="m">200&lt;/span> OK
Server: nginx/1.21.4
Date: Sun, &lt;span class="m">26&lt;/span> Dec &lt;span class="m">2021&lt;/span> 04:17:22 GMT
Content-Type: text/html
Content-Length: &lt;span class="m">615&lt;/span>
Last-Modified: Tue, &lt;span class="m">02&lt;/span> Nov &lt;span class="m">2021&lt;/span> 14:49:22 GMT
Connection: keep-alive
ETag: &lt;span class="s2">&amp;#34;61814ff2-267&amp;#34;&lt;/span>
Accept-Ranges: bytes
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="è™šæ‹Ÿæœºé…ç½®">è™šæ‹Ÿæœºé…ç½®&lt;/h2>
&lt;p>Colima å¯åŠ¨çš„è™šæ‹Ÿæœºé»˜è®¤æ˜¯ 2CPUã€2GiB å†…å­˜ å’Œ 60GiB å­˜å‚¨ã€‚å¯ä»¥åœ¨åˆ›å»ºæ—¶é€šè¿‡ &lt;code>--cpu&lt;/code> ã€&lt;code>--memory&lt;/code> å’Œ &lt;code>--disk&lt;/code> æ¥åˆ†é…æ›´å¤šèµ„æºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">colima start --cpu &lt;span class="m">4&lt;/span> --memory &lt;span class="m">16&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå¯ä»¥ä¿®æ”¹å½“å‰è™šæ‹Ÿæœºçš„é…ç½®ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">colima stop
colima start --cpu &lt;span class="m">4&lt;/span> --memory &lt;span class="m">16&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åŒç±»å·¥å…·æ¯”è¾ƒ">åŒç±»å·¥å…·æ¯”è¾ƒ&lt;/h2>
&lt;p>å…¶å®æœ‰ä¸å°‘ç±»ä¼¼çš„å·¥å…·ï¼Œæ¯”å¦‚ kindã€k3d å’Œ minikube ä¸‰ç§éƒ½æ˜¯ç”¨æ¥åˆ›å»º Kubernetes ç¯å¢ƒã€‚æˆ‘ä¸ªäººæ­¤å‰ç”¨çš„ k3d å°±æ¯”è¾ƒå¤šã€‚&lt;/p>
&lt;p>å¯¹äº Docker å®¹å™¨ç¯å¢ƒï¼Œè¿™ä¸‰ä¸ªå…¶å®éƒ½æ²¡æœ‰æä¾›ã€‚minikube çš„è™šæ‹Ÿæœºä¸­ä¹Ÿæœ‰å®¹å™¨è¿è¡Œæ—¶ï¼Œä½†æ˜¯æ— æ³•å•çº¯å®‰è£… Docker ç¯å¢ƒã€‚&lt;/p>
&lt;p>å¯¹äº Kubernetes ç¯å¢ƒæ¥è¯´ï¼Œè¿™å‡ ç§éƒ½é€‚åˆï¼Œç›¸æ¯” Colima æ¥è¯´è¿˜æ”¯æŒåˆ›å»ºå¤šä¸ªé›†ç¾¤ï¼ˆå½“å‰ Colima æœ€æ–°ç‰ˆæœ¬æ˜¯ 0.2.2ï¼Œå¤šé›†ç¾¤çš„æ”¯æŒä¹Ÿåœ¨å¼€å‘ä¸­ã€‚ä¼°è®¡ 0.3.0 ä¼šæä¾›ï¼Œæ¯•ç«Ÿåˆ›å»ºå¤šä¸ªè™šæ‹Ÿæœºå°±èƒ½å®ç°ï¼‰ã€‚ä½†ä½¿ç”¨ Colima çš„è¯ï¼ŒKubernetes å’Œ Docker å¯ä»¥å…±äº«é•œåƒï¼ˆæœ¬åœ°é•œåƒï¼‰å’Œè¿è¡Œæ—¶ã€‚&lt;/p>
&lt;h2 id="ä¸è¶³">ä¸è¶³&lt;/h2>
&lt;h3 id="å¤šé›†ç¾¤çš„æ”¯æŒ">å¤šé›†ç¾¤çš„æ”¯æŒ&lt;/h3>
&lt;p>å‰é¢æåˆ°ï¼Œç›®å‰è¿˜ä¸æ”¯æŒåˆ›å»ºå¤šä¸ª Kubernetes é›†ç¾¤ï¼Œä¼°è®¡ 0.3.0 ä¼šæä¾›ã€‚&lt;/p>
&lt;h3 id="m1-çš„æ”¯æŒ">m1 çš„æ”¯æŒ&lt;/h3>
&lt;p>è¿™é‡Œè¿˜æ˜¯è¦è¯´ä¸‹ m1ï¼Œæˆ‘ç°åœ¨ä¸»è¦ç”¨ m1 çš„ç”µè„‘ï¼Œæœ¬åœ°çš„å®¹å™¨è¿è¡Œæ—¶ç”¨çš„ Docker Desktopã€‚&lt;/p>
&lt;p>å‰é¢æˆ‘ä»¬æœ‰ç•™æ„åˆ°è™šæ‹Ÿæœºä½¿ç”¨çš„æ˜¯ &lt;code>aarch64&lt;/code> æ¶æ„ç³»ç»Ÿï¼Œ&lt;strong>å¯¹äºæŸäº›ä¸æ”¯æŒ arm64 çš„é•œåƒè¿˜æ˜¯æ— æ³•è¿è¡Œ&lt;/strong>ã€‚æ¯•ç«Ÿ Lima æ˜¯åŸç”Ÿæ”¯æŒ m1ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ Rosetta è½¬è¯‘çš„ Docker Desktopã€‚&lt;/p>
&lt;p>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å°è¯•ç”¨ Rosetta è½¬è¯‘ Limaã€‚&lt;/p></description></item><item><title>å¸¸ç”¨çš„å‡ æ¬¾å·¥å…·è®© Kubernetes é›†ç¾¤ä¸Šçš„å·¥ä½œæ›´å®¹æ˜“</title><link>https://atbug.com/tools-accelerate-work-on-kubernetes-cluster/</link><pubDate>Sat, 26 Jun 2021 12:16:28 +0800</pubDate><guid>https://atbug.com/tools-accelerate-work-on-kubernetes-cluster/</guid><description>
&lt;p>ä¹‹å‰å†™è¿‡ä¸€ç¯‡ &lt;a href="https://mp.weixin.qq.com/s/CXJ1zUoktdI3c3CHVju0gA">ä»‹ç»äº†å·¥å…·åŠ é€Ÿäº‘åŸç”Ÿ Java å¼€å‘&lt;/a>ã€‚&lt;/p>
&lt;p>å…¶å®æ—¥å¸¸å·¥ä½œä¸­åœ¨é›†ç¾¤ä¸Šçš„æ“ä½œä¹Ÿéå¸¸å¤šï¼Œä»Šå¤©å°±æ¥ä»‹ç»æˆ‘æ‰€ä½¿ç”¨çš„å·¥å…·ã€‚&lt;/p>
&lt;h2 id="kubectl-alias">kubectl-alias&lt;/h2>
&lt;p>ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„å·¥å…·ï¼Œæˆ‘è‡ªå·±ç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹ï¼ŒåŠ å…¥äº† &lt;code>StatefulSet&lt;/code> çš„æ”¯æŒã€‚&lt;/p>
&lt;p>è¿™ä¸ªæ˜¯æˆ‘çš„ &lt;a href="https://github.com/addozhang/kubectl-aliases">https://github.com/addozhang/kubectl-aliases&lt;/a>ï¼ŒåŸºäº &lt;a href="https://github.com/ahmetb/kubectl-aliases">https://github.com/ahmetb/kubectl-aliases&lt;/a>ã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¾“å‡ºæŸä¸ª pod çš„ jsonï¼Œ&lt;code>kgpoojson xxx&lt;/code> ç­‰åŒäº &lt;code>kubectl get pod xxx -o json&lt;/code>ã€‚&lt;/p>
&lt;p>ç»“åˆ &lt;a href="https://stedolan.github.io/jq/">jq&lt;/a> ä½¿ç”¨æ•ˆæœæ›´å¥½ ğŸ˜‚ã€‚&lt;/p>
&lt;h3 id="è¯­æ³•è§£è¯»">è¯­æ³•è§£è¯»&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>&lt;code>k&lt;/code>&lt;/strong>=&lt;code>kubectl&lt;/code>
&lt;ul>
&lt;li>&lt;strong>&lt;code>sys&lt;/code>&lt;/strong>=&lt;code>--namespace kube-system&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>commands:
&lt;ul>
&lt;li>&lt;strong>&lt;code>g&lt;/code>&lt;/strong>=&lt;code>get&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>d&lt;/code>&lt;/strong>=&lt;code>describe&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>rm&lt;/code>&lt;/strong>=&lt;code>delete&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>a&lt;/code>&lt;/strong>:&lt;code>apply -f&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>ak&lt;/code>&lt;/strong>:&lt;code>apply -k&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>k&lt;/code>&lt;/strong>:&lt;code>kustomize&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>ex&lt;/code>&lt;/strong>:Â &lt;code>exec -i -t&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>lo&lt;/code>&lt;/strong>:Â &lt;code>logs -f&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>resources:
&lt;ul>
&lt;li>&lt;strong>&lt;code>po&lt;/code>&lt;/strong>=pod,Â &lt;strong>&lt;code>dep&lt;/code>&lt;/strong>=&lt;code>deployment&lt;/code>,Â &lt;strong>&lt;code>ing&lt;/code>&lt;/strong>=&lt;code>ingress&lt;/code>,Â &lt;strong>&lt;code>svc&lt;/code>&lt;/strong>=&lt;code>service&lt;/code>,Â &lt;strong>&lt;code>cm&lt;/code>&lt;/strong>=&lt;code>configmap&lt;/code>,Â &lt;strong>&lt;code>sec&lt;/code>=&lt;code>secret&lt;/code>&lt;/strong>,&lt;strong>&lt;code>ns&lt;/code>&lt;/strong>=&lt;code>namespace&lt;/code>,Â &lt;strong>&lt;code>no&lt;/code>&lt;/strong>=&lt;code>node&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>flags:
&lt;ul>
&lt;li>output format:Â &lt;strong>&lt;code>oyaml&lt;/code>&lt;/strong>,Â &lt;strong>&lt;code>ojson&lt;/code>&lt;/strong>,Â &lt;strong>&lt;code>owide&lt;/code>&lt;/strong>&lt;/li>
&lt;li>&lt;strong>&lt;code>all&lt;/code>&lt;/strong>:Â &lt;code>--all&lt;/code>Â orÂ &lt;code>--all-namespaces&lt;/code>Â depending on the command&lt;/li>
&lt;li>&lt;strong>&lt;code>sl&lt;/code>&lt;/strong>:Â &lt;code>--show-labels&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>w&lt;/code>&lt;/strong>=&lt;code>-w/--watch&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>value flags (should be at the end):
&lt;ul>
&lt;li>&lt;strong>&lt;code>n&lt;/code>&lt;/strong>=&lt;code>-n/--namespace&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>f&lt;/code>&lt;/strong>=&lt;code>-f/--filename&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>l&lt;/code>&lt;/strong>=&lt;code>-l/--selector&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="kubectx--kubens">kubectx + kubens&lt;/h2>
&lt;p>&lt;a href="https://github.com/ahmetb/kubectx#installation">å®‰è£…çœ‹è¿™é‡Œ&lt;/a>&lt;/p>
&lt;p>&lt;code>kubectx&lt;/code> ç”¨äºåœ¨ä¸åŒçš„é›†ç¾¤é—´è¿›è¡Œå¿«é€Ÿåˆ‡æ¢ã€‚å‡å¦‚ç”¨ &lt;code>kubectl&lt;/code>ï¼Œä½ éœ€è¦ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># context åˆ—è¡¨&lt;/span>
kubectl config current-context
&lt;span class="c1"># è®¾ç½® context&lt;/span>
kubectl config use-context coffee
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/kubectxdemo.gif" alt="kubectx-demo">&lt;/p>
&lt;p>&lt;code>kubens&lt;/code> å°±æ˜¯åœ¨ä¸åŒ namespace é—´å¿«é€Ÿåˆ‡æ¢çš„å·¥å…·ã€‚ç”¨ &lt;code>kubectl&lt;/code> çš„è¯ï¼Œéœ€è¦ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># namespace åˆ—è¡¨&lt;/span>
kbuectl get ns
&lt;span class="c1"># kubectl config set-context --current --namespace=kube-system&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/kubensdemo.gif" alt="kubens-demo">&lt;/p>
&lt;h2 id="k9s">k9s&lt;/h2>
&lt;p>æ²¡é”™ï¼Œåªæ¯” k8s å¤šäº†ä¸ª 1 ğŸ˜‚ã€‚&lt;/p>
&lt;p>&lt;a href="https://github.com/derailed/k9s">k9s&lt;/a> æä¾›äº†ç»ˆç«¯ UI ä¸ Kubernetes é›†ç¾¤è¿›è¡Œç¼–è¾‘äº¤äº’ã€‚æœ¬äººå¸¸ç”¨çš„æ¯”å¦‚ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>F&lt;/code> é…ç½®ç«¯å£è½¬å‘&lt;/li>
&lt;li>&lt;code>l&lt;/code> è¾“å‡º pod æ—¥å¿—&lt;/li>
&lt;li>&lt;code>e&lt;/code> ä¿®æ”¹èµ„æºå¯¹è±¡&lt;/li>
&lt;li>&lt;code>s&lt;/code> pod ç»ˆç«¯äº¤äº’æ¨¡å¼&lt;/li>
&lt;li>&lt;code>y&lt;/code> yaml æ–¹å¼è¾“å‡ºèµ„æºå¯¹è±¡&lt;/li>
&lt;li>&lt;code>d&lt;/code> describe èµ„æºå¯¹è±¡&lt;/li>
&lt;li>&lt;code>ctrl+d&lt;/code> åˆ é™¤ pod&lt;/li>
&lt;/ul>
&lt;p>å¯åŠ¨æ–¹å¼&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># æŒ‡å®š namespace è¿è¡Œ&lt;/span>
k9s -n mycoolns
&lt;span class="c1"># æŒ‡å®š context è¿è¡Œ&lt;/span>
k9s --context coolCtx
&lt;span class="c1"># åªè¯»æ¨¡å¼è¿è¡Œ&lt;/span>
k9s --readonly
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626102731.png" alt="k9s-pod">&lt;/p>
&lt;p>é”®å…¥é—®å·â€œ?â€ å°±å¯ä»¥æ‰“å¼€å¿«æ·æ“ä½œæŒ‡å¼•ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626103012.png" alt="help">&lt;/p>
&lt;h2 id="stern">stern&lt;/h2>
&lt;p>&lt;a href="https://github.com/wercker/stern">stern&lt;/a> å¯ä»¥ç”¨æ¥ &lt;code>tail&lt;/code> é›†ç¾¤ä¸Šçš„å¤šä¸ª pod å’Œ pod ä¸­å¤šä¸ªå®¹å™¨çš„æ—¥å¿—ã€‚ä¸åŒçš„ pod å’Œå®¹å™¨ä»¥ä¸åŒçš„é¢œè‰²åŒºåˆ†ï¼Œæ–¹ä¾¿ debugã€‚&lt;/p>
&lt;p>æ¯”å¦‚ä½¿ç”¨å‘½ä»¤ &lt;code>stern -l tier=control-plane -n kube-system&lt;/code> å¯ä»¥è¾“å‡º &lt;code>kube-system&lt;/code> å‘½åç©ºé—´ä¸‹æ§åˆ¶å¹³é¢ï¼ˆ&lt;code>label&lt;/code> ä¸º &lt;code>tier=control-plane&lt;/code>ï¼‰ pod çš„æ—¥å¿—ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626104458.png" alt="stern-control-plane">&lt;/p>
&lt;p>å‘½ä»¤è¡Œé€‰é¡¹&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">Tail multiple pods and containers from Kubernetes
Usage:
stern pod-query &lt;span class="o">[&lt;/span>flags&lt;span class="o">]&lt;/span>
Flags:
-A, --all-namespaces If present, tail across all namespaces. A specific namespace is ignored even &lt;span class="k">if&lt;/span> specified with --namespace.
--color string Color output. Can be &lt;span class="s1">&amp;#39;always&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;never&amp;#39;&lt;/span>, or &lt;span class="s1">&amp;#39;auto&amp;#39;&lt;/span> &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;auto&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
--completion string Outputs stern command-line completion code &lt;span class="k">for&lt;/span> the specified shell. Can be &lt;span class="s1">&amp;#39;bash&amp;#39;&lt;/span> or &lt;span class="s1">&amp;#39;zsh&amp;#39;&lt;/span>
-c, --container string Container name when multiple containers in pod &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;.*&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
--container-state string If present, tail containers with status in running, waiting or terminated. Default to running. &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;running&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
--context string Kubernetes context to use. Default to current context configured in kubeconfig.
-e, --exclude strings Regex of log lines to exclude
-E, --exclude-container string Exclude a Container name
--field-selector string Selector &lt;span class="o">(&lt;/span>field query&lt;span class="o">)&lt;/span> to filter on. If present, default to &lt;span class="s2">&amp;#34;.*&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> the pod-query.
-h, --help &lt;span class="nb">help&lt;/span> &lt;span class="k">for&lt;/span> stern
-i, --include strings Regex of log lines to include
--init-containers Include or exclude init containers &lt;span class="o">(&lt;/span>default &lt;span class="nb">true&lt;/span>&lt;span class="o">)&lt;/span>
--kubeconfig string Path to kubeconfig file to use
-n, --namespace strings Kubernetes namespace to use. Default to namespace configured in Kubernetes context. To specify multiple namespaces, repeat this or &lt;span class="nb">set&lt;/span> comma-separated value.
-o, --output string Specify predefined template. Currently support: &lt;span class="o">[&lt;/span>default, raw, json&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;default&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
-l, --selector string Selector &lt;span class="o">(&lt;/span>label query&lt;span class="o">)&lt;/span> to filter on. If present, default to &lt;span class="s2">&amp;#34;.*&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> the pod-query.
-s, --since duration Return logs newer than a relative duration like 5s, 2m, or 3h. Defaults to 48h.
--tail int The number of lines from the end of the logs to show. Defaults to -1, showing all logs. &lt;span class="o">(&lt;/span>default -1&lt;span class="o">)&lt;/span>
--template string Template to use &lt;span class="k">for&lt;/span> log lines, leave empty to use --output flag
-t, --timestamps Print timestamps
--timezone string Set timestamps to specific timezone &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;Local&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
-v, --version Print the version and &lt;span class="nb">exit&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="lens">Lens&lt;/h2>
&lt;p>&lt;a href="https://k8slens.dev/">Lens&lt;/a> æ˜¯ç”¨æ¥æ§åˆ¶ Kubernetes çš„ IDEï¼Œå¼€æºä¸”å…è´¹ã€‚&lt;/p>
&lt;p>æ¶ˆé™¤äº†é›†ç¾¤æ“ä½œçš„å¤æ‚æ€§ã€æä¾›äº†å®æ—¶çš„å¯è§‚å¯Ÿæ€§ã€æ–¹ä¾¿æ•…éšœæ’æŸ¥ã€æ”¯æŒå¤šç³»ç»Ÿçš„æ¡Œé¢å®¢æˆ·ç«¯ã€å…¼å®¹å¤šç§é›†ç¾¤ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626113853.png" alt="Lens">&lt;/p>
&lt;h2 id="infra-app">Infra App&lt;/h2>
&lt;p>&lt;a href="https://infra.app/">Infra App&lt;/a> è·Ÿ Lens å·®ä¸å¤šï¼ŒUI è¾ƒ Lens å¥½äº›ï¼Œä½†æ˜¯åŠŸèƒ½å°±å¼±å¾ˆå¤šï¼Œç±»ä¼¼ Lens çš„åªè¯»æ¨¡å¼ã€‚&lt;/p>
&lt;p>å…è´¹ç‰ˆæ¯”æ”¶è´¹ç‰ˆçš„åŒºåˆ«åªåœ¨äºæ”¯æŒçš„é›†ç¾¤æ•°é‡ï¼Œå…è´¹ç‰ˆåªæ”¯æŒä¸€ä¸ªé›†ç¾¤ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626114417.png" alt="Infra">&lt;/p>
&lt;h2 id="kubefwd">kubefwd&lt;/h2>
&lt;p>&lt;a href="https://github.com/txn2/kubefwd">kubefwd&lt;/a>ï¼Œè¿™ä¸ªä¸€ç›´æœ‰å®‰è£…ä½†æ˜¯ä½¿ç”¨æ¬¡æ•°å¯¥å¯¥ï¼Œå› ä¸ºåº”ç”¨ä¹‹é—´çš„è®¿é—®æ²¡æœ‰èµ° serviceï¼Œä¸è¿‡å¶å°”åšäº›å®éªŒçš„æ—¶å€™ä¼šç”¨çš„ä¸Šã€‚&lt;/p>
&lt;blockquote>
&lt;p>kubefwd æ˜¯ä¸€ä¸ªç”¨äºç«¯å£è½¬å‘Kubernetesä¸­æŒ‡å®šnamespaceä¸‹çš„å…¨éƒ¨æˆ–è€…éƒ¨åˆ†podçš„å‘½ä»¤è¡Œå·¥å…·ã€‚ kubefwd ä½¿ç”¨æœ¬åœ°çš„ç¯å›IPåœ°å€è½¬å‘éœ€è¦è®¿é—®çš„serviceï¼Œå¹¶ä¸”ä½¿ç”¨ä¸serviceç›¸åŒçš„ç«¯å£ã€‚ kubefwd ä¼šä¸´æ—¶å°†serviceçš„åŸŸæ¡ç›®æ·»åŠ åˆ° /etc/hosts æ–‡ä»¶ä¸­ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>å¯åŠ¨kubefwdåï¼Œåœ¨æœ¬åœ°å°±èƒ½åƒåœ¨Kubernetesé›†ç¾¤ä¸­ä¸€æ ·ä½¿ç”¨serviceåå­—ä¸ç«¯å£è®¿é—®å¯¹åº”çš„åº”ç”¨ç¨‹åºã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/kubefwdani.gif" alt="kubefwd_ani">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/16246803227515.jpg" alt="">&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>å–„ç”¨å·¥å…·å¯ä»¥æå‡æ•ˆç‡ï¼Œä½†å¹¶ä¸æ˜¯ä¸å¯æˆ–ç¼ºçš„ã€‚&lt;/p>
&lt;p>å¦‚æœä½ æœ‰å…¶ä»–çš„å·¥å…·ï¼Œæ¬¢è¿ç•™è¨€æå‡ºã€‚&lt;/p></description></item><item><title>å¼€ç®±å³ç”¨çš„ Prometheus å‘Šè­¦è§„åˆ™é›†</title><link>https://atbug.com/introduction-awesome-prometheus-alerts/</link><pubDate>Thu, 13 May 2021 08:01:00 +0800</pubDate><guid>https://atbug.com/introduction-awesome-prometheus-alerts/</guid><description>
&lt;p>åœ¨é…ç½®ç³»ç»Ÿç›‘æ§çš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯å³ä½¿ç»å°½è„‘æ±ç›‘æ§çš„ä¹Ÿè¿˜æ˜¯ä¸å¤Ÿå…¨é¢ï¼Œæˆ–è€…ä¸çŸ¥å¦‚ä½•è·å–æƒ³è¦çš„æŒ‡æ ‡ã€‚&lt;/p>
&lt;p>&lt;a href="https://awesome-prometheus-alerts.grep.to/">Awesome Prometheus alerts&lt;/a> ç»´æŠ¤äº†ä¸€å¥—å¼€ç®±å³ç”¨çš„ Prometheus å‘Šè­¦è§„åˆ™é›†åˆï¼Œæœ‰ 300 å¤šä¸ªå‘Šè­¦è§„åˆ™ã€‚åŒæ—¶ï¼Œè¿˜æ˜¯è¯´æ˜å¦‚ä½•è·å–å¯¹åº”çš„æŒ‡æ ‡ã€‚è¿™äº›è§„åˆ™ï¼Œå¯¹æ¯ä¸ª Prometheus éƒ½æ˜¯é€šç”¨çš„ã€‚&lt;/p>
&lt;p>æ¶‰åŠå¦‚ä¸»æœºã€ç¡¬ä»¶ã€å®¹å™¨ç­‰åŸºç¡€èµ„æºï¼Œåˆ°æ•°æ®åº“ã€æ¶ˆæ¯ä»£ç†ã€è¿è¡Œæ—¶ã€åå‘ä»£ç†ã€è´Ÿè´£å‡è¡¡å™¨ï¼Œè¿è¡Œæ—¶ã€æœåŠ¡ç¼–æ’ï¼Œç”šè‡³æ˜¯ç½‘ç»œå±‚é¢å’Œ Prometheus è‡ªèº«å’Œé›†ç¾¤ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/13/alertrulescover.png" alt="alert_rules">&lt;/p>
&lt;p>Prometheus çš„å®‰è£…å’Œé…ç½®ä¸åšèµ˜è¿°ï¼Œé…ç½®å¯ä»¥çœ‹&lt;a href="https://awesome-prometheus-alerts.grep.to/alertmanager">è¿™é‡Œ&lt;/a>ã€‚ä¸‹é¢ç®€å•çœ‹ä¸‹å‡ ä¸ªå¸¸ç”¨è§„åˆ™&lt;/p>
&lt;h3 id="ä¸»æœºå’Œç¡¬ä»¶èµ„æº">ä¸»æœºå’Œç¡¬ä»¶èµ„æº&lt;/h3>
&lt;p>ä¸»æœºå’Œç¡¬ä»¶èµ„æºçš„å‘Šè­¦ä¾èµ– &lt;a href="https://github.com/prometheus/node_exporter">node-exporter&lt;/a> è¾“å‡ºçš„æŒ‡æ ‡ã€‚ä¾‹å¦‚ï¼š&lt;/p>
&lt;h4 id="å†…å­˜ä¸è¶³">å†…å­˜ä¸è¶³&lt;/h4>
&lt;p>å¯ç”¨å†…å­˜ä½äºé˜ˆå€¼ &lt;code>10%&lt;/code> å°±ä¼šè§¦å‘å‘Šè­¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">HostOutOfMemory&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100 &amp;lt; 10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Host out of memory (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Node memory is filling up (&amp;lt; 10% left)\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="ä¸»æœºå¼‚å¸¸çš„ç½‘ç»œåå">ä¸»æœºå¼‚å¸¸çš„ç½‘ç»œåå&lt;/h5>
&lt;p>æœ€è¿‘ä¸¤åˆ†é’Ÿå…¥ç«™çš„æµé‡è¶…è¿‡ &lt;code>100m&lt;/code>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>rate&lt;/code> è¯­æ³•è§&lt;a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#rate">è¿™é‡Œ&lt;/a>ã€‚&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">HostUnusualNetworkThroughputIn&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sum by (instance) (rate(node_network_receive_bytes_total[2m])) / 1024 / 1024 &amp;gt; 100&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">5m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Host unusual network throughput in (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Host network interfaces are probably receiving too much data (&amp;gt; 100 MB/s)\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="mysql">Mysql&lt;/h3>
&lt;p>Mysql çš„å‘Šè­¦ä¾èµ– &lt;a href="https://github.com/prometheus/mysqld_exporter">prometheus/mysqld_exporter&lt;/a> è¾“å‡ºçš„æŒ‡æ ‡ã€‚&lt;/p>
&lt;h4 id="è¿æ¥æ•°è¿‡å¤š">è¿æ¥æ•°è¿‡å¤š&lt;/h4>
&lt;p>Mysql å®ä¾‹çš„è¿æ¥æ•°æœ€è¿‘ä¸€åˆ†é’Ÿçš„è¿æ¥æ•°è¶…è¿‡æœ€å¤§å€¼çš„ &lt;code>80%&lt;/code> è§¦å‘å‘Šè­¦&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">MysqlTooManyConnections(&amp;gt;80%)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">avg by (instance) (rate(mysql_global_status_threads_connected[1m])) / avg by (instance) (mysql_global_variables_max_connections) * 100 &amp;gt; 80&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">MySQL too many connections (&amp;gt; 80%) (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;More than 80% of MySQL connections are in use on {{ $labels.instance }}\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="æ…¢æŸ¥è¯¢">æ…¢æŸ¥è¯¢&lt;/h4>
&lt;p>æœ€è¿‘ä¸€åˆ†é’Ÿæ…¢æŸ¥è¯¢æ•°é‡å¤§äº 0 æ—¶è§¦å‘ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">MysqlSlowQueries&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">increase(mysql_global_status_slow_queries[1m]) &amp;gt; 0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">MySQL slow queries (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;MySQL server mysql has some new slow query.\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è¿è¡Œæ—¶-jvm">è¿è¡Œæ—¶ JVM&lt;/h3>
&lt;p>JVM çš„è¿è¡Œæ—¶å‘Šè­¦ï¼Œå±…ç„¶åªæœ‰å¯æ€œå·´å·´çš„ä¸€ä¸ªã€‚å †ç©ºé—´å ç”¨è¶…è¿‡ &lt;code>80%&lt;/code> è§¦å‘å‘Šè­¦ã€‚&lt;/p>
&lt;p>ä¾èµ– &lt;a href="https://github.com/prometheus/client_java">java-client&lt;/a> è¾“å‡ºçš„æŒ‡æ ‡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">JvmMemoryFillingUp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">(sum by (instance)(jvm_memory_used_bytes{area=&amp;#34;heap&amp;#34;}) / sum by (instance)(jvm_memory_max_bytes{area=&amp;#34;heap&amp;#34;})) * 100 &amp;gt; 80&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">JVM memory filling up (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;JVM memory is filling up (&amp;gt; 80%)\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="kubernetes">Kubernetes&lt;/h3>
&lt;p>Kubernetes ç›¸å…³çš„å‘Šè­¦è§„åˆ™æœ‰ 33 ä¸ªï¼Œæ¯”è¾ƒä¸°å¯Œã€‚&lt;/p>
&lt;p>æ‘˜ä¸ªæ¯”è¾ƒå¸¸è§çš„ï¼šå®¹å™¨OOMå‘Šè­¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">KubernetesContainerOomKiller&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">(kube_pod_container_status_restarts_total - kube_pod_container_status_restarts_total offset 10m &amp;gt;= 1) and ignoring (reason) min_over_time(kube_pod_container_status_last_terminated_reason{reason=&amp;#34;OOMKilled&amp;#34;}[10m]) == 1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">0m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Kubernetes container oom killer (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} has been OOMKilled {{ $value }} times in the last 10 minutes.\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ssl-è¯ä¹¦è¿‡æœŸ">SSL è¯ä¹¦è¿‡æœŸ&lt;/h3>
&lt;p>é€šè¿‡ &lt;a href="https://github.com/ribbybibby/ssl_exporter">&lt;/a> è¾“å‡ºçš„æŒ‡æ ‡ï¼Œå¯ä»¥ç›‘æ§è¯ä¹¦è¿‡æœŸï¼šæœªæ¥ &lt;code>7 å¤©&lt;/code> æœ‰è¯ä¹¦è¿‡æœŸä¾¿ä¼šè§¦å‘å‘Šè­¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">SslCertificateExpiry(&amp;lt;7Days)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ssl_verified_cert_not_after{chain_no=&amp;#34;0&amp;#34;} - time() &amp;lt; 86400 * 7&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">0m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">SSL certificate expiry (&amp;lt; 7 days) (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ $labels.instance }} Certificate is expiring in 7 days\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»Šå¤©åˆ—å‡ºæ¥çš„ä¹Ÿä»…ä»…æ˜¯å†°å±±ä¸€è§’ï¼Œè€Œä¸”ç”¨æˆ·ä¹Ÿå¯ä»¥&lt;a href="https://github.com/samber/awesome-prometheus-alerts#-contributing">è´¡çŒ®&lt;/a>å‡ºæ›´å¤šçš„è§„åˆ™ã€‚&lt;/p></description></item></channel></rss>