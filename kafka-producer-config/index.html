<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.57.2" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Kafka Producer配置解读 &middot; 乱世浮生</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://atbug.comcss/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://atbug.comcss/poole.css">
  <link type="text/css" rel="stylesheet" href="https://atbug.comcss/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://atbug.comcss/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="../favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://atbug.com"><h1>乱世浮生</h1></a>
      <p class="lead">
       知我者谓我何忧 不知我者谓我何求. 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://atbug.com">Home</a> </li>
        <li><a href="../"> Home </a></li><li><a href="../post/"> Archives </a></li><li><a href="../tags/"> Tags </a></li><li><a href="../categories/"> Categories </a></li><li><a href="../about/"> About </a></li>
      </ul>
    </nav>

    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Kafka Producer配置解读</h1>
  <time datetime=2017-09-19T15:38:03Z class="post-date">Tue, Sep 19, 2017</time>
  

<p>按照重要性分类, 基于版本0.11.0.0</p>

<h2 id="高">高</h2>

<h3 id="bootstrap-servers">bootstrap.servers</h3>

<p>一组host和port用于初始化连接. 不管这里配置了多少台server, 都只是用作发现整个集群全部server信息. 这个配置不需要包含集群所有的机器信息. 但是最好多于一个, 以防服务器挂掉.</p>

<h3 id="key-serializer">key.serializer</h3>

<p>用来序列化key的<code>Serializer</code>接口的实现类.</p>

<h3 id="value-serializer">value.serializer</h3>

<p>用来序列化value的<code>Serializer</code>接口的实现类</p>

<h3 id="acks">acks</h3>

<p>producer希望leader返回的用于确认请求完成的确认数量. 可选值 all, -1, 0 1. 默认值为1</p>

<ul>
<li><code>acks=0</code> 不需要等待服务器的确认. 这是<code>retries</code>设置无效. 响应里来自服务端的offset总是-1. producer只管发不管发送成功与否。延迟低，容易丢失数据。</li>
<li><code>acks=1</code> 表示leader写入成功（但是并没有刷新到磁盘）后即向producer响应。延迟中等，一旦leader副本挂了，就会丢失数据。</li>
<li><code>acks=all</code>等待数据完成副本的复制, 等同于<code>-1</code>. 假如需要保证消息不丢失, 需要使用该设置. 同时需要设置<code>unclean.leader.election.enable</code>为true, 保证当ISR列表为空时, 选择其他存活的副本作为新的leader.</li>
</ul>

<h3 id="buffer-memory">buffer.memory</h3>

<p>producer可以使用的最大内存来缓存等待发送到server端的消息.  如果消息速度大于producer交付到server端的阻塞时间<code>max.block.ms</code>,  将会抛出异常. 默认值33554432 byte (32m). 这个设置不是一个严格的边界, 因为producer除了用来缓存消息, 还要用来进行压缩.</p>

<h3 id="compression-type">compression.type</h3>

<p>producer压缩数据的类型, 默认为none, 就是不压缩. 可选<code>none</code>, <code>gzip</code>, <code>snappy</code> 和<code>lz4</code>.  压缩整个batch的数据, 因此batch的效果对压缩率也有影响. 更多的批处理意味着更好的压缩</p>

<h3 id="retries">retries</h3>

<p>设置大于零的值将导致客户端重新发送其发送失败并发生潜在的瞬时错误的记录. 相当于client在发送失败的时候会重新发行. 如果设置了<code>retries</code>而没有将<code>max.in.flight.request.per.connection</code>设置为1, 在两个batch发送到同一个partition时有可能打乱消息的发送顺序(第一个发送失败, 而第二个发送成功)</p>

<h2 id="中">中</h2>

<h3 id="batch-size">batch.size</h3>

<p>producer会尝试批量发送属于同一个partition的消息以减少请求的数量. 这样可以提升客户端和服务端的性能. 默认大小是16348 byte (16k).</p>

<p>发送到broker的请求可以包含多个batch, 每个batch的数据属于同一个partition.</p>

<p>太小的batch会降低吞吐.  太大会浪费内存.</p>

<h3 id="client-id">client.id</h3>

<p>发送请求时传递给服务端的id字符. 用来追溯请求源, 除了使用ip/port. 服务端的请求日志中会包含一个合理的应用名. 默认为空</p>

<h3 id="linger-ms">linger.ms</h3>

<p>在正常负载的情况下, 要想减少请求的数量. 加上一个认为的延迟: 不是立即发送消息, 而是延迟等待更多的消息一起批量发送. 类似TCP中的Nagle算法. 当获得了<code>batch.size</code>的同一partition的消息会立即发送, 不管<code>linger.ms</code>的设置. 假如要发送的消息比较少, 会等待指定的时间以获取更多的消息.</p>

<p>默认设置为0 ms(没有延迟).</p>

<h4 id="max-block-ms">max.block.ms</h4>

<p>控制<code>KafkaProducer.send()</code>和<code>KafkaProducer.partitionsFor()</code>的阻塞时间. 这些方法会因为buffer满了或者metadata不可用而阻塞. 用户设置在serializers或者partitioner中的阻塞不会计算在内.</p>

<h4 id="max-request-size">max.request.size</h4>

<p>请求的最大大小（以字节为单位）。 此设置将限制生产者在单个请求中发送的记录批次数，以避免发送巨大的请求。 这也是最大记录批量大小的上限。 请注意，服务器拥有自己的记录批量大小，可能与此不同。</p>

<h4 id="partitioner-class">partitioner.class</h4>

<p><code>Partitioner</code>接口的实现类, 默认是<code>org.apache.kafka.clients.producer.internals.DefaultPartitioner</code>. 需要处理数据倾斜等原因调整分区逻辑的时候使用.</p>

<h4 id="request-timeout-ms">request.timeout.ms</h4>

<p>配置控制客户端等待请求响应的最长时间。 如果在超时之前未收到响应，客户端将在必要时重新发送请求，如果重试耗尽，则该请求将失败。 这应该大于replica.lag.time.max.ms(broker配置)，以减少由于不必要的生产者重试引起的消息重复的可能性。</p>

<h2 id="低">低</h2>

<h4 id="enable-idempotence">enable.idempotence</h4>

<p>设置为&rsquo;true&rsquo;, 将开启<code>exactly-once</code>模式. 设置为&rsquo;false&rsquo;(默认值), producer会因为borker失败等原因重试发送, 可能会导致消息重复.</p>

<p>设置为&rsquo;true&rsquo;时需要结合<code>max.in.flight.requests.per.connection</code>设为&rsquo;1&rsquo;和<code>retires</code>不能为&rsquo;0&rsquo;, 同时<code>acks</code>需要设置为&rsquo;all&rsquo;或者&rdquo;-1&rsquo;.</p>

<h4 id="interceptor-classes">interceptor.classes</h4>

<p>一组<code>ProducerInterceptor</code>接口的实现类, 默认为null. 可以通过该接口的实现类去拦截(可能需要修改)producer要发送的消息在发送到服务端之前.</p>

<h4 id="max-in-flight-requests-per-connection">max.in.flight.requests.per.connection</h4>

<p>没有被确认unacknowledge的batch数, 如果设置大于1在<code>retries</code>设置了的情况下会出现消息发送顺序错误.</p>

<h4 id="retry-backoff-ms">retry.backoff.ms</h4>

<p>失败请求重试的间隔时间. 默认是100毫秒</p>

<h4 id="transaction-timeout-ms">transaction.timeout.ms</h4>

<p>事务协调器等待producer更新事务状态的最大毫秒数, 超过的话事务协调器会终止进行中的事务. 如果设置的时间大于broker的<code>max.transaction.timeout.ms</code>会收到<code>InvalidTransactionTimeout</code>错误.</p>

<h4 id="transactional-id">transactional.id</h4>

<p>用于事务传递的TransactionalId。 这使得可以跨越多个生产者会话的可靠性语义，因为它允许客户端保证在开始任何新事务之前使用相同的TransactionalId的事务已经完成。 如果没有提供TransactionalId，则生产者被限制为幂等传递。 请注意，如果配置了TransactionalId，则必须启用enable.idempotence。 默认值为空，这意味着无法使用事务。</p>

</div>

<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "addozhang" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-47966140-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
