<!DOCTYPE html>
<html>
<head>
    <title>Zipkin dependencies的坑之一: 耗时越来越长 // 乱世浮生</title>

    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    <meta name="description" content="知我者谓我何忧 不知我者谓我何求.">
    <meta name="keywords" content="Java,Spring Cloud,Architecture,">

        <meta property="og:title" content="Zipkin dependencies的坑之一: 耗时越来越长" />
    <meta property="og:description" content="知我者谓我何忧 不知我者谓我何求." />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="zh-cn" />
    <meta property="og:url" content="https://atbug.com/zipkin-dependencies-bug-one/" />
    

    <link rel="shortcut icon" href="../favicon.ico">

    <link href="https://atbug.com/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
    <link href="https://atbug.com/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="https://atbug.com/css/style.css">
    

    <meta name="generator" content="Hugo 0.73.0" />
</head>


<body>
<div id="container">
    <header id="header">
    <div id="header-outer" class="outer">
        <div id="header-inner" class="inner">
            <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
            <a id="logo" class="logo-text" href="https://atbug.com/">乱世浮生</a>
            <nav id="main-nav">
                
                <a class="main-nav-link" href="../">Home</a>
                
                <a class="main-nav-link" href="../post/">Archives</a>
                
                <a class="main-nav-link" href="../tags/">Tags</a>
                
                <a class="main-nav-link" href="../categories/">Categories</a>
                
                <a class="main-nav-link" href="../about/">About</a>
                
            </nav>
            <nav id="sub-nav">
                <div id="search-form-wrap">
                </div>
            </nav>
        </div>
    </div>
</header>

    <section id="main" class="outer">
        <article class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            <h1 class="article-title" itemprop="name">Zipkin dependencies的坑之一: 耗时越来越长</h1>
        </header>
        
        <div class="article-meta">
            <a href="../zipkin-dependencies-bug-one/" class="article-date">
                <time datetime='2019-09-22T17:59:56.000&#43;08:00' itemprop="datePublished">2019-09-22</time>
            </a>
            
            
            <div class="post-categories">
                <div class="article-category">
                    
                    
                    <a class="article-category-link" href="https://atbug.com//categories/%E7%AC%94%E8%AE%B0">笔记</a>
                    
                </div>
            </div>
            
            
            <div class="article-comment-link-wrap">
                <a href="../zipkin-dependencies-bug-one/#disqus_thread" class="article-comment-link">Comments</a>
            </div>
            
        </div>
        <div class="article-entry" itemprop="articleBody">
            <p>zipkin-dependencies是zipkin调用链的依赖分析工具.</p>
<p>系统上线时使用了当时的最新版本<code>2.0.1</code>, 运行一年之后随着服务的增多, 分析一天的数据耗时越来越多. 从最初的几分钟, 到最慢的几十小时(数据量18m).</p>
<p>最终返现是版本的问题, 升级到&gt;=<code>2.3.0</code>的版本之后吞吐迅速上升.</p>
<p>所以便有了issue: <a href="https://github.com/openzipkin/zipkin-dependencies/issues/149">Reminder: do NOT use the version before 2.3.0</a></p>
<p>但这也引来了另一个坑: <a href="https://atbug.com/zipkin-dependencies-bug-two-timeout-and-oom/">心跳超时和Executor OOM</a></p>
<h3 id="tldr">TL;DR</h3>
<p>简单浏览了下zipkin-dependencies的源码, 2.0.1和2.3.2的比较大的差距是依赖的<code>elasticsearch-spark</code>的版本. 前者用的是<code>6.3.2</code>, 后者是<code>7.3.0</code>.</p>
<p>尝试在<code>zipkin-dependencies-2.0.1</code>中使用<code>elasticsearch-spark-7.3.0</code>, 和<code>2.3.2</code>的性能一直.</p>
<p>通过打开log4j debug日志, 发现到<code>elasticsearch-spark</code>两个版本的运行差异:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">#7.3.0
19/09/05 18:13:14 INFO DAGScheduler: Submitting 3 missing tasks from ShuffleMapStage 0 (MapPartitionsRDD[1] at groupBy at ElasticsearchDependenciesJob.java:185) (first 15 tasks are for partitions Vector(0, 1, 2))

#6.3.2
19/09/05 18:09:56 INFO DAGScheduler: Submitting 214 missing tasks from ShuffleMapStage 0 (MapPartitionsRDD[1] at groupBy at ElasticsearchDependenciesJob.java:185) (first 15 tasks are for partitions Vector(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14))
</code></pre></div><h4 id="restservicefindpartitionsl268的源码"><code>RestService#findPartitions()L268</code>的源码:</h4>
<p><code>7.3.0</code>
<img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/rXGrya.jpg" alt=""></p>
<p><code>6.3.2</code>
<img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/wswyzO.jpg" alt=""></p>
<p>7.x <code>es.input.max.docs.per.partition</code>为<code>null</code> 计算出partitions=3 (实际分区数为3, 使用方法<code>#findShardPartitions()</code>)
6.x <code>es.input.use.sliced.partitions</code>为<code>true</code>, 计算出partitions=214 (使用方法<code>#findSlicePartitions()</code>)</p>
<p>在7.x中, 可以通过设置<code>es.input.max.docs.per.partition</code>的值来设置切片数量(对单个partition进行切分, 通过增加并行任务数量来提高吞吐)</p>
<p>**该行代码的commit message: **</p>
<blockquote>
<p>Remove default setting for max documents per partition  We added support for sliced scrolls back in 5.0, which allows subdividing scrolls into smaller input splits. there are some cases where the added subdivision of the scroll operations causes high amounts of overhead when reading very large shards. in most cases, shards should be small enough that a regular read operation over them should complete in reasonable time. In order to avoid performance degradation at higher levels, we are removing the default value of 100k from this setting, and instead, checking if it is set. Additionally, the &lsquo;es.input.use.sliced.partitions&rsquo; setting has been removed as it is now redundant.</p>
</blockquote>
<p><a href="https://github.com/elastic/elasticsearch-hadoop/issues/1196">关联的issue#1196</a></p>

        </div>

        
        
        <div class="article-toc" >
            <h3></h3>
            <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#tldr">TL;DR</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
        
        

        


        
    </div>
    
<nav id="article-nav">
    
    <a href="../zipkin-dependencies-bug-two-timeout-and-oom/" id="article-nav-newer" class="article-nav-link-wrap">
        <div class="article-nav-title"><span>&lt;</span>&nbsp;
            Zipkin dependencies的坑之二: 心跳超时和Executor OOM
        </div>
    </a>
    
    
    <a href="../how-to-choose-topic-partition-count-number-kafka/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">如何选择Kafka Topic的分区数&nbsp;<span>&gt;</span></div>
    </a>
    
</nav>


</article>

        
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "addozhang" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
    </section>
    <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2020 Addo Zhang
            <br />
            Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with theme <a href="https://github.com/carsonip/hugo-theme-minos" target="_blank">Minos</a>
        </div>
    </div>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-47966140-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css" integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    <script>
        document.getElementById('main-nav-toggle').addEventListener('click', function () {
            var header = document.getElementById('header');
            if (header.classList.contains('mobile-on')) {
                header.classList.remove('mobile-on');
            } else {
                header.classList.add('mobile-on');
            }
        });
    </script>
</footer>

</div>
</body>
</html>
