<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Zipkin dependencies的坑之一: 耗时越来越长 - 乱世浮生</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Addo Zhang" /><meta name="description" content="zipkin-dependencies是zipkin调用链的依赖分析工具. 系统上线时使用了当时的最新版本2.0.1, 运行一年之后随着服务的增" /><meta name="keywords" content="Java, Spring Cloud, Architecture" />






<meta name="generator" content="Hugo 0.57.2 with theme even" />


<link rel="canonical" href="https://atbug.com/zipkin-dependencies-bug-one/" />
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="manifest" href="../manifest.json">
<link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">


<link href="../dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Zipkin dependencies的坑之一: 耗时越来越长" />
<meta property="og:description" content="zipkin-dependencies是zipkin调用链的依赖分析工具. 系统上线时使用了当时的最新版本2.0.1, 运行一年之后随着服务的增" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://atbug.com/zipkin-dependencies-bug-one/" />
<meta property="article:published_time" content="2019-09-22T17:59:56+08:00" />
<meta property="article:modified_time" content="2019-09-22T17:59:56+08:00" />
<meta itemprop="name" content="Zipkin dependencies的坑之一: 耗时越来越长">
<meta itemprop="description" content="zipkin-dependencies是zipkin调用链的依赖分析工具. 系统上线时使用了当时的最新版本2.0.1, 运行一年之后随着服务的增">


<meta itemprop="datePublished" content="2019-09-22T17:59:56&#43;08:00" />
<meta itemprop="dateModified" content="2019-09-22T17:59:56&#43;08:00" />
<meta itemprop="wordCount" content="901">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Zipkin dependencies的坑之一: 耗时越来越长"/>
<meta name="twitter:description" content="zipkin-dependencies是zipkin调用链的依赖分析工具. 系统上线时使用了当时的最新版本2.0.1, 运行一年之后随着服务的增"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="../" class="logo">乱世浮生</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="../post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="../tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="../categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="../about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="../" class="logo">乱世浮生</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="../post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Zipkin dependencies的坑之一: 耗时越来越长</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-09-22 </span>
        <div class="post-category">
            <a href="../categories/%E7%AC%94%E8%AE%B0/"> 笔记 </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#tl-dr">TL;DR</a>
<ul>
<li><a href="#restservice-findpartitions-l268-的源码"><code>RestService#findPartitions()L268</code>的源码:</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<p>zipkin-dependencies是zipkin调用链的依赖分析工具.</p>

<p>系统上线时使用了当时的最新版本<code>2.0.1</code>, 运行一年之后随着服务的增多, 分析一天的数据耗时越来越多. 从最初的几分钟, 到最慢的几十小时(数据量18m).</p>

<p>最终返现是版本的问题, 升级到&gt;=<code>2.3.0</code>的版本之后吞吐迅速上升.</p>

<p>所以便有了issue: <a href="https://github.com/openzipkin/zipkin-dependencies/issues/149">Reminder: do NOT use the version before 2.3.0</a></p>

<p>但这也引来了另一个坑: <a href="https://atbug.com/zipkin-dependencies-bug-two-timeout-and-oom/">心跳超时和Executor OOM</a></p>

<h3 id="tl-dr">TL;DR</h3>

<p>简单浏览了下zipkin-dependencies的源码, 2.0.1和2.3.2的比较大的差距是依赖的<code>elasticsearch-spark</code>的版本. 前者用的是<code>6.3.2</code>, 后者是<code>7.3.0</code>.</p>

<p>尝试在<code>zipkin-dependencies-2.0.1</code>中使用<code>elasticsearch-spark-7.3.0</code>, 和<code>2.3.2</code>的性能一直.</p>

<p>通过打开log4j debug日志, 发现到<code>elasticsearch-spark</code>两个版本的运行差异:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-log" data-lang="log"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-log" data-lang="log">#7.3.0
19/09/05 18:13:14 INFO DAGScheduler: Submitting 3 missing tasks from ShuffleMapStage 0 (MapPartitionsRDD[1] at groupBy at ElasticsearchDependenciesJob.java:185) (first 15 tasks are for partitions Vector(0, 1, 2))

#6.3.2
19/09/05 18:09:56 INFO DAGScheduler: Submitting 214 missing tasks from ShuffleMapStage 0 (MapPartitionsRDD[1] at groupBy at ElasticsearchDependenciesJob.java:185) (first 15 tasks are for partitions Vector(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14))</code></pre></td></tr></table>
</div>
</div>
<h4 id="restservice-findpartitions-l268-的源码"><code>RestService#findPartitions()L268</code>的源码:</h4>

<p><code>7.3.0</code>
<img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/rXGrya.jpg" alt="" /></p>

<p><code>6.3.2</code>
<img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/wswyzO.jpg" alt="" /></p>

<p>7.x <code>es.input.max.docs.per.partition</code>为<code>null</code> 计算出partitions=3 (实际分区数为3, 使用方法<code>#findShardPartitions()</code>)
6.x <code>es.input.use.sliced.partitions</code>为<code>true</code>, 计算出partitions=214 (使用方法<code>#findSlicePartitions()</code>)</p>

<p>在7.x中, 可以通过设置<code>es.input.max.docs.per.partition</code>的值来设置切片数量(对单个partition进行切分, 通过增加并行任务数量来提高吞吐)</p>

<p>**该行代码的commit message: **</p>

<blockquote>
<p>Remove default setting for max documents per partition  We added support for sliced scrolls back in 5.0, which allows subdividing scrolls into smaller input splits. there are some cases where the added subdivision of the scroll operations causes high amounts of overhead when reading very large shards. in most cases, shards should be small enough that a regular read operation over them should complete in reasonable time. In order to avoid performance degradation at higher levels, we are removing the default value of 100k from this setting, and instead, checking if it is set. Additionally, the &lsquo;es.input.use.sliced.partitions&rsquo; setting has been removed as it is now redundant.</p>
</blockquote>

<p><a href="https://github.com/elastic/elasticsearch-hadoop/issues/1196">关联的issue#1196</a></p>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="../zipkin-dependencies-bug-two-timeout-and-oom/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Zipkin dependencies的坑之二: 心跳超时和Executor OOM</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="../how-to-choose-topic-partition-count-number-kafka/">
            <span class="next-text nav-default">如何选择Kafka Topic的分区数</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'addozhang';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:duwasai@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/addozhang" class="iconfont icon-github" title="github"></a>
  <a href="https://atbug.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2015 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Addo Zhang</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="../dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-47966140-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
