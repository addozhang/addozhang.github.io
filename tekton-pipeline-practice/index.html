<!DOCTYPE html>
<html>
<head>
    <title>CICD: Tekton Pipeline 实战 // 乱世浮生</title>

    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    <meta name="description" content="知我者谓我何忧 不知我者谓我何求.">
    <meta name="keywords" content="Java,Spring Cloud,Architecture,">

        <meta property="og:title" content="CICD: Tekton Pipeline 实战" />
    <meta property="og:description" content="知我者谓我何忧 不知我者谓我何求." />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="zh-cn" />
    <meta property="og:url" content="https://atbug.com/tekton-pipeline-practice/" />
    

    <link rel="shortcut icon" href="../favicon.ico">

    <link href="https://atbug.com/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
    <link href="https://atbug.com/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="https://atbug.com/css/style.css">
    

    <meta name="generator" content="Hugo 0.68.3" />
</head>


<body>
<div id="container">
    <header id="header">
    <div id="header-outer" class="outer">
        <div id="header-inner" class="inner">
            <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
            <a id="logo" class="logo-text" href="https://atbug.com/">乱世浮生</a>
            <nav id="main-nav">
                
                <a class="main-nav-link" href="../">Home</a>
                
                <a class="main-nav-link" href="../post/">Archives</a>
                
                <a class="main-nav-link" href="../tags/">Tags</a>
                
                <a class="main-nav-link" href="../categories/">Categories</a>
                
                <a class="main-nav-link" href="../about/">About</a>
                
            </nav>
            <nav id="sub-nav">
                <div id="search-form-wrap">
                </div>
            </nav>
        </div>
    </div>
</header>

    <section id="main" class="outer">
        <article class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            <h1 class="article-title" itemprop="name">CICD: Tekton Pipeline 实战</h1>
        </header>
        
        <div class="article-meta">
            <a href="../tekton-pipeline-practice/" class="article-date">
                <time datetime='2020-01-21T20:19:33.000&#43;08:00' itemprop="datePublished">2020-01-21</time>
            </a>
            
            
            <div class="post-categories">
                <div class="article-category">
                    
                    
                    <a class="article-category-link" href="https://atbug.com//categories/%E7%AC%94%E8%AE%B0">笔记</a>
                    
                </div>
            </div>
            
            
            <div class="article-comment-link-wrap">
                <a href="../tekton-pipeline-practice/#disqus_thread" class="article-comment-link">Comments</a>
            </div>
            
        </div>
        <div class="article-entry" itemprop="articleBody">
            <p>Tekton 是 Google 开源的 Kubernetes 原生CI/CD 系统, 功能强大扩展性强. 前身是 Knavite 里的 build-pipeline 项目, 后期孵化成<a href="https://github.com/tektoncd/pipeline">独立的项目</a>. 并成为 <a href="https://cd.foundation/projects/">CDF</a> 下的四个项目之一, 其他三个分别是 Jenkins, Jenkins X, Spinnaker.</p>
<p>为什么说 Tekton 是 Kubernetes 原生的, 以内其基于 Kubernetes 的 CRD 定义了 Pipeline 流水线.</p>
<p><img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/bquuTV.jpg" alt=""></p>
<p>CRD 及说明:</p>
<ul>
<li>Task: 构建任务, 可以定义一些列的 steps. 每个 step 由一个 container 执行.</li>
<li>TaskRun: task 实际的执行, 并提供执行所需的参数. 这个对象创建后, 就会有 pod 被创建.</li>
<li>Pipeline: 定义一个或者多个 task 的执行, 以及 PipelineResource 和各种定义参数的集合</li>
<li>PipelineRun: 类似 task 和 taskrun 的关系: 一个定义一个执行. PipelineRun 则是 pipeline 的实际执行. 创建后也会创建 pod 来执行各个 task.</li>
<li>PipelineResource: 流水线的输入资源, 比如 github/gitlab 的源码, 某种存储服务的文件, 或者镜像等. 执行时, 也会作为 pod 的其中一个 container 来运行(比如拉取代码).</li>
<li>Condition: 在 pipeline 的 task 执行时通过添加 condition 来对条件进行评估, 进而判断是否执行 task. 目前是WIP的状态, 待<a href="https://github.com/tektoncd/pipeline/issues/1137">#1137</a>的完成.</li>
</ul>
<p><strong>组件:</strong></p>
<ul>
<li><code>tekton-pipelines-controller</code>: 监控 CRD 对象(TaskRun, PipelineRun)的创建, 为该次执行创建 pod.</li>
<li><code>tekton-pipelines-webhook</code>: 对 apiserver 提供 http 接口做 CRD 对象的校验.</li>
</ul>
<h2 id="安装">安装</h2>
<p>参考<a href="https://atbug.com/tekton-installation-and-sample/">上一篇文章</a>, 文章中有个简单的&quot;hello world&rdquo;.</p>
<h2 id="实践">实践</h2>
<p>到了这里相信已经安装好了 Tekton. 我们使用<a href="https://start.spring.io/">Spring Initializer</a>生成的项目为例, 演示如何使用 Tekton 实现 CICD.</p>
<p>开始之前简单整理下这个项目的 CICD 流程:</p>
<ol>
<li>拉取代码</li>
<li>maven 打包</li>
<li>构建镜像并推送</li>
<li>部署</li>
</ol>
<p><em>注: 所有的操作都是在 <code>tekton-pipelines</code> namespace 下操作</em></p>
<h3 id="0x00-添加-dockerfile-和部署用的-yaml">0x00 添加 dockerfile 和部署用的 yaml</h3>
<p>用于构建镜像的Dockerfile</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">FROM openjdk:8-jdk-alpine

RUN mkdir /app
WORKDIR /app
COPY target/*.jar /app/app.jar
ENTRYPOINT [&#34;sh&#34;, &#34;-c&#34;, &#34;java -Xmx128m -Xms64m -jar app.jar&#34;]
</code></pre></div><p>用于部署 K8s Deployment 的deployment.yml</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;apps/v1&#34;</span><span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Deployment&#34;</span><span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tekton-test&#34;</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tekton-test&#34;</span><span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">app</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tekton-test&#34;</span><span class="w">
</span><span class="w">  </span><span class="k">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">app</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tekton-test&#34;</span><span class="w">
</span><span class="w">    </span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">containers</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">image</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;addozhang/tekton-test:latest&#34;</span><span class="w">
</span><span class="w">          </span><span class="k">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Always&#34;</span><span class="w">
</span><span class="w">          </span><span class="k">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">            </span><span class="k">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/actuator/info&#34;</span><span class="w">
</span><span class="w">              </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">              </span><span class="k">scheme</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;HTTP&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">            </span><span class="k">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">            </span><span class="k">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">            </span><span class="k">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">          </span><span class="k">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tekton-test&#34;</span><span class="w">
</span><span class="w">          </span><span class="k">ports</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="k">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">              </span><span class="k">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http&#34;</span><span class="w">
</span><span class="w">              </span><span class="k">protocol</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;TCP&#34;</span><span class="w">
</span><span class="w">          </span><span class="k">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">            </span><span class="k">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/actuator/info&#34;</span><span class="w">
</span><span class="w">              </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">              </span><span class="k">scheme</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;HTTP&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span><span class="w">            </span><span class="k">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">            </span><span class="k">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">            </span><span class="k">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></code></pre></div><h3 id="0x01-拉取代码">0x01 拉取代码</h3>
<p>代码作为构建的输入, 需要提供一个 Pipeline CRD 对象来表示输入是从 git 仓库来获取代码</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>tekton.dev/v1alpha1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>PipelineResource<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>git-source<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">type</span><span class="p">:</span><span class="w"> </span>git<span class="w">
</span><span class="w">  </span><span class="k">params</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>revision<span class="w">
</span><span class="w">      </span><span class="k">value</span><span class="p">:</span><span class="w"> </span>master<span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>url<span class="w">
</span><span class="w">      </span><span class="k">value</span><span class="p">:</span><span class="w"> </span>https<span class="p">:</span>//github.com/addozhang/tekton-test.git<span class="w">
</span></code></pre></div><p><strong>说明:</strong></p>
<ul>
<li>type: 表示资源类型为 git</li>
<li>revision: 表示从仓库的 master 分支拉取代码</li>
<li>url: 表示仓库的位置</li>
</ul>
<p>由于测试的代码放在 github 上作为public 仓库, 所以这里不需要 ssh key. 如果是私有仓库, 请参考<a href="https://github.com/tektoncd/pipeline/blob/master/docs/auth.md">官方文档</a></p>
<p><strong>执行:</strong>
添加资源对象<code>kubectl apply -f resource/git-resource.yaml</code></p>
<p>运行<code>tkn res list</code>检查资源</p>
<pre><code>NAME         TYPE   DETAILS
git-source   git    url: https://github.com/addozhang/tekton-test.git
</code></pre>
<h3 id="0x02-maven-打包">0x02 maven 打包</h3>
<p>Task <code>source-to-image.yaml</code>: step <code>maven</code></p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>git-source<span class="w">
</span><span class="w">        </span><span class="k">type</span><span class="p">:</span><span class="w"> </span>git<span class="w">
</span><span class="w">  </span><span class="k">steps</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>maven<span class="w">
</span><span class="w">      </span><span class="k">image</span><span class="p">:</span><span class="w"> </span>maven<span class="p">:</span><span class="m">3.5.0</span>-jdk<span class="m">-8</span>-alpine<span class="w">
</span><span class="w">      </span><span class="k">workingDir</span><span class="p">:</span><span class="w"> </span>/workspace/git-source<span class="w">
</span><span class="w">      </span><span class="k">command</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- mvn<span class="w">
</span><span class="w">      </span><span class="k">args</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- clean<span class="w">
</span><span class="w">        </span>- install<span class="w">
</span><span class="w">        </span>- -DskipTests<span class="w">
</span><span class="w">      </span><span class="k">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>m2<span class="w">
</span><span class="w">          </span><span class="k">mountPath</span><span class="p">:</span><span class="w"> </span>/root/.m2<span class="w">
</span><span class="w">  </span><span class="k">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>m2<span class="w">
</span><span class="w">      </span><span class="k">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">path</span><span class="p">:</span><span class="w"> </span>/home/docker/.m2<span class="w">                  
</span></code></pre></div><p><strong>说明:</strong></p>
<p>有了代码下一步就是执行 maven 的编译打包, 在<code>maven:3.5.0-jdk-8-alpine</code>镜像中执行<code>mvn</code>的相关命令.</p>
<p>这里挂在了一个本地的volume, 避免每次构建重复下载依赖包, 同时里面还有<code> settings.xml</code></p>
<p><em>注意: 对于 minikube, hostPath 请使用/data/.m2, 否则minikube重启后无法持久化</em></p>
<h3 id="0x03-构建镜像并推送">0x03 构建镜像并推送</h3>
<p>Task <code>source-to-image.yaml</code>: step <code>build-and-push</code></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">spec:
  inputs:
    resources:
      - name: git-source
        type: git
    params:
      - name: pathToContext
        description: The path to the build context, used by Kaniko - within the workspace
        default: .
      - name: pathToDockerFile
        description: The path to the dockerfile to build (relative to the context)
        default: Dockerfile
      - name: imageUrl
        description: Url of image repository
      - name: imageTag
        description: Tag to apply to the built image
        default: latest        
  steps:
    - name: build-and-push
      image: gcr.io/kaniko-project/executor
      command:
        - /kaniko/executor
      args:
        - --dockerfile=$(inputs.params.pathToDockerFile)
        - --destination=$(inputs.params.imageUrl):$(inputs.params.imageTag)
        - --context=/workspace/git-source/$(inputs.params.pathToContext)
</code></pre></div><p><strong>说明:</strong></p>
<p>镜像的构建, 我们采用了 kaniko.</p>
<p>镜像仓库我们选择了Docker Hub, 推送的时候需要使用 credentials.</p>
<p>先添加<code> docker-registry</code>类型的 <code>secret</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create secret docker-registry dockerhub --docker-server<span class="o">=</span>https://index.docker.io/v1/ --docker-username<span class="o">=</span>&lt;USERNAME&gt; --docker-password<span class="o">=</span>&lt;PASSWORD&gt;
</code></pre></div><p>创建 <code>ServiceAccount</code>, 并指定上面创建的 secret</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>ServiceAccount<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>tekton-test<span class="w">
</span><span class="w"></span><span class="k">secrets</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>dockerhub<span class="w">
</span></code></pre></div><p>执行 pipeline 的时候需要该<code> ServiceAccount</code>. (后面会提到)</p>
<p><strong>执行:</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f tasks/source-to-image.yaml
</code></pre></div><h3 id="0x04-部署">0x04 部署</h3>
<p>deploy-to-k8s.yaml:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>tekton.dev/v1alpha1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Task<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>deploy-to-k8s<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>git-source<span class="w">
</span><span class="w">        </span><span class="k">type</span><span class="p">:</span><span class="w"> </span>git<span class="w">
</span><span class="w">    </span><span class="k">params</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>pathToYamlFile<span class="w">
</span><span class="w">        </span><span class="k">description</span><span class="p">:</span><span class="w"> </span>The<span class="w"> </span>path<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>yaml<span class="w"> </span>file<span class="w"> </span>to<span class="w"> </span>deploy<span class="w"> </span>within<span class="w"> </span>the<span class="w"> </span>git<span class="w"> </span>source<span class="w">
</span><span class="w">        </span><span class="k">default</span><span class="p">:</span><span class="w"> </span>deployment.yaml<span class="w">
</span><span class="w">  </span><span class="k">steps</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>run-kubectl<span class="w">
</span><span class="w">      </span><span class="k">image</span><span class="p">:</span><span class="w"> </span>lachlanevenson/k8s-kubectl<span class="w">
</span><span class="w">      </span><span class="k">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;kubectl&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">      </span><span class="k">args</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="s2">&#34;apply&#34;</span><span class="w">
</span><span class="w">        </span>- <span class="s2">&#34;-f&#34;</span><span class="w">
</span><span class="w">        </span>- <span class="s2">&#34;/workspace/git-source/$(inputs.params.pathToYamlFile)&#34;</span><span class="w">
</span></code></pre></div><p><strong>说明:</strong></p>
<ul>
<li>pathToYamlFile: 指定部署应用的 yaml.</li>
</ul>
<p>需要为上面创建的 <code>ServiceAccount</code> 添加分配权限用于对象的操作: 这里直接给了 <code>admin</code> <code>clusterrole</code>, 实际不需要对权限进行细分控制.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create clusterrolebinding pipeline-admin-binding --clusterrole<span class="o">=</span>admin --serviceaccount<span class="o">=</span>tekton-pipelines:tekton-test
</code></pre></div><p><strong>执行:</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f tasks/deploy-to-k8s.yaml
</code></pre></div><h3 id="0x05-组装流水线">0x05 组装流水线</h3>
<p><code>build-pipeline.yaml</code></p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>tekton.dev/v1alpha1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Pipeline<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>build-pipeline<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>git-source<span class="w">
</span><span class="w">      </span><span class="k">type</span><span class="p">:</span><span class="w"> </span>git<span class="w">
</span><span class="w">  </span><span class="k">params</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>pathToContext<span class="w">
</span><span class="w">      </span><span class="k">description</span><span class="p">:</span><span class="w"> </span>The<span class="w"> </span>path<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>build<span class="w"> </span>context<span class="p">,</span><span class="w"> </span>used<span class="w"> </span>by<span class="w"> </span>Kaniko<span class="w"> </span>- within<span class="w"> </span>the<span class="w"> </span>workspace<span class="w">
</span><span class="w">      </span><span class="k">default</span><span class="p">:</span><span class="w"> </span>.<span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>imageUrl<span class="w">
</span><span class="w">      </span><span class="k">description</span><span class="p">:</span><span class="w"> </span>Url<span class="w"> </span>of<span class="w"> </span>image<span class="w"> </span>repository<span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>imageTag<span class="w">
</span><span class="w">      </span><span class="k">description</span><span class="p">:</span><span class="w"> </span>Tag<span class="w"> </span>to<span class="w"> </span>apply<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>built<span class="w"> </span>image<span class="w">
</span><span class="w">  </span><span class="k">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>source-to-image<span class="w">
</span><span class="w">    </span><span class="k">taskRef</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>source-to-image<span class="w">
</span><span class="w">    </span><span class="k">params</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>pathToContext<span class="w">
</span><span class="w">        </span><span class="k">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;$(params.pathToContext)&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>imageUrl<span class="w">
</span><span class="w">        </span><span class="k">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;$(params.imageUrl)&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>imageTag<span class="w">
</span><span class="w">        </span><span class="k">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;$(params.imageTag)&#34;</span><span class="w">
</span><span class="w">    </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>git-source<span class="w">
</span><span class="w">          </span><span class="k">resource</span><span class="p">:</span><span class="w"> </span>git-source<span class="w">
</span><span class="w">  </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>deploy-to-k8s<span class="w">
</span><span class="w">    </span><span class="k">runAfter</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- source-to-image<span class="w">
</span><span class="w">    </span><span class="k">taskRef</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>deploy-to-k8s<span class="w">
</span><span class="w">    </span><span class="k">params</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>pathToYamlFile<span class="w">
</span><span class="w">        </span><span class="k">value</span><span class="p">:</span><span class="w"> </span>deployment.yaml<span class="w">
</span><span class="w">    </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>git-source<span class="w">
</span><span class="w">          </span><span class="k">resource</span><span class="p">:</span><span class="w"> </span>git-source<span class="w">
</span></code></pre></div><p><strong>执行:</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f tasks/deploy-to-k8s.yaml
</code></pre></div><h3 id="0x06-执行流水线">0x06 执行流水线</h3>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>tekton.dev/v1alpha1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>PipelineRun<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">generateName</span><span class="p">:</span><span class="w"> </span>generic-pr<span class="sd">-
</span><span class="sd">  name: generic-pipeline-run</span><span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">pipelineRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>build-pipeline<span class="w">
</span><span class="w">  </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>git-source<span class="w">
</span><span class="w">      </span><span class="k">resourceRef</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>git-source<span class="w">
</span><span class="w">  </span><span class="k">params</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>imageUrl<span class="w">
</span><span class="w">      </span><span class="k">value</span><span class="p">:</span><span class="w"> </span>addozhang/tekton-test<span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>imageTag<span class="w">
</span><span class="w">      </span><span class="k">value</span><span class="p">:</span><span class="w"> </span>latest<span class="w">
</span><span class="w">  </span><span class="k">serviceAccountName</span><span class="p">:</span><span class="w"> </span>tekton-test<span class="w">
</span></code></pre></div><p><strong>执行:</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f run/run.yaml
</code></pre></div><h3 id="0x07结果">0x07结果</h3>
<p>执行流水线后, 可以看到分别创建了下面的几个 pod:</p>
<ol>
<li><code>generic-pipeline-run-source-to-image-ltcnh-pod-xxxxx</code></li>
<li><code>generic-pipeline-run-deploy-to-k8s-lxmnh-pod-xxxxx</code></li>
<li><code>tekton-test-xxxx-xxxx</code></li>
</ol>
<p>就此我们完成了使用 Tekton 部署 Java 应用</p>
<p>做个端口转发:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">kubectl port-forward &lt;POD_NAME&gt; 8080
</code></pre></div><p>访问应用的<code>/hi</code>接口: <code>curl http://localhost:8080/hi</code>, 成功返回<code> hello world</code></p>
<h2 id="总结">总结</h2>
<p>目前 Tekton 还只是出于 alpha 阶段, 最新的版本是<code> 0.9.0</code>. 提供的 Dashboard 也是比较简陋的, 后期会提供可视化的界面.</p>
<p>基于 CRD 的实现让 Tekton 在实际使用中可以灵活的设计自己的 CICD 流程.</p>
<p>接下来准备再写下<a href="https://github.com/tektoncd/dashboard">Dashboard</a>的安装, 及<a href="https://github.com/tektoncd/triggers">Triggers</a>的入门.</p>
<p>文中的 Java 项目以及 tekton 的相关 yaml 都已经提交到了 <a href="https://github.com/addozhang/tekton-test">tekton-test</a>.</p>
<p>更多文章:</p>
<ul>
<li><a href="https://atbug.com/tekton-dashboard-installation/">Tekton Dashboard 安装</a></li>
<li><a href="https://atbug.com/tekton-trigger-glance/">Tekton Trigger 介绍</a></li>
<li><a href="https://atbug.com/tekton-trigger-practice/">Tekton Trigger 实战</a></li>
</ul>

        </div>

        
        
        <div class="article-toc" >
            <h3></h3>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#安装">安装</a></li>
    <li><a href="#实践">实践</a>
      <ul>
        <li><a href="#0x00-添加-dockerfile-和部署用的-yaml">0x00 添加 dockerfile 和部署用的 yaml</a></li>
        <li><a href="#0x01-拉取代码">0x01 拉取代码</a></li>
        <li><a href="#0x02-maven-打包">0x02 maven 打包</a></li>
        <li><a href="#0x03-构建镜像并推送">0x03 构建镜像并推送</a></li>
        <li><a href="#0x04-部署">0x04 部署</a></li>
        <li><a href="#0x05-组装流水线">0x05 组装流水线</a></li>
        <li><a href="#0x06-执行流水线">0x06 执行流水线</a></li>
        <li><a href="#0x07结果">0x07结果</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
        </div>
        
        

        


        
        <footer class="article-footer">
            <ul class="article-tag-list">
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://atbug.com//tags/cicd">CICD
                    </a>
                </li>
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://atbug.com//tags/tekton">Tekton
                    </a>
                </li>
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://atbug.com//tags/kubernetes">Kubernetes
                    </a>
                </li>
                
            </ul>
        </footer>
        
    </div>
    <nav id="article-nav">
    
    <a href="../tekton-dashboard-installation/" id="article-nav-newer" class="article-nav-link-wrap">
        <div class="article-nav-title"><span>&lt;</span>&nbsp;
            Tekton Dashboard 安装
        </div>
    </a>
    
    
    <a href="../tekton-0.9.0-release/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">Tekton 0.9.0 更新&nbsp;<span>&gt;</span></div>
    </a>
    
</nav>

</article>

        
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "addozhang" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
    </section>
    <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2020 Addo Zhang
            <br />
            Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with theme <a href="https://github.com/carsonip/hugo-theme-minos" target="_blank">Minos</a>
        </div>
    </div>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-47966140-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css" integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    <script>
        document.getElementById('main-nav-toggle').addEventListener('click', function () {
            var header = document.getElementById('header');
            if (header.classList.contains('mobile-on')) {
                header.classList.remove('mobile-on');
            } else {
                header.classList.add('mobile-on');
            }
        });
    </script>
</footer>

</div>
</body>
</html>
