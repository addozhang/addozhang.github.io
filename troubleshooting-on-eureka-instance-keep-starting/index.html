<!DOCTYPE html>
<html>
<head>
    <title>Eureka 实例注册状态保持 STARTING 的问题排查 // 乱世浮生</title>

    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    <meta name="description" content="知我者谓我何忧 不知我者谓我何求.">
    <meta name="keywords" content="Java,Spring Cloud,Architecture,">

        <meta property="og:title" content="Eureka 实例注册状态保持 STARTING 的问题排查" />
    <meta property="og:description" content="知我者谓我何忧 不知我者谓我何求." />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="zh-cn" />
    <meta property="og:url" content="https://atbug.com/troubleshooting-on-eureka-instance-keep-starting/" />
    

    <link rel="shortcut icon" href="../favicon.ico">

    <link href="https://atbug.com/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
    <link href="https://atbug.com/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="https://atbug.com/css/style.css">
    

    <meta name="generator" content="Hugo 0.68.3" />
</head>


<body>
<div id="container">
    <header id="header">
    <div id="header-outer" class="outer">
        <div id="header-inner" class="inner">
            <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
            <a id="logo" class="logo-text" href="https://atbug.com/">乱世浮生</a>
            <nav id="main-nav">
                
                <a class="main-nav-link" href="../">Home</a>
                
                <a class="main-nav-link" href="../post/">Archives</a>
                
                <a class="main-nav-link" href="../tags/">Tags</a>
                
                <a class="main-nav-link" href="../categories/">Categories</a>
                
                <a class="main-nav-link" href="../about/">About</a>
                
            </nav>
            <nav id="sub-nav">
                <div id="search-form-wrap">
                </div>
            </nav>
        </div>
    </div>
</header>

    <section id="main" class="outer">
        <article class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            <h1 class="article-title" itemprop="name">Eureka 实例注册状态保持 STARTING 的问题排查</h1>
        </header>
        
        <div class="article-meta">
            <a href="../troubleshooting-on-eureka-instance-keep-starting/" class="article-date">
                <time datetime='2020-05-28T22:04:02.000&#43;08:00' itemprop="datePublished">2020-05-28</time>
            </a>
            
            
            <div class="post-categories">
                <div class="article-category">
                    
                    
                    <a class="article-category-link" href="https://atbug.com//categories/%E7%AC%94%E8%AE%B0">笔记</a>
                    
                </div>
            </div>
            
            
            <div class="article-comment-link-wrap">
                <a href="../troubleshooting-on-eureka-instance-keep-starting/#disqus_thread" class="article-comment-link">Comments</a>
            </div>
            
        </div>
        <div class="article-entry" itemprop="articleBody">
            <p><img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/28/maninblackshirtandgraydenimpantssittingongray11342.jpg" alt=""></p>
<p>这是真实发生在生产环境的 case，实例启动后正常运行，而在注册中心的状态一直保持<code>STARTING</code>，而本地的状态为<code>UP</code>。导致服务的消费方无法发现可用实例。</p>
<p>这种情况的出现概率非常低，运行一年多未发现两个实例同时出现问题的情况，因此多实例运行可以避免。文末有问题的解决方案，不想花时间看分析过程可直接跳到最后。</p>
<p>环境说明：</p>
<blockquote>
<p>eureka-client: 1.7.2
spring-boot: 1.5.12.RELEASE
spring-cloud: Edgware.SR3</p>
</blockquote>
<h2 id="问题重现">问题重现</h2>
<p>借助<code>Btrace</code>重现, <code>java -noverify -cp .:btrace-boot.jar -javaagent:btrace-agent.jar=script=&lt;pre-compiled-btrace-script&gt; &lt;MainClass&gt; &lt;AppArguments&gt;</code></p>
<h3 id="思路">思路</h3>
<p>主线程更新实例本地状态(STARTING-&gt;UP)前, 等待心跳线程完成第一次心跳并尝试注册实例, 获取到当前的状态<code>STARTING</code>. 主线程更新状态后触发</p>
<p><a href="https://gist.github.com/addozhang/9b584470558beb862abeb93e74c1a9b4">Btrace 脚本</a></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">com.sun.btrace.annotations.BTrace</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.btrace.annotations.Kind</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.btrace.annotations.Location</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.btrace.annotations.OnMethod</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicBoolean</span><span class="o">;</span>

<span class="kn">import static</span> <span class="nn">com.sun.btrace.BTraceUtils.currentThread</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">com.sun.btrace.BTraceUtils.println</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author Addo.Zhang
</span><span class="cm"> * @date 2019-07-31
</span><span class="cm"> */</span>
<span class="nd">@BTrace</span><span class="o">(</span><span class="n">unsafe</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EurekaRequest</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">AtomicBoolean</span> <span class="n">heartbeatThreadRegistrationStarted</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicBoolean</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">AtomicBoolean</span> <span class="n">replicatorThreadRegistrationCompleted</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicBoolean</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">AtomicBoolean</span> <span class="n">statusUP</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicBoolean</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

    <span class="nd">@OnMethod</span><span class="o">(</span><span class="n">clazz</span> <span class="o">=</span> <span class="s">&#34;org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistry&#34;</span><span class="o">,</span> <span class="n">location</span> <span class="o">=</span> <span class="nd">@Location</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">Kind</span><span class="o">.</span><span class="na">LINE</span><span class="o">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">45</span><span class="o">))</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">waitHeartbeatExecution</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">println</span><span class="o">(</span><span class="n">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; is waiting heartbeatThreadRegistrationStarted thread executing first&#34;</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">heartbeatThreadRegistrationStarted</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@OnMethod</span><span class="o">(</span><span class="n">clazz</span> <span class="o">=</span> <span class="s">&#34;org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistry&#34;</span><span class="o">,</span> <span class="n">location</span> <span class="o">=</span> <span class="nd">@Location</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">Kind</span><span class="o">.</span><span class="na">LINE</span><span class="o">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">46</span><span class="o">))</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">markStatusUp</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">statusUP</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">println</span><span class="o">(</span><span class="s">&#34;Heartbeat thread executed and &#34;</span> <span class="o">+</span> <span class="n">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; continues procedure to change status to [UP]&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@OnMethod</span><span class="o">(</span><span class="n">clazz</span> <span class="o">=</span> <span class="s">&#34;com.netflix.discovery.converters.EurekaJacksonCodec$InstanceInfoSerializer&#34;</span><span class="o">,</span> <span class="n">location</span> <span class="o">=</span> <span class="nd">@Location</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">Kind</span><span class="o">.</span><span class="na">LINE</span><span class="o">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">369</span><span class="o">))</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">continueRegistrationExecution</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">doExecution</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@OnMethod</span><span class="o">(</span><span class="n">clazz</span> <span class="o">=</span> <span class="s">&#34;com.logancloud.forge.discovery.converters.LoganEurekaJacksonCodec$LoganInstanceInfoSerializer&#34;</span><span class="o">,</span> <span class="n">location</span> <span class="o">=</span> <span class="nd">@Location</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">Kind</span><span class="o">.</span><span class="na">LINE</span><span class="o">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">117</span><span class="o">))</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">continueRegistrationExecution2</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">doExecution</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doExecution</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">println</span><span class="o">(</span><span class="n">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; started to proceed registration&#34;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&#34;HeartbeatExecutor&#34;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">heartbeatThreadRegistrationStarted</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(!</span><span class="n">statusUP</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">replicatorThreadRegistrationCompleted</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">500</span><span class="o">);</span> <span class="c1">//interval for replicator registration request completed.
</span><span class="c1"></span>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&#34;InstanceInfoReplicator&#34;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">replicatorThreadRegistrationCompleted</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">println</span><span class="o">(</span><span class="n">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; thread registration completed&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/28/15652581664364.jpg" alt=""></p>
<ol>
<li>心跳线程<code>HeartbeatThread</code>发送心跳请求(<code>PUT</code>), 注册中心返回404.</li>
<li>实例信息同步线程<code>InstanceInfoReplicator</code>发送注册请求(<code>POST</code>): 状态为<code>UP</code>, <code>lastDirtyTimestamp</code>为<code>a</code></li>
<li>心跳线程发送实例注册请求(<code>POST</code>): 状态为<code>STARTING</code>, <code>lastDirtyTimestamp</code>为<code>a</code></li>
</ol>
<h2 id="服务注册">服务注册</h2>
<p>先分析服务实例的注册逻辑.</p>
<h3 id="instanceinfo初始化">InstanceInfo初始化</h3>
<p>通过<code>InstanceInfoFactory#create()</code>方法来初始化<code>ApplicationInfoManager.instanceInfo</code>实例时, 实例状态被设置为<code>STARTING</code></p>
<h3 id="服务实例注册">服务实例注册</h3>
<p>服务实例注册的真正逻辑是在<code>DiscoveryClient#register()</code>中完成的. 但是这个方法的调用却有两个入口, 在整个过程中可解释为主动注册和被动注册.</p>
<h4 id="一-主动注册">一. 主动注册</h4>
<p><code>EurekaAutoServiceRegistration</code>实现了<code>SmartLifecycle</code>接口, 在<code>EurekaClientAutoConfiguration#eurekaAutoServiceRegistration()</code>被实例化.</p>
<p><code>EurekaAutoServiceRegistration#start()</code>方法将<code>EurekaRegistration</code>注册给<code>EurekaServiceRegistry</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">running</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">registration</span><span class="o">.</span><span class="na">getNonSecurePort</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//调用EurekaServiceRegistry进行注册
</span><span class="c1"></span>    	<span class="k">this</span><span class="o">.</span><span class="na">serviceRegistry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registration</span><span class="o">);</span>
    	<span class="c1">//发布实例注册的事件
</span><span class="c1"></span>    	<span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">publishEvent</span><span class="o">(</span>
    			<span class="k">new</span> <span class="n">InstanceRegisteredEvent</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registration</span><span class="o">.</span><span class="na">getInstanceConfig</span><span class="o">()));</span>
    	<span class="k">this</span><span class="o">.</span><span class="na">running</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><hr>
<p><code>EurekaServiceRegistry#register()</code>:
先将实例状态设置为初始状态<strong>UP</strong>(可通过<code>eureka.instance.initial-status</code>修改, 默认为<code>UP</code>). 这里会触发<code>StatusChangeListener#notify()</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">EurekaRegistration</span> <span class="n">reg</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">maybeInitializeClient</span><span class="o">(</span><span class="n">reg</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Registering application &#34;</span> <span class="o">+</span> <span class="n">reg</span><span class="o">.</span><span class="na">getInstanceConfig</span><span class="o">().</span><span class="na">getAppname</span><span class="o">()</span>
				<span class="o">+</span> <span class="s">&#34; with eureka with status &#34;</span>
				<span class="o">+</span> <span class="n">reg</span><span class="o">.</span><span class="na">getInstanceConfig</span><span class="o">().</span><span class="na">getInitialStatus</span><span class="o">());</span>
	<span class="o">}</span>
	<span class="c1">//1
</span><span class="c1"></span>	<span class="n">reg</span><span class="o">.</span><span class="na">getApplicationInfoManager</span><span class="o">()</span>
			<span class="o">.</span><span class="na">setInstanceStatus</span><span class="o">(</span><span class="n">reg</span><span class="o">.</span><span class="na">getInstanceConfig</span><span class="o">().</span><span class="na">getInitialStatus</span><span class="o">());</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">reg</span><span class="o">.</span><span class="na">getHealthCheckHandler</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	   <span class="c1">//2
</span><span class="c1"></span>		<span class="n">reg</span><span class="o">.</span><span class="na">getEurekaClient</span><span class="o">().</span><span class="na">registerHealthCheck</span><span class="o">(</span><span class="n">reg</span><span class="o">.</span><span class="na">getHealthCheckHandler</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><code>DiscoveryClient</code>内部匿名类提供了<code>StatusChangeListener</code>的实现, 调用<code>InstanceInfoReplicator#onDemandUpdate()</code></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">statusChangeListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplicationInfoManager</span><span class="o">.</span><span class="na">StatusChangeListener</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&#34;statusChangeListener&#34;</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">notify</span><span class="o">(</span><span class="n">StatusChangeEvent</span> <span class="n">statusChangeEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">InstanceStatus</span><span class="o">.</span><span class="na">DOWN</span> <span class="o">==</span> <span class="n">statusChangeEvent</span><span class="o">.</span><span class="na">getStatus</span><span class="o">()</span> <span class="o">||</span>
                <span class="n">InstanceStatus</span><span class="o">.</span><span class="na">DOWN</span> <span class="o">==</span> <span class="n">statusChangeEvent</span><span class="o">.</span><span class="na">getPreviousStatus</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// log at warn level if DOWN was involved
</span><span class="c1"></span>            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Saw local status change event {}&#34;</span><span class="o">,</span> <span class="n">statusChangeEvent</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Saw local status change event {}&#34;</span><span class="o">,</span> <span class="n">statusChangeEvent</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">instanceInfoReplicator</span><span class="o">.</span><span class="na">onDemandUpdate</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre></div><p><code>InstanceInfoReplicator</code>是在<code>DiscoveryClient#initScheduledTasks()</code>中实例化的<code>Runnable</code>的实现, 实例化之后, 使用其内部的调度线程池调度一个线程. 而<code>onDemandUpdate()</code>也同样会使用调度线程池调度一个线程.</p>
<p>其<code>#run()</code>方法会调用<code>DiscoveryClient#refreshInstanceInfo()</code>来更新状态. 状态的更新是通过<code>HealthCheckHandler</code>来实现的, 具体请看<a href="#%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5">状态检查</a>. 然后调用<code>DiscoveryClient#register()</code>方法进行注册.</p>
<h4 id="二-被动注册">二. 被动注册</h4>
<p>上面提到了<code>DiscoveryClient#initScheduledTasks()</code>, 这里的task除了<code>InstanceInfoReplicator</code>之外还有其他的线程. 其中一个是线条线程<code>HeartbeatThread</code>. 这个线程会每隔一段时间向注册中心发送一个<code>PUT</code>类型的HTTP请求: 上报实例的状态(状态(status), 以及状态修改的时间(lastDirtyTimestamp)).</p>
<p>这个请求可能会有两种结果: <code>404</code>和<code>200</code>. 前者说明注册中心中还没有这个实例的注册信息; 后者说明状态上报成功.</p>
<p>假如是<code>404</code>, 便直接发起注册的动作, 即调用<code>DiscoveryClient#register()</code>方法进行注册.</p>
<h4 id="状态检查">状态检查</h4>
<p><img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/28/15459820056548.jpg" alt=""></p>
<p><code>CloudEurekaClient</code>通过<code>HealthCheckHandler</code>来检查实例的健康状态, 看下<code>HealthCheckCallbackToHandlerBridge</code>实现: callback为空, 或者当前状态为<code>STARTING</code>或者<code>OUT_OF_SERVICE</code>时, 返回当前的状态. 我们没有设置callback, 故而总是会返回当前的状态. 比如应用启动的初始状态为<code>STARTING</code></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">InstanceInfo</span><span class="o">.</span><span class="na">InstanceStatus</span> <span class="nf">getStatus</span><span class="o">(</span><span class="n">InstanceInfo</span><span class="o">.</span><span class="na">InstanceStatus</span> <span class="n">currentStatus</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">callback</span> <span class="o">||</span> <span class="n">InstanceInfo</span><span class="o">.</span><span class="na">InstanceStatus</span><span class="o">.</span><span class="na">STARTING</span> <span class="o">==</span> <span class="n">currentStatus</span>
            <span class="o">||</span> <span class="n">InstanceInfo</span><span class="o">.</span><span class="na">InstanceStatus</span><span class="o">.</span><span class="na">OUT_OF_SERVICE</span> <span class="o">==</span> <span class="n">currentStatus</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// Do not go to healthcheck handler if the status is starting or OOS.
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">currentStatus</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">callback</span><span class="o">.</span><span class="na">isHealthy</span><span class="o">()</span> <span class="o">?</span> <span class="n">InstanceInfo</span><span class="o">.</span><span class="na">InstanceStatus</span><span class="o">.</span><span class="na">UP</span> <span class="o">:</span> <span class="n">InstanceInfo</span><span class="o">.</span><span class="na">InstanceStatus</span><span class="o">.</span><span class="na">DOWN</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h2 id="问题分析">问题分析</h2>
<h3 id="现象">现象</h3>
<h4 id="tcp抓包">TCP抓包</h4>
<p>HeartBeat请求和Fetch请求正常. <code>status=UP&amp;lastDirtyTimestamp=1545039481813</code></p>
<p><img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/28/15459763724617.jpg" alt=""></p>
<h4 id="堆信息">堆信息</h4>
<p>本地状态为UP, <code>lastDirtyTimestamp</code>为1545039481813, <code>lastUpdatedTimestamp</code>为1545039472888</p>
<p><img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/28/15459778021925.jpg" alt=""></p>
<h4 id="注册中心里的实例信息">注册中心里的实例信息</h4>
<p>状态为STARTING, <code>lastDirtyTimestamp</code>为1545039481813, <code>registrationTimestamp</code>为1545039481898, <code>lastUpdatedTimestamp</code>为1545039481899</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"> <span class="nt">&lt;instance&gt;</span>
      <span class="nt">&lt;instanceId&gt;</span>xp-xtower-webapp-boot-6-txcxb:xp-xtower-webapp-boot:10100<span class="nt">&lt;/instanceId&gt;</span>
      <span class="nt">&lt;hostName&gt;</span>10.128.41.74<span class="nt">&lt;/hostName&gt;</span>
      <span class="nt">&lt;app&gt;</span>XP-XTOWER-WEBAPP-BOOT<span class="nt">&lt;/app&gt;</span>
      <span class="nt">&lt;ipAddr&gt;</span>10.128.41.74<span class="nt">&lt;/ipAddr&gt;</span>
      <span class="nt">&lt;status&gt;</span>STARTING<span class="nt">&lt;/status&gt;</span>
      <span class="nt">&lt;overriddenstatus&gt;</span>UNKNOWN<span class="nt">&lt;/overriddenstatus&gt;</span>
      <span class="nt">&lt;port</span> <span class="na">enabled=</span><span class="s">&#34;true&#34;</span><span class="nt">&gt;</span>10100<span class="nt">&lt;/port&gt;</span>
      <span class="nt">&lt;securePort</span> <span class="na">enabled=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>443<span class="nt">&lt;/securePort&gt;</span>
      <span class="nt">&lt;countryId&gt;</span>1<span class="nt">&lt;/countryId&gt;</span>
      <span class="nt">&lt;dataCenterInfo</span> <span class="na">class=</span><span class="s">&#34;com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo&#34;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;name&gt;</span>MyOwn<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;/dataCenterInfo&gt;</span>
      <span class="nt">&lt;leaseInfo&gt;</span>
        <span class="nt">&lt;renewalIntervalInSecs&gt;</span>5<span class="nt">&lt;/renewalIntervalInSecs&gt;</span>
        <span class="nt">&lt;durationInSecs&gt;</span>20<span class="nt">&lt;/durationInSecs&gt;</span>
        <span class="nt">&lt;registrationTimestamp&gt;</span>1545039481898<span class="nt">&lt;/registrationTimestamp&gt;</span>
        <span class="nt">&lt;lastRenewalTimestamp&gt;</span>1545950719063<span class="nt">&lt;/lastRenewalTimestamp&gt;</span>
        <span class="nt">&lt;evictionTimestamp&gt;</span>0<span class="nt">&lt;/evictionTimestamp&gt;</span>
        <span class="nt">&lt;serviceUpTimestamp&gt;</span>0<span class="nt">&lt;/serviceUpTimestamp&gt;</span>
      <span class="nt">&lt;/leaseInfo&gt;</span>
      <span class="nt">&lt;metadata&gt;</span>
        <span class="nt">&lt;forge&gt;</span>1.0.0<span class="nt">&lt;/forge&gt;</span>
        <span class="nt">&lt;management.port&gt;</span>10100<span class="nt">&lt;/management.port&gt;</span>
        <span class="nt">&lt;jmx.port&gt;</span>1099<span class="nt">&lt;/jmx.port&gt;</span>
        <span class="nt">&lt;group&gt;</span>innovation<span class="nt">&lt;/group&gt;</span>
      <span class="nt">&lt;/metadata&gt;</span>
      <span class="nt">&lt;homePageUrl&gt;</span>http://10.128.41.74:10100/<span class="nt">&lt;/homePageUrl&gt;</span>
      <span class="nt">&lt;statusPageUrl&gt;&lt;/statusPageUrl&gt;</span>
      <span class="nt">&lt;healthCheckUrl&gt;</span>http://10.128.41.74:10100/health<span class="nt">&lt;/healthCheckUrl&gt;</span>
      <span class="nt">&lt;vipAddress&gt;</span>xp-xtower-webapp-boot<span class="nt">&lt;/vipAddress&gt;</span>
      <span class="nt">&lt;secureVipAddress&gt;</span>xp-xtower-webapp-boot<span class="nt">&lt;/secureVipAddress&gt;</span>
      <span class="nt">&lt;isCoordinatingDiscoveryServer&gt;</span>false<span class="nt">&lt;/isCoordinatingDiscoveryServer&gt;</span>
      <span class="nt">&lt;lastUpdatedTimestamp&gt;</span>1545039481899<span class="nt">&lt;/lastUpdatedTimestamp&gt;</span>
      <span class="nt">&lt;lastDirtyTimestamp&gt;</span>1545039481813<span class="nt">&lt;/lastDirtyTimestamp&gt;</span>
      <span class="nt">&lt;actionType&gt;</span>ADDED<span class="nt">&lt;/actionType&gt;</span>
    <span class="nt">&lt;/instance&gt;</span>

</code></pre></div><table>
<thead>
<tr>
<th>Scope</th>
<th>Status</th>
<th>lastDirtyTimestamp</th>
<th>lastUpdatedTimestamp</th>
<th>registrationTimestamp</th>
</tr>
</thead>
<tbody>
<tr>
<td>Request</td>
<td>UP</td>
<td>1545039481813</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Local</td>
<td>UP</td>
<td>1545039481813</td>
<td>1545039472888</td>
<td></td>
</tr>
<tr>
<td>Remote</td>
<td>STARTING</td>
<td>1545039481813</td>
<td>1545039481899</td>
<td>1545039481898</td>
</tr>
</tbody>
</table>
<p>结合起来看, 问题出在<code>lastDirtyTimestamp</code>未更新, 导致注册中心的状态未更新. 而<code>lastUpdatedTimestamp</code>的时间为1545039481899, 与<code>lastDirtyTimestamp</code>相差<code>86毫秒</code>.</p>
<p>服务端<code>InstanceResource#validateDirtyTimestamp()</code>根据本地保存的实例的信息, 和心跳请求发送过来的请求做比较, 决定响应的状态码<code>200</code>, <code>404</code>或者<code>409</code></p>
<h3 id="推理">推理</h3>
<p>注册中心里实例的状态为<code>STARTING</code>, 可以确定实例是[被动注册](#二. 被动注册)的.</p>
<p>这里有几个时间点:</p>
<ul>
<li><code>1545039472888</code>: <code>InstanceInfo</code>对象实例化的时间, 因为本地对象的<code>#lastUpdatedTimestamp</code>字段只有在实例化才会赋值, 此后不会被修改. 见<a href="#%E5%A0%86%E4%BF%A1%E6%81%AF">堆信息</a></li>
<li><code>1545039481813</code>: 状态从<code>STARTING</code>变为<code>UP</code>的时间, 也是实例状态的最后一次更新时间. 此后的心跳请求都会带上实例的最新状态(<code>UP</code>)和状态的最后一次更新时间(<code>1545039481813</code>), 见<a href="#TCP%E6%8A%93%E5%8C%85">TCP抓包</a>.</li>
<li><code>1545039481898</code>: 注册中心收到实例的注册请求的时间. 见<a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E9%87%8C%E7%9A%84%E5%AE%9E%E4%BE%8B%E4%BF%A1%E6%81%AF">注册中心里的实例信息</a></li>
<li><code>1545039481899</code>: 注册中心中的实例信息被更新的时间. 这个时间只比注册的时间晚了<em>1毫秒</em>. 见<a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E9%87%8C%E7%9A%84%E5%AE%9E%E4%BE%8B%E4%BF%A1%E6%81%AF">注册中心里的实例信息</a></li>
</ul>
<p>综上可见, 被动注册时发送请求, 拿到的实例的旧的状态<code>STARTING</code>, 修改时间确实最新的<code>1545039481813</code>. 后续的心跳上报实例状态为最新的<code>UP</code>, 修改时间也是最新的<code>1545039481813</code>. 但是由于最后修改时间与注册时的最后修改时间相同, 即使状态已经变为<code>UP</code>, 注册中心在收到心跳请求之后也不会将状态更新为<code>UP</code>.</p>
<p>服务端<code>InstanceResource#renewLease()</code> -&gt; <code>InstanceResource#validateDirtyTimestamp()</code>: 如果请求中的<code>lastDirtyTimestamp</code>与当前保存的实例的相同, 则直接返回OK, 不会更新注册中心中保存的实例的状态.</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">Response</span> <span class="nf">validateDirtyTimestamp</span><span class="o">(</span><span class="n">Long</span> <span class="n">lastDirtyTimestamp</span><span class="o">,</span>
                                        <span class="kt">boolean</span> <span class="n">isReplication</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">InstanceInfo</span> <span class="n">appInfo</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getInstanceByAppAndId</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">id</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">appInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">lastDirtyTimestamp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(!</span><span class="n">lastDirtyTimestamp</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">appInfo</span><span class="o">.</span><span class="na">getLastDirtyTimestamp</span><span class="o">())))</span> <span class="o">{</span>
            <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="o">{</span><span class="n">id</span><span class="o">,</span> <span class="n">appInfo</span><span class="o">.</span><span class="na">getLastDirtyTimestamp</span><span class="o">(),</span> <span class="n">lastDirtyTimestamp</span><span class="o">,</span> <span class="n">isReplication</span><span class="o">};</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lastDirtyTimestamp</span> <span class="o">&gt;</span> <span class="n">appInfo</span><span class="o">.</span><span class="na">getLastDirtyTimestamp</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
                        <span class="s">&#34;Time to sync, since the last dirty timestamp differs -&#34;</span>
                                <span class="o">+</span> <span class="s">&#34; ReplicationInstance id : {},Registry : {} Incoming: {} Replication: {}&#34;</span><span class="o">,</span>
                        <span class="n">args</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">Status</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">appInfo</span><span class="o">.</span><span class="na">getLastDirtyTimestamp</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">lastDirtyTimestamp</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// In the case of replication, send the current instance info in the registry for the
</span><span class="c1"></span>                <span class="c1">// replicating node to sync itself with this one.
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">isReplication</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
                            <span class="s">&#34;Time to sync, since the last dirty timestamp differs -&#34;</span>
                                    <span class="o">+</span> <span class="s">&#34; ReplicationInstance id : {},Registry : {} Incoming: {} Replication: {}&#34;</span><span class="o">,</span>
                            <span class="n">args</span><span class="o">);</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">Status</span><span class="o">.</span><span class="na">CONFLICT</span><span class="o">).</span><span class="na">entity</span><span class="o">(</span><span class="n">appInfo</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div><h4 id="为什么会出现这种情况">为什么会出现这种情况?</h4>
<p>应用启动过程中会有两个线程会触发<strong>注册</strong>的动作</p>
<ol>
<li><code>InstanceInfoReplicator</code>线程: <code>DiscoveryClient</code>中的<code>ApplicationInfoManager.StatusChangeListener</code>监听到实例状态发生变化, 会新建一个线程将实例注册到注册中心</li>
<li><code>DiscoveryClient$HeartbeatThread</code>线程: 这个线程在<code>DiscoveryClient</code>实例初始化后延迟(与心跳间隔时间相同, 默认是<code>30s</code>, 中台为提高实例发现效率将其改为了<code>5s</code>)启动运行. 第一次发送心跳请求是如果注册中心返回<strong>404</strong>(说明心跳线程提实例状态更新线程先启动), 则会先将实例注册到注册中心.</li>
</ol>
<p>上面两个线程都通过调用<code>AbstractJerseyEurekaHttpClient$register()</code>方法并使用<code>EurekaJacksonCodec$InstanceInfoSerializer</code>将实例信息序列化. 序列化的过程中<strong>先记录实例的状态后记录实例状态的最后修改时间(lastDirtyTimestamp)</strong>, 这两个操作不是一个原子操作.</p>
<p>非常极端的情况下(<strong>缩小心跳间隔增加了出现的概率, 但依然极地</strong>), 两个操作之间(心跳线程先拿到实例状态<code>STARTING</code>)主线程修改了实例状态为<code>UP</code>, 同时修改了<code>lastDirtyTimestamp</code>, 并触发了<code>InstanceInfoReplicator</code>线程的注册操作, 此时心跳线程获取到的实例的最后修改时间与<code>STARTING</code>状态并不一致. 之后同样注册动作覆盖了实例在注册中心的状态: <code>UP -&gt; STARTING</code>.</p>
<p>后续的心跳请求带去的最新状态<code>UP</code>和<code>lastDirtyTimestamp</code>, 并不会更新在注册中心的状态.</p>
<h2 id="解决方案">解决方案</h2>
<p>在<code>EurekaJacksonCodec$InstanceInfoSerializer#serialize()</code>方法中, 将<code>#autoMarshalEligible()</code> 的调用移到<code>jgen.writeStartObject()</code>后面. 这样就使得<code>lastDirtyTimestamp</code>的获取比<code>status</code>早, 就能保证即使注册时的<code>lastDirtyTimestamp</code>小于真正的, 但是状态是与实际相符. <code>lastDirtyTimestamp</code>会在后续的心跳请求中更新.
<img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/28/15476421041186.jpg" alt=""></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">addInstance-info.getStatus(): UP
addInstance-info.getLastDirtyTimestamp(): 1565164484429

addInstance-info.getStatus(): STARTING
addInstance-info.getLastDirtyTimestamp(): 1565164484415

renew-status-in-registry: UP
renew-lastDirtyTimestamp: 1565164484429
renew-appInfo.getLastDirtyTimestamp(): 1565164484429
</code></pre></div><p><a href="https://github.com/Netflix/eureka/pull/1229">PR</a> 已经提交并合并完成，然而 1.7.x 的版本不知何时会发布修复版本</p>
<p>参考:</p>
<ul>
<li><a href="https://github.com/Netflix/eureka/issues/1174">GitHub issue</a></li>
<li><a href="https://github.com/Netflix/eureka/pull/1229">PR</a></li>
</ul>

        </div>

        
        
        <div class="article-toc" >
            <h3></h3>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#问题重现">问题重现</a>
      <ul>
        <li><a href="#思路">思路</a></li>
      </ul>
    </li>
    <li><a href="#服务注册">服务注册</a>
      <ul>
        <li><a href="#instanceinfo初始化">InstanceInfo初始化</a></li>
        <li><a href="#服务实例注册">服务实例注册</a></li>
      </ul>
    </li>
    <li><a href="#问题分析">问题分析</a>
      <ul>
        <li><a href="#现象">现象</a></li>
        <li><a href="#推理">推理</a></li>
      </ul>
    </li>
    <li><a href="#解决方案">解决方案</a></li>
  </ul>
</nav>
        </div>
        
        

        


        
        <footer class="article-footer">
            <ul class="article-tag-list">
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://atbug.com//tags/spring">spring
                    </a>
                </li>
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://atbug.com//tags/eureka">eureka
                    </a>
                </li>
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://atbug.com//tags/troubleshooting">troubleshooting
                    </a>
                </li>
                
            </ul>
        </footer>
        <div class="article-entry">
            <hr>
            <p>文章同步发送到公众号：云编码 (微信号：sevenfeet)。</p>
            <p><img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/qrcode.jpg" alt="qrcode"></p>
        </div>
        
    </div>
    
<nav id="article-nav">
    
    <a href="../how-loadbalancer-works-in-ribbon/" id="article-nav-newer" class="article-nav-link-wrap">
        <div class="article-nav-title"><span>&lt;</span>&nbsp;
            带你了解 Ribbon 负载均衡器的实现
        </div>
    </a>
    
    
    <a href="../how-tekton-works/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">Tekton 的工作原理&nbsp;<span>&gt;</span></div>
    </a>
    
</nav>


</article>

        
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "addozhang" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
    </section>
    <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2020 Addo Zhang
            <br />
            Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with theme <a href="https://github.com/carsonip/hugo-theme-minos" target="_blank">Minos</a>
        </div>
    </div>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-47966140-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css" integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    <script>
        document.getElementById('main-nav-toggle').addEventListener('click', function () {
            var header = document.getElementById('header');
            if (header.classList.contains('mobile-on')) {
                header.classList.remove('mobile-on');
            } else {
                header.classList.add('mobile-on');
            }
        });
    </script>
</footer>

</div>
</body>
</html>
