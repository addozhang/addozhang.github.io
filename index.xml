<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ä¹±ä¸–æµ®ç”Ÿ</title><link>https://atbug.com/</link><description>Recent content on ä¹±ä¸–æµ®ç”Ÿ</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Sun, 27 Jun 2021 09:38:18 +0800</lastBuildDate><atom:link href="https://atbug.com/index.xml" rel="self" type="application/rss+xml"/><item><title>å¯ç¼–ç¨‹ç½‘å…³ Pipy ç¬¬ä¸‰å¼¹ï¼šäº‹ä»¶æ¨¡å‹è®¾è®¡</title><link>https://atbug.com/pipy-event-handling-design/</link><pubDate>Sun, 27 Jun 2021 09:38:18 +0800</pubDate><guid>https://atbug.com/pipy-event-handling-design/</guid><description>
&lt;p>è‡ªä»å‚åŠ äº† &lt;a href="https://flomesh.cn/">Flomesh&lt;/a> çš„ workshopï¼Œäº†è§£äº†å¯ç¼–ç¨‹ç½‘å…³ &lt;a href="https://github.com/flomesh-io/pipy">Pipy&lt;/a>ã€‚å¯¹è¿™ä¸ªâ€œå°ä¸œè¥¿â€å……æ»¡äº†å¥½å¥‡ï¼Œå‰åå†™äº†ä¸¤ç¯‡æ–‡ç« ï¼Œçœ‹äº†éƒ¨åˆ†æºç è§£å¼€äº†å…¶éƒ¨åˆ†é¢çº±ã€‚ä½†å§‹ç»ˆæœªè§å…¶å…¨è²Œï¼Œæ²¡æœ‰è§¦åŠå…¶æ ¸å¿ƒè®¾è®¡ã€‚&lt;/p>
&lt;p>ä¸æ˜¯æœ‰å¥è¯ï¼Œâ€œå¥½å¥‡å®³æ­»çŒ«â€ã€‚å…¶å®åº”è¯¥è¿˜æœ‰ååŠå¥ï¼Œâ€œæ»¡è¶³äº†å°±æ²¡äº‹â€ï¼ˆè§&lt;a href="https://zh.wikipedia.org/wiki/%E5%A5%BD%E5%A5%87%E5%AE%B3%E6%AD%BB%E7%8C%AB">ç»´åŸºç™¾ç§‘&lt;/a>ï¼‰ã€‚&lt;/p>
&lt;p>æ‰€æœ‰å°±æœ‰äº†ä»Šå¤©çš„è¿™ä¸€ç¯‡ï¼Œå¯¹å‰ä¸¤ç¯‡æ„Ÿå…´è¶£çš„å¯ä»¥è·³è½¬ç¿»çœ‹ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/l8JzYRn350fjuCAOoo8pcg">åˆæ¢å¯ç¼–ç¨‹ç½‘å…³ Pipy&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/_IeRXp9EJnVsvDfg8tUr1A">å¯ç¼–ç¨‹ç½‘å…³ Pipy ç¬¬äºŒå¼¹ï¼šç¼–ç¨‹å®ç° Metrics åŠæºç è§£è¯»&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>è¨€å½’æ­£ä¼ ã€‚&lt;/p>
&lt;h2 id="äº‹ä»¶æ¨¡å‹">äº‹ä»¶æ¨¡å‹&lt;/h2>
&lt;p>ä¸Šç¯‡å†™äº† Pipy åŸºäºäº‹ä»¶çš„ä¿¡æ¯æµè½¬ï¼Œå…¶å®è¿˜æœªæ·±å…¥è§¦åŠå…¶æ ¸å¿ƒçš„äº‹ä»¶æ¨¡å‹ã€‚æ—¢ç„¶æ˜¯äº‹ä»¶æ¨¡å‹ï¼Œå…ˆçœ‹äº‹ä»¶ã€‚&lt;/p>
&lt;p>&lt;code>src/event.hpp:41&lt;/code> ä¸­å®šä¹‰äº† Pipy çš„å››ç§äº‹ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>Data&lt;/code>&lt;/li>
&lt;li>&lt;code>MessageStart&lt;/code>&lt;/li>
&lt;li>&lt;code>MessageEnd&lt;/code>&lt;/li>
&lt;li>&lt;code>SessionEnd&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ç¿»çœ‹æºç å¯çŸ¥ï¼ˆå¿…é¡»åæ§½æ–‡æ¡£å¤ªå°‘ï¼‰è¿™å‡ ç§äº‹ä»¶å…¶å®æ˜¯æœ‰é¡ºåºçš„ï¼š&lt;code>MessageStart&lt;/code> -&amp;gt; &lt;code>Data&lt;/code> -&amp;gt; &lt;code>MessageEnd&lt;/code> -&amp;gt; &lt;code>SessionEnd&lt;/code>ã€‚&lt;/p>
&lt;p>è¿™ç§é¢å‘äº‹ä»¶æ¨¡å‹ï¼Œå¿…ç„¶æœ‰ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚åˆæ˜¯ç¿»çœ‹æºç å¯çŸ¥ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½æ˜¯ &lt;code>pipy::Filter&lt;/code>ã€‚æˆ‘ä»¬åœ¨ä¸Šç¯‡æ–‡ç« ä¸­è®²è¿‡ï¼šæ¯ä¸ª &lt;code>Pipeline&lt;/code> éƒ½æœ‰ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œç±»ä¼¼&lt;strong>å•å‘é“¾è¡¨çš„æ•°æ®ç»“æ„&lt;/strong>ã€‚&lt;/p>
&lt;p>é‚£æ˜¯ä¸æ˜¯æŒ‰ç…§ä¸Šé¢è¯´çš„ï¼Œäº‹ä»¶æ˜¯ä»ä¸€ä¸ª &lt;code>Filter&lt;/code> æµå‘ä¸‹ä¸€ä¸ª &lt;code>Filter&lt;/code>ï¼Ÿä¹Ÿå¯¹ï¼Œä¹Ÿä¸å¯¹ã€‚&lt;/p>
&lt;h2 id="çŸ›ç›¾">çŸ›ç›¾ï¼Ÿ&lt;/h2>
&lt;p>å…ˆçœ‹ &lt;code>Filter&lt;/code> å¦‚ä½•å‘ä¸‹ä¼ é€’äº‹ä»¶ï¼Œ&lt;code>src/session.cpp:55&lt;/code> å¤„ï¼Œ&lt;code>Filter&lt;/code> æŒæœ‰ &lt;code>output&lt;/code> å˜é‡ï¼Œç±»ä¼¼ä¸º &lt;code>Event::Receiver&lt;/code>ï¼ˆå‚æ•°ä¸º &lt;code>Event&lt;/code> çš„ &lt;code>std::function&lt;/code> çš„åˆ«åï¼Œä½œä¸ºå¤–è¡Œçš„ç¬”è€…å¹¶ä¸æ‡‚ c++ï¼Œä½†ä¸å¦¨ç¢äº†è§£ç¨‹åºè®¾è®¡ï¼‰ã€‚é€šè¿‡ &lt;code>Receiver&lt;/code> è°ƒç”¨ä¸‹ä¸€ä¸ª &lt;code>Filter&lt;/code> çš„ &lt;code>#process&lt;/code> æ–¹æ³•ã€‚&lt;/p>
&lt;p>è¿™é‡Œçš„ &lt;code>Receiver&lt;/code> å°±å¯ä»¥ç†è§£ä¸ºäº‹ä»¶å‘é€çš„çª—å£ï¼Œè€Œ &lt;code>#process(Context *ctx, Event *inp)&lt;/code> å°±æ˜¯äº‹ä»¶çš„æ¥æ”¶çª—å£ã€‚&lt;/p>
&lt;p>è¿™å°±æ˜¯å‰é¢ä¸ºä»€ä¹ˆè¯´ â€œäº‹ä»¶æ˜¯ä»ä¸€ä¸ª &lt;code>Filter&lt;/code> æµå‘ä¸‹ä¸€ä¸ª &lt;code>Filter&lt;/code>â€ æ˜¯æ­£ç¡®çš„ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆä¸å¯¹ï¼Ÿé¦–å…ˆï¼Œä¸€ä¸ª &lt;code>Filter&lt;/code> ä¼šäº§ç”Ÿå¤šä¸ªäº‹ä»¶ï¼Œæ¯”å¦‚ &lt;code>decodeHttpRequest&lt;/code> å¯èƒ½ä¼šäº§ç”Ÿ &lt;code>MessageStart&lt;/code>ã€&lt;code>Data&lt;/code> å’Œ &lt;code>MessageEnd&lt;/code> äº‹ä»¶ï¼Œ&lt;strong>å¹¶ä¸”æ¯äº§ç”Ÿä¸€ä¸ªäº‹ä»¶éƒ½ä¼šé€šè¿‡&lt;code>Receiver&lt;/code> å‘ä¸‹ä¼ é€’ï¼Œä¸ä¼šç­‰ &lt;code>#process&lt;/code> æµç¨‹ç»“æŸæ‰ä¼ é€’äº‹ä»¶&lt;/strong>ï¼›å†å°±æ˜¯ä¸‹ä¸€ä¸ª &lt;code>Filter&lt;/code> å¯èƒ½å¹¶ä¸ä¼šå¯¹æŸä¸ªäº‹ä»¶æ„Ÿå…´è¶£ï¼ˆä¸‹ä¸€ä¸ª &lt;code>Filter&lt;/code> çš„ &lt;code>#process&lt;/code> æ–¹æ³•ä¸åšä»»ä½•å¤„ç†å°±è¿”å›äº†ï¼‰ã€‚&lt;/p>
&lt;p>å¯èƒ½çœ‹ä¸‹å›¾ä¼šæ›´å®¹æ˜“ç†è§£ï¼ˆå›¾ä¸­ &lt;code>no output&lt;/code> è¡¨æ˜äº‹ä»¶ä¸ä¼šå‘ä¸‹ä¼ é€’ï¼‰ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/27/20210627073856.png" alt="event-handling-flow">&lt;/p>
&lt;h2 id="æœ€ç®€å•çš„ç¤ºä¾‹">æœ€ç®€å•çš„ç¤ºä¾‹&lt;/h2>
&lt;p>åœ¨ &lt;code>test/001-echo/pipy.js&lt;/code> æä¾›äº†çš„ç¤ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="nx">pipy&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">6080&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">decodeHttpRequest&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">encodeHttpResponse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‘èµ·è¯·æ±‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ curl -X POST localhost:6080 -d &lt;span class="s1">&amp;#39;{}&amp;#39;&lt;/span>
&lt;span class="o">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>HTTP æ¶ˆæ¯ä½“&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="err">#request
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nf">POST&lt;/span> &lt;span class="nn">/&lt;/span> &lt;span class="kr">HTTP&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="m">1.1&lt;/span>
&lt;span class="n">Content-Type&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">application/javascript&lt;/span>
&lt;span class="n">User-Agent&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">PostmanRuntime/7.28.1&lt;/span>
&lt;span class="n">Accept&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">*/*&lt;/span>
&lt;span class="n">Postman-Token&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">fc84b575-7fea-487b-a55d-f6085bc62cf7&lt;/span>
&lt;span class="n">Host&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">localhost:6080&lt;/span>
&lt;span class="n">Accept-Encoding&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">gzip, deflate, br&lt;/span>
&lt;span class="n">Connection&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">keep-alive&lt;/span>
&lt;span class="n">Content-Length&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">2&lt;/span>
&lt;span class="err"> &lt;/span>
&lt;span class="p">{}&lt;/span>
&lt;span class="err">#&lt;/span>&lt;span class="nx">response&lt;/span>
&lt;span class="nx">HTTP&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="mi">200&lt;/span> &lt;span class="nx">OK&lt;/span>
&lt;span class="nx">postman&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">token&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">fc84b575&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">7&lt;/span>&lt;span class="nx">fea&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">487&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">a55d&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">f6085bc62cf7&lt;/span>
&lt;span class="nx">accept&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">encoding&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">gzip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">deflate&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">br&lt;/span>
&lt;span class="nx">host&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">localhost&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="mi">6080&lt;/span>
&lt;span class="nx">accept&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="err">/*&lt;/span>
&lt;span class="nx">user&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">agent&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">PostmanRuntime&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">7.28.1&lt;/span>
&lt;span class="nx">content&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">type&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">application&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">javascript&lt;/span>
&lt;span class="nx">Connection&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">keep&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">alive&lt;/span>
&lt;span class="nx">Content&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">Length&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="p">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œæˆ‘ä»¬ä»¥è¿‡æ»¤å™¨ &lt;code>decodeHttpRequest&lt;/code> ä¸ºä¾‹ï¼Œå®˜æ–¹çš„è¯´æ˜æ˜¯ &lt;code>Deframes an HTTP request message&lt;/code>ã€‚å‰é¢æåˆ°å®ƒä¼šäº§ç”Ÿ 3 ä¸ªäº‹ä»¶ï¼Œéƒ½æ˜¯åœ¨ &lt;code>deframe&lt;/code> çš„è¿‡ç¨‹ä¸­å‘å‡ºçš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/27/20210627080912.png" alt="decodeHttpRequest">&lt;/p>
&lt;p>&lt;code>Session&lt;/code> è°ƒç”¨ç¬¬ä¸€ä¸ª &lt;code>Filter&lt;/code> æ—¶ï¼Œä¼ å…¥çš„äº‹ä»¶ç±»å‹æ˜¯ &lt;code>event::Data&lt;/code>ã€‚&lt;code>decodeHttpRequest&lt;/code> å…³æ³¨è¯¥äº‹ä»¶ï¼Œå¹¶æŒ‰ç…§ HTTP åè®®å¼€å§‹è§£æã€‚&lt;/p>
&lt;p>åœ¨ä¸Šå›¾å¯ä»¥çœ‹åˆ°è§£æçš„ä¸åŒé˜¶æ®µï¼Œä¼šå‘å‡ºä¸åŒçš„äº‹ä»¶ã€‚è°ƒç”¨ &lt;code>Receiver&lt;/code> ä¼ è¾“äº‹ä»¶ï¼Œè°ƒç”¨ &lt;code>encodeHttpResponse&lt;/code> çš„ &lt;code>#process()&lt;/code> æ–¹æ³•ã€‚&lt;/p>
&lt;p>è¿™é‡Œåˆä¼šå¥½å¥‡ï¼Œå‡å¦‚ä¸Šé¢çš„ç¤ºä¾‹ä¸­å»æ‰ä¸¤ä¸ªè¿‡æ»¤å™¨ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œæˆ–è€…éƒ½å»æ‰ï¼Œèƒ½ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Ÿ&lt;/p>
&lt;p>ç­”æ¡ˆæ˜¯éƒ½ä¸èƒ½ï¼å“åº”çŠ¶æ€ç éƒ½æ˜¯ &lt;code>502 Bad Gateway&lt;/code>ï¼ˆcurl/httpieï¼‰ã€‚&lt;/p>
&lt;h2 id="åˆ†æ">åˆ†æ&lt;/h2>
&lt;p>è¿™é‡Œéœ€è¦ç»“åˆæœ¬æ–‡çš„ç¬¬ä¸€å¼ å›¾ event-handling-flowã€‚&lt;/p>
&lt;h3 id="å»æ‰ä¸¤ä¸ªè¿‡æ»¤å™¨">å»æ‰ä¸¤ä¸ªè¿‡æ»¤å™¨&lt;/h3>
&lt;p>å‡å¦‚ä¸¤ä¸ªéƒ½å»æ‰äº†ï¼ŒHTTP Request è¯·æ±‚æ¶ˆæ¯ä¼šè¢«ç›´æ¥å›ä¼ ç»™å®¢æˆ·ç«¯ï¼Œåè®®é”™è¯¯ã€‚&lt;/p>
&lt;h3 id="å»æ‰-decodehttprequest">å»æ‰ decodeHttpRequest&lt;/h3>
&lt;p>å‰é¢æåˆ° &lt;code>Session&lt;/code> ä¼ ç»™ç¬¬ä¸€ä¸ª &lt;code>Filter&lt;/code> çš„äº‹ä»¶æ˜¯ &lt;code>event::Data&lt;/code>ã€‚è€Œ &lt;code>encodeHttpResponse&lt;/code> é’ˆå¯¹è¯¥äº‹ä»¶åªä¼šå°†å…¶ä¿å­˜åˆ° buffer ä¸­ã€‚&lt;/p>
&lt;p>ç„¶åæ•´ä¸ªé“¾è·¯åœ¨æ­¤ç»“æŸï¼Œæ²¡æœ‰å›ä¼ ä»»ä½•æ•°æ®ã€‚å®¢æˆ·ç«¯ä¼šç­‰å¾…å“åº”ï¼Œè¶…æ—¶é€€å‡ºï¼ˆcurlï¼‰ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/27/20210627084340.png" alt="2021-06-27-08-43-40">&lt;/p>
&lt;h3 id="å»æ‰-encodehttpresponse">å»æ‰ encodeHttpResponse&lt;/h3>
&lt;p>å…ˆè¯´ç»“æœï¼Œä¸å‰é¢ä¸€æ ·è¶…æ—¶é€€å‡ºã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œæ˜æ˜ &lt;code>decodeHttpRequest&lt;/code> äº§ç”Ÿäº† 3 ä¸ªæ—¶é—´ï¼Œ&lt;code>Session&lt;/code> é‡Œçš„ &lt;code>Receiver&lt;/code> ä¹Ÿæœ‰æ”¶åˆ°ï¼Œä¹Ÿç¡®å®å†™å›äº†è¯·æ±‚ body é‡Œçš„ &lt;code>{}&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>encodeHttpResponse&lt;/code> è¿‡æ»¤å™¨æœ‰å†™å›å“åº”å¤´ï¼Œç¼ºå°‘äº†è¿™äº›ä¿¡æ¯ï¼Œå“åº”å°±ä¸å¹¶ä¸æ˜¯åˆæ³•çš„ HTTP åè®®ï¼Œåªæ˜¯æ™®é€šçš„ TCP åè®®ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>Pipy åŸºäºäº‹ä»¶æ¨¡å‹çš„è®¾è®¡ï¼Œæä¾›äº†å¼ºå¤§çš„çµæ´»æ€§ã€‚å…è®¸æˆ‘ä»¬åœ¨â€œè§„åˆ™â€ä¸­ä½¿ç”¨ä¸åŒè¿‡æ»¤å™¨é’ˆå¯¹ä¸åŒçš„äº‹ä»¶ï¼Œå¯¹è¯·æ±‚å’Œå“åº”çš„ä¿¡æ¯è¿›è¡Œå¤„ç†ã€‚&lt;/p>
&lt;p>â€œè§„åˆ™â€ å°±æ˜¯ä¸šåŠ¡é€»è¾‘çš„æ ¸å¿ƒï¼Œè€Œ Pipy å°±æ˜¯è¿™é€»è¾‘çš„&lt;strong>æ‰§è¡Œå¼•æ“&lt;/strong>ã€‚&lt;/p>
&lt;p>æœ€åï¼Œâ€œå¥½å¥‡å¿ƒæ˜¯æˆé•¿çš„é©±åŠ¨åŠ›ï¼Œæ°¸è¿œä¿æŒå¥½å¥‡å¿ƒã€‚â€&lt;/p></description></item><item><title>å¸¸ç”¨çš„å‡ æ¬¾å·¥å…·è®© Kubernetes é›†ç¾¤ä¸Šçš„å·¥ä½œæ›´å®¹æ˜“</title><link>https://atbug.com/tools-accelerate-work-on-kubernetes-cluster/</link><pubDate>Sat, 26 Jun 2021 12:16:28 +0800</pubDate><guid>https://atbug.com/tools-accelerate-work-on-kubernetes-cluster/</guid><description>
&lt;p>ä¹‹å‰å†™è¿‡ä¸€ç¯‡ &lt;a href="https://mp.weixin.qq.com/s/CXJ1zUoktdI3c3CHVju0gA">ä»‹ç»äº†å·¥å…·åŠ é€Ÿäº‘åŸç”Ÿ Java å¼€å‘&lt;/a>ã€‚&lt;/p>
&lt;p>å…¶å®æ—¥å¸¸å·¥ä½œä¸­åœ¨é›†ç¾¤ä¸Šçš„æ“ä½œä¹Ÿéå¸¸å¤šï¼Œä»Šå¤©å°±æ¥ä»‹ç»æˆ‘æ‰€ä½¿ç”¨çš„å·¥å…·ã€‚&lt;/p>
&lt;h2 id="kubectl-alias">kubectl-alias&lt;/h2>
&lt;p>ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„å·¥å…·ï¼Œæˆ‘è‡ªå·±ç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹ï¼ŒåŠ å…¥äº† &lt;code>StatefulSet&lt;/code> çš„æ”¯æŒã€‚&lt;/p>
&lt;p>è¿™ä¸ªæ˜¯æˆ‘çš„ &lt;a href="https://github.com/addozhang/kubectl-aliases">https://github.com/addozhang/kubectl-aliases&lt;/a>ï¼ŒåŸºäº &lt;a href="https://github.com/ahmetb/kubectl-aliases">https://github.com/ahmetb/kubectl-aliases&lt;/a>ã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¾“å‡ºæŸä¸ª pod çš„ jsonï¼Œ&lt;code>kgpoojson xxx&lt;/code> ç­‰åŒäº &lt;code>kubectl get pod xxx -o json&lt;/code>ã€‚&lt;/p>
&lt;p>ç»“åˆ &lt;a href="https://stedolan.github.io/jq/">jq&lt;/a> ä½¿ç”¨æ•ˆæœæ›´å¥½ ğŸ˜‚ã€‚&lt;/p>
&lt;h3 id="è¯­æ³•è§£è¯»">è¯­æ³•è§£è¯»&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>&lt;code>k&lt;/code>&lt;/strong>=&lt;code>kubectl&lt;/code>
&lt;ul>
&lt;li>&lt;strong>&lt;code>sys&lt;/code>&lt;/strong>=&lt;code>--namespace kube-system&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>commands:
&lt;ul>
&lt;li>&lt;strong>&lt;code>g&lt;/code>&lt;/strong>=&lt;code>get&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>d&lt;/code>&lt;/strong>=&lt;code>describe&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>rm&lt;/code>&lt;/strong>=&lt;code>delete&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>a&lt;/code>&lt;/strong>:&lt;code>apply -f&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>ak&lt;/code>&lt;/strong>:&lt;code>apply -k&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>k&lt;/code>&lt;/strong>:&lt;code>kustomize&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>ex&lt;/code>&lt;/strong>:Â &lt;code>exec -i -t&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>lo&lt;/code>&lt;/strong>:Â &lt;code>logs -f&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>resources:
&lt;ul>
&lt;li>&lt;strong>&lt;code>po&lt;/code>&lt;/strong>=pod,Â &lt;strong>&lt;code>dep&lt;/code>&lt;/strong>=&lt;code>deployment&lt;/code>,Â &lt;strong>&lt;code>ing&lt;/code>&lt;/strong>=&lt;code>ingress&lt;/code>,Â &lt;strong>&lt;code>svc&lt;/code>&lt;/strong>=&lt;code>service&lt;/code>,Â &lt;strong>&lt;code>cm&lt;/code>&lt;/strong>=&lt;code>configmap&lt;/code>,Â &lt;strong>&lt;code>sec&lt;/code>=&lt;code>secret&lt;/code>&lt;/strong>,&lt;strong>&lt;code>ns&lt;/code>&lt;/strong>=&lt;code>namespace&lt;/code>,Â &lt;strong>&lt;code>no&lt;/code>&lt;/strong>=&lt;code>node&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>flags:
&lt;ul>
&lt;li>output format:Â &lt;strong>&lt;code>oyaml&lt;/code>&lt;/strong>,Â &lt;strong>&lt;code>ojson&lt;/code>&lt;/strong>,Â &lt;strong>&lt;code>owide&lt;/code>&lt;/strong>&lt;/li>
&lt;li>&lt;strong>&lt;code>all&lt;/code>&lt;/strong>:Â &lt;code>--all&lt;/code>Â orÂ &lt;code>--all-namespaces&lt;/code>Â depending on the command&lt;/li>
&lt;li>&lt;strong>&lt;code>sl&lt;/code>&lt;/strong>:Â &lt;code>--show-labels&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>w&lt;/code>&lt;/strong>=&lt;code>-w/--watch&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>value flags (should be at the end):
&lt;ul>
&lt;li>&lt;strong>&lt;code>n&lt;/code>&lt;/strong>=&lt;code>-n/--namespace&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>f&lt;/code>&lt;/strong>=&lt;code>-f/--filename&lt;/code>&lt;/li>
&lt;li>&lt;strong>&lt;code>l&lt;/code>&lt;/strong>=&lt;code>-l/--selector&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="kubectx--kubens">kubectx + kubens&lt;/h2>
&lt;p>&lt;a href="https://github.com/ahmetb/kubectx#installation">å®‰è£…çœ‹è¿™é‡Œ&lt;/a>&lt;/p>
&lt;p>&lt;code>kubectx&lt;/code> ç”¨äºåœ¨ä¸åŒçš„é›†ç¾¤é—´è¿›è¡Œå¿«é€Ÿåˆ‡æ¢ã€‚å‡å¦‚ç”¨ &lt;code>kubectl&lt;/code>ï¼Œä½ éœ€è¦ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># context åˆ—è¡¨&lt;/span>
kubectl config current-context
&lt;span class="c1"># è®¾ç½® context&lt;/span>
kubectl config use-context coffee
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/kubectxdemo.gif" alt="kubectx-demo">&lt;/p>
&lt;p>&lt;code>kubens&lt;/code> å°±æ˜¯åœ¨ä¸åŒ namespace é—´å¿«é€Ÿåˆ‡æ¢çš„å·¥å…·ã€‚ç”¨ &lt;code>kubectl&lt;/code> çš„è¯ï¼Œéœ€è¦ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># namespace åˆ—è¡¨&lt;/span>
kbuectl get ns
&lt;span class="c1"># kubectl config set-context --current --namespace=kube-system&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/kubensdemo.gif" alt="kubens-demo">&lt;/p>
&lt;h2 id="k9s">k9s&lt;/h2>
&lt;p>æ²¡é”™ï¼Œåªæ¯” k8s å¤šäº†ä¸ª 1 ğŸ˜‚ã€‚&lt;/p>
&lt;p>&lt;a href="https://github.com/derailed/k9s">k9s&lt;/a> æä¾›äº†ç»ˆç«¯ UI ä¸ Kubernetes é›†ç¾¤è¿›è¡Œç¼–è¾‘äº¤äº’ã€‚æœ¬äººå¸¸ç”¨çš„æ¯”å¦‚ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>F&lt;/code> é…ç½®ç«¯å£è½¬å‘&lt;/li>
&lt;li>&lt;code>l&lt;/code> è¾“å‡º pod æ—¥å¿—&lt;/li>
&lt;li>&lt;code>e&lt;/code> ä¿®æ”¹èµ„æºå¯¹è±¡&lt;/li>
&lt;li>&lt;code>s&lt;/code> pod ç»ˆç«¯äº¤äº’æ¨¡å¼&lt;/li>
&lt;li>&lt;code>y&lt;/code> yaml æ–¹å¼è¾“å‡ºèµ„æºå¯¹è±¡&lt;/li>
&lt;li>&lt;code>d&lt;/code> describe èµ„æºå¯¹è±¡&lt;/li>
&lt;li>&lt;code>ctrl+d&lt;/code> åˆ é™¤ pod&lt;/li>
&lt;/ul>
&lt;p>å¯åŠ¨æ–¹å¼&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># æŒ‡å®š namespace è¿è¡Œ&lt;/span>
k9s -n mycoolns
&lt;span class="c1"># æŒ‡å®š context è¿è¡Œ&lt;/span>
k9s --context coolCtx
&lt;span class="c1"># åªè¯»æ¨¡å¼è¿è¡Œ&lt;/span>
k9s --readonly
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626102731.png" alt="k9s-pod">&lt;/p>
&lt;p>é”®å…¥é—®å·â€œ?â€ å°±å¯ä»¥æ‰“å¼€å¿«æ·æ“ä½œæŒ‡å¼•ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626103012.png" alt="help">&lt;/p>
&lt;h2 id="stern">stern&lt;/h2>
&lt;p>&lt;a href="https://github.com/wercker/stern">stern&lt;/a> å¯ä»¥ç”¨æ¥ &lt;code>tail&lt;/code> é›†ç¾¤ä¸Šçš„å¤šä¸ª pod å’Œ pod ä¸­å¤šä¸ªå®¹å™¨çš„æ—¥å¿—ã€‚ä¸åŒçš„ pod å’Œå®¹å™¨ä»¥ä¸åŒçš„é¢œè‰²åŒºåˆ†ï¼Œæ–¹ä¾¿ debugã€‚&lt;/p>
&lt;p>æ¯”å¦‚ä½¿ç”¨å‘½ä»¤ &lt;code>stern -l tier=control-plane -n kube-system&lt;/code> å¯ä»¥è¾“å‡º &lt;code>kube-system&lt;/code> å‘½åç©ºé—´ä¸‹æ§åˆ¶å¹³é¢ï¼ˆ&lt;code>label&lt;/code> ä¸º &lt;code>tier=control-plane&lt;/code>ï¼‰ pod çš„æ—¥å¿—ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626104458.png" alt="stern-control-plane">&lt;/p>
&lt;p>å‘½ä»¤è¡Œé€‰é¡¹&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">Tail multiple pods and containers from Kubernetes
Usage:
stern pod-query &lt;span class="o">[&lt;/span>flags&lt;span class="o">]&lt;/span>
Flags:
-A, --all-namespaces If present, tail across all namespaces. A specific namespace is ignored even &lt;span class="k">if&lt;/span> specified with --namespace.
--color string Color output. Can be &lt;span class="s1">&amp;#39;always&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;never&amp;#39;&lt;/span>, or &lt;span class="s1">&amp;#39;auto&amp;#39;&lt;/span> &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;auto&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
--completion string Outputs stern command-line completion code &lt;span class="k">for&lt;/span> the specified shell. Can be &lt;span class="s1">&amp;#39;bash&amp;#39;&lt;/span> or &lt;span class="s1">&amp;#39;zsh&amp;#39;&lt;/span>
-c, --container string Container name when multiple containers in pod &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;.*&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
--container-state string If present, tail containers with status in running, waiting or terminated. Default to running. &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;running&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
--context string Kubernetes context to use. Default to current context configured in kubeconfig.
-e, --exclude strings Regex of log lines to exclude
-E, --exclude-container string Exclude a Container name
--field-selector string Selector &lt;span class="o">(&lt;/span>field query&lt;span class="o">)&lt;/span> to filter on. If present, default to &lt;span class="s2">&amp;#34;.*&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> the pod-query.
-h, --help &lt;span class="nb">help&lt;/span> &lt;span class="k">for&lt;/span> stern
-i, --include strings Regex of log lines to include
--init-containers Include or exclude init containers &lt;span class="o">(&lt;/span>default &lt;span class="nb">true&lt;/span>&lt;span class="o">)&lt;/span>
--kubeconfig string Path to kubeconfig file to use
-n, --namespace strings Kubernetes namespace to use. Default to namespace configured in Kubernetes context. To specify multiple namespaces, repeat this or &lt;span class="nb">set&lt;/span> comma-separated value.
-o, --output string Specify predefined template. Currently support: &lt;span class="o">[&lt;/span>default, raw, json&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;default&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
-l, --selector string Selector &lt;span class="o">(&lt;/span>label query&lt;span class="o">)&lt;/span> to filter on. If present, default to &lt;span class="s2">&amp;#34;.*&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> the pod-query.
-s, --since duration Return logs newer than a relative duration like 5s, 2m, or 3h. Defaults to 48h.
--tail int The number of lines from the end of the logs to show. Defaults to -1, showing all logs. &lt;span class="o">(&lt;/span>default -1&lt;span class="o">)&lt;/span>
--template string Template to use &lt;span class="k">for&lt;/span> log lines, leave empty to use --output flag
-t, --timestamps Print timestamps
--timezone string Set timestamps to specific timezone &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;Local&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
-v, --version Print the version and &lt;span class="nb">exit&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="lens">Lens&lt;/h2>
&lt;p>&lt;a href="https://k8slens.dev/">Lens&lt;/a> æ˜¯ç”¨æ¥æ§åˆ¶ Kubernetes çš„ IDEï¼Œå¼€æºä¸”å…è´¹ã€‚&lt;/p>
&lt;p>æ¶ˆé™¤äº†é›†ç¾¤æ“ä½œçš„å¤æ‚æ€§ã€æä¾›äº†å®æ—¶çš„å¯è§‚å¯Ÿæ€§ã€æ–¹ä¾¿æ•…éšœæ’æŸ¥ã€æ”¯æŒå¤šç³»ç»Ÿçš„æ¡Œé¢å®¢æˆ·ç«¯ã€å…¼å®¹å¤šç§é›†ç¾¤ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626113853.png" alt="Lens">&lt;/p>
&lt;h2 id="infra-app">Infra App&lt;/h2>
&lt;p>&lt;a href="https://infra.app/">Infra App&lt;/a> è·Ÿ Lens å·®ä¸å¤šï¼ŒUI è¾ƒ Lens å¥½äº›ï¼Œä½†æ˜¯åŠŸèƒ½å°±å¼±å¾ˆå¤šï¼Œç±»ä¼¼ Lens çš„åªè¯»æ¨¡å¼ã€‚&lt;/p>
&lt;p>å…è´¹ç‰ˆæ¯”æ”¶è´¹ç‰ˆçš„åŒºåˆ«åªåœ¨äºæ”¯æŒçš„é›†ç¾¤æ•°é‡ï¼Œå…è´¹ç‰ˆåªæ”¯æŒä¸€ä¸ªé›†ç¾¤ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/20210626114417.png" alt="Infra">&lt;/p>
&lt;h2 id="kubefwd">kubefwd&lt;/h2>
&lt;p>&lt;a href="https://github.com/txn2/kubefwd">kubefwd&lt;/a>ï¼Œè¿™ä¸ªä¸€ç›´æœ‰å®‰è£…ä½†æ˜¯ä½¿ç”¨æ¬¡æ•°å¯¥å¯¥ï¼Œå› ä¸ºåº”ç”¨ä¹‹é—´çš„è®¿é—®æ²¡æœ‰èµ° serviceï¼Œä¸è¿‡å¶å°”åšäº›å®éªŒçš„æ—¶å€™ä¼šç”¨çš„ä¸Šã€‚&lt;/p>
&lt;blockquote>
&lt;p>kubefwd æ˜¯ä¸€ä¸ªç”¨äºç«¯å£è½¬å‘Kubernetesä¸­æŒ‡å®šnamespaceä¸‹çš„å…¨éƒ¨æˆ–è€…éƒ¨åˆ†podçš„å‘½ä»¤è¡Œå·¥å…·ã€‚ kubefwd ä½¿ç”¨æœ¬åœ°çš„ç¯å›IPåœ°å€è½¬å‘éœ€è¦è®¿é—®çš„serviceï¼Œå¹¶ä¸”ä½¿ç”¨ä¸serviceç›¸åŒçš„ç«¯å£ã€‚ kubefwd ä¼šä¸´æ—¶å°†serviceçš„åŸŸæ¡ç›®æ·»åŠ åˆ° /etc/hosts æ–‡ä»¶ä¸­ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>å¯åŠ¨kubefwdåï¼Œåœ¨æœ¬åœ°å°±èƒ½åƒåœ¨Kubernetesé›†ç¾¤ä¸­ä¸€æ ·ä½¿ç”¨serviceåå­—ä¸ç«¯å£è®¿é—®å¯¹åº”çš„åº”ç”¨ç¨‹åºã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/kubefwdani.gif" alt="kubefwd_ani">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/26/16246803227515.jpg" alt="">&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>å–„ç”¨å·¥å…·å¯ä»¥æå‡æ•ˆç‡ï¼Œä½†å¹¶ä¸æ˜¯ä¸å¯æˆ–ç¼ºçš„ã€‚&lt;/p>
&lt;p>å¦‚æœä½ æœ‰å…¶ä»–çš„å·¥å…·ï¼Œæ¬¢è¿ç•™è¨€æå‡ºã€‚&lt;/p></description></item><item><title>Jenkins å¦‚ä½•ä¸ Kubernetes é›†ç¾¤çš„ Tekton Pipeline äº¤äº’ï¼Ÿ</title><link>https://atbug.com/jenkins-interact-with-tekton-pipelines-via-plugin/</link><pubDate>Wed, 23 Jun 2021 07:58:45 +0800</pubDate><guid>https://atbug.com/jenkins-interact-with-tekton-pipelines-via-plugin/</guid><description>
&lt;p>æœ¬æ–‡è¯¦ç»†ä»‹ç»äº† Jenkins å¦‚ä½•é€šè¿‡ &lt;a href="https://github.com/jenkinsci/tekton-client-plugin">tekton-client-plugin&lt;/a> å®ç°ä¸ Kubernetes ä¸Šçš„ Tekton Pipeline äº¤äº’ï¼ŒåŒ…æ‹¬ Kubernetes ä¸Šå®‰è£… Jenkinsã€Tekton Pipelines ç­‰ã€‚&lt;/p>
&lt;p>å…³äºå¦‚ä½•ä½¿ç”¨ Tekton Pipeline å®ç° CICD å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç«  &lt;a href="https://atbug.com/tekton-pipeline-practice/">äº‘åŸç”Ÿ CICD: Tekton Pipeline å®æˆ˜&lt;/a>&lt;/p>
&lt;p>æœ¬æ–‡ç”¨äºæ„å»ºçš„é¡¹ç›®ä»¥åŠæ‰€æœ‰ manifest yaml éƒ½åœ¨å¯ä»¥åœ¨&lt;a href="https://github.com/addozhang/tekton-test">è¿™é‡Œ&lt;/a>ä¸‹è½½ã€‚&lt;/p>
&lt;h2 id="tldr">TL;DR&lt;/h2>
&lt;p>æƒ¯ä¾‹ï¼Œå…ˆä¸Šæ€»ç»“ã€‚&lt;code>tekton-client-plugin&lt;/code> è™½ç„¶è¿˜æ˜¯å¤„äºåˆæœŸé˜¶æ®µï¼Œä½†æ˜¯ &lt;em>å…¶ä»·å€¼éå¸¸æ˜æ˜¾ï¼Œå°¤å…¶æ˜¯å¯¹å…ˆç”¨ä½¿ç”¨ Jenkins ä½œä¸º CICD å®ç°çš„ç”¨æˆ·æ¥è¯´ã€‚ä» Jenkins è¿ç§»åˆ°äº‘åŸç”Ÿçš„ Tekton æ—¶ï¼Œå¯ä»¥çœæ‰ç”¨æˆ·ç•Œé¢çš„å¼€å‘æˆæœ¬ï¼Œè€Œä¸”å°½å¯èƒ½å°‘çš„æ”¹å˜ç”¨æˆ·ä¹ æƒ¯&lt;/em> ï¼Œä¾é ç‰ˆæœ¬ç®¡ç†å¯ä»¥æ§åˆ¶è¿ç§»çš„èŠ‚å¥ã€‚&lt;/p>
&lt;p>&lt;code>tekton-client-plugin&lt;/code> åœ¨ä»Šå¹´ 5 æœˆ 7 æ—¥å‘å¸ƒçš„ &lt;code>1.0.0&lt;/code> ç‰ˆæœ¬ï¼Œç›®å‰ä¸º &lt;code>1.0.02&lt;/code>ã€‚ç›®å‰è¿˜å¤„äºåˆæœŸé˜¶æ®µï¼Œæˆ‘ä¸ªäººæ„Ÿè§‰ç›®å‰ä»…ä»…ç®—æ˜¯æ‰“é€š Jenkins ä¸ Tekton äº¤äº’è¿™æ¡è·¯ï¼Œæ‰©å±•æ€§è¿˜ä¸å¤Ÿå¥½ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ç›®å‰ä»…ä»…æ”¯æŒå¦‚ä¸‹å‡ ä¸ªå‚æ•°æ³¨å…¥åˆ° &lt;code>PipelineRun&lt;/code> ä¸­ï¼Œéš¾ä»¥æ”¯æ’‘å¤æ‚çš„æµç¨‹æ§åˆ¶ï¼Œ&lt;a href="https://github.com/jenkinsci/tekton-client-plugin/blob/1.0.2/src/main/java/org/waveywaves/jenkins/plugins/tekton/client/build/create/CreateRaw.java#L292">æ”¯æŒçš„ Pipeline å‚æ•° hardcode åœ¨ä»£ç ä¸­&lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>BUILD_ID - the build id/number of the Jenkins job&lt;/li>
&lt;li>JOB_NAME - the name of the jenkins job that triggered this pipeline&lt;/li>
&lt;li>PULL_BASE_REF - name of the base branch&lt;/li>
&lt;li>PULL_PULL_SHA - the commit sha of the pull request or branch&lt;/li>
&lt;li>REPO_NAME - name of the repository&lt;/li>
&lt;li>REPO_OWNER - owner of the repository&lt;/li>
&lt;li>REPO_URL - the URL of the repository&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>å¸Œæœ›åé¢ä¼šæ”¯æŒè‡ªå®šä¹‰å‚æ•°ï¼Œæ¯”å¦‚å°†æ›´å¤šçš„é¡¹ç›®å…ƒæ•°æ®ä¿¡æ¯æ³¨å†Œåˆ° &lt;code>Pipeline&lt;/code> ä¸­ã€‚&lt;/p>
&lt;p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ&lt;code>tekton-client-plugin&lt;/code> æä¾›äº†å¯¹ Job DSL çš„æ”¯æŒï¼Œæœ¬æ–‡åé¢æ²¡æœ‰ç”¨è¿™ç§æ–¹å¼ï¼Œè€Œæ˜¯ç”¨çš„ FreeStyle Projectã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">pipeline {
agent any
stages {
stage(&amp;#39;Stage&amp;#39;) {
steps {
checkout scm
tektonCreateRaw(inputType: &amp;#39;FILE&amp;#39;, input: &amp;#39;.tekton/pipeline.yaml&amp;#39;)
}
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‰ç½®æ¡ä»¶">å‰ç½®æ¡ä»¶&lt;/h2>
&lt;h3 id="ç¯å¢ƒ">ç¯å¢ƒ&lt;/h3>
&lt;ul>
&lt;li>Kubernetesï¼šæ¨è minikube&lt;/li>
&lt;li>Jenkinsï¼šå»ºè®®åœ¨ Kubernetes ä¸Šå®‰è£…&lt;/li>
&lt;li>Tekton&lt;/li>
&lt;li>ç”¨äºæ„å»ºçš„é¡¹ç›®&lt;/li>
&lt;/ul>
&lt;h3 id="å·¥å…·">å·¥å…·&lt;/h3>
&lt;ul>
&lt;li>kubectl&lt;/li>
&lt;li>tektoncd-cli&lt;/li>
&lt;li>&lt;a href="https://github.com/ahmetb/kubectx">kubectxã€kubens&lt;/a>&lt;/li>
&lt;li>helm&lt;/li>
&lt;/ul>
&lt;h2 id="kubernetes-ä¸Šå®‰è£…-jenkinshelm">Kubernetes ä¸Šå®‰è£… Jenkinsï¼ˆHelmï¼‰&lt;/h2>
&lt;p>Jenkins è¿™é‡Œä½¿ç”¨ Helm å®‰è£…åˆ° Kubernetes ä¸Šã€‚&lt;/p>
&lt;p>åˆå§‹åŒ–å‘½åç©ºé—´ã€æŒä¹…åŒ–å·ã€ServiceAccount ç­‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create namespace jenkins
kubens jenkins
&lt;span class="c1"># æŒä¹…åŒ–å­˜å‚¨ï¼Œç¬”è€…å°†å®¹é‡ä¿®æ”¹ä¸º 5G&lt;/span>
http https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/doc/tutorials/kubernetes/installing-jenkins-on-kubernetes/jenkins-volume.yaml --body &amp;gt; jenkins-volume.yaml
&lt;span class="c1"># åˆ›å»º PV&lt;/span>
kubectl apply -f jenkins-volume.yaml
&lt;span class="c1"># åˆ›å»º service account&lt;/span>
kubectl apply -f https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/doc/tutorials/kubernetes/installing-jenkins-on-kubernetes/jenkins-sa.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å‡†å¤‡-helm-ç¯å¢ƒå¹¶æ·»åŠ -jenkins-chartrepo">å‡†å¤‡ helm ç¯å¢ƒå¹¶æ·»åŠ  Jenkins ChartRepo&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># homebrew å®‰è£… helm&lt;/span>
brew install helm
&lt;span class="c1"># æ·»åŠ  jenkins chart repo&lt;/span>
helm repo add jenkinsci https://charts.jenkins.io
helm repo update
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="é…ç½®-jenkins-chart">é…ç½® Jenkins Chart&lt;/h3>
&lt;ol>
&lt;li>ä¸‹è½½å®˜æ–¹çš„ values yamlè¿›è¡Œä¿®æ”¹ï¼š&lt;code>http https://raw.githubusercontent.com/jenkinsci/helm-charts/main/charts/jenkins/values.yaml &amp;gt; jenkins-values.yaml&lt;/code>&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>serviceType&lt;/code> ä¸º &lt;code>NodePort&lt;/code>ï¼Œå¹¶å¢åŠ  &lt;code>nodePort: 32000&lt;/code>ã€‚ç”¨äºä» minikube å¤–è®¿é—® Jenkins&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>storageClass&lt;/code> ä¸º &lt;code>jenkins-pv&lt;/code>ã€‚å‰é¢åˆ›å»º PV çš„æ—¶å€™ä½¿ç”¨äº† &lt;code>jenkins-pv&lt;/code> ä½œä¸º &lt;a href="https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/">Dynamic Volume Provisioning&lt;/a> çš„ &lt;code>storageClass&lt;/code>&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>serviceAccount&lt;/code> éƒ¨åˆ†ï¼Œå°† &lt;code>create&lt;/code> è®¾ç½®ä¸º &lt;code>false&lt;/code>ï¼ˆä¸Šé¢å·²ç»åˆ›å»ºäº† &lt;code>serviceAccount&lt;/code>ï¼‰ï¼ŒåŒæ—¶å°† &lt;code>name&lt;/code> æŒ‡å®šä¸ºå‰é¢çš„ sa åå­— &lt;code>jenkins&lt;/code>&lt;/li>
&lt;li>&lt;code>installPlugins&lt;/code> ä¸‹å¢åŠ  &lt;code>tekton-client:1.0.2&lt;/code>&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>adminPassword&lt;/code> ä¸º &lt;code>admin&lt;/code>ã€‚æŒ‡å®šåˆå§‹å¯†ç ï¼ˆä¸æŒ‡å®šä¹Ÿå¯ä»¥é€šè¿‡å®‰è£…è¾“å‡ºçš„è¯´æ˜è·å–åˆå§‹å¯†ç ï¼‰&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>persistence&lt;/code> çš„ &lt;code>size&lt;/code> ä¸º &lt;code>5Gi&lt;/code> ï¼ˆæˆ‘çš„ minikube çš„è™šæ‹Ÿæœºåªæœ‰ 20Gi å¤§å°ï¼‰&lt;/li>
&lt;/ol>
&lt;p>ä¿®æ”¹åçš„æ–‡ä»¶åœ¨&lt;a href="https://github.com/addozhang/tekton-test/blob/main/tekton-client-sample/jenkins-values.yaml">è¿™é‡Œ jenkins-values.yaml&lt;/a>ã€‚&lt;/p>
&lt;h3 id="æ‰§è¡Œå®‰è£…">æ‰§è¡Œå®‰è£…&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">chart&lt;/span>&lt;span class="o">=&lt;/span>jenkinsci/jenkins
helm install jenkins -n jenkins -f jenkins-values.yaml &lt;span class="nv">$chart&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">NAME: jenkins
LAST DEPLOYED: Sun Jun 20 22:05:53 2021
NAMESPACE: jenkins
STATUS: deployed
REVISION: 1
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è·å– Jenkins çš„è®¿é—®åœ°å€ &lt;code>echo $(minikube ip):$(kubectl get svc jenkins -o jsonpath=&amp;quot;{.spec.ports[0].nodePort}&amp;quot;)&lt;/code>ï¼Œç„¶åä½¿ç”¨å‰é¢è®¾ç½®çš„è´¦å·ç™»å½•ã€‚&lt;/p>
&lt;h2 id="tekton-å®‰è£…">Tekton å®‰è£…&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create ns tekton-pipelines
kubens tekton-pipelines
kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…-cli">å®‰è£… CLI&lt;/h3>
&lt;p>&lt;code>brew install tektoncd-cli&lt;/code>&lt;/p>
&lt;h3 id="rbac">RBAC&lt;/h3>
&lt;p>Tekton Pipeline å®‰è£…å®Œæˆåï¼Œéœ€è¦ç»™å‰é¢åˆ›å»ºçš„ ServiceAccount &lt;code>jenkins&lt;/code> å¢åŠ  tekon èµ„æºçš„æ“ä½œæƒé™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="l">//tekton-role.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Role&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-role&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pods&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pods/log&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">verbs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">get&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">list&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">watch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">tekton.dev&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">tasks&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">taskruns&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pipelineruns&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">verbs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">create&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">delete&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">deletecollection&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">get&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">list&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">patch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">update&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">watch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">RoleBinding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-role-binding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">roleRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Role&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-role&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">subjects&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ServiceAccount&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jenkins&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jenkins&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="jenkins-ä¸-tekton-äº¤äº’">Jenkins ä¸ Tekton äº¤äº’&lt;/h2>
&lt;p>å‰é¢å¤§ç¯‡å¹…çš„éƒ½åªæ˜¯å‡†å¤‡å·¥ä½œï¼ŒJenkins å®‰è£…æ—¶æˆ‘ä»¬å·²ç»æ·»åŠ äº† &lt;code>tekton-client-plugin&lt;/code> æ’ä»¶ã€‚&lt;/p>
&lt;p>æ·»åŠ ä¸€ä¸ªåä¸º &lt;code>tekton-client-sample&lt;/code> çš„ &lt;code>FreeStyle project&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622-151450.png" alt="åˆ›å»ºä½œä¸š">&lt;/p>
&lt;p>SCM è¿™é‡Œå¡«å…¥ç”¨äºæ„å»ºçš„é¡¹ç›®ä»“åº“åœ°å€ä»¥åŠåˆ†æ”¯ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622-151523.png" alt="é…ç½®ä»£ç ä»“åº“">&lt;/p>
&lt;p>Build æ¨¡å—ä¸­é€‰æ‹© &lt;code>Tekton: Create Resource (RAW)&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622-151544.png" alt="å¢åŠ  Tekton step">&lt;/p>
&lt;p>è¿™é‡Œé€‰æ‹© &lt;code>FILE&lt;/code> ç±»å‹ï¼Œå› ä¸ºæˆ‘å·²ç»å°† &lt;code>PipelineRun&lt;/code> çš„ yaml æ”¾è¿›äº†ä»£ç ä»“åº“ä¸­äº†ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622151734.png" alt="é…ç½® Resource">&lt;/p>
&lt;p>æ‰§è¡Œä¸€æ¬¡æ„å»º&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/22/20210622153535.png" alt="æ„å»ºç»“æŸ">&lt;/p>
&lt;p>æ£€æŸ¥ä¸‹åº”ç”¨&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get pod &lt;span class="p">|&lt;/span> grep tekton-test
tekton-test-75975dcc88-xkzb6 1/1 Running &lt;span class="m">0&lt;/span> 3m13s
tekton-test-c26lw-deploy-to-k8s-28trp-pod-w8tgc 0/1 Completed &lt;span class="m">0&lt;/span> 3m18s
tekton-test-c26lw-fetch-from-git-pv66g-pod-nm5qh 0/1 Completed &lt;span class="m">0&lt;/span> 6m30s
tekton-test-c26lw-source-to-image-k8mpg-pod-qh7g4 0/2 Completed &lt;span class="m">0&lt;/span> 6m15s
$ curl &lt;span class="k">$(&lt;/span>minikube ip&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>kubectl get svc tekton-test -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;{.spec.ports[0].nodePort}&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>/hi
hello world
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://www.jenkins.io/doc/book/installing/kubernetes/">Jenkins on Kubernetes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/jenkinsci/tekton-client-plugin/blob/master/docs/tutorial.md">Tekton Client Plugin Tutorial&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.jenkins.io/blog/2021/04/21/tekton-plugin/#easily-reuse-tekton-and-jenkins-x-from-jenkins">Easily reuse Tekton and Jenkins X from Jenkins&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>äº‘åŸç”Ÿ CICD: Tekton Pipeline å®æˆ˜</title><link>https://atbug.com/tekton-pipeline-practice/</link><pubDate>Tue, 22 Jun 2021 07:19:33 +0800</pubDate><guid>https://atbug.com/tekton-pipeline-practice/</guid><description>
&lt;p>æ›´æ–°å†å²ï¼š&lt;/p>
&lt;ul>
&lt;li>v1ï¼š2020.1.21 åŸºäº Tekton Pipline &lt;a href="https://github.com/tektoncd/pipeline/tree/v0.9.0/docs#tekton-pipelines">v0.9.0&lt;/a>&lt;/li>
&lt;li>v2ï¼ˆå½“å‰ï¼‰ï¼š2021.6.22 åŸºäº Tekton Pipeline &lt;a href="https://github.com/tektoncd/pipeline/tree/v0.25.0/docs#tekton-pipelines">v0.25.0&lt;/a>&lt;/li>
&lt;/ul>
&lt;hr>
&lt;p>Tekton æ˜¯ Google å¼€æºçš„ Kubernetes åŸç”ŸCI/CD ç³»ç»Ÿ, åŠŸèƒ½å¼ºå¤§æ‰©å±•æ€§å¼º. å‰èº«æ˜¯ Knavite é‡Œçš„ build-pipeline é¡¹ç›®, åæœŸå­µåŒ–æˆ&lt;a href="https://github.com/tektoncd/pipeline">ç‹¬ç«‹çš„é¡¹ç›®&lt;/a>. å¹¶æˆä¸º &lt;a href="https://cd.foundation/projects/">CDF&lt;/a> ä¸‹çš„å››ä¸ªé¡¹ç›®ä¹‹ä¸€, å…¶ä»–ä¸‰ä¸ªåˆ†åˆ«æ˜¯ Jenkins, Jenkins X, Spinnaker.&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆè¯´ Tekton æ˜¯ Kubernetes åŸç”Ÿçš„, ä»¥å†…å…¶åŸºäº Kubernetes çš„ CRD å®šä¹‰äº† Pipeline æµæ°´çº¿.&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/bquuTV.jpg" alt="">&lt;/p>
&lt;p>CRD åŠè¯´æ˜:&lt;/p>
&lt;ul>
&lt;li>Task: æ„å»ºä»»åŠ¡, å¯ä»¥å®šä¹‰ä¸€äº›åˆ—çš„ steps. æ¯ä¸ª step ç”±ä¸€ä¸ª container æ‰§è¡Œ.&lt;/li>
&lt;li>TaskRun: task å®é™…çš„æ‰§è¡Œ, å¹¶æä¾›æ‰§è¡Œæ‰€éœ€çš„å‚æ•°. è¿™ä¸ªå¯¹è±¡åˆ›å»ºå, å°±ä¼šæœ‰ pod è¢«åˆ›å»º.&lt;/li>
&lt;li>Pipeline: å®šä¹‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª task çš„æ‰§è¡Œ, ä»¥åŠ PipelineResource å’Œå„ç§å®šä¹‰å‚æ•°çš„é›†åˆ&lt;/li>
&lt;li>PipelineRun: ç±»ä¼¼ task å’Œ taskrun çš„å…³ç³»: ä¸€ä¸ªå®šä¹‰ä¸€ä¸ªæ‰§è¡Œ. PipelineRun åˆ™æ˜¯ pipeline çš„å®é™…æ‰§è¡Œ. åˆ›å»ºåä¹Ÿä¼šåˆ›å»º pod æ¥æ‰§è¡Œå„ä¸ª task.&lt;/li>
&lt;li>&lt;del>PipelineResource: æµæ°´çº¿çš„è¾“å…¥èµ„æº, æ¯”å¦‚ github/gitlab çš„æºç , æŸç§å­˜å‚¨æœåŠ¡çš„æ–‡ä»¶, æˆ–è€…é•œåƒç­‰. æ‰§è¡Œæ—¶, ä¹Ÿä¼šä½œä¸º pod çš„å…¶ä¸­ä¸€ä¸ª container æ¥è¿è¡Œ(æ¯”å¦‚æ‹‰å–ä»£ç ).&lt;/del> PipelineResource ç›®å‰å¤„äº Alahaï¼Œè‡³äºåŸå› å¯ä»¥çœ‹&lt;a href="https://github.com/tektoncd/pipeline/blob/v0.25.0/docs/resources.md#why-arent-pipelineresources-in-beta">Why Aren&amp;rsquo;t PipelineResources in Beta?&lt;/a>&lt;/li>
&lt;li>Condition: åœ¨ pipeline çš„ task æ‰§è¡Œæ—¶é€šè¿‡æ·»åŠ  condition æ¥å¯¹æ¡ä»¶è¿›è¡Œè¯„ä¼°, è¿›è€Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œ task. ç›®å‰æ˜¯WIPçš„çŠ¶æ€, å¾…&lt;a href="https://github.com/tektoncd/pipeline/issues/1137">#1137&lt;/a>çš„å®Œæˆ.&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ç»„ä»¶:&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;code>tekton-pipelines-controller&lt;/code>: ç›‘æ§ CRD å¯¹è±¡(TaskRun, PipelineRun)çš„åˆ›å»º, ä¸ºè¯¥æ¬¡æ‰§è¡Œåˆ›å»º pod.&lt;/li>
&lt;li>&lt;code>tekton-pipelines-webhook&lt;/code>: å¯¹ apiserver æä¾› http æ¥å£åš CRD å¯¹è±¡çš„æ ¡éªŒ.&lt;/li>
&lt;/ul>
&lt;h2 id="å‰ç½®æ¡ä»¶">å‰ç½®æ¡ä»¶&lt;/h2>
&lt;p>æ–‡ä¸­ä½¿ç”¨çš„ä¸€äº›å·¥å…·ï¼ŒåŸºæœ¬éƒ½å¯ä»¥é€šè¿‡ homebrew å®‰è£…ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://stedolan.github.io/jq/">jq&lt;/a> ï¼šæ“ä½œ json çš„å‘½ä»¤è¡Œå·¥å…·&lt;/li>
&lt;li>&lt;a href="https://httpie.io/">httpie&lt;/a>ï¼šHTTP å®¢æˆ·ç«¯å‘½ä»¤è¡Œå·¥å…·&lt;/li>
&lt;li>&lt;a href="https://minikube.sigs.k8s.io/docs/start/">minikube ç¯å¢ƒ&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>æ–‡ä¸­çš„ Java é¡¹ç›®ä»¥åŠ tekton çš„ç›¸å…³ yaml éƒ½å·²ç»æäº¤åˆ°äº† &lt;a href="https://github.com/addozhang/tekton-test">tekton-test&lt;/a>.&lt;/p>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;p>å‚è€ƒ&lt;a href="https://atbug.com/tekton-installation-and-sample/">ä¸Šä¸€ç¯‡æ–‡ç« &lt;/a>, æ–‡ç« ä¸­æœ‰ä¸ªç®€å•çš„&amp;quot;hello world&amp;quot;.&lt;/p>
&lt;h2 id="å®è·µ">å®è·µ&lt;/h2>
&lt;p>åˆ°äº†è¿™é‡Œç›¸ä¿¡å·²ç»å®‰è£…å¥½äº† Tekton. æˆ‘ä»¬ä½¿ç”¨&lt;a href="https://start.spring.io/">Spring Initializer&lt;/a>ç”Ÿæˆçš„é¡¹ç›®ä¸ºä¾‹, æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Tekton å®ç° CICD.&lt;/p>
&lt;p>å¼€å§‹ä¹‹å‰ç®€å•æ•´ç†ä¸‹è¿™ä¸ªé¡¹ç›®çš„ CICD æµç¨‹:&lt;/p>
&lt;ol>
&lt;li>æ‹‰å–ä»£ç &lt;/li>
&lt;li>maven æ‰“åŒ…&lt;/li>
&lt;li>æ„å»ºé•œåƒå¹¶æ¨é€&lt;/li>
&lt;li>éƒ¨ç½²&lt;/li>
&lt;/ol>
&lt;p>&lt;em>æ³¨: æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åœ¨ &lt;code>tekton-pipelines&lt;/code> namespace ä¸‹æ“ä½œ&lt;/em>&lt;/p>
&lt;h3 id="0x00-æ·»åŠ -dockerfile-å’Œéƒ¨ç½²ç”¨çš„-yaml">0x00 æ·»åŠ  Dockerfile å’Œéƒ¨ç½²ç”¨çš„ yaml&lt;/h3>
&lt;p>ç”¨äºæ„å»ºé•œåƒçš„Dockerfile&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">FROM openjdk:8-jdk-alpine
RUN mkdir /app
WORKDIR /app
COPY target/*.jar /app/app.jar
ENTRYPOINT [&amp;#34;sh&amp;#34;, &amp;#34;-c&amp;#34;, &amp;#34;java -Xmx128m -Xms64m -jar app.jar&amp;#34;]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”¨äºéƒ¨ç½² K8s Deployment çš„ deployment.ymlï¼ŒåŒæ—¶é€šè¿‡åˆ›å»º &lt;code>NodePort&lt;/code> ç±»å‹çš„ Service ç”¨äºè®¿é—®åº”ç”¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;apps/v1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Deployment&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addozhang/tekton-test:latest&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Always&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">livenessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">failureThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/actuator/info&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initialDelaySeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">60&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">successThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeoutSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tekton-test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">containerPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;TCP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">readinessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">failureThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/actuator/info&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initialDelaySeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">successThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeoutSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NodePort &lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x01-rbac">0x01 RBAC&lt;/h3>
&lt;p>åˆ›å»º ServiceAccount ç”¨äº Pipeline çš„è¿è¡Œã€‚&lt;/p>
&lt;p>&lt;strong>æ³¨ï¼šè¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆäºˆäº† &lt;code>ClusterRole&lt;/code> &lt;code>admin&lt;/code>ã€‚&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="c"># serviceaccount.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ServiceAccount&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-build&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterRoleBinding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pipeline-admin-binding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">roleRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterRole&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">admin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># user cluster role admin&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">subjects&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ServiceAccount&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-build&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x02-æ‹‰å–ä»£ç ">0x02 æ‹‰å–ä»£ç &lt;/h3>
&lt;p>ä»£ç ä½œä¸ºæ„å»ºçš„è¾“å…¥, éœ€è¦æä¾›ä¸€ä¸ª Pipeline CRD å¯¹è±¡æ¥è¡¨ç¤ºè¾“å…¥æ˜¯ä» git ä»“åº“æ¥è·å–ä»£ç ã€‚&lt;/p>
&lt;p>è®¿é—® Tekton Hub å¯ä»¥æ‰¾åˆ°ç°æˆçš„ &lt;a href="https://hub.tekton.dev/tekton/task/git-clone">git-clone task&lt;/a>ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ kubectl å®‰è£…ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f https://raw.githubusercontent.com/tektoncd/catalog/main/task/git-clone/0.4/git-clone.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…ä½¿ç”¨ tekton-cli å®‰è£…ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">tkn hub install task git-clone
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x03-maven-æ‰“åŒ…">0x03 maven æ‰“åŒ…&lt;/h3>
&lt;p>Task &lt;code>source-to-image.yaml&lt;/code>çš„ step &lt;code>maven&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.5.0-jdk-8-alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workingDir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(workspaces.source.path)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mvn&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">clean&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">install&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">DskipTests&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/root/.m2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/home/docker/.m2 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>è¯´æ˜:&lt;/strong>&lt;/p>
&lt;p>æœ‰äº†ä»£ç ä¸‹ä¸€æ­¥å°±æ˜¯æ‰§è¡Œ maven çš„ç¼–è¯‘æ‰“åŒ…, åœ¨&lt;code>maven:3.5.0-jdk-8-alpine&lt;/code>é•œåƒä¸­æ‰§è¡Œ&lt;code>mvn&lt;/code>çš„ç›¸å…³å‘½ä»¤.&lt;/p>
&lt;p>è¿™é‡ŒæŒ‚åœ¨äº†ä¸€ä¸ªæœ¬åœ°çš„volume, é¿å…æ¯æ¬¡æ„å»ºé‡å¤ä¸‹è½½ä¾èµ–åŒ…, åŒæ—¶é‡Œé¢è¿˜æœ‰&lt;code> settings.xml&lt;/code>&lt;/p>
&lt;p>&lt;em>æ³¨æ„: å¯¹äº minikube, hostPath è¯·ä½¿ç”¨/data/.m2, å¦åˆ™minikubeé‡å¯åæ— æ³•æŒä¹…åŒ–&lt;/em>&lt;/p>
&lt;h3 id="0x04-æ„å»ºé•œåƒå¹¶æ¨é€">0x04 æ„å»ºé•œåƒå¹¶æ¨é€&lt;/h3>
&lt;p>Task &lt;code>source-to-image.yaml&lt;/code> çš„ step &lt;code>build-and-push&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">spec:
params:
- name: pathToDockerFile
description: The path to the dockerfile to build (relative to the context)
default: Dockerfile
- name: imageUrl
description: Url of image repository
- name: imageTag
description: Tag to apply to the built image
default: latest
workspaces:
- name: source
- name: dockerconfig
mountPath: /kaniko/.docker # config.json çš„æŒ‚è½½ç›®å½•
steps:
- name: build-and-push
image: gcr.io/kaniko-project/executor:v1.6.0-debug
command:
- /kaniko/executor
args:
- --dockerfile=$(params.pathToDockerFile)
- --destination=$(params.imageUrl):$(params.imageTag)
- --context=$(workspaces.source.path)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>è¯´æ˜:&lt;/strong>&lt;/p>
&lt;p>é•œåƒçš„æ„å»º, æˆ‘ä»¬é‡‡ç”¨äº† kanikoã€‚&lt;/p>
&lt;p>é•œåƒä»“åº“æˆ‘ä»¬é€‰æ‹©äº†Docker Hub, æ¨é€çš„æ—¶å€™éœ€è¦ä½¿ç”¨ credentialsã€‚&lt;/p>
&lt;p>kaniko éœ€è¦å°† docker config çš„æ–‡ä»¶å­˜åœ¨äº &lt;code>/kanika/.docker&lt;/code> ç›®å½•ä¸‹ã€‚è¿™é‡Œçš„æ€è·¯æ˜¯å°† docker çš„ &lt;code>config.json&lt;/code>ï¼Œä»¥ &lt;code>secret&lt;/code> çš„æ–¹å¼æŒä¹…åŒ–ï¼Œåœ¨é€šè¿‡å…ˆæ·»åŠ &lt;code> docker-registry&lt;/code>ç±»å‹çš„ &lt;code>secret&lt;/code>ï¼Œç„¶åé€šè¿‡ &lt;code>workspace&lt;/code> çš„æ–¹å¼è¾“å…¥åˆ° kaniko è¿è¡Œç¯å¢ƒä¸­ã€‚&lt;/p>
&lt;p>&lt;code>config.json&lt;/code> é‡Œé¢ä¿å­˜çš„ json ç»“æ„åŒ–çš„æ•°æ®ï¼Œä¸ºäº†æ–¹ä¾¿é€šè¿‡ dry run åˆ›å»º&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create secret docker-registry dockerhub --docker-server&lt;span class="o">=&lt;/span>https://index.docker.io/v1/ --docker-username&lt;span class="o">=[&lt;/span>USERNAME&lt;span class="o">]&lt;/span> --docker-password&lt;span class="o">=[&lt;/span>PASSWORD&lt;span class="o">]&lt;/span> --dry-run&lt;span class="o">=&lt;/span>client -o json &lt;span class="p">|&lt;/span> jq -r &lt;span class="s1">&amp;#39;.data.&amp;#34;.dockerconfigjson&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> base64 -d &amp;gt; /tmp/config.json &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> kubectl create secret generic docker-config --from-file&lt;span class="o">=&lt;/span>/tmp/config.json &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> rm -f /tmp/config.json
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ‰§è¡Œ:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f tasks/source-to-image.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x05-éƒ¨ç½²">0x05 éƒ¨ç½²&lt;/h3>
&lt;p>deploy-to-k8s.yaml:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Task&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-to-k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">inputs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pathToYamlFile&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The path to the yaml file to deploy within the git source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deployment.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">run-kubectl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">lachlanevenson/k8s-kubectl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;kubectl&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;apply&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;-f&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;/workspace/git-source/$(inputs.params.pathToYamlFile)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>è¯´æ˜:&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>pathToYamlFile: æŒ‡å®šéƒ¨ç½²åº”ç”¨çš„ yamlã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>æ‰§è¡Œ:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f tasks/deploy-to-k8s.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x06-ç»„è£…æµæ°´çº¿">0x06 ç»„è£…æµæ°´çº¿&lt;/h3>
&lt;p>&lt;code>build-pipeline.yaml&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pipeline&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build-pipeline&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pathToContext&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The path to the build context, used by Kaniko - within the workspace&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageUrl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Url of image repository&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageTag&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Tag to apply to the built image&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">fetch-from-git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-clone&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$(params.git-url)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$(params.git-revision)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">output&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source-to-image&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source-to-image&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageUrl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$(params.imageUrl)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageTag&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$(params.imageTag)&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dockerconfig&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">runAfter&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">fetch-from-git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-to-k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy-to-k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pathToYamlFile&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deployment.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">runAfter&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">source-to-image&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ‰§è¡Œ:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f tasks/deploy-to-k8s.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x07-æ‰§è¡Œæµæ°´çº¿">0x07 æ‰§è¡Œæµæ°´çº¿&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PipelineRun&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">generateName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">generic-pr-&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">generic-pipeline-run&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">pipelineRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build-pipeline&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">main&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://github.com/addozhang/tekton-test.git &lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageUrl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">addozhang/tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageTag&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeClaimTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">1Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secret&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceAccountName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-build&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ‰§è¡Œ:&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f run/run.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="0x08-ç»“æœ">0x08 ç»“æœ&lt;/h3>
&lt;p>æ‰§è¡Œæµæ°´çº¿å, å¯ä»¥çœ‹åˆ°åˆ†åˆ«åˆ›å»ºäº†ä¸‹é¢çš„å‡ ä¸ª pod:&lt;/p>
&lt;ul>
&lt;li>generic-pipeline-run-deploy-to-k8s-xxx&lt;/li>
&lt;li>generic-pipeline-run-fetch-from-git-xxx&lt;/li>
&lt;li>generic-pipeline-run-source-to-image-xxx&lt;/li>
&lt;/ul>
&lt;p>ä»¥åŠæˆ‘ä»¬çš„åº”ç”¨ &lt;code>tekton-test-xxx&lt;/code>ï¼Œå‘èµ·è¯·æ±‚æµ‹è¯•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ http &lt;span class="k">$(&lt;/span>minikube ip&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>kubectl get svc tekton-test -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;{.spec.ports[0].nodePort}&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>/hi --body
hello world
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ç›®å‰ Tekton è¿›å…¥ beta é˜¶æ®µ, æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ &lt;code>0.25.0&lt;/code>ã€‚åŸºäº CRD çš„å®ç°è®© Tekton åœ¨å®é™…ä½¿ç”¨ä¸­å¯ä»¥çµæ´»çš„è®¾è®¡è‡ªå·±çš„ CICD æµç¨‹.&lt;/p>
&lt;p>ç”Ÿæ€ä¹Ÿè¶Šæ¥è¶Šå®Œå–„ï¼Œæ¯”å¦‚ &lt;a href="https://hub.tekton.dev/">Tekton Hub&lt;/a> æä¾›äº†å¤§é‡çš„å¯é‡ç”¨æœ€ä½³å®ç°çš„ Task å’Œ Pipelineã€‚&lt;/p>
&lt;p>ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°è¯•ä¸‹å¦‚ä½•åœ¨ Jenkins ä¸­ä¸ Tekton Pipeline è¿›è¡Œäº¤äº’ã€‚&lt;/p>
&lt;p>æ›´å¤šæ–‡ç« :&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/_hK6bqODJv3LrwnQaou-hA">Tekton çš„å·¥ä½œåŸç†&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://atbug.com/tekton-dashboard-installation/">Tekton Dashboard å®‰è£…&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://atbug.com/tekton-trigger-glance/">Tekton Trigger ä»‹ç»&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://atbug.com/tekton-trigger-practice/">Tekton Trigger å®æˆ˜&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>æºç è§£æï¼šä¸€æ–‡è¯»æ‡‚ Kubelet</title><link>https://atbug.com/kubelet-source-code-analysis/</link><pubDate>Tue, 15 Jun 2021 08:25:25 +0800</pubDate><guid>https://atbug.com/kubelet-source-code-analysis/</guid><description>
&lt;p>æœ¬æ–‡ä¸»è¦ä»‹ç» kubelet åŠŸèƒ½ã€æ ¸å¿ƒç»„ä»¶ï¼Œä»¥åŠå¯åŠ¨æµç¨‹çš„æºç åˆ†æï¼Œæ€»ç»“äº† kubelet çš„å·¥ä½œåŸç†ã€‚&lt;/p>
&lt;h2 id="kubelet-ç®€ä»‹">kubelet ç®€ä»‹&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/15/20210613091144.png" alt="Kubernetes çš„æ¶æ„å›¾">&lt;/p>
&lt;p>ä»å®˜æ–¹çš„æ¶æ„å›¾ä¸­å¾ˆå®¹æ˜“å°±èƒ½æ‰¾åˆ° &lt;code>kubelet&lt;/code>&lt;/p>
&lt;p>æ‰§è¡Œ &lt;code>kubelet -h&lt;/code> çœ‹åˆ° kubelet çš„åŠŸèƒ½ä»‹ç»ï¼š&lt;/p>
&lt;ul>
&lt;li>kubelet æ˜¯æ¯ä¸ª Node èŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œçš„ä¸»è¦â€œèŠ‚ç‚¹ä»£ç†â€ã€‚ä½¿ç”¨å¦‚ä¸‹çš„ä¸€ä¸ªå‘ apiserver æ³¨å†Œ Node èŠ‚ç‚¹ï¼šä¸»æœºçš„ &lt;code>hostname&lt;/code>ï¼›è¦†ç›– &lt;code>host&lt;/code> çš„å‚æ•°ï¼›æˆ–è€…äº‘æä¾›å•†æŒ‡å®šçš„é€»è¾‘ã€‚&lt;/li>
&lt;li>kubelet åŸºäº &lt;code>PodSpec&lt;/code> å·¥ä½œã€‚&lt;code>PodSpec&lt;/code> æ˜¯ç”¨ &lt;code>YAML&lt;/code> æˆ–è€… &lt;code>JSON&lt;/code> å¯¹è±¡æ¥æè¿° Podã€‚Kubelet æ¥å—é€šè¿‡å„ç§æœºåˆ¶ï¼ˆä¸»è¦æ˜¯ apiserverï¼‰æä¾›çš„ä¸€ç»„ &lt;code>PodSpec&lt;/code>ï¼Œå¹¶ç¡®ä¿é‡Œé¢æè¿°çš„å®¹å™¨è‰¯å¥½è¿è¡Œã€‚&lt;/li>
&lt;/ul>
&lt;p>é™¤äº†ç”± apiserver æä¾› &lt;code>PodSpec&lt;/code>ï¼Œè¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æä¾›ï¼š&lt;/p>
&lt;ul>
&lt;li>æ–‡ä»¶&lt;/li>
&lt;li>HTTP ç«¯ç‚¹&lt;/li>
&lt;li>HTTP æœåŠ¡å™¨&lt;/li>
&lt;/ul>
&lt;p>kubelet åŠŸèƒ½å½’çº³ä¸€ä¸‹å°±æ˜¯ä¸ŠæŠ¥ Node èŠ‚ç‚¹ä¿¡æ¯ï¼Œå’Œç®¡ç†ï¼ˆåˆ›å»ºã€é”€æ¯ï¼‰Podã€‚ åŠŸèƒ½çœ‹ä¼¼ç®€å•ï¼Œå®é™…ä¸ç„¶ã€‚æ¯ä¸€ä¸ªç‚¹æ‹¿å‡ºæ¥éƒ½éœ€è¦å¾ˆå¤§çš„ç¯‡å¹…æ¥è®²ï¼Œæ¯”å¦‚ Node èŠ‚ç‚¹çš„è®¡ç®—èµ„æºï¼Œé™¤äº†ä¼ ç»Ÿçš„ CPUã€å†…å­˜ã€ç¡¬ç›˜ï¼Œè¿˜æä¾›æ‰©å±•æ¥æ”¯æŒç±»ä¼¼ GPU ç­‰èµ„æºï¼›Pod ä¸ä»…ä»…æœ‰å®¹å™¨ï¼Œè¿˜æœ‰ç›¸å…³çš„ç½‘ç»œã€å®‰å…¨ç­–ç•¥ç­‰ã€‚&lt;/p>
&lt;h2 id="kubelet-æ¶æ„">kubelet æ¶æ„&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/15/20210614215508.png" alt="2021-06-14-21-55-08">&lt;/p>
&lt;h3 id="é‡è¦ç»„ä»¶">é‡è¦ç»„ä»¶&lt;/h3>
&lt;p>kubelet çš„æ¶æ„ç”± N å¤šçš„ç»„ä»¶ç»„æˆï¼Œä¸‹é¢ç®€å•ä»‹ç»ä¸‹æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªï¼š&lt;/p>
&lt;h4 id="pleg">PLEG&lt;/h4>
&lt;p>å³ &lt;strong>Pod Lifecycle Event Generator&lt;/strong>ï¼Œå­—é¢æ„æ€ Pod ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆ&lt;code>ContainerStarted&lt;/code>ã€&lt;code>ContainerDied&lt;/code>ã€&lt;code>ContainerRemoved&lt;/code>ã€&lt;code>ContainerChanged&lt;/code>ï¼‰ç”Ÿæˆå™¨ã€‚&lt;/p>
&lt;p>å…¶ç»´æŠ¤ç€ Pod ç¼“å­˜ï¼›å®šæœŸé€šè¿‡ &lt;code>ContainerRuntime&lt;/code> è·å– Pod çš„ä¿¡æ¯ï¼Œä¸ç¼“å­˜ä¸­çš„ä¿¡æ¯æ¯”è¾ƒï¼Œç”Ÿæˆå¦‚ä¸Šçš„äº‹ä»¶ï¼›å°†äº‹ä»¶å†™å…¥å…¶ç»´æŠ¤çš„é€šé“ï¼ˆchannelï¼‰ä¸­ã€‚&lt;/p>
&lt;h4 id="podworkers">PodWorkers&lt;/h4>
&lt;p>å¤„ç†äº‹ä»¶ä¸­ Pod çš„åŒæ­¥ã€‚æ ¸å¿ƒæ–¹æ³• &lt;code>managePodLoop()&lt;/code> é—´æ¥è°ƒç”¨ &lt;code>kubelet.syncPod()&lt;/code> å®Œæˆ Pod çš„åŒæ­¥ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœ Pod æ­£åœ¨è¢«åˆ›å»ºï¼Œè®°å½•å…¶å»¶è¿Ÿ&lt;/li>
&lt;li>ç”Ÿæˆ Pod çš„ API Statusï¼Œå³ &lt;code>v1.PodStatus&lt;/code>ï¼šä»è¿è¡Œæ—¶çš„ status è½¬æ¢æˆ api status&lt;/li>
&lt;li>è®°å½• Pod ä» &lt;code>pending&lt;/code> åˆ° &lt;code>running&lt;/code> çš„è€—æ—¶&lt;/li>
&lt;li>åœ¨ &lt;code>StatusManager&lt;/code> ä¸­æ›´æ–° pod çš„çŠ¶æ€&lt;/li>
&lt;li>æ€æ‰ä¸åº”è¯¥è¿è¡Œçš„ Pod&lt;/li>
&lt;li>å¦‚æœç½‘ç»œæ’ä»¶æœªå°±ç»ªï¼Œåªå¯åŠ¨ä½¿ç”¨äº†ä¸»æœºç½‘ç»œï¼ˆhost networkï¼‰çš„ Pod&lt;/li>
&lt;li>å¦‚æœ static pod ä¸å­˜åœ¨ï¼Œä¸ºå…¶åˆ›å»ºé•œåƒï¼ˆMirrorï¼‰Pod&lt;/li>
&lt;li>ä¸º Pod åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•ï¼šPod ç›®å½•ã€å·ç›®å½•ã€æ’ä»¶ç›®å½•&lt;/li>
&lt;li>ä½¿ç”¨ &lt;code>VolumeManager&lt;/code> ä¸º Pod æŒ‚è½½å·&lt;/li>
&lt;li>è·å– image pull secrets&lt;/li>
&lt;li>è°ƒç”¨å®¹å™¨è¿è¡Œæ—¶ï¼ˆcontainer runtimeï¼‰çš„ &lt;code>#SyncPod()&lt;/code> æ–¹æ³•&lt;/li>
&lt;/ul>
&lt;h4 id="podmanager">PodManager&lt;/h4>
&lt;p>å­˜å‚¨ Pod çš„æœŸæœ›çŠ¶æ€ï¼Œkubelet æœåŠ¡çš„ä¸åŒæ¸ é“çš„ Pod&lt;/p>
&lt;h4 id="statsprovider">StatsProvider&lt;/h4>
&lt;p>æä¾›èŠ‚ç‚¹å’Œå®¹å™¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œæœ‰ &lt;code>cAdvisor&lt;/code> å’Œ &lt;code>CRI&lt;/code> ä¸¤ç§å®ç°ã€‚&lt;/p>
&lt;h4 id="containerruntime">ContainerRuntime&lt;/h4>
&lt;p>é¡¾åæ€ä¹‰ï¼Œå®¹å™¨è¿è¡Œæ—¶ã€‚ä¸éµå¾ª CRI è§„èŒƒçš„é«˜çº§å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ã€‚&lt;/p>
&lt;h4 id="depspodconfig">Deps.PodConfig&lt;/h4>
&lt;p>PodConfig æ˜¯ä¸€ä¸ªé…ç½®å¤šè·¯å¤ç”¨å™¨ï¼Œå®ƒå°†è®¸å¤š Pod é…ç½®æºåˆå¹¶æˆä¸€ä¸ªå•ä¸€çš„ä¸€è‡´ç»“æ„ï¼Œç„¶åæŒ‰é¡ºåºå‘ç›‘å¬å™¨ä¼ é€’å¢é‡å˜æ›´é€šçŸ¥ã€‚&lt;/p>
&lt;p>é…ç½®æºæœ‰ï¼šæ–‡ä»¶ã€apiserverã€HTTP&lt;/p>
&lt;h4 id="syncloop">&lt;code>#syncLoop&lt;/code>&lt;/h4>
&lt;p>æ¥æ”¶æ¥è‡ª &lt;code>PodConfig&lt;/code> çš„ Pod å˜æ›´é€šçŸ¥ã€å®šæ—¶ä»»åŠ¡ã€&lt;code>PLEG&lt;/code> çš„äº‹ä»¶ï¼Œä»¥åŠ &lt;code>ProbeManager&lt;/code> çš„äº‹ä»¶ï¼Œå°† Pod åŒæ­¥åˆ°&lt;strong>æœŸæœ›çŠ¶æ€&lt;/strong>ã€‚&lt;/p>
&lt;h4 id="podadmithandlers">PodAdmitHandlers&lt;/h4>
&lt;p>Pod admission è¿‡ç¨‹ä¸­è°ƒç”¨çš„ä¸€ç³»åˆ—å¤„ç†å™¨ï¼Œæ¯”å¦‚ eviction handlerï¼ˆèŠ‚ç‚¹å†…å­˜æœ‰å‹åŠ›æ—¶ï¼Œä¸ä¼šé©±é€ QoS è®¾ç½®ä¸º &lt;code>BestEffort&lt;/code> çš„ Podï¼‰ã€shutdown admit handlerï¼ˆå½“èŠ‚ç‚¹å…³é—­æ—¶ï¼Œä¸å¤„ç† pod çš„åŒæ­¥æ“ä½œï¼‰ç­‰ã€‚&lt;/p>
&lt;h4 id="oomwatcher">OOMWatcher&lt;/h4>
&lt;p>ä»ç³»ç»Ÿæ—¥å¿—ä¸­è·å–å®¹å™¨çš„ OOM æ—¥å¿—ï¼Œå°†å…¶å°è£…æˆäº‹ä»¶å¹¶è®°å½•ã€‚&lt;/p>
&lt;h4 id="volumemanger">VolumeManger&lt;/h4>
&lt;p>VolumeManager è¿è¡Œä¸€ç»„å¼‚æ­¥å¾ªç¯ï¼Œæ ¹æ®åœ¨æ­¤èŠ‚ç‚¹ä¸Šè°ƒåº¦çš„ pod ç¡®å®šéœ€è¦é™„åŠ /æŒ‚è½½/å¸è½½/åˆ†ç¦»å“ªäº›å·å¹¶æ‰§è¡Œæ“ä½œã€‚&lt;/p>
&lt;h4 id="certificatemanager">CertificateManager&lt;/h4>
&lt;p>å¤„ç†è¯ä¹¦è½®æ¢ã€‚&lt;/p>
&lt;h4 id="probemanager">ProbeManager&lt;/h4>
&lt;p>å®é™…ä¸ŠåŒ…å«äº†ä¸‰ç§ Probeï¼Œæä¾› probe ç»“æœç¼“å­˜å’Œé€šé“ã€‚&lt;/p>
&lt;ul>
&lt;li>LivenessManager&lt;/li>
&lt;li>ReadinessManager&lt;/li>
&lt;li>StartupManager&lt;/li>
&lt;/ul>
&lt;h4 id="evictionmanager">EvictionManager&lt;/h4>
&lt;p>ç›‘æ§ Node èŠ‚ç‚¹çš„èµ„æºå ç”¨æƒ…å†µï¼Œæ ¹æ®é©±é€è§„åˆ™é©±é€ Pod é‡Šæ”¾èµ„æºï¼Œç¼“è§£èŠ‚ç‚¹çš„å‹åŠ›ã€‚&lt;/p>
&lt;h4 id="pluginmanager">PluginManager&lt;/h4>
&lt;p>PluginManager è¿è¡Œä¸€ç»„å¼‚æ­¥å¾ªç¯ï¼Œæ ¹æ®æ­¤èŠ‚ç‚¹ç¡®å®šå“ªäº›æ’ä»¶éœ€è¦æ³¨å†Œ/å–æ¶ˆæ³¨å†Œå¹¶æ‰§è¡Œã€‚å¦‚ CSI é©±åŠ¨å’Œè®¾å¤‡ç®¡ç†å™¨æ’ä»¶ï¼ˆDevice Pluginï¼‰ã€‚&lt;/p>
&lt;h5 id="csi">CSI&lt;/h5>
&lt;p>Container Storage Interfaceï¼Œç”±å­˜å‚¨å‚å•†å®ç°çš„å­˜å‚¨é©±åŠ¨ã€‚&lt;/p>
&lt;h5 id="è®¾å¤‡ç®¡ç†å™¨æ’ä»¶device-plugin">è®¾å¤‡ç®¡ç†å™¨æ’ä»¶ï¼ˆDevice Pluginï¼‰&lt;/h5>
&lt;p>Kubernetes æä¾›äº†ä¸€ä¸ª è®¾å¤‡æ’ä»¶æ¡†æ¶ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥å°†ç³»ç»Ÿç¡¬ä»¶èµ„æºå‘å¸ƒåˆ° Kubeletã€‚&lt;/p>
&lt;p>ä¾›åº”å•†å¯ä»¥å®ç°è®¾å¤‡æ’ä»¶ï¼Œç”±ä½ æ‰‹åŠ¨éƒ¨ç½²æˆ–ä½œä¸º DaemonSet æ¥éƒ¨ç½²ï¼Œè€Œä¸å¿…å®šåˆ¶ Kubernetes æœ¬èº«çš„ä»£ç ã€‚ç›®æ ‡è®¾å¤‡åŒ…æ‹¬ GPUã€é«˜æ€§èƒ½ NICã€FPGAã€ InfiniBand é€‚é…å™¨ä»¥åŠå…¶ä»–ç±»ä¼¼çš„ã€å¯èƒ½éœ€è¦ç‰¹å®šäºä¾›åº”å•†çš„åˆå§‹åŒ–å’Œè®¾ç½®çš„è®¡ç®—èµ„æºã€‚&lt;/p>
&lt;h2 id="kubelet-çš„å¯åŠ¨æµç¨‹">kubelet çš„å¯åŠ¨æµç¨‹&lt;/h2>
&lt;p>è¦åˆ†æ kubelet çš„å¯åŠ¨æµç¨‹ï¼Œå¯ä»¥ä» kubelet è¿è¡Œæ–¹å¼ç€æ‰‹ã€‚æ‰¾ä¸€ä¸ª Node èŠ‚ç‚¹ï¼Œå¾ˆå®¹æ˜“å°±èƒ½æ‰¾åˆ° kubelet çš„è¿›ç¨‹ã€‚ç”±äºå…¶æ˜¯ä»¥ &lt;code>systemd&lt;/code> çš„æ–¹å¼å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ &lt;code>systemctl&lt;/code> æŸ¥çœ‹å…¶çŠ¶æ€ã€‚&lt;/p>
&lt;h3 id="kubelet-å¯åŠ¨å‘½ä»¤">kubelet å¯åŠ¨å‘½ä»¤&lt;/h3>
&lt;p>kubelet çš„å¯åŠ¨å‘½ä»¤ï¼ˆminikube ç¯å¢ƒï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ ps -aux &lt;span class="p">|&lt;/span> grep &lt;span class="s1">&amp;#39;/kubelet&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> grep -v grep
root &lt;span class="m">4917&lt;/span> 2.6 0.3 &lt;span class="m">1857652&lt;/span> &lt;span class="m">106152&lt;/span> ? Ssl 01:34 13:05 /var/lib/minikube/binaries/v1.21.0/kubelet --bootstrap-kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/bootstrap-kubelet.conf --config&lt;span class="o">=&lt;/span>/var/lib/kubelet/config.yaml --container-runtime&lt;span class="o">=&lt;/span>docker --hostname-override&lt;span class="o">=&lt;/span>1.21.0 --kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/kubelet.conf --node-ip&lt;span class="o">=&lt;/span>192.168.64.5
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ systemctl status kubelet.service
â— kubelet.service - kubelet: The Kubernetes Node Agent
Loaded: loaded &lt;span class="o">(&lt;/span>/usr/lib/systemd/system/kubelet.service&lt;span class="p">;&lt;/span> disabled&lt;span class="p">;&lt;/span> vendor preset: enabled&lt;span class="o">)&lt;/span>
Drop-In: /etc/systemd/system/kubelet.service.d
â””â”€10-kubeadm.conf
Active: active &lt;span class="o">(&lt;/span>running&lt;span class="o">)&lt;/span> since Sun 2021-06-13 01:34:42 UTC&lt;span class="p">;&lt;/span> 11h ago
Docs: http://kubernetes.io/docs/
Main PID: &lt;span class="m">4917&lt;/span> &lt;span class="o">(&lt;/span>kubelet&lt;span class="o">)&lt;/span>
Tasks: &lt;span class="m">15&lt;/span> &lt;span class="o">(&lt;/span>limit: 38314&lt;span class="o">)&lt;/span>
Memory: 39.4M
CGroup: /system.slice/kubelet.service
â””â”€4917 /var/lib/minikube/binaries/v1.21.0/kubelet --bootstrap-kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/bootstrap-kubelet.conf --config&lt;span class="o">=&lt;/span>/var/lib/kubelet/config.yaml --container-runtime&lt;span class="o">=&lt;/span>docker --hostname-override&lt;span class="o">=&lt;/span>1.21.0 --kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/kubelet.conf --node-ip&lt;span class="o">=&lt;/span>192.168.64
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æºç åˆ†æ">æºç åˆ†æ&lt;/h3>
&lt;p>ä» &lt;code>git@github.com:kubernetes/kubernetes.git&lt;/code> ä»“åº“è·å–ä»£ç ï¼Œä½¿ç”¨æœ€æ–°çš„ &lt;code>release-1.21&lt;/code> åˆ†æ”¯ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>cmd/kubelet/kubelet.go:35&lt;/code> çš„ &lt;code>main&lt;/code> æ–¹æ³•ä¸ºç¨‹åºå…¥å£ã€‚
&lt;ul>
&lt;li>è°ƒç”¨ &lt;code>NewKubeletCommand&lt;/code> æ–¹æ³•ï¼Œåˆ›å»º command&lt;/li>
&lt;li>æ‰§è¡Œ command
&lt;ul>
&lt;li>&lt;code>cmd/kubelet/app/server.go:434&lt;/code> çš„ &lt;code>Run&lt;/code> æ–¹æ³•ã€‚
&lt;ul>
&lt;li>è°ƒç”¨ &lt;code>RunKubelet&lt;/code> æ–¹æ³•ã€‚
&lt;ul>
&lt;li>è°ƒç”¨ &lt;code>createAndInitKubelet&lt;/code> æ–¹æ³•ï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ– kubelet
&lt;ul>
&lt;li>&lt;code>pkg/kubelet/kubelet.go&lt;/code> çš„ &lt;code>NewMainKubelet&lt;/code> æ–¹æ³•ï¼Œåˆ›å»º kubeletçš„ å„ç§ç»„ä»¶ã€‚å…±åå‡ ä¸ªç»„ä»¶ï¼Œè§ &lt;a href="#kubelet-%E6%9E%B6%E6%9E%84">kubelet çš„æ„æ¶&lt;/a>ã€‚&lt;/li>
&lt;li>è°ƒç”¨ &lt;code>BirtyCry&lt;/code> æ–¹æ³•ï¼šæ”¾å‡º &lt;code>Starting&lt;/code> äº‹ä»¶&lt;/li>
&lt;li>è°ƒç”¨ &lt;code>StartGarbageCollection&lt;/code> æ–¹æ³•ï¼Œå¼€å¯ &lt;code>ContainerGC&lt;/code> å’Œ &lt;code>ImageGC&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>è°ƒç”¨ &lt;code>startKubelet&lt;/code> æ–¹æ³•ï¼ˆå¤§é‡ä½¿ç”¨ goroutine å’Œé€šé“ï¼‰
&lt;ul>
&lt;li>goroutineï¼š&lt;code>kubelet.Run()&lt;/code>
&lt;ul>
&lt;li>åˆå§‹åŒ–æ¨¡å—
&lt;ul>
&lt;li>metrics ç›¸å…³&lt;/li>
&lt;li>åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•ç›®å½•&lt;/li>
&lt;li>åˆ›å»ºå®¹å™¨æ—¥å¿—ç›®å½•&lt;/li>
&lt;li>å¯åŠ¨ &lt;code>ImageGCManager&lt;/code>&lt;/li>
&lt;li>å¯åŠ¨ &lt;code>ServerCertificateManager&lt;/code>&lt;/li>
&lt;li>å¯åŠ¨ &lt;code>OOMWatcher&lt;/code>&lt;/li>
&lt;li>å¯åŠ¨ &lt;code>ResourceAnalyzer&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>goroutineï¼š&lt;code>VolumeManager.Run()&lt;/code> å¼€å§‹å¤„ç† Pod Volume çš„å¸è½½å’ŒæŒ‚è½½&lt;/li>
&lt;li>goroutineï¼šçŠ¶æ€æ›´æ–° &lt;code>fastStatusUpdateOnce()&lt;/code> ï¼ˆæ›´æ–° Pod CIDR -&amp;gt; æ›´æ–° &lt;code>ContainerRuntime&lt;/code> çŠ¶æ€ -&amp;gt; æ›´æ–° Node èŠ‚ç‚¹çŠ¶æ€ï¼‰&lt;/li>
&lt;li>goroutineï¼š &lt;code>NodeLeaseController.Run()&lt;/code> æ›´æ–°èŠ‚ç‚¹ç§Ÿçº¦&lt;/li>
&lt;li>goroutineï¼š&lt;code>podKiller.PerformPodKillingWork&lt;/code> æ€æ‰æœªè¢«æ­£ç¡®å¤„ç†çš„ pod&lt;/li>
&lt;li>&lt;code>StatusManager.Start()&lt;/code> å¼€å§‹å‘ apiserver æ›´æ–° Pod çŠ¶æ€&lt;/li>
&lt;li>&lt;code>RuntimeClassManager.Start()&lt;/code>&lt;/li>
&lt;li>&lt;code>PLEG.Start()&lt;/code>ï¼šæŒç»­ä» &lt;code>ContainerRuntime&lt;/code> è·å– Pod/å®¹å™¨çš„çŠ¶æ€ï¼Œå¹¶ä¸ kubelet æœ¬åœ° cache ä¸­çš„æ¯”è¾ƒï¼Œç”Ÿæˆå¯¹åº”çš„ &lt;code>Event&lt;/code>&lt;/li>
&lt;li>&lt;code>syncLoop()&lt;/code> é‡ç‚¹ï¼Œ&lt;strong>&lt;em>æŒç»­ç›‘æ§å¹¶å¤„ç†æ¥è‡ªæ–‡ä»¶ã€apiserverã€http çš„å˜æ›´&lt;/em>&lt;/strong>ã€‚åŒ…æ‹¬ Pod çš„å¢åŠ ã€æ›´æ–°ã€ä¼˜é›…åˆ é™¤ã€éä¼˜é›…åˆ é™¤ã€è°ƒå’Œã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>å¯åŠ¨ serverï¼Œæš´éœ² &lt;code>/healthz&lt;/code> ç«¯ç‚¹&lt;/li>
&lt;li>é€šçŸ¥ &lt;code>systemd&lt;/code> &lt;code>kuberlet&lt;/code> æœåŠ¡å·²ç»å¯åŠ¨&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="kubelet-çš„å·¥ä½œåŸç†">kubelet çš„å·¥ä½œåŸç†&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/15/20210615000611.png" alt="">&lt;/p>
&lt;ol>
&lt;li>æ¥é™æ€æ–‡ä»¶ã€apiserver ä»¥åŠ HTTP è¯·æ±‚çš„ Pod é…ç½®å˜æ›´ï¼Œè¢«å‘é€åˆ° &lt;code>kubelet.syncLoop&lt;/code>&lt;/li>
&lt;li>PLEG ä¼šå®šæœŸé€šè¿‡å®¹å™¨è¿è¡Œæ—¶è·å–èŠ‚ç‚¹ä¸Š Pod çš„çŠ¶æ€ï¼Œä¸å…¶ç¼“å­˜ä¸­çš„ Pod ä¿¡æ¯è¿›è¡Œæ¯”è¾ƒï¼Œå°è£…æˆäº‹ä»¶ï¼Œè¿›å…¥ PLEG çš„é€šé“&lt;/li>
&lt;li>å®šæœŸæ£€æŸ¥å·¥ä½œé˜Ÿåˆ—ä¸­çš„ Pod&lt;/li>
&lt;li>ProbeManager çš„é€šé“ä¸­çš„ Pod&lt;/li>
&lt;li>ä»¥ä¸Š 1~4ï¼Œéƒ½ä¼šè¿›å…¥ &lt;code>syncLoopIteration&lt;/code>ï¼Œå¹¶ä»å¯¹åº”çš„é€šé“ä¸­è·å–åˆ°å¯¹åº” Podï¼Œå°† Pod çš„ä¿¡æ¯ä¿å­˜åˆ° &lt;code>PodManager&lt;/code>ï¼›ç„¶ååˆ†å‘ç»™ &lt;code>PodWorker&lt;/code>ï¼Œ&lt;a href="#PodWorkers">å®Œæˆä¸€äº›åˆ—çš„åŒæ­¥å·¥ä½œ&lt;/a>ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>kubelet å¯åŠ¨æµé‡å°±è®²åˆ°è¿™é‡Œï¼Œè™½ç„¶å¤æ‚ï¼Œè¿˜æ˜¯æœ‰è¿¹å¯å¾ªã€‚åªè¦äº†è§£äº† kubelet åœ¨ Kubernetes ä¸­çš„å®šä½åŠè§’è‰²ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£å…¶å·¥ä½œæµé‡ã€‚&lt;/p>
&lt;p>åé¢ä¼šå†æ·±å…¥åˆ†æ Pod åˆ›å»ºåŠå¯åŠ¨æµç¨‹ã€‚&lt;/p></description></item><item><title>å¯ç¼–ç¨‹ç½‘å…³ Pipy ç¬¬äºŒå¼¹ï¼šç¼–ç¨‹å®ç° Metrics åŠæºç è§£è¯»</title><link>https://atbug.com/programming-archive-metrics-with-pipy/</link><pubDate>Fri, 11 Jun 2021 08:27:36 +0800</pubDate><guid>https://atbug.com/programming-archive-metrics-with-pipy/</guid><description>
&lt;p>ç”±äºè¦ç»™å›¢é˜Ÿåšä¸€ä¸‹å…³äº Flomesh çš„åˆ†äº«ï¼Œå‡†å¤‡ä¸‹ææ–™ã€‚&lt;/p>
&lt;p>â€œåˆ†äº«æ˜¯æœ€å¥½çš„å­¦ä¹ æ–¹æ³•ã€‚â€&lt;/p>
&lt;p>ä¸Šä¸€å›&lt;a href="https://mp.weixin.qq.com/s/l8JzYRn350fjuCAOoo8pcg">åˆæ¢å¯ç¼–ç¨‹ç½‘å…³ Pipy&lt;/a>ï¼Œé¢†ç•¥äº† Pipy çš„â€œé£éªšâ€ã€‚ä» Pipy çš„ GUI äº¤äº’æ·±å…¥äº†è§£äº† Pipy çš„é…ç½®åŠ è½½æµç¨‹ã€‚&lt;/p>
&lt;p>ä»Šå¤©çœ‹ä¸€ä¸‹ Pipy å¦‚ä½•å®ç° Metrics çš„åŠŸèƒ½ï¼Œé¡ºä¾¿çœ‹ä¸‹æ•°æ®å¦‚ä½•åœ¨å¤šä¸ª Pipeline ä¸­è¿›è¡Œæµè½¬ã€‚&lt;/p>
&lt;h2 id="å‰ç½®">å‰ç½®&lt;/h2>
&lt;p>é¦–å…ˆï¼Œéœ€è¦å¯¹ Pipy æœ‰ä¸€å®šçš„äº†è§£ï¼Œå¦‚æœä¸äº†è§£çœ‹ä¸€ä¸‹&lt;a href="https://mp.weixin.qq.com/s/l8JzYRn350fjuCAOoo8pcg">ä¸Šä¸€ç¯‡æ–‡ç« &lt;/a>ã€‚&lt;/p>
&lt;p>å…¶æ¬¡æ„å»ºå¥½ Pipy ç¯å¢ƒï¼Œå…³äºæ„å»ºè¿˜æ˜¯å»çœ‹ä¸Šä¸€ç¯‡æ–‡ç« ã€‚&lt;/p>
&lt;h2 id="metrics-åŠŸèƒ½å®ç°">Metrics åŠŸèƒ½å®ç°&lt;/h2>
&lt;p>è‡³äº Pipy å®ç° Metrics çš„æ–¹å¼ï¼Œæºç ä¸­å°±æœ‰ï¼Œä½äº &lt;code>test/006-metrics/pipy.js&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/10/20210610202734.png" alt="">&lt;/p>
&lt;ul>
&lt;li>ä»£ç†ç›‘å¬ &lt;code>6080&lt;/code> ç«¯å£ï¼Œåç«¯æœåŠ¡åœ¨ &lt;code>8080&lt;/code> ç«¯å£ï¼ŒMetrics åœ¨ &lt;code>9090&lt;/code> ç«¯å£&lt;/li>
&lt;li>å…±æœ‰ 5 ä¸ª Pipelineï¼š3 ä¸ª listen ç±»å‹ï¼Œ2 ä¸ª Pipeline ç±»å‹&lt;/li>
&lt;li>7 ç§è¿‡æ»¤å™¨ï¼š&lt;code>fork&lt;/code>ã€&lt;code>connect&lt;/code>ã€&lt;code>decodeHttpRequest&lt;/code>ã€&lt;code>onMessageStart&lt;/code>ã€&lt;code>decodeHttpResponse&lt;/code>ã€&lt;code>encodeHttpRespnse&lt;/code>ã€&lt;code>replaceMessage&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>è´´ä¸€ä¸‹æºç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="nx">pipy&lt;/span>&lt;span class="p">({&lt;/span>
&lt;span class="nx">_metrics&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">count&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nx">_statuses&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{},&lt;/span>
&lt;span class="nx">_latencies&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">15&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">40&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">60&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">70&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">80&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">90&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">300&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">400&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2000&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">10000&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">30000&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">60000&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nb">Number&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">POSITIVE_INFINITY&lt;/span>
&lt;span class="p">],&lt;/span>
&lt;span class="nx">_buckets&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">[],&lt;/span>
&lt;span class="nx">_timestamp&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">6080&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">fork&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;in&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">connect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;127.0.0.1:8080&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">fork&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;out&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// Extract request info
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pipeline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;in&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">decodeHttpRequest&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">onMessageStart&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">_timestamp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Date&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;span class="nx">_metrics&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="c1">// Extract response info
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pipeline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;out&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">decodeHttpResponse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">onMessageStart&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">e&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="p">((&lt;/span>&lt;span class="nx">status&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">latency&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">head&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">status&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">latency&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Date&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">_timestamp&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">_latencies&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">findIndex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">latency&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">_buckets&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">_statuses&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">status&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">_statuses&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">status&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="p">))()&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="c1">// Expose as Prometheus metrics
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">9090&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">decodeHttpRequest&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">replaceMessage&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="p">(&lt;/span>&lt;span class="nx">sum&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Message&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="p">[&lt;/span>
&lt;span class="sb">`count &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">_metrics&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">...&lt;/span>&lt;span class="nb">Object&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">entries&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">_statuses&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">map&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="p">([&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="sb">`status{code=&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">&amp;#34;} &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">`&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="p">...&lt;/span>&lt;span class="nx">_buckets&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">map&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="sb">`bucket{le=&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">_latencies&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">&amp;#34;} &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">sum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">]&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;\n&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">))(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">encodeHttpResponse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// Mock service on port 8080
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">8080&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">decodeHttpRequest&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">replaceMessage&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="nx">Message&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Hello!\n&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">encodeHttpResponse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æµ‹è¯•">æµ‹è¯•&lt;/h2>
&lt;p>ä½¿ç”¨ ab åšè¯·æ±‚æ¨¡æ‹Ÿ &lt;code>ab -n 2000 -c 10 http://localhost:6080/&lt;/code>ï¼Œç„¶åæ£€æŸ¥ä¸‹è®°å½•çš„æŒ‡æ ‡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ http :9090 --body
count &lt;span class="m">2000&lt;/span>
status&lt;span class="o">{&lt;/span>&lt;span class="nv">code&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;200&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span> &lt;span class="m">2000&lt;/span>
bucket&lt;span class="o">{&lt;/span>&lt;span class="nv">le&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span> &lt;span class="m">1762&lt;/span>
bucket&lt;span class="o">{&lt;/span>&lt;span class="nv">le&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span> &lt;span class="m">1989&lt;/span>
bucket&lt;span class="o">{&lt;/span>&lt;span class="nv">le&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;5&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span> &lt;span class="m">1994&lt;/span>
bucket&lt;span class="o">{&lt;/span>&lt;span class="nv">le&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;7&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span> &lt;span class="m">1999&lt;/span>
bucket&lt;span class="o">{&lt;/span>&lt;span class="nv">le&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;10&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span> &lt;span class="m">2000&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆ†æ">åˆ†æ&lt;/h2>
&lt;p>&lt;strong>TL;DRï¼šæœ¬æ¬¡ç¤ºä¾‹çš„æ ¸å¿ƒæ˜¯ &lt;code>fork&lt;/code>ï¼Œä»å­—é¢æ„æ€å°±å¾ˆå®¹æ˜“ç†è§£ï¼šæ–°å¼€ä¸€ä¸ªå¤„ç†åˆ†æ”¯ï¼ˆPipelineï¼‰ï¼Œä¸ä¸»çº¿å¹¶è¡Œæ‰§è¡Œã€‚&lt;/strong>&lt;/p>
&lt;p>åœ¨ &lt;code>src/inbound.cpp:104 109&lt;/code> å¤„ï¼ŒPipy æ¥æ”¶ä¸€ä¸ªæ–°çš„è¿æ¥ã€‚
&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/10/20210610210104.png" alt="">&lt;/p>
&lt;p>åˆ›å»º &lt;code>Context&lt;/code> å’Œ &lt;code>Session&lt;/code>ï¼Œå¹¶åœ¨ L178 å¤„æ³¨å†Œäº‹ä»¶çš„å¤„ç†å™¨ï¼Œç„¶ååœ¨ L187 å¤„å¼€å§‹æ¥æ”¶æ•°æ®ã€‚
&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/10/20210610210414.png" alt="">&lt;/p>
&lt;p>åœ¨ &lt;code>#receive&lt;/code> æ–¹æ³•ä¸­ï¼Œå®šä¹‰äº†æ•°æ®æ¥æ”¶å¤„ç†å™¨ï¼šå°†è¯»åˆ°çš„æ•°æ®å†™å…¥ &lt;code>buffer&lt;/code> ä¸­ã€‚è¿™ä¸ª &lt;code>buffer&lt;/code> å­˜å‚¨çš„æ˜¯ &lt;code>Event&lt;/code>ç±»å‹æ•°æ®ã€‚ï¼ˆæ‰€ä»¥è¯´ Pipy æ˜¯åŸºäºæ•°æ®æµäº‹ä»¶ï¼Œå°†ä¸€äº›å°è£…æˆäº†äº‹ä»¶ï¼‰&lt;/p>
&lt;p>æ¥ç€è°ƒç”¨ &lt;code>Session#input&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/10/20210610211221.png" alt="">&lt;/p>
&lt;p>å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ &lt;code>ReusableSession#input&lt;/code>ï¼Œè°ƒç”¨ &lt;code>m_filters&lt;/code> çš„ &lt;code>#process&lt;/code> æ–¹æ³•ã€‚&lt;code>m_filters&lt;/code> å®é™…ä¸Šæ˜¯ &lt;code>Filter&lt;/code> ç±»å‹ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/10/20210610212917.png" alt="">&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆåªæœ‰ä¸€ä¸ª &lt;code>Filter&lt;/code>ï¼Ÿé‡ç‚¹æ¥äº†ï¼Œçœ‹ä¸‹ &lt;code>ReusableSession&lt;/code> çš„æ„é€ è¿‡ç¨‹å°±èƒ½æ˜ç™½äº†ï¼ˆè¿™é‡Œç”¨äº†ä¸ªåå‘è¿­ä»£å™¨ï¼‰ã€‚&lt;code>output&lt;/code> æ˜¯å½“å‰ &lt;code>Filter&lt;/code> å¤„ç†å®Œè¦æ‰§è¡Œçš„ï¼Œå®ç°ç±»ä¼¼é“¾å¼çš„æ‰§è¡Œã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/10/20210610213338.png" alt="">&lt;/p>
&lt;p>å†å›å¤´çœ‹ä¸Šé¢çš„ç¤ºä¾‹ï¼Œå¯ä»¥æƒ³è±¡ &lt;code>fork&lt;/code> å°±æ˜¯ &lt;code>Session&lt;/code> çš„ &lt;code>m_filters&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>src/filters/fork.cpp:85&lt;/code>ï¼Œåœ¨ &lt;code>fork&lt;/code> è¿‡æ»¤å™¨ä¸­ï¼Œåœ¨ &lt;em>1&lt;/em> å¤„ä» &lt;code>module&lt;/code> ä¸­è·å–åˆ°ç›®æ ‡ &lt;code>Pipeline&lt;/code>ï¼Œå¹¶åœ¨ &lt;em>3&lt;/em> å’Œ &lt;em>4&lt;/em> å¤„ åˆ›å»ºäº†æ–°çš„ &lt;code>Session&lt;/code> å¹¶ä¿å­˜åŸ &lt;code>Session&lt;/code> çš„æ•°æ®ã€‚&lt;/p>
&lt;p>ç„¶ååœ¨ &lt;em>5&lt;/em> å¤„å°†åŸ &lt;code>Event&lt;/code> è¾“å…¥åˆ°æ–°çš„ &lt;code>Session&lt;/code> ä¸­ï¼Œè§¦å‘ç›®æ ‡ &lt;code>Pipeline&lt;/code> çš„ &lt;code>Filter&lt;/code> é“¾ã€‚&lt;strong>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ˜¯åŸºäºäº‹ä»¶çš„å¤„ç†ï¼Œå¹¶ä¸æ˜¯é˜»å¡çš„ã€‚è¿™å°±æ„å‘³ç€ï¼Œ&lt;code>fork&lt;/code> çš„ç›®æ ‡ &lt;code>pipline&lt;/code>ï¼Œä¸ &lt;code>fork&lt;/code> æ‰€åœ¨çš„ pipeline æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚&lt;/strong> åœ¨ç¤ºä¾‹ä¸­ï¼Œå°±æ˜¯ &lt;code>Pipeline&lt;/code> â€˜inâ€™ ä¸ ä¸» &lt;code>Pipeline&lt;/code> çš„ &lt;code>connect&lt;/code> æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚&lt;/p>
&lt;p>æœ€ç»ˆåœ¨ &lt;em>6&lt;/em> å¤„ï¼Œç»§ç»­ä½¿ç”¨åŸ &lt;code>Session&lt;/code> çš„ &lt;code>Filter&lt;/code> é“¾ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/10/20210610214811.png" alt="">&lt;/p></description></item><item><title>Kubernetes çš„è‡ªåŠ¨ä¼¸ç¼©ä½ ç”¨å¯¹äº†å—ï¼Ÿ</title><link>https://atbug.com/auto-scaling-best-practice-in-kubernetes/</link><pubDate>Wed, 09 Jun 2021 00:34:25 +0800</pubDate><guid>https://atbug.com/auto-scaling-best-practice-in-kubernetes/</guid><description>
&lt;p>æœ¬æ–‡ç¿»è¯‘è‡ª learnk8s çš„ &lt;a href="https://learnk8s.io/kubernetes-autoscaling-strategies#when-autoscaling-pods-goes-wrong">Architecting Kubernetes clusters â€” choosing the best autoscaling strategy&lt;/a>ï¼Œ&lt;!-- raw HTML omitted -->æœ‰å¢åˆ éƒ¨åˆ†å†…å®¹&lt;!-- raw HTML omitted -->ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2159402x.png" alt="">&lt;/p>
&lt;p>TL;DR: åœ¨é»˜è®¤è®¾ç½®ä¸‹ï¼Œæ‰©å±• Kubernetes é›†ç¾¤ä¸­çš„ pod å’ŒèŠ‚ç‚¹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚äº†è§£å¦‚ä½•è°ƒæ•´é›†ç¾¤èŠ‚ç‚¹çš„å¤§å°ã€é…ç½®æ°´å¹³å’Œé›†ç¾¤è‡ªåŠ¨ç¼©æ”¾å™¨ä»¥åŠè¿‡åº¦é…ç½®é›†ç¾¤ä»¥åŠ å¿«æ‰©å±•é€Ÿåº¦ã€‚&lt;/p>
&lt;h2 id="è‡ªåŠ¨æ‰©å±•å™¨">è‡ªåŠ¨æ‰©å±•å™¨&lt;/h2>
&lt;p>åœ¨ Kubernetes ä¸­ï¼Œå¸¸è¯´çš„â€œè‡ªç”¨æ‰©å±•â€æœ‰ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">HPAï¼šPod æ°´å¹³ç¼©æ”¾å™¨&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler">VPAï¼šPod å‚ç›´ç¼©æ”¾å™¨&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler">CAï¼šé›†ç¾¤è‡ªåŠ¨ç¼©æ”¾å™¨&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ä¸åŒç±»å‹çš„è‡ªåŠ¨ç¼©æ”¾å™¨ï¼Œä½¿ç”¨çš„åœºæ™¯ä¸ä¸€æ ·ã€‚&lt;/p>
&lt;h3 id="hpa">HPA&lt;/h3>
&lt;p>HPA å®šæœŸæ£€æŸ¥å†…å­˜å’Œ CPU ç­‰æŒ‡æ ‡ï¼Œè‡ªåŠ¨è°ƒæ•´ Deployment ä¸­çš„å‰¯æœ¬æ•°ï¼Œæ¯”å¦‚æµé‡å˜åŒ–ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2206552x.png" alt="è°ƒæ•´å‰">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2207122x.png" alt="è°ƒæ•´å">&lt;/p>
&lt;h3 id="vpa">VPA&lt;/h3>
&lt;p>æœ‰äº›æ—¶å€™æ— æ³•é€šè¿‡å¢åŠ  Pod æ•°æ¥æ‰©å®¹ï¼Œæ¯”å¦‚æ•°æ®åº“ã€‚è¿™æ—¶å€™å¯ä»¥é€šè¿‡ VPA å¢åŠ  Pod çš„å¤§å°ï¼Œæ¯”å¦‚è°ƒæ•´ Pod çš„ CPU å’Œå†…å­˜ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2212162x.png" alt="è°ƒæ•´å‰">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2212342x.png" alt="è°ƒæ•´å">&lt;/p>
&lt;h3 id="ca">CA&lt;/h3>
&lt;p>å½“é›†ç¾¤èµ„æºä¸è¶³æ—¶ï¼ŒCA ä¼šè‡ªåŠ¨é…ç½®æ–°çš„è®¡ç®—èµ„æºå¹¶æ·»åŠ åˆ°é›†ç¾¤ä¸­ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2213392x.png" alt="è°ƒæ•´å‰">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2214182x.png" alt="è°ƒæ•´å">&lt;/p>
&lt;h2 id="è‡ªåŠ¨ç¼©æ”¾-pod-å‡ºé”™æ—¶">è‡ªåŠ¨ç¼©æ”¾ Pod å‡ºé”™æ—¶&lt;/h2>
&lt;p>æ¯”å¦‚ä¸€ä¸ªåº”ç”¨éœ€è¦ 1.5 GB å†…å­˜å’Œ 0.25 ä¸ª vCPUã€‚ä¸€ä¸ª 8GB å’Œ 2 ä¸ª vCPU çš„èŠ‚ç‚¹ï¼Œå¯ä»¥å®¹çº³ 4 ä¸ªè¿™æ ·çš„ Podï¼Œå®Œç¾ï¼&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2216192x.png" alt="">&lt;/p>
&lt;p>åšå¦‚ä¸‹é…ç½®ï¼š&lt;/p>
&lt;ol>
&lt;li>HPAï¼šæ¯å¢åŠ  10 ä¸ªå¹¶å‘ï¼Œå¢åŠ ä¸€ä¸ªå‰¯æœ¬ã€‚å³ 40 ä¸ªå¹¶å‘çš„æ—¶å€™ï¼Œè‡ªåŠ¨æ‰©å±•åˆ° 4 ä¸ªå‰¯æœ¬ã€‚ï¼ˆè¿™é‡Œä½¿ç”¨è‡ªå®šä¹‰æŒ‡æ ‡ï¼Œæ¯”å¦‚æ¥è‡ª Ingress Controller çš„ QPSï¼‰&lt;/li>
&lt;li>CAï¼šåœ¨èµ„æºä¸è¶³çš„æ—¶å€™ï¼Œå¢åŠ è®¡ç®—èŠ‚ç‚¹ã€‚&lt;/li>
&lt;/ol>
&lt;p>å½“å¹¶å‘è¾¾åˆ° 30 çš„æ—¶å€™ï¼Œç³»ç»Ÿæ˜¯ä¸‹é¢è¿™æ ·ã€‚å®Œç¾ï¼HPA å·¥ä½œæ­£å¸¸ï¼ŒCA æ²¡å·¥ä½œã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2223102x.png" alt="">&lt;/p>
&lt;p>å½“å¢åŠ åˆ° 40 ä¸ªå¹¶å‘çš„æ—¶å€™ï¼Œç³»ç»Ÿæ˜¯ä¸‹é¢çš„æƒ…å†µï¼š&lt;/p>
&lt;ol>
&lt;li>HPA å¢åŠ äº†ä¸€ä¸ª Pod&lt;/li>
&lt;li>Pod æŒ‚èµ·&lt;/li>
&lt;li>CA å¢åŠ äº†ä¸€ä¸ªèŠ‚ç‚¹&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2224462x.png" alt="HPA å·¥ä½œ">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2225022x.png" alt="CA å·¥ä½œ">&lt;/p>
&lt;p>&lt;em>ä¸ºä»€ä¹ˆ Pod æ²¡æœ‰éƒ¨ç½²æˆåŠŸï¼Ÿ&lt;/em>&lt;/p>
&lt;p>èŠ‚ç‚¹ä¸Šçš„æ“ä½œç³»ç»Ÿè¿›ç¨‹å’Œ kubelet ä¹Ÿä¼šæ¶ˆè€—ä¸€éƒ¨åˆ†èµ„æºï¼Œ8G å’Œ 2 vCPU å¹¶ä¸æ˜¯å…¨éƒ½å¯ä»¥æä¾›ç»™ Pod ç”¨çš„ã€‚å¹¶ä¸”è¿˜æœ‰ä¸€ä¸ª&lt;a href="https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/#eviction-thresholds">é©±é€é˜ˆå€¼&lt;/a>ï¼šåœ¨èŠ‚ç‚¹ç³»ç»Ÿå‰©ä½™èµ„æºè¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œä¼šé©±é€ Podï¼Œé¿å… OOM çš„å‘ç”Ÿã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2230402x.png" alt="">&lt;/p>
&lt;p>å½“ç„¶ä¸Šé¢çš„è¿™äº›éƒ½æ˜¯&lt;a href="https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/#node-allocatable">å¯é…ç½®&lt;/a>çš„ã€‚&lt;/p>
&lt;p>&lt;em>é‚£ä¸ºä»€ä¹ˆåœ¨åˆ›å»ºè¯¥ Pod ä¹‹å‰ï¼ŒCA æ²¡æœ‰å¢åŠ æ–°çš„èŠ‚ç‚¹å‘¢ï¼Ÿ&lt;/em>&lt;/p>
&lt;h2 id="ca-å¦‚ä½•å·¥ä½œ">CA å¦‚ä½•å·¥ä½œï¼Ÿ&lt;/h2>
&lt;p>&lt;strong>CA åœ¨è§¦å‘è‡ªåŠ¨ç¼©æ”¾æ—¶ï¼Œä¸ä¼šæŸ¥çœ‹å¯ç”¨çš„å†…å­˜æˆ– CPUã€‚&lt;/strong>&lt;/p>
&lt;p>CA æ˜¯é¢å‘äº‹ä»¶å·¥ä½œçš„ï¼Œå¹¶æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦å­˜åœ¨ä¸å¯è°ƒåº¦ï¼ˆPendingï¼‰çš„ Podã€‚&lt;/p>
&lt;p>å½“è°ƒåº¦å™¨æ— æ³•æ‰¾åˆ°å¯ä»¥å®¹çº³ Pod çš„èŠ‚ç‚¹æ—¶ï¼Œè¿™ä¸ª Pod æ˜¯ä¸å¯è°ƒåº¦çš„ã€‚&lt;/p>
&lt;p>æ­¤æ—¶ï¼ŒCA å¼€å§‹åˆ›å»ºæ–°èŠ‚ç‚¹ï¼šCA æ‰«æé›†ç¾¤å¹¶æ£€æŸ¥æ˜¯å¦æœ‰ä¸å¯è°ƒåº¦çš„ Podã€‚&lt;/p>
&lt;p>å½“é›†ç¾¤æœ‰å¤šç§èŠ‚ç‚¹æ± ï¼ŒCA ä¼šé€šè¿‡é€‰æ‹©ä¸‹é¢çš„ä¸€ç§ç­–ç•¥ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>random&lt;/code>ï¼šé»˜è®¤çš„æ‰©å±•å™¨ï¼Œéšæœºé€‰æ‹©ä¸€ç§èŠ‚ç‚¹æ± &lt;/li>
&lt;li>&lt;code>most-pods&lt;/code>ï¼šèƒ½å¤Ÿè°ƒåº¦æœ€å¤š Pod çš„èŠ‚ç‚¹æ± &lt;/li>
&lt;li>&lt;code>least-waste&lt;/code>ï¼šé€‰æ‹©æ‰©å±•åï¼Œèµ„æºç©ºé—²æœ€å°‘çš„èŠ‚ç‚¹æ± &lt;/li>
&lt;li>&lt;code>price&lt;/code>ï¼šé€‰æ‹©æˆæœ¬æœ€ä½çš„èŠ‚ç‚¹æ± &lt;/li>
&lt;li>&lt;code>priority&lt;/code>ï¼šé€‰æ‹©ç”¨æˆ·åˆ†é…çš„å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§çš„èŠ‚ç‚¹æ± &lt;/li>
&lt;/ul>
&lt;p>ç¡®å®šç±»å‹åï¼ŒCA ä¼šè°ƒç”¨ç›¸å…³ API æ¥åˆ›å»ºèµ„æºã€‚ï¼ˆäº‘å‚å•†ä¼šå®ç° APIï¼Œæ¯”å¦‚ AWS æ·»åŠ  EC2ï¼›Azure æ·»åŠ  Virtual Machineï¼›é˜¿é‡Œäº‘å¢åŠ  ECSï¼›GCP å¢åŠ  Compute Engineï¼‰&lt;/p>
&lt;p>è®¡ç®—èµ„æºå°±ç»ªåï¼Œå°±ä¼šè¿›è¡Œ&lt;a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/">èŠ‚ç‚¹çš„åˆå§‹åŒ–&lt;/a>ã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼Œè¿™é‡Œéœ€è¦ä¸€å®šçš„è€—æ—¶ï¼Œé€šå¸¸æ¯”è¾ƒæ…¢ã€‚&lt;/p>
&lt;h2 id="æ¢ç´¢-pod-è‡ªåŠ¨ç¼©æ”¾çš„å‰ç½®æ—¶é—´">æ¢ç´¢ Pod è‡ªåŠ¨ç¼©æ”¾çš„å‰ç½®æ—¶é—´&lt;/h2>
&lt;p>å››ä¸ªå› ç´ ï¼š&lt;/p>
&lt;ol>
&lt;li>HPA çš„å“åº”è€—æ—¶&lt;/li>
&lt;li>CA çš„å“åº”è€—æ—¶&lt;/li>
&lt;li>èŠ‚ç‚¹çš„åˆå§‹åŒ–è€—æ—¶&lt;/li>
&lt;li>Pod çš„åˆ›å»ºæ—¶é—´&lt;/li>
&lt;/ol>
&lt;p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ&lt;a href="https://github.com/kubernetes/kubernetes/blob/2da8d1c18fb9406bd8bb9a51da58d5f8108cb8f7/pkg/kubelet/kubelet.go#L1855">kubelet æ¯ 10 ç§’æŠ“å–ä¸€æ¬¡ Pod çš„ CPU å’Œå†…å­˜å ç”¨æƒ…å†µ&lt;/a>ã€‚&lt;/p>
&lt;p>&lt;a href="https://github.com/kubernetes-sigs/metrics-server/blob/master/FAQ.md#how-often-metrics-are-scraped">æ¯åˆ†é’Ÿï¼ŒMetrics Server ä¼šå°†èšåˆçš„æŒ‡æ ‡å¼€æ”¾&lt;/a>ç»™ Kubernetes API çš„å…¶ä»–ç»„ä»¶ä½¿ç”¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2256302x.png" alt="">&lt;/p>
&lt;p>&lt;a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-does-scale-up-work">CA æ¯ 10 ç§’æ’æŸ¥ä¸å¯è°ƒåº¦çš„ Podã€‚&lt;/a>&lt;/p>
&lt;ul>
&lt;li>å°‘äº 100 ä¸ªèŠ‚ç‚¹ï¼Œä¸”æ¯ä¸ªèŠ‚ç‚¹æœ€å¤š 30 ä¸ª Podï¼Œæ—¶é—´ä¸è¶…è¿‡ 30sã€‚å¹³å‡å»¶è¿Ÿå¤§çº¦ 5sã€‚&lt;/li>
&lt;li>100 åˆ° 1000ä¸ªèŠ‚ç‚¹ï¼Œä¸è¶…è¿‡ 60sã€‚å¹³å‡å»¶è¿Ÿå¤§çº¦ 15sã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2300242x.png" alt="">&lt;/p>
&lt;p>èŠ‚ç‚¹çš„é…ç½®æ—¶é—´ï¼Œå–å†³äºäº‘æœåŠ¡å•†ã€‚é€šå¸¸åœ¨ 3~5 åˆ†é’Ÿã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2301312x.png" alt="">&lt;/p>
&lt;p>å®¹å™¨è¿è¡Œæ—¶åˆ›å»º Podï¼šå¯åŠ¨å®¹å™¨çš„å‡ æ¯«ç§’å’Œ&lt;strong>ä¸‹è½½é•œåƒçš„å‡ ç§’é’Ÿ&lt;/strong>ã€‚å¦‚æœä¸åšé•œåƒç¼“å­˜ï¼Œå‡ ç§’åˆ° 1 åˆ†é’Ÿä¸ç­‰ï¼Œå–å†³äºå±‚çš„å¤§å°å’Œæ¢³ç†ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2302382x.png" alt="">&lt;/p>
&lt;p>å¯¹äºå°è§„æ¨¡çš„é›†ç¾¤ï¼Œæœ€åçš„æƒ…å†µæ˜¯ 6 åˆ† 30 ç§’ã€‚å¯¹äº 100 ä¸ªä»¥ä¸ŠèŠ‚ç‚¹è§„æ¨¡çš„é›†ç¾¤ï¼Œå¯èƒ½é«˜è¾¾ 7 åˆ†é’Ÿã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">HPA delay: 1m30s +
CA delay: 0m30s +
Cloud provider: 4m +
Container runtime: 0m30s +
=========================
Total 6m30s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>çªå‘æƒ…å†µï¼Œæ¯”å¦‚æµé‡æ¿€å¢ï¼Œä½ æ˜¯å¦æ„¿æ„ç­‰è¿™ 7 åˆ†é’Ÿï¼Ÿ&lt;/em>&lt;/p>
&lt;p>&lt;em>è¿™ 7 åˆ†é’Ÿï¼Œå¦‚ä½•ä¼˜åŒ–å‹ç¼©ï¼Ÿ&lt;/em>&lt;/p>
&lt;ul>
&lt;li>HPA çš„åˆ·æ–°æ—¶é—´ï¼Œé»˜è®¤ 15 ç§’ï¼Œé€šè¿‡ &lt;code>--horizontal-pod-autoscaler-sync-period&lt;/code> æ ‡å¿—æ§åˆ¶ã€‚&lt;/li>
&lt;li>Metrics Server çš„æŒ‡æ ‡æŠ“å–æ—¶é—´ï¼Œé»˜è®¤ 60 ç§’ï¼Œé€šè¿‡ &lt;code>metric-resolution&lt;/code> æ§åˆ¶ã€‚&lt;/li>
&lt;li>CA çš„æ‰«æé—´éš”ï¼Œé»˜è®¤ 10 ç§’ï¼Œé€šè¿‡ &lt;code>scan-interval&lt;/code> æ§åˆ¶ã€‚&lt;/li>
&lt;li>èŠ‚ç‚¹ä¸Šç¼“å­˜é•œåƒï¼Œæ¯”å¦‚ &lt;a href="https://github.com/senthilrch/kube-fledged">kube-fledged&lt;/a> ç­‰å·¥å…·ã€‚&lt;/li>
&lt;/ul>
&lt;p>å³ä½¿è°ƒå°äº†ä¸Šè¿°è®¾ç½®ï¼Œä¾ç„¶ä¼šå—äº‘æœåŠ¡å•†çš„æ—¶é—´é™åˆ¶ã€‚&lt;/p>
&lt;p>&lt;em>é‚£ä¹ˆï¼Œå¦‚ä½•è§£å†³ï¼Ÿ&lt;/em>&lt;/p>
&lt;p>ä¸¤ç§å°è¯•ï¼š&lt;/p>
&lt;ol>
&lt;li>å°½é‡é¿å…è¢«åŠ¨åˆ›å»ºæ–°èŠ‚ç‚¹&lt;/li>
&lt;li>ä¸»åŠ¨åˆ›å»ºæ–°èŠ‚ç‚¹&lt;/li>
&lt;/ol>
&lt;h2 id="ä¸º-kubernetes-é€‰æ‹©æœ€ä½³è§„æ ¼çš„èŠ‚ç‚¹">ä¸º Kubernetes é€‰æ‹©æœ€ä½³è§„æ ¼çš„èŠ‚ç‚¹&lt;/h2>
&lt;p>&lt;strong>è¿™ä¼šå¯¹æ‰©å±•ç­–ç•¥äº§ç”Ÿå·¨å¤§å½±å“ã€‚&lt;/strong>&lt;/p>
&lt;p>&lt;em>è¿™æ ·çš„åœºæ™¯&lt;/em>&lt;/p>
&lt;p>åº”ç”¨ç¨‹åºéœ€è¦ 1GB å†…å­˜å’Œ 0.1 vCPUï¼›æœ‰ä¸€ä¸ª 4GB å†…å­˜å’Œ 1 ä¸ª vCPU çš„èŠ‚ç‚¹ã€‚&lt;/p>
&lt;p>æ’é™¤æ“ä½œç³»ç»Ÿã€kubelet å’Œé˜ˆå€¼ä¿ç•™ç©ºé—´åï¼Œæœ‰ 2.5GB å†…å­˜å’Œ 0.7 ä¸ª vCPU å¯ç”¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2314032x.png" alt="">&lt;/p>
&lt;p>æœ€å¤šåªèƒ½å®¹çº³ 2 ä¸ª Podï¼Œæ‰©å±•å‰¯æœ¬æ—¶æœ€é•¿è€—æ—¶ 7 åˆ†é’Ÿï¼ˆHPAã€CAã€äº‘æœåŠ¡å•†çš„èµ„æºé…ç½®è€—æ—¶ï¼‰&lt;/p>
&lt;p>å‡å¦‚èŠ‚ç‚¹çš„è§„æ ¼æ˜¯ 64GB å†…å­˜å’Œ 16 ä¸ª vCPUï¼Œå¯ç”¨çš„èµ„æºä¸º 58.32GB å’Œ 15.8 ä¸ª vCPUã€‚&lt;/p>
&lt;p>&lt;strong>è¿™ä¸ªèŠ‚ç‚¹å¯ä»¥æ‰˜ç®¡ 58 ä¸ª Podã€‚åªæœ‰æ‰©å®¹ç¬¬ 59 ä¸ªå‰¯æœ¬æ—¶ï¼Œæ‰éœ€è¦åˆ›å»ºæ–°çš„èŠ‚ç‚¹ã€‚&lt;/strong>&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2316562x.png" alt="CleanShot 2021-06-08 at 23.16.56@2x">&lt;/p>
&lt;p>è¿™æ ·è§¦å‘ CA çš„æœºä¼šæ›´å°‘ã€‚&lt;/p>
&lt;p>é€‰æ‹©å¤§è§„æ ¼çš„èŠ‚ç‚¹ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªå¥½å¤„ï¼šèµ„æºçš„åˆ©ç”¨ç‡ä¼šæ›´é«˜ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2317562x.png" alt="">&lt;/p>
&lt;p>&lt;strong>èŠ‚ç‚¹ä¸Šå¯ä»¥å®¹çº³çš„ Pod æ•°é‡ï¼Œå†³å®šäº†æ•ˆç‡çš„å³°å€¼ã€‚&lt;/strong>&lt;/p>
&lt;p>ç‰©æå¿…åï¼æ›´å¤§çš„å®ä¾‹ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼š&lt;/p>
&lt;ol>
&lt;li>çˆ†ç‚¸åŠå¾„ï¼ˆBlast radiusï¼‰ï¼šèŠ‚ç‚¹æ•…éšœæ—¶ï¼Œå°‘èŠ‚ç‚¹çš„é›†ç¾¤å’Œå¤šèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œå‰è€…å½±å“æ›´å¤§ã€‚&lt;/li>
&lt;li>è‡ªåŠ¨ç¼©æ”¾çš„æˆæœ¬æ•ˆç›Šä½ï¼šå¢åŠ ä¸€ä¸ªå¤§å®¹é‡çš„èŠ‚ç‚¹ï¼Œå…¶åˆ©ç”¨ç‡ä¼šæ¯”è¾ƒä½ï¼ˆè°ƒåº¦è¿‡å»çš„ Pod æ•°å°‘ï¼‰&lt;/li>
&lt;/ol>
&lt;p>&lt;em>å³ä½¿é€‰æ‹©äº†æ­£ç¡®è§„æ ¼çš„èŠ‚ç‚¹ï¼Œé…ç½®æ–°çš„è®¡ç®—å•å…ƒæ—¶ï¼Œå»¶è¿Ÿä»ç„¶å­˜åœ¨ã€‚æ€ä¹ˆè§£å†³ï¼Ÿ&lt;/em>&lt;/p>
&lt;p>&lt;em>èƒ½å¦æå‰åˆ›å»ºèŠ‚ç‚¹ï¼Ÿ&lt;/em>&lt;/p>
&lt;h2 id="ä¸ºé›†ç¾¤è¿‡åº¦é…ç½®èŠ‚ç‚¹">ä¸ºé›†ç¾¤è¿‡åº¦é…ç½®èŠ‚ç‚¹&lt;/h2>
&lt;p>å³ä¸ºé›†ç¾¤å¢åŠ å¤‡ç”¨èŠ‚ç‚¹ï¼Œå¯ä»¥ï¼š&lt;/p>
&lt;ol>
&lt;li>åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ç•™ç©º ï¼ˆæ¯”å¦‚ SchedulingDisabledï¼‰&lt;/li>
&lt;li>ä¸€æ—¦ç©ºèŠ‚ç‚¹ä¸­æœ‰äº†ä¸€ä¸ª Podï¼Œé©¬ä¸Šåˆ›å»ºæ–°çš„ç©ºèŠ‚ç‚¹&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2325582x.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2326262x.png" alt="CleanShot 2021-06-08 at 23.26.26@2x">&lt;/p>
&lt;p>&lt;strong>è¿™ç§ä¼šäº§ç”Ÿé¢å¤–çš„æˆæœ¬ï¼Œä½†æ˜¯æ•ˆç‡ä¼šæå‡ã€‚&lt;/strong>&lt;/p>
&lt;p>&lt;strong>CA å¹¶ä¸æ”¯æŒæ­¤åŠŸèƒ½ &amp;ndash; æ€»æ˜¯ä¿ç•™ä¸€ä¸ªç©ºèŠ‚ç‚¹ã€‚&lt;/strong>&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œå¯ä»¥ä¼ªé€ ã€‚åˆ›å»ºä¸€ä¸ªåªå ç”¨èµ„æºï¼Œä¸ä½¿ç”¨èµ„æºçš„ Pod å ç”¨æ•´ä¸ª Node èŠ‚ç‚¹ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2329322x.png" alt="">&lt;/p>
&lt;p>ä¸€æ—¦æœ‰äº†çœŸæ­£çš„ Podï¼Œé©±é€å ä½çš„ Podã€‚
&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2330332x.png" alt="">&lt;/p>
&lt;p>å¾…åå°å®Œæˆæ–°çš„èŠ‚ç‚¹é…ç½®åï¼Œå°†â€œå ä½â€ Pod å†æ¬¡å ç”¨æ•´ä¸ªèŠ‚ç‚¹ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2331062x.png" alt="">&lt;/p>
&lt;p>è¿™ä¸ªâ€œå ä½â€çš„ Pod å¯ä»¥é€šè¿‡æ°¸ä¹…ä¼‘çœ æ¥å®ç°ç©ºé—´çš„ä¿ç•™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">overprovisioning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">overprovisioning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">overprovisioning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pause&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">k8s.gcr.io/pause&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;1739m&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;5.9G&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨&lt;a href="https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/">ä¼˜å…ˆçº§å’ŒæŠ¢å &lt;/a>ï¼Œæ¥å®ç°åˆ›å»ºçœŸæ­£çš„ Pod åé©±é€â€œå ä½â€çš„ Podã€‚&lt;/p>
&lt;p>ä½¿ç”¨ &lt;code>PodPriorityClass&lt;/code> åœ¨é…ç½® Pod ä¼˜å…ˆçº§ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">scheduling.k8s.io/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PriorityClass&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">overprovisioning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="m">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#é»˜è®¤çš„æ˜¯ 0ï¼Œè¿™ä¸ªè¡¨ç¤ºæ¯”é»˜è®¤çš„ä½&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">globalDefault&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;Priority class used by overprovisioning.&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸ºâ€œå ä½â€ Pod é…ç½®ä¼˜å…ˆçº§ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">overprovisioning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">overprovisioning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">overprovisioning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">priorityClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">overprovisioning&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#HERE&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">reserve-resources&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">k8s.gcr.io/pause&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;1739m&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;5.9G&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>å·²ç»åšå®Œè¿‡åº¦é…ç½®ï¼Œåº”ç”¨ç¨‹åºæ˜¯å¦éœ€è¦ä¼˜åŒ–ï¼Ÿ&lt;/em>&lt;/p>
&lt;h2 id="ä¸º-pod-é€‰æ‹©æ­£ç¡®çš„å†…å­˜å’Œ-cpu-è¯·æ±‚">ä¸º Pod é€‰æ‹©æ­£ç¡®çš„å†…å­˜å’Œ CPU è¯·æ±‚&lt;/h2>
&lt;p>Kubernetes æ˜¯æ ¹æ® Pod çš„å†…å­˜å’Œ CPU è¯·æ±‚ï¼Œä¸ºå…¶åˆ†é…èŠ‚ç‚¹ã€‚&lt;/p>
&lt;p>å¦‚æœ Pod çš„èµ„æºè¯·æ±‚é…ç½®ä¸æ­£ç¡®ï¼Œå¯èƒ½ä¼šè¿‡æ™šï¼ˆæˆ–è¿‡æ—©ï¼‰è§¦å‘è‡ªåŠ¨ç¼©æ”¾å™¨ã€‚&lt;/p>
&lt;p>è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š&lt;/p>
&lt;ul>
&lt;li>åº”ç”¨ç¨‹åºå¹³å‡è´Ÿè½½ä¸‹æ¶ˆè€— 512MB å†…å­˜å’Œ 0.25 ä¸ª vCPUã€‚&lt;/li>
&lt;li>é«˜å³°æ—¶ï¼Œæ¶ˆè€— 4GB å†…å­˜ å’Œ 1 ä¸ª vCPUã€‚ï¼ˆå³èµ„æºé™åˆ¶ï¼ŒLimitï¼‰&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2338292x.png" alt="">&lt;/p>
&lt;p>æœ‰ä¸‰ç§è¯·æ±‚çš„é…ç½®é€‰æ‹©ï¼š&lt;/p>
&lt;ol>
&lt;li>è¿œä½äºå¹³å‡ä½¿ç”¨é‡&lt;/li>
&lt;li>åŒ¹é…å¹³å‡ä½¿ç”¨é‡&lt;/li>
&lt;li>å°½é‡æ¥è¿‘é™åˆ¶&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2344462x.png" alt="2">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2345002x.png" alt="2">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2346042x.png" alt="3">&lt;/p>
&lt;p>ç¬¬ä¸€ç§çš„é—®é¢˜åœ¨äº&lt;strong>è¶…å–ä¸¥é‡ï¼Œè¿‡åº¦ä½¿ç”¨èŠ‚ç‚¹&lt;/strong>ã€‚kubelet è´Ÿè½½é«˜ï¼Œç¨³å®šæ€§å·®ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2346452x.png" alt="1">&lt;/p>
&lt;p>ç¬¬ä¸‰ç§ï¼Œä¼šé€ æˆèµ„æºçš„åˆ©ç”¨ç‡ä½ï¼Œæµªè´¹èµ„æºã€‚è¿™ç§é€šå¸¸è¢«ç§°ä¸º &lt;a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/#qos-classes">QoSï¼šQuality of Service class&lt;/a> ä¸­çš„ &lt;code>Guaranteed&lt;/code> çº§åˆ«ï¼ŒPod ä¸ä¼šè¢«ç»ˆæ­¢å’Œé©±é€ã€‚
&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/06/09/cleanshot-20210608-at-2347382x.png" alt="3">&lt;/p>
&lt;p>&lt;em>å¦‚ä½•åœ¨ç¨³å®šæ€§å’Œèµ„æºä½¿ç”¨ç‡é—´åšæƒè¡¡ï¼Ÿ&lt;/em>&lt;/p>
&lt;p>è¿™å°±æ˜¯ &lt;a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/#qos-classes">QoSï¼šQuality of Service class&lt;/a> ä¸­çš„ &lt;code>Burstable&lt;/code> çº§åˆ«ï¼Œå³ Pod å¶å°”ä¼šä½¿ç”¨æ›´å¤šçš„å†…å­˜å’Œ CPUã€‚&lt;/p>
&lt;ol>
&lt;li>å¦‚æœèŠ‚ç‚¹ä¸­æœ‰å¯ç”¨èµ„æºï¼Œåº”ç”¨ç¨‹åºä¼šåœ¨è¿”å›åŸºçº¿ï¼ˆbaselineï¼‰å‰ä½¿ç”¨è¿™äº›èµ„æºã€‚&lt;/li>
&lt;li>å¦‚æœèµ„æºä¸è¶³ï¼ŒPod å°†ç«äº‰èµ„æºï¼ˆCPUï¼‰ï¼Œkubelet ä¹Ÿæœ‰å¯èƒ½å°è¯•é©±é€ Podï¼ˆå†…å­˜ï¼‰ã€‚&lt;/li>
&lt;/ol>
&lt;p>åœ¨ &lt;code>Guaranteed&lt;/code> å’Œ &lt;code>Burstable&lt;/code> ä¹‹å‰å¦‚ä½•åšé€‰æ‹©ï¼Ÿå–å†³äºï¼š&lt;/p>
&lt;ol>
&lt;li>æƒ³å°½é‡å‡å°‘ Pod çš„é‡æ–°è°ƒåº¦å’Œé©±é€ï¼Œåº”è¯¥æ˜¯ç”¨ &lt;code>Guaranteed&lt;/code>ã€‚&lt;/li>
&lt;li>å¦‚æœæƒ³å……åˆ†åˆ©ç”¨èµ„æºæ—¶ï¼Œä½¿ç”¨ &lt;code>Burstable&lt;/code>ã€‚æ¯”å¦‚å¼¹æ€§è¾ƒå¤§çš„æœåŠ¡ï¼ŒWeb æˆ–è€… REST æœåŠ¡ã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;em>å¦‚ä½•åšå‡ºæ­£ç¡®çš„é…ç½®ï¼Ÿ&lt;/em>&lt;/p>
&lt;p>åº”è¯¥åˆ†æåº”ç”¨ç¨‹åºï¼Œå¹¶æµ‹ç®—ç©ºé—²ã€è´Ÿè½½å’Œå³°å€¼æ—¶çš„å†…å­˜å’Œ CPU æ¶ˆè€—ã€‚&lt;/p>
&lt;p>ç”šè‡³å¯ä»¥é€šè¿‡éƒ¨ç½² VPA æ¥è‡ªåŠ¨è°ƒæ•´ã€‚&lt;/p>
&lt;h2 id="å¦‚ä½•è¿›è¡Œé›†ç¾¤ç¼©å®¹">å¦‚ä½•è¿›è¡Œé›†ç¾¤ç¼©å®¹ï¼Ÿ&lt;/h2>
&lt;p>&lt;strong>æ¯ 10 ç§’ï¼Œå½“è¯·æ±‚ï¼ˆrequestï¼‰åˆ©ç”¨ç‡ä½äº 50%æ—¶ï¼ŒCA æ‰ä¼šå†³å®šåˆ é™¤èŠ‚ç‚¹ã€‚&lt;/strong>&lt;/p>
&lt;p>CA ä¼šæ±‡æ€»åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Pod çš„ CPU å’Œå†…å­˜è¯·æ±‚ã€‚å°äºèŠ‚ç‚¹å®¹é‡çš„ä¸€åŠï¼Œå°±ä¼šè€ƒè™‘å¯¹å½“å‰èŠ‚ç‚¹è¿›è¡Œç¼©å‡ã€‚&lt;/p>
&lt;blockquote>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCA ä¸è€ƒè™‘å®é™…çš„ CPU å’Œå†…å­˜ä½¿ç”¨æˆ–è€…é™åˆ¶ï¼ˆlimitï¼‰ï¼Œåªçœ‹è¯·æ±‚ï¼ˆrequestï¼‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ç§»é™¤èŠ‚ç‚¹ä¹‹å‰ï¼ŒCA ä¼šï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-types-of-pods-can-prevent-ca-from-removing-a-node">æ£€æŸ¥ Pod&lt;/a> ç¡®ä¿å¯ä»¥è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚&lt;/li>
&lt;li>&lt;a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#i-have-a-couple-of-nodes-with-low-utilization-but-they-are-not-scaled-down-why">æ£€æŸ¥èŠ‚ç‚¹&lt;/a>ï¼Œé¿å…èŠ‚ç‚¹è¢«è¿‡æ—©çš„é”€æ¯ï¼Œæ¯”å¦‚ä¸¤ä¸ªèŠ‚ç‚¹çš„è¯·æ±‚éƒ½ä½äº 50%ã€‚&lt;/li>
&lt;/ol>
&lt;p>æ£€æŸ¥éƒ½é€šè¿‡ä¹‹åï¼Œæ‰ä¼šåˆ é™¤èŠ‚ç‚¹ã€‚&lt;/p>
&lt;h2 id="ä¸ºä»€ä¹ˆä¸æ ¹æ®å†…å­˜æˆ–-cpu-è¿›è¡Œè‡ªåŠ¨ç¼©æ”¾">ä¸ºä»€ä¹ˆä¸æ ¹æ®å†…å­˜æˆ– CPU è¿›è¡Œè‡ªåŠ¨ç¼©æ”¾ï¼Ÿ&lt;/h2>
&lt;p>&lt;strong>åŸºäºå†…å­˜å’Œ CPU çš„è‡ªåŠ¨ç¼©æ”¾å™¨ï¼Œä¸å…³å¿ƒ podã€‚&lt;/strong>&lt;/p>
&lt;p>æ¯”å¦‚é…ç½®ç¼©æ”¾å™¨åœ¨èŠ‚ç‚¹çš„ CPU è¾¾åˆ°æ€»é‡çš„ 80%ï¼Œå°±è‡ªåŠ¨å¢åŠ èŠ‚ç‚¹ã€‚&lt;/p>
&lt;p>å½“ä½ åˆ›å»º 3 ä¸ªå‰¯æœ¬çš„ Deploymentï¼Œ3 ä¸ªèŠ‚ç‚¹çš„ CPU è¾¾åˆ°äº† 85%ã€‚è¿™æ—¶ä¼šåˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½†ä½ å¹¶ä¸éœ€è¦ç¬¬ 4 ä¸ªå‰¯æœ¬ï¼Œæ–°çš„èŠ‚ç‚¹å°±ç©ºé—²äº†ã€‚&lt;/p>
&lt;p>&lt;strong>ä¸å»ºè®®ä½¿ç”¨è¿™ç§ç±»å‹çš„è‡ªåŠ¨ç¼©æ”¾å™¨ã€‚&lt;/strong>&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>å®šä¹‰å’Œå®æ–½æˆåŠŸçš„æ‰©å±•ç­–ç•¥ï¼Œéœ€è¦æŒæ¡ä»¥ä¸‹å‡ ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>èŠ‚ç‚¹çš„å¯åˆ†é…èµ„æºã€‚&lt;/li>
&lt;li>å¾®è°ƒ Metrics Serverã€HPA å’Œ CA çš„åˆ·æ–°é—´éš”ã€‚&lt;/li>
&lt;li>è®¾è®¡é›†ç¾¤å’ŒèŠ‚ç‚¹çš„è§„æ ¼ã€‚&lt;/li>
&lt;li>ç¼“å­˜å®¹å™¨é•œåƒåˆ°èŠ‚ç‚¹ã€‚&lt;/li>
&lt;li>åº”ç”¨ç¨‹åºçš„åŸºå‡†æµ‹è¯•å’Œåˆ†æã€‚&lt;/li>
&lt;/ul>
&lt;p>é…åˆé€‚å½“çš„ç›‘æ§å·¥å…·ï¼Œå¯ä»¥åå¤æµ‹è¯•æ‰©å±•ç­–ç•¥å¹¶è°ƒæ•´é›†ç¾¤çš„ç¼©æ”¾é€Ÿåº¦å’Œæˆæœ¬ã€‚&lt;/p></description></item><item><title>åˆæ¢å¯ç¼–ç¨‹ç½‘å…³ Pipy</title><link>https://atbug.com/glance-at-programmable-gateway-pipy/</link><pubDate>Mon, 31 May 2021 00:45:08 +0800</pubDate><guid>https://atbug.com/glance-at-programmable-gateway-pipy/</guid><description>
&lt;p>æœ‰å¹¸å‚åŠ äº† &lt;a href="https://flomesh.cn/">Flomesh&lt;/a> ç»„ç»‡çš„workshopï¼Œäº†è§£äº†ä»–ä»¬çš„ Pipy ç½‘ç»œä»£ç†ï¼Œä»¥åŠå›´ç»• Pipy æ„å»ºèµ·æ¥çš„ç”Ÿæ€ã€‚Pipy åœ¨ç”Ÿæ€ä¸­ï¼Œä¸æ­¢æ˜¯ä»£ç†çš„è§’è‰²ï¼Œè¿˜æ˜¯ Flomesh æœåŠ¡ç½‘æ ¼â€‹ä¸­çš„æ•°æ®å¹³é¢ã€‚&lt;/p>
&lt;p>æ•´ç†ä¸€ä¸‹ï¼Œåšä¸ªè®°å½•ï¼Œé¡ºä¾¿ç„ä¸€ä¸‹ Pipy çš„éƒ¨åˆ†æºç ã€‚&lt;/p>
&lt;h2 id="ä»‹ç»">ä»‹ç»&lt;/h2>
&lt;p>ä¸‹é¢æ˜¯æ‘˜è‡ª Github ä¸Šå…³äº Pipy çš„ä»‹ç»ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Pipy æ˜¯ä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½ã€é«˜ç¨³å®šã€å¯ç¼–ç¨‹çš„ç½‘ç»œä»£ç†ã€‚Pipy æ ¸å¿ƒæ¡†æ¶ä½¿ç”¨ C++ å¼€å‘ï¼Œç½‘ç»œ IO é‡‡ç”¨ ASIO åº“ã€‚ Pipy çš„å¯æ‰§è¡Œæ–‡ä»¶ä»…æœ‰ 5M å·¦å³ï¼Œè¿è¡ŒæœŸçš„å†…å­˜å ç”¨ 10M å·¦å³ï¼Œå› æ­¤ Pipy éå¸¸é€‚åˆåš Sidecar proxyã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>Pipy å†…ç½®äº†è‡ªç ”çš„ pjs ä½œä¸ºè„šæœ¬æ‰©å±•ï¼Œä½¿å¾—Pipy å¯ä»¥ç”¨ JS è„šæœ¬æ ¹æ®ç‰¹å®šéœ€æ±‚å¿«é€Ÿå®šåˆ¶é€»è¾‘ä¸åŠŸèƒ½ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>Pipy é‡‡ç”¨äº†æ¨¡å—åŒ–ã€é“¾å¼çš„å¤„ç†æ¶æ„ï¼Œç”¨é¡ºåºæ‰§è¡Œçš„æ¨¡å—æ¥å¯¹ç½‘ç»œæ•°æ®å—è¿›è¡Œå¤„ç†ã€‚è¿™ç§ç®€å•çš„æ¶æ„ä½¿å¾— Pipy åº•å±‚ç®€å•å¯é ï¼ŒåŒæ—¶å…·å¤‡äº†åŠ¨æ€ç¼–æ’æµé‡çš„èƒ½åŠ›ï¼Œå…¼é¡¾äº†ç®€å•å’Œçµæ´»ã€‚é€šè¿‡ä½¿ç”¨ REUSE_PORT çš„æœºåˆ¶ï¼ˆä¸»æµ Linux å’Œ BSD ç‰ˆæœ¬éƒ½æ”¯æŒè¯¥åŠŸèƒ½ï¼‰ï¼ŒPipy å¯ä»¥ä»¥å¤šè¿›ç¨‹æ¨¡å¼è¿è¡Œï¼Œä½¿å¾— Pipy ä¸ä»…é€‚ç”¨äº Sidecar æ¨¡å¼ï¼Œä¹Ÿé€‚ç”¨äºå¤§è§„æ¨¡çš„æµé‡å¤„ç†åœºæ™¯ã€‚ åœ¨å®è·µä¸­ï¼ŒPipy ç‹¬ç«‹éƒ¨ç½²çš„æ—¶å€™ç”¨ä½œâ€œè½¯è´Ÿè½½â€ï¼Œå¯ä»¥åœ¨ä½å»¶è¿Ÿçš„æƒ…å†µä¸‹ï¼Œå®ç°åª²ç¾ç¡¬ä»¶çš„è´Ÿè½½å‡è¡¡ååèƒ½åŠ›ï¼ŒåŒæ—¶å…·æœ‰çµæ´»çš„æ‰©å±•æ€§ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16221838193789.jpg" alt="">&lt;/p>
&lt;p>Pipy çš„æ ¸å¿ƒæ˜¯æ¶ˆæ¯æµå¤„ç†å™¨ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16221838399668.jpg" alt="">&lt;/p>
&lt;p>Pipy æµé‡å¤„ç†çš„æµç¨‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16221838630400.jpg" alt="">&lt;/p>
&lt;h3 id="æ ¸å¿ƒæ¦‚å¿µ">æ ¸å¿ƒæ¦‚å¿µ&lt;/h3>
&lt;ul>
&lt;li>æµï¼ˆStreamï¼‰&lt;/li>
&lt;li>ç®¡é“ï¼ˆPipelineï¼‰&lt;/li>
&lt;li>æ¨¡å—ï¼ˆModuleï¼‰&lt;/li>
&lt;li>ä¼šè¯ï¼ˆSessionï¼‰&lt;/li>
&lt;li>ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰&lt;/li>
&lt;/ul>
&lt;p>&lt;!-- raw HTML omitted -->ä»¥ä¸‹æ˜¯ä¸ªäººæµ…è§&lt;!-- raw HTML omitted -->ï¼š&lt;/p>
&lt;p>Pipy ä½¿ç”¨ &lt;code>pjs&lt;/code> å¼•æ“å°† JavaScriptæ ¼å¼çš„é…ç½®ï¼Œè§£ææˆå…¶æŠ½è±¡çš„ &lt;code>Configuration&lt;/code> å¯¹è±¡ã€‚æ¯ä¸ª &lt;code>Configuration&lt;/code> ä¸­åŒ…å«äº†å¤šä¸ª &lt;code>Pipeline&lt;/code>ï¼Œæ¯ä¸ª &lt;code>Configuration&lt;/code> ä¸­åˆä¼šç”¨åˆ°å¤šä¸ª &lt;code>Filter&lt;/code>ã€‚è¿™äº›éƒ½å±äº Pipy çš„&lt;em>é™æ€&lt;/em>é…ç½®éƒ¨åˆ†ã€‚ï¼ˆåé¢ä¼šæåˆ° Pipeline çš„ä¸‰ç§ä¸åŒç±»å‹ï¼‰&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16223905428188.jpg" alt="">&lt;/p>
&lt;p>è€Œå±äº&lt;strong>è¿è¡Œæ—¶&lt;/strong>çš„å°±æ˜¯æµã€ä¼šè¯å’Œä¸Šä¸‹æ–‡äº†ï¼Œåœ¨ Pipy ä¸­ï¼Œæ•°æ®æµæ˜¯ç”±å¯¹è±¡ï¼ˆPipy çš„&lt;em>æŠ½è±¡&lt;/em>ï¼‰ç»„æˆçš„ã€‚è€Œè¿™äº›å¯¹è±¡æŠµè¾¾ Pipyï¼Œè¢«æŠ½è±¡æˆä¸åŒçš„&lt;!-- raw HTML omitted -->äº‹ä»¶&lt;!-- raw HTML omitted -->ã€‚è€Œäº‹ä»¶è§¦å‘ä¸åŒçš„è¿‡æ»¤å™¨çš„æ‰§è¡Œã€‚&lt;/p>
&lt;p>æˆ‘ä¸ªäººæ›´å–œæ¬¢å°†å…¶æ ¸å¿ƒç†è§£ä¸ºï¼šå¯¹æ•°æ®æµçš„äº‹ä»¶å¤„ç†å¼•æ“ã€‚&lt;/p>
&lt;p>ç†è§£å½’ç†è§£ï¼Œå®è·µå‡ºçœŸçŸ¥ã€‚â€œå¤§èƒ†å‡è®¾ï¼Œå°å¿ƒæ±‚è¯ï¼â€&lt;/p>
&lt;h2 id="æœ¬åœ°ç¼–è¯‘">æœ¬åœ°ç¼–è¯‘&lt;/h2>
&lt;p>ä»ç¼–è¯‘ Pipy å¼€å§‹ã€‚&lt;/p>
&lt;h3 id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#å®‰è£… nodejs&lt;/span>
$ nvm install lts/erbium
&lt;span class="c1">#å®‰è£… cmake&lt;/span>
$ brew install cmake
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ç¼–è¯‘-pipy">ç¼–è¯‘ Pipy&lt;/h3>
&lt;p>ä» &lt;code>https://github.com/flomesh-io/pipy.git&lt;/code> å…‹éš†ä»£ç ã€‚&lt;/p>
&lt;p>Pipy çš„ç¼–è¯‘åŒ…æ‹¬äº†ä¸¤ä¸ªéƒ¨åˆ†ï¼ŒGUI å’Œ Pipy æœ¬ä½“ã€‚&lt;/p>
&lt;p>GUI æ˜¯ Pipy æä¾›çš„ä¸€ä¸ªç”¨äºå¼€å‘æ¨¡å¼ä¸‹è¿›è¡Œé…ç½®çš„ç•Œé¢ï¼Œé¦–å…ˆç¼–è¯‘Pipy GUIã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># pipy root folder&lt;/span>
$ &lt;span class="nb">cd&lt;/span> gui
$ npm install
$ npm run build
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ç€ç¼–è¯‘ Pipy çš„æœ¬ä½“&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># pipy root folder&lt;/span>
$ mkdir build
$ &lt;span class="nb">cd&lt;/span> build
$ cmake -DCMAKE_BUILD_TYPE&lt;span class="o">=&lt;/span>Release -DPIPY_GUI&lt;span class="o">=&lt;/span>ON ..
$ make
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®Œæˆåæ£€æŸ¥æ ¹ç›®å½•ä¸‹çš„ &lt;code>bin&lt;/code> ç›®å½•ï¼Œå¯ä»¥çœ‹åˆ° pipy çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¤§å°åªæœ‰ 11Mã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16223857141237.jpg" alt="">&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ bin/pipy --help
Usage: pipy &lt;span class="o">[&lt;/span>options&lt;span class="o">]&lt;/span> &amp;lt;script filename&amp;gt;
Options:
-h, -help, --help Show &lt;span class="nb">help&lt;/span> information
-v, -version, --version Show version information
--list-filters List all filters
--help-filters Show detailed usage information &lt;span class="k">for&lt;/span> all filters
--log-level&lt;span class="o">=&lt;/span>&amp;lt;debug&lt;span class="p">|&lt;/span>info&lt;span class="p">|&lt;/span>warn&lt;span class="p">|&lt;/span>error&amp;gt; Set the level of log output
--verify Verify configuration only
--reuse-port Enable kernel load balancing &lt;span class="k">for&lt;/span> all listening ports
--gui-port&lt;span class="o">=&lt;/span>&amp;lt;port&amp;gt; Enable web GUI on the specified port
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="demohello-pipy">Demoï¼šHello Pipy&lt;/h3>
&lt;p>å¼€å‘æ¨¡å¼ä¸‹å¯ä»¥è®© Pipy æºå¸¦ GUI å¯åŠ¨ï¼Œé€šè¿‡ GUI è¿›è¡Œé…ç½®ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#æŒ‡å®š gui çš„ç«¯å£ä¸º 6060ï¼Œä» test ç›®å½•ä¸­åŠ è½½é…ç½®&lt;/span>
$ bin/pipy --gui-port&lt;span class="o">=&lt;/span>&lt;span class="m">6060&lt;/span> test/
2021-05-30 22:48:41 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>gui&lt;span class="o">]&lt;/span> Starting GUI service...
2021-05-30 22:48:41 &lt;span class="o">[&lt;/span>info&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>listener&lt;span class="o">]&lt;/span> Listening on 0.0.0.0:6060
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æµè§ˆå™¨ä¸­æ‰“å¼€
&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16223862683344.jpg" alt="">&lt;/p>
&lt;p>é…ç½®ç•Œé¢
&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16223865498871.jpg" alt="">&lt;/p>
&lt;p>å±•å¼€ &lt;code>002-hello&lt;/code> å­ç›®å½•ç‚¹é€‰ &lt;code>pipy&lt;/code> å¹¶ç‚¹å‡»è¿è¡ŒæŒ‰é’®ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16223866403409.jpg" alt="">&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ curl -i localhost:6080
HTTP/1.1 &lt;span class="m">200&lt;/span> OK
Connection: keep-alive
Content-Length: &lt;span class="m">7&lt;/span>
Hello!
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="pipy-è¿‡æ»¤å™¨">Pipy è¿‡æ»¤å™¨&lt;/h3>
&lt;p>é€šè¿‡ pipe çš„å‘½ä»¤å¯ä»¥è¾“å‡ºå…¶æ”¯æŒçš„è¿‡æ»¤å™¨åˆ—è¡¨ï¼Œä¸€å…± 31 ä¸ªã€‚é€šè¿‡å°†ä¸€ç³»åˆ—è¿‡æ»¤å™¨è¿›è¡Œç»„è£…ï¼Œå¯ä»¥å®ç°å¤æ‚çš„æµå¤„ç†ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ &lt;code>007-logging&lt;/code> çš„é…ç½®å®ç°äº†æ—¥å¿—çš„åŠŸèƒ½ï¼šè®°å½•è¯·æ±‚å’Œå“åº”çš„æ•°æ®ï¼Œå¹¶æ‰¹é‡å‘é€åˆ° ElasticSearchã€‚è¿™é‡Œå°±ç”¨åˆ°äº† &lt;code>fork&lt;/code>ã€&lt;code>connect&lt;/code>ã€&lt;code>onSessionStart&lt;/code>ã€&lt;code>encodeHttpRequest&lt;/code>ã€&lt;code>decodeHttpRequest&lt;/code>ã€&lt;code>onMessageStart&lt;/code>ã€&lt;code>onMessage&lt;/code>ã€&lt;code>decodeHttpResponse&lt;/code>ã€&lt;code>replaceMessage&lt;/code>ã€&lt;code>link&lt;/code>ã€&lt;code>mux&lt;/code>ã€&lt;code>task&lt;/code> ç­‰åå¤šç§è¿‡æ»¤å™¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16223878872474.jpg" alt="">&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ bin/pipy --list-filters
connect &lt;span class="o">(&lt;/span>target&lt;span class="o">[&lt;/span>, options&lt;span class="o">])&lt;/span> Sends data to a remote endpoint and receives data from it
demux &lt;span class="o">(&lt;/span>target&lt;span class="o">)&lt;/span> Sends messages to a different pipline with each one in its own session and context
decodeDubbo &lt;span class="o">()&lt;/span> Deframes a Dubbo message
decodeHttpRequest &lt;span class="o">()&lt;/span> Deframes an HTTP request message
decodeHttpResponse &lt;span class="o">()&lt;/span> Deframes an HTTP response message
dummy &lt;span class="o">()&lt;/span> Eats up all events
dump &lt;span class="o">([&lt;/span>tag&lt;span class="o">])&lt;/span> Outputs events to the standard output
encodeDubbo &lt;span class="o">([&lt;/span>head&lt;span class="o">])&lt;/span> Frames a Dubbo message
encodeHttpRequest &lt;span class="o">([&lt;/span>head&lt;span class="o">])&lt;/span> Frames an HTTP request message
encodeHttpResponse &lt;span class="o">([&lt;/span>head&lt;span class="o">])&lt;/span> Frames an HTTP response message
&lt;span class="nb">exec&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="nb">command&lt;/span>&lt;span class="o">)&lt;/span> Spawns a child process and connects to its input/output
fork &lt;span class="o">(&lt;/span>target&lt;span class="o">[&lt;/span>, sessionData&lt;span class="o">])&lt;/span> Sends copies of events to other pipeline sessions
link &lt;span class="o">(&lt;/span>target&lt;span class="o">[&lt;/span>, when&lt;span class="o">[&lt;/span>, target2&lt;span class="o">[&lt;/span>, when2, ...&lt;span class="o">]]])&lt;/span> Sends events to a different pipeline
mux &lt;span class="o">(&lt;/span>target&lt;span class="o">[&lt;/span>, selector&lt;span class="o">])&lt;/span> Sends messages from different sessions to a shared pipeline session
onSessionStart &lt;span class="o">(&lt;/span>callback&lt;span class="o">)&lt;/span> Handles the initial event in a session
onData &lt;span class="o">(&lt;/span>callback&lt;span class="o">)&lt;/span> Handles a Data event
onMessageStart &lt;span class="o">(&lt;/span>callback&lt;span class="o">)&lt;/span> Handles a MessageStart event
onMessageEnd &lt;span class="o">(&lt;/span>callback&lt;span class="o">)&lt;/span> Handles a MessageEnd event
onSessionEnd &lt;span class="o">(&lt;/span>callback&lt;span class="o">)&lt;/span> Handles a SessionEnd event
onMessageBody &lt;span class="o">(&lt;/span>callback&lt;span class="o">)&lt;/span> Handles a &lt;span class="nb">complete&lt;/span> message body
onMessage &lt;span class="o">(&lt;/span>callback&lt;span class="o">)&lt;/span> Handles a &lt;span class="nb">complete&lt;/span> message including the head and the body
print &lt;span class="o">()&lt;/span> Outputs raw data to the standard output
replaceSessionStart &lt;span class="o">(&lt;/span>callback&lt;span class="o">)&lt;/span> Replaces the initial event in a session
replaceData &lt;span class="o">([&lt;/span>replacement&lt;span class="o">])&lt;/span> Replaces a Data event
replaceMessageStart &lt;span class="o">([&lt;/span>replacement&lt;span class="o">])&lt;/span> Replaces a MessageStart event
replaceMessageEnd &lt;span class="o">([&lt;/span>replacement&lt;span class="o">])&lt;/span> Replaces a MessageEnd event
replaceSessionEnd &lt;span class="o">([&lt;/span>replacement&lt;span class="o">])&lt;/span> Replaces a SessionEnd event
replaceMessageBody &lt;span class="o">([&lt;/span>replacement&lt;span class="o">])&lt;/span> Replaces an entire message body
replaceMessage &lt;span class="o">([&lt;/span>replacement&lt;span class="o">])&lt;/span> Replaces a &lt;span class="nb">complete&lt;/span> message including the head and the body
tap &lt;span class="o">(&lt;/span>quota&lt;span class="o">[&lt;/span>, account&lt;span class="o">])&lt;/span> Throttles message rate or data rate
use &lt;span class="o">(&lt;/span>module, pipeline&lt;span class="o">[&lt;/span>, argv...&lt;span class="o">])&lt;/span> Sends events to a pipeline in a different module
&lt;span class="nb">wait&lt;/span> &lt;span class="o">(&lt;/span>condition&lt;span class="o">)&lt;/span> Buffers up events &lt;span class="k">until&lt;/span> a condition is fulfilled
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åŸç†">åŸç†&lt;/h3>
&lt;p>â€œTalk is cheap, show me the code.â€&lt;/p>
&lt;h4 id="é…ç½®åŠ è½½">é…ç½®åŠ è½½&lt;/h4>
&lt;p>ä¸ªäººæ¯”è¾ƒå–œæ¬¢çœ‹æºç æ¥ç†è§£å®ç°ï¼Œå³ä½¿æ˜¯ C++ã€‚ä»æµè§ˆå™¨è¯·æ±‚å…¥æ‰‹å‘ç°è¿è¡Œæ—¶å‘&lt;code>/api/program&lt;/code> å‘é€äº† &lt;code>POST&lt;/code> è¯·æ±‚ï¼Œè¯·æ±‚çš„å†…å®¹æ˜¯é…ç½®æ–‡ä»¶çš„åœ°å€ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16223870171916.jpg" alt="">&lt;/p>
&lt;p>æ£€æŸ¥æºç åï¼Œæ‰¾åˆ°é€»è¾‘çš„å®ç°åœ¨ &lt;code>src/gui.cpp:189&lt;/code>ï¼š&lt;/p>
&lt;ol>
&lt;li>åˆ›å»ºæ–°çš„ worker&lt;/li>
&lt;li>åŠ è½½é…ç½®ï¼Œå°† JavaScrip ä»£ç è§£ææˆ &lt;code>Configuration&lt;/code> å¯¹è±¡&lt;/li>
&lt;li>å¯åŠ¨ workerï¼Œæ‰§è¡Œ&lt;code>Configuration::apply()&lt;/code>&lt;/li>
&lt;li>å¸è½½æ—§çš„ worker&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16224186469477.jpg" alt="">&lt;/p>
&lt;p>ä» &lt;code>src/api/configuration.cpp:267&lt;/code> å¤„çœ‹ï¼š&lt;code>pipeline&lt;/code>ã€&lt;code>listen&lt;/code> å’Œ &lt;code>task&lt;/code> é…ç½®å®é™…åœ¨ Pipy çš„é…ç½®ä¸­éƒ½æ˜¯è¢«æŠ½è±¡ä¸º &lt;code>Pipeline&lt;/code> å¯¹è±¡ï¼Œåªæ˜¯åœ¨ç±»å‹ä¸Šæœ‰å·®å¼‚åˆ†åˆ«ä¸ºï¼š&lt;code>NAMED&lt;/code>ã€&lt;code>LISTEN&lt;/code> å’Œ &lt;code>TASK&lt;/code>ã€‚æ¯”å¦‚ &lt;code>listen&lt;/code> ä¸­å¯ä»¥é€šè¿‡ &lt;code>fork&lt;/code> è¿‡æ»¤å™¨å°†äº‹ä»¶çš„å‰¯æœ¬å‘é€åˆ°æŒ‡å®šçš„ &lt;code>pipeline&lt;/code> ä¸­ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16223897550113.jpg" alt="">&lt;/p>
&lt;h4 id="åŸºäºæ•°æ®æµäº‹ä»¶çš„å¤„ç†">åŸºäºæ•°æ®æµäº‹ä»¶çš„å¤„ç†&lt;/h4>
&lt;p>&lt;code>src/inbound.cpp:171&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/31/16223918853729.jpg" alt="">&lt;/p>
&lt;h2 id="ç»“è¯­">ç»“è¯­&lt;/h2>
&lt;p>Pipy è™½å°ï¼ˆåªæœ‰ 11Mï¼‰ï¼Œä½†ä»¥å…¶å¯ç¼–ç¨‹çš„ç‰¹æ€§æä¾›äº†çµæ´»çš„é…ç½®èƒ½åŠ›ï¼Œæ½œåŠ›æ— é™ã€‚&lt;/p>
&lt;p>Pipy åƒå¤„ç† HTTP ä¸€æ ·å¤„ç†ä»»æ„çš„ä¸ƒå±‚åè®®ã€‚å†…éƒ¨ç‰ˆæœ¬æ”¯æŒDubboã€Redisã€Socks ç­‰ï¼Œç›®å‰æ­£åœ¨è¿ç§»åˆ°å¼€æºç‰ˆæœ¬ã€‚&lt;/p>
&lt;p>æœŸå¾…å³å°†å¼€æºçš„ Portalï¼Œä»¥åŠæœåŠ¡ç½‘æ ¼ Flomeshã€‚æŒç»­å…³æ³¨ï¼Œåé¢è€ƒè™‘å†å†™å‡ ç¯‡ã€‚&lt;/p>
&lt;p>â€œæœªæ¥å¯æœŸï¼â€&lt;/p></description></item><item><title>ä½¿ç”¨ Quarkus å’Œ MicroProfile å®ç°å¾®æœåŠ¡ç‰¹æ€§</title><link>https://atbug.com/microservicilities-quarkus/</link><pubDate>Wed, 26 May 2021 07:37:04 +0800</pubDate><guid>https://atbug.com/microservicilities-quarkus/</guid><description>
&lt;p>Quarkus çš„æ–‡ç« ä¹‹å‰å†™è¿‡ä¸‰ç¯‡äº†ï¼Œè®²è¿‡äº† Quarkus çš„å°è€Œå¿«ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/YcEqFm3oxlsEvJ3ckRbQyA">Hello, Quarkus&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/Dq3hQrXE4XWH-MyjBAGMEw">åº”&amp;quot;äº‘&amp;quot;è€Œç”Ÿçš„ Java æ¡†æ¶ Quarkusï¼šæ„å»ºæœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/1eqjYC36O3qm1XDw84aAPA">è°è¯´ Java ä¸èƒ½ç”¨æ¥è·‘ Serverlessï¼Ÿ&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ä¸€ç›´åœ¨é…é…¿å†™ä¸€ç¯‡ Quarkus ç”Ÿæ€ç›¸å…³çš„ï¼Œå› ä¸ºæœ€è¿‘ä¸€ç›´åœ¨å¿™ Meetup çš„äº‹æƒ…è€Œææµ…ã€‚æ­£å¥½çœ‹åˆ°äº†è¿™ç¯‡æ–‡ç« ï¼Œå°±æ‹¿æ¥ç¿»è¯‘ä¸€ä¸‹ï¼Œè¡¥å…¨äº‘åŸç”Ÿä¸­çš„â€œå¾®æœåŠ¡â€è¿™ä¸€å—ã€‚&lt;/p>
&lt;p>æœ¬æ–‡è¯‘è‡ª&lt;a href="https://www.infoq.com/articles/microservicilities-quarkus">ã€ŠImplementing Microservicilities with Quarkus and MicroProfileã€‹&lt;/a> ã€‚&lt;/p>
&lt;hr>
&lt;h2 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¾®æœåŠ¡ç‰¹æ€§">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¾®æœåŠ¡ç‰¹æ€§ï¼Ÿ&lt;/h2>
&lt;p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºæ˜¯ç”±å‡ ä¸ªç›¸äº’è¿æ¥çš„æœåŠ¡ç»„æˆçš„ï¼Œè¿™äº›æœåŠ¡ä¸€èµ·å·¥ä½œæ¥å®ç°æ‰€éœ€çš„ä¸šåŠ¡åŠŸèƒ½ã€‚&lt;/p>
&lt;p>å› æ­¤ï¼Œå…¸å‹çš„ä¼ä¸šå¾®æœåŠ¡æ¶æ„å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/26/16219855266680.jpg" alt="">&lt;/p>
&lt;p>åˆšå¼€å§‹ï¼Œä½¿ç”¨å¾®æœåŠ¡æ¶æ„å®ç°åº”ç”¨ç¨‹åºçœ‹èµ·æ¥å¾ˆå®¹æ˜“ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œå› ä¸ºæœ‰äº†å•ä½“æ¶æ„æ²¡æœ‰ä¸€äº›æ–°çš„æŒ‘æˆ˜ï¼Œå› æ­¤åšèµ·æ¥å¹¶ä¸å®¹å™¨&lt;/p>
&lt;p>ä¸¾å‡ ä¸ªä¾‹å­ï¼Œæ¯”å¦‚å®¹é”™ã€æœåŠ¡å‘ç°ã€æ‰©å±•æ€§ã€æ—¥å¿—è®°å½•å’Œè·Ÿè¸ªã€‚&lt;/p>
&lt;p>ä¸ºäº†è§£å†³è¿™äº›æŒ‘æˆ˜ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½åº”å®ç°æˆ‘ä»¬åœ¨ Red Hat æ‰€è¯´çš„â€œå¾®æœåŠ¡ç‰¹æ€§â€ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;input disabled="" type="checkbox"> è¯¥æœ¯è¯­æ˜¯æŒ‡é™¤ä¸šåŠ¡é€»è¾‘ä»¥å¤–ï¼ŒæœåŠ¡è¿˜å¿…é¡»å®ç°æ¥è§£å†³çš„è·¨é¢†åŸŸå…³æ³¨ç‚¹æ¸…å•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/26/16219855419604.jpg" alt="">&lt;/p>
&lt;p>å¯ä»¥ç”¨ä»»ä½•è¯­è¨€ï¼ˆJavaã€Goã€JavaScriptï¼‰æˆ–ä»»ä½•æ¡†æ¶ï¼ˆSpring Bootã€Quarkusï¼‰å®ç°ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯å›´ç»•ä¸šåŠ¡é€»è¾‘ï¼Œåº”å®ç°ä»¥ä¸‹å…³æ³¨ç‚¹ï¼š&lt;/p>
&lt;p>&lt;strong>API&lt;/strong>ï¼šå¯é€šè¿‡ä¸€ç»„å®šä¹‰çš„ API æ“ä½œæ¥è®¿é—®è¯¥æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œå¯¹äº RESTful Web APIï¼ŒHTTP ç”¨ä½œåè®®ã€‚æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨è¯¸å¦‚ Swagger ä¹‹ç±»çš„å·¥å…·æ¥è®°å½• API ã€‚
&lt;strong>æœåŠ¡å‘ç°ï¼ˆDiscoveryï¼‰&lt;/strong>ï¼šæœåŠ¡éœ€è¦å‘ç°å…¶ä»–æœåŠ¡ã€‚&lt;/p>
&lt;p>&lt;strong>è°ƒç”¨æœåŠ¡ï¼ˆInvocationï¼‰&lt;/strong>ï¼šå‘ç°æœåŠ¡åï¼Œéœ€è¦ä½¿ç”¨ä¸€ç»„å‚æ•°å¯¹å…¶è¿›è¡Œè°ƒç”¨ï¼Œå¹¶é€‰æ‹©æ€§åœ°è¿”å›å“åº”ã€‚&lt;/p>
&lt;p>&lt;strong>å¼¹æ€§ï¼ˆElasticityï¼‰&lt;/strong>ï¼šå¾®æœåŠ¡æ¶æ„çš„é‡è¦ç‰¹å¾ä¹‹ä¸€æ˜¯æ¯ä¸ªæœåŠ¡éƒ½æ˜¯å¼¹æ€§çš„ï¼Œè¿™æ„å‘³ç€å¯ä»¥æ ¹æ®ç³»ç»Ÿçš„å…³é”®ç¨‹åº¦æˆ–å½“å‰çš„å·¥ä½œé‡ç­‰å‚æ•°ç‹¬ç«‹åœ°è¿›è¡Œç¼©æ”¾ã€‚ï¼ˆè¯‘è€…æ³¨ï¼šè¿™é‡Œçš„å¼¹æ€§åªæ˜¯èµ„æºçš„å¼¹æ€§ï¼‰&lt;/p>
&lt;p>&lt;strong>å¼¹æ€§ï¼ˆResiliencyï¼‰&lt;/strong>ï¼šåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæˆ‘ä»¬åœ¨å¼€å‘æ—¶åº”ç‰¢è®°å¤±è´¥ï¼Œå°¤å…¶æ˜¯åœ¨ä¸å…¶ä»–æœåŠ¡è¿›è¡Œé€šä¿¡æ—¶ã€‚åœ¨å•ä½“åº”ç”¨ä¸­ï¼Œæ•´ä¸ªåº”ç”¨ç¨‹åºå¤„äºå¯åŠ¨æˆ–å…³é—­çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå½“æ­¤åº”ç”¨ç¨‹åºåˆ†è§£ä¸ºå¾®æœåŠ¡ä½“ç³»ç»“æ„æ—¶ï¼Œè¯¥åº”ç”¨ç¨‹åºç”±å¤šä¸ªæœåŠ¡ç»„æˆï¼Œå¹¶ä¸”æ‰€æœ‰è¿™äº›æœåŠ¡éƒ½é€šè¿‡ç½‘ç»œäº’è¿ï¼Œè¿™æ„å‘³ç€è¯¥åº”ç”¨ç¨‹åºçš„æŸäº›éƒ¨åˆ†å¯èƒ½æ­£åœ¨è¿è¡Œï¼Œè€Œå…¶ä»–éƒ¨åˆ†å¯èƒ½ä¼šå¤±è´¥ã€‚éåˆ¶æ•…éšœå¯¹é¿å…é€šè¿‡å…¶ä»–æœåŠ¡ä¼ æ’­é”™è¯¯å¾ˆé‡è¦ã€‚å¼¹æ€§ï¼ˆæˆ–åº”ç”¨ç¨‹åºå¼¹æ€§ï¼‰æ˜¯åº”ç”¨ç¨‹åº/æœåŠ¡å¯¹é—®é¢˜åšå‡ºååº”å¹¶ä»ç„¶æä¾›æœ€ä½³ç»“æœçš„èƒ½åŠ›ã€‚ï¼ˆè¯‘è€…æ³¨ï¼šè¿™é‡Œçš„å¼¹æ€§ä¸å®¹é”™ç›¸å…³ï¼Œå¯¹å¤±è´¥å¤„ç†çš„å¼¹æ€§ï¼‰&lt;/p>
&lt;p>&lt;strong>ç®¡é“ï¼ˆPipelineï¼‰&lt;/strong>ï¼šæœåŠ¡åº”ç‹¬ç«‹éƒ¨ç½²ï¼Œè€Œæ— éœ€è¿›è¡Œä»»ä½•å½¢å¼çš„ç¼–æ’ã€‚å› æ­¤ï¼Œæ¯ä¸ªæœåŠ¡åº”å…·æœ‰è‡ªå·±çš„éƒ¨ç½²ç®¡é“ã€‚&lt;/p>
&lt;p>&lt;strong>èº«ä»½éªŒè¯ï¼ˆAuthenticationï¼‰&lt;/strong>ï¼šå…³äºå¾®æœåŠ¡ä½“ç³»ç»“æ„ä¸­çš„å®‰å…¨æ€§çš„å…³é”®æ–¹é¢ä¹‹ä¸€æ˜¯å¦‚ä½•å¯¹å†…éƒ¨æœåŠ¡ä¹‹é—´çš„è°ƒç”¨è¿›è¡Œèº«ä»½éªŒè¯/æˆæƒã€‚Web ä»¤ç‰Œï¼ˆé€šå¸¸æ˜¯ä»¤ç‰Œï¼‰æ˜¯åœ¨å†…éƒ¨æœåŠ¡ä¸­å®‰å…¨åœ°è¡¨ç¤ºå£°æ˜çš„é¦–é€‰æ–¹å¼ã€‚&lt;/p>
&lt;p>&lt;strong>æ—¥å¿—è®°å½•ï¼ˆLoggingï¼‰&lt;/strong>ï¼šåœ¨å•ä½“åº”ç”¨ç¨‹åºä¸­ï¼Œæ—¥å¿—è®°å½•å¾ˆç®€å•ï¼Œå› ä¸ºè¯¥åº”ç”¨ç¨‹åºçš„æ‰€æœ‰ç»„ä»¶éƒ½åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ç„¶åç°åœ¨ç»„ä»¶ä»¥æœåŠ¡çš„å½¢å¼åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œå› æ­¤ï¼Œè¦æ‹¥æœ‰å®Œæ•´çš„æ—¥å¿—è®°å½•è§†å›¾ï¼Œéœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„æ—¥å¿—è®°å½•ç³»ç»Ÿ/æ•°æ®æ”¶é›†å™¨ã€‚&lt;/p>
&lt;p>&lt;strong>ç›‘æ§ï¼ˆMonitoringï¼‰&lt;/strong>ï¼šè¡¡é‡ç³»ç»Ÿçš„æ€§èƒ½ã€äº†è§£åº”ç”¨ç¨‹åºçš„æ•´ä½“è¿è¡ŒçŠ¶å†µï¼Œä»¥åŠåœ¨å‡ºç°é—®é¢˜æ—¶å‘å‡ºè­¦æŠ¥æ˜¯ä¿æŒåŸºäºå¾®æœåŠ¡çš„åº”ç”¨ç¨‹åºæ­£ç¡®è¿è¡Œçš„å…³é”®æ–¹é¢ã€‚ç›‘æ§æ˜¯æ§åˆ¶åº”ç”¨ç¨‹åºçš„å…³é”®æ–¹é¢ã€‚&lt;/p>
&lt;p>&lt;strong>è·Ÿè¸ªï¼ˆTracingï¼‰&lt;/strong>ï¼šè·Ÿè¸ªç”¨äºå¯è§†åŒ–ç¨‹åºçš„æµç¨‹å’Œæ•°æ®è¿›åº¦ã€‚ä½œä¸ºå¼€å‘äººå‘˜/è¿ç»´äººå‘˜ï¼Œå½“æˆ‘ä»¬éœ€è¦æ£€æŸ¥ç”¨æˆ·åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­çš„è¡Œç¨‹æ—¶ï¼Œè¿™ç‰¹åˆ«æœ‰ç”¨ã€‚&lt;/p>
&lt;p>Kubernetesæ­£åœ¨æˆä¸ºéƒ¨ç½²å¾®æœåŠ¡çš„å®é™…å·¥å…·ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºè‡ªåŠ¨åŒ–ã€ç¼–æ’ã€æ‰©å±•å’Œç®¡ç†å®¹å™¨çš„å¼€æºç³»ç»Ÿã€‚&lt;/p>
&lt;p>ä½¿ç”¨ Kubernetes æ—¶ï¼Œåä¸ªå¾®æœåŠ¡ç‰¹æ€§ä¸­åªæœ‰ä¸‰ä¸ªè¢«æ¶µç›–ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/26/16219855537970.jpg" alt="">&lt;/p>
&lt;p>**æœåŠ¡å‘ç°Â **æ˜¯é€šè¿‡ &lt;em>Kubernetes æœåŠ¡&lt;/em>çš„æ¦‚å¿µå®ç°çš„ã€‚å®ƒæä¾›äº†ä¸€ç§ä½¿ç”¨ç¨³å®šçš„è™šæ‹Ÿ IP å’Œ DNS åç§°å°† Kubernetes Pod åˆ†ç»„ï¼ˆä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼‰çš„æ–¹æ³•ã€‚å‘ç°æœåŠ¡åªæ˜¯ä½¿ç”¨ Kubernetes çš„æœåŠ¡åä½œä¸º hostname è¿›è¡Œè¯·æ±‚ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ Kubernetes å¯ä»¥å¾ˆå®¹æ˜“åœ°&lt;strong>è°ƒç”¨æœåŠ¡&lt;/strong>ï¼Œå› ä¸ºå¹³å°æœ¬èº«æä¾›äº†è°ƒç”¨ä»»ä½•æœåŠ¡æ‰€éœ€çš„ç½‘ç»œã€‚&lt;/p>
&lt;p>ä»ä¸€å¼€å§‹ï¼ŒKubernetes å°±ä¸€ç›´åœ¨è€ƒè™‘&lt;strong>å¼¹æ€§&lt;/strong>ï¼ˆæˆ–å¯ä¼¸ç¼©æ€§ï¼‰ï¼Œä¾‹å¦‚è¿è¡Œæ—¶&lt;code>kubectl scale deployment myservice --replicas=5 command&lt;/code>ï¼Œmyservice deployment å¯ä¼¸ç¼©è‡³äº”ä¸ªå‰¯æœ¬æˆ–å®ä¾‹ã€‚Kubernetes å¹³å°è´Ÿè´£å¯»æ‰¾åˆé€‚çš„èŠ‚ç‚¹ï¼Œéƒ¨ç½²æœåŠ¡å¹¶å§‹ç»ˆä¿æŒæ‰€éœ€æ•°é‡çš„å‰¯æœ¬å¹¶æ­£å¸¸è¿è¡Œã€‚&lt;/p>
&lt;p>ä½†æ˜¯å…¶ä½™çš„å¾®æœåŠ¡ç‰¹æ€§åˆå¦‚ä½•å‘¢ï¼ŸKubernetes ä»…æ¶µç›–å…¶ä¸­çš„ä¸‰ä¸ªï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•å®ç°å‰©ä¸‹çš„å‘¢ï¼Ÿ&lt;/p>
&lt;p>æ ¹æ®æ‰€ä½¿ç”¨çš„è¯­è¨€æˆ–æ¡†æ¶ï¼Œå¯ä»¥éµå¾ªçš„ç­–ç•¥å¾ˆå¤šã€‚ä½†æ˜¯åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†äº†è§£å¦‚ä½•ä½¿ç”¨ &lt;a href="https://quarkus.io/">Quarkus&lt;/a> å®ç°å…¶ä¸­çš„ä¸€äº›&lt;a href="https://quarkus.io/">ç­–ç•¥&lt;/a>ã€‚&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯-quarkus">ä»€ä¹ˆæ˜¯ Quarkusï¼Ÿ&lt;/h2>
&lt;p>&lt;a href="https://quarkus.io/">Quarkus&lt;/a>Â æ˜¯é’ˆå¯¹ Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰å’Œæœ¬æœºç¼–è¯‘çš„å…¨æ ˆ Kubernetes æœ¬åœ° Java æ¡†æ¶ï¼Œä¸“é—¨é’ˆå¯¹å®¹å™¨ä¼˜åŒ– Javaï¼Œä½¿å…¶æˆä¸ºæ— æœåŠ¡å™¨ï¼ˆServerlessï¼‰ã€äº‘å’Œ Kubernetes ç¯å¢ƒçš„é«˜æ•ˆå¹³å°ã€‚&lt;/p>
&lt;p>Instead of reinventing the wheel, Quarkus uses well-known enterprise-grade frameworks backed by standards/specifications and makes them compilable to a binary usingÂ &lt;a href="https://www.graalvm.org/">GraalVM&lt;/a>.
Quarkusä¸ç”¨é‡æ–°å‘æ˜è½®å­ï¼Œè€Œæ˜¯ä½¿ç”¨ä»¥æ ‡å‡†/è§„èŒƒä¸ºåç›¾çš„çŸ¥åä¼ä¸šçº§æ¡†æ¶ï¼Œå¹¶ä½¿ç”¨ &lt;a href="https://www.graalvm.org/">GraalVM&lt;/a> å°†å…¶ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶&lt;a href="https://www.graalvm.org/">æ–‡ä»¶&lt;/a>ã€‚&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯-microprofile">ä»€ä¹ˆæ˜¯ MicroProfileï¼Ÿ&lt;/h2>
&lt;p>Quarkus ä¸ &lt;a href="https://microprofile.io/">MicroProfile&lt;/a> è§„èŒƒé›†æˆï¼Œä»è€Œå°†ä¼ä¸š Java ç”Ÿæ€ç³»ç»Ÿè¿ç§»åˆ°å¾®æœåŠ¡ä½“ç³»ç»“æ„ä¸­ã€‚&lt;/p>
&lt;p>åœ¨ä¸‹å›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æ„æˆ MicroProfile è§„èŒƒçš„æ‰€æœ‰ APIã€‚æŸäº› APIï¼ˆä¾‹å¦‚ CDIã€JSON-P å’Œ JAX-RSï¼‰åŸºäº &lt;a href="https://jakarta.ee/">Jakarta EE&lt;/a>ï¼ˆä»¥å‰çš„ Java EEï¼‰è§„èŒƒã€‚å…¶ä½™çš„ç”± Java ç¤¾åŒºå¼€å‘ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/26/16219855657899.jpg" alt="">&lt;/p>
&lt;p>Letâ€™s implement API, invocation, resilience, authentication, logging, monitoring, and tracing microservicilities using Quarkus.
è®©æˆ‘ä»¬ä½¿ç”¨Quarkuså®ç°APIã€è°ƒç”¨ã€å¼¹æ€§ã€èº«ä»½éªŒè¯ã€æ—¥å¿—è®°å½•ã€ç›‘è§†å’Œè·Ÿè¸ªå¾®æœåŠ¡ç‰¹æ€§ã€‚&lt;/p>
&lt;h2 id="å¦‚ä½•ä½¿ç”¨-quarkus-å®ç°å¾®æœåŠ¡ç‰¹æ€§">å¦‚ä½•ä½¿ç”¨ Quarkus å®ç°å¾®æœåŠ¡ç‰¹æ€§&lt;/h2>
&lt;h3 id="å…¥é—¨">å…¥é—¨&lt;/h3>
&lt;p>å¼€å§‹ä½¿ç”¨ Quarkus çš„æœ€å¿«æ–¹æ³•æ˜¯é€šè¿‡åœ¨&lt;a href="https://code.quarkus.io/">å¼€å§‹é¡µé¢&lt;/a>ä¸­é€‰æ‹©æ‰€éœ€çš„ä¾èµ–ã€‚å¯¹äºå½“å‰ç¤ºä¾‹ï¼Œé€‰æ‹©å¦‚ä¸‹ä¾èµ–å…³ç³»ä»¥æ»¡è¶³å¾®æœåŠ¡éœ€æ±‚ï¼š&lt;/p>
&lt;p>APIï¼šRESTEasy JAX-RSã€RESTEasy JSON-Bã€OpenAPI
è°ƒç”¨ï¼šREST Client JSON-B
å¼¹æ€§ï¼šFault Tolerance
è®¤è¯ï¼šJWT
è®°å½•ï¼šGELF
ç›‘æ§ï¼šMicrometer metrics
è·Ÿè¸ªï¼šOpenTracing&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/26/16219855795760.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨é€‰æ‹©å„è‡ªçš„ä¾èµ–å…³ç³»ï¼Œæˆ–æµè§ˆä»¥ä¸‹é“¾æ¥ &lt;a href="https://code.quarkus.io/?a=microservicilities-quarkus&amp;amp;e=resteasy&amp;amp;e=resteasy-jsonb&amp;amp;e=rest-client-jsonb&amp;amp;e=smallrye-jwt&amp;amp;e=smallrye-openapi&amp;amp;e=logging-gelf&amp;amp;e=smallrye-fault-tolerance&amp;amp;e=micrometer&amp;amp;e=smallrye-opentracing">Quarkus å¾®æœåŠ¡ç‰¹æ€§ç”Ÿæˆå™¨&lt;/a>ï¼Œæ‰€æœ‰è¿™äº›éƒ½ä¼šè¢«é€‰ä¸­ã€‚ç„¶åæŒ‰â€œç”Ÿæˆåº”ç”¨ç¨‹åºâ€æŒ‰é’®ä»¥ä¸‹è½½åŒ…å«æ”¯æ¶åº”ç”¨ç¨‹åºçš„zipæ–‡ä»¶ã€‚&lt;/p>
&lt;h3 id="æœåŠ¡">æœåŠ¡&lt;/h3>
&lt;p>å¯¹äºå½“å‰ç¤ºä¾‹ï¼Œä»…ä½¿ç”¨ä¸¤ä¸ªæœåŠ¡ç”Ÿæˆäº†ä¸€ä¸ªéå¸¸ç®€å•çš„åº”ç”¨ç¨‹åºã€‚ä¸€ä¸ªåä¸ºâ€œ&lt;em>è¯„çº§æœåŠ¡ rating service&lt;/em>â€çš„æœåŠ¡è¿”å›ç»™å®šä¹¦ç±çš„è¯„çº§ï¼Œè€Œå¦ä¸€ä¸ªåä¸ºâ€œ&lt;em>ä¹¦ç±æœåŠ¡ book service&lt;/em>â€çš„æœåŠ¡åˆ™è¿”å›ä¸€æœ¬ä¹¦çš„ä¿¡æ¯åŠå…¶è¯„çº§ã€‚æœåŠ¡ä¹‹é—´çš„æ‰€æœ‰è°ƒç”¨éƒ½å¿…é¡»ç»è¿‡èº«ä»½éªŒè¯ã€‚&lt;/p>
&lt;p>åœ¨ä¸‹å›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æ•´ä¸ªç³»ç»Ÿçš„æ¦‚è¿°ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/26/16219855936882.jpg" alt="">&lt;/p>
&lt;p>&lt;em>è¯„çº§æœåŠ¡&lt;/em>å·²ç»å¼€å‘å¹¶ä½œä¸º Linux å®¹å™¨æä¾›ã€‚é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåœ¨ç«¯å£ 9090 ä¸Šå¯åŠ¨æœåŠ¡ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker run --rm -ti -p 9090:8080
quay.io/lordofthejars/rating-service:1.0.0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¦éªŒè¯æœåŠ¡ï¼Œè¯·å‘ http://localhost:9090/rate/1 å‘å‡ºè¯·æ±‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl localhost:8080/rate/1 -vv
&amp;gt; GET /rate/1 HTTP/1.1
&amp;gt; Host: localhost:8080
&amp;gt; User-Agent: curl/7.64.1
&amp;gt; Accept: */*
&amp;gt;
&amp;lt; HTTP/1.1 &lt;span class="m">401&lt;/span> Unauthorized
&amp;lt; www-authenticate: Bearer &lt;span class="o">{&lt;/span>token&lt;span class="o">}&lt;/span>
&amp;lt; Content-Length: &lt;span class="m">0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿”å›çš„çŠ¶æ€ç æ˜¯ &lt;code>401 Unauthorized&lt;/code> å› ä¸ºæ²¡æœ‰åœ¨è¯·æ±‚ä¸­æºå¸¦ä»¤ç‰Œï¼ˆJWTï¼‰æä¾›æˆæƒä¿¡æ¯ã€‚åªæœ‰å¸¦æœ‰ &lt;em>group &lt;code>Echoer&lt;/code>&lt;/em> æœ‰æ•ˆä»¤ç‰Œæ‰èƒ½è®¿é—®è¯„çº§æœåŠ¡ã€‚&lt;/p>
&lt;h3 id="api">API&lt;/h3>
&lt;p>Quarkus ä½¿ç”¨ä¼—æ‰€å‘¨çŸ¥çš„ JAX-RS è§„èŒƒæ¥å®šä¹‰ RESTful Web APIã€‚åœ¨å¹•åï¼ŒQuarkus ä½¿ç”¨ RESTEasy å®ç°ç›´æ¥ä¸ Vert.X æ¡†æ¶ä¸€èµ·ä½¿ç”¨ï¼Œè€Œæ— éœ€ä½¿ç”¨ Servlet æŠ€æœ¯ã€‚&lt;/p>
&lt;p>è®©æˆ‘ä»¬ä¸ºå®ç°æœ€å¸¸è§æ“ä½œçš„å›¾ä¹¦æœåŠ¡å®šä¹‰ä¸€ä¸ª APIï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.Consumes&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.DELETE&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.GET&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.POST&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.Path&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.PathParam&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.Produces&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.QueryParam&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.core.MediaType&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.core.Response&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.core.UriBuilder&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Path&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/book&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">BookResource&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@GET&lt;/span>
&lt;span class="nd">@Path&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/{bookId}&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Produces&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MediaType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">APPLICATION_JSON&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Book&lt;/span> &lt;span class="nf">book&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nd">@PathParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;bookId&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">Long&lt;/span> &lt;span class="n">bookId&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// logic
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="nd">@POST&lt;/span>
&lt;span class="nd">@Consumes&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MediaType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">APPLICATION_JSON&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Response&lt;/span> &lt;span class="nf">getBook&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Book&lt;/span> &lt;span class="n">book&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// logic
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">created&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="n">UriBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">fromResource&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">BookResource&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">path&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">book&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">bookId&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">())&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@DELETE&lt;/span>
&lt;span class="nd">@Path&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/{bookId}&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Response&lt;/span> &lt;span class="nf">delete&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nd">@PathParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;bookId&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">Long&lt;/span> &lt;span class="n">bookId&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// logic
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">noContent&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@GET&lt;/span>
&lt;span class="nd">@Produces&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MediaType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">APPLICATION_JSON&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Path&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;search&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Response&lt;/span> &lt;span class="nf">searchBook&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nd">@QueryParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;description&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">description&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// logic
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ok&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">books&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¦–å…ˆè¦æ³¨æ„çš„æ˜¯ï¼Œå®šä¹‰äº†å››ä¸ªä¸åŒçš„ç«¯ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>GET /book/{bookId}&lt;/code>Â ä½¿ç”¨ GET HTTP æ–¹æ³•è¿”å›å¸¦æœ‰å…¶è¯„çº§çš„å›¾ä¹¦ä¿¡æ¯ã€‚return å…ƒç´ ä¼šè‡ªåŠ¨è§£ç¼–ä¸º JSONã€‚&lt;/li>
&lt;li>&lt;code>POST /book&lt;/code>Â ä½¿ç”¨ POST HTTP æ–¹æ³•æ’å…¥ä¸€æœ¬ä¹¦ä½œä¸ºæ­£æ–‡å†…å®¹ã€‚æ­£æ–‡å†…å®¹ä¼šè‡ªåŠ¨ä» JSON ç¼–ç»„åˆ° Java å¯¹è±¡ã€‚&lt;/li>
&lt;li>&lt;code>DELETE /book/{bookId}&lt;/code>Â ä½¿ç”¨ DELETE HTTP æ–¹æ³•é€šè¿‡ä¹¦çš„ ID åˆ é™¤ä¹¦ã€‚&lt;/li>
&lt;li>&lt;code>GET /book/search?description={description}&lt;/code>Â æŒ‰ä¹¦åæœç´¢ä¹¦ç±ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ³¨æ„çš„ç¬¬äºŒä»¶äº‹æ˜¯è¿”å›ç±»å‹ï¼Œæœ‰æ—¶æ˜¯ Java å¯¹è±¡ï¼Œæœ‰æ—¶æ˜¯ Java å®ä¾‹ &lt;code>javax.ws.rs.core.Response&lt;/code>ã€‚ä½¿ç”¨ Java å¯¹è±¡æ—¶ï¼Œä¼šå°†å…¶ä» Java å¯¹è±¡åºåˆ—åŒ–ä¸º &lt;code>@Produces&lt;/code> æ³¨è§£ä¸­è®¾ç½®çš„åª’ä½“ç±»å‹ã€‚åœ¨æ­¤ç‰¹å®šæœåŠ¡ä¸­ï¼Œè¾“å‡ºä¸º JSON æ–‡æ¡£ã€‚é€šè¿‡è¯¥ &lt;code>Response&lt;/code> å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¿”å›ç»™è°ƒç”¨æ–¹çš„å†…å®¹è¿›è¡Œç»†ç²’åº¦çš„æ§åˆ¶ã€‚å¯ä»¥è®¾ç½® HTTP çŠ¶æ€ä»£ç ã€æ ‡å¤´æˆ–è¿”å›ç»™è°ƒç”¨æ–¹çš„å†…å®¹ã€‚å–å†³äºä½¿ç”¨åœºæ™¯ï¼Œæ˜¯åçˆ±ä¸€ç§æ–¹æ³•è€Œä¸æ˜¯å¦ä¸€ç§æ–¹æ³•ã€‚&lt;/p>
&lt;h3 id="è°ƒç”¨">è°ƒç”¨&lt;/h3>
&lt;p>åœ¨å®šä¹‰äº†ç”¨äºè®¿é—®&lt;em>å›¾ä¹¦æœåŠ¡&lt;/em>çš„ API ä¹‹åï¼Œæ˜¯æ—¶å€™å¼€å‘ä¸€æ®µä»£ç æ¥è°ƒç”¨&lt;em>è¯„çº§æœåŠ¡&lt;/em>ä»¥æ£€ç´¢å›¾ä¹¦çš„è¯„çº§äº†ã€‚&lt;/p>
&lt;p>Quarkus ä½¿ç”¨ &lt;a href="https://github.com/eclipse/microprofile-rest-client">MicroProfile Rest Client&lt;/a> è§„èŒƒæ¥è®¿é—®å¤–éƒ¨ï¼ˆHTTPï¼‰æœåŠ¡ã€‚å®ƒæä¾›äº†ä¸€ç§ç±»å‹å®‰å…¨çš„æ–¹æ³•ï¼Œä»¥é€šè¿‡æŸäº› JAX-RS 2.0 API é€šè¿‡ HTTP è°ƒç”¨ RESTful æœåŠ¡ï¼Œä»¥å®ç°ä¸€è‡´æ€§å’Œæ›´æ˜“äºé‡ç”¨ã€‚&lt;/p>
&lt;p>è¦åˆ›å»ºçš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªä½¿ç”¨ JAX-RS æ‰¹æ³¨è¡¨ç¤ºè¿œç¨‹æœåŠ¡çš„æ¥å£ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.GET&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.Path&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.PathParam&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.Produces&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.ws.rs.core.MediaType&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">org.eclipse.microprofile.rest.client.inject.RegisterRestClient&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Path&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/rate&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@RegisterRestClient&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="nc">RatingService&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@GET&lt;/span>
&lt;span class="nd">@Path&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/{bookId}&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Produces&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MediaType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">APPLICATION_JSON&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">Rate&lt;/span> &lt;span class="nf">getRate&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nd">@PathParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;bookId&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">Long&lt;/span> &lt;span class="n">bookId&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>When the getRate() method is called, a remote HTTP call is invoked at /rate/{bookId} replacing the bookId with the value set in the method parameter. It is important to annotate the interface with the @RegisterRestClient annotation.
Then the RatingService interface needs to be injected into BookResource to execute the remote calls.
å½“ &lt;code>getRate() &lt;/code>æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè¿œç¨‹ HTTP è¯·æ±‚åœ¨è°ƒç”¨ &lt;code>/rate/{bookId}&lt;/code> æ›¿æ¢ &lt;code>bookId&lt;/code> ç”¨åœ¨è¯¥æ–¹æ³•ä¸­çš„å‚æ•°å€¼é›†åˆã€‚ç”¨ &lt;code>@RegisterRestClient&lt;/code> æ³¨è§£å¯¹æ¥å£è¿›è¡Œæ³¨è§£å¾ˆé‡è¦ã€‚&lt;/p>
&lt;p>ç„¶å &lt;code>RatingService&lt;/code> éœ€è¦å°†æ¥å£æ³¨å…¥ &lt;code>BookResource&lt;/code> ä»¥æ‰§è¡Œè¿œç¨‹è°ƒç”¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">import&lt;/span> &lt;span class="nn">org.eclipse.microprofile.rest.client.inject.RestClient&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@RestClient&lt;/span>
&lt;span class="n">RatingService&lt;/span> &lt;span class="n">ratingService&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@GET&lt;/span>
&lt;span class="nd">@Path&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/{bookId}&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Produces&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MediaType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">APPLICATION_JSON&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Book&lt;/span> &lt;span class="nf">book&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nd">@PathParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;bookId&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">Long&lt;/span> &lt;span class="n">bookId&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="n">Rate&lt;/span> &lt;span class="n">rate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ratingService&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRate&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">bookId&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">Book&lt;/span> &lt;span class="n">book&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">findBook&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">bookId&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">book&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The @RestClient annotation injects a proxied instance of the interface, providing the implementation of the client.
The last thing is to configure the service location (the hostname part). In Quarkus, the configuration properties are set in src/main/resources/application.properties file. To configure the location of the service, we need to use the fully qualified name of the Rest Client interface with URL as key, and the location as a value:
è¯¥ &lt;code>@RestClient&lt;/code> æ³¨è§£æ³¨å…¥ç•Œé¢çš„ä»£ç†å®ä¾‹ï¼Œæä¾›å®¢æˆ·ç«¯çš„å®ç°ã€‚&lt;/p>
&lt;p>æœ€åä¸€ä»¶äº‹æ˜¯é…ç½®æœåŠ¡ä½ç½®ï¼ˆ&lt;em>hostname&lt;/em> éƒ¨åˆ†ï¼‰ã€‚åœ¨ Quarkus ä¸­ï¼Œé…ç½®å±æ€§åœ¨ &lt;code>src/main/resources/application.properties&lt;/code> æ–‡ä»¶ä¸­è®¾ç½®ã€‚è¦é…ç½®æœåŠ¡çš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ Rest Client æ¥å£çš„æ ‡å‡†åç§°ï¼Œå…¶ä¸­ URL ä½œä¸ºé”®ï¼Œè€Œ location ä½œä¸ºå€¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">org.acme.RatingService/mp-rest/url=http://localhost:9090
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨æ­£ç¡®è®¿é—®&lt;em>è¯„ä¼°æœåŠ¡&lt;/em>è€Œæ²¡æœ‰ &lt;code>401 Unauthorized&lt;/code> é—®é¢˜ä¹‹å‰ï¼Œå¿…é¡»è§£å†³ç›¸äº’è®¤è¯é—®é¢˜ã€‚&lt;/p>
&lt;h3 id="èº«ä»½éªŒè¯">èº«ä»½éªŒè¯&lt;/h3>
&lt;p>åŸºäºä»¤ç‰Œçš„èº«ä»½éªŒè¯æœºåˆ¶å…è®¸ç³»ç»ŸåŸºäºå®‰å…¨ä»¤ç‰Œå¯¹èº«ä»½è¿›è¡Œèº«ä»½éªŒè¯ã€æˆæƒå’ŒéªŒè¯ã€‚Quarkus ä¸ &lt;a href="https://github.com/eclipse/microprofile-jwt-auth">MicroProfile JWT RBAC å®‰å…¨&lt;/a>è§„èŒƒé›†æˆåœ¨ä¸€èµ·ï¼Œä»¥ä½¿ç”¨ JWT ä»¤ç‰Œä¿æŠ¤æœåŠ¡ã€‚&lt;/p>
&lt;p>è¦ä½¿ç”¨ MicroProfile JWT RBAC å®‰å…¨æ€§ä¿æŠ¤ç«¯ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨æ‰¹æ³¨å¯¹æ–¹æ³•è¿›è¡Œ &lt;code>@RolesAllowed&lt;/code> æ³¨è§£ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@GET&lt;/span>
&lt;span class="nd">@Path&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/{bookId}&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@RolesAllowed&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Echoer&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Produces&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MediaType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">APPLICATION_JSON&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Book&lt;/span> &lt;span class="nf">book&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nd">@PathParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;bookId&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">Long&lt;/span> &lt;span class="n">bookId&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åï¼Œæˆ‘ä»¬é…ç½®ä»¤ç‰Œçš„å‘è¡Œæ–¹å’Œå…¬é’¥çš„ä½ç½®ï¼Œä»¥éªŒè¯ä»¤ç‰Œåœ¨ &lt;code>application.properties&lt;/code> æ–‡ä»¶ä¸­çš„ç­¾åï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">mp.jwt.verify.publickey.location=https://raw.githubusercontent.com/redhat-developer-demos/quarkus-tutorial/master/jwt-token/quarkus.jwt.pub
mp.jwt.verify.issuer=https://quarkus.io/using-jwt-rbac
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ­¤æ‰©å±•åè‡ªåŠ¨éªŒè¯ï¼šä»¤ç‰Œæœ‰æ•ˆï¼›å‘è¡Œæ–¹æ˜¯æ­£ç¡®çš„ï¼›ä»¤ç‰Œå°šæœªä¿®æ”¹ï¼›ç­¾åæœ‰æ•ˆï¼›æ²¡æœ‰è¿‡æœŸã€‚&lt;/p>
&lt;p>è¿™ä¸¤ç§&lt;em>å›¾ä¹¦æœåŠ¡&lt;/em>å’Œ&lt;em>è¯„çº§æœåŠ¡&lt;/em>ç°åœ¨æ˜¯ç”±åŒä¸€ JWT å‘è¡Œæ–¹å’Œå¯†é’¥ä¿æŠ¤ï¼Œå› æ­¤æœåŠ¡ä¹‹é—´çš„é€šä¿¡è¦æ±‚éªŒè¯æä¾›åœ¨ä»¤ç‰Œçš„æœ‰æ•ˆæ‰¿è½½ç”¨æˆ· &lt;code>Authentication&lt;/code> å¤´éƒ¨ã€‚&lt;/p>
&lt;p>&lt;em>è¯„çº§æœåŠ¡&lt;/em>å¯åŠ¨å’Œè¿è¡Œï¼Œè®©æˆ‘ä»¬å¼€å§‹ç”¨ä¸‹é¢çš„å‘½ä»¤&lt;em>å›¾ä¹¦æœåŠ¡&lt;/em>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">./mvnw compile quarkus:dev
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Finally, we can make a request to get book information providing a valid JSON Web Token as a bearer token.
The generation of the token is out of the scope of this article, and a token has been already generated:
æœ€åï¼Œæˆ‘ä»¬å¯ä»¥è¯·æ±‚è·å–æä¾›æœ‰æ•ˆ JSON Web ä»¤ç‰Œä½œä¸ºæ‰¿è½½ä»¤ç‰Œçš„å›¾ä¹¦ä¿¡æ¯ã€‚&lt;/p>
&lt;p>ä»¤ç‰Œçš„ç”Ÿæˆä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ä¹‹å†…ï¼Œå¹¶ä¸”å·²ç»ç”Ÿæˆäº†ä»¤ç‰Œï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/26/16219856429022.jpg" alt="">&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">curl -H &amp;#34;Authorization: Bearer eyJraWQiOiJcL3ByaXZhdGVLZXkucGVtIiwidHlwIjoiSldUIiwiYWxnIjoiUlMyNTYifQ.eyJzdWIiOiJqZG9lLXVzaW5nLWp3dC1yYmFjIiwiYXVkIjoidXNpbmctand0LXJiYWMiLCJ1cG4iOiJqZG9lQHF1YXJrdXMuaW8iLCJiaXJ0aGRhdGUiOiIyMDAxLTA3LTEzIiwiYXV0aF90aW1lIjoxNTcwMDk0MTcxLCJpc3MiOiJodHRwczpcL1wvcXVhcmt1cy5pb1wvdXNpbmctand0LXJiYWMiLCJyb2xlTWFwcGluZ3MiOnsiZ3JvdXAyIjoiR3JvdXAyTWFwcGVkUm9sZSIsImdyb3VwMSI6Ikdyb3VwMU1hcHBlZFJvbGUifSwiZ3JvdXBzIjpbIkVjaG9lciIsIlRlc3RlciIsIlN1YnNjcmliZXIiLCJncm91cDIiXSwicHJlZmVycmVkX3VzZXJuYW1lIjoiamRvZSIsImV4cCI6MjIwMDgxNDE3MSwiaWF0IjoxNTcwMDk0MTcxLCJqdGkiOiJhLTEyMyJ9.Hzr41h3_uewy-g2B-sonOiBObtcpkgzqmF4bT3cO58v45AIOiegl7HIx7QgEZHRO4PdUtR34x9W23VJY7NJ545ucpCuKnEV1uRlspJyQevfI-mSRg1bHlMmdDt661-V3KmQES8WX2B2uqirykO5fCeCp3womboilzCq4VtxbmM2qgf6ag8rUNnTCLuCgEoulGwTn0F5lCrom-7dJOTryW1KI0qUWHMMwl4TX5cLmqJLgBzJapzc5_yEfgQZ9qXzvsT8zeOWSKKPLm7LFVt2YihkXa80lWcjewwt61rfQkpmqSzAHL0QIs7CsM9GfnoYc0j9po83-P3GJiBMMFmn-vg&amp;#34; localhost:8080/book/1 -v
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å“åº”åˆæ˜¯ forbidden é”™è¯¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">&amp;lt; HTTP/1.1 401 Unauthorized
&amp;lt; Content-Length: 0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½ å¯èƒ½æƒ³çŸ¥é“ä¸ºä»€ä¹ˆåœ¨æä¾›æœ‰æ•ˆä»¤ç‰Œåä»ç„¶å‡ºç°æ­¤é”™è¯¯ã€‚å¦‚æœæˆ‘ä»¬æ£€æŸ¥å›¾ä¹¦æœåŠ¡çš„æ§åˆ¶å°ï¼Œå°±ä¼šå‘ç°æŠ›å‡ºäº†ä»¥ä¸‹å¼‚å¸¸ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">org.jboss.resteasy.client.exception.ResteasyWebApplicationException: Unknown error, status code 401
at org.jboss.resteasy.client.exception.WebApplicationExceptionWrapper.wrap(WebApplicationExceptionWrapper.java:107)
at org.jboss.resteasy.microprofile.client.DefaultResponseExceptionMapper.toThrowable(DefaultResponseExceptionMapper.java:21)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‘ç”Ÿæ­¤å¼‚å¸¸çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬å·²è·å¾—èº«ä»½éªŒè¯å¹¶æœ‰æƒè®¿é—®&lt;em>å›¾ä¹¦æœåŠ¡&lt;/em>ï¼Œä½†æ‰¿è½½ä»¤ç‰Œå°šæœªä¼ æ’­åˆ°&lt;em>è¯„çº§æœåŠ¡&lt;/em>ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/26/16219856618998.jpg" alt="">&lt;/p>
&lt;p>ä¸ºäº†è‡ªåŠ¨å°† &lt;code>Authorization&lt;/code> æ ‡å¤´ä»ä¼ å…¥è¯·æ±‚ä¼ æ’­åˆ°å…¶ä½™å®¢æˆ·ç«¯è¯·æ±‚ï¼Œéœ€è¦è¿›è¡Œä¸¤æ¬¡ä¿®æ”¹ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€ä¸ªä¿®æ”¹æ˜¯ä¿®æ”¹ Rest Client ç•Œé¢ï¼Œå¹¶ä½¿ç”¨å¯¹å…¶è¿›è¡Œæ³¨è§£ &lt;code>org.eclipse.microprofile.rest.client.inject.RegisterClientHeaders&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Path&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/rate&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@RegisterRestClient&lt;/span>
&lt;span class="nd">@RegisterClientHeaders&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="nc">RatingService&lt;/span> &lt;span class="o">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¬¬äºŒä¸ªä¿®æ”¹æ˜¯é…ç½®åœ¨è¯·æ±‚ä¹‹é—´ä¼ æ’­å“ªäº›æ ‡å¤´ã€‚è¿™æ˜¯åœ¨ &lt;code>application.properties&lt;/code> æ–‡ä»¶ä¸­è®¾ç½®çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback"> org.eclipse.microprofile.rest.client.propagateHeaders=Authorization
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œä¸ä¹‹å‰ç›¸åŒçš„ curl å‘½ä»¤ï¼Œæˆ‘ä»¬å°†è·å¾—æ­£ç¡®çš„è¾“å‡ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&amp;lt; HTTP/1.1 &lt;span class="m">200&lt;/span> OK
&amp;lt; Content-Length: &lt;span class="m">39&lt;/span>
&amp;lt; Content-Type: application/json
&amp;lt;
* Connection &lt;span class="c1">#0 to host localhost left intact&lt;/span>
&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;bookId&amp;#34;&lt;/span>:2,&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;Book 2&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;rating&amp;#34;&lt;/span>:1&lt;span class="o">}&lt;/span>* Closing connection &lt;span class="m">0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å¼¹æ€§">å¼¹æ€§&lt;/h3>
&lt;p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå…·æœ‰å®¹é”™èƒ½åŠ›å¾ˆé‡è¦ï¼Œè¿™æ ·å¯ä»¥é¿å…æ•…éšœä»ä¸€ä¸ªæœåŠ¡ä¼ æ’­åˆ°è¯¥æœåŠ¡çš„æ‰€æœ‰ç›´æ¥å’Œé—´æ¥è°ƒç”¨æ–¹ã€‚Quarkus å°† &lt;a href="https://github.com/eclipse/microprofile-fault-tolerance">MicroProfile Fault Tolerance&lt;/a> è§„èŒƒä¸ä»¥ä¸‹ç”¨äºå¤„ç†æ•…éšœçš„æ³¨é‡Šé›†æˆåœ¨ä¸€èµ·ï¼š&lt;/p>
&lt;p>â—Â Â  Â &lt;code>@Timeout&lt;/code>ï¼šå®šä¹‰æŠ›å‡ºå¼‚å¸¸ä¹‹å‰æ‰§è¡Œçš„æœ€é•¿æ—¶é—´ã€‚
â—Â Â  Â &lt;code>@Retry&lt;/code>ï¼šå¦‚æœè°ƒç”¨å¤±è´¥ï¼Œè¯·å†æ¬¡é‡è¯•æ‰§è¡Œã€‚
â—Â Â  Â &lt;code>@Bulkhead&lt;/code>ï¼šé™åˆ¶å¹¶å‘æ‰§è¡Œï¼Œä»¥ä½¿è¯¥åŒºåŸŸä¸­çš„æ•…éšœä¸ä¼šä½¿æ•´ä¸ªç³»ç»Ÿè¿‡è½½ã€‚
â—Â Â  Â &lt;code>@CircuitBreaker&lt;/code>ï¼šæ‰§è¡Œåå¤å¤±è´¥æ—¶ï¼Œå°†è‡ªåŠ¨è¿›è¡Œå¿«é€Ÿæ•…éšœåˆ‡æ¢ã€‚
â—Â Â  Â &lt;code>@Fallback&lt;/code>ï¼šæ‰§è¡Œå¤±è´¥æ—¶ï¼Œæä¾›å¤‡ç”¨è§£å†³æ–¹æ¡ˆ/é»˜è®¤å€¼ã€‚&lt;/p>
&lt;p>è®©æˆ‘ä»¬æ·»åŠ ä¸‰æ¬¡é‡è¯•ï¼Œå…¶ä¸­é‡è¯•ä¹‹é—´çš„å»¶è¿Ÿè®¡æ—¶å™¨ä¸ºä¸€ç§’ï¼Œä»¥é˜²è®¿é—®&lt;em>è¯„çº§æœåŠ¡&lt;/em>æ—¶å‘ç”Ÿé”™è¯¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Retry&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">maxRetries&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">3&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">delay&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">1000&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">Rate&lt;/span> &lt;span class="nf">getRate&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nd">@PathParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;bookId&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">Long&lt;/span> &lt;span class="n">bookId&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç°åœ¨ï¼Œåœæ­¢&lt;em>è¯„çº§æœåŠ¡&lt;/em>å¹¶æ‰§è¡Œè¯·æ±‚ã€‚å¼•å‘ä»¥ä¸‹å¼‚å¸¸ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">org.jboss.resteasy.spi.UnhandledException: javax.ws.rs.ProcessingException: RESTEASY004655: Unable to invoke request:
org.apache.http.conn.HttpHostConnectException: Connect to localhost:9090 [localhost/127.0.0.1, localhost/0:0:0:0:0:0:0:1] failed: Connection refused
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ˜¾ç„¶ï¼Œè¿™é‡Œå­˜åœ¨é”™è¯¯ï¼Œä½†æ˜¯è¯·æ³¨æ„ï¼Œç”±äºæ‰§è¡Œäº†ä¸‰æ¬¡é‡è¯•ï¼ˆå»¶è¿Ÿä¸€ç§’ï¼‰ï¼Œå› æ­¤å¼•å‘å¼‚å¸¸ä¹‹å‰ï¼Œç»è¿‡äº†ä¸‰ç§’é’Ÿã€‚&lt;/p>
&lt;p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ&lt;em>è¯„çº§æœåŠ¡&lt;/em>å·²å…³é—­ï¼Œå› æ­¤æ— æ³•è¿›è¡Œæ¢å¤ï¼Œä½†æ˜¯åœ¨ä¸€ä¸ªå®é™…ç¤ºä¾‹ä¸­ï¼Œ&lt;em>è¯„çº§æœåŠ¡&lt;/em>å¯èƒ½ä»…åœ¨çŸ­æ—¶é—´å†…å°±æ¢å¤äº†ï¼Œæˆ–è€…éƒ¨ç½²äº†è¯¥æœåŠ¡çš„å¤šä¸ªå‰¯æœ¬ï¼Œå› æ­¤å¯ä»¥ç®€å•åœ°é‡è¯•æ“ä½œå¯èƒ½è¶³ä»¥æ¢å¤å¹¶æä¾›æœ‰æ•ˆçš„å“åº”ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œå½“å¼•å‘å¼‚å¸¸æ—¶é‡è¯•æ¬¡æ•°ä¸å¤Ÿæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†é”™è¯¯ä¼ æ’­ç»™è°ƒç”¨æ–¹ï¼Œä¹Ÿå¯ä»¥ä¸ºè°ƒç”¨æä¾›æ›¿ä»£å€¼ã€‚è¿™ç§é€‰æ‹©å¯ä»¥æ˜¯å¯¹å¦ä¸€ä¸ªç³»ç»Ÿçš„è°ƒç”¨ï¼ˆå³åˆ†å¸ƒå¼ç¼“å­˜ï¼‰æˆ–é™æ€å€¼ã€‚&lt;/p>
&lt;p>å¯¹äºæ­¤ç”¨ä¾‹ï¼Œå½“ä¸è¯„çº§æœåŠ¡çš„è¿æ¥å¤±è´¥æ—¶ï¼Œå°†è¿”å›è¯„çº§å€¼ 0ã€‚&lt;/p>
&lt;p>è¦å®ç°å›é€€é€»è¾‘ï¼Œé¦–å…ˆè¦åšçš„æ˜¯å®ç°å°† &lt;code>org.eclipse.microprofile.faulttolerance.FallbackHandler&lt;/code> è¿”å›ç±»å‹è®¾ç½®ä¸ºä¸å›é€€ç­–ç•¥æ–¹æ³•æä¾›çš„æ›¿ä»£ç±»å‹ç›¸åŒçš„æ¥å£ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå°† &lt;code>Rate&lt;/code> è¿”å›é»˜è®¤å¯¹è±¡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">import&lt;/span> &lt;span class="nn">org.eclipse.microprofile.faulttolerance.ExecutionContext&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">org.eclipse.microprofile.faulttolerance.FallbackHandler&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">RatingServiceFallback&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">FallbackHandler&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Rate&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Rate&lt;/span> &lt;span class="nf">handle&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ExecutionContext&lt;/span> &lt;span class="n">context&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Rate&lt;/span> &lt;span class="n">rate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Rate&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">rate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">rate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">rate&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åè¦åšçš„æ˜¯ç”¨æ³¨è§£å¯¹ &lt;code>getRating()&lt;/code> æ–¹æ³•è¿›è¡Œ &lt;code>@org.eclipse.microprofile.faulttolerance.Fallback&lt;/code> æ³¨è§£ï¼Œä»¥é…ç½®æ— æ³•æ¢å¤æ—¶è¦æ‰§è¡Œçš„å›é€€ç±»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Retry&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">maxRetries&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">3&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">delay&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">1000&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Fallback&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RatingServiceFallback&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">Rate&lt;/span> &lt;span class="nf">getRate&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nd">@PathParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;bookId&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">Long&lt;/span> &lt;span class="n">bookId&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœé‡å¤ä¸ä»¥å‰ç›¸åŒçš„è¯·æ±‚ï¼Œåˆ™ä¸ä¼šå¼•å‘ä»»ä½•å¼‚å¸¸ï¼Œä½†æ˜¯æœ‰æ•ˆå€¼çš„è¾“å‡ºå°† rating å­—æ®µè®¾ç½®ä¸º 0ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">* Connection #0 to host localhost left intact
{&amp;#34;bookId&amp;#34;:2,&amp;#34;name&amp;#34;:&amp;#34;Book 2&amp;#34;,&amp;#34;rating&amp;#34;:0}* Closing connection 0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è§„èŒƒæä¾›çš„ä»»ä½•å…¶ä»–ç­–ç•¥éƒ½å¯ä»¥ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå¯¹äºæ–­è·¯å™¨æ¨¡å¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@CircuitBreaker&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">requestVolumeThreshold&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">4&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">failureRatio&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">75&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">delay&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">1000&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœåœ¨å››ä¸ªè¿ç»­è°ƒç”¨çš„æ»šåŠ¨çª—å£ä¸­å‘ç”Ÿäº†ä¸‰ä¸ªï¼ˆ&lt;em>4 x 0.75&lt;/em>ï¼‰æ•…éšœï¼Œåˆ™ç”µè·¯å°†æ–­å¼€ 1000 msï¼Œç„¶åæ¢å¤åˆ°åŠæ–­å¼€çŠ¶æ€ã€‚å¦‚æœåœ¨åŠå¼€æ—¶è°ƒç”¨æˆåŠŸï¼Œåˆ™å°†å…¶å†æ¬¡å…³é—­ã€‚å¦åˆ™ï¼Œå®ƒå°†ä¿æŒæ‰“å¼€çŠ¶æ€&lt;/p>
&lt;h3 id="æ—¥å¿—è®°å½•">æ—¥å¿—è®°å½•&lt;/h3>
&lt;p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå»ºè®®å°†æ‰€æœ‰æœåŠ¡çš„æ—¥å¿—æ”¶é›†åœ¨ä¸€ä¸ªç»Ÿä¸€çš„æ—¥å¿—ä¸­ï¼Œä»¥æ›´æœ‰æ•ˆåœ°ä½¿ç”¨å’Œç†è§£ã€‚&lt;/p>
&lt;p>ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ &lt;a href="https://www.fluentd.org/">Fluentd&lt;/a>ï¼Œå®ƒæ˜¯ &lt;a href="https://www.fluentd.org/">Kubernetes&lt;/a> ä¸­ç”¨äºç»Ÿä¸€æ—¥å¿—è®°å½•å±‚çš„å¼€æºæ•°æ®æ”¶é›†å™¨ã€‚Quarkus ä½¿ç”¨ Graylog æ‰©å±•æ—¥å¿—æ ¼å¼ï¼ˆGELFï¼‰ä¸ Fluentd é›†æˆã€‚&lt;/p>
&lt;p>é›†æˆçœŸçš„å¾ˆç®€å•ã€‚é¦–å…ˆï¼Œä¸å…¶ä»–ä»»ä½• Quarkus åº”ç”¨ç¨‹åºä¸€æ ·ä½¿ç”¨æ—¥å¿—é€»è¾‘ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">import&lt;/span> &lt;span class="nn">org.jboss.logging.Logger&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Logger&lt;/span> &lt;span class="n">LOG&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Logger&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getLogger&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">BookResource&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="nd">@GET&lt;/span>
&lt;span class="nd">@Path&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/{bookId}&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@RolesAllowed&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Echoer&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Produces&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MediaType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">APPLICATION_JSON&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Book&lt;/span> &lt;span class="nf">book&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nd">@PathParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;bookId&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">Long&lt;/span> &lt;span class="n">bookId&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">LOG&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Get Book&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ä¸‹æ¥ï¼Œå¯ç”¨ GELF æ ¼å¼å¹¶è®¾ç½® Fluentd æœåŠ¡å™¨ä½ç½®ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">quarkus.log.handler.gelf.enabled=true
quarkus.log.handler.gelf.host=localhost
quarkus.log.handler.gelf.port=12201
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥å‘è®°å½•çš„ç«¯ç‚¹å‘å‡ºè¯·æ±‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -H &lt;span class="s2">&amp;#34;Authorization: Bearer ...&amp;#34;&lt;/span> localhost:8080/book/1
&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;bookId&amp;#34;&lt;/span>:1,&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;Book 1&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;rating&amp;#34;&lt;/span>:3&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºæ–¹é¢æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œä½†æ˜¯æ—¥å¿—è¡Œå·²ä¼ è¾“åˆ° Fluentdã€‚å¦‚æœä½¿ç”¨ &lt;a href="https://www.elastic.co/kibana">Kibana&lt;/a> å¯è§†åŒ–æ•°æ®ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å­˜å‚¨çš„æ—¥å¿—è¡Œï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/26/16219856876241.jpg" alt="">&lt;/p>
&lt;h3 id="ç›‘æ§">ç›‘æ§&lt;/h3>
&lt;p>ç›‘æ§æ˜¯å¦ä¸€ä¸ªéœ€è¦åœ¨æˆ‘ä»¬çš„å¾®æœåŠ¡æ¶æ„ä¸­å®ç°çš„ â€œå¾®æœåŠ¡ç‰¹æ€§â€ã€‚Quarkus ä¸ &lt;a href="https://micrometer.io/">Micrometer&lt;/a> é›†æˆåœ¨ä¸€èµ·ä»¥è¿›è¡Œåº”ç”¨ç¨‹åºç›‘æ§ã€‚Micrometer æä¾›äº†æœ€æµè¡Œçš„ç›‘æ§ç³»ç»Ÿçš„å•ä¸ªå…¥å£ç‚¹ï¼Œä½¿ä½ æ— éœ€ä¾›åº”å•†é”å®šå³å¯æ£€æµ‹åŸºäº JVM çš„åº”ç”¨ç¨‹åºä»£ç ã€‚&lt;/p>
&lt;p>å¯¹äºæ­¤ç¤ºä¾‹ï¼Œç›‘æ§è¾“å‡ºé‡‡ç”¨ &lt;a href="https://prometheus.io/">Prometheus&lt;/a> æ ¼å¼ï¼Œä½† Micrometerï¼ˆå’Œ Quarkusï¼‰è¿˜æ”¯æŒå…¶ä»–æ ¼å¼ï¼Œä¾‹å¦‚ Azure Monitorã€Stackdriverã€SignalFxã€StatsD å’Œ DataDogã€‚&lt;/p>
&lt;p>ä½ å¯ä»¥æ³¨å†Œä»¥ä¸‹ Maven ä¾èµ–é¡¹ä»¥æä¾› Prometheus è¾“å‡ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>io.quarkus&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>quarkus-micrometer-registry-prometheus&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒMicrometer æ‰©å±•æ³¨å†Œäº†ä¸€äº›ä¸ç³»ç»Ÿï¼ŒJVM æˆ– HTTP ç›¸å…³çš„åº¦é‡ã€‚æ”¶é›†çš„æŒ‡æ ‡çš„ä¸€ä¸ªå­é›†åœ¨ &lt;code>/q/metrics&lt;/code> ç«¯ç‚¹å¤„å¯ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl localhost:8080/q/metrics
jvm_threads_states_threads&lt;span class="o">{&lt;/span>&lt;span class="nv">state&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;runnable&amp;#34;&lt;/span>,&lt;span class="o">}&lt;/span> 22.0
jvm_threads_states_threads&lt;span class="o">{&lt;/span>&lt;span class="nv">state&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;blocked&amp;#34;&lt;/span>,&lt;span class="o">}&lt;/span> 0.0
jvm_threads_states_threads&lt;span class="o">{&lt;/span>&lt;span class="nv">state&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;waiting&amp;#34;&lt;/span>,&lt;span class="o">}&lt;/span> 10.0
http_server_bytes_read_count 1.0
http_server_bytes_read_sum 0.0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Micrometer API æ¥å®ç°ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„æŒ‡æ ‡ã€‚
è®©æˆ‘ä»¬å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æŒ‡æ ‡ï¼Œè¯¥æŒ‡æ ‡ç”¨äºè¡¡é‡è¯„ä»·æœ€é«˜çš„å›¾ä¹¦ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ &lt;code>io.micrometer.core.instrument.MeterRegistry&lt;/code> è¯¥ç±»å¯ä»¥å®ŒæˆæŒ‡æ ‡ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ä¸ºé‡è§„ï¼‰çš„æ³¨å†Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">MeterRegistry&lt;/span> &lt;span class="n">registry&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">LongAccumulator&lt;/span> &lt;span class="n">highestRating&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">LongAccumulator&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">max&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="nf">BookResource&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MeterRegistry&lt;/span> &lt;span class="n">registry&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">registry&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">registry&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">registry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">gauge&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;book.rating.max&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">BookResource&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">highestRatingBook&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯·æ±‚ä¸€ä¸‹ï¼Œå¹¶éªŒè¯é‡è§„æ˜¯å¦æ­£ç¡®æ›´æ–°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -H &lt;span class="s2">&amp;#34;Authorization: Bearer ...&amp;#34;&lt;/span> localhost:8080/book/1
&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;bookId&amp;#34;&lt;/span>:1,&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;Book 1&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;rating&amp;#34;&lt;/span>:3&lt;span class="o">}&lt;/span>
curl localhost:8080/q/metrics
&lt;span class="c1"># HELP book_rating_max&lt;/span>
&lt;span class="c1"># TYPE book_rating_max gauge&lt;/span>
book_rating_max 3.0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬è¿˜å¯ä»¥è®¾ç½®ä¸€ä¸ªè®¡æ—¶å™¨æ¥è®°å½•ä»&lt;em>è¯„çº§æœåŠ¡&lt;/em>è·å–è¯„çº§ä¿¡æ¯æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">Supplier&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Rate&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">rateSupplier&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">ratingService&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRate&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">bookId&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">};&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="n">Rate&lt;/span> &lt;span class="n">rate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">registry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">timer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;book.rating.test&amp;#34;&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">wrap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">rateSupplier&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯·æ±‚ä¸€ä¸‹ï¼Œå¹¶éªŒè¯æ”¶é›†è¯„ä»·â€‹â€‹æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback"># HELP book_rating_test_seconds
# TYPE book_rating_test_seconds summary
book_rating_test_seconds_count 4.0
book_rating_test_seconds_sum 1.05489108
# HELP book_rating_test_seconds_max
# TYPE book_rating_test_seconds_max gauge
book_rating_test_seconds_max 1.018622001
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Micrometer ä½¿ç”¨ &lt;code>MeterFilter&lt;/code> å®ä¾‹æ¥è‡ªå®šä¹‰ &lt;code>MeterRegistry&lt;/code> å®ä¾‹å‘å‡ºçš„åº¦é‡ã€‚Micrometer æ‰©å±•å°†æ£€æµ‹ &lt;code>MeterFilter&lt;/code> CDI beanï¼Œå¹¶åœ¨åˆå§‹åŒ– &lt;code>MeterRegistry&lt;/code> å®ä¾‹æ—¶ä½¿ç”¨å®ƒä»¬ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªé€šç”¨æ ‡ç­¾æ¥è®¾ç½®è¿è¡Œåº”ç”¨ç¨‹åºçš„ç¯å¢ƒï¼ˆäº§å“ã€æµ‹è¯•ã€é¢„å‘å¸ƒç­‰ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Singleton&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">MicrometerCustomConfiguration&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Produces&lt;/span>
&lt;span class="nd">@Singleton&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">MeterFilter&lt;/span> &lt;span class="nf">configureAllRegistries&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">MeterFilter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">commonTags&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Arrays&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">asList&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="n">Tag&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">of&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;env&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;prod&amp;#34;&lt;/span>&lt;span class="o">)));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‘é€æ–°è¯·æ±‚å¹¶éªŒè¯æŒ‡æ ‡æ˜¯å¦å·²æ ‡è®°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">http_client_requests_seconds_max{clientName=&amp;#34;localhost&amp;#34;,env=&amp;#34;prod&amp;#34;,method=&amp;#34;GET&amp;#34;,outcome=&amp;#34;SUCCESS&amp;#34;,status=&amp;#34;200&amp;#34;,uri=&amp;#34;/rate/2&amp;#34;,} 0.0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯·æ³¨æ„ &lt;code>env&lt;/code> åŒ…å«å€¼ä¸º &lt;code>prod&lt;/code> çš„æ ‡ç­¾ã€‚&lt;/p>
&lt;h3 id="è·Ÿè¸ª">è·Ÿè¸ª&lt;/h3>
&lt;p>Quarkus åº”ç”¨ç¨‹åºåˆ©ç”¨ &lt;a href="https://opentracing.io/">OpenTracing&lt;/a> è§„èŒƒä¸ºäº¤äº’å¼ Web åº”ç”¨ç¨‹åºæä¾›åˆ†å¸ƒå¼è·Ÿè¸ªã€‚&lt;/p>
&lt;p>è®©æˆ‘ä»¬é…ç½® OpenTracing ä»¥è¿æ¥åˆ° Jaeger æœåŠ¡å™¨ï¼Œå°† book-service è®¾ç½®ä¸ºæœåŠ¡åç§°ä»¥æ ‡è¯†è·Ÿè¸ªï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">quarkus.jaeger.enabled=true
quarkus.jaeger.endpoint=http://localhost:14268/api/traces
quarkus.jaeger.service-name=book-service
quarkus.jaeger.sampler-type=const
quarkus.jaeger.sampler-param=1
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç°åœ¨å‘ä¸€ä¸ªè¯·æ±‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -H &lt;span class="s2">&amp;#34;Authorization: Bearer ...&amp;#34;&lt;/span> localhost:8080/book/1 &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;bookId&amp;#34;&lt;/span>:1,&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;Book 1&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;rating&amp;#34;&lt;/span>:3&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è®¿é—®Jaeger UIä»¥éªŒè¯æ˜¯å¦è·Ÿè¸ªäº†è¯¥è°ƒç”¨ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/26/16219857070960.jpg" alt="">&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä¸å¼€å‘æ•´ä½“åº”ç”¨ç¨‹åºç›¸æ¯”ï¼Œå¼€å‘å’Œå®ç°å¾®æœåŠ¡ä½“ç³»ç»“æ„æ›´å…·æŒ‘æˆ˜æ€§ã€‚æˆ‘ä»¬è®¤ä¸ºï¼Œå¾®æœåŠ¡å¯ä»¥é©±åŠ¨ä½ æ ¹æ®åº”ç”¨ç¨‹åºåŸºç¡€ç»“æ„æ­£ç¡®åœ°å¼€å‘æœåŠ¡ã€‚&lt;/p>
&lt;p>æ­¤å¤„ä»‹ç»çš„å¤§å¤šæ•°å¾®æœåŠ¡ï¼ˆAPI å’Œç®¡é“é™¤å¤–ï¼‰æ˜¯æ–°çš„ï¼Œæˆ–è€…åœ¨æ•´ä½“åº”ç”¨ä¸­å®ç°æ–¹å¼æœ‰æ‰€ä¸åŒã€‚åŸå› æ˜¯ç°åœ¨åº”ç”¨ç¨‹åºè¢«åˆ†è§£æˆå‡ éƒ¨åˆ†ï¼Œæ‰€æœ‰éƒ¨åˆ†éƒ½åœ¨ç½‘ç»œä¸­äº’è¿ã€‚&lt;/p>
&lt;p>å¦‚æœä½ May 26, 2021æ‰“ç®—å¼€å‘å¾®æœåŠ¡å¹¶å°†å…¶éƒ¨ç½²åˆ° Kubernetesï¼Œé‚£ä¹ˆ Quarkus æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºå®ƒå¯ä»¥ä¸ Kubernetes é¡ºåˆ©é›†æˆã€‚å®æ–½å¤§å¤šæ•°å¾®æœåŠ¡å¾ˆç®€å•ï¼Œåªéœ€è¦å‡ è¡Œä»£ç ã€‚&lt;/p>
&lt;p>æœ¬æ–‡æ¼”ç¤ºçš„æºä»£ç å¯ä»¥åœ¨ &lt;a href="https://github.com/lordofthejars/microservicilities-quarkus">github&lt;/a> ä¸Šæ‰¾åˆ°ã€‚&lt;/p>
&lt;h2 id="å…³äºä½œè€…">å…³äºä½œè€…&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/26/16219857200384.jpg" alt="">&lt;/p>
&lt;p>Alex Soto æ˜¯ Red Hat å¼€å‘äººå‘˜ç»éªŒæ€»ç›‘ã€‚ä»–å¯¹ Java ä¸–ç•Œï¼Œè½¯ä»¶è‡ªåŠ¨åŒ–å……æ»¡çƒ­æƒ…ï¼Œå¹¶ä¸”ä»–ç›¸ä¿¡å¼€æºè½¯ä»¶æ¨¡å‹ã€‚Soto æ˜¯ &lt;a href="https://www.manning.com/books/testing-java-microservices">Manning&lt;/a> çš„åˆè‘—è€… | &lt;a href="https://www.manning.com/books/testing-java-microservices">æµ‹è¯• Java å¾®æœåŠ¡&lt;/a>å’Œ &lt;a href="https://www.oreilly.com/library/view/quarkus-cookbook/9781492062646/">O&amp;rsquo;Reilly Quarkus Cookbook&lt;/a> å’Œå‡ ä¸ªå¼€æºé¡¹ç›®çš„è´¡çŒ®è€…ã€‚è‡ª 2017 å¹´ä»¥æ¥ä¸€ç›´æ˜¯ Java å† å†›ï¼Œä»–è¿˜æ˜¯ Salle URL University çš„å›½é™…æ¼”è®²è€…å’Œè€å¸ˆã€‚ä½ å¯ä»¥åœ¨ Twitter ï¼ˆAlex Sotoï¼‰ä¸Šå…³æ³¨ä»–ï¼Œä»¥éšæ—¶äº†è§£ Kubernetes å’Œ Java ä¸–ç•Œä¸­æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…ã€‚&lt;/p></description></item><item><title>å¼€ç®±å³ç”¨çš„ Prometheus å‘Šè­¦è§„åˆ™é›†</title><link>https://atbug.com/introduction-awesome-prometheus-alerts/</link><pubDate>Thu, 13 May 2021 08:01:00 +0800</pubDate><guid>https://atbug.com/introduction-awesome-prometheus-alerts/</guid><description>
&lt;p>åœ¨é…ç½®ç³»ç»Ÿç›‘æ§çš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯å³ä½¿ç»å°½è„‘æ±ç›‘æ§çš„ä¹Ÿè¿˜æ˜¯ä¸å¤Ÿå…¨é¢ï¼Œæˆ–è€…ä¸çŸ¥å¦‚ä½•è·å–æƒ³è¦çš„æŒ‡æ ‡ã€‚&lt;/p>
&lt;p>&lt;a href="https://awesome-prometheus-alerts.grep.to/">Awesome Prometheus alerts&lt;/a> ç»´æŠ¤äº†ä¸€å¥—å¼€ç®±å³ç”¨çš„ Prometheus å‘Šè­¦è§„åˆ™é›†åˆï¼Œæœ‰ 300 å¤šä¸ªå‘Šè­¦è§„åˆ™ã€‚åŒæ—¶ï¼Œè¿˜æ˜¯è¯´æ˜å¦‚ä½•è·å–å¯¹åº”çš„æŒ‡æ ‡ã€‚è¿™äº›è§„åˆ™ï¼Œå¯¹æ¯ä¸ª Prometheus éƒ½æ˜¯é€šç”¨çš„ã€‚&lt;/p>
&lt;p>æ¶‰åŠå¦‚ä¸»æœºã€ç¡¬ä»¶ã€å®¹å™¨ç­‰åŸºç¡€èµ„æºï¼Œåˆ°æ•°æ®åº“ã€æ¶ˆæ¯ä»£ç†ã€è¿è¡Œæ—¶ã€åå‘ä»£ç†ã€è´Ÿè´£å‡è¡¡å™¨ï¼Œè¿è¡Œæ—¶ã€æœåŠ¡ç¼–æ’ï¼Œç”šè‡³æ˜¯ç½‘ç»œå±‚é¢å’Œ Prometheus è‡ªèº«å’Œé›†ç¾¤ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/05/13/alertrulescover.png" alt="alert_rules">&lt;/p>
&lt;p>Prometheus çš„å®‰è£…å’Œé…ç½®ä¸åšèµ˜è¿°ï¼Œé…ç½®å¯ä»¥çœ‹&lt;a href="https://awesome-prometheus-alerts.grep.to/alertmanager">è¿™é‡Œ&lt;/a>ã€‚ä¸‹é¢ç®€å•çœ‹ä¸‹å‡ ä¸ªå¸¸ç”¨è§„åˆ™&lt;/p>
&lt;h3 id="ä¸»æœºå’Œç¡¬ä»¶èµ„æº">ä¸»æœºå’Œç¡¬ä»¶èµ„æº&lt;/h3>
&lt;p>ä¸»æœºå’Œç¡¬ä»¶èµ„æºçš„å‘Šè­¦ä¾èµ– &lt;a href="https://github.com/prometheus/node_exporter">node-exporter&lt;/a> è¾“å‡ºçš„æŒ‡æ ‡ã€‚ä¾‹å¦‚ï¼š&lt;/p>
&lt;h4 id="å†…å­˜ä¸è¶³">å†…å­˜ä¸è¶³&lt;/h4>
&lt;p>å¯ç”¨å†…å­˜ä½äºé˜ˆå€¼ &lt;code>10%&lt;/code> å°±ä¼šè§¦å‘å‘Šè­¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">HostOutOfMemory&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100 &amp;lt; 10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Host out of memory (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Node memory is filling up (&amp;lt; 10% left)\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="ä¸»æœºå¼‚å¸¸çš„ç½‘ç»œåå">ä¸»æœºå¼‚å¸¸çš„ç½‘ç»œåå&lt;/h5>
&lt;p>æœ€è¿‘ä¸¤åˆ†é’Ÿå…¥ç«™çš„æµé‡è¶…è¿‡ &lt;code>100m&lt;/code>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>rate&lt;/code> è¯­æ³•è§&lt;a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#rate">è¿™é‡Œ&lt;/a>ã€‚&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">HostUnusualNetworkThroughputIn&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sum by (instance) (rate(node_network_receive_bytes_total[2m])) / 1024 / 1024 &amp;gt; 100&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">5m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Host unusual network throughput in (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Host network interfaces are probably receiving too much data (&amp;gt; 100 MB/s)\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="mysql">Mysql&lt;/h3>
&lt;p>Mysql çš„å‘Šè­¦ä¾èµ– &lt;a href="https://github.com/prometheus/mysqld_exporter">prometheus/mysqld_exporter&lt;/a> è¾“å‡ºçš„æŒ‡æ ‡ã€‚&lt;/p>
&lt;h4 id="è¿æ¥æ•°è¿‡å¤š">è¿æ¥æ•°è¿‡å¤š&lt;/h4>
&lt;p>Mysql å®ä¾‹çš„è¿æ¥æ•°æœ€è¿‘ä¸€åˆ†é’Ÿçš„è¿æ¥æ•°è¶…è¿‡æœ€å¤§å€¼çš„ &lt;code>80%&lt;/code> è§¦å‘å‘Šè­¦&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">MysqlTooManyConnections(&amp;gt;80%)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">avg by (instance) (rate(mysql_global_status_threads_connected[1m])) / avg by (instance) (mysql_global_variables_max_connections) * 100 &amp;gt; 80&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">MySQL too many connections (&amp;gt; 80%) (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;More than 80% of MySQL connections are in use on {{ $labels.instance }}\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="æ…¢æŸ¥è¯¢">æ…¢æŸ¥è¯¢&lt;/h4>
&lt;p>æœ€è¿‘ä¸€åˆ†é’Ÿæ…¢æŸ¥è¯¢æ•°é‡å¤§äº 0 æ—¶è§¦å‘ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">MysqlSlowQueries&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">increase(mysql_global_status_slow_queries[1m]) &amp;gt; 0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">MySQL slow queries (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;MySQL server mysql has some new slow query.\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è¿è¡Œæ—¶-jvm">è¿è¡Œæ—¶ JVM&lt;/h3>
&lt;p>JVM çš„è¿è¡Œæ—¶å‘Šè­¦ï¼Œå±…ç„¶åªæœ‰å¯æ€œå·´å·´çš„ä¸€ä¸ªã€‚å †ç©ºé—´å ç”¨è¶…è¿‡ &lt;code>80%&lt;/code> è§¦å‘å‘Šè­¦ã€‚&lt;/p>
&lt;p>ä¾èµ– &lt;a href="https://github.com/prometheus/client_java">java-client&lt;/a> è¾“å‡ºçš„æŒ‡æ ‡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">JvmMemoryFillingUp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">(sum by (instance)(jvm_memory_used_bytes{area=&amp;#34;heap&amp;#34;}) / sum by (instance)(jvm_memory_max_bytes{area=&amp;#34;heap&amp;#34;})) * 100 &amp;gt; 80&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">JVM memory filling up (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;JVM memory is filling up (&amp;gt; 80%)\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="kubernetes">Kubernetes&lt;/h3>
&lt;p>Kubernetes ç›¸å…³çš„å‘Šè­¦è§„åˆ™æœ‰ 33 ä¸ªï¼Œæ¯”è¾ƒä¸°å¯Œã€‚&lt;/p>
&lt;p>æ‘˜ä¸ªæ¯”è¾ƒå¸¸è§çš„ï¼šå®¹å™¨OOMå‘Šè­¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">KubernetesContainerOomKiller&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">(kube_pod_container_status_restarts_total - kube_pod_container_status_restarts_total offset 10m &amp;gt;= 1) and ignoring (reason) min_over_time(kube_pod_container_status_last_terminated_reason{reason=&amp;#34;OOMKilled&amp;#34;}[10m]) == 1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">0m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Kubernetes container oom killer (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} has been OOMKilled {{ $value }} times in the last 10 minutes.\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ssl-è¯ä¹¦è¿‡æœŸ">SSL è¯ä¹¦è¿‡æœŸ&lt;/h3>
&lt;p>é€šè¿‡ &lt;a href="https://github.com/ribbybibby/ssl_exporter">&lt;/a> è¾“å‡ºçš„æŒ‡æ ‡ï¼Œå¯ä»¥ç›‘æ§è¯ä¹¦è¿‡æœŸï¼šæœªæ¥ &lt;code>7 å¤©&lt;/code> æœ‰è¯ä¹¦è¿‡æœŸä¾¿ä¼šè§¦å‘å‘Šè­¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>- &lt;span class="nt">alert&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">SslCertificateExpiry(&amp;lt;7Days)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ssl_verified_cert_not_after{chain_no=&amp;#34;0&amp;#34;} - time() &amp;lt; 86400 * 7&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">for&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">0m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">severity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">warning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">summary&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">SSL certificate expiry (&amp;lt; 7 days) (instance {{ $labels.instance }})&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ $labels.instance }} Certificate is expiring in 7 days\n VALUE = {{ $value }}\n LABELS = {{ $labels }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»Šå¤©åˆ—å‡ºæ¥çš„ä¹Ÿä»…ä»…æ˜¯å†°å±±ä¸€è§’ï¼Œè€Œä¸”ç”¨æˆ·ä¹Ÿå¯ä»¥&lt;a href="https://github.com/samber/awesome-prometheus-alerts#-contributing">è´¡çŒ®&lt;/a>å‡ºæ›´å¤šçš„è§„åˆ™ã€‚&lt;/p></description></item><item><title>Kubernetes ä¸Šå¦‚ä½•æ§åˆ¶å®¹å™¨çš„å¯åŠ¨é¡ºåºï¼Ÿ</title><link>https://atbug.com/k8s-1.18-container-start-sequence-control/</link><pubDate>Fri, 30 Apr 2021 07:43:54 +0800</pubDate><guid>https://atbug.com/k8s-1.18-container-start-sequence-control/</guid><description>
&lt;p>å»å¹´å†™è¿‡ä¸€ç¯‡åšå®¢ï¼š&lt;a href="https://mp.weixin.qq.com/s/5UXhXpwPDBh2xuGKq9Nqig">æ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº&lt;/a>ï¼Œåˆ†æäº† &lt;a href="https://github.com/tektoncd">TektonCD&lt;/a> çš„å®¹å™¨å¯åŠ¨æ§åˆ¶çš„åŸç†ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆè¦åšå®¹å™¨å¯åŠ¨é¡ºåºæ§åˆ¶ï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“ Pod ä¸­é™¤äº† &lt;code>init-container&lt;/code> ä¹‹å¤–ï¼Œæ˜¯å…è®¸æ·»åŠ å¤šä¸ªå®¹å™¨çš„ã€‚ç±»ä¼¼ TektonCD ä¸­ &lt;code>task&lt;/code> å’Œ &lt;code>step&lt;/code> çš„æ¦‚å¿µå°±åˆ†åˆ«ä¸ &lt;code>pod&lt;/code> å’Œ &lt;code>container&lt;/code> å¯¹åº”ï¼Œè€Œ &lt;code>step&lt;/code> æ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œçš„ã€‚æ­¤å¤–è¿˜æœ‰æœåŠ¡ç½‘æ ¼çš„åœºæ™¯ï¼Œsidecar å®¹å™¨éœ€è¦åœ¨æœåŠ¡å®¹å™¨å¯åŠ¨ä¹‹å‰å®Œæˆé…ç½®çš„åŠ è½½ï¼Œä¹Ÿéœ€è¦å¯¹å®¹å™¨çš„å¯åŠ¨é¡ºåºåŠ ä»¥æ§åˆ¶ã€‚å¦åˆ™ï¼ŒæœåŠ¡å®¹å™¨å…ˆå¯åŠ¨ï¼Œè€Œ sidecar è¿˜æ— æ³•æä¾›ç½‘ç»œä¸Šçš„æ”¯æŒã€‚&lt;/p>
&lt;h3 id="ç°å®">ç°å®&lt;/h3>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/sidecarlifecycle1.gif" alt="sidecar-lifecycle-1">&lt;/p>
&lt;h3 id="æœŸæœ›">æœŸæœ›&lt;/h3>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/sidecarlifecycle2.gif" alt="sidecar-lifecycle-2">&lt;/p>
&lt;p>åˆ°äº†è¿™é‡Œè‚¯å®šæœ‰åŒå­¦ä¼šé—®ï¼Œ&lt;code>spec.containers[]&lt;/code> æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„æ˜¯æœ‰é¡ºåºçš„ã€‚Kubernetes ä¹Ÿç¡®å®æ˜¯æŒ‰ç…§é¡ºåºæ¥åˆ›å»ºå’Œå¯åŠ¨å®¹å™¨ï¼Œä½†æ˜¯ &lt;strong>å®¹å™¨å¯åŠ¨æˆåŠŸï¼Œå¹¶ä¸è¡¨ç¤ºå®¹å™¨å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡&lt;/strong>ã€‚&lt;/p>
&lt;p>åœ¨ Kubernetes 1.18 éæ­£å¼ç‰ˆä¸­æ›¾åœ¨ Lifecycle å±‚é¢æä¾›äº†å¯¹ &lt;code>sidecar ç±»å‹å®¹å™¨çš„&lt;/code> æ”¯æŒï¼Œä½†æ˜¯æœ€ç»ˆè¯¥åŠŸèƒ½å¹¶&lt;a href="https://github.com/kubernetes/enhancements/issues/753#issuecomment-713471597">æ²¡æœ‰è½åœ°&lt;/a>ã€‚&lt;/p>
&lt;p>é‚£åˆ°åº•è¯¥æ€ä¹ˆåšï¼Ÿ&lt;/p>
&lt;h2 id="tldr">TL;DR&lt;/h2>
&lt;p>ç¬”è€…å‡†å¤‡äº†ä¸€ä¸ªç®€å•çš„ &lt;a href="https://github.com/addozhang/k8s-container-sequence-sample">go é¡¹ç›®&lt;/a>ï¼Œç”¨äºæ¨¡æ‹Ÿ sidecar çš„å¯åŠ¨åŠé…ç½®åŠ è½½ã€‚&lt;/p>
&lt;p>å…‹éš†ä»£ç åå¯ä»¥é€šè¿‡ &lt;code>make build&lt;/code> æ„å»ºå‡ºé•œåƒï¼Œå‡å¦‚ä½ æ˜¯ç”¨çš„ minikube è¿›è¡Œçš„å®éªŒï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ &lt;code>make load-2-minikube&lt;/code> å°†é•œåƒåŠ è½½åˆ° minikube èŠ‚ç‚¹ä¸­ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ Deployment çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ï¼Œç›´æ¥ç”¨ Pod ä¹Ÿå¯ä»¥ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">strategy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">addozhang/k8s-container-sequence-sidecar:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sidecar&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">IfNotPresent&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">lifecycle&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">postStart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">exec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">wait&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">busybox:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">app&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">IfNotPresent&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/bin/sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;-c&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;date; echo &amp;#39;app container started&amp;#39;; tail -f /dev/null&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸‹é¢çš„æˆªå›¾ä¸­ï¼Œæ¼”ç¤ºäº†åœ¨ &lt;code>sample&lt;/code> å‘½åç©ºé—´ä¸­ï¼Œpod å†…ä¸¤ä¸ªå®¹å™¨çš„æ‰§è¡Œé¡ºåºã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/20210430-062819.gif" alt="2021-04-30 06.28.19">&lt;/p>
&lt;h2 id="kubernetes-æºç ">Kubernetes æºç &lt;/h2>
&lt;p>åœ¨ kubelet çš„æºç  &lt;code>pkg/kubelet/kuberuntime/kuberuntime_manager.go&lt;/code> ä¸­ï¼Œ&lt;code>#SyncPod&lt;/code> æ–¹æ³•ç”¨äºåˆ›å»º Podï¼Œæ­¥éª¤æ¯”è¾ƒç¹çï¼Œç›´æ¥çœ‹ç¬¬ 7 æ­¥ï¼šåˆ›å»ºæ™®é€šå®¹å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// SyncPod syncs the running pod into the desired pod by executing following steps:
&lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">// 1. Compute sandbox and container changes.
&lt;/span>&lt;span class="c1">// 2. Kill pod sandbox if necessary.
&lt;/span>&lt;span class="c1">// 3. Kill any containers that should not be running.
&lt;/span>&lt;span class="c1">// 4. Create sandbox if necessary.
&lt;/span>&lt;span class="c1">// 5. Create ephemeral containers.
&lt;/span>&lt;span class="c1">// 6. Create init containers.
&lt;/span>&lt;span class="c1">// 7. Create normal containers.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubeGenericRuntimeManager&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SyncPod&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pod&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podStatus&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubecontainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodStatus&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pullSecrets&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Secret&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">backOff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">flowcontrol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Backoff&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span> &lt;span class="nx">kubecontainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodSyncResult&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="c1">// Step 7: start containers in podContainerChanges.ContainersToStart.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">idx&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">podContainerChanges&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ContainersToStart&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;container&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">containerStartSpec&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">pod&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Containers&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">idx&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ &lt;code>#start&lt;/code> æ–¹æ³•ä¸­è°ƒç”¨äº† &lt;code>#startContainer&lt;/code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå¯åŠ¨å®¹å™¨ï¼Œå¹¶è¿”å›å®¹å™¨å¯åŠ¨çš„ç»“æœã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ç»“æœè¿˜ &lt;strong>åŒ…å«äº†å®¹å™¨çš„ Lifecycle hooks è°ƒç”¨&lt;/strong>ã€‚&lt;/p>
&lt;p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚å®¹å™¨çš„ &lt;code>PostStart&lt;/code> hook æ²¡æœ‰æ­£ç¡®çš„è¿”å›ï¼Œkubelet ä¾¿ä¸ä¼šå»åˆ›å»ºä¸‹ä¸€ä¸ªå®¹å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// startContainer starts a container and returns a message indicates why it is failed on error.
&lt;/span>&lt;span class="c1">// It starts the container through the following steps:
&lt;/span>&lt;span class="c1">// * pull the image
&lt;/span>&lt;span class="c1">// * create the container
&lt;/span>&lt;span class="c1">// * start the container
&lt;/span>&lt;span class="c1">// * run the post start lifecycle hooks (if applicable)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubeGenericRuntimeManager&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">startContainer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">podSandboxID&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podSandboxConfig&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">runtimeapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodSandboxConfig&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">spec&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">startSpec&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pod&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podStatus&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubecontainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodStatus&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pullSecrets&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Secret&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podIP&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">podIPs&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="c1">// Step 4: execute the post start hook.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lifecycle&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lifecycle&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PostStart&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">kubeContainerID&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">kubecontainer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ContainerID&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">runtimeName&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">containerID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">handlerErr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">runner&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">kubeContainerID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lifecycle&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PostStart&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">handlerErr&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">recordContainerEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">kubeContainerID&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventTypeWarning&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">events&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FailedPostStartHook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">killContainer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pod&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">kubeContainerID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;FailedPostStartHook&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reasonFailedPostStartHook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ErrorS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%s: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ErrPostStartHook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">handlerErr&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;Failed to kill container&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;pod&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">KObj&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pod&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="s">&amp;#34;podUID&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pod&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;containerName&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;containerID&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">kubeContainerID&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%s: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ErrPostStartHook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">handlerErr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å®ç°æ–¹æ¡ˆ">å®ç°æ–¹æ¡ˆ&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/16197365667225.jpg" alt="">&lt;/p>
&lt;p>&lt;a href="https://github.com/addozhang/k8s-container-sequence-sample/blob/main/cmd/entrypoint/wait.go#L26">cmd/entrypoint/wait.go#L26&lt;/a> ï¼ˆè¿™é‡Œå‚è€ƒäº† Istio çš„ pilot-agent å®ç° ï¼‰&lt;/p>
&lt;p>åœ¨ &lt;code>PostStart&lt;/code> ä¸­æŒç»­çš„å»æ£€æŸ¥ &lt;code>/ready&lt;/code> æ–­ç‚¹ï¼Œå¯ä»¥ hold ä½å½“å‰å®¹å™¨çš„åˆ›å»ºæµç¨‹ã€‚ä¿è¯ &lt;code>/ready&lt;/code> è¿”å› &lt;code>200&lt;/code> åï¼Œkubelet æ‰ä¼šå»åˆ›å»ºä¸‹ä¸€ä¸ªå®¹å™¨ã€‚&lt;/p>
&lt;p>è¿™æ ·å°±è¾¾åˆ°äº†å‰é¢æˆªå›¾ä¸­æ¼”ç¤ºçš„æ•ˆæœã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Before&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">timeoutAt&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">checkIfReady&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">url&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sidecar is ready&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sidecar is not ready&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">periodMillis&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Millisecond&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sidecar is not ready in %d second(s)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">timeoutSeconds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://banzaicloud.com/blog/k8s-sidecars/">Sidecar container lifecycle changes in Kubernetes 1.18&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://medium.com/@marko.luksa/delaying-application-start-until-sidecar-is-ready-2ec2d21a7b74">Delaying application start until sidecar is ready&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>äº‘ä¸Šç»†ç²’åº¦è®¿é—®ç®¡ç†çš„å‚è€ƒæ¶æ„</title><link>https://atbug.com/translation-access-management-reference-architecture/</link><pubDate>Wed, 28 Apr 2021 08:02:11 +0800</pubDate><guid>https://atbug.com/translation-access-management-reference-architecture/</guid><description>
&lt;p>æœ¬æ–‡ç”± &lt;a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&amp;amp;__biz=MjM5OTg2MTM0MQ==&amp;amp;scene=124#wechat_redirect">Addo Zhang&lt;/a> ç¿»è¯‘è‡ª &lt;a href="https://www.infoq.com/articles/access-management-reference-architecture/">A Reference Architecture for Fine-Grained Access Management on the Cloud&lt;/a>&lt;/p>
&lt;h1 id="ä»€ä¹ˆæ˜¯è®¿é—®ç®¡ç†">ä»€ä¹ˆæ˜¯è®¿é—®ç®¡ç†ï¼Ÿ&lt;/h1>
&lt;p>è®¿é—®ç®¡ç†æ˜¯è¯†åˆ«ç”¨æˆ·æˆ–ä¸€ç»„ç”¨æˆ·æ˜¯å¦åº”è¯¥èƒ½å¤Ÿè®¿é—®ç»™å®šèµ„æºï¼ˆä¾‹å¦‚ä¸»æœºã€æœåŠ¡æˆ–æ•°æ®åº“ï¼‰çš„è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼Œå¯¹äºå¼€å‘äººå‘˜æ¥è¯´æ˜¯å¦å¯ä»¥ä½¿ç”¨ SSH ç™»å½•ç”Ÿäº§åº”ç”¨ç¨‹åºæœåŠ¡å™¨ï¼Œå¦‚æœå¯ä»¥ï¼Œé‚£ä¹ˆå¯ä»¥ç™»å½•å¤šé•¿æ—¶é—´ï¼Ÿå¦‚æœ SRE åœ¨éæ”¯æŒæ—¶é—´å°è¯•è®¿é—®æ•°æ®åº“ï¼Œä»–ä»¬è¿™æ ·åšï¼Ÿå¦‚æœæ•°æ®å·¥ç¨‹å¸ˆå·²è½¬ç§»åˆ°å…¶ä»–å›¢é˜Ÿï¼Œä»–ä»¬æ˜¯å¦åº”è¯¥ç»§ç»­è®¿é—® ETL ç®¡é“çš„ S3 å­˜å‚¨æ¡¶ï¼Ÿ&lt;/p>
&lt;h1 id="ç°åœ¨å¦‚ä½•è¿›è¡Œè®¿é—®ç®¡ç†">ç°åœ¨å¦‚ä½•è¿›è¡Œè®¿é—®ç®¡ç†ï¼Ÿ&lt;/h1>
&lt;p>åœ¨äº‘ä¸Šå„ç§åŸºç¡€è®¾æ–½å’Œæ•°æ®æœåŠ¡æ¿€å¢ä¹‹å‰ï¼Œè®¿é—®ç®¡ç†æ˜¯ DevOps å’Œ Security å›¢é˜Ÿè¦è§£å†³çš„ç›¸å¯¹ç®€å•çš„é—®é¢˜ã€‚VPN å’Œå ¡å’ä¸»æœºæ˜¯ï¼ˆç°åœ¨ä»ç„¶æ˜¯ï¼‰åœ¨ç½‘ç»œçº§åˆ«å°é”æ‰€æœ‰å…³é”®èµ„æºçš„é¦–é€‰æœºåˆ¶ã€‚ç”¨æˆ·å¿…é¡»å…ˆé€šè¿‡ VPN æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ï¼Œæˆ–è€…ç™»å½•åˆ°å ¡å’ä¸»æœºï¼Œç„¶åæ‰èƒ½è®¿é—®ä¸“ç”¨ç½‘ç»œä¸Šçš„æ‰€æœ‰èµ„æºã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/27/16195301216852.jpg" alt="">&lt;/p>
&lt;p>å½“èµ„æºæ˜¯é™æ€çš„å¹¶ä¸”å®ƒä»¬çš„æ•°é‡ç›¸å¯¹è¾ƒå°æ—¶ï¼Œæ­¤æ–¹æ³•æ•ˆæœå¾ˆå¥½ã€‚ä½†æ˜¯ï¼Œéšç€è¶Šæ¥è¶Šå¤šçš„èµ„æºåŠ¨æ€åœ°æ¶Œå…¥ä¸“ç”¨ç½‘ç»œçš„å„å¤„ï¼ŒVPN / å ¡å’ä¸»æœºè§£å†³æ–¹æ¡ˆå˜å¾—ç«™ä¸ä½è„šã€‚&lt;/p>
&lt;p>å…·ä½“æ¥è¯´ï¼Œåœ¨ä¸‰ä¸ªæ–¹é¢ï¼ŒVPN å’Œå ¡å’ä¸»æœºä¸è¶³ä»¥ä½œä¸ºä¸€ç§æœ‰æ•ˆçš„è®¿é—®ç®¡ç†æœºåˆ¶ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;strong>å®ƒä»¬ä½œç”¨äºç½‘ç»œå±‚é¢&lt;/strong>ï¼šç”¨æˆ·é€šè¿‡ VPN è¿›è¡Œèº«ä»½éªŒè¯å¹¶è·å¾—å¯¹ä¸“ç”¨ç½‘ç»œçš„è®¿é—®æƒé™åï¼Œä»–ä»¬å®é™…ä¸Šå°±å¯ä»¥è®¿é—®å…¶ä¸Šè¿è¡Œçš„æ‰€æœ‰æœåŠ¡ã€‚æ— æ³•æ ¹æ®ç”¨æˆ·çš„èº«ä»½åœ¨åŸºç¡€æ¶æ„æˆ–æ•°æ®æœåŠ¡çš„ç²’åº¦ä¸Šç®¡ç†è®¿é—®ã€‚&lt;/li>
&lt;li>&lt;strong>å‡­æ®æ˜¯æ”»å‡»çš„åª’ä»‹&lt;/strong>ï¼šVPN å’Œå ¡å’ä¸»æœºéƒ½è¦æ±‚ç”¨æˆ·è®°ä½å¹¶å­˜å‚¨å‡­æ®ã€‚è¿‡æœŸå’Œè½®æ¢å‡­è¯ä½œä¸ºå®‰å…¨ç­–ç•¥éå¸¸å›°éš¾ï¼Œå°¤å…¶æ˜¯åœ¨æ¶‰åŠå¤§é‡ç”¨æˆ·çš„æƒ…å†µä¸‹ï¼Œå‡­è¯å› æ­¤æˆä¸ºæ½œåœ¨çš„æ”»å‡»åª’ä»‹ã€‚&lt;/li>
&lt;li>&lt;strong>ä¸èƒ½ç®¡ç†ç¬¬ä¸‰æ–¹ SaaS å·¥å…·&lt;/strong>ï¼šSaaS å·¥å…·ï¼ˆå¦‚ Lookerã€Tableau å’Œ Periscope Dataï¼‰éœ€è¦ç›´æ¥è®¿é—®æ•°æ®ç«¯ç‚¹ã€‚å› æ­¤ï¼Œä½¿ç”¨è¿™äº›å·¥å…·è®¿é—®æ•°æ®çš„ä»»ä½•äººéƒ½æ— æ³•é€šè¿‡ä½¿ç”¨äº†ç›¸åŒçš„æœºåˆ¶å’Œå‡­æ®çš„åŸºç¡€è®¾æ–½è¿›è¡Œèº«ä»½éªŒè¯ã€‚&lt;/li>
&lt;/ul>
&lt;h1 id="äº‘ä¸Šè®¿é—®ç®¡ç†çš„æ–°æ¶æ„">äº‘ä¸Šè®¿é—®ç®¡ç†çš„æ–°æ¶æ„&lt;/h1>
&lt;p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å®šä¹‰æ–°çš„å‚è€ƒæ¶æ„ï¼Œä¸ºé‚£äº›æ­£åœ¨å¯»æ±‚ç®€åŒ–è®¿é—®ç®¡ç†äº‘èµ„æºï¼ˆä» SSH ä¸»æœºã€æ•°æ®åº“ã€æ•°æ®ä»“åº“åˆ°æ¶ˆæ¯ç®¡é“å’Œäº‘å­˜å‚¨ç»ˆç»“ç‚¹ï¼‰è§£å†³æ–¹æ¡ˆçš„äº‘åŸç”Ÿä¼ä¸šã€‚&lt;/p>
&lt;p>å®ƒè§£å†³äº† VPN å’Œå ¡å’ä¸»æœºæ— æ³•å…‹æœçš„ä»¥ä¸‹ç‰¹å®šæŒ‘æˆ˜ï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨ç»†ç²’åº¦çš„æœåŠ¡çº§åˆ«ä¸Šè¿›è¡Œè®¿é—®é‰´æƒ&lt;/li>
&lt;li>æ¶ˆé™¤å…±äº«å‡­æ®å’Œä¸ªäººå¸æˆ·ç®¡ç†&lt;/li>
&lt;li>é€šè¿‡ç¬¬ä¸‰æ–¹ SaaS å·¥å…·æ§åˆ¶è®¿é—®&lt;/li>
&lt;/ul>
&lt;p>æ­¤å¤–ï¼Œå®ƒä¸ºå…·æœ‰æ•æ„Ÿæ•°æ®çš„ç»„ç»‡å¸¦æ¥ä»¥ä¸‹å•†ä¸šåˆ©ç›Šï¼š&lt;/p>
&lt;ul>
&lt;li>é€šè¿‡è·¨æ‰€æœ‰æœåŠ¡çš„ä¼šè¯è®°å½•å’Œæ´»åŠ¨ç›‘è§†æ¥æ»¡è¶³ FedRamp å’Œ SOC2 ç­‰åˆè§„æ€§æ ‡å‡†çš„å¯å®¡æ ¸æ€§&lt;/li>
&lt;li>åŸºäºè®¿é—®è€…çš„èº«ä»½ï¼Œé€šè¿‡ç»†ç²’åº¦çš„æˆæƒç­–ç•¥æ¥é™åˆ¶æˆ–æ¸…é™¤æ•æ„Ÿæ•°æ®ï¼Œä»è€Œå®ç°éšç§å’Œæ•°æ®æ²»ç†&lt;/li>
&lt;/ul>
&lt;p>è¯¥æ¶æ„å»ºç«‹åœ¨ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒåŸåˆ™çš„åŸºç¡€ä¸Šï¼Œè¿™äº›åŸåˆ™çš„å®ç°ä½¿ DevOps å’Œ Security å›¢é˜Ÿå¯ä»¥åœ¨å¯¹æ‰€æœ‰ç¯å¢ƒè¿›è¡Œå…¨é¢æ§åˆ¶çš„åŒæ—¶ï¼Œé€šè¿‡ç®€å•è€Œä¸€è‡´çš„ä½“éªŒæ¥æé«˜ç”¨æˆ·çš„å·¥ä½œæ•ˆç‡ã€‚&lt;/p>
&lt;ul>
&lt;li>ä¸ºè®¿é—®èµ„æºçš„ç”¨æˆ·å»ºç«‹ä¸å¯å¦è®¤çš„èº«ä»½&lt;/li>
&lt;li>ä½¿ç”¨çŸ­æœŸçš„çŸ­æš‚ä»¤ç‰Œå’Œè¯ä¹¦ä»£æ›¿é™æ€å‡­è¯å’Œå¯†é’¥&lt;/li>
&lt;li>åœ¨ä¸€å¤„é›†ä¸­æ‰€æœ‰èµ„æºç±»å‹çš„ç»†ç²’åº¦è®¿é—®ç­–ç•¥&lt;/li>
&lt;/ul>
&lt;p>ä¸‹å›¾æ˜¾ç¤ºäº†å‚è€ƒæ¶æ„åŠå…¶ç»„ä»¶ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/27/16195323349746.jpg" alt="">&lt;/p>
&lt;p>ä¸Šå›¾ä¸­çš„ VPN / å ¡å’ä¸»æœºå·²æ›¿æ¢ä¸ºæ¥å…¥ç½‘å…³ï¼ˆAccess Gatewayï¼‰ã€‚æ¥å…¥ç½‘å…³å®é™…ä¸Šæ˜¯å¾®æœåŠ¡çš„é›†åˆï¼Œè´Ÿè´£éªŒè¯å•ä¸ªç”¨æˆ·ã€åŸºäºç‰¹å®šå±æ€§æˆæƒä»–ä»¬çš„è¯·æ±‚ï¼Œå¹¶æœ€ç»ˆæˆäºˆä»–ä»¬è®¿é—®ä¸“ç”¨ç½‘ç»œä¸­çš„åŸºç¡€ç»“æ„å’Œæ•°æ®æœåŠ¡çš„æƒé™ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å„ä¸ªç»„ä»¶ï¼Œä»¥äº†è§£ä¹‹å‰æ¦‚æ‹¬çš„æ ¸å¿ƒåŸç†æ˜¯å¦‚ä½•å®ç°çš„ã€‚&lt;/p>
&lt;h2 id="è®¿é—®æ§åˆ¶å™¨">è®¿é—®æ§åˆ¶å™¨&lt;/h2>
&lt;p>æ”¯æŒæ­¤ä½“ç³»ç»“æ„çš„å…³é”®è§è§£æ˜¯å°†ç”¨æˆ·èº«ä»½éªŒè¯å§”æ´¾ç»™å•ä¸ªæœåŠ¡ï¼ˆè®¿é—®æ§åˆ¶å™¨ï¼‰ï¼Œè€Œä¸æ˜¯å°†è´£ä»»åˆ†é…ç»™ç”¨æˆ·å¯èƒ½éœ€è¦è®¿é—®çš„æœåŠ¡ã€‚è¿™ç§è”åˆåœ¨ SaaS åº”ç”¨ç¨‹åºä¸–ç•Œä¸­å¾ˆå¸¸è§ã€‚ç”±å•ä¸€æœåŠ¡è´Ÿè´£èº«ä»½éªŒè¯ï¼Œå¯ä»¥ç®€åŒ–åº”ç”¨ç¨‹åºæ‰€æœ‰è€…çš„ç”¨æˆ·é…ç½®å’Œæ¥è§¦é…ç½®ï¼Œå¹¶åŠ å¿«åº”ç”¨ç¨‹åºå¼€å‘ã€‚&lt;/p>
&lt;p>å¯¹äºå®é™…çš„èº«ä»½éªŒè¯åºåˆ—ï¼Œè®¿é—®æ§åˆ¶å™¨æœ¬èº«é€šå¸¸ä¼šä¸èº«ä»½æä¾›å•†é›†æˆï¼Œä¾‹å¦‚ &lt;a href="https://auth0.com/">Auth0&lt;/a> æˆ– &lt;a href="https://www.okta.com/">Okta&lt;/a>ï¼Œå› æ­¤ï¼Œå¯ä»¥è·¨æä¾›è€…å’Œåè®®æä¾›æœ‰ç”¨çš„æŠ½è±¡ã€‚æœ€ç»ˆï¼Œèº«ä»½æä¾›å•†ä»¥ç­¾åçš„ SAML å£°æ˜\JWT ä»¤ç‰Œæˆ–ä¸´æ—¶è¯ä¹¦çš„å½¢å¼ä¿è¯ç”¨æˆ·çš„èº«ä»½ä¸å¯å¦è®¤ã€‚è¿™æ ·å°±æ— éœ€ä¾èµ–å—ä¿¡ä»»çš„å­ç½‘ä½œä¸ºç”¨æˆ·èº«ä»½çš„ä»£ç†ã€‚ä¸ VPN å…è®¸ç”¨æˆ·è®¿é—®ç½‘ç»œä¸Šçš„æ‰€æœ‰æœåŠ¡ä¸åŒï¼Œå®ƒè¿˜å…è®¸å°†è®¿é—®ç­–ç•¥é…ç½®åˆ°æœåŠ¡çš„ç²’åº¦ã€‚&lt;/p>
&lt;p>å°†èº«ä»½éªŒè¯å§”æ´¾ç»™èº«ä»½æä¾›è€…çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¯ä»¥ä½¿ç”¨é›¶ä¿¡ä»»åŸåˆ™å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ã€‚ å…·ä½“æ¥è¯´ï¼Œå¯ä»¥åˆ›å»ºèº«ä»½æä¾›è€…ç­–ç•¥ä»¥å¼ºåˆ¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š&lt;/p>
&lt;ul>
&lt;li>ç¦æ­¢ä»ä¿¡èª‰ä¸ä½³çš„åœ°ç†ä½ç½®å’Œ IP åœ°å€è®¿é—®&lt;/li>
&lt;li>ç¦æ­¢ä»å·²çŸ¥æ¼æ´çš„è®¾å¤‡ï¼ˆæœªä¿®è¡¥çš„ OSã€è¾ƒæ—§çš„æµè§ˆå™¨ç­‰ï¼‰è¿›è¡Œè®¿é—®&lt;/li>
&lt;li>æˆåŠŸè¿›è¡Œ SAML äº¤æ¢åç«‹å³è§¦å‘ MFA&lt;/li>
&lt;/ul>
&lt;h3 id="èº«ä»½éªŒè¯åºåˆ—å¦‚ä½•å·¥ä½œ">èº«ä»½éªŒè¯åºåˆ—å¦‚ä½•å·¥ä½œï¼š&lt;/h3>
&lt;ol>
&lt;li>ç”¨æˆ·é¦–å…ˆé€šè¿‡è®¿é—®æ§åˆ¶å™¨è¿›è¡Œèº«ä»½éªŒè¯ï¼Œè®¿é—®æ§åˆ¶å™¨åˆå°†èº«ä»½éªŒè¯å§”æ´¾ç»™èº«ä»½æä¾›è€…ã€‚&lt;/li>
&lt;li>æˆåŠŸç™»å½•åˆ°èº«ä»½æä¾›è€…åï¼Œè®¿é—®æ§åˆ¶å™¨å°†ç”Ÿæˆä¸€ä¸ªçŸ­æš‚çš„ä¸´æ—¶è¯ä¹¦ï¼Œè¿›è¡Œç­¾åå¹¶å°†å…¶è¿”å›ç»™ç”¨æˆ·ã€‚æˆ–è€…ï¼Œå®ƒå¯ä»¥ä»£æ›¿è¯ä¹¦ç”Ÿæˆä»¤ç‰Œã€‚åªè¦è¯ä¹¦æˆ–ä»¤ç‰Œæœ‰æ•ˆï¼Œå°±å¯ä»¥å°†å…¶ç”¨äºè¿æ¥åˆ° æ¥å…¥ç½‘å…³ç®¡ç†çš„ä»»ä½•æˆæƒåŸºç¡€è®¾æ–½æˆ–æ•°æ®æœåŠ¡ã€‚åˆ°æœŸåï¼Œå¿…é¡»è·å–æ–°çš„è¯ä¹¦æˆ–ä»¤ç‰Œã€‚&lt;/li>
&lt;li>ç”¨æˆ·å°†åœ¨æ­¥éª¤ï¼ˆ2ï¼‰ä¸­è·å¾—çš„è¯ä¹¦ä¼ é€’ç»™ä»–ä»¬é€‰æ‹©çš„å·¥å…·ï¼Œç„¶åè¿æ¥åˆ°æ¥å…¥ç½‘å…³ã€‚æ ¹æ®ç”¨æˆ·è¯·æ±‚è®¿é—®çš„æœåŠ¡ï¼ŒåŸºç¡€è®¾æ–½ç½‘å…³æˆ–æ•°æ®ç½‘å…³å°†é¦–å…ˆå…è®¸è®¿é—®æ§åˆ¶å™¨éªŒè¯ç”¨æˆ·çš„è¯ä¹¦ï¼Œç„¶åå†å…è®¸ä»–ä»¬è®¿é—®è¯¥æœåŠ¡ã€‚å› æ­¤ï¼Œè®¿é—®æ§åˆ¶å™¨å……å½“ç”¨æˆ·ä¸å…¶è®¿é—®çš„æœåŠ¡ä¹‹é—´çš„ CAï¼Œå› æ­¤ä¸ºæ¯ä¸ªç”¨æˆ·æä¾›äº†ä¸å¯å¦è®¤çš„èº«ä»½ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="ç­–ç•¥å¼•æ“">ç­–ç•¥å¼•æ“&lt;/h2>
&lt;p>å½“è®¿é—®æ§åˆ¶å™¨å¼ºåˆ¶å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼Œç­–ç•¥å¼•æ“ä¼šå¯¹ç”¨æˆ·çš„è¯·æ±‚å¼ºåˆ¶è¿›è¡Œç»†ç²’åº¦çš„æˆæƒã€‚å®ƒä»¥æ˜“äºä½¿ç”¨çš„ YAML è¯­æ³•æ¥å—æˆæƒè§„åˆ™ï¼ˆæŸ¥çœ‹æœ€åçš„ç¤ºä¾‹ï¼‰ï¼Œå¹¶æ ¹æ®ç”¨æˆ·è¯·æ±‚å’Œå“åº”å¯¹å®ƒä»¬è¿›è¡Œè¯„ä¼°ã€‚&lt;/p>
&lt;p>å¼€æ”¾ç­–ç•¥ä»£ç†ï¼ˆOPAï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„ CNCF é¡¹ç›®ï¼Œæ˜¯ç­–ç•¥å¼•æ“çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚å®ƒå¯ä»¥è‡ªå·±ä½œä¸ºå¾®æœåŠ¡è¿è¡Œï¼Œä¹Ÿå¯ä»¥ç”¨ä½œå…¶ä»–å¾®æœåŠ¡è¿›ç¨‹ç©ºé—´ä¸­çš„åº“ã€‚OPA ä¸­çš„ç­–ç•¥ä»¥ç§°ä¸º Rego çš„è¯­è¨€ç¼–å†™ã€‚å¦å¤–ï¼Œä¹Ÿå¯ä»¥åœ¨ Rego ä¹‹ä¸Šè½»æ¾æ„å»ºä¸€ä¸ªç®€å•çš„ YAML ç•Œé¢ï¼Œä»¥ç®€åŒ–æ”¿ç­–è§„èŒƒã€‚&lt;/p>
&lt;p>å…·æœ‰ç‹¬ç«‹äºåŸºç¡€ç»“æ„å’Œæ•°æ®æœåŠ¡çš„å®‰å…¨æ¨¡å‹çš„ç‹¬ç«‹ç­–ç•¥å¼•æ“çš„ä¼˜ç‚¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯ä»¥ä»¥ä¸æœåŠ¡å’Œä½ç½®æ— å…³çš„æ–¹å¼æŒ‡å®šå®‰å…¨ç­–ç•¥
&lt;ul>
&lt;li>ä¾‹å¦‚åœ¨æ‰€æœ‰ SSH æœåŠ¡å™¨ä¸Šç¦æ­¢ç‰¹æƒå‘½ä»¤&lt;/li>
&lt;li>ä¾‹å¦‚å¼ºåˆ¶æ‰§è¡Œ MFA æ£€æŸ¥æ‰€æœ‰æœåŠ¡ï¼ˆåŸºç¡€è®¾æ–½å’Œæ•°æ®ï¼‰&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ç­–ç•¥å¯ä»¥ä¿å­˜åœ¨ä¸€ä¸ªåœ°æ–¹å¹¶è¿›è¡Œç‰ˆæœ¬æ§åˆ¶
&lt;ul>
&lt;li>ç­–ç•¥å¯ä»¥ä½œä¸ºä»£ç ç­¾å…¥ GitHub å­˜å‚¨åº“&lt;/li>
&lt;li>æ¯é¡¹å˜æ›´åœ¨æäº¤ä¹‹å‰éƒ½è¦ç»è¿‡åä½œå®¡æ ¸æµç¨‹&lt;/li>
&lt;li>å­˜åœ¨ç‰ˆæœ¬å†å²è®°å½•ï¼Œå¯ä»¥è½»æ¾åœ°è¿˜åŸç­–ç•¥æ›´æ”¹&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>åŸºç¡€è®¾æ–½ç½‘å…³å’Œæ•°æ®ç½‘å…³éƒ½ä¾èµ–äºç­–ç•¥å¼•æ“ï¼Œä»¥åˆ†åˆ«è¯„ä¼°ç”¨æˆ·çš„åŸºç¡€è®¾æ–½å’Œæ•°æ®æ´»åŠ¨ã€‚&lt;/p>
&lt;h2 id="åŸºç¡€è®¾æ–½ç½‘å…³">åŸºç¡€è®¾æ–½ç½‘å…³&lt;/h2>
&lt;p>åŸºç¡€è®¾æ–½ç½‘å…³ç®¡ç†å’Œç›‘æ§å¯¹åŸºç¡€è®¾æ–½æœåŠ¡çš„è®¿é—®ï¼Œä¾‹å¦‚ SSH æœåŠ¡å™¨å’Œ Kubernetes é›†ç¾¤ã€‚å®ƒä¸ç­–ç•¥å¼•æ“è¿æ¥ï¼Œä»¥ç¡®å®šç»†åŒ–çš„æˆæƒè§„åˆ™ï¼Œå¹¶åœ¨ç”¨æˆ·ä¼šè¯æœŸé—´å¯¹æ‰€æœ‰åŸºç¡€è®¾æ–½æ´»åŠ¨å¼ºåˆ¶æ‰§è¡Œè¿™äº›è§„åˆ™ã€‚ ä¸ºäº†å®ç°è´Ÿè½½å¹³è¡¡ï¼Œç½‘å…³å¯ä»¥åŒ…å«ä¸€ç»„å·¥ä½œèŠ‚ç‚¹ï¼Œå¯ä»¥åœ¨ AWS ä¸Šéƒ¨ç½²ä¸ºè‡ªåŠ¨æ‰©å±•ç»„ï¼Œä¹Ÿå¯ä»¥åœ¨ Kubernetes é›†ç¾¤ä¸Šä½œä¸ºå‰¯æœ¬é›†è¿è¡Œã€‚&lt;/p>
&lt;p>&lt;a href="https://www.boundaryproject.io/">Hashicorp è¾¹ç•Œ&lt;/a> æ˜¯åŸºç¡€è®¾æ–½ç½‘å…³çš„ç¤ºä¾‹ã€‚è¿™æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œä½¿å¼€å‘äººå‘˜ã€DevOps å’Œ SRE å¯ä»¥ä½¿ç”¨ç»†ç²’åº¦çš„æˆæƒæ¥å®‰å…¨åœ°è®¿é—®åŸºç¡€è®¾æ–½æœåŠ¡ï¼ˆSSH æœåŠ¡å™¨ã€Kubernetes ç¾¤é›†ï¼‰ï¼Œè€Œæ— éœ€ç›´æ¥è®¿é—®ç½‘ç»œï¼ŒåŒæ—¶åˆç¦æ­¢ä½¿ç”¨ VPN æˆ–å ¡å’ä¸»æœºã€‚&lt;/p>
&lt;p>åŸºç¡€è®¾æ–½ç½‘å…³æ”¯æŒ SSH æœåŠ¡å™¨å’Œ Kubernetes å®¢æˆ·ç«¯ä½¿ç”¨çš„å„ç§è¿æ¥åè®®ï¼Œå¹¶æä¾›ä»¥ä¸‹å…³é”®åŠŸèƒ½ï¼š&lt;/p>
&lt;h3 id="ä¼šè¯è®°å½•">ä¼šè¯è®°å½•&lt;/h3>
&lt;p>è¿™æ¶‰åŠå¤åˆ¶ç”¨æˆ·åœ¨ä¼šè¯æœŸé—´æ‰§è¡Œçš„æ¯ä¸ªå‘½ä»¤ã€‚æ•è·çš„å‘½ä»¤é€šå¸¸ä¼šé™„åŠ å…¶ä»–ä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨æˆ·çš„èº«ä»½ã€ä»–ä»¬æ‰€å±çš„å„ç§èº«ä»½æä¾›è€…ç»„ã€å½“å¤©çš„æ—¶é—´ã€å‘½ä»¤çš„æŒç»­æ—¶é—´ä»¥åŠå“åº”çš„ç‰¹å¾ï¼ˆæ˜¯å¦æˆåŠŸã€æ˜¯å¦æœ‰é”™è¯¯ã€æ˜¯å¦å·²è¯»å–æˆ–å†™å…¥æ•°æ®ç­‰ï¼‰ã€‚&lt;/p>
&lt;h3 id="æ´»åŠ¨ç›‘æ§">æ´»åŠ¨ç›‘æ§&lt;/h3>
&lt;p>ç›‘æ§ä½¿ä¼šè¯è®°å½•çš„æ¦‚å¿µæ›´è¿›ä¸€æ­¥ã€‚é™¤äº†æ•è·æ‰€æœ‰å‘½ä»¤å’Œå“åº”ï¼ŒåŸºç¡€è®¾æ–½ç½‘å…³è¿˜å°†å®‰å…¨ç­–ç•¥åº”ç”¨äºç”¨æˆ·çš„æ´»åŠ¨ã€‚åœ¨å‘ç”Ÿè¿è§„çš„æƒ…å†µä¸‹ï¼Œå®ƒå¯ä»¥é€‰æ‹©è§¦å‘è­¦æŠ¥ã€é˜»æ­¢æœ‰é—®é¢˜çš„å‘½ä»¤åŠå…¶å“åº”æˆ–å®Œå…¨ç»ˆæ­¢ç”¨æˆ·çš„ä¼šè¯ã€‚&lt;/p>
&lt;h2 id="æ•°æ®ç½‘å…³">æ•°æ®ç½‘å…³&lt;/h2>
&lt;p>æ•°æ®ç½‘å…³ç®¡ç†å’Œç›‘æ§å¯¹æ•°æ®æœåŠ¡çš„è®¿é—®ï¼Œä¾‹å¦‚ MySQLã€PostgreSQL å’Œ MongoDB ç­‰æ‰˜ç®¡æ•°æ®åº“ã€AWS RDS ç­‰ DBaaS ç«¯ç‚¹ã€Snowflake å’Œ Bigquery ç­‰æ•°æ®ä»“åº“ã€AWS S3 ç­‰äº‘å­˜å‚¨ä»¥åŠ Kafka å’Œ Kinesisã€‚å®ƒä¸ç­–ç•¥å¼•æ“è¿æ¥ï¼Œä»¥ç¡®å®šç»†åŒ–çš„æˆæƒè§„åˆ™ï¼Œå¹¶åœ¨ç”¨æˆ·ä¼šè¯æœŸé—´å¯¹æ‰€æœ‰æ•°æ®æ´»åŠ¨å¼ºåˆ¶æ‰§è¡Œè¿™äº›è§„åˆ™ã€‚&lt;/p>
&lt;p>ä¸åŸºç¡€è®¾æ–½ç½‘å…³ç±»ä¼¼ï¼Œæ•°æ®ç½‘å…³å¯ä»¥åŒ…å«ä¸€ç»„å·¥ä½œèŠ‚ç‚¹ï¼Œå¯ä»¥åœ¨ AWS ä¸Šéƒ¨ç½²ä¸ºè‡ªåŠ¨æ‰©å±•ç»„ï¼Œä¹Ÿå¯ä»¥åœ¨ Kubernetes é›†ç¾¤ä¸Šä½œä¸ºå‰¯æœ¬é›†è¿è¡Œã€‚&lt;/p>
&lt;p>ç”±äºä¸åŸºç¡€è®¾æ–½æœåŠ¡ç›¸æ¯”ï¼Œæ•°æ®æœåŠ¡çš„ç§ç±»æ›´å¤šï¼Œå› æ­¤æ•°æ®ç½‘å…³é€šå¸¸å°†æ”¯æŒå¤§é‡çš„è¿æ¥åè®®å’Œè¯­æ³•ã€‚&lt;/p>
&lt;p>æ­¤ç±»æ•°æ®ç½‘å…³çš„ç¤ºä¾‹æ˜¯ &lt;a href="https://cyral.com/">Cyral&lt;/a>ï¼Œè¿™æ˜¯ä¸€ç§è½»é‡çº§çš„æ‹¦æˆªæœåŠ¡ï¼Œä»¥è¾¹è½¦ï¼ˆsidecarï¼‰çš„æ–¹å¼éƒ¨ç½²æ¥ç›‘æ§å’Œç®¡ç†å¯¹ç°ä»£æ•°æ®ç»ˆç«¯èŠ‚ç‚¹çš„è®¿é—®ï¼Œå¦‚ AWS RDSã€Snowflakeã€Bigqueryï¼Œã€AWS S3ã€Apache Kafka ç­‰ã€‚å…¶åŠŸèƒ½åŒ…æ‹¬ï¼š&lt;/p>
&lt;h3 id="ä¼šè¯è®°å½•-1">ä¼šè¯è®°å½•&lt;/h3>
&lt;p>è¿™ç±»ä¼¼äºè®°å½•åŸºç¡€è®¾æ–½æ´»åŠ¨ï¼Œå¹¶ä¸”æ¶‰åŠç”¨æˆ·åœ¨ä¼šè¯æœŸé—´æ‰§è¡Œçš„æ¯ä¸ªå‘½ä»¤çš„å‰¯æœ¬ï¼Œå¹¶ä½¿ç”¨ä¸°å¯Œçš„å®¡è®¡ä¿¡æ¯è¿›è¡Œæ³¨é‡Šã€‚&lt;/p>
&lt;h3 id="æ´»åŠ¨ç›‘æ§-1">æ´»åŠ¨ç›‘æ§&lt;/h3>
&lt;p>åŒæ ·ï¼Œè¿™ç±»ä¼¼äºç›‘è§†åŸºç¡€è®¾æ–½æ´»åŠ¨ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ç­–ç•¥é˜»æ­¢æ•°æ®åˆ†æäººå‘˜è¯»å–æ•æ„Ÿçš„å®¢æˆ· PIIã€‚&lt;/p>
&lt;h3 id="éšç§æƒæ‰§è¡Œ">éšç§æƒæ‰§è¡Œ&lt;/h3>
&lt;p>ä¸åŸºç¡€è®¾æ–½æœåŠ¡ä¸åŒï¼Œæ•°æ®æœåŠ¡æˆäºˆç”¨æˆ·å¯¹é€šå¸¸ä½äºæ•°æ®åº“ã€æ•°æ®ä»“åº“ã€äº‘å­˜å‚¨å’Œæ¶ˆæ¯ç®¡é“ä¸­çš„ä¸å®¢æˆ·ã€åˆä½œä¼™ä¼´å’Œç«äº‰å¯¹æ‰‹æœ‰å…³çš„æ•æ„Ÿæ•°æ®çš„è¯»å†™è®¿é—®æƒé™ã€‚ å‡ºäºéšç§åŸå› ï¼Œå¯¹æ•°æ®ç½‘å…³çš„ä¸€ä¸ªéå¸¸æ™®éçš„è¦æ±‚æ˜¯èƒ½å¤Ÿæ¸…ç†ï¼ˆä¹Ÿç§°ä¸ºä»¤ç‰ŒåŒ–æˆ–å±è”½ï¼‰PIIï¼Œä¾‹å¦‚ç”µå­é‚®ä»¶ã€å§“åã€ç¤¾ä¼šä¿é™©å·ã€ä¿¡ç”¨å¡å·å’Œåœ°å€ã€‚&lt;/p>
&lt;h2 id="é‚£ä¹ˆè¿™ç§ä½“ç³»ç»“æ„å¦‚ä½•ç®€åŒ–è®¿é—®ç®¡ç†">é‚£ä¹ˆè¿™ç§ä½“ç³»ç»“æ„å¦‚ä½•ç®€åŒ–è®¿é—®ç®¡ç†ï¼Ÿ&lt;/h2>
&lt;p>è®©æˆ‘ä»¬çœ‹ä¸€äº›å¸¸è§çš„è®¿é—®ç®¡ç†æ–¹æ¡ˆï¼Œä»¥äº†è§£ä¸ä½¿ç”¨ VPN å’Œå ¡å’ä¸»æœºç›¸æ¯”ï¼Œæ¥å…¥ç½‘å…³æ¶æ„å¦‚ä½•æä¾›ç»†ç²’åº¦çš„æ§åˆ¶ã€‚&lt;/p>
&lt;h2 id="ç‰¹æƒæ´»åŠ¨ç›‘æ§pam">ç‰¹æƒæ´»åŠ¨ç›‘æ§ï¼ˆPAMï¼‰&lt;/h2>
&lt;p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ç­–ç•¥ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹ç›‘è§†æ‰€æœ‰åŸºç¡€è®¾æ–½å’Œæ•°æ®æœåŠ¡ä¸­çš„ç‰¹æƒæ´»åŠ¨ï¼š&lt;/p>
&lt;ul>
&lt;li>ä»…å…è®¸å±äº Admins å’Œ SRE ç»„çš„ä¸ªäººåœ¨ SSH æœåŠ¡å™¨ã€Kubernetes é›†ç¾¤å’Œæ•°æ®åº“ä¸Šè¿è¡Œç‰¹æƒå‘½ä»¤ã€‚&lt;/li>
&lt;li>è™½ç„¶å¯ä»¥è¿è¡Œç‰¹æƒå‘½ä»¤ï¼Œä½†æ˜¯æœ‰ä¸€äº›ä¾‹å¤–å½¢å¼çš„é™åˆ¶ã€‚å…·ä½“æ¥è¯´ï¼Œä»¥ä¸‹å‘½ä»¤æ˜¯ä¸å…è®¸çš„ï¼š
&lt;ul>
&lt;li>â€œsudoâ€ å’Œ â€œyumâ€ å‘½ä»¤å¯èƒ½æ— æ³•åœ¨ä»»ä½• SSH æœåŠ¡å™¨ä¸Šè¿è¡Œ&lt;/li>
&lt;li>â€œkubectl deleteâ€ å’Œ â€œkubectl taintâ€ å‘½ä»¤å¯èƒ½æ— æ³•åœ¨ä»»ä½• Kubernetes é›†ç¾¤ä¸Šè¿è¡Œ&lt;/li>
&lt;li>â€œdrop tableâ€ å’Œ â€œcreate userâ€ å‘½ä»¤å¯èƒ½æ— æ³•åœ¨ä»»ä½•æ•°æ®åº“ä¸Šè¿è¡Œ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/27/16195354276750.jpg" alt="">&lt;/p>
&lt;h2 id="é›¶ç‰¹æƒzspæ‰§è¡Œ">é›¶ç‰¹æƒï¼ˆZSPï¼‰æ‰§è¡Œ&lt;/h2>
&lt;p>The next policy shows an example of enforcing zero standing privileges &amp;ndash; a paradigm where no one has access to an infrastructure or data service by default. Access may be obtained only upon satisfying one or more qualifying criteria:&lt;/p>
&lt;ul>
&lt;li>Only individuals belonging to the Support group are allowed access&lt;/li>
&lt;li>An individual must be on-call to gain access. On call status may be determined by checking their schedule in an incident response service such as PagerDuty&lt;/li>
&lt;li>A multi-factor authentication (MFA) check is triggered upon successful authentication&lt;/li>
&lt;li>They must use TLS to connect to the infrastructure or data service&lt;/li>
&lt;li>Lastly, if a data service is being accessed, full table scans (e.g. SQL requests lacking a WHERE or a LIMIT clause that end up reading an entire dataset) are disallowed.&lt;/li>
&lt;/ul>
&lt;p>ä¸‹ä¸€ä¸ªç­–ç•¥æ˜¾ç¤ºäº†ä¸€ä¸ªå®æ–½é›¶ç‰¹æƒçš„ç¤ºä¾‹ &amp;ndash; ä¸€ç§é»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰äººå¯ä»¥è®¿é—®åŸºç¡€è®¾æ–½æˆ–æ•°æ®æœåŠ¡çš„èŒƒä¾‹ã€‚åªæœ‰æ»¡è¶³ä¸€ä¸ªæˆ–å¤šä¸ªåˆæ ¼æ ‡å‡†ï¼Œæ‰èƒ½è·å¾—è®¿é—®æƒé™ï¼š&lt;/p>
&lt;ul>
&lt;li>åªå…è®¸å±äºæ”¯æŒç»„çš„ä¸ªäººè®¿é—®&lt;/li>
&lt;li>ä¸ªäººå¿…é¡» on-call æ‰èƒ½è·å¾—è®¿é—®æƒé™ã€‚å¯ä»¥é€šè¿‡æ£€æŸ¥äº‹ä»¶å“åº”æœåŠ¡ï¼ˆä¾‹å¦‚ PagerDutyï¼‰ä¸­çš„æ—¶é—´è¡¨æ¥ç¡®å®šé€šè¯çŠ¶æ€&lt;/li>
&lt;li>æˆåŠŸé€šè¿‡èº«ä»½éªŒè¯åä¼šè§¦å‘å¤šå› å­èº«ä»½éªŒè¯ï¼ˆMFAï¼‰æ£€æŸ¥&lt;/li>
&lt;li>ä»–ä»¬å¿…é¡»ä½¿ç”¨ TLS è¿æ¥åˆ°åŸºç¡€è®¾æ–½æˆ–æ•°æ®æœåŠ¡&lt;/li>
&lt;li>æœ€åï¼Œå¦‚æœæ­£åœ¨è®¿é—®æ•°æ®æœåŠ¡ï¼Œåˆ™ä¸å…è®¸è¿›è¡Œå…¨è¡¨æ‰«æï¼ˆä¾‹å¦‚ï¼Œç¼ºå°‘ WHERE æˆ– LIMIT å­å¥çš„ SQL è¯·æ±‚æœ€ç»ˆå°†è¯»å–æ•´ä¸ªæ•°æ®é›†ï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/27/16195356881012.jpg" alt="">&lt;/p>
&lt;h2 id="éšç§å’Œæ•°æ®ä¿æŠ¤">éšç§å’Œæ•°æ®ä¿æŠ¤&lt;/h2>
&lt;p>The last policy shows an example of data governance involving data scrubbing:&lt;/p>
&lt;ul>
&lt;li>If anyone from Marketing is accessing PII (social security number (SSN), credit card number (CCN), age), scrub the data before returning&lt;/li>
&lt;li>If anyone is accessing PII using the Looker or Tableau services, also scrub the data&lt;/li>
&lt;li>Scrubbing rules are defined by the specific type of the PII
&lt;ul>
&lt;li>For SSNs, scrub the first 5 digits&lt;/li>
&lt;li>For CCNs, scrub the lastÂ Â 4 digits&lt;/li>
&lt;li>For ages, scrub the last digit i.e., the requestor will know the age brackets but never the actual ages&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>æœ€åä¸€æ¡ç­–ç•¥æ˜¾ç¤ºäº†æ¶‰åŠæ•°æ®æ¸…ç†çš„æ•°æ®æ²»ç†ç¤ºä¾‹ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœå¸‚åœºè¥é”€äººå‘˜æ­£åœ¨è®¿é—® PIIï¼ˆç¤¾ä¼šä¿é™©å·ï¼ˆSSNï¼‰ã€ä¿¡ç”¨å¡å·ï¼ˆCCNï¼‰ã€å¹´é¾„ï¼‰ï¼Œå…ˆæ¸…æ´—æ•°æ®ç„¶åå†è¿”å›&lt;/li>
&lt;li>å¦‚æœæœ‰äººæ­£åœ¨ä½¿ç”¨ Looker æˆ– Tableau æœåŠ¡è®¿é—® PIIï¼ŒåŒæ—¶æ¸…æ´—æ•°æ®&lt;/li>
&lt;li>æ¸…ç†è§„åˆ™ç”± PII çš„ç‰¹å®šç±»å‹å®šä¹‰
&lt;ul>
&lt;li>å¯¹äº SSNï¼Œæ¸…æ´—å‰ 5 ä½æ•°å­—&lt;/li>
&lt;li>å¯¹äº CCNï¼Œæ¸…æ´—æœ€å 4 ä½æ•°å­—&lt;/li>
&lt;li>å¯¹äºå¹´é¾„ï¼Œè¯·æ¸…æ´—æœ€åä¸€ä½æ•°å­—ï¼Œå³è¯·æ±‚è€…å°†çŸ¥é“å¹´é¾„æ®µï¼Œä½†ä»ä¸çŸ¥é“å®é™…å¹´é¾„&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/27/16195358881245.jpg" alt="">&lt;/p>
&lt;h2 id="æ¦‚æ‹¬">æ¦‚æ‹¬&lt;/h2>
&lt;p>æˆ‘ä»¬çœ‹åˆ°ï¼Œå¯¹äºé«˜åº¦åŠ¨æ€çš„äº‘ç¯å¢ƒï¼ŒVPN å’Œå ¡å’ä¸»æœºä¸è¶³ä»¥ä½œä¸ºé«˜æ•ˆäº‘ç¯å¢ƒä¸­çš„æœ‰æ•ˆè®¿é—®ç®¡ç†æœºåˆ¶ã€‚ä¸€ç§æ–°çš„è®¿é—®ç®¡ç†ä½“ç³»ç»“æ„ï¼Œå…¶é‡ç‚¹æ˜¯ä¸å¯å¦è®¤çš„ç”¨æˆ·èº«ä»½ï¼ŒçŸ­æš‚çš„è¯ä¹¦æˆ–ä»¤ç‰Œä»¥åŠé›†ä¸­çš„ç»†ç²’åº¦æˆæƒå¼•æ“ï¼Œå¯æœ‰æ•ˆè§£å†³ VPN å’Œå ¡å’ä¸»æœºæ— æ³•è§£å†³çš„éš¾é¢˜ã€‚é™¤äº†ä¸ºè®¿é—®å…³é”®åŸºç¡€è®¾æ–½å’Œæ•°æ®æœåŠ¡çš„ç”¨æˆ·æä¾›å…¨é¢çš„å®‰å…¨æ€§ä¹‹å¤–ï¼Œè¯¥ä½“ç³»ç»“æ„è¿˜å¯ä»¥å¸®åŠ©ç»„ç»‡å®ç°å…¶å®¡æ ¸ã€åˆè§„æ€§ã€éšç§å’Œä¿æŠ¤ç›®æ ‡ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬è¿˜è®¨è®ºäº†è¯¥æ¶æ„çš„å‚è€ƒå®ç°ï¼Œå…¶ä¸­ä½¿ç”¨äº†ä»¥å¼€å‘äººå‘˜ä¸ºä¸­å¿ƒçš„è‘—åå¼€æºè§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ Hashicorp Boundary å’Œ OPA ä»¥åŠ Cyralï¼ˆä¸€ç§ç”¨äºç°ä»£æ•°æ®æœåŠ¡çš„å¿«é€Ÿä¸”æ— çŠ¶æ€çš„è¾…åŠ©å·¥å…·ï¼‰ã€‚ ä»–ä»¬ä¸€èµ·å¯ä»¥åœ¨äº‘ä¸Šæä¾›ç»†ç²’åº¦ä¸”æ˜“äºä½¿ç”¨çš„è®¿é—®ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚&lt;/p>
&lt;h2 id="å…³äºä½œè€…">å…³äºä½œè€…&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/27/16195361264391.jpg" alt="">&lt;/p>
&lt;p>&lt;strong>Manav Mital&lt;/strong> æ˜¯ Cyral çš„è”åˆåˆ›å§‹äººå…¼é¦–å¸­æ‰§è¡Œå®˜ï¼ŒCyral æ˜¯é¦–ä¸ªä¸ºæ•°æ®äº‘æä¾›å¯è§æ€§ã€è®¿é—®æ§åˆ¶å’Œä¿æŠ¤çš„äº‘åŸç”Ÿå®‰å…¨æœåŠ¡ã€‚Cyral æˆç«‹äº 2018 å¹´ï¼Œä¸å„ç§ç»„ç»‡åˆä½œ - ä»äº‘åŸç”Ÿåˆåˆ›ä¼ä¸šåˆ°è´¢å¯Œ 500 å¼ºä¼ä¸šï¼Œå› ä¸ºå®ƒä»¬é‡‡ç”¨ DevOps æ–‡åŒ–å’Œäº‘æŠ€æœ¯æ¥ç®¡ç†å’Œåˆ†ææ•°æ®ã€‚ Manav æ‹¥æœ‰ UCLA çš„è®¡ç®—æœºç§‘å­¦ç¡•å£«å­¦ä½å’Œåæ™®å°”çš„å°åº¦ç†å·¥å­¦é™¢çš„è®¡ç®—æœºç§‘å­¦å­¦å£«å­¦ä½ã€‚&lt;/p>
&lt;h2 id="å…³äºè¯‘è€…">å…³äºè¯‘è€…&lt;/h2>
&lt;p>&lt;strong>Addo Zhang&lt;/strong> äº‘åŸç”Ÿä»ä¸šäººå‘˜ï¼Œçˆ±å¥½å„ç§ä»£ç ã€‚æ›´å¤šç¿»è¯‘ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/beRHn9l2K4eiS8M1IevcRA">åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨ Kubernetes ä¸Šçš„è¿›åŒ–&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/V6lO9sT_6hJVled9sOI4IA">2021 å¹´åŠæœªæ¥çš„äº‘åŸç”Ÿé¢„æµ‹&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/mw9LhDPiTyooUAXAoKHwTA">åº”ç”¨æ¶æ„ï¼šä¸ºä»€ä¹ˆè¦éšç€å¸‚åœºæ¼”è¿›&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Quarkusï¼šè°è¯´ Java ä¸èƒ½ç”¨æ¥è·‘ Serverlessï¼Ÿ</title><link>https://atbug.com/quarkus-enable-java-running-in-serverless/</link><pubDate>Sat, 24 Apr 2021 09:16:05 +0800</pubDate><guid>https://atbug.com/quarkus-enable-java-running-in-serverless/</guid><description>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/24/whynotjava.png" alt="why-not-java">&lt;/p>
&lt;p>æƒ³åˆ°è¿™ä¸ªæ ‡é¢˜çš„æ—¶å€™ï¼Œæˆ‘ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„å°±æ˜¯æ˜Ÿçˆ·çš„ã€Šå”ä¼¯è™ç‚¹ç§‹é¦™ã€‹çš„è¿™ä¸€å¹•ã€‚&lt;/p>
&lt;p>å½“è®¨è®ºèµ·ä¸–ç•Œä¸Šæœ€å¥½çš„å¼€å‘è¯­è¨€æ˜¯ä»€ä¹ˆçš„æ—¶å€™ï¼ŒJava çš„ç²‰ä¸ä»¬æ€»ä¼šé‡åˆ°è¿™ç§åœºæ™¯ï¼š&lt;/p>
&lt;blockquote>
&lt;p>å¹ï¼šâ€œJava è¯­æ³•ç®€å•ï¼Œå®¹æ˜“ä¸Šæ‰‹ï¼â€
é»‘ï¼šâ€œJava å¯åŠ¨æ…¢ï¼Œæ€§èƒ½å·®ï¼Œè€—èµ„æºï¼â€
å¹ï¼šâ€œJava æœ‰ä¸–ç•Œä¸Šæœ€å¤šçš„ç¨‹åºå‘˜ï¼â€
é»‘ï¼šâ€œJava å¯åŠ¨æ…¢ï¼Œæ€§èƒ½å·®ï¼Œè€—èµ„æºï¼â€
å¹ï¼šâ€œJava ç”Ÿæ€å¥½ï¼â€
é»‘ï¼šâ€œJava å¯åŠ¨æ…¢ï¼Œæ€§èƒ½å·®ï¼Œè€—èµ„æºï¼â€
å¹ï¼šâ€œæ»šï¼â€&lt;/p>
&lt;/blockquote>
&lt;p>ä»Šå¤©æˆ‘ä»¬ç»§ç»­è¯´è¯´ Quarkusï¼Œåº”â€œäº‘â€è€Œç”Ÿçš„ Java æ¡†æ¶ã€‚ä»Šå¤©ç®—æ˜¯ç¬¬ä¸‰ç¯‡äº†ï¼Œæ²¡çœ‹è¿‡çš„åŒå­¦å¯ä»¥å›é¡¾ä¸€ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/YcEqFm3oxlsEvJ3ckRbQyA">Hello, Quarkus&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/Dq3hQrXE4XWH-MyjBAGMEw">åº”&amp;quot;äº‘&amp;quot;è€Œç”Ÿçš„ Java æ¡†æ¶ Quarkusï¼šæ„å»ºæœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ä¸Šä¸€ç¯‡çš„ç»“å°¾é¢„å‘Šï¼šè¯•è¯• Quarkus åœ¨ ArgoCD ä¸­çš„åº”ç”¨ï¼Œçœ‹ä¸‹ Serverless ä¸Šçš„ä½¿ç”¨ä½“éªŒã€‚ä¸è¿‡ä¸æƒ³ç”¨ ArgoCD äº†ï¼Œå› ä¸ºè¿™ workflow è¿™ç§åœºæ™¯å®åœ¨ä½“ç°ä¸å‡º Quarkus åˆ°åº•æœ‰å¤šå¿«ã€‚ä½†åˆæƒ³åš Serverlessï¼Œé‚£å°±æƒ³åˆ°äº† Knative Serving äº†ã€‚&lt;/p>
&lt;p>å…¶å®ï¼Œè¿˜æœ‰ä¸€ä¸ªåŸå› æ˜¯æ¯”è¾ƒæ‡’ï¼Œä¸Šæ¬¡çš„é•œåƒè¿˜å¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ã€‚&lt;/p>
&lt;h2 id="tldr">TL;DR&lt;/h2>
&lt;p>åºŸè¯ä¸å¤šè¯´ï¼Œå…ˆä¸Šç»“è®ºã€‚Quarkus ä¸ Spring é¦–ä¸ªè¯·æ±‚çš„å“åº”è€—æ—¶ï¼š&lt;strong>2.5s vs 5.7s&lt;/strong>ã€‚&lt;/p>
&lt;p>&lt;em>æ³¨ï¼šä¸ºäº†å¿½ç•¥æ‹‰å–é•œåƒçš„æ—¶é—´å·®å¼‚ï¼Œæå‰ pull é•œåƒã€‚&lt;/em>&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/24/cleanshot-20210424-at-0831012x.png" alt="">&lt;/p>
&lt;h2 id="éªŒè¯">éªŒè¯&lt;/h2>
&lt;h3 id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡&lt;/h3>
&lt;ul>
&lt;li>Kubernetes 1.18+ via minikube&lt;/li>
&lt;li>Istio 1.9.2&lt;/li>
&lt;li>Knative 0.22.0&lt;/li>
&lt;li>Knative CLI ï¼ˆbrew å®‰è£…ï¼‰&lt;/li>
&lt;li>watch ï¼ˆbrew å®‰è£…ï¼‰&lt;/li>
&lt;/ul>
&lt;p>ç¯å¢ƒçš„å®‰è£…å‡†å¤‡å‚è€ƒå®˜æ–¹çš„æ–‡æ¡£ã€‚&lt;/p>
&lt;h4 id="é•œåƒ">é•œåƒ&lt;/h4>
&lt;p>èµ„æºé•œåƒå°±ä½¿ç”¨&lt;a href="https://mp.weixin.qq.com/s/Dq3hQrXE4XWH-MyjBAGMEw">ä¸Šä¸€ç¯‡æ–‡ç« &lt;/a>æ„å»ºçš„ï¼Œä½†éœ€è¦åšä¸‹è°ƒæ•´ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker tag quarkus/quarkus-getting-started:distroless dev.local/quarkus/quarkus-getting-started:distroless
docker tag spring/spring-getting-started:latest dev.local/spring/spring-getting-started:latest
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨ï¼šknative ä¼šå¿½ç•¥ &lt;code>dev.local&lt;/code> é•œåƒçš„é¢„åŠ è½½ï¼Œä¸ä¼šåœ¨åˆ›å»º knative service çš„æ—¶å€™æ‹‰å–ã€‚&lt;/p>
&lt;p>ç„¶åä½¿ç”¨ &lt;code>minikube image load&lt;/code> åŠ è½½åˆ° minikubeç¯å¢ƒä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube image load dev.local/quarkus/quarkus-getting-started:distroless
minikube image load dev.local/spring/spring-getting-started:latest
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="knative-é…ç½®å¯é€‰">knative é…ç½®ï¼ˆå¯é€‰ï¼‰&lt;/h4>
&lt;p>ä¿®æ”¹ &lt;code>istio-system&lt;/code> namespace ä¸‹çš„ configmap &lt;code>config-domain&lt;/code>ï¼Œå¢åŠ æ–°çš„ domainï¼š&lt;code>nip.io&lt;/code>&lt;/p>
&lt;p>æ³¨ï¼šè¿™ä¸ªæ“ä½œçº¯å±ä¸ªäººå–œå¥½ï¼Œä¸å–œæ¬¢é‚£ä¸ª &lt;code>example.com&lt;/code>ï¼Œå¯è·³è¿‡ã€‚&lt;/p>
&lt;h4 id="è·å–-istio-ingress-åœ°å€">è·å– Istio Ingress åœ°å€&lt;/h4>
&lt;p>ä½¿ç”¨å‘½ä»¤è·å– Ingress çš„è®¿é—®æ–¹å¼ï¼Œè¿™é‡Œ &lt;code>http2/80&lt;/code> åçš„ &lt;code>http://192.168.64.2:31608&lt;/code> å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œè®°ä¸‹è¿™ä¸ª ip å’Œç«¯å£ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube service list
&lt;span class="p">|&lt;/span>------------------&lt;span class="p">|&lt;/span>----------------------------&lt;span class="p">|&lt;/span>-------------------&lt;span class="p">|&lt;/span>---------------------------&lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> NAMESPACE &lt;span class="p">|&lt;/span> NAME &lt;span class="p">|&lt;/span> TARGET PORT &lt;span class="p">|&lt;/span> URL &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span>------------------&lt;span class="p">|&lt;/span>----------------------------&lt;span class="p">|&lt;/span>-------------------&lt;span class="p">|&lt;/span>---------------------------&lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> default &lt;span class="p">|&lt;/span> kubernetes &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> istio-system &lt;span class="p">|&lt;/span> istio-egressgateway &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> istio-system &lt;span class="p">|&lt;/span> istio-ingressgateway &lt;span class="p">|&lt;/span> status-port/15021 &lt;span class="p">|&lt;/span> http://192.168.64.2:32431 &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> http2/80 &lt;span class="p">|&lt;/span> http://192.168.64.2:31608 &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> https/443 &lt;span class="p">|&lt;/span> http://192.168.64.2:31795 &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> tcp/31400 &lt;span class="p">|&lt;/span> http://192.168.64.2:31369 &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> tls/15443 &lt;span class="p">|&lt;/span> http://192.168.64.2:30293 &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> istio-system &lt;span class="p">|&lt;/span> istiod &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> istio-system &lt;span class="p">|&lt;/span> knative-local-gateway &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> knative-eventing &lt;span class="p">|&lt;/span> broker-filter &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> knative-eventing &lt;span class="p">|&lt;/span> broker-ingress &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> knative-eventing &lt;span class="p">|&lt;/span> eventing-webhook &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> knative-eventing &lt;span class="p">|&lt;/span> imc-dispatcher &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> knative-serving &lt;span class="p">|&lt;/span> activator-service &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> knative-serving &lt;span class="p">|&lt;/span> autoscaler &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> knative-serving &lt;span class="p">|&lt;/span> autoscaler-bucket-00-of-01 &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> knative-serving &lt;span class="p">|&lt;/span> autoscaler-hpa &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> knative-serving &lt;span class="p">|&lt;/span> controller &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> knative-serving &lt;span class="p">|&lt;/span> istio-webhook &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> knative-serving &lt;span class="p">|&lt;/span> webhook &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> kube-system &lt;span class="p">|&lt;/span> kube-dns &lt;span class="p">|&lt;/span> No node port &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span>------------------&lt;span class="p">|&lt;/span>----------------------------&lt;span class="p">|&lt;/span>-------------------&lt;span class="p">|&lt;/span>---------------------------&lt;span class="p">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ›å»º-knative-service">åˆ›å»º Knative service&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="c">#quarkus&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">serving.knative.dev/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">hello-quarkus&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dev.local/quarkus/quarkus-getting-started:distroless&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Never&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#spring&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">serving.knative.dev/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">hello-spring&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dev.local/spring/spring-getting-started:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Never&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šè¿‡ cli &lt;code>kn&lt;/code> å‘½ä»¤æŸ¥çœ‹ä¸‹ service çš„ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kn service describe hello-quarkus -n default
Name: hello-quarkus
Namespace: default
Age: 21s
URL: http://hello-quarkus.default.nip.io
Revisions:
100% @latest &lt;span class="o">(&lt;/span>hello-quarkus-00001&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>21s&lt;span class="o">)&lt;/span>
Image: dev.local/quarkus/quarkus-getting-started:distroless
Conditions:
OK TYPE AGE REASON
++ Ready 9s
++ ConfigurationsReady 10s
++ RoutesReady 9s
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kn service describe hello-spring -n default
Name: hello-spring
Namespace: default
Age: 44s
URL: http://hello-spring.default.nip.io
Revisions:
100% @latest &lt;span class="o">(&lt;/span>hello-spring-00001&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>44s&lt;span class="o">)&lt;/span>
Image: dev.local/spring/spring-getting-started:latest
Conditions:
OK TYPE AGE REASON
++ Ready 31s
++ ConfigurationsReady 32s
++ RoutesReady 31s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»æè¿°ä¿¡æ¯ä¸­å¯ä»¥æ‹¿åˆ°æœåŠ¡çš„è®¿é—®åœ°å€ï¼Œåˆ†åˆ«æ˜¯ &lt;code>http://hello-quarkus.default.nip.io&lt;/code> å’Œ &lt;code>http://hello-spring.default.nip.io&lt;/code>ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥å°±éœ€è¦åœ¨æœ¬åœ°ä¸»æœºçš„ hosts ä¸­åŠ å…¥è§£æï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">192.168.64.2 hello-quarkus.default.nip.io
192.168.64.2 hello-spring.default.nip.io
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æµ‹è¯•">æµ‹è¯•&lt;/h3>
&lt;p>ä¸Šé¢æ“ä½œå®Œä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„åœ°å€è®¿é—®æœåŠ¡äº†ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;a href="http://hello-quarkus.default.nip.io:31608/hello/greeting/quarkus">http://hello-quarkus.default.nip.io:31608/hello/greeting/quarkus&lt;/a>
&lt;a href="http://hello-spring.default.nip.io:31608/hello/greeting/spring">http://hello-spring.default.nip.io:31608/hello/greeting/spring&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡ &lt;code>watch -n 1 'kubectl get po -n default | grep hello'&lt;/code> å‘½ä»¤æ¥æŸ¥çœ‹ pod çš„åˆ›å»ºå’Œé”€æ¯ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/24/20210424-090756.gif" alt="2021-04-24 09.07.56">&lt;/p></description></item><item><title>æœåŠ¡ç½‘æ ¼å¹³ç¨³è½åœ°ï¼šIstio ä¸­ç²¾å‡†æ§åˆ¶ Sidecar çš„æ³¨å…¥</title><link>https://atbug.com/how-to-control-istio-sidecar-injection/</link><pubDate>Wed, 21 Apr 2021 08:13:04 +0800</pubDate><guid>https://atbug.com/how-to-control-istio-sidecar-injection/</guid><description>
&lt;h2 id="ä¸ºä»€ä¹ˆ">ä¸ºä»€ä¹ˆ&lt;/h2>
&lt;p>è¯´èµ·æœåŠ¡ç½‘æ ¼ï¼Œè¿™å¹…å›¾å¤§å®¶è‚¯å®šä¸ä¼šé™Œç”Ÿã€‚è¿™å°±æ˜¯æœåŠ¡ç½‘æ ¼çš„ç½‘ç»œï¼Œä¹Ÿæ˜¯ç½‘æ ¼æ¶æ„çš„ç»ˆæå½¢æ€ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/21/cleanshot-20210420-at-2314142x.png" alt="">&lt;/p>
&lt;p>é‚£åœ¨è¿ç§»åˆ°ç½‘æ ¼æ¶æ„ä¹‹å‰ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/21/cleanshot-20210420-at-2316432x.png" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬çš„ç³»ç»Ÿåœ¨æ¼”è¿›çš„è¿‡ç¨‹ä¸­ï¼Œä¸å¯é¿å…çš„ä¼šé‡åˆ°å„ç§ 0 åˆ° 1 è¿‡ç¨‹ä¸­çš„ä¸­é—´æ€ã€‚æ¯”å¦‚ä¸‹é¢è¿™ç§ï¼Œå¯ä»¥æ¯”è¾ƒç›´è§‚çš„çœ‹å‡º Istio æˆ–è€…ç½‘æ ¼æ˜¯éƒ¨åˆ†è¦†ç›–çš„ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¹³æ»‘ã€å¯æ§çš„æ¨è¿›ï¼Œæ‰èƒ½åœ¨ä¿éšœç³»ç»Ÿå¯ç”¨æ€§çš„å‰æä¸‹è¿›è¡Œæ¶æ„çš„æ¼”è¿›ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/21/cleanshot-20210420-at-2318242x.png" alt="">&lt;/p>
&lt;h2 id="æ€ä¹ˆåš">æ€ä¹ˆåš&lt;/h2>
&lt;p>Sidecar çš„æ³¨å…¥åˆ†ä¸¤ç§ï¼šæ‰‹åŠ¨å’Œè‡ªåŠ¨ã€‚&lt;/p>
&lt;h3 id="æ‰‹åŠ¨">æ‰‹åŠ¨&lt;/h3>
&lt;p>æ‰‹åŠ¨å°±æ˜¯åˆ©ç”¨ Istio çš„ cli å·¥å…· &lt;code>istioctl kube-inject&lt;/code> å¯¹èµ„æº yaml è¿›è¡Œä¿®æ”¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ istioctl kube-inject -f samples/sleep/sleep.yaml &lt;span class="p">|&lt;/span> kubectl apply -f -
serviceaccount/sleep created
service/sleep created
deployment.apps/sleep created
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰‹åŠ¨çš„æ–¹å¼æ¯”è¾ƒé€‚åˆå¼€å‘é˜¶æ®µä½¿ç”¨ã€‚&lt;/p>
&lt;h3 id="è‡ªåŠ¨">è‡ªåŠ¨&lt;/h3>
&lt;p>sidecar çš„è‡ªåŠ¨æ³¨å…¥åˆ™æ˜¯é€šè¿‡ &lt;a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/">mutating webhook admission controller&lt;/a> å®ç°çš„ã€‚å…¶åŸç†ç®€å•è¯´å°±æ˜¯æ‹¦æˆª podçš„åˆ›å»ºè¯·æ±‚æ¥å¯¹ pod çš„èµ„æºå®šä¹‰è¿›è¡Œä¿®æ”¹ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯¹æˆªå–äº† &lt;code>istio-sidecar-injector&lt;/code> &lt;code>MutatingWebhookConfiguration&lt;/code> çš„éƒ¨åˆ†å†…å®¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">webhooks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Exact&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sidecar-injector.istio.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespaceSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">istio-injection&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">enabled&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">objectSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sidecar.istio.io/inject&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NotIn&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">values&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#4&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiVersions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">operations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">CREATE&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">pods&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scope&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>è¿™é‡Œçš„ &lt;code>matchPolicy: Exact&lt;/code> é’ˆå¯¹çš„æ˜¯ #4 ä¸­çš„ &lt;code>apiGroups&lt;/code>ä¸&lt;code>apiVersions&lt;/code> çš„ç»„åˆï¼Œå³ç²¾ç¡®åŒ¹é… &lt;code>v1/pods&lt;/code> çš„ &lt;code>CREATE&lt;/code> è¯·æ±‚&lt;/li>
&lt;li>é¡¾åæ€ä¹‰ï¼ŒåŒ¹é…ç¬¦åˆæ¡ä»¶çš„ &lt;code>namespace&lt;/code>&lt;/li>
&lt;li>åŒ2ï¼ŒåŒ¹é…ç¬¦åˆæ¡ä»¶çš„ &lt;code>object&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>æ³¨ï¼š #2ã€#3 æ”¯æŒ Kubernetes çš„&lt;a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/">æ ‡ç­¾é€‰æ‹©è¯­æ³•&lt;/a>&lt;/p>
&lt;p>æŒ‰ç…§å‰é¢çš„è¯´æ˜ï¼Œè¿™ä¸ª hook ä¼šæ‹¦æˆªæ‰“äº† &lt;code>istio-injection: enabled&lt;/code> label çš„ namespace ä¸‹ï¼Œæ²¡æœ‰æ‰“ &lt;code>sidecar.istio.io/inject: false&lt;/code> æ ‡ç­¾çš„ &lt;code>v1/pod&lt;/code> çš„åˆ›å»ºã€‚é€šè¿‡ &lt;code>https://istiod.istio-system:443/inject&lt;/code> ç«¯ç‚¹å¯¹ pod çš„å®šä¹‰è¿›è¡Œå®šåˆ¶ï¼ˆæ·»åŠ  &lt;code>init-container&lt;/code>ã€sidecar å®¹å™¨ç­‰ï¼‰ã€‚&lt;/p>
&lt;p>æœ‰äººå¯èƒ½ä¼šè¯´è¿™æ ·è¿˜ä¸å¤Ÿç²¾å‡†ï¼Œå› ä¸ºå¯èƒ½æŸä¸ª namespace ä¸‹åªæœ‰éƒ¨åˆ†å¯¹è±¡æ‰ä¼šæ³¨å…¥ sidecarã€‚&lt;/p>
&lt;p>è¿™å°±éœ€è¦å€ŸåŠ© &lt;code>istiod&lt;/code> çš„é€»è¾‘äº†ã€‚&lt;/p>
&lt;h3 id="åªé’ˆå¯¹ç‰¹å®š-pod-æ³¨å…¥sidecar-æˆ–å¿½ç•¥æ³¨å…¥">åªé’ˆå¯¹ç‰¹å®š pod æ³¨å…¥sidecar æˆ–å¿½ç•¥æ³¨å…¥&lt;/h3>
&lt;p>åœ¨ &lt;code>configmap&lt;/code> &lt;code>istio-sidecar-injector&lt;/code> ä¸­æœ‰ä¸¤ä¸ªå­—æ®µ &lt;code>alwaysInjectSelector&lt;/code> å’Œ &lt;code>neverInjectSelector&lt;/code>ã€‚ä»åå­—æ¥çœ‹è¿™ä¸¤ä¸ªåˆ†åˆ«æä¾›äº†ç™½åå•ã€é»‘åå•çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">alwaysInjectSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="l">neverInjectSelector:[]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬åªéœ€å¦‚ä¸‹è°ƒæ•´ï¼ˆéœ€è¦é‡å¯ istiodï¼‰ï¼Œç„¶åä¸ºéœ€è¦æ³¨å…¥ sidecar çš„èµ„æºæ‰“ä¸Šç›¸åº”çš„æ ‡ç­¾å³å¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">alwaysInjectSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sidecar.istio.io/inject&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">In&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">values&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;true&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;enabled&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;yes&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>åº”â€œäº‘â€è€Œç”Ÿçš„ Java æ¡†æ¶ï¼šæ„å»ºæœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶</title><link>https://atbug.com/quarkus-build-native-executable-file/</link><pubDate>Sat, 17 Apr 2021 09:08:40 +0800</pubDate><guid>https://atbug.com/quarkus-build-native-executable-file/</guid><description>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/17/16186233244243.jpg" alt="">&lt;/p>
&lt;blockquote>
&lt;p>ç”µå½±ã€ŠåŠŸå¤«ã€‹ä¸­ï¼Œç«äº‘é‚ªç¥æœ‰å¥è¯ï¼šâ€œå¤©ä¸‹æ­¦åŠŸæ— åšä¸æ‘§ï¼Œå”¯å¿«ä¸ç ´ã€‚â€&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨ &lt;a href="https://mp.weixin.qq.com/s/YcEqFm3oxlsEvJ3ckRbQyA">ä¸Šä¸€ç¯‡æ–‡ç« &lt;/a> ä¸­ï¼Œæˆ‘ä»¬å†™äº†ç¬¬ä¸€ä¸ª Quarkus åº”ç”¨ï¼Œå¹¶å°è¯•ç€æ„å»ºäº† &lt;code>legacy-jar&lt;/code> å’Œ &lt;code>fast-jar&lt;/code>ã€‚&lt;/p>
&lt;p>ä»Šå¤©æ¥çœ‹ä¸€ä¸‹ Quarkus æ„å»ºå‡ºæ¥çš„æœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶åˆ°åº•æ¯” Spring åº”ç”¨èƒ½å¿«å¤šå°‘ï¼Œ&lt;strong>ç”Ÿæ€çš„æˆç†Ÿåº¦ä¸åœ¨è¿™é‡Œè®¨è®º&lt;/strong>ã€‚&lt;/p>
&lt;h2 id="tldr">TLDR&lt;/h2>
&lt;p>å…ˆä¸Šç»“è®ºï¼Œ ä¸åªæœ‰ä¸€ä¸ª Controller çš„Spring Web åº”ç”¨åšä¸‹å¯¹æ¯”ã€‚&lt;/p>
&lt;h3 id="åº”ç”¨å¯åŠ¨æ—¶é—´0012s-vs-2294s">åº”ç”¨å¯åŠ¨æ—¶é—´ï¼š0.012s vs 2.294s&lt;/h3>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/17/cleanshot-20210417-at-0900292x.png" alt="CleanShot 2021-04-17 at 09.00.29@2x">&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/17/cleanshot-20210417-at-0915282x.png" alt="CleanShot 2021-04-17 at 09.15.28@2x">&lt;/p>
&lt;h3 id="é•œåƒå¤§å°49mb-vs-237-mb">é•œåƒå¤§å°ï¼š49MB vs 237 MB&lt;/h3>
&lt;p>Spring åº”ç”¨é•œåƒä½¿ç”¨ &lt;code>openjdk:11.0-jre-slim&lt;/code> ä½œä¸º base é•œåƒï¼Œå¤§å°ä¸º 220MBã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker images
REPOSITORY TAG IMAGE ID CREATED SIZE
spring/spring-getting-started latest 5f47030c5c3f &lt;span class="m">6&lt;/span> minutes ago 237MB
quarkus/quarkus-getting-started distroless2 fe973c5ac172 &lt;span class="m">24&lt;/span> minutes ago 49MB
quarkus/quarkus-getting-started distroless 6fe27dd44e86 &lt;span class="m">31&lt;/span> minutes ago 51MB
quarkus/quarkus-getting-started ubi 8f86f5915715 &lt;span class="m">58&lt;/span> minutes ago 132MB
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="java-åº”ç”¨å®¹å™¨åŒ–çš„å›°å¢ƒ">Java åº”ç”¨å®¹å™¨åŒ–çš„å›°å¢ƒ&lt;/h2>
&lt;p>äº‘åŸç”Ÿä¸–ç•Œä¸­ï¼Œåº”ç”¨å®¹å™¨åŒ–æ˜¯ä¸ªæ˜¾è‘—çš„ç‰¹ç‚¹ã€‚Java åº”ç”¨å®¹å™¨åŒ–æ—¶é¢ä¸´äº†å¦‚ä¸‹é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>åº”ç”¨å¯åŠ¨æ…¢ï¼šå…¶å®è¿™æ˜¯ Java åº”ç”¨çš„é—®é¢˜ã€‚Java åº”ç”¨å ç”¨å†…å­˜å¤šï¼›JVM è™šæ‹Ÿæœºå¯åŠ¨æ—¶éœ€è¦åšç¯å¢ƒçš„åˆå§‹åŒ–ã€é¢„åŠ è½½å¤§é‡çš„ç±»ã€åˆå§‹åŒ–çº¿ç¨‹ç­‰ç­‰ã€‚å¯åŠ¨è€—æ—¶è§†åº”ç”¨æƒ…å†µéœ€è¦å‡ ç§’ï¼Œç”šè‡³å¯è¾¾åˆ†é’Ÿçº§ã€‚è¾ƒé•¿çš„å¯åŠ¨è€—æ—¶ï¼Œä¹ŸæŠ‘åˆ¶äº†æ°´å¹³ä¼¸ç¼©æ€§ã€‚å³ä½¿åœ¨ Serverless è¿™ç§å“åº”è€—æ—¶è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œä¹Ÿä¼šè¢«å«Œå¼ƒã€‚&lt;/li>
&lt;li>é•œåƒè¿‡å¤§ï¼šå…¶å®ä½¿ç”¨äº†é•œåƒçš„åˆ†å±‚è®¾è®¡ï¼Œå¸¸è§çš„ä¸€ä¸ª SpringCloud åº”ç”¨çš„ uÌˆber-jar åŒ…å¯èƒ½éƒ½æœ‰ 7ã€80MBã€‚&lt;/li>
&lt;li>ç©ºé—´å ç”¨ï¼šè™½ç„¶ç”¨äº†é•œåƒåˆ†å±‚ï¼Œä½†ç§¯å°‘æˆå¤šï¼Œä¹Ÿä¼šå¢åŠ å­˜å‚¨æˆæœ¬ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="quarkus-ä¸æœ¬æœºæ˜ åƒnative-image">Quarkus ä¸æœ¬æœºæ˜ åƒï¼ˆnative imageï¼‰&lt;/h2>
&lt;p>Quarkus çš„å¼€å‘éµä»äº†å®¹å™¨ä¼˜å…ˆçš„åŸåˆ™ï¼š&lt;/p>
&lt;ul>
&lt;li>æ”¯æŒ Graal/SubstrateVM&lt;/li>
&lt;li>æ„å»ºæ—¶å¤„ç†å…ƒæ•°æ®&lt;/li>
&lt;li>å‡å°‘åå°„çš„ä½¿ç”¨&lt;/li>
&lt;li>æœ¬æœºæ˜ åƒé¢„å¯åŠ¨&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>æœ¬æœºæ˜ åƒæ˜¯å°† Java ä»£ç æå‰ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆç§°ä¸ºæœ¬æœºæ˜ åƒï¼‰çš„æŠ€æœ¯ã€‚è¯¥å¯æ‰§è¡Œæ–‡ä»¶åŒ…æ‹¬åº”ç”¨ç¨‹åºç±»ã€å…¶ä¾èµ–é¡¹ä¸­çš„ç±»ã€è¿è¡Œæ—¶åº“ç±»ä»¥åŠ JDK ä¸­çš„é™æ€é“¾æ¥æœ¬æœºä»£ç ã€‚å®ƒä¸æ˜¯åœ¨ Java VM ä¸Šè¿è¡Œï¼Œè€Œæ˜¯åŒ…æ‹¬å¿…è¦çš„ç»„ä»¶ï¼Œä¾‹å¦‚å†…å­˜ç®¡ç†ï¼Œçº¿ç¨‹è°ƒåº¦ç­‰ï¼Œè¿™äº›ç»„ä»¶æ¥è‡ªå¦ä¸€ä¸ªè¿è¡Œæ—¶ç³»ç»Ÿ â€œSubstrate VMâ€ã€‚â€œSubstrate VMâ€ æ˜¯è¿è¡Œæ—¶ç»„ä»¶ï¼ˆä¾‹å¦‚åä¼˜åŒ–å™¨ï¼Œåƒåœ¾æ”¶é›†å™¨ï¼Œçº¿ç¨‹è°ƒåº¦ç­‰ï¼‰çš„åç§°ã€‚ä¸ JVM ç›¸æ¯”ï¼Œç”Ÿæˆçš„ç¨‹åºå…·æœ‰æ›´å¿«çš„å¯åŠ¨æ—¶é—´å’Œæ›´ä½çš„è¿è¡Œæ—¶å†…å­˜å¼€é”€ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="å¦‚ä½•æ„å»ºæœ¬æœºæ˜ åƒ">å¦‚ä½•æ„å»ºæœ¬æœºæ˜ åƒ&lt;/h2>
&lt;p>ç¯å¢ƒé…ç½®å‚è€ƒ&lt;a href="https://mp.weixin.qq.com/s/YcEqFm3oxlsEvJ3ckRbQyA">ä¸Šä¸€ç¯‡æ–‡ç« &lt;/a>ï¼Œå¯ä»¥ç›´æ¥&lt;a href="https://github.com/addozhang/quarkus-getting-started">ä»è¿™é‡Œä¸‹è½½æºç &lt;/a>ã€‚&lt;/p>
&lt;h3 id="é…ç½®-graalvm">é…ç½® GraalVM&lt;/h3>
&lt;p>ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨äº†&lt;a href="https://sdkman.io/"> sdkman&lt;/a> è¿›è¡Œ GraalVM å®‰è£…ã€‚è®¾ç½® &lt;code>GRAALVM_HOME&lt;/code> ç¯å¢ƒå˜é‡ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nb">export&lt;/span> &lt;span class="nv">GRAALVM_HOME&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>sdk home java 21.0.0.2.r11-grl&lt;span class="sb">`&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨ &lt;code>gu&lt;/code> å®‰è£… &lt;code>native-image&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="si">${&lt;/span>&lt;span class="nv">GRAALVM_HOME&lt;/span>&lt;span class="si">}&lt;/span>/bin/gu install native-image
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ„å»ºæœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶">æ„å»ºæœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶&lt;/h3>
&lt;p>åœ¨æºç çš„ &lt;code>pom.xml&lt;/code> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ &lt;code>profile&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="nt">&amp;lt;profiles&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;profile&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;id&amp;gt;&lt;/span>native&lt;span class="nt">&amp;lt;/id&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;properties&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;quarkus.package.type&amp;gt;&lt;/span>native&lt;span class="nt">&amp;lt;/quarkus.package.type&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/properties&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/profile&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/profiles&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ª profile è¿›è¡Œæœ¬æœºå¯æ‰§è¡Œæ–‡ä»¶çš„æ„å»ºï¼Œæ•´ä¸ªæ„å»ºè€—æ—¶ &lt;strong>å‡ åˆ†é’Ÿ&lt;/strong> ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">./mvnw package -Pnative
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éƒ¨åˆ†æ„å»ºæ—¥å¿—ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">[INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ quarkus-getting-started ---
[INFO]
[INFO] --- quarkus-maven-plugin:1.13.0.Final:build (default) @ quarkus-getting-started ---
[INFO] [org.jboss.threads] JBoss Threads version 3.2.0.Final
[INFO] [io.quarkus.deployment.pkg.steps.JarResultBuildStep] Building native image source jar: /Users/addo/Workspaces/private_w/quarkus-getting-started/target/quarkus-getting-started-1.0.0-SNAPSHOT-native-image-source-jar/quarkus-getting-started-1.0.0-SNAPSHOT-runner.jar
[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildStep] Building native image from /Users/addo/Workspaces/private_w/quarkus-getting-started/target/quarkus-getting-started-1.0.0-SNAPSHOT-native-image-source-jar/quarkus-getting-started-1.0.0-SNAPSHOT-runner.jar
[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildContainerRunner] Using docker to run the native image builder
[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildContainerRunner] Checking image status quay.io/quarkus/ubi-quarkus-native-image:21.0.0-java11
21.0.0-java11: Pulling from quarkus/ubi-quarkus-native-image
Digest: sha256:becf08de869e707beaa5e57444b533ef93ebef15aad90c92ac660ddf7cea2b11
Status: Image is up to date for quay.io/quarkus/ubi-quarkus-native-image:21.0.0-java11
quay.io/quarkus/ubi-quarkus-native-image:21.0.0-java11
[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildStep] Running Quarkus native-image plugin on GraalVM Version 21.0.0 (Java Version 11.0.10+8-jvmci-21.0-b06)
[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildRunner] docker run --env LANG=C --rm -v /Users/addo/Workspaces/private_w/quarkus-getting-started/target/quarkus-getting-started-1.0.0-SNAPSHOT-native-image-source-jar:/project:z quay.io/quarkus/ubi-quarkus-native-image:21.0.0-java11 -J-Dsun.nio.ch.maxUpdateArraySize=100 -J-Djava.util.logging.manager=org.jboss.logmanager.LogManager -J-Dvertx.logger-delegate-factory-class-name=io.quarkus.vertx.core.runtime.VertxLogDelegateFactory -J-Dvertx.disableDnsResolver=true -J-Dio.netty.leakDetection.level=DISABLED -J-Dio.netty.allocator.maxOrder=1 -J-Duser.language=en -J-Duser.country=CN -J-Dfile.encoding=UTF-8 --initialize-at-build-time= -H:InitialCollectionPolicy=com.oracle.svm.core.genscavenge.CollectionPolicy\$BySpaceAndTime -H:+JNI -H:+AllowFoldMethods -jar quarkus-getting-started-1.0.0-SNAPSHOT-runner.jar -H:FallbackThreshold=0 -H:+ReportExceptionStackTraces -J-Xmx5g -H:-AddAllCharsets -H:EnableURLProtocols=http --no-server -H:-UseServiceLoaderFeature -H:+StackTrace quarkus-getting-started-1.0.0-SNAPSHOT-runner
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] classlist: 5,859.24 ms, 0.96 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (cap): 633.34 ms, 0.94 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] setup: 2,468.19 ms, 0.94 GB
00:06:00,437 INFO [org.jbo.threads] JBoss Threads version 3.2.0.Final
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (clinit): 516.65 ms, 2.23 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (typeflow): 12,642.02 ms, 2.23 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (objects): 11,340.37 ms, 2.23 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (features): 525.87 ms, 2.23 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] analysis: 26,032.67 ms, 2.23 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] universe: 1,394.06 ms, 2.16 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (parse): 2,690.38 ms, 2.16 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (inline): 4,336.77 ms, 2.73 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] (compile): 17,580.03 ms, 2.71 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] compile: 26,152.06 ms, 2.71 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] image: 3,288.43 ms, 2.70 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] write: 1,904.64 ms, 2.70 GB
[quarkus-getting-started-1.0.0-SNAPSHOT-runner:25] [total]: 67,414.16 ms, 2.70 GB
[WARNING] [io.quarkus.deployment.pkg.steps.NativeImageBuildStep] objcopy executable not found in PATH. Debug symbols will not be separated from executable.
[WARNING] [io.quarkus.deployment.pkg.steps.NativeImageBuildStep] That will result in a larger native image with debug symbols embedded in it.
[INFO] [io.quarkus.deployment.QuarkusAugmentor] Quarkus augmentation completed in 74739ms
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 01:21 min
[INFO] Finished at: 2021-04-17T08:06:47+08:00
[INFO] ------------------------------------------------------------------------
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>å‡å¦‚æ„å»ºæ—¶å‡ºç°ç±»ä¼¼ &lt;code>Caused by: java.lang.RuntimeException: Image generation failed. Exit code was 137 which indicates an out of memory error. Consider increasing the Xmx value for native image generation by setting the &amp;quot;quarkus.native.native-image-xmx&amp;quot; property&lt;/code> è¿™ç§æŠ¥é”™ã€‚éœ€è¦è°ƒæ•´ä¸‹ Docker çš„è®¾ç½®ï¼Œæ¯”å¦‚ç¬”è€…ä½¿ç”¨çš„ macOSï¼Œæ‰“å¼€ Docker Desktop &amp;gt; Preference &amp;gt; Resource &amp;gt; Advancedï¼Œå°†å†…å­˜ä»é»˜è®¤çš„ 2GB è°ƒå¤§ï¼Œæ¯”å¦‚ 8GBã€‚&lt;/p>
&lt;p>ä»æ„å»ºæ—¥å¿—å¯ä»¥çœ‹å‡ºï¼Œæ„å»ºçš„è¿‡ç¨‹æ˜¯åœ¨ &lt;code>quay.io/quarkus/ubi-quarkus-native-image&lt;/code> çš„å®¹å™¨ä¸­å®Œæˆçš„ã€‚è™½ç„¶å¼‚å¸¸æç¤ºè°ƒæ•´ &amp;ldquo;quarkus.native.native-image-xmx&amp;rdquo; ï¼Œå…¶å®æ˜¯å®¹å™¨å†…å­˜å¤ªå°å¯¼è‡´çš„ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ„å»ºæˆåŠŸåï¼Œå¯ä»¥åœ¨ &lt;code>target&lt;/code> ä¸­æ‰¾åˆ° &lt;code>quarkus-getting-started-1.0.0-SNAPSHOT-runner&lt;/code>ã€‚è¿™æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¤§å°ä¸º 28MBã€‚&lt;/p>
&lt;p>å°è¯•æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œæ”¶åˆ° &lt;code>zsh: exec format error: ./target/quarkus-getting-started-1.0.0-SNAPSHOT-runner&lt;/code> é”™è¯¯ã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ª Linux å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨å®¹å™¨ä¸­è¿è¡Œã€‚&lt;/p>
&lt;h3 id="æ„å»ºæœ¬æœºé•œåƒ">æ„å»ºæœ¬æœºé•œåƒ&lt;/h3>
&lt;p>åœ¨æºæ–‡ä»¶çš„ &lt;code>src/main/docker&lt;/code> ç›®å½•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ° &lt;code>Dockerfile.native&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-Dockerfile" data-lang="Dockerfile">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> registry.access.redhat.com/ubi8/ubi-minimal:8.3&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /work/&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> chown &lt;span class="m">1001&lt;/span> /work &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> chmod &lt;span class="s2">&amp;#34;g+rwX&amp;#34;&lt;/span> /work &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> chown 1001:root /work&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --chown&lt;span class="o">=&lt;/span>1001:root target/*-runner /work/application&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">EXPOSE&lt;/span>&lt;span class="s"> 8080&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">USER&lt;/span>&lt;span class="s"> 1001&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">CMD&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;./application&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;-Dquarkus.http.host=0.0.0.0&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è¿è¡Œé•œåƒ">è¿è¡Œé•œåƒ&lt;/h3>
&lt;p>æœ¬åœ°è¿è¡Œä¸€ä¸‹ï¼Œå¯ä»¥çœ‹å‡ºå¯åŠ¨åªéœ€è¦ &lt;code>0.013s&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker run --rm -p 8080:8080 quarkus/quarkus-getting-started:latest
__ ____ __ _____ ___ __ ____ ______
--/ __ &lt;span class="se">\/&lt;/span> / / / _ &lt;span class="p">|&lt;/span> / _ &lt;span class="se">\/&lt;/span> //_/ / / / __/
-/ /_/ / /_/ / __ &lt;span class="p">|&lt;/span>/ , _/ ,&amp;lt; / /_/ /&lt;span class="se">\ \
&lt;/span>&lt;span class="se">&lt;/span>--&lt;span class="se">\_&lt;/span>__&lt;span class="se">\_\_&lt;/span>___/_/ &lt;span class="p">|&lt;/span>_/_/&lt;span class="p">|&lt;/span>_/_/&lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span>&lt;span class="se">\_&lt;/span>___/___/
2021-04-17 00:22:27,146 INFO &lt;span class="o">[&lt;/span>io.quarkus&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>main&lt;span class="o">)&lt;/span> quarkus-getting-started 1.0.0-SNAPSHOT native &lt;span class="o">(&lt;/span>powered by Quarkus 1.13.0.Final&lt;span class="o">)&lt;/span> started in 0.013s. Listening on: http://0.0.0.0:8080
2021-04-17 00:22:27,147 INFO &lt;span class="o">[&lt;/span>io.quarkus&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>main&lt;span class="o">)&lt;/span> Profile prod activated.
2021-04-17 00:22:27,147 INFO &lt;span class="o">[&lt;/span>io.quarkus&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>main&lt;span class="o">)&lt;/span> Installed features: &lt;span class="o">[&lt;/span>cdi, resteasy&lt;span class="o">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æµ‹è¯•ä¸€ä¸‹ç«¯ç‚¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">http :8080/hello/greeting/quarkus
HTTP/1.1 &lt;span class="m">200&lt;/span> OK
Content-Length: &lt;span class="m">14&lt;/span>
Content-Type: text/plain&lt;span class="p">;&lt;/span>&lt;span class="nv">charset&lt;/span>&lt;span class="o">=&lt;/span>UTF-8
Hello, quarkus
&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹ä¸‹é•œåƒçš„ä¿¡æ¯ï¼Œå¤§å°ä¸º 132MBï¼Œå…¶ä¸­ base é•œåƒ &lt;code>ubi-minimal&lt;/code> å°±å äº† 103 MBã€‚æ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹å¤§ï¼Œæ˜¯å¦ç»§ç»­ç²¾ç®€ä¸€ä¸‹ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker images
REPOSITORY TAG IMAGE ID CREATED SIZE
quarkus/quarkus-getting-started latest 8f86f5915715 &lt;span class="m">4&lt;/span> minutes ago 132MB
registry.access.redhat.com/ubi8/ubi-minimal 8.3 604ddd554fec &lt;span class="m">2&lt;/span> weeks ago 103MB
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="é•œåƒç˜¦èº«">é•œåƒç˜¦èº«&lt;/h3>
&lt;p>åœ¨ &lt;code>src/main/docker&lt;/code> ä¸­è¿˜æœ‰ä¸ªåä¸º &lt;code>Dockerfile.native-distroless&lt;/code> çš„Dockerfileï¼Œé‡Œé¢ä½¿ç”¨äº† &lt;code>quay.io/quarkus/quarkus-distroless-image:1.0&lt;/code> ä½œä¸º base é•œåƒ&lt;/p>
&lt;p>ä½¿ç”¨è¿™ä¸ªDockerfileè¿›è¡Œæ„å»ºï¼Œå¾—åˆ°çš„é•œåƒå°±å°å¾ˆå¤šï¼Œåªæœ‰ 51MBï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker images
REPOSITORY TAG IMAGE ID CREATED SIZE
quarkus/quarkus-getting-started distroless 6fe27dd44e86 &lt;span class="m">33&lt;/span> seconds ago 51MB
quarkus/quarkus-getting-started ubi 8f86f5915715 &lt;span class="m">27&lt;/span> minutes ago 132MB
quay.io/quarkus/quarkus-distroless-image 1.0 062663862a83 &lt;span class="m">6&lt;/span> days ago 21.3MB
registry.access.redhat.com/ubi8/ubi-minimal 8.3 604ddd554fec &lt;span class="m">2&lt;/span> weeks ago 103MB
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡ŒæˆåŠŸï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker run --rm -p 8080:8080 quarkus/quarkus-getting-started:distroless
__ ____ __ _____ ___ __ ____ ______
--/ __ &lt;span class="se">\/&lt;/span> / / / _ &lt;span class="p">|&lt;/span> / _ &lt;span class="se">\/&lt;/span> //_/ / / / __/
-/ /_/ / /_/ / __ &lt;span class="p">|&lt;/span>/ , _/ ,&amp;lt; / /_/ /&lt;span class="se">\ \
&lt;/span>&lt;span class="se">&lt;/span>--&lt;span class="se">\_&lt;/span>__&lt;span class="se">\_\_&lt;/span>___/_/ &lt;span class="p">|&lt;/span>_/_/&lt;span class="p">|&lt;/span>_/_/&lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span>&lt;span class="se">\_&lt;/span>___/___/
2021-04-17 00:51:26,070 INFO &lt;span class="o">[&lt;/span>io.quarkus&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>main&lt;span class="o">)&lt;/span> quarkus-getting-started 1.0.0-SNAPSHOT native &lt;span class="o">(&lt;/span>powered by Quarkus 1.13.0.Final&lt;span class="o">)&lt;/span> started in 0.013s. Listening on: http://0.0.0.0:8080
2021-04-17 00:51:26,071 INFO &lt;span class="o">[&lt;/span>io.quarkus&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>main&lt;span class="o">)&lt;/span> Profile prod activated.
2021-04-17 00:51:26,071 INFO &lt;span class="o">[&lt;/span>io.quarkus&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>main&lt;span class="o">)&lt;/span> Installed features: &lt;span class="o">[&lt;/span>cdi, resteasy&lt;span class="o">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æè‡´ç˜¦èº«ï¼Œå‚è€ƒäº†&lt;a href="https://capgemini.github.io/development/Introduction-to-Quarkus-Supersonic-Subatomic-Java/#distroless-images">è¿™é‡Œ&lt;/a>ï¼Œæˆ‘ä»¬åˆ›å»º &lt;code>Dockerfile.native-distroless2&lt;/code>ã€‚&lt;/p>
&lt;p>æœ€ç»ˆé•œåƒçš„å¤§å°ä¸º 49MBï¼Œä¸å®˜æ–¹æä¾›çš„ distroless base é•œåƒåªå°äº† 2MBã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker images
REPOSITORY TAG IMAGE ID CREATED SIZE
quarkus/quarkus-getting-started distroless2 fe973c5ac172 &lt;span class="m">3&lt;/span> seconds ago 49MB
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‰é¢å¯¹æ¯”ï¼Œç”¨æ¥æ„å»º Spring åº”ç”¨çš„ base é•œåƒ &lt;code>openjdk:11.0-jre-slim&lt;/code> å·²ç»æœ‰ 220MBï¼Œè¿™è¿˜æ²¡ç®—ä¸Šåº”ç”¨çš„å¤§å°ã€‚å³ä½¿æ˜¯ &lt;code>openjdk:17-alpine3.13&lt;/code> ä¹Ÿæœ‰ 182 MBã€‚&lt;/p>
&lt;h2 id="next">NEXT&lt;/h2>
&lt;p>ä¸‹ä¸€å›ï¼Œæˆ‘ä»¬è¯•è¯• Quarkus åœ¨ ArgoCD ä¸­çš„åº”ç”¨ï¼Œçœ‹ä¸‹ Serverless ä¸Šçš„ä½¿ç”¨ä½“éªŒå¦‚ä½•ã€‚&lt;/p></description></item><item><title>åº”â€œäº‘â€è€Œç”Ÿçš„ Java æ¡†æ¶ï¼šHello, Quarkus</title><link>https://atbug.com/hello-quarkus/</link><pubDate>Mon, 05 Apr 2021 21:08:40 +0800</pubDate><guid>https://atbug.com/hello-quarkus/</guid><description>
&lt;p>Wikipediaä¸Šæœ‰å…³ Quarkus çš„ä¿¡æ¯è¿˜å¾ˆå°‘ï¼Œåªæœ‰ä¸€å¥ç®€å•çš„ä»‹ç»ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Quarkus æ˜¯ä¸“ä¸º OpenJDK HotSpot å’Œ GraalVM å®šåˆ¶çš„å…¨æ ˆ Kubernetes åŸç”Ÿ Java åº”ç”¨ç¨‹åºæ¡†æ¶ã€‚ä¸å¦‚ Spring ä¹‹ç±»çš„å…¶ä»–æ¡†æ¶ç›¸æ¯”ï¼Œå®ƒæä¾›äº†è¾ƒå°çš„å†…å­˜å ç”¨å¹¶ç¼©çŸ­äº†å¯åŠ¨æ—¶é—´ã€‚å®ƒå…è®¸ç»“åˆå‘½ä»¤å¼å’Œéé˜»å¡å“åº”å¼ç¼–ç¨‹ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ä» Quarkus çš„&lt;a href="https://quarkus.io/">å®˜ç½‘&lt;/a>ï¼Œå¯ä»¥çœ‹åˆ°å…¶æœ‰å‡ ä¸ªç‰¹æ€§ï¼š&lt;/p>
&lt;ul>
&lt;li>å®¹å™¨ä¼˜å…ˆ&lt;/li>
&lt;li>ç»Ÿä¸€äº†å‘½ä»¤å¼å’Œå“åº”å¼ç¼–ç¨‹&lt;/li>
&lt;li>å¼€å‘è€…å‹å¥½&lt;/li>
&lt;li>æœ€ä½³å“ç§çš„åº“åŠæ ‡å‡†&lt;/li>
&lt;/ul>
&lt;p>æ›´å¤š Quarkus å¯ä»¥å‚è€ƒ&lt;a href="https://quarkus.io/">å®˜ç½‘&lt;/a>çš„ä»‹ç»åŠæ–‡æ¡£ã€‚ä»Šå¤©ä¸»è¦å°±æ˜¯è·‘ä¸€ä¸‹ Quarkus çš„ &lt;code>Hello world&lt;/code>ã€‚&lt;/p>
&lt;p>æ”¾ä¸€å¼ å®˜ç½‘çš„å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/05/16176279246527.jpg" alt="">&lt;/p>
&lt;h2 id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡&lt;/h2>
&lt;ul>
&lt;li>åŸºäº Java 11 çš„ GraalVM&lt;/li>
&lt;li>Maven 3.6.2+&lt;/li>
&lt;/ul>
&lt;p>ç¬”è€…ä½¿ç”¨çš„æ˜¯ macos 10.15.4ï¼ŒGraalVM å’Œ Maven å»ºè®®é€šè¿‡ &lt;a href="https://sdkman.io">sdkman&lt;/a> è¿›è¡Œå®‰è£…ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ sdk install java 21.0.0.2.r11-grl &lt;span class="c1">#å¦‚æœå·²ä½¿ç”¨å…¶ä»– java ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ sdk use java 21.0.0.2.r11-grl è¿›è¡Œåˆ‡æ¢&lt;/span>
$ sdk install maven 3.6.3
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="éªŒè¯å®‰è£…">éªŒè¯å®‰è£…&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ java -version
openjdk version &lt;span class="s2">&amp;#34;11.0.10&amp;#34;&lt;/span> 2021-01-19
OpenJDK Runtime Environment GraalVM CE 21.0.0.2 &lt;span class="o">(&lt;/span>build 11.0.10+8-jvmci-21.0-b06&lt;span class="o">)&lt;/span>
OpenJDK 64-Bit Server VM GraalVM CE 21.0.0.2 &lt;span class="o">(&lt;/span>build 11.0.10+8-jvmci-21.0-b06, mixed mode, sharing&lt;span class="o">)&lt;/span>
$ mvn -version
Apache Maven 3.6.3 &lt;span class="o">(&lt;/span>cecedd343002696d0abb50b32b541b8a6ba2883f&lt;span class="o">)&lt;/span>
Maven home: /Users/addo/.sdkman/candidates/maven/current
Java version: 11.0.10, vendor: GraalVM Community, runtime: /Users/addo/.sdkman/candidates/java/21.0.0.2.r11-grl
Default locale: en_CN, platform encoding: UTF-8
OS name: &lt;span class="s2">&amp;#34;mac os x&amp;#34;&lt;/span>, version: &lt;span class="s2">&amp;#34;10.15.4&amp;#34;&lt;/span>, arch: &lt;span class="s2">&amp;#34;x86_64&amp;#34;&lt;/span>, family: &lt;span class="s2">&amp;#34;mac&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹&lt;/h2>
&lt;h3 id="åˆ›å»ºé¡¹ç›®">åˆ›å»ºé¡¹ç›®&lt;/h3>
&lt;p>åˆ›å»º quarkus é¡¹ç›®æœ€å¿«çš„æ–¹å¼æ˜¯é€šè¿‡ &lt;code>quarkus-maven-plugin&lt;/code> æ¥åˆ›å»ºï¼Œä½¿ç”¨å¦‚ä¸‹çš„å‘½ä»¤å¿«é€Ÿå¯ä»¥åˆ›å»º&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ mvn io.quarkus:quarkus-maven-plugin:1.13.0.Final:create &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> -DprojectGroupId&lt;span class="o">=&lt;/span>com.atbug.quickstart &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> -DprojectArtifactId&lt;span class="o">=&lt;/span>quarkus-getting-started &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> -DclassName&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;com.atbug.quickstart.GreetingResource&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> -Dpath&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/hello&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ &lt;code>./quarkus-getting-started&lt;/code> ä¸­æä¾›äº†ï¼š&lt;/p>
&lt;ul>
&lt;li>maven çš„é¡¹ç›®ç»“æ„&lt;/li>
&lt;li>&lt;code>com.atbug.quickstart.GreetingResource&lt;/code> æš´éœ²äº† &lt;code>/hello&lt;/code> ç«¯ç‚¹ï¼Œé€šè¿‡ &lt;code>JAX-RS&lt;/code> æ³¨è§£å®ç°&lt;/li>
&lt;li>ç›¸å…³çš„å•å…ƒæµ‹è¯•&lt;/li>
&lt;li>åº”ç”¨å¯åŠ¨åå¯ä»¥é€šè¿‡ &lt;code>http://localhost:8080&lt;/code> æ‰“å¼€çš„å¯åŠ¨é¡µé¢&lt;/li>
&lt;li>&lt;code>src/main/docker&lt;/code> ä¸‹æä¾›äº† &lt;code>native&lt;/code> å’Œ &lt;code>jvm&lt;/code> é£æ ¼çš„ Dockerfile&lt;/li>
&lt;li>åº”ç”¨é…ç½®æ–‡ä»¶&lt;/li>
&lt;/ul>
&lt;h3 id="è¿è¡Œåº”ç”¨">è¿è¡Œåº”ç”¨&lt;/h3>
&lt;p>æ‰§è¡Œ &lt;code>./mvnw compile quarkus:dev&lt;/code> å‘½ä»¤å¯å¯åŠ¨åº”ç”¨&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">__ ____ __ _____ ___ __ ____ ______
--/ __ &lt;span class="se">\/&lt;/span> / / / _ &lt;span class="p">|&lt;/span> / _ &lt;span class="se">\/&lt;/span> //_/ / / / __/
-/ /_/ / /_/ / __ &lt;span class="p">|&lt;/span>/ , _/ ,&amp;lt; / /_/ /&lt;span class="se">\ \
&lt;/span>&lt;span class="se">&lt;/span>--&lt;span class="se">\_&lt;/span>__&lt;span class="se">\_\_&lt;/span>___/_/ &lt;span class="p">|&lt;/span>_/_/&lt;span class="p">|&lt;/span>_/_/&lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span>&lt;span class="se">\_&lt;/span>___/___/
2021-04-05 19:48:36,419 INFO &lt;span class="o">[&lt;/span>io.quarkus&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>Quarkus Main Thread&lt;span class="o">)&lt;/span> quarkus-getting-started 1.0.0-SNAPSHOT on JVM &lt;span class="o">(&lt;/span>powered by Quarkus 1.13.0.Final&lt;span class="o">)&lt;/span> started in 2.135s. Listening on: http://localhost:8080
2021-04-05 19:48:36,448 INFO &lt;span class="o">[&lt;/span>io.quarkus&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>Quarkus Main Thread&lt;span class="o">)&lt;/span> Profile dev activated. Live Coding activated.
2021-04-05 19:48:36,448 INFO &lt;span class="o">[&lt;/span>io.quarkus&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>Quarkus Main Thread&lt;span class="o">)&lt;/span> Installed features: &lt;span class="o">[&lt;/span>cdi, resteasy&lt;span class="o">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è®¿é—® &lt;code>/hello&lt;/code> æ–­ç‚¹&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">$ http :8080/hello
HTTP/1.1 200 OK
Content-Length: 5
Content-Type: text/plain;charset=UTF-8
Hello
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>ç¬”è€…é€šè¿‡ &lt;code>httpie&lt;/code> è¿›è¡Œè®¿é—®ï¼Œå¯ä»¥é€šè¿‡ &lt;code>brew install httpie&lt;/code> è¿›è¡Œå®‰è£…ï¼Œæ¨èä½¿ç”¨ã€‚&lt;/p>
&lt;/blockquote>
&lt;h4 id="å¢åŠ æ–°çš„æ–­ç‚¹">å¢åŠ æ–°çš„æ–­ç‚¹&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java"> &lt;span class="nd">@GET&lt;/span>
&lt;span class="nd">@Produces&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MediaType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">TEXT_PLAIN&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Path&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/greeting/{name}&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">greeting&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nd">@PathParam&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;Hello, &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨ï¼š&lt;code>PathParam&lt;/code> æ¥è‡ª &lt;code>org.jboss.resteasy.annotations.jaxrs.PathParam&lt;/code>&lt;/p>
&lt;p>æµ‹è¯•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ http :8080/hello/greeting/Quarkus
HTTP/1.1 &lt;span class="m">200&lt;/span> OK
Content-Length: &lt;span class="m">14&lt;/span>
Content-Type: text/plain&lt;span class="p">;&lt;/span>&lt;span class="nv">charset&lt;/span>&lt;span class="o">=&lt;/span>UTF-8
Hello, Quarkus
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸ºæ–°çš„ç«¯ç‚¹å¢åŠ å•å…ƒæµ‹è¯•&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java"> &lt;span class="nd">@Test&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">testGreetingEndpoint&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">uuid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">UUID&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">randomUUID&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">given&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">pathParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">uuid&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">when&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/hello/greeting/{name}&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">then&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">statusCode&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">200&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">body&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">is&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Hello, &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">uuid&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šè¿‡ &lt;code>./mvnw test&lt;/code> è¿è¡Œå•å…ƒæµ‹è¯•&lt;/p>
&lt;blockquote>
&lt;p>æ³¨æ„è¿™é‡Œä½¿ç”¨ intellij è¿è¡Œå•å…ƒæµ‹è¯•çš„è¯ï¼Œä¼šæŠ¥é”™ã€‚éœ€è¦ä¿®æ”¹ Java Compiler çš„é…ç½®ï¼Œæ·»åŠ é¢å¤–çš„å‘½ä»¤è¡Œå‚æ•° &lt;code>-parameters&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/05/16176241035940.jpg" alt="">&lt;/p>
&lt;/blockquote>
&lt;h3 id="æ‰“åŒ…">æ‰“åŒ…&lt;/h3>
&lt;p>ä¸é€šå¸¸çš„ maven é¡¹ç›®æ‰“åŒ…æ–¹å¼ä¸€æ ·ï¼Œæ‰§è¡Œ &lt;code>./mvnw package&lt;/code>ï¼Œåœ¨ &lt;code>target&lt;/code> ç›®å½•ä¸­ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>quarkus-getting-started-1.0.0-SNAPSHOT.jar&lt;/code> ä»…åŒ…å«äº†é¡¹ç›®ç¼–è¯‘çš„ç±»å’Œèµ„æºæ–‡ä»¶ï¼Œæ˜¯ä¸å¯æ‰§è¡Œçš„ jar&lt;/li>
&lt;li>&lt;code>quarkus-app&lt;/code> ç›®å½•ä¸­åŒ…å«äº†å¯æ‰§è¡Œçš„ jar æ–‡ä»¶ &lt;code>quarkus-run.jar&lt;/code> ï¼Œ&lt;strong>ä½†æ˜¯&lt;/strong>ï¼Œå…¶å¹¶ä¸æ˜¯ä¸€ä¸ª &lt;code>Ã¼ber-jar&lt;/code>ï¼Œé¡¹ç›®çš„ä¾èµ–åº“éƒ½ä½äº &lt;code>lib&lt;/code>ç›®å½•ä¸­ã€‚&lt;/li>
&lt;/ul>
&lt;p>å¯ä»¥é€šè¿‡æ‰§è¡Œ &lt;code>java -jar target/quarkus-app/quarkus-run.jar&lt;/code> åœ¨å¯åŠ¨åº”ç”¨ã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¿™æ„å‘³ç€å‡å¦‚ä½ æƒ³åœ¨å®¹å™¨ä¸­è¿è¡Œï¼Œéœ€è¦éƒ¨ç½²æ•´ä¸ª &lt;code>quarkus-app&lt;/code> ç›®å½•&lt;/p>
&lt;/blockquote>
&lt;h4 id="ä½¿ç”¨-fast-jar">ä½¿ç”¨ fast-jar&lt;/h4>
&lt;p>qurakus çš„æ‰“åŒ…æ–¹å¼æœ‰ä¸¤ç§ï¼š&lt;code>legacy-jar&lt;/code> å’Œ &lt;code>fast-jar&lt;/code>ã€‚å¯ä»¥åœ¨ &lt;code>application.properties&lt;/code> æ–‡ä»¶ä¸­è¿›è¡ŒæŒ‡å®šï¼Œæœªæ˜¾å¼æŒ‡å®šé»˜è®¤ä¸º &lt;code>legacy-jar&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">quarkus.package.type=fast-jar
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>å¦‚æœè¦åœ¨å®¹å™¨ä¸­è¿è¡Œï¼ŒåŒæ ·éœ€è¦éƒ¨ç½²æ•´ä¸ª &lt;code>quarkus-app&lt;/code> ç›®å½•
&lt;code>fast-jar&lt;/code> ç±»å‹çš„åŒ…æ¯” &lt;code>legacy-jar&lt;/code> çš„åŒ…å¯åŠ¨ä¼šå¿«ä¸€ç‚¹ç‚¹ï¼ŒåŒæ—¶å ç”¨çš„å†…å­˜ä¹Ÿæ›´ä½ã€‚å› ä¸º &lt;code>fast-jar&lt;/code> çš„åŒ…å«äº†ä¾èµ–åŒ…ä¸­çš„ç±»å’Œèµ„æºæ–‡ä»¶çš„ç´¢å¼•ï¼Œé¿å…åœ¨ç±»å’Œèµ„æºæ–‡ä»¶åŠ è½½æ—¶å¯¹ classpath ä¸‹çš„åŒ…çš„æŸ¥æ‰¾ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>ä¸‹ä¸€ç¯‡ï¼Œè¯•è¯•æ„å»ºä¸€ä¸ªåŸç”Ÿçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚&lt;/strong>&lt;/p></description></item><item><title>åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨ Kubernetes ä¸Šçš„è¿›åŒ–</title><link>https://atbug.com/translation-distributed-systems-kubernetes/</link><pubDate>Mon, 29 Mar 2021 23:11:25 +0800</pubDate><guid>https://atbug.com/translation-distributed-systems-kubernetes/</guid><description>
&lt;p>æœ¬æ–‡è¯‘è‡ª &lt;a href="https://www.infoq.com/articles/distributed-systems-kubernetes/">The Evolution of Distributed Systems on Kubernetes&lt;/a>&lt;/p>
&lt;p>åœ¨ 3 æœˆä»½çš„ QCon ä¸Šï¼Œæˆ‘åšäº†ä¸€ä¸ªå…³äº Kubernetes çš„åˆ†å¸ƒå¼ç³»ç»Ÿè¿›åŒ–çš„æ¼”è®²ã€‚é¦–å…ˆï¼Œæˆ‘æƒ³å…ˆé—®ä¸€ä¸ªé—®é¢˜ï¼Œå¾®æœåŠ¡ä¹‹åæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ç›¸ä¿¡å¤§å®¶éƒ½æœ‰å„è‡ªçš„ç­”æ¡ˆï¼Œæˆ‘ä¹Ÿæœ‰æˆ‘çš„ç­”æ¡ˆã€‚ä½ ä¼šåœ¨æœ€åå‘ç°æˆ‘çš„æƒ³æ³•æ˜¯ä»€ä¹ˆã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæˆ‘å»ºè®®å¤§å®¶çœ‹çœ‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Ÿä»¥åŠè¿™äº›éœ€æ±‚åœ¨è¿‡å»æ˜¯å¦‚ä½•å‘å±•çš„ï¼Œä»å•ä½“åº”ç”¨å¼€å§‹åˆ° Kubernetesï¼Œå†åˆ°æœ€è¿‘çš„ Daprã€Istioã€Knative ç­‰é¡¹ç›®ï¼Œå®ƒä»¬æ˜¯å¦‚ä½•æ”¹å˜æˆ‘ä»¬åšåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ–¹å¼ã€‚æˆ‘ä»¬å°†å°è¯•å¯¹æœªæ¥åšä¸€äº›é¢„æµ‹ã€‚&lt;/p>
&lt;h2 id="ç°ä»£åˆ†å¸ƒå¼åº”ç”¨">ç°ä»£åˆ†å¸ƒå¼åº”ç”¨&lt;/h2>
&lt;p>ä¸ºäº†ç»™è¿™ä¸ªè¯é¢˜æä¾›æ›´å¤šçš„èƒŒæ™¯ä¿¡æ¯ï¼Œæˆ‘è®¤ä¸ºçš„åˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ç”±æ•°ç™¾ä¸ªç»„ä»¶ç»„æˆçš„ç³»ç»Ÿã€‚è¿™äº›ç»„ä»¶å¯ä»¥æ˜¯æœ‰çŠ¶æ€çš„ã€æ— çŠ¶æ€çš„æˆ–è€…æ— æœåŠ¡å™¨çš„ã€‚æ­¤å¤–ï¼Œè¿™äº›ç»„ä»¶å¯ä»¥ç”¨ä¸åŒçš„è¯­è¨€åˆ›å»ºï¼Œè¿è¡Œåœ¨æ··åˆç¯å¢ƒä¸Šï¼Œå¹¶å¼€å‘å¼€æºæŠ€æœ¯ã€å¼€æ”¾æ ‡å‡†å’Œäº’æ“ä½œæ€§ã€‚æˆ‘ç›¸ä¿¡ä½ å¯ä»¥ä½¿ç”¨é—­æºè½¯ä»¶æ¥æ„å»ºè¿™æ ·çš„ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥åœ¨ AWS å’Œå…¶ä»–åœ°æ–¹æ„å»ºã€‚å…·ä½“åˆ°è¿™æ¬¡æ¼”è®²ï¼Œæˆ‘å°†å…³æ³¨ Kubernetes ç”Ÿæ€ç³»ç»Ÿï¼Œä»¥åŠä½ å¦‚ä½•åœ¨ Kubernetes å¹³å°ä¸Šæ„å»ºè¿™æ ·ä¸€ä¸ªç³»ç»Ÿã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä»åˆ†å¸ƒå¼ç³»ç»Ÿçš„éœ€æ±‚è®²èµ·ã€‚æˆ‘è®¤ä¸ºæ˜¯æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªåº”ç”¨æˆ–è€…æœåŠ¡ï¼Œå¹¶å†™ä¸€äº›ä¸šåŠ¡é€»è¾‘ã€‚é‚£ä»è¿è¡Œæ—¶çš„å¹³å°åˆ°æ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä»€ä¹ˆå‘¢ï¼Ÿåœ¨åº•å±‚ï¼Œæœ€å¼€å§‹æ˜¯æˆ‘ä»¬è¦ä¸€äº›ç”Ÿå‘½å‘¨æœŸçš„èƒ½åŠ›ã€‚å½“ä½ ç”¨ä»»ä¸€è¯­è¨€å¼€å‘ä½ çš„åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰èƒ½åŠ›æŠŠè¿™ä¸ªåº”ç”¨å¯é åœ°æ‰“åŒ…å’Œéƒ¨ç½²ã€å›æ»šã€å¥åº·æ£€æŸ¥ã€‚å¹¶ä¸”èƒ½å¤ŸæŠŠåº”ç”¨éƒ¨ç½²åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œå¹¶å®ç°èµ„æºéš”ç¦»ã€æ‰©å±•ã€é…ç½®ç®¡ç†ï¼Œä»¥åŠæ‰€æœ‰è¿™äº›ã€‚è¿™äº›éƒ½æ˜¯ä½ åˆ›å»ºåˆ†å¸ƒå¼åº”ç”¨æ‰€éœ€è¦çš„ç¬¬ä¸€ç‚¹ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/55image0011616431697020.jpg" alt="">&lt;/p>
&lt;p>ç¬¬äºŒç‚¹æ˜¯å›´ç»•ç½‘ç»œã€‚æˆ‘ä»¬æœ‰äº†åº”ç”¨ä¹‹åï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒèƒ½å¤Ÿå¯é åœ°è¿æ¥åˆ°å…¶ä»–æœåŠ¡ï¼Œæ— è®ºè¯¥æœåŠ¡æ˜¯åœ¨é›†ç¾¤å†…éƒ¨è¿˜æ˜¯åœ¨å¤–éƒ¨ã€‚æˆ‘ä»¬å¸Œæœ›å…¶å…·æœ‰æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ã€‚ä¸ºäº†ä¸åŒçš„å‘å¸ƒç­–ç•¥æˆ–æ˜¯å…¶ä»–çš„ä¸€äº›åŸå› çš„æˆ‘ä»¬å¸Œæœ›æœ‰æµé‡è½¬ç§»çš„èƒ½åŠ›ã€‚ç„¶åæˆ‘ä»¬è¿˜å¸Œæœ›å…¶å…·æœ‰ä¸å…¶ä»–ç³»ç»Ÿè¿›è¡Œå¼¹æ€§é€šä¿¡çš„èƒ½åŠ›ï¼Œæ— è®ºæ˜¯é€šè¿‡é‡è¯•ã€è¶…æ—¶è¿˜æ˜¯æ–­è·¯å™¨ã€‚è¦æœ‰é€‚å½“çš„å®‰å…¨ä¿éšœï¼Œå¹¶ä¸”è¦æœ‰è¶³å¤Ÿçš„ç›‘æ§ã€è¿½è¸ªã€å¯è§‚å¯Ÿæ€§ç­‰ç­‰ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/25image0021616431698392.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬æœ‰äº†ç½‘ç»œä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬å¸Œæœ›æœ‰èƒ½åŠ›ä¸ä¸åŒçš„ API å’Œç«¯ç‚¹äº¤äº’ï¼Œå³èµ„æºç»‘å®š&amp;ndash;ä¸å…¶ä»–åè®®å’Œä¸åŒçš„æ•°æ®æ ¼å¼äº¤äº’ã€‚ç”šè‡³èƒ½å¤Ÿä»ä¸€ç§æ•°æ®æ ¼å¼è½¬æ¢æˆå¦ä¸€ç§æ•°æ®æ ¼å¼ã€‚æˆ‘è¿˜ä¼šåœ¨è¿™é‡ŒåŠ å…¥è¯¸å¦‚æ»¤å…‰çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬è®¢é˜…ä¸€ä¸ªä¸»é¢˜æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè®¸åªå¯¹æŸäº›äº‹ä»¶æ„Ÿå…´è¶£ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/45image0031616431697873.jpg" alt="">&lt;/p>
&lt;p>ä½ è®¤ä¸ºæœ€åä¸€ç±»æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯çŠ¶æ€ã€‚å½“æˆ‘åœ¨è¯´çŠ¶æ€å’Œæœ‰çŠ¶æ€çš„æŠ½è±¡æ—¶ï¼Œæˆ‘å¹¶ä¸æ˜¯åœ¨è°ˆè®ºå®é™…çš„çŠ¶æ€ç®¡ç†ï¼Œæ¯”å¦‚æ•°æ®åº“æˆ–è€…æ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½ã€‚æˆ‘è¦è¯´çš„æ›´å¤šæ˜¯æœ‰å…³å¹•åä¾èµ–çŠ¶æ€çš„å¼€å‘äººå‘˜æŠ½è±¡ã€‚å¯èƒ½ï¼Œä½ éœ€è¦å…·æœ‰å·¥ä½œæµç®¡ç†çš„èƒ½åŠ›ã€‚ä¹Ÿè®¸ä½ æƒ³ç®¡ç†è¿è¡Œæ—¶é—´é•¿çš„è¿›ç¨‹æˆ–è€…åšä¸´æ—¶è°ƒåº¦æˆ–è€…æŸäº›å®šæ—¶ä»»åŠ¡æ¥å®šæœŸè¿è¡ŒæœåŠ¡ã€‚ä¹Ÿè®¸ä½ è¿˜æƒ³è¿›è¡Œåˆ†å¸ƒå¼ç¼“å­˜ï¼Œå…·æœ‰å¹‚ç­‰æ€§æˆ–è€…æ”¯æŒå›æ»šã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯å¼€å‘äººå‘˜çº§çš„åŸè¯­ï¼Œä½†åœ¨å¹•åï¼Œå®ƒä»¬ä¾èµ–äºå…·æœ‰æŸç§çŠ¶æ€ã€‚ä½ æƒ³éšæ„ä½¿ç”¨è¿™äº›æŠ½è±¡ä¿©åˆ›å»ºå®Œå–„çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/26image0041616431697348.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªåˆ†å¸ƒå¼ç³»ç»ŸåŸè¯­çš„æ¡†æ¶æ¥è¯„ä¼°å®ƒä»¬åœ¨ Kubernetes å’Œå…¶ä»–é¡¹ç›®ä¸Šçš„å˜åŒ–æƒ…å†µã€‚&lt;/p>
&lt;h2 id="å•ä½“æ¶æ„----ä¼ ç»Ÿä¸­é—´ä»¶åŠŸèƒ½">å•ä½“æ¶æ„ &amp;ndash; ä¼ ç»Ÿä¸­é—´ä»¶åŠŸèƒ½&lt;/h2>
&lt;p>å‡è®¾æˆ‘ä»¬ä»å•ä½“æ¶æ„ä»¥åŠå¦‚ä½•è·å¾—è¿™äº›èƒ½åŠ›å¼€å§‹ã€‚åœ¨é‚£ç§æƒ…å†µä¸‹ï¼Œé¦–å…ˆæ˜¯å½“æˆ‘è¯´å•ä½“çš„æ—¶å€™ï¼Œåœ¨åˆ†å¸ƒå¼åº”ç”¨çš„æƒ…å†µä¸‹æˆ‘æƒ³åˆ°çš„æ˜¯ ESBã€‚ESB æ˜¯ç›¸å½“å¼ºå¤§çš„ï¼Œå½“æˆ‘ä»¬æ£€æŸ¥æˆ‘ä»¬çš„éœ€æ±‚åˆ—è¡¨æ—¶ï¼Œæˆ‘ä»¬ä¼šè¯´ ESB å¯¹æ‰€æœ‰æœ‰çŠ¶æ€çš„æŠ½è±¡æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚&lt;/p>
&lt;p>ä½¿ç”¨ ESBï¼Œä½ å¯ä»¥è¿›è¡Œé•¿æ—¶é—´è¿è¡Œçš„æµç¨‹çš„ç¼–æ’ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€å›æ»šå’Œå¹‚ç­‰ã€‚æ­¤å¤–ï¼ŒESB è¿˜æä¾›äº†å‡ºè‰²çš„èµ„æºç»‘å®šèƒ½åŠ›ï¼Œå¹¶ä¸”æœ‰æ•°ç™¾ä¸ªè¿æ¥å™¨ï¼Œæ”¯æŒè½¬æ¢ã€ç¼–æ’ï¼Œç”šè‡³æœ‰è”ç½‘åŠŸèƒ½ã€‚æœ€åï¼ŒESB ç”šè‡³å¯ä»¥åšæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚&lt;/p>
&lt;p>å®ƒå…·æœ‰å›´ç»•ç½‘ç»œè¿æ¥çš„å¼¹æ€§çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå› æ­¤å®ƒå¯ä»¥è¿›è¡Œé‡è¯•ã€‚å¯èƒ½ ESB æœ¬è´¨ä¸Šä¸æ˜¯å¾ˆåˆ†å¸ƒå¼ï¼Œæ‰€ä»¥å®ƒä¸éœ€è¦éå¸¸é«˜çº§çš„ç½‘ç»œå’Œå‘å¸ƒèƒ½åŠ›ã€‚ESB æ¬ ç¼ºçš„ä¸»è¦æ˜¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚å› ä¸ºå®ƒæ˜¯å•ä¸€è¿è¡Œæ—¶ï¼Œæ‰€ä»¥ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ä½ åªèƒ½ä½¿ç”¨ä¸€ç§è¯­è¨€ã€‚é€šå¸¸æ˜¯åˆ›å»ºå®é™…è¿è¡Œæ—¶çš„è¯­è¨€ï¼ŒJavaã€.NETã€æˆ–è€…å…¶ä»–çš„è¯­è¨€ã€‚ç„¶åï¼Œå› ä¸ºæ˜¯å•ä¸€è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½è½»æ¾åœ°è¿›è¡Œå£°æ˜å¼çš„éƒ¨ç½²æˆ–è€…è‡ªåŠ¨é˜²æ­¢ã€‚éƒ¨ç½²æ˜¯ç›¸å½“å¤§ä¸”éå¸¸é‡çš„ï¼Œæ‰€ä»¥å®ƒé€šå¸¸æ¶‰åŠåˆ°äººæœºäº¤äº’ã€‚è¿™ç§å•ä½“æ¶æ„çš„å¦ä¸€ä¸ªéš¾ç‚¹æ˜¯æ‰©å±•ï¼šâ€œæˆ‘ä»¬æ— æ³•æ‰©å±•å•ä¸ªç»„ä»¶ã€‚â€&lt;/p>
&lt;p>æœ€åå´å¹¶éæœ€ä¸é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œå›´ç»•éš”ç¦»ï¼Œæ— è®ºæ˜¯èµ„æºéš”ç¦»è¿˜æ˜¯æ•…éšœéš”ç¦»ã€‚ä½¿ç”¨å•ä½“æ¶æ„æ— æ³•å®Œæˆæ‰€æœ‰è¿™äº›å·¥ä½œã€‚ä»æˆ‘ä»¬çš„éœ€æ±‚æ¡†æ¶æ¥çœ‹ï¼ŒESB çš„å•ä½“æ¶æ„ä¸ç¬¦åˆæ¡ä»¶ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/40image0051616431696438.jpg" alt="">&lt;/p>
&lt;h2 id="äº‘åŸç”Ÿæ¶æ„----å¾®æœåŠ¡å’Œ-kubernetes">äº‘åŸç”Ÿæ¶æ„ &amp;ndash; å¾®æœåŠ¡å’Œ Kubernetes&lt;/h2>
&lt;p>æ¥ä¸‹æ¥ï¼Œæˆ‘å»ºè®®æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹äº‘åŸç”Ÿæ¶æ„ä»¥åŠè¿™äº›éœ€æ±‚æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚å¦‚æœæˆ‘ä»¬ä»ä¸€ä¸ªéå¸¸é«˜çš„å±‚é¢æ¥çœ‹ï¼Œè¿™äº›æ¶æ„æ˜¯å¦‚ä½•å‘ç”Ÿå˜åŒ–çš„ï¼Œäº‘åŸç”Ÿå¯èƒ½å§‹äºå¾®æœåŠ¡è¿åŠ¨ã€‚å¾®æœåŠ¡ä½¿æˆ‘ä»¬å¯ä»¥æŒ‰ä¸šåŠ¡é¢†åŸŸè¿›è¡Œæ‹†åˆ†å•ä½“åº”ç”¨ã€‚äº‹å®è¯æ˜ï¼Œå®¹å™¨å’Œ Kubernetes å®é™…ä¸Šæ˜¯ç®¡ç†è¿™äº›å¾®æœåŠ¡çš„ä¼˜ç§€å¹³å°ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Kubernetes å¯¹äºå¾®æœåŠ¡ç‰¹åˆ«æœ‰å¸å¼•åŠ›çš„ä¸€äº›å…·ä½“ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/13image0061616431699209.jpg" alt="">&lt;/p>
&lt;p>ä»ä¸€å¼€å§‹ï¼Œè¿›è¡Œå¥åº·çŠ¶å†µæ¢æµ‹çš„èƒ½åŠ›å°±æ˜¯ Kubernetes å—æ¬¢è¿çš„åŸå› ã€‚åœ¨å®è·µä¸­ï¼Œè¿™æ„å‘³ç€å½“ä½ å°†å®¹å™¨éƒ¨ç½²åˆ° Pod ä¸­æ—¶ï¼ŒKubernetes ä¼šæ£€æŸ¥è¿›ç¨‹çš„è¿è¡ŒçŠ¶å†µã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¯¥è¿‡ç¨‹æ¨¡å‹è¿˜ä¸å¤Ÿå¥½ã€‚ä½ å¯èƒ½ä»ç„¶æœ‰ä¸€ä¸ªå·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œä½†æ˜¯å®ƒå¹¶ä¸å¥åº·ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿˜å¯ä»¥ä½¿ç”¨å°±ç»ªåº¦å’Œå­˜æ´»åº¦æ£€æŸ¥çš„åŸå› ã€‚Kubernetes ä¼šåšä¸€ä¸ªå°±ç»ªåº¦æ£€æŸ¥ï¼Œä»¥ç¡®å®šä½ çš„åº”ç”¨åœ¨å¯åŠ¨æœŸé—´ä½•æ—¶å‡†å¤‡æ¥å—æµé‡ã€‚å®ƒå°†è¿›è¡Œæ´»è·ƒåº¦æ£€æŸ¥ï¼Œä»¥æ£€æŸ¥æœåŠ¡çš„è¿è¡ŒçŠ¶å†µã€‚åœ¨ Kubernetes ä¹‹å‰ï¼Œè¿™å¹¶ä¸æ˜¯å¾ˆæµè¡Œï¼Œä½†ä»Šå¤©å‡ ä¹æ‰€æœ‰è¯­è¨€ã€æ‰€æœ‰æ¡†æ¶ã€æ‰€æœ‰è¿è¡Œæ—¶éƒ½æœ‰å¥åº·æ£€æŸ¥åŠŸèƒ½ï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­å¿«é€Ÿå¯åŠ¨ç«¯ç‚¹ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/29image0071616431696697.jpg" alt="">&lt;/p>
&lt;p>Kubernetes å¼•å…¥çš„ä¸‹ä¸€ä¸ªç‰¹æ€§æ˜¯å›´ç»•åº”ç”¨ç¨‹åºçš„æ‰˜ç®¡ç”Ÿå‘½å‘¨æœŸ&amp;ndash;æˆ‘çš„æ„æ€æ˜¯ï¼Œä½ ä¸å†æ§åˆ¶ä½•æ—¶å¯åŠ¨ã€ä½•æ—¶å…³é—­æœåŠ¡ã€‚ä½ ç›¸ä¿¡å¹³å°å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚Kubernetes å¯ä»¥å¯åŠ¨ä½ çš„åº”ç”¨ï¼›å®ƒå¯ä»¥å°†å…¶å…³é—­ï¼Œç„¶ååœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šç§»åŠ¨å®ƒã€‚ä¸ºæ­¤ï¼Œä½ å¿…é¡»æ­£ç¡®æ‰§è¡Œå¹³å°åœ¨åº”ç”¨å¯åŠ¨å’Œå…³é—­æœŸé—´å‘Šè¯‰ä½ çš„äº‹ä»¶ã€‚&lt;/p>
&lt;p>Kubernetes åˆ˜å…´çš„å¦ä¸€ä»¶ç‰¹æ€§æ˜¯å›´ç»•ç€å£°æ˜å¼éƒ¨ç½²ã€‚è¿™æ„å‘³ç€ä½ ä¸å†éœ€è¦å¯åŠ¨æœåŠ¡ï¼›æ£€æŸ¥æ—¥å¿—æ˜¯å¦å·²ç»å¯åŠ¨ã€‚ä½ ä¸å¿…æ‰‹åŠ¨å‡çº§å®ä¾‹&amp;ndash;æ”¯æŒå£°æ˜å¼éƒ¨ç½²çš„ Kubernetes å¯ä»¥ä¸ºä½ åšåˆ°è¿™ä¸€ç‚¹ã€‚æ ¹æ®ä½ é€‰æ‹©çš„ç­–ç•¥ï¼Œå®ƒå¯ä»¥åœæ­¢æ—§å®ä¾‹å¹¶å¯åŠ¨æ–°å®ä¾‹ã€‚æ­¤å¤–ï¼Œå¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥è¿›è¡Œå›æ»šã€‚&lt;/p>
&lt;p>å¦å¤–å°±æ˜¯å£°æ˜ä½ çš„èµ„æºéœ€æ±‚ã€‚åˆ›å»ºæœåŠ¡æ—¶ï¼Œå°†å…¶å®¹å™¨åŒ–ã€‚æœ€å¥½å‘Šè¯‰å¹³å°è¯¥æœåŠ¡å°†éœ€è¦å¤šå°‘ CPU å’Œå†…å­˜ã€‚Kubernetes åˆ©ç”¨è¿™äº›ä¿¡æ¯ä¸ºä½ çš„å·¥ä½œè´Ÿè½½æ‰¾åˆ°æœ€ä½³èŠ‚ç‚¹ã€‚åœ¨ä½¿ç”¨ Kubernetes ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»æ ¹æ®æˆ‘ä»¬çš„æ ‡å‡†å°†å®ä¾‹æ‰‹åŠ¨æ”¾ç½®åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„åå¥½æ¥æŒ‡å¯¼ Kubernetesï¼Œå®ƒå°†ä¸ºæˆ‘ä»¬åšå‡ºæœ€ä½³çš„å†³ç­–ã€‚&lt;/p>
&lt;p>å¦‚ä»Šï¼Œåœ¨ Kubernetes ä¸Šï¼Œä½ å¯ä»¥è¿›è¡Œå¤šè¯­è¨€é…ç½®ç®¡ç†ã€‚æ— éœ€åœ¨åº”ç”¨ç¨‹åºè¿è¡Œæ—¶è¿›è¡Œé…ç½®æŸ¥æ‰¾å°±å¯ä»¥è¿›è¡Œä»»ä½•æ“ä½œã€‚Kubernetes ä¼šç¡®ä¿é…ç½®æœ€ç»ˆåœ¨å·¥ä½œè´Ÿè½½æ‰€åœ¨çš„åŒä¸€èŠ‚ç‚¹ä¸Šã€‚è¿™äº›é…ç½®è¢«æ˜ å°„ä¸ºå·æˆ–ç¯å¢ƒå˜é‡ï¼Œä»¥ä¾›ä½ çš„åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚&lt;/p>
&lt;p>äº‹å®è¯æ˜ï¼Œæˆ‘åˆšæ‰è°ˆåˆ°çš„é‚£äº›ç‰¹å®šåŠŸèƒ½ä¹Ÿæ˜¯ç›¸å…³çš„ã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æœè¦è¿›è¡Œè‡ªåŠ¨æ”¾ç½®ï¼Œåˆ™å¿…é¡»å‘Šè¯‰ Kubernetes æœåŠ¡çš„èµ„æºéœ€æ±‚ã€‚ç„¶åï¼Œä½ å¿…é¡»å‘Šè¯‰å®ƒè¦ä½¿ç”¨çš„éƒ¨ç½²ç­–ç•¥ã€‚ä¸ºäº†è®©ç­–ç•¥æ­£ç¡®è¿è¡Œï¼Œä½ çš„åº”ç”¨ç¨‹åºå¿…é¡»æ‰§è¡Œæ¥è‡ªç¯å¢ƒçš„äº‹ä»¶ã€‚å®ƒå¿…é¡»æ‰§è¡Œå¥åº·æ£€æŸ¥ã€‚ä¸€æ—¦é‡‡ç”¨äº†æ‰€æœ‰è¿™äº›æœ€ä½³å®è·µå¹¶ä½¿ç”¨æ‰€æœ‰è¿™äº›åŠŸèƒ½ï¼Œä½ çš„åº”ç”¨å°±ä¼šæˆä¸ºå‡ºè‰²çš„äº‘åŸç”Ÿå…¬æ°‘ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ Kubernetes ä¸Šå®ç°è‡ªåŠ¨åŒ–äº†ï¼ˆè¿™æ˜¯åœ¨ Kubernetes ä¸Šè¿è¡Œå·¥ä½œè´Ÿè½½çš„åŸºæœ¬æ¨¡å¼ï¼‰ã€‚æœ€åï¼Œè¿˜æœ‰å›´ç»•ç€æ„å»º Pod ä¸­çš„å®¹å™¨ã€é…ç½®ç®¡ç†å’Œè¡Œä¸ºï¼Œè¿˜æœ‰å…¶ä»–æ¨¡å¼ã€‚&lt;/p>
&lt;p>æˆ‘è¦ç®€è¦ä»‹ç»çš„ä¸‹ä¸€ä¸ªä¸»é¢˜æ˜¯å·¥ä½œè´Ÿè½½ã€‚ä»ç”Ÿå‘½å‘¨æœŸçš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè¿è¡Œä¸åŒçš„å·¥ä½œè´Ÿè½½ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ Kubernetes ä¸Šåšåˆ°è¿™ä¸€ç‚¹ã€‚è¿è¡ŒåäºŒè¦ç´ åº”ç”¨ç¨‹åºå’Œæ— çŠ¶æ€å¾®æœåŠ¡éå¸¸ç®€å•ã€‚Kubernetes å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚è¿™ä¸æ˜¯ä½ å°†è¦æ‰¿æ‹…çš„å”¯ä¸€å·¥ä½œé‡ã€‚å¯èƒ½ä½ è¿˜æœ‰æœ‰çŠ¶æ€çš„å·¥ä½œè´Ÿè½½ï¼Œä½ å¯ä»¥ä½¿ç”¨æœ‰çŠ¶æ€é›†åœ¨ Kubernetes ä¸Šå®Œæˆæ­¤å·¥ä½œã€‚&lt;/p>
&lt;p>ä½ å¯èƒ½è¿˜æœ‰çš„å¦ä¸€ä¸ªå·¥ä½œè´Ÿè½½æ˜¯å•ä¾‹ã€‚ä¹Ÿè®¸ä½ å¸Œæœ›æŸä¸ªåº”ç”¨ç¨‹åºçš„å®ä¾‹æ˜¯æ•´ä¸ªé›†ç¾¤ä¸­åº”ç”¨ç¨‹åºçš„å”¯ä¸€ä¸€ä¸ªå®ä¾‹&amp;ndash;ä½ å¸Œæœ›å®ƒæˆä¸ºå¯é çš„å•ä¾‹ã€‚å¦‚æœå¤±è´¥ï¼Œåˆ™é‡æ–°å¯åŠ¨ã€‚å› æ­¤ï¼Œä½ å¯ä»¥æ ¹æ®éœ€æ±‚ä»¥åŠæ˜¯å¦å¸Œæœ›å•ä¾‹è‡³å°‘å…·æœ‰ä¸€ç§æˆ–æœ€å¤šä¸€ç§è¯­ä¹‰æ¥åœ¨æœ‰çŠ¶æ€é›†å’Œå‰¯æœ¬é›†ä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚ä½ å¯èƒ½è¿˜æœ‰çš„å¦ä¸€ä¸ªå·¥ä½œè´Ÿè½½æ˜¯å›´ç»•ä½œä¸šå’Œå®šæ—¶ä½œä¸š&amp;ndash;æœ‰äº† Kubernetesï¼Œä½ ä¹Ÿå¯ä»¥å®ç°è¿™äº›ã€‚&lt;/p>
&lt;p>å¦‚æœæˆ‘ä»¬å°†æ‰€æœ‰è¿™äº› Kubernetes åŠŸèƒ½æ˜ å°„åˆ°æˆ‘ä»¬çš„éœ€æ±‚ï¼Œåˆ™ Kubernetes å¯ä»¥æ»¡è¶³ç”Ÿå‘½å‘¨æœŸéœ€æ±‚ã€‚æˆ‘é€šå¸¸åˆ›å»ºçš„éœ€æ±‚åˆ—è¡¨ä¸»è¦æ˜¯ç”± Kubernetes ä»Šå¤©æä¾›ç»™æˆ‘ä»¬çš„ã€‚è¿™äº›æ˜¯ä»»ä½•å¹³å°ä¸Šçš„é¢„æœŸåŠŸèƒ½ï¼Œè€Œ Kubernetes å¯ä»¥ä¸ºä½ çš„éƒ¨ç½²åšçš„æ˜¯é…ç½®ç®¡ç†ã€èµ„æºéš”ç¦»å’Œæ•…éšœéš”ç¦»ã€‚æ­¤å¤–ï¼Œé™¤äº†æ— æœåŠ¡å™¨æœ¬èº«ä¹‹å¤–ï¼Œå®ƒè¿˜æ”¯æŒå…¶ä»–å·¥ä½œè´Ÿè½½ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/12image0081616431698134.jpg" alt="">&lt;/p>
&lt;p>ç„¶åï¼Œå¦‚æœè¿™å°±æ˜¯ Kubernetes ç»™å¼€å‘è€…æä¾›çš„å…¨éƒ¨åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•æ‰©å±• Kubernetes å‘¢ï¼Ÿä»¥åŠå¦‚ä½•ä½¿å®ƒå…·æœ‰æ›´å¤šåŠŸèƒ½ï¼Ÿå› æ­¤ï¼Œæˆ‘æƒ³æè¿°å½“ä»Šä½¿ç”¨çš„ä¸¤ç§å¸¸ç”¨æ–¹æ³•ã€‚&lt;/p>
&lt;h2 id="è¿›ç¨‹å¤–æ‰©å±•æœºåˆ¶">è¿›ç¨‹å¤–æ‰©å±•æœºåˆ¶&lt;/h2>
&lt;p>é¦–å…ˆæ˜¯ Pod çš„æ¦‚å¿µï¼ŒPod æ˜¯ç”¨äºåœ¨èŠ‚ç‚¹ä¸Šéƒ¨ç½²å®¹å™¨çš„æŠ½è±¡ã€‚æ­¤å¤–ï¼ŒPod ç»™æˆ‘ä»¬æä¾›äº†ä¸¤ç»„ä¿è¯ï¼š&lt;/p>
&lt;ul>
&lt;li>ç¬¬ä¸€ç»„æ˜¯éƒ¨ç½²ä¿è¯ &amp;ndash; Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å§‹ç»ˆä½äºåŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚è¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥é€šè¿‡ localhost ç›¸äº’é€šä¿¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæˆ–é€šè¿‡å…¶ä»– IPC æœºåˆ¶è¿›è¡Œå¼‚æ­¥é€šä¿¡ã€‚&lt;/li>
&lt;li>Pod ç»™æˆ‘ä»¬çš„å¦ä¸€ç»„ä¿è¯æ˜¯å›´ç»•ç”Ÿå‘½å‘¨æœŸçš„ã€‚Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å¹¶ééƒ½ç›¸ç­‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/22image0091616431698660.jpg" alt="">&lt;/p>
&lt;p>æ ¹æ®ä½¿ç”¨çš„æ˜¯ init å®¹å™¨è¿˜æ˜¯åº”ç”¨ç¨‹åºå®¹å™¨ï¼Œä½ ä¼šè·å¾—ä¸åŒçš„ä¿è¯ã€‚ä¾‹å¦‚ï¼Œinit å®¹å™¨åœ¨å¼€å§‹æ—¶è¿è¡Œï¼›å½“ Pod å¯åŠ¨æ—¶ï¼Œå®ƒæŒ‰é¡ºåºä¸€ä¸ªæ¥ä¸€ä¸ªåœ°è¿è¡Œã€‚ä»–ä»¬ä»…åœ¨ä¹‹å‰çš„å®¹å™¨å·²æˆåŠŸå®Œæˆæ—¶è¿è¡Œã€‚å®ƒä»¬æœ‰åŠ©äºå®ç°ç”±å®¹å™¨é©±åŠ¨çš„ç±»ä¼¼å·¥ä½œæµçš„é€»è¾‘ã€‚&lt;/p>
&lt;p>å¦ä¸€æ–¹é¢ï¼Œåº”ç”¨ç¨‹åºå®¹å™¨æ˜¯å¹¶è¡Œè¿è¡Œçš„ã€‚å®ƒä»¬åœ¨æ•´ä¸ª Pod çš„ç”Ÿå‘½å‘¨æœŸä¸­è¿è¡Œï¼Œè¿™ä¹Ÿæ˜¯ sidecar æ¨¡å¼çš„åŸºç¡€ã€‚sidecar å¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œè¿™äº›å®¹å™¨å¯ä»¥åä½œå¹¶å…±åŒä¸ºç”¨æˆ·æä¾›ä»·å€¼ã€‚è¿™ä¹Ÿæ˜¯å½“ä»Šæˆ‘ä»¬çœ‹åˆ°çš„æ‰©å±• Kubernetes é™„åŠ åŠŸèƒ½çš„ä¸»è¦æœºåˆ¶ä¹‹ä¸€ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/9image0101616431695489.jpg" alt="">&lt;/p>
&lt;p>ä¸ºäº†è§£é‡Šä»¥ä¸‹åŠŸèƒ½ï¼Œæˆ‘å¿…é¡»ç®€è¦åœ°å‘Šè¯‰ä½  Kubernetes å†…éƒ¨çš„å·¥ä½œæ–¹å¼ã€‚å®ƒæ˜¯åŸºäºè°ƒè°å¾ªç¯çš„ã€‚è°ƒè°å¾ªç¯çš„æ€æƒ³æ˜¯å°†æœŸæœ›çŠ¶æ€é©±åŠ¨åˆ°å®é™…çŠ¶æ€ã€‚åœ¨ Kubernetes ä¸­ï¼Œå¾ˆå¤šåŠŸèƒ½éƒ½æ˜¯é è¿™ä¸ªæ¥å®ç°çš„ã€‚ä¾‹å¦‚ï¼Œå½“ä½ è¯´æˆ‘è¦ä¸¤ä¸ª Pod å®ä¾‹ï¼Œè¿™ç³»ç»Ÿçš„æœŸæœ›çŠ¶æ€ã€‚æœ‰ä¸€ä¸ªæ§åˆ¶å¾ªç¯ä¸æ–­åœ°è¿è¡Œï¼Œå¹¶æ£€æŸ¥ä½ çš„ Pod æ˜¯å¦æœ‰ä¸¤ä¸ªå®ä¾‹ã€‚å¦‚æœä¸å­˜åœ¨ä¸¤ä¸ªå®ä¾‹ï¼Œå®ƒå°†è®¡ç®—å·®å€¼ã€‚å®ƒå°†ç¡®ä¿å­˜åœ¨ä¸¤ä¸ªå®ä¾‹ã€‚&lt;/p>
&lt;p>è¿™æ–¹é¢çš„ä¾‹å­æœ‰å¾ˆå¤šã€‚ä¸€äº›æ˜¯å‰¯æœ¬é›†æˆ–æœ‰çŠ¶æ€é›†ã€‚èµ„æºå®šä¹‰æ˜ å°„åˆ°æ§åˆ¶å™¨æ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸”æ¯ä¸ªèµ„æºå®šä¹‰éƒ½æœ‰ä¸€ä¸ªæ§åˆ¶å™¨ã€‚è¯¥æ§åˆ¶å™¨ç¡®ä¿ç°å®ä¸–ç•Œä¸æ‰€éœ€æ§åˆ¶å™¨ç›¸åŒ¹é…ï¼Œä½ ç”šè‡³å¯ä»¥ç¼–å†™è‡ªå·±çš„è‡ªå®šä¹‰æ§åˆ¶å™¨ã€‚&lt;/p>
&lt;p>å½“åœ¨ Pod ä¸­è¿è¡Œåº”ç”¨ç¨‹åºæ—¶ï¼Œä½ å°†æ— æ³•åœ¨è¿è¡Œæ—¶åŠ è½½ä»»ä½•é…ç½®æ–‡ä»¶æ›´æ”¹ã€‚ç„¶è€Œï¼Œä½ å¯ä»¥ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰æ§åˆ¶å™¨ï¼Œæ£€æµ‹ config map çš„å˜åŒ–ï¼Œé‡æ–°å¯åŠ¨ Pod å’Œåº”ç”¨ç¨‹åº&amp;ndash;ä»è€Œè·å–é…ç½®æ›´æ”¹ã€‚&lt;/p>
&lt;p>äº‹å®è¯æ˜ï¼Œå³ä½¿ Kubernetes æ‹¥æœ‰ä¸°å¯Œçš„èµ„æºé›†åˆï¼Œä½†å®ƒä»¬å¹¶ä¸èƒ½æ»¡è¶³ä½ çš„æ‰€æœ‰ä¸åŒéœ€æ±‚ã€‚Kubernetes å¼•å…¥äº†è‡ªå®šä¹‰èµ„æºå®šä¹‰çš„æ¦‚å¿µã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å¯¹éœ€æ±‚è¿›è¡Œå»ºæ¨¡å¹¶å®šä¹‰é€‚ç”¨äº Kubernetes çš„ APIã€‚å®ƒä¸å…¶ä»– Kubernetes åŸç”Ÿèµ„æºå…±å­˜ã€‚ä½ å¯ä»¥ç”¨èƒ½ç†è§£æ¨¡å‹çš„ä»»ä½•è¯­è¨€ç¼–å†™è‡ªå·±çš„æ§åˆ¶å™¨ã€‚ä½ å¯ä»¥è®¾è®¡ä¸€ä¸ªç”¨ Java å®ç°çš„ ConfigWatcherï¼Œæè¿°æˆ‘ä»¬å‰é¢æ‰€è§£é‡Šçš„å†…å®¹ã€‚è¿™å°±æ˜¯ operator æ¨¡å¼ï¼Œå³ä¸è‡ªå®šä¹‰èµ„æºå®šä¹‰ä¸€èµ·ä½¿ç”¨çš„æ§åˆ¶å™¨ã€‚å¦‚ä»Šï¼Œæˆ‘ä»¬çœ‹åˆ°å¾ˆå¤š operator å‡å¦‚ï¼Œè¿™å°±æ˜¯ç¬¬äºŒç§æ‰©å±• Kubernetes é™„åŠ åŠŸèƒ½çš„æ–¹å¼ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥ï¼Œæˆ‘æƒ³ç®€å•ä»‹ç»ä¸€ä¸‹åŸºäº Kubernetes æ„å»ºçš„ä¸€äº›å¹³å°ï¼Œè¿™äº›å¹³å°å¤§é‡ä½¿ç”¨ sidecar å’Œ operator æ¥ç»™å¼€å‘è€…æä¾›é¢å¤–çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼">ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Ÿ&lt;/h2>
&lt;p>è®©æˆ‘ä»¬ä»æœåŠ¡ç½‘æ ¼å¼€å§‹ï¼Œä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Ÿ&lt;/p>
&lt;p>æˆ‘ä»¬æœ‰ä¸¤ä¸ªæœåŠ¡ï¼ŒæœåŠ¡ A è¦è°ƒç”¨æœåŠ¡ Bï¼Œå¹¶ä¸”å¯ä»¥ç”¨ä»»ä½•è¯­è¨€ã€‚æŠŠè¿™ä¸ªå½“åšæ˜¯æˆ‘ä»¬çš„åº”ç”¨å·¥ä½œè´Ÿè½½ã€‚æœåŠ¡ç½‘æ ¼ä½¿ç”¨ sidecar æ§åˆ¶å™¨ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„æœåŠ¡æ—è¾¹æ³¨å…¥ä¸€ä¸ªä»£ç†ã€‚ä½ æœ€ç»ˆä¼šåœ¨ Pod ä¸­å¾—åˆ°ä¸¤ä¸ªå®¹å™¨ã€‚ä»£ç†æ˜¯ä¸€ä¸ªé€æ˜çš„ä»£ç†ï¼Œä½ çš„åº”ç”¨å¯¹è¿™ä¸ªä»£ç†å®Œå…¨æ— æ„ŸçŸ¥&amp;ndash;å®ƒæ‹¦æˆªæ‰€æœ‰ä¼ å…¥å’Œä¼ å‡ºçš„æµé‡ã€‚æ­¤å¤–ï¼Œä»£ç†è¿˜å……å½“æ•°æ®é˜²ç«å¢™ã€‚&lt;/p>
&lt;p>è¿™äº›æœåŠ¡ä»£ç†çš„é›†åˆä»£è¡¨äº†ä½ çš„æ•°æ®å¹³é¢ï¼Œå¹¶ä¸”å¾ˆå°ä¸”æ— çŠ¶æ€ã€‚ä¸ºäº†è·å¾—æ‰€æœ‰çŠ¶æ€å’Œé…ç½®ï¼Œå®ƒä»¬ä¾èµ–äºæ§åˆ¶å¹³é¢ã€‚æ§åˆ¶å¹³é¢æ˜¯ä¿æŒæ‰€æœ‰é…ç½®ï¼Œæ”¶é›†æŒ‡æ ‡ï¼Œåšå‡ºå†³å®šå¹¶ä¸æ•°æ®å¹³é¢è¿›è¡Œäº¤äº’çš„æœ‰çŠ¶æ€éƒ¨åˆ†ã€‚æ­¤å¤–ï¼Œå®ƒä»¬æ˜¯ä¸åŒæ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢çš„æ­£ç¡®é€‰æ‹©ã€‚äº‹å®è¯æ˜ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç»„ä»¶-ä¸€ä¸ª API ç½‘å…³ï¼Œä»¥å°†æ•°æ®è·å–åˆ°æˆ‘ä»¬çš„é›†ç¾¤ä¸­ã€‚ä¸€äº›æœåŠ¡ç½‘æ ¼å…·æœ‰è‡ªå·±çš„ API ç½‘å…³ï¼Œè€ŒæŸäº›ä½¿ç”¨ç¬¬ä¸‰æ–¹ã€‚å¦‚æœä½ ç ”ç©¶ä¸‹æ‰€æœ‰è¿™äº›ç»„ä»¶ï¼Œå®ƒä»¬å°†æä¾›æˆ‘ä»¬æ‰€éœ€çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>API ç½‘å…³ä¸»è¦ä¸“æ³¨äºæŠ½è±¡æˆ‘ä»¬æœåŠ¡çš„å®ç°ã€‚å®ƒéšè—ç»†èŠ‚å¹¶æä¾›è¾¹ç•ŒåŠŸèƒ½ã€‚æœåŠ¡ç½‘æ ¼åˆ™ç›¸åã€‚åœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œå®ƒå¢å¼ºäº†æœåŠ¡å†…çš„å¯è§æ€§å’Œå¯é æ€§ã€‚å¯ä»¥è¯´ï¼ŒAPI ç½‘å…³å’ŒæœåŠ¡ç½‘æ ¼å…±åŒæä¾›äº†æ‰€æœ‰ç½‘ç»œéœ€æ±‚ã€‚è¦åœ¨ Kubernetes ä¸Šè·å¾—ç½‘ç»œåŠŸèƒ½ï¼Œä»…ä½¿ç”¨æœåŠ¡æ˜¯ä¸å¤Ÿçš„ï¼šâ€œä½ éœ€è¦ä¸€äº›æœåŠ¡ç½‘æ ¼ã€‚â€&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/19image0111616431696146.jpg" alt="">&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯-knative">ä»€ä¹ˆæ˜¯ Knativeï¼Ÿ&lt;/h2>
&lt;p>æˆ‘è¦è®¨è®ºçš„ä¸‹ä¸€ä¸ªä¸»é¢˜æ˜¯ Knativeï¼Œè¿™æ˜¯ Google å‡ å¹´å‰å¯åŠ¨çš„ä¸€ä¸ªé¡¹ç›®ã€‚å®ƒæ˜¯ Kubernetes ä¹‹ä¸Šçš„ä¸€å±‚ï¼Œå¯ä¸ºæ‚¨æä¾›æ— æœåŠ¡å™¨åŠŸèƒ½ï¼Œå¹¶å…·æœ‰ä¸¤ä¸ªä¸»è¦æ¨¡å—ï¼š&lt;/p>
&lt;ul>
&lt;li>Knative æœåŠ¡ - å›´ç»•ç€è¯·æ±‚-åº”ç­”äº¤äº’ï¼Œä»¥åŠ&lt;/li>
&lt;li>Knative Eventing - æ›´å¤šçš„æ˜¯ç”¨äºäº‹ä»¶é©±åŠ¨çš„äº¤äº’ã€‚&lt;/li>
&lt;/ul>
&lt;p>åªæ˜¯è®©ä½ æ„Ÿå—ä¸€ä¸‹ï¼ŒKnative Serving æ˜¯ä»€ä¹ˆï¼Ÿé€šè¿‡ Knative Servingï¼Œä½ å¯ä»¥å®šä¹‰æœåŠ¡ï¼Œä½†è¿™ä¸åŒäº Kubernetes æœåŠ¡ã€‚è¿™æ˜¯ Knative æœåŠ¡ã€‚ä½¿ç”¨ Knative æœåŠ¡å®šä¹‰å·¥ä½œè´Ÿè½½åï¼Œä½ å°±ä¼šå¾—åˆ°å…·æœ‰æ— æœåŠ¡å™¨çš„ç‰¹å¾çš„éƒ¨ç½²ã€‚ä½ ä¸éœ€è¦æœ‰å¯åŠ¨å¹¶è¿è¡Œå®ä¾‹ã€‚å®ƒå¯ä»¥åœ¨è¯·æ±‚åˆ°è¾¾æ—¶ä»é›¶å¼€å§‹ã€‚ä½ å¾—åˆ°çš„æ˜¯æ— æœåŠ¡å™¨çš„èƒ½åŠ›ï¼›å®ƒå¯ä»¥è¿…é€Ÿæ‰©å®¹ï¼Œä¹Ÿå¯ä»¥ç¼©å®¹åˆ°é›¶ã€‚&lt;/p>
&lt;p>Knative Eventing ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå®Œå…¨å£°æ˜å¼çš„äº‹ä»¶ç®¡ç†ç³»ç»Ÿã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€äº›è¦ä¸ä¹‹é›†æˆçš„å¤–éƒ¨ç³»ç»Ÿï¼Œä»¥åŠä¸€äº›å¤–éƒ¨çš„äº‹ä»¶ç”Ÿäº§è€…ã€‚åœ¨åº•éƒ¨ï¼Œæˆ‘ä»¬å°†åº”ç”¨ç¨‹åºæ”¾åœ¨å…·æœ‰ HTTP ç«¯ç‚¹çš„å®¹å™¨ä¸­ã€‚å€ŸåŠ© Knative Eventingï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ä»£ç†ï¼Œè¯¥ä»£ç†å¯ä»¥è§¦å‘ Kafka æ˜ å°„çš„ä»£ç†ï¼Œä¹Ÿå¯ä»¥åœ¨å†…å­˜æˆ–è€…æŸäº›äº‘æœåŠ¡ä¸­ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨è¿æ¥åˆ°å¤–éƒ¨ç³»ç»Ÿçš„å¯¼å…¥å™¨ï¼Œå¹¶å°†äº‹ä»¶å¯¼å…¥åˆ°æˆ‘ä»¬çš„ä»£ç†ä¸­ã€‚è¿™äº›å¯¼å…¥å™¨å¯ä»¥åŸºäºï¼Œä¾‹å¦‚ï¼Œå…·æœ‰æ•°ç™¾ä¸ªè¿æ¥å™¨çš„ Apache Camelã€‚&lt;/p>
&lt;p>ä¸€æ—¦æˆ‘ä»¬å°†äº‹ä»¶å‘é€ç»™ä»£ç†ï¼Œç„¶åç”¨ YAML æ–‡ä»¶å£°æ˜ï¼Œæˆ‘ä»¬å¯ä»¥è®©å®¹å™¨è®¢é˜…è¿™äº›äº‹ä»¶ã€‚åœ¨æˆ‘ä»¬çš„å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä»»ä½•æ¶ˆæ¯å®¢æˆ·ç«¯&amp;ndash;æ¯”å¦‚ Kafka å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬çš„å®¹å™¨å°†ä½¿ç”¨äº‘äº‹ä»¶é€šè¿‡ HTTP POST è·å–äº‹ä»¶ã€‚è¿™æ˜¯ä¸€ä¸ªå®Œå…¨å¹³å°ç®¡ç†çš„æ¶ˆæ¯ä¼ é€’åŸºç¡€è®¾æ–½ã€‚ä½œä¸ºå¼€å‘äººå‘˜ï¼Œä½ å¿…é¡»åœ¨å®¹å™¨ä¸­ç¼–å†™ä¸šåŠ¡ä»£ç ï¼Œå¹¶ä¸”ä¸å¤„ç†ä»»ä½•æ¶ˆæ¯ä¼ é€’é€»è¾‘ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/8image0121616431698919.jpg" alt="">&lt;/p>
&lt;p>ä»æˆ‘ä»¬çš„éœ€æ±‚çš„è§’åº¦æ¥çœ‹ï¼ŒKnative å¯ä»¥æ»¡è¶³å…¶ä¸­çš„ä¸€äº›è¦æ±‚ã€‚ä»ç”Ÿå‘½å‘¨æœŸçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒä¸ºæˆ‘ä»¬çš„å·¥ä½œè´Ÿè½½æä¾›äº†æ— æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œå› æ­¤èƒ½å¤Ÿå°†å…¶æ‰©å±•åˆ°é›¶ï¼Œå¹¶ä»é›¶å¼€å§‹æ¿€æ´»ã€‚ä»ç½‘ç»œçš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœæœåŠ¡ç½‘æ ¼ä¹‹é—´å­˜åœ¨æŸäº›é‡å ï¼Œåˆ™ Knative ä¹Ÿå¯ä»¥è¿›è¡Œæµé‡è½¬ç§»ã€‚ä»ç»‘å®šçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒå¯¹ä½¿ç”¨ Knative å¯¼å…¥ç¨‹åºè¿›è¡Œç»‘å®šæä¾›äº†å¾ˆå¥½çš„æ”¯æŒã€‚å®ƒå¯ä»¥ä½¿æˆ‘ä»¬è¿›è¡Œå‘å¸ƒ/è®¢é˜…ï¼Œæˆ–ç‚¹å¯¹ç‚¹äº¤äº’ï¼Œç”šè‡³å¯ä»¥è¿›è¡Œä¸€äº›æ’åºã€‚å®ƒå¯ä»¥æ»¡è¶³å‡ ç±»éœ€æ±‚ã€‚&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯-dapr">ä»€ä¹ˆæ˜¯ Daprï¼Ÿ&lt;/h2>
&lt;p>å¦ä¸€ä¸ªä½¿ç”¨ sidecar å’Œ operator çš„é¡¹ç›®æ˜¯ &lt;a href="https://dapr.io/">Dapr&lt;/a>ï¼Œå®ƒæ˜¯å¾®è½¯å‡ ä¸ªæœˆå‰æ‰å¼€å§‹å¹¶ä¸”æ­£åœ¨è¿…é€Ÿæµè¡Œèµ·æ¥ã€‚æ­¤å¤–ï¼Œ1.0 ç‰ˆæœ¬ &lt;a href="https://www.infoq.com/news/2021/02/dapr-production-ready/">è¢«è®¤ä¸ºæ˜¯ç”Ÿäº§å¯ç”¨çš„&lt;/a>ã€‚å®ƒæ˜¯ä¸€ä¸ªä½œä¸º sidecar çš„åˆ†å¸ƒå¼ç³»ç»Ÿå·¥å…·åŒ…&amp;ndash;Dapr ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯ä½œä¸º sidecar æä¾›çš„ï¼Œå¹¶ä¸”æœ‰ä¸€å¥—ä»–ä»¬æ‰€è°“çš„æ„ä»¶æˆ–åŠŸèƒ½é›†çš„é›†åˆã€‚&lt;/p>
&lt;p>è¿™äº›åŠŸèƒ½æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç¬¬ä¸€ç»„åŠŸèƒ½æ˜¯å›´ç»•ç½‘ç»œã€‚Dapr å¯ä»¥è¿›è¡ŒæœåŠ¡å‘ç°å’ŒæœåŠ¡ä¹‹é—´çš„ç‚¹å¯¹ç‚¹é›†æˆã€‚åŒæ ·ï¼Œå®ƒä¹Ÿå¯ä»¥è¿›è¡ŒæœåŠ¡ç½‘æ ¼çš„è¿½è¸ªã€å¯é é€šä¿¡ã€é‡è¯•å’Œæ¢å¤ã€‚ç¬¬äºŒå¥—åŠŸèƒ½æ˜¯å›´ç»•èµ„æºç»‘å®šï¼š&lt;/p>
&lt;ul>
&lt;li>å®ƒæœ‰å¾ˆå¤šäº‘ APIã€ä¸åŒç³»ç»Ÿçš„è¿æ¥å™¨ï¼Œä»¥åŠ&lt;/li>
&lt;li>ä¹Ÿå¯ä»¥åšæ¶ˆæ¯å‘å¸ƒ/è®¢é˜…å’Œå…¶ä»–é€»è¾‘ã€‚&lt;/li>
&lt;/ul>
&lt;p>æœ‰è¶£çš„æ˜¯ï¼ŒDapr è¿˜å¼•å…¥äº†çŠ¶æ€ç®¡ç†çš„æ¦‚å¿µã€‚é™¤äº† Knative å’ŒæœåŠ¡ç½‘æ ¼æä¾›çš„åŠŸèƒ½å¤–ï¼ŒDapr åœ¨çŠ¶æ€å­˜å‚¨ä¹‹ä¸Šè¿›è¡Œäº†æŠ½è±¡ã€‚æ­¤å¤–ï¼Œä½ é€šè¿‡å­˜å‚¨æœºåˆ¶æ”¯æŒä¸ Dapr è¿›è¡ŒåŸºäºé”®å€¼çš„äº¤äº’ã€‚&lt;/p>
&lt;p>åœ¨è¾ƒé«˜çš„å±‚æ¬¡ä¸Šï¼Œæ¶æ„æ˜¯ä½ çš„åº”ç”¨ç¨‹åºä½äºé¡¶éƒ¨ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•è¯­è¨€ã€‚ä½ å¯ä»¥ä½¿ç”¨ Dapr æä¾›çš„å®¢æˆ·ç«¯åº“ï¼Œä½†ä½ ä¸å¿…è¿™æ ·åšã€‚ä½ å¯ä»¥ä½¿ç”¨è¯­è¨€åŠŸèƒ½æ¥æ‰§è¡Œç§°ä¸º sidecar çš„ HTTP å’Œ gRPCã€‚ä¸ æœåŠ¡ç½‘æ ¼çš„åŒºåˆ«åœ¨äºï¼Œè¿™é‡Œçš„ Dapr sidecar ä¸æ˜¯ä¸€ä¸ªé€æ˜çš„ä»£ç†ã€‚å®ƒæ˜¯ä¸€ä¸ªæ˜¾å¼ä»£ç†ï¼Œä½ å¿…é¡»ä»ä½ çš„åº”ç”¨ä¸­è°ƒç”¨å®ƒï¼Œå¹¶é€šè¿‡ HTTP æˆ– gRPC ä¸ä¹‹äº¤äº’ã€‚æ ¹æ®ä½ éœ€è¦çš„åŠŸèƒ½ï¼ŒDapr å¯ä»¥ä¸å…¶ä»–å¦‚äº‘æœåŠ¡çš„ç³»ç»Ÿå¯¹è¯ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/18image0131616431699532.jpg" alt="">&lt;/p>
&lt;p>åœ¨ Kubernetes ä¸Šï¼ŒDapr æ˜¯ä½œä¸º sidecar éƒ¨ç½²çš„ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ Kubernetes ä¹‹å¤–å·¥ä½œï¼ˆä¸ä»…ä»…æ˜¯ Kubernetesï¼‰ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª operator &amp;ndash; è€Œ sidecar å’Œ Operator æ˜¯ä¸»è¦çš„æ‰©å±•æœºåˆ¶ã€‚å…¶ä»–ä¸€äº›ç»„ä»¶ç®¡ç†è¯ä¹¦ã€å¤„ç†åŸºäº actor çš„å»ºæ¨¡å¹¶æ³¨å…¥ sidecarã€‚ä½ çš„å·¥ä½œè´Ÿè½½ä¸ sidecar äº¤äº’ï¼Œå¹¶å°½å…¶æ‰€èƒ½ä¸å…¶ä»–æœåŠ¡å¯¹è¯ï¼Œè®©ä½ ä¸ä¸åŒçš„äº‘æä¾›å•†è¿›è¡Œäº’æ“ä½œã€‚å®ƒè¿˜ä¸ºä½ æä¾›äº†é¢å¤–çš„åˆ†å¸ƒå¼ç³»ç»ŸåŠŸèƒ½ã€‚&lt;/p>
&lt;p>ç»¼ä¸Šæ‰€è¿°ï¼Œè¿™äº›é¡¹ç›®æ‰€æä¾›çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥è¯´ ESB æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—©æœŸåŒ–èº«ï¼Œå…¶ä¸­æˆ‘ä»¬æœ‰é›†ä¸­å¼çš„æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢&amp;ndash;ä½†æ˜¯æ‰©å±•æ€§ä¸å¥½ã€‚åœ¨äº‘åŸç”Ÿä¸­ï¼Œé›†ä¸­å¼æ§åˆ¶å¹³é¢ä»ç„¶å­˜åœ¨ï¼Œä½†æ˜¯æ•°æ®å¹³é¢æ˜¯åˆ†æ•£çš„&amp;ndash;å¹¶ä¸”å…·æœ‰éš”éŸ³åŠŸèƒ½å’Œé«˜åº¦çš„å¯æ‰©å±•æ€§ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å§‹ç»ˆéœ€è¦ Kubernetes æ¥åšè‰¯å¥½çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä½ å¯èƒ½è¿˜éœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ªé™„åŠ ç»„ä»¶ã€‚ä½ å¯èƒ½éœ€è¦ Istio æ¥è¿›è¡Œé«˜çº§è”ç½‘ã€‚ä½ å¯èƒ½ä¼šä½¿ç”¨ Knative æ¥è¿›è¡Œæ— æœåŠ¡å™¨å·¥ä½œè´Ÿè½½ï¼Œæˆ–è€…ä½¿ç”¨ Dapr æ¥åšé›†æˆã€‚è¿™äº›æ¡†æ¶å¯ä¸ Istio å’Œ Envoy å¾ˆå¥½çš„é…åˆä½¿ç”¨ã€‚ä» Dapr å’Œ Knative çš„è§’åº¦æ¥çœ‹ï¼Œä½ å¯èƒ½å¿…é¡»é€‰æ‹©ä¸€ä¸ªã€‚å®ƒä»¬å…±åŒä»¥äº‘åŸç”Ÿçš„æ–¹å¼æä¾›äº†æˆ‘ä»¬è¿‡å»åœ¨ ESB ä¸Šæ‹¥æœ‰çš„ä¸œè¥¿ã€‚&lt;/p>
&lt;h2 id="æœªæ¥äº‘åŸç”Ÿè¶‹åŠ¿--ç”Ÿå‘½å‘¨æœŸè¶‹åŠ¿">æœªæ¥äº‘åŸç”Ÿè¶‹åŠ¿&amp;ndash;ç”Ÿå‘½å‘¨æœŸè¶‹åŠ¿&lt;/h2>
&lt;p>åœ¨æ¥ä¸‹æ¥çš„éƒ¨åˆ†ï¼Œæˆ‘åˆ—å‡ºäº†ä¸€äº›æˆ‘è®¤ä¸ºåœ¨è¿™äº›é¢†åŸŸæ­£åœ¨å‘ç”Ÿä»¤äººæŒ¯å¥‹çš„å‘å±•çš„é¡¹ç›®ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/8image0141616431695762.jpg" alt="">&lt;/p>
&lt;p>æˆ‘æƒ³ä»ç”Ÿå‘½å‘¨æœŸå¼€å§‹ã€‚é€šè¿‡ Kubernetesï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºåº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ªæœ‰ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™å¯èƒ½ä¸è¶³ä»¥è¿›è¡Œæ›´å¤æ‚çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªæ›´å¤æ‚çš„æœ‰çŠ¶æ€åº”ç”¨ï¼Œåˆ™å¯èƒ½ä¼šæœ‰è¿™æ ·çš„åœºæ™¯ï¼Œå…¶ä¸­ Kubernetes ä¸­çš„éƒ¨ç½²åŸè¯­ä¸è¶³ä»¥ä¸ºåº”ç”¨æä¾›æ”¯æŒã€‚&lt;/p>
&lt;p>åœ¨è¿™äº›åœºæ™¯ä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ operator æ¨¡å¼ã€‚ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ª operator æ¥è¿›è¡Œéƒ¨ç½²å’Œå‡çº§ï¼Œè¿˜å¯ä»¥å°† S3 ä½œä¸ºæœåŠ¡å¤‡ä»½çš„å­˜å‚¨ä»‹è´¨ã€‚æ­¤å¤–ï¼Œä½ å¯èƒ½è¿˜ä¼šå‘ç° Kubernetes çš„å®é™…å¥åº·æ£€æŸ¥æœºåˆ¶ä¸å¤Ÿå¥½ã€‚å‡è®¾å­˜æ´»æ£€æŸ¥å’Œå°±ç»ªæ£€æŸ¥ä¸å¤Ÿå¥½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ operator å¯¹ä½ çš„åº”ç”¨è¿›è¡Œæ›´æ™ºèƒ½çš„å­˜æ´»å’Œå°±ç»ªæ£€æŸ¥ï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ¢å¤ã€‚&lt;/p>
&lt;p>ç¬¬ä¸‰ä¸ªé¢†åŸŸå°±æ˜¯è‡ªåŠ¨ä¼¸ç¼©å’Œè°ƒæ•´ã€‚ä½ å¯ä»¥è®© operator æ›´å¥½çš„äº†è§£ä½ çš„åº”ç”¨ï¼Œå¹¶åœ¨å¹³å°ä¸Šè¿›è¡Œè‡ªåŠ¨è°ƒæ•´ã€‚ç›®å‰ï¼Œç¼–å†™ operator çš„æ¡†æ¶ä¸»è¦æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ Kubernetes ç‰¹åˆ«å…´è¶£å°ç»„çš„ Kubebuilderï¼Œå¦ä¸€ä¸ªæ˜¯çº¢å¸½åˆ›å»ºçš„ operator æ¡†æ¶çš„ä¸€éƒ¨åˆ†&amp;ndash;operator SDKã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„å†…å®¹ï¼š&lt;/p>
&lt;p>Operator SDK è®©ä½ å¯ä»¥ç¼–å†™ operator &amp;ndash; operator ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨æ¥ç®¡ç† operator çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠå¯ä»¥å‘å¸ƒä½ çš„ operator åˆ° OperatorHubã€‚å¦‚ä»Šåœ¨ OperatorHubï¼Œä½ ä¼šçœ‹åˆ° 100 å¤šä¸ª operator ç”¨äºç®¡ç†æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—å’Œç›‘æ§å·¥å…·ã€‚ä»ç”Ÿå‘½å‘¨æœŸç©ºé—´æ¥çœ‹ï¼Œoperator å¯èƒ½æ˜¯ Kubernetes ç”Ÿæ€ç³»ç»Ÿä¸­å‘å±•æœ€æ´»è·ƒçš„é¢†åŸŸã€‚&lt;/p>
&lt;h2 id="ç½‘ç»œè¶‹åŠ¿---envoy">ç½‘ç»œè¶‹åŠ¿ - Envoy&lt;/h2>
&lt;p>æˆ‘é€‰çš„å¦ä¸€ä¸ªé¡¹ç›®æ˜¯ &lt;a href="https://www.envoyproxy.io/">Envoy&lt;/a>ã€‚æœåŠ¡ç½‘æ ¼æ¥å£è§„èŒƒçš„å¼•å…¥å°†ä½¿ä½ æ›´è½»æ¾åœ°åˆ‡æ¢ä¸åŒçš„æœåŠ¡ç½‘æ ¼å®ç°ã€‚åœ¨éƒ¨ç½²ä¸Š Istio å¯¹æ¶æ„è¿›è¡Œäº†ä¸€äº›æ•´åˆã€‚ä½ ä¸å†éœ€è¦ä¸ºæ§åˆ¶å¹³é¢éƒ¨ç½² 7 ä¸ª Podï¼›ç°åœ¨ï¼Œä½ åªéœ€è¦éƒ¨ç½²ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚æ›´æœ‰è¶£çš„æ˜¯åœ¨ Envoy é¡¹ç›®çš„æ•°æ®å¹³é¢ä¸Šæ‰€æ­£åœ¨å‘ç”Ÿçš„ï¼šè¶Šæ¥è¶Šå¤šçš„ç¬¬ 7 å±‚åè®®è¢«æ·»åŠ åˆ° Envoy ä¸­ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/11image0151616431697613.jpg" alt="">&lt;/p>
&lt;p>æœåŠ¡ç½‘æ ¼å¢åŠ äº†å¯¹æ›´å¤šåè®®çš„æ”¯æŒï¼Œæ¯”å¦‚ MongoDBã€ZooKeeperã€MySQLã€Redisï¼Œè€Œæœ€æ–°çš„åè®®æ˜¯ Kafkaã€‚æˆ‘çœ‹åˆ° Kafka ç¤¾åŒºç°åœ¨æ­£åœ¨è¿›ä¸€æ­¥æ”¹è¿›ä»–ä»¬çš„åè®®ï¼Œä½¿å…¶å¯¹æœåŠ¡ç½‘æ ¼æ›´åŠ å‹å¥½ã€‚æˆ‘ä»¬å¯ä»¥é¢„æ–™å°†ä¼šæœ‰æ›´ç´§å¯†çš„é›†æˆã€æ›´å¤šçš„åŠŸèƒ½ã€‚æœ€æœ‰å¯èƒ½çš„æ˜¯ï¼Œä¼šæœ‰ä¸€äº›æ¡¥æ¥çš„èƒ½åŠ›ã€‚ä½ å¯ä»¥ä»æœåŠ¡ä¸­åœ¨ä½ çš„åº”ç”¨æœ¬åœ°åšä¸€ä¸ª HTTP è°ƒç”¨ï¼Œè€Œä»£ç†å°†åœ¨åå°ä½¿ç”¨ Kafkaã€‚ä½ å¯ä»¥åœ¨åº”ç”¨å¤–éƒ¨ï¼Œåœ¨ sidecar ä¸­é’ˆå¯¹ Kafka åè®®è¿›è¡Œè½¬æ¢å’ŒåŠ å¯†ã€‚&lt;/p>
&lt;p>å¦ä¸€ä¸ªä»¤äººå…´å¥‹çš„å‘å±•æ˜¯å¼•å…¥äº† HTTP ç¼“å­˜ã€‚ç°åœ¨ Envoy å¯ä»¥è¿›è¡Œ HTTP ç¼“å­˜ã€‚ä½ ä¸å¿…åœ¨ä½ çš„åº”ç”¨ä¸­ä½¿ç”¨ç¼“å­˜å®¢æˆ·ç«¯ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯åœ¨ sidecar ä¸­é€æ˜åœ°å®Œæˆçš„ã€‚æœ‰äº† tap è¿‡æ»¤å™¨ï¼Œä½ å¯ä»¥ tap æµé‡å¹¶è·å¾—æµé‡çš„å‰¯æœ¬ã€‚æœ€è¿‘ï¼ŒWebAssembly çš„å¼•å…¥ï¼Œæ„å‘³ç€å¦‚æœä½ è¦ä¸º Envoy ç¼–å†™ä¸€äº›è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ï¼Œä½ ä¸å¿…ç”¨ C++ ç¼–å†™ï¼Œä¹Ÿä¸å¿…ç¼–è¯‘æ•´ä¸ª Envoy è¿è¡Œæ—¶ã€‚ä½ å¯ä»¥ç”¨ WebAssembly å†™ä½ çš„è¿‡æ»¤å™¨ï¼Œç„¶ååœ¨è¿è¡Œæ—¶è¿›è¡Œéƒ¨ç½²ã€‚è¿™äº›å¤§å¤šæ•°è¿˜åœ¨è¿›è¡Œä¸­ã€‚å®ƒä»¬ä¸å­˜åœ¨ï¼Œè¯´æ˜æ•°æ®å¹³é¢å’ŒæœåŠ¡ç½‘æ ¼æ— æ„åœæ­¢ï¼Œä»…æ”¯æŒ HTTP å’Œ gRPCã€‚ä»–ä»¬æœ‰å…´è¶£æ”¯æŒæ›´å¤šçš„åº”ç”¨å±‚åè®®ï¼Œä¸ºä½ æä¾›æ›´å¤šçš„åŠŸèƒ½ï¼Œä»¥å®ç°æ›´å¤šçš„ç”¨ä¾‹ã€‚æœ€ä¸»è¦çš„æ˜¯ï¼Œéšç€ WebAssembly çš„å¼•å…¥ï¼Œä½ ç°åœ¨å¯ä»¥åœ¨ sidecar ä¸­ç¼–å†™è‡ªå®šä¹‰é€»è¾‘ã€‚åªè¦ä½ æ²¡æœ‰åœ¨å…¶ä¸­æ·»åŠ ä¸€äº›ä¸šåŠ¡é€»è¾‘å°±å¯ä»¥äº†ã€‚&lt;/p>
&lt;h2 id="ç»‘å®šè¶‹åŠ¿---apache-camel">ç»‘å®šè¶‹åŠ¿ - Apache Camel&lt;/h2>
&lt;p>&lt;a href="https://camel.apache.org/">Apache Camel&lt;/a> æ˜¯ä¸€ä¸ªç”¨äºé›†æˆçš„é¡¹ç›®ï¼Œå®ƒå…·æœ‰å¾ˆå¤šä½¿ç”¨ä¼ä¸šé›†æˆæ¨¡å¼è¿æ¥åˆ°ä¸åŒç³»ç»Ÿçš„è¿æ¥å™¨ã€‚Â æ¯”å¦‚ &lt;a href="https://camel.apache.org/releases/release-3.0.0/">Camel version 3&lt;/a> å°±æ·±åº¦é›†æˆåˆ°äº† Kubernetes ä¸­ï¼Œå¹¶ä¸”ä½¿ç”¨äº†æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢æ‰€è®²çš„é‚£äº›åŸè¯­ï¼Œæ¯”å¦‚ operatorã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/7image0161616431694981.jpg" alt="">&lt;/p>
&lt;p>ä½ å¯ä»¥åœ¨ Camel ä¸­ç”¨ Javaã€JavaScript æˆ– YAML ç­‰è¯­è¨€ç¼–å†™ä½ çš„é›†æˆé€»è¾‘ã€‚æœ€æ–°çš„ç‰ˆæœ¬å¼•å…¥äº†ä¸€ä¸ª Camel operatorï¼Œå®ƒåœ¨ Kubernetes ä¸­è¿è¡Œå¹¶ç†è§£ä½ çš„é›†æˆã€‚å½“ä½ å†™å¥½ Camel åº”ç”¨ï¼Œå°†å…¶éƒ¨ç½²åˆ°è‡ªå®šä¹‰èµ„æºä¸­ï¼Œoperator å°±çŸ¥é“å¦‚ä½•æ„å»ºå®¹å™¨æˆ–æŸ¥æ‰¾ä¾èµ–é¡¹ã€‚æ ¹æ®å¹³å°çš„èƒ½åŠ›ï¼Œä¸ç®¡æ˜¯åªç”¨ Kubernetesï¼Œè¿˜æ˜¯å¸¦æœ‰ Knative çš„ Kubernetesï¼Œå®ƒéƒ½å¯ä»¥å†³å®šè¦ä½¿ç”¨çš„æœåŠ¡ä»¥åŠå¦‚ä½•å®ç°é›†æˆã€‚åœ¨è¿è¡Œæ—¶ä¹‹å¤–æœ‰ç›¸å½“å¤šçš„æ™ºèƒ½ &amp;ndash; åŒ…æ‹¬ operator &amp;ndash; æ‰€æœ‰è¿™äº›éƒ½éå¸¸å¿«åœ°å‘ç”Ÿã€‚ä¸ºä»€ä¹ˆæˆ‘ä¼šè¯´è¿™æ˜¯ä¸€ä¸ªç»‘å®šçš„è¶‹åŠ¿ï¼Ÿä¸»è¦æ˜¯å› ä¸º Apache Camel æä¾›çš„è¿æ¥å™¨çš„åŠŸèƒ½ã€‚è¿™é‡Œæœ‰è¶£çš„ä¸€ç‚¹æ˜¯å®ƒå¦‚ä½•ä¸ Kubernetes æ·±åº¦é›†æˆã€‚&lt;/p>
&lt;h2 id="çŠ¶æ€è¶‹åŠ¿---cloudstate">çŠ¶æ€è¶‹åŠ¿ - Cloudstate&lt;/h2>
&lt;p>å¦ä¸€ä¸ªæˆ‘æƒ³è®¨è®ºçš„é¡¹ç›®æ˜¯ &lt;a href="https://cloudstate.io/">Cloudstate&lt;/a> å’Œä¸çŠ¶æ€ç›¸å…³çš„è¶‹åŠ¿ã€‚Cloudstate æ˜¯ Lightbend çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä¸»è¦è‡´åŠ›äºæ— æœåŠ¡å™¨å’ŒåŠŸèƒ½é©±åŠ¨çš„å¼€å‘ã€‚æœ€æ–°å‘å¸ƒçš„ç‰ˆæœ¬ï¼Œæ­£åœ¨ä½¿ç”¨ sidecar å’Œ operator ä¸ Kubernetes è¿›è¡Œæ·±åº¦é›†æˆã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/8image0171616431996943.jpg" alt="">&lt;/p>
&lt;p>è¿™ä¸ªåˆ›æ„æ˜¯ï¼Œå½“ä½ ç¼–å†™ä½ çš„åŠŸèƒ½æ—¶ï¼Œä½ åœ¨åŠŸèƒ½ä¸­è¦åšçš„å°±æ˜¯ä½¿ç”¨ gRPC æ¥è·å–çŠ¶æ€å¹¶ä¸ä¹‹è¿›è¡Œäº¤äº’ã€‚æ•´ä¸ªçŠ¶æ€ç®¡ç†åœ¨ä¸å…¶ä»– sidecar ç¾¤é›†çš„ sidear ä¸­è¿›è¡Œã€‚å®ƒä½¿ä½ èƒ½å¤Ÿè¿›è¡Œäº‹ä»¶æº¯æºã€CQRSã€é”®å€¼æŸ¥è¯¢ã€æ¶ˆæ¯ä¼ é€’ã€‚&lt;/p>
&lt;p>ä»åº”ç”¨ç¨‹åºè§’åº¦æ¥çœ‹ï¼Œä½ å¹¶ä¸äº†è§£æ‰€æœ‰è¿™äº›å¤æ‚æ€§ã€‚ä½ æ‰€åšçš„åªæ˜¯è°ƒç”¨ä¸€ä¸ªæœ¬åœ°çš„ sidecarï¼Œè€Œ sidecar ä¼šå¤„ç†è¿™äº›å¤æ‚çš„äº‹æƒ…ã€‚å®ƒå¯ä»¥åœ¨åå°ä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„æ•°æ®æºã€‚è€Œä¸”å®ƒæ‹¥æœ‰å¼€å‘äººå‘˜æ‰€éœ€çš„æ‰€æœ‰æœ‰çŠ¶æ€æŠ½è±¡ã€‚&lt;/p>
&lt;p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†äº‘åŸç”Ÿç”Ÿæ€ç³»ç»Ÿä¸­çš„æœ€æ–°æŠ€æœ¯ä»¥åŠä¸€äº›ä»åœ¨è¿›è¡Œä¸­çš„å¼€å‘ã€‚æˆ‘ä»¬å¦‚ä½•ç†è§£è¿™ä¸€åˆ‡ï¼Ÿ&lt;/p>
&lt;h2 id="å¤šè¿è¡Œæ—¶å¾®æœåŠ¡å·²ç»åˆ°æ¥">å¤šè¿è¡Œæ—¶å¾®æœåŠ¡å·²ç»åˆ°æ¥&lt;/h2>
&lt;p>å¦‚æœä½ çœ‹å¾®æœåŠ¡åœ¨ Kubernetes ä¸Šçš„æ ·å­ï¼Œåˆ™å°†éœ€è¦ä½¿ç”¨æŸäº›å¹³å°åŠŸèƒ½ã€‚æ­¤å¤–ï¼Œä½ å°†éœ€è¦é¦–å…ˆä½¿ç”¨ Kubernetes çš„åŠŸèƒ½è¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ç„¶åï¼Œå¾ˆæœ‰å¯èƒ½é€æ˜åœ°ï¼Œä½ çš„æœåŠ¡ä¼šä½¿ç”¨æŸäº›æœåŠ¡ç½‘æ ¼ï¼ˆä¾‹å¦‚ Envoyï¼‰æ¥è·å¾—å¢å¼ºçš„ç½‘ç»œåŠŸèƒ½ï¼Œæ— è®ºæ˜¯æµé‡è·¯ç”±ã€å¼¹æ€§ã€å¢å¼ºçš„å®‰å…¨æ€§ï¼Œç”šè‡³å‡ºäºç›‘æ§çš„ç›®çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ ¹æ®ä½ çš„åœºæ™¯å’Œä½¿ç”¨çš„å·¥ä½œè´Ÿè½½å¯èƒ½éœ€è¦ Dapr æˆ–è€… Knativeã€‚æ‰€æœ‰è¿™äº›éƒ½ä»£è¡¨äº†è¿›ç¨‹å¤–é™„åŠ çš„åŠŸèƒ½ã€‚å‰©ä¸‹çš„å°±æ˜¯ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ˜¯æ”¾åœ¨æœ€ä¸Šé¢è€Œæ˜¯ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„è¿è¡Œæ—¶æ¥ç¼–å†™ã€‚æœªæ¥çš„å¾®æœåŠ¡å¾ˆæœ‰å¯èƒ½å°†æ˜¯ç”±å¤šä¸ªå®¹å™¨ç»„æˆçš„è¿™ç§å¤šè¿è¡Œæ—¶ã€‚æœ‰äº›æ˜¯é€æ˜çš„ï¼Œæœ‰äº›åˆ™æ˜¯éå¸¸æ˜ç¡®çš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/6image0181616431996411.jpg" alt="">&lt;/p>
&lt;h2 id="æ™ºèƒ½çš„-sidecar-å’Œæ„šè ¢çš„ç®¡é“">æ™ºèƒ½çš„ sidecar å’Œæ„šè ¢çš„ç®¡é“&lt;/h2>
&lt;p>å¦‚æœæ›´æ·±å…¥åœ°çœ‹ï¼Œé‚£å¯èƒ½æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›é«˜çº§è¯­è¨€ç¼–å†™ä¸šåŠ¡é€»è¾‘ã€‚æ˜¯ä»€ä¹ˆå¹¶ä¸é‡è¦ï¼Œä¸å¿…ä»…æ˜¯ Javaï¼Œå› ä¸ºä½ å¯ä»¥ä½¿ç”¨ä»»ä½•å…¶ä»–è¯­è¨€å¹¶åœ¨å†…éƒ¨å¼€å‘è‡ªå®šä¹‰é€»è¾‘ã€‚&lt;/p>
&lt;p>ä½ çš„ä¸šåŠ¡é€»è¾‘ä¸å¤–éƒ¨ä¸–ç•Œçš„æ‰€æœ‰äº¤äº’éƒ½æ˜¯é€šè¿‡ sidecar å‘ç”Ÿçš„ï¼Œå¹¶ä¸å¹³å°é›†æˆè¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚å®ƒä¸ºå¤–éƒ¨ç³»ç»Ÿæ‰§è¡Œç½‘ç»œæŠ½è±¡ï¼Œä¸ºä½ æä¾›é«˜çº§çš„ç»‘å®šåŠŸèƒ½å’ŒçŠ¶æ€æŠ½è±¡ã€‚sidecar æ˜¯ä½ ä¸éœ€è¦å¼€å‘çš„ä¸œè¥¿ã€‚ä½ å¯ä»¥ä»è´§æ¶ä¸Šæ‹¿åˆ°å®ƒã€‚ä½ ç”¨ä¸€ç‚¹ YAML æˆ– JSON é…ç½®å®ƒï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨å®ƒã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥è½»æ¾åœ°æ›´æ–° sidecarï¼Œå› ä¸ºå®ƒä¸å†è¢«åµŒå…¥åˆ°ä½ çš„è¿è¡Œæ—¶ã€‚è¿™ä½¿å¾—æ‰“è¡¥ä¸ã€æ›´æ–°å˜å¾—æ›´åŠ æ›´å®¹æ˜“ã€‚å®ƒä¸ºæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘å¯ç”¨äº†å¤šè¯­è¨€è¿è¡Œæ—¶ã€‚&lt;/p>
&lt;h2 id="å¾®æœåŠ¡ä¹‹åæ˜¯ä»€ä¹ˆ">å¾®æœåŠ¡ä¹‹åæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/h2>
&lt;p>è¿™è®©æˆ‘æƒ³åˆ°äº†æœ€åˆçš„é—®é¢˜ï¼Œå¾®æœåŠ¡ä¹‹åæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/6image0201616431995910.jpg" alt="">&lt;/p>
&lt;p>å¦‚æœæˆ‘ä»¬çœ‹ä¸‹æ¶æ„çš„å‘å±•å†ç¨‹ï¼Œåº”ç”¨æ¶æ„åœ¨å¾ˆé«˜çš„å±‚é¢ä¸Šæ˜¯ä»å•ä½“åº”ç”¨å¼€å§‹çš„ã€‚ç„¶è€Œå¾®æœåŠ¡ç»™æˆ‘ä»¬æä¾›äº†å¦‚ä½•æŠŠä¸€ä¸ªå•ä½“åº”ç”¨æ‹†åˆ†æˆç‹¬ç«‹çš„ä¸šåŠ¡åŸŸçš„æŒ‡å¯¼åŸåˆ™ã€‚ä¹‹ååˆå‡ºç°äº†æ— æœåŠ¡å™¨å’ŒåŠŸèƒ½å³æœåŠ¡ï¼ˆFaaSï¼‰ï¼Œæˆ‘ä»¬è¯´è¿‡å¯ä»¥æŒ‰æ“ä½œå°†å…¶è¿›ä¸€æ­¥æ‹†åˆ†ï¼Œä»è€Œå®ç°æé«˜çš„å¯æ‰©å±•æ€§-å› ä¸ºæˆ‘ä»¬å¯ä»¥åˆ†åˆ«æ‰©å±•æ¯ä¸ªæ“ä½œã€‚&lt;/p>
&lt;p>æˆ‘æƒ³è¯´çš„æ˜¯ FaaS å¹¶ä¸æ˜¯æœ€å¥½çš„æ¨¡å¼ &amp;ndash; å› ä¸ºåŠŸèƒ½å¹¶ä¸æ˜¯å®ç°åˆç†çš„å¤æ‚æœåŠ¡çš„æœ€ä½³æ¨¡å¼ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å¤šä¸ªæ“ä½œå¿…é¡»ä¸åŒä¸€ä¸ªæ•°æ®é›†è¿›è¡Œäº¤äº’æ—¶ï¼Œä½ å¸Œæœ›å®ƒä»¬é©»ç•™åœ¨ä¸€èµ·ã€‚å¯èƒ½æ˜¯å¤šè¿è¡Œæ—¶ï¼ˆæˆ‘æŠŠå®ƒç§°ä¸º &lt;a href="https://www.infoq.com/articles/multi-runtime-microservice-architecture/">Mecha æ¶æ„&lt;/a>ï¼‰ï¼Œåœ¨è¯¥æ¶æ„ä¸­ä½ å°†ä¸šåŠ¡é€»è¾‘æ”¾åœ¨ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œè€Œæ‰€æœ‰ä¸åŸºç¡€è®¾æ–½ç›¸å…³çš„å…³æ³¨ç‚¹ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å®¹å™¨å­˜åœ¨ã€‚å®ƒä»¬å…±åŒä»£è¡¨å¤šè¿è¡Œæ—¶å¾®æœåŠ¡ã€‚ä¹Ÿè®¸è¿™æ˜¯ä¸€ä¸ªæ›´åˆé€‚çš„æ¨¡å‹ï¼Œå› ä¸ºå®ƒæœ‰æ›´å¥½çš„å±æ€§ã€‚&lt;/p>
&lt;p>ä½ å¯ä»¥è·å¾—å¾®æœåŠ¡çš„æ‰€æœ‰å¥½å¤„ã€‚ä»ç„¶å°†æ‰€æœ‰åŸŸå’Œæ‰€æœ‰é™ç•Œä¸Šä¸‹æ–‡æ”¾åœ¨ä¸€å¤„ã€‚ä½ å°†æ‰€æœ‰çš„åŸºç¡€è®¾æ–½å’Œåˆ†å¸ƒå¼åº”ç”¨éœ€æ±‚æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„å®¹å™¨ä¸­ï¼Œå¹¶åœ¨è¿è¡Œæ—¶å°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ã€‚å¤§æ¦‚ï¼Œç°åœ¨æœ€æ¥è¿‘è¿™ç§æ¨¡å‹çš„æ˜¯ Daprã€‚ä»–ä»¬æ­£åœ¨éµå¾ªè¿™ç§æ¨¡å‹ã€‚å¦‚æœä½ ä»…å¯¹ç½‘ç»œæ–¹é¢æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆå¯èƒ½ä½¿ç”¨ Envoy ä¹Ÿä¼šæ¥è¿‘è¿™ç§æ¨¡å‹ã€‚&lt;/p>
&lt;h2 id="å…³äºä½œè€…">å…³äºä½œè€…&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/03/30/21bilgin-ibryam15886810412341616480845087.jpeg" alt="">&lt;/p>
&lt;p>&lt;strong>Bilgin Ibryam&lt;/strong> æ˜¯çº¢å¸½å…¬å¸çš„äº§å“ç»ç†å’Œå‰æ¶æ„å¸ˆã€æäº¤äººï¼Œå¹¶ä¸”æ˜¯ Apache è½¯ä»¶åŸºé‡‘ä¼šçš„æˆå‘˜ã€‚ä»–æ˜¯å¼€æºå¸ƒé“è€…ï¼Œç»å¸¸å†™åšå®¢ã€å‘è¡¨æ¼”è®²ï¼Œæ˜¯ &lt;a href="https://k8spatterns.io/">Kubernetes Patterns&lt;/a> å’Œ Camel Design Patterns ä¹¦ç±çš„ä½œè€…ã€‚Bilgin ç›®å‰çš„å·¥ä½œä¸»è¦é›†ä¸­åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿã€äº‹ä»¶é©±åŠ¨æ¶æ„ä»¥åŠå¯é‡å¤çš„äº‘åŸç”Ÿåº”ç”¨å¼€å‘æ¨¡å¼å’Œå®è·µä¸Šã€‚è¯·å…³æ³¨ä»– @bibryam äº†è§£æœªæ¥ç±»ä¼¼ä¸»é¢˜çš„æ›´æ–°ã€‚&lt;/p></description></item><item><title>ã€è¯‘ã€‘2021 å¹´åŠæœªæ¥çš„äº‘åŸç”Ÿé¢„æµ‹</title><link>https://atbug.com/translation-cloud-native-predictions-for-2021-and-beyond/</link><pubDate>Tue, 09 Feb 2021 06:43:54 +0800</pubDate><guid>https://atbug.com/translation-cloud-native-predictions-for-2021-and-beyond/</guid><description>
&lt;p>æœ¬æ–‡è¯‘è‡ª &lt;a href="https://www.cncf.io/blog/2021/01/29/cloud-native-predictions-for-2021-and-beyond/">Cloud Native Predictions for 2021 and Beyond&lt;/a>&lt;/p>
&lt;p>åŸæ–‡å‘å¸ƒåœ¨Â &lt;a href="https://www.aniszczyk.org/2021/01/19/cloud-native-predictions-for-2021-and-beyond/">Chris Aniszczyk çš„ä¸ªäººåšå®¢&lt;/a>&lt;/p>
&lt;p>æˆ‘å¸Œæœ›æ¯ä¸ªäººéƒ½æœ‰ä¸€ä¸ªç¾å¥½çš„å‡æœŸï¼Œå› ä¸º 2021 å¹´ 1 æœˆçš„å‰å‡ å‘¨ä¸€ç›´éå¸¸ç–¯ç‹‚ï¼Œä»å›ä¹±åˆ°æ–°çš„ COVID èŒæ ªã€‚åœ¨äº‘åŸç”Ÿå›½åº¦ï¼ŒCNCF æœ€è¿‘å‘å¸ƒäº†å…³äºæˆ‘ä»¬å»å¹´å®Œæˆçš„æ‰€æœ‰å·¥ä½œçš„&lt;a href="https://www.cncf.io/cncf-annual-report-2020/">å¹´åº¦æŠ¥å‘Š&lt;/a>ã€‚æˆ‘å»ºè®®å¤§å®¶æ‰¾ä¸ªæœºä¼šå»çœ‹ä¸€ä¸‹è¿™ä»½æŠ¥å‘Šï¼Œåœ¨ç–«æƒ…å¤§æµè¡Œçš„è¿™ä¸€å¹´ï¼Œæˆ‘ä»¬æ”¶è·é¢‡ä¸°ã€‚&lt;a href="https://twitter.com/CloudNativeFdn/status/1343914259177222145">https://twitter.com/CloudNativeFdn/status/1343914259177222145&lt;/a>&lt;/p>
&lt;p>ä½œä¸ºæˆ‘å·¥ä½œçš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘å¯¹äº‘åŸç”Ÿè¶‹åŠ¿æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„è§‚ç‚¹ï¼Œé€ç»™æ‰€æœ‰ä¸æˆ‘åˆä½œçš„ä¼šå‘˜å…¬å¸å’Œå¼€å‘äººå‘˜ï¼Œæ‰€ä»¥æˆ‘æƒ³æˆ‘ä¼šåˆ†äº«æˆ‘å¯¹ 2021 å¹´åŠä»¥åäº‘åŸç”Ÿå‘å±•çš„æƒ³æ³•ã€‚&lt;/p>
&lt;p>&lt;strong>äº‘åŸç”Ÿçš„ IDE&lt;/strong>&lt;/p>
&lt;p>ä½œä¸ºä¸€ä¸ªåœ¨ Eclipse åŸºé‡‘ä¼šå†…éƒ¨ä»äº‹å¼€å‘è€…å·¥å…·å·¥ä½œçš„äººï¼Œæˆ‘å¯¹æœ€è¿‘çš„æŠ€æœ¯çŠ¶æ€è¿›å±•æ„Ÿåˆ°æ— æ¯”å…´å¥‹ã€‚æœªæ¥ï¼Œå¼€å‘ç”Ÿå‘½å‘¨æœŸï¼ˆä»£ç ã€æ„å»ºã€è°ƒè¯•ï¼‰å°†ä¸»è¦å‘ç”Ÿåœ¨äº‘ç«¯ï¼Œè€Œä¸æ˜¯ä½ æœ¬åœ°çš„ Emacs æˆ– VSCodeã€‚ä½ å°†æ¯ä¸€ä¸ªæ‹‰åŠ¨è¯·æ±‚æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„å¼€å‘ç¯å¢ƒè®¾ç½®ï¼Œé¢„å…ˆé…ç½®å¹¶è¿æ¥åˆ°ä»–ä»¬è‡ªå·±çš„éƒ¨ç½²ï¼Œä»¥ååŠ©ä½ çš„å¼€å‘å’Œè°ƒè¯•éœ€æ±‚ã€‚ä»Šå¤©è¿™ç§æŠ€æœ¯çš„ä¸€ä¸ªå…·ä½“ä¾‹å­æ˜¯é€šè¿‡ GitHub &lt;a href="https://github.com/features/codespaces">Codespaces&lt;/a> å’Œ &lt;a href="https://gitpod.io/">GitPod&lt;/a> å®ç°çš„ã€‚è™½ç„¶ GitHub Codespaces è¿˜å¤„äºæµ‹è¯•é˜¶æ®µï¼Œä½†ä»Šå¤©ä½ å¯ä»¥é€šè¿‡ GitPod æ¥ä½“éªŒï¼Œä»¥ &lt;a href="https://gitpod.io/#https://github.com/prometheus/prometheus">Prometheus&lt;/a> ä¸ºä¾‹ã€‚ä¸€åˆ†é’Ÿå·¦å³ï¼Œä½ å°±æ‹¥æœ‰äº†ä¸€ä¸ªæœ‰ç¼–è¾‘å™¨å’Œé¢„è§ˆç¯å¢ƒçš„å®Œå…¨å®æ—¶çš„å¼€å‘ç¯å¢ƒã€‚æœ€ç–¯ç‹‚çš„æ˜¯ï¼Œè¿™ä¸ªå¼€å‘ç¯å¢ƒï¼ˆå·¥ä½œç©ºé—´ï¼‰æ˜¯ &lt;a href="https://github.com/prometheus/prometheus/blob/master/.gitpod.yml">ç”¨ä»£ç æè¿°&lt;/a>ï¼Œå¹¶ä¸”å¯ä»¥åƒå…¶ä»–ä»£ç å·¥ä»¶ä¸€æ ·ï¼Œä¸ä½ å›¢é˜Ÿçš„å…¶ä»–å¼€å‘è€…å…±äº«ã€‚&lt;/p>
&lt;p>æœ€åï¼Œæˆ‘æœŸæœ›åœ¨æ¥ä¸‹æ¥çš„ä¸€å¹´é‡Œï¼Œèƒ½çœ‹åˆ°äº‘åŸç”Ÿ IDE é¢†åŸŸå‡ºç°ä»¤äººéš¾ä»¥ç½®ä¿¡çš„åˆ›æ–°ï¼Œç‰¹åˆ«æ˜¯éšç€ GitHub Codespaces è¿›å…¥æµ‹è¯•ç‰ˆä¹‹åï¼Œå¹¶å¾—åˆ°å¹¿æ³›åœ°ä½¿ç”¨ï¼Œè®©å¼€å‘è€…å¯ä»¥ä½“éªŒåˆ°è¿™ä¸ªæ–°æ¦‚å¿µï¼Œå¹¶çˆ±ä¸Šå®ƒã€‚&lt;/p>
&lt;p>&lt;strong>è¾¹ç¼˜çš„ Kubernetes&lt;/strong>&lt;/p>
&lt;p>Kubernetes æ˜¯é€šè¿‡åœ¨å¤§è§„æ¨¡æ•°æ®ä¸­å¿ƒçš„ä½¿ç”¨è€Œè¯ç”Ÿçš„ï¼Œä½† Kubernetes ä¼šåƒ Linux ä¸€æ ·ä¸ºæ–°çš„ç¯å¢ƒè€Œè¿›åŒ–ã€‚Linux æ‰€å‘ç”Ÿçš„äº‹æƒ…æ˜¯ï¼Œç»ˆç«¯ç”¨æˆ·æœ€ç»ˆå¯¹å†…æ ¸è¿›è¡Œäº†æ‰©å±•ï¼Œä»¥æ”¯æŒä»ç§»åŠ¨ã€åµŒå…¥å¼ç­‰å„ç§æ–°çš„éƒ¨ç½²åœºæ™¯ã€‚æˆ‘åšä¿¡ Kubernetes ä¹Ÿä¼šç»å†ç±»ä¼¼çš„è¿›åŒ–ï¼Œæˆ‘ä»¬å·²ç»è§è¯äº† Telcosï¼ˆå’Œå…¶ä»–åˆåˆ›å…¬å¸ï¼‰é€šè¿‡å°† VNFs è½¬åŒ–ä¸º &lt;a href="https://github.com/cncf/cnf-wg">äº‘åŸç”Ÿç½‘ç»œåŠŸèƒ½&lt;/a>ï¼ˆCNFsï¼‰ï¼Œä»¥åŠ &lt;a href="https://k3s.io/">k3s&lt;/a>ã€KubeEdgeã€k0sã€&lt;a href="https://www.lfedge.org/">LFEdge&lt;/a>ã€Eclipse ioFog ç­‰å¼€æºé¡¹ç›®ï¼Œæ¥æ¢ç´¢ Kubernetes ä½œä¸ºè¾¹ç¼˜å¹³å°ã€‚æ¨åŠ¨è¶…å¤§è§„æ¨¡äº‘æœåŠ¡æ”¯æŒç”µä¿¡å…¬å¸å’Œè¾¹ç¼˜çš„èƒ½åŠ›ï¼Œå†åŠ ä¸Šé‡ç”¨äº‘åŸç”Ÿè½¯ä»¶çš„èƒ½åŠ›ï¼Œä»¥åŠå»ºç«‹åœ¨ç°æœ‰åºå¤§çš„ç”Ÿæ€ç³»ç»ŸåŸºç¡€ä¸Šçš„èƒ½åŠ›ï¼Œå°†å·©å›º Kubernetes åœ¨æœªæ¥å‡ å¹´å†…æˆä¸ºè¾¹ç¼˜è®¡ç®—çš„ä¸»å¯¼å¹³å°ã€‚&lt;/p>
&lt;p>&lt;strong>äº‘åŸç”Ÿ + Wasm&lt;/strong>&lt;/p>
&lt;p>&lt;a href="https://webassembly.org/">Web Assembly&lt;/a>(Wasm) æ˜¯ä¸€é¡¹æ–°çš„æŠ€æœ¯ï¼Œä½†æˆ‘é¢„è®¡å®ƒå°†æˆä¸ºäº‘åŸç”Ÿç”Ÿæ€ç³»ç»Ÿä¸­ä¸æ–­å¢é•¿çš„å®ç”¨å·¥å…·å’Œå·¥ä½œè´Ÿè½½ï¼Œç‰¹åˆ«æ˜¯éšç€ &lt;a href="https://wasi.dev/">WASI&lt;/a> çš„æˆç†Ÿï¼Œä»¥åŠ Kubernetes æ›´å¤šåœ°ä½œä¸ºè¾¹ç¼˜ç¼–æ’å·¥å…·ä½¿ç”¨ï¼Œå¦‚å‰æ‰€è¿°ã€‚ä¸€ä¸ªåœºæ™¯æ˜¯å¢å¼ºæ‰©å±•æœºåˆ¶ï¼Œå°±åƒ Envoy å¯¹è¿‡æ»¤å™¨å’Œ LuaJIT æ‰€åšçš„é‚£æ ·ã€‚ä½ å¯ä»¥ä¸ä¸€ä¸ªæ”¯æŒå„ç§ç¼–ç¨‹è¯­è¨€çš„æ›´å°çš„ä¼˜åŒ–è¿è¡Œæ—¶ååŒï¼Œè€Œä¸æ˜¯ç›´æ¥ä¸ Lua æ‰“äº¤é“ã€‚Envoy é¡¹ç›®ç›®å‰æ­£å¤„äº &lt;a href="https://www.solo.io/blog/the-state-of-webassembly-in-envoy-proxy/">é‡‡ç”¨ Wasm&lt;/a> çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘é¢„è®¡ä»»ä½•ä½¿ç”¨è„šæœ¬è¯­è¨€ä½œä¸ºæµè¡Œæ‰©å±•æœºåˆ¶çš„ç¯å¢ƒéƒ½ä¼šå‡ºç°è¢« Wasm å…¨ç›˜å–ä»£çš„æƒ…å†µã€‚&lt;/p>
&lt;p>åœ¨ Kubernetes æ–¹é¢ï¼Œæœ‰åƒå¾®è½¯çš„ &lt;a href="https://deislabs.io/posts/introducing-krustlet/">Krustlet&lt;/a> è¿™æ ·çš„é¡¹ç›®ï¼Œæ­£åœ¨æ¢ç´¢å¦‚ä½•åœ¨ Kubernetes ä¸­æ”¯æŒåŸºäº WASI çš„è¿è¡Œæ—¶ã€‚è¿™ä¸åº”è¯¥å¤ªä»¤äººæƒŠè®¶ï¼Œå› ä¸º Kubernetes å·²ç»åœ¨é€šè¿‡ CRD å’Œå…¶ä»–æœºåˆ¶æ‰©å±•ï¼Œä»¥è¿è¡Œä¸åŒç±»å‹çš„å·¥ä½œè´Ÿè½½ï¼Œå¦‚ VMï¼ˆ&lt;a href="https://kubevirt.io/">KubeVirt&lt;/a>ï¼‰ç­‰ç­‰ã€‚&lt;/p>
&lt;p>å¦å¤–ï¼Œå¦‚æœä½ æ˜¯ Wasm çš„æ–°æ‰‹ï¼Œæˆ‘æ¨è Linux åŸºé‡‘ä¼šçš„è¿™æœ¬æ–°çš„ &lt;a href="https://www.edx.org/course/introduction-to-webassembly-runtime">å…¥é—¨è¯¾ç¨‹&lt;/a>ï¼Œå®ƒå¯¹å…¶è¿›è¡Œäº†ä»‹ç»ï¼Œä»¥åŠä¼˜é€‰çš„æ–‡æ¡£ã€‚&lt;/p>
&lt;p>&lt;strong>FinOps çš„å´›èµ·ï¼ˆCFMï¼‰&lt;/strong>&lt;/p>
&lt;p>æ–°å† ç—…æ¯’çš„çˆ†å‘åŠ é€Ÿäº†å‘äº‘åŸç”Ÿçš„è½¬å˜ã€‚è‡³å°‘æœ‰ä¸€åŠçš„å…¬å¸åœ¨å±æœºä¸­åŠ å¿«äº†ä»–ä»¬çš„äº‘è®¡åˆ’ã€‚è¿‘ 60% çš„å—è®¿è€…è¡¨ç¤ºï¼Œç”±äº COVID-19 å¤§æµè¡Œï¼Œäº‘è®¡ç®—çš„ä½¿ç”¨é‡å°†è¶…è¿‡ä¹‹å‰çš„è®¡åˆ’ (&lt;a href="https://info.flexera.com/SLO-CM-REPORT-State-of-the-Cloud-2020">2020 å¹´äº‘è®¡ç®—ç°çŠ¶æŠ¥å‘Š&lt;/a>)ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œäº‘è´¢åŠ¡ç®¡ç† (æˆ– FinOps) å¯¹è®¸å¤šå…¬å¸æ¥è¯´æ˜¯ä¸€ä¸ªæ—¥ç›Šä¸¥é‡çš„é—®é¢˜å’Œ &lt;a href="https://www.wsj.com/articles/cloud-bills-will-get-loftier-1518363001">å…³æ³¨&lt;/a>ï¼Œè€å®è¯´ï¼Œåœ¨è¿‡å» 6 ä¸ªæœˆé‡Œï¼Œæˆ‘ä¸æ­£åœ¨è¿›è¡Œäº‘åŸç”Ÿä¹‹æ—…çš„å…¬å¸è¿›è¡Œçš„è®¨è®ºä¸­ï¼Œå¤§çº¦æœ‰ä¸€åŠçš„è®¨è®ºéƒ½ä¼šæåˆ°è¿™ä¸ªé—®é¢˜ã€‚ä½ ä¹Ÿå¯ä»¥è¯´ï¼Œäº‘æä¾›å•†æ²¡æœ‰åŠ¨åŠ›è®©äº‘è´¢åŠ¡ç®¡ç†å˜å¾—æ›´å®¹æ˜“ï¼Œå› ä¸ºè¿™å°†ä½¿å®¢æˆ·æ›´å®¹æ˜“å‡å°‘æ”¯å‡ºï¼Œç„¶è€Œï¼Œåœ¨æˆ‘çœ‹æ¥ï¼ŒçœŸæ­£çš„ç—›è‹¦æ˜¯ç¼ºä¹å›´ç»•äº‘è´¢åŠ¡ç®¡ç†çš„å¼€æºåˆ›æ–°å’Œæ ‡å‡†åŒ–ï¼ˆæ‰€æœ‰çš„äº‘éƒ½ä»¥ä¸åŒçš„æ–¹å¼è¿›è¡Œæˆæœ¬ç®¡ç†ï¼‰ã€‚åœ¨ CNCF çš„èƒŒæ™¯ä¸‹ï¼Œè¯•å›¾è®© FinOps å˜å¾—æ›´å®¹æ˜“çš„å¼€æºé¡¹ç›®å¹¶ä¸å¤šï¼Œæœ‰ &lt;a href="https://github.com/kubecost/cost-model">KubeCost&lt;/a> é¡¹ç›®ï¼Œä½†è¿˜ç›¸å½“æ—©æœŸã€‚&lt;/p>
&lt;p>å¦å¤–ï¼ŒLinux åŸºé‡‘ä¼šæœ€è¿‘æ¨å‡ºäº† &lt;a href="https://www.finops.org/blog/linux-foundation">FinOps åŸºé‡‘ä¼š&lt;/a> æ¥å¸®åŠ©è¿™ä¸ªé¢†åŸŸçš„åˆ›æ–°ï¼Œä»–ä»¬åœ¨è¿™ä¸ªé¢†åŸŸæœ‰ä¸€äº› &lt;a href="https://www.edx.org/course/introduction-to-finops">å¾ˆæ£’çš„å…¥é—¨ææ–™&lt;/a>ã€‚æˆ‘æœŸæœ›åœ¨æœªæ¥å‡ å¹´ï¼Œåœ¨ FinOps é¢†åŸŸèƒ½çœ‹åˆ°æ›´å¤šçš„å¼€æºé¡¹ç›®å’Œè§„èŒƒã€‚&lt;/p>
&lt;p>&lt;strong>äº‘åŸç”Ÿä¸­æ›´å¤šçš„ä½¿ç”¨ Rust&lt;/strong>&lt;/p>
&lt;p>Rust ä»ç„¶æ˜¯ä¸€é—¨å¹´è½»è€Œå°ä¼—çš„ç¼–ç¨‹è¯­è¨€ï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ ä»¥ Redmonk çš„ &lt;a href="https://redmonk.com/sogrady/2020/07/27/language-rankings-6-20/">ç¼–ç¨‹è¯­è¨€æ’å&lt;/a> ä¸ºä¾‹ã€‚ç„¶è€Œï¼Œæˆ‘çš„æ„Ÿè§‰æ˜¯ï¼Œé‰´äºå·²ç»æœ‰ä¸€äº› &lt;a href="https://www.cncf.io/blog/2020/06/22/rust-at-cncf/">ä½¿ç”¨ Rust çš„ CNCF é¡¹ç›®&lt;/a>ï¼Œä»¥åŠå®ƒå‡ºç°åœ¨åƒ microvm &lt;a href="https://firecracker-microvm.github.io/">Firecracker&lt;/a> è¿™æ ·æœ‰è¶£çš„åŸºç¡€è®¾æ–½é¡¹ç›®ä¸­ï¼Œä½ å°†åœ¨æœªæ¥ä¸€å¹´ä¸­çœ‹åˆ° Rust å‡ºç°åœ¨æ›´å¤šçš„äº‘åŸç”Ÿé¡¹ç›®ä¸­ã€‚è™½ç„¶ CNCF ç›®å‰æœ‰è¶…å¤šçš„é¡¹ç›®æ˜¯ç”¨ Golang ç¼–å†™çš„ï¼Œä½†æˆ‘é¢„è®¡éšç€ &lt;a href="https://blog.rust-lang.org/2020/08/18/laying-the-foundation-for-rusts-future.html">Rust ç¤¾åŒºçš„æˆç†Ÿ&lt;/a>ï¼Œå‡ å¹´ååŸºäº Rust çš„é¡¹ç›®å°†ä¸åŸºäº Go çš„é¡¹ç›®å¹³èµ·å¹³åã€‚&lt;/p>
&lt;p>&lt;strong>GitOps+CD/PD å¢é•¿æ˜¾è‘—&lt;/strong>&lt;/p>
&lt;p>&lt;a href="https://www.weave.works/blog/what-is-gitops-really">GitOps&lt;/a> æ˜¯äº‘åŸç”ŸæŠ€æœ¯çš„ä¸€ç§æ“ä½œæ¨¡å¼ï¼Œæä¾›äº†ä¸€å¥—ç»Ÿä¸€éƒ¨ç½²ã€ç®¡ç†å’Œç›‘æ§åº”ç”¨ç¨‹åºçš„æœ€ä½³å®è·µ (æœ€åˆæ˜¯ç”± Weaveworks åæ°”å¾ˆå¤§çš„ Alexis Richardson&lt;a href="https://www.weave.works/blog/gitops-operations-by-pull-request">åˆ›é€ &lt;/a>)ã€‚GitOps æœ€é‡è¦çš„æ–¹é¢æ˜¯é€šè¿‡å£°æ˜çš„æ–¹å¼æè¿°æ‰€éœ€çš„åœ¨ Git ä¸­ç‰ˆæœ¬åŒ–çš„ç³»ç»ŸçŠ¶æ€ï¼Œè¿™åŸºæœ¬ä¸Šå¯ä»¥ä½¿ä¸€ç³»åˆ—å¤æ‚çš„ç³»ç»Ÿå˜æ›´è¢«æ­£ç¡®åœ°åº”ç”¨ï¼Œç„¶åè¿›è¡ŒéªŒè¯ï¼ˆé€šè¿‡ Git å’Œå…¶ä»–å·¥å…·å¯ç”¨çš„æ¼‚äº®çš„å®¡è®¡æ—¥å¿—ï¼‰ã€‚ä»å®ç”¨çš„è§’åº¦æ¥çœ‹ï¼ŒGitOps æ”¹å–„äº†å¼€å‘è€…çš„ä½“éªŒï¼Œéšç€ Argoã€GitLabã€Flux ç­‰é¡¹ç›®çš„å‘å±•ï¼Œæˆ‘é¢„è®¡ä»Šå¹´ GitOps å·¥å…·ä¼šæ›´å¤šåœ°å†²å‡»ä¼ä¸šã€‚å¦‚æœä½ çœ‹è¿‡ GitLab çš„ &lt;a href="https://about.gitlab.com/blog/2020/07/14/gitops-next-big-thing-automation/">æ•°æ®&lt;/a>ï¼ŒGitOps è¿˜æ˜¯ä¸€ä¸ªå¤§éƒ¨åˆ†å…¬å¸è¿˜æ²¡æœ‰æ¢ç´¢å‡ºæ¥çš„æ–°å…´çš„å®è·µï¼Œä½†éšç€è¶Šæ¥è¶Šå¤šçš„å…¬å¸å¤§è§„æ¨¡é‡‡ç”¨äº‘åŸç”Ÿè½¯ä»¶ï¼Œæˆ‘è®¤ä¸º GitOps è‡ªç„¶ä¼šéšä¹‹è€Œæ¥ã€‚å¦‚æœä½ æœ‰å…´è¶£äº†è§£æ›´å¤šå…³äºè¿™ä¸ªé¢†åŸŸçš„ä¿¡æ¯ï¼Œæˆ‘æ¨èä½ å»çœ‹çœ‹ CNCF ä¸­ &lt;a href="https://codefresh.io/devops/announcing-gitops-working-group/">æ–°&lt;/a> æˆç«‹çš„ &lt;a href="https://github.com/gitops-working-group/gitops-working-group">GitOps å·¥ä½œç»„&lt;/a>ã€‚&lt;/p>
&lt;p>&lt;strong>æœåŠ¡ç›®å½•2.0ï¼šäº‘åŸç”Ÿå¼€å‘è€…ä»ªè¡¨ç›˜&lt;/strong>&lt;/p>
&lt;p>æœåŠ¡ç›®å½•çš„æ¦‚å¿µå¹¶ä¸æ˜¯ä¸€ä¸ªæ–°äº‹ç‰©ï¼Œå¯¹äºæˆ‘ä»¬ä¸€äº›åœ¨ &lt;a href="https://en.wikipedia.org/wiki/ITIL">ITIL&lt;/a> æ—¶ä»£æˆé•¿èµ·æ¥çš„è€äººä»¬æ¥è¯´ï¼Œä½ å¯èƒ½è¿˜è®°å¾— &lt;a href="https://en.wikipedia.org/wiki/Configuration_management_database">CMDBs&lt;/a> ï¼ˆææ€–ï¼‰ç­‰ä¸œè¥¿ã€‚ç„¶è€Œï¼Œéšç€å¾®æœåŠ¡å’Œäº‘åŸç”Ÿå¼€å‘çš„å…´èµ·ï¼Œå¯¹æœåŠ¡è¿›è¡Œç¼–ç›®å’Œç´¢å¼•å„ç§å®æ—¶æœåŠ¡å…ƒæ•°æ®çš„èƒ½åŠ›å¯¹äºæ¨åŠ¨å¼€å‘è€…è‡ªåŠ¨åŒ–æ˜¯è‡³å…³é‡è¦çš„ã€‚è¿™å¯ä»¥åŒ…æ‹¬ä½¿ç”¨æœåŠ¡ç›®å½•æ¥äº†è§£æ‰€æœ‰æƒæ¥å¤„ç†äº‹ä»¶ç®¡ç†ã€ç®¡ç† SLO ç­‰ã€‚&lt;/p>
&lt;p>åœ¨æœªæ¥ï¼Œä½ å°†çœ‹åˆ°å¼€å‘äººå‘˜ä»ªè¡¨ç›˜çš„è¶‹åŠ¿ï¼Œå®ƒä¸ä»…æ˜¯ä¸€ä¸ªæœåŠ¡ç›®å½•ï¼Œè€Œä¸”æä¾›äº†é€šè¿‡å„ç§è‡ªåŠ¨åŒ–åŠŸèƒ½åœ¨æ‰©å±•ä»ªè¡¨ç›˜çš„èƒ½åŠ›ã€‚è¿™æ–¹é¢çš„å…¸èŒƒå¼€æºä¾‹å­æ˜¯ Lyft çš„ &lt;a href="https://engineering.atspotify.com/2020/03/17/what-the-heck-is-backstage-anyway/">Backstage&lt;/a> å’Œ &lt;a href="https://eng.lyft.com/announcing-clutch-the-open-source-platform-for-infrastructure-tooling-143d00de9713">Clutch&lt;/a>ï¼Œç„¶è€Œï¼Œä»»ä½•æ‹¥æœ‰ç›¸å½“ç°ä»£çš„äº‘åŸç”Ÿéƒ¨ç½²çš„å…¬å¸å¾€å¾€éƒ½æœ‰ä¸€ä¸ªå¹³å°åŸºç¡€è®¾æ–½å›¢é˜Ÿï¼Œä»–ä»¬å·²ç»å°è¯•æ„å»ºç±»ä¼¼çš„ä¸œè¥¿ã€‚éšç€å¼€æºå¼€å‘è€…ä»ªè¡¨ç›˜ä¸ &lt;a href="https://backstage.io/plugins">å¤§å‹æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ&lt;/a> çš„æˆç†Ÿï¼Œä½ ä¼šçœ‹åˆ°å…¶è¢«å„åœ°çš„å¹³å°å·¥ç¨‹å›¢é˜ŸåŠ é€Ÿé‡‡ç”¨ã€‚&lt;/p>
&lt;p>&lt;strong>è·¨äº‘å˜å¾—æ›´çœŸå®&lt;/strong>&lt;/p>
&lt;p>Kubernetes å’Œäº‘åŸç”Ÿè¿åŠ¨å·²ç»è¯æ˜äº†äº‘åŸç”Ÿå’Œå¤šäº‘æ–¹å¼åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯å¯è¡Œçš„ï¼Œæ•°æ®å¾ˆæ¸…æ¥šåœ°è¡¨æ˜â€œ93% çš„ä¼ä¸šéƒ½æœ‰ä½¿ç”¨å¾®è½¯ Azureã€äºšé©¬é€Šç½‘ç»œæœåŠ¡å’Œè°·æ­Œäº‘ç­‰å¤šä¸ªæä¾›å•†çš„ç­–ç•¥â€ (&lt;a href="https://info.flexera.com/SLO-CM-REPORT-State-of-the-Cloud-2020">2020 å¹´äº‘è®¡ç®—ç°çŠ¶æŠ¥å‘Š&lt;/a>)ã€‚äº‹å®ä¸Šï¼ŒKubernetes è¿™äº›å¹´ä¼´éšç€äº‘å¸‚åœºçš„å‘å±•è€Œæ›´åŠ æˆç†Ÿï¼Œå°†æœ‰æœ›è§£é”ç¨‹åºåŒ–çš„è·¨äº‘ç®¡ç†æœåŠ¡ã€‚è¿™ç§æ–¹æ³•çš„ä¸€ä¸ªå…·ä½“ä¾‹å­ä½“ç°åœ¨ Crossplane é¡¹ç›®ä¸­ï¼Œè¯¥é¡¹ç›®æä¾›äº†ä¸€ä¸ªå¼€æºçš„è·¨äº‘æ§åˆ¶å¹³é¢ï¼Œåˆ©ç”¨ Kubernetes API çš„å¯æ‰©å±•æ€§æ¥å®ç°è·¨äº‘å·¥ä½œè´Ÿè½½ç®¡ç†ï¼ˆå‚è§ &lt;a href="https://thenewstack.io/gitlab-deploys-the-crossplane-control-plane-to-offer-multicloud-deployments/">&amp;ldquo;GitLab éƒ¨ç½² Crossplane æ§åˆ¶å¹³é¢ï¼Œæä¾›å¤šäº‘éƒ¨ç½² &amp;ldquo;&lt;/a>ï¼‰ã€‚&lt;/p>
&lt;p>&lt;strong>ä¸»æµ eBPF&lt;/strong>&lt;/p>
&lt;p>&lt;a href="https://en.wikipedia.org/wiki/Berkeley_Packet_Filter">eBPF&lt;/a> å…è®¸ä½ åœ¨ä¸æ”¹å˜å†…æ ¸ä»£ç æˆ–åŠ è½½æ¨¡å—çš„æƒ…å†µä¸‹ï¼Œåœ¨ Linux å†…æ ¸ä¸­è¿è¡Œç¨‹åºï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ä¸€ç§æ²™ç®±æ‰©å±•æœºåˆ¶ã€‚eBPF å…è®¸ &lt;a href="https://ebpf.io/projects">æ–°ä¸€ä»£è½¯ä»¶&lt;/a> ä»æ”¹è¿›çš„ç½‘ç»œã€ç›‘æ§å’Œå®‰å…¨ç­‰å„ç§ä¸åŒçš„æ–¹å‘æ‰©å±• Linux å†…æ ¸çš„è¡Œä¸ºã€‚ä»å†å²ä¸Šçœ‹ï¼ŒeBPF çš„ç¼ºç‚¹æ˜¯å®ƒéœ€è¦ä¸€ä¸ªç°ä»£çš„å†…æ ¸ç‰ˆæœ¬æ¥åˆ©ç”¨å®ƒï¼Œåœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´é‡Œï¼Œè¿™å¯¹è®¸å¤šå…¬å¸æ¥è¯´éƒ½ä¸æ˜¯ä¸€ä¸ªç°å®çš„é€‰æ‹©ã€‚ç„¶è€Œï¼Œäº‹æƒ…æ­£åœ¨å‘ç”Ÿå˜åŒ–ï¼Œç”šè‡³æ–°ç‰ˆæœ¬çš„ RHEL ç»ˆäºæ”¯æŒ eBPFï¼Œæ‰€ä»¥ä½ ä¼šçœ‹åˆ°æ›´å¤šçš„é¡¹ç›®åˆ©ç”¨å…¶ [ä¼˜åŠ¿]ï¼ˆhttps://sysdig.com/blog/sysdig-and-falco-now-powered-by-ebpf/ï¼‰ã€‚å¦‚æœä½ çœ‹è¿‡ Sysdig æœ€æ–°çš„ &lt;a href="https://sysdig.com/blog/sysdig-2021-container-security-usage-report/">å®¹å™¨æŠ¥å‘Š&lt;/a>ï¼Œä½ ä¼šå‘ç° Falco çš„é‡‡ç”¨ç‡æœ€è¿‘åœ¨ä¸Šå‡ï¼Œè™½ç„¶ Sysdig çš„æŠ¥å‘Šå¯èƒ½æœ‰ç‚¹åé¢‡ï¼Œä½†å®ƒåæ˜ åœ¨ç”Ÿäº§ä½¿ç”¨ä¸Šã€‚æ‰€ä»¥è¯·ç»§ç»­å…³æ³¨ï¼Œå¹¶æœŸå¾…æœªæ¥æ›´å¤šåŸºäº eBPF çš„é¡¹ç›®ã€‚&lt;/p>
&lt;p>&lt;strong>æœ€åï¼Œç¥å¤§å®¶ 2021 å¹´å¿«ä¹ï¼&lt;/strong>&lt;/p>
&lt;p>æˆ‘è¿˜æœ‰ä¸€äº›é¢„æµ‹å’Œè¶‹åŠ¿è¦åˆ†äº«ï¼Œå°¤å…¶æ˜¯å›´ç»•ç»ˆç«¯ç”¨æˆ·é©±åŠ¨çš„å¼€æºã€æœåŠ¡ç½‘æ ¼æ‹†è§£/æ ‡å‡†åŒ–ã€Prometheus+OTelã€ä¿éšœè½¯ä»¶ä¾›åº”é“¾å®‰å…¨çš„ KYC ç­‰ç­‰ï¼Œä½†æˆ‘ä¼šæŠŠè¿™äº›ç•™åˆ°æ›´è¯¦ç»†çš„æ–‡ç« ä¸­å»ï¼Œ9 ä¸ªé¢„æµ‹è¶³ä»¥å¼€å¯æ–°çš„ä¸€å¹´ï¼æ€»ä¹‹ï¼Œæ„Ÿè°¢å¤§å®¶çš„é˜…è¯»ï¼Œå¸Œæœ›åœ¨ 2021 å¹´ 5 æœˆçš„ &lt;a href="https://events.linuxfoundation.org/kubecon-cloudnativecon-europe/">KubeCon+CloudNativeCon EU&lt;/a> ä¸Šä¸å¤§å®¶è§é¢ï¼ŒæŠ¥åå·²å¼€å§‹ï¼&lt;/p></description></item><item><title>ã€è¯‘ã€‘åº”ç”¨æ¶æ„ï¼šä¸ºä»€ä¹ˆè¦éšç€å¸‚åœºæ¼”è¿›</title><link>https://atbug.com/translation-application-architecture-why-it-should-evolve-with-the-market/</link><pubDate>Sun, 17 Jan 2021 21:37:23 +0800</pubDate><guid>https://atbug.com/translation-application-architecture-why-it-should-evolve-with-the-market/</guid><description>
&lt;p>æœ¬æ–‡è¯‘è‡ª &lt;a href="https://www.cncf.io/blog/2021/01/07/application-architecture-why-it-should-evolve-with-the-market/">Application architecture: why it should evolve with the market&lt;/a>
æœ€åˆç”±Mia Platformå›¢é˜Ÿå‘å¸ƒåœ¨&lt;a href="https://blog.mia-platform.eu/en/application-architecture-why-it-should-evolve-with-the-market">Mia Platformçš„åšå®¢&lt;/a>ä¸Š&lt;/p>
&lt;p>å¦‚ä»Šï¼ŒIT æŒ‘æˆ˜åœ¨äºé€šè¿‡æœ‰æ•ˆé€‰æ‹©åº”ç”¨æ¶æ„æ¥é€‚åº”å¸‚åœºå’Œä¸šåŠ¡éœ€æ±‚çš„å‘å±•ã€‚ä¸ºäº†æ»¡è¶³ä¸šåŠ¡å’Œå®¢æˆ·çš„éœ€æ±‚ï¼ŒIT éƒ¨é—¨åº”èƒ½å¤Ÿå¯¹æŠ€æœ¯å’Œ&lt;strong>æ–¹æ³•&lt;/strong>é‡‡å–è¡ŒåŠ¨ä»¥ç¡®ä¿è½¯ä»¶å…·æœ‰çµæ´»æ€§ï¼Œå¹¶å®ç°äº§å“å’ŒæœåŠ¡çš„æŒç»­åˆ›æ–°æµç¨‹ï¼Œä»è€Œåšå‡ºæ›´å¿«çš„ååº” ã€‚&lt;/p>
&lt;p>å½“ç„¶ï¼Œè¿‡å»çš„å•ä½“åº”ç”¨ç¨‹åºå’Œåˆšæ€§åŸºç¡€è®¾æ–½æ— æ³•åšåˆ°è¿™ä¸€ç‚¹ã€‚ç›¸åï¼Œå®ƒå¯ä»¥é€šè¿‡&lt;strong>ä¸ºæ¼”åŒ–è€Œè®¾è®¡çš„æ¶æ„&lt;/strong>æ¥å®ç°ï¼Œè¯¥æ¶æ„åœ¨éœ€è¦æ—¶æ˜“äºæ›´æ–°å’Œé‡æ„ã€‚å®¹å™¨åŒ–å®è·µçš„å¹¿æ³›åº”ç”¨ï¼ˆæ ¹æ® &lt;a href="https://www.gartner.com/en/newsroom/press-releases/2020-06-25-gartner-forecasts-strong-revenue-growth-for-global-co">Gartner&lt;/a>ï¼Œåˆ°2022å¹´ï¼Œå¤§å…¬å¸çš„å°±ä¸šäººæ•°å°†ä»ç›®å‰çš„ 30ï¼… å¢é•¿åˆ° 75ï¼…ï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹é‡‡ç”¨äº‘åŸç”Ÿæ–¹æ³•é‡æ–°è®¾è®¡å¾®æœåŠ¡åº”ç”¨æ˜¯æˆåŠŸçš„å…³é”®ã€‚&lt;/p>
&lt;h2 id="å¦‚ä½•æ„å»ºä¸æ–­å‘å±•çš„åº”ç”¨æ¶æ„">å¦‚ä½•æ„å»ºä¸æ–­å‘å±•çš„åº”ç”¨æ¶æ„&lt;/h2>
&lt;p>æµ·å¤–ä¸“å®¶ç§°å®ƒä»¬ä¸º&lt;strong>å¯æ¼”è¿›çš„æ¶æ„&lt;/strong>ï¼Œä»¥å°†å®ƒä»¬ä¸å½“ä»Šé˜»ç¢æˆ–æ— åŠ©äºæ”¹å˜çš„ä¼ ç»Ÿæ¶æ„åŒºåˆ†å¼€ã€‚åº”ç”¨æ¶æ„åŸºäº&lt;a href="https://blog.mia-platform.eu/it/architettura-a-microservizi-i-vantaggi-per-il-business-e-per-lit">å¾®æœåŠ¡æ¶æ„é£æ ¼&lt;/a> ï¼Œè¢«è®¾è®¡æˆåœ¨ç°ä»£è™šæ‹ŸåŒ– IT å’Œäº‘ç¯å¢ƒä¸­å‘æŒ¥æœ€ä½³æ€§èƒ½ã€‚&lt;/p>
&lt;p>åŸºæœ¬æ€æƒ³æ˜¯&lt;strong>åˆ›å»ºå¯ä»¥è½»æ¾â€œåˆ†è§£â€çš„åº”ç”¨ç¨‹åºï¼Œå…¶ç»„ä»¶å¯ä»¥åœ¨å…¶ä»–ä¸Šä¸‹æ–‡æˆ–ç»„åˆä¸­é‡ç”¨&lt;/strong>ï¼Œå¦‚ Lego ç³»åˆ—ã€‚å¼€å‘ä¸€ç³»åˆ—å¾®æœåŠ¡ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½ç”¨äºæ‰§è¡Œå•ä¸ªä¸šåŠ¡åŠŸèƒ½ï¼ˆæ ¹æ®â€œå•ä¸€èŒè´£åŸåˆ™â€ï¼‰ï¼Œå¯ä»¥åœ¨åº”ç”¨æœ¬èº«çš„å¼€å‘å’Œæ¼”è¿›ä¸­è·å¾—ç›¸å½“å¤§çš„çµæ´»æ€§ã€‚å®é™…ä¸Šï¼Œå¯ä»¥æ ¹æ®æ”¯æŒåŠŸèƒ½çš„ç‰¹å®šç”Ÿå‘½å‘¨æœŸç‹¬ç«‹å¼€å‘ã€æ›´æ–°å’Œæµ‹è¯•æœåŠ¡ã€‚&lt;/p>
&lt;p>æ­¤å¤–ï¼Œè°ˆåˆ°éƒ¨ç½²ï¼Œå¾®æœåŠ¡åº”ç”¨çš„æ¶æ„å…·æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ï¼šå¯ä»¥æ ¹æ®éœ€è¦åœ¨å†…éƒ¨æˆ–äº‘ä¸­é€šè¿‡ä½¿ç”¨å¯ç”¨èµ„æºæ¥æ‰©å±•å•ä¸ªå¾®æœåŠ¡ã€‚&lt;/p>
&lt;p>ä¸ºæ­¤ï¼Œå¾®æœåŠ¡åº”ç”¨è·å¾—&lt;strong>åŸºäºå®¹å™¨çš„åŸºç¡€è®¾æ–½&lt;/strong>çš„æ”¯æŒï¼Œè¯¥åŸºç¡€è®¾æ–½é€šè¿‡ä¸šåŠ¡ç¼–æ’ç³»ç»Ÿï¼ˆé€šå¸¸ä¸º &lt;a href="https://blog.mia-platform.eu/en/kubernetes-why-it-is-so-popular-and-who-should-use-it">Kubernetes&lt;/a>ï¼‰è¿›è¡Œç®¡ç†ï¼Œè¯¥æµç¨‹å¯ä»¥è‡ªåŠ¨åŒ–å¹¶ä¿ƒè¿›å…¬å¸ç³»ç»Ÿä¹‹é—´ä»¥åŠä»è¿™äº›ç³»ç»Ÿåˆ°äº‘æä¾›å•†æœåŠ¡çš„è½¯ä»¶ä½œä¸šçš„è¿ç§»ã€‚&lt;/p>
&lt;h2 id="éšç€ä¸šåŠ¡å‘å±•çš„åº”ç”¨æ¶æ„çš„ä¼˜åŠ¿">éšç€ä¸šåŠ¡å‘å±•çš„åº”ç”¨æ¶æ„çš„ä¼˜åŠ¿&lt;/h2>
&lt;p>åŸºäºå¾®æœåŠ¡çš„åº”ç”¨æ¶æ„åœ¨å¼€å‘å’Œéƒ¨ç½²æ–¹é¢å…·æœ‰æ›´å¤§çš„è‡ªæ²»æƒã€‚å¦‚æˆ‘ä»¬æ‰€è§ï¼Œå¾®æœåŠ¡å¯ä»¥åœ¨å…¶ä»–åº”ç”¨ç¨‹åºä¸­å•ç‹¬å®ç°ã€â€œåˆ†è§£â€ã€æ›´æ–°å’Œé‡ç”¨ã€‚å› æ­¤ï¼Œé€šè¿‡äº§å“æˆ–å®¢æˆ·éœ€æ±‚çš„æ¼”å˜ï¼Œå®ƒæœ‰é™ä½&lt;strong>å‡å°‘å¸‚åœºæ‰€éœ€çš„æ¯ä¸ªæ–°äº§å“çš„è®¾è®¡/å¼€å‘æ—¶é—´å’Œæˆæœ¬&lt;/strong>ã€‚&lt;/p>
&lt;p>æ­¤å¤–ï¼Œé€šè¿‡ä½¿ç”¨å®¹å™¨åŒ–å®è·µï¼Œå¯ä»¥ç®€åŒ–åœ¨æœ¬åœ°ã€äº‘ã€å¤šäº‘æˆ–æ··åˆç¯å¢ƒçš„ä»»ä½•ç¯å¢ƒä¸­åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ï¼Œä»è€Œä¼˜åŒ–æˆæœ¬ã€‚&lt;/p>
&lt;p>åœ¨å¾®æœåŠ¡æ¶æ„é£æ ¼çš„ä¼˜ç‚¹ä¸­ï¼Œæˆ‘ä»¬è¿˜å‘ç°æœ‰å¯èƒ½åœ¨å„ç§æœåŠ¡ä¹‹é—´çš„å¯¹è¯åŠå…¶å¥åº·çŠ¶å†µä¸Šè·å¾—æ›´å¤§çš„&lt;strong>é€æ˜åº¦&lt;/strong>ï¼šæ›´å¥½çš„å¯è§‚å¯Ÿæ€§æ„å‘³ç€å¯ä»¥è½»æ¾è§£å†³å¤æ‚åº”ç”¨çš„é—®é¢˜ã€‚å®é™…ä¸Šï¼Œç®¡ç†å‘˜å¯ä»¥&lt;strong>æ›´å¿«åœ°å®šä½å’Œè§£å†³æ€§èƒ½å’Œå®‰å…¨æ€§é—®é¢˜&lt;/strong>ï¼Œåœ¨è¿ç»´å’Œä»£ç å±‚é¢å®æ–½æªæ–½ï¼Œä»è€Œä½¿å“åº”é€Ÿåº¦ä¸å˜æ›´çš„é•¿æœŸæœ‰æ•ˆæ€§ä¿æŒä¸€è‡´ã€‚&lt;/p>
&lt;p>é€šè¿‡é‡‡ç”¨å¾®æœåŠ¡ä»¥åŠæ–°çš„å¼€å‘å’Œéƒ¨ç½²æ–¹æ³•ï¼Œå¯ä»¥åˆ›å»ºèƒ½å¤Ÿéšæ—¶é—´å‘å±•çš„åº”ç”¨æ¶æ„ã€‚é™¤äº† IT å›¢é˜Ÿå¿…é¡»æŒæ¡çš„æ–°æŠ€èƒ½å¤–ï¼Œè¿˜å¿…é¡»å¯¹å…¬å¸çš„æœªæ¥æœ‰ä¸€ä¸ªæ¸…æ™°çš„æ„¿æ™¯ï¼Œä»¥ç¡®ä¿æ‰€æä¾›çš„æœåŠ¡å¯¹ä¸šåŠ¡å‘å±•æœ‰ç”¨ã€‚&lt;/p>
&lt;h2 id="åˆ›å»ºå¯æ¼”è¿›çš„åº”ç”¨æ¶æ„">åˆ›å»ºå¯æ¼”è¿›çš„åº”ç”¨æ¶æ„&lt;/h2>
&lt;p>æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†åŸºäºå¾®æœåŠ¡çš„ç°ä»£åº”ç”¨æ¶æ„å¦‚ä½•ä¿è¯è½¯ä»¶çš„çµæ´»æ€§ï¼Œå¹¶å…è®¸ä½ åˆ©ç”¨æœ¬åœ°å’ŒæŒ‰éœ€ä½¿ç”¨çš„æ‰€æœ‰èµ„æºï¼Œåœ¨å¯ä»¥&lt;strong>æ–¹ä¾¿åœ°&lt;/strong>è·å¾—æ‰€éœ€æ€§èƒ½ã€é™ä½æˆæœ¬æˆ–ä¿æŠ¤æ•°æ®çš„&lt;strong>ä½ç½®åˆ†é…ä½œä¸š&lt;/strong>ã€‚&lt;/p>
&lt;p>ä¸ºäº†ä½¿ä¹‹æˆä¸ºå¯èƒ½ï¼Œæœ‰å¿…è¦åœ¨äº‘å’Œæ··åˆç¯å¢ƒä¸­åˆ›å»ºå’Œç®¡ç†è™šæ‹ŸåŒ–çš„ IT ç¯å¢ƒï¼Œå¹¶&lt;strong>é‡‡ç”¨æœ€åˆé€‚çš„æ–¹æ³•å’Œç­–ç•¥&lt;/strong>ã€‚ä¾‹å¦‚ï¼Œåœ¨ç”¨äºå°†å¼€å‘å’Œè¿ç»´æ´»åŠ¨é“¾æ¥åœ¨ä¸€èµ·çš„DevOpsé¢†åŸŸä¸­ï¼Œ&lt;strong>æŒç»­é›†æˆ/æŒç»­äº¤ä»˜&lt;/strong>ï¼ˆCI / CDï¼‰ç­–ç•¥çš„æ–¹æ³•å­¦æ”¯æŒå¯å¸®åŠ©æé«˜æ›´æ–°é€Ÿåº¦å’Œåº”ç”¨è½¯ä»¶çš„è´¨é‡ã€‚&lt;/p>
&lt;p>æ­¤å¤–ï¼Œå¾®æœåŠ¡å¯ä¿ƒè¿›å¯¹&lt;a href="https://blog.mia-platform.eu/it/da-monolite-a-microservizi-come-far-evolvere-unapplicazione-legacy">é—ç•™åº”ç”¨ç¨‹åºçš„é›†æˆ&lt;/a>ï¼Œä»è€Œä½¿å…¬å¸æ›´åŠ æ•æ·ï¼Œå¹¶åˆ©ç”¨å¸‚åœºä¸Šæœ€&lt;strong>å…ˆè¿›çš„è§£å†³æ–¹æ¡ˆ&lt;/strong>ã€‚é™¤äº†éœ€è¦æ–°çš„æŠ€æœ¯å’Œå·¥ä½œæ–¹æ³•å¤–ï¼Œç°åœ¨è¿˜éœ€è¦å¯æ¼”è¿›çš„åº”ç”¨æ¶æ„æ¥&lt;strong>æ”¯æŒæ•°å­—åŒ–è½¬å‹æ‰€å†³å®šçš„ä¸æ–­å˜åŒ–çš„éœ€æ±‚&lt;/strong>ã€‚&lt;/p></description></item><item><title>Envoy listener filter times out é—®é¢˜</title><link>https://atbug.com/envoy-listener-filter-times-out/</link><pubDate>Wed, 09 Dec 2020 20:00:00 +0800</pubDate><guid>https://atbug.com/envoy-listener-filter-times-out/</guid><description>
&lt;p>æœ€è¿‘åœ¨çœ‹ openservicemesh ç›¸å…³å†…å®¹ï¼Œè¿™å‘¨æ›´æ–°äº† main åˆ†æ”¯çš„ä»£ç ä¹‹åã€‚å‘ç°åŸæœ¬ v0.5.0 æ—¶å¯ä»¥æ­£å¸¸ä»£ç†çš„ mysql æµé‡ï¼Œåœ¨æ–°çš„ commit ä¸­æ— æ³•ä»£ç†äº†ã€‚&lt;/p>
&lt;p>å¼€å¯ envoy çš„ filter debug æ—¥å¿—åå‘ç°å‡ºç°äº†è¶…æ—¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">[2020-12-09 08:54:42.285][15][debug][filter] [source/extensions/filters/listener/original_dst/original_dst.cc:18] original_dst: New connection accepted
[2020-12-09 08:54:42.285][15][debug][filter] [source/extensions/filters/listener/http_inspector/http_inspector.cc:38] http inspector: new connection accepted
[2020-12-09 08:54:42.285][15][trace][filter] [source/extensions/filters/listener/http_inspector/http_inspector.cc:105] http inspector: recv: 0
[2020-12-09 08:54:57.286][15][debug][conn_handler] [source/server/connection_handler_impl.cc:273] listener filter times out after 15000 ms
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è´´ä¸€ä¸‹ outbound listener çš„é…ç½®ç‰‡æ®µ:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;@type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;type.googleapis.com/envoy.admin.v3.ListenersConfigDump&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;version_info&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;dynamic_listeners&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[{&lt;/span>
&lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;outbound_listener&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;active_state&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;version_info&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;listener&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;@type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;type.googleapis.com/envoy.config.listener.v3.Listener&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;outbound_listener&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;address&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;socket_address&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;address&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;0.0.0.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;port_value&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">15001&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nt">&amp;#34;filter_chains&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="err">//çœç•¥å…¶ä»–&lt;/span> &lt;span class="err">filter&lt;/span> &lt;span class="err">chain&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;filters&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[{&lt;/span>
&lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;envoy.filters.network.tcp_proxy&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;typed_config&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;@type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;stat_prefix&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;passthrough-outbound&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;cluster&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;passthrough-outbound&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}],&lt;/span>
&lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;outbound-egress-filter-chain&amp;#34;&lt;/span>
&lt;span class="p">}],&lt;/span>
&lt;span class="nt">&amp;#34;listener_filters&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[{&lt;/span>
&lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;envoy.filters.listener.original_dst&amp;#34;&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;envoy.filters.listener.http_inspector&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">],&lt;/span>
&lt;span class="nt">&amp;#34;traffic_direction&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;OUTBOUND&amp;#34;&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nt">&amp;#34;last_updated&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2020-12-08T10:07:41.191Z&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ†æ">åˆ†æ&lt;/h3>
&lt;p>Envoy é‚£è¾¹çœ‹åˆ°äº†æœ‰ä¸ª &lt;a href="https://github.com/envoyproxy/envoy/issues/7195">issue&lt;/a>ï¼Œä¸ºæ­¤å¢åŠ äº† timeout çš„è®¾ç½®ï¼Œé»˜è®¤ 15sã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>listener_filters_timeout&lt;/code>ï¼šé»˜è®¤ 15sã€‚ç­‰å¾… listener filter å®Œæˆçš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœè®¾ç½®ä¸º 0ï¼Œåˆ™ä¸è¶…æ—¶ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®ä¸‹é¢çš„é…ç½®ä¸º&lt;code>true&lt;/code>ï¼Œåˆ™ä¼šç›´æ¥å…³é—­è¿æ¥ã€‚&lt;/li>
&lt;li>&lt;code>continue_on_listener_filters_timeout&lt;/code>ï¼šé»˜è®¤ &lt;code>false&lt;/code>ã€‚è¶…æ—¶æ—¶æ˜¯å¦ä½¿ç”¨é»˜è®¤çš„ filter_chain åˆ›å»ºè¿æ¥ã€‚&lt;/li>
&lt;/ul>
&lt;p>å¯¹æ¯”ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä¸åŒä¹‹å¤„æ˜¯åœ¨ filter ä¸­å¤šäº† &lt;code>envoy.filters.listener.http_inspector&lt;/code>ã€‚ä¸€ä¸ª http_inspector ä¸ºä½• hold ä½æ•´ä¸ª followã€‚&lt;/p>
&lt;p>æ­£å¥½æ˜¨å¤©&lt;a href="https://mp.weixin.qq.com/s/pmDw779cfj8SXjqAni3mCA">é…ç½®äº† Clion ç”¨äºæºç é˜…è¯»&lt;/a>ï¼Œçœ‹ä¸‹ &lt;code>http_inspector&lt;/code> çš„æºç ï¼š&lt;/p>
&lt;p>åœ¨&lt;code>http_inspector.cc&lt;/code>çš„&lt;code>onRead&lt;/code>æ–¹æ³•ï¼Œåœ¨åš&lt;code>MSG_PEEK&lt;/code>æ˜¯é“å®šè¯»ä¸åˆ°æ•°æ®çš„ï¼Œè§ä¸Šé¢çš„æ—¥å¿—ï¼ŒåŒæ—¶æŸ¥çœ‹ stats &lt;code>http_inspector.read_error: 0&lt;/code>ã€‚å¯è§ï¼Œè¿”å›äº†&lt;code>ParseState::Continue&lt;/code>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>Api::IoError::IoErrorCode::Again&lt;/code>çš„æ„æ€æ˜¯ï¼š&lt;code>No data available right now, try again later.&lt;/code>
å¯¹äº&lt;code>ParseState::Continue&lt;/code>çš„è§£é‡Šæ˜¯ï¼š&lt;code>Parser expects more data.&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/12/09/screenshot-20201209-at-165537.png" alt="screenshot 2020-12-09 at 16.55.37">&lt;/p>
&lt;p>ç”±äº&lt;code>onRead&lt;/code>è¿”å›äº†&lt;code>ParseState::Continue&lt;/code>ï¼Œ&lt;code>onAccept&lt;/code>æ–¹æ³•ä¼šè¿”å› &lt;code>Network::FilterStatus::StopIteration&lt;/code>ã€‚è¿”å›ä¹‹å‰ä¼šæ³¨å†Œä¸ªé’ˆå¯¹&lt;code>Event::FileReadyType::Read | Event::FileReadyType::Closed&lt;/code> çš„ callbackï¼Œç”¨äºè¯»å–åˆ°æ•°æ®æˆ–è€…å…³é—­æ–‡ä»¶æ—¶è¿›è¡Œå›è°ƒå¤„ç†ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>Network::FilterStatus::StopIteration&lt;/code>ï¼š&lt;code>Stop executing further filters.&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/12/09/screenshot-20201209-at-165220.png" alt="screenshot 2020-12-09 at 16.52.20">&lt;/p>
&lt;p>&lt;code>source/server/connection_handler_impl.cc&lt;/code> çš„ &lt;code>continueFilterChain&lt;/code>æ–¹æ³•ï¼Œçœ‹æ³¨é‡Šï¼š&lt;code>Blocking at the filter but no error&lt;/code>ã€‚ç­‰å¾…ä¸Šé¢çš„ callback è¢«è°ƒç”¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/12/09/screenshot-20201209-at-171328.png" alt="screenshot 2020-12-09 at 17.13.28">&lt;/p>
&lt;p>ç”±äºå‰é¢ç›´æ¥ä»&lt;code>for&lt;/code> loop ä¸­è·³å‡ºï¼Œè¿­ä»£å¹¶æ²¡æœ‰æ‰§è¡Œåˆ°&lt;code>end&lt;/code>ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªè¶…æ—¶çš„ timerã€‚
&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/12/09/screenshot-20201209-at-172017.png" alt="screenshot 2020-12-09 at 17.20.17">&lt;/p>
&lt;p>å‚è€ƒï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://mp.weixin.qq.com/s/pmDw779cfj8SXjqAni3mCA">é…ç½® Clion é˜…è¯» envoy æºç &lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/envoyproxy/envoy/issues/7195">allow fallback to default filter chain when listener filters timeout&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>ä½¿ç”¨ cLion é˜…è¯» envoy æºç </title><link>https://atbug.com/read-envoy-source-code-in-clion/</link><pubDate>Tue, 08 Dec 2020 20:53:39 +0800</pubDate><guid>https://atbug.com/read-envoy-source-code-in-clion/</guid><description>
&lt;p>è™½ç„¶ä¸å†™ C++ï¼Œä½†æ˜¯çœ‹ç‚¹ä»£ç è¿˜æ˜¯èƒ½çœ‹æ‡‚ã€‚Envoy çš„åŠŸèƒ½é…ç½®å¤æ‚ï¼Œæœ‰æ—¶å€™å¤„ç†é—®é¢˜è¿˜æ˜¯éœ€è¦çœ‹ä¸‹æºç çš„ã€‚&lt;/p>
&lt;p>Vim æˆ–è€… Code å°±ç®—äº†ï¼Œæˆ‘åªæ˜¯é˜…è¯»æºç éœ€è¦å…³è”è·³è½¬å°±è¡Œã€‚åœ¨ Clion ä¸­ï¼Œä»£ç çš„å…³è”è·³è½¬éœ€è¦ä¸€ä¸ªCMakeLists.txt æ–‡ä»¶ã€‚&lt;/p>
&lt;p>æˆ‘å°†ç”Ÿæˆçš„å†…å®¹æŒ‚åœ¨äº† &lt;a href="https://gist.github.com/addozhang/82b172a4276acd073329e5deab272f18">gist&lt;/a> ä¸Šäº†ï¼Œä¸æƒ³èŠ±è´¹æ—¶é—´ç”Ÿæˆçš„å¯ä»¥ç›´æ¥å¤åˆ¶ã€‚&lt;/p>
&lt;h2 id="å‡†å¤‡ç¯å¢ƒ">å‡†å¤‡ç¯å¢ƒ&lt;/h2>
&lt;h3 id="1-å®‰è£…ä¾èµ–çš„å·¥å…·">1. å®‰è£…ä¾èµ–çš„å·¥å…·&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">brew install coreutils wget cmake libtool go automake ninja clang-format
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="2-bazel">2. bazel&lt;/h3>
&lt;p>ä½¿ç”¨ homebrew è¿›è¡Œå®‰è£…ï¼š &lt;code>brew install bazel&lt;/code> å³å¯&lt;/p>
&lt;p>å®‰è£…é—®è¿è¡Œç¼–è¯‘æµ‹è¯•ä¸‹ï¼š&lt;code>bazel build //source/exe:envoy-static&lt;/code>ï¼Œæç¤ºç‰ˆæœ¬å¤ªé«˜ã€‚&lt;/p>
&lt;p>ç°åœ¨ homebrew å®‰è£…çš„ç‰ˆæœ¬æ˜¯&lt;code>3.7.1&lt;/code>ï¼Œè€Œ envoy éœ€è¦&lt;code>3.4.1&lt;/code>ã€‚&lt;/p>
&lt;p>æŒ‰ç…§æç¤ºä¸‹è½½&lt;code>3.4.1&lt;/code>çš„ç‰ˆæœ¬ï¼š&lt;code>cd &amp;quot;/usr/local/Cellar/bazel/3.7.1/libexec/bin&amp;quot; &amp;amp;&amp;amp; curl -fLO https://releases.bazel.build/3.4.1/release/bazel-3.4.1-darwin-x86_64 &amp;amp;&amp;amp; chmod +x bazel-3.4.1-darwin-x86_64&lt;/code>ï¼Œç„¶å &lt;em>è¿›åˆ°ç›®å½•é‡Œè¿›è¡Œä¸‹æ›¿æ¢&lt;/em> ã€‚&lt;/p>
&lt;p>&lt;strong>æ³¨æ„ï¼šç¼–è¯‘è€—æ—¶å¾ˆé•¿ï¼Œåƒ cpuã€‚&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">INFO: Elapsed time: 1844.351s, Critical Path: 336.48s
INFO: &lt;span class="m">4918&lt;/span> processes: &lt;span class="m">4918&lt;/span> darwin-sandbox.
INFO: Build completed successfully, &lt;span class="m">6088&lt;/span> total actions
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/12/08/16074319425868.jpg" alt="">&lt;/p>
&lt;h3 id="3-ç”Ÿæˆcmakeliststxtæ–‡ä»¶">3. ç”Ÿæˆ&lt;code>CMakeLists.txt&lt;/code>æ–‡ä»¶&lt;/h3>
&lt;p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢éœ€è¦å®‰è£…ç¼–è¯‘å·¥å…·äº†ï¼Œclone &lt;code>git@github.com:lizan/bazel-cmakelists.git&lt;/code> è¿™ä¸ªä»“åº“ã€‚&lt;/p>
&lt;p>åªè¦&lt;code>bazel&lt;/code>ç¼–è¯‘èƒ½é€šè¿‡ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å…·ç”Ÿæˆæ–‡ä»¶äº†ã€‚&lt;/p>
&lt;p>åœ¨ envoy æºç æ ¹ç›®å½•æ‰§è¡Œå‘½ä»¤ï¼š&lt;code>/path_to_bazel-cmakelists/bazel-cmakelists //source/exe:envoy-static&lt;/code>ã€‚&lt;/p>
&lt;p>æ‰§è¡Œç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">CMakeLists.txt generated in following directory:
/Users/addo/Workspaces/github_w/envoyproxy/envoy
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="4-clion-åˆ·æ–°">4. Clion åˆ·æ–°&lt;/h3>
&lt;p>Clion æ£€æµ‹åˆ° CMakeLists.txt ä¹‹åå°±ä¼šè‡ªåŠ¨åˆ·æ–° workspaceï¼Œè‡ªæ­¤å°±å¯ä»¥åœ¨ Clion ä¸­æ„‰å¿«çš„é˜…è¯»æºç äº†ã€‚&lt;/p></description></item><item><title>Kubernetes æºç è§£æ - Informer</title><link>https://atbug.com/kubernetes-source-code-how-informer-work/</link><pubDate>Sun, 16 Aug 2020 23:32:38 +0800</pubDate><guid>https://atbug.com/kubernetes-source-code-how-informer-work/</guid><description>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/wY8ZevIHIH7CD-fWGZecPQ">ä¸Šç¯‡&lt;/a>æ‰’äº† HPA çš„æºç ï¼Œä½†æ˜¯æ²¡æ·±å…¥ç»†èŠ‚ï¼Œä»Šå¤©å¾€ç»†èŠ‚æ·±å…¥ã€‚&lt;/p>
&lt;p>å¼€å±€å…ˆç¥­å‡ºä¸€å¼ å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/08/16/15975802542217.png" alt="">&lt;/p>
&lt;h2 id="ä¸ºä»€ä¹ˆè¦æœ‰-informer">ä¸ºä»€ä¹ˆè¦æœ‰ Informerï¼Ÿ&lt;/h2>
&lt;p>Kubernetes ä¸­çš„æŒä¹…åŒ–æ•°æ®ä¿å­˜åœ¨ etcdä¸­ï¼Œå„ä¸ªç»„ä»¶å¹¶ä¸ä¼šç›´æ¥è®¿é—® etcdï¼Œè€Œæ˜¯é€šè¿‡ api-serveræš´éœ²çš„ RESTful æ¥å£å¯¹é›†ç¾¤è¿›è¡Œè®¿é—®å’Œæ§åˆ¶ã€‚&lt;/p>
&lt;p>èµ„æºçš„æ§åˆ¶å™¨ï¼ˆå›¾ä¸­å³ä¾§ç°è‰²çš„éƒ¨åˆ†ï¼‰è¯»å–æ•°æ®ä¹Ÿå¹¶ä¸ä¼šç›´æ¥ä» api-server ä¸­è·å–èµ„æºä¿¡æ¯ï¼ˆè¿™æ ·ä¼šå¢åŠ  api-server çš„å‹åŠ›ï¼‰ï¼Œè€Œæ˜¯ä»å…¶â€œæœ¬åœ°ç¼“å­˜â€ä¸­è¯»å–ã€‚è¿™ä¸ªâ€œæœ¬åœ°ç¼“å­˜â€åªæ˜¯è¡¨è±¡çš„å­˜åœ¨ï¼ŒåŠ ä¸Šç¼“å­˜çš„åŒæ­¥é€»è¾‘å°±æ˜¯ä»Šå¤©è¦æ˜¯è¯´çš„&lt;code>Informer&lt;/code>ï¼ˆç°è‰²åŒºåŸŸä¸­çš„ç¬¬ä¸€ä¸ªè“è‰²å—ï¼‰æ‰€æä¾›çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ° Informer çš„å‡ ä¸ªç»„ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>Reflectorï¼šä¸ &lt;code>api-server&lt;/code>äº¤äº’ï¼Œç›‘å¬èµ„æºçš„å˜æ›´ã€‚&lt;/li>
&lt;li>Delta FIFO Queueï¼šå¢é‡çš„ FIFO é˜Ÿåˆ—ï¼Œä¿å­˜ Reflector ç›‘å¬åˆ°çš„èµ„æºå˜æ›´ï¼ˆç®€å•çš„å°è£…ï¼‰ã€‚&lt;/li>
&lt;li>Indexerï¼šInformer çš„æœ¬åœ°ç¼“å­˜ï¼ŒFIFO é˜Ÿåˆ—ä¸­çš„æ•°æ®æ ¹æ®ä¸åŒçš„å˜æ›´ç±»å‹ï¼Œåœ¨è¯¥ç¼“å­˜ä¸­è¿›è¡Œæ“ä½œã€‚
&lt;ul>
&lt;li>Local Storeï¼š&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/wY8ZevIHIH7CD-fWGZecPQ">ä¸Šç¯‡&lt;/a> æåˆ°äº†æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©çš„æ§åˆ¶å™¨&lt;code>HorizontalController&lt;/code>ï¼Œå…¶æ„é€ æ–¹æ³•å°±éœ€è¦æä¾› &lt;code>Informer&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//pkg/controller/podautoscaler/horizontal.go
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalController&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">scaleNamespacer&lt;/span> &lt;span class="nx">scaleclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ScalesGetter&lt;/span>
&lt;span class="nx">hpaNamespacer&lt;/span> &lt;span class="nx">autoscalingclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalersGetter&lt;/span>
&lt;span class="nx">mapper&lt;/span> &lt;span class="nx">apimeta&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RESTMapper&lt;/span>
&lt;span class="nx">replicaCalc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ReplicaCalculator&lt;/span>
&lt;span class="nx">eventRecorder&lt;/span> &lt;span class="nx">record&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventRecorder&lt;/span>
&lt;span class="nx">downscaleStabilisationWindow&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>
&lt;span class="nx">hpaLister&lt;/span> &lt;span class="nx">autoscalinglisters&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerLister&lt;/span>
&lt;span class="nx">hpaListerSynced&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InformerSynced&lt;/span>
&lt;span class="nx">podLister&lt;/span> &lt;span class="nx">corelisters&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodLister&lt;/span>
&lt;span class="nx">podListerSynced&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InformerSynced&lt;/span>
&lt;span class="nx">queue&lt;/span> &lt;span class="nx">workqueue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RateLimitingInterface&lt;/span>
&lt;span class="nx">recommendations&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">][]&lt;/span>&lt;span class="nx">timestampedRecommendation&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewHorizontalController&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">evtNamespacer&lt;/span> &lt;span class="nx">v1core&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventsGetter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">scaleNamespacer&lt;/span> &lt;span class="nx">scaleclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ScalesGetter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">hpaNamespacer&lt;/span> &lt;span class="nx">autoscalingclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalersGetter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">mapper&lt;/span> &lt;span class="nx">apimeta&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RESTMapper&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">metricsClient&lt;/span> &lt;span class="nx">metricsclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MetricsClient&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="c1">//ä»HorizontalPodAutoscalerInformer è·å–hpa å®ä¾‹ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">hpaInformer&lt;/span> &lt;span class="nx">autoscalinginformers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerInformer&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="c1">//ä»PodInformer ä¸­è·å– pod ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">podInformer&lt;/span> &lt;span class="nx">coreinformers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PodInformer&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">resyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">downscaleStabilisationWindow&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">tolerance&lt;/span> &lt;span class="kt">float64&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">cpuInitializationPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">delayOfInitialReadinessStatus&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">......&lt;/span>
&lt;span class="nx">hpaInformer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Informer&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">AddEventHandlerWithResyncPeriod&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="c1">//æ·»åŠ äº‹ä»¶å¤„ç†å™¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResourceEventHandlerFuncs&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">AddFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">hpaController&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">enqueueHPA&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">UpdateFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">hpaController&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">updateHPA&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">DeleteFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">hpaController&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">deleteHPA&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="o">......&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerInformer&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Informer&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SharedIndexInformer&lt;/span>
&lt;span class="nf">Lister&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerLister&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>HorizontalPodAutoscalerInformer&lt;/code>çš„å®ä¾‹åŒ–æ–¹æ³•ä¸­å°±å‡ºç°äº†ä»Šå¤©çš„æ­£ä¸»&lt;code>cache.NewSharedIndexInformer()&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/informers/autoscaling/v1/horizontalpodautoscaler.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewFilteredHorizontalPodAutoscalerInformer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span> &lt;span class="nx">kubernetes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">namespace&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexers&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Indexers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tweakListOptions&lt;/span> &lt;span class="nx">internalinterfaces&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TweakListOptionsFunc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SharedIndexInformer&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewSharedIndexInformer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="c1">//ç”¨äº list å’Œ watch api-server ä¸­çš„èµ„æºã€‚æ¯”å¦‚ç”¨æ¥åˆ›å»º Reflector
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListWatch&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">ListFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListOptions&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">tweakListOptions&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">tweakListOptions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ä½¿ç”¨ HPA API è·å– HPAèµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AutoscalingV1&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">HorizontalPodAutoscalers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">namespace&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">List&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nx">WatchFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListOptions&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">watch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">tweakListOptions&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">tweakListOptions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ä½¿ç”¨ HPA API ç›‘æ§ HPAèµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AutoscalingV1&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">HorizontalPodAutoscalers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">namespace&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Watch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">autoscalingv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscaler&lt;/span>&lt;span class="p">{},&lt;/span>
&lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">indexers&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆå§‹åŒ–">åˆå§‹åŒ–&lt;/h2>
&lt;h3 id="informer">Informer&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/index.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Indexers&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">IndexFunc&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">IndexFunc&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">obj&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®ä¾‹åŒ– Indexers &lt;code>cache.Indexers{cache.NamespaceIndex: cache.MetaNamespaceIndexFunc}&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/shared_informer.go
&lt;/span>&lt;span class="c1">// ListerWatcher ç”¨äº list å’Œwatch api-server ä¸Šçš„èµ„æº
&lt;/span>&lt;span class="c1">//runtime.Objectè¦ç›‘æ§çš„èµ„æºçš„è¿è¡Œæ—¶å¯¹è±¡
&lt;/span>&lt;span class="c1">//time.DurationåŒæ­¥çš„é—´éš”æ—¶é—´
&lt;/span>&lt;span class="c1">//Indexers æä¾›ä¸åŒèµ„æºçš„ç´¢å¼•æ•°æ®çš„ä¿¡æ¯æŸ¥è¯¢æ–¹æ³•ï¼Œå¦‚ namespace =&amp;gt; MetaNamespaceIndexFunc
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewSharedIndexInformer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lw&lt;/span> &lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">objType&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">defaultEventHandlerResyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexers&lt;/span> &lt;span class="nx">Indexers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">SharedIndexInformer&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">realClock&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RealClock&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">sharedIndexInformer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sharedIndexInformer&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">processor&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sharedProcessor&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">realClock&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="nx">indexer&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">NewIndexer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">DeletionHandlingMetaNamespaceKeyFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexers&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="c1">//åˆå§‹åŒ– Indexer
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">listerWatcher&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">lw&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">objectType&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">objType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">resyncCheckPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">defaultEventHandlerResyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">defaultEventHandlerResyncPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">defaultEventHandlerResyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">cacheMutationDetector&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">NewCacheMutationDetector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%T&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">objType&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="nx">clock&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">realClock&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">sharedIndexInformer&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="indexer">Indexer&lt;/h3>
&lt;p>&lt;code>Indexer&lt;/code>æä¾›äº†æœ¬åœ°ç¼“å­˜çš„å®ç°ï¼šè®¡ç®— key å’Œå¯¹æ•°æ®è¿›è¡Œæ§åˆ¶ï¼ˆé€šè¿‡è°ƒç”¨&lt;code>ThreadSafeStore&lt;/code>çš„æ¥å£ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Indexer&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Store&lt;/span>
&lt;span class="nf">Index&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexName&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">IndexKeys&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexedValue&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">ListIndexFuncValues&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexName&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="nf">ByIndex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexedValue&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">GetIndexers&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Indexers&lt;/span>
&lt;span class="nf">AddIndexers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newIndexers&lt;/span> &lt;span class="nx">Indexers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Indexer&lt;/code> çš„åˆ›å»º&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/store.go
&lt;/span>&lt;span class="c1">//keyFuncï¼škey çš„ç”Ÿæˆè§„åˆ™
&lt;/span>&lt;span class="c1">//indexersï¼šæä¾›äº†ç´¢å¼•èµ„æºçš„ä¸åŒä¿¡æ¯çš„è®¿é—®æ–¹æ³•ï¼Œå¦‚ç”¨äºæŸ¥è¯¢å‘½åç©ºé—´çš„ namespace =&amp;gt; MetaNamespaceIndexFunc
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewIndexer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">keyFunc&lt;/span> &lt;span class="nx">KeyFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indexers&lt;/span> &lt;span class="nx">Indexers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Indexer&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">cacheStorage&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">NewThreadSafeStore&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Indices&lt;/span>&lt;span class="p">{}),&lt;/span>
&lt;span class="nx">keyFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">keyFunc&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="threadsafestore">&lt;code>ThreadSafeStore&lt;/code>&lt;/h4>
&lt;p>ThreadSafeStoreæä¾›äº†å¯¹å­˜å‚¨çš„å¹¶å‘è®¿é—®æ¥å£&lt;/p>
&lt;p>æ³¨æ„äº‹é¡¹ï¼šä¸èƒ½ä¿®æ”¹Getæˆ–Listè¿”å›çš„ä»»ä½•å†…å®¹ï¼Œå› ä¸ºå®ƒä¸ä»…ä¼šç ´åçº¿ç¨‹å®‰å…¨ï¼Œè¿˜ä¼šç ´åç´¢å¼•åŠŸèƒ½ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/thread_safe_store.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewThreadSafeStore&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">indexers&lt;/span> &lt;span class="nx">Indexers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">indices&lt;/span> &lt;span class="nx">Indices&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">ThreadSafeStore&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">threadSafeMap&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">items&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{},&lt;/span>
&lt;span class="nx">indexers&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">indexers&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">indices&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">indices&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">threadSafeMap&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">lock&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RWMutex&lt;/span>
&lt;span class="nx">items&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}&lt;/span> &lt;span class="c1">//key =&amp;gt; value
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">indexers&lt;/span> &lt;span class="nx">Indexers&lt;/span> &lt;span class="c1">//value çš„ä¿¡æ¯çš„è®¿é—®æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">indices&lt;/span> &lt;span class="nx">Indices&lt;/span> &lt;span class="c1">//ç´¢å¼•
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="reflector">Reflector&lt;/h3>
&lt;p>&lt;code>Reflector&lt;/code>é€šè¿‡&lt;code> ListerWatcher&lt;/code>ï¼ˆAPIï¼‰ä¸&lt;code>api-server&lt;/code>äº¤äº’ï¼Œå¯¹èµ„æºè¿›è¡Œç›‘æ§ã€‚å°†èµ„æºå®ä¾‹çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ç­‰æ—¶é—´å°è£…åä¿å­˜åœ¨&lt;code>Informer&lt;/code>çš„FIFO é˜Ÿåˆ—ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/reflector.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewReflector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lw&lt;/span> &lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">expectedType&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">store&lt;/span> &lt;span class="nx">Store&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Reflector&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">NewNamedReflector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">naming&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetNameFromCallsite&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">internalPackages&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">lw&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">expectedType&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">store&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// NewNamedReflector same as NewReflector, but with a specified name for logging
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewNamedReflector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">lw&lt;/span> &lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">expectedType&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">store&lt;/span> &lt;span class="nx">Store&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Reflector&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">r&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Reflector&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">listerWatcher&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">lw&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">store&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">store&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">//FIFOé˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">period&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">resyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">clock&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RealClock&lt;/span>&lt;span class="p">{},&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">setExpectedType&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">expectedType&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">r&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ·»åŠ åŒæ­¥äº‹ä»¶ç›‘å¬å™¨">æ·»åŠ åŒæ­¥äº‹ä»¶ç›‘å¬å™¨&lt;/h3>
&lt;p>é€šè¿‡&lt;code>sharedIndexInformer#AddEventHandlerWithResyncPeriod()&lt;/code>æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ã€‚&lt;/p>
&lt;p>ä»¥å‰é¢çš„ HorizontalControllerä¸ºä¾‹ï¼Œåˆ›å»º informer çš„æ—¶å€™æ·»åŠ äº†ä¸‰ä¸ªå¤„ç†æ–¹æ³•ï¼š&lt;code>AddFunc&lt;/code>ã€&lt;code>UpdateFunc&lt;/code>ã€&lt;code>DeleteFunc&lt;/code>ã€‚è¿™ä¸‰ä¸ªæ–¹æ³•çš„å®ç°æ˜¯å°†å¯¹åº”çš„å…ƒç´ çš„ keyï¼ˆå›ºå®šæ ¼å¼ &lt;code>namespace/name&lt;/code>ï¼‰ä»&lt;code> workequeue&lt;/code>ä¸­è¿›è¡Œå…¥é˜Ÿã€å‡ºé˜Ÿçš„æ“ä½œã€‚ï¼ˆèµ„æºæ§åˆ¶å™¨ç›‘å¬äº†è¯¥ &lt;code>workqueue&lt;/code>ï¼‰&lt;/p>
&lt;h2 id="è¿è¡Œ">è¿è¡Œ&lt;/h2>
&lt;h3 id="controller-manager">&lt;code>controller-manager&lt;/code>&lt;/h3>
&lt;p>åœ¨é€šè¿‡&lt;code>InformerFactory&lt;/code>åˆ›å»º&lt;code>Informer&lt;/code>å®Œæˆåï¼Œéƒ½ä¼šå°†æ–°å»ºçš„&lt;code> Informer&lt;/code>åŠ å…¥åˆ°&lt;code>InformerFactory&lt;/code>çš„ä¸€ä¸ª&lt;code>map&lt;/code>ä¸­ã€‚&lt;/p>
&lt;p>åœ¨&lt;code>controller-manager&lt;/code>åœ¨å®Œæˆæ‰€æœ‰çš„æ§åˆ¶å™¨ï¼ˆå„ç§&lt;code>Controller&lt;/code>ï¼ŒåŒ…æ‹¬ CRDï¼‰åï¼Œä¼šè°ƒç”¨&lt;code>InformerFactory#Start()&lt;/code>æ¥å¯åŠ¨&lt;code>InformerFactory&lt;/code>çš„&lt;code>map&lt;/code>ä¸­çš„æ‰€æœ‰&lt;code> Informer&lt;/code>ï¼ˆè°ƒç”¨&lt;code>Informer#Run()&lt;/code>æ–¹æ³•ï¼‰&lt;/p>
&lt;h3 id="sharedindexinformerrun">&lt;code>sharedIndexInformer#Run()&lt;/code>&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/shared_informer.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sharedIndexInformer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleCrash&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">//åˆ›å»ºä¸€ä¸ªå¢é‡çš„ FIFOé˜Ÿåˆ—ï¼šDeltaFIFO
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">fifo&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">NewDeltaFIFO&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">MetaNamespaceKeyFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cfg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Queue&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">fifo&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">listerWatcher&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ObjectType&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">objectType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">FullResyncPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resyncCheckPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">RetryOnError&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ShouldResync&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">shouldResync&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Process&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HandleDeltas&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//å¯åŠ¨å‰çš„åˆå§‹åŒ–ï¼Œåˆ›å»º Controller
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startedLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startedLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">controller&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cfg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">controller&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">controller&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">clock&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">started&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="nx">processorStopCh&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Group&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// Wait for Processor to stop
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">defer&lt;/span> &lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">processorStopCh&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// Tell Processor to stop
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartWithChannel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">processorStopCh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheMutationDetector&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Run&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartWithChannel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">processorStopCh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">run&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//é€€å‡ºæ—¶çš„çŠ¶æ€æ¸…ç†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startedLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startedLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stopped&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span> &lt;span class="c1">// Don&amp;#39;t want any new listeners
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}()&lt;/span>
&lt;span class="c1">//å®è¡Œæ§åˆ¶é€»è¾‘
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">controller&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="controllerrun">&lt;code>controller#Run()&lt;/code>&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/controller.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">controller&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleCrash&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">stopCh&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="c1">//åˆ›å»ºä¸€ä¸ª Reflectorï¼Œç”¨äºä» api-server list å’Œ watch èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">NewReflector&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListerWatcher&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Queue&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FullResyncPeriod&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ShouldResync&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ShouldResync&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span>
&lt;span class="c1">//ä¸º controller æŒ‡å®š Reflector
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">reflectorMutex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">reflector&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">r&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">reflectorMutex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Group&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">//æ‰§è¡ŒReflector#Run()ï¼šä¼šå¯åŠ¨ä¸€ä¸ªgoroutineå¼€å§‹ç›‘æ§èµ„æºï¼Œå°† watch åˆ°çš„æ•°æ®å†™å…¥åˆ°queueï¼ˆFIFO é˜Ÿåˆ—ï¼‰ä¸­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartWithChannel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Run&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//æŒç»­ä» queueï¼ˆFIFO é˜Ÿåˆ—ï¼‰ è·å–æ•°æ®å¹¶è¿›è¡Œå¤„ç†ï¼Œå¤„ç†çš„é€»è¾‘åœ¨sharedIndexInformer#HandleDeltas()
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Until&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processLoop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stopCh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="sharedindexinformerhandledeltas">&lt;code>sharedIndexInformer#HandleDeltas()&lt;/code>&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/client-go/tools/cache/shared_informer.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sharedIndexInformer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">HandleDeltas&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">obj&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">blockDeltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">blockDeltas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// from oldest to newest
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">d&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">obj&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">Deltas&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//å¾ªç¯å¤„ç† FIFO é˜Ÿåˆ—ä¸­å–å‡ºçš„èµ„æºå®ä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">switch&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Type&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">Sync&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Added&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Updated&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1">//åŒæ­¥ï¼ˆåé¢è¯¦ç»†è§£è¯»ï¼‰ã€æ–°å¢ã€æ›´æ–°äº‹ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">isSync&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Type&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">Sync&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheMutationDetector&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">old&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">exists&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">exists&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//å¦‚æœ indexer ä¸­å·²ç»å­˜åœ¨ï¼Œæ›´æ‰ç”¨ update æ–¹æ³•è¿›è¡Œæ›´æ–°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//æ›´æ–°æˆåŠŸåå‘é€â€œæ›´æ–°â€é€šçŸ¥ï¼šåŒ…å«äº†æ–°ã€æ—§èµ„æºå®ä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">distribute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">updateNotification&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">oldObj&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">old&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">newObj&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="nx">isSync&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//å¦‚æœ indexer ä¸­æ²¡æœ‰è¯¥èµ„æºå®ä¾‹ï¼Œåˆ™æ”¾å…¥ indexer ä¸­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//æ·»åŠ æˆåŠŸåï¼Œå‘é€â€œæ–°å¢â€é€šçŸ¥ï¼šåŒ…å«äº†æ–°åŠ çš„èµ„æºå®ä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">distribute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addNotification&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">newObj&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="nx">isSync&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">Deleted&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1">//åˆ é™¤äº‹ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">indexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="c1">//ä» indexer ä¸­åˆ é™¤
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//åˆ é™¤æˆåŠŸåï¼Œå‘é€â€œåˆ é™¤é€šçŸ¥â€ï¼šåŒ…å«äº†åˆ é™¤çš„èµ„æºå®ä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">distribute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">deleteNotification&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">oldObj&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>Informer çš„å®ç°ä¸ç®—å¤æ‚ï¼Œå´åœ¨ Kubernetes ä¸­å¾ˆå¸¸è§ï¼Œæ¯ç§èµ„æºçš„æ§åˆ¶ä¹Ÿéƒ½é€šè¿‡ Informer æ¥è·å–&lt;code>api-server&lt;/code>çš„èµ„æºå®ä¾‹çš„å˜æ›´ã€‚&lt;/p></description></item><item><title>Kubernetes æºç è§£æ - HPA æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©å¦‚ä½•å·¥ä½œ</title><link>https://atbug.com/kubernetes-source-code-how-hpa-work/</link><pubDate>Sat, 15 Aug 2020 02:09:37 +0800</pubDate><guid>https://atbug.com/kubernetes-source-code-how-hpa-work/</guid><description>
&lt;p>HPA - Horizontal Pod Autoscaler çš„ç¼©å†™ï¼ŒPod æ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ã€‚é€šè¿‡å¯¹ Pod è´Ÿè½½çš„ç›‘æ§ï¼Œæ¥è‡ªåŠ¨å¢åŠ æˆ–è€…å‡å°‘ Pod çš„å‰¯æœ¬æ•°é‡ã€‚&lt;/p>
&lt;p>ä»å­—é¢æ„æ€æ¥çœ‹ï¼Œå…¶ä¸»è¦åŒ…å«äº†ä¸¤éƒ¨åˆ†ï¼š&lt;/p>
&lt;ul>
&lt;li>ç›‘æ§ Pod çš„è´Ÿè½½&lt;/li>
&lt;li>æ§åˆ¶ Pod çš„å‰¯æœ¬æ•°é‡&lt;/li>
&lt;/ul>
&lt;p>é‚£å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿä»¥ä¸‹åŸºäº1.17 æºç ï¼Œæ¥åˆ†æä¸‹ HPA å¦‚ä½•å·¥ä½œã€‚&lt;/p>
&lt;p>&lt;strong>æ³¨æ„ï¼šæ–‡ç« ä¸­çš„ä»£ç åœ¨æºç çš„åŸºç¡€ä¸Šè¿›è¡Œäº†ç²¾ç®€ï¼šåˆ æ‰äº†æ³¨é‡Šã€åºåˆ—åŒ–ç­‰ä¿¡æ¯ï¼Œæˆ–ä¿ç•™äº†éƒ¨åˆ†æ ¸å¿ƒä»£ç ï¼ŒåŠ ä¸Šæ–°çš„æ³¨é‡Šã€‚&lt;/strong>&lt;/p>
&lt;h2 id="èµ„æº">èµ„æº&lt;/h2>
&lt;p>HPA çš„èµ„æºæ˜¯&lt;code>HorizontalPodAutoscaler&lt;/code>ï¼Œåœ¨&lt;code>v1&lt;/code>ç‰ˆæœ¬ä¸­ï¼Œåªæ”¯æŒåŸºäº CPU æŒ‡æ ‡çš„è®¡ç®—ï¼›åœ¨&lt;code>v2beta2&lt;/code>ç‰ˆæœ¬ä¸­åŠ å…¥äº†åŸºäºå†…å­˜å’Œè‡ªå®šä¹‰æŒ‡æ ‡çš„è®¡ç®—ã€‚&lt;/p>
&lt;h3 id="v1">v1&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/api/autoscaling/v1/types.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscaler&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TypeMeta&lt;/span>
&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span>
&lt;span class="nx">Spec&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span>
&lt;span class="nx">Status&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerStatus&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ScaleTargetRef&lt;/span> &lt;span class="nx">CrossVersionObjectReference&lt;/span> &lt;span class="c1">//ç›‘æ§çš„ç›®æ ‡èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">MinReplicas&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span> &lt;span class="c1">//æœ€å°å‰¯æœ¬æ•°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">MaxReplicas&lt;/span> &lt;span class="kt">int32&lt;/span> &lt;span class="c1">//æœ€å¤§å‰¯æœ¬æ•°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">TargetCPUUtilizationPercentage&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span> &lt;span class="c1">//è§¦å‘è°ƒæ•´çš„CPU ä½¿ç”¨ç‡
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="v2">v2&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//staging/src/k8s.io/api/autoscaling/v2beta2/types.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscaler&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TypeMeta&lt;/span>
&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span>
&lt;span class="nx">Spec&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span>
&lt;span class="nx">Status&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerStatus&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ScaleTargetRef&lt;/span> &lt;span class="nx">CrossVersionObjectReference&lt;/span> &lt;span class="c1">//ç›‘æ§çš„ç›®æ ‡èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">MinReplicas&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span>
&lt;span class="nx">MaxReplicas&lt;/span> &lt;span class="kt">int32&lt;/span>
&lt;span class="nx">Metrics&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">MetricSpec&lt;/span> &lt;span class="c1">//æ–°åŠ å…¥çš„è‡ªå®šä¹‰æŒ‡æ ‡
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">MetricSpec&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Type&lt;/span> &lt;span class="nx">MetricSourceType&lt;/span> &lt;span class="c1">//æŒ‡æ ‡æºçš„ç±»å‹ï¼šObjectï¼ˆåŸºäºæŸä¸ªå¯¹è±¡ï¼‰ã€Podsï¼ˆåŸºäºpod æ•°ï¼‰ã€Resourceï¼ˆåŸºäºèµ„æºä½¿ç”¨è®¡ç®—ï¼Œæ¯”å¦‚v1 ç‰ˆæœ¬ä¸­cpuï¼‰ã€Externalï¼ˆåŸºäºå¤–éƒ¨çš„æŒ‡æ ‡ï¼‰ã€‚å¯¹åº” MetricsClient æ¥å£çš„å››ä¸ªæ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Object&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ObjectMetricSource&lt;/span> &lt;span class="c1">//å¯¹åº” Object ç±»å‹çš„æŒ‡æ ‡æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Pods&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PodsMetricSource&lt;/span> &lt;span class="c1">//å¯¹åº” Pod ç±»å‹çš„æŒ‡æ ‡æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Resource&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ResourceMetricSource&lt;/span> &lt;span class="c1">//å¯¹åº” Resource ç±»å‹çš„æŒ‡æ ‡æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">External&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExternalMetricSource&lt;/span> &lt;span class="c1">//å¯¹åº” External ç±»å‹çš„æŒ‡æ ‡æº
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">ObjectMetricSource&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">DescribedObject&lt;/span> &lt;span class="nx">CrossVersionObjectReference&lt;/span> &lt;span class="c1">//ç›®æ ‡å¯¹è±¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Target&lt;/span> &lt;span class="nx">MetricTarget&lt;/span> &lt;span class="c1">//æŒ‡å®šæŒ‡æ ‡çš„ç›®æ ‡å€¼ã€å¹³å‡å€¼æˆ–è€…å¹³å‡ä½¿ç”¨ç‡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Metric&lt;/span> &lt;span class="nx">MetricIdentifier&lt;/span> &lt;span class="c1">//æŒ‡æ ‡æ ‡è¯†ï¼šåå­—ã€labelé€‰æ‹©å™¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">PodsMetricSource&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Metric&lt;/span> &lt;span class="nx">MetricIdentifier&lt;/span>
&lt;span class="nx">Target&lt;/span> &lt;span class="nx">MetricTarget&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">ResourceMetricSource&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span> &lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResourceName&lt;/span>
&lt;span class="nx">Target&lt;/span> &lt;span class="nx">MetricTarget&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">ExternalMetricSource&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Metric&lt;/span> &lt;span class="nx">MetricIdentifier&lt;/span>
&lt;span class="nx">Target&lt;/span> &lt;span class="nx">MetricTarget&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">MetricTarget&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Type&lt;/span> &lt;span class="nx">MetricTargetType&lt;/span> &lt;span class="c1">//ç±»å‹ï¼šUtilizationã€Valueã€AverageValue
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">resource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Quantity&lt;/span>
&lt;span class="nx">AverageValue&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">resource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Quantity&lt;/span>
&lt;span class="nx">AverageUtilization&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ§åˆ¶å™¨-horizontalcontroller">æ§åˆ¶å™¨ &lt;code>HorizontalController&lt;/code>&lt;/h2>
&lt;p>&lt;code>HorizontalController&lt;/code>è¢«é€šè¿‡ key &lt;code>horizontalpodautoscaling&lt;/code> åŠ å…¥åˆ° controller manager ä¸­ã€‚ç”¨æ¥æ§åˆ¶&lt;code>HorizontalPodAutoscaler&lt;/code>å®ä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">///cmd/kube-controller-manager/app/controllermanager.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewControllerInitializers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">loopMode&lt;/span> &lt;span class="nx">ControllerLoopMode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">InitFunc&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="nx">controllers&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;horizontalpodautoscaling&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">startHPAController&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è·å–è´Ÿè½½æŒ‡æ ‡">è·å–è´Ÿè½½æŒ‡æ ‡&lt;/h3>
&lt;p>æ—¢ç„¶ Pod å‰¯æœ¬æ•°é‡çš„è®¡ç®—æ˜¯åŸºäº Pod çš„è´Ÿè½½æƒ…å†µï¼Œé‚£è¾¹éœ€è¦é€”å¾„è·å–è´Ÿè½½æ•°æ®ï¼Œè¿™ä¸ªé€”å¾„å°±æ˜¯&lt;code>MetricsClient&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>MetricsClient&lt;/code>æœ‰ä¸¤ç§å®ç°ï¼šREST æ–¹å¼å’Œä¼ ç»Ÿï¼ˆLegacyï¼‰æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯&lt;code>restMetricsClient&lt;/code>å’Œ&lt;code>HeapsterMetricsClient&lt;/code>ã€‚ä¸€ä¸ªæ˜¯REST å®ç°ä»¥æ”¯æŒè‡ªå®šä¹‰çš„æŒ‡æ ‡ï¼›ä¸€ä¸ªæ˜¯ä¼ ç»Ÿçš„ Heapster æŒ‡æ ‡ï¼ˆheapster å·²ç»ä» 1.13 ç‰ˆæœ¬å¼€å§‹è¢«åºŸå¼ƒäº†ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//cmd/kube-controller-manager/app/autoscaling.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">startHPAController&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">ControllerContext&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AvailableResources&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GroupVersionResource&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Group&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;autoscaling&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Version&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;v1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Resource&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;horizontalpodautoscalers&amp;#34;&lt;/span>&lt;span class="p">}]&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ComponentConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HPAController&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerUseRESTClients&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// use the new-style clients if support for custom metrics is enabled
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nf">startHPAControllerWithRESTClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">startHPAControllerWithLegacyClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ§åˆ¶å™¨é€»è¾‘horizontalcontrollerrun">æ§åˆ¶å™¨é€»è¾‘&lt;code>HorizontalController#Run()&lt;/code>&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//pkg/controller/podautoscaler/horizontal.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleCrash&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ShutDown&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Starting HPA controller&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Shutting down HPA controller&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// ç­‰å¾… informer å®ŒæˆHorizontalPodAutoscalerç›¸å…³äº‹ä»¶çš„åŒæ­¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WaitForNamedCacheSync&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;HPA&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stopCh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">hpaListerSynced&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">podListerSynced&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// start a single worker (we may wish to start more in the future)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//æ‰§è¡Œ worker é€»è¾‘ï¼Œç›´åˆ°æ”¶åˆ°é€€å‡ºæŒ‡ä»¤
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">go&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Until&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">worker&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stopCh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">stopCh&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>worker&lt;/code>çš„æ ¸å¿ƒæ˜¯ä»å·¥ä½œé˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ª keyï¼ˆæ ¼å¼ä¸ºï¼šnamespace/nameï¼‰ï¼Œç„¶åå¯¹ key è¿›è¡Œ reconcileï¼ˆè¿™ä¸ªè¯æ˜¯Kubernetes çš„æ ¸å¿ƒï¼Œç¿»è¯‘ä¸ºâ€œè°ƒå’Œâ€ã€â€œå’Œè§£â€ã€‚ä¸ªäººæ›´å–œæ¬¢â€œè°ƒæ•´â€ï¼Œå³&lt;strong>å°†å®ä¾‹çš„çŠ¶æ€è°ƒæ•´ä¸ºæœŸæœ›çš„çŠ¶æ€&lt;/strong>ã€‚æ­¤å¤„ï¼Œå¯¹äº hpa çš„å®ä¾‹çš„æ¯ä¸ªäº‹ä»¶ï¼Œéƒ½ä¼šæŒ‰ç…§ç‰¹å®šçš„é€»è¾‘è°ƒæ•´ç›®æ ‡å®ä¾‹çš„ Pod çš„å‰¯æœ¬æ•°é‡ã€‚ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//pkg/controller/podautoscaler/horizontal.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">worker&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">processNextWorkItem&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;horizontal pod autoscaler controller worker shutting down&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">processNextWorkItem&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">quit&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">quit&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">deleted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">reconcileKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">deleted&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">queue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddRateLimited&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹ key è¿›è¡Œ reconcile çš„è°ƒç”¨æ ˆï¼š&lt;code>HorizontalController#reconcileKey -&amp;gt; HorizontalController#reconcileAutoscaler -&amp;gt; HorizontalController#computeReplicasForMetrics -&amp;gt; ScaleInterface#Update&lt;/code>&lt;/p>
&lt;p>ç®€å•æ¥è¯´å°±æ˜¯å…ˆä»&lt;code>Informer&lt;/code>ä¸­æ‹¿åˆ° key å¯¹åº”çš„&lt;code>HorizontalPodAutoscaler&lt;/code>èµ„æºå®ä¾‹ï¼›ç„¶åé€šè¿‡&lt;code>HorizontalPodAutoscaler&lt;/code>å®ä¾‹ä¸­çš„ä¿¡æ¯ï¼Œæ£€æŸ¥ç›®æ ‡èµ„æºçš„Pod è´Ÿè½½ä»¥åŠå½“å‰çš„å‰¯æœ¬æ•°ï¼Œå¾—åˆ°æœŸæœ›çš„ Pod å‰¯æœ¬æ•°ï¼›æœ€ç»ˆé€šè¿‡ Scale API æ¥è°ƒæ•´ Pod çš„å‰¯æœ¬æ•°ã€‚æœ€åä¼šå°†è°ƒæ•´çš„åŸå› ã€è®¡ç®—çš„ç»“æœç­‰ä¿¡æ¯å†™å…¥&lt;code>HorizontalPodAutoscaler&lt;/code>å®ä¾‹çš„ condition ä¸­ã€‚&lt;/p>
&lt;h3 id="è®¡ç®—æœŸæœ›çš„å‰¯æœ¬æ•°">è®¡ç®—æœŸæœ›çš„å‰¯æœ¬æ•°&lt;/h3>
&lt;p>å¯¹æ¯ä¸ªæŒ‡æ ‡è¿›è¡Œè®¡ç®—ï¼Œéƒ½ä¼šå¾—åˆ°å»ºè®®çš„å‰¯æœ¬æ•°ï¼Œç„¶åæœ€å¤§çš„é‚£ä¸ªå°±æ˜¯æœ€ç»ˆçš„æœŸæœ›å‰¯æœ¬æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//pkg/controller/podautoscaler/horizontal.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HorizontalController&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">computeReplicasForMetrics&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hpa&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">autoscalingv2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscaler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scale&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">autoscalingv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Scale&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">metricSpecs&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">autoscalingv2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MetricSpec&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">replicas&lt;/span> &lt;span class="kt">int32&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metric&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">statuses&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">autoscalingv2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MetricStatus&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">timestamp&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">......&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricSpec&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">metricSpecs&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">replicaCountProposal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricNameProposal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">timestampProposal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">condition&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">computeReplicasForMetric&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hpa&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricSpec&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">specReplicas&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">statusReplicas&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">selector&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">statuses&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">invalidMetricsCount&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">invalidMetricCondition&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">condition&lt;/span>
&lt;span class="nx">invalidMetricError&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">invalidMetricsCount&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">replicas&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">replicaCountProposal&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="nx">replicas&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">timestamp&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">timestampProposal&lt;/span>
&lt;span class="nx">replicas&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">replicaCountProposal&lt;/span>
&lt;span class="nx">metric&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">metricNameProposal&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">......&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>#computeStatusForObjectMetric&lt;/code>ï¼ˆæ³¨æ„è¿™ä¸ªæ–¹æ³•åå°‘äº†ä¸ª &amp;ldquo;s&amp;rdquo;ï¼‰ä½¿ç”¨&lt;code>MetricsClient&lt;/code>å¾—åˆ°æŒ‡å®šæŒ‡æ ‡çš„å€¼ã€‚&lt;/p>
&lt;p>è¿™ä¸ªæµç¨‹çš„ç»†èŠ‚è¿˜å¯ä»¥ç»§ç»­æ·±æŒ–ï¼Œä½†åˆ°æ­¤å·²å¤Ÿæˆ‘ä»¬ç†è§£ HPAâ€‹ çš„å®ç°æ–¹å¼äº†ã€‚â€‹&lt;/p></description></item><item><title>å¸¦ä½ äº†è§£ Ribbon è´Ÿè½½å‡è¡¡å™¨çš„å®ç°</title><link>https://atbug.com/how-loadbalancer-works-in-ribbon/</link><pubDate>Tue, 09 Jun 2020 19:35:53 +0800</pubDate><guid>https://atbug.com/how-loadbalancer-works-in-ribbon/</guid><description>
&lt;p>Spring Cloud ä¸­ &lt;code>Ribbon&lt;/code>æœ‰åœ¨ &lt;code>Zuul&lt;/code> å’Œ &lt;code>Feign&lt;/code> ä¸­ä½¿ç”¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡åœ¨&lt;code>RestTemplate&lt;/code>çš„ bean å®šä¹‰ä¸Šæ·»åŠ &lt;code>@LoadBalanced&lt;/code>æ³¨è§£æ–¹å¼è·å¾—ä¸€ä¸ªå¸¦æœ‰è´Ÿè½½å‡è¡¡æ›´èƒ½çš„&lt;code>RestTemplate&lt;/code>ã€‚&lt;/p>
&lt;p>ä¸è¿‡å®ç°çš„æ–¹æ³•éƒ½å¤§åŒå°å¼‚ï¼šå¯¹&lt;code>HttpClient&lt;/code>è¿›è¡Œå°è£…ï¼ŒåŠ ä¸Šå®ä¾‹çš„â€é€‰æ‹©â€œï¼ˆè¿™ä¸ªé€‰æ‹©çš„é€»è¾‘å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„è´Ÿè½½å‡è¡¡ï¼‰ã€‚&lt;/p>
&lt;p>è¦å­¦ä¹ æŸä¸ªæ¡†æ¶çš„æ—¶å€™ï¼Œæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯ï¼š&lt;strong>Running+Debugging&lt;/strong>ã€‚&lt;/p>
&lt;p>&lt;strong>è·‘å°±æ˜¯äº†ã€‚&lt;/strong>&lt;/p>
&lt;blockquote>
&lt;p>debug ä¸ä¸€å®šæ˜¯ä¸ºäº† bug&lt;/p>
&lt;p>debug å‡ºçœŸçŸ¥&lt;/p>
&lt;p>Debugging = Learning&lt;/p>
&lt;/blockquote>
&lt;p>é€‰ç”¨ &lt;a href="https://www.alispit.tel">Ali Spittel&lt;/a> çš„ä¸€æ¡æ¨æ–‡ï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/06/09/screenshot-20200609-at-165236.png" alt="screenshot 2020-06-09 at 16.52.36">&lt;/p>
&lt;h3 id="ä»¥-zuul-è·¯ç”±çš„çº¿ç¨‹æ ˆä¸ºä¾‹">ä»¥ Zuul è·¯ç”±çš„çº¿ç¨‹æ ˆä¸ºä¾‹&lt;/h3>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/06/09/screenshot-20200609-at-151421.png" alt="screenshot 2020-06-09 at 15.14.21">&lt;/p>
&lt;p>è°ƒæ•´ä¸‹é¡ºåºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">RetryableRibbonLoadBalancingHttpClient&lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="n">execute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RibbonApacheHttpRequest&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">IClientConfig&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">RetryableRibbonLoadBalancingHttpClient&lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="n">executeWithRetry&lt;/span>&lt;span class="o">(...)&lt;/span>
&lt;span class="n">RetryTemplate&lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="n">execute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RetryCallback&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;,&lt;/span> &lt;span class="n">RecoveryCallback&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;)&lt;/span>
&lt;span class="n">RetryTemplate&lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="n">doExecute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RetryCallback&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;,&lt;/span> &lt;span class="n">RecoveryCallback&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;,&lt;/span> &lt;span class="n">RetryState&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">RetryTemplate&lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="n">canRetry&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RetryPolicy&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">RetryContext&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">InterceptorRetryPolicy&lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="n">canRetry&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RetryContext&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">AbstractLoadBalancingClient&lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="n">choose&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">serviceId&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">ZoneAwareLoadBalancer&lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="n">chooseServer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="c1">//key as serviceId
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">BaseLoadBalancer&lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="n">chooseServer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">PredicateBasedRule&lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="n">choose&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">AbstractServerPredicate&lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="n">chooseRoundRobinAfterFiltering&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Server&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">servers&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="n">loadBalancerKey&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">AbstractServerPredicate&lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="n">apply&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Predicate&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ†æ">åˆ†æ&lt;/h3>
&lt;p>Zuul æ”¶åˆ°è¯·æ±‚ç»è¿‡ä¸€ç³»åˆ— Filter çš„å¤„ç†ï¼Œæ¥åˆ° &lt;code>RibbonRoutingFilter&lt;/code>ï¼›å°†è¯·æ±‚å°è£…æˆ &lt;code>RibbonCommandContext&lt;/code>ï¼Œç„¶åä½¿ç”¨ context æ„å»º &lt;code>RibbonCommand&lt;/code>ã€‚æœ€ç»ˆè°ƒç”¨&lt;code>RibbonCommand#execute()&lt;/code>æ–¹æ³•ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°ä¸‹æ¸¸ã€‚&lt;/p>
&lt;p>&lt;code>RibbonCommand&lt;/code>æŒæœ‰&lt;code>AbstractLoadBalancerAwareClient&lt;/code>çš„å¯¹è±¡ï¼Œé€šè¿‡è¯¥ client åœ¨å¤„ç†è¯·æ±‚å’Œå“åº”ã€‚&lt;/p>
&lt;p>å¯¹äº &lt;strong>retryable&lt;/strong> çš„ clientï¼ˆæ¯”å¦‚æ­¤å¤„çš„&lt;code>RetryableRibbonLoadBalancingHttpClient&lt;/code>ï¼‰ï¼Œ &lt;em>&lt;em>æ¯æ¬¡å¤„ç†è¯·æ±‚çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ª&lt;/em>&lt;/em> &lt;code>RetryTemplate&lt;/code>å¯¹è±¡æ¥å¤„ç†è¯·æ±‚ï¼›åŒæ—¶æ ¹æ®&lt;code>RetryPolicy&lt;/code>æ¥åˆ›å»º&lt;code>RetryContext&lt;/code>å¯¹è±¡ï¼Œç”¨æ¥ä¿å­˜é‡è¯•çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶ &lt;em>æ£€æŸ¥å®ä¾‹æ˜¯å¦å¯ä»¥è¿›è¡Œé‡è¯•&lt;/em> ã€‚&lt;/p>
&lt;p>æ³¨æ„é‡ç‚¹å°±åœ¨è¿™é‡Œï¼šæ£€æŸ¥çš„æ—¶å€™&lt;strong>å¦‚æœé‡è¯•æ¬¡æ•°ä¸º 0 ä¸”è¦æ£€æŸ¥çš„å®ä¾‹ä¸ºç©º&lt;/strong>ï¼ˆè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼‰ï¼Œè¿™æ—¶ä¾¿ä¼šé€šè¿‡&lt;strong>è´Ÿè½½å‡è¡¡å™¨å®¢æˆ·ç«¯&lt;/strong>ï¼ˆåŸºæœ¬éƒ½æ˜¯&lt;code>AbstractLoadBalancingClient&lt;/code>çš„å­ç±»ï¼‰ä»åç«¯åˆ—è¡¨æ‹©å‡ºä¸€ä¸ªå®ä¾‹ï¼Œä¿å­˜åœ¨&lt;code>RetryContext&lt;/code>ä¸­ã€‚&lt;/p>
&lt;p>è´Ÿè½½å‡è¡¡å™¨å®¢æˆ·ç«¯ä½¿ç”¨&lt;strong>è´Ÿè½½å‡è¡¡å™¨&lt;/strong>ï¼ˆ&lt;code>ILoadBalancer&lt;/code>çš„å®ç°ï¼‰æ¥é€‰æ‹©å®ä¾‹ã€‚æ¯ä¸ªè´Ÿè½½å‡è¡¡å™¨éƒ½æœ‰è‡ªå·±çš„è§„åˆ™ï¼ˆ&lt;code>IRule&lt;/code>çš„å®ç°ç±»ï¼‰ï¼Œé€šè¿‡è§„åˆ™æ¥é€‰æ‹©å®ä¾‹ã€‚&lt;/p>
&lt;p>&lt;code>IRule&lt;/code>çš„å®ç°ä¸æ˜¯å¾ˆå¤šï¼Œ&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/06/09/screenshot-20200609-at-163309.png" alt="screenshot 2020-06-09 at 16.33.09">&lt;/p>
&lt;p>å…¶ä¸­çš„&lt;code>ClientConfigEnabledRoundRobinRule&lt;/code>åœ¨&lt;code>RoundRobinRule&lt;/code>çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†é…ç½®çš„æ¥å£ï¼ˆå› ä¸ºå…¶å®ç°äº†&lt;code>IClientConfigAware&lt;/code>æ¥å£ï¼‰å¯ä»¥å¯¹è§„åˆ™è¿›è¡Œé…ç½®ã€‚&lt;/p>
&lt;p>æŸäº›&lt;code>ClientConfigEnabledRoundRobinRule&lt;/code>çš„å­ç±»äº†ï¼Œå¢åŠ äº†&lt;code>Predicate&lt;/code>é€»è¾‘ï¼šä½¿ç”¨&lt;code>Predicate&lt;/code>ï¼ˆ&lt;code>AbstractServerPredicate&lt;/code>çš„å­ç±»ï¼‰çš„é€»è¾‘è¿›è¡Œé€‰æ‹©ï¼›è€Œ&lt;code>ClientConfigEnabledRoundRobinRule&lt;/code>åªæ˜¯ç®€å•çš„ä½¿ç”¨&lt;code>RoundRobinRule&lt;/code>è¿›è¡Œé€‰æ‹©ã€‚&lt;/p>
&lt;p>å› æ­¤é€‰æ‹©çš„é€»è¾‘éƒ½æ˜¯åœ¨&lt;code>AbstractServerPredicate&lt;/code>å­ç±»ä¸­ï¼Œå…¶æœ‰ä¸ªç‰¹åˆ«çš„å­ç±»&lt;code>CompositePredicate&lt;/code>ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯å°†å¤šä¸ªé€»è¾‘æ•´åˆåœ¨ä¸€èµ·ï¼ˆä½¿ç”¨&lt;code>Predicate#and()&lt;/code>å°†æ‰€æœ‰é€»è¾‘ä¸²è”èµ·æ¥ï¼Œè¾¾åˆ°&lt;code>&amp;amp;&amp;amp;&lt;/code>çš„æ•ˆæœï¼‰ï¼Œæ‰€æœ‰çš„é€»è¾‘æ£€æŸ¥éƒ½é€šè¿‡ï¼ˆè¿”å›&lt;code>true&lt;/code>ï¼‰æ—¶ï¼Œè¿™ä¸ªå®ä¾‹å°±ä¼šè¢«é€‰ä¸­ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/06/09/screenshot-20200609-at-165642.png" alt="screenshot 2020-06-09 at 16.56.42">&lt;/p>
&lt;hr>
&lt;p>é‚£ä¹ˆç°åœ¨è¦ä½ å†™ä¸ªè‡ªå·±è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œåº”è¯¥çŸ¥é“ä»å“ªé‡Œå…¥æ‰‹äº†å§ï¼Ÿ:D&lt;/p></description></item><item><title>Eureka å®ä¾‹æ³¨å†ŒçŠ¶æ€ä¿æŒ STARTING çš„é—®é¢˜æ’æŸ¥</title><link>https://atbug.com/troubleshooting-on-eureka-instance-keep-starting/</link><pubDate>Thu, 28 May 2020 22:04:02 +0800</pubDate><guid>https://atbug.com/troubleshooting-on-eureka-instance-keep-starting/</guid><description>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/28/maninblackshirtandgraydenimpantssittingongray11342.jpg" alt="">&lt;/p>
&lt;p>è¿™æ˜¯çœŸå®å‘ç”Ÿåœ¨ç”Ÿäº§ç¯å¢ƒçš„ caseï¼Œå®ä¾‹å¯åŠ¨åæ­£å¸¸è¿è¡Œï¼Œè€Œåœ¨æ³¨å†Œä¸­å¿ƒçš„çŠ¶æ€ä¸€ç›´ä¿æŒ&lt;code>STARTING&lt;/code>ï¼Œè€Œæœ¬åœ°çš„çŠ¶æ€ä¸º&lt;code>UP&lt;/code>ã€‚å¯¼è‡´æœåŠ¡çš„æ¶ˆè´¹æ–¹æ— æ³•å‘ç°å¯ç”¨å®ä¾‹ã€‚&lt;/p>
&lt;p>è¿™ç§æƒ…å†µçš„å‡ºç°æ¦‚ç‡éå¸¸ä½ï¼Œè¿è¡Œä¸€å¹´å¤šæœªå‘ç°ä¸¤ä¸ªå®ä¾‹åŒæ—¶å‡ºç°é—®é¢˜çš„æƒ…å†µï¼Œå› æ­¤å¤šå®ä¾‹è¿è¡Œå¯ä»¥é¿å…ã€‚æ–‡æœ«æœ‰é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œä¸æƒ³èŠ±æ—¶é—´çœ‹åˆ†æè¿‡ç¨‹å¯ç›´æ¥è·³åˆ°æœ€åã€‚&lt;/p>
&lt;p>ç¯å¢ƒè¯´æ˜ï¼š&lt;/p>
&lt;blockquote>
&lt;p>eureka-client: 1.7.2
spring-boot: 1.5.12.RELEASE
spring-cloud: Edgware.SR3&lt;/p>
&lt;/blockquote>
&lt;h2 id="é—®é¢˜é‡ç°">é—®é¢˜é‡ç°&lt;/h2>
&lt;p>å€ŸåŠ©&lt;code>Btrace&lt;/code>é‡ç°, &lt;code>java -noverify -cp .:btrace-boot.jar -javaagent:btrace-agent.jar=script=&amp;lt;pre-compiled-btrace-script&amp;gt; &amp;lt;MainClass&amp;gt; &amp;lt;AppArguments&amp;gt;&lt;/code>&lt;/p>
&lt;h3 id="æ€è·¯">æ€è·¯&lt;/h3>
&lt;p>ä¸»çº¿ç¨‹æ›´æ–°å®ä¾‹æœ¬åœ°çŠ¶æ€(STARTING-&amp;gt;UP)å‰, ç­‰å¾…å¿ƒè·³çº¿ç¨‹å®Œæˆç¬¬ä¸€æ¬¡å¿ƒè·³å¹¶å°è¯•æ³¨å†Œå®ä¾‹, è·å–åˆ°å½“å‰çš„çŠ¶æ€&lt;code>STARTING&lt;/code>. ä¸»çº¿ç¨‹æ›´æ–°çŠ¶æ€åè§¦å‘&lt;/p>
&lt;p>&lt;a href="https://gist.github.com/addozhang/9b584470558beb862abeb93e74c1a9b4">Btrace è„šæœ¬&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">import&lt;/span> &lt;span class="nn">com.sun.btrace.annotations.BTrace&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">com.sun.btrace.annotations.Kind&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">com.sun.btrace.annotations.Location&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">com.sun.btrace.annotations.OnMethod&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">java.util.concurrent.atomic.AtomicBoolean&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import static&lt;/span> &lt;span class="nn">com.sun.btrace.BTraceUtils.currentThread&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import static&lt;/span> &lt;span class="nn">com.sun.btrace.BTraceUtils.println&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * @author Addo.Zhang
&lt;/span>&lt;span class="cm"> * @date 2019-07-31
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="nd">@BTrace&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">unsafe&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">EurekaRequest&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">AtomicBoolean&lt;/span> &lt;span class="n">heartbeatThreadRegistrationStarted&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">AtomicBoolean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">AtomicBoolean&lt;/span> &lt;span class="n">replicatorThreadRegistrationCompleted&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">AtomicBoolean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">AtomicBoolean&lt;/span> &lt;span class="n">statusUP&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">AtomicBoolean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="nd">@OnMethod&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">clazz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistry&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nd">@Location&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Kind&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">LINE&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">45&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">waitHeartbeatExecution&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">currentThread&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; is waiting heartbeatThreadRegistrationStarted thread executing first&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">heartbeatThreadRegistrationStarted&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@OnMethod&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">clazz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistry&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nd">@Location&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Kind&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">LINE&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">46&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">markStatusUp&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">statusUP&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Heartbeat thread executed and &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">currentThread&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; continues procedure to change status to [UP]&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@OnMethod&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">clazz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;com.netflix.discovery.converters.EurekaJacksonCodec$InstanceInfoSerializer&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nd">@Location&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Kind&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">LINE&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">369&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">continueRegistrationExecution&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">doExecution&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@OnMethod&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">clazz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;com.logancloud.forge.discovery.converters.LoganEurekaJacksonCodec$LoganInstanceInfoSerializer&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">location&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nd">@Location&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Kind&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">LINE&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">117&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">continueRegistrationExecution2&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">doExecution&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">doExecution&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">currentThread&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; started to proceed registration&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">contains&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;HeartbeatExecutor&amp;#34;&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">heartbeatThreadRegistrationStarted&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">statusUP&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">replicatorThreadRegistrationCompleted&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">500&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="c1">//interval for replicator registration request completed.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">interrupt&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">contains&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;InstanceInfoReplicator&amp;#34;&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">replicatorThreadRegistrationCompleted&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">currentThread&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; thread registration completed&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/28/15652581664364.jpg" alt="">&lt;/p>
&lt;ol>
&lt;li>å¿ƒè·³çº¿ç¨‹&lt;code>HeartbeatThread&lt;/code>å‘é€å¿ƒè·³è¯·æ±‚(&lt;code>PUT&lt;/code>), æ³¨å†Œä¸­å¿ƒè¿”å›404.&lt;/li>
&lt;li>å®ä¾‹ä¿¡æ¯åŒæ­¥çº¿ç¨‹&lt;code>InstanceInfoReplicator&lt;/code>å‘é€æ³¨å†Œè¯·æ±‚(&lt;code>POST&lt;/code>): çŠ¶æ€ä¸º&lt;code>UP&lt;/code>, &lt;code>lastDirtyTimestamp&lt;/code>ä¸º&lt;code>a&lt;/code>&lt;/li>
&lt;li>å¿ƒè·³çº¿ç¨‹å‘é€å®ä¾‹æ³¨å†Œè¯·æ±‚(&lt;code>POST&lt;/code>): çŠ¶æ€ä¸º&lt;code>STARTING&lt;/code>, &lt;code>lastDirtyTimestamp&lt;/code>ä¸º&lt;code>a&lt;/code>&lt;/li>
&lt;/ol>
&lt;h2 id="æœåŠ¡æ³¨å†Œ">æœåŠ¡æ³¨å†Œ&lt;/h2>
&lt;p>å…ˆåˆ†ææœåŠ¡å®ä¾‹çš„æ³¨å†Œé€»è¾‘.&lt;/p>
&lt;h3 id="instanceinfoåˆå§‹åŒ–">InstanceInfoåˆå§‹åŒ–&lt;/h3>
&lt;p>é€šè¿‡&lt;code>InstanceInfoFactory#create()&lt;/code>æ–¹æ³•æ¥åˆå§‹åŒ–&lt;code>ApplicationInfoManager.instanceInfo&lt;/code>å®ä¾‹æ—¶, å®ä¾‹çŠ¶æ€è¢«è®¾ç½®ä¸º&lt;code>STARTING&lt;/code>&lt;/p>
&lt;h3 id="æœåŠ¡å®ä¾‹æ³¨å†Œ">æœåŠ¡å®ä¾‹æ³¨å†Œ&lt;/h3>
&lt;p>æœåŠ¡å®ä¾‹æ³¨å†Œçš„çœŸæ­£é€»è¾‘æ˜¯åœ¨&lt;code>DiscoveryClient#register()&lt;/code>ä¸­å®Œæˆçš„. ä½†æ˜¯è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨å´æœ‰ä¸¤ä¸ªå…¥å£, åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­å¯è§£é‡Šä¸ºä¸»åŠ¨æ³¨å†Œå’Œè¢«åŠ¨æ³¨å†Œ.&lt;/p>
&lt;h4 id="ä¸€-ä¸»åŠ¨æ³¨å†Œ">ä¸€. ä¸»åŠ¨æ³¨å†Œ&lt;/h4>
&lt;p>&lt;code>EurekaAutoServiceRegistration&lt;/code>å®ç°äº†&lt;code>SmartLifecycle&lt;/code>æ¥å£, åœ¨&lt;code>EurekaClientAutoConfiguration#eurekaAutoServiceRegistration()&lt;/code>è¢«å®ä¾‹åŒ–.&lt;/p>
&lt;p>&lt;code>EurekaAutoServiceRegistration#start()&lt;/code>æ–¹æ³•å°†&lt;code>EurekaRegistration&lt;/code>æ³¨å†Œç»™&lt;code>EurekaServiceRegistry&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">start&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">running&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">registration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getNonSecurePort&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//è°ƒç”¨EurekaServiceRegistryè¿›è¡Œæ³¨å†Œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">serviceRegistry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">register&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">registration&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//å‘å¸ƒå®ä¾‹æ³¨å†Œçš„äº‹ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">context&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">publishEvent&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="n">InstanceRegisteredEvent&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">registration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInstanceConfig&lt;/span>&lt;span class="o">()));&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">running&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;p>&lt;code>EurekaServiceRegistry#register()&lt;/code>:
å…ˆå°†å®ä¾‹çŠ¶æ€è®¾ç½®ä¸ºåˆå§‹çŠ¶æ€&lt;strong>UP&lt;/strong>(å¯é€šè¿‡&lt;code>eureka.instance.initial-status&lt;/code>ä¿®æ”¹, é»˜è®¤ä¸º&lt;code>UP&lt;/code>). è¿™é‡Œä¼šè§¦å‘&lt;code>StatusChangeListener#notify()&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">register&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">EurekaRegistration&lt;/span> &lt;span class="n">reg&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">maybeInitializeClient&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">reg&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isInfoEnabled&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Registering application &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">reg&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInstanceConfig&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getAppname&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; with eureka with status &amp;#34;&lt;/span>
&lt;span class="o">+&lt;/span> &lt;span class="n">reg&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInstanceConfig&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getInitialStatus&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//1
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">reg&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getApplicationInfoManager&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">setInstanceStatus&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">reg&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInstanceConfig&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getInitialStatus&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">reg&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getHealthCheckHandler&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//2
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">reg&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getEurekaClient&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">registerHealthCheck&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">reg&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getHealthCheckHandler&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>DiscoveryClient&lt;/code>å†…éƒ¨åŒ¿åç±»æä¾›äº†&lt;code>StatusChangeListener&lt;/code>çš„å®ç°, è°ƒç”¨&lt;code>InstanceInfoReplicator#onDemandUpdate()&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">statusChangeListener&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ApplicationInfoManager&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">StatusChangeListener&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">getId&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;statusChangeListener&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">notify&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">StatusChangeEvent&lt;/span> &lt;span class="n">statusChangeEvent&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InstanceStatus&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">DOWN&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">statusChangeEvent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getStatus&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">||&lt;/span>
&lt;span class="n">InstanceStatus&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">DOWN&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">statusChangeEvent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getPreviousStatus&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// log at warn level if DOWN was involved
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">logger&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">warn&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Saw local status change event {}&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">statusChangeEvent&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">logger&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Saw local status change event {}&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">statusChangeEvent&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">instanceInfoReplicator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">onDemandUpdate&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">};&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>InstanceInfoReplicator&lt;/code>æ˜¯åœ¨&lt;code>DiscoveryClient#initScheduledTasks()&lt;/code>ä¸­å®ä¾‹åŒ–çš„&lt;code>Runnable&lt;/code>çš„å®ç°, å®ä¾‹åŒ–ä¹‹å, ä½¿ç”¨å…¶å†…éƒ¨çš„è°ƒåº¦çº¿ç¨‹æ± è°ƒåº¦ä¸€ä¸ªçº¿ç¨‹. è€Œ&lt;code>onDemandUpdate()&lt;/code>ä¹ŸåŒæ ·ä¼šä½¿ç”¨è°ƒåº¦çº¿ç¨‹æ± è°ƒåº¦ä¸€ä¸ªçº¿ç¨‹.&lt;/p>
&lt;p>å…¶&lt;code>#run()&lt;/code>æ–¹æ³•ä¼šè°ƒç”¨&lt;code>DiscoveryClient#refreshInstanceInfo()&lt;/code>æ¥æ›´æ–°çŠ¶æ€. çŠ¶æ€çš„æ›´æ–°æ˜¯é€šè¿‡&lt;code>HealthCheckHandler&lt;/code>æ¥å®ç°çš„, å…·ä½“è¯·çœ‹&lt;a href="#%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5">çŠ¶æ€æ£€æŸ¥&lt;/a>. ç„¶åè°ƒç”¨&lt;code>DiscoveryClient#register()&lt;/code>æ–¹æ³•è¿›è¡Œæ³¨å†Œ.&lt;/p>
&lt;h4 id="äºŒ-è¢«åŠ¨æ³¨å†Œ">äºŒ. è¢«åŠ¨æ³¨å†Œ&lt;/h4>
&lt;p>ä¸Šé¢æåˆ°äº†&lt;code>DiscoveryClient#initScheduledTasks()&lt;/code>, è¿™é‡Œçš„taské™¤äº†&lt;code>InstanceInfoReplicator&lt;/code>ä¹‹å¤–è¿˜æœ‰å…¶ä»–çš„çº¿ç¨‹. å…¶ä¸­ä¸€ä¸ªæ˜¯çº¿æ¡çº¿ç¨‹&lt;code>HeartbeatThread&lt;/code>. è¿™ä¸ªçº¿ç¨‹ä¼šæ¯éš”ä¸€æ®µæ—¶é—´å‘æ³¨å†Œä¸­å¿ƒå‘é€ä¸€ä¸ª&lt;code>PUT&lt;/code>ç±»å‹çš„HTTPè¯·æ±‚: ä¸ŠæŠ¥å®ä¾‹çš„çŠ¶æ€(çŠ¶æ€(status), ä»¥åŠçŠ¶æ€ä¿®æ”¹çš„æ—¶é—´(lastDirtyTimestamp)).&lt;/p>
&lt;p>è¿™ä¸ªè¯·æ±‚å¯èƒ½ä¼šæœ‰ä¸¤ç§ç»“æœ: &lt;code>404&lt;/code>å’Œ&lt;code>200&lt;/code>. å‰è€…è¯´æ˜æ³¨å†Œä¸­å¿ƒä¸­è¿˜æ²¡æœ‰è¿™ä¸ªå®ä¾‹çš„æ³¨å†Œä¿¡æ¯; åè€…è¯´æ˜çŠ¶æ€ä¸ŠæŠ¥æˆåŠŸ.&lt;/p>
&lt;p>å‡å¦‚æ˜¯&lt;code>404&lt;/code>, ä¾¿ç›´æ¥å‘èµ·æ³¨å†Œçš„åŠ¨ä½œ, å³è°ƒç”¨&lt;code>DiscoveryClient#register()&lt;/code>æ–¹æ³•è¿›è¡Œæ³¨å†Œ.&lt;/p>
&lt;h4 id="çŠ¶æ€æ£€æŸ¥">çŠ¶æ€æ£€æŸ¥&lt;/h4>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/28/15459820056548.jpg" alt="">&lt;/p>
&lt;p>&lt;code>CloudEurekaClient&lt;/code>é€šè¿‡&lt;code>HealthCheckHandler&lt;/code>æ¥æ£€æŸ¥å®ä¾‹çš„å¥åº·çŠ¶æ€, çœ‹ä¸‹&lt;code>HealthCheckCallbackToHandlerBridge&lt;/code>å®ç°: callbackä¸ºç©º, æˆ–è€…å½“å‰çŠ¶æ€ä¸º&lt;code>STARTING&lt;/code>æˆ–è€…&lt;code>OUT_OF_SERVICE&lt;/code>æ—¶, è¿”å›å½“å‰çš„çŠ¶æ€. æˆ‘ä»¬æ²¡æœ‰è®¾ç½®callback, æ•…è€Œæ€»æ˜¯ä¼šè¿”å›å½“å‰çš„çŠ¶æ€. æ¯”å¦‚åº”ç”¨å¯åŠ¨çš„åˆå§‹çŠ¶æ€ä¸º&lt;code>STARTING&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="n">InstanceInfo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">InstanceStatus&lt;/span> &lt;span class="nf">getStatus&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">InstanceInfo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">InstanceStatus&lt;/span> &lt;span class="n">currentStatus&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kc">null&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">callback&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">InstanceInfo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">InstanceStatus&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">STARTING&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">currentStatus&lt;/span>
&lt;span class="o">||&lt;/span> &lt;span class="n">InstanceInfo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">InstanceStatus&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">OUT_OF_SERVICE&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">currentStatus&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// Do not go to healthcheck handler if the status is starting or OOS.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">currentStatus&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">callback&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isHealthy&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="n">InstanceInfo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">InstanceStatus&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">UP&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">InstanceInfo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">InstanceStatus&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">DOWN&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="é—®é¢˜åˆ†æ">é—®é¢˜åˆ†æ&lt;/h2>
&lt;h3 id="ç°è±¡">ç°è±¡&lt;/h3>
&lt;h4 id="tcpæŠ“åŒ…">TCPæŠ“åŒ…&lt;/h4>
&lt;p>HeartBeatè¯·æ±‚å’ŒFetchè¯·æ±‚æ­£å¸¸. &lt;code>status=UP&amp;amp;lastDirtyTimestamp=1545039481813&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/28/15459763724617.jpg" alt="">&lt;/p>
&lt;h4 id="å †ä¿¡æ¯">å †ä¿¡æ¯&lt;/h4>
&lt;p>æœ¬åœ°çŠ¶æ€ä¸ºUP, &lt;code>lastDirtyTimestamp&lt;/code>ä¸º1545039481813, &lt;code>lastUpdatedTimestamp&lt;/code>ä¸º1545039472888&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/28/15459778021925.jpg" alt="">&lt;/p>
&lt;h4 id="æ³¨å†Œä¸­å¿ƒé‡Œçš„å®ä¾‹ä¿¡æ¯">æ³¨å†Œä¸­å¿ƒé‡Œçš„å®ä¾‹ä¿¡æ¯&lt;/h4>
&lt;p>çŠ¶æ€ä¸ºSTARTING, &lt;code>lastDirtyTimestamp&lt;/code>ä¸º1545039481813, &lt;code>registrationTimestamp&lt;/code>ä¸º1545039481898, &lt;code>lastUpdatedTimestamp&lt;/code>ä¸º1545039481899&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml"> &lt;span class="nt">&amp;lt;instance&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;instanceId&amp;gt;&lt;/span>xp-xtower-webapp-boot-6-txcxb:xp-xtower-webapp-boot:10100&lt;span class="nt">&amp;lt;/instanceId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;hostName&amp;gt;&lt;/span>10.128.41.74&lt;span class="nt">&amp;lt;/hostName&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;app&amp;gt;&lt;/span>XP-XTOWER-WEBAPP-BOOT&lt;span class="nt">&amp;lt;/app&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;ipAddr&amp;gt;&lt;/span>10.128.41.74&lt;span class="nt">&amp;lt;/ipAddr&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;status&amp;gt;&lt;/span>STARTING&lt;span class="nt">&amp;lt;/status&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;overriddenstatus&amp;gt;&lt;/span>UNKNOWN&lt;span class="nt">&amp;lt;/overriddenstatus&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;port&lt;/span> &lt;span class="na">enabled=&lt;/span>&lt;span class="s">&amp;#34;true&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>10100&lt;span class="nt">&amp;lt;/port&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;securePort&lt;/span> &lt;span class="na">enabled=&lt;/span>&lt;span class="s">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>443&lt;span class="nt">&amp;lt;/securePort&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;countryId&amp;gt;&lt;/span>1&lt;span class="nt">&amp;lt;/countryId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;dataCenterInfo&lt;/span> &lt;span class="na">class=&lt;/span>&lt;span class="s">&amp;#34;com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;name&amp;gt;&lt;/span>MyOwn&lt;span class="nt">&amp;lt;/name&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/dataCenterInfo&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;leaseInfo&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;renewalIntervalInSecs&amp;gt;&lt;/span>5&lt;span class="nt">&amp;lt;/renewalIntervalInSecs&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;durationInSecs&amp;gt;&lt;/span>20&lt;span class="nt">&amp;lt;/durationInSecs&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;registrationTimestamp&amp;gt;&lt;/span>1545039481898&lt;span class="nt">&amp;lt;/registrationTimestamp&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;lastRenewalTimestamp&amp;gt;&lt;/span>1545950719063&lt;span class="nt">&amp;lt;/lastRenewalTimestamp&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;evictionTimestamp&amp;gt;&lt;/span>0&lt;span class="nt">&amp;lt;/evictionTimestamp&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;serviceUpTimestamp&amp;gt;&lt;/span>0&lt;span class="nt">&amp;lt;/serviceUpTimestamp&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/leaseInfo&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;metadata&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;forge&amp;gt;&lt;/span>1.0.0&lt;span class="nt">&amp;lt;/forge&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;management.port&amp;gt;&lt;/span>10100&lt;span class="nt">&amp;lt;/management.port&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jmx.port&amp;gt;&lt;/span>1099&lt;span class="nt">&amp;lt;/jmx.port&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;group&amp;gt;&lt;/span>innovation&lt;span class="nt">&amp;lt;/group&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/metadata&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;homePageUrl&amp;gt;&lt;/span>http://10.128.41.74:10100/&lt;span class="nt">&amp;lt;/homePageUrl&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;statusPageUrl&amp;gt;&amp;lt;/statusPageUrl&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;healthCheckUrl&amp;gt;&lt;/span>http://10.128.41.74:10100/health&lt;span class="nt">&amp;lt;/healthCheckUrl&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;vipAddress&amp;gt;&lt;/span>xp-xtower-webapp-boot&lt;span class="nt">&amp;lt;/vipAddress&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;secureVipAddress&amp;gt;&lt;/span>xp-xtower-webapp-boot&lt;span class="nt">&amp;lt;/secureVipAddress&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;isCoordinatingDiscoveryServer&amp;gt;&lt;/span>false&lt;span class="nt">&amp;lt;/isCoordinatingDiscoveryServer&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;lastUpdatedTimestamp&amp;gt;&lt;/span>1545039481899&lt;span class="nt">&amp;lt;/lastUpdatedTimestamp&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;lastDirtyTimestamp&amp;gt;&lt;/span>1545039481813&lt;span class="nt">&amp;lt;/lastDirtyTimestamp&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;actionType&amp;gt;&lt;/span>ADDED&lt;span class="nt">&amp;lt;/actionType&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/instance&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Scope&lt;/th>
&lt;th>Status&lt;/th>
&lt;th>lastDirtyTimestamp&lt;/th>
&lt;th>lastUpdatedTimestamp&lt;/th>
&lt;th>registrationTimestamp&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Request&lt;/td>
&lt;td>UP&lt;/td>
&lt;td>1545039481813&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Local&lt;/td>
&lt;td>UP&lt;/td>
&lt;td>1545039481813&lt;/td>
&lt;td>1545039472888&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Remote&lt;/td>
&lt;td>STARTING&lt;/td>
&lt;td>1545039481813&lt;/td>
&lt;td>1545039481899&lt;/td>
&lt;td>1545039481898&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>ç»“åˆèµ·æ¥çœ‹, é—®é¢˜å‡ºåœ¨&lt;code>lastDirtyTimestamp&lt;/code>æœªæ›´æ–°, å¯¼è‡´æ³¨å†Œä¸­å¿ƒçš„çŠ¶æ€æœªæ›´æ–°. è€Œ&lt;code>lastUpdatedTimestamp&lt;/code>çš„æ—¶é—´ä¸º1545039481899, ä¸&lt;code>lastDirtyTimestamp&lt;/code>ç›¸å·®&lt;code>86æ¯«ç§’&lt;/code>.&lt;/p>
&lt;p>æœåŠ¡ç«¯&lt;code>InstanceResource#validateDirtyTimestamp()&lt;/code>æ ¹æ®æœ¬åœ°ä¿å­˜çš„å®ä¾‹çš„ä¿¡æ¯, å’Œå¿ƒè·³è¯·æ±‚å‘é€è¿‡æ¥çš„è¯·æ±‚åšæ¯”è¾ƒ, å†³å®šå“åº”çš„çŠ¶æ€ç &lt;code>200&lt;/code>, &lt;code>404&lt;/code>æˆ–è€…&lt;code>409&lt;/code>&lt;/p>
&lt;h3 id="æ¨ç†">æ¨ç†&lt;/h3>
&lt;p>æ³¨å†Œä¸­å¿ƒé‡Œå®ä¾‹çš„çŠ¶æ€ä¸º&lt;code>STARTING&lt;/code>, å¯ä»¥ç¡®å®šå®ä¾‹æ˜¯[è¢«åŠ¨æ³¨å†Œ](#äºŒ. è¢«åŠ¨æ³¨å†Œ)çš„.&lt;/p>
&lt;p>è¿™é‡Œæœ‰å‡ ä¸ªæ—¶é—´ç‚¹:&lt;/p>
&lt;ul>
&lt;li>&lt;code>1545039472888&lt;/code>: &lt;code>InstanceInfo&lt;/code>å¯¹è±¡å®ä¾‹åŒ–çš„æ—¶é—´, å› ä¸ºæœ¬åœ°å¯¹è±¡çš„&lt;code>#lastUpdatedTimestamp&lt;/code>å­—æ®µåªæœ‰åœ¨å®ä¾‹åŒ–æ‰ä¼šèµ‹å€¼, æ­¤åä¸ä¼šè¢«ä¿®æ”¹. è§&lt;a href="#%E5%A0%86%E4%BF%A1%E6%81%AF">å †ä¿¡æ¯&lt;/a>&lt;/li>
&lt;li>&lt;code>1545039481813&lt;/code>: çŠ¶æ€ä»&lt;code>STARTING&lt;/code>å˜ä¸º&lt;code>UP&lt;/code>çš„æ—¶é—´, ä¹Ÿæ˜¯å®ä¾‹çŠ¶æ€çš„æœ€åä¸€æ¬¡æ›´æ–°æ—¶é—´. æ­¤åçš„å¿ƒè·³è¯·æ±‚éƒ½ä¼šå¸¦ä¸Šå®ä¾‹çš„æœ€æ–°çŠ¶æ€(&lt;code>UP&lt;/code>)å’ŒçŠ¶æ€çš„æœ€åä¸€æ¬¡æ›´æ–°æ—¶é—´(&lt;code>1545039481813&lt;/code>), è§&lt;a href="#TCP%E6%8A%93%E5%8C%85">TCPæŠ“åŒ…&lt;/a>.&lt;/li>
&lt;li>&lt;code>1545039481898&lt;/code>: æ³¨å†Œä¸­å¿ƒæ”¶åˆ°å®ä¾‹çš„æ³¨å†Œè¯·æ±‚çš„æ—¶é—´. è§&lt;a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E9%87%8C%E7%9A%84%E5%AE%9E%E4%BE%8B%E4%BF%A1%E6%81%AF">æ³¨å†Œä¸­å¿ƒé‡Œçš„å®ä¾‹ä¿¡æ¯&lt;/a>&lt;/li>
&lt;li>&lt;code>1545039481899&lt;/code>: æ³¨å†Œä¸­å¿ƒä¸­çš„å®ä¾‹ä¿¡æ¯è¢«æ›´æ–°çš„æ—¶é—´. è¿™ä¸ªæ—¶é—´åªæ¯”æ³¨å†Œçš„æ—¶é—´æ™šäº†&lt;em>1æ¯«ç§’&lt;/em>. è§&lt;a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E9%87%8C%E7%9A%84%E5%AE%9E%E4%BE%8B%E4%BF%A1%E6%81%AF">æ³¨å†Œä¸­å¿ƒé‡Œçš„å®ä¾‹ä¿¡æ¯&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ç»¼ä¸Šå¯è§, è¢«åŠ¨æ³¨å†Œæ—¶å‘é€è¯·æ±‚, æ‹¿åˆ°çš„å®ä¾‹çš„æ—§çš„çŠ¶æ€&lt;code>STARTING&lt;/code>, ä¿®æ”¹æ—¶é—´ç¡®å®æœ€æ–°çš„&lt;code>1545039481813&lt;/code>. åç»­çš„å¿ƒè·³ä¸ŠæŠ¥å®ä¾‹çŠ¶æ€ä¸ºæœ€æ–°çš„&lt;code>UP&lt;/code>, ä¿®æ”¹æ—¶é—´ä¹Ÿæ˜¯æœ€æ–°çš„&lt;code>1545039481813&lt;/code>. ä½†æ˜¯ç”±äºæœ€åä¿®æ”¹æ—¶é—´ä¸æ³¨å†Œæ—¶çš„æœ€åä¿®æ”¹æ—¶é—´ç›¸åŒ, å³ä½¿çŠ¶æ€å·²ç»å˜ä¸º&lt;code>UP&lt;/code>, æ³¨å†Œä¸­å¿ƒåœ¨æ”¶åˆ°å¿ƒè·³è¯·æ±‚ä¹‹åä¹Ÿä¸ä¼šå°†çŠ¶æ€æ›´æ–°ä¸º&lt;code>UP&lt;/code>.&lt;/p>
&lt;p>æœåŠ¡ç«¯&lt;code>InstanceResource#renewLease()&lt;/code> -&amp;gt; &lt;code>InstanceResource#validateDirtyTimestamp()&lt;/code>: å¦‚æœè¯·æ±‚ä¸­çš„&lt;code>lastDirtyTimestamp&lt;/code>ä¸å½“å‰ä¿å­˜çš„å®ä¾‹çš„ç›¸åŒ, åˆ™ç›´æ¥è¿”å›OK, ä¸ä¼šæ›´æ–°æ³¨å†Œä¸­å¿ƒä¸­ä¿å­˜çš„å®ä¾‹çš„çŠ¶æ€.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">private&lt;/span> &lt;span class="n">Response&lt;/span> &lt;span class="nf">validateDirtyTimestamp&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Long&lt;/span> &lt;span class="n">lastDirtyTimestamp&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="kt">boolean&lt;/span> &lt;span class="n">isReplication&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">InstanceInfo&lt;/span> &lt;span class="n">appInfo&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">registry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInstanceByAppAndId&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">appInfo&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">((&lt;/span>&lt;span class="n">lastDirtyTimestamp&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">lastDirtyTimestamp&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">appInfo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getLastDirtyTimestamp&lt;/span>&lt;span class="o">())))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Object&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">appInfo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getLastDirtyTimestamp&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">lastDirtyTimestamp&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">isReplication&lt;/span>&lt;span class="o">};&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">lastDirtyTimestamp&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">appInfo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getLastDirtyTimestamp&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">logger&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="s">&amp;#34;Time to sync, since the last dirty timestamp differs -&amp;#34;&lt;/span>
&lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; ReplicationInstance id : {},Registry : {} Incoming: {} Replication: {}&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">status&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Status&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">NOT_FOUND&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">appInfo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getLastDirtyTimestamp&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">lastDirtyTimestamp&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// In the case of replication, send the current instance info in the registry for the
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// replicating node to sync itself with this one.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">isReplication&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">logger&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="s">&amp;#34;Time to sync, since the last dirty timestamp differs -&amp;#34;&lt;/span>
&lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; ReplicationInstance id : {},Registry : {} Incoming: {} Replication: {}&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">status&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Status&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">CONFLICT&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">entity&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">appInfo&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ok&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ok&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µ">ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µ?&lt;/h4>
&lt;p>åº”ç”¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹ä¼šè§¦å‘&lt;strong>æ³¨å†Œ&lt;/strong>çš„åŠ¨ä½œ&lt;/p>
&lt;ol>
&lt;li>&lt;code>InstanceInfoReplicator&lt;/code>çº¿ç¨‹: &lt;code>DiscoveryClient&lt;/code>ä¸­çš„&lt;code>ApplicationInfoManager.StatusChangeListener&lt;/code>ç›‘å¬åˆ°å®ä¾‹çŠ¶æ€å‘ç”Ÿå˜åŒ–, ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹å°†å®ä¾‹æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ&lt;/li>
&lt;li>&lt;code>DiscoveryClient$HeartbeatThread&lt;/code>çº¿ç¨‹: è¿™ä¸ªçº¿ç¨‹åœ¨&lt;code>DiscoveryClient&lt;/code>å®ä¾‹åˆå§‹åŒ–åå»¶è¿Ÿ(ä¸å¿ƒè·³é—´éš”æ—¶é—´ç›¸åŒ, é»˜è®¤æ˜¯&lt;code>30s&lt;/code>, ä¸­å°ä¸ºæé«˜å®ä¾‹å‘ç°æ•ˆç‡å°†å…¶æ”¹ä¸ºäº†&lt;code>5s&lt;/code>)å¯åŠ¨è¿è¡Œ. ç¬¬ä¸€æ¬¡å‘é€å¿ƒè·³è¯·æ±‚æ˜¯å¦‚æœæ³¨å†Œä¸­å¿ƒè¿”å›&lt;strong>404&lt;/strong>(è¯´æ˜å¿ƒè·³çº¿ç¨‹æå®ä¾‹çŠ¶æ€æ›´æ–°çº¿ç¨‹å…ˆå¯åŠ¨), åˆ™ä¼šå…ˆå°†å®ä¾‹æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ.&lt;/li>
&lt;/ol>
&lt;p>ä¸Šé¢ä¸¤ä¸ªçº¿ç¨‹éƒ½é€šè¿‡è°ƒç”¨&lt;code>AbstractJerseyEurekaHttpClient$register()&lt;/code>æ–¹æ³•å¹¶ä½¿ç”¨&lt;code>EurekaJacksonCodec$InstanceInfoSerializer&lt;/code>å°†å®ä¾‹ä¿¡æ¯åºåˆ—åŒ–. åºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­&lt;strong>å…ˆè®°å½•å®ä¾‹çš„çŠ¶æ€åè®°å½•å®ä¾‹çŠ¶æ€çš„æœ€åä¿®æ”¹æ—¶é—´(lastDirtyTimestamp)&lt;/strong>, è¿™ä¸¤ä¸ªæ“ä½œä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œ.&lt;/p>
&lt;p>éå¸¸æç«¯çš„æƒ…å†µä¸‹(&lt;strong>ç¼©å°å¿ƒè·³é—´éš”å¢åŠ äº†å‡ºç°çš„æ¦‚ç‡, ä½†ä¾ç„¶æåœ°&lt;/strong>), ä¸¤ä¸ªæ“ä½œä¹‹é—´(å¿ƒè·³çº¿ç¨‹å…ˆæ‹¿åˆ°å®ä¾‹çŠ¶æ€&lt;code>STARTING&lt;/code>)ä¸»çº¿ç¨‹ä¿®æ”¹äº†å®ä¾‹çŠ¶æ€ä¸º&lt;code>UP&lt;/code>, åŒæ—¶ä¿®æ”¹äº†&lt;code>lastDirtyTimestamp&lt;/code>, å¹¶è§¦å‘äº†&lt;code>InstanceInfoReplicator&lt;/code>çº¿ç¨‹çš„æ³¨å†Œæ“ä½œ, æ­¤æ—¶å¿ƒè·³çº¿ç¨‹è·å–åˆ°çš„å®ä¾‹çš„æœ€åä¿®æ”¹æ—¶é—´ä¸&lt;code>STARTING&lt;/code>çŠ¶æ€å¹¶ä¸ä¸€è‡´. ä¹‹ååŒæ ·æ³¨å†ŒåŠ¨ä½œè¦†ç›–äº†å®ä¾‹åœ¨æ³¨å†Œä¸­å¿ƒçš„çŠ¶æ€: &lt;code>UP -&amp;gt; STARTING&lt;/code>.&lt;/p>
&lt;p>åç»­çš„å¿ƒè·³è¯·æ±‚å¸¦å»çš„æœ€æ–°çŠ¶æ€&lt;code>UP&lt;/code>å’Œ&lt;code>lastDirtyTimestamp&lt;/code>, å¹¶ä¸ä¼šæ›´æ–°åœ¨æ³¨å†Œä¸­å¿ƒçš„çŠ¶æ€.&lt;/p>
&lt;h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ&lt;/h2>
&lt;p>åœ¨&lt;code>EurekaJacksonCodec$InstanceInfoSerializer#serialize()&lt;/code>æ–¹æ³•ä¸­, å°†&lt;code>#autoMarshalEligible()&lt;/code> çš„è°ƒç”¨ç§»åˆ°&lt;code>jgen.writeStartObject()&lt;/code>åé¢. è¿™æ ·å°±ä½¿å¾—&lt;code>lastDirtyTimestamp&lt;/code>çš„è·å–æ¯”&lt;code>status&lt;/code>æ—©, å°±èƒ½ä¿è¯å³ä½¿æ³¨å†Œæ—¶çš„&lt;code>lastDirtyTimestamp&lt;/code>å°äºçœŸæ­£çš„, ä½†æ˜¯çŠ¶æ€æ˜¯ä¸å®é™…ç›¸ç¬¦. &lt;code>lastDirtyTimestamp&lt;/code>ä¼šåœ¨åç»­çš„å¿ƒè·³è¯·æ±‚ä¸­æ›´æ–°.
&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/28/15476421041186.jpg" alt="">&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">addInstance-info.getStatus(): UP
addInstance-info.getLastDirtyTimestamp(): 1565164484429
addInstance-info.getStatus(): STARTING
addInstance-info.getLastDirtyTimestamp(): 1565164484415
renew-status-in-registry: UP
renew-lastDirtyTimestamp: 1565164484429
renew-appInfo.getLastDirtyTimestamp(): 1565164484429
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;a href="https://github.com/Netflix/eureka/pull/1229">PR&lt;/a> å·²ç»æäº¤å¹¶åˆå¹¶å®Œæˆï¼Œç„¶è€Œ 1.7.x çš„ç‰ˆæœ¬ä¸çŸ¥ä½•æ—¶ä¼šå‘å¸ƒä¿®å¤ç‰ˆæœ¬&lt;/p>
&lt;p>å‚è€ƒ:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/Netflix/eureka/issues/1174">GitHub issue&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/Netflix/eureka/pull/1229">PR&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Tekton çš„å·¥ä½œåŸç†</title><link>https://atbug.com/how-tekton-works/</link><pubDate>Sat, 23 May 2020 22:47:14 +0800</pubDate><guid>https://atbug.com/how-tekton-works/</guid><description>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/24/tekton.jpeg" alt="tekton">&lt;/p>
&lt;p>&lt;em>è¿™ç¯‡æ–‡ç« æ˜¯åŸºäº Tekton Pipeline çš„æœ€æ–°ç‰ˆæœ¬&lt;code>v0.12.1&lt;/code>ç‰ˆæœ¬ã€‚&lt;/em>&lt;/p>
&lt;p>å¿«é€Ÿå…¥é—¨è¯·å‚è€ƒï¼š&lt;a href="https://atbug.com/tekton-trigger-practice/">äº‘åŸç”Ÿ CICD: Tekton Pipeline å®æˆ˜&lt;/a> ï¼Œ&lt;em>å®æˆ˜æ˜¯åŸºäºç‰ˆæœ¬ v0.10.x&lt;/em>ã€‚&lt;/p>
&lt;h2 id="pipeline-crd-ä¸æ ¸å¿ƒèµ„æºçš„å…³ç³»">Pipeline CRD ä¸æ ¸å¿ƒèµ„æºçš„å…³ç³»&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ k api-resources --api-group&lt;span class="o">=&lt;/span>tekton.dev
NAME SHORTNAMES APIGROUP NAMESPACED KIND
clustertasks tekton.dev &lt;span class="nb">false&lt;/span> ClusterTask
conditions tekton.dev &lt;span class="nb">true&lt;/span> Condition
pipelineresources tekton.dev &lt;span class="nb">true&lt;/span> PipelineResource
pipelineruns pr,prs tekton.dev &lt;span class="nb">true&lt;/span> PipelineRun
pipelines tekton.dev &lt;span class="nb">true&lt;/span> Pipeline
taskruns tr,trs tekton.dev &lt;span class="nb">true&lt;/span> TaskRun
tasks tekton.dev &lt;span class="nb">true&lt;/span> Task
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Tekton Pipelinesæä¾›äº†ä¸Šé¢çš„CRDï¼Œå…¶ä¸­éƒ¨åˆ†CRDä¸k8s coreä¸­èµ„æºç›¸å¯¹åº”&lt;/p>
&lt;ul>
&lt;li>Task =&amp;gt; Pod&lt;/li>
&lt;li>Task.Step =&amp;gt; Container&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/15902164552270.jpg" alt="">&lt;/p>
&lt;h2 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/15902280074872.jpg" alt="">
(å›¾ç‰‡æ¥è‡ª)&lt;/p>
&lt;p>Tekton Pipeline æ˜¯åŸºäº Knative çš„å®ç°ï¼Œpod &lt;code>tekton-pipelines-controller&lt;/code> ä¸­æœ‰ä¸¤ä¸ª &lt;a href="https://knative.dev/docs/eventing/samples/writing-receive-adapter-source/03-controller/">Knative Controller&lt;/a>çš„å®ç°ï¼šPipelineRun å’Œ TaskRunã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/15902270934199.jpg" alt="">&lt;/p>
&lt;h3 id="taskçš„æ‰§è¡Œé¡ºåº">Taskçš„æ‰§è¡Œé¡ºåº&lt;/h3>
&lt;p>PipelineRun Controller çš„ &lt;code>#reconcile()&lt;/code>æ–¹æ³•ï¼Œç›‘æ§åˆ°æœ‰&lt;code>PipelineRun&lt;/code>è¢«åˆ›å»ºã€‚ç„¶åä»&lt;code>PipelineSpec&lt;/code>çš„ tasks åˆ—è¡¨ï¼Œæ„å»ºå‡ºä¸€ä¸ªå›¾ï¼ˆ&lt;code>graph&lt;/code>ï¼‰ï¼Œç”¨äºæè¿°&lt;code>Pipeline&lt;/code>ä¸­ Task é—´çš„ä¾èµ–å…³ç³»ã€‚ä¾èµ–å…³ç³»æ˜¯é€šè¿‡&lt;code>runAfter&lt;/code>å’Œ&lt;code>from&lt;/code>ï¼Œè¿›è€Œæ§åˆ¶&lt;a href="#Task%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F">Taskçš„æ‰§è¡Œé¡ºåº&lt;/a>ã€‚ä¸æ­¤åŒæ—¶ï¼Œå‡†å¤‡&lt;code>PipelineRun&lt;/code>ä¸­å®šä¹‰çš„&lt;code>PipelineResources&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Node represents a Task in a pipeline.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Node&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Task represent the PipelineTask in Pipeline
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Task&lt;/span> &lt;span class="nx">Task&lt;/span>
&lt;span class="c1">// Prev represent all the Previous task Nodes for the current Task
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Prev&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Node&lt;/span>
&lt;span class="c1">// Next represent all the Next task Nodes for the current Task
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Next&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Node&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Graph represents the Pipeline Graph
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Graph&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//Nodes represent map of PipelineTask name to Node in Pipeline Graph
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Nodes&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Node&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Build&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tasks&lt;/span> &lt;span class="nx">Tasks&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Graph&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>PipelineRun&lt;/code>ä¸­å®šä¹‰çš„å‚æ•°ï¼ˆparametersï¼‰ä¹Ÿä¼šæ³¨å…¥åˆ°&lt;code>PipelineSpec&lt;/code>ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">pipelineSpec&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">resources&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ApplyParameters&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pipelineSpec&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨&lt;code>dag#GetSchedulable()&lt;/code>æ–¹æ³•ï¼Œè·å–æœªå®Œæˆï¼ˆé€šè¿‡TaskçŠ¶æ€åˆ¤æ–­ï¼‰çš„ Task åˆ—è¡¨ï¼›&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">GetSchedulable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Graph&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">doneTasks&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">struct&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸º Task A åˆ›å»º&lt;code>TaskRun&lt;/code>ï¼Œå‡å¦‚&lt;code>Task&lt;/code>é…ç½®äº†&lt;code>Condition&lt;/code>ã€‚ä¼šå…ˆä¸º conditionåˆ›å»ºä¸€ä¸ª&lt;code>TaskRun&lt;/code>ï¼Œåªæœ‰åœ¨ condition çš„&lt;code>TaskRun&lt;/code>è¿è¡ŒæˆåŠŸï¼Œæ‰ä¼šè¿è¡Œ A çš„&lt;code>TaskRun&lt;/code>ï¼›å¦åˆ™å°±è·³è¿‡ã€‚&lt;/p>
&lt;h3 id="stepçš„æ‰§è¡Œé¡ºåº">Stepçš„æ‰§è¡Œé¡ºåº&lt;/h3>
&lt;p>è¿™ä¸€éƒ¨åˆ†ç¯‡å¹…è¾ƒé•¿ï¼Œä¹‹å‰çš„æ–‡ç«  &lt;a href="https://atbug.com/control-process-order-of-pod-containers/">æ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº&lt;/a> ä¸­æåˆ°è¿‡ã€‚&lt;/p>
&lt;p>è¿™é‡Œè¡¥å……ä¸€ä¸‹&lt;a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/#the-downward-api">Kubernetes Downward API&lt;/a>çš„ä½¿ç”¨ï¼ŒKubernetes Downward APIçš„å¼•å…¥ï¼Œæ§åˆ¶ç€ &lt;code>Task&lt;/code> çš„ç¬¬ä¸€ä¸ª &lt;code>Step&lt;/code> åœ¨ä½•æ—¶æ‰§è¡Œã€‚&lt;/p>
&lt;p>&lt;code>TaskRun&lt;/code> Controller åœ¨ reconciling çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨ç›¸åº”çš„ &lt;code>Pod&lt;/code> çŠ¶æ€å˜ä¸º&lt;code>Running&lt;/code>æ—¶ï¼Œä¼šå°†&lt;code>tekton.dev/ready=READY&lt;/code>å†™å…¥åˆ° Pod çš„ annotation ä¸­ï¼Œæ¥é€šçŸ¥ç¬¬ä¸€ä¸ª&lt;code>Step&lt;/code>çš„æ‰§è¡Œã€‚&lt;/p>
&lt;p>Podçš„éƒ¨åˆ†å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">wait_file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/downward/ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">wait_file_content&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">post_file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/tools/0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">termination_path&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/termination&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/ko-app/git-init&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- --&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ssh://git@gitlab.nip.io:8022/addozhang/logan-pulse.git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">develop&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">path&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/workspace/git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/tools/entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/tekton/downward&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-internal-downward&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">downwardAPI&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">defaultMode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">420&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">items&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">fieldRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">metadata.annotations[&amp;#39;tekton.dev/ready&amp;#39;]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-internal-downward&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹åŸç”Ÿçš„æ’åºstep containerè¿›ä¸€æ­¥å¤„ç†ï¼šå¯åŠ¨å‘½ä»¤ä½¿ç”¨&lt;code>entrypoint&lt;/code>æä¾›ï¼Œå¹¶è®¾ç½®æ‰§è¡Œå‚æ•°ï¼š&lt;/p>
&lt;p>&lt;code>entrypoint.go&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">orderContainers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">entrypointImage&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">steps&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">results&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">v1alpha1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TaskResult&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">initContainer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;place-tools&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Image&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">entrypointImage&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Command&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;cp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;/ko-app/entrypoint&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">entrypointBinary&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="nx">VolumeMounts&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumeMount&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">toolsMount&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">steps&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">corev1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;No steps specified&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">steps&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">argsForEntrypoint&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">argsForEntrypoint&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="c1">// First step waits for the Downward volume file.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="s">&amp;#34;-wait_file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">downwardMountPoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">downwardMountReadyFile&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="s">&amp;#34;-wait_file_content&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// Wait for file contents, not just an empty file.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// Start next step.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="s">&amp;#34;-post_file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mountPoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="s">&amp;#34;-termination_path&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">terminationPath&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1">// All other steps wait for previous file, write next file.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">argsForEntrypoint&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="s">&amp;#34;-wait_file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mountPoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="s">&amp;#34;-post_file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mountPoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="s">&amp;#34;-termination_path&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">terminationPath&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è‡ªåŠ¨è¿è¡Œçš„å®¹å™¨">è‡ªåŠ¨è¿è¡Œçš„å®¹å™¨&lt;/h3>
&lt;p>è¿™äº›è‡ªåŠ¨è¿è¡Œçš„å®¹å™¨ä½œä¸º pod çš„&lt;code>initContainer&lt;/code>ä¼šåœ¨ step å®¹å™¨è¿è¡Œä¹‹å‰è¿è¡Œ&lt;/p>
&lt;h4 id="credential-initializer">&lt;code>credential-initializer&lt;/code>&lt;/h4>
&lt;p>ç”¨äºå°† &lt;code>ServiceAccount&lt;/code> çš„ç›¸å…³secretsæŒä¹…åŒ–åˆ°å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚æ¯”å¦‚ ssh ç›¸å…³ç§˜é’¥ã€configæ–‡ä»¶ä»¥åŠknow_hostsæ–‡ä»¶ï¼›docker registry ç›¸å…³çš„å‡­è¯åˆ™ä¼šè¢«å†™å…¥åˆ° docker çš„é…ç½®æ–‡ä»¶ä¸­ã€‚&lt;/p>
&lt;h4 id="working-dir-initializer">&lt;code>working-dir-initializer&lt;/code>&lt;/h4>
&lt;p>æ”¶é›†&lt;code>Task&lt;/code>å†…çš„å„ä¸ª&lt;code>Step&lt;/code>çš„&lt;code>workingDir&lt;/code>é…ç½®ï¼Œåˆå§‹åŒ–ç›®å½•ç»“æ„&lt;/p>
&lt;h4 id="place-scripts">&lt;code>place-scripts&lt;/code>&lt;/h4>
&lt;p>å‡å¦‚&lt;code>Step&lt;/code>ä½¿ç”¨çš„æ˜¯&lt;code>script&lt;/code>é…ç½®ï¼ˆä¸command+argsç›¸å¯¹ï¼‰ï¼Œè¿™ä¸ªå®¹å™¨ä¼šå°†è„šæœ¬ä»£ç ï¼ˆ&lt;code>script&lt;/code>å­—æ®µçš„å†…å®¹ï¼‰æŒä¹…åŒ–åˆ°&lt;code>/tekton/scripts&lt;/code>ç›®å½•ä¸­ã€‚&lt;/p>
&lt;p>æ³¨ï¼šæ‰€æœ‰çš„è„šæœ¬ä¼šè‡ªåŠ¨åŠ ä¸Š&lt;code>#!/bin/sh\nset -xe\n&lt;/code>ï¼Œæ‰€ä»¥&lt;code>script&lt;/code>å­—æ®µé‡Œå°±ä¸å¿…å†™äº†ã€‚&lt;/p>
&lt;h4 id="place-tools">&lt;code>place-tools&lt;/code>&lt;/h4>
&lt;p>å°†&lt;code>entrypoint&lt;/code>çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¤åˆ¶åˆ°&lt;code>/tekton/tools/entrypoint&lt;/code>.&lt;/p>
&lt;h3 id="taskstepé—´çš„æ•°æ®ä¼ é€’">Task/Stepé—´çš„æ•°æ®ä¼ é€’&lt;/h3>
&lt;p>é’ˆå¯¹ä¸åŒçš„æ•°æ®ï¼Œæœ‰å¤šç§ä¸åŒçš„é€‰æ‹©ã€‚æ¯”å¦‚&lt;code>Workspace&lt;/code>ã€&lt;code>Result&lt;/code>ã€&lt;code>PipelineResource&lt;/code>ã€‚å¯¹äºç”±äº&lt;code>Task&lt;/code>çš„æ‰§è¡Œæ˜¯é€šè¿‡&lt;code>Pod&lt;/code>æ¥å®Œæˆçš„ï¼Œè€Œ&lt;code>Pod&lt;/code>ä¼šè°ƒåº¦åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šã€‚å› æ­¤&lt;code>Task&lt;/code>é—´çš„æ•°æ®ä¼ é€’ï¼Œéœ€è¦ç”¨åˆ°æŒä¹…åŒ–çš„å·ã€‚&lt;/p>
&lt;p>è€Œ&lt;code>Step&lt;/code>ä½œä¸º&lt;code>Pod&lt;/code>ä¸­çš„å®¹å™¨æ¥è¿è¡Œï¼Œ&lt;/p>
&lt;h4 id="workspace">Workspace&lt;/h4>
&lt;p>å·¥ä½œåŒºï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæŒ‚åœ¨åˆ°å®¹å™¨ä¸Šçš„å·ï¼Œç”¨äºæ–‡ä»¶çš„ä¼ é€’ã€‚&lt;/p>
&lt;h5 id="persistentvolumeclaim">&lt;code>persistentVolumeClaim&lt;/code>&lt;/h5>
&lt;p>å¼•ç”¨å·²å­˜åœ¨&lt;code>persistentVolumeClaim&lt;/code>å·ï¼ˆvolumeï¼‰ã€‚è¿™ç§å·¥ä½œç©ºé—´ï¼Œå¯å¤šæ¬¡ä½¿ç”¨ï¼Œéœ€è¦å…ˆè¿›è¡Œåˆ›å»ºã€‚æ¯”å¦‚ Java é¡¹ç›®çš„ &lt;code>maven&lt;/code>ï¼Œç¼–è¯‘éœ€è¦æœ¬åœ°ä¾èµ–åº“ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœæ¯æ¬¡ç¼–è¯‘éƒ½è¦ä¸‹è½½ä¾èµ–åŒ…çš„æˆæœ¬ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeClaim&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">claimName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2-pv-claim&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolume&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2-pv&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">local&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">manual&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">capacity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">10Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteMany&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/data/.m2&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolumeClaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">m2-pv-claim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">manual&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># volumeName: m2-pv&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteMany&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">10Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="volumeclaimtemplate">&lt;code>volumeClaimTemplate&lt;/code>&lt;/h5>
&lt;p>ä¸ºæ¯ä¸ª&lt;code>PipelineRun&lt;/code>æˆ–è€…&lt;code>TaskRun&lt;/code>åˆ›å»º&lt;code>PersistentVolumeClaim&lt;/code>å·ï¼ˆvolumeï¼‰çš„æ¨¡æ¿ã€‚æ¯”å¦‚ä¸€æ¬¡æ„å»ºéœ€è¦ä» git ä»“åº“å…‹éš†ä»£ç ï¼Œè€Œé’ˆå¯¹ä¸åŒçš„æµæ°´çº¿ä»£ç ä»“åº“æ˜¯ä¸åŒçš„ã€‚è¿™é‡Œå°±ä¼šç”¨åˆ°&lt;code>volumeClaimTemplate&lt;/code>ï¼Œä¸ºæ¯æ¬¡æ„å»ºåˆ›å»ºä¸€ä¸ª&lt;code>PersistentVolumeClaim&lt;/code>å·ã€‚ï¼ˆä»0.12.0å¼€å§‹ï¼‰&lt;/p>
&lt;p>ç”Ÿå‘½å‘¨æœŸåŒ&lt;code>PipelineRun&lt;/code>æˆ–è€…&lt;code>TaskRun&lt;/code>ï¼Œè¿è¡Œä¹‹åé‡Šæ”¾ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeClaimTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteMany&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">1Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç›¸è¾ƒäº&lt;code>persistantVolumeClain&lt;/code>ç±»å‹çš„workspaceï¼Œ&lt;code>volumeClaimTemplate&lt;/code>ä¸éœ€è¦åœ¨æ¯æ¬¡åœ¨&lt;code>PipelineRun&lt;/code>å®Œæˆåæ¸…ç†å·¥ä½œåŒºï¼›å¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚&lt;/p>
&lt;h5 id="emptydir">&lt;code>emptyDir&lt;/code>&lt;/h5>
&lt;p>å¼•ç”¨&lt;code>emptyDir&lt;/code>å·ï¼Œè·Ÿéš&lt;code>Task&lt;/code>ç”Ÿå‘½å‘¨æœŸçš„ä¸´æ—¶ç›®å½•ã€‚é€‚åˆåœ¨&lt;code>Task&lt;/code>çš„&lt;code>Step&lt;/code>é—´å…±äº«æ•°æ®ï¼Œæ— æ³•åœ¨å¤šä¸ª&lt;code>Task&lt;/code>é—´å…±äº«ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">temp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">emptyDir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="configmap">&lt;code>configMap&lt;/code>&lt;/h5>
&lt;p>å¼•ç”¨ä¸€ä¸ª&lt;code>configMap&lt;/code>å·ï¼Œå°†&lt;code>configMap&lt;/code>å·ä½œä¸ºå·¥ä½œåŒºï¼Œæœ‰å¦‚ä¸‹é™åˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>æŒ‚è½½çš„å·æ˜¯&lt;code>åªè¯»&lt;/code>çš„&lt;/li>
&lt;li>éœ€è¦æå‰åˆ›å»º&lt;code>configMap&lt;/code>&lt;/li>
&lt;li>&lt;code>configMap&lt;/code>çš„&lt;a href="https://github.com/kubernetes/kubernetes/blob/f16bfb069a22241a5501f6fe530f5d4e2a82cf0e/pkg/apis/core/validation/validation.go#L5042">å¤§å°é™åˆ¶ä¸º1MBï¼ˆK8sçš„é™åˆ¶ï¼‰&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ä½¿ç”¨åœºæ™¯ï¼Œæ¯”å¦‚ä½¿ç”¨&lt;code>maven&lt;/code>ç¼–è¯‘Javaé¡¹ç›®ï¼Œé…ç½®æ–‡ä»¶&lt;code>settings.xml&lt;/code>å¯ä»¥ä½¿ç”¨&lt;code>configMap&lt;/code>ä½œä¸ºå·¥ä½œåŒº&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">workspaces&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven-settings&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">configmap&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven-settings&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="secret">&lt;code>secret&lt;/code>&lt;/h5>
&lt;p>ç”¨äºå¼•ç”¨&lt;code>secret&lt;/code>å·ï¼ŒåŒ&lt;code>configMap&lt;/code>å·¥ä½œåŒºä¸€æ ·ï¼Œä¹Ÿæœ‰é™åˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>æŒ‚è½½çš„å·æ˜¯&lt;code>åªè¯»&lt;/code>çš„&lt;/li>
&lt;li>éœ€è¦æå‰åˆ›å»º&lt;code>secret&lt;/code>&lt;/li>
&lt;li>&lt;code>secret&lt;/code>çš„&lt;a href="https://github.com/kubernetes/kubernetes/blob/f16bfb069a22241a5501f6fe530f5d4e2a82cf0e/pkg/apis/core/validation/validation.go#L5042">å¤§å°é™åˆ¶ä¸º1MBï¼ˆK8sçš„é™åˆ¶ï¼‰&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="result">Result&lt;/h4>
&lt;p>&lt;code>results&lt;/code>å­—æ®µå¯ä»¥ç”¨æ¥é…ç½®å¤šä¸ªæ–‡ä»¶ç”¨æ¥å­˜å‚¨&lt;code>Tasks&lt;/code>çš„æ‰§è¡Œç»“æœï¼Œè¿™äº›æ–‡ä»¶ä¿å­˜åœ¨&lt;code>/tekton/results&lt;/code>ç›®å½•ä¸­ã€‚&lt;/p>
&lt;p>åœ¨&lt;code>Pipeline&lt;/code>ä¸­ï¼Œå¯ä»¥é€šè¿‡&lt;code>tasks.[task-nanme].results.[result-name]&lt;/code>æ³¨å…¥åˆ°å…¶ä»–&lt;code>Task&lt;/code>çš„å‚æ•°ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Task&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">A simple task that prints the date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">results&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-unix-timestamp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The current date in unix timestamp format&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-human-readable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The current date in human readable format&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date-unix-timestamp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">bash:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> #!/usr/bin/env bash
&lt;/span>&lt;span class="sd"> date +%s | tee $(results.current-date-unix-timestamp.path)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date-humman-readable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">bash:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> #!/usr/bin/env bash
&lt;/span>&lt;span class="sd"> date | tee $(results.current-date-human-readable.path)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PipelineRun&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pass-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">pipelineSpec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">print-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">read-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">runAfter&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#é…ç½®æ‰§è¡Œé¡ºåº&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">print-date&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskSpec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-unix-timestamp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">string&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-human-readable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">string&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">read&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">busybox&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> echo $(params.current-date-unix-timestamp)
&lt;/span>&lt;span class="sd"> echo $(params.current-date-human-readable)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-unix-timestamp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(tasks.print-date.results.current-date-unix-timestamp)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># æ³¨å…¥å‚æ•°&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">current-date-human-readable&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(tasks.print-date.results.current-date-human-readable)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># æ³¨å…¥å‚æ•° &lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">â”Œâ”€â”€â”€â”€â”€â”€Logs(tekton-pipelines/pass-date-read-date-rhlf2-pod-9b2sk)[all] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ place-scripts stream closed â”‚â”‚ step-read 1590242170 â”‚
â”‚ step-read Sat May 23 13:56:10 UTC 2020 â”‚â”‚ step-read + echo 1590242170 â”‚
â”‚ step-read + echo Sat May 23 13:56:10 UTC 2020 â”‚
â”‚ place-tools stream closed â”‚
â”‚ step-read stream closed â”‚
â”‚
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="pipelineresource">PipelineResource&lt;/h4>
&lt;p>&lt;code>PipelineResource&lt;/code>åœ¨æœ€åæï¼Œå› ä¸ºç›®å‰åªæ˜¯&lt;code>alpha&lt;/code>ç‰ˆæœ¬ï¼Œä½•æ—¶ä¼šè¿›å…¥&lt;code>beta&lt;/code>æˆ–è€…å¼ƒç”¨ç›®å‰è¿˜æ˜¯æœªçŸ¥æ•°ã€‚æœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸‹è¿™é‡Œï¼š&lt;a href="https://tekton.dev/docs/pipelines/resources/#why-aren-t-pipelineresources-in-beta">Why Arenâ€™t PipelineResources in Beta?&lt;/a>&lt;/p>
&lt;p>ç®€å•æ¥è¯´ï¼Œ&lt;code>PipelineResource&lt;/code>å¯ä»¥é€šè¿‡å…¶ä»–çš„æ–¹å¼å®ç°ï¼Œè€Œå…¶æœ¬èº«ä¹Ÿå­˜åœ¨å¼Šç«¯ï¼šæ¯”å¦‚å®ç°ä¸é€æ˜ï¼Œdebugæœ‰éš¾åº¦ï¼›åŠŸèƒ½ä¸å¤Ÿå¼ºï¼›é™ä½äº†Taskçš„é‡ç”¨æ€§ç­‰ã€‚&lt;/p>
&lt;p>æ¯”å¦‚&lt;code>git&lt;/code>ç±»å‹çš„&lt;code>PipelineResource&lt;/code>ï¼Œå¯ä»¥é€šè¿‡&lt;code>workspace&lt;/code>å’Œ&lt;code>git-clone&lt;/code> Taskæ¥å®ç°ï¼›å­˜å‚¨ç±»å‹çš„ï¼Œä¹Ÿå¯ä»¥é€šè¿‡&lt;code>workspace&lt;/code>æ¥å®ç°ã€‚&lt;/p>
&lt;p>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ&lt;a href="#Workspace">ä¸Šé¢ä»‹ç»workspaceçš„ç¯‡å¹…&lt;/a>æ¯”è¾ƒå¤§ã€‚ä¸ªäººä¹Ÿåå‘äºä½¿ç”¨&lt;code>workspace&lt;/code>ï¼Œçµæ´»åº¦é«˜ï¼›ä½¿ç”¨workspaceçš„Taské‡ç”¨æ€§å¼ºã€‚&lt;/p>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://atbug.com/tekton-trigger-practice">äº‘åŸç”Ÿ CICD: Tekton Pipeline å®æˆ˜&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://atbug.com/control-process-order-of-pod-containers">æ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://knative.dev/docs/eventing/samples/writing-receive-adapter-source/03-controller">Knative Controller&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tekton.dev/docs/pipelines/resources/#why-aren-t-pipelineresources-in-beta">Why Arenâ€™t PipelineResources in Beta?&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Java ä¸­çš„ Mysql æ—¶åŒºé—®é¢˜</title><link>https://atbug.com/mysql-timezone-in-java/</link><pubDate>Thu, 14 May 2020 11:34:24 +0800</pubDate><guid>https://atbug.com/mysql-timezone-in-java/</guid><description>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/14/anonymouspersonwithminiatureairplaneonchalkboard37.jpg" alt="anonymous-person-with-miniature-airplane-on-chalkboard-3769120">&lt;/p>
&lt;p>&lt;em>(Photo by Andrea Piacquadio from Pexels)&lt;/em>&lt;/p>
&lt;p>è¯è¯´å·¥ä½œåå¤šå¹´ï¼Œmysql è¿˜çœŸæ²¡ç”¨å‡ å¹´ã€‚èµ·åˆæ˜¯å¤–ä¼é“¶è¡Œï¼Œæ— æ³•ç›´æ¥æ¥è§¦åˆ° DBï¼›åæ¥ä¸€ç›´ä»äº‹æ¶æ„æ–¹é¢ï¼Œä¹Ÿå¤šæ˜¯è§£å†³é—®é¢˜ä¸ºä¸»ã€‚&lt;/p>
&lt;p>è¿™æ¬¡æ­å»ºæµ·å¤–æœºæˆ¿ï¼Œå›´ç»•æ—¶åŒºå¤§å®¶åšäº†ä¸€ç•ªè®¨è®ºã€‚ä¸è¯´æœ€ç»ˆçš„ç»“æœæ˜¯ä»€ä¹ˆï¼ŒæœŸé—´æœ‰åŒäº‹è®¤ä¸º DB è¿”å›çš„æ˜¯ UTC æ—¶é—´ã€‚&lt;/p>
&lt;p>è¿™é‡Œç®€å•åšä¸ªéªŒè¯ï¼Œé¡ºä¾¿çœ‹ä¸‹æ—¶åŒºçš„é—®é¢˜åˆ°åº•æ˜¯å¦‚ä½•å¤„ç†ã€‚&lt;/p>
&lt;h2 id="ç¯å¢ƒ">ç¯å¢ƒ&lt;/h2>
&lt;blockquote>
&lt;p>openjdk version &amp;ldquo;1.8.0_242&amp;rdquo;
mysql-connector-java &amp;ldquo;8.0.20&amp;rdquo;
mysql &amp;ldquo;5.7&amp;rdquo; æ—¶åŒº TZ=Europe/London
æœ¬åœ°æ—¶åŒº GMT+8&lt;/p>
&lt;/blockquote>
&lt;p>åˆ›å»ºä¸ªç®€å•çš„åº“&lt;code>test&lt;/code>åŠè¡¨&lt;code>user&lt;/code>ï¼Œ è¡¨ç»“æ„å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="k">CREATE&lt;/span> &lt;span class="k">TABLE&lt;/span> &lt;span class="o">`&lt;/span>&lt;span class="k">user&lt;/span>&lt;span class="o">`&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="o">`&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">`&lt;/span> &lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">NOT&lt;/span> &lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">`&lt;/span>&lt;span class="n">birth_date&lt;/span>&lt;span class="o">`&lt;/span> &lt;span class="k">timestamp&lt;/span> &lt;span class="k">NULL&lt;/span> &lt;span class="k">DEFAULT&lt;/span> &lt;span class="k">CURRENT_TIMESTAMP&lt;/span>
&lt;span class="p">)&lt;/span> &lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span> &lt;span class="k">DEFAULT&lt;/span> &lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">latin1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ’å…¥ä¸€æ¡æµ‹è¯•æ•°æ®ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="k">insert&lt;/span> &lt;span class="k">into&lt;/span> &lt;span class="o">`&lt;/span>&lt;span class="k">user&lt;/span>&lt;span class="o">`&lt;/span>
&lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="k">values&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Tom&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;2020-05-15 08:00:00&amp;#39;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="n">Query&lt;/span> &lt;span class="n">OK&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="k">row&lt;/span> &lt;span class="n">affected&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">01&lt;/span> &lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="k">select&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="k">from&lt;/span> &lt;span class="k">user&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="o">+&lt;/span>&lt;span class="c1">------+---------------------+
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">birth_date&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="o">+&lt;/span>&lt;span class="c1">------+---------------------+
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="n">Tom&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">2020&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">05&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">14&lt;/span> &lt;span class="mi">08&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">00&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="o">+&lt;/span>&lt;span class="c1">------+---------------------+
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="k">row&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="k">set&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span> &lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æµ‹è¯•ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">Connection&lt;/span> &lt;span class="n">conn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">DriverManager&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getConnection&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;jdbc:mysql://localhost:3306/test?useSSL=false&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;root&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;root&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">Statement&lt;/span> &lt;span class="n">stmt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">conn&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">createStatement&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">stmt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;select * from user where name = &amp;#39;Tom&amp;#39;&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">ResultSet&lt;/span> &lt;span class="n">rs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">stmt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getResultSet&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">rs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Timestamp&lt;/span> &lt;span class="n">timestamp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">rs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getTimestamp&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;birth_date&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">timestamp&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toLocalDateTime&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">2020-05-14T15:00
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆ†æ">åˆ†æ&lt;/h2>
&lt;p>ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹åŒæ—¶ç”¨ wireshark æŠ“äº†åŒ…ã€‚å¯ä»¥çœ‹åˆ°ä¸€æ¬¡æŸ¥è¯¢ï¼Œåšäº†è¿™ä¹ˆå¤šæ¬¡çš„äº¤äº’ï¼ˆåŒ…å«äº†ä¼šè¯åˆå§‹åŒ–ï¼‰ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ° #177 çš„äº¤äº’è¿”å›æŸ¥è¯¢çš„ç»“æœï¼š&lt;code>Tom 2020-05-14 08:00:00&lt;/code>ï¼Œä¸ DB ä¸­çš„æ•°æ®ç›¸ç¬¦ã€‚&lt;strong>å¯è§ï¼Œè¿”å›çš„å¹¶ä¸æ˜¯ UTC æ—¶é—´&lt;/strong>ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/14/15894244815090.jpg" alt="">&lt;/p>
&lt;p>åœ¨ TCP æŠ“åŒ…ç»“æœä¸­ #155 çš„æŸ¥è¯¢è¯­å¥ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="cm">/* mysql-connector-java-8.0.20 (Revision: afc0a13cd3c5a0bf57eaa809ee0ee6df1fd5ac9b) */&lt;/span>
&lt;span class="k">SELECT&lt;/span> &lt;span class="o">@@&lt;/span>&lt;span class="k">session&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">auto_increment_increment&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">auto_increment_increment&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">character_set_client&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">character_set_client&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">character_set_connection&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">character_set_connection&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">character_set_results&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">character_set_results&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">character_set_server&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">character_set_server&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">collation_server&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">collation_server&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">collation_connection&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">collation_connection&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">init_connect&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">init_connect&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">interactive_timeout&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">interactive_timeout&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">license&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">license&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">lower_case_table_names&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">lower_case_table_names&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">max_allowed_packet&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">max_allowed_packet&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">net_write_timeout&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">net_write_timeout&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">performance_schema&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">performance_schema&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">query_cache_size&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">query_cache_size&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">query_cache_type&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">query_cache_type&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">sql_mode&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">sql_mode&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">system_time_zone&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">system_time_zone&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">time_zone&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">time_zone&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">transaction_isolation&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">transaction_isolation&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">@@&lt;/span>&lt;span class="n">wait_timeout&lt;/span> &lt;span class="k">AS&lt;/span> &lt;span class="n">wait_timeout&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/14/15894253881690.jpg" alt="">&lt;/p>
&lt;p>æœåŠ¡ç«¯è¿”å›çš„ &lt;code>time_zone&lt;/code> ä¸º &lt;code>BST&lt;/code>ã€‚ä¸æœ¬åœ°æ—¶åŒºçš„è½¬æ¢ï¼Œç”± mysql çš„ connector è‡ªåŠ¨å®Œæˆã€‚&lt;/p>
&lt;h2 id="è¿›é˜¶">è¿›é˜¶&lt;/h2>
&lt;h3 id="æ—¶åŒºè‡ªåŠ¨è½¬æ¢">æ—¶åŒºè‡ªåŠ¨è½¬æ¢&lt;/h3>
&lt;p>å®ç°æºç ï¼š&lt;/p>
&lt;p>&lt;code>ResultSetImpl&lt;/code>æºç &lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">defaultTimestampValueFactory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SqlTimestampValueFactory&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pset&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getServerSession&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getServerTimeZone&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Timestamp&lt;/span> &lt;span class="nf">getTimestamp&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">columnIndex&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">SQLException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">checkRowPos&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">checkColumnBounds&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">columnIndex&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">thisRow&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">columnIndex&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">defaultTimestampValueFactory&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å¦‚ä½•ç¡®è®¤æœåŠ¡ç«¯æ—¶åŒº">å¦‚ä½•ç¡®è®¤æœåŠ¡ç«¯æ—¶åŒºï¼Ÿ&lt;/h3>
&lt;p>ä½¿ç”¨ä¼šè¯ä¸­çš„æœåŠ¡ç«¯æ—¶åŒºè¿›è¡ŒæœåŠ¡ç«¯æ—¶åŒºã€‚ä¼šè¯åˆå§‹åŒ–æ—¶ä¼šè¿›è¡Œæ—¶åŒºçš„ç¡®è®¤ï¼Œæ¯”å¦‚å‰é¢è·å–çš„åˆ°&lt;code>BST&lt;/code>ã€‚ç¡®è®¤æ—¶åŒºçš„é€»è¾‘åœ¨&lt;code>NativeProtocol#configureTimezone()&lt;/code>ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">configureTimezone&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="err">#&lt;/span>&lt;span class="n">ä»mysqlçš„å“åº”è·å–&lt;/span> &lt;span class="n">time_zone&lt;/span> &lt;span class="n">å’Œ&lt;/span> &lt;span class="n">system_time_zone&lt;/span> &lt;span class="n">çš„è®¾ç½®&lt;/span>
&lt;span class="n">String&lt;/span> &lt;span class="n">configuredTimeZoneOnServer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">serverSession&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getServerVariable&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;time_zone&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;SYSTEM&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">equalsIgnoreCase&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">configuredTimeZoneOnServer&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">configuredTimeZoneOnServer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">serverSession&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getServerVariable&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;system_time_zone&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="err">#&lt;/span>&lt;span class="n">ä»&lt;/span> &lt;span class="n">jdbc&lt;/span> &lt;span class="n">url&lt;/span> &lt;span class="n">å‚æ•°&lt;/span> &lt;span class="n">serverTimezone&lt;/span> &lt;span class="n">è·å–æ—¶åŒº&lt;/span>
&lt;span class="n">String&lt;/span> &lt;span class="n">canonicalTimezone&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getPropertySet&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getStringProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">PropertyKey&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">serverTimezone&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">configuredTimeZoneOnServer&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//å¦‚æœ jdbc url ä¸­æœªé€šè¿‡ serverTimezone æŒ‡å®šæ—¶åŒºã€‚åˆ™ä»TimeZoneMapping.propertiesä¸­è·å–mysql å›ä¼ çš„æ—¶åŒºç¼©å†™å¯¹åº”çš„æ ‡å‡†æ—¶åŒºï¼Œæ¯”å¦‚æ­¤å¤„çš„ BST =&amp;gt; Europe/London
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//ä¼šå‡ºç°æ— æ³•æ˜ å°„çš„æƒ…å†µï¼Œä¸å¦‚ CEST æ— æ³•æ˜ å°„åˆ° =&amp;gt; Europe/Berlinï¼Œå¯ä»¥æŒ‡å®šè‡ªå®šä¹‰çš„ Properties æ–‡ä»¶è¿›è¡Œæ˜ å°„
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// user can override this with driver properties, so don&amp;#39;t detect if that&amp;#39;s the case
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">canonicalTimezone&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">StringUtils&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isEmptyOrWhitespaceOnly&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">canonicalTimezone&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">canonicalTimezone&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TimeUtil&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getCanonicalTimezone&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">configuredTimeZoneOnServer&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">getExceptionInterceptor&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">IllegalArgumentException&lt;/span> &lt;span class="n">iae&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="n">ExceptionFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">createException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">WrongArgumentException&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">iae&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getMessage&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">getExceptionInterceptor&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//å¦‚æœ jdbc url ä¸­é€šè¿‡ serverTimezone æŒ‡å®šäº†æ—¶åŒºï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨è¯¥æ—¶åŒº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">canonicalTimezone&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">canonicalTimezone&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">serverSession&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setServerTimeZone&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">TimeZone&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getTimeZone&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">canonicalTimezone&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// The Calendar class has the behavior of mapping unknown timezones to &amp;#39;GMT&amp;#39; instead of throwing an exception, so we must check for this...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">canonicalTimezone&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">equalsIgnoreCase&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;GMT&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">serverSession&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getServerTimeZone&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getID&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;GMT&amp;#34;&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="n">ExceptionFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">createException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">WrongArgumentException&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Messages&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Connection.9&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Object&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="n">canonicalTimezone&lt;/span> &lt;span class="o">}),&lt;/span>
&lt;span class="n">getExceptionInterceptor&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å…³äº-servertimezone-çš„å®˜æ–¹è¯´æ˜">å…³äº serverTimezone çš„å®˜æ–¹è¯´æ˜&lt;/h3>
&lt;blockquote>
&lt;p>Override detection/mapping of time zone. Used when time zone from server doesn&amp;rsquo;t map to Java time zone&lt;/p>
&lt;/blockquote>
&lt;p>ä¿®æ”¹ä¸€ä¸‹ jdbc urlï¼Œé€šè¿‡&lt;code>serverTimezone&lt;/code>æŒ‡å®šæ—¶åŒºä¸º &lt;code>GMT+8&lt;/code>ï¼š&lt;code>jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8&amp;amp;useSSL=false&lt;/code>&lt;/p>
&lt;p>å†æ¬¡æ‰§è¡Œä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">2020-05-14T08:00
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>ç¿»è¯‘ï¼šå¤šè¿è¡Œæ—¶å¾®æœåŠ¡æ¶æ„</title><link>https://atbug.com/translation-multi-runtime-microservices-architecture/</link><pubDate>Wed, 01 Apr 2020 23:18:00 +0800</pubDate><guid>https://atbug.com/translation-multi-runtime-microservices-architecture/</guid><description>
&lt;p>è¿™æ ·æ–‡ç« é€šè¿‡Googleç¿»è¯‘å’Œäººå·¥é€å­—ä¿®æ”¹çš„æ–¹å¼å®Œæˆçš„ï¼ŒæŸäº›ä½ç½®ä¹ŸåŠ ä¸Šè‡ªå·±çš„ç†è§£ã€‚å¦‚æœ‰é”™è¯¯ï¼Œè¯·æŒ‡å‡ºã€‚&lt;/p>
&lt;p>ç¿»è¯‘è¿™ç¯‡æ–‡ç« çš„ç›®çš„å…¶å®æ˜¯ä¸ºäº†è‡ªå·±åŠ æ·±å¯¹å¾®æœåŠ¡ã€åˆ†å¸ƒå¼æ¶æ„ä»¥åŠå¤šè¿è¡Œæ—¶æ¶æ„çš„ç†è§£ã€‚æ•´ç¯‡æ–‡ç« ä»â€æˆ˜ç•¥â€œä¸Šåˆ†æäº†å¾®æœåŠ¡â€ä»å¤è‡³ä»Šâ€œè§£å†³çš„é—®é¢˜ï¼Œä»¥åŠå¸¦æ¥çš„æ–°é—®é¢˜ï¼›è¿›è€Œåœ¨â€œæˆ˜æœ¯â€å±‚é¢ï¼Œç»™å‡ºäº†è§£å†³è¿™äº›æ–°é—®é¢˜çš„æ‰‹æ®µã€‚&lt;/p>
&lt;p>ä¸ªäººè§è§£ï¼šæ¶æ„ä»æ¥éƒ½æ˜¯è§£å†³é—®é¢˜å¹¶å¸¦æ¥é—®é¢˜ï¼Œ &lt;em>å–èˆä¹‹é“&lt;/em> ã€‚&lt;/p>
&lt;h3 id="èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†&lt;/h3>
&lt;p>å¾®æœåŠ¡çš„ 12 è¦ç´ ï¼š&lt;/p>
&lt;ol>
&lt;li>åŸºå‡†ä»£ç ï¼šä¸€ä»½åŸºå‡†ä»£ç ï¼Œå¤šä»½éƒ¨ç½²&lt;/li>
&lt;li>ä¾èµ–ï¼šæ˜¾å¼å£°æ˜ä¾èµ–å…³ç³»&lt;/li>
&lt;li>é…ç½®ï¼šåœ¨ç¯å¢ƒä¸­å­˜å‚¨é…ç½®&lt;/li>
&lt;li>åç«¯æœåŠ¡ï¼šæŠŠåç«¯æœåŠ¡å½“åšé™„åŠ èµ„æº&lt;/li>
&lt;li>æ„å»ºã€å‘å¸ƒã€è¿è¡Œï¼šä¸¥æ ¼åˆ†ç¦»æ„å»ºå’Œè¿è¡Œ&lt;/li>
&lt;li>è¿›ç¨‹ï¼šä»¥ä¸€ä¸ªæˆ–å¤šä¸ªæ— çŠ¶æ€è¿›ç¨‹è¿è¡Œåº”ç”¨&lt;/li>
&lt;li>ç«¯å£ç»‘å®šï¼šé€šè¿‡ç«¯å£ç»‘å®šæä¾›æœåŠ¡&lt;/li>
&lt;li>å¹¶å‘ï¼šé€šè¿‡è¿›ç¨‹æ¨¡å‹è¿›è¡Œæ‰©å±•&lt;/li>
&lt;li>æ˜“å¤„ç†ï¼šå¿«é€Ÿå¯åŠ¨å’Œä¼˜é›…ç»ˆæ­¢å¯æœ€å¤§åŒ–å¥å£®æ€§&lt;/li>
&lt;li>å¼€å‘ç¯å¢ƒä¸çº¿ä¸Šç¯å¢ƒç­‰ä»·ï¼šå°½å¯èƒ½çš„ä¿æŒå¼€å‘ã€é¢„å‘å¸ƒã€çº¿ä¸Šç¯å¢ƒç›¸åŒ&lt;/li>
&lt;li>æ—¥å¿—ï¼šæŠŠæ—¥å¿—å½“åšäº‹ä»¶æµ&lt;/li>
&lt;li>ç®¡ç†è¿›ç¨‹ï¼šåå°ç®¡ç†ä»»åŠ¡å½“åšä¸€æ¬¡æ€§è¿›ç¨‹è¿è¡Œ&lt;/li>
&lt;/ol>
&lt;p>&lt;em>åŸæ–‡ä»æ­¤å¤„å¼€å§‹ï¼š&lt;/em>&lt;/p>
&lt;ul>
&lt;li>åˆ›å»ºåˆ†å¸ƒå¼ç³»ç»Ÿå¹¶éæ˜“äº‹ã€‚å›´ç»•â€œå¾®æœåŠ¡â€æ¶æ„å’Œâ€œ 12è¦ç´ åº”ç”¨ç¨‹åºâ€è®¾è®¡å‡ºç°äº†æœ€ä½³å®è·µã€‚è¿™äº›æä¾›äº†ä¸äº¤ä»˜ç”Ÿå‘½å‘¨æœŸï¼Œç½‘ç»œï¼ŒçŠ¶æ€ç®¡ç†ä»¥åŠå¯¹å¤–éƒ¨ä¾èµ–é¡¹çš„ç»‘å®šæœ‰å…³çš„å‡†åˆ™ã€‚&lt;/li>
&lt;li>ä½†æ˜¯ï¼Œä»¥å¯æ‰©å±•å’Œå¯ç»´æŠ¤çš„æ–¹å¼ä¸€è‡´åœ°å®æ–½è¿™äº›åŸåˆ™æ˜¯å…·æœ‰æŒ‘æˆ˜æ€§çš„ã€‚&lt;/li>
&lt;li>è§£å†³è¿™äº›åŸç†çš„ä»¥æŠ€æœ¯ä¸ºä¸­å¿ƒçš„ä¼ ç»Ÿæ–¹æ³•åŒ…æ‹¬ä¼ä¸šæœåŠ¡æ€»çº¿ï¼ˆESBï¼‰å’Œé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼ˆMOMï¼‰ã€‚è™½ç„¶è¿™äº›è§£å†³æ–¹æ¡ˆæä¾›äº†è‰¯å¥½çš„åŠŸèƒ½é›†ï¼Œä½†ä¸»è¦çš„æŒ‘æˆ˜æ˜¯æ•´ä½“æ¶æ„ä»¥åŠä¸šåŠ¡é€»è¾‘å’Œå¹³å°ä¹‹é—´çš„ç´§å¯†æŠ€æœ¯è€¦åˆã€‚&lt;/li>
&lt;li>éšç€äº‘ï¼Œå®¹å™¨å’Œå®¹å™¨åè°ƒå™¨ï¼ˆKubernetesï¼‰çš„æµè¡Œï¼Œå‡ºç°äº†è§£å†³è¿™äº›åŸç†çš„æ–°è§£å†³æ–¹æ¡ˆã€‚ä¾‹å¦‚ï¼ŒKnativeç”¨äºäº¤ä»˜ï¼ŒæœåŠ¡ç½‘æ ¼ç”¨äºç½‘ç»œï¼Œè€ŒCamel-Kç”¨äºç»‘å®šå’Œé›†æˆã€‚&lt;/li>
&lt;li>é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œä¸šåŠ¡é€»è¾‘ï¼ˆç§°ä¸ºâ€œå¾®é€»è¾‘â€ï¼‰æ„æˆäº†åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒï¼Œå¹¶ä¸”å¯ä»¥åˆ›å»ºæä¾›å¼ºå¤§çš„ç°æˆåˆ†å¸ƒå¼åŸè¯­çš„sidecarâ€œ mechaâ€ç»„ä»¶ã€‚&lt;/li>
&lt;li>å¾®è§‚ç»„ä»¶å’Œæœºæ¢°ç»„ä»¶çš„è¿™ç§åˆ†ç¦»å¯ä»¥æ”¹å–„ç¬¬äºŒå¤©çš„æ“ä½œï¼Œä¾‹å¦‚æ‰“è¡¥ä¸å’Œå‡çº§ï¼Œå¹¶æœ‰åŠ©äºç»´æŒä¸šåŠ¡é€»è¾‘å†…èšå•å…ƒçš„é•¿æœŸå¯ç»´æŠ¤æ€§ã€‚&lt;/li>
&lt;/ul>
&lt;p>åˆ›å»ºè‰¯å¥½çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºå¹¶éæ˜“äº‹ï¼šæ­¤ç±»ç³»ç»Ÿé€šå¸¸éµå¾ª12è¦ç´ åº”ç”¨ç¨‹åºå’Œå¾®æœåŠ¡åŸåˆ™ã€‚å®ƒä»¬å¿…é¡»æ˜¯æ— çŠ¶æ€çš„ï¼Œå¯ä¼¸ç¼©çš„ï¼Œå¯é…ç½®çš„ï¼Œç‹¬ç«‹å‘å¸ƒçš„ï¼Œå®¹å™¨åŒ–çš„ï¼Œå¯è‡ªåŠ¨åŒ–çš„ï¼Œå¹¶ä¸”æœ‰æ—¶æ˜¯äº‹ä»¶é©±åŠ¨çš„å’Œæ— æœåŠ¡å™¨çš„ã€‚åˆ›å»ºåï¼Œå®ƒä»¬åº”è¯¥æ˜“äºå‡çº§ï¼Œå¹¶ä¸”é•¿æœŸå¯ä»¥æ‰¿å—ã€‚åœ¨å½“ä»Šçš„æŠ€æœ¯ä¸­ï¼Œè¦åœ¨è¿™äº›ç›¸äº’ç«äº‰çš„è¦æ±‚ä¹‹é—´æ‰¾åˆ°è‰¯å¥½çš„å¹³è¡¡ä»ç„¶æ˜¯ä¸€é¡¹è‰°å·¨çš„åŠªåŠ›ã€‚&lt;/p>
&lt;p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†æ¢è®¨åˆ†å¸ƒå¼å¹³å°å¦‚ä½•å‘å±•ä»¥å®ç°è¿™ç§å¹³è¡¡ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¼”è¿›ä¸­è¿˜éœ€è¦å‘ç”Ÿä»€ä¹ˆäº‹æƒ…ï¼Œä»¥ç®€åŒ–å¯ç»´æŠ¤çš„åˆ†å¸ƒå¼ä½“ç³»ç»“æ„çš„åˆ›å»ºã€‚å¦‚æœæ‚¨æƒ³è®©æˆ‘å®æ—¶è°ˆè®ºè¿™ä¸ªè¯é¢˜ï¼Œè¯·åŠ å…¥æˆ‘çš„QCon ä¸‰æœˆçš„ä¼¦æ•¦ã€‚&lt;/p>
&lt;h2 id="åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºéœ€æ±‚">åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºéœ€æ±‚&lt;/h2>
&lt;p>åœ¨æ­¤è®¨è®ºä¸­ï¼Œæˆ‘å°†æŠŠç°ä»£åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„éœ€æ±‚åˆ†ä¸ºå››ä¸ªç±»åˆ«-ç”Ÿå‘½å‘¨æœŸï¼Œç½‘ç»œï¼ŒçŠ¶æ€ï¼Œç»‘å®š-å¹¶ç®€è¦åˆ†æå®ƒä»¬åœ¨æœ€è¿‘å‡ å¹´ä¸­çš„å‘å±•æƒ…å†µã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/04/01/15856635785757.jpg" alt="">&lt;/p>
&lt;h3 id="ç”Ÿå‘½å‘¨æœŸ-lifecycle">ç”Ÿå‘½å‘¨æœŸ Lifecycle&lt;/h3>
&lt;ul>
&lt;li>æ‰“åŒ… Packaging&lt;/li>
&lt;li>å¥åº·æ£€æŸ¥ Healthcheck&lt;/li>
&lt;li>éƒ¨ç½² Deployment&lt;/li>
&lt;li>æ‰©å±• Scaling&lt;/li>
&lt;li>é…ç½® Configuration&lt;/li>
&lt;/ul>
&lt;p>è®©æˆ‘ä»¬ä»åŸºç¡€å¼€å§‹ã€‚å½“æˆ‘ä»¬ç¼–å†™ä¸€é¡¹åŠŸèƒ½æ—¶ï¼Œç¼–ç¨‹è¯­è¨€å°†æŒ‡ç¤ºç”Ÿæ€ç³»ç»Ÿä¸­çš„å¯ç”¨åº“ï¼Œæ‰“åŒ…æ ¼å¼å’Œè¿è¡Œæ—¶ã€‚ä¾‹å¦‚ï¼ŒJavaä½¿ç”¨.jaræ ¼å¼ï¼Œå°†æ‰€æœ‰Mavenä¾èµ–é¡¹ç”¨ä½œç”Ÿæ€ç³»ç»Ÿï¼Œå¹¶å°†JVMç”¨ä½œè¿è¡Œæ—¶ã€‚å¦‚ä»Šï¼Œéšç€å‘å¸ƒå‘¨æœŸçš„ç¼©çŸ­ï¼Œç”Ÿå‘½å‘¨æœŸæ›´é‡è¦çš„æ˜¯èƒ½å¤Ÿè‡ªåŠ¨éƒ¨ç½²ï¼Œä»é”™è¯¯ä¸­æ¢å¤ä»¥åŠæ‰©å±•æœåŠ¡çš„èƒ½åŠ›ã€‚è¿™ç»„åŠŸèƒ½å¹¿æ³›åœ°ä»£è¡¨äº†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸéœ€æ±‚ã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¯‘è€…ï¼šé”™è¯¯æ¢å¤ä¾èµ–å¥åº·æ£€æŸ¥&lt;/p>
&lt;/blockquote>
&lt;h3 id="ç½‘ç»œ-networking">ç½‘ç»œ Networking&lt;/h3>
&lt;ul>
&lt;li>æœåŠ¡å‘ç° Service Discovery&lt;/li>
&lt;li>A/B æµ‹è¯•ã€é‡‘ä¸é›€éƒ¨ç½² A/B Testingï¼ŒCanary rollouts&lt;/li>
&lt;li>é‡è¯•ã€è¶…æ—¶ã€æ–­è·¯å™¨ Retryï¼Œtimeoutï¼Œcircuit breaker&lt;/li>
&lt;li>ç‚¹åˆ°ç‚¹ã€å‘å¸ƒ/è®¢é˜… Point-to-pointï¼Œpub/sub&lt;/li>
&lt;li>å®‰å…¨ã€å¯è§‚æµ‹æ€§ Security observability&lt;/li>
&lt;/ul>
&lt;p>ä»æŸç§æ„ä¹‰ä¸Šè®²ï¼Œä»Šå¤©å‡ ä¹æ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½æ˜¯åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºï¼Œå› æ­¤éœ€è¦è”ç½‘ã€‚ä½†æ˜¯ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿéœ€è¦ä»æ›´å¹¿æ³›çš„è§’åº¦æŒæ¡ç½‘ç»œã€‚ä»æœåŠ¡å‘ç°å’Œé”™è¯¯æ¢å¤å¼€å§‹ï¼Œåˆ°å¯ç”¨ç°ä»£è½¯ä»¶å‘å¸ƒæŠ€æœ¯ä»¥åŠå„ç§è·Ÿè¸ªå’Œé¥æµ‹ã€‚ä¸ºäº†æˆ‘ä»¬çš„ç›®çš„ï¼Œæˆ‘ä»¬ç”šè‡³å°†ä¸åŒçš„æ¶ˆæ¯äº¤æ¢æ¨¡å¼ï¼Œç‚¹å¯¹ç‚¹å’Œå‘å¸ƒ/è®¢é˜…æ–¹æ³•ä»¥åŠæ™ºèƒ½è·¯ç”±æœºåˆ¶åŒ…æ‹¬åœ¨æ­¤ç±»åˆ«ä¸­ã€‚&lt;/p>
&lt;h3 id="çŠ¶æ€-state">çŠ¶æ€ State&lt;/h3>
&lt;ul>
&lt;li>å·¥ä½œæµç®¡ç† Workflow mgmt&lt;/li>
&lt;li>å¹‚ç­‰æ€§ Idempotency&lt;/li>
&lt;li>ä¸´æ—¶è°ƒåº¦ Temporal scheduling&lt;/li>
&lt;li>ç¼“å­˜ Caching&lt;/li>
&lt;li>åº”ç”¨çŠ¶æ€ Application State&lt;/li>
&lt;/ul>
&lt;p>å½“æˆ‘ä»¬è°ˆè®ºçŠ¶æ€æ—¶ï¼Œé€šå¸¸æ˜¯å…³äºæœåŠ¡çŠ¶æ€ä»¥åŠä¸ºä»€ä¹ˆæœ€å¥½æ˜¯æ— çŠ¶æ€çš„ã€‚ä½†æ˜¯ç®¡ç†æœåŠ¡çš„å¹³å°æœ¬èº«éœ€è¦çŠ¶æ€ã€‚è¿™å¯¹äºæ‰§è¡Œå¯é çš„æœåŠ¡ç¼–æ’å’Œå·¥ä½œæµï¼Œåˆ†å¸ƒå¼å•ä¾‹ï¼Œä¸´æ—¶è°ƒåº¦ï¼ˆcronä½œä¸šï¼‰ï¼Œå¹‚ç­‰æ€§ï¼Œæœ‰çŠ¶æ€çš„é”™è¯¯æ¢å¤ï¼Œç¼“å­˜ç­‰æ˜¯å¿…éœ€çš„ã€‚æ­¤å¤„åˆ—å‡ºçš„æ‰€æœ‰åŠŸèƒ½éƒ½ä¾èµ–äºåº•å±‚çš„çŠ¶æ€ã€‚è™½ç„¶å®é™…çš„çŠ¶æ€ç®¡ç†ä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ä¹‹å†…ï¼Œä½†å…³æ³¨çŠ¶æ€çš„åˆ†å¸ƒå¼åŸè¯­åŠå…¶æŠ½è±¡å´å¾ˆå—å…³æ³¨ã€‚&lt;/p>
&lt;h3 id="ç»‘å®š-binding">ç»‘å®š Binding&lt;/h3>
&lt;ul>
&lt;li>è¿æ¥å™¨ Connectors&lt;/li>
&lt;li>åè®®è½¬æ¢ Protocol conversion&lt;/li>
&lt;li>æ¶ˆæ¯è½¬æ¢ Message transformation&lt;/li>
&lt;li>æ¶ˆæ¯è·¯ç”± Message routeing&lt;/li>
&lt;li>äº‹åŠ¡æ€§ Transactionality&lt;/li>
&lt;/ul>
&lt;p>åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç»„ä»¶ä¸ä»…å¿…é¡»å½¼æ­¤å¯¹è¯ï¼Œè€Œä¸”è¿˜å¿…é¡»ä¸ç°ä»£æˆ–æ—§å¼å¤–éƒ¨ç³»ç»Ÿé›†æˆã€‚è¿™å°±è¦æ±‚è¿æ¥å™¨èƒ½å¤Ÿè½¬æ¢å„ç§åè®®ï¼Œæ”¯æŒä¸åŒçš„æ¶ˆæ¯äº¤æ¢æ¨¡å¼ï¼ˆä¾‹å¦‚è½®è¯¢ï¼Œäº‹ä»¶é©±åŠ¨ï¼Œè¯·æ±‚/ç­”å¤ï¼‰è½¬æ¢æ¶ˆæ¯æ ¼å¼ï¼Œç”šè‡³èƒ½å¤Ÿæ‰§è¡Œè‡ªå®šä¹‰çš„é”™è¯¯æ¢å¤è¿‡ç¨‹å’Œå®‰å…¨æœºåˆ¶ã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¯‘è€…ï¼šæ‰§è¡Œè‡ªå®šä¹‰çš„é”™è¯¯æ¢å¤è¿‡ç¨‹å’Œå®‰å…¨æœºåˆ¶ &amp;ndash; äº‹åŠ¡&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨ä¸æ¶‰åŠä¸€æ¬¡æ€§ä½¿ç”¨æ¡ˆä¾‹çš„æƒ…å†µä¸‹ï¼Œä»¥ä¸Šå†…å®¹ä»£è¡¨äº†åˆ›å»ºè‰¯å¥½çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ‰€éœ€çš„é€šç”¨åŸè¯­çš„è‰¯å¥½é›†åˆã€‚å¦‚ä»Šï¼Œè®¸å¤šå¹³å°éƒ½æä¾›äº†è¿™æ ·çš„åŠŸèƒ½ï¼Œä½†æ˜¯æœ¬æ–‡ä¸­æˆ‘ä»¬è¦å¯»æ‰¾çš„æ˜¯è¿‡å»åå¹´ä¸­æˆ‘ä»¬ä½¿ç”¨è¿™äº›åŠŸèƒ½çš„æ–¹å¼å¦‚ä½•å˜åŒ–ï¼Œä»¥åŠåœ¨ä¸‹ä¸€ä¸ªåå¹´ä¸­å®ƒå°†å¦‚ä½•å˜åŒ–ã€‚ä¸ºäº†è¿›è¡Œæ¯”è¾ƒï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿‡å»çš„åå¹´ï¼Œçœ‹çœ‹åŸºäºJavaçš„ä¸­é—´ä»¶å¦‚ä½•æ»¡è¶³è¿™äº›éœ€æ±‚ã€‚&lt;/p>
&lt;h2 id="ä¼ ç»Ÿä¸­é—´ä»¶çš„é™åˆ¶">ä¼ ç»Ÿä¸­é—´ä»¶çš„é™åˆ¶&lt;/h2>
&lt;p>ä¸Šä¸€ä»£çš„ä¼ä¸šæœåŠ¡æ€»çº¿ï¼ˆESBï¼‰åŠå…¶å˜ä½“ï¼ˆä¾‹å¦‚é¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼Œæ›´è½»é‡çº§çš„é›†æˆæ¡†æ¶ç­‰ï¼‰å¯æ»¡è¶³ä¸Šè¿°éœ€æ±‚ï¼Œè¿™æ˜¯ä¸€ç§ä¼—æ‰€å‘¨çŸ¥çš„ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆã€‚ESB æ˜¯ä¸€ç§ä¸­é—´ä»¶ï¼Œå¯ä»¥ä½¿ç”¨é¢å‘æœåŠ¡çš„ä½“ç³»ç»“æ„ï¼ˆå³ç»å…¸SOAï¼‰åœ¨å¼‚æ„ç¯å¢ƒä¹‹é—´å®ç°äº’æ“ä½œæ€§ã€‚&lt;/p>
&lt;p>ESBå¯ä»¥ä¸ºæ‚¨æä¾›è‰¯å¥½çš„åŠŸèƒ½é›†ï¼Œä½†ESBçš„ä¸»è¦æŒ‘æˆ˜æ˜¯æ•´ä½“æ¶æ„ä»¥åŠä¸šåŠ¡é€»è¾‘å’Œå¹³å°ä¹‹é—´ç´§å¯†çš„æŠ€æœ¯è€¦åˆï¼Œä»è€Œå¯¼è‡´æŠ€æœ¯å’Œç»„ç»‡é›†ä¸­åŒ–ã€‚åœ¨å°†æœåŠ¡å¼€å‘å¹¶éƒ¨ç½²åˆ°è¿™æ ·çš„ç³»ç»Ÿä¸­æ—¶ï¼Œå®ƒä¸åˆ†å¸ƒå¼ç³»ç»Ÿæ¡†æ¶ç´§å¯†ç»“åˆï¼Œä»è€Œé™åˆ¶äº†æœåŠ¡çš„å‘å±•ã€‚è¿™é€šå¸¸åªä¼šåœ¨è½¯ä»¶ç”Ÿå‘½å‘¨æœŸçš„åæœŸæ‰å˜å¾—æ˜æ˜¾ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯æ¯ç±»éœ€æ±‚çš„ä¸€äº›é—®é¢˜å’Œå±€é™æ€§ï¼Œè¿™äº›é—®é¢˜å’Œå±€é™æ€§ä½¿å¾—ESBåœ¨ç°ä»£æ—¶ä»£ä¸å†æœ‰ç”¨ã€‚&lt;/p>
&lt;h3 id="ç”Ÿå‘½å‘¨æœŸ">ç”Ÿå‘½å‘¨æœŸ&lt;/h3>
&lt;p>åœ¨ä¼ ç»Ÿçš„ä¸­é—´ä»¶ä¸­ï¼Œé€šå¸¸åªæœ‰ä¸€ä¸ªå—æ”¯æŒçš„è¯­è¨€è¿è¡Œæ—¶ï¼ˆä¾‹å¦‚Javaï¼‰ï¼Œå®ƒè§„å®šäº†è½¯ä»¶çš„æ‰“åŒ…æ–¹å¼ï¼Œå¯ç”¨çš„åº“ï¼Œå¿…é¡»å®šæœŸå¯¹å…¶è¿›è¡Œæ‰“è¡¥ä¸ç­‰ã€‚ä¸šåŠ¡æœåŠ¡å¿…é¡»ä½¿ç”¨é‚£äº›ä½¿å…¶ä¸ä»¥ç›¸åŒè¯­è¨€ç¼–å†™çš„å¹³å°ç´§å¯†ç»“åˆçš„åº“ã€‚å®é™…ä¸Šï¼Œè¿™å¯¼è‡´åè°ƒçš„æœåŠ¡å’Œå¹³å°å‡çº§ï¼Œä»è€Œé˜»æ­¢äº†ç‹¬ç«‹å’Œå¸¸è§„çš„æœåŠ¡å’Œå¹³å°å‘å¸ƒã€‚&lt;/p>
&lt;h3 id="è”ç½‘">è”ç½‘&lt;/h3>
&lt;p>å°½ç®¡ä¼ ç»Ÿçš„ä¸­é—´ä»¶æ‹¥æœ‰å›´ç»•ä¸å…¶ä»–å†…éƒ¨å’Œå¤–éƒ¨æœåŠ¡äº¤äº’çš„é«˜çº§åŠŸèƒ½é›†ï¼Œä½†å®ƒå…·æœ‰ä¸€äº›ä¸»è¦ç¼ºç‚¹ã€‚ ç½‘ç»œåŠŸèƒ½é›†ä¸­äºä¸€ç§ä¸»è¦è¯­è¨€åŠå…¶ç›¸å…³æŠ€æœ¯ã€‚ å¯¹äºJavaæ¥è¯´ï¼Œå³JMSï¼ŒJDBCï¼ŒJTAç­‰ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œç½‘ç»œé—®é¢˜å’Œè¯­ä¹‰ä¹Ÿæ·±æ·±åœ°åˆ»åœ¨ä¸šåŠ¡æœåŠ¡ä¸­ã€‚ æœ‰ä¸€äº›å…·æœ‰æŠ½è±¡çš„åº“æ¥è§£å†³ç½‘ç»œé—®é¢˜ï¼ˆä¾‹å¦‚æ›¾ç»å¾ˆå—æ¬¢è¿çš„Hystrixé¡¹ç›®ï¼‰ï¼Œä½†æ˜¯è¯¥åº“çš„æŠ½è±¡â€œæ³„æ¼â€åˆ°äº†æœåŠ¡çš„ç¼–ç¨‹æ¨¡å‹ï¼Œäº¤æ¢æ¨¡å¼å’Œé”™è¯¯å¤„ç†è¯­ä¹‰ä»¥åŠåº“æœ¬èº«ä¸­ã€‚ è™½ç„¶å¯ä»¥æ–¹ä¾¿åœ°åœ¨ä¸€ä¸ªä½ç½®ç¼–å†™å’Œè¯»å–ä¸ç½‘ç»œæ–¹é¢æ··åˆçš„æ•´ä¸ªä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯è¿™å°†ä¸¤ä¸ªé—®é¢˜ç´§å¯†åœ°è€¦åˆåˆ°ä¸€ä¸ªå®ç°ä¸­ï¼Œæœ€ç»ˆå½¢æˆäº†ä¸€æ¡å…±åŒçš„æ¼”è¿›è·¯å¾„ã€‚&lt;/p>
&lt;p>è¯‘è€…ï¼šè¿™é‡Œé—®é¢˜åœ¨äºä¸€äº›é€šç”¨çš„é«˜çº§åŠŸèƒ½ä¸è¯­è¨€ç»‘å®šã€‚è¿™é‡Œæåˆ°çš„ Hystrix ä½œä¸ºæ–­è·¯å™¨çš„ä¸€ä¸ªå®ç°ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦é‡‡ç”¨ Hystrix çš„ç¼–ç¨‹æ¨¡å‹ã€‚å¦‚æœåˆ‡æ¢åˆ°å…¶ä»–çš„å®ç°ï¼Œåˆ™éœ€è¦å­¦ä¹ å’Œæ”¹é€ çš„æˆæœ¬ã€‚&lt;/p>
&lt;h3 id="çŠ¶æ€">çŠ¶æ€&lt;/h3>
&lt;p>ä¸ºäº†è¿›è¡Œå¯é çš„æœåŠ¡ç¼–æ’ï¼Œä¸šåŠ¡æµç¨‹ç®¡ç†ä»¥åŠå®æ–½æ¨¡å¼ï¼ˆä¾‹å¦‚Sagaæ¨¡å¼å’Œå…¶ä»–è¿è¡Œç¼“æ…¢çš„æµç¨‹ï¼‰ï¼Œå¹³å°éœ€è¦åœ¨å¹•åä¿æŒæŒä¹…çŠ¶æ€ã€‚åŒæ ·ï¼Œä¸´æ—¶åŠ¨ä½œï¼ˆä¾‹å¦‚è§¦å‘è®¡æ—¶å™¨å’Œcronä½œä¸šï¼‰å»ºç«‹åœ¨çŠ¶æ€ä¹‹ä¸Šï¼Œå¹¶ä¸”éœ€è¦åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å¯¹æ•°æ®åº“è¿›è¡Œé›†ç¾¤åŒ–å’Œæ¢å¤ã€‚è¿™é‡Œçš„ä¸»è¦çº¦æŸæ˜¯ä»¥ä¸‹äº‹å®ï¼šä¸çŠ¶æ€äº¤äº’çš„åº“å’Œæ¥å£æ²¡æœ‰å®Œå…¨æŠ½è±¡å‡ºæ¥ï¼Œä¹Ÿæ²¡æœ‰ä¸æœåŠ¡è¿è¡Œæ—¶åˆ†ç¦»ã€‚é€šå¸¸ï¼Œè¿™äº›åº“å¿…é¡»é…ç½®æœ‰æ•°æ®åº“è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶ä¸”å®ƒä»¬å­˜åœ¨äºæœåŠ¡ä¸­ï¼Œä»è€Œå°†è¯­ä¹‰å’Œä¾èµ–å…³ç³»æ³„æ¼åˆ°åº”ç”¨ç¨‹åºåŸŸä¸­&lt;/p>
&lt;h3 id="ç»‘å®š">ç»‘å®š&lt;/h3>
&lt;p>ä½¿ç”¨é›†æˆä¸­é—´ä»¶çš„ä¸»è¦é©±åŠ¨ç¨‹åºä¹‹ä¸€æ˜¯èƒ½å¤Ÿä½¿ç”¨ä¸åŒçš„åè®®ï¼Œæ•°æ®æ ¼å¼å’Œæ¶ˆæ¯äº¤æ¢æ¨¡å¼è¿æ¥åˆ°å…¶ä»–å„ç§ç³»ç»Ÿã€‚ä½†æ˜¯ï¼Œè¿™äº›è¿æ¥å™¨å¿…é¡»ä¸åº”ç”¨ç¨‹åºä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ„å‘³ç€å¿…é¡»å°†ä¾èµ–å…³ç³»ä¸ä¸šåŠ¡é€»è¾‘ä¸€èµ·è¿›è¡Œæ›´æ–°å’Œä¿®è¡¥ã€‚è¿™æ„å‘³ç€å¿…é¡»åœ¨æœåŠ¡å†…æ¥å›è½¬æ¢æ•°æ®ç±»å‹å’Œæ•°æ®æ ¼å¼ã€‚è¿™æ„å‘³ç€å¿…é¡»æ ¹æ®æ¶ˆæ¯äº¤æ¢æ¨¡å¼æ¥æ„é€ ä»£ç å¹¶è®¾è®¡æµç¨‹ã€‚è¿™äº›æ˜¯å³ä½¿æŠ½è±¡çš„ç«¯ç‚¹å¦‚ä½•å½±å“ä¼ ç»Ÿä¸­é—´ä»¶ä¸­æœåŠ¡å®ç°çš„ä¸€äº›ç¤ºä¾‹ã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¯‘è€…ï¼šä½¿ç”¨ä¸åŒ RPC å®ç°çš„æœåŠ¡ä¹‹é—´çš„å¯¹è¯ï¼Œæ¯”å¦‚æŸä¸ªæœåŠ¡è°ƒç”¨ä¼šåŒæ—¶ï¼ˆç©ºé—´ä¸Šï¼‰è°ƒç”¨ä½¿ç”¨ Dubbo åè®®çš„æœåŠ¡å’Œä½¿ç”¨ RESTful åè®®çš„æœåŠ¡&lt;/p>
&lt;/blockquote>
&lt;h2 id="äº‘åŸç”Ÿè¶‹åŠ¿">äº‘åŸç”Ÿè¶‹åŠ¿&lt;/h2>
&lt;p>ä¼ ç»Ÿçš„ä¸­é—´ä»¶åŠŸèƒ½å¼ºå¤§ã€‚å®ƒå…·æœ‰æ‰€æœ‰å¿…è¦çš„æŠ€æœ¯åŠŸèƒ½ï¼Œä½†ç¼ºä¹ç°ä»£æ•°å­—ä¸šåŠ¡éœ€æ±‚æ‰€è¦æ±‚çš„å¿«é€Ÿæ›´æ”¹å’Œæ‰©å±•çš„èƒ½åŠ›ã€‚è¿™å°±æ˜¯å¾®æœåŠ¡ä½“ç³»ç»“æ„åŠå…¶è®¾è®¡ç°ä»£åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„æŒ‡å¯¼åŸåˆ™æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>å¾®æœåŠ¡èƒŒåçš„æ€æƒ³åŠå…¶æŠ€æœ¯è¦æ±‚ä¿ƒè¿›äº†å®¹å™¨å’ŒKubernetesçš„æ™®åŠå’Œå¹¿æ³›ä½¿ç”¨ã€‚è¿™å¼€å§‹äº†ä¸€ç§æ–°çš„åˆ›æ–°æ–¹å¼ï¼Œè¿™ç§æ–¹å¼å°†å½±å“æˆ‘ä»¬ä»Šåå‡ å¹´å¤„ç†åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„æ–¹å¼ã€‚è®©æˆ‘ä»¬çœ‹çœ‹Kuberneteså’Œç›¸å…³æŠ€æœ¯å¦‚ä½•å½±å“æ¯ç»„éœ€æ±‚ã€‚&lt;/p>
&lt;h3 id="ç”Ÿå‘½å‘¨æœŸ-1">ç”Ÿå‘½å‘¨æœŸ&lt;/h3>
&lt;p>å®¹å™¨å’ŒKuberneteså°†æˆ‘ä»¬æ‰“åŒ…ã€åˆ†å‘å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºçš„æ–¹å¼å‘å±•ä¸ºä¸è¯­è¨€æ— å…³çš„æ ¼å¼ã€‚å…³äºKubernetesæ¨¡å¼å’ŒKuberneteså¯¹å¼€å‘äººå‘˜çš„å½±å“çš„æ–‡ç« å¾ˆå¤šï¼Œåœ¨è¿™é‡Œæˆ‘å°†ç®€çŸ­ä»‹ç»ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œå¯¹äºKubernetesï¼Œè¦ç®¡ç†çš„æœ€å°åŸè¯­æ˜¯å®¹å™¨ï¼Œå®ƒä¸“æ³¨äºåœ¨å®¹å™¨çº§åˆ«å’Œæµç¨‹æ¨¡å‹ä¸Šäº¤ä»˜åˆ†å¸ƒå¼åŸè¯­ã€‚è¿™æ„å‘³ç€å®ƒåœ¨ç®¡ç†åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸæ–¹é¢ï¼Œè¿è¡ŒçŠ¶å†µæ£€æŸ¥ã€æ¢å¤ã€éƒ¨ç½²å’Œæ‰©å±•æ–¹é¢åšå¾—å¾ˆå¥½ï¼Œä½†æ˜¯åœ¨å®¹å™¨å†…çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„å…¶ä»–æ–¹é¢å´æ²¡æœ‰åšå¾—é‚£ä¹ˆå¥½ï¼Œä¾‹å¦‚çµæ´»çš„ç½‘ç»œã€çŠ¶æ€ç®¡ç†å’Œç»‘å®šã€‚&lt;/p>
&lt;p>æ‚¨å¯èƒ½ä¼šæŒ‡å‡ºï¼ŒKuberneteså…·æœ‰çŠ¶æ€å·¥ä½œè´Ÿè½½ã€æœåŠ¡å‘ç°ã€cronä½œä¸šå’Œå…¶ä»–åŠŸèƒ½ã€‚çš„ç¡®å¦‚æ­¤ï¼Œä½†æ˜¯æ‰€æœ‰è¿™äº›åŸè¯­éƒ½æ˜¯åœ¨å®¹å™¨çº§åˆ«çš„ï¼Œå¹¶ä¸”åœ¨å®¹å™¨å†…éƒ¨ï¼Œå¼€å‘äººå‘˜ä»ç„¶å¿…é¡»ä½¿ç”¨ç‰¹å®šäºè¯­è¨€çš„åº“æ¥è®¿é—®æˆ‘ä»¬åœ¨æœ¬æ–‡å¼€å¤´åˆ—å‡ºçš„æ›´è¯¦ç»†çš„åŠŸèƒ½ã€‚è¿™å°±æ˜¯æ¨åŠ¨è¯¸å¦‚Envoyã€Linkerdã€Consulã€Knativeã€Daprã€Camel-Kç­‰é¡¹ç›®çš„åŸå› ã€‚&lt;/p>
&lt;h3 id="ç½‘ç»œ">ç½‘ç»œ&lt;/h3>
&lt;p>äº‹å®è¯æ˜ï¼ŒKubernetesæä¾›çš„å›´ç»•æœåŠ¡å‘ç°çš„åŸºæœ¬ç½‘ç»œåŠŸèƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åŸºç¡€ï¼Œä½†å¯¹äºç°ä»£åº”ç”¨ç¨‹åºæ¥è¯´è¿˜ä¸å¤Ÿã€‚éšç€å¾®æœåŠ¡æ•°é‡çš„å¢åŠ å’Œéƒ¨ç½²é€Ÿåº¦çš„åŠ å¿«ï¼Œå¯¹æ›´é«˜çº§çš„å‘å¸ƒç­–ç•¥ã€ç®¡ç†å®‰å…¨æ€§ã€æŒ‡æ ‡ã€è·Ÿè¸ªã€ä»é”™è¯¯ä¸­æ¢å¤ã€é”™è¯¯æ¨¡æ‹Ÿç­‰ç­‰æ–¹é¢çš„éœ€æ±‚å˜å¾—è¶Šæ¥è¶Šå…·æœ‰å¸å¼•åŠ›ï¼Œå¹¶äº§ç”Ÿäº†ä¸€ç§æ–°çš„è½¯ä»¶ç±»åˆ«ï¼Œç§°ä¸ºæœåŠ¡ç½‘æ ¼ã€‚&lt;/p>
&lt;p>è¿™é‡Œæ›´ä»¤äººå…´å¥‹çš„æ˜¯ï¼Œè¶‹åŠ¿æ˜¯å°†ä¸ç½‘ç»œç›¸å…³çš„é—®é¢˜ä»åŒ…å«ä¸šåŠ¡é€»è¾‘çš„æœåŠ¡ç§»å‡ºåˆ°å•ç‹¬çš„è¿è¡Œæ—¶ï¼ˆæ— è®ºæ˜¯sidecarè¿˜æ˜¯èŠ‚ç‚¹çº§ä»£ç†ï¼‰ã€‚å¦‚ä»Šï¼ŒæœåŠ¡ç½‘æ ¼å¯ä»¥æ‰§è¡Œé«˜çº§è·¯ç”±ã€åŠ©åŠ›æµ‹è¯•ã€å¤„ç†å®‰å…¨æ€§çš„æŸäº›éƒ¨åˆ†ï¼Œæ›´ç”šè‡³ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„åè®®ï¼ˆä¾‹å¦‚ï¼ŒEnvoyæ”¯æŒKafkaï¼ŒMongoDBï¼ŒRedisï¼ŒMySQLç­‰ï¼‰ã€‚å°½ç®¡ä½œä¸ºè§£å†³æ–¹æ¡ˆçš„æœåŠ¡ç½‘æ ¼å¯èƒ½å°šæœªå¾—åˆ°å¹¿æ³›é‡‡ç”¨ï¼Œä½†å®ƒè§¦åŠäº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„çœŸæ­£ç—›ç‚¹ï¼Œæˆ‘ç›¸ä¿¡å®ƒå°†æ‰¾åˆ°å…¶å½¢çŠ¶å’Œå­˜åœ¨å½¢å¼ã€‚&lt;/p>
&lt;p>é™¤äº†å…¸å‹çš„æœåŠ¡æœºåˆ¶å¤–ï¼Œè¿˜æœ‰å…¶ä»–é¡¹ç›®ï¼Œä¾‹å¦‚Skupperï¼Œè¿™äº›é¡¹ç›®è¯å®äº†å°†ç½‘ç»œåŠŸèƒ½æ”¾å…¥å¤–éƒ¨è¿è¡Œæ—¶ä»£ç†çš„è¶‹åŠ¿ã€‚Skupperé€šè¿‡ç¬¬7å±‚è™šæ‹Ÿç½‘ç»œè§£å†³äº†å¤šé›†ç¾¤é—´çš„é€šä¿¡éš¾é¢˜ï¼Œå¹¶æä¾›äº†å…ˆè¿›çš„è·¯ç”±å’Œè¿æ¥åŠŸèƒ½ã€‚ä½†æ˜¯ï¼ŒSkupperå¹¶æ²¡æœ‰è¢«åµŒå…¥åˆ°ä¸šåŠ¡æœåŠ¡è¿è¡Œæ—¶ä¸­ï¼Œè€Œæ˜¯æ¯ä¸ªKuberneteså‘½åç©ºé—´è¿è¡Œä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å®ä¾‹å……å½“å…±äº«çš„è¡¥å……å·¥å…·ã€‚&lt;/p>
&lt;p>ç»¼ä¸Šæ‰€è¿°ï¼Œå®¹å™¨å’ŒKubernetesåœ¨åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†æ–¹é¢è¿ˆå‡ºäº†é‡è¦çš„ä¸€æ­¥ã€‚æœåŠ¡ç½‘æ ¼å’Œç›¸å…³æŠ€æœ¯é‡åˆ°äº†çœŸæ­£çš„ç—›ç‚¹ï¼Œå¹¶ä¸ºå°†æ›´å¤šèŒè´£ä»åº”ç”¨ç¨‹åºç§»åˆ°ä»£ç†ä¸­å¥ å®šäº†åŸºç¡€ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ä¸‹ä¸€æ­¥ã€‚&lt;/p>
&lt;h3 id="çŠ¶æ€-1">çŠ¶æ€&lt;/h3>
&lt;p>æˆ‘ä»¬åœ¨å‰é¢åˆ—å‡ºäº†ä¾èµ–çŠ¶æ€çš„ä¸»è¦é›†æˆåŸè¯­ã€‚ç®¡ç†çŠ¶æ€éå¸¸å›°éš¾ï¼Œåº”å°†å…¶å§”æ´¾ç»™ä¸“é—¨çš„å­˜å‚¨è½¯ä»¶å’Œæ‰˜ç®¡æœåŠ¡ã€‚è¿™ä¸æ˜¯è¿™é‡Œçš„ä¸»é¢˜ï¼Œè€Œæ˜¯åœ¨è¯­è¨€æ— å…³çš„æŠ½è±¡ä¸­ä½¿ç”¨çŠ¶æ€æ¥å¸®åŠ©é›†æˆç”¨ä¾‹ã€‚ä»Šå¤©ï¼Œè®¸å¤šåŠªåŠ›è¯•å›¾åœ¨è¯­è¨€æ— å…³çš„æŠ½è±¡åé¢æä¾›æœ‰çŠ¶æ€çš„åŸè¯­ã€‚æœ‰çŠ¶æ€çš„å·¥ä½œæµç®¡ç†æ˜¯åŸºäºäº‘çš„æœåŠ¡ä¸­çš„å¼ºåˆ¶æ€§åŠŸèƒ½ï¼Œä¾‹å¦‚AWS Step Functionsï¼ŒAzure Durable Functionsç­‰ç¤ºä¾‹ã€‚åœ¨åŸºäºå®¹å™¨çš„éƒ¨ç½²ä¸­ï¼ŒCloudStateå’ŒDapréƒ½ä¾èµ–äºsidecaræ¨¡å‹æ¥è¿›ä¸€æ­¥è§£è€¦åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºä¸­çš„çŠ¶æ€æŠ½è±¡ã€‚&lt;/p>
&lt;p>æˆ‘ä¹ŸæœŸå¾…å°†ä¸Šé¢åˆ—å‡ºçš„æ‰€æœ‰æœ‰çŠ¶æ€åŠŸèƒ½æŠ½è±¡åˆ°ä¸€ä¸ªå•ç‹¬çš„è¿è¡Œæ—¶ä¸­ã€‚è¿™æ„å‘³ç€å·¥ä½œæµç®¡ç†ã€å•ä¾‹ã€å¹‚ç­‰ã€äº‹åŠ¡ç®¡ç†ã€cronä½œä¸šè§¦å‘å™¨å’Œæœ‰çŠ¶æ€é”™è¯¯å¤„ç†éƒ½å¯é åœ°å‘ç”Ÿåœ¨Sidecarï¼ˆæˆ–ä¸»æœºçº§ä»£ç†ï¼‰ä¸­ï¼Œè€Œä¸æ˜¯å­˜åœ¨äºæœåŠ¡ä¸­ã€‚ä¸šåŠ¡é€»è¾‘ä¸éœ€è¦åœ¨åº”ç”¨ç¨‹åºä¸­åŒ…å«æ­¤ç±»ä¾èµ–å…³ç³»å’Œè¯­ä¹‰ï¼Œå¹¶ä¸”å¯ä»¥ä»ç»‘å®šç¯å¢ƒä¸­å£°æ˜æ€§åœ°è¯·æ±‚æ­¤ç±»è¡Œä¸ºã€‚ä¾‹å¦‚ï¼ŒSidecarå¯ä»¥å……å½“cronä½œä¸šè§¦å‘å™¨ã€å¹‚ç­‰æ¶ˆè´¹è€…å’Œå·¥ä½œæµç®¡ç†å™¨ï¼Œè€Œè‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘å¯ä»¥ä½œä¸ºå›è°ƒè°ƒç”¨æˆ–æ’å…¥å·¥ä½œæµçš„æŸäº›é˜¶æ®µã€é”™è¯¯å¤„ç†ã€ä¸´æ—¶è°ƒç”¨æˆ–å”¯ä¸€å¹‚ç­‰è¦æ±‚ç­‰ã€‚&lt;/p>
&lt;p>å¦ä¸€ä¸ªæœ‰çŠ¶æ€ç”¨ä¾‹æ˜¯ç¼“å­˜ã€‚æ— è®ºæ˜¯ç”±æœåŠ¡ç½‘æ ¼å±‚æ‰§è¡Œè¯·æ±‚ç¼“å­˜ï¼Œè¿˜æ˜¯ä½¿ç”¨è¯¸å¦‚Infinispanï¼ŒRedisï¼ŒHazelcastç­‰ä¹‹ç±»çš„æ•°æ®ç¼“å­˜ï¼Œéƒ½æœ‰ä¸€äº›å°†ç¼“å­˜åŠŸèƒ½æ¨åˆ°åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ä¹‹å¤–çš„ç¤ºä¾‹ã€‚&lt;/p>
&lt;h3 id="ç»‘å®š-1">ç»‘å®š&lt;/h3>
&lt;p>å°½ç®¡æˆ‘ä»¬çš„ä¸»é¢˜æ˜¯å°†æ‰€æœ‰åˆ†å¸ƒå¼éœ€æ±‚ä¸åº”ç”¨ç¨‹åºè¿è¡Œæ—¶è„±é’©ï¼Œä½†è¿™ç§è¶‹åŠ¿ä¹Ÿç»§ç»­ä¼´éšç€ç»‘å®šã€‚è¿æ¥å™¨ã€åè®®è½¬æ¢ã€æ¶ˆæ¯è½¬æ¢
ã€é”™è¯¯å¤„ç†å’Œå®‰å…¨ä¸­ä»‹éƒ½å¯ä»¥ç§»å‡ºæœåŠ¡è¿è¡Œæ—¶ã€‚æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ°é‚£é‡Œï¼Œä½†æ˜¯åœ¨è¯¸å¦‚Knativeå’ŒDaprä¹‹ç±»çš„é¡¹ç›®ä¸­æœè¿™ä¸ªæ–¹å‘è¿›è¡Œäº†å°è¯•ã€‚å°†æ‰€æœ‰è¿™äº›èŒè´£ç§»å‡ºåº”ç”¨ç¨‹åºè¿è¡Œæ—¶å°†å¯¼è‡´æ›´å°ï¼Œæ›´æ³¨é‡ä¸šåŠ¡é€»è¾‘çš„ä»£ç ã€‚è¿™æ ·çš„ä»£ç å°†åœ¨ç‹¬ç«‹äºåˆ†å¸ƒå¼ç³»ç»Ÿéœ€æ±‚çš„è¿è¡Œæ—¶ä¸­è¿è¡Œï¼Œè€Œåˆ†å¸ƒå¼ç³»ç»Ÿéœ€æ±‚å¯ä»¥ä½œä¸ºé¢„åŒ…è£…åŠŸèƒ½ä½¿ç”¨ã€‚&lt;/p>
&lt;p>Apache Camel-K é‡‡ç”¨äº†å¦ä¸€ç§æœ‰è¶£çš„æ–¹æ³•ã€‚è¯¥é¡¹ç›®æ²¡æœ‰ä½¿ç”¨æ¥ä¼´éšä¸»åº”ç”¨ç¨‹åºçš„ä»£ç†è¿è¡Œæ—¶ï¼Œè€Œæ˜¯ä¾é æ™ºèƒ½çš„Kubernetes Operatoræ¥æ„å»ºå…·æœ‰Kuberneteså’ŒKnativeçš„é™„åŠ å¹³å°åŠŸèƒ½çš„åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ã€‚åœ¨è¿™é‡Œï¼Œå•ä¸€ä»£ç†æ˜¯è´Ÿè´£åŒ…æ‹¬åº”ç”¨ç¨‹åºæ‰€éœ€çš„åˆ†å¸ƒå¼ç³»ç»ŸåŸè¯­çš„æ“ä½œå‘˜ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼ŒæŸäº›åˆ†å¸ƒå¼åŸè¯­å·²æ·»åŠ åˆ°åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ä¸­ï¼Œè€ŒæŸäº›å·²åœ¨å¹³å°ä¸­å¯ç”¨ï¼ˆä¹Ÿå¯èƒ½åŒ…æ‹¬Sidecarï¼‰ã€‚&lt;/p>
&lt;h2 id="æœªæ¥æ¶æ„è¶‹åŠ¿">æœªæ¥æ¶æ„è¶‹åŠ¿&lt;/h2>
&lt;p>æ¦‚æ‹¬åœ°è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œé€šè¿‡å°†åŠŸèƒ½éƒ¨ä»¶è½¬ç§»åˆ°å¹³å°çº§åˆ«ï¼Œåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„äº§å“åŒ–è¾¾åˆ°äº†æ–°çš„é¢†åŸŸã€‚é™¤äº†ç”Ÿå‘½å‘¨æœŸä¹‹å¤–ï¼Œç°åœ¨æˆ‘ä»¬è¿˜å¯ä»¥è§‚å¯Ÿåˆ°è”ç½‘ï¼ŒçŠ¶æ€æŠ½è±¡ï¼Œå£°æ˜æ€§äº‹ä»¶å’Œç«¯ç‚¹ç»‘å®šï¼ˆæ‹†ç®±å³ç”¨ï¼‰ï¼Œå¹¶ä¸”EIPsåœ¨æ­¤åˆ—è¡¨ä¸­æ’åœ¨åé¢ã€‚æœ‰è¶£çš„æ˜¯ï¼Œäº§å“åŒ–ä½¿ç”¨è¿›ç¨‹å¤–æ¨¡å‹ï¼ˆsidecarï¼‰è¿›è¡ŒåŠŸèƒ½æ‰©å±•ï¼Œè€Œä¸æ˜¯ä½¿ç”¨è¿è¡Œæ—¶åº“æˆ–çº¯å¹³å°åŠŸèƒ½ï¼ˆä¾‹å¦‚æ–°çš„KubernetesåŠŸèƒ½ï¼‰ã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¯‘è€…ï¼šäº§å“åŒ–å¯ä»¥ç†è§£ä¸ºåˆ†å¸ƒå¼åŸè¯­çš„å†…èšï¼šä¾¿äºç‹¬ç«‹å‘å¸ƒå’Œæ¼”è¿›ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ç°åœ¨ï¼Œæˆ‘ä»¬é€šè¿‡å°†æ‰€æœ‰ä¼ ç»Ÿçš„ä¸­é—´ä»¶åŠŸèƒ½ï¼ˆä¹Ÿç§°ä¸ºESBï¼‰è½¬ç§»åˆ°å…¶ä»–è¿è¡Œæ—¶ä¸­æ¥ï¼Œä¸ä¹…ï¼Œæˆ‘ä»¬åœ¨æœåŠ¡ä¸­è¦åšçš„å°±åªæ˜¯ç¼–å†™ä¸šåŠ¡é€»è¾‘ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/04/01/15857495038535.jpg" alt="">
ä¼ ç»Ÿä¸­é—´ä»¶å¹³å°å’Œäº‘åŸç”Ÿå¹³å°æ¦‚è¿°&lt;/p>
&lt;p>ä¸ä¼ ç»Ÿçš„ESBæ—¶ä»£ç›¸æ¯”ï¼Œæ­¤ä½“ç³»ç»“æ„å°†ä¸šåŠ¡é€»è¾‘ä¸å¹³å°æ›´å¥½åœ°åˆ†ç¦»äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å®Œå…¨åˆ†ç¦»ã€‚è®¸å¤šåˆ†å¸ƒå¼åŸè¯­ï¼Œä¾‹å¦‚ç»å…¸çš„ä¼ä¸šé›†æˆæ¨¡å¼ï¼ˆEIPï¼‰ï¼šæ‹†åˆ†å™¨ã€èšåˆå™¨ã€è¿‡æ»¤å™¨ã€åŸºäºå†…å®¹çš„è·¯ç”±å™¨ï¼›æµå¤„ç†æ¨¡å¼ï¼šæ˜ å°„ã€è¿‡æ»¤ã€æŠ˜å ã€è”æ¥ã€åˆå¹¶ã€æ»‘åŠ¨çª—å£ï¼›ä»ç„¶å¿…é¡»åŒ…å«åœ¨ä¸šåŠ¡é€»è¾‘è¿è¡Œæ—¶ä¸­ï¼Œè®¸å¤šå…¶ä»–ä¾èµ–äºå¤šä¸ªä¸åŒä¸”é‡å çš„å¹³å°é™„åŠ ç»„ä»¶ã€‚&lt;/p>
&lt;p>å¦‚æœæˆ‘ä»¬å°†åœ¨ä¸åŒé¢†åŸŸè¿›è¡Œåˆ›æ–°çš„å„ç§äº‘åŸç”Ÿé¡¹ç›®è¿›è¡Œå †å ï¼Œé‚£ä¹ˆæœ€ç»ˆå°†å¾—åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/04/01/15857496466055.jpg" alt="">
å¤šè¿è¡Œæ—¶å¾®æœåŠ¡&lt;/p>
&lt;p>è¿™é‡Œçš„å›¾ä»…ç”¨äºè¯´æ˜ç›®çš„ï¼Œå®ƒæœ‰ç›®çš„åœ°é€‰æ‹©ä»£è¡¨æ€§çš„é¡¹ç›®å¹¶å°†å…¶æ˜ å°„åˆ°åˆ†å¸ƒå¼åŸè¯­çš„ç±»åˆ«ã€‚å®é™…ä¸Šï¼Œæ‚¨ä¸ä¼šåŒæ—¶ä½¿ç”¨æ‰€æœ‰è¿™äº›é¡¹ç›®ï¼Œå› ä¸ºå…¶ä¸­ä¸€äº›é¡¹ç›®æ˜¯é‡å çš„ä¸”ä¸å…¼å®¹çš„å·¥ä½œè´Ÿè½½æ¨¡å‹ã€‚å¦‚ä½•è§£é‡Šè¿™ä¸ªå›¾ï¼Ÿ&lt;/p>
&lt;ul>
&lt;li>Kuberneteså’Œå®¹å™¨åœ¨å¤šè¯­è¨€åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸­å–å¾—äº†å·¨å¤§é£è·ƒï¼Œå¹¶ä¸ºæœªæ¥çš„åˆ›æ–°å¥ å®šäº†åŸºç¡€ã€‚&lt;/li>
&lt;li>æœåŠ¡ç½‘æ ¼æŠ€æœ¯é€šè¿‡é«˜çº§ç½‘ç»œåŠŸèƒ½åœ¨Kubernetesä¸Šè¿›è¡Œäº†æ”¹è¿›ï¼Œå¹¶å¼€å§‹æ¶‰è¶³åº”ç”¨ç¨‹åºæ–¹é¢ã€‚&lt;/li>
&lt;li>å°½ç®¡Knativeé€šè¿‡å¿«é€Ÿæ‰©å±•ä¸»è¦ä¸“æ³¨äºæ— æœåŠ¡å™¨å·¥ä½œè´Ÿè½½ï¼Œä½†å®ƒä¹Ÿæ»¡è¶³äº†æœåŠ¡ç¼–æ’å’Œäº‹ä»¶é©±åŠ¨çš„ç»‘å®šéœ€æ±‚ã€‚&lt;/li>
&lt;li>Daprä»¥Kubernetesã€Knativeå’ŒService Meshçš„æ€æƒ³ä¸ºåŸºç¡€ï¼Œå¹¶æ·±å…¥åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ä»¥è§£å†³æœ‰çŠ¶æ€çš„å·¥ä½œè´Ÿè½½ã€ç»‘å®šå’Œé›†æˆéœ€æ±‚ï¼Œå……å½“ç°ä»£çš„åˆ†å¸ƒå¼ä¸­é—´ä»¶ã€‚&lt;/li>
&lt;/ul>
&lt;p>è¯¥å›¾å¯å¸®åŠ©æ‚¨ç›´è§‚åœ°çœ‹åˆ°ï¼Œå¾ˆå¯èƒ½åœ¨å°†æ¥ï¼Œæˆ‘ä»¬æœ€ç»ˆå°†ä½¿ç”¨å¤šä¸ªè¿è¡Œæ—¶æ¥å®ç°åˆ†å¸ƒå¼ç³»ç»Ÿã€‚å¤šä¸ªè¿è¡Œæ—¶ï¼Œä¸æ˜¯å› ä¸ºæœ‰å¤šä¸ªå¾®æœåŠ¡ï¼Œè€Œæ˜¯å› ä¸ºæ¯ä¸ªå¾®æœåŠ¡éƒ½å°†ç”±å¤šä¸ªè¿è¡Œæ—¶ç»„æˆï¼Œæœ€æœ‰å¯èƒ½æ˜¯ä¸¤ä¸ªè¿è¡Œæ—¶-&lt;strong>è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘è¿è¡Œæ—¶&lt;/strong>å’Œ&lt;strong>åˆ†å¸ƒå¼åŸè¯­è¿è¡Œæ—¶&lt;/strong>ã€‚&lt;/p>
&lt;h2 id="å¼•å…¥å¤šè¿è¡Œæ—¶å¾®æœåŠ¡">å¼•å…¥å¤šè¿è¡Œæ—¶å¾®æœåŠ¡&lt;/h2>
&lt;p>è¿™æ˜¯å¼€å§‹å½¢æˆçš„å¤šè¿è¡Œæ—¶å¾®æœåŠ¡ä½“ç³»ç»“æ„çš„ç®€è¦è¯´æ˜ã€‚&lt;/p>
&lt;p>æ‚¨è¿˜è®°å¾—ç§‘å­¦å®¶ä»¬åˆ¶ä½œçš„ç”µå½±ä¸­çš„Avatarå’Œæœºç”²ï¼ˆæœºæ¢°å¥—ä»¶ï¼‰ï¼Œä»–ä»¬å»æ—·é‡æ¢ç´¢æ½˜å¤šæ‹‰å—ï¼Ÿè¿™ç§å¤šè¿è¡Œæ—¶æ¶æ„ç±»ä¼¼äºè¿™äº›Mecha-ä¸ºç±»äººåŠ¨ç‰©é©¾é©¶å‘˜èµ‹äºˆè¶…èƒ½åŠ›çš„å¥—è£…ã€‚åœ¨ç”µå½±ä¸­ï¼Œæ‚¨è¦ç©¿ä¸Šå¥—è£…æ‰èƒ½è·å¾—åŠ›é‡å¹¶è·å¾—ç ´åæ€§æ­¦å™¨ã€‚åœ¨è¿™ç§è½¯ä»¶æ¶æ„ä¸­ï¼Œæ‚¨å…·æœ‰æ„æˆåº”ç”¨ç¨‹åºæ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘ï¼ˆç§°ä¸ºmicrologicå¾®é€»è¾‘ï¼‰å’Œæä¾›å¼ºå¤§ä¸”æ‹†ç®±å³ç”¨çš„åˆ†å¸ƒå¼åŸè¯­çš„sidecar mechaç»„ä»¶ã€‚å¾®é€»è¾‘ä¸mechaåŠŸèƒ½ç›¸ç»“åˆï¼Œå½¢æˆäº†ä¸€ä¸ªå¤šè¿è¡Œæ—¶å¾®æœåŠ¡ï¼Œè¯¥æœåŠ¡å°†è¿›ç¨‹å¤–åŠŸèƒ½ç”¨äºè§£å†³å…¶åˆ†å¸ƒå¼ç³»ç»Ÿéœ€æ±‚ã€‚æœ€æ£’çš„æ˜¯ï¼ŒAvatar 2å³å°†é¢ä¸–ï¼Œä»¥å¸®åŠ©æ¨å¹¿è¿™ç§æ¶æ„ã€‚æˆ‘ä»¬æœ€ç»ˆå¯ä»¥åœ¨æ‰€æœ‰è½¯ä»¶ä¼šè®®ä¸Šç”¨ä»¤äººèµå¹çš„æœºç”²å›¾ç‰‡ä»£æ›¿è€å¼çš„è¾¹è½¦æ‘©æ‰˜è½¦ï¼›-)ã€‚æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹è¯¥è½¯ä»¶ä½“ç³»ç»“æ„çš„è¯¦ç»†ä¿¡æ¯ã€‚&lt;/p>
&lt;p>è¿™æ˜¯ä¸€ä¸ªç±»ä¼¼äºå®¢æˆ·ç«¯-æœåŠ¡å™¨ä½“ç³»ç»“æ„çš„ä¸¤ç»„ä»¶æ¨¡å‹ï¼Œå…¶ä¸­æ¯ä¸ªç»„ä»¶éƒ½æ˜¯ç‹¬ç«‹çš„è¿è¡Œæ—¶ã€‚å®ƒä¸çº¯å®¢æˆ·ç«¯-æœåŠ¡å™¨ä½“ç³»ç»“æ„çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œè¿™ä¸¤ä¸ªç»„ä»¶éƒ½ä½äºåŒä¸€ä¸»æœºä¸Šï¼Œå½¼æ­¤ä¹‹é—´æ²¡æœ‰å¯é çš„ç½‘ç»œè¿æ¥ã€‚è¿™ä¸¤ä¸ªç»„ä»¶çš„é‡è¦æ€§ç›¸åŒï¼Œå®ƒä»¬å¯ä»¥åœ¨ä»»ä¸€æ–¹å‘ä¸Šå¯åŠ¨æ“ä½œå¹¶å……å½“å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨ã€‚å…¶ä¸­çš„ä¸€ä¸ªç»„ä»¶ç§°ä¸ºä¸ºé€»è¾‘ï¼ˆMicrologicï¼‰ï¼Œå®ƒæ‹¥æœ‰ä»å‡ ä¹æ‰€æœ‰åˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜ä¸­å‰¥ç¦»å‡ºæ¥çš„éå¸¸å°‘çš„ä¸šåŠ¡é€»è¾‘ã€‚å¦ä¸€ä¸ªéšé™„çš„ç»„ä»¶æ˜¯Mechaï¼Œå®ƒæä¾›äº†æˆ‘ä»¬åœ¨æœ¬æ–‡ä¸­ä¸€ç›´è®¨è®ºçš„æ‰€æœ‰åˆ†å¸ƒå¼ç³»ç»ŸåŠŸèƒ½ï¼ˆç”Ÿå‘½å‘¨æœŸé™¤å¤–ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¹³å°åŠŸèƒ½ï¼‰ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/04/01/15857504765833.jpg" alt="">
å¤šè¿è¡Œæ—¶ï¼ˆè¿›ç¨‹å¤–ï¼‰å¾®æœåŠ¡æ¶æ„&lt;/p>
&lt;p>Micrologicå’ŒMechaå¯èƒ½æ˜¯ä¸€å¯¹ä¸€çš„éƒ¨ç½²ï¼ˆç§°ä¸ºsidecaræ¨¡å‹ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯å¸¦æœ‰å‡ ä¸ªMicrologicè¿è¡Œæ—¶çš„å…±äº«Mechaã€‚ç¬¬ä¸€ç§æ¨¡å‹æœ€é€‚ç”¨äºKubernetesç­‰ç¯å¢ƒï¼Œè€Œç¬¬äºŒç§æ¨¡å‹åˆ™é€‚ç”¨äºè¾¹ç¼˜éƒ¨ç½²ã€‚&lt;/p>
&lt;h3 id="å¾®é€»è¾‘è¿è¡Œæ—¶ç‰¹å¾">å¾®é€»è¾‘è¿è¡Œæ—¶ç‰¹å¾&lt;/h3>
&lt;p>è®©æˆ‘ä»¬ç®€è¦åœ°æ¢è®¨Micrologicè¿è¡Œæ—¶çš„ä¸€äº›ç‰¹å¾ï¼š&lt;/p>
&lt;ul>
&lt;li>Micrologicç»„ä»¶æœ¬èº«ä¸æ˜¯å¾®æœåŠ¡ã€‚å®ƒåŒ…å«å¾®æœåŠ¡å°†å…·æœ‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯è¯¥é€»è¾‘åªèƒ½ä¸Mechaç»„ä»¶ç»“åˆä½¿ç”¨ã€‚å¦ä¸€æ–¹é¢ï¼Œå¾®æœåŠ¡æ˜¯è‡ªåŒ…å«çš„ï¼Œæ²¡æœ‰æ•´ä½“åŠŸèƒ½çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ²¡æœ‰ä¸€éƒ¨åˆ†å¤„ç†æµç¨‹æ‰©å±•åˆ°å…¶ä»–è¿è¡Œæ—¶ä¸­ã€‚MicrologicåŠå…¶ä¸Mechaå¯¹åº”çš„äº§å“çš„ç»„åˆå½¢æˆäº†å¾®æœåŠ¡ã€‚&lt;/li>
&lt;li>è¿™ä¹Ÿä¸æ˜¯å‡½æ•°æˆ–æ— æœåŠ¡å™¨æ¶æ„ã€‚æ— æœåŠ¡å™¨æœ€è‘—åçš„æ˜¯å…¶æä¾›çš„å¿«é€Ÿæ‰©å±•å’Œä»é›¶æ‰©å±•åˆ°é›¶çš„èƒ½åŠ›ã€‚åœ¨æ— æœåŠ¡å™¨ä½“ç³»ç»“æ„ä¸­ï¼Œå‡½æ•°å®ç°å•ä¸ªæ“ä½œï¼Œå› ä¸ºè¿™æ˜¯å¯ä¼¸ç¼©æ€§çš„å•ä½ã€‚åœ¨è¿™æ–¹é¢ï¼Œå‡½æ•°ä¸åŒäºå®ç°å¤šç§æ“ä½œçš„Micrologicï¼Œä½†å®ç°æ–¹å¼ä¸æ˜¯ç«¯åˆ°ç«¯çš„ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œæ“ä½œçš„å®ç°åˆ†å¸ƒåœ¨Mechaå’ŒMicrologicè¿è¡Œæ—¶ä¸Šã€‚&lt;/li>
&lt;li>è¿™æ˜¯å®¢æˆ·ç«¯-æœåŠ¡å™¨ä½“ç³»ç»“æ„çš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œé’ˆå¯¹æ— éœ€ç¼–ç å³å¯ä½¿ç”¨ä¼—æ‰€å‘¨çŸ¥çš„åˆ†å¸ƒå¼åŸè¯­è¿›è¡Œäº†ä¼˜åŒ–ã€‚å¦å¤–ï¼Œå¦‚æœæˆ‘ä»¬å‡è®¾Mechaæ‰®æ¼”æœåŠ¡å™¨è§’è‰²ï¼Œé‚£ä¹ˆæ¯ä¸ªå®ä¾‹éƒ½å¿…é¡»ç»è¿‡ä¸“é—¨é…ç½®ä»¥ä¾¿ä¸å•ä¸ªå®¢æˆ·ç«¯ä¸€èµ·å·¥ä½œã€‚å®ƒä¸æ˜¯é‚£ç§æ—¨åœ¨ä¸å…¸å‹çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨ä½“ç³»ç»“æ„åŒæ—¶æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯çš„é€šç”¨æœåŠ¡å™¨å®ä¾‹ã€‚ï¼ˆè¯‘è€…ï¼šå¤šè¿è¡Œæ—¶æ¶æ„ä¸­å‡å¦‚ mecha ä½œä¸ºæœåŠ¡ç«¯ï¼Œé‚£ä¹ˆå¾®é€»è¾‘ä½œä¸ºå®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„å…³ç³»å¤šä¸ºä¸€å¯¹ä¸€ï¼Œæˆ–è€…å¤šå¯¹ä¸€ã€‚è€Œä¼ ç»Ÿå¾®æœåŠ¡æ¶æ„ä¸­çš„å®¢æˆ·ç«¯æœåŠ¡ç«¯ä¸€èˆ¬æ˜¯å¤šå¯¹å¤šï¼‰&lt;/li>
&lt;li>Micrologicä¸­çš„ç”¨æˆ·ä»£ç ä¸ä¼šç›´æ¥ä¸å…¶ä»–ç³»ç»Ÿäº¤äº’ï¼Œä¹Ÿä¸ä¼šå®ç°ä»»ä½•åˆ†å¸ƒå¼ç³»ç»ŸåŸè¯­ã€‚å®ƒé€šè¿‡äº‹å®ä¸Šçš„æ ‡å‡†ï¼ˆä¾‹å¦‚HTTP / gRPCï¼ŒCloudEventsè§„èŒƒï¼‰ä¸Mechaè¿›è¡Œäº¤äº’ï¼Œå¹¶ä¸”Mechaä½¿ç”¨ä¸°å¯Œçš„åŠŸèƒ½å¹¶åœ¨é…ç½®çš„æ­¥éª¤å’Œæœºåˆ¶çš„æŒ‡å¯¼ä¸‹ä¸å…¶ä»–ç³»ç»Ÿè¿›è¡Œé€šä¿¡ã€‚&lt;/li>
&lt;li>å°½ç®¡Micrologicä»…è´Ÿè´£å®ç°ä»åˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜ä¸­å‰¥ç¦»å‡ºæ¥çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†å®ƒä»å¿…é¡»è‡³å°‘å®ç°ä¸€äº›APIã€‚å®ƒå¿…é¡»å…è®¸Mechaå’Œå¹³å°é€šè¿‡é¢„å®šä¹‰çš„APIå’Œåè®®ä¸å…¶è¿›è¡Œäº¤äº’ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡éµå¾ªKuberneteséƒ¨ç½²çš„äº‘åŸç”Ÿè®¾è®¡åŸåˆ™ï¼‰ã€‚ï¼ˆè¯‘è€…ï¼šæ¯”å¦‚å¾®é€»è¾‘éœ€è¦å®ç°å¥åº·æ£€æŸ¥çš„ APIï¼Œæ–¹ä¾¿å¹³å°-Kubernetes æˆ–è€… mecha è¿›è¡Œå¥åº·æ£€æŸ¥ï¼‰&lt;/li>
&lt;/ul>
&lt;h3 id="mechaè¿è¡Œæ—¶ç‰¹å¾">Mechaè¿è¡Œæ—¶ç‰¹å¾&lt;/h3>
&lt;p>ä»¥ä¸‹æ˜¯ä¸€äº›Mechaè¿è¡Œæ—¶ç‰¹å¾ï¼š&lt;/p>
&lt;ul>
&lt;li>Mechaæ˜¯ä¸€ä¸ªé€šç”¨çš„ã€é«˜åº¦å¯é…ç½®çš„ã€å¯é‡ç”¨çš„ç»„ä»¶ã€æä¾›åˆ†å¸ƒå¼åŸè¯­ä½œä¸ºç°æˆçš„åŠŸèƒ½ã€‚&lt;/li>
&lt;li>Mechaçš„æ¯ä¸ªå®ä¾‹éƒ½å¿…é¡»é…ç½®ä¸ºä¸ä¸€ä¸ªMicrologicç»„ä»¶ï¼ˆè¾¹è½¦æ¨¡å‹ï¼‰ä¸€èµ·ä½¿ç”¨ï¼Œæˆ–è€…é…ç½®ä¸ºä¸å‡ ä¸ªç»„ä»¶å…±äº«ï¼ˆèŠ‚ç‚¹çº§åˆ«ï¼‰ã€‚&lt;/li>
&lt;li>Mechaä¸å¯¹Micrologicè¿è¡Œæ—¶åšä»»ä½•å‡è®¾ã€‚å®ƒä¸ä½¿ç”¨å¼€æ”¾åè®®å’Œæ ¼å¼ï¼ˆä¾‹å¦‚HTTP / gRPCï¼ŒJSONï¼ŒProtobufï¼ŒCloudEventsï¼‰çš„å¤šè¯­è¨€å¾®æœåŠ¡ç”šè‡³å•ç‰‡ç³»ç»Ÿä¸€èµ·ä½¿ç”¨ã€‚&lt;/li>
&lt;li>Mechaä»¥ç®€å•çš„æ–‡æœ¬æ ¼å¼ï¼ˆä¾‹å¦‚YAMLï¼ŒJSONï¼‰å£°æ˜æ€§åœ°é…ç½®ï¼Œè¯¥æ ¼å¼è¡¨æ˜è¦å¯ç”¨çš„åŠŸèƒ½ä»¥åŠå¦‚ä½•å°†å…¶ç»‘å®šåˆ°Micrologicç«¯ç‚¹ã€‚å¯¹äºä¸“é—¨çš„APIäº¤äº’ï¼Œå¯ä»¥ä¸ºMechané™„åŠ è§„èŒƒï¼Œä¾‹å¦‚OpenAPIï¼ŒAsyncAPIï¼ŒANSI-SQLç­‰ã€‚å¯¹äºç”±å¤šä¸ªå¤„ç†æ­¥éª¤ç»„æˆçš„æœ‰çŠ¶æ€å·¥ä½œæµï¼Œå¯ä»¥ä½¿ç”¨è¯¸å¦‚Amazon State Languageçš„è§„èŒƒã€‚å¯¹äºæ— çŠ¶æ€é›†æˆï¼Œå¯ä»¥ä½¿ç”¨ä¸Camel-K YAML DSLç±»ä¼¼çš„æ–¹æ³•æ¥ä½¿ç”¨ä¼ä¸šé›†æˆæ¨¡å¼ï¼ˆEIPï¼‰ã€‚è¿™é‡Œçš„å…³é”®ç‚¹æ˜¯ï¼Œæ‰€æœ‰è¿™äº›éƒ½æ˜¯Mechaæ— éœ€ç¼–ç å³å¯å®ç°çš„ç®€å•çš„ã€åŸºäºæ–‡æœ¬çš„ã€å£°æ˜æ€§çš„ã€å¤šç§è¯­è¨€çš„å®šä¹‰ã€‚è¯·æ³¨æ„ï¼Œè¿™äº›éƒ½æ˜¯æœªæ¥æ´¾çš„é¢„æµ‹ï¼Œå½“å‰ï¼Œæ²¡æœ‰ç”¨äºçŠ¶æ€ç¼–æ’æˆ–EIPçš„Mechasï¼Œä½†æ˜¯æˆ‘å¸Œæœ›ç°æœ‰çš„Mechasï¼ˆEnvoyï¼ŒDaprï¼ŒCloudstateç­‰ï¼‰å¾ˆå¿«å°±ä¼šå¼€å§‹æ·»åŠ æ­¤ç±»åŠŸèƒ½ã€‚Mechaæ˜¯åº”ç”¨ç¨‹åºçº§åˆ«çš„åˆ†å¸ƒå¼åŸè¯­æŠ½è±¡å±‚ã€‚&lt;/li>
&lt;li>ä¸å…¶ä¸ºäº†ä¸åŒç›®çš„è€Œä¾èµ–äºå¤šä¸ªä»£ç†çš„ï¼ˆä¾‹å¦‚ç½‘ç»œä»£ç†ã€ç¼“å­˜ä»£ç†ã€ç»‘å®šä»£ç†ï¼‰ï¼Œè€Œåº”è¯¥ç”±ä¸€ä¸ªMechaæä¾›æ‰€æœ‰è¿™äº›åŠŸèƒ½ã€‚ä¸€äº›åŠŸèƒ½ï¼ˆä¾‹å¦‚å­˜å‚¨ã€æ¶ˆæ¯æŒä¹…æ€§ã€ç¼“å­˜ç­‰ï¼‰çš„å®ç°å°†è¢«å…¶ä»–äº‘æˆ–æœ¬åœ°æœåŠ¡æ³¨å…¥å¹¶æ”¯æŒã€‚&lt;/li>
&lt;li>ä¸€äº›ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ‰å…³çš„åˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜å¯ä»¥ç”±ç®¡ç†å¹³å°ï¼ˆä¾‹å¦‚Kubernetesæˆ–å…¶ä»–äº‘æœåŠ¡ï¼‰æ¥å¤„ç†ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é€šç”¨çš„å¼€æ”¾è§„èŒƒï¼ˆä¾‹å¦‚Open App Modelï¼‰æä¾›çš„Mechaè¿è¡Œæ—¶ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="è¿™ç§æ¶æ„çš„ä¸»è¦å¥½å¤„æ˜¯ä»€ä¹ˆ">è¿™ç§æ¶æ„çš„ä¸»è¦å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/h3>
&lt;p>å¥½å¤„æ˜¯ä¸šåŠ¡é€»è¾‘å’Œè¶Šæ¥è¶Šå¤šçš„åˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜ä¹‹é—´çš„è€¦åˆå˜å¾—æ¾æ•£ã€‚è½¯ä»¶ç³»ç»Ÿçš„è¿™ä¸¤ä¸ªè¦ç´ å…·æœ‰å®Œå…¨ä¸åŒçš„åŠ¨åŠ›å­¦ã€‚ä¸šåŠ¡é€»è¾‘å§‹ç»ˆæ˜¯å†…éƒ¨ç¼–å†™çš„å”¯ä¸€çš„è‡ªå®šä¹‰ä»£ç ã€‚å®ƒç»å¸¸æ›´æ”¹ï¼Œå…·ä½“å–å†³äºæ‚¨çš„ç»„ç»‡ä¼˜å…ˆçº§å’Œæ‰§è¡Œèƒ½åŠ›ã€‚å¦ä¸€æ–¹é¢ï¼Œç”¨äºè§£å†³æœ¬æ–‡ä¸­åˆ—å‡ºçš„é—®é¢˜çš„åˆ†å¸ƒå¼åŸè¯­ï¼Œå¹¶ä¸”ä¼—æ‰€å‘¨çŸ¥ã€‚è¿™äº›ç”±è½¯ä»¶ä¾›åº”å•†å¼€å‘ï¼Œå¹¶ä½œä¸ºåº“ï¼Œå®¹å™¨æˆ–æœåŠ¡ä½¿ç”¨ã€‚è¯¥ä»£ç æ ¹æ®ä¾›åº”å•†çš„ä¼˜å…ˆçº§ã€å‘å¸ƒå‘¨æœŸã€å®‰å…¨è¡¥ä¸ã€å¼€æ”¾æºä»£ç ç®¡ç†è§„åˆ™ç­‰è€Œæ›´æ”¹ã€‚è¿™ä¸¤éƒ¨åˆ†ä¹‹é—´å‡ ä¹ä¸å¯è§å¹¶ä¸”æ— æ³•ç›¸äº’æ§åˆ¶ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/04/01/15857520911736.jpg" alt="">
ä¸šåŠ¡é€»è¾‘å’Œåˆ†å¸ƒå¼ç³»ç»Ÿå…³æ³¨ä¸åŒæ¶æ„ä¸­çš„è€¦åˆ&lt;/p>
&lt;p>å¾®æœåŠ¡åŸç†æœ‰åŠ©äºé€šè¿‡æœ‰é™çš„ä¸Šä¸‹æ–‡ä½¿ä¸åŒçš„ä¸šåŠ¡é¢†åŸŸè„±é’©ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½å¯ä»¥ç‹¬ç«‹å‘å±•ã€‚ä½†æ˜¯å¾®æœåŠ¡æ¶æ„æ— æ³•è§£å†³å°†ä¸šåŠ¡é€»è¾‘ä¸ä¸­é—´ä»¶é—®é¢˜è€¦åˆåœ¨ä¸€èµ·å¸¦æ¥çš„å›°éš¾ã€‚å¯¹äºæŸäº›ä¾èµ–äºé›†æˆç”¨ä¾‹çš„å¾®æœåŠ¡ï¼Œè¿™å¯èƒ½ä¸æ˜¯ä¸€ä¸ªå¤§å› ç´ ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„é¢†åŸŸæ¶‰åŠå¤æ‚çš„é›†æˆï¼ˆä¹Ÿæ˜¯è¶Šæ¥è¶Šå¤šçš„äººæ‰€é¢ä¸´çš„ï¼‰ï¼Œé‚£ä¹ˆéµå¾ªå¾®æœåŠ¡åŸåˆ™ä¹Ÿæ— æ³•å¸®åŠ©æ‚¨é¿å…ä¸ä¸­é—´ä»¶çš„è€¦åˆã€‚å³ä½¿ä¸­é—´ä»¶æ˜¯ä¸ºæ‚¨åŒ…å«åœ¨å¾®æœåŠ¡ä¸­çš„åº“ï¼Œå½“æ‚¨å¼€å§‹è¿ç§»å’Œæ›´æ”¹è¿™äº›åº“æ—¶ï¼Œè¿™ç§è€¦åˆä¾¿ä¼šæ˜¾ç°å‡ºæ¥ã€‚è¿˜æœ‰æ‚¨éœ€è¦çš„åˆ†å¸ƒçš„åŸè¯­è¶Šå¤šï¼Œæ‚¨ä¸é›†æˆå¹³å°çš„è€¦åˆå°±è¶Šå¼ºã€‚é€šè¿‡é¢„å®šä¹‰çš„APIï¼ˆè€Œä¸æ˜¯åº“ï¼‰æ¥è®¿é—®ä½œä¸ºç‹¬ç«‹è¿è¡Œæ—¶/è¿›ç¨‹çš„ä¸­é—´ä»¶ï¼Œæœ‰åŠ©äºè§£è€¦å¹¶å®ç°æ¯ä¸ªç»„ä»¶çš„ç‹¬ç«‹æ¼”è¿›ã€‚&lt;/p>
&lt;p>è¿™ä¹Ÿæ˜¯ä¸ºä¾›åº”å•†åˆ†å‘å’Œç»´æŠ¤å¤æ‚çš„ä¸­é—´ä»¶è½¯ä»¶çš„è¾ƒå¥½çš„æ–¹æ³•ã€‚åªè¦ä¸ä¸­é—´ä»¶çš„äº¤äº’æ˜¯é€šè¿‡å¼€æ”¾APIå’Œæ ‡å‡†çš„è¿›ç¨‹é—´é€šä¿¡è¿›è¡Œçš„ï¼Œè½¯ä»¶ä¾›åº”å•†å°±å¯ä»¥æŒ‰ç…§è‡ªå·±çš„èŠ‚å¥è‡ªç”±å‘å¸ƒè¡¥ä¸å’Œå‡çº§ã€‚æ¶ˆè´¹è€…å¯ä»¥è‡ªç”±ä½¿ç”¨ä»–ä»¬å–œæ¬¢çš„è¯­è¨€ã€åº“ã€è¿è¡Œæ—¶ã€éƒ¨ç½²æ–¹æ³•å’Œè¿‡ç¨‹ã€‚&lt;/p>
&lt;h3 id="è¿™ç§æ¶æ„çš„ä¸»è¦ç¼ºç‚¹æ˜¯ä»€ä¹ˆ">è¿™ç§æ¶æ„çš„ä¸»è¦ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/h3>
&lt;p>è¿›ç¨‹é—´é€šä¿¡ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸šåŠ¡é€»è¾‘å’Œä¸­é—´ä»¶æœºåˆ¶ï¼ˆæ‚¨å¯ä»¥çœ‹åˆ°åç§°çš„æ¥æºï¼‰åœ¨ä¸åŒçš„è¿è¡Œæ—¶ä¸­ï¼Œå¹¶ä¸”éœ€è¦HTTPæˆ–gRPCè°ƒç”¨è€Œä¸æ˜¯è¿›ç¨‹å†…æ–¹æ³•è°ƒç”¨ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œè¿™å¹¶ä¸æ˜¯è·¨æœºå™¨æˆ–æ•°æ®ä¸­å¿ƒçš„ç½‘ç»œè°ƒç”¨ã€‚Micrologicè¿è¡Œæ—¶å’ŒMechaåº”å½“ä½äºåŒä¸€ä¸»æœºä¸Šï¼Œå¹¶ä¸”å»¶è¿Ÿæ—¶é—´çŸ­ï¼Œå¹¶ä¸”å‡ºç°ç½‘ç»œé—®é¢˜çš„å¯èƒ½æ€§æœ€å°ã€‚&lt;/p>
&lt;p>å¤æ‚ã€‚ä¸‹ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæ˜¯å¦å€¼å¾—ä¸ºè·å¾—æŸäº›å¥½å¤„è€Œè¿›è¡Œå¤æ‚çš„å¼€å‘ã€å¹¶ç»´æŠ¤æ­¤ç±»ç³»ç»Ÿã€‚æˆ‘è®¤ä¸ºç­”æ¡ˆå°†è¶Šæ¥è¶Šå€¾å‘äºæ˜¯ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿçš„éœ€æ±‚å’Œå‘å¸ƒå‘¨æœŸçš„æ­¥ä¼æ­£åœ¨å¢åŠ ï¼Œå¹¶ä¸”æ­¤æ¶æ„ä¸ºæ­¤è¿›è¡Œäº†ä¼˜åŒ–ã€‚æˆ‘å‰æ®µæ—¶é—´å†™é“ï¼Œæœªæ¥çš„å¼€å‘äººå‘˜å¿…é¡»å…·å¤‡æ··åˆå¼€å‘æŠ€èƒ½ã€‚è¿™ç§ä½“ç³»ç»“æ„è¿›ä¸€æ­¥è¯å®äº†è¿™ä¸€è¶‹åŠ¿ã€‚åº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†å°†ä½¿ç”¨é«˜çº§ç¼–ç¨‹è¯­è¨€ç¼–å†™ï¼Œéƒ¨åˆ†åŠŸèƒ½å°†ç”±å¿…é¡»è¿›è¡Œå£°æ˜æ€§é…ç½®çš„ç°æˆç»„ä»¶æä¾›ã€‚è¿™ä¸¤ä¸ªéƒ¨åˆ†çš„äº’è¿ä¸æ˜¯åœ¨ç¼–è¯‘æ—¶æˆ–åœ¨å¯åŠ¨æ—¶é€šè¿‡è¿›ç¨‹å†…ä¾èµ–æ³¨å…¥ï¼Œè€Œæ˜¯åœ¨éƒ¨ç½²æ—¶é€šè¿‡è¿›ç¨‹é—´é€šä¿¡äº’è¿ã€‚è¯¥æ¨¡å‹å¯å®ç°æ›´é«˜çš„è½¯ä»¶é‡ç”¨ç‡å’Œæ›´å¿«çš„å˜æ›´é€Ÿåº¦ã€‚&lt;/p>
&lt;h3 id="å¾®æœåŠ¡åæ— æ³•ä½¿ç”¨çš„åŠŸèƒ½">å¾®æœåŠ¡åæ— æ³•ä½¿ç”¨çš„åŠŸèƒ½&lt;/h3>
&lt;p>å¾®æœåŠ¡æ¶æ„æœ‰ä¸€ä¸ªæ˜ç¡®çš„ç›®æ ‡ã€‚å®ƒä¸ºå˜åŒ–è€Œä¼˜åŒ–ã€‚é€šè¿‡å°†åº”ç”¨ç¨‹åºåˆ’åˆ†åˆ°ä¸šåŠ¡åŸŸä¸­ï¼Œæ­¤è½¯ä»¶æ¶æ„é€šè¿‡ç‹¬ç«‹çš„å›¢é˜Ÿåˆ†ç¦»ã€ç®¡ç†å¹¶ä»¥ç‹¬ç«‹çš„æ­¥è°ƒå‘å¸ƒçš„æœåŠ¡ï¼Œä¸ºè½¯ä»¶æ¼”è¿›å’Œå¯ç»´æŠ¤æ€§æä¾›äº†æœ€ä½³çš„æœåŠ¡è¾¹ç•Œã€‚&lt;/p>
&lt;p>å¦‚æœæˆ‘ä»¬çœ‹ä¸€ä¸‹æ— æœåŠ¡å™¨ä½“ç³»ç»“æ„çš„ç¼–ç¨‹æ¨¡å‹ï¼Œå®ƒä¸»è¦åŸºäºåŠŸèƒ½ã€‚åŠŸèƒ½å·²é’ˆå¯¹å¯ä¼¸ç¼©æ€§è¿›è¡Œäº†ä¼˜åŒ–ã€‚é€šè¿‡åŠŸèƒ½ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªæ“ä½œåˆ†è§£ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç»„ä»¶ï¼Œä»¥ä¾¿å¯ä»¥å¿«é€Ÿï¼Œç‹¬ç«‹å’ŒæŒ‰éœ€æ‰©å±•ã€‚åœ¨æ­¤æ¨¡å‹ä¸­ï¼Œéƒ¨ç½²ç²’åº¦æ˜¯ä¸€é¡¹åŠŸèƒ½ã€‚ä¹‹æ‰€ä»¥é€‰æ‹©è¯¥å‡½æ•°ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯ä»£ç ç»“æ„ï¼šå…¶è¾“å…¥çš„é€Ÿç‡ä¸ç¼©æ”¾è¡Œä¸ºç›´æ¥ç›¸å…³ã€‚è¿™æ˜¯ä¸€ç§é’ˆå¯¹æç«¯å¯ä¼¸ç¼©æ€§ï¼ˆè€Œä¸æ˜¯å¤æ‚ç³»ç»Ÿçš„é•¿æœŸå¯ç»´æŠ¤æ€§ï¼‰è¿›è¡Œäº†ä¼˜åŒ–çš„ä½“ç³»ç»“æ„ã€‚&lt;/p>
&lt;p>ä»AWS Lambdaçš„æµè¡ŒåŠå…¶å®Œå…¨æ‰˜ç®¡çš„è¿è¥æ€§è´¨æ¥çœ‹ï¼ŒServerlessçš„å…¶ä»–æ–¹é¢åˆå¦‚ä½•å‘¢ï¼Ÿåœ¨è¿™æ–¹é¢ï¼Œâ€œAWSæ— æœåŠ¡å™¨â€ä¸ºé…ç½®é€Ÿåº¦è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä½†ç¼ºå°‘æ§åˆ¶å’Œé”å®šåŠŸèƒ½ã€‚ä½†æ˜¯å®Œå…¨æ‰˜ç®¡çš„æ–¹é¢ä¸æ˜¯åº”ç”¨ç¨‹åºä½“ç³»ç»“æ„ï¼Œè€Œæ˜¯ä¸€ç§è½¯ä»¶ä½¿ç”¨æ¨¡å‹ã€‚å®ƒåœ¨åŠŸèƒ½ä¸Šæ˜¯æ­£äº¤çš„ï¼Œç±»ä¼¼äºä½¿ç”¨åŸºäºSaaSçš„å¹³å°ï¼Œè¯¥å¹³å°åœ¨ç†æƒ³æƒ…å†µä¸‹åº”é€‚ç”¨äºä»»ä½•ç±»å‹çš„ä½“ç³»ç»“æ„ï¼Œæ— è®ºæ˜¯æ•´ä½“å¼ã€å¾®æœåŠ¡ã€æœºç”²è¿˜æ˜¯åŠŸèƒ½ã€‚åœ¨è®¸å¤šæ–¹é¢ï¼ŒAWS Lambdaç±»ä¼¼äºå®Œå…¨æ‰˜ç®¡çš„Mechaæ¶æ„ï¼Œä½†æœ‰ä¸€ä¸ªå¾ˆå¤§çš„åŒºåˆ«ï¼šMechaä¸æ‰§è¡ŒåŠŸèƒ½æ¨¡å‹ï¼Œè€Œæ˜¯å…è®¸å›´ç»•ä¸šåŠ¡åŸŸä½¿ç”¨æ›´å…·å‡èšåŠ›çš„ä»£ç æ„é€ ï¼Œè€Œä¸æ‰€æœ‰ä¸­é—´ä»¶æ— å…³ã€‚&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/04/01/15857521845846.jpg" alt="">
æ¶æ„ä¼˜åŒ–&lt;/p>
&lt;p>å¦ä¸€æ–¹é¢ï¼ŒMechaæ¶æ„ä¸ºä¸­é—´ä»¶ç‹¬ç«‹æ€§ä¼˜åŒ–äº†å¾®æœåŠ¡ã€‚å°½ç®¡å¾®æœåŠ¡å½¼æ­¤ç‹¬ç«‹ï¼Œä½†å®ƒä»¬åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºåµŒå…¥çš„åˆ†å¸ƒå¼åŸè¯­ã€‚Mechaæ¶æ„å°†è¿™ä¸¤ä¸ªé—®é¢˜åˆ†ä¸ºå•ç‹¬çš„è¿è¡Œæ—¶ï¼Œä»è€Œå…è®¸ç‹¬ç«‹å›¢é˜Ÿç‹¬ç«‹å‘å¸ƒå®ƒä»¬ã€‚è¿™ç§è§£è€¦å¯ä»¥æ”¹å–„ç¬¬äºŒå¤©ï¼ˆday-2ï¼‰çš„æ“ä½œï¼ˆä¾‹å¦‚ä¿®è¡¥å’Œå‡çº§ï¼‰ï¼Œå¹¶æ”¹å–„ä¸šåŠ¡é€»è¾‘å†…èšå•å…ƒçš„é•¿æœŸå¯ç»´æŠ¤æ€§ã€‚åœ¨è¿™æ–¹é¢ï¼ŒMechaæ¶æ„æ˜¯å¾®æœåŠ¡æ¶æ„çš„è‡ªç„¶å‘å±•ï¼Œå®ƒé€šè¿‡æ ¹æ®å¼•èµ·æœ€å¤§æ‘©æ“¦çš„è¾¹ç•Œæ‹†åˆ†è½¯ä»¶æ¥è¿›è¡Œå¼€å‘ã€‚ä¸åŠŸèƒ½æ¨¡å‹ç›¸æ¯”ï¼Œè¯¥ä¼˜åŒ–ä»¥è½¯ä»¶é‡ç”¨å’Œæ¼”åŒ–çš„å½¢å¼æä¾›äº†æ›´å¤šå¥½å¤„ï¼Œè€ŒåŠŸèƒ½æ¨¡å‹åˆ™ä»¥ä»£ç çš„è¿‡åº¦åˆ†é…ä¸ºä»£ä»·è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä»¥å®ç°æé«˜çš„å¯ä¼¸ç¼©æ€§ã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¯‘è€…ï¼šday-2å¯ä»¥ç†è§£ä¸ºå‰ä¸€å¤©çš„å‘å¸ƒå¸¦æ¥çš„é—®é¢˜éœ€è¦ç¬¬äºŒå¤©çš„å‘å¸ƒè¿›è¡Œä¿®å¤ï¼Œè€Œå¤šè¿è¡Œæ—¶è§£è€¦äº†ä¸šåŠ¡é€»è¾‘å’Œåˆ†å¸ƒå¼åŸè¯­ï¼Œå…è®¸å…¶ä¸­ä¸€ä¸ªçš„ç‹¬ç«‹å‘å¸ƒï¼Œä¸éœ€è¦ç»Ÿä¸€å®‰æ’å‡çº§çš„èŠ‚ç‚¹ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºæœ‰è®¸å¤šè¦æ±‚ã€‚åˆ›å»ºé«˜æ•ˆçš„åˆ†å¸ƒå¼ç³»ç»Ÿéœ€è¦å¤šç§æŠ€æœ¯å’Œè‰¯å¥½çš„é›†æˆæ–¹æ³•ã€‚å°½ç®¡ä¼ ç»Ÿçš„å•ä½“ä¸­é—´ä»¶æä¾›äº†åˆ†å¸ƒå¼ç³»ç»Ÿæ‰€éœ€çš„æ‰€æœ‰å¿…è¦çš„æŠ€æœ¯åŠŸèƒ½ï¼Œä½†å®ƒç¼ºä¹ä¸šåŠ¡æ‰€éœ€çš„å¿«é€Ÿæ›´æ”¹ã€é€‚åº”å’Œæ‰©å±•çš„èƒ½åŠ›ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåŸºäºå¾®æœåŠ¡çš„æ¶æ„èƒŒåçš„æ€æƒ³ä¸ºå®¹å™¨å’ŒKubernetesçš„å¿«é€Ÿæ™®åŠåšå‡ºäº†è´¡çŒ®ã€‚éšç€äº‘åŸç”Ÿé¢†åŸŸçš„æœ€æ–°å‘å±•ï¼Œæˆ‘ä»¬ç°åœ¨é€šè¿‡å°†æ‰€æœ‰ä¼ ç»Ÿä¸­é—´ä»¶åŠŸèƒ½è½¬ç§»åˆ°å¹³å°å’Œç°æˆçš„è¾…åŠ©è¿è¡Œæ—¶ä¸­æ¥å…¨é¢å‘å±•ã€‚&lt;/p>
&lt;p>åº”ç”¨ç¨‹åºåŠŸèƒ½çš„è¿™ç§äº§å“åŒ–ä¸»è¦æ˜¯ä½¿ç”¨è¿›ç¨‹å¤–æ¨¡å‹è¿›è¡ŒåŠŸèƒ½æ‰©å±•ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶åº“æˆ–çº¯å¹³å°åŠŸèƒ½ã€‚è¿™æ„å‘³ç€ï¼Œå°†æ¥å¾ˆæœ‰å¯èƒ½æˆ‘ä»¬å°†ä½¿ç”¨å¤šä¸ªè¿è¡Œæ—¶æ¥å®ç°åˆ†å¸ƒå¼ç³»ç»Ÿã€‚å¤šä¸ªè¿è¡Œæ—¶ï¼Œä¸æ˜¯å› ä¸ºæœ‰å¤šä¸ªå¾®æœåŠ¡ï¼Œè€Œæ˜¯å› ä¸ºæ¯ä¸ªå¾®æœåŠ¡éƒ½å°†ç”±å¤šä¸ªè¿è¡Œæ—¶ç»„æˆã€‚è‡ªå®šä¹‰å¾®ä¸šåŠ¡é€»è¾‘çš„è¿è¡Œæ—¶ï¼Œä»¥åŠæ‹†ç®±å³ç”¨çš„åˆ†å¸ƒå¼åŸè¯­è¿è¡Œæ—¶ã€‚&lt;/p>
&lt;h2 id="å…³äºä½œè€…">å…³äºä½œè€…&lt;/h2>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/04/01/15857522443912.jpg" alt="">&lt;/p>
&lt;p>Bilgin Ibryamæ˜¯Red Hatçš„é¦–å¸­æ¶æ„å¸ˆã€æäº¤è€…å’ŒApache Software Foundationçš„æˆå‘˜ã€‚ä»–æ˜¯ä¸€ä½å¼€æºçš„ä¼ æ’­è€…
ã€åšå®¢ä½œè€…ã€å¶å°”çš„æ¼”è®²è€…ï¼Œå¹¶ä¸”æ˜¯Kubernetes Patternså’ŒCamel Design Patternsä¹¦ç±çš„ä½œè€…ã€‚åœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼ŒBilginä¹äºæŒ‡å¯¼ã€ç¼–ç å¹¶å¸¦é¢†å¼€å‘äººå‘˜æˆåŠŸæ„å»ºå¼€æºè§£å†³æ–¹æ¡ˆã€‚ä»–å½“å‰çš„å·¥ä½œé›†ä¸­åœ¨åŒºå—é“¾ã€åˆ†å¸ƒå¼ç³»ç»Ÿã€å¾®æœåŠ¡ã€devopså’Œäº‘åŸç”Ÿåº”ç”¨ç¨‹åºå¼€å‘ä¸Šã€‚&lt;/p>
&lt;p>åŸæ–‡çš„æŸäº›è¿æ¥ï¼š&lt;/p>
&lt;ul>
&lt;li>12-Factorsï¼šhttps://12factor.net/zh_cn/&lt;/li>
&lt;li>åŸæ–‡ï¼šhttps://www.infoq.com/articles/multi-runtime-microservice-architecture/&lt;/li>
&lt;/ul></description></item><item><title>æ§åˆ¶ Pod å†…å®¹å™¨çš„å¯åŠ¨é¡ºåº</title><link>https://atbug.com/control-process-order-of-pod-containers/</link><pubDate>Thu, 12 Mar 2020 22:05:16 +0800</pubDate><guid>https://atbug.com/control-process-order-of-pod-containers/</guid><description>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2021/04/30/screenshot-20210430-at-092623.png" alt="">&lt;/p>
&lt;p>2021.4.30 æ›´æ–°ï¼š&lt;/p>
&lt;p>æœ€æ–°çš„æ–¹æ¡ˆï¼Œè¯·è·³è½¬æ–°ç¯‡ &lt;a href="https://mp.weixin.qq.com/s/8DqF_N_fjiM9AOouvddvgA">Kubernetes ä¸Šå¦‚ä½•æ§åˆ¶å®¹å™¨çš„å¯åŠ¨é¡ºåº&lt;/a>ã€‚&lt;/p>
&lt;hr>
&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>ä¼—æ‰€å‘¨çŸ¥, Kubernetes Pod å†…æœ‰ä¸¤ç§å®¹å™¨: åˆå§‹åŒ–å®¹å™¨(init container)å’Œåº”ç”¨å®¹å™¨(app container). å…¶ä¸­åˆå§‹åŒ–å®¹å™¨çš„æ‰§è¡Œå…ˆäºåº”ç”¨å®¹å™¨, å¹¶ä¸”åˆå§‹åŒ–å®¹å™¨å’Œåº”ç”¨å®¹å™¨çš„ä¸ªæ•°åˆ†åˆ«ä¸º &lt;code>0~n&lt;/code> å’Œ &lt;code>1~n&lt;/code>.&lt;/p>
&lt;p>åˆå§‹åŒ–å®¹å™¨ä¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œ, é¡ºåºæ‰§è¡Œçš„å‰ææ˜¯åˆå§‹åŒ–å®¹å™¨å§‹ç»ˆä¼šè¿è¡Œåˆ°å®Œæˆ(completed)çŠ¶æ€. è€Œåº”ç”¨å®¹å™¨æ°å¥½ç›¸å: å¯åŠ¨é¡ºåºéšæœº, å¹¶å§‹ç»ˆä¿æŒè¿è¡Œ(running)çŠ¶æ€.&lt;/p>
&lt;h2 id="é—®é¢˜">é—®é¢˜&lt;/h2>
&lt;p>å·¥ä½œä¸­æœ‰ä¸ªæ¶æ„çš„æ–¹æ¡ˆä½¿ç”¨åˆ°äº† sidecar å®¹å™¨: å°†åŸºç¡€ç»„ä»¶åŠŸèƒ½ä»å®¹å™¨è½¬ç§»åˆ° sidecar å®¹å™¨ä¸­, å…¶ä¸­æœ‰ä¸ªåŠŸèƒ½æ˜¯ä»è¿œç¨‹é…ç½®ä¸­å¿ƒè·å–é…ç½®å¹¶ä¿æŒå®æ—¶æ›´æ–°. ä¿è¯å®æ—¶æ›´æ–°æ²¡æœ‰é—®é¢˜, ä½†æ˜¯é…ç½®æ–‡ä»¶éœ€è¦åœ¨ app å¯åŠ¨ä¹‹å‰å®Œæˆåˆå§‹åŒ–.&lt;/p>
&lt;p>å¯¹äºåŒä¸º&amp;quot;åº”ç”¨å®¹å™¨&amp;quot;ç±»å‹çš„ sidecar å®¹å™¨æ¥è¯´, ç”±äºå®¹å™¨å¯åŠ¨é¡ºåºéšæœºè€Œæ— æ³•åšåˆ°è¿™ä¸€ç‚¹.&lt;/p>
&lt;p>å½“æ—¶æˆ‘ä»¬ç»™å®šçš„æ–¹æ¡ˆæ˜¯å¢åŠ ä¸€ä¸ªåˆå§‹åŒ–å®¹å™¨è¿›è¡Œé…ç½®çš„åˆå§‹åŒ–, ä¸å¯é¿å…çš„æˆ‘ä»¬éœ€è¦å¢åŠ ä¸€ä¸ªé¢å¤–çš„å®¹å™¨, å³ä½¿æ˜¯è¿™ä¸ªå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸéå¸¸çŸ­.&lt;/p>
&lt;p>è¿½æ±‚æè‡´çš„æˆ‘ä»¬æ€»æ˜¯å¯¹è¿™ä¸ªé¢å¤–å¢åŠ çš„å®¹å™¨è€¿è€¿äºæ€€: å‡å¦‚èƒ½æ§åˆ¶åº”ç”¨å®¹å™¨çš„å¯åŠ¨é¡ºåº&amp;hellip;&lt;/p>
&lt;h3 id="æ–°å‘ç°">æ–°å‘ç°&lt;/h3>
&lt;p>è¿‘æœŸåœ¨ç ”ç©¶ CDF (Continuous Delivery Foundation)ä¸‹çš„ &lt;a href="https://github.com/tektoncd">Tekton&lt;/a>, å…¶ä¸­æœ‰ä¸ªæ¦‚å¿µæ˜¯å…¶å°†æµæ°´çº¿(pipeline)ä¸­çš„å„ä¸ªæ­¥éª¤(step)ä½œä¸ºåº”ç”¨å®¹å™¨åœ¨åŒä¸€ä¸ª Pod ä¸­è¿è¡Œ.&lt;/p>
&lt;p>æˆ‘ä»¬éƒ½çŸ¥é“æµæ°´çº¿ä¸­çš„æ­¥éª¤æ˜¯æŒ‰ç…§å®šä¹‰çš„é¡ºåºæ‰§è¡Œçš„, é‚£ä¹ˆ Tekton æ˜¯å¦‚ä½•ä¿è¯åº”ç”¨å®¹å™¨çš„æ‰§è¡Œé¡ºåºçš„?&lt;/p>
&lt;p>æŸ¥çœ‹ pod çš„ manifest ä¹‹åå‘ç°äº†ä¸‹é¢çš„å®¹å™¨é…ç½® (è¿™ä¸ªå®¹å™¨çš„ä½œç”¨ä» git ä»“åº“å…‹éš†ä»£ç )&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">wait_file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/downward/ready&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">wait_file_content&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">post_file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/tools/0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">termination_path&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/termination&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/ko-app/git-init&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- --&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">http://gitlab.nip.io:8088/addozhang/tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">develop&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">path&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/workspace/git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tekton/tools/entrypoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…‹éš†ä»£ç çš„å‘½ä»¤æ˜¯:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">git-init -url http://gitlab.nip.io:8088/addozhang/tekton-test -revision develop -path /workspace/git-source
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯å®¹å™¨çš„å¯åŠ¨å‘½ä»¤æ˜¯&lt;code>/tekton/tools/entrypoint&lt;/code>å¹¶å¸¦ä¸Šäº†ä¸€å¨çš„å‚æ•°(æ­¤å¤„ç•¥è¿‡, åé¢åˆ†æ).&lt;/p>
&lt;p>ç¿»çœ‹äº†ä¸‹&lt;a href="https://github.com/tektoncd/pipeline/tree/master/cmd/entrypoint">æ–‡æ¡£&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>This binary is used to override the entrypoint of a container by wrapping it. In tektoncd/pipeline this is used to make sure Task&amp;rsquo;s steps are executed in order, or for sidecars.&lt;/p>
&lt;p>è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶è¢«ç”¨äºé€šè¿‡åŒ…è£…çš„æ–¹å¼æ¥è¦†ç›–å®¹å™¨çš„å…¥å£ç‚¹. åœ¨ tektoncd/pipeline ä¸­ç¡®ä¿ä»»åŠ¡ä¸­çš„æ­¥éª¤æˆ–è€… sidecar è¢«é¡ºåºåœ°æ‰§è¡Œ.&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>&lt;code>-entrypoint&lt;/code>: åŸå§‹çš„å®¹å™¨å¯åŠ¨å‘½ä»¤, ä½œä¸º &lt;code>entrypoint&lt;/code> çš„å­è¿›ç¨‹è¿è¡Œ. å³ä¸Šé¢çš„ &lt;code>git-init XXXX&lt;/code>&lt;/li>
&lt;li>&lt;code>-post_file&lt;/code>: å­è¿›ç¨‹è¿è¡Œç»“æŸåå†™çš„æ–‡ä»¶è·¯å¾„(å³ä¸Šé¢çš„&lt;code>/tekton/tools/0&lt;/code>). å¦‚æœå­è¿›ç¨‹æ‰§è¡Œå¤±è´¥, åˆ™å†™ä¸€ä¸ª&lt;code>{{post_file}}.err&lt;/code>æ–‡ä»¶, è€Œä¸æ˜¯&lt;code>{{post_file}}&lt;/code>&lt;/li>
&lt;li>&lt;code>-wait_file&lt;/code>: å¯åŠ¨å­è¿›ç¨‹&lt;strong>å‰&lt;/strong>ç›‘æ§çš„æ–‡ä»¶è·¯å¾„(å³ä¸Šé¢çš„&lt;code>/tekton/downward/ready&lt;/code>). é€šè¿‡ç›‘æ§åˆ°çš„&lt;code>{{watch_file}}&lt;/code>æˆ–è€…&lt;code>{{watch_file}}.err&lt;/code>æ–‡ä»¶æ¥å†³å®šæ‰§è¡Œå­è¿›ç¨‹, è¿˜æ˜¯è·³è¿‡æ‰§è¡Œç„¶åå†™å…¥&lt;code>{{post_file}}.err&lt;/code>æ–‡ä»¶å¹¶è¿”å›é”™è¯¯ç (&lt;code>exitCode&lt;/code> &amp;gt;= 0)&lt;/li>
&lt;li>&lt;code>-wait_file_content&lt;/code>: ç­‰å¾…&lt;code>wait_file&lt;/code>æœ‰å®é™…å†…å®¹å†™å…¥, æŒç»­ç›‘æ§&lt;code>wait_file&lt;/code>ç›´åˆ°æœ‰å†…å®¹å†™å…¥.&lt;/li>
&lt;/ul>
&lt;p>å›å¤´çœ‹ä¸Šé¢å®¹å™¨é…ç½®:&lt;/p>
&lt;ol>
&lt;li>å®¹å™¨çš„&lt;code>entrypoint&lt;/code>å¯åŠ¨è¿›ç¨‹&lt;/li>
&lt;li>ç›‘æ§åˆ°&lt;code>/tekton/downward/ready&lt;/code>æ–‡ä»¶çš„åˆ›å»º, å¹¶ç­‰å¾…æ–‡ä»¶å†…å®¹çš„å†™å…¥&lt;/li>
&lt;li>æ‰§è¡Œ&lt;code>git-init&lt;/code>å­è¿›ç¨‹, ä» git ä»“åº“å…‹éš†æºç &lt;/li>
&lt;li>åˆ›å»º&lt;code>/tekton/tools/0&lt;/code>æ–‡ä»¶&lt;/li>
&lt;/ol>
&lt;h3 id="å®é™…åº”ç”¨">å®é™…åº”ç”¨&lt;/h3>
&lt;p>è¿™ä¸ªæ–¹æ¡ˆæ˜¯å¦èƒ½è§£å†³æˆ‘ä»¬çš„é—®é¢˜, è¿˜æ˜¯æœ‰ä¸€å®šçš„å±€é™æ€§çš„.&lt;/p>
&lt;p>é¦–å…ˆéœ€è¦åº”ç”¨å®¹å™¨çš„å¯åŠ¨å‘½ä»¤è¿›è¡Œé‡æ–°çš„ç¼–æ’, è¿™ä¸ªå­˜åœ¨ä¸€å®šçš„æŒ‘æˆ˜. éœ€è¦ç»Ÿä¸€åº”ç”¨çš„å¯åŠ¨å‘½ä»¤æ‰èƒ½åšåˆ°è§„æ¨¡åŒ–+è‡ªåŠ¨åŒ–.&lt;/p>
&lt;p>å…¶æ¬¡å¼•å…¥å¯ç”¨äºç›‘æ§çš„æ–‡ä»¶, éœ€è¦é¢å¤–å¢åŠ &lt;code>Volume&lt;/code>ç”¨äºè·¨å®¹å™¨çš„æ–‡ä»¶è®¿é—®. å½“ç„¶é€šè¿‡å¢åŠ &lt;code>emptyDir&lt;/code>çš„&lt;code>Volume&lt;/code>å³å¯.&lt;/p>
&lt;p>åŒæ—¶ sidecar å®¹å™¨éœ€è¦åœ¨å®Œæˆå¯åŠ¨ååˆ›å»º&lt;code>post_file&lt;/code>, åº”ç”¨å®¹å™¨å¯ä»¥ä½¿ç”¨è¿™ä¸ª&lt;code>entrypoint&lt;/code>è¿›è¡ŒåŒ…è£….&lt;/p>
&lt;p>å¦‚æœè¦çªç ´è¿™ä¸ªå±€é™, CRD æ— éæ˜¯ä¸ªä¼˜ç§€çš„æ–¹æ¡ˆ. ä¸‹ä¸€ç¯‡, æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ CRD æ¥å®ç°.&lt;/p></description></item><item><title>Go Docker é•œåƒè¿›é˜¶: ç²¾ç®€é•œåƒ</title><link>https://atbug.com/build-minimal-docker-image-for-go-app/</link><pubDate>Wed, 11 Mar 2020 23:00:27 +0800</pubDate><guid>https://atbug.com/build-minimal-docker-image-for-go-app/</guid><description>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/03/11/15839387687383.jpg" alt="">
â€‹[å›¾ç‰‡æ¥è‡ª https://www.facebook.com/sequenceprocess/]&lt;/p>
&lt;h3 id="é—®é¢˜-å…¥é—¨åˆ°ç”Ÿäº§çº§çš„å·®è·">é—®é¢˜: å…¥é—¨åˆ°ç”Ÿäº§çº§çš„å·®è·&lt;/h3>
&lt;p>æ˜¨å¤©çš„æ–‡ç« ã€Šä¸º Go åº”ç”¨åˆ›å»º Docker é•œåƒã€‹, ç®—æ˜¯å…¥é—¨çº§çš„, å¹¶ä¸é€‚ç”¨äºç”Ÿäº§çº§. ä¸ºä»€ä¹ˆ?&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker images
REPOSITORY TAG IMAGE ID CREATED SIZE
addozhang/golang-hello-world latest 4cce1292a87a &lt;span class="m">4&lt;/span> seconds ago 813MB
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ•´ä¸ªé•œåƒçš„å¤§å°æœ‰ 813MB, è¿™è¿˜åªæœ‰ä¸€ä¸ªç®€å•çš„ Hello world. å› ä¸ºå…¶ä¸­åŒ…å«äº† Golang çš„ç¼–è¯‘å’Œè¿è¡Œç¯å¢ƒ. ä½†æ˜¯å®é™…ç”Ÿäº§ç¯å¢ƒä¸­, æˆ‘ä»¬å¹¶ä¸éœ€è¦è¿™ä¹ˆå¤š.&lt;/p>
&lt;h3 id="å…ˆçœ‹ç»“æœ">å…ˆçœ‹ç»“æœ&lt;/h3>
&lt;p>ç²¾ç®€ä¹‹ååªæœ‰ 2.07MB, è€Œä¸”å¹¶ä¸å½±å“è¿è¡Œ.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker images
REPOSITORY TAG IMAGE ID CREATED SIZE
addozhang/golang-hello-world latest 4cce1292a87a &lt;span class="m">3&lt;/span> minutes ago 813MB
addozhang/golang-hello-world2 latest 1da5bb994074 &lt;span class="m">7&lt;/span> minutes ago 2.07MB
$ docker run --rm addozhang/golang-hello-world2
Hello world
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ&lt;/h3>
&lt;p>å¦‚æœåšåˆ°çš„? é¦–å…ˆä»åŸºç¡€é•œåƒå¼€å§‹, æ¢æˆ&lt;code>scratch&lt;/code>&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>. æ„å»ºæ—¶å°†ç¼–è¯‘å¥½çš„æ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">FROM scratch
ADD golang-hello-world /
CMD [&amp;#34;/golang-hello-world&amp;#34;]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‡å¦‚ä½ æ˜¯ä½¿ç”¨&lt;code>go build&lt;/code>æ¥ç¼–è¯‘, åœ¨ Macos ä¸Šä¼šé‡åˆ°å¦‚ä¸‹é—®é¢˜:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run --rm addozhang/golang-hello-world2
standard_init_linux.go:211: &lt;span class="nb">exec&lt;/span> user process caused &lt;span class="s2">&amp;#34;exec format error&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è§£å†³æ–¹æ¡ˆæ˜¯&lt;code>CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build&lt;/code>&lt;/p>
&lt;p>ä»å¤´æ¥çœ‹, æ„å»ºå‡ºä¸€ä¸ªç²¾ç®€çš„é•œåƒ, æˆ‘ä»¬éœ€è¦:&lt;/p>
&lt;ol>
&lt;li>è¿è¡Œ&lt;code>CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build&lt;/code>æ„å»º linux ç¯å¢ƒçš„å¯æ‰§è¡Œæ–‡ä»¶. è¯¥æ–‡ä»¶å¹¶ä¸èƒ½åœ¨ mac ä¸Šè¿è¡Œ&lt;/li>
&lt;li>ä½¿ç”¨&lt;code>docker build&lt;/code>è¿›è¡Œæ„å»º&lt;/li>
&lt;/ol>
&lt;p>è¿™æ ·çš„æ“ä½œæ­¥éª¤å¤ªéº»çƒ¦, è¿˜èƒ½ä¸èƒ½ç²¾ç®€ä¸€ä¸‹?&lt;/p>
&lt;h3 id="è¿›é˜¶-ä½¿ç”¨-docker-çš„å¤šæ­¥æ„å»º">è¿›é˜¶: ä½¿ç”¨ Docker çš„å¤šæ­¥æ„å»º&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">#build stage
FROM golang as builder
ENV GO111MODULE=on
ENV GOPROXY=https://goproxy.io
WORKDIR /app
COPY go.mod .
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build
#image stage
FROM scratch
COPY --from=builder /app/golang-hello-world /
CMD [&amp;#34;/golang-hello-world&amp;#34;]
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å‚è€ƒ">å‚è€ƒ&lt;/h3>
&lt;p>&lt;a href="https://dev.to/plutov/docker-and-go-modules-3kkn">https://dev.to/plutov/docker-and-go-modules-3kkn&lt;/a>&lt;/p>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>&lt;code>scratch&lt;/code>æ˜¯ä¸€ä¸ªç©ºçš„é•œåƒæ–‡ä»¶ &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>ä¸º Go åº”ç”¨åˆ›å»º Docker é•œåƒ</title><link>https://atbug.com/build-docker-image-for-go-app/</link><pubDate>Wed, 11 Mar 2020 20:41:58 +0800</pubDate><guid>https://atbug.com/build-docker-image-for-go-app/</guid><description>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/03/11/15839304511808.jpg" alt="">&lt;/p>
&lt;p>å—¯å—¯, æœ€è¿‘å¼€å§‹ç”¨ Golang äº†.&lt;/p>
&lt;p>ä»Šå¤©éœ€è¦ä¸º Go åº”ç”¨åˆ›å»ºå¯¹è±¡, çœ‹äº†ä¸‹å®˜æ–¹åšå®¢. æ‹¿ hello world åšä¸ªæµ‹è¯•.&lt;/p>
&lt;p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åˆ›å»ºä¸ªæ–°çš„é¡¹ç›®&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ mkdir -p &lt;span class="nv">$GOPATH&lt;/span>/src/github.com/addozhang/golang-hello-world &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">cd&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
$ go mod init github.com/addozhang/golang-hello-world
go: creating new go.mod: module github.com/addozhang/golang-hello-world
$ cat &lt;span class="s">&amp;lt;&amp;lt; EOF &amp;gt; main.go
&lt;/span>&lt;span class="s">package main
&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">import &amp;#34;fmt&amp;#34;
&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">func main() {
&lt;/span>&lt;span class="s"> fmt.Println(&amp;#34;Hello world&amp;#34;)
&lt;/span>&lt;span class="s">}
&lt;/span>&lt;span class="s">EOF&lt;/span>
&lt;span class="c1"># go fmt&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡Œæ£€æŸ¥ä¸€æ¬¡&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ go run main.go
Hello world
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¨‹åºæ²¡é—®é¢˜, ä¸‹é¢å°±æ˜¯æ„å»ºé•œåƒäº†. åˆ›å»ºä¸€ä¸ª Dockerfile æ–‡ä»¶, å†…å®¹å¦‚ä¸‹:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">FROM golang
LABEL Author=&amp;#34;addozhang&amp;#34;
ADD . /go/src/github.com/addozhang/golang-hello-world
RUN go install github.com/addozhang/golang-hello-world
ENTRYPOINT [ &amp;#34;/go/bin/golang-hello-world&amp;#34; ]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ„å»ºé•œåƒ:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker build -t addozhang/golang-hello-world .
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡Œé•œåƒ:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run --rm addozhang/golang-hello-world:latest
Hello world
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡Œæ²¡é—®é¢˜, æ”¶å·¥&lt;/p></description></item><item><title>äº‘åŸç”ŸCICD: Tekton Trigger å®æˆ˜</title><link>https://atbug.com/tekton-trigger-practice/</link><pubDate>Wed, 12 Feb 2020 21:30:03 +0800</pubDate><guid>https://atbug.com/tekton-trigger-practice/</guid><description>
&lt;p>Triggerçš„ä»‹ç»çœ‹ &lt;a href="https://atbug.com/tekton-trigger-glance/">è¿™é‡Œ&lt;/a>.&lt;/p>
&lt;p>æ¥ä¸Šæ–‡ &lt;a href="https://atbug.com/tekton-pipeline-practice/">Tekton Pipeline å®æˆ˜&lt;/a> , æˆ‘ä»¬ä¸ºæŸä¸ªé¡¹ç›®åˆ›å»ºäº†ä¸€ä¸ªPipeline, ä½†æ˜¯æ‰§è¡Œæ—¶é€šè¿‡ PipelineRun æ¥å®Œæˆçš„. åœ¨ PipelineRun ä¸­æˆ‘ä»¬åˆ¶å®šäº† Pipepline ä»¥åŠè¦ä½¿ç”¨çš„ PipelineResource. ä½†æ˜¯æ—¥å¸¸çš„å¼€å‘ä¸­, æˆ‘ä»¬æ›´å¤šå¸Œæœ›åœ¨æäº¤äº†ä»£ç ä¹‹åå¼€å§‹ Pipeline çš„æ‰§è¡Œ. è¿™æ—¶æˆ‘ä»¬å°±è¦ç”¨åˆ° Tekton Trigger äº†.&lt;/p>
&lt;p>æ€è·¯æ˜¯è¿™æ ·: ä»£ç æäº¤åå°†&lt;code>Push Event&lt;/code>å‘é€ç»™&lt;code>Tekton Trigger EventController&lt;/code>(ä»¥ä¸‹ç®€ç§° Controller), ç„¶å Controller åŸºäºçš„&lt;code>TriggerBinding&lt;/code>çš„é…ç½®ä» payload ä¸­æå–ä¿¡æ¯, è£…è½½åœ¨&amp;quot;Params&amp;quot;ä¸­ä½œä¸º&lt;code>TriggerTemplate&lt;/code>çš„å…¥å‚. æœ€å Controller åˆ›å»º&lt;code>PipelineRun&lt;/code>.&lt;/p>
&lt;h2 id="trigger-ç›¸å…³çš„èµ„æº">Trigger ç›¸å…³çš„èµ„æº&lt;/h2>
&lt;h3 id="triggertemplate">TriggerTemplate&lt;/h3>
&lt;p>å›çœ‹&lt;a href="https://atbug.com/tekton-pipeline-practice/#0x06-%E6%89%A7%E8%A1%8C%E6%B5%81%E6%B0%B4%E7%BA%BF">ä¸Šå›ç”¨çš„PipelineRun Yaml&lt;/a>, å‚æ•°æœ‰&lt;code>revision&lt;/code>, &lt;code>url&lt;/code>, &lt;code>imageUrl&lt;/code>å’Œ&lt;code>imageTag&lt;/code>. (imageUrl ä¸é¡¹ç›®åä¸€ç›´)&lt;/p>
&lt;p>å› æ­¤å®šä¹‰&lt;code>TriggerTemplate&lt;/code>å°†è¿™ 4 ä¸ªå…ƒç´ ä½œä¸ºå…¥å‚, ç„¶åå¤ç”¨ä¹‹å‰çš„&lt;code>Pipeline&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TriggerTemplate&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">trigger-test-triggertemplate&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gitrevision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The git revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">master&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gitrepositoryurl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The git repository url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">namespace&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The namespace to create the resources&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pielines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">projectname&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The project name&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imagetag&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">The image tag&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resourcetemplates&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PipelineRun&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-test-pipeline-run-$(uid)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(params.namespace)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceAccountName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageUrl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">addozhang/$(params.projectname)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">imageTag&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(params.imagetag)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">pipelineRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build-pipeline&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git-source&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resourceSpec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">git&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">revision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(params.gitrevision)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(params.gitrepositoryurl)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œ&lt;code>kubectl apply -f trigger/trigger-template.yaml&lt;/code>&lt;/p>
&lt;h3 id="triggerbinding">TriggerBinding&lt;/h3>
&lt;p>&lt;code>TriggerTemplate&lt;/code>çš„å…¥å‚éƒ½å¯ä»¥ä»&lt;code>PushEvent&lt;/code>çš„ payloadä¸­é€šè¿‡ JsonPath è¡¨è¾¾å¼æ¥æå–. æ›´å¤šè¡¨è¾¾å¼çš„ä½¿ç”¨å‚è€ƒ&lt;a href="https://github.com/tektoncd/triggers/blob/master/docs/triggerbindings.md#event-variable-interpolation">å®˜æ–¹çš„æ–‡æ¡£&lt;/a>.&lt;/p>
&lt;p>&lt;em>æ³¨æ„: è¿™é‡Œçš„ payload æ ¼å¼ä½¿ç”¨çš„æ˜¯ Gitlab çš„ PushEvent å®šä¹‰. ä¸ºä»€ä¹ˆè¦ç”¨ Gitlab åä»€ä¹ˆä¼šè§£é‡Š&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TriggerBinding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">trigger-test-triggerbinding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">params&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gitrevision&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(body.after)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">namespace&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gitrepositoryurl&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(body.project.git_http_url)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">projectname&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(body.project.name)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œ&lt;code>kubectl apply -f trigger/trigger-binding.yaml&lt;/code>&lt;/p>
&lt;h3 id="eventlistener">EventListener&lt;/h3>
&lt;p>&lt;code>EventController&lt;/code>å°†&lt;code>TriggerTemplate&lt;/code>å’Œ&lt;code>TriggerBinding&lt;/code>å…³è”åœ¨ä¸€èµ·, èµ„æºåœ¨åˆ›å»ºåä¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„ pod å’Œ service.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">EventListener&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">trigger-test-eventlistener&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceAccountName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-test //éœ€è¦è®¿é—® API, ç”¨ä¸Šå›åˆ›å»º serviceaccount&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">triggers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">bindings&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">trigger-test-triggerbinding&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">trigger-test-triggertemplate&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œ&lt;code>kubectl apply -f trigger/event-listener.yaml&lt;/code>&lt;/p>
&lt;p>æä¾› WebHook çš„è®¿é—®å…¥å£, ä¸º&lt;code>EventListener&lt;/code>åˆ›å»º&lt;code>ingress&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">extensions/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Ingress&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">el-trigger-test-eventlistener&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">trigger-test.el.nip.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">paths&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">backend&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">el-trigger-test-eventlistener&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">servicePort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åšå®Œä¹‹åè®°å¾—æ·»åŠ è§£æ&lt;code>sudo echo &amp;quot;$(minikube ip) trigger-test.el.nip.io&amp;quot; &amp;gt;&amp;gt; /etc/hosts&lt;/code>&lt;/p>
&lt;h2 id="gitlab">GitLab&lt;/h2>
&lt;p>è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ç»§ç»­ç”¨ github ä½œä¸º CVS, minikube è¿è¡Œåœ¨æœ¬åœ°, ingress åœ°å€æ— æ³•åœ¨ github ä¸Šè§£æ(webhook æ— æ³•å·¥ä½œ). å› æ­¤åªèƒ½æœ¬åœ°æ­å»ºä¸ª gitlab.&lt;/p>
&lt;p>ä½¿ç”¨ Docker Compose çš„æ–¹å¼éƒ¨ç½², å¹¶åˆ¶å®šåŸŸå&lt;code>gitlab.nip.io&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;3.6&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">web&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;gitlab/gitlab-ce:latest&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">hostname&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;gitlab.nip.io&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">GITLAB_OMNIBUS_CONFIG&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> external_url &amp;#39;http://gitlab.nip.io:8088&amp;#39;
&lt;/span>&lt;span class="sd"> gitlab_rails[&amp;#39;gitlab_shell_ssh_port&amp;#39;] = 8022
&lt;/span>&lt;span class="sd"> # Add any other gitlab.rb configuration here, each on its own line&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;8088:8088&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;8022:22&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è®°å¾—æ·»åŠ è§£æ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">sudo echo &amp;#34;$(ifconfig | grep -Eo &amp;#39;inet (addr:)?([0-9]*\.){3}[0-9]*&amp;#39; | grep -Eo &amp;#39;([0-9]*\.){3}[0-9]*&amp;#39; | grep -v &amp;#39;127.0.0.1&amp;#39; | head -n 1) gitlab.nip.io&amp;#34; &amp;gt;&amp;gt; /etc/hosts
&lt;/code>&lt;/pre>&lt;/div>&lt;p>GitLab çš„é»˜è®¤è´¦å·æ˜¯&lt;code>root&lt;/code>, é¦–æ¬¡è®¿é—®&lt;code>http://gitlab.nip.io:8088&lt;/code>çš„æ—¶å€™ä¼šæç¤ºè®¾ç½®å¯†ç .&lt;/p>
&lt;p>åˆ›å»ºé¡¹ç›®, æäº¤ä»£ç çš„æ“ä½œä¸å¤šè¯´äº†. æ·»åŠ  webhook å‰, è¦å…ˆå»&amp;quot;Admin Area &amp;raquo; Settings &amp;raquo; Network &amp;raquo; Outbound Requests&amp;quot;å‹¾é€‰&lt;code>Allow requests to the local network from web hooks and services&lt;/code>.&lt;/p>
&lt;h3 id="dns-è§£æé—®é¢˜">DNS è§£æé—®é¢˜&lt;/h3>
&lt;p>Docker å’Œ minikube æ˜¯åœ¨ä¸¤ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿæœºä¸­è¿è¡Œ, å¹¶ä¸”æˆ‘ä»¬æ·»åŠ äº†ä¸¤ä¸ªåœ°å€è§£æ. äº’ç›¸è®¿é—®çš„æ—¶å€™ä¾¿ä¼šå‡ºç° domain æ— æ³•è§£æçš„é—®é¢˜, è¿™é‡Œæ˜¯é€šè¿‡éƒ¨ç½²ä¸€ä¸ª dnsmasq ä½œä¸ºç‹¬ç«‹çš„ dns è§£ææœåŠ¡å™¨.&lt;/p>
&lt;p>å®‰è£…å’Œé…ç½® dnsmasq, dnsmasq ä¼šå°† &lt;code>/etc/hosts&lt;/code> ä¸­çš„è®°å½•åŠ å…¥åˆ°è®°å½•ä¸­.&lt;/p>
&lt;p>æˆ‘æœ¬åœ°çš„ minikube ä½äº&lt;code>192.168.64.0&lt;/code>ç½‘æ®µ, å› æ¬¡ dnsmasq æ·»åŠ ç›‘å¬åœ°å€&lt;code>192.168.64.1&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">brew install dnsmasq
cat &lt;span class="s">&amp;lt;&amp;lt; EOF &amp;gt;&amp;gt; /usr/local/etc/dnsmasq.conf
&lt;/span>&lt;span class="s">strict-order
&lt;/span>&lt;span class="s">listen-address=127.0.0.1,192.168.64.1
&lt;/span>&lt;span class="s">EOF&lt;/span>
sudo brew services start dnsmasq
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥ä¸€ä¸‹, &lt;code>192.168.1.136&lt;/code>æ˜¯æˆ‘æœ¬æœº ip.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ dig gitlab.nip.io @192.168.64.1
&lt;span class="p">;&lt;/span> &amp;lt;&amp;lt;&amp;gt;&amp;gt; DiG 9.10.6 &amp;lt;&amp;lt;&amp;gt;&amp;gt; gitlab.nip.io @192.168.64.1
&lt;span class="p">;;&lt;/span> global options: +cmd
&lt;span class="p">;;&lt;/span> Got answer:
&lt;span class="p">;;&lt;/span> -&amp;gt;&amp;gt;HEADER&lt;span class="s">&amp;lt;&amp;lt;- opco&lt;/span>de: QUERY, status: NOERROR, id: &lt;span class="m">63393&lt;/span>
&lt;span class="p">;;&lt;/span> flags: qr aa rd ra&lt;span class="p">;&lt;/span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: &lt;span class="m">1&lt;/span>
&lt;span class="p">;;&lt;/span> OPT PSEUDOSECTION:
&lt;span class="p">;&lt;/span> EDNS: version: 0, flags:&lt;span class="p">;&lt;/span> udp: &lt;span class="m">4096&lt;/span>
&lt;span class="p">;;&lt;/span> QUESTION SECTION:
&lt;span class="p">;&lt;/span>gitlab.nip.io. IN A
&lt;span class="p">;;&lt;/span> ANSWER SECTION:
gitlab.nip.io. 0 IN A 192.168.1.136
&lt;span class="p">;;&lt;/span> Query time: &lt;span class="m">0&lt;/span> msec
&lt;span class="p">;;&lt;/span> SERVER: 192.168.64.1#53&lt;span class="o">(&lt;/span>192.168.64.1&lt;span class="o">)&lt;/span>
&lt;span class="p">;;&lt;/span> WHEN: Thu Feb &lt;span class="m">13&lt;/span> 18:20:19 CST &lt;span class="m">2020&lt;/span>
&lt;span class="p">;;&lt;/span> MSG SIZE rcvd: &lt;span class="m">58&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æµ‹è¯•">æµ‹è¯•&lt;/h2>
&lt;p>æ¨é€ä¸€ä¸ªç©ºçš„æäº¤åˆ°ä»£ç ä»“åº“: &lt;code>git commit -a -m &amp;quot;trigger commit&amp;quot; --allow-empty &amp;amp;&amp;amp; git push origin master&lt;/code>&lt;/p>
&lt;p>ç„¶åå°±å¯ä»¥çœ‹åˆ°æ–°çš„&lt;code>PipelineRun&lt;/code>åˆ›å»ºå¹¶è¿è¡Œ.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">$ tkn pr list
NAME STARTED DURATION STATUS
tekton-test-pipeline-run-fk2xj &lt;span class="m">42&lt;/span> seconds ago --- Running
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å…¶ä»–æ–‡ç« ">å…¶ä»–æ–‡ç« &lt;/h2>
&lt;p>Tekton Pipeline å®æˆ˜: &lt;a href="https://atbug.com/tekton-pipeline-practice">https://atbug.com/tekton-pipeline-practice&lt;/a>&lt;/p></description></item><item><title>Tekton Trigger ä»‹ç»</title><link>https://atbug.com/tekton-trigger-glance/</link><pubDate>Wed, 05 Feb 2020 18:03:15 +0800</pubDate><guid>https://atbug.com/tekton-trigger-glance/</guid><description>
&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>Tekton çš„ä»‹ç»è¯·å‚è€ƒ&lt;a href="https://atbug.com/tekton-pipeline-practice/">Tekton Pipeline å®æˆ˜&lt;/a>.&lt;/p>
&lt;p>é€šå¸¸, CI/CD äº‹ä»¶åº”è¯¥åŒ…å«å¦‚ä¸‹ä¿¡æ¯:&lt;/p>
&lt;ul>
&lt;li>ç¡®å®šäº‹ä»¶çš„ç±»å‹(æ¯”å¦‚ GitHub Push, GitLab Issue, Docker Hub Webhook ç­‰)&lt;/li>
&lt;li>å¯ä»ç‰¹å®šç®¡é“è®¿é—®å¹¶æ˜ å°„åˆ°ç‰¹å®šç®¡é“ (ä»äº‹ä»¶è´Ÿè½½ä¸­è·å– SHA ä¿¡æ¯, ç„¶ååœ¨ç®¡é“ä¸­ä½¿ç”¨)&lt;/li>
&lt;li>å‡†ç¡®åœ°è§¦å‘ç®¡é“ (åŸºäºæœ‰æ•ˆè´Ÿè½½å€¼è§¦å‘ç®¡é“)&lt;/li>
&lt;/ul>
&lt;p>Tekton API çš„è®¾è®¡åˆ†ç¦»äº†é…ç½®(æ¯”å¦‚ PipelineRun VS Pipeline), ä¿è¯äº† step å¯ä»¥è¢«é‡ç”¨. ä½†æ˜¯æ²¡æœ‰æä¾›åŠ¨æ€å°è£…é…ç½®çš„æœºåˆ¶æ¥ç”Ÿæˆèµ„æº(å°¤å…¶æ˜¯ PipelineRun å’Œ PipelineResource). &lt;a href="https://github.com/tektoncd/triggers">Triggers&lt;/a> é€šè¿‡ä¸‹é¢çš„ CRDs åœ¨æ¶æ„ä¸Šå¯¹ Tekton è¿›è¡Œäº†æ‰©å±•:&lt;/p>
&lt;ul>
&lt;li>&lt;code>TriggerTemplate&lt;/code>: åˆ›å»ºèµ„æºçš„æ¨¡æ¿(æ¯”å¦‚ç”¨æ¥åˆ›å»º PipelineResource å’Œ PipelineRun)&lt;/li>
&lt;li>&lt;code>TriggerBinding&lt;/code>: æ ¡éªŒäº‹ä»¶å¹¶æå–è´Ÿè½½å­—æ®µ&lt;/li>
&lt;li>&lt;code>EventListener&lt;/code>: è¿æ¥&lt;code>TriggerBinding&lt;/code>å’Œ&lt;code>TriggerTemplate&lt;/code>åˆ°å¯å¯»å€çš„ç«¯ç‚¹(äº‹ä»¶æ¥æ”¶å™¨). ä½¿ç”¨ä»å„ä¸ª&lt;code> TriggerBinding&lt;/code>ä¸­æå–çš„å‚æ•°æ¥åˆ›å»º&lt;code>TriggerTemplate&lt;/code>ä¸­æŒ‡å®šçš„ resources. åŒæ ·é€šè¿‡&lt;code> interceptor&lt;/code>å­—æ®µæ¥æŒ‡å®šå¤–éƒ¨æœåŠ¡æ¥å¯¹äº‹ä»¶è´Ÿè½½è¿›è¡Œé¢„å¤„ç†.&lt;/li>
&lt;li>&lt;code>ClusterTriggerBinding&lt;/code>: clusterçº§åˆ«çš„&lt;code>TriggerBinding&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/rymZ0w.jpg" alt="">&lt;/p>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl apply --filename https://storage.googleapis.com/tekton-releases/triggers/latest/release.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥æ–°å¢çš„ CRD: &lt;code>kubectl api-resources | grep tekton&lt;/code>. Triggers å¼•å…¥äº† 3 ä¸ª CRD: &lt;code>TriggerTemplate&lt;/code>, &lt;code>TriggerBinding&lt;/code>,&lt;code>EventListener&lt;/code>.&lt;/p>
&lt;p>æ£€æŸ¥æ–°å¢çš„ deployment: &lt;code>tekton-triggers-webhook&lt;/code>, &lt;code>tekton-triggers-controller&lt;/code>.&lt;/p></description></item><item><title>Tekton Dashboard å®‰è£…</title><link>https://atbug.com/tekton-dashboard-installation/</link><pubDate>Sat, 01 Feb 2020 12:39:28 +0800</pubDate><guid>https://atbug.com/tekton-dashboard-installation/</guid><description>
&lt;p>Tekton æä¾›äº†&lt;a href="https://github.com/tektoncd/dashboard">dashboard&lt;/a>æ–¹ä¾¿ç”¨æˆ·ç®¡ç†å’ŒæŸ¥çœ‹ Tekton PipelineRun å’Œ TaskRun ä»¥åŠåˆ›å»º, æ‰§è¡Œå’Œå®Œæˆè¿‡ç¨‹ä¸­æ¶‰åŠçš„èµ„æº. å®ƒè¿˜å…è®¸æŒ‰æ ‡ç­¾è¿‡æ»¤ PipelineRun å’Œ TaskRun.&lt;/p>
&lt;h3 id="å®‰è£…æ–¹æ³•">å®‰è£…æ–¹æ³•&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply --filename https://github.com/tektoncd/dashboard/releases/download/v0.4.1/dashboard_latest_release.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥dashboardçš„è¿è¡Œæƒ…å†µ, &lt;code>STATUS&lt;/code>ä¸º&lt;code>Running&lt;/code>çš„è¯åˆ™è¯´æ˜è¿è¡ŒæˆåŠŸ.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get pods --namespace tekton-pipelines
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è®¿é—®">è®¿é—®&lt;/h3>
&lt;p>è®¿é—®Tektonçš„Dashboardæœ‰ä¸¤ç§æ–¹å¼, ä¸€ç§æ˜¯é€šè¿‡&lt;code>port-forward&lt;/code>, å¦ä¸€ç§æ˜¯é€šè¿‡&lt;code>ingress&lt;/code>æ¥è®¿é—®.&lt;/p>
&lt;h4 id="port-forward">port-forward&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl port-forward svc/tekton-dashboard &lt;span class="m">9097&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ingress">ingress&lt;/h4>
&lt;p>å…ˆæ£€æŸ¥ingressæ˜¯å¦å¼€å¯.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube addon list
...
- ingress: enabled
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœæ˜¯disabledçš„è¯, é€šè¿‡å‘½ä»¤&lt;code>minikube addons enable ingress&lt;/code>.&lt;/p>
&lt;p>&lt;em>æ³¨æ„: è¿™é‡Œæ‹‰å–&lt;code>quay.io/kubernetes-ingress-controller/nginx-ingress-controller&lt;/code>é•œåƒå¯èƒ½æ¯”è¾ƒæ…¢, å»ºè®®ä½¿ç”¨å›½å†…çš„é•œåƒ, æ¯”å¦‚&lt;code>quay.mirrors.ustc.edu.cn/kubernetes-ingress-controller/nginx-ingress-controller&lt;/code>&lt;/em>&lt;/p>
&lt;p>ä¿®æ”¹&lt;code>basic-dashboard-ingress.yaml&lt;/code>ä¸­çš„&lt;code>host&lt;/code>åœ°å€:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">extensions/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Ingress&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-dashboard&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-pipelines&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-dashboard.nip.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">paths&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">backend&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton-dashboard&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">servicePort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">9097&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œ&lt;code>kubectl apply -f basic-dashboard-ingress.yaml&lt;/code>.&lt;/p>
&lt;p>è¿˜æœ‰æœ€åä¸€æ­¥, åœ¨&lt;code>/etc/hosts&lt;/code>ä¸­æ·»åŠ ä¸€æ¡è§£æ&lt;code>x.x.x.x tekton-dashboard.nip.io&lt;/code>, ipåœ°å€é€šè¿‡&lt;code>minikube ip&lt;/code>æ¥è·å–&lt;/p>
&lt;p>æµè§ˆå™¨ä¸­æ‰“å¼€&lt;code> tekton-dashboard.nip.io&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/6weoXL.jpg" alt="">&lt;/p></description></item><item><title>Tekton 0.9.0 æ›´æ–°</title><link>https://atbug.com/tekton-0.9.0-release/</link><pubDate>Sun, 19 Jan 2020 14:33:17 +0800</pubDate><guid>https://atbug.com/tekton-0.9.0-release/</guid><description>
&lt;p>ç¿»è¯‘æ•´ç†è‡ª &lt;a href="https://cd.foundation/blog/2019/12/12/whats-new-in-tekton-0-9/">Whatâ€™s New in Tekton 0.9&lt;/a>&lt;/p>
&lt;h2 id="åŠŸèƒ½åŠbugä¿®å¤">åŠŸèƒ½åŠBugä¿®å¤&lt;/h2>
&lt;h3 id="è„šæœ¬æ¨¡å¼">è„šæœ¬æ¨¡å¼&lt;/h3>
&lt;p>ä»¥å‰å¦‚æœè¦åœ¨å®¹å™¨é‡Œè¿è¡Œä¸ªç®€å•çš„ bash è„šæœ¬, éœ€è¦è¿™ä¹ˆå†™:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">hello&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ubuntu&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;bash&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">c&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> set -ex
&lt;/span>&lt;span class="sd"> echo &amp;#34;hello&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ 0.9 ä¹‹å, å¯ä»¥æ›´åŠ ç®€å•, ä¸éœ€è¦å†å†™command å’Œè®¨åŒçš„&lt;code>-c&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">hello&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ubuntu&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> #!/bin/bash
&lt;/span>&lt;span class="sd"> echo &amp;#34;hello&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ€§èƒ½">æ€§èƒ½&lt;/h3>
&lt;p>é€šè¿‡ä¸€ç³»åˆ—çš„å·¥ä½œ, æ¯ä¸ª PipelineRun çš„è¿è¡Œæ—¶é—´ç¼©çŸ­äº† 5-20 ç§’&lt;/p>
&lt;h2 id="api-å˜åŒ–">API å˜åŒ–&lt;/h2>
&lt;p>ä¸ºäº† beta ç‰ˆæœ¬çš„å‘å¸ƒ, API åšäº†ä¸€äº›è°ƒæ•´:&lt;/p>
&lt;h3 id="é•œåƒæ‘˜è¦è¾“å‡ºè·¯å¾„çš„æ ‡å‡†åŒ–">é•œåƒæ‘˜è¦è¾“å‡ºè·¯å¾„çš„æ ‡å‡†åŒ–&lt;/h3>
&lt;p>Tekton ç›®å‰æä¾›äº†ä¸€ä¸ªæœºåˆ¶ç”¨äºå­˜å‚¨ task æ„å»ºå‡ºçš„é•œåƒçš„æ‘˜è¦. è¿™ä¸ªæœºåˆ¶æ—©äº&lt;code> PipelineResource&lt;/code>å­ç³»ç»Ÿ, å¹¶è¦æ±‚ Task ç¼–å†™è€…é•œåƒè¿™äº›æ‘˜è¦å†™åˆ°æŒ‡å®šçš„ä½ç½®&lt;code>/builder/image-outputs&lt;/code>. ä»ç°åœ¨å¼€å§‹, æœ‰äº†è¾“å‡ºèµ„æºçš„æ ‡å‡†è·¯å¾„&lt;code>/workspace/output/&amp;lt;resource-name&amp;gt;&lt;/code>&lt;/p>
&lt;h3 id="ç®€åŒ–é›†ç¾¤èµ„æº">ç®€åŒ–é›†ç¾¤èµ„æº&lt;/h3>
&lt;p>é›†ç¾¤&lt;code>PipelineResource&lt;/code>ä½¿ä» Tasks å†…éƒ¨éƒ¨ç½²å’Œä½¿ç”¨ Kubernetes é›†ç¾¤å˜å¾—ç®€å•. å®ƒä¸ºç”¨æˆ·æä¾›äº†å£°æ˜é›†ç¾¤çš„ä½ç½®ä»¥åŠå¦‚ä½•è¿›è¡Œèº«ä»½éªŒè¯çš„æœºåˆ¶. ç„¶åå†æ‰§è¡Œ Task è¿‡ç¨‹ä¸­, ä»–ä»¬ä¼šè‡ªåŠ¨é…ç½®&lt;code>.kubeconfig&lt;/code>æ–‡ä»¶, ä»¥ä¾¿ Kubernetes å·¥å…·å¯ä»¥æ‰¾åˆ°è¯¥é›†ç¾¤.&lt;/p>
&lt;p>è¿™ä¸ªç‰ˆæœ¬ä¿å‡½äº†ä¸€äº›æ›´æ”¹, ä½¿é›†ç¾¤&lt;code> PipelineResource&lt;/code>æ›´æ˜“äºä½¿ç”¨.&lt;/p>
&lt;p>ä»¥å‰ç”¨æˆ·å¿…é¡»ä¸¤æ¬¡æŒ‡å®šåå­—å‚æ•°: ä¸€æ¬¡åœ¨èµ„æºåç§°ä¸­æŒ‡å®š, ä¸€æ¬¡ä½œä¸ºèµ„æºå‚æ•°. ç°åœ¨ç¬¬äºŒä¸ªå‚æ•°ä¸éœ€è¦äº†.&lt;/p>
&lt;h2 id="åŸºç¡€å·¥ä½œ">åŸºç¡€å·¥ä½œ&lt;/h2>
&lt;p>æ¯ä¸ªTektonç‰ˆæœ¬ä¸­åŒ…å«çš„å¤§éƒ¨åˆ†å·¥ä½œéƒ½æ˜¯é’ˆå¯¹æŸäº›åŠŸèƒ½çš„, è¿™äº›åŠŸèƒ½è¦ç­‰åˆ°ä»¥åçš„ç‰ˆæœ¬æ‰èƒ½å…¬å¼€.å†µã€‚&lt;/p>
&lt;h3 id="æ”¹è¿›çš„-pipelineresource">æ”¹è¿›çš„ PipelineResource&lt;/h3>
&lt;p>æºäº&lt;a href="https://github.com/tektoncd/pipeline/issues/1673">Pipeline Resource Redesign&lt;/a>&lt;/p>
&lt;h3 id="api-çš„ç‰ˆæœ¬æ§åˆ¶">API çš„ç‰ˆæœ¬æ§åˆ¶&lt;/h3>
&lt;p>æºäº&lt;a href="https://github.com/tektoncd/pipeline/issues/1526">Create a v1alpha2 apiVersion&lt;/a>&lt;/p>
&lt;h2 id="ç‹¬ç«‹çš„åŒ…">ç‹¬ç«‹çš„åŒ…&lt;/h2>
&lt;p>Tektoné¡¹ç›®å‘å±•æƒŠäºº. é™¤äº†è¿™é‡Œæåˆ°çš„&lt;a href="https://github.com/tektoncd/pipeline">Pipeline&lt;/a>æ›´æ–°, å…¶ä»–æ¯”å¦‚&lt;a href="https://github.com/tektoncd/triggers">Triggers&lt;/a>, &lt;a href="https://github.com/tektoncd/cli">CLI&lt;/a>, &lt;a href="https://github.com/tektoncd/dashboard">Dashboard&lt;/a>ä¹Ÿæœ‰æ˜¾è‘—çš„æˆæœ.&lt;/p>
&lt;p>Triggers ç°åœ¨æ”¯æŒå¼€ç®±å³ç”¨çš„ Github å’Œ Gitlab æ ¡éªŒ.
CLIåŠ å…¥äº†äº¤äº’å¼åˆ›å»º&lt;code>PipelineResource&lt;/code>å’Œå¯åŠ¨ task çš„æ”¯æŒ.
Dashboard æ¥ä¸‹æ¥ä¹Ÿä¼šå‡å¦‚å¯è§†åŒ–ç‰¹æ€§.&lt;/p></description></item><item><title>Tektonå®‰è£…åŠHello world</title><link>https://atbug.com/tekton-installation-and-sample/</link><pubDate>Fri, 17 Jan 2020 19:17:14 +0800</pubDate><guid>https://atbug.com/tekton-installation-and-sample/</guid><description>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥å®‰è£…çš„tektonç›¸å…³çš„CRD:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl api-resources &lt;span class="p">|&lt;/span> grep tekton
clustertasks tekton.dev &lt;span class="nb">false&lt;/span> ClusterTask
conditions tekton.dev &lt;span class="nb">true&lt;/span> Condition
pipelineresources tekton.dev &lt;span class="nb">true&lt;/span> PipelineResource
pipelineruns pr,prs tekton.dev &lt;span class="nb">true&lt;/span> PipelineRun
pipelines tekton.dev &lt;span class="nb">true&lt;/span> Pipeline
taskruns tr,trs tekton.dev &lt;span class="nb">true&lt;/span> TaskRun
tasks tekton.dev &lt;span class="nb">true&lt;/span> Task
&lt;/code>&lt;/pre>&lt;/div>&lt;p>tektonçš„ä¸¤ä¸ªpod:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get pods --namespace tekton-pipelines
NAME READY STATUS RESTARTS AGE
tekton-pipelines-controller-556d8f4494-2qthv 1/1 Running &lt;span class="m">0&lt;/span> 11m
tekton-pipelines-webhook-849cff5cf-8m5qq 1/1 Running &lt;span class="m">0&lt;/span> 11m
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…cli">å®‰è£…CLI&lt;/h3>
&lt;p>cli: &lt;a href="https://github.com/tektoncd/cli#installing-tkn">https://github.com/tektoncd/cli#installing-tkn&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">brew install tektoncd-cli
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="tekton-hello-world">Tekton: hello world&lt;/h2>
&lt;p>åˆ›å»ºä¸€ä¸ªç®€å•çš„&lt;code>Task&lt;/code>, åªæœ‰ä¸€ä¸ª&lt;code>step&lt;/code>å°±æ˜¯æ‰“å°å‡º&amp;quot;hello world&amp;quot;&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Task&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo-hello-world&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">echo&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;hello world&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»ºä¸€ä¸ª&lt;code>TaskRun&lt;/code>æ‰§è¡Œä¸Šé¢çš„&lt;code>Task&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tekton.dev/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TaskRun&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo-hello-world-task-run&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">taskRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo-hello-world&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡Œtask:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl apply -f &amp;lt;name-of-file.yaml&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥&lt;code>TaskRun&lt;/code>çš„è¾“å‡º, æ‰§è¡Œå‘½ä»¤:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">tkn taskrun describe echo-hello-world-task-run
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">Name: echo-hello-world-task-run
Namespace: tekton-pipelines
Task Ref: echo-hello-world
Status
STARTED DURATION STATUS
21 minutes ago 1 minute Succeeded
Input Resources
No resources
Output Resources
No resources
Params
No params
Steps
NAME STATUS
echo Completed
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Succeeded&lt;/code>çŠ¶æ€è¡¨ç¤ºtaskæ‰§è¡ŒæˆåŠŸ.&lt;/p>
&lt;p>æŸ¥çœ‹å®é™…çš„è¾“å‡º, æ‰§è¡Œå‘½ä»¤:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">tkn taskrun logs echo-hello-world-task-run
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æœ:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">[echo] hello world
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Minikubeå®‰è£…istio</title><link>https://atbug.com/install-istio-on-minikube/</link><pubDate>Fri, 17 Jan 2020 08:02:42 +0800</pubDate><guid>https://atbug.com/install-istio-on-minikube/</guid><description>
&lt;h2 id="å‡†å¤‡">å‡†å¤‡&lt;/h2>
&lt;p>&lt;strong>æ³¨æ„: istioctlçš„å®‰è£…è¦ä½¿ç”¨å®‰è£…é‡Œçš„, ä¸è¦æ˜¯ç”¨homebrewé‡Œçš„. &lt;a href="https://github.com/istio/istio/issues/19029">github issue&lt;/a>&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -L https://istio.io/downloadIstio &lt;span class="p">|&lt;/span> sh -
&lt;span class="nb">cd&lt;/span> istio-1.4.2
cp bin/istioctl /usr/local/bin/istioctl
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…å‰æ£€æŸ¥">å®‰è£…å‰æ£€æŸ¥&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">istioctl verify-install
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœæ£€æŸ¥æ²¡é—®é¢˜, ä¼šçœ‹åˆ°&lt;code>Install Pre-Check passed! The cluster is ready for Istio installation.&lt;/code>&lt;/p>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;p>istioæœ‰5ç§å†…å»ºçš„å®‰è£…é…ç½®&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>: remote, sds, default, demo, minimal&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">istioctl profile list
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>minimal: ä½¿ç”¨istioçš„æµé‡ç®¡ç†æ‰€éœ€ç»„ä»¶çš„æœ€å°åŒ–å®‰è£…&lt;/li>
&lt;li>default: æ ¹æ®IstioControlPlane APIçš„é»˜è®¤è®¾ç½®(å»ºè®®ç”¨äºç”Ÿäº§éƒ¨ç½²)å¯ç”¨ç»„ä»¶. æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œå‘½ä»¤istioctl profile dumpæ˜¾ç¤ºé»˜è®¤è®¾ç½®.&lt;/li>
&lt;li>demo: å‡ ä¹å®‰è£…æ‰€æœ‰çš„ç‰¹æ€§, åŒ…æ‹¬loggingå’Œtracingçš„æ¯”ä¾‹ä¸º100%. ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ, è´Ÿè½½å¤ªé‡&lt;/li>
&lt;/ul>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;/th>
&lt;th>default&lt;/th>
&lt;th>demo&lt;/th>
&lt;th>minimal&lt;/th>
&lt;th>sds&lt;/th>
&lt;th>remote&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Core components&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-citadel&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-egressgateway&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-galley&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-ingressgateway&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-nodeagent&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-pilot&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-policy&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-sidecar-injector&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-telemetry&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Addons&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>grafana&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>istio-tracing&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>kiali&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>prometheus&lt;/code>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;td>X&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;code>demo&lt;/code> profileå®‰è£…&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">istioctl manifest apply --set &lt;span class="nv">profile&lt;/span>&lt;span class="o">=&lt;/span>demo
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éªŒè¯å®‰è£…ç»“æœ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">istioctl manifest generate --set &lt;span class="nv">profile&lt;/span>&lt;span class="o">=&lt;/span>demo &amp;gt; /tmp/generated-manifest.yaml
istioctl verify-install -f /tmp/generated-manifest.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>&amp;hellip;&amp;hellip;
Checked 23 crds
Checked 9 Istio Deployments
Istio is installed successfully&lt;/p>
&lt;/blockquote>
&lt;h2 id="å¸è½½">å¸è½½&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">helm template install/kubernetes/helm/istio --namespace istio-system &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --values install/kubernetes/helm/istio/values-istio-demo.yaml &lt;span class="p">|&lt;/span> kubectl delete -f -
kubectl delete namespace istio-system
&lt;span class="c1">#delete all CRDs&lt;/span>
kubectl delete -f install/kubernetes/helm/istio-init/files
&lt;/code>&lt;/pre>&lt;/div>&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>&lt;a href="https://istio.io/docs/setup/additional-setup/config-profiles/">è¿™é‡Œ&lt;/a>å¯ä»¥æŸ¥çœ‹å„ä¸ªé…ç½®çš„è¯¦ç»†è¯´æ˜ &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>ç¥ç§˜çš„Eurekaè‡ªæˆ‘ä¿æŠ¤</title><link>https://atbug.com/translation-the-mystery-of-eurekas-self-preservation/</link><pubDate>Sun, 05 Jan 2020 14:14:03 +0800</pubDate><guid>https://atbug.com/translation-the-mystery-of-eurekas-self-preservation/</guid><description>
&lt;p>æœ¬æ–‡ç¿»è¯‘è‡ª&lt;a href="https://dzone.com/articles/the-mystery-of-eurekas-self-preservation">The Mystery of Eureka Self-Preservation&lt;/a>&lt;/p>
&lt;p>æ ¹æ®CAPå®šç†, Eurekaæ˜¯ä¸€ä¸ªAPç³»ç»Ÿ, è¿™å°±å¯¼è‡´äº†åœ¨ç½‘ç»œåˆ†åŒºæœŸé—´å¤šä¸ªæ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯ä¸ä¸€è‡´. è‡ªæˆ‘ä¿æŠ¤åŠŸèƒ½åˆ™æ˜¯ä¸ºäº†å°½å¯èƒ½é™ä½è¿™ç§ä¸ä¸€è‡´.&lt;/p>
&lt;h2 id="è‡ªæˆ‘ä¿æŠ¤çš„å®šä¹‰">è‡ªæˆ‘ä¿æŠ¤çš„å®šä¹‰&lt;/h2>
&lt;p>è‡ªæˆ‘ä¿æŠ¤(self preservation)æ˜¯Eurekaçš„ä¸€é¡¹åŠŸèƒ½, Eurekaæ³¨å†Œè¡¨åœ¨æœªæ”¶åˆ°å®ä¾‹çš„å¿ƒè·³æƒ…å†µè¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶åœæ­¢é©±é€è¿‡æœŸçš„å®ä¾‹.&lt;/p>
&lt;h3 id="ä»ä¸€ä¸ªå¥åº·çš„ç³»ç»Ÿå¼€å§‹">ä»ä¸€ä¸ªå¥åº·çš„ç³»ç»Ÿå¼€å§‹&lt;/h3>
&lt;p>æŠŠä¸‹é¢çœ‹æˆä¸€ä¸ªå¥åº·çš„ç³»ç»Ÿ&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/n5wZMX.jpg" alt="The healthy systemâ€Šâ€”â€Šbefore encountering network partition">&lt;/p>
&lt;p>å‡è®¾æ‰€æœ‰çš„å¾®æœåŠ¡éƒ½å¤„äºå¥åº·çš„çŠ¶æ€å¹¶æˆåŠŸæ³¨å†Œåˆ°Eurekaæ³¨å†Œè¡¨ä¸­.&lt;/p>
&lt;p>å¤šä¸ªæ³¨å†Œè¡¨é—´ä¼šåŒæ­¥æ³¨å†Œè¡¨è®°å½•, æ‰€æœ‰çš„å¾®æœåŠ¡å®ä¾‹éƒ½å¤„äºUPçŠ¶æ€. å‡è®¾å®ä¾‹2ä»æ³¨å†Œä¸­å¿ƒå‘ç°é‡Œå®ä¾‹4, å¹¶è°ƒç”¨å®ä¾‹4ä¸Šçš„æœåŠ¡.&lt;/p>
&lt;h3 id="çªå‘ç½‘ç»œåˆ†åŒº">çªå‘ç½‘ç»œåˆ†åŒº&lt;/h3>
&lt;p>å‡è®¾å‡ºç°äº†ç½‘ç»œåˆ†åŒº, ç³»ç»Ÿå˜æˆä¸‹é¢çš„çŠ¶æ€.&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/MznWWr.jpg" alt="During network partitionâ€Š - â€Šenters self-preservation">&lt;/p>
&lt;p>ç”±äºç½‘ç»œåˆ†åŒº, å®ä¾‹4å’Œ5ä¸¢å¤±äº†æ³¨å†Œä¸­å¿ƒçš„è¿æ¥, ä½†æ˜¯å®ä¾‹2ä»ç„¶å¯ä»¥è¿æ¥åˆ°å®ä¾‹4. EurekaæœåŠ¡ç«¯å› ä¸ºæ²¡æœ‰æ”¶åˆ°å®ä¾‹4å’Œ5çš„å¿ƒè·³(è¶…è¿‡ä¸€å®šæ—¶é—´å), å°†ä»–ä»¬é©±é€. ç„¶åEurekaæœåŠ¡ç«¯æ„è¯†åˆ°çªç„¶ä¸¢å¤±äº†è¶…è¿‡15%(2/5)çš„å¿ƒè·³, å› æ­¤å…¶è¿›å…¥&lt;em>è‡ªæˆ‘ä¿æŠ¤&lt;/em>æ¨¡å¼&lt;/p>
&lt;p>ä»æ­¤æ—¶å¼€å§‹, EurekaæœåŠ¡ç«¯ä¸åœ¨é©±é€ä»»ä½•å®ä¾‹, å³ä½¿å®ä¾‹çœŸæ­£çš„ä¸‹çº¿äº†.&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/uPic/7c9eHt.jpg" alt="During self-preservationâ€Š - â€Šstops expiring instances">&lt;/p>
&lt;p>å®ä¾‹3ä¸‹çº¿, ä½†å…¶å§‹ç»ˆå­˜åœ¨æ³¨å†Œè¡¨ä¸­.&lt;/p>
&lt;p>ä½†æ­¤æ—¶æ³¨å†Œè¡¨è¿˜ä¼šæ¥å—æ–°å®ä¾‹çš„æ³¨å†Œ.&lt;/p>
&lt;h2 id="è‡ªæˆ‘ä¿æŠ¤çš„åŸºæœ¬åŸç†">è‡ªæˆ‘ä¿æŠ¤çš„åŸºæœ¬åŸç†&lt;/h2>
&lt;p>è‡ªæˆ‘ä¿æŠ¤åŠŸèƒ½åœ¨ä¸‹é¢ä¸¤ç§æƒ…å†µä¸‹æ˜¯åˆç†çš„:&lt;/p>
&lt;ul>
&lt;li>EurekaæœåŠ¡ç«¯å› ä¸ºå¼±ç½‘åˆ†åŒºé—®é¢˜æ²¡æœ‰æ”¶åˆ°å¿ƒè·³(è¿™å¹¶ä¸æ„å‘³ç€å®¢æˆ·ç«¯ä¸‹çº¿), ä½†æ˜¯è¿™ç§é—®é¢˜å¯èƒ½ä¼šå¾ˆå¿«è¢«ä¿®å¤.&lt;/li>
&lt;li>å³ä½¿EurekaæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„è¿æ¥æ–­å¼€, å®¢æˆ·ç«¯é—´è¿˜å¯ä»¥ç»§ç»­ä¿æŒè¿æ¥. (æ¯”å¦‚ä¸Šé¢å®ä¾‹2ä»ç„¶å¯ä»¥è¿æ¥åˆ°å®ä¾‹4)&lt;/li>
&lt;/ul>
&lt;h3 id="é…ç½®-é»˜è®¤">é…ç½® (é»˜è®¤)&lt;/h3>
&lt;p>ä¸‹é¢çš„é…ç½®ä¼šç›´æ¥æˆ–é—´æ¥å½±å“åˆ°è‡ªæˆ‘ä¿æŠ¤çš„è¡Œä¸º.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">eureka.instance.lease-renewal-interval-in-seconds = 30
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®¢æˆ·ç«¯å‘é€å¿ƒè·³çš„é¢‘ç‡. æœåŠ¡ç«¯ä¼šä»¥æ­¤åœ¨è®¡ç®—æœŸæœ›æ”¶åˆ°å¿ƒè·³æ•°, é»˜è®¤30ç§’&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">eureka.instance.lease-expiration-duration-in-seconds = 90
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¤šé•¿æ—¶é—´æœªæ”¶åˆ°å¿ƒè·³å, å®ä¾‹æ‰å¯ä»¥è¢«é©±é€, é»˜è®¤90ç§’&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">eureka.server.eviction-interval-timer-in-ms = 60 * 1000
&lt;/code>&lt;/pre>&lt;/div>&lt;p>EurekaæœåŠ¡ç«¯é©±é€æ“ä½œçš„æ‰§è¡Œé¢‘ç‡, é»˜è®¤60ç§’&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">eureka.server.renewal-percent-threshold = 0.85
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœŸæœ›å¿ƒè·³æ•°è¾¾åˆ°è¯¥é˜ˆå€¼å, å°±ä¼šè¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼, é»˜è®¤0.85&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">eureka.server.renewal-threshold-update-interval-ms = 15 * 60 * 1000
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœŸæœ›å¿ƒè·³æ•°çš„è®¡ç®—é—´éš”, é»˜è®¤15åˆ†é’Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">eureka.server.enable-self-preservation = true
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ˜¯å¦å…è®¸EurekaæœåŠ¡ç«¯è¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼, é»˜è®¤å¼€å¯&lt;/p>
&lt;h2 id="ç†è§£é…ç½®">ç†è§£é…ç½®&lt;/h2>
&lt;p>EurekaæœåŠ¡ç«¯åœ¨&amp;quot;ä¸Šä¸€åˆ†é’Ÿå®é™…æ”¶åˆ°çš„å¿ƒè·³æ•°&amp;quot;å°äº&amp;quot;æ¯åˆ†é’ŸæœŸæœ›çš„å¿ƒè·³æ•°&amp;quot;æ—¶å°±ä¼šè¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼&lt;/p>
&lt;h3 id="æœŸæœ›çš„æ¯åˆ†é’Ÿå¿ƒè·³æ•°">æœŸæœ›çš„æ¯åˆ†é’Ÿå¿ƒè·³æ•°&lt;/h3>
&lt;p>å‡è®¾&lt;code>renewal-percent-threshold&lt;/code>è®¾ç½®ä¸º&lt;code>0.85&lt;/code>&lt;/p>
&lt;p>è®¡ç®—æ–¹å¼:&lt;/p>
&lt;ul>
&lt;li>å•ä¸ªå®ä¾‹æ¯åˆ†é’ŸæœŸæœ›çš„å¿ƒè·³æ•°æ˜¯: 2&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>&lt;/li>
&lt;/ul>
&lt;ul>
&lt;li>Nä¸ªå®ä¾‹çš„æ¯åˆ†é’ŸæœŸæœ›çš„å¿ƒè·³æ•°: 2 * N&lt;/li>
&lt;li>æœŸæœ›çš„ä¸Šä¸€åˆ†é’Ÿæœ€å°å¿ƒè·³æ•°: 2 * N * 0.85&lt;/li>
&lt;/ul>
&lt;h3 id="å®é™…çš„æ¯åˆ†é’Ÿå¿ƒè·³æ•°">å®é™…çš„æ¯åˆ†é’Ÿå¿ƒè·³æ•°&lt;/h3>
&lt;p>æ­£å¦‚ä¸Šé¢æ‰€è¿°, ä¸¤ä¸ªå®šæ—¶è°ƒåº¦å™¨ç‹¬ç«‹åœ°è¿è¡Œè®¡ç®—&lt;em>å®é™…&lt;/em>å’Œ&lt;em>æœŸæœ›&lt;/em>çš„å¿ƒè·³æ•°. æ­¤å¤–è¿˜æœ‰å¦ä¸€ä¸ªè°ƒåº¦ä»»åŠ¡&lt;code>EvictionTask&lt;/code>è¿›è¡Œç»“æœæ¯”è¾ƒ, å¹¶è¯†åˆ«å½“å‰ç³»ç»Ÿæ˜¯å¦åœ¨è‡ªæˆ‘ä¿æŠ¤çŠ¶æ€.&lt;/p>
&lt;p>è¿™ä¸ªè°ƒåº¦ä»»åŠ¡æ¯ä¸ª&lt;code>eviction-interval-timer-in-ms&lt;/code>æ—¶é—´æ‰§è¡Œä¸€æ¬¡, å¹¶å†³å®šæ˜¯å¦é©±é€å®ä¾‹.&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;ul>
&lt;li>åŸºäºä½¿ç”¨çš„ç»éªŒ, å¤§å¤šæ•°æƒ…å†µä¸‹è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼éƒ½æ˜¯é”™è¯¯çš„, å®ƒé”™è¯¯åœ°è®¤ä¸ºä¸€äº›ä¸‹çº¿çš„å¾®æœåŠ¡å®ä¾‹æ˜¯ä¸è‰¯çš„ç½‘ç»œåˆ†åŒº&lt;/li>
&lt;li>è‡ªæˆ‘ä¿æŠ¤æ°¸è¿œä¸ä¼šè¿‡æœŸ, é™¤éä¸‹çº¿çš„å®ä¾‹é‡æ–°ä¸Šçº¿&lt;/li>
&lt;li>å¦‚æœå¯ç”¨äº†è‡ªæˆ‘ä¿ç•™, åˆ™æ— æ³•å¯¹å®ä¾‹çš„å¿ƒè·³é—´éš”è¿›è¡Œå¾®è°ƒ, å› ä¸ºè‡ªæˆ‘ä¿æŠ¤åœ¨è®¡ç®—æœŸæœ›å¿ƒè·³æ•°æ˜¯æŒ‰ç…§30sé—´éš”æ¥è®¡ç®—çš„&lt;/li>
&lt;li>é™¤éç¯å¢ƒä¸­ç»å¸¸å‡ºç°ç±»ä¼¼çš„ç½‘ç»œåˆ†åŒºæ•…éšœ, å¦åˆ™å»ºè®®å…³é—­&lt;/li>
&lt;/ul>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>è¿™ä¸ªå€¼æ˜¯å›ºå®šçš„, æºäºé»˜è®¤çš„å¿ƒè·³é—´éš”æ˜¯30s, æ•…æ¯åˆ†é’Ÿ2æ¬¡. è§eureka-core-1.7.2çš„&lt;code>AbstractInstanceRegistryL226&lt;/code> &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>åŠ é€Ÿäº‘åŸç”Ÿçš„ Java å¼€å‘</title><link>https://atbug.com/speed-up-java-development-on-kubernetes/</link><pubDate>Sat, 21 Dec 2019 20:45:22 +0800</pubDate><guid>https://atbug.com/speed-up-java-development-on-kubernetes/</guid><description>
&lt;p>ä»Šå¤©æ¥è¯´è¯´æ—¥å¸¸åœ¨Kuberneteså¼€å‘Javaé¡¹ç›®é‡åˆ°çš„é—®é¢˜.&lt;/p>
&lt;p>å½“æˆ‘ä»¬æ–°å»ºä¸€ä¸ªé¡¹ç›®çš„æ—¶å€™, æ€»æ˜¯é¢ä¸´éœ€è¦æ–°å»ºmanifest, å¹³æ—¶éƒ½æ˜¯&lt;code>copy+paste+modify&lt;/code>. èƒ½å¦ä»¥å˜æˆçš„æ–¹å¼æ¥ç”Ÿæˆ?&lt;/p>
&lt;p>å¼€å‘æ—¶çš„æ­¥éª¤ä¹Ÿæ¯”è¾ƒç¹ç: &lt;code>docker build&lt;/code>, &lt;code>docker push&lt;/code>, &lt;code>kubectl apple&lt;/code>, &lt;code>kubectl delete pod&lt;/code>. å¯¹äºä¸€ä¸ªJavaåº”ç”¨æ¥è¯´è¿˜å¤šäº†ä¸€æ­¥ç¼–è¯‘. æ“ä½œä¸€æ¬¡è¿˜ok, ä½†æ˜¯ä¸€å¤©åå‡ æ¬¡æ€»ä¼šæœ‰æƒ³åçš„æ„Ÿè§‰. è¿™äº›æ­¥éª¤èƒ½å¦ç®€åŒ–æˆä¸€ä¸ªå‘½ä»¤, ç”šè‡³ä¿®æ”¹äº†ä»£ç è‡ªåŠ¨å°±å®Œæˆä¸Šé¢ä¸€ç³»åˆ—çš„æ“ä½œ?&lt;/p>
&lt;p>å®ç°è¿™äº›æˆ‘ä»¬éœ€è¦å‡ ä¸ªå·¥å…·: &lt;a href="https://github.com/dekorateio/dekorate">dekorate&lt;/a>, &lt;a href="https://github.com/GoogleContainerTools/jib">Jib&lt;/a>, &lt;a href="https://github.com/GoogleContainerTools/skaffold">Skaffold&lt;/a>. å…¶ä¸­Jibä¹Ÿåœ¨ä¸Šä¸€ç¯‡æ–‡ç« &lt;a href="https://atbug.com/build-docker-or-oci-image-with-jib-for-java/">ä½¿ç”¨Jibä¸ºJavaåº”ç”¨æ„å»ºé•œåƒ&lt;/a>ä¸­ä»‹ç»è¿‡.&lt;/p>
&lt;h2 id="dekorate">dekorate&lt;/h2>
&lt;blockquote>
&lt;p>Dekorate is a collection of Java compile-time generators and decorators for Kubernetes/OpenShift manifests.
Dekorateæ˜¯Javaç¼–è¯‘æ—¶ç”Ÿæˆå’Œè£…é¥°Kubernetes/OpenShiftçš„manifestsçš„å·¥å…·&lt;/p>
&lt;/blockquote>
&lt;h3 id="å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹&lt;/h3>
&lt;h4 id="1-é€šè¿‡ä½¿ç”¨spring-initializerhttpsstartspringioç”Ÿæˆä¸€ä¸ªé¡¹ç›®spring-boot-222-å¹¶åŠ å…¥ä¾èµ–">1. é€šè¿‡ä½¿ç”¨&lt;a href="https://start.spring.io">Spring Initializer&lt;/a>ç”Ÿæˆä¸€ä¸ªé¡¹ç›®(Spring Boot 2.2.2), å¹¶åŠ å…¥ä¾èµ–:&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>io.dekorate&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>kubernetes-spring-starter&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>0.10.0&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="2-åŠ å…¥ä¸€ä¸ªç®€å•çš„controller">2. åŠ å…¥ä¸€ä¸ªç®€å•çš„&lt;code>Controller&lt;/code>:&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * @author Addo.Zhang
&lt;/span>&lt;span class="cm"> * @date 2019/12/22
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="nd">@RestController&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">DekorateExampleController&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@GetMapping&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">hi&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;Hello World&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-æ‰§è¡Œå‘½ä»¤mvn-clean-install-ç„¶ååœ¨targetclassesmeta-infdekorateç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°kubernetesjsonå’Œkubernetesymlä¸¤ä¸ªæ–‡ä»¶">3. æ‰§è¡Œå‘½ä»¤&lt;code>mvn clean install&lt;/code>, ç„¶ååœ¨&lt;code>target/classes/META-INF/dekorate&lt;/code>ç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°&lt;code>kubernetes.json&lt;/code>å’Œ&lt;code>kubernetes.yml&lt;/code>ä¸¤ä¸ªæ–‡ä»¶.&lt;/h4>
&lt;p>&lt;code>kubernetes.yml&lt;/code>çš„å†…å®¹:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;v1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Service&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;ClusterIP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;apps/v1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Deployment&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">env&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;KUBERNETES_NAMESPACE&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">valueFrom&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;metadata.namespace&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;addo/dekorate-example:0.0.1-SNAPSHOT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;IfNotPresent&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">livenessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">failureThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/actuator/info&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initialDelaySeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">successThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeoutSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dekorate-example&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">containerPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;TCP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">readinessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">failureThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/actuator/health&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8081&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">scheme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initialDelaySeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">successThreshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeoutSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ymlä¸­åŒ…å«äº†&lt;code>Service&lt;/code>å’Œ&lt;code>Deployment&lt;/code>ä¸¤éƒ¨åˆ†, dekorateå®Œç¾å…¼å®¹çš„Spring:&lt;/p>
&lt;ul>
&lt;li>&lt;code>app: dekorate-example&lt;/code>: é¡¹ç›®å&lt;/li>
&lt;li>&lt;code>version: 0.0.1-SNAPSHOT&lt;/code>: é¡¹ç›®å½“å‰ç‰ˆæœ¬&lt;/li>
&lt;li>&lt;code>group: addo&lt;/code>: æ˜¯æˆ‘ç³»ç»Ÿå½“å‰ç”¨æˆ·å&lt;/li>
&lt;li>&lt;code>/actuator/health&lt;/code>: Spring Boot 2.2åactuatorçš„health endpoint, ä½œä¸º&lt;code>readinessProbe&lt;/code>&lt;/li>
&lt;li>&lt;code>/actuator/info&lt;/code>: Spring Boot 2.2åactuatorçš„endpoint, ä½œä¸º&lt;code>livenessProbe&lt;/code>&lt;/li>
&lt;/ul>
&lt;h3 id="è¿›é˜¶">è¿›é˜¶&lt;/h3>
&lt;p>&lt;strong>å‰é¢ymlçš„å†…å®¹éƒ½æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„, å‡å¦‚æœ‰äº›ç‰¹æ®Šçš„éœ€æ±‚. æ¯”å¦‚ä¿®æ”¹é•œåƒçš„&lt;code>repository&lt;/code>å³è¿™é‡Œçš„&lt;code>group&lt;/code>, å¦‚ä½•æ“ä½œ?&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">dekorate.kubernetes.group = addozhang
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æœ:&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/5zgkfl.jpg" alt="Change Image Repository">&lt;/p>
&lt;p>&lt;strong>æˆ–è€…ä¿®æ”¹Serviceçš„ç±»å‹ä¸ºNodePort&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">dekorate.kubernetes.service-type = NodePort
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/vIen3M.jpg" alt="NodePort Service">&lt;/p>
&lt;h4 id="é…ç½®">é…ç½®&lt;/h4>
&lt;p>dekorationæä¾›äº†&lt;a href="https://github.com/dekorateio/dekorate/blob/master/assets/config.md">ä¸°å¯Œçš„é…ç½®&lt;/a>æ¥ä¸ªæ€§åŒ–manifest.&lt;/p>
&lt;p>é™¤äº†ä¸Šé¢ä½¿ç”¨çš„é…ç½®æ–‡ä»¶(properties/yaml)çš„æ–¹å¼, è¿˜æä¾›äº†&lt;code>Annotation&lt;/code>æ³¨è§£é…ç½®æ–¹å¼.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">import&lt;/span> &lt;span class="nn">io.dekorate.kubernetes.annotation.Env&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">io.dekorate.kubernetes.annotation.KubernetesApplication&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@KubernetesApplication&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">envVars&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nd">@Env&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;key1&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;var1&amp;#34;&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Main&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//Your code goes here
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/exQoxy.jpg" alt="@KubernetesApplication Annotation">&lt;/p>
&lt;h2 id="jib">Jib&lt;/h2>
&lt;p>Jibçš„è¯´æ˜è¯·çœ‹ä¸Šä¸€ç¯‡æ–‡ç« :&lt;a href="https://atbug.com/build-docker-or-oci-image-with-jib-for-java/">ä½¿ç”¨Jibä¸ºJavaåº”ç”¨æ„å»ºé•œåƒ&lt;/a>&lt;/p>
&lt;h3 id="æ’ä»¶é…ç½®">æ’ä»¶é…ç½®&lt;/h3>
&lt;p>ä¸‹é¢æ˜¯é’ˆå¯¹è¯¥é¡¹ç›®æ·»åŠ çš„é…ç½®:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="nt">&amp;lt;plugin&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.google.cloud.tools&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>jib-maven-plugin&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>1.8.0&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;configuration&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;container&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-Xmx128m&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-Xms64m&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/jvmFlags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;labels&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;Author&amp;gt;&lt;/span>Addo.Zhang&lt;span class="nt">&amp;lt;/Author&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/labels&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;creationTime&amp;gt;&lt;/span>USE_CURRENT_TIMESTAMP&lt;span class="nt">&amp;lt;/creationTime&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/container&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;from&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;image&amp;gt;&lt;/span>openjdk:8-jdk-alpine&lt;span class="nt">&amp;lt;/image&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/from&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;to&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;image&amp;gt;&lt;/span>addo/dekorate-example&lt;span class="nt">&amp;lt;/image&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;tags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;tag&amp;gt;&lt;/span>latest&lt;span class="nt">&amp;lt;/tag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/tags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/to&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;allowInsecureRegistries&amp;gt;&lt;/span>true&lt;span class="nt">&amp;lt;/allowInsecureRegistries&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/configuration&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/plugin&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œå‘½ä»¤&lt;code>mvn compile jib:dockerBuild&lt;/code>ä¾¿å¯ä»¥ç¼–è¯‘ä»£ç , æ„å»ºé•œåƒå¹¶æ¨é€åˆ°é•œåƒä»“åº“.&lt;/p>
&lt;h2 id="skaffold">Skaffold&lt;/h2>
&lt;p>&lt;a href="https://github.com/GoogleContainerTools/skaffold">Skaffold&lt;/a>ä¹Ÿæ˜¯GoogleContainerToolsä¸­çš„ä¸€ä¸ªå·¥å…·.&lt;/p>
&lt;blockquote>
&lt;p>Skaffold is a command line tool that facilitates continuous development for Kubernetes applications. You can iterate on your application source code locally then deploy to local or remote Kubernetes clusters. Skaffold handles the workflow for building, pushing and deploying your application. It also provides building blocks and describe customizations for a CI/CD pipeline.
Skaffoldæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·, å¯ä¿ƒè¿›Kubernetesåº”ç”¨ç¨‹åºçš„æŒç»­å¼€å‘. å¯ä»¥åœ¨æœ¬åœ°è¿­ä»£åº”ç”¨ç¨‹åºæºä»£ç , ç„¶åéƒ¨ç½²åˆ°æœ¬åœ°æˆ–è¿œç¨‹Kubernetesé›†ç¾¤. Skaffoldå¤„ç†æ„å»º, æ¨é€å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºçš„å·¥ä½œæµç¨‹. å®ƒè¿˜æä¾›äº†æ„å»ºå—å¹¶æè¿°äº†CI/CDç®¡é“çš„è‡ªå®šä¹‰.&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­, é€šè¿‡ä¸Jibçš„è”åŠ¨, å®Œæˆç¼–è¯‘ä»£ç , æ„å»ºé•œåƒ, æ¨é€é•œåƒ, éƒ¨ç½²ä¸€ç³»åˆ—æ“ä½œ.&lt;/p>
&lt;p>![Run](&lt;a href="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/2019-12-23">https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/2019-12-23&lt;/a> 15.12.24.gif)&lt;/p>
&lt;p>æˆªå±ä¸­çš„æ“ä½œ, å› ä¸ºæ²¡æœ‰ä»£ç æ”¹åŠ¨è€Œä¸ç»­æ„å»ºé•œåƒ, Skaffoldç›´æ¥ä»cacheä¸­è·å–é•œåƒå¹¶éƒ¨ç½²åˆ°Kubernetesä¸­.&lt;/p>
&lt;h3 id="skaffoldæ“ä½œ">Skaffoldæ“ä½œ&lt;/h3>
&lt;h4 id="1-æ‰§è¡Œå‘½ä»¤skaffold-init---xxenablejibinitå¹¶åœ¨æç¤ºå‡ºè¾“å…¥y">1. æ‰§è¡Œå‘½ä»¤&lt;code>skaffold init --XXenableJibInit&lt;/code>å¹¶åœ¨æç¤ºå‡ºè¾“å…¥&lt;code>y&lt;/code>&lt;/h4>
&lt;h4 id="2-è¯¥å‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ªåä¸ºskaffoldyamlçš„æ–‡ä»¶">2. è¯¥å‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ªåä¸º&lt;code>skaffold.yaml&lt;/code>çš„æ–‡ä»¶&lt;/h4>
&lt;p>ç”±äº&lt;code>dekorate&lt;/code>åŒæ—¶ç”Ÿæˆäº†&lt;code>json&lt;/code>å’Œ&lt;code>yaml&lt;/code>æ ¼å¼çš„manifest, è¢«&lt;code>skaffold&lt;/code>æ£€æµ‹åˆ°. å®é™…æ“ä½œä¸­åªéœ€è¦å…¶ä¸­ä¸€ä¸ªå³å¯.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">skaffold/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dekorate-example&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">artifacts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">addo/dekorate-example&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">jib&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kubectl&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">manifests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">target/classes/META-INF/dekorate/kubernetes.json&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">target/classes/META-INF/dekorate/kubernetes.yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-æ‰§è¡Œskaffold-run">3. æ‰§è¡Œ&lt;code>skaffold run&lt;/code>&lt;/h4>
&lt;h4 id="4-podå¯åŠ¨å®Œæˆå-é€šè¿‡kubectl-port-forward-podname-here-8081">4. podå¯åŠ¨å®Œæˆå, é€šè¿‡&lt;code>kubectl port-forward PODNAME-HERE 8081&lt;/code>&lt;/h4>
&lt;h4 id="5-è¯·æ±‚http-httplocalhost8081">5. è¯·æ±‚&lt;code>http http://localhost:8081&lt;/code>&lt;/h4>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/wt2BVU.jpg" alt="">&lt;/p>
&lt;h3 id="è¿›é˜¶-1">è¿›é˜¶&lt;/h3>
&lt;p>Skaffoldçš„åŠŸèƒ½å¼ºå¤§, ç›®å‰ä¸ªäººä½¿ç”¨çš„æœ‰é™, æœ‰æ—¶é—´æ–°å¼€ä¸€ç¯‡æ¥å­¦ä¹ ä¸€ä¸‹.&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/FXu4Hy.jpg" alt="">&lt;/p>
&lt;h4 id="cli">CLI&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">âœ ~ skaffold &lt;span class="nb">help&lt;/span>
A tool that facilitates continuous development &lt;span class="k">for&lt;/span> Kubernetes applications.
Find more information at: https://skaffold.dev/docs/getting-started/
End-to-end pipelines:
run Run a pipeline
dev Run a pipeline in development mode
debug &lt;span class="o">[&lt;/span>beta&lt;span class="o">]&lt;/span> Run a pipeline in debug mode
Pipeline building blocks &lt;span class="k">for&lt;/span> CI/CD:
build Build the artifacts
deploy Deploy pre-built artifacts
delete Delete the deployed application
render &lt;span class="o">[&lt;/span>alpha&lt;span class="o">]&lt;/span> Perform all image builds, and output rendered Kubernetes manifests
Getting started with a new project:
init &lt;span class="o">[&lt;/span>alpha&lt;span class="o">]&lt;/span> Generate configuration &lt;span class="k">for&lt;/span> deploying an application
fix Update old configuration to newest schema version
Other Commands:
completion Output shell completion &lt;span class="k">for&lt;/span> the given shell &lt;span class="o">(&lt;/span>bash or zsh&lt;span class="o">)&lt;/span>
config Interact with the Skaffold configuration
credits Export third party notices to given path &lt;span class="o">(&lt;/span>./skaffold-credits by default&lt;span class="o">)&lt;/span>
diagnose Run a diagnostic on Skaffold
version Print the version information
Usage:
skaffold &lt;span class="o">[&lt;/span>flags&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>options&lt;span class="o">]&lt;/span>
Use &lt;span class="s2">&amp;#34;skaffold &amp;lt;command&amp;gt; --help&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> more information about a given command.
Use &lt;span class="s2">&amp;#34;skaffold options&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> a list of global command-line options &lt;span class="o">(&lt;/span>applies to all commands&lt;span class="o">)&lt;/span>.
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="yamlé…ç½®">Yamlé…ç½®&lt;/h4>
&lt;p>å‚è€ƒ&lt;a href="https://skaffold.dev/docs/references/yaml/">skaffold.yaml&lt;/a>&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>æ–‡ç« çš„å¼€å¤´æˆ‘ä»¬æåˆ°å¦‚ä½•åšåˆ°ä¿®æ”¹ä»£ç åè‡ªåŠ¨å®Œæˆä¸€äº›åˆ—çš„æ“ä½œ, é€šè¿‡&lt;code>skaffold dev&lt;/code>å°±å¯ä»¥å®ç°.&lt;/p>
&lt;p>æ–‡ç« ä¸­ä½¿ç”¨çš„&lt;code>dekoration-example&lt;/code>å¯åœ¨&lt;a href="https://github.com/addozhang/dekorate-example">GitHub&lt;/a>ä¸Šæ‰¾åˆ°.&lt;/p></description></item><item><title>ä½¿ç”¨ Jib ä¸º Java åº”ç”¨æ„å»ºé•œåƒ</title><link>https://atbug.com/build-docker-or-oci-image-with-jib-for-java/</link><pubDate>Mon, 09 Dec 2019 10:05:30 +0800</pubDate><guid>https://atbug.com/build-docker-or-oci-image-with-jib-for-java/</guid><description>
&lt;p>&lt;img src="https://github.com/GoogleContainerTools/jib/raw/master/logo/jib-build-docker-java-container-image.png" alt="pic from jib github">&lt;/p>
&lt;p>&lt;a href="https://github.com/GoogleContainerTools/jib">Jib&lt;/a>æ˜¯Google Container Toolsä¸­çš„ä¸€ä¸ªå·¥å…·ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Jib builds optimized Docker and OCI images for your Java applications without a Docker daemon - and without deep mastery of Docker best-practices. It is available as plugins for Maven and Gradle and as a Java library.&lt;/p>
&lt;p>Jibæ— éœ€Dockerå®ˆæŠ¤ç¨‹åºå³å¯ä¸ºJavaåº”ç”¨ç¨‹åºæ„å»ºä¼˜åŒ–çš„Dockerå’ŒOCIæ˜ åƒ-æ— éœ€æ·±å…¥äº†è§£Dockeræœ€ä½³å®è·µ. å®ƒå¯ä»¥ä½œä¸ºMavenå’ŒGradleçš„æ’ä»¶ä»¥åŠJavaåº“ä½¿ç”¨.&lt;/p>
&lt;/blockquote>
&lt;h2 id="ä¸dockeræ„å»ºæµç¨‹æ¯”è¾ƒ">ä¸Dockeræ„å»ºæµç¨‹æ¯”è¾ƒ&lt;/h2>
&lt;p>Dockeré•œåƒæ„å»ºæµç¨‹:&lt;/p>
&lt;p>&lt;img src="https://4.bp.blogspot.com/-SXeItzMS_oo/WzVemqaj7CI/AAAAAAAAF_w/t5Lau7EOC84Kywct_OPiDGIomCiFTywgwCLcBGAs/s1600/docker_build_flow.png" alt="pic from Google Cloud Platform Blog">&lt;/p>
&lt;p>Jibæ„å»ºæµç¨‹:&lt;/p>
&lt;p>&lt;img src="https://3.bp.blogspot.com/-_qNyJdVno8E/WzVeqmuC5PI/AAAAAAAAF_0/AHaZ1_ZnJmg8eaUnTlUGyUVe06KRmvlYQCLcBGAs/s1600/jib_build_flow.png" alt="">&lt;/p>
&lt;p>&lt;em>(pic from Google Cloud Platform Blog)&lt;/em>&lt;/p>
&lt;h2 id="å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹&lt;/h2>
&lt;p>æ„å»ºé•œåƒ, å¹¶æ¨é€åˆ°å¯¹åº”çš„é•œåƒä»“åº“, æ¯”å¦‚Docker Hubç­‰, æˆ–è€…è‡ªå»ºä»“åº“.&lt;/p>
&lt;p>&lt;code>mvn compile com.google.cloud.tools:jib-maven-plugin:1.8.0:build -Dimage=&amp;lt;MY IMAGE&amp;gt;&lt;/code>&lt;/p>
&lt;p>å‡å¦‚è¦æ„å»ºåˆ°Dockerå®ˆæŠ¤è¿›ç¨‹çš„è¯:&lt;/p>
&lt;p>&lt;code>mvn compile com.google.cloud.tools:jib-maven-plugin:1.8.0:dockerBuild&lt;/code>&lt;/p>
&lt;h3 id="æ’ä»¶">æ’ä»¶&lt;/h3>
&lt;h4 id="è®¾ç½®">è®¾ç½®&lt;/h4>
&lt;p>&lt;code>pom.xml&lt;/code>ä¸­ä½¿ç”¨&lt;code>jib-maven-plugin&lt;/code>æ’ä»¶.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="nt">&amp;lt;project&amp;gt;&lt;/span>
...
&lt;span class="nt">&amp;lt;build&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;plugins&amp;gt;&lt;/span>
...
&lt;span class="nt">&amp;lt;plugin&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.google.cloud.tools&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>jib-maven-plugin&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>1.8.0&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;configuration&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;to&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;image&amp;gt;&lt;/span>myimage&lt;span class="nt">&amp;lt;/image&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/to&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/configuration&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/plugin&amp;gt;&lt;/span>
...
&lt;span class="nt">&amp;lt;/plugins&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/build&amp;gt;&lt;/span>
...
&lt;span class="nt">&amp;lt;/project&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="æ’ä»¶é…ç½®">æ’ä»¶é…ç½®&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="nt">&amp;lt;plugin&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.google.cloud.tools&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>jib-maven-plugin&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>${jib.maven-plugin-version}&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;configuration&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;container&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-Xmx1024m&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-Xms512m&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-XX:NewRatio=1&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-XX:+UseConcMarkSweepGC&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-XX:CMSInitiatingOccupancyFraction=75&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-XX:+UseCMSInitiatingOccupancyOnly&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-XX:ReservedCodeCacheSize=128M&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-XX:ParallelGCThreads=2&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-XX:+ExplicitGCInvokesConcurrent&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-Duser.timezone=Asia/Shanghai&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;jvmFlag&amp;gt;&lt;/span>-Djava.security.egd=file:/dev/./urandom&lt;span class="nt">&amp;lt;/jvmFlag&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/jvmFlags&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;labels&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;Author&amp;gt;&lt;/span>Addo.Zhang&lt;span class="nt">&amp;lt;/Author&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/labels&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;user&amp;gt;&lt;/span>apps&lt;span class="nt">&amp;lt;/user&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;appRoot&amp;gt;&lt;/span>/home/apps/local&lt;span class="nt">&amp;lt;/appRoot&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;workingDirectory&amp;gt;&lt;/span>/home/apps/local&lt;span class="nt">&amp;lt;/workingDirectory&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;creationTime&amp;gt;&lt;/span>USE_CURRENT_TIMESTAMP&lt;span class="nt">&amp;lt;/creationTime&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/container&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;from&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;image&amp;gt;&lt;/span>PRIVATE_REGISTRY/REPOSITORY/GLOBAL_BASE:1.0.0&lt;span class="nt">&amp;lt;/image&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;auth&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;username&amp;gt;&lt;/span>USERNAME&lt;span class="nt">&amp;lt;/username&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;password&amp;gt;&lt;/span>PASSWORD&lt;span class="nt">&amp;lt;/password&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/auth&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/from&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;to&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;image&amp;gt;&lt;/span>PRIVATE_REGISTRY/REPOSITORY/${project.artifactId}&lt;span class="nt">&amp;lt;/image&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;auth&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;username&amp;gt;&lt;/span>USERNAME&lt;span class="nt">&amp;lt;/username&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;password&amp;gt;&lt;/span>PASSWORD&lt;span class="nt">&amp;lt;/password&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/auth&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/to&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;allowInsecureRegistries&amp;gt;&lt;/span>true&lt;span class="nt">&amp;lt;/allowInsecureRegistries&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/configuration&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/plugin&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„: å¦‚æœä½ çš„ç§åº“æ˜¯insecureçš„, éœ€è¦æŒ‡å®š&lt;code>allowInsecureRegistries&lt;/code>ä¸ºtrue. åŒæ—¶å‘½ä»¤è¡Œæ„å»ºçš„æ—¶å€™æ·»åŠ &lt;code>-DsendCredentialsOverHttp=true&lt;/code>&lt;/p>
&lt;p>æ›´å¤šçš„é…ç½®å‚è§&lt;a href="https://github.com/GoogleContainerTools/jib/tree/master/jib-maven-plugin">å®˜æ–¹æ–‡æ¡£&lt;/a>&lt;/p></description></item><item><title>Spring Cloud Hoxtonå‘å¸ƒ</title><link>https://atbug.com/spring-cloud-hoxton-release/</link><pubDate>Wed, 04 Dec 2019 11:09:07 +0800</pubDate><guid>https://atbug.com/spring-cloud-hoxton-release/</guid><description>
&lt;p>&lt;a href="https://spring.io/blog/2019/11/28/spring-cloud-hoxton-released">åŸæ–‡&lt;/a>&lt;/p>
&lt;p>Spring Cloud Hoxton.RELEASEåŸºäºSpring Boot 2.2.1.RELEASE&lt;/p>
&lt;h3 id="æ–‡æ¡£å˜åŒ–">æ–‡æ¡£å˜åŒ–&lt;/h3>
&lt;p>Hoxton.RELEASEä½¿ç”¨äº†æ–°çš„&lt;a href="https://cloud.spring.io/spring-cloud-static/Hoxton.RELEASE/reference/html/spring-cloud.html">é¦–é¡µ&lt;/a>, æ–°çš„æ ·å¼ä»¥åŠå•é¡µé¢, å¤šé¡µé¢å’ŒPDFç‰ˆæœ¬.&lt;/p>
&lt;h3 id="æ–°çš„è´Ÿè½½å‡è¡¡å™¨å®ç°">æ–°çš„è´Ÿè½½å‡è¡¡å™¨å®ç°&lt;/h3>
&lt;p>Hoxton.RELEASEæ˜¯ç¬¬ä¸€ä¸ªåŒ…å«é˜»å¡å’Œéé˜»å¡å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨å®ç°çš„ç‰ˆæœ¬, æ›¿ä»£è¿›å…¥ç»´æŠ¤çŠ¶æ€çš„Netflix Ribbon.&lt;/p>
&lt;p>æ­é…&lt;code>BlockingLoadBalancerClient&lt;/code>ä½¿ç”¨&lt;code>RestTemplate&lt;/code>, éœ€è¦åœ¨classpathä¸­å¼•å…¥&lt;code>org.springframework.cloud:spring-cloud-loadbalancer&lt;/code>. è¿™ä¸ªä¾èµ–åŒæ ·ç”¨äºä½¿ç”¨äº†&lt;code>@LoadBalanced WebClient.Builder&lt;/code>çš„å“åº”å¼åº”ç”¨ä¸­. å”¯ä¸€çš„åŒºåˆ«æ˜¯Spring Cloudä¼šè‡ªåŠ¨é…ç½®&lt;code>ReactorLoadBalancerExchangeFilterFunction&lt;/code>å®ä¾‹. æ›´å¤šå†…å®¹æŸ¥çœ‹&lt;a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-commons/2.2.0.M2/reference/html/#_spring_resttemplate_as_a_load_balancer_client">æ–‡æ¡£&lt;/a>. æ–°çš„&lt;code>ReactorLoadBalancerExchangeFilterFunction&lt;/code>å¯ç”¨äºè‡ªåŠ¨è£…é…å¹¶è‡ªåŠ¨ä¼ é€’ç»™&lt;code>WebClient.Builder&lt;/code>(&lt;a href="https://cloud.spring.io/spring-cloud-commons/reference/html/#webflux-with-reactive-loadbalancer">æ–‡æ¡£&lt;/a>).&lt;/p>
&lt;h3 id="spring-cloud-netflix">Spring Cloud Netflix&lt;/h3>
&lt;ul>
&lt;li>å¢åŠ äº†æ–°çš„&lt;code>ReactiveDiscoveryClient&lt;/code>, åŒæ—¶å¢åŠ äº†æ–°çš„Spring Cloud Circuit Breaker APIçš„Hystrixå®ç°.&lt;/li>
&lt;li>å¢åŠ &lt;a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-netflix/2.2.0.RC2/reference/html/#disabling-spring-cloud-circuit-breaker-hystrix">é…ç½®é¡¹&lt;/a>&lt;code>spring.cloud.circuitbreaker.hystrix.enabled&lt;/code>æ¥ç¦ç”¨Spring Cloud CircuitBreaker Hystrixçš„è‡ªåŠ¨é…ç½®.&lt;/li>
&lt;/ul>
&lt;h3 id="spring-cloud-cloudfoundry">Spring Cloud Cloudfoundry&lt;/h3>
&lt;p>æ”¯æŒæ–°çš„&lt;code>ReactiveDiscoveryClient&lt;/code>&lt;/p>
&lt;h3 id="spring-cloud-bus">Spring Cloud Bus&lt;/h3>
&lt;p>æ–‡æ¡£æ›´æ–°&lt;/p>
&lt;h3 id="spring-cloud-vault">Spring Cloud Vault&lt;/h3>
&lt;ul>
&lt;li>åœ¨Pivotalåº”ç”¨ç¨‹åºæœåŠ¡)ä»¥å‰çš„PCF)ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºå¯ä»¥åˆ©ç”¨å®¹å™¨çš„èº«ä»½æ¥ä½¿ç”¨ä¿é™©æŸœçš„PCFèº«ä»½éªŒè¯æ”¯æŒè¿›è¡Œèº«ä»½éªŒè¯&lt;/li>
&lt;li>ä½¿ç”¨X-Vault-Namespaceæ ‡å¤´æ”¯æŒVaultåç§°ç©ºé—´(Vault EnterpriseåŠŸèƒ½)&lt;/li>
&lt;/ul>
&lt;h3 id="spring-cloud-kubernetes">Spring Cloud Kubernetes&lt;/h3>
&lt;p>æ”¯æŒæ–°çš„&lt;code>ReactiveDiscoveryClient&lt;/code>&lt;/p>
&lt;h3 id="spring-cloud-contract">Spring Cloud Contract&lt;/h3>
&lt;ul>
&lt;li>å®Œæ•´çš„æ–‡æ¡£é‡å†™&lt;/li>
&lt;li>ä¸»è¦æµ‹è¯•ç±»ç”Ÿæˆé‡æ„&lt;/li>
&lt;li>ä»Groovyåˆ°Javaçš„å¤§é‡é‡å†™&lt;/li>
&lt;li>æ·»åŠ äº†å¯¹ä½¿ç”¨Kotlinå’ŒJavaç¼–å†™åˆåŒçš„æ”¯æŒ&lt;/li>
&lt;li>åœ¨åˆåŒDSLå’Œè¿è¡Œæ—¶å­˜æ ¹ç”Ÿæˆä¸­æ·»åŠ äº†inProgressæ ‡å¿—&lt;/li>
&lt;li>å¢åŠ äº†å¯¹ç”Ÿæˆæµ‹è¯•çš„TestNGæ”¯æŒ&lt;/li>
&lt;li>è®¸å¤šåº“ç‰ˆæœ¬å¢é‡(åŒ…æ‹¬Groovy, WireMockå’ŒPact)&lt;/li>
&lt;/ul>
&lt;h3 id="spring-cloud-consul">Spring Cloud Consul&lt;/h3>
&lt;p>æ”¯æŒæ–°çš„&lt;code>ReactiveDiscoveryClient&lt;/code>ä»¥åŠConsulçš„ä¸€è‡´æ€§æ¨¡å‹&lt;/p>
&lt;h3 id="spring-cloud-config">Spring Cloud Config&lt;/h3>
&lt;ul>
&lt;li>æ–°çš„ç¯å¢ƒä»“åº“æ”¯æŒAWS S3&lt;/li>
&lt;li>æ·»åŠ äº†è§£å¯†çº¯æ–‡æœ¬å±æ€§çš„åŠŸèƒ½&lt;/li>
&lt;/ul>
&lt;h3 id="spring-cloud-gcp">Spring Cloud Gcp&lt;/h3>
&lt;ul>
&lt;li>æ·»åŠ BigQueryæ¨¡å—&lt;/li>
&lt;li>ä¸ºCloud Foundryåˆ›å»ºäº†ä¸€ä¸ªå•ç‹¬çš„å¯åŠ¨å™¨ï¼š&lt;code>spring-cloud-gcp-starter-cloudfoundry&lt;/code>&lt;/li>
&lt;li>å¯ä»¥æµè§ˆ&lt;a href="https://github.com/spring-cloud/spring-cloud-gcp/blob/master/CHANGELOG.adoc#120release-2019-11-26">å˜æ›´æ—¥å¿—&lt;/a>æ–‡æ¡£ä»¥è·å–æ›´å¤šä¿¡æ¯&lt;/li>
&lt;/ul>
&lt;h3 id="spring-cloud-stream">Spring Cloud Stream&lt;/h3>
&lt;p>ä»annotation-drivenè¿‡åº¦åˆ°äº†æ›´åŠ ç®€å•çš„å‡½æ•°å¼.&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://spring.io/blog/2019/10/14/spring-cloud-stream-demystified-and-simplified">Spring Cloud Stream - demystified and simplified&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://spring.io/blog/2019/10/17/spring-cloud-stream-functional-and-reactive">Spring Cloud Stream - functional and reactive&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://spring.io/blog/2019/10/25/spring-cloud-stream-and-spring-integration">Spring Cloud Stream - and Spring Integration&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://spring.io/blog/2019/10/31/spring-cloud-stream-event-routing">Spring Cloud Stream - Event Routing&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="spring-cloud-commons">Spring Cloud Commons&lt;/h3>
&lt;p>å¼•å…¥é˜»å¡å’Œéé˜»å¡å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨å®ç°, æ¥æ›¿ä»£è¿›å…¥ç»´æŠ¤çŠ¶æ€çš„Netflix Ribbon.&lt;/p>
&lt;h3 id="spring-cloud-openfeign">Spring Cloud Openfeign&lt;/h3>
&lt;ul>
&lt;li>Openfeignå‡çº§åˆ°10.4.0&lt;/li>
&lt;li>æ”¯æŒSpring Cloud LoadBalancer&lt;/li>
&lt;/ul>
&lt;h3 id="spring-cloud-task">Spring Cloud Task&lt;/h3>
&lt;ul>
&lt;li>æ”¯æŒMicrometer&lt;/li>
&lt;li>æ›´æ–°æ–‡æ¡£&lt;/li>
&lt;li>ä½¿ç”¨Spring Batchåˆ†åŒºæ—¶å¯åŠ¨çš„ä»»åŠ¡åº”ç”¨ç°åœ¨åŠ å…¥äº†external-execution-id&lt;/li>
&lt;/ul>
&lt;h3 id="spring-cloud-sleuth">Spring Cloud Sleuth&lt;/h3>
&lt;ul>
&lt;li>åŠ å…¥å¯¹æœ€æ–°çš„Brave(åŒ…æ‹¬æ¶ˆæ¯é‡‡æ ·)çš„æ”¯æŒ&lt;/li>
&lt;li>æ·»åŠ äº†onLastOperator Reactorè·Ÿè¸ªé€‰é¡¹ï¼Œä»¥æé«˜æ€§èƒ½&lt;/li>
&lt;li>æ·»åŠ äº†Redisè·Ÿè¸ª&lt;/li>
&lt;li>å°†é»˜è®¤é‡‡æ ·å™¨è®¾ç½®ä¸ºé™é€Ÿé‡‡æ ·å™¨&lt;/li>
&lt;li>æ·»åŠ äº†å¯¹AWS SQSè·Ÿè¸ªçš„æ”¯æŒ&lt;/li>
&lt;li>å¢åŠ äº†å¯¹Quartzè·Ÿè¸ªçš„æ”¯æŒ&lt;/li>
&lt;li>æ·»åŠ äº†è¿›ç¨‹å†…ä¼ æ’­æœºåˆ¶&lt;/li>
&lt;li>é»˜è®¤ä¸ºZipkinæŠ¥å‘Šçš„MicrometeræŒ‡æ ‡&lt;/li>
&lt;/ul>
&lt;h3 id="spring-cloud-aws">Spring Cloud AWS&lt;/h3>
&lt;p>Bugä¿®å¤&lt;/p>
&lt;h3 id="spring-cloud-zookeeper">Spring Cloud Zookeeper&lt;/h3>
&lt;p>æ”¯æŒæ–°çš„&lt;code>ReactiveDiscoveryClient&lt;/code>&lt;/p>
&lt;h3 id="spring-cloud-security">Spring Cloud Security&lt;/h3>
&lt;p>Bugä¿®å¤&lt;/p>
&lt;h3 id="spring-cloud-curcuitbreaker">Spring Cloud CurcuitBreaker&lt;/h3>
&lt;p>å¼•å…¥æ–°çš„é¡¹ç›®Spring Cloud CircuitBreaker, è¿™ä¸ªé¡¹ç›®åŒ…å«çš„æŠ½è±¡çš„APIç”¨äºåœ¨é¡¹ç›®ä¸­ä½¿ç”¨æ–­è·¯å™¨. æ”¯æŒè¯¥APIçš„å®ç°:&lt;/p>
&lt;ul>
&lt;li>Resilience4j&lt;/li>
&lt;li>Spring Retry&lt;/li>
&lt;li>Hystrix (in &lt;a href="https://github.com/spring-cloud/spring-cloud-netflix/blob/master/spring-cloud-netflix-hystrix/src/main/java/org/springframework/cloud/netflix/hystrix/HystrixCircuitBreaker.java">spring-cloud-netflix&lt;/a>)&lt;/li>
&lt;li>Sentinel (in &lt;a href="https://github.com/alibaba/spring-cloud-alibaba/tree/master/spring-cloud-alibaba-sentinel">spring-cloud-alibaba&lt;/a>)&lt;/li>
&lt;/ul>
&lt;p>&lt;a href="https://spring.io/blog/2019/04/16/introducing-spring-cloud-circuit-breaker">æ›´å¤šä¿¡æ¯&lt;/a>&lt;/p>
&lt;ul>
&lt;li>æ—¶æ·»åŠ äº†è‡ªåŠ¨é…ç½®, åœ¨ä½¿ç”¨Resilience4Jæ”¶é›†æ–­è·¯å™¨çš„æŒ‡æ ‡æ•°æ®&lt;/li>
&lt;li>å‡çº§åˆ°Resilience4J 1.1.0&lt;/li>
&lt;li>æ·»åŠ é…ç½®é¡¹ç¦ç”¨REsilience4Jçš„è‡ªåŠ¨é…ç½®&lt;/li>
&lt;/ul>
&lt;h3 id="spring-cloud-function">Spring Cloud Function&lt;/h3>
&lt;p>æ·»åŠ äº†æ›´å¤šæ–°ç‰¹æ€§:&lt;/p>
&lt;ul>
&lt;li>é€æ˜ç±»å‹è½¬æ¢&lt;/li>
&lt;li>å‡½æ•°è·¯ç”±&lt;/li>
&lt;li>å‡½æ•°å‚æ•°&lt;/li>
&lt;/ul>
&lt;p>&lt;a href="https://spring.io/blog/2019/11/25/announcing-the-release-of-spring-cloud-function-3-0-0-release">æ›´å¤šè¯¦ç»†ä¿¡æ¯&lt;/a>&lt;/p>
&lt;h3 id="spring-cloud-gateway">Spring Cloud Gateway&lt;/h3>
&lt;ul>
&lt;li>æ”¯æŒæ–°çš„&lt;code>ReactiveDiscoveryClient&lt;/code>&lt;/li>
&lt;li>RSocketæ¨¡å—è¿ç§»åˆ°äº†è‡ªå·±ç»´æŠ¤çš„ä½äºSpring Cloud Incubator organizationé¡¹ç›®ä¸­&lt;/li>
&lt;li>é€šè¿‡å¢åŠ çš„ä½¿ç”¨äº†æ–°Spring Cloud CircuitBreakeråº“è¿‡æ»¤å™¨ä¸ºè·¯ç”±æä¾›æ–­è·¯å™¨åŠŸèƒ½&lt;/li>
&lt;/ul></description></item><item><title>Bose QC35 å›ºä»¶é™çº§</title><link>https://atbug.com/bose-qc35-downgrade/</link><pubDate>Sun, 10 Nov 2019 19:50:27 +0800</pubDate><guid>https://atbug.com/bose-qc35-downgrade/</guid><description>
&lt;p>ä¸ºä»€ä¹ˆè¦é™çº§? æ—¢ç„¶å·²ç»æœåˆ°äº†è¿™é‡Œ, ç›¸ä¿¡ä¸ªä¸­åŸå› ä¹Ÿéƒ½æ¸…æ¥š.&lt;/p>
&lt;p>æˆ‘çš„QC35ä¸€ä»£, ä¹‹å‰å‡çº§åˆ°äº†3.0.3å›ºä»¶. ç›®å‰å·²æˆåŠŸé™çº§åˆ°äº†1.0.6, ä¸‹é¢çš„æ“ä½œæ­¥éª¤Mac OSXçš„, ä½œè€…ä¹Ÿæä¾›äº†&lt;a href="https://github.com/bosefirmware/ced/blob/master/README.md">Windowsä¸Šçš„æ“ä½œæ­¥éª¤&lt;/a>.&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/LaTKaT.jpg" alt="">&lt;/p>
&lt;h3 id="æ“ä½œæ­¥éª¤">æ“ä½œæ­¥éª¤&lt;/h3>
&lt;ol>
&lt;li>ç¡®è®¤å·²ç»å¸è½½Bose Updater&lt;/li>
&lt;li>GitHubä¸Šä¸‹è½½ä½œè€…å·²ç»æ”¹å¥½çš„&lt;a href="https://github.com/bosefirmware/ced/raw/master/BOSEUPDATER.EXE">6.0.0.4388&lt;/a>ç‰ˆæœ¬çš„Bose Updater&lt;/li>
&lt;li>è§£å‹åå¤åˆ¶åˆ°&lt;code>/Applications&lt;/code>ä¸‹&lt;/li>
&lt;li>è¿è¡ŒBose Updaterç¡®è®¤èƒ½å¦æ­£å¸¸è¿è¡Œ&lt;/li>
&lt;li>é€€å‡º (å³é”®&amp;gt;Exit)&lt;/li>
&lt;li>æ£€æŸ¥æ˜¯å¦è¿˜æœ‰Bose Updaterçš„è¿›ç¨‹&lt;/li>
&lt;li>æ‰“å¼€&lt;code>https://btu.bose.com/&lt;/code>&lt;/li>
&lt;li>é¡µé¢ä¸Šé€‰æ‹©&lt;code>Launch&lt;/code> Bose Updater&lt;/li>
&lt;li>çœ‹åˆ°ä¸‹é¢ç•Œé¢(å€Ÿç”¨ä½œè€…çš„å›¾)æ—¶, é”®ç›˜ä¸Šä¾æ¬¡æŒ‰: a, d, v, æ–¹å‘ä¸Š, æ–¹å‘ä¸‹
&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/QqtGw0.jpg" alt="">&lt;/li>
&lt;li>æ¥ä¸‹æ¥ä¼šçœ‹åˆ°ä¸‹é¢ç•Œé¢(å€Ÿç”¨ä½œè€…çš„å›¾)
&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/GUHIVT.jpg" alt="">&lt;/li>
&lt;li>å¯ä»¥ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©ç‰ˆæœ¬è¿›è¡Œå‡/é™çº§&lt;/li>
&lt;li>ç­‰å¾…å‡/é™çº§å®Œæˆ&lt;/li>
&lt;li>å¸è½½æ‰‹æœºapp (æˆ‘æ˜¯å¸è½½äº†, é˜²æ­¢å†æ¬¡æ‰‹è´±)&lt;/li>
&lt;/ol>
&lt;h3 id="å‚è€ƒ">å‚è€ƒ&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.reddit.com/r/bose/comments/cw47fx/githubcombosefirmware/">Reddit&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/bosefirmware/ced">GitHub&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Docker Engine API on Mac Osx</title><link>https://atbug.com/docker-engine-api-on-mac-osx/</link><pubDate>Wed, 06 Nov 2019 20:19:50 +0800</pubDate><guid>https://atbug.com/docker-engine-api-on-mac-osx/</guid><description>
&lt;p>æ ¹æ®å®˜æ–¹çš„æ–‡æ¡£&lt;a href="https://docs.docker.com/docker-for-mac/docker-toolbox/">Docker Desktop on Mac vs. Docker Toolbox&lt;/a>, Docker Desktop on Macåªæä¾›äº†UNIX socket&lt;code>/var/run/docker.sock&lt;/code>, å¹¶æœªæä¾›tcpçš„ç›‘å¬(é»˜è®¤2375ç«¯å£).&lt;/p>
&lt;p>&lt;strong>å¦‚æœä½¿ç”¨linuxçš„é…ç½®æ–¹å¼åœ¨&lt;code>Docker Desktop&lt;/code>ä¸­é…ç½®&lt;code>host&lt;/code>, &lt;code>Docker Desktop&lt;/code>å°†æ— æ³•å¯åŠ¨. éœ€è¦å»&lt;code>~/.docker/daemon.json&lt;/code>ä¸­åˆ é™¤&lt;code>hosts&lt;/code>é…ç½®æ‰èƒ½æ­£å¸¸å¯åŠ¨.&lt;/strong>&lt;/p>
&lt;p>é€šè¿‡ä¸‹é¢çš„æ–¹å¼æš´éœ²å‡º2375çš„tcp&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">docker run --rm -d -v /var/run/docker.sock:/var/run/docker.sock -p 127.0.0.1:2375:2375 bobrik/socat TCP-LISTEN:2375,fork UNIX-CONNECT:/var/run/docker.sock
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åé€šè¿‡&lt;code>docker version&lt;/code>æŸ¥çœ‹å½“å‰çš„docker engineçš„ç‰ˆæœ¬, æ¯”å¦‚1.40. æŸ¥çœ‹å®˜æ–¹çš„Engine APIæ–‡æ¡£: &lt;a href="https://docs.docker.com/engine/api/v1.40">https://docs.docker.com/engine/api/v1.40&lt;/a>&lt;/p>
&lt;p>æœç´¢ä¸ªé•œåƒæµ‹è¯•ä¸€ä¸‹:&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/15729240620185.jpg" alt="">&lt;/p></description></item><item><title>Spring Boot 2.2.0 å‘å¸ƒ</title><link>https://atbug.com/spring-boot-2-2-0-release/</link><pubDate>Tue, 22 Oct 2019 09:27:03 +0800</pubDate><guid>https://atbug.com/spring-boot-2-2-0-release/</guid><description>
&lt;p>è¯‘è‡ª: &lt;a href="https://spring.io/blog/2019/10/16/spring-boot-2-2-0">https://spring.io/blog/2019/10/16/spring-boot-2-2-0&lt;/a>&lt;/p>
&lt;h3 id="ç»„ä»¶å‡çº§">ç»„ä»¶å‡çº§&lt;/h3>
&lt;ul>
&lt;li>Spring AMQP 2.2&lt;/li>
&lt;li>Spring Batch 4.2&lt;/li>
&lt;li>Spring Data Moore&lt;/li>
&lt;li>Spring Framework 5.2&lt;/li>
&lt;li>Spring HATEOAS 1.0&lt;/li>
&lt;li>Spring Integration 5.2&lt;/li>
&lt;li>Spring Kafka 2.3&lt;/li>
&lt;li>Spring Security 5.2&lt;/li>
&lt;li>Spring Session Corn&lt;/li>
&lt;/ul>
&lt;h3 id="ç¬¬ä¸‰æ–¹åº“å‡çº§">ç¬¬ä¸‰æ–¹åº“å‡çº§&lt;/h3>
&lt;ul>
&lt;li>Elasticsearch 6.7&lt;/li>
&lt;li>Flyway 6.0&lt;/li>
&lt;li>Jackson 2.10&lt;/li>
&lt;li>JUnit 5.5&lt;/li>
&lt;li>Micrometer 1.3&lt;/li>
&lt;li>Reactor Dysprosium&lt;/li>
&lt;li>Solr 8.0&lt;/li>
&lt;/ul>
&lt;h3 id="æ€§èƒ½æå‡">æ€§èƒ½æå‡&lt;/h3>
&lt;h4 id="å»¶è¿Ÿåˆå§‹åŒ–lazy-initialization">å»¶è¿Ÿåˆå§‹åŒ–(Lazy initialization)&lt;/h4>
&lt;p>æ”¯æŒå¼€å¯å…¨å±€å»¶è¿ŸåŠ è½½&lt;code>spring.main.lazy-initialization&lt;/code>. ä»£ä»·:&lt;/p>
&lt;ul>
&lt;li>åˆæ¬¡å¤„ç†HTTPè¯·æ±‚è€—æ—¶é•¿&lt;/li>
&lt;li>æœ¬åº”åœ¨å¯åŠ¨åˆå§‹åŒ–æ—¶å‡ºç°çš„é—®é¢˜, å»¶åå‡ºç°&lt;/li>
&lt;/ul>
&lt;p>æ›´å¤šå‚è€ƒ: &lt;a href="https://spring.io/blog/2019/03/14/lazy-initialization-in-spring-boot-2-2">https://spring.io/blog/2019/03/14/lazy-initialization-in-spring-boot-2-2&lt;/a>&lt;/p>
&lt;h3 id="java-13æ”¯æŒ">Java 13æ”¯æŒ&lt;/h3>
&lt;p>è·ŸéšSpring Framework5.2å¯¹Java 13çš„æ”¯æŒ, Spring Boot 2.2ç°åœ¨ä¹Ÿæ”¯æŒäº†Java13. åŒæ—¶å…¼å®¹Java 11å’Œ8.&lt;/p>
&lt;h3 id="ä¸å¯å˜çš„configurationpropertiesç»‘å®š">ä¸å¯å˜çš„&lt;code>@ConfigurationProperties&lt;/code>ç»‘å®š&lt;/h3>
&lt;p>ç°åœ¨åŠ å…¥äº†åŸºäºæ„é€ å™¨çš„ç»‘å®š, å…è®¸&lt;code>@ConfigurationProperties&lt;/code>æ ‡æ³¨çš„ç±»ä¸å¯å˜(å±æ€§ä¸å¯å˜).&lt;/p>
&lt;p>å¯é€šè¿‡&lt;code>@ConfigurationProperties&lt;/code>æ ‡æ³¨ç±», æˆ–è€…ä½¿ç”¨&lt;code>@ConstructorBinding&lt;/code>æ ‡æ³¨æ„é€ å™¨æ¥å¼€å¯.&lt;/p>
&lt;p>é¢å¤–çš„æ³¨è§£å¦‚&lt;code>@DefaultValue&lt;/code>, &lt;code>@DateTimeFormt&lt;/code>å¯å¯¹æ„é€ å‚æ•°è¿›è¡Œé…ç½®.&lt;/p>
&lt;p>æ›´å¤šå‚è€ƒ: &lt;a href="https://docs.spring.io/spring-boot/docs/2.2.0.RELEASE/reference/html/spring-boot-features.html#boot-features-external-config-constructor-binding">https://docs.spring.io/spring-boot/docs/2.2.0.RELEASE/reference/html/spring-boot-features.html#boot-features-external-config-constructor-binding&lt;/a>&lt;/p>
&lt;h3 id="rscoketæ”¯æŒ">RScoketæ”¯æŒ&lt;/h3>
&lt;p>ä½¿ç”¨æ–°çš„starter&lt;code>spring-boot-starter-rsocket&lt;/code>è‡ªåŠ¨é…ç½®.&lt;/p>
&lt;p>Spring Securityçš„RScoketé›†æˆåœ¨classpathä¸­å­˜åœ¨&lt;code>spring-security-rsocket&lt;/code>æ—¶è‡ªåŠ¨å®Œæˆé…ç½®.&lt;/p>
&lt;p>æ›´å¤šå‚è€ƒ: &lt;a href="https://docs.spring.io/spring-boot/docs/2.2.0.RELEASE/reference/html//spring-boot-features.html#boot-features-rsocket">https://docs.spring.io/spring-boot/docs/2.2.0.RELEASE/reference/html//spring-boot-features.html#boot-features-rsocket&lt;/a>&lt;/p>
&lt;h3 id="å¥åº·æŒ‡ç¤ºå™¨åˆ†ç»„">å¥åº·æŒ‡ç¤ºå™¨åˆ†ç»„&lt;/h3>
&lt;p>æ”¯æŒå¯¹å¥åº·æŒ‡ç¤ºå™¨(Health Indicator)è¿›è¡Œåˆ†ç»„. æ¯”å¦‚å°†åº”ç”¨éƒ¨ç½²åˆ°Kubernetesæ—¶, å¸Œæœ›é’ˆå¯¹&amp;quot;liveness&amp;quot;å’Œ&amp;quot;readiness&amp;quot;å¯¹æŒ‡ç¤ºå™¨è¿›è¡Œåˆ†ç»„&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">management.endpoint.health.group.custom.include=db
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥æ—¶ä½¿ç”¨&lt;code>localhost:8080/actuator/health/custom&lt;/code>&lt;/p>
&lt;p>æ›´å¤šå‚è€ƒ: &lt;a href="https://docs.spring.io/spring-boot/docs/2.2.0.RELEASE/reference/html//production-ready-features.html#health-groups">https://docs.spring.io/spring-boot/docs/2.2.0.RELEASE/reference/html//production-ready-features.html#health-groups&lt;/a>&lt;/p>
&lt;h3 id="å…¶ä»–å˜åŒ–">å…¶ä»–å˜åŒ–&lt;/h3>
&lt;p>å‚è€ƒ: &lt;a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.2-Release-Notes">https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.2-Release-Notes&lt;/a>&lt;/p></description></item><item><title>Zipkin dependenciesçš„å‘ä¹‹äºŒ: å¿ƒè·³è¶…æ—¶å’ŒExecutor OOM</title><link>https://atbug.com/zipkin-dependencies-bug-two-timeout-and-oom/</link><pubDate>Sun, 22 Sep 2019 18:27:37 +0800</pubDate><guid>https://atbug.com/zipkin-dependencies-bug-two-timeout-and-oom/</guid><description>
&lt;p>ä¸Šå›è¯´ä¸ºäº†è§£å†³ååé—®é¢˜, å°†&lt;a href="https://github.com/openzipkin/zipkin-dependencies">zipkin-dependencies&lt;/a>çš„ç‰ˆæœ¬å‡çº§åˆ°äº†2.3.0.&lt;/p>
&lt;p>å¥½æ™¯ä¸é•¿, ä»æŸä¸€å¤©å¼€å§‹ä½œä¸šè¿è¡ŒæŠ¥é”™:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">Issue communicating with driver in heartbeater
org.apache.spark.rpc.RpcTimeoutException: Futures timed out after [10000 milliseconds]. This timeout is controlled by spark.executor.heartbeatInterval
...
19/09/18 08:33:20 ERROR Executor: Exception in task 1.0 in stage 1.0 (TID 4)
java.lang.OutOfMemoryError: Java heap space
...
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ&lt;/h3>
&lt;p>æœ€æ–°ç‰ˆæœ¬(2.3.0)ç›®å‰ä¸æ”¯æŒé¢å¤–çš„sparkå’Œelasticsearch-sparkçš„é…ç½®, å·²ç»æäº¤äº†&lt;a href="https://github.com/openzipkin/zipkin-dependencies/pull/151">PR&lt;/a>&lt;/p>
&lt;ol>
&lt;li>
&lt;p>è¶…æ—¶çš„è§£å†³æ–¹æ¡ˆ: ä¸ºsparkæŒ‡å®šé…ç½®&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">spark.executor.heartbeatInterval=600000
spark.network.timeout=600000
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>OOMè§£å†³æ–¹æ¡ˆ: æ ¹æ®å®é™…æƒ…å†µé€šè¿‡&lt;code>es.input.max.docs.per.partition&lt;/code>é…ç½®executorçš„æ•°é‡. è°ƒæ•´è¿è¡Œå†…å­˜åŠ&lt;code>spark.executor.memory&lt;/code>&lt;/p>
&lt;/li>
&lt;/ol></description></item><item><title>Zipkin dependenciesçš„å‘ä¹‹ä¸€: è€—æ—¶è¶Šæ¥è¶Šé•¿</title><link>https://atbug.com/zipkin-dependencies-bug-one/</link><pubDate>Sun, 22 Sep 2019 17:59:56 +0800</pubDate><guid>https://atbug.com/zipkin-dependencies-bug-one/</guid><description>
&lt;p>zipkin-dependenciesæ˜¯zipkinè°ƒç”¨é“¾çš„ä¾èµ–åˆ†æå·¥å…·.&lt;/p>
&lt;p>ç³»ç»Ÿä¸Šçº¿æ—¶ä½¿ç”¨äº†å½“æ—¶çš„æœ€æ–°ç‰ˆæœ¬&lt;code>2.0.1&lt;/code>, è¿è¡Œä¸€å¹´ä¹‹åéšç€æœåŠ¡çš„å¢å¤š, åˆ†æä¸€å¤©çš„æ•°æ®è€—æ—¶è¶Šæ¥è¶Šå¤š. ä»æœ€åˆçš„å‡ åˆ†é’Ÿ, åˆ°æœ€æ…¢çš„å‡ åå°æ—¶(æ•°æ®é‡18m).&lt;/p>
&lt;p>æœ€ç»ˆè¿”ç°æ˜¯ç‰ˆæœ¬çš„é—®é¢˜, å‡çº§åˆ°&amp;gt;=&lt;code>2.3.0&lt;/code>çš„ç‰ˆæœ¬ä¹‹åååè¿…é€Ÿä¸Šå‡.&lt;/p>
&lt;p>æ‰€ä»¥ä¾¿æœ‰äº†issue: &lt;a href="https://github.com/openzipkin/zipkin-dependencies/issues/149">Reminder: do NOT use the version before 2.3.0&lt;/a>&lt;/p>
&lt;p>ä½†è¿™ä¹Ÿå¼•æ¥äº†å¦ä¸€ä¸ªå‘: &lt;a href="https://atbug.com/zipkin-dependencies-bug-two-timeout-and-oom/">å¿ƒè·³è¶…æ—¶å’ŒExecutor OOM&lt;/a>&lt;/p>
&lt;h3 id="tldr">TL;DR&lt;/h3>
&lt;p>ç®€å•æµè§ˆäº†ä¸‹zipkin-dependenciesçš„æºç , 2.0.1å’Œ2.3.2çš„æ¯”è¾ƒå¤§çš„å·®è·æ˜¯ä¾èµ–çš„&lt;code>elasticsearch-spark&lt;/code>çš„ç‰ˆæœ¬. å‰è€…ç”¨çš„æ˜¯&lt;code>6.3.2&lt;/code>, åè€…æ˜¯&lt;code>7.3.0&lt;/code>.&lt;/p>
&lt;p>å°è¯•åœ¨&lt;code>zipkin-dependencies-2.0.1&lt;/code>ä¸­ä½¿ç”¨&lt;code>elasticsearch-spark-7.3.0&lt;/code>, å’Œ&lt;code>2.3.2&lt;/code>çš„æ€§èƒ½ä¸€ç›´.&lt;/p>
&lt;p>é€šè¿‡æ‰“å¼€log4j debugæ—¥å¿—, å‘ç°åˆ°&lt;code>elasticsearch-spark&lt;/code>ä¸¤ä¸ªç‰ˆæœ¬çš„è¿è¡Œå·®å¼‚:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">#7.3.0
19/09/05 18:13:14 INFO DAGScheduler: Submitting 3 missing tasks from ShuffleMapStage 0 (MapPartitionsRDD[1] at groupBy at ElasticsearchDependenciesJob.java:185) (first 15 tasks are for partitions Vector(0, 1, 2))
#6.3.2
19/09/05 18:09:56 INFO DAGScheduler: Submitting 214 missing tasks from ShuffleMapStage 0 (MapPartitionsRDD[1] at groupBy at ElasticsearchDependenciesJob.java:185) (first 15 tasks are for partitions Vector(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14))
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="restservicefindpartitionsl268çš„æºç ">&lt;code>RestService#findPartitions()L268&lt;/code>çš„æºç :&lt;/h4>
&lt;p>&lt;code>7.3.0&lt;/code>
&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/rXGrya.jpg" alt="">&lt;/p>
&lt;p>&lt;code>6.3.2&lt;/code>
&lt;img src="https://raw.githubusercontent.com/addozhang/oss/master/blog/upload/wswyzO.jpg" alt="">&lt;/p>
&lt;p>7.x &lt;code>es.input.max.docs.per.partition&lt;/code>ä¸º&lt;code>null&lt;/code> è®¡ç®—å‡ºpartitions=3 (å®é™…åˆ†åŒºæ•°ä¸º3, ä½¿ç”¨æ–¹æ³•&lt;code>#findShardPartitions()&lt;/code>)
6.x &lt;code>es.input.use.sliced.partitions&lt;/code>ä¸º&lt;code>true&lt;/code>, è®¡ç®—å‡ºpartitions=214 (ä½¿ç”¨æ–¹æ³•&lt;code>#findSlicePartitions()&lt;/code>)&lt;/p>
&lt;p>åœ¨7.xä¸­, å¯ä»¥é€šè¿‡è®¾ç½®&lt;code>es.input.max.docs.per.partition&lt;/code>çš„å€¼æ¥è®¾ç½®åˆ‡ç‰‡æ•°é‡(å¯¹å•ä¸ªpartitionè¿›è¡Œåˆ‡åˆ†, é€šè¿‡å¢åŠ å¹¶è¡Œä»»åŠ¡æ•°é‡æ¥æé«˜åå)&lt;/p>
&lt;p>**è¯¥è¡Œä»£ç çš„commit message: **&lt;/p>
&lt;blockquote>
&lt;p>Remove default setting for max documents per partition We added support for sliced scrolls back in 5.0, which allows subdividing scrolls into smaller input splits. there are some cases where the added subdivision of the scroll operations causes high amounts of overhead when reading very large shards. in most cases, shards should be small enough that a regular read operation over them should complete in reasonable time. In order to avoid performance degradation at higher levels, we are removing the default value of 100k from this setting, and instead, checking if it is set. Additionally, the &amp;lsquo;es.input.use.sliced.partitions&amp;rsquo; setting has been removed as it is now redundant.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="https://github.com/elastic/elasticsearch-hadoop/issues/1196">å…³è”çš„issue#1196&lt;/a>&lt;/p></description></item><item><title>å¦‚ä½•é€‰æ‹©Kafka Topicçš„åˆ†åŒºæ•°</title><link>https://atbug.com/how-to-choose-topic-partition-count-number-kafka/</link><pubDate>Fri, 30 Aug 2019 11:10:46 +0800</pubDate><guid>https://atbug.com/how-to-choose-topic-partition-count-number-kafka/</guid><description>
&lt;p>åœ¨kafkaä¸­, topicçš„åˆ†åŒºæ˜¯å¹¶è¡Œè®¡ç®—çš„å•å…ƒ. åœ¨producerç«¯å’Œbrokerç«¯, å¯ä»¥åŒæ—¶å¹¶å‘çš„å†™æ•°æ®åˆ°ä¸åŒçš„åˆ†åŒºä¸­.
åœ¨consumerç«¯, Kafkaæ€»æ˜¯å°†æŸä¸ªåˆ†åŒºåˆ†é…ä¸ªä¸€ä¸ªconsumerçº¿ç¨‹. å› æ­¤åŒä¸€ä¸ªæ¶ˆè´¹ç»„å†…çš„å¹¶è¡Œåº¦ä¸åˆ†åŒºæ•°æ¯æ¯ç›¸å…³.&lt;/p>
&lt;p>Partitionåˆ†åŒºæ•°çš„å¤§å°, æ›´å¤šç›´æ¥å½±å“åˆ°æ¶ˆè´¹ç«¯çš„åå(ä¸€ä¸ªåˆ†åŒºåªèƒ½åŒä¸€æ¶ˆè´¹ç»„çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹). åˆ†åŒºæ•°å°, æ¶ˆè´¹ç«¯çš„ååå°±ä½. ä½†æ˜¯å¤ªå¤§ä¹Ÿä¼šæœ‰å…¶ä»–çš„å½±å“&lt;/p>
&lt;p>åŸåˆ™:&lt;/p>
&lt;ul>
&lt;li>æ›´å¤šçš„åˆ†åŒºå¯æé«˜ååé‡&lt;/li>
&lt;li>åˆ†åŒºæ•°è¶Šå¤šæ‰“å¼€çš„æ–‡ä»¶å¥æŸ„è¶Šå¤š&lt;/li>
&lt;li>åˆ†åŒºæ•°è¶Šå¤šé™ä½å¯ç”¨æ€§&lt;/li>
&lt;li>æ›´å¤šçš„åˆ†åŒºå¢åŠ ç«¯åˆ°ç«¯çš„å»¶è¿Ÿ&lt;/li>
&lt;li>å®¢æˆ·ç«¯éœ€è¦æ›´å¤šçš„å†…å­˜&lt;/li>
&lt;/ul>
&lt;p>å½’æ ¹ç»“åº•è¿˜æ˜¯å¾—æœ‰ä¸ªåº¦. å¦‚ä½•æ‰¾å‡ºè¿™ä¸ªåº¦?&lt;/p>
&lt;p>æœ‰ä¸ªç²—ç•¥çš„è®¡ç®—å…¬å¼: &lt;code>max(t/p, t/c)&lt;/code>. &lt;code>t&lt;/code>å°±æ˜¯æ‰€é¢„æœŸååé‡, &lt;code>p&lt;/code>æ˜¯å½“å‰ç”Ÿäº§ç«¯å•ä¸ªåˆ†åŒºçš„åå, é‚£&lt;code>c&lt;/code>å°±æ˜¯æ¶ˆè´¹ç«¯å•ä¸ªåˆ†åŒºçš„åå.&lt;/p>
&lt;p>æ¯”å¦‚å•ä¸ªpartitionçš„ç”Ÿäº§ç«¯ååæ˜¯200, æ¶ˆè´¹ç«¯æ˜¯100. é¢„æœŸçš„ååæ˜¯500, é‚£ä¹ˆpartitionçš„æ•°é‡å°±æ˜¯5.&lt;/p>
&lt;p>å•ä¸ªåˆ†åŒºçš„ååé€šå¸¸é€šè¿‡ä¿®æ”¹é…ç½®æ¥æå‡, æ¯”å¦‚ç”Ÿäº§ç«¯çš„æ‰¹å¤„ç†å¤§å°, å‹ç¼©ç®—æ³•, acknowledgementç±»å‹, å‰¯æœ¬æ•°ç­‰. è€Œåœ¨æ¶ˆè´¹ç«¯åˆ™æ›´ä¾èµ–äºæ¶ˆæ¯çš„å¤„ç†é€Ÿåº¦.&lt;/p>
&lt;h3 id="å‚è€ƒ">å‚è€ƒ&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.confluent.io/blog/how-choose-number-topics-partitions-kafka-cluster">Confluentåšå®¢&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://engineering.linkedin.com/kafka/benchmarking-apache-kafka-2-million-writes-second-three-cheap-machines">Linkedinçš„benchmark&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>åšå®¢æœ€è¿‘åŠå¹´æ²¡ä»€ä¹ˆäº§å‡º</title><link>https://atbug.com/no-output-in-past-half-year/</link><pubDate>Tue, 27 Aug 2019 14:29:12 +0000</pubDate><guid>https://atbug.com/no-output-in-past-half-year/</guid><description>
&lt;p>ä¸Šä¸€ç¯‡æ—¥å¿—æ›´æ–°è¿˜æ˜¯åœ¨å»å¹´çš„12æœˆ, è‡³ä»Šæœ‰å·®ä¸å¤š10ä¸ªæœˆæ²¡æœ‰æ›´æ–°äº†.&lt;/p>
&lt;p>ä¸æ˜¯è¯´æ²¡æœ‰ä¸œè¥¿å¯å†™, è€Œä¸”æƒ³å†™çš„ä¸œè¥¿å¾ˆå¤š. å·¥ä½œå¤ªå¿™, ä¸å¿™çš„æ—¶å€™åˆå¤ªæ‡’, å½’æ ¹ç»“åº•è¿˜æ˜¯å¤ªæ‡’.&lt;/p>
&lt;p>è¿‡å»ä¸€å¹´å¤šéƒ½æ˜¯åœ¨åšåŸºç¡€æ¶æ„æ–¹é¢çš„å·¥ä½œ, å›´ç»•æŠ€æœ¯ä¸­å°å±•å¼€çš„. æœ‰å¾ˆå¤šæŠ€æœ¯éœ€è¦å»å­¦ä¹ , ä¹Ÿæœ‰å¾ˆå¤šé—®é¢˜è¦å¤„ç†. è¿‡ç¨‹ä¸­ä¸€ç›´æœ‰è®°ç¬”è®°çš„ä¹ æƒ¯, æ‰€ä»¥å¯ä»¥å†™çš„ä¸œè¥¿å¾ˆå¤š. ä¸è¿‡æœ‰äº›å±äºå…¬å¸çš„éƒ¨åˆ†è¿˜æ˜¯ä¸èƒ½å†™çš„, å¿…è¦çš„èŒä¸šé“å¾·è¿˜æ˜¯è¦æœ‰çš„.&lt;/p>
&lt;p>ç¬”è®°è®°å½•ä¸€ç›´åœ¨ç”¨&lt;a href="https://zh.mweb.im">MWeb&lt;/a>, å¹¶ä½¿ç”¨iCloudåŒæ­¥, æœ€è¿‘å‡ ä¸ªæœˆä¹Ÿåœ¨ç»“åˆ&lt;a href="https://mubu.com">å¹•å¸ƒ&lt;/a>æ•´ç†æ€è·¯å’Œå·¥ä½œå®‰æ’. å¥½ç”¨çš„è½¯ä»¶æˆ‘ä¹Ÿæ¯”è¾ƒå–œæ¬¢åˆ†äº«, è®°å¾—æœ€æ—©åœ¨Workpressä¸Šçš„åšå®¢å°±åˆ†äº«äº†å¾ˆå¤šè‡ªå·±å¸¸ç”¨çš„è½¯ä»¶. (æœ‰ç‚¹æ‰¯è¿œäº†~~~)&lt;/p>
&lt;p>MWebæ²¡æœ‰ç»Ÿè®¡åŠŸèƒ½, è¿˜æœ‰ä½¿ç”¨çš„æ˜¯sqlite. ç®€å•sqlæŸ¥è¯¢äº†ä¸‹, ä»å»å¹´è¿™ä»½å·¥ä½œå¼€å§‹æœ‰244ç¯‡ç¬”è®°. ä»Šå¹´åˆ°ç°åœ¨æœ‰109ç¯‡. å½“ç„¶æœ‰äº›ç¬”è®°çš„å†…å®¹æ¯”è¾ƒå°‘, ä¸å¾—ä¸è¯´è¿™ä¸€å¹´å¤šæ”¶è·ç”šå¤š.&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆä»Šå¤©åˆå†™äº†è¿™ä¹ˆä¸€ç¯‡, æºäºé˜®ä¸€å³°çš„&lt;a href="http://www.ruanyifeng.com/blog/2019/08/weekly-issue-69.html">ç§‘æŠ€çˆ±å¥½è€…å‘¨åˆŠï¼šç¬¬ 69 æœŸ&lt;/a>.&lt;/p>
&lt;p>åˆŠé¦–è¯­æ˜¯&amp;quot;ä¸€ä»¶äº‹&amp;quot;åšå¾—å¥½&amp;quot;æ¯”è¾ƒå¥½ï¼Œè¿˜æ˜¯&amp;quot;åšå¾—å¿«&amp;quot;æ¯”è¾ƒå¥½ï¼Ÿ&amp;quot;, ç›´æ¥copyä»–çš„ç»“è®º.&lt;/p>
&lt;blockquote>
&lt;p>æˆ‘å¾ˆèµåŒ&lt;a href="http://jsomers.net/blog/speed-matters">ä¸€ç¯‡æ–‡ç« &lt;/a>çš„ç»“è®ºï¼šåšå¾—å¿«æ›´å¥½ã€‚&lt;/p>
&lt;blockquote>
&lt;p>åšå¾—å¿«ä¸ä»…å¯ä»¥è®©ä½ åœ¨å•ä½æ—¶é—´å†…å®Œæˆæ›´å¤šçš„å·¥ä½œï¼Œè€Œä¸” &lt;strong>å› ä¸ºä½ å·¥ä½œå¾—å¾ˆå¿«ï¼Œæ‰€ä»¥ä½ ä¼šè§‰å¾—æˆæœ¬ä½ï¼Œä»è€Œå€¾å‘äºåšæ›´å¤šã€‚&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>å†™ä¸€ç¯‡åšå®¢ï¼Œä½ å¯èƒ½éœ€è¦ä¸¤å¤©ã€‚è¿™æ˜¯å¾ˆé«˜çš„æ—¶é—´æˆæœ¬ï¼Œä½ è§‰å¾—å¤ªè´µäº†ï¼Œäºæ˜¯ä½ å¾ˆå°‘å†™ã€‚ä½†æ˜¯ï¼Œ&lt;strong>åšå¥½ä¸€ä»¶äº‹çš„å”¯ä¸€æ–¹æ³•ï¼Œå°±æ˜¯å¤šåšè¿™ä»¶äº‹ã€‚&lt;/strong> åšå¾—è¶Šå¿«ï¼Œè¿™ä»¶äº‹çš„æ—¶é—´æˆæœ¬å°±è¶Šä½ï¼Œä½ ä¼šæ„¿æ„åšå¾—æ›´å¤šã€‚&lt;/p>
&lt;p>äººä»¬æ€»æ˜¯å€¾å‘äºï¼Œå¤šæ¶ˆè´¹æ—¶é—´æˆæœ¬ä½çš„ä¸œè¥¿ã€‚ç½‘ç«™å¾ˆå¿«ï¼Œå°±ä¼šå¤šè®¿é—®ï¼›æœç´¢å¾ˆå¿«ï¼Œå°±ä¼šå¤šæœç´¢ï¼›æ–‡ç« å¾ˆå®¹æ˜“è¯»æ‡‚ï¼Œå°±ä¼šå¤šè¯»å‡ ç¯‡ã€‚åšå¾—å¿«çš„æ ¸å¿ƒï¼Œå°±æ˜¯è¦è®©æ—¶é—´æˆæœ¬é™ä¸‹æ¥ï¼Œä»è€Œå¤šåšã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ä¹‹å‰å†™åšå®¢çš„æ—¶å€™, ç¡®å®æŠ•å…¥å¾ˆå¤š. ç¬”è®°è®°å½•çš„æ—¶å€™å¾ˆéšæ„, ä½†æ˜¯å‘åˆ°åšå®¢ä¸­åˆè¦èŠ±ä¸å°‘çš„æ—¶é—´æ¥æ•´ç†è¯­è¨€. æ€»æƒ³å†™çš„å¤§è€Œç¾, ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸ªåŸå› å¯¼è‡´å¤§åŠå¹´æ²¡æœ‰æ›´æ–°(å…¶å®ä¹Ÿè¿˜æ˜¯æ‡’), æ¯æ¬¡æƒ³å†™éƒ½å› ä¸ºè¦èŠ±æ—¶é—´è€ŒèŒç”Ÿé€€æ„.&lt;/p>
&lt;p>æ‰€ä»¥ä»Šåè¿˜æ˜¯å¤šå†™å†™, å°è€Œç¾.&lt;/p>
&lt;p>è™½ç„¶å¤§åŠå¹´æ²¡æ›´æ–°, è®¿é—®é‡å±…ç„¶è¿˜æœ‰æå‡.&lt;/p>
&lt;p>&lt;img src="https://i.loli.net/2019/08/27/XyNqw2HtTxFK6pP.jpg" alt="google analytics">&lt;/p></description></item><item><title>Spring Bootæºç åˆ†æ - Configurationæ³¨è§£</title><link>https://atbug.com/spring-boot-configuration-annotation/</link><pubDate>Mon, 10 Dec 2018 16:24:33 +0000</pubDate><guid>https://atbug.com/spring-boot-configuration-annotation/</guid><description>
&lt;h1 id="configurationæ³¨è§£">@Configurationæ³¨è§£&lt;/h1>
&lt;p>&lt;code>@Configuration&lt;/code>æ³¨è§£æŒ‡ç¤ºä¸€ä¸ªç±»å£°æ˜ä¸€ä¸ªæˆ–å¤šä¸ª@Beanæ–¹æ³•, å¹¶ä¸”å¯ä»¥ç”±Springå®¹å™¨å¤„ç†, ä»¥åœ¨è¿è¡Œæ—¶ä¸ºè¿™äº›beanç”Ÿæˆbeanå®šä¹‰å’ŒæœåŠ¡è¯·æ±‚.&lt;/p>
&lt;p>ä½¿ç”¨&lt;code>ConfigurationClassParser&lt;/code>æ¥å¯¹&lt;code>@Configuration&lt;/code>æ ‡æ³¨çš„ç±»è¿›è¡Œè§£æ, å°è£…æˆ&lt;code>ConfigurationClass&lt;/code>å®ä¾‹. å…·ä½“çš„å®ç°é€šè¿‡&lt;code>ConfigurationClassPostProcessor&lt;/code>æ¥å®ç°çš„.&lt;/p>
&lt;h2 id="configurationclasspostprocessor">ConfigurationClassPostProcessor&lt;/h2>
&lt;p>å®ç°äº†&lt;code>BeanDefinitionRegistryPostProcessor&lt;/code>æ¥å£, é—´æ¥å®ç°äº†&lt;code>BeanFactorPostProcessor&lt;/code>æ¥å£.&lt;/p>
&lt;ul>
&lt;li>&lt;code>#postProcessBeanDefinitionRegistry()&lt;/code>: æ³¨å†Œæ‰€æœ‰&lt;code>ConfigurationClass&lt;/code>ä¸­çš„&lt;code>BeanDefinition&lt;/code>, åŒ…æ‹¬&lt;code>@Bean&lt;/code>æ³¨è§£çš„æ–¹æ³•, &lt;code>@ImporResource&lt;/code>å¼•å…¥çš„èµ„æºä¸­å®šä¹‰çš„bean, å’Œ&lt;code>@Import&lt;/code>æ³¨è§£å¼•å…¥çš„&lt;code>ImportBeanDefinitionRegistrar&lt;/code>ä¸­æ³¨å†Œçš„&lt;code>BeanDefinition&lt;/code>&lt;/li>
&lt;li>&lt;code>#postProcessBeanFactory()&lt;/code>: åœ¨è¿è¡Œæ—¶ä»¥é€šè¿‡&lt;code>cglig&lt;/code>å¢å¼ºçš„ç±»æ¥æ›¿æ¢&lt;code>ConfigurationClass&lt;/code>, ä¸ºæœåŠ¡beanè¯·æ±‚åšå‡†å¤‡. å¢å¼ºçš„å®ç°æ˜¯é€šè¿‡&lt;code>ConfigurationClassEnhancer&lt;/code>å®Œæˆçš„.&lt;/li>
&lt;/ul>
&lt;p>æ’å…¥ä¸€ç‚¹, &lt;code>ConfigurationClassEnhancer&lt;/code>å®ç°äº†ç›´æ¥ä½¿ç”¨beanæ³¨å†Œæ–¹æ³•æ¥è·å–beançš„æ“ä½œ, æä¾›äº†ä¸€ä¸ª&lt;code>BeanMethodInterceptor&lt;/code>çš„å†…éƒ¨ç±»æ¥å®è¡Œ.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">
&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Config&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">A&lt;/span> &lt;span class="nf">a&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">B&lt;/span> &lt;span class="nf">b&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">b&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setA&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="full-configurationclass-vs-lite-configurationclass">Full ConfigurationClass VS Lite ConfigurationClass&lt;/h3>
&lt;p>å…ˆè¯´åŒºåˆ«: fullçš„&lt;code>ConfigurationClass&lt;/code>ä¼šä½¿ç”¨CGLIBè¿›è¡Œå¢å¼º.&lt;/p>
&lt;p>æŸ¥çœ‹ç±»&lt;code>ConfigurationClassUtils&lt;/code>, å…¶ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•&lt;code>#isFullConfigurationClass()&lt;/code>å’Œ&lt;code>#isLiteConfigurationClass()&lt;/code>.&lt;/p>
&lt;p>æ–¹æ³•çš„å®ç°æ˜¯å»æ£€æŸ¥&lt;code>BeanDefinition&lt;/code>ä¸­çš„&lt;code>ConfigurationClassPostProcessor.configurationClass&lt;/code>å±æ€§, æ˜¯&lt;code>full&lt;/code>è¿˜æ˜¯&lt;code>lite&lt;/code>.&lt;/p>
&lt;p>è¿™ä¸ªå±æ€§çš„å€¼åˆæ¥æºäº&lt;code>#checkConfigurationClassCandidate()&lt;/code>æ–¹æ³•, å¦‚æœ&lt;code>BeanDefinition&lt;/code>ä½¿ç”¨çš„æ˜¯&lt;code>@Configuration&lt;/code>æ³¨è§£, åˆ™ä¸º&lt;code>full&lt;/code>; å¦‚æœæ˜¯&lt;code>@Component&lt;/code>, &lt;code>@ComponentScan&lt;/code>, &lt;code>@Import&lt;/code>æˆ–è€…&lt;code>@ImportResource&lt;/code>ä¸­çš„ä»»ä½•ä¸€ç§, åˆ™ä¸º&lt;code>lite&lt;/code>. å¦‚æœæ˜¯&lt;code>ConfigurationClass&lt;/code>, åˆ™ä¼šç»§ç»­ä¸ºå…¶æ·»åŠ é¡ºåºå±æ€§.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">checkConfigurationClassCandidate&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">BeanDefinition&lt;/span> &lt;span class="n">beanDef&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">MetadataReaderFactory&lt;/span> &lt;span class="n">metadataReaderFactory&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">isFullConfigurationCandidate&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">metadata&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">beanDef&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setAttribute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">CONFIGURATION_CLASS_ATTRIBUTE&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">CONFIGURATION_CLASS_FULL&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">isLiteConfigurationCandidate&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">metadata&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">beanDef&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setAttribute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">CONFIGURATION_CLASS_ATTRIBUTE&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">CONFIGURATION_CLASS_LITE&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// It&amp;#39;s a full or lite configuration candidate... Let&amp;#39;s determine the order value, if any.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">orderAttributes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">metadata&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getAnnotationAttributes&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Order&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">orderAttributes&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">beanDef&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setAttribute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ORDER_ATTRIBUTE&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">orderAttributes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">AnnotationUtils&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">VALUE&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Nginxå®ç°Elasticsearchçš„HTTPåŸºæœ¬è®¤è¯</title><link>https://atbug.com/elasticsearch-http-basic-authentication-via-nginx/</link><pubDate>Tue, 06 Nov 2018 09:24:24 +0000</pubDate><guid>https://atbug.com/elasticsearch-http-basic-authentication-via-nginx/</guid><description>
&lt;p>Elasticssearchçš„HTTPåŸºæœ¬è®¤è¯å®ç°æœ‰ä¸¤ç§æ–¹æ¡ˆ: x-packå’Œnginxåå‘ä»£ç†. å‰è€…æ”¶è´¹, åè€…ä¸å¤ªé€‚åˆç”Ÿäº§ä½¿ç”¨. å¦‚æœä»…ä»…æ˜¯å¼€å‘æµ‹è¯•, ç¬¬äºŒç§å®Œå…¨è¶³å¤Ÿ.&lt;/p>
&lt;h3 id="åˆ›å»ºå¯†ç ">åˆ›å»ºå¯†ç &lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">htpasswd -bc ./passwd &lt;span class="o">[&lt;/span>username&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>password&lt;span class="o">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="docker-compose">Docker compose&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;3&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">elasticsearch&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">elasticsearch:5.5.2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">container_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">elasticsearch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">unless-stopped&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/tmp/elasticsearch:/usr/share/elasticsearch/data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">nginx&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">container_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">elasticsearch-proxy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">9200&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">9200&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">links&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">elasticsearch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">./passwd:/etc/nginx/.passwd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">./default.conf:/etc/nginx/conf.d/default.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="nginxé…ç½®æ–‡ä»¶">nginxé…ç½®æ–‡ä»¶&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">upstream es {
server elasticsearch:9200;
keepalive 15;
}
server {
listen 9200;
server_name localhost;
access_log /dev/stdout;
error_log /dev/stdout;
location / {
auth_basic &amp;#34;Administratorâ€™s Area&amp;#34;;
auth_basic_user_file /etc/nginx/.passwd;
proxy_http_version 1.1;
proxy_set_header Connection &amp;#34;Keep-Alive&amp;#34;;
proxy_set_header Proxy-Connection &amp;#34;Keep-Alive&amp;#34;;
proxy_pass http://es;
}
location /health {
access_log off;
return 200 &amp;#34;healthy\n&amp;#34;;
}
#error_page 404 /404.html;
# redirect server error pages to the static page /50x.html
#
error_page 500 502 503 504 /50x.html;
location = /50x.html {
root html;
}
# proxy the PHP scripts to Apache listening on 127.0.0.1:80
#
#location ~ \.php$ {
# proxy_pass http://127.0.0.1;
#}
# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
#
#location ~ \.php$ {
# root html;
# fastcgi_pass 127.0.0.1:9000;
# fastcgi_index index.php;
# fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;
# include fastcgi_params;
#}
# deny access to .htaccess files, if Apache&amp;#39;s document root
# concurs with nginx&amp;#39;s one
#
#location ~ /\.ht {
# deny all;
#}
}
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Alpineå®¹å™¨å®‰è£…Dockerå’ŒOpenShift Client Tools</title><link>https://atbug.com/install-docker-and-openshift-client-tools-in-alpine-container/</link><pubDate>Tue, 28 Aug 2018 09:14:12 +0000</pubDate><guid>https://atbug.com/install-docker-and-openshift-client-tools-in-alpine-container/</guid><description>
&lt;h2 id="å®‰è£…docker">å®‰è£…Docker&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;http://dl-2.alpinelinux.org/alpine/edge/main&amp;#34;&lt;/span> &amp;gt; /etc/apk/repositories
&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;http://dl-2.alpinelinux.org/alpine/edge/community&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/apk/repositories
&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;http://dl-2.alpinelinux.org/alpine/edge/testing&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/apk/repositories
apk -U --no-cache &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --allow-untrusted add &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> shadow &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> docker &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> py-pip &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> openrc &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> pip install docker-compose
rc-update add docker boot
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å®‰è£…openshift-client-tools">å®‰è£…OpenShift Client Tools&lt;/h2>
&lt;p>éœ€è¦å…ˆå®‰è£…glibc&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">apk --no-cache add ca-certificates wget
wget -q -O /etc/apk/keys/sgerrand.rsa.pub https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub
wget https://github.com/sgerrand/alpine-pkg-glibc/releases/download/2.28-r0/glibc-2.28-r0.apk
apk add glibc-2.28-r0.apk
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>curl --retry 7 -Lo /tmp/client-tools.tar.gz &amp;quot;https://mirror.openshift.com/pub/openshift-v3/clients/3.9.1/linux/oc.tar.gz&amp;quot;&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl --retry &lt;span class="m">7&lt;/span> -Lo /tmp/client-tools.tar.gz &lt;span class="s2">&amp;#34;https://mirror.openshift.com/pub/openshift-v3/clients/3.9.1/linux/oc.tar.gz&amp;#34;&lt;/span>
tar zxf /tmp/client-tools.tar.gz -C /usr/local/bin oc &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> rm /tmp/client-tools.tar.gz &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> apk del .build-deps
&lt;span class="c1"># ADDED: Resolve issue x509 oc login issue&lt;/span>
apk add --update ca-certificates
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‚è€ƒ: &lt;a href="https://github.com/openshift/origin/issues/11135">github issue&lt;/a>&lt;/p></description></item><item><title>Zuulç½‘å…³Ribboné‡è¯•</title><link>https://atbug.com/ribbon-retry-in-zuul/</link><pubDate>Thu, 02 Aug 2018 08:55:43 +0000</pubDate><guid>https://atbug.com/ribbon-retry-in-zuul/</guid><description>
&lt;h2 id="ç›¸å…³é…ç½®">ç›¸å…³é…ç½®&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">#å¦‚æœè·¯ç”±è½¬å‘è¯·æ±‚å‘ç”Ÿè¶…æ—¶(è¿æ¥è¶…æ—¶æˆ–å¤„ç†è¶…æ—¶), åªè¦è¶…æ—¶æ—¶é—´çš„è®¾ç½®å°äºHystrixçš„å‘½ä»¤è¶…æ—¶æ—¶é—´,é‚£ä¹ˆå®ƒå°±ä¼šè‡ªåŠ¨å‘èµ·é‡è¯•. é»˜è®¤ä¸ºfalse. æˆ–è€…å¯¹æŒ‡å®šå“åº”çŠ¶æ€ç è¿›è¡Œé‡è¯•
zuul.retryable = true
zuul.routes.&amp;lt;route&amp;gt;.retryable = false
#åŒä¸€å®ä¾‹ä¸Šçš„æœ€å¤§é‡è¯•æ¬¡æ•°, é»˜è®¤å€¼ä¸º0. ä¸åŒ…æ‹¬é¦–æ¬¡è°ƒç”¨
ribbon.MaxAutoRetries=0
#é‡è¯•å…¶ä»–å®ä¾‹çš„æœ€å¤§é‡è¯•æ¬¡æ•°, ä¸åŒ…æ‹¬ç¬¬ä¸€æ¬¡é€‰çš„å®ä¾‹. é»˜è®¤ä¸º1
ribbon.MaxAutoRetriesNextServer=1
#æ˜¯å¦æ‰€æœ‰æ“ä½œæ‰§è¡Œé‡è¯•, é»˜è®¤å€¼ä¸ºfalse, åªé‡è¯•`GET`è¯·æ±‚
ribbon.OkToRetryOnAllOperations=false
#è¿æ¥è¶…æ—¶, é»˜è®¤2000
ribbon.ConnectTimeout=15000
#å“åº”è¶…æ—¶, é»˜è®¤5000
ribbon.ReadTimeout=15000
#æ¯ä¸ªhostçš„æœ€å¤§è¿æ¥æ•°
ribbon.MaxHttpConnectionsPerHost=50
#æœ€å¤§è¿æ¥æ•°
ribbon.MaxTotalHttpConnections=200
#ä½•ç§å“åº”çŠ¶æ€ç æ‰è¿›è¡Œé‡è¯•
ribbon.retryableStatusCodes=404,502
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å®ç°">å®ç°&lt;/h2>
&lt;ol>
&lt;li>&lt;code>SimpleRouteLocator#getRoute&lt;/code>è¿”å›çš„&lt;code>route&lt;/code>å¯¹è±¡ä¸­ä¼šå¸¦ä¸Š&lt;code>retryable&lt;/code>çš„è®¾ç½®.&lt;/li>
&lt;li>&lt;code>PreDecorationFilter&lt;/code>åœ¨å¯¹&lt;code>RequestContext&lt;/code>è¿›è¡Œè£…é¥°çš„æ—¶å€™ä¼šå°†&lt;code>retryable&lt;/code>çš„è®¾ç½®é€šè¿‡key&lt;code>FilterConstants.RETRYABLE_KEY&lt;/code>æ³¨å…¥&lt;code>RequestContext&lt;/code>ä¸­.&lt;/li>
&lt;li>&lt;code>RibbonRoutingFilter#buildCommandContext&lt;/code>ä¼šä½¿ç”¨&lt;code>RequestContext&lt;/code>çš„&lt;code>retryable&lt;/code>è®¾ç½®æ„é€ &lt;code>RibbonCommandContext&lt;/code>å¯¹è±¡.&lt;/li>
&lt;li>&lt;code>RibbonCommandFactory&lt;/code>ä½¿ç”¨&lt;code>RibbonCommandContext&lt;/code>æ„å»ºå‡º&lt;code>RibbonCommand&lt;/code>å¯¹è±¡.&lt;/li>
&lt;li>&lt;code>RibbonCommand#run&lt;/code>ä¸­, å½“&lt;code>retryable&lt;/code>ä¸º&lt;code>true&lt;/code>æ—¶, ä¼šè°ƒç”¨&lt;code>IClient&lt;/code>çš„&lt;code>execute&lt;/code>æ–¹æ³•å¤„ç†è¯·æ±‚. ä¸º&lt;code>false&lt;/code>æ—¶, ä¼šè°ƒç”¨&lt;code>IClient&lt;/code>çš„&lt;code>executeWithLoadBalancer&lt;/code>æ–¹æ³•æ‰§è¡Œè¯·æ±‚.
&lt;ul>
&lt;li>&lt;code>execute&lt;/code>ä¼šåœ¨å¤±è´¥æ—¶è¿›è¡Œé‡è¯•(ä¸è¶…è¿‡è¶…æ—¶é™åˆ¶)&lt;/li>
&lt;li>&lt;code>executeWithLoadBalancer&lt;/code>æ–¹æ³•æ˜¯å…ˆé€šè¿‡&lt;code>LoadBalancer&lt;/code>é€‰æ‹©å‡ºä¸€ä¸ª&lt;code>Server&lt;/code>, ç„¶åæ„å»ºå‡ºè¯·æ±‚åœ°å€.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>IClient#execute&lt;/code>æ‰§è¡Œæ—¶, é€šè¿‡&lt;code>LoadBalancedRetryPolicyFactory&lt;/code>åˆ›å»ºä¸€ä¸ª&lt;code>LoadBalancedRetryPolicy&lt;/code>å¯¹è±¡. &lt;code>LoadBalancedRetryPolicy&lt;/code>æŒæœ‰ä¸Šé¢&lt;code>ribbon.XXX&lt;/code>çš„è®¾ç½®. å½“å“åº”çŠ¶æ€ç ä¸åœ¨&lt;code>ribbon.retryableStatusCodes&lt;/code>è®¾ç½®ä¸­, åˆ™ä¼šç›´æ¥è¿”å›å“åº”. å¦‚æœå±äºå¯é‡è¯•çš„å“åº”çŠ¶æ€ç , åˆ™ä¼šå°†å“åº”å°è£…ä¸º&lt;code>HttpClientStatusCodeException&lt;/code>æŠ›å‡º. å¼‚å¸¸è¢«&lt;code>RetryTemplate&lt;/code>æ•è·, ç„¶åä½¿ç”¨&lt;code>LoadBalancedRetryPolicy&lt;/code>å¯¹å½“å‰çŠ¶æ€(MaxAutoRetries, MaxAutoRetriesNextServer)è®¡ç®—å‡ºèƒ½å¦è¿›è¡Œä¸€æ¬¡é‡è¯•. ç›´è‡³æˆåŠŸ, æˆ–è€…å½“å‰çŠ¶æ€ä¸æ»¡è¶³æ¡ä»¶.&lt;/li>
&lt;/ol></description></item><item><title>Hystrixå·¥ä½œåŸç†ä¸‰</title><link>https://atbug.com/hystrix-exception-handling/</link><pubDate>Sun, 24 Jun 2018 16:20:16 +0000</pubDate><guid>https://atbug.com/hystrix-exception-handling/</guid><description>
&lt;h2 id="å¼‚å¸¸å¤„ç†">å¼‚å¸¸å¤„ç†&lt;/h2>
&lt;h3 id="hystrixå¼‚å¸¸ç±»å‹">Hystrixå¼‚å¸¸ç±»å‹&lt;/h3>
&lt;ul>
&lt;li>HystrixRuntimeException&lt;/li>
&lt;li>HystrixBadRequestException&lt;/li>
&lt;li>HystrixTimeoutException&lt;/li>
&lt;li>RejectedExecutionException&lt;/li>
&lt;/ul>
&lt;h4 id="hystrixruntimeexception">HystrixRuntimeException&lt;/h4>
&lt;p>&lt;code>HystrixCommand&lt;/code>å¤±è´¥æ—¶æŠ›å‡º, ä¸ä¼šè§¦å‘fallback.&lt;/p>
&lt;h4 id="hystrixbadrequestexception">HystrixBadRequestException&lt;/h4>
&lt;p>ç”¨æä¾›çš„å‚æ•°æˆ–çŠ¶æ€è¡¨ç¤ºé”™è¯¯çš„å¼‚å¸¸, è€Œä¸æ˜¯æ‰§è¡Œå¤±è´¥. ä¸å…¶ä»–&lt;code>HystrixCommand&lt;/code>æŠ›å‡ºçš„å¼‚å¸¸ä¸åŒ, è¿™ä¸ªå¼‚å¸¸ä¸ä¼šè§¦å‘&lt;code>fallback&lt;/code>, ä¹Ÿä¸ä¼šè®°å½•è¿›&lt;code>failure&lt;/code>çš„æŒ‡æ ‡, å› è€Œä¹Ÿä¸ä¼šè§¦å‘æ–­è·¯å™¨,&lt;/p>
&lt;p>åº”è¯¥åœ¨ç”¨æˆ·è¾“å…¥å¼•èµ·çš„é”™è¯¯æ˜¯æŠ›å‡º, å¦åˆ™ä¼šå®ƒä¸å®¹é”™å’Œåé€€è¡Œä¸ºçš„ç›®çš„ç›¸æ‚–.&lt;/p>
&lt;p>&lt;strong>ä¸ä¼šè§¦å‘fallback, ä¹Ÿä¸ä¼šè®°å½•åˆ°é”™è¯¯çš„æŒ‡æ ‡ä¸­, ä¹Ÿä¸ä¼šè§¦å‘æ–­è·¯å™¨&lt;/strong>.&lt;/p>
&lt;h4 id="rejectedexecutionexception">RejectedExecutionException&lt;/h4>
&lt;p>çº¿ç¨‹æ± å‘ç”Ÿ&lt;code>reject&lt;/code>æ—¶æŠ›å‡º&lt;/p>
&lt;h4 id="hystrixtimeoutexception">HystrixTimeoutException&lt;/h4>
&lt;p>åœ¨&lt;code>HystrixCommand.run()&lt;/code>æˆ–è€…&lt;code>HystrixObservableCommand.construct()&lt;/code>æ—¶æŠ›å‡º, ä¼šè®°å½•&lt;code>timeout&lt;/code>çš„æ¬¡æ•°. å¦‚æœå¸Œæœ›æŸäº›ç±»å‹çš„å¤±è´¥è¢«è®°å½•ä¸º&lt;code>timeout&lt;/code>, åº”è¯¥å°†è¿™äº›ç±»å‹çš„å¤±è´¥åŒ…è£…ä¸º&lt;code>HystrixTimeoutException&lt;/code>&lt;/p>
&lt;h3 id="å¼‚å¸¸å¤„ç†-1">å¼‚å¸¸å¤„ç†&lt;/h3>
&lt;p>&lt;code>ignoreExceptions&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">final&lt;/span> &lt;span class="n">Func1&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Observable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">handleFallback&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Func1&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Observable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Observable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">call&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Throwable&lt;/span> &lt;span class="n">t&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">circuitBreaker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">markNonSuccess&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getExceptionFromThrowable&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">executionResult&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">executionResult&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setExecutionException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">RejectedExecutionException&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">handleThreadPoolRejectionViaFallback&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">t&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">HystrixTimeoutException&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">handleTimeoutViaFallback&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">t&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">HystrixBadRequestException&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">handleBadRequestByEmittingError&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="cm">/*
&lt;/span>&lt;span class="cm"> * Treat HystrixBadRequestException from ExecutionHook like a plain HystrixBadRequestException.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">HystrixBadRequestException&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">eventNotifier&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">markEvent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">HystrixEventType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">BAD_REQUEST&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">commandKey&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Observable&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">handleFailureViaFallback&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">};&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="feignä¸­å“åº”çŠ¶æ€ç å¤„ç†">Feignä¸­å“åº”çŠ¶æ€ç å¤„ç†&lt;/h4>
&lt;p>Feignä½¿ç”¨&lt;code>SynchronousMethodHandler&lt;/code>åšè¯·æ±‚çš„æ‰§è¡Œå’Œå“åº”çš„å¤„ç†. å“åº”å¤„ç†çš„éƒ¨åˆ†, å¯¹&lt;code>[200, 300)&lt;/code>åŒºé—´çš„çŠ¶æ€, ä¼šå°†responseè¿”å›; å¦‚æœæ˜¯&lt;code>404&lt;/code>, æ ¹æ®&lt;code>@FeignClient&lt;/code>ä¸­&lt;code>decode404&lt;/code>(é»˜è®¤ä¸ºfalse)å’Œæ–¹æ³•è¿”å›å€¼åˆ¤æ–­æ˜¯å¦ç†”æ–­, å¦‚æœå“åº”è¿”å›&lt;code>404&lt;/code>, &lt;code>decode&lt;/code>ä¸º&lt;code>false&lt;/code>, åŒæ—¶æ–¹æ³•è¿”å›å€¼ä¸æ˜¯&lt;code>void&lt;/code>, ä¼šåŒ…è£…æˆ&lt;code>FeignException&lt;/code>æŠ›å‡º; å…¶ä»–çš„çŠ¶æ€, é€šè¿‡åŒ…è£…æˆ&lt;code>FeignException&lt;/code>æŠ›å‡º.&lt;/p>
&lt;p>&lt;code>FeignException&lt;/code>æ˜¯&lt;code>RuntimeException&lt;/code>çš„å®ç°, å¦‚æœæ²¡æœ‰ignoreçš„è¯, ä¼šè®¡å…¥ç†”æ–­å™¨çš„è®¡ç®—ä¸­.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">final&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">SynchronousMethodHandler&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">MethodHandler&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Object&lt;/span> &lt;span class="nf">executeAndDecode&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RequestTemplate&lt;/span> &lt;span class="n">template&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Throwable&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">status&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">200&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">status&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">300&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">metadata&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">returnType&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">decode&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">decode404&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">status&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">404&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="kt">void&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">metadata&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">returnType&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">decode&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="n">errorDecoder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">decode&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">metadata&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">configKey&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">response&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ribbonä¸­å“åº”çŠ¶æ€ç å¤„ç†">Ribbonä¸­å“åº”çŠ¶æ€ç å¤„ç†&lt;/h4>
&lt;p>åœ¨Zuulä¸­, è·¯ç”±ä½¿ç”¨&lt;code>Ribbon&lt;/code>åšè´Ÿè½½å‡è¡¡, åŒæ—¶ä½¿ç”¨&lt;code>Hystrix&lt;/code>åšæ–­è·¯å™¨, ä½¿ç”¨&lt;code>RibbonCommand&lt;/code>æ¥å£çš„å®ç°. &lt;code>RibbonCommand&lt;/code>çš„å®ç°&lt;strong>å¹¶æ²¡æœ‰å¯¹å“åº”ç¼–ç å°è£…å¼‚å¸¸, å› æ­¤ä¹Ÿä¸ä¼šè§¦å‘ç†”æ–­å™¨&lt;/strong>.&lt;/p>
&lt;p>&lt;code>AbstractRibbonCommand&lt;/code>æ˜¯&lt;code>RibbonCommand&lt;/code>çš„æŠ½è±¡å®ç°, æ‰€æœ‰å…¶ä»–å®ç°çš„çˆ¶ç±». æ ¸å¿ƒ&lt;code>run()&lt;/code>æ–¹æ³•å¹¶æ²¡æœ‰é’ˆå¯¹å“åº”ç¼–ç é‡æ–°å°è£…å¼‚å¸¸.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">abstract&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">AbstractRibbonCommand&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">LBC&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">AbstractLoadBalancerAwareClient&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">RQ&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">RS&lt;/span>&lt;span class="o">&amp;gt;,&lt;/span> &lt;span class="n">RQ&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">ClientRequest&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">RS&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">HttpResponse&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;span class="kd">extends&lt;/span> &lt;span class="n">HystrixCommand&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ClientHttpResponse&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">RibbonCommand&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">protected&lt;/span> &lt;span class="n">ClientHttpResponse&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="n">RequestContext&lt;/span> &lt;span class="n">context&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">RequestContext&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getCurrentContext&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">RQ&lt;/span> &lt;span class="n">request&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createRequest&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">RS&lt;/span> &lt;span class="n">response&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kt">boolean&lt;/span> &lt;span class="n">retryableClient&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">client&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">AbstractLoadBalancingClient&lt;/span>
&lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">((&lt;/span>&lt;span class="n">AbstractLoadBalancingClient&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">client&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">isClientRetryable&lt;/span>&lt;span class="o">((&lt;/span>&lt;span class="n">ContextAwareRequest&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">retryableClient&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">response&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">config&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">response&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">executeWithLoadBalancer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">config&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">context&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ribbonResponse&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">response&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// Explicitly close the HttpResponse if the Hystrix command timed out to
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// release the underlying HTTP connection held by the response.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isResponseTimedOut&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">response&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">RibbonHttpResponse&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Observable.error(ex)&lt;/code>ä¼šæ•è·&lt;code>run()&lt;/code>æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">abstract&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">HystrixCommand&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">AbstractCommand&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">HystrixExecutable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;,&lt;/span> &lt;span class="n">HystrixInvokableInfo&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;,&lt;/span> &lt;span class="n">HystrixObservable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="kd">protected&lt;/span> &lt;span class="n">Observable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">getExecutionObservable&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Observable&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">defer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Func0&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Observable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Observable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">call&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Observable&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">just&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">run&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Throwable&lt;/span> &lt;span class="n">ex&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Observable&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}).&lt;/span>&lt;span class="na">doOnSubscribe&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Action0&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">call&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// Save thread on which we get subscribed so that we can interrupt it later if needed
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">executionThread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">});&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="hystrix-è¶…æ—¶å¤„ç†">Hystrix è¶…æ—¶å¤„ç†&lt;/h2>
&lt;p>åœ¨Hystrixç‰ˆæœ¬1.4ä¹‹å‰, Seamphoreç­–ç•¥æ˜¯ä¸æ”¯æŒè¶…æ—¶çš„. ç›®å‰&lt;code>spring-cloud-netflix&lt;/code>çš„1.4.4ä¸­ä½¿ç”¨çš„æ˜¯1.5.12&lt;/p>
&lt;p>å¦‚æœå¼€å¯äº†timeout, HystrixCommandä¼š&lt;code>lift&lt;/code>ä¸€ä¸ª&lt;code>HystrixObservableTimeoutOperator&lt;/code>åˆ°&lt;code>Observable&lt;/code>ä¸­.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">abstract&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">AbstractCommand&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">HystrixInvokableInfo&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;,&lt;/span> &lt;span class="n">HystrixObservable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">Observable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">executeCommandAndObserve&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kd">final&lt;/span> &lt;span class="n">AbstractCommand&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">_cmd&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="n">Observable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">execution&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">properties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">executionTimeoutEnabled&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">execution&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">executeCommandWithSpecifiedIsolation&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">_cmd&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">lift&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">HystrixObservableTimeoutOperator&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;(&lt;/span>&lt;span class="n">_cmd&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">execution&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">executeCommandWithSpecifiedIsolation&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">_cmd&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">execution&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">doOnNext&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">markEmits&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">doOnCompleted&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">markOnCompleted&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">onErrorResumeNext&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">handleFallback&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">doOnEach&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">setRequestContext&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ª&lt;code>HystrixObservableTimeoutOperator&lt;/code>ä¼šæ·»åŠ æ³¨å†Œ&lt;code>TimeListener&lt;/code>. &lt;code>TimeListener&lt;/code>æ˜¯ä»¥&lt;code>tick&lt;/code>çš„æ–¹å¼è¿è¡Œ, å³å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»¶è¿Ÿ&lt;code>executionTimeoutInMilliseconds&lt;/code>è¿è¡Œ, ç„¶åæ¯æ¬¡åœ¨&lt;code>executionTimeoutInMilliseconds + n * executionTimeoutInMilliseconds&lt;/code>æ—¶è¿è¡Œ.&lt;/p>
&lt;p>å¦‚æœåˆ¤æ–­æ“ä½œè¶…æ—¶? çœ‹&lt;code>tick&lt;/code>æ–¹æ³•çš„å®ç°, çº¿ç¨‹æ¯æ¬¡è¿è¡Œæ—¶, å°è¯•ä¿®æ”¹Commandçš„çŠ¶æ€ä»&lt;code>NOT_EXECUTED&lt;/code>åˆ°&lt;code>TIMED_OUT&lt;/code>. å¦‚æœæˆåŠŸ, è¯´æ˜è¿è¡Œè¶…æ—¶. æœ€åæŠ›å‡º&lt;code>HystrixTimeoutException&lt;/code>å¼‚å¸¸, è¢«&lt;code>handleFallback&lt;/code>å¤„ç†.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="c1">// if we can go from NOT_EXECUTED to TIMED_OUT then we do the timeout codepath
&lt;/span>&lt;span class="c1">// otherwise it means we lost a race and the run() execution completed or did not start
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">originalCommand&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isCommandTimedOut&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">compareAndSet&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">TimedOutStatus&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">NOT_EXECUTED&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimedOutStatus&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">TIMED_OUT&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// report timeout failure
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">originalCommand&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">eventNotifier&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">markEvent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">HystrixEventType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">TIMEOUT&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">originalCommand&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">commandKey&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// shut down the original request
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unsubscribe&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="n">HystrixContextRunnable&lt;/span> &lt;span class="n">timeoutRunnable&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">HystrixContextRunnable&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">originalCommand&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">concurrencyStrategy&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">hystrixRequestContext&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Runnable&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">child&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">onError&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">HystrixTimeoutException&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">});&lt;/span>
&lt;span class="n">timeoutRunnable&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">run&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="c1">//if it did not start, then we need to mark a command start for concurrency metrics, and then issue the timeout
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Hystrixå·¥ä½œåŸç†äºŒ</title><link>https://atbug.com/hystrix-isolation/</link><pubDate>Sun, 24 Jun 2018 16:18:52 +0000</pubDate><guid>https://atbug.com/hystrix-isolation/</guid><description>
&lt;h2 id="éš”ç¦»ç­–ç•¥">éš”ç¦»ç­–ç•¥&lt;/h2>
&lt;h3 id="çº¿ç¨‹å’Œçº¿ç¨‹æ± ">çº¿ç¨‹å’Œçº¿ç¨‹æ± &lt;/h3>
&lt;p>å®¢æˆ·ç«¯(åº“, ç½‘ç»œè°ƒç”¨ç­‰)åœ¨å„è‡ªçš„çº¿ç¨‹ä¸Šè¿è¡Œ. è¿™ç§åšæ³•å°†ä»–ä»¬ä¸è°ƒç”¨çº¿ç¨‹éš”å¼€, å› æ­¤è°ƒç”¨è€…å¯ä»¥ä»ä¸€ä¸ªè€—æ—¶çš„ä¾èµ–è°ƒç”¨&amp;quot;ç¦»å¼€(walk away)&amp;quot;&lt;/p>
&lt;p>Hystrixä½¿ç”¨å•ç‹¬çš„, æ¯ä¸ªä¾èµ–çš„çº¿ç¨‹æ± ä½œä¸ºçº¦æŸä»»ä½•ç»™å®šä¾èµ–çš„ä¸€ç§æ–¹å¼, å› æ­¤æ½œåœ¨æ‰§è¡Œçš„å»¶è¿Ÿå°†ä»…åœ¨è¯¥æ± ä¸­ä½¿å¯ç”¨çº¿ç¨‹é¥±å’Œ.&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15280741661560.png" alt="">&lt;/p>
&lt;p>å¦‚æœä¸è¯•ç”¨çº¿ç¨‹æ± å¯ä»¥ä¿æŠ¤ä½ å…å—æ•…éšœçš„å½±å“, ä½†æ˜¯è¿™éœ€è¦å®¢æˆ·ç«¯å¯ä¿¡ä»»åœ°å¿«é€Ÿå¤±è´¥(ç½‘ç»œè¿æ¥/è¯»å–è¶…æ—¶, é‡è¯•çš„é…ç½®)å¹¶å§‹ç»ˆè¡¨ç°è‰¯å¥½.&lt;/p>
&lt;p>åœ¨Hystrixçš„è®¾è®¡ä¸­, Netflixé€‰æ‹©è¯•ç”¨çº¿ç¨‹å’Œçº¿ç¨‹æ± æ¥è¾¾åˆ°éš”ç¦»çš„ç›®çš„, åŸå› æœ‰:&lt;/p>
&lt;ul>
&lt;li>å¾ˆå¤šåº”ç”¨ç¨‹åºè°ƒç”¨äº†ç”±å¾ˆå¤šä¸åŒçš„å›¢é˜Ÿå¼€å‘çš„è®¸å¤š(æœ‰æ—¶è¶…è¿‡1000)ä¸åŒçš„åç«¯æœåŠ¡&lt;/li>
&lt;li>æ¯ä¸ªæœåŠ¡éƒ½å„è‡ªæä¾›äº†å…¶å®¢æˆ·ç«¯åº“&lt;/li>
&lt;li>å®¢æˆ·ç«¯åº“ä¸æ–­åœ°åœ¨æ›´æ–°&lt;/li>
&lt;li>å®¢æˆ·ç«¯åº“å¯èƒ½è¢«æ·»åŠ ä½¿ç”¨æ–°çš„ç½‘ç»œè°ƒç”¨&lt;/li>
&lt;li>å®¢æˆ·ç«¯åº“çš„é€»è¾‘ä¸­å¯èƒ½åŒ…å«é‡è¯•, æ•°æ®è§£æ, ç¼“å­˜(å†…å­˜æˆ–è€…è·¨ç½‘ç»œ)å’Œå…¶ä»–ç±»ä¼¼çš„è¡Œä¸º&lt;/li>
&lt;li>å®¢æˆ·ç«¯åº“æ›´ç±»ä¼¼äºä¸€ä¸ªé»‘ç›’, å…¶å®ç°ç»†èŠ‚, ç½‘ç»œè®¿é—®æ¨¡å¼, é»˜è®¤é…ç½®ç­‰æ˜¯å¯¹ä½¿ç”¨è€…ä¸é€æ˜çš„&lt;/li>
&lt;li>åœ¨å®é™…çš„ç”Ÿäº§é—®é¢˜ä¸­, æ ¹æºç»å¸¸æ˜¯ &amp;ldquo;æœ‰äº›ä¸œè¥¿æ”¹å˜äº†, é…ç½®åº”è¯¥è¢«ä¿®æ”¹&amp;rdquo; æˆ–è€… &amp;ldquo;å®¢æˆ·ç«¯åº“ä¿®æ”¹äº†é€»è¾‘&amp;rdquo;&lt;/li>
&lt;li>å³ä½¿å®¢æˆ·ç«¯æ²¡æœ‰æ”¹å˜, æœåŠ¡ç«¯è‡ªèº«å‘ç”Ÿäº†å˜ä¼šå‘˜. è¿™ç§å˜åŒ–ä¼šæ˜¯å®¢æˆ·ç«¯è®¾ç½®æ— æ•ˆè€Œå½±å“æ€§èƒ½ç‰¹æ€§&lt;/li>
&lt;li>ä¼ é€’ä¾èµ–ä¼šå¼•å…¥å…¶ä»–å®¢æˆ·ç«¯, è¿™äº›å®¢æˆ·ç«¯ä¸æ˜¯å¯é¢„æœŸçš„, ä¹Ÿå¯èƒ½æ²¡æœ‰è¢«æ­£ç¡®åœ°é…ç½®&lt;/li>
&lt;li>å¤§å¤šæ•°ç½‘ç»œè®¿é—®æ˜¯åŒæ­¥çš„&lt;/li>
&lt;li>å¤±è´¥å’Œå»¶è¿Ÿä¹Ÿå¯èƒ½å‘ç”Ÿåœ¨å®¢æˆ·ç«¯, ä¸åªæ˜¯ç½‘ç»œè°ƒç”¨&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15274259800386.png" alt="">&lt;/p>
&lt;h4 id="çº¿ç¨‹æ± çš„ä¼˜åŠ¿">çº¿ç¨‹æ± çš„ä¼˜åŠ¿&lt;/h4>
&lt;ul>
&lt;li>è¯¥åº”ç”¨ç¨‹åºå®Œå…¨å…å—å¤±æ§å®¢æˆ·ç«¯åº“çš„ä¿æŠ¤. ç»™å®šä¾èµ–åº“çš„çº¿ç¨‹æ± å¯ä»¥å¡«æ»¡è€Œä¸ä¼šå½±å“åº”ç”¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†.&lt;/li>
&lt;li>åº”ç”¨ç¨‹åºå¯ä»¥æ¥å—é£é™©ä½å¾—å¤šçš„æ–°å®¢æˆ·ç«¯åº“. å¦‚æœå‘ç”Ÿé—®é¢˜, å®ƒä¼šä¸å…¶ä»–ä¾èµ–åº“éš”ç¦», ä¸ä¼šå½±å“å…¶ä»–çš„ä¾èµ–åº“&lt;/li>
&lt;li>å½“å‘ç”Ÿæ•…éšœçš„å®¢æˆ·ç«¯å†æ¬¡å¥åº·æ—¶, çº¿ç¨‹æ± å°†è¿›è¡Œæ¸…ç†, åº”ç”¨ç¨‹åºä¼šç«‹å³æ¢å¤å¥åº·çš„æ€§èƒ½, è€Œä¸æ˜¯æ•´ä¸ªTomcatå®¹å™¨ä¸å ªé‡è´Ÿçš„é•¿æ—¶é—´æ¢å¤.&lt;/li>
&lt;li>å¦‚æœå®¢æˆ·ç«¯åº“é…ç½®é”™è¯¯, çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶å†µå°†å¾ˆå¿«è¯æ˜è¿™ä¸€ç‚¹(é€šè¿‡å¢åŠ é”™è¯¯, å»¶è¿Ÿ, è¶…æ—¶, æ‹’ç»ç­‰), å¹¶ä¸”ä½ å¯ä»¥åœ¨ä¸å½±å“åº”ç”¨ç¨‹åºåŠŸèƒ½çš„æƒ…å†µä¸‹å¤„ç†å®ƒ(é€šå¸¸é€šè¿‡åŠ¨æ€å±æ€§è¿›è¡Œå®æ—¶ä¿®æ”¹).&lt;/li>
&lt;li>å¦‚æœå®¢æˆ·ç«¯æœåŠ¡æ”¹å˜äº†æ€§èƒ½ç‰¹å¾(ç»å¸¸å‘ç”Ÿä¼šä»¥æˆä¸ºä¸€ä¸ªé—®é¢˜), ä»è€Œå¯¼è‡´éœ€è¦è°ƒæ•´å±æ€§(å¢åŠ /å‡å°‘è¶…æ—¶, æ›´æ”¹é‡è¯•ç­‰), è¿™é€šè¿‡çº¿ç¨‹æ± æŒ‡æ ‡(é”™è¯¯, å»¶è¿Ÿ, è¶…æ—¶, æ‹’ç»), å¹¶ä¸”å¯ä»¥åœ¨ä¸å½±å“å…¶ä»–å®¢æˆ·ç«¯, è¯·æ±‚æˆ–ç”¨æˆ·çš„æƒ…å†µä¸‹è¿›è¡Œå¤„ç†.&lt;/li>
&lt;li>é™¤äº†éš”ç¦»ä¼˜åŠ¿å¤–, æ‹¥æœ‰ä¸“ç”¨çº¿ç¨‹æ± è¿˜æä¾›äº†å†…ç½®å¹¶å‘æ€§, å¯ç”¨äºåœ¨åŒæ­¥å®¢æˆ·ç«¯åº“ä¹‹ä¸Šæ„å»ºå¼‚æ­¥ç‰¹æ€§(ç±»ä¼¼äºNetflix APIåœ¨Hystrixå‘½ä»¤ä¹‹ä¸Šæ„å»ºååº”å¼, å®Œå…¨å¼‚æ­¥çš„Java API).&lt;/li>
&lt;/ul>
&lt;p>ç®€è€Œè¨€ä¹‹, ç”±çº¿ç¨‹æ± æä¾›çš„éš”ç¦»åŠŸèƒ½å¯ä»¥ä½¿å®¢æˆ·ç«¯åº“å’Œå­ç³»ç»Ÿæ€§èƒ½ç‰¹æ€§çš„ä¸æ–­å˜åŒ–å’ŒåŠ¨æ€ç»„åˆå¾—åˆ°é€‚åº¦å¤„ç†, è€Œä¸ä¼šé€ æˆä¸­æ–­.&lt;/p>
&lt;p>&lt;strong>æ³¨æ„&lt;/strong>: å°½ç®¡å•ç‹¬çš„çº¿ç¨‹æä¾›äº†éš”ç¦», ä½†ä½ çš„åº•å±‚å®¢æˆ·ç«¯ä»£ç ä¹Ÿåº”è¯¥æœ‰è¶…æ—¶ å’Œ/æˆ– å“åº”çº¿ç¨‹ä¸­æ–­, ä»¥ä¾¿å®ƒä¸ä¼šæ— é™åˆ¶åœ°é˜»å¡å¹¶ä½¿Hystrixçº¿ç¨‹æ± é¥±å’Œ.&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15274259098702.png" alt="">&lt;/p>
&lt;p>&lt;strong>çº¿ç¨‹æ± çš„ç¼ºç‚¹&lt;/strong>&lt;/p>
&lt;p>çº¿ç¨‹æ± çš„ä¸»è¦ç¼ºç‚¹æ˜¯å¢åŠ äº†è®¡ç®—å¼€é”€, æ¯ä¸ªCommandçš„æ‰§è¡Œè®¾è®¡åˆ°é˜Ÿåˆ—, è°ƒåº¦å’ŒCommandå•ç‹¬è¿è¡Œçš„çº¿ç¨‹çš„ä¸Šä¸‹æ–‡çš„åˆ‡æ¢.&lt;/p>
&lt;p>åœ¨è®¾è®¡è¿™ä¸ªç³»ç»Ÿæ—¶, Netflixå†³å®šæ¥å—è¿™ç§å¼€é”€, ä»¥æ¢å–å…¶æä¾›çš„å¥½å¤„, å¹¶è®¤ä¸ºå®ƒè¶³å¤Ÿå°, ä¸ä¼šå¯¹æˆæœ¬æˆ–æ€§èƒ½äº§ç”Ÿé‡å¤§å½±å“,.&lt;/p>
&lt;p>&lt;strong>çº¿ç¨‹æˆæœ¬&lt;/strong>&lt;/p>
&lt;p>Hystrixåœ¨å­çº¿ç¨‹ä¸Šæ‰§è¡Œconstruct()æˆ–run()æ–¹æ³•æ—¶æµ‹é‡å»¶è¿Ÿ, ä»¥åŠçˆ¶çº¿ç¨‹ä¸Šçš„æ€»ç«¯åˆ°ç«¯æ—¶é—´. é€šè¿‡è¿™ç§æ–¹å¼, ä½ å¯ä»¥çœ‹åˆ°Hystrixå¼€é”€çš„æˆæœ¬(çº¿ç¨‹, æŒ‡æ ‡, æ—¥å¿—è®°å½•, æ–­è·¯å™¨ç­‰).&lt;/p>
&lt;p>Netflix APIæ¯å¤©ä½¿ç”¨çº¿ç¨‹éš”ç¦»å¤„ç†10äº¿å¤šHystrix Commandæ‰§è¡Œ. æ¯ä¸ªAPIå®ä¾‹éƒ½æœ‰40å¤šä¸ªçº¿ç¨‹æ± , æ¯ä¸ªçº¿ç¨‹æ± ä¸­æœ‰5-20ä¸ªçº¿ç¨‹(å¤§å¤šæ•°è®¾ç½®ä¸º10).&lt;/p>
&lt;h3 id="ä¿¡å·é‡">ä¿¡å·é‡&lt;/h3>
&lt;p>ä½ å¯ä»¥ä½¿ç”¨ä¿¡å·é‡(æˆ–è®¡æ•°å™¨)æ¥é™åˆ¶å¯¹ä»»ä½•ç»™å®šä¾èµ–é¡¹çš„å¹¶å‘è°ƒç”¨æ•°é‡, è€Œä¸æ˜¯ä½¿ç”¨çº¿ç¨‹æ± /é˜Ÿåˆ—å¤§å°. è¿™å…è®¸Hystrixåœ¨ä¸ä½¿ç”¨çº¿ç¨‹æ± çš„æƒ…å†µä¸‹å¸è½½è´Ÿè½½. å¦‚æœä½ ä¿¡ä»»ä¸‹å®¢æˆ·ç«¯, è€Œä½ åªæƒ³è¦å¸è½½, ä½ å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•.&lt;/p>
&lt;p>&lt;code>HystrixCommand&lt;/code>å’Œ&lt;code>HystrixObservableCommand&lt;/code>æ”¯æŒ2ä¸ªåœ°æ–¹çš„ä¿¡å·é‡:&lt;/p>
&lt;p>&lt;strong>å›é€€:&lt;/strong> å½“Hystrixæ‰§è¡Œå›é€€æ—¶, å®ƒæ€»æ˜¯åœ¨è°ƒç”¨Tomcatçº¿ç¨‹ä¸Šæ‰§è¡Œå›é€€
&lt;strong>æ‰§è¡Œ:&lt;/strong> å¦‚æœå°†å±æ€§&lt;code>execution.isolation.strategy&lt;/code>è®¾ç½®ä¸º&lt;code>SEMAPHORE&lt;/code>, åˆ™Hystrixå°†ä½¿ç”¨ä¿¡å·è€Œä¸æ˜¯çº¿ç¨‹æ¥é™åˆ¶è°ƒç”¨è¯¥å‘½ä»¤çš„å¹¶å‘çˆ¶çº¿ç¨‹çš„æ•°é‡.&lt;/p>
&lt;p>ä½ å¯ä»¥é€šè¿‡åŠ¨æ€å±æ€§æ¥é…ç½®è¿™ä¸¤ç§ä¿¡å·é‡çš„ä½¿ç”¨, è¿™äº›åŠ¨æ€å±æ€§å®šä¹‰äº†å¯ä»¥æ‰§è¡Œå¤šå°‘ä¸ªå¹¶å‘çº¿ç¨‹. åœ¨è°ƒæ•´çº¿ç¨‹æ± å¤§å°æ—¶, ä½ åº”è¯¥ä½¿ç”¨ç±»ä¼¼çš„è®¡ç®—æ¥è°ƒæ•´å®ƒä»¬çš„å¤§å°(å†…å­˜è°ƒç”¨è¿”å›çš„æ¬¡æ¯«ç§’æ—¶é—´å¯ä»¥åœ¨ä¿¡å·é‡ä»…ä¸º1æˆ–2çš„æƒ…å†µä¸‹æ‰§è¡Œè¶…è¿‡5000rps, ä½†é»˜è®¤å€¼ä¸º10).&lt;/p>
&lt;p>ä¸€æ—¦è¾¾åˆ°é™åˆ¶, ä¿¡å·é‡æ‹’ç»å°†å¼€å§‹, ä½†å¡«å……ä¿¡å·é‡çš„çº¿ç¨‹ä¸èƒ½ç¦»å¼€.&lt;/p>
&lt;p>ç¿»è¯‘è‡ª&lt;a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works">How it Works&lt;/a>&lt;/p></description></item><item><title>Hystrixå·¥ä½œåŸç†ä¸€</title><link>https://atbug.com/how-hystrix-works/</link><pubDate>Mon, 04 Jun 2018 08:47:40 +0000</pubDate><guid>https://atbug.com/how-hystrix-works/</guid><description>
&lt;h2 id="è¿è¡Œæ—¶çš„æµç¨‹å›¾">è¿è¡Œæ—¶çš„æµç¨‹å›¾&lt;/h2>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15273755001891.png" alt="å›¾ç‰‡æ¥è‡ªnetflix hystrix">&lt;/p>
&lt;ol>
&lt;li>
&lt;p>æ„å»º&lt;code>HystrixCommand&lt;/code>æˆ–è€…&lt;code>HystrixObservableCommand&lt;/code>å¯¹è±¡&lt;/p>
&lt;p>ç¬¬ä¸€æ­¥æ˜¯æ„å»ºä¸€ä¸ªHystrixCommandæˆ–HystrixObservableCommandå¯¹è±¡æ¥ä»£è¡¨å¯¹ä¾èµ–æœåŠ¡æ‰€åšçš„è¯·æ±‚ã€‚ å°†åœ¨è¯·æ±‚å‘ç”Ÿæ—¶å°†éœ€è¦çš„ä»»ä½•å‚æ•°ä¼ é€’ç»™æ„é€ å‡½æ•°ã€‚&lt;/p>
&lt;p>å¦‚æœä¾èµ–çš„æœåŠ¡é¢„æœŸä¼šè¿”å›å•ä¸€çš„å“åº”, æ„é€ ä¸€ä¸ª&lt;code>HystrixCommand&lt;/code>å¯¹è±¡, ä¾‹å¦‚:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">HystrixCommand&lt;/span> &lt;span class="n">command&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">HystrixCommand&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">arg1&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">arg2&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœä¾èµ–çš„æœåŠ¡é¢„æœŸä¼šè¿”å›ä¸€ä¸ªå‘å‡ºå“åº”çš„Observableå¯¹è±¡, åˆ™æ„é€ ä¸€ä¸ª&lt;code>HystrixObservableCommand&lt;/code>å¯¹è±¡, ä¾‹å¦‚:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">HystrixObservableCommand&lt;/span> &lt;span class="n">command&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">HystrixObservableCommand&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">arg1&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">arg2&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>æ‰§è¡ŒCommand&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å“åº”æ˜¯å¦è¢«ç¼“å­˜?&lt;/p>
&lt;p>å¦‚æœCommandçš„ç¼“å­˜è¯·æ±‚è¢«å¼€å¯, åŒæ—¶è¯·æ±‚çš„å“åº”åœ¨ç¼“å­˜ä¸­å¯ç”¨, ç¼“å­˜çš„å“åº”è¢«ç«‹å³ä»¥ä¸€ä¸ª&lt;code>Observable&lt;/code>çš„æ–¹å¼è¿”å›.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ–­è·¯å™¨æ˜¯å¦å¼€å¯?&lt;/p>
&lt;p>æ‰§è¡ŒCommandæ—¶, Hystrixä¼šæ£€æŸ¥æ–­è·¯å™¨(circuti-breaker)æ˜¯å¦å¼€å§‹å›è·¯(circuit).&lt;/p>
&lt;p>å¦‚æœå›è·¯å¼€å¯, Hystrixå°†ä¸ä¼šæ‰§è¡ŒCommand, è€Œç›´æ¥å»åˆ°æµç¨‹&lt;strong>8&lt;/strong>: Get the Fallback
å¦‚æœå…³é—­, åˆ™æ‰§è¡Œæµç¨‹&lt;strong>5&lt;/strong>æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å®¹é‡æ¥è¿è¡Œè¯¥å‘½ä»¤&lt;/p>
&lt;/li>
&lt;li>
&lt;p>çº¿ç¨‹æ± /é˜Ÿåˆ—/é™å·é‡æ˜¯å¦æ»¡?&lt;/p>
&lt;p>å‡å¦‚ä¸Commandç›¸å…³çš„çº¿ç¨‹æ± å’Œé˜Ÿåˆ—(æˆ–è€…ä¿¡å·é‡, ä¸é€‚ç”¨éš”ç¦»çº¿ç¨‹çš„è¯)æ»¡äº†, Hystrixå°†ä¸ä¼šæ‰§è¡ŒCommand, è€Œæ˜¯ç›´æ¥å»åˆ°æµç¨‹&lt;strong>8&lt;/strong>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>HystrixObservableCommand.construct()&lt;/code>æˆ–&lt;code>HystrixCommand.run()&lt;/code>&lt;/p>
&lt;p>Hystrixä½¿ç”¨ä¸‹é¢ä»»ä¸€çš„æ–¹å¼å‘ä¾èµ–çš„æœåŠ¡å‘å‡ºè¯·æ±‚:&lt;/p>
&lt;ul>
&lt;li>&lt;code>HystrixCommand.run()&lt;/code> è¿”å›å•ä¸ªå“åº”æˆ–æŠ›å‡ºå¼‚å¸¸&lt;/li>
&lt;li>&lt;code>HystrixObservableCommand.construct()&lt;/code> è¿”å›ä¸€ä¸ªå‘å‡ºå“åº”çš„Observableå¯¹è±¡, æˆ–è€…å‘é€&lt;code>onError&lt;/code>é€šçŸ¥&lt;/li>
&lt;/ul>
&lt;p>å¦‚æœ&lt;code>run()&lt;/code>æˆ–è€…&lt;code>construct()&lt;/code>æ–¹æ³•æ‰§è¡Œè¶…è¿‡Commandçš„è¶…æ—¶è®¾ç½®, çº¿ç¨‹ä¼šæŠ›å‡ºä¸€ä¸ª&lt;code>TimeoutException&lt;/code>(æˆ–è€…ç‹¬ç«‹çš„timerçº¿ç¨‹æŠ›å‡º, å¦‚æœCommandä¸æ˜¯è¿è¡Œåœ¨å®ƒè‡ªå·±çš„çº¿ç¨‹ä¸Š). è¿™æ˜¯Hystrixç›´æ¥å»åˆ°æµç¨‹&lt;strong>8&lt;/strong>. è·å–&lt;code>Fallback&lt;/code>, å¦‚æœæ²¡æœ‰cancel/interrup, åˆ™æŠ›å¼ƒ&lt;code>run()&lt;/code>æˆ–&lt;code>construct()&lt;/code>çš„æœ€ç»ˆè¿”å›å€¼.&lt;/p>
&lt;p>è¯·æ³¨æ„, æ²¡æœ‰ä»»ä½•æ–¹æ³•å¯ä»¥å¼ºåˆ¶ä»»åŠ¡çº¿ç¨‹åœæ­¢å·¥ä½œ, æœ€ä½³çš„æ–¹å¼æ˜¯HystrixæŠ›å‡ºä¸€ä¸ª&lt;code>InterruptException&lt;/code>. å¦‚æœHystrixå°è£…çš„ä»»åŠ¡å¿½ç•¥&lt;code>InterruptException&lt;/code>, è¯¥ä»»åŠ¡çº¿ç¨‹ä¼šç»§ç»­å·¥ä½œ, å³ä½¿å®¢æˆ·ç«¯å·²ç»æ”¶åˆ°äº†ä¸€ä¸ª&lt;code>TimeoutException&lt;/code>. è¿™ç§è¡Œä¸ºä¼šæ˜¯Hystrixçš„çº¿ç¨‹æ± é¥±å’Œ, å°½ç®¡è´Ÿè½½&lt;code>æ­£ç¡®åœ°æµå‡º(correctly shed)&lt;/code>. å¤§å¤šæ•°Java HTTPå®¢æˆ·ç«¯åº“ä¸è§£é‡ŠInterruptedExceptions. å› æ­¤, è¯·ç¡®ä¿åœ¨HTTPå®¢æˆ·ç«¯ä¸Šæ­£ç¡®é…ç½®è¿æ¥å’Œè¯»/å†™è¶…æ—¶.&lt;/p>
&lt;p>å¦‚æœCommandæ‰§è¡Œæ²¡æœ‰è¶…æ—¶è€Œè¿”å›ä¸€ä¸ªå“åº”, Hystrixåœ¨æ‰§è¡ŒæŸäº›æ—¥å¿—è®°å½•å’ŒæŒ‡æ ‡æŠ¥å‘Šä¹‹åè¿”å›è¿™ä¸ªå“åº”.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è®¡ç®—ç”µè·¯å¥åº·&lt;/p>
&lt;p>Hystrixå°†æˆåŠŸ, å¤±è´¥, æ‹’ç»æœåŠ¡å’Œè¶…æ—¶ä¸ŠæŠ¥ç»™æ–­è·¯å™¨, æ–­è·¯å™¨ç»´æŠ¤ç€ä¸€ä¸ªè®¡ç®—ç»Ÿè®¡æ•°æ®çš„è®¡æ•°å™¨.&lt;/p>
&lt;p>å®ƒé€šè¿‡è¿™äº›ç»Ÿè®¡æ•°æ®å†³å®šæ–­è·¯å™¨ä½•æ—¶åº”è¯¥æ‰“å¼€, åœ¨å“ªä¸ªç‚¹å¼€å§‹çŸ­è·¯åç»­çš„è¯·æ±‚çŸ¥é“æ¢å¤æœŸè¿‡å», æˆ–è€…å†³å®šåœ¨ç¬¬ä¸€æ¬¡å¥åº·æ£€æŸ¥è¯·æ±‚ç»“æŸåæ˜¯å¦è¦å…³é—­æ–­è·¯å™¨.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è·å–&lt;code>Fallback&lt;/code>&lt;/p>
&lt;p>åœ¨commandæ‰§è¡Œå¤±è´¥å: å½“&lt;code>run()&lt;/code>æˆ–&lt;code>construct()&lt;/code>æŠ›å‡ºå¼‚å¸¸(6), commandå› ä¸ºæ–­è·¯å™¨å¼€å¯è€ŒçŸ­è·¯(4), commandçš„çº¿ç¨‹æ± å’Œé˜Ÿåˆ—æˆ–è€…è®¡æ•°å™¨å¤„äºæ»¡è´Ÿè·(6), æˆ–è€…æ‰§è¡Œè¶…æ—¶, Hystrixå°è¯•è½¬å‘ä½ çš„&lt;code>Fallback&lt;/code>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è¿”å›æˆåŠŸçš„å“åº”&lt;/p>
&lt;p>å¦‚æœCommandå¤„ç†æˆåŠŸ, å®ƒå°†ä»¥&lt;code>Obervable&lt;/code>çš„å®è¡Œè¿”å›responseæˆ–è€…responsesç»™è°ƒç”¨è€…. å–å†³äºä¸Šé¢æµç¨‹2ä¸­çš„Commandçš„æ‰§è¡Œæ–¹å¼, è¯¥&lt;code>Observable&lt;/code>å¯èƒ½åœ¨è¿”å›ç»™ä½ ä¹‹å‰è¢«è½¬æ¢:&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15279954901603.png" alt="">&lt;/p>
&lt;ul>
&lt;li>execute() - è¿”å›ä¸€ä¸ª&lt;code>Fature&lt;/code>å¯¹è±¡, å¯ä»¥é€šè¿‡è°ƒç”¨&lt;code>get()&lt;/code>è·å–&lt;code>Obervable&lt;/code>è¿”å›çš„å•ä¸ªå€¼&lt;/li>
&lt;li>queue() - æŠŠ&lt;code>Observable&lt;/code>è½¬æ¢ä¸º&lt;code>BlockingObservable&lt;/code>, å› æ­¤&lt;code>BlockingObservable&lt;/code>å¯ä»¥è¢«è½¬æ¢æˆ&lt;code>Future&lt;/code>, å¹¶è¿”å›&lt;/li>
&lt;li>observe() - ç†è§£è®¢é˜…&lt;code>Observable&lt;/code>, å¹¶å¼€å§‹Commandçš„æ‰§è¡Œæµç¨‹. è¿”å›ä¸€ä¸ª&lt;code>Observable&lt;/code>, å½“è®¢é˜…å®ƒæ—¶, é‡æ’­è¿”å›å’Œé€šçŸ¥(replay emissions and notifiactions).&lt;/li>
&lt;li>toObservable() - ä¸å˜åœ°è¿”å›Observable; å¿…é¡»è®¢é˜…å®ƒæ‰èƒ½çœŸæ­£å¼€å§‹å¯¼è‡´æ‰§è¡Œå‘½ä»¤çš„æµç¨‹.&lt;/li>
&lt;/ul>
&lt;p>æ›´è¯¦ç»†çš„æµç¨‹å›¾&lt;a href="https://design.codelytics.io/hystrix/how-it-works">&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="æ–­è·¯å™¨">æ–­è·¯å™¨&lt;/h2>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15279966397767.png" alt="">&lt;/p>
&lt;ol>
&lt;li>å‡è®¾é€šè¿‡æ–­è·¯å™¨çš„è´Ÿè½½è¾¾åˆ°äº†é˜ˆå€¼ (HystrixCommandProperties.circuitBreakerRequestVolumeThreshold())&lt;/li>
&lt;li>å‡è®¾é”™è¯¯ç™¾åˆ†æ¯”è¶…è¿‡é”™è¯¯çš„é˜ˆå€¼ (HystrixCommandProperties.circuitBreakerErrorThresholdPercentage())&lt;/li>
&lt;li>æ–­è·¯å™¨çŠ¶æ€ä»å…³é—­å˜ä¸ºæ‰“å¼€&lt;/li>
&lt;li>æ‰“å¼€å, æ–­è·¯å™¨ä¼šçŸ­è·¯æ‰€æœ‰é’ˆå¯¹è¯¥æ–­è·¯å™¨çš„è¯·æ±‚&lt;/li>
&lt;li>è¿‡äº†ä¸€æ®µæ—¶é—´å(HystrixCommandProperties.circuitBreakerSleepWindowInMilliseconds()), ä¸‹ä¸€æ¡è¯·æ±‚ä¼šè¢«æ”¾è¡Œ(åŠå¼€çŠ¶æ€). å¦‚æœè¯·æ±‚å¤±è´¥, æ–­è·¯å™¨é‡å›æ‰“å¼€çŠ¶æ€(OPEN)å¹¶æŒç»­ä¸€ä¸ªç¡çœ çª—å£(sleep window). å¦‚æœæˆåŠŸ, çŠ¶æ€å˜ä¸ºå…³é—­(CLOSED). ä¸‹ä¸ªè¯·æ±‚ä»é€»è¾‘1å¼€å§‹.&lt;/li>
&lt;/ol>
&lt;p>ç¿»è¯‘è‡ª&lt;a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works">Hystrix Wiki - How it works&lt;/a>&lt;/p></description></item><item><title>è§£å†³rsyslogdèµ„æºå ç”¨ç‡é«˜é—®é¢˜</title><link>https://atbug.com/rsyslogd-high-cpu-trouble-shooting/</link><pubDate>Fri, 01 Jun 2018 09:32:28 +0000</pubDate><guid>https://atbug.com/rsyslogd-high-cpu-trouble-shooting/</guid><description>
&lt;h1 id="rsyslogdèµ„æºå ç”¨é«˜é—®é¢˜è®°å½•">rsyslogdèµ„æºå ç”¨é«˜é—®é¢˜è®°å½•&lt;/h1>
&lt;p>é—®é¢˜:
&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15277280296373.jpg" alt="">&lt;/p>
&lt;p>openshifté›†ç¾¤å®‰è£…åœ¨&lt;code>esxi&lt;/code>çš„è™šæ‹Ÿæœºä¸Š. å„ä¸ªèŠ‚ç‚¹å‡ºç°é—®é¢˜, é›†ç¾¤å“åº”å¾ˆæ…¢.&lt;/p>
&lt;ul>
&lt;li>&lt;code>kswapd0&lt;/code>è¿›ç¨‹cpu 90%å¤š.&lt;/li>
&lt;li>&lt;code>rsyslogd&lt;/code>è¿›ç¨‹å†…å­˜ 90%å¤š.&lt;/li>
&lt;/ul>
&lt;p>**å…ˆä¸Šæ€»ç»“: **&lt;/p>
&lt;p>&lt;code>system-journal&lt;/code>æœåŠ¡ç›‘å¬&lt;code>/dev/log&lt;/code>socketè·å–æ—¥å¿—, ä¿å­˜åœ¨å†…å­˜ä¸­, å¹¶é—´æ­‡æ€§çš„å†™å…¥&lt;code>/var/log/journal&lt;/code>ç›®å½•ä¸­.&lt;/p>
&lt;p>&lt;code>rsyslog&lt;/code>æœåŠ¡å¯åŠ¨åç›‘å¬&lt;code>/run/systemd/journal/syslog&lt;/code>socketè·å–&lt;code>syslog&lt;/code>ç±»å‹æ—¥å¿—, å¹¶å†™å…¥&lt;code>/var/log/messages&lt;/code>æ–‡ä»¶ä¸­. è·å–æ—¥å¿—æ—¶éœ€è¦è®°å½•æ—¥å¿—æ¡ç›®çš„&lt;code>position&lt;/code>åˆ°&lt;code>/var/lib/rsyslog/imjournal.state&lt;/code>æ–‡ä»¶ä¸­.&lt;/p>
&lt;p>å¯èƒ½æ˜¯è™šæ‹Ÿæœºç³»ç»Ÿå®‰è£…é—®é¢˜, å¯¼è‡´æ²¡æœ‰åˆ›å»º&lt;code>/var/lib/rsyslog&lt;/code>. &lt;code>rsyslog&lt;/code>å°†å¼‚å¸¸æ—¥å¿—å†™å…¥&lt;code>/dev/log&lt;/code>socketä¸­.&lt;/p>
&lt;p>è¿™æ ·å°±å¯¼è‡´äº†æ­»å¾ªç¯, &lt;code>rsyslog&lt;/code>å› ä¸ºè¦æ‰“å¼€&lt;code>/var/log/messages&lt;/code>å¹¶å†™å…¥æ—¥å¿—, æ¶ˆè€—cpu, å†…å­˜è¿˜æœ‰ç£ç›˜I/O.&lt;/p>
&lt;h2 id="è¯Šæ–­æ­¥éª¤">è¯Šæ–­æ­¥éª¤:&lt;/h2>
&lt;h3 id="rsyslog">rsyslog&lt;/h3>
&lt;p>é‡å¯&lt;code>rsyslog&lt;/code>æœåŠ¡&lt;/p>
&lt;p>é‡å¯ä¹‹åå†…å­˜å¾—åˆ°é‡Šæ”¾, ä½†æ˜¯rsyslogdè¿›ç¨‹cpuè·‘åˆ°90%å¤š, ä¸”å†…å­˜åœ¨æŒç»­å‡é«˜.&lt;/p>
&lt;p>æ£€æŸ¥æœåŠ¡çŠ¶æ€å‘ç°è¿›ç¨‹ä¸€ç›´åœ¨æŠ¥é”™:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">fopen() failed: &amp;#39;Permission denied&amp;#39;, path: &amp;#39;/imjournal.state.tmp&amp;#39;
[try http://www.rsyslog.com/e/2013 ]
fopen() failed: &amp;#39;Permission denied&amp;#39;, path: &amp;#39;/imjournal.state.tmp&amp;#39;
[try http://www.rsyslog.com/e/2013 ]
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥&lt;code>/etc/rsyslog.conf&lt;/code>ä¸­çš„&lt;code>WorkDirectory&lt;/code>è¡Œæ˜¯æ²¡æœ‰è¢«æ³¨é‡Šçš„. æ£€æŸ¥é»˜è®¤å·¥ä½œç›®å½•&lt;code>/var/lib/rsyslog&lt;/code>, å‘ç°ç›®å½•ä¸å­˜åœ¨.&lt;/p>
&lt;p>å› æ­¤åˆ›å»º&lt;code>/var/lib/rsyslog&lt;/code>ç›®å½•, å¹¶èµ‹äºˆ&lt;code>600&lt;/code>æƒé™.&lt;/p>
&lt;p>å†æ¬¡é‡å¯&lt;code>rsyslog&lt;/code>æœåŠ¡, è§‚å¯Ÿä¸€æ®µæ—¶é—´æ²¡æœ‰é”™è¯¯æŠ›å‡º, &lt;code>/var/lib/rsyslog&lt;/code>ç›®å½•ä¸‹åˆ›å»ºäº†&lt;code>imjournal.state&lt;/code>æ–‡ä»¶. æ£€æŸ¥æ–‡ä»¶, å†…å®¹ä¸æ–­è¢«åˆ·æ–°. ä½†æ˜¯å ç”¨å†…å­˜è¿˜åœ¨å‡é«˜, &lt;code>/var/log/messages&lt;/code>æ–‡ä»¶ä¸­è¿˜æœ‰é”™è¯¯ä¿¡æ¯å†™å…¥. ä½†æ˜¯é”™è¯¯æ—¥å¿—çš„æ—¶é—´æ˜¯æ¯”è¾ƒæ—©çš„.&lt;/p>
&lt;p>å†æ¬¡æ£€æŸ¥&lt;code>/etc/rsyslog.conf&lt;/code>é…ç½®, æœ‰ä¸€è¡Œé…ç½®:&lt;/p>
&lt;blockquote>
&lt;p># Include all config files in /etc/rsyslog.d/
$IncludeConfig /etc/rsyslog.d/*.conf&lt;/p>
&lt;/blockquote>
&lt;p>ç›®å½•ä¸­æœ‰æ–‡ä»¶&lt;code>/etc/rsyslog.d/listen.conf&lt;/code>, å†…å®¹ä¸º&lt;code>$SystemLogSocketName /run/systemd/journal/syslog&lt;/code>.&lt;/p>
&lt;p>åˆ†æ:&lt;/p>
&lt;ul>
&lt;li>&lt;code>/run&lt;/code>æ˜¯linuxå†…å­˜ä¸­çš„æ•°æ®&lt;/li>
&lt;li>&lt;code>journal&lt;/code>ç›¸å…³æœåŠ¡:&lt;code>systemd-journald.service&lt;/code>.&lt;/li>
&lt;/ul>
&lt;h3 id="systemd-journaldservice">systemd-journald.service&lt;/h3>
&lt;p>&lt;code>systemd-journald&lt;/code>æ˜¯ç”¨æ¥ååŠ©&lt;code>rsyslog&lt;/code>è®°å½•ç³»ç»Ÿå¯åŠ¨æœåŠ¡å’ŒæœåŠ¡å¯åŠ¨å¤±è´¥çš„æƒ…å†µç­‰ç­‰. &lt;code>systemd-journald&lt;/code>ä½¿ç”¨å†…å­˜ä¿å­˜è®°å½•, ç³»ç»Ÿé‡å¯è®°å½•ä¼šä¸¢å¤±. æ‰€æœ‰è¿˜è¦ç”¨&lt;code>rsyslog&lt;/code>æ¥è®°å½•åˆ†ç±»ä¿¡æ¯, å¦‚ä¸Šé¢&lt;code>/etc/rsyslog.d/listen.conf&lt;/code>ä¸­çš„&lt;code>syslog&lt;/code>åˆ†ç±».&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">~ systemctl list-sockets
LISTEN UNIT ACTIVATES
....
/dev/log systemd-journald.socket systemd-journald.service
/run/systemd/journal/socket systemd-journald.socket systemd-journald.service
/run/systemd/journal/stdout systemd-journald.socket systemd-journald.service
....
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹journalçš„é…ç½®&lt;code>/etc/systemd/jounal.conf&lt;/code>, æœ€ç»ˆè¿˜æ˜¯ä¼šæŒä¹…åŒ–åˆ°ç¡¬ç›˜ä¸Šçš„&lt;code>/var/log/journal&lt;/code>ç›®å½•ä¸­. æ¯ä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯&lt;code>10M&lt;/code>, æœ€å¤šä½¿ç”¨&lt;code>8G&lt;/code>çš„ç©ºé—´, åŒæ­¥é—´éš”&lt;code>1s&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">[Journal]
Storage=persistent
Compress=True
#Seal=yes
#SplitMode=uid
SyncIntervalSec=1s
RateLimitInterval=1s
RateLimitBurst=10000
SystemMaxUse=8G
SystemMaxFileSize=10M
#RuntimeKeepFree=
#RuntimeMaxFileSize=
MaxRetentionSec=1month
ForwardToSyslog=False
#ForwardToKMsg=no
#ForwardToConsole=no
ForwardToWall=False
#TTYPath=/dev/console
#MaxLevelStore=debug
#MaxLevelSyslog=debug
#MaxLevelKMsg=notice
#MaxLevelConsole=info
#MaxLevelWall=emerg
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥&lt;code>/var/log/journal&lt;/code>ç›®å½•, å‘ç°é‡Œé¢æ–‡ä»¶å¾ˆå¤š, æ¯ä¸ªå¤§å°ä¸º&lt;code>10m&lt;/code>. æ¸…ç©ºè¯¥ç›®å½•å¹¶é‡å¯&lt;code>rsyslog&lt;/code>, è§‚å¯Ÿä¸€æ®µæ—¶é—´åä¸€åˆ‡æ­£å¸¸.&lt;/p>
&lt;p>å‚è€ƒ:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://access.redhat.com/solutions/2795451">Redhat&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://wizardforcel.gitbooks.io/vbird-linux-basic-4e/content/160.html">systemd-journald.service ç®€ä»‹&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://unix.stackexchange.com/questions/362681/systemd-journal-what-is-the-relation-of-dev-log-and-syslog">StackExchange&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Kubernetesä¸­çš„NginxåŠ¨æ€è§£æ</title><link>https://atbug.com/nginx-dynamic-domain-parse-in-kubernetes/</link><pubDate>Wed, 30 May 2018 12:10:32 +0000</pubDate><guid>https://atbug.com/nginx-dynamic-domain-parse-in-kubernetes/</guid><description>
&lt;h3 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h3>
&lt;p>Nginxè¿è¡Œåœ¨kubernetsä¸­, åå‘ä»£ç†serviceæä¾›æœåŠ¡.&lt;/p>
&lt;p>kubernetesç‰ˆæœ¬v1.9.1+a0ce1bc657.&lt;/p>
&lt;h3 id="é—®é¢˜">é—®é¢˜:&lt;/h3>
&lt;p>é…ç½®å¦‚ä¸‹:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">location ^~/info {
proxy_pass: http://serviceName:port;
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ é™¤å¹¶é‡å»ºServiceçš„æ—¶å€™, nginxä¼šå‡ºç°ä¸‹é¢çš„é—®é¢˜:&lt;/p>
&lt;blockquote>
&lt;p>connect() failed (113: No route to host) &amp;hellip; upstream: &amp;ldquo;xxxxx&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;h3 id="åˆ†æ">åˆ†æ&lt;/h3>
&lt;p>é€šè¿‡googleå‘ç°, æ˜¯nginxçš„dnsè§£ææ–¹æ¡ˆçš„é—®é¢˜.&lt;/p>
&lt;p>nginxå®˜æ–¹çš„è¯´æ˜:&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>If the domain name canâ€™t be resolved, NGINX fails to start or reload its configuration.&lt;/li>
&lt;li>NGINX caches the DNS records until the next restart or configuration reload, ignoring the recordsâ€™ TTL values.&lt;/li>
&lt;li>We canâ€™t specify another loadâ€‘balancing algorithm, nor can we configure passive health checks or other features defined by parameters to the server directive, which weâ€™ll describe in the next section.&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>æ„æ€æ˜¯è¯´, nginxåœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šè§£æ&lt;code>proxy_pass&lt;/code>åçš„åŸŸå, å¹¶æŠŠ&lt;code>ip&lt;/code>ç¼“å­˜ä¸‹æ¥, è€Œä¸”æ²¡æœ‰TTL. åªæœ‰åœ¨restartæˆ–è€…reloadçš„æ—¶å€™æ‰ä¼šå†æ¬¡è§£æ.&lt;/p>
&lt;h3 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ&lt;/h3>
&lt;p>ä½¿ç”¨nginx podçš„è§£ææœåŠ¡å™¨ä½œä¸ºresolver:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">#nginx conf
resolver NAME_SERVER valid=30s ipv6=off;
set $service &amp;#34;http://serviceName:port&amp;#34;;
location ^~/info {
proxy_pass: $service;
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨shellè·å–podä¸­ä½¿ç”¨çš„è§£ææœåŠ¡å™¨&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">NAME_SERVER&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>cat /etc/resolv.conf &lt;span class="p">|&lt;/span> grep &lt;span class="s2">&amp;#34;nameserver&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> tr &lt;span class="s1">&amp;#39;\n&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="sb">`&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‚è€ƒ:
&lt;a href="https://stackoverflow.com/questions/17685674/nginx-proxy-pass-with-remote-addr">Nginx proxy_pass with $remote_addr&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://tenzer.dk/nginx-with-dynamic-upstreams/">Nginx with dynamic upstreams&lt;/a>&lt;/p>
&lt;h3 id="å¦ä¸€ä¸ªé—®é¢˜">å¦ä¸€ä¸ªé—®é¢˜&lt;/h3>
&lt;blockquote>
&lt;p>serviceName could not be resolved (3: Host not found)&lt;/p>
&lt;/blockquote>
&lt;p>serviceçš„çŸ­åç§°æ˜¯è§£æä¸äº†çš„, éœ€è¦ä½¿ç”¨serviceName.namespace.svc.clusterName.&lt;/p></description></item><item><title>Spring Cloud Ribbon è¯¦è§£</title><link>https://atbug.com/spring-cloud-ribbon-breakdown-1/</link><pubDate>Sat, 05 May 2018 11:18:05 +0000</pubDate><guid>https://atbug.com/spring-cloud-ribbon-breakdown-1/</guid><description>
&lt;p>å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡, Ribbonçš„æ ¸å¿ƒæ¦‚å¿µæ˜¯å‘½åçš„å®¢æˆ·ç«¯.&lt;/p>
&lt;h2 id="ä½¿ç”¨">ä½¿ç”¨&lt;/h2>
&lt;h3 id="å¼•å…¥ribbonä¾èµ–å’Œé…ç½®">å¼•å…¥Ribbonä¾èµ–å’Œé…ç½®&lt;/h3>
&lt;p>åŠ å…¥&lt;code>spring-cloud-starter-netflix-ribbon&lt;/code>ä¾èµ–&lt;/p>
&lt;h3 id="ä»£ç ä¸­ä½¿ç”¨ribbonclientæ³¨è§£">ä»£ç ä¸­ä½¿ç”¨RibbonClientæ³¨è§£&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="nd">@RibbonClient&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;foo&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">configuration&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FooConfiguration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">TestConfiguration&lt;/span> &lt;span class="o">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Configuration&lt;/span> &lt;span class="kd">protected&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">FooConfiguration&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">ZonePreferenceServerListFilter&lt;/span> &lt;span class="nf">serverListFilter&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ZonePreferenceServerListFilter&lt;/span> &lt;span class="n">filter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ZonePreferenceServerListFilter&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">filter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setZone&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;myTestZone&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">filter&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">IPing&lt;/span> &lt;span class="nf">ribbonPing&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">PingUrl&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Ribbonå®¢æˆ·ç«¯çš„é…ç½®, å¦‚æœä¸æŒ‡å®šä¼šä½¿ç”¨é»˜è®¤çš„å®ç°:&lt;/p>
&lt;ul>
&lt;li>IClientConfig å®¢æˆ·ç«¯ç›¸å…³é…ç½®&lt;/li>
&lt;li>IRule å®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥&lt;/li>
&lt;li>IPing å®šä¹‰å¦‚ä½•pingç›®æ ‡æœåŠ¡å®ä¾‹æ¥åˆ¤æ–­æ˜¯å¦å­˜æ´», ribbonä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹æ¯éš”ä¸€æ®µæ—¶é—´(é»˜è®¤10s)å¯¹æœ¬åœ°ç¼“å­˜çš„ServerListåšä¸€æ¬¡æ£€æŸ¥&lt;/li>
&lt;li>ServerList&lt;!-- raw HTML omitted --> å®šä¹‰å¦‚ä½•è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨. ä¸¤ç§å®ç°åŸºäºé…ç½®çš„&lt;code>ConfigurationBasedServerList&lt;/code>å’ŒåŸºäºEurekaæœåŠ¡å‘ç°çš„&lt;code>DiscoveryEnabledNIWSServerList&lt;/code>&lt;/li>
&lt;li>ServerListFilter&lt;!-- raw HTML omitted --> ç”¨æ¥ä½¿ç”¨æœŸæœ›çš„ç‰¹å¾è¿‡æ»¤é™æ€é…ç½®åŠ¨æ€è·å¾—çš„å€™é€‰æœåŠ¡å®ä¾‹åˆ—è¡¨. è‹¥æœªæä¾›, é»˜è®¤ä½¿ç”¨&lt;code>ZoneAffinityServerListFilter&lt;/code>&lt;/li>
&lt;li>ILoadBalancer å®šä¹‰äº†è½¯è´Ÿè½½å‡è¡¡å™¨çš„æ“ä½œçš„æ¥å£. ä¸€ä¸ªå…¸å‹çš„è´Ÿè½½å‡è¡¡å™¨è‡³å°‘éœ€è¦ä¸€ç»„ç”¨æ¥åšè´Ÿè½½å‡è¡¡çš„æœåŠ¡å®ä¾‹, ä¸€ä¸ªæ ‡è®°æŸä¸ªæœåŠ¡å®ä¾‹ä¸åœ¨æ—‹è½¬ä¸­çš„æ–¹æ³•, å’Œå¯¹åº”çš„æ–¹æ³•è°ƒç”¨ä»å®ä¾‹åˆ—è¡¨ä¸­é€‰å‡ºæŸä¸€ä¸ªæœåŠ¡å®ä¾‹.&lt;/li>
&lt;li>ServerListUpdater DynamicServerListLoadBalancerç”¨æ¥æ›´æ–°å®ä¾‹åˆ—è¡¨çš„ç­–ç•¥(æ¨&lt;code>EurekaNotificationServerListUpdater&lt;/code>/æ‹‰&lt;code>PollingServerListUpdater&lt;/code>, é»˜è®¤æ˜¯æ‹‰)&lt;/li>
&lt;/ul>
&lt;h2 id="åˆ†æ">åˆ†æ&lt;/h2>
&lt;p>ç±»ç»“æ„&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/Ribbon.png" alt="Ribbon">&lt;/p>
&lt;h3 id="å®ç°">å®ç°&lt;/h3>
&lt;p>å®é™…ä½¿ç”¨ä¸­, æœåŠ¡è°ƒç”¨ä½¿ç”¨RestTemplate, è¯·æ±‚åœ°å€ä¸º&lt;code>http://&amp;lt;serviceName&amp;gt;/&amp;lt;path&amp;gt;&lt;/code>, å¦‚&lt;code>http://foo/&lt;/code>
é€šè¿‡&lt;code>@RibbonClient&lt;/code>æ³¨è§£ä¸ºæœåŠ¡åˆ›å»ºribbonå®¢æˆ·ç«¯, åå­—ä¸ºæ–¹æ³•å. RestTemplateå‘é€è¯·æ±‚çš„æ—¶å€™, è¯·æ±‚ä¼šè¢«&lt;code>LoadBalancerInterceptor&lt;/code>æ‹¦æˆªåˆ°, ä½¿ç”¨æœåŠ¡å¯¹åº”çš„ribbonå®¢æˆ·ç«¯. Ribbonå®¢æˆ·ç«¯çš„&lt;code>LoadBalancer&lt;/code>ä¼šä»&lt;code>ServerList&lt;/code>ä¸­æ ¹æ®&lt;code>IRule&lt;/code>çš„è§„åˆ™é€‰æ‹©æŸä¸ªæœåŠ¡å®ä¾‹ä½œä¸ºè¯·æ±‚å¯¹è±¡. &lt;code>ServerList&lt;/code>æœ‰åŠ¨æ€çš„å®ç°, æ›´æ–°åˆ—è¡¨æ—¶ä¼šä½¿ç”¨&lt;code>ServerListFilter&lt;/code>è¿›è¡Œè¿‡æ»¤.&lt;/p>
&lt;h4 id="ribbonclientæ³¨è§£">RibbonClientæ³¨è§£&lt;/h4>
&lt;p>ä»æ³¨é‡Šä¸Š&lt;code>@RibbonClient&lt;/code>ä¸ºä¸€ä¸ªribbonå®¢æˆ·ç«¯å£°æ˜é…ç½®ä¿¡æ¯. æŠŠè¿™ä¸ªæ³¨è§£åŠ åœ¨ä»»ä½•&lt;code>@Configuration&lt;/code>æ ‡æ³¨çš„ç±»ä¸Š, ç„¶åæ³¨å…¥&lt;code>SpringClientFactory&lt;/code>æ¥è®¿é—®åˆ›å»ºçš„å®¢æˆ·ç«¯.&lt;/p>
&lt;p>ä»ä»£ç ä¸Šçœ‹&lt;code>@RibbonClient&lt;/code>å¼•å…¥äº†&lt;code>RibbonClientConfigurationRegistrar&lt;/code>. &lt;code>RibbonClientConfigurationRegistrar&lt;/code>å®ç°äº†&lt;code>ImportBeanDefinitionRegistrar&lt;/code>æ¥å£, åœ¨&lt;code>@Configuration&lt;/code>çš„è§£ææç«¯è°ƒç”¨æ¥å£çš„&lt;code>registerBeanDefinitions&lt;/code>æ–¹æ³•, ä¸ºribbonå®¢æˆ·ç«¯åˆ›å»ºBeanDefinition
ä½¿ç”¨&lt;code>name/value&lt;/code>å’Œ&lt;code>configuration&lt;/code>åˆ›å»ºä¸€ä¸ª&lt;code>BeanDefinition&lt;/code>. Definitionçš„åä¸º&lt;code>&amp;lt;name&amp;gt;.RibbonClientSpecification&lt;/code>, classä¸º&lt;code>RibbonClientSpecification&lt;/code>.&lt;/p>
&lt;p>&lt;code>FooConfiguration.class&lt;/code>ä¹Ÿè¦ä½¿ç”¨&lt;code>@Configuration&lt;/code>æ³¨è§£, ç„¶åé€šè¿‡&lt;code>RibbonClientConfigurationRegistrar&lt;/code>å…³è”åˆ°Ribbonå®¢æˆ·ç«¯çš„BeanDefinition. æ‰€ä»¥&lt;strong>ä¸èƒ½æŠŠFooConfigurationæ”¾åˆ°@ComponentScançš„ä¸Šä¸‹æ–‡ä¸­, åŒæ ·@SpringBootApplicationä¹Ÿä¸è¡Œ. å¿…è¦æ—¶ä½¿ç”¨excludeæ’é™¤&lt;/strong>, å¦åˆ™ä¼šå˜æˆæ‰€æœ‰Ribbonå®¢æˆ·ç«¯å…±äº«.&lt;/p>
&lt;p>&lt;code>RibbonAutoConfiguration&lt;/code>ä¸­åœ¨åˆ›å»º&lt;code>SpringClientFactory&lt;/code>beanæ—¶, ä¼šæ³¨å…¥è¿™äº›&lt;code>RibbonClientSpecification&lt;/code>. &lt;code>SpringClientFactory&lt;/code>ç»§æ‰¿äº†ç±»&lt;code>NamedContextFactory&lt;/code>. ä»æ³¨é‡Šçœ‹&lt;code>NamedContextFactory&lt;/code>å¯ä»¥åˆ›å»ºä¸€ç»„å­ä¸Šä¸‹æ–‡, æ¯ä¸ªå­ä¸Šä¸‹æ–‡ä¸­å¯ä»¥ä½¿ç”¨ä¸€ç»„çš„Specificationæ¥å®šä¹‰bean. å¯¹äºRibbonæ¥è¯´, æ¯ä¸ªribbonå®¢æˆ·ç«¯å„è‡ªä¸ºä¸€ä¸ªå­ä¸Šä¸‹æ–‡, &lt;code>@RibbonClient&lt;/code>çš„&lt;code>configuration&lt;/code>æŒ‡å®šçš„é…ç½®, å°±æ˜¯ç”¨æ¥æ„å»ºè¯¥å­ä¸Šä¸‹æ–‡çš„é…ç½®, æœ€ç»ˆè¢«ç”¨æ¥æ„å»ºribbonå®¢æˆ·ç«¯. è¿™äº›ä¸Šä¸‹æ–‡æœ‰å…±åŒçš„çˆ¶ä¸Šä¸‹æ–‡, å³&lt;code>ApplicationContext&lt;/code>. è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢æåˆ°çš„&lt;code>FooConfiguration&lt;/code>ä¸èƒ½ç½®äº&lt;code>ApplicationContext&lt;/code>ä¸­, å¦åˆ™ä¼šè¢«æ‰€æœ‰çš„Ribbonå®¢æˆ·ç«¯å…±äº«é…ç½®.&lt;/p>
&lt;h4 id="loadbalancerautoconfigurationé…ç½®ç±»">LoadBalancerAutoConfigurationé…ç½®ç±»&lt;/h4>
&lt;p>é€šè¿‡&lt;code>RibbonAutoConfiguration&lt;/code>å¼•å…¥, å®šä¹‰äº†å‡ ä¸ªé‡è¦çš„bean:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>LoadBalancerRequestFactory&lt;/code>: 1) å°†Httpè¯·æ±‚å°è£…æˆ&lt;code>ServiceRequestWrapper&lt;/code>. &lt;code>ServiceRequestWrapper&lt;/code>ç»§æ‰¿å¹¶é‡å†™äº†&lt;code>HttpRquestWrapper&lt;/code>çš„&lt;code>getURI&lt;/code>æ–¹æ³•: è°ƒç”¨&lt;code>LoadBalancerClient&lt;/code>çš„&lt;code>reconstructURI&lt;/code>æ–¹æ³•,åˆ›å»ºå®é™…è¯·æ±‚çš„åœ°å€. 2) å¦‚æœæœ‰æä¾›&lt;code>LoadBalancerRequestTransformer&lt;/code>çš„å®ä¾‹, åˆ™ä½¿ç”¨è¿™äº›å®ä¾‹å¯¹ç›¸æ±‚è¿›è¡Œå“åº”çš„è½¬æ¢.
&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15254831654150.jpg" alt="">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>LoadBalancerInterceptor&lt;/code>: Httpè¯·æ±‚æ‹¦æˆªå™¨, å°†è¯·æ±‚çš„&lt;code>host&lt;/code>ä½œä¸º&lt;code>serviceName&lt;/code>å¹¶ä½¿ç”¨&lt;code>LoadBalancerRequestFactory&lt;/code>å°è£…è¯·æ±‚, è°ƒç”¨&lt;code>LoadBalancerClient&lt;/code>çš„&lt;code>execute&lt;/code>æ–¹æ³•, å‘é€è¯·æ±‚åˆ°çœŸå®çš„æœåŠ¡å®ä¾‹åœ°å€, è¿”å›å“åº”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>RestTemplateCustomizer&lt;/code>: æä¾›ä¸€ä¸ª&lt;code>RestTemplateCustomizer&lt;/code>çš„åŒ¿åç±»å®ç°, ä¸ºæ‰€æœ‰çš„RestTemplateå®ä¾‹æ·»åŠ ä¸€ä¸ª&lt;code>LoadBalancerInterceptor&lt;/code>æ‹¦æˆªå™¨&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="ribbonautoconfigurationé…ç½®ç±»">RibbonAutoConfigurationé…ç½®ç±»&lt;/h4>
&lt;p>é€šè¿‡spring.factorieså¼•å…¥, &lt;code>RibbonAutoConfiguration&lt;/code>å®šä¹‰äº†å‡ ä¸ªé‡è¦çš„bean:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>SpringClientFactory&lt;/code>: ä½¿ç”¨&lt;code>@RibbonClient&lt;/code>æ³¨è§£å¼•å…¥çš„ribbonå®¢æˆ·ç«¯çš„é…ç½®, æ„å»ºribbonå®¢æˆ·ç«¯çš„å­ä¸Šä¸‹æ–‡, åˆå§‹åŒ–ribbonå®¢æˆ·ç«¯bean. å››ä¸ªgetæ–¹æ³•, åˆ†åˆ«è¿”å›å¯¹åº”&lt;strong>service&lt;/strong>çš„&lt;code>IClient&lt;/code>, &lt;code>ILoadBalancer&lt;/code>, &lt;code>IClientConfig&lt;/code>, &lt;code>RibbonLoadBalancerContext&lt;/code>å®ä¾‹.
&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15254844516099.jpg" alt="">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>LoadBalancerClient&lt;/code>: ä½¿ç”¨Spring Cloudæä¾›çš„å®ç°&lt;code>RibbonLoadBalancerClient&lt;/code>. é€šè¿‡&lt;code>SpringClientFactory&lt;/code>åˆ›å»ºä¸€ä¸ª&lt;code>ILoadBalancer&lt;/code>å®ä¾‹, é€šè¿‡&lt;code>ILoadBalancer&lt;/code>è¿”å›ä¸€ä¸ª&lt;code>Server&lt;/code>å®ä¾‹. ä½¿ç”¨&lt;code>Server&lt;/code>å®ä¾‹.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>reconstructURI(): é€šè¿‡&lt;code>SpringClientFactory&lt;/code>è·å–è¯¥æœåŠ¡ribbonå®¢æˆ·ç«¯å­ä¸Šä¸‹æ–‡&lt;code>RibbonLoadBalancerContext&lt;/code>å¯¹è±¡, è°ƒç”¨&lt;code>RibbonLoadBalancerContext&lt;/code>çš„&lt;code>reconstructURIWithServer&lt;/code>æ–¹æ³•æ„å»ºæœ€ç»ˆçš„è¯·æ±‚åœ°å€&lt;/p>
&lt;/li>
&lt;li>
&lt;p>choose(): é€šè¿‡&lt;code>SpringClientFactory&lt;/code>è·å–è¯¥æœåŠ¡çš„æœåŠ¡å‡è¡¡å™¨, ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨çš„&lt;code>IRule&lt;/code>è¿”å›æœåŠ¡å®ä¾‹.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>execute(): æ‰§è¡Œæœ€ç»ˆçš„è¯·æ±‚, å¹¶è®°å½•çŠ¶æ€: &lt;code>ServerStats&lt;/code>å’Œ&lt;code>Stopwatch&lt;/code>&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15254847309993.jpg" alt="">&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></description></item><item><title>Jenkins CI/CD (ä¸€) åŸºäºè§’è‰²çš„æˆæƒç­–ç•¥</title><link>https://atbug.com/using-role-based-authorization-strategy-in-jenkins/</link><pubDate>Fri, 20 Apr 2018 12:18:46 +0000</pubDate><guid>https://atbug.com/using-role-based-authorization-strategy-in-jenkins/</guid><description>
&lt;p>æœ€è¿‘å¼€å§‹å®¢ä¸²è¿ç»´åšCI/CDçš„è§„åˆ’è®¾è®¡, ä¸»è¦æ˜¯åŸºäº&amp;rsquo;Pipeline as Code in Jenkins'. æ•´ç†äº†ä¸‹æ€è·¯å’ŒæŠ€æœ¯ç‚¹, æ…¢æ…¢çš„å†™.&lt;/p>
&lt;p>è¿™ä¸€ç¯‡æ˜¯å…³äºåŸºäºè§’è‰²çš„æˆæƒç­–ç•¥, ç”¨çš„æ˜¯&lt;code>Role-Based Authorization Strategy Plugin&lt;/code>.&lt;/p>
&lt;p>æˆæƒåœ¨CI/CDæµç¨‹ä¸­æ¯”è¾ƒå¸¸è§, æ¯”å¦‚æˆ‘ä»¬åªè®©æŸäº›ç‰¹å®šç”¨æˆ·æ‰å¯ä»¥æ„å»ºPre-Releaseçš„Job. è€Œæ›´é«˜çº§çš„Releaseå‘å¸ƒ, åˆä¼šéœ€è¦æŸäº›ç”¨æˆ·çš„å®¡æ‰¹æ‰å¯ä»¥è¿›è¡Œ. éœ€è¦æˆæƒæ—¶, å¯èƒ½è¿˜éœ€è¦å‘é‚®ä»¶æé†’ç”¨æˆ·.&lt;/p>
&lt;p>UIä¸Šå¦‚ä½•ä½¿ç”¨å°±ä¸æäº†, è¿™é‡Œåªè¯´Pipeline as Code. åé¢çš„å‡ ç¯‡ä¹Ÿä¼šæ˜¯è¿™ä¸ªèƒŒæ™¯.&lt;/p>
&lt;p>å‚è€ƒçš„è¿™ç¯‡&lt;a href="https://www.avioconsulting.com/blog/using-role-based-authorization-strategy-jenkins">æ–‡ç« &lt;/a>, æ–‡ç« é‡Œçš„ä»£ç è¿è¡Œå¤±è´¥, åšäº†ä¿®å¤.&lt;/p>
&lt;h2 id="é…ç½®">é…ç½®&lt;/h2>
&lt;p>å®‰è£…å®Œæ’ä»¶, éœ€è¦å¼€å§‹&lt;code>åŸºäºè§’è‰²çš„æˆæƒç­–ç•¥&lt;/code>. åŒæ—¶æ·»åŠ è§’è‰²å’Œä¸ºç”¨æˆ·åˆ†é…è§’è‰².&lt;/p>
&lt;h3 id="ä½¿ç”¨role-based-strategyä½œä¸ºéªŒè¯æ–¹å¼">ä½¿ç”¨&lt;code>Role-Based Strategy&lt;/code>ä½œä¸ºéªŒè¯æ–¹å¼&lt;/h3>
&lt;p>&lt;code>Manage Jenkins / Configure Global Security / Configure Global Security&lt;/code>&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15241955282214.jpg" alt="">&lt;/p>
&lt;h3 id="æ·»åŠ è§’è‰²">æ·»åŠ è§’è‰²&lt;/h3>
&lt;p>&lt;code>Manage Jenkins / Manage and Assign Roles / Manage Roles / Global roles &lt;/code>&lt;/p>
&lt;p>è¾“å…¥è¦æ·»åŠ çš„è§’è‰²å&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15241956860233.jpg" alt="">&lt;/p>
&lt;h4 id="ä¸ºæ–°åŠ çš„è§’è‰²é…ç½®æƒé™">ä¸ºæ–°åŠ çš„è§’è‰²é…ç½®æƒé™&lt;/h4>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15241957585851.jpg" alt="">&lt;/p>
&lt;h3 id="ä¸ºç”¨æˆ·æŒ‡å®šè§’è‰²">ä¸ºç”¨æˆ·æŒ‡å®šè§’è‰²&lt;/h3>
&lt;p>`Manage Jenkins / Manage and Assign Roles / Assign Roles / Global roles'&lt;/p>
&lt;p>è¾“å…¥å·²æœ‰çš„ç”¨æˆ·å&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15241960130076.jpg" alt="">&lt;/p>
&lt;p>åˆ†é…è§’è‰²&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15241960527215.jpg" alt="">&lt;/p>
&lt;h2 id="ç¼–ç ">ç¼–ç &lt;/h2>
&lt;p>æˆæƒä¼šåœ¨å¾ˆå¤šjobé‡Œä½¿ç”¨, æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨&lt;code>shared library&lt;/code>æ¥å®šä¹‰.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-groovy" data-lang="groovy">&lt;span class="n">timeout&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nl">time:&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="nl">unit:&lt;/span> &lt;span class="s1">&amp;#39;MINUTES&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">notifyAwaitApproval&lt;/span> &lt;span class="nl">approvers:&lt;/span> &lt;span class="n">getApprovers&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;pre-release&amp;#39;&lt;/span>&lt;span class="o">),&lt;/span>
&lt;span class="nl">emailPrompt:&lt;/span> &lt;span class="s1">&amp;#39;Build is ready to prepare release&amp;#39;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»™ç”¨æˆ·å‘é€å¾…å®¡æ‰¹é‚®ä»¶, ä½¿ç”¨&lt;code>input&lt;/code>ç­‰å¾…ç”¨æˆ·çš„äº¤äº’, åŒæ—¶ä½¿ç”¨&lt;code>milestone&lt;/code>é˜»å¡åç»­çš„æ„å»ºè¯·æ±‚.
&lt;code>notifyAwaitApproval.groovy&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-groovy" data-lang="groovy">&lt;span class="kt">def&lt;/span> &lt;span class="nf">call&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">options&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">def&lt;/span> &lt;span class="n">jobName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">env&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">JOB_NAME&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">message&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">message&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;Action Required For Build $jobName&amp;#34;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kt">def&lt;/span> &lt;span class="n">csvApproverUsernames&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">approvers&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nl">String:&lt;/span>
&lt;span class="c1">// already csv
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">approvers&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nl">Map:&lt;/span>
&lt;span class="c1">// keys are usernames and values are names
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">approvers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">keySet&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">join&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;,&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nl">ArrayList:&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nl">HashSet:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">approvers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">join&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;,&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nf">Exception&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;Unexpeced approver type ${options.approvers.class}!&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}()&lt;/span>
&lt;span class="n">echo&lt;/span> &lt;span class="s2">&amp;#34;Notify approvers: $csvApproverUsernames for approval&amp;#34;&lt;/span>
&lt;span class="c1">// emailext needs to be inside a node block but don&amp;#39;t want to take up a node while waiting for approval
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">emailext&lt;/span> &lt;span class="nl">body:&lt;/span> &lt;span class="s2">&amp;#34;Action Required For Build \${jobName} (#\${env.BUILD_NUMBER})&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="nl">to:&lt;/span> &lt;span class="n">csvApproverUsernames&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="nl">subject:&lt;/span> &lt;span class="s2">&amp;#34;Action Required For Build \${jobName} (#\${env.BUILD_NUMBER})&amp;#34;&lt;/span>
&lt;span class="n">milestone&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="n">input&lt;/span> &lt;span class="nl">id:&lt;/span> &lt;span class="s1">&amp;#39;Approval&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="nl">message:&lt;/span> &lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">message&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="nl">submitter:&lt;/span> &lt;span class="n">csvApproverUsernames&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="nl">submitterParameter:&lt;/span> &lt;span class="s1">&amp;#39;submitter&amp;#39;&lt;/span>
&lt;span class="n">milestone&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥å¹¶è·å–Jenkinså½“å‰é…ç½®çš„æˆæƒç­–ç•¥, å¦‚æœæ˜¯&lt;code>Role-Based Authorization&lt;/code>, è¿”å›æ‹¥æœ‰æŒ‡å®šè§’è‰²çš„ç”¨æˆ·åˆ—è¡¨.
&lt;code>getApprovers.groovy&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-groovy" data-lang="groovy">&lt;span class="kn">import&lt;/span> &lt;span class="nn">com.cloudbees.groovy.cps.NonCPS&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy&lt;/span>
&lt;span class="nd">@NonCPS&lt;/span>
&lt;span class="kt">def&lt;/span> &lt;span class="nf">call&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">role&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">echo&lt;/span> &lt;span class="s2">&amp;#34;Retrieving users for $role&amp;#34;&lt;/span>
&lt;span class="kt">def&lt;/span> &lt;span class="n">strategy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">RoleBasedAuthorizationStrategy&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">instance&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">strategy&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">strategy&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getGrantedRoles&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RoleBasedAuthorizationStrategy&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">GLOBAL&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">entrySet&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">find&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="n">entry&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">key&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">role&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">}.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nf">Exception&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;Role Strategy Plugin not in use. Please enable to retrieve users for a role&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>KVMå®‰è£…æ‰‹å†Œ</title><link>https://atbug.com/kvm-installation-note/</link><pubDate>Thu, 12 Apr 2018 12:45:15 +0000</pubDate><guid>https://atbug.com/kvm-installation-note/</guid><description>
&lt;h2 id="æ·»åŠ è™šæ‹Ÿæœºæµç¨‹">æ·»åŠ è™šæ‹Ÿæœºæµç¨‹ï¼š&lt;/h2>
&lt;pre>&lt;code>1. é…ç½®ç½‘ç»œ
2. é…ç½®å­˜å‚¨æ± 
3. ä¸Šä¼ é•œåƒ
4. å®‰è£…è™šæ‹Ÿæœºï¼ŒæŒ‡å®šé…ç½®
&lt;/code>&lt;/pre>
&lt;h3 id="å®‰è£…kvmè™šæ‹Ÿæœº">å®‰è£…KVMè™šæ‹Ÿæœº&lt;/h3>
&lt;h4 id="1-å…³é—­é˜²ç«å¢™selinux">1. å…³é—­é˜²ç«å¢™ï¼Œselinux&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># service iptables stop&lt;/span>
&lt;span class="c1"># setenforce 0 ä¸´æ—¶å…³é—­&lt;/span>
&lt;span class="c1"># chkconfig NetworkManager off&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="2-å®‰è£…kvmè™šæ‹Ÿæœº">2. å®‰è£…kvmè™šæ‹Ÿæœº&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># yum install kvm libvirt libvirt-devel python-virtinst python-virtinst qemu-kvm virt-viewer bridge-utils virt-top libguestfs-tools ca-certificates audit-libs-python device-mapper-libs virt-install&lt;/span>
&lt;span class="c1"># å¯åŠ¨æœåŠ¡&lt;/span>
&lt;span class="c1"># service libvirtd restart&lt;/span>
ä¸‹è½½virtio-win-1.5.2-1.el6.noarch.rpm å¦‚æœä¸å®‰è£…windowè™šæ‹Ÿæœºæˆ–è€…ä½¿ç”¨å¸¦virtioé©±åŠ¨çš„é•œåƒå¯ä»¥ä¸ç”¨å®‰è£…
&lt;span class="c1"># rpm -ivh virtio-win-1.5.2-1.el6.noarch.rpm&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-libvirtåœ¨ç®¡ç†æœ¬åœ°æˆ–è¿œç¨‹hypervisoræ—¶çš„è¡¨ç°å½¢å¼å¦‚ä¸‹">3. Libvirtåœ¨ç®¡ç†æœ¬åœ°æˆ–è¿œç¨‹Hypervisoræ—¶çš„è¡¨ç°å½¢å¼å¦‚ä¸‹ã€‚&lt;/h4>
&lt;p>åœ¨libvirtå†…éƒ¨ç®¡ç†äº†äº”éƒ¨åˆ†ï¼š&lt;/p>
&lt;ul>
&lt;li>èŠ‚ç‚¹ï¼šæ‰€è°“çš„èŠ‚ç‚¹å°±æ˜¯æˆ‘ä»¬çš„ç‰©ç†æœåŠ¡å™¨ï¼Œä¸€ä¸ªæœåŠ¡å™¨ä»£è¡¨ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸Šè¾¹å­˜æ”¾ç€Hyperå’ŒDomain&lt;/li>
&lt;li>Hypervisorï¼šå³VMMï¼ŒæŒ‡è™šæ‹Ÿæœºçš„ç›‘æ§ç¨‹åºï¼Œåœ¨KVMä¸­æ˜¯ä¸€ä¸ªåŠ è½½äº†kvm.koçš„æ ‡å‡†Linuxç³»ç»Ÿã€‚&lt;/li>
&lt;li>åŸŸï¼ˆDomainï¼‰ï¼šæŒ‡è™šæ‹Ÿæœºï¼Œä¸€ä¸ªåŸŸä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿæœºï¼ˆä¼°è®¡æ€è·¯æ¥æºäºXençš„Domain0ï¼‰&lt;/li>
&lt;li>å­˜å‚¨æ± ï¼ˆStorage Poolï¼‰ï¼šå­˜å‚¨ç©ºé—´ï¼Œæ”¯æŒå¤šç§åè®®å’Œç½‘ç»œå­˜å‚¨ã€‚ä½œä¸ºè™šæ‹Ÿæœºç£ç›˜çš„å­˜å‚¨æºã€‚&lt;/li>
&lt;li>å·ç»„ï¼ˆVolumeï¼‰ï¼šè™šæ‹Ÿæœºç£ç›˜åœ¨Hostä¸Šçš„è¡¨ç°å½¢å¼ã€‚
ä¸Šè¾¹çš„äº”éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨çš„æ˜¯å‰ä¸‰ä¸ªï¼Œå› ä¸ºå¾ˆå¤šæ—¶å€™æ ¹æ®ä¸šåŠ¡è§„åˆ™æˆ–åº”ç”¨çš„çµæ´»æ€§å¹¶æ²¡æœ‰ä½¿ç”¨å·ç»„ï¼ˆå…¶å®å°±æ˜¯æœ‰äº†ç¼–åˆ¶çš„è™šæ‹Ÿç£ç›˜æ–‡ä»¶ï¼‰ï¼Œä¹Ÿå°±æ²¡æœ‰å¿…è¦ä½¿ç”¨å­˜å‚¨æ± ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="é…ç½®">é…ç½®&lt;/h3>
&lt;h4 id="1-ä¿®æ”¹ç½‘ç»œé…ç½®">1. ä¿®æ”¹ç½‘ç»œé…ç½®&lt;/h4>
&lt;p>æ–¹æ¡ˆä¸€ (æ¨è)&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">brctl addbr br0 &amp;amp;&amp;amp; brctl addif br0 em1 &amp;amp;&amp;amp; brctl stp br0 on &amp;amp;&amp;amp; ifconfig em1 0.0.0.0 &amp;amp;&amp;amp; ifconfig br0 192.168.1.31 netmask 255.255.255.0 &amp;amp;&amp;amp; route add default gw 192.168.1.1
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ–¹æ¡ˆäºŒ&lt;/p>
&lt;p>&lt;a href="https://blog.csdn.net/wh211212/article/details/54141412">å‚è€ƒ&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># vim /etc/sysconfig/network-scripts/ifcfg-br0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>DEVICE=br0
TYPE=Bridge
BOOTPROTO=static
BROADCAST=192.168.1.255
IPADDR=192.168.1.10
NETMASK=255.255.255.0
NETWORK=192.168.1.0
GATEWAY=192.168.1.1
DNS1=119.29.29.29
ONBOOT=yes&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># vim /etc/sysconfig/network-scripts/ifcfg-em1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>DEVICE=em1
BOOTPROTO=none
ONBOOT=yes
BRIDGE=br0&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># vim /etc/sysconfig/network-scripts/ifcfg-bond0 &lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>DEVICE=bond0
TYPE=Ethernet
NAME=bond0
BONDING_MASTER=yes
BOOTPROTO=none
BRIDGE=br0
ONBOOT=yes
BONDING_OPTS=&amp;ldquo;mode=5 miimon=100&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="https://www.jianshu.com/p/110b60c14a8b">æ–¹æ¡ˆä¸‰&lt;/a>&lt;/p>
&lt;h4 id="3-å…³é—­å®¿ä¸»æœºçš„gsoä¸tsoåŠŸèƒ½">3. å…³é—­å®¿ä¸»æœºçš„GSOä¸TSOåŠŸèƒ½&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># ethtool -K em1 gso off&lt;/span>
&lt;span class="c1"># ethtool -K em1 tso off&lt;/span>
&lt;span class="c1"># systemctl restart network&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="4-åˆ›å»ºåŸºäºæ–‡ä»¶å¤¹çš„å­˜å‚¨æ± ç›®å½•">4. åˆ›å»ºåŸºäºæ–‡ä»¶å¤¹çš„å­˜å‚¨æ± ï¼ˆç›®å½•ï¼‰&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># mkdir -p /home/vmdisk&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®šä¹‰å­˜å‚¨æ± ä¸å…¶ç›®å½•&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh pool-define-as vmDiskPool --type dir --target /home/vmdisk&lt;/span>
Pool vmDiskPool defined
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ›å»ºå·²å®šä¹‰çš„å­˜å‚¨æ± &lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh pool-build vmDiskPool&lt;/span>
Pool vmDiskPool built
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹å·²å®šä¹‰çš„å­˜å‚¨æ± ï¼Œå­˜å‚¨æ± ä¸æ¿€æ´»æ— æ³•ä½¿ç”¨&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh pool-list --all&lt;/span>
Name State Autostart
-----------------------------------------
vmDiskPool inactive no
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹å­˜å‚¨å·ä¿¡æ¯&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh pool-info vmDiskPool&lt;/span>
Name: vmDiskPool
UUID: 3fc996c4-9bfa-7fdc-2960-445e4c551855
State: inactive
Persistent: yes
Autostart: no
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¿€æ´»å¹¶è‡ªåŠ¨å¯åŠ¨å·²å®šä¹‰çš„å­˜å‚¨æ± &lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh pool-autostart vmDiskPool&lt;/span>
Pool vmDiskPool marked as autostarted
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯åŠ¨å­˜å‚¨å·&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh pool-start vmDiskPool&lt;/span>
Pool vmDiskPool started
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†æ¬¡æŸ¥çœ‹å­˜å‚¨å·ä¿¡æ¯&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh pool-info vmDiskPool&lt;/span>
Name: vmDiskPool
UUID: 3fc996c4-9bfa-7fdc-2960-445e4c551855
State: running
Persistent: yes
Autostart: yes
Capacity: 39.25 GiB
Allocation: 47.89 MiB
Available: 39.20 GiB
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-åœ¨å­˜å‚¨æ± ä¸­åˆ›å»ºè™šæ‹Ÿæœºå­˜å‚¨å·åˆ›å»ºå·">3. åœ¨å­˜å‚¨æ± ä¸­åˆ›å»ºè™šæ‹Ÿæœºå­˜å‚¨å·ï¼ˆåˆ›å»ºå·ï¼‰&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh vol-create-as vmDiskPool linux_vm0.qcow2 300G --format qcow2&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹å­˜å‚¨å·&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">ll /home/vmdisk/
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="å­˜å‚¨æ± ç›¸å…³ç®¡ç†å‘½ä»¤">å­˜å‚¨æ± ç›¸å…³ç®¡ç†å‘½ä»¤&lt;/h5>
&lt;p>åˆ é™¤å­˜å‚¨æ± ä¸­çš„å­˜å‚¨å·&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh vol-delete --pool vmDiskPool linux_vm1.qcow2&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å–æ¶ˆæ¿€æ´»å­˜å‚¨æ± &lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh pool-destroy vmDiskPool&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å–æ¶ˆå®šä¹‰å­˜å‚¨æ± &lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh pool-undefine vmDiskPool&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ é™¤å­˜å‚¨æ± &lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh pool-delete vmDiskPool&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="4-å®‰è£…è™šæ‹Ÿæœº">4. å®‰è£…è™šæ‹Ÿæœº&lt;/h4>
&lt;p>bridgeç½‘ç»œæ¨¡å¼&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virt-install \&lt;/span>
--virt-type kvm &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--os-type&lt;span class="o">=&lt;/span>linux &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--os-variant&lt;span class="o">=&lt;/span>RHEL7 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--name&lt;span class="o">=&lt;/span>vm0 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--memory &lt;span class="m">16384&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--vcpus &lt;span class="m">6&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--disk &lt;span class="nv">path&lt;/span>&lt;span class="o">=&lt;/span>/home/vmdisk/linux_vm0.qcow2,format&lt;span class="o">=&lt;/span>qcow2,bus&lt;span class="o">=&lt;/span>virtio &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--location /root/CentOS-7-x86_64-Minimal-1708.iso &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--graphics none &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--network &lt;span class="nv">bridge&lt;/span>&lt;span class="o">=&lt;/span>br0,model&lt;span class="o">=&lt;/span>virtio &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--autostart &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--boot cdrom,hd,menu&lt;span class="o">=&lt;/span>on &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--console pty,target_type&lt;span class="o">=&lt;/span>serial &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--extra-args &lt;span class="s1">&amp;#39;console=ttyS0,115200n8 serial&amp;#39;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>--debug
&lt;/code>&lt;/pre>&lt;/div>&lt;p>NATç½‘ç»œæ¨¡å¼&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virt-install --name=test --ram 512 --vcpus=1 -f /data/kvm/vm/test.qcow2 --cdrom /data/iso/CentOS-6.5-x86_64-bin-DVD1.iso --graphics vnc,listen=0.0.0.0,port=5988, --network network=default,model=virtio --force --accelerate --autostart --boot cdrom,hd,menu=on&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®‰è£…windowä¸»æœº&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virt-install --name=window_24 --ram 12288 --vcpus 4 -c /data/iso/windows2008.iso --disk path=/usr/share/virtio-win/virtio-win-1.5.2.iso,device=cdrom --disk path=/data/kvm/vm/window_24.img,format=qcow2,bus=virtio --network bridge=br0,model=virtio --vnc --vncport=5924 --vnclisten=0.0.0.0 --force --autostart --os-type=windows --accelerate --boot cdrom,hd,menu=on&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è®¾ç½®è™šæ‹Ÿæœºç½‘ç»œ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback"># vi /etc/sysconfig/network-scripts/ifcfg-eth0
TYPE=Ethernet
BOOTPROTO=static
DEFROUTE=yes
PEERDNS=yes
PEERROUTES=yes
IPV4_FAILURE_FATAL=no
NAME=eth0
DEVICE=eth0
ONBOOT=yes
IPADDR=192.168.1.16
PREFIX=24
GATEWAY=192.168.1.1
DNS1=119.29.29.29
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="5-å¯åŠ¨">5. å¯åŠ¨&lt;/h4>
&lt;p>ä½¿ç”¨virsh list &amp;ndash;allæŸ¥çœ‹å·²å®‰è£…çš„kvm&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="o">[&lt;/span>root@localhost ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># virsh list --all&lt;/span>
Id Name State
----------------------------------------------------
&lt;span class="m">5&lt;/span> &lt;span class="nb">test&lt;/span> running
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="6-åŠ¨æ€è°ƒæ•´cpuä¸ªæ•°">6. åŠ¨æ€è°ƒæ•´cpuä¸ªæ•°&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh setvcpus test --maximum 4 --config #è®¾ç½®testçš„æœ€å¤§cpué¢—æ•°&lt;/span>
&lt;span class="c1"># virsh setvcpus test 3 #å¢åŠ åˆ°3ä¸ªCPU&lt;/span>
æ³¨ï¼šä½¿ç”¨ä¸Šé¢å‘½ä»¤ä¿®æ”¹ï¼Œè™šæ‹Ÿæœºé‡å¯ä¿®æ”¹çš„é…ç½®ä¼šä¸¢å¤±
&lt;span class="c1"># virsh edit test #ä¿®æ”¹CPUä¸ªæ•°å†ä¿å­˜é…ç½®ï¼Œè¿™æ ·é‡å¯ä¹‹åä¹Ÿä¼šç”Ÿæ•ˆ&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="7-åŠ¨æ€è°ƒæ•´memå®¹é‡">7. åŠ¨æ€è°ƒæ•´memå®¹é‡&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh setmaxmem test 2G --config #è®¾ç½®æœ€å¤§å†…å­˜&lt;/span>
&lt;span class="c1"># virsh setmem test 800M --config #é‡å¯åç”Ÿæ•ˆ&lt;/span>
&lt;span class="c1"># virsh setmem test 800M --config --live #é©¬ä¸Šç”Ÿæ•ˆ&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="8-æŸ¥çœ‹è™šæ‹ŸåŒ–å®¢æˆ·æœºçš„èµ„æºä½¿ç”¨æƒ…å†µ">8. æŸ¥çœ‹è™šæ‹ŸåŒ–å®¢æˆ·æœºçš„èµ„æºä½¿ç”¨æƒ…å†µ&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virt-top&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="9-ä¸€äº›æ‰©å±•å‘½ä»¤">9. ä¸€äº›æ‰©å±•å‘½ä»¤&lt;/h4>
&lt;p>virshå‘½ä»¤è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># virsh list #æ˜¾ç¤ºæœ¬åœ°æ´»åŠ¨è™šæ‹Ÿæœº&lt;/span>
&lt;span class="c1"># virsh list --all #æ˜¾ç¤ºæœ¬åœ°æ‰€æœ‰çš„è™šæ‹Ÿæœºï¼ˆæ´»åŠ¨çš„+ä¸æ´»åŠ¨çš„ï¼‰&lt;/span>
&lt;span class="c1"># virsh define test.xml #é€šè¿‡é…ç½®æ–‡ä»¶å®šä¹‰ä¸€ä¸ªè™šæ‹Ÿæœºï¼ˆè¿™ä¸ªè™šæ‹Ÿæœºè¿˜ä¸æ˜¯æ´»åŠ¨çš„ï¼‰&lt;/span>
&lt;span class="c1"># virsh start test #å¯åŠ¨åå­—ä¸ºtestçš„éæ´»åŠ¨è™šæ‹Ÿæœº&lt;/span>
&lt;span class="c1"># virsh create test.xml #åˆ›å»ºè™šæ‹Ÿæœºï¼ˆåˆ›å»ºåï¼Œè™šæ‹Ÿæœºç«‹å³æ‰§è¡Œï¼Œæˆä¸ºæ´»åŠ¨ä¸»æœºï¼‰&lt;/span>
&lt;span class="c1"># virsh suspend test #æš‚åœè™šæ‹Ÿæœº&lt;/span>
&lt;span class="c1"># virsh resume test #å¯åŠ¨æš‚åœçš„è™šæ‹Ÿæœº&lt;/span>
&lt;span class="c1"># virsh shutdown test #æ­£å¸¸å…³é—­è™šæ‹Ÿæœº&lt;/span>
&lt;span class="c1"># virsh destroy test #å¼ºåˆ¶å…³é—­è™šæ‹Ÿæœº&lt;/span>
&lt;span class="c1"># virsh undefine test #æ¸…é™¤è™šæ‹Ÿæœº&lt;/span>
&lt;span class="c1"># virsh dominfo test #æ˜¾ç¤ºè™šæ‹Ÿæœºçš„åŸºæœ¬ä¿¡æ¯&lt;/span>
&lt;span class="c1"># virsh domname 2 #æ˜¾ç¤ºidå·ä¸º2çš„è™šæ‹Ÿæœºå&lt;/span>
&lt;span class="c1"># virsh domid test #æ˜¾ç¤ºè™šæ‹Ÿæœºidå·&lt;/span>
&lt;span class="c1"># virsh domuuid test #æ˜¾ç¤ºè™šæ‹Ÿæœºçš„uuid&lt;/span>
&lt;span class="c1"># virsh domstate test #æ˜¾ç¤ºè™šæ‹Ÿæœºçš„å½“å‰çŠ¶æ€&lt;/span>
&lt;span class="c1"># virsh dumpxml test #æ˜¾ç¤ºè™šæ‹Ÿæœºçš„å½“å‰é…ç½®æ–‡ä»¶ï¼ˆå¯èƒ½å’Œå®šä¹‰è™šæ‹Ÿæœºæ—¶çš„é…ç½®ä¸åŒï¼Œå› ä¸ºå½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œéœ€è¦ç»™è™šæ‹Ÿæœºåˆ†é…idå·ã€uuidã€vncç«¯å£å·ç­‰ç­‰ï¼‰&lt;/span>
&lt;span class="c1"># virsh setmem test 512000 #ç»™ä¸æ´»åŠ¨è™šæ‹Ÿæœºè®¾ç½®å†…å­˜å¤§å°&lt;/span>
&lt;span class="c1"># virsh setmaxmem test 1024000 #è®¾å®šå†…å­˜ä¸Šé™&lt;/span>
&lt;span class="c1"># virsh setvcpus test 4 #ç»™ä¸æ´»åŠ¨è™šæ‹Ÿæœºè®¾ç½®cpuä¸ªæ•°&lt;/span>
&lt;span class="c1"># virsh edit test #ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼ˆä¸€èˆ¬æ˜¯åœ¨åˆšå®šä¹‰å®Œè™šæ‹Ÿæœºä¹‹åï¼‰&lt;/span>
&lt;span class="c1"># virsh vcpuinfo test #æ˜¾ç¤ºå®¢æˆ·ç«¯çš„è™šæ‹Ÿ CPU ä¿¡æ¯ã€‚&lt;/span>
&lt;span class="c1"># virsh vcpupin test #æ§åˆ¶å®¢æˆ·ç«¯çš„è™šæ‹Ÿ CPU äº²å’Œæ€§ã€‚&lt;/span>
&lt;span class="c1"># virsh domblkstat test #æ˜¾ç¤ºæ­£åœ¨è¿è¡Œçš„å®¢æˆ·ç«¯çš„å—è®¾å¤‡ç»Ÿè®¡ã€‚&lt;/span>
&lt;span class="c1"># virsh domifstat test #æ˜¾ç¤ºæ­£åœ¨è¿è¡Œçš„å®¢æˆ·ç«¯çš„ç½‘ç»œæ¥å£ç»Ÿè®¡ã€‚&lt;/span>
&lt;span class="c1"># virsh attach-device test #ä½¿ç”¨ XML æ–‡ä»¶ä¸­çš„è®¾å¤‡å®šä¹‰åœ¨å®¢æˆ·ç«¯ä¸­æ·»åŠ è®¾å¤‡ã€‚&lt;/span>
&lt;span class="c1"># virsh attach-disk test #åœ¨å®¢æˆ·ç«¯ä¸­é™„åŠ æ–°ç£ç›˜è®¾å¤‡ã€‚&lt;/span>
&lt;span class="c1"># virsh attach-interface test #åœ¨å®¢æˆ·ç«¯ä¸­é™„åŠ æ–°ç½‘ç»œæ¥å£ã€‚&lt;/span>
&lt;span class="c1"># virsh detach-device test #ä»å®¢æˆ·ç«¯ä¸­åˆ†ç¦»è®¾å¤‡ï¼Œä½¿ç”¨åŒæ ·çš„ XML æè¿°ä½œä¸ºå‘½ä»¤attach-device&lt;/span>
&lt;span class="c1"># virsh detach-disk test #ä»å®¢æˆ·ç«¯ä¸­åˆ†ç¦»ç£ç›˜è®¾å¤‡ã€‚&lt;/span>
&lt;span class="c1"># virsh detach-interface #ä»å®¢æˆ·ç«¯ä¸­åˆ†ç¦»ç½‘ç»œæ¥å£ã€‚&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="é—®é¢˜">é—®é¢˜&lt;/h2>
&lt;blockquote>
&lt;p>Could not open &amp;lsquo;/root/CentOS-7-x86_64-Minimal-1708.iso&amp;rsquo;: Permission denied&lt;/p>
&lt;/blockquote>
&lt;p>ä¿®æ”¹&lt;code>/etc/libvirt/qemu.conf&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#å–æ¶ˆæ³¨é‡Š&lt;/span>
&lt;span class="nv">user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;root&amp;#34;&lt;/span>
&lt;span class="nv">group&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;root&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é‡å¯libvirtd&lt;/p>
&lt;p>&lt;code>service libvirtd restart&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>error: æ“ä½œå¤±è´¥: è¿™ä¸ªåŸŸæœ‰æ´»è·ƒæ§åˆ¶å°ä¼šè¯&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">ps -ef&lt;span class="p">|&lt;/span>grep &lt;span class="s1">&amp;#39;console VMNAME|grep -v &amp;#39;&lt;/span>grep&lt;span class="err">&amp;#39;&lt;/span>
&lt;span class="c1">#ç„¶åkillæ‰ç›¸åº”çš„è¿›è¡Œ&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>å¯ç”¨Jenkins CLI</title><link>https://atbug.com/jenkins-cli-enable/</link><pubDate>Mon, 09 Apr 2018 11:16:38 +0000</pubDate><guid>https://atbug.com/jenkins-cli-enable/</guid><description>
&lt;p>Jenkins CLIæä¾›äº†SSHå’ŒClientæ¨¡å¼.&lt;/p>
&lt;p>Dockerè¿è¡ŒJenkins&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;3&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">jenkins&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jenkins/jenkins:alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">8080&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">50000&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">50000&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">46059&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">46059&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;/Users/addo/DevApps/Docker/data/jenkins:/var/jenkins_home&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>note: ä»¥ä¸ºæ˜¯dockerè¿è¡Œ, sshç«¯å£è®¾ç½®é€‰ç”¨äº†å›ºå®šç«¯å£.&lt;/p>
&lt;h3 id="client">Client&lt;/h3>
&lt;p>ä»&lt;code>http://JENKINS_URL/cli&lt;/code>é¡µé¢ä¸‹è½½client jar&lt;/p>
&lt;p>ä½¿ç”¨æ–¹æ³•:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">java -jar jenkins-cli.jar -s http://localhost:8080/ &lt;span class="nb">help&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ„å»º:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">java -jar jenkins-cli.jar -s http://localhost:8080/ build JOB &lt;span class="o">[&lt;/span>-c&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>-f&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>-p&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>-r N&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>-s&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>-v&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>-w&lt;span class="o">]&lt;/span>
Starts a build, and optionally waits &lt;span class="k">for&lt;/span> a completion.
Aside from general scripting use, this &lt;span class="nb">command&lt;/span> can be
used to invoke another job from within a build of one job.
With the -s option, this &lt;span class="nb">command&lt;/span> changes the &lt;span class="nb">exit&lt;/span> code based on
the outcome of the build &lt;span class="o">(&lt;/span>&lt;span class="nb">exit&lt;/span> code &lt;span class="m">0&lt;/span> indicates a success&lt;span class="o">)&lt;/span>
and interrupting the &lt;span class="nb">command&lt;/span> will interrupt the job.
With the -f option, this &lt;span class="nb">command&lt;/span> changes the &lt;span class="nb">exit&lt;/span> code based on
the outcome of the build &lt;span class="o">(&lt;/span>&lt;span class="nb">exit&lt;/span> code &lt;span class="m">0&lt;/span> indicates a success&lt;span class="o">)&lt;/span>
however, unlike -s, interrupting the &lt;span class="nb">command&lt;/span> will not interrupt
the job &lt;span class="o">(&lt;/span>&lt;span class="nb">exit&lt;/span> code &lt;span class="m">125&lt;/span> indicates the &lt;span class="nb">command&lt;/span> was interrupted&lt;span class="o">)&lt;/span>.
With the -c option, a build will only run &lt;span class="k">if&lt;/span> there has been
an SCM change.
JOB : Name of the job to build
-c : Check &lt;span class="k">for&lt;/span> SCM changes before starting the build, and &lt;span class="k">if&lt;/span> there&lt;span class="err">&amp;#39;&lt;/span>s no
change, &lt;span class="nb">exit&lt;/span> without doing a build
-f : Follow the build progress. Like -s only interrupts are not passed
through to the build.
-p : Specify the build parameters in the &lt;span class="nv">key&lt;/span>&lt;span class="o">=&lt;/span>value format.
-s : Wait &lt;span class="k">until&lt;/span> the completion/abortion of the command. Interrupts are passed
through to the build.
-v : Prints out the console output of the build. Use with -s
-w : Wait &lt;span class="k">until&lt;/span> the start of the &lt;span class="nb">command&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ssh">SSH&lt;/h3>
&lt;p>å¯ç”¨SSH, ä½¿ç”¨éšæœºç«¯å£. ä¹Ÿå¯ä»¥ä½¿ç”¨å›ºå®šç«¯å£:&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15232377732862.jpg" alt="">&lt;/p>
&lt;p>è·å–SSHç«¯å£å·:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -Lv http://localhost:8080/login 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="p">|&lt;/span> grep &lt;span class="s1">&amp;#39;X-SSH-Endpoint&amp;#39;&lt;/span>
&lt;span class="c1">#&amp;lt; X-SSH-Endpoint: localhost:46059&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”Ÿæˆssh key:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">ssh-keygen -t rsa -b &lt;span class="m">4096&lt;/span> -C &lt;span class="s2">&amp;#34;admin&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ·»åŠ sshå…¬é’¥:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">http://localhost:8080/user/admin/configure
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹ssh config, æ·»åŠ å¦‚ä¸‹é…ç½®:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">Host localhost
IdentityFile ~/.ssh/id_rsa_jenkins_cli
Port &lt;span class="m">46059&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éªŒè¯:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">ssh admin@localhost &lt;span class="nb">help&lt;/span>
add-job-to-view
Adds &lt;span class="nb">jobs&lt;/span> to view.
build
Builds a job, and optionally waits &lt;span class="k">until&lt;/span> its completion.
cancel-quiet-down
Cancel the effect of the &lt;span class="s2">&amp;#34;quiet-down&amp;#34;&lt;/span> command.
clear-queue
Clears the build queue.
connect-node
Reconnect to a node&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>
console
Retrieves console output of a build.
copy-job
Copies a job.
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15232435960672.jpg" alt="">&lt;/p></description></item><item><title>Jenkins - è§£å†³execute shellä¸­å¯åŠ¨çš„è¿›ç¨‹è¢«åœ¨Jobé€€å‡ºæ—¶è¢«æ€æ­»é—®é¢˜</title><link>https://atbug.com/resolve-process-be-killed-after-jenkins-job-done/</link><pubDate>Thu, 15 Mar 2018 17:00:25 +0000</pubDate><guid>https://atbug.com/resolve-process-be-killed-after-jenkins-job-done/</guid><description>
&lt;p>å› ä¸º&lt;a href="https://wiki.jenkins.io/display/JENKINS/ProcessTreeKiller">ProcessTreeKiller&lt;/a>çš„å­˜åœ¨, æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨shellå¯åŠ¨çš„è¿›ç¨‹åœ¨Jobå®Œæˆæ—¶éƒ½ä¼šè¢«killæ‰.&lt;/p>
&lt;p>å„ç§æœç´¢ä»¥åŠ&lt;a href="https://wiki.jenkins.io/display/JENKINS/ProcessTreeKiller">ProcessTreeKiller&lt;/a>æä¾›çš„è§£å†³æ–¹å¼æ˜¯ä¿®æ”¹&lt;code>BUILD_ID&lt;/code>å’Œæ·»åŠ &lt;code> -Dhudson.util.ProcessTree.disable=true&lt;/code>éƒ½æ— æ³•è§£å†³.&lt;/p>
&lt;p>æœ€åå‚è€ƒ&lt;a href="https://issues.jenkins-ci.org/browse/JENKINS-28182">StackOverflow&lt;/a>å’Œ&lt;a href="https://issues.jenkins-ci.org/browse/JENKINS-28182">Jenkins JIRA&lt;/a>, ä¿®æ”¹&lt;code>JENKINS_NODE_COOKIE&lt;/code>ä¸ºä»»ä½•å€¼, å¦‚&lt;code>dontKillMe&lt;/code>. è¿™ç§æ–¹æ³•å¯ä»¥è§£å†³, è®°å½•ä¸€ä¸‹. (æœç´¢æ’åé å‰çš„ç»“æœéƒ½ä¸å¯¹).&lt;/p></description></item><item><title>MacOSå®‰è£…minishift</title><link>https://atbug.com/install-minishift-on-mac/</link><pubDate>Fri, 23 Feb 2018 15:32:26 +0000</pubDate><guid>https://atbug.com/install-minishift-on-mac/</guid><description>
&lt;p>MacOSç¯å¢ƒå®‰è£…minishift&lt;/p>
&lt;h4 id="å®‰è£…minishift-cli">å®‰è£…minishift cli&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">brew cask install minishift
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ä½¿ç”¨virtualboxå®‰è£…">ä½¿ç”¨virtualboxå®‰è£…&lt;/h4>
&lt;p>å®‰è£…çš„æ—¶å€™å¯ä»¥æŒ‡å®šHTTPä»£ç†, æ‹‰å–å¢™å¤–é•œåƒæ—¶éœ€è¦; è¿˜å¯ä»¥æŒ‡å®šinsecureçš„é•œåƒåº“.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minishift start --docker-env &lt;span class="nv">HTTP_PROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.99.1:1087&amp;#34;&lt;/span> --docker-env &lt;span class="nv">HTTPS_PROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.99.1:1087&amp;#34;&lt;/span> --docker-env &lt;span class="nv">NO_PROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.0.0/16,172.30.0.0/16&amp;#34;&lt;/span> --insecure-registry&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.1.34&amp;#34;&lt;/span> --vm-driver&lt;span class="o">=&lt;/span>virtualbox
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å¯åŠ¨">å¯åŠ¨&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minishift start --vm-driver&lt;span class="o">=&lt;/span>virtualbox
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="åˆ é™¤">åˆ é™¤&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minishift delete
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="æ‰“å¼€openshiftæ§åˆ¶é¢æ¿">æ‰“å¼€Openshiftæ§åˆ¶é¢æ¿&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minishift dashboard
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="è·å–é›†ç¾¤ipåœ°å€">è·å–é›†ç¾¤ipåœ°å€&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minishift ip
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å®‰è£…openshift-cli">å®‰è£…Openshift Cli&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">brew install openshift-cli
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥ä½¿ç”¨openshift cliè¿›è¡Œæ“ä½œ. minishiftå®‰è£…å®Œæˆåä¼šå°†é…ç½®ä¿¡æ¯å†™å…¥åˆ°ä¸»æœºçš„ç”¨æˆ·ç›®å½•ä¸‹, &lt;code>$HOME/.kube&lt;/code>ç›®å½•ä¸‹é™¤äº†&lt;code>config&lt;/code>ä¿¡æ¯, è¿˜æœ‰openshiftçš„é›†ç¾¤ä¿¡æ¯åŠæ”¯æŒçš„api.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">oc login -u system:admin
oc get pods --all-namespaces
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Spring Cloud Zuulè¯¦è§£</title><link>https://atbug.com/spring-cloud-zuul-breakdown/</link><pubDate>Thu, 22 Feb 2018 17:02:26 +0000</pubDate><guid>https://atbug.com/spring-cloud-zuul-breakdown/</guid><description>
&lt;p>Spring Cloudå¯¹Netflix Zuulåšäº†å°è£…é›†æˆ, ä½¿å¾—åœ¨Spring Cloudç¯å¢ƒä¸­ä½¿ç”¨Zuulæ›´æ–¹ä¾¿. Netflix Zuulç›¸å…³åˆ†æè¯·çœ‹&lt;a href="http://atbug.com/learn-netflix-zuul/">ä¸Šä¸€ç¯‡&lt;/a>.&lt;/p>
&lt;h2 id="å®ç°">å®ç°&lt;/h2>
&lt;p>@EnableZuulProxy ä¸ @EnableZuulServer
äºŒè€…çš„åŒºåˆ«åœ¨äºå‰è€…ä½¿ç”¨äº†æœåŠ¡å‘ç°ä½œä¸ºè·¯ç”±å¯»å€, å¹¶ä½¿ç”¨Ribbonåšå®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡; åè€…æ²¡æœ‰ä½¿ç”¨.
Zuul serverçš„è·¯ç”±éƒ½é€šè¿‡&lt;code>ZuulProperties&lt;/code>è¿›è¡Œé…ç½®.&lt;/p>
&lt;h3 id="å…·ä½“å®ç°">å…·ä½“å®ç°:&lt;/h3>
&lt;ol>
&lt;li>ä½¿ç”¨&lt;code>ZuulController&lt;/code>(&lt;code>ServletWrappingController&lt;/code>çš„å­ç±»)å°è£…&lt;code>ZuulServlet&lt;/code>å®ä¾‹, å¤„ç†ä»&lt;code>DispatcherServlet&lt;/code>è¿›æ¥çš„è¯·æ±‚.&lt;/li>
&lt;li>&lt;code>ZuulHandlerMapping&lt;/code>è´Ÿè´£æ³¨å†Œhandler mapping, å°†&lt;code>Route&lt;/code>çš„&lt;code>fullPath&lt;/code>çš„è¯·æ±‚äº¤ç”±&lt;code>ZuulController&lt;/code>å¤„ç†.&lt;/li>
&lt;li>åŒæ—¶ä½¿ç”¨&lt;code>ServletRegistrationBean&lt;/code>æ³¨å†Œ&lt;code>ZuulServlet&lt;/code>, é»˜è®¤ä½¿ç”¨&lt;code>/zuul&lt;/code>ä½œä¸ºurlMapping. æ‰€æœ‰æ¥è‡ªä»¥&lt;code>/zuul&lt;/code>å¼€å¤´çš„pathçš„è¯·æ±‚éƒ½ä¼šç›´æ¥è¿›å…¥&lt;code>ZuulServlet&lt;/code>, ä¸ä¼šè¿›å…¥&lt;code>DispatcherServlet&lt;/code>.&lt;/li>
&lt;/ol>
&lt;h4 id="ä½¿ç”¨æ³¨è§£">ä½¿ç”¨æ³¨è§£&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>&lt;code>@EnableZuulProxy&lt;/code>å¼•å…¥äº†&lt;code>ZuulProxyMarkerConfiguration&lt;/code>, &lt;code>ZuulProxyMarkerConfiguration&lt;/code>åªåšäº†ä¸€ä»¶äº‹, å®ä¾‹åŒ–äº†å†…éƒ¨ç±»&lt;code>Marker&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ZuulProxyMarkerConfiguration&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Marker&lt;/span> &lt;span class="nf">zuulProxyMarkerBean&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Marker&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">class&lt;/span> &lt;span class="nc">Marker&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>@EnableZuulServer&lt;/code>å¼•å…¥äº†&lt;code>ZuulServerMarkerConfiguration&lt;/code>, &lt;code>ZuulServerMarkerConfiguration&lt;/code>ä¹Ÿåªåšäº†ä¸€ä»¶äº‹: å®ä¾‹åŒ–äº†å†…éƒ¨ç±»&lt;code>Marker&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ZuulServerMarkerConfiguration&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Marker&lt;/span> &lt;span class="nf">zuulServerMarkerBean&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Marker&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">class&lt;/span> &lt;span class="nc">Marker&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="enableautoconfiguration">EnableAutoConfiguration&lt;/h4>
&lt;p>é¡¹ç›®ä¸­ä½¿ç”¨&lt;code>@EnableAutoConfiguration&lt;/code>æ³¨è§£, å¼€å¯Springä¸Šä¸‹æ–‡å¯¹è±¡çš„è‡ªåŠ¨é…ç½®åŠŸèƒ½, å°è¯•å»çŒœæµ‹å’Œå®ä¾‹åŒ–ä½ &lt;strong>å¯èƒ½éœ€è¦çš„&lt;/strong>bean.&lt;/p>
&lt;p>è¿™ä¸ªåŠŸèƒ½æ˜¯åŸºäºclassPathæ¥å®Œæˆçš„. æ¯”å¦‚: é¡¹ç›®ä¸­å¼•ç”¨äº†&lt;code>tomcat-embedded.jar&lt;/code>, ä½ å¯èƒ½éœ€è¦ä¸€ä¸ª&lt;code>TomcatEmbeddedServletContainerFactory&lt;/code>å®ä¾‹, é™¤éå®šä¹‰äº†è‡ªå·±çš„&lt;code>EmbeddedServletContainerFactory&lt;/code>å®ä¾‹.&lt;/p>
&lt;p>æˆ‘ä»¬æ¥æ¥ç€çœ‹, åœ¨&lt;code>spring-cloud-netflix-core&lt;/code>çš„&lt;code>spring.factories&lt;/code>ä¸­çš„&lt;code>org.springframework.boot.autoconfigure.EnableAutoConfiguration&lt;/code>å®ç°ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°&lt;code>org.springframework.cloud.netflix.zuul.ZuulProxyAutoConfiguration&lt;/code>å’Œ&lt;code>org.springframework.cloud.netflix.zuul.ZuulServerAutoConfiguration&lt;/code>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ZuulServerAutoConfiguration
å®ƒçš„åˆå§‹åŒ–æ¡ä»¶æœ‰ä¸¤ä¸ª:&lt;/p>
&lt;ul>
&lt;li>&lt;code>@ConditionalOnClass(ZuulServlet.class)&lt;/code>æŒ‡å®šclasspathä¸­éœ€è¦æœ‰&lt;code>ZuulServlet.class&lt;/code>. è¿™ä¸ªservletè´Ÿè´£å¯¹æ‰€æœ‰è¿›å…¥Zuul serverçš„è¯·æ±‚ä»¥åŠé…ç½®åº”ç”¨æŒ‡å®šçš„&lt;code>preRoute&lt;/code>, &lt;code>route&lt;/code>, &lt;code>postRoute&lt;/code>å’Œ&lt;code>error&lt;/code>.&lt;/li>
&lt;li>&lt;code>@ConditionalOnBean(ZuulServerMarkerConfiguration.Marker.class)&lt;/code> ä¸&lt;code>@EnableZuulServer&lt;/code>æ³¨è§£å‘¼åº”.&lt;/li>
&lt;/ul>
&lt;p>â€‹&lt;code>java @Configuration @EnableConfigurationProperties({ ZuulProperties.class }) @ConditionalOnClass(ZuulServlet.class) @ConditionalOnBean(ZuulServerMarkerConfiguration.Marker.class) // Make sure to get the ServerProperties from the same place as a normal web app would @Import(ServerPropertiesAutoConfiguration.class) public class ZuulServerAutoConfiguration { ... } â€‹&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ZuulProxyAutoConfiguration
å®ƒæœ‰ä¸€ä¸ªåˆå§‹åŒ–çš„æ¡ä»¶&lt;code>@ConditionalOnBean(ZuulProxyMarkerConfiguration.Marker.class)&lt;/code>, å°±æ˜¯ä¸Šä¸‹æ–‡ä¸­éœ€è¦æœ‰&lt;code>ZuulProxyMarkerConfiguration.Marker&lt;/code>è¿™ä¸ªå†…éƒ¨ç±»çš„bean. ä¸&lt;code>@EnableZuulProxy&lt;/code>æ³¨è§£å‘¼åº”.&lt;/p>
&lt;p>åˆå§‹åŒ–åŒ…æ‹¬å†…ç½®çš„filter, ä»¥åŠDiscovery, Ribbonç­‰çš„åˆå§‹åŒ–.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="nd">@Import&lt;/span>&lt;span class="o">({&lt;/span> &lt;span class="n">RibbonCommandFactoryConfiguration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">RestClientRibbonConfiguration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">RibbonCommandFactoryConfiguration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">OkHttpRibbonConfiguration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">RibbonCommandFactoryConfiguration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">HttpClientRibbonConfiguration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span> &lt;span class="o">})&lt;/span>
&lt;span class="nd">@ConditionalOnBean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ZuulProxyMarkerConfiguration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Marker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ZuulProxyAutoConfiguration&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">ZuulServerAutoConfiguration&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>â€‹&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h5 id="zuulserverautoconfiguration-è¯¦è§£">ZuulServerAutoConfiguration è¯¦è§£&lt;/h5>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="c1">//å£°æ˜é…ç½®
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="c1">//é…ç½®ZuulPropertieså®ä¾‹
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nd">@EnableConfigurationProperties&lt;/span>&lt;span class="o">({&lt;/span> &lt;span class="n">ZuulProperties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span> &lt;span class="o">})&lt;/span>
&lt;span class="c1">//æ¡ä»¶1 å­˜åœ¨ZuulServlet.class
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nd">@ConditionalOnClass&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ZuulServlet&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="c1">//æ¡ä»¶2 å­˜åœ¨ZuulServerMarkerConfiguration.Marker.class bean, å³åº”ç”¨ä½¿ç”¨@EnableZuulServeræ³¨è§£
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nd">@ConditionalOnBean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ZuulServerMarkerConfiguration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Marker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="c1">//é…ç½®ServerPropertieså®ä¾‹
&lt;/span>&lt;span class="c1">// Make sure to get the ServerProperties from the same place as a normal web app would
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nd">@Import&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ServerPropertiesAutoConfiguration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ZuulServerAutoConfiguration&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">protected&lt;/span> &lt;span class="n">ZuulProperties&lt;/span> &lt;span class="n">zuulProperties&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">protected&lt;/span> &lt;span class="n">ServerProperties&lt;/span> &lt;span class="n">server&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">required&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">ErrorController&lt;/span> &lt;span class="n">errorController&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">HasFeatures&lt;/span> &lt;span class="nf">zuulFeature&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">HasFeatures&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">namedFeature&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Zuul (Simple)&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ZuulServerAutoConfiguration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//å¤åˆç»“æ„çš„RouteLocator
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nd">@Bean&lt;/span>
&lt;span class="nd">@Primary&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">CompositeRouteLocator&lt;/span> &lt;span class="nf">primaryRouteLocator&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="n">Collection&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">RouteLocator&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">routeLocators&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">CompositeRouteLocator&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">routeLocators&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//æ²¡æœ‰SimpleRouteLocator.classçš„beanæ—¶, ä½¿ç”¨zuulPropertieså®ä¾‹åŒ–ä¸€ä¸ªSimpleRouteLocatorå®ä¾‹.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nd">@Bean&lt;/span>
&lt;span class="nd">@ConditionalOnMissingBean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SimpleRouteLocator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">SimpleRouteLocator&lt;/span> &lt;span class="nf">simpleRouteLocator&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SimpleRouteLocator&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">server&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getServletPrefix&lt;/span>&lt;span class="o">(),&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">zuulProperties&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//zuulController, åŒ…è£…äº†ä¸€ä¸ªZuulServletç±»å‹çš„servlet, å®ç°å¯¹ZuulServletç±»å‹çš„servletçš„åˆå§‹åŒ–.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">ZuulController&lt;/span> &lt;span class="nf">zuulController&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ZuulController&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">ZuulHandlerMapping&lt;/span> &lt;span class="nf">zuulHandlerMapping&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RouteLocator&lt;/span> &lt;span class="n">routes&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ZuulHandlerMapping&lt;/span> &lt;span class="n">mapping&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ZuulHandlerMapping&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">routes&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">zuulController&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="n">mapping&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setErrorController&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">errorController&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">mapping&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">ApplicationListener&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ApplicationEvent&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">zuulRefreshRoutesListener&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ZuulRefreshListener&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="nd">@ConditionalOnMissingBean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;zuulServlet&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">ServletRegistrationBean&lt;/span> &lt;span class="nf">zuulServlet&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ServletRegistrationBean&lt;/span> &lt;span class="n">servlet&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ServletRegistrationBean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">ZuulServlet&lt;/span>&lt;span class="o">(),&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">zuulProperties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getServletPattern&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="c1">// The whole point of exposing this servlet is to provide a route that doesn&amp;#39;t
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// buffer requests.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">servlet&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">addInitParameter&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;buffer-requests&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">servlet&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// pre filters
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">ServletDetectionFilter&lt;/span> &lt;span class="nf">servletDetectionFilter&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ServletDetectionFilter&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">FormBodyWrapperFilter&lt;/span> &lt;span class="nf">formBodyWrapperFilter&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">FormBodyWrapperFilter&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">DebugFilter&lt;/span> &lt;span class="nf">debugFilter&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">DebugFilter&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Servlet30WrapperFilter&lt;/span> &lt;span class="nf">servlet30WrapperFilter&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Servlet30WrapperFilter&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// post filters
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">SendResponseFilter&lt;/span> &lt;span class="nf">sendResponseFilter&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SendResponseFilter&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">SendErrorFilter&lt;/span> &lt;span class="nf">sendErrorFilter&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SendErrorFilter&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">SendForwardFilter&lt;/span> &lt;span class="nf">sendForwardFilter&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SendForwardFilter&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="nd">@ConditionalOnProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;zuul.ribbon.eager-load.enabled&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">matchIfMissing&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">ZuulRouteApplicationContextInitializer&lt;/span> &lt;span class="nf">zuulRoutesApplicationContextInitiazer&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="n">SpringClientFactory&lt;/span> &lt;span class="n">springClientFactory&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ZuulRouteApplicationContextInitializer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">springClientFactory&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">zuulProperties&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="kd">protected&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ZuulFilterConfiguration&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ZuulFilter&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">filters&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">ZuulFilterInitializer&lt;/span> &lt;span class="nf">zuulFilterInitializer&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="n">CounterFactory&lt;/span> &lt;span class="n">counterFactory&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TracerFactory&lt;/span> &lt;span class="n">tracerFactory&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">FilterLoader&lt;/span> &lt;span class="n">filterLoader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FilterLoader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInstance&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">FilterRegistry&lt;/span> &lt;span class="n">filterRegistry&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FilterRegistry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">instance&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ZuulFilterInitializer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">filters&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">counterFactory&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">tracerFactory&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">filterLoader&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">filterRegistry&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="nd">@ConditionalOnClass&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">CounterService&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">protected&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ZuulCounterFactoryConfiguration&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="nd">@ConditionalOnBean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">CounterService&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">CounterFactory&lt;/span> &lt;span class="nf">counterFactory&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">CounterService&lt;/span> &lt;span class="n">counterService&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">DefaultCounterFactory&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">counterService&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="kd">protected&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ZuulMetricsConfiguration&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="nd">@ConditionalOnMissingBean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">CounterFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">CounterFactory&lt;/span> &lt;span class="nf">counterFactory&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">EmptyCounterFactory&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@ConditionalOnMissingBean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">TracerFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">TracerFactory&lt;/span> &lt;span class="nf">tracerFactory&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">EmptyTracerFactory&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ZuulRefreshListener&lt;/span>
&lt;span class="kd">implements&lt;/span> &lt;span class="n">ApplicationListener&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ApplicationEvent&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">ZuulHandlerMapping&lt;/span> &lt;span class="n">zuulHandlerMapping&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">HeartbeatMonitor&lt;/span> &lt;span class="n">heartbeatMonitor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">HeartbeatMonitor&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">onApplicationEvent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ApplicationEvent&lt;/span> &lt;span class="n">event&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">event&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">ContextRefreshedEvent&lt;/span>
&lt;span class="o">||&lt;/span> &lt;span class="n">event&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">RefreshScopeRefreshedEvent&lt;/span>
&lt;span class="o">||&lt;/span> &lt;span class="n">event&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">RoutesRefreshedEvent&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">zuulHandlerMapping&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setDirty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">event&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">HeartbeatEvent&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">heartbeatMonitor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">update&lt;/span>&lt;span class="o">(((&lt;/span>&lt;span class="n">HeartbeatEvent&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">event&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="o">()))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">zuulHandlerMapping&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setDirty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="zuulproxyautoconfiguration-è¯¦è§£">ZuulProxyAutoConfiguration è¯¦è§£&lt;/h5>
&lt;pre>&lt;code>â€‹```java
//å£°æ˜é…ç½®
@Configuration
//å¼•å…¥RibbonCommandFactoryé…ç½®
@Import({ RibbonCommandFactoryConfiguration.RestClientRibbonConfiguration.class,
RibbonCommandFactoryConfiguration.OkHttpRibbonConfiguration.class,
RibbonCommandFactoryConfiguration.HttpClientRibbonConfiguration.class,
HttpClientConfiguration.class })
//é…ç½®ç”Ÿæ•ˆæ¡ä»¶
@ConditionalOnBean(ZuulProxyMarkerConfiguration.Marker.class)
public class ZuulProxyAutoConfiguration extends ZuulServerAutoConfiguration {
@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)
@Autowired(required = false)
private List&amp;lt;RibbonRequestCustomizer&amp;gt; requestCustomizers = Collections.emptyList();
//ç½‘å…³æœåŠ¡æ³¨å†Œå®ä¾‹ä¿¡æ¯
@Autowired(required = false)
private Registration registration;
//æœåŠ¡å‘ç°å®¢æˆ·ç«¯
@Autowired
private DiscoveryClient discovery;
//serviceIdå’Œè·¯ç”±çš„æ˜ å°„é€»è¾‘, é»˜è®¤ä¸ºç›¸åŒ
@Autowired
private ServiceRouteMapper serviceRouteMapper;
@Override
public HasFeatures zuulFeature() {
return HasFeatures.namedFeature(&amp;quot;Zuul (Discovery)&amp;quot;,
ZuulProxyAutoConfiguration.class);
}
//é™æ€å’ŒåŠ¨æ€è·¯ç”±å¯»å€: é™æ€ä»é…ç½®æ–‡ä»¶è·å–, åŠ¨æ€é€šè¿‡æœåŠ¡å‘ç°å®¢æˆ·ç«¯å®Œæˆ. åè€…ä¼˜å…ˆçº§æ›´é«˜
@Bean
@ConditionalOnMissingBean(DiscoveryClientRouteLocator.class)
public DiscoveryClientRouteLocator discoveryRouteLocator() {
return new DiscoveryClientRouteLocator(this.server.getServletPrefix(),
this.discovery, this.zuulProperties, this.serviceRouteMapper, this.registration);
}
//è£…é¥°è¿‡æ»¤å™¨
// pre filters
@Bean
public PreDecorationFilter preDecorationFilter(RouteLocator routeLocator,
ProxyRequestHelper proxyRequestHelper) {
return new PreDecorationFilter(routeLocator, this.server.getServletPrefix(),
this.zuulProperties, proxyRequestHelper);
}
//åŸºäºRibbonè·¯ç”±è¿‡æ»¤å™¨
// route filters
@Bean
public RibbonRoutingFilter ribbonRoutingFilter(ProxyRequestHelper helper,
RibbonCommandFactory&amp;lt;?&amp;gt; ribbonCommandFactory) {
RibbonRoutingFilter filter = new RibbonRoutingFilter(helper, ribbonCommandFactory,
this.requestCustomizers);
return filter;
}
//åŸºäºhostçš„è·¯ç”±è¿‡æ»¤å™¨
@Bean
@ConditionalOnMissingBean({SimpleHostRoutingFilter.class, CloseableHttpClient.class})
public SimpleHostRoutingFilter simpleHostRoutingFilter(ProxyRequestHelper helper,
ZuulProperties zuulProperties,
ApacheHttpClientConnectionManagerFactory connectionManagerFactory,
ApacheHttpClientFactory httpClientFactory) {
return new SimpleHostRoutingFilter(helper, zuulProperties,
connectionManagerFactory, httpClientFactory);
}
@Bean
@ConditionalOnMissingBean({SimpleHostRoutingFilter.class})
public SimpleHostRoutingFilter simpleHostRoutingFilter2(ProxyRequestHelper helper,
ZuulProperties zuulProperties,
CloseableHttpClient httpClient) {
return new SimpleHostRoutingFilter(helper, zuulProperties,
httpClient);
}
//æœåŠ¡å‘ç°å¯»å€åˆ·æ–°ç›‘å¬å™¨
@Bean
public ApplicationListener&amp;lt;ApplicationEvent&amp;gt; zuulDiscoveryRefreshRoutesListener() {
return new ZuulDiscoveryRefreshListener();
}
@Bean
@ConditionalOnMissingBean(ServiceRouteMapper.class)
public ServiceRouteMapper serviceRouteMapper() {
return new SimpleServiceRouteMapper();
}
@Configuration
@ConditionalOnMissingClass(&amp;quot;org.springframework.boot.actuate.endpoint.Endpoint&amp;quot;)
protected static class NoActuatorConfiguration {
@Bean
public ProxyRequestHelper proxyRequestHelper(ZuulProperties zuulProperties) {
ProxyRequestHelper helper = new ProxyRequestHelper();
helper.setIgnoredHeaders(zuulProperties.getIgnoredHeaders());
helper.setTraceRequestBody(zuulProperties.isTraceRequestBody());
return helper;
}
}
@Configuration
@ConditionalOnClass(Endpoint.class)
protected static class EndpointConfiguration {
@Autowired(required = false)
private TraceRepository traces;
@ConditionalOnEnabledEndpoint(&amp;quot;routes&amp;quot;)
@Bean
public RoutesEndpoint routesEndpoint(RouteLocator routeLocator) {
return new RoutesEndpoint(routeLocator);
}
@ConditionalOnEnabledEndpoint(&amp;quot;routes&amp;quot;)
@Bean
public RoutesMvcEndpoint routesMvcEndpoint(RouteLocator routeLocator,
RoutesEndpoint endpoint) {
return new RoutesMvcEndpoint(endpoint, routeLocator);
}
@ConditionalOnEnabledEndpoint(&amp;quot;filters&amp;quot;)
@Bean
public FiltersEndpoint filtersEndpoint() {
FilterRegistry filterRegistry = FilterRegistry.instance();
return new FiltersEndpoint(filterRegistry);
}
@Bean
public ProxyRequestHelper proxyRequestHelper(ZuulProperties zuulProperties) {
TraceProxyRequestHelper helper = new TraceProxyRequestHelper();
if (this.traces != null) {
helper.setTraces(this.traces);
}
helper.setIgnoredHeaders(zuulProperties.getIgnoredHeaders());
helper.setTraceRequestBody(zuulProperties.isTraceRequestBody());
return helper;
}
}
private static class ZuulDiscoveryRefreshListener
implements ApplicationListener&amp;lt;ApplicationEvent&amp;gt; {
private HeartbeatMonitor monitor = new HeartbeatMonitor();
@Autowired
private ZuulHandlerMapping zuulHandlerMapping;
@Override
public void onApplicationEvent(ApplicationEvent event) {
if (event instanceof InstanceRegisteredEvent) {
reset();
}
else if (event instanceof ParentHeartbeatEvent) {
ParentHeartbeatEvent e = (ParentHeartbeatEvent) event;
resetIfNeeded(e.getValue());
}
else if (event instanceof HeartbeatEvent) {
HeartbeatEvent e = (HeartbeatEvent) event;
resetIfNeeded(e.getValue());
}
}
private void resetIfNeeded(Object value) {
if (this.monitor.update(value)) {
reset();
}
}
private void reset() {
this.zuulHandlerMapping.setDirty(true);
}
}
}
â€‹```
&lt;/code>&lt;/pre>
&lt;h2 id="é…ç½®é¡¹">é…ç½®é¡¹&lt;/h2>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15192869619623.jpg" alt="">&lt;/p>
&lt;h4 id="zuulservletpath">zuul.servletPath&lt;/h4>
&lt;p>é»˜è®¤ä¸º*/zuul*, æ³¨å†ŒZuulServletçš„æ—¶å€™ä½œä¸ºurlMappingä½¿ç”¨. å³æ‰€æœ‰æ¥è‡ªä»¥*/zuul*å¼€å¤´çš„pathéƒ½ä¼šç”±ZuulServletå¤„ç†.&lt;/p>
&lt;h4 id="zuulignoredpatterns">zuul.ignoredPatterns&lt;/h4>
&lt;p>Zuulä½¿ç”¨&lt;code>ZuulController&lt;/code>å°è£…äº†&lt;code>ZuulServlet&lt;/code>. æ‰€æœ‰è¿›å…¥Zuulçš„è¯·æ±‚çš„å…¥å£éƒ½æ˜¯&lt;code>ZuulController&lt;/code>.
&lt;code>ZuulController&lt;/code>çš„&lt;code>ZuulHandlerMapping&lt;/code>é»˜è®¤æŠŠ&lt;code>zuul.routes.[ITEM].path&lt;/code>çš„è¯·æ±‚äº¤ç»™&lt;code>ZuulServlet&lt;/code>å¤„ç†. å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„pathçš„route, åˆ™ä¼šèµ°å…¶ä»–çš„&lt;code>DispatcherServlet&lt;/code>&lt;/p>
&lt;p>&lt;code>zuul.ignoredPatterns&lt;/code>ä½œç”¨å°±æ˜¯è¿›å…¥Zuulçš„è¯·æ±‚, åªè¦matchéƒ½ä¼šç›´æ¥äº¤ç”±å…¶ä»–çš„&lt;code>DispatcherServlet&lt;/code>å¤„ç†, è€Œä¸éœ€è¦å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”pathçš„route.&lt;/p>
&lt;p>&amp;hellip;&lt;/p>
&lt;h2 id="è¿‡æ»¤å™¨">è¿‡æ»¤å™¨&lt;/h2>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15192707341614.jpg" alt="">&lt;/p>
&lt;h3 id="zuulserverautoconfiguration">ZuulServerAutoConfiguration&lt;/h3>
&lt;h4 id="servletdetectionfilter">ServletDetectionFilter&lt;/h4>
&lt;p>æ£€æŸ¥è¯·æ±‚çš„å…¥å£æ˜¯&lt;code>DispatcherServlet&lt;/code>è¿˜æ˜¯&lt;code>ZuulServlet&lt;/code>
å¦‚æœæ˜¯&lt;code>DispatcherServlet&lt;/code>è¿›æ¥çš„è¯·æ±‚, å°†&lt;code>RequestContext&lt;/code>ä¸­çš„å±æ€§&lt;code>isDispatcherServletRequest&lt;/code>è®¾ç½®ä¸ºture.&lt;/p>
&lt;p>æ£€æŸ¥çš„æ–¹æ³•æ˜¯åˆ¤æ–­&lt;code>RequestContext&lt;/code>ä¸­çš„è¯·æ±‚ç±»å‹æ˜¯å¦ä¸º&lt;code>HttpServletRequestWrapper&lt;/code>ç±»å‹, å› ä¸º&lt;code>ZuulServlet&lt;/code>è¿›æ¥çš„è¯·æ±‚ä¼šä½¿ç”¨&lt;code>HttpServletRequestWrapper&lt;/code>è¿›è¡Œå†æ¬¡å°è£…; åŒæ—¶æ£€æŸ¥è¯·æ±‚ä¸­ä¸­æ˜¯å¦æœ‰&lt;code>DispatcherServlet.CONTEXT&lt;/code>å±æ€§, å› ä¸º&lt;code>DispatcherServlet&lt;/code>è¿›æ¥çš„è¯·æ±‚ä¼šå¸¦æœ‰è¯¥å±æ€§.&lt;/p>
&lt;h4 id="formbodywrapperfilter">FormBodyWrapperFilter&lt;/h4>
&lt;p>ä¸ºä¸‹æ¸¸çš„æœåŠ¡è§£æè¡¨å•æ•°æ®, å¹¶é‡æ–°ç¼–ç . åªé’ˆå¯¹multipart/form-dataå’Œapplication/x-www-form-urlencodedç±»å‹çš„è¯·æ±‚.&lt;/p>
&lt;h4 id="debugfilter">DebugFilter&lt;/h4>
&lt;p>é€šè¿‡è®¾ç½®&lt;code>zuul.debug.parameter&lt;/code>å±æ€§æ§åˆ¶, é»˜è®¤å¯ç”¨.
æ‰§è¡Œæ—¶å°†ä¸Šä¸‹æ–‡ä¸­çš„&lt;code>debugRouting&lt;/code>å’Œ&lt;code>debugRequest&lt;/code>è®¾ç½®ä¸º&lt;code>true&lt;/code>&lt;/p>
&lt;h4 id="servlet30wrapperfilter">Servlet30WrapperFilter&lt;/h4>
&lt;p>ä½¿ç”¨&lt;code>Servlet30RequestWrapper&lt;/code>å°è£…è¯·æ±‚, å¼ºåˆ¶å¯ç”¨.&lt;/p>
&lt;h4 id="sendresponsefilter">SendResponseFilter&lt;/h4>
&lt;p>åæ‰§è¡Œçš„è¿‡æ»¤å™¨, è´Ÿè´£å°†ä»£ç†è¯·æ±‚çš„å“åº”å†™å…¥å½“å‰çš„è¯·æ±‚çš„å“åº”ä¸­.&lt;/p>
&lt;h3 id="zuulproxyautoconfiguration">ZuulProxyAutoConfiguration&lt;/h3>
&lt;h4 id="predecorationfilter">PreDecorationFilter&lt;/h4>
&lt;p>Preç±»å‹çš„è¿‡æ»¤å™¨, é€šè¿‡æä¾›çš„RouteLocatorå†³å®šå°†å¦‚ä½•è¯·æ±‚è·¯ç”±åˆ°å“ªé‡Œå’Œå¦‚ä½•è·¯ç”±. åŒæ—¶ä¸ºä¸‹æ¸¸è¯·æ±‚æ·»åŠ å¤šä¸ªä¸ä»£ç†ç›¸å…³çš„å¤´ä¿¡æ¯. å½“&lt;code>RequestContext&lt;/code>ä¸­ä¸å­˜åœ¨&lt;code>FORWARD_TO_KEY&lt;/code>å’Œ&lt;code>SERVICE_ID_KEY&lt;/code>ä¿¡æ¯æ—¶ç”Ÿæ•ˆ.&lt;/p>
&lt;p>å°†è·¯ç”±åˆ¤æ–­ç»“æœå†™å…¥&lt;code>routeHost&lt;/code>, &lt;code>FORWARD_TO_KEY&lt;/code>æˆ–è€…&lt;code>SERVICE_ID_KEY&lt;/code>.&lt;/p>
&lt;h4 id="ribbonroutingfilter">RibbonRoutingFilter&lt;/h4>
&lt;p>Routeç±»å‹çš„è¿‡æ»¤å™¨, å½“&lt;code>RequestContext&lt;/code>ä¸­&lt;code>routeHost&lt;/code>ä¸ºç©º, ä¸”æœ‰&lt;code>serviceId&lt;/code>å€¼æ—¶ç”Ÿæ•ˆ.&lt;/p>
&lt;p>ä½¿ç”¨&lt;code>RequestContext&lt;/code>æ„å»º&lt;code>RibbonCommandContext&lt;/code>, é€šè¿‡&lt;code>RibbonCommandFactory&lt;/code>è¿›è€Œåˆ›å»º&lt;code>RibbonCommand&lt;/code>å¹¶æ‰§è¡Œ. æœ€åé€šè¿‡&lt;code>ProxyRequestHelper&lt;/code>å°†å“åº”ç»“æœè®°å½•åˆ°&lt;code>RequestContext&lt;/code>ä¸­.&lt;/p>
&lt;h4 id="simplehostroutingfilter">SimpleHostRoutingFilter&lt;/h4>
&lt;p>Routeç±»å‹çš„è¿‡æ»¤å™¨, å½“&lt;code>RequestContext&lt;/code>ä¸­çš„&lt;code>routeHost&lt;/code>ä¸ä¸ºç©ºæ—¶ç”Ÿæ•ˆ. ä½¿ç”¨Apacheçš„HttpClientå‘é€è¯·æ±‚&lt;/p>
&lt;h2 id="ç›‘å¬å™¨">ç›‘å¬å™¨&lt;/h2>
&lt;h4 id="zuulrefreshlistener">ZuulRefreshListener&lt;/h4>
&lt;p>é€šè¿‡ç›‘å¬åº”ç”¨ç¨‹åºäº‹ä»¶(&lt;code>ContextRefreshedEvent&lt;/code>, &lt;code>RefreshScopeRefreshedEvent&lt;/code>, &lt;code>RoutesRefreshedEvent&lt;/code>å’Œ&lt;code>RoutesRefreshedEvent&lt;/code>)æ›´æ–°handler mappingçš„æ³¨å†Œä¿¡æ¯. å‰ä¸¤ä¸ªäº‹ä»¶åœ¨&lt;code>ContextRefresh&lt;/code>æ—¶å‘å‡º; ç¬¬ä¸‰ä¸ªæ˜¯é€šè¿‡JMXé‡ç½®è·¯ç”±æ—¶å‘å‡º(å‚è€ƒ&lt;code>RoutesMvcEndpoint&lt;/code>); æœ€åä¸€ä¸ªæ˜¯&lt;code>DiscoveryClient&lt;/code>æ¯æ¬¡æ‹‰å–æœåŠ¡æ³¨å†Œä¿¡æ¯åå‘å‡º.&lt;/p>
&lt;p>æ”¶åˆ°äº‹ä»¶å, å°†&lt;code>ZuulHandlerMapping&lt;/code>çš„&lt;code>dirty&lt;/code>å˜é‡ç½®ä¸º&lt;code>true&lt;/code>, å½“ä¸‹æ¬¡è¯·æ±‚è¿›æ¥æ—¶, æ£€æŸ¥åˆ°&lt;code>dirty&lt;/code>ä¸º&lt;code>true&lt;/code>, å°±ä¼šé‡æ–°æ³¨å†Œurl mapping.&lt;/p>
&lt;h4 id="zuuldiscoveryrefreshlistener">ZuulDiscoveryRefreshListener&lt;/h4>
&lt;p>ç›‘å¬åº”ç”¨ç¨‹åºäº‹ä»¶(&lt;code>InstanceRegisteredEvent&lt;/code>, &lt;code>ParentHeartbeatEvent&lt;/code>å’Œ&lt;code>HeartbeatEvent&lt;/code>)æ›´æ–°handler mappingçš„æ³¨å†Œä¿¡æ¯.&lt;/p>
&lt;p>&lt;code>InstanceRegisteredEvent&lt;/code>å½“å‰è·¯ç”±æœåŠ¡å®ä¾‹å®ŒæˆæœåŠ¡æ³¨å†Œåå‘å‡ºçš„äº‹ä»¶.
&lt;code>ParentHeartbeatEvent&lt;/code>å½“&lt;code>DiscoveryClient&lt;/code>å®šä½åˆ°&lt;em>Config Server&lt;/em>æœåŠ¡çš„æ—¶å€™æœ‰&lt;code>bootstrapContext&lt;/code>å‘ç»™åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡çš„äº‹ä»¶.
&lt;code>HeartbeatEvent&lt;/code>ç”±&lt;code>DiscoveryClient&lt;/code>æ¯æ¬¡æ‹‰å–æœåŠ¡æ³¨å†Œä¿¡æ¯åå‘å‡º.&lt;/p></description></item><item><title>Spring Cloud - EurekaæœåŠ¡æ³¨å†Œ</title><link>https://atbug.com/spring-cloud-service-registry-via-eureka/</link><pubDate>Wed, 14 Feb 2018 07:32:43 +0000</pubDate><guid>https://atbug.com/spring-cloud-service-registry-via-eureka/</guid><description>
&lt;p>ä¹‹å‰åˆ†æè¿‡&lt;a href="http://atbug.com/spring-cloud-eureka-client-source-code-analysis/">Spring Cloudçš„EurekaæœåŠ¡å‘ç°&lt;/a>, ä»Šå¤©åˆ†æä¸€ä¸‹æœåŠ¡æ³¨å†Œ.&lt;/p>
&lt;h2 id="é…ç½®">é…ç½®&lt;/h2>
&lt;h3 id="bootstrapconfiguration">BootstrapConfiguration&lt;/h3>
&lt;h4 id="eurekadiscoveryclientconfigservicebootstrapconfiguration">EurekaDiscoveryClientConfigServiceBootstrapConfiguration&lt;/h4>
&lt;p>spring-cloud-configç¯å¢ƒä¸­ä½¿ç”¨çš„é…ç½®&lt;/p>
&lt;p>å¼•å…¥&lt;code>EurekaDiscoveryClientConfiguration&lt;/code>å’Œ&lt;code>EurekaClientAutoConfiguration&lt;/code>&lt;/p>
&lt;h5 id="eurekadiscoveryclientconfiguration">EurekaDiscoveryClientConfiguration&lt;/h5>
&lt;ol>
&lt;li>åœ¨spring-cloudä¸­(é€šè¿‡æ˜¯å¦å­˜åœ¨RefreshScopeRefreshedEvent.classåˆ¤æ–­), æ·»åŠ &lt;code>RefreshScopeRefreshedEvent&lt;/code>çš„listener. æ”¶åˆ°äº‹ä»¶åé‡æ–°æ³¨å†Œå®ä¾‹.&lt;/li>
&lt;li>åœ¨&lt;code>eureka.client.healthcheck.enabled&lt;/code>è®¾ç½®ä¸ºtrueæ—¶, æ³¨å†Œ&lt;code>EurekaHealthCheckHandler&lt;/code>bean. &lt;code>EurekaHealthCheckHandler&lt;/code>è´Ÿè´£å°†åº”ç”¨çŠ¶æ€æ˜ å°„ä¸ºå®ä¾‹çŠ¶æ€&lt;code>InstanceStatus&lt;/code>.&lt;/li>
&lt;/ol>
&lt;h5 id="eurekaclientautoconfiguration">EurekaClientAutoConfiguration&lt;/h5>
&lt;p>æ”¯æŒspring-cloudå’Œéspring-cloudç¯å¢ƒ, åœ¨spring-cloudç¯å¢ƒä¸­, ä¸‹é¢ä¸¤ä¸ªbeanè¦ä½¿ç”¨&lt;code>@RefreshScope&lt;/code>æ ‡æ³¨&lt;/p>
&lt;ol>
&lt;li>å®ä¾‹åŒ–&lt;code>EurekaClient&lt;/code>bean, åœ¨spring-cloudä¸­ä½¿ç”¨å®ç°ç±»&lt;code>CloudEurekaClient&lt;/code>.&lt;/li>
&lt;li>ä½¿ç”¨&lt;code>EurekaInstanceConfig&lt;/code>å®ä¾‹, å®ä¾‹åŒ–&lt;code>ApplicationInfoManager&lt;/code>bean&lt;/li>
&lt;/ol>
&lt;h3 id="enableautoconfiguration">EnableAutoConfiguration&lt;/h3>
&lt;h4 id="eurekaclientconfigserverautoconfiguration">EurekaClientConfigServerAutoConfiguration&lt;/h4>
&lt;p>åœ¨spring-cloud-configçš„ç¯å¢ƒä¸­, å°†&lt;code>configPath&lt;/code>åŠ å…¥åˆ°å®ä¾‹çš„metadata mapä¸­.&lt;/p>
&lt;h4 id="eurekadiscoveryclientconfigserviceautoconfiguration">EurekaDiscoveryClientConfigServiceAutoConfiguration&lt;/h4>
&lt;p>å½“configå®¢æˆ·ç«¯å¸Œæœ›é€šè¿‡æœåŠ¡å‘ç°å¯»æ‰¾configæœåŠ¡çš„æ—¶å€™ä½¿ç”¨çš„å¼•å¯¼é…ç½®&lt;/p>
&lt;p>åœ¨&lt;code>spring.cloud.config.discovery.enabled&lt;/code>ä¸º&lt;code>true&lt;/code>æ—¶, å…³é—­çˆ¶application contexté‡Œå®ä¾‹åŒ–çš„&lt;code>EurekaClient&lt;/code>å®ä¾‹. åªä½¿ç”¨å½“å‰ä¸Šä¸‹æ–‡é‡Œçš„å®ä¾‹.&lt;/p>
&lt;h4 id="eurekaclientautoconfiguration-1">EurekaClientAutoConfiguration&lt;/h4>
&lt;p>&lt;strong>æ ¸å¿ƒé…ç½®&lt;/strong>
æ”¯æŒspring-cloud(æ”¯æŒåŠ¨æ€é…ç½®)å’Œéspring-cloudç¯å¢ƒ, &lt;code>EurekaClient&lt;/code>å’Œ&lt;code>EurekaInstanceConfig&lt;/code>ä¸¤ä¸ªbeanè¦ä½¿ç”¨&lt;code>@RefreshScope&lt;/code>æ ‡æ³¨&lt;/p>
&lt;ol>
&lt;li>å®ä¾‹åŒ–å½“å‰æœåŠ¡å®ä¾‹ä¿¡æ¯&lt;code>EurekaInstanceConfigBean&lt;/code>çš„å®ä¾‹&lt;/li>
&lt;li>å®ä¾‹åŒ–&lt;code>DiscoveryClient&lt;/code>çš„å®ç°, åœ¨è¿™é‡Œæ˜¯&lt;code>EurekaDiscoveryClient&lt;/code>&lt;/li>
&lt;li>å®ä¾‹åŒ–&lt;code>EurekaServiceRegistry&lt;/code>&lt;/li>
&lt;li>å®ä¾‹åŒ–&lt;code>EurekaRegistration&lt;/code>&lt;/li>
&lt;li>å®ä¾‹åŒ–&lt;code>EurekaAutoServiceRegistration&lt;/code>, è¿™ä¸ªç±»å®ç°äº†StartLifecycleæ¥å£. åœ¨ApplicationContext refreshæˆ–è€…shutdownä¹‹åæ³¨å†Œæˆ–è€…æ³¨é”€å½“å‰å®ä¾‹&lt;/li>
&lt;li>å®ä¾‹åŒ–&lt;code>EurekaClient&lt;/code>bean, åœ¨spring-cloudä¸­ä½¿ç”¨å®ç°ç±»&lt;code>CloudEurekaClient&lt;/code>&lt;/li>
&lt;li>ä½¿ç”¨&lt;code>EurekaInstanceConfig&lt;/code>å®ä¾‹, å®ä¾‹åŒ–&lt;code>ApplicationInfoManager&lt;/code>bean&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15185619590053.jpg" alt="EurekaClientAutoConfiguration">&lt;/p>
&lt;h4 id="ribboneurekaautoconfiguration">RibbonEurekaAutoConfiguration&lt;/h4>
&lt;p>å½“å¯ç”¨Eureka client(eureka.client.enableä¸ºtrueå’Œribbon.eureka.enabledä¸ºtrueæ—¶, é»˜è®¤ä¸ºtrue)æ—¶é…ç½®é»˜è®¤åŸºäºeurekaçš„ribbon.
ä½¿ç”¨&lt;code>EurekaRibbonClientConfiguration&lt;/code>æä¾›çš„é…ç½®: RibbonPing, ServerList, ServerIntrospector.&lt;/p>
&lt;h4 id="eurekadiscoveryclientconfiguration-1">EurekaDiscoveryClientConfiguration&lt;/h4>
&lt;p>æä¾›ç›‘å¬&lt;code>RefreshScopeRefreshedEvent&lt;/code>çš„ç›‘å¬å™¨, å½“äº‹ä»¶å‘ç”Ÿæ—¶æ³¨é”€å¹¶é‡æ–°æ³¨å†Œ(é˜²æ­¢metadataå‘ç”Ÿæ”¹å˜)
æä¾›ä¸€ä¸ªé»˜è®¤çš„EurekaHealthCheckHandlerå®ä¾‹, å½“beanä¸å­˜åœ¨çš„ä¸”&lt;code>eureka.client.healthcheck.enabled&lt;/code>ä¸ºtrueæ—¶.&lt;/p>
&lt;h2 id="ä¸»è¦ç±»">ä¸»è¦ç±»&lt;/h2>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15185644052296.jpg" alt="">&lt;/p>
&lt;h3 id="serviceregistry">ServiceRegistry&lt;/h3>
&lt;p>springæä¾›çš„æœåŠ¡å®ä¾‹æ³¨å†Œå’Œæ³¨é”€çš„æ¥å£.&lt;/p>
&lt;h3 id="eurekaserviceregistry">EurekaServiceRegistry&lt;/h3>
&lt;p>ServiceRegistryçš„Eurekaå®ç°. æ³¨å†Œå’Œæ³¨é”€çš„å®ç°æ˜¯é€šè¿‡&lt;code>EurekaRegistration&lt;/code>çš„&lt;code>ApplicationInfoManager&lt;/code>ä¿®æ”¹å®ä¾‹çŠ¶æ€å®ç°çš„.&lt;/p>
&lt;h3 id="eurekaregistration">EurekaRegistration&lt;/h3>
&lt;p>é€šè¿‡å®ç°&lt;code>ServiceInstance&lt;/code>æä¾›è®¿é—®å®ä¾‹ä¿¡æ¯çš„æ¥å£,&lt;/p>
&lt;h3 id="applicationinfomanager">ApplicationInfoManager&lt;/h3>
&lt;p>æä¾›ä¿®æ”¹å®ä¾‹çŠ¶æ€çš„æ¥å£, å¹¶é€šçŸ¥çŠ¶æ€å˜åŒ–çš„ç›‘å¬å™¨.
æä¾›å†…éƒ¨ç±»&lt;code>StatusChangeListener&lt;/code>.
æä¾›æ³¨å†Œå’Œæ³¨é”€çŠ¶æ€å˜åŒ–ç›‘å¬å™¨çš„æ¥å£, Eurekaçš„&lt;code>DiscoveryClient&lt;/code>ä¸­é€šè¿‡åŒ¿åç±»çš„æ–¹å¼å®ç°äº†è¯¥æ¥å£, å½“å®ä¾‹çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶, åˆ·æ–°å®ä¾‹çŠ¶æ€.&lt;/p></description></item><item><title>åˆè¯†Netflix Zuul</title><link>https://atbug.com/learn-netflix-zuul/</link><pubDate>Sun, 11 Feb 2018 10:07:18 +0000</pubDate><guid>https://atbug.com/learn-netflix-zuul/</guid><description>
&lt;p>åµŒå…¥å¼çš„zuulä»£ç†&lt;/p>
&lt;p>ä½¿ç”¨äº†Netfilx OSSçš„å…¶ä»–ç»„ä»¶:&lt;/p>
&lt;ul>
&lt;li>Hystrix ç†”æ–­&lt;/li>
&lt;li>Ribbon è´Ÿè´£å‘é€å¤–å‡ºè¯·æ±‚çš„å®¢æˆ·ç«¯, æä¾›è½¯ä»¶è´Ÿè½½å‡è¡¡åŠŸèƒ½&lt;/li>
&lt;li>Trubine å®æ—¶åœ°èšåˆç»†ç²’åº¦çš„metricsæ•°æ®&lt;/li>
&lt;li>Archaius åŠ¨æ€é…ç½®&lt;/li>
&lt;/ul>
&lt;h2 id="ä»‹ç»">ä»‹ç»&lt;/h2>
&lt;p>ç”±äº2.0åœæ­¢å¼€å‘ä¸”ä¼šæœ‰bug, æ•…ä¸‹é¢çš„åˆ†æåŸºäº1.xç‰ˆæœ¬.&lt;/p>
&lt;h3 id="ç‰¹æ€§">ç‰¹æ€§&lt;/h3>
&lt;ul>
&lt;li>Authentication è®¤è¯&lt;/li>
&lt;li>Insights æ´å¯Ÿ&lt;/li>
&lt;li>Stress Testing å‹åŠ›æµ‹è¯•&lt;/li>
&lt;li>Canary Testing é‡‘ä¸é›€æµ‹è¯•&lt;/li>
&lt;li>Dynamic Routing åŠ¨æ€è·¯ç”±&lt;/li>
&lt;li>Multi-Region Resiliency å¤šåŒºåŸŸå¼¹æ€§&lt;/li>
&lt;li>Load Shedding è´Ÿè½½è„±è½&lt;/li>
&lt;li>Security å®‰å…¨&lt;/li>
&lt;li>Static Response handling é™æ€å“åº”å¤„ç†&lt;/li>
&lt;li>Multi-Region Resiliency ä¸»åŠ¨/ä¸»åŠ¨æµé‡ç®¡ç†&lt;/li>
&lt;/ul>
&lt;h3 id="zuulæ ¸å¿ƒæ¶æ„">Zuulæ ¸å¿ƒæ¶æ„&lt;/h3>
&lt;h4 id="è¿‡æ»¤å™¨åŠ è½½å™¨">è¿‡æ»¤å™¨åŠ è½½å™¨&lt;/h4>
&lt;p>ä»æ–‡ä»¶ç›®å½•å®šæ—¶çš„ç›‘æ§æ–‡ä»¶, ç¼–è¯‘æˆClasså¹¶åŠ è½½åˆ°è¿‡æ»¤å™¨é“¾ä¸­.&lt;/p>
&lt;h4 id="è´¯ç©¿æ•´ä¸ªè¯·æ±‚çš„requestcontext">è´¯ç©¿æ•´ä¸ªè¯·æ±‚çš„RequestContext&lt;/h4>
&lt;p>å°†Servletçš„è¯·æ±‚å’Œå“åº”åˆå§‹åŒ–æˆ&lt;code>RequestContext&lt;/code>, ä¿å­˜åœ¨ThreadLocalä¸­è´¯ç©¿æ•´ä¸ªè¯·æ±‚.&lt;/p>
&lt;p>ä»¥åŠæ·»åŠ Netfixåº“çš„æŒ‡å®šæ¦‚å¿µå’Œæ•°æ®çš„æ‰©å±•å¯¹è±¡&lt;code>NFRequestContext&lt;/code>, å¦‚&lt;code>Eureka&lt;/code>&lt;/p>
&lt;h4 id="å››ç§è¿‡æ»¤å™¨">å››ç§è¿‡æ»¤å™¨:&lt;/h4>
&lt;ul>
&lt;li>preRoute&lt;/li>
&lt;li>route&lt;/li>
&lt;li>postRoute&lt;/li>
&lt;li>error&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://cdn-images-1.medium.com/max/1000/1*j9iGkeQ7bPK2nC1a7BgFOw.png" alt="Zuul Core Architecture">&lt;/p>
&lt;h3 id="zuulè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ">Zuulè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ&lt;/h3>
&lt;p>&lt;img src="https://camo.githubusercontent.com/4eb7754152028cdebd5c09d1c6f5acc7683f0094/687474703a2f2f6e6574666c69782e6769746875622e696f2f7a75756c2f696d616765732f7a75756c2d726571756573742d6c6966656379636c652e706e67" alt="Request Lifecycle">&lt;/p>
&lt;h3 id="zuul-netflix">Zuul Netflix&lt;/h3>
&lt;p>ä½¿ç”¨Netflixçš„å…¶ä»–ç»„ä»¶&lt;/p>
&lt;p>&lt;img src="https://cdn-images-1.medium.com/max/800/1*pz6sv69la9ek6yWNTPqymQ.png" alt="Netflix OSS libraries in Zuul">&lt;/p>
&lt;h3 id="zullåœ¨netfilxçš„åº”ç”¨">zullåœ¨Netfilxçš„åº”ç”¨&lt;/h3>
&lt;h4 id="ç²¾ç¡®è·¯ç”±">ç²¾ç¡®è·¯ç”±&lt;/h4>
&lt;p>åˆ›å»ºä¸€ä¸ªè¿‡æ»¤å™¨æ˜¯ç‰¹å®šçš„ç”¨æˆ·æˆ–è€…è®¾å¤‡çš„è¯·æ±‚é‡å®šå‘åˆ°ç‹¬ç«‹çš„APIé›†ç¾¤è¾¾åˆ°è°ƒè¯•çš„ç›®çš„.&lt;/p>
&lt;h4 id="å¤šåŒºåŸŸå¼¹">å¤šåŒºåŸŸå¼¹&lt;/h4>
&lt;p>Zuulæ˜¯æˆ‘ä»¬ç§°ä¸ºåœ°å³¡(Isthmus)çš„å¤šåœ°åŒºELBå¼¹æ€§é¡¹ç›®çš„æ ¸å¿ƒ. ä½œä¸ºIsthmusçš„ä¸€éƒ¨åˆ†, Zuulè¢«ç”¨æ¥å°†è¯·æ±‚ä»è¥¿æµ·å²¸æ•°æ®ä¸­å¿ƒä¼ é€åˆ°ä¸œæµ·å²¸, ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„å…³é”®é¢†åŸŸçš„ELBä¸­å®ç°å¤šåŒºåŸŸå†—ä½™.&lt;/p>
&lt;h4 id="å‹åŠ›æµ‹è¯•">å‹åŠ›æµ‹è¯•&lt;/h4>
&lt;p>åœ¨&lt;code>Zuul&lt;/code>è¿‡æ»¤å™¨ä¸­ä½¿ç”¨åŠ¨æ€&lt;code>Archaius&lt;/code>é…ç½®é€æ­¥æå‡è¿›å…¥ä¸€éƒ¨åˆ†æœåŠ¡å™¨çš„æµé‡, è‡ªåŠ¨å®ç°å‹åŠ›æµ‹è¯•.&lt;/p>
&lt;h2 id="åŸç†">åŸç†&lt;/h2>
&lt;h3 id="å¦‚ä½•å·¥ä½œ">å¦‚ä½•å·¥ä½œ&lt;/h3>
&lt;h4 id="startserveråˆå§‹åŒ–">StartServeråˆå§‹åŒ–&lt;/h4>
&lt;p>å®ç°äº†ServletContextListeneræ¥å£, å¦‚æœéœ€è¦ä¸netflix osså…¶ä»–ç»„ä»¶é›†æˆ(å¦‚Eureka, Archaius)å®ä¾‹åŒ–çš„æ—¶å€™å¯åŠ¨ä¸€ä¸ªKaryonæœåŠ¡å™¨.&lt;/p>
&lt;p>åœ¨ServletContextåˆå§‹åŒ–å®Œæˆåè°ƒç”¨&lt;code>initGroovyFilterManager&lt;/code>å’Œ&lt;code>initJavaFilters&lt;/code>.&lt;/p>
&lt;h5 id="initgroovyfiltermanager">initGroovyFilterManager&lt;/h5>
&lt;p>å‘è¿‡æ»¤å™¨æ³¨å†Œè¡¨ä¸­æ·»åŠ Groovyè¿‡æ»¤å™¨.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">initGroovyFilterManager&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//è®¾ç½®GroovyCompiler
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//GroovyCompileræ˜¯DynamicCompilerçš„å®ç°ç±»
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">FilterLoader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInstance&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">setCompiler&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">GroovyCompiler&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="c1">//ä»é…ç½®ä¸­æ˜¯è·å–è¿‡æ»¤å™¨æºæ–‡ä»¶çš„æ ¹ç›®å½•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">scriptRoot&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;zuul.filter.root&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">scriptRoot&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">scriptRoot&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">scriptRoot&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">File&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">separator&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//è®¾ç½®æ–‡ä»¶åè¿‡æ»¤å™¨, è¿™é‡Œåªè¿‡æ»¤`.groovy`ç±»å‹æ–‡ä»¶.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">FilterFileManager&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setFilenameFilter&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">GroovyFileFilter&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="c1">//åˆå§‹åŒ–è¿‡æ»¤å™¨æ–‡ä»¶ç®¡ç†å™¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ‰«æç›®å½•çš„é—´éš”æ—¶é—´, å•ä½ä¸ºç§’
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//åé¢è·Ÿè¦æ‰«æçš„å­ç›®å½•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//1. åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰«æå„ä¸ªå­ç›®å½•, ä½¿ç”¨æ–‡ä»¶åè¿‡æ»¤å™¨è·å–åˆ°æ‰€æœ‰çš„è¿‡æ»¤å™¨æºæ–‡ä»¶.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//2. éå†è¿™äº›æ–‡ä»¶, ä½¿ç”¨`FilterLoader.getInstance().putFilter(file)`, compilerç¼–è¯‘ä¹‹åä½¿ç”¨FilterFactoryè¿›è¡Œå®ä¾‹åŒ–, å¹¶æ·»åŠ åˆ°è¿‡æ»¤å™¨æ³¨å†Œè¡¨ä¸­. æ˜¯å¦å®ä¾‹åŒ–çš„é€»è¾‘åˆ¤æ–­æ˜¯å¦åœ¨ä¸Šæ¬¡ä¿®æ”¹ä¸”æ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´æ˜¯å¦ç›¸åŒ. å¦‚æœæ˜¯ä¸Šæ¬¡ä¿®æ”¹ä¹‹ååˆæœ‰æ”¹åŠ¨, è¦é‡å»ºæ”¹ç±»å‹è¿‡æ»¤å™¨çš„åˆ—è¡¨. å¦‚æœæ²¡æœ‰ä¿®æ”¹, å¯¹æ”¹æ–‡ä»¶ä¸åšä»»ä½•å¤„ç†.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//3. å¯åŠ¨çº¿ç¨‹, æ¯ä¸ª5ç§’æ‰§è¡Œä¸€ä¸ª1å’Œ2çš„æ“ä½œ.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">FilterFileManager&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">init&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">5&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">scriptRoot&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;pre&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">scriptRoot&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;route&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">scriptRoot&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;post&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">RuntimeException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="initjavafilters">initJavaFilters&lt;/h5>
&lt;p>å‘è¿‡æ»¤å™¨æ³¨å†Œè¡¨ä¸­æ·»åŠ Javaè¿‡æ»¤å™¨.&lt;/p>
&lt;p>*å®˜æ–¹æ²¡æœ‰æä¾›ä»javaæºä»£ç åˆ°classsçš„ç¼–è¯‘å™¨.&lt;/p>
&lt;h4 id="zuulservlet">ZuulServlet&lt;/h4>
&lt;p>æ ¸å¿ƒzuul servlet, åˆå§‹åŒ–å’Œå¸æ‰zullFilterçš„è¿è¡Œ.
ä½¿ç”¨ZuulRunnerå°†Servletçš„è¯·æ±‚å’Œå“åº”åˆå§‹åŒ–æˆ&lt;code>RequestContext&lt;/code>, å¹¶å°†&lt;code>FilterProcessor&lt;/code>çš„è°ƒç”¨åŒ…è£…æˆ&lt;code>preRoute()&lt;/code>, &lt;code>route()&lt;/code>, &lt;code>postRoute()&lt;/code>å’Œ&lt;code>error()&lt;/code>æ–¹æ³•. åˆå§‹åŒ–æ—¶å¯ä»¥é€‰æ‹©å°†è¯·æ±‚åŒ…è£…æˆ&lt;code>HttpServletRequestWrapper&lt;/code>å¹¶ç¼“å†²è¯·æ±‚æ¶ˆæ¯ä½“.&lt;/p>
&lt;p>åˆå§‹åŒ–åçš„&lt;code>RequestContext&lt;/code>ä¼šæ”¾åœ¨&lt;code>ThreadLocal&lt;/code>ä¸­, ä¾›åç»­çš„filterè®¿é—®.&lt;/p>
&lt;p>&lt;strong>Serviceæ–¹æ³•&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">service&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">javax&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">servlet&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ServletRequest&lt;/span> &lt;span class="n">servletRequest&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">javax&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">servlet&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ServletResponse&lt;/span> &lt;span class="n">servletResponse&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">ServletException&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">IOException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">init&lt;/span>&lt;span class="o">((&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">servletRequest&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">HttpServletResponse&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">servletResponse&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// Marks this request as having passed through the &amp;#34;Zuul engine&amp;#34;, as opposed to servlets
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// explicitly bound in web.xml, for which requests will not have the same data attached
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">RequestContext&lt;/span> &lt;span class="n">context&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">RequestContext&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getCurrentContext&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">context&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setZuulEngineRan&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">preRoute&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ZuulException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">error&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">postRoute&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">return&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">route&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ZuulException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">error&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">postRoute&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">return&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">postRoute&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ZuulException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">error&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Throwable&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">error&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">ZuulException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">500&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;UNHANDLED_EXCEPTION_&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getClass&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">()));&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">RequestContext&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getCurrentContext&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">unset&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šè¿‡&lt;code>FilterProcessor.getInstnace()&lt;/code>è°ƒç”¨&lt;code>FilterProcessor&lt;/code>çš„&lt;code>preRoute()&lt;/code>, &lt;code>route()&lt;/code>, &lt;code>postRoute()&lt;/code>å’Œ&lt;code>error()&lt;/code>æ–¹æ³•.&lt;/p>
&lt;p>å››ä¸ªæ–¹æ³•éƒ½æ˜¯é€šè¿‡&lt;code>FilterLoader.getInstance()&lt;/code>è·å–å¯¹åº”ç±»å‹çš„filteråˆ—è¡¨.&lt;/p>
&lt;p>éå†filteråˆ—è¡¨, è°ƒç”¨filterçš„&lt;code>runFilter()&lt;/code>æ–¹æ³•.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * runFilter checks !isFilterDisabled() and shouldFilter(). The run() method is invoked if both are true.
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * @return the return from ZuulFilterResult
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">ZuulFilterResult&lt;/span> &lt;span class="nf">runFilter&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ZuulFilterResult&lt;/span> &lt;span class="n">zr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ZuulFilterResult&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="c1">//åŠ¨æ€è·å–`zuul.filerClassName.filterType.disable`çš„å€¼
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//åŠ¨æ€è·å–ä½¿ç”¨Archaiusçš„DynamicPropertyFactoryè·å–*, é€šè¿‡è¿™ä¸ªå¯å®ç°åŠ¨æ€é…ç½®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">isFilterDisabled&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//è°ƒç”¨filterç±»çš„æ ¡éªŒé€»è¾‘
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">shouldFilter&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Tracer&lt;/span> &lt;span class="n">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TracerFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">instance&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">startMicroTracer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ZUUL::&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getClass&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getSimpleName&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//æ‰§è¡Œfilterçš„é€»è¾‘å¤„ç†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="n">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">run&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="c1">//æ‰§è¡ŒæˆåŠŸ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">zr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ZuulFilterResult&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ExecutionStatus&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SUCCESS&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Throwable&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setName&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ZUUL::&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getClass&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getSimpleName&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; failed&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//æ‰§è¡Œå¤±è´¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">zr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ZuulFilterResult&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ExecutionStatus&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">FAILED&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">zr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">stopAndLog&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//filterä¸é€‚ç”¨, ç›´æ¥è·³è¿‡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">zr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ZuulFilterResult&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ExecutionStatus&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SKIPPED&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">zr&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="contextlifecyclefilter">ContextLifecycleFilter&lt;/h4>
&lt;p>æ¸…ç©º&lt;code>ThreadLocal&lt;/code>ä¸­çš„&lt;code>RequestContext&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">doFilter&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ServletRequest&lt;/span> &lt;span class="n">req&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ServletResponse&lt;/span> &lt;span class="n">res&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">FilterChain&lt;/span> &lt;span class="n">chain&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">throws&lt;/span> &lt;span class="n">IOException&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ServletException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">chain&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">doFilter&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">req&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">res&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">RequestContext&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getCurrentContext&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">unset&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è°ƒè¯•">è°ƒè¯•&lt;/h3>
&lt;p>è°ƒè¯•ä¿¡æ¯ä¸­çš„åè¯&lt;/p>
&lt;ul>
&lt;li>ZUUL_DEBUG è¾“å‡ºzuulçš„è¯Šæ–­ä¿¡æ¯&lt;/li>
&lt;li>REQUEST_DUBG è¾“å‡ºHttpè¯·æ±‚çš„ä¿¡æ¯. REQUEST -&amp;gt; ZUUL -&amp;gt; ORIGIN_RESPONSE -&amp;gt; OUTBOUND
&lt;ul>
&lt;li>REQUEST è¿›å…¥zuulçš„è¯·æ±‚&lt;/li>
&lt;li>ZUUL zuulè½¬å‘ç»™åŸç›®æ ‡çš„è¯·æ±‚&lt;/li>
&lt;li>ORIGIN_RESPONSE åŸç›®æ ‡è¿”å›çš„åŸå§‹å“åº”&lt;/li>
&lt;li>OUTBOND zuulè¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº”&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="æ¥å£å’Œç±»">æ¥å£å’Œç±»&lt;/h2>
&lt;h3 id="æ¥å£">æ¥å£&lt;/h3>
&lt;h4 id="dynamiccodecompiler">DynamicCodeCompiler&lt;/h4>
&lt;p>ä»æºä»£ç ç¼–è¯‘æˆClassesçš„æ¥å£, ç›®å‰åªæœ‰ä¸€ä¸ª&lt;code>GroovyCompiler&lt;/code>å®ç°ç±»&lt;/p>
&lt;h4 id="filterfactory">FilterFactory&lt;/h4>
&lt;p>ç”Ÿæˆç»™å®šçš„è¿‡æ»¤å™¨ç±»å®ä¾‹çš„æ¥å£, å®ç°ç±»&lt;code>DefaultFilterFactory&lt;/code>&lt;/p>
&lt;h4 id="filterusagenotifier">FilterUsageNotifier&lt;/h4>
&lt;p>æ³¨å†Œè¿‡æ»¤å™¨ä½¿ç”¨æ—¶çš„å›è°ƒçš„æ¥å£&lt;/p>
&lt;h3 id="ç±»">ç±»&lt;/h3>
&lt;h4 id="defaultfilterfactory">DefaultFilterFactory&lt;/h4>
&lt;p>ä½¿ç”¨åå°„å®ç°&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="n">ZuulFilter&lt;/span> &lt;span class="nf">newInstance&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Class&lt;/span> &lt;span class="n">clazz&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InstantiationException&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">IllegalAccessException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ZuulFilter&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">clazz&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newInstance&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="filterfilemanager">FilterFileManager&lt;/h4>
&lt;p>ä»è¿‡æ»¤å™¨ç›®å½•ä¸­è·å–ä¿®æ”¹å’Œæ–°å¢çš„Groovyè¿‡æ»¤å™¨æ–‡ä»¶.&lt;/p>
&lt;h4 id="filterloader">FilterLoader&lt;/h4>
&lt;p>æŒæœ‰è¿‡æ»¤å™¨æ³¨å†Œè¡¨, åŠ è½½è¿‡æ»¤å™¨.&lt;/p></description></item><item><title>ConfigurationPropertiesåˆ°åº•éœ€ä¸éœ€è¦getter</title><link>https://atbug.com/configurationproperties-requires-getter-or-not/</link><pubDate>Wed, 07 Feb 2018 15:53:21 +0000</pubDate><guid>https://atbug.com/configurationproperties-requires-getter-or-not/</guid><description>
&lt;p>ä¸ºä»€ä¹ˆè¦è®¨è®ºè¿™ä¸ªé—®é¢˜, å·¥ä½œä¸­ä¸€ä¸ªåŒäº‹å†™çš„ç±»ä½¿ç”¨äº†&lt;code>ConfigurationProperties&lt;/code>, åªæä¾›äº†æ ‡å‡†çš„setteræ–¹æ³•. å±æ€§çš„è®¿é—®, æä¾›äº†å®šåˆ¶çš„æ–¹æ³•. å¯ä»¥å‚è€ƒ&lt;code>EurekaClientConfigBean&lt;/code>.&lt;/p>
&lt;p>ä»–ä½¿ç”¨çš„æ˜¯spring boot 2.0.0.M5ç‰ˆæœ¬, å¯ä»¥æ­£å¸¸è·å–é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å€¼, ä½†æ˜¯åœ¨1.5.8.RELEASEè·å–ä¸åˆ°.&lt;/p>
&lt;p>çœ‹ä¸‹æ–‡æ¡£å’Œæºç :&lt;/p>
&lt;blockquote>
&lt;p>Annotation for externalized configuration. Add this to a class definition or a @Bean method in a @Configuration class if you want to bind and validate some external Properties (e.g. from a .properties file).&lt;/p>
&lt;/blockquote>
&lt;p>å¤–ç½®é…ç½®çš„æ³¨è§£. å½“éœ€è¦ç»‘å®šå¤–ç½®é…ç½®(å¦‚propertiesæˆ–è€…yamlé…ç½®)çš„æ—¶å€™, å°†å…¶åŠ åˆ°ä½¿ç”¨äº†&lt;code>@Configuration&lt;/code>æ³¨è§£çš„ç±»å£°æ˜å¤„æˆ–è€…&lt;code>@Bean&lt;/code>æ ‡æ³¨çš„æ–¹æ³•ä¸Š.&lt;/p>
&lt;p>å€¼çš„ç»‘å®šæ˜¯é€šè¿‡&lt;code>ConfigurationPropertiesBindingPostProcessor&lt;/code>åœ¨beanå®ä¾‹åˆ›å»ºå, åˆå§‹åŒ–å›è°ƒ(å¦‚&lt;code>InitializingBean&lt;/code>çš„&lt;code>afterPropertiesSet&lt;/code>æ–¹æ³•)æˆ–è€…&lt;code>init-method&lt;/code>ä¹‹å‰ä¹‹å‰å®Œæˆçš„.&lt;/p>
&lt;h3 id="15x">1.5.x&lt;/h3>
&lt;p>æ‰§è¡Œç»‘å®šçš„æ—¶å€™å¦‚æœæ‰¾ä¸åˆ°getteræ–¹æ³•, ä¼šæŠ›å‡º&lt;code>RelaxedBindingNotWritablePropertyException&lt;/code>å¼‚å¸¸. debugæ¨¡å¼ä¸‹, ä¼šæ‰“å°&lt;strong>Ignoring benign property binding failure&lt;/strong>.&lt;/p>
&lt;h3 id="2x">2.x&lt;/h3>
&lt;p>2.xç‰ˆæœ¬ä¸­, å¦‚æœæ‰¾ä¸åˆ°getteræ–¹æ³•, ä¼šå°†åŸå€¼é»˜è®¤ä¸ºnull, å¹¶ç»§ç»­æ‰§è¡Œç»‘å®š.&lt;/p></description></item><item><title>Go In Action è¯»ä¹¦ç¬”è®° å››</title><link>https://atbug.com/go-in-action-four/</link><pubDate>Mon, 01 Jan 2018 12:30:55 +0000</pubDate><guid>https://atbug.com/go-in-action-four/</guid><description>
&lt;p>&lt;img src="https://talks.golang.org/2013/go4python/img/fib-go.png" alt="">&lt;/p>
&lt;h2 id="å¹¶å‘æ¨¡å¼">å¹¶å‘æ¨¡å¼&lt;/h2>
&lt;h3 id="runner">runner&lt;/h3>
&lt;p>runnerå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨é€šé“æ¥ç›‘è§†ç¨‹åºçš„æ‰§è¡Œæ—¶é—´, å¦‚æœç¨‹åºæ‰§è¡Œæ—¶é—´å¤ªé•¿, ä¹Ÿå¯ä»¥ç”¨ç»ˆæ­¢ç¨‹åº.
è¿™ä¸ªç¨‹åºå¯ç”¨ä½œcornä½œä¸šæ‰§è¡Œ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">runner&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;errors&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os/signal&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Runner&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//ç³»ç»Ÿä¿¡å·é€šé“
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">interrupt&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Signal&lt;/span>
&lt;span class="c1">//ä»»åŠ¡æ‰§è¡Œç»“æœé€šé“
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">complete&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">//æŠ¥å‘Šä»»åŠ¡å¤„ç†å·²ç»è¶…æ—¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">timeout&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>
&lt;span class="nx">tasks&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//è¶…æ—¶é”™è¯¯
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">ErrTimeout&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;received timeout&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//ç³»ç»Ÿç»ˆç«¯é”™è¯¯
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">ErrInterrupt&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;received interrupt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//è¿”å›ä¸€ä¸ªæ–°çš„å‡†å¤‡ä½¿ç”¨çš„Runner
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Runner&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Runner&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">interrupt&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Signal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">complete&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">timeout&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">After&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="c1">//Afterå‡½æ•°ä¼šä½¿ç”¨goroutineå¯åŠ¨ä¸€ä¸ªtimer, timeræ—¶é—´åˆ°åå‘channelå†™å…¥Time
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//å‘Runnerä¸­æ·»åŠ task
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Runner&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">AddTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tasks&lt;/span> &lt;span class="o">...&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">tasks&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">tasks&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tasks&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Runner&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Start&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//å¸Œæœ›æ¥æ”¶æ‰€æœ‰ç»ˆç«¯ä¿¡å·
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">signal&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Notify&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">interrupt&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interrupt&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//ä½¿ç”¨goroutineæ‰§è¡Œä»»åŠ¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">complete&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">run&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="k">select&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//mainçº¿ç¨‹åœ¨selectå¤„é˜»å¡, è¦ä¹ˆç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æœç»“æŸ, è¦ä¹ˆç­‰å¾…è®¡æ—¶å™¨æŠ¥å‘Šè¶…æ—¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">complete&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="c1">//é˜»å¡ç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æœ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">timeout&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1">//é˜»å¡ç­‰å¾…è¶…æ—¶æŠ¥å‘Š
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">ErrTimeout&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Runner&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">task&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">tasks&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//æ£€æµ‹æ˜¯å¦æœ‰æ¥è‡ªæ“ä½œç³»ç»Ÿçš„ç»ˆç«¯ä¿¡å·
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">getInterrupted&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">ErrInterrupt&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//æ‰§è¡Œä»»åŠ¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">task&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Runner&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">getInterrupted&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//ä½¿ç”¨defaultå°†selectçš„é˜»å¡å˜æˆéé˜»å¡. æ¯æ¬¡æ–¹æ³•è°ƒç”¨åªæ˜¯æ£€æŸ¥é€šé“ä¸­æ˜¯å¦æœ‰æ•°æ®, ä¸é˜»å¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">select&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">interrupt&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/addozhang/learning-go-lang/runner&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Starting working.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="nx">timeout&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>
&lt;span class="nx">r&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">runner&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">timeout&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">createTask&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nf">createTask&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nf">createTask&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Start&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">runner&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ErrTimeout&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Terminating due to timeout.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">runner&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ErrInterrupt&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Terminating due to interrupt.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Process ended.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//åˆ›å»ºä»»åŠ¡, è¿”å›æ¥å—intç±»å‹å‚æ•°çš„å‡½æ•°
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">createTask&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">){&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Processor - Task #%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//åˆ›å»ºä»»åŠ¡, è¿”å›æ¥å—intç±»å‹å‚æ•°çš„å‡½æ•°
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">createTask&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">){&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Processor - Task #%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ç»“æœè¾“å‡º
&lt;/span>&lt;span class="c1">//2018/01/01 09:45:57 Starting working.
&lt;/span>&lt;span class="c1">//2018/01/01 09:45:57 Processor - Task #0
&lt;/span>&lt;span class="c1">//2018/01/01 09:45:57 Processor - Task #1
&lt;/span>&lt;span class="c1">//2018/01/01 09:45:58 Processor - Task #2
&lt;/span>&lt;span class="c1">//2018/01/01 09:46:00 Terminating due to timeout.
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="pool">pool&lt;/h3>
&lt;p>ä¸‹é¢çš„ä»£ç å±•ç¤ºå¦‚ä½•ä½¿ç”¨æœ‰ç¼“å†²é€šé“å®ç°èµ„æºæ± , ä»¥1.5ç‰ˆæœ¬ä¸ºåŸºç¡€å†™çš„. 1.6ä¹‹åçš„ç‰ˆæœ¬, æ ‡å‡†åº“ä¸­è‡ªå¸¦äº†èµ„æºæ± çš„å®ç°&lt;code>sycn.Pool&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">pool&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;io&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;errors&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Pool&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span> &lt;span class="c1">//äº’æ–¥é”ç”¨äºå®‰å…¨åœ°æ–¹è®¿é—®èµ„æºæ± 
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">resources&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Closer&lt;/span> &lt;span class="c1">//èµ„æºæ± é€šé“, éœ€è¦å®ç°io.Closeræ¥å£
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">factory&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Closer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//åˆ›å»ºèµ„æºçš„å·¥å‚æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">closed&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="c1">//èµ„æºæ± æ˜¯å¦å…³é—­
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">//èµ„æºæ± å…³é—­é”™è¯¯
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">ErrPoolClosed&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Pool has ben closed.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fn&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Closer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">size&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Pool&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">size&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Size value too small.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Pool&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">resources&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Closer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">size&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="c1">//ä½¿ç”¨æœ‰ç¼“å†²èµ„æºæ± 
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">factory&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">fn&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ä»æ± ä¸­è·å–èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Pool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Acquire&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Closer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">select&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resources&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1">//ä»èµ„æºæ± é€šé“è·å–ä¸€ä¸ªèµ„æº, å› ä¸ºæœ‰default, ä¸é˜»å¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Acqure: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Shared Resources&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ErrPoolClosed&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1">//èµ„æºæ± é€šé“æ²¡æœ‰æ•°æ®æ—¶, æ–°å»ºä¸€ä¸ª
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Acquire: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;New Resource&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">factory&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//é‡Šæ”¾èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Pool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Release&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Closer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//éœ€è¦ä½¿ç”¨äº’æ–¥é”æ“ä½œèµ„æºæ± 
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">defer&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">closed&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">select&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resources&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1">//å°†èµ„æºæ”¾å›é€šé“. å¦‚æœé€šé“æ»¡ä¸ä¼šé˜»å¡, å› ä¸ºæœ‰default
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Release: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;In Queue&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1">//å¦‚æœé€šé“å·²æ»¡, ç›´æ¥å…³é—­èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Release: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Closing&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//å…³é—­èµ„æºæ± 
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Pool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//åŠ äº’æ–¥é”
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">defer&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">closed&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//å°†æ± å…³é—­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">closed&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="c1">//åœ¨æ¸…ç©ºé€šé“èµ„æºä¹‹å‰å…³é—­é€šé“, å¦‚æœä¸å…³é—­ä¼šå‘å£°æ­»é”
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resources&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">res&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resources&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//å…³é—­é€šé“ä¸­çš„èµ„æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;github.com/addozhang/learning-go-lang/pool&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;io&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;sync/atomic&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;math/rand&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">maxGoRoutines&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">25&lt;/span>
&lt;span class="nx">pooledResources&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">dbConnection&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ID&lt;/span> &lt;span class="kt">int32&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">idCounter&lt;/span> &lt;span class="kt">int32&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">dbConn&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">dbConnection&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Close: Connection, &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">dbConn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">createConnection&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Closer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">id&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">atomic&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddInt32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">idCounter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Create: New Connection&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">dbConnection&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">maxGoRoutines&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">pool&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">createConnection&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pooledResources&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">query&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">query&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">maxGoRoutines&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">query&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">q&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">performQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">q&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}(&lt;/span>&lt;span class="nx">query&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Shutdown Program.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">performQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">query&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pool&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">pool&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">dbConn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">pool&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Acquire&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">dbConn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rand&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Intn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Millisecond&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;QID[%d] CID[%d]&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">query&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">dbConn&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">dbConnection&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="work">work&lt;/h3>
&lt;p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æ— ç¼“å†²é€šé“æ¥åˆ›å»ºä¸€ä¸ªgoroutineæ± . è¿™ä¸ªgoroutineæ‰§è¡Œå¹¶æ§åˆ¶ä¸€ç»„å·¥ä½œ, è®©å…¶å¹¶å‘æ‰§è¡Œ.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">worker&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Worker&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Task&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Pool&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">worker&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="nx">Worker&lt;/span>
&lt;span class="nx">wg&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">maxRoutines&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Pool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">p&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">Pool&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">worker&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="nx">Worker&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">maxRoutines&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">maxRoutines&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">w&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">worker&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">w&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Task&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Pool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span> &lt;span class="nx">Worker&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">worker&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">w&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Pool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Shutdown&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">worker&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;span class="nx">worker2&lt;/span> &lt;span class="s">&amp;#34;github.com/addozhang/learning-go-lang/worker&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">names&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="s">&amp;#34;bob&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;steve&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;mary&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;therese&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;json&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">namePrinter&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">np&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">namePrinter&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Task&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">np&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">p&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">worker2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">names&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">name&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">names&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">np&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">namePrinter&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">np&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Shutdown&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Go In Action è¯»ä¹¦ç¬”è®° ä¸‰</title><link>https://atbug.com/go-in-action-three/</link><pubDate>Mon, 01 Jan 2018 12:30:31 +0000</pubDate><guid>https://atbug.com/go-in-action-three/</guid><description>
&lt;h2 id="å¹¶å‘">å¹¶å‘&lt;/h2>
&lt;p>Goè¯­è¨€é‡Œçš„å¹¶å‘æ˜¯æŒ‡è®©æŸä¸ªå‡½æ•°å¯ä»¥ç‹¬ç«‹äºå…¶ä»–å‡½æ•°è¿è¡Œçš„èƒ½åŠ›. å½“ä¸€ä¸ªå‡½æ•°åˆ›å»ºä¸ºgoroutineæ—¶, Goä¼šå°†å…¶è§†ä¸ºä¸€ä¸ªç‹¬ç«‹çš„å·¥ä½œå•å…ƒ. è¿™ä¸ªå·¥ä½œå•å…ƒä¼šè¢«è°ƒåº¦åˆ°å¯ç”¨çš„&lt;strong>é€»è¾‘å¤„ç†å™¨&lt;/strong>ä¸Šæ‰§è¡Œ.&lt;/p>
&lt;p>Goçš„è¿è¡Œæ—¶è°ƒåº¦å™¨å¯ä»¥ç®¡ç†æ‰€æœ‰åˆ›å»ºçš„goroutine, å¹¶ä¸ºå…¶åˆ†é…æ‰§è¡Œæ—¶é—´.
è¿™ä¸ªè°ƒåº¦å™¨åœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Š, å°†æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ä¸é€»è¾‘å¤„ç†å™¨ç»‘å®š, å¹¶åœ¨é€»è¾‘å¤„ç†å™¨æ‰§è¡Œgoroutine. &lt;strong>è°ƒåº¦å™¨å¯ä»¥åœ¨ä»»ä½•ç»™å®šçš„æ—¶é—´, å…¨é¢æ§åˆ¶å“ªä¸ªgoroutineåœ¨å“ªä¸ªé€»è¾‘å¤„ç†å™¨ä¸Šè¿è¡Œ&lt;/strong>.&lt;/p>
&lt;p>Goçš„å¹¶å‘åŒæ­¥æ¨¡å‹æ¥è‡ªä¸€ä¸ªå«åšé€šä¿¡é¡ºåºè¿›ç¨‹(Communicating Sequential Processes, &lt;a href="http://www.usingcsp.com">CSP&lt;/a>). CSPæ˜¯ä¸€ä¸ªæ¶ˆæ¯ä¼ é€’æ¨¡å‹, é€šè¿‡åœ¨goroutineä¹‹å‰ä¼ é€’æ•°æ®æ¥ä¼ é€’æ¶ˆæ¯, ä¸éœ€è¦é€šè¿‡åŠ é”å®ç°åŒæ­¥è®¿é—®. ç”¨äºåœ¨goroutineé—´ä¼ é€’æ¶ˆæ¯çš„æ•°æ®ç»“æ„å«åšé€šé“(channel).&lt;/p>
&lt;h3 id="å¹¶å‘ä¸å¹¶è¡Œ">å¹¶å‘ä¸å¹¶è¡Œ&lt;/h3>
&lt;p>æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹(thread)å’Œè¿›ç¨‹(process).&lt;/p>
&lt;p>è¿›ç¨‹ç±»ä¼¼åº”ç”¨ç¨‹åºåœ¨è¿è¡Œä¸­éœ€è¦ç”¨åˆ°å’Œç»´æŠ¤çš„å„ç§èµ„æºçš„å®¹å™¨.
èµ„æºåŒ…æ‹¬ä½†ä¸é™äº: å†…å­˜(æ¥è‡ªæ–‡ä»¶ç³»ç»Ÿçš„ä»£ç å’Œæ•°æ®), å¥æŸ„(æ–‡ä»¶, è®¾å¤‡, æ“ä½œç³»ç»Ÿ), çº¿ç¨‹.&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15144419454015.jpg" alt="">&lt;/p>
&lt;p>æ¯ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹, ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸€ä¸ªæ‰§è¡Œç©ºé—´. è¿™ä¸ªç©ºé—´ä¼šè¢«æ“ä½œç³»ç»Ÿè°ƒåº¦æ¥è¿è¡Œå‡½æ•°ä¸­æ‰€å†™çš„ä»£ç . æ¯ä¸ªçº¿ç¨‹çš„åˆå§‹çº¿ç¨‹è¢«ç§°ä¸ºä¸»çº¿ç¨‹. ä¸»çº¿ç¨‹ç»ˆæ­¢æ—¶, åº”ç”¨ç¨‹åºä¹Ÿä¼šç»ˆæ­¢.æ“ä½œç³»ç»Ÿå°†çº¿ç¨‹è°ƒåº¦åˆ°æŸä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œ, è¿™ä¸ªå¤„ç†å™¨ä¸ä¸€å®šæ˜¯è¿›ç¨‹æ‰€åœ¨çš„å¤„ç†å™¨.&lt;/p>
&lt;p>Goè¯­è¨€çš„è¿è¡Œæ—¶ä¼šåœ¨&lt;strong>é€»è¾‘å¤„ç†å™¨&lt;/strong>ä¸Šè°ƒåº¦goroutineè¿è¡Œ. æ¯ä¸ªé€»è¾‘å¤„ç†å™¨éƒ½åˆ†åˆ«ç»‘å®šåˆ°å•ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹. Goè¯­è¨€çš„è¿è¡Œæ—¶é»˜è®¤ä¼šä¸ºæ¯ä¸ªå¯ç”¨çš„ç‰©ç†å¤„ç†å™¨åˆ†é…ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨.&lt;/p>
&lt;p>åˆ›å»ºä¸€ä¸ªgorouineå¹¶å‡†å¤‡è¿è¡Œ, è¿™ä¸ªgoroutineå°±ä¼šè¢«æ”¾åˆ°è°ƒåº¦å™¨çš„&lt;strong>å…¨å±€è¿è¡Œé˜Ÿåˆ—&lt;/strong>ä¸­. ä¹‹å, è°ƒåº¦å™¨å°±å°†è¿™äº›é˜Ÿåˆ—ä¸­çš„goroutineåˆ†é…ç»™ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨, å¹¶æ”¾åˆ°è¯¥é€»è¾‘å¤„ç†å™¨å¯¹åº”çš„&lt;strong>æœ¬åœ°è¿è¡Œé˜Ÿåˆ—&lt;/strong>, ç„¶ååœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«é€»è¾‘å¤„ç†å™¨æ‰§è¡Œ.&lt;/p>
&lt;p>å¦‚æœgoroutineæ‰§è¡Œäº†é˜»å¡çº¿ç¨‹çš„è°ƒç”¨, è°ƒåº¦å™¨ä¼šå°†è¿™ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸é€»è¾‘å¤„ç†å™¨åˆ†ç¦», å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ä¸é€»è¾‘å¤„ç†å™¨ç»‘å®š, ç„¶å. ä¸€æ—¦é˜»å¡çš„è°ƒç”¨å®Œæˆ, è¯¥goroutineä¼šå›åˆ°æœ¬åœ°è¿è¡Œé˜Ÿåˆ—.&lt;/p>
&lt;p>å¦‚æœé˜»å¡è°ƒç”¨æ˜¯ç½‘ç»œI/O, goroutineä¼šä¸é€»è¾‘å¤„ç†å™¨åˆ†ç¦», ç§»åˆ°é›†æˆäº†ç½‘ç»œè½®è¯¢å™¨çš„è¿è¡Œæ—¶. ä¸€æ—¦è½®è¯¢å™¨æŒ‡ç¤ºæŸä¸ªç½‘ç»œçš„è¯»æˆ–å†™æ“ä½œå·²ç»å°±ç»ª, å¯¹åº”çš„goroutineå°±ä¼šé‡æ–°åˆ†é…åˆ°é€»è¾‘å¤„ç†å™¨ä¸Šå®Œæˆæ“ä½œ.&lt;/p>
&lt;p>è°ƒåº¦å™¨å¯¹å¯ä»¥åˆ›å»ºçš„é€»è¾‘å¤„ç†å™¨çš„æ•°é‡æ²¡æœ‰é™åˆ¶, ä½†æ˜¯è¯­è¨€è¿è¡Œæ—¶é»˜è®¤é™åˆ¶æ¯ä¸ªç¨‹åºæœ€å¤šåˆ›å»º10000ä¸ªçº¿ç¨‹. å¯ä»¥é€šè¿‡è°ƒç”¨&lt;code>runtime/debug&lt;/code>åŒ…çš„&lt;code>SetMaxThreads&lt;/code>æ–¹æ³•æ¥æ›´æ”¹.&lt;/p>
&lt;h4 id="å¹¶å‘concurrencyä¸æ˜¯å¹¶è¡Œparallelism">å¹¶å‘(concurrency)ä¸æ˜¯å¹¶è¡Œ(parallelism)&lt;/h4>
&lt;p>å¹¶è¡Œæ˜¯è®©ä¸åŒçš„ä»£ç åŒæ—¶åœ¨ä¸åŒçš„ç‰©ç†å¤„ç†å™¨ä¸Šæ‰§è¡Œ. å¹¶è¡Œçš„å…³é”®æ˜¯åŒæ—¶åšå¾ˆå¤šäº‹. å¹¶å‘æ˜¯æŒ‡åŒæ—¶ç®¡ç†å¾ˆå¤šäº‹æƒ…, è¿™äº›äº‹æƒ…å¯èƒ½åªåšä¸€èˆ¬å°±å†æš‚åœå»åšåˆ«çš„äº‹æƒ…äº†.&lt;/p>
&lt;p>&lt;strong>ä½¿ç”¨è¾ƒå°‘çš„èµ„æºåšæ›´å¤šçš„äº‹æƒ…&lt;/strong>&lt;/p>
&lt;p>å¤šä¸ªé€»è¾‘å¤„ç†å™¨æ—¶, goroutineä¼šè¢«å¹³å‡åˆ†é…åˆ°æ¯ä¸ªé€»è¾‘å¤„ç†å™¨ä¸Š, è®©goroutineåœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šè¿è¡Œ.&lt;/p>
&lt;h3 id="goroutine">goroutine&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;runtime&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//åˆ†é…ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨ç»™è°ƒåº¦å™¨ä½¿ç”¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GOMAXPROCS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%s\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Start&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">ch&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="sc">&amp;#39;a&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">ch&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="sc">&amp;#39;a&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">26&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">ch&lt;/span> &lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%c &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ch&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">ch&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="sc">&amp;#39;A&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">ch&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="sc">&amp;#39;A&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">26&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">ch&lt;/span> &lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%c &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ch&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Wait&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;\nEnd&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ç»“æœ
&lt;/span>&lt;span class="c1">//Start
&lt;/span>&lt;span class="c1">//Wait
&lt;/span>&lt;span class="c1">//A B C D E F G H I J K L M N O P Q R S T U V W X Y Z A B C D E F G H I J K L M N O P Q R S T U V W X Y Z A B C D E F G H I J K L M N O P Q R S T U V W X Y Z a b c d e f g h i j k l m n o p q r s t u v w x y z a b c d e f g h i j k l m n o p q r s t u v w x y z a b c d e f g h i j k l m n o p q r s t u v w x y z
&lt;/span>&lt;span class="c1">//End
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">//ç¬¬ä¸€ä¸ªgoroutineå®Œæˆæ‰€æœ‰æ˜¾ç¤ºéœ€è¦çš„æ—¶é—´å¤ªçŸ­, ä»¥è‡³äºåœ¨è°ƒåº¦å™¨åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªgoroutineä¹‹å‰å°±å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡.
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¨‹åºå¯ä»¥ä½¿ç”¨&lt;code>runtime.GOMAXPROCS&lt;/code>æ¥æ›´æ”¹è°ƒåº¦å™¨å¯ä»¥ä¸‹ä½¿ç”¨çš„é€»è¾‘å¤„ç†å™¨çš„æ•°é‡. å¦‚æœä¸æƒ³ä»£ç é‡Œä½¿ç”¨, å¯ä»¥ä½¿ç”¨è·Ÿå‡½æ•°åŒåçš„ç¯å¢ƒå˜é‡(&lt;code>GOMAXPROCS&lt;/code>)æ¥è®¾ç½®. ä½¿ç”¨&lt;code>runtime.NumCPU()&lt;/code>å¯ä»¥è·å–ç‰©ç†å¤„ç†å™¨çš„ä¸ªæ•°.&lt;/p>
&lt;p>&lt;code>WaitGroup&lt;/code>æ˜¯ä¸€ä¸ªè®¡æ•°ä¿¡å·é‡, å¯ä»¥ç”¨æ¥è®°å½•å¹¶ç»´æŠ¤è¿è¡Œçš„goroutine. ä½¿ç”¨&lt;code>defer&lt;/code>åœ¨goroutineå‡½æ•°è°ƒç”¨å®Œæˆåè°ƒç”¨&lt;code>Done&lt;/code>æ–¹æ³•.&lt;/p>
&lt;p>ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„goroutineåœ¨å·¥ä½œç»“æŸå‰, å¯ä»¥è¢«åœæ­¢(å›åˆ°æœ¬åœ°é˜Ÿåˆ—)å¹¶é‡æ–°è°ƒåº¦. é˜²æ­¢æŸä¸ªgoroutineé•¿æ—¶é—´å ç”¨é€»è¾‘å¤„ç†å™¨.&lt;/p>
&lt;h3 id="ç«äº‰çŠ¶æ€">ç«äº‰çŠ¶æ€&lt;/h3>
&lt;p>race condition: å¤šä¸ªgoroutineåœ¨æ²¡æœ‰äº’ç›¸åŒæ­¥çš„æƒ…å†µç³»å•Š, è®¿é—®æŸä¸ªå…±äº«çš„èµ„æº, å¹¶è¯•å›¾åŒæ—¶è¯»å’Œå†™è¿™ä¸ªèµ„æº, å­˜åœ¨ç«äº‰çš„çŠ¶æ€.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;runtime&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">counter&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nx">wg&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">incCounter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">incCounter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Final counter: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">counter&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">incCounter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">val&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">counter&lt;/span>
&lt;span class="c1">//å½“å‰goroutineä»çº¿ç¨‹é€€å‡º, å¹¶å›åˆ°é˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Gosched&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">val&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="nx">counter&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">val&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ç»“æœ
&lt;/span>&lt;span class="c1">//Final counter: 2
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>éåŸå­æ“ä½œå¯¼è‡´æœ€åç»“æœä¸º2&lt;/p>
&lt;h3 id="é”ä½å…±äº«èµ„æº">é”ä½å…±äº«èµ„æº&lt;/h3>
&lt;p>ä½¿ç”¨&lt;code>atomic&lt;/code>å’Œ&lt;code>sync&lt;/code>åŒ…çš„å‡½æ•°&lt;/p>
&lt;h4 id="åŸå­å‡½æ•°">åŸå­å‡½æ•°&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;sync/atomic&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;runtime&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">counter&lt;/span> &lt;span class="kt">int64&lt;/span>
&lt;span class="nx">wg&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">incCounter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">incCounter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Final counter: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">counter&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">incCounter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//å®‰å…¨åœ°å¯¹counteråŠ 1
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">atomic&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddInt64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">counter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//å½“å‰goroutineä»çº¿ç¨‹é€€å‡º, å¹¶å›åˆ°é˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Gosched&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>atomic&lt;/code>åŒ…çš„&lt;code>AddInt64&lt;/code>å‡½æ•°, ä¼šåŒæ­¥æ•´å‹å€¼çš„åŠ æ³•, æ–¹æ³•æ˜¯å¼ºåˆ¶åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªgoroutineè¿è¡Œå¹¶å®Œæˆè¿™ä¸ªåŠ æ³•æ“ä½œ. è¿˜æœ‰&lt;code>LoadInt64&lt;/code>å’Œ&lt;code>StoreInt64&lt;/code>å‡½æ•°, æä¾›å®‰å…¨çš„è¯»å†™æ•´å‹å€¼çš„æ–¹å¼.&lt;/p>
&lt;h4 id="äº’æ–¥é”">äº’æ–¥é”&lt;/h4>
&lt;p>ä½¿ç”¨äº’æ–¥é”&lt;code>mutex&lt;/code>, åå­—æ¥è‡ªäº’æ–¥&lt;code>mutual exclusion&lt;/code>çš„æ¦‚å¿µ. åœ¨ä»£ç ä¸Šåˆ›å»ºä¸€ä¸ªé“¾æ¥å», ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªgoroutineå¯ä»¥æ‰§è¡Œè¿™ä¸ªä¸´ç•ŒåŒºçš„ä»£ç .&lt;/p>
&lt;p>ä¸´ç•ŒåŒºçš„ä»£ç å¯ä»¥ä½¿ç”¨å¤§æ‹¬å·&lt;code>{}&lt;/code>åŒ…å›´, æå‡å¯è¯»æ€§.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;runtime&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">counter&lt;/span> &lt;span class="kt">int64&lt;/span>
&lt;span class="nx">wg&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;span class="nx">mutex&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">incCounter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">incCounter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Final counter: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">counter&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">incCounter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//åˆ›å»ºä¸´ç•ŒåŒº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">mutex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nx">val&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">counter&lt;/span>
&lt;span class="c1">//å½“å‰goroutineä»çº¿ç¨‹é€€å‡º, å¹¶å›åˆ°é˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Gosched&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">val&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="nx">counter&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">val&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">mutex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="é€šé“">é€šé“&lt;/h4>
&lt;p>å½“ä¸€ä¸ªèµ„æºéœ€è¦åœ¨goroutineä¹‹é—´å…±äº«æ—¶, é€šé“åœ¨goroutineä¹‹å‰æ¶èµ·äº†ä¸€ä¸ªç®¡é“, å¹¶æä¾›äº†ç¡®ä¿åŒæ­¥äº¤æ¢æ•°æ®çš„æœºåˆ¶.&lt;/p>
&lt;p>å£°æ˜é€šé“æ—¶éœ€è¦æŒ‡å®šè¦å…±äº«çš„æ•°æ®ç±»å‹, åŒ…æ‹¬å…±äº«å†…ç½®ç±»å‹, å‘½åç±»å‹, ç»“æ„ç±»å‹å’Œå¼•ç”¨ç±»å‹çš„å€¼æˆ–è€…æŒ‡é’ˆ.&lt;/p>
&lt;p>éœ€è¦ä½¿ç”¨å…³é”®å­—&lt;code>make&lt;/code>åˆ›å»ºé€šé“. &lt;code>make&lt;/code>çš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦å…³é”®å­—&lt;code>chan&lt;/code>, ä¹‹åè·Ÿç€äº¤æ¢çš„æ•°æ®çš„ç±»å‹. å¦‚æœæ˜¯åˆ›å»ºçš„æœ‰ç¼“å†²çš„é€šé“, ç¬¬äºŒä¸ªå‚æ•°è¦æŒ‡å®šé€šé“çš„ç¼“å†²åŒºçš„å¤§å°.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//æ— ç¼“å†²çš„æ•´å½¢é€šé“
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">unbuffered&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//æœ‰ç¼“å†²çš„å­—ç¬¦ä¸²é€šé“
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">buffered&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šé“æ“ä½œ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//å†™å­—ç¬¦ä¸²åˆ°é€šé“
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">buffered&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="s">&amp;#34;Gopher&amp;#34;&lt;/span>
&lt;span class="c1">//ä»é€šé“æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">value&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buffered&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="æ— ç¼“å†²é€šé“">æ— ç¼“å†²é€šé“&lt;/h5>
&lt;p>unbuffered channelæ˜¯æŒ‡åœ¨æ¥æ”¶å‰æ²¡æœ‰èƒ½åŠ›ä¿å­˜ä»»ä½•å€¼çš„é€šé“. è¿™ç§é€šé“è¦æ±‚å‘é€goroutineå’Œæ¥æ”¶goroutineåŒæ—¶å‡†å¤‡å¥½, æ‰èƒ½å®Œæˆå‘é€å’Œæ¥æ”¶æ“ä½œ. å¦‚æœæ²¡æœ‰åŒæ—¶å‡†å¤‡å¥½, ä¼šå¯¼è‡´å…ˆæ‰§è¡Œå‘é€æˆ–æ¥æ”¶æ“ä½œçš„goroutineé˜»å¡ç­‰å¾….&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15145142937691.jpg" alt="æ— ç¼“å†²té€šé“">&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;math/rand&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;span class="nx">rand&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Seed&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">UnixNano&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">court&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">player&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Lisa&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">court&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">player&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Bill&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">court&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">court&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">player&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">court&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ball&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">court&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Player %s Won\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">rand&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Intn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="mi">13&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Player %s missed\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">court&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Player %s Hit %d\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ball&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">ball&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="nx">court&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">ball&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="æœ‰ç¼“å†²é€šé“">æœ‰ç¼“å†²é€šé“&lt;/h5>
&lt;p>buffered channelæ˜¯ä¸€ç§åœ¨è¢«æ¥æ”¶å‰èƒ½å­˜å‚¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªå€¼çš„é€šé“. å¹¶ä¸è¦æ±‚goroutineä¹‹é—´å¿…é¡»åŒæ—¶å®Œæˆå‘é€å’Œæ¥æ”¶.&lt;/p>
&lt;p>åªæœ‰åœ¨ç¼“å†²åŒºé‡Œæ²¡æœ‰æ•°æ®çš„æ—¶å€™æ¥æ”¶æ‰ä¼šé˜»å¡; åŒæ ·åªæœ‰ç¼“å†²åŒºæ»¡çš„æ—¶å€™å‘é€æ‰ä¼šé˜»å¡.&lt;/p>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15145248018025.jpg" alt="æœ‰ç¼“å†²té€šé“">&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;math/rand&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">workers&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">4&lt;/span>
&lt;span class="nx">taskLoad&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">rand&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Seed&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">UnixNano&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">tasks&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">taskLoad&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">workers&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">workers&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">worker&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tasks&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">taskLoad&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">tasks&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Task : %d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tasks&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">worker&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tasks&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">task&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">tasks&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Work %d shutting down\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Worker: %d : Started %s\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">task&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">sleep&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">rand&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Int63n&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sleep&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Millisecond&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Worker : %d : Completed %s\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">task&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Go In Action è¯»ä¹¦ç¬”è®° äºŒ</title><link>https://atbug.com/go-in-action-two/</link><pubDate>Mon, 01 Jan 2018 12:28:04 +0000</pubDate><guid>https://atbug.com/go-in-action-two/</guid><description>
&lt;h2 id="goè¯­è¨€çš„ç±»å‹ç³»ç»Ÿ">Goè¯­è¨€çš„ç±»å‹ç³»ç»Ÿ&lt;/h2>
&lt;p>Goè¯­è¨€æ˜¯é™æ€ç±»å‹çš„å˜æˆè¯­è¨€. ç¼–è¯‘çš„æ—¶å€™éœ€è¦ç¡®å®šç±»å‹.&lt;/p>
&lt;h3 id="ç”¨æˆ·å®šä¹‰çš„ç±»å‹">ç”¨æˆ·å®šä¹‰çš„ç±»å‹&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">user&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">email&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">ext&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nx">privileged&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>ä½¿ç”¨&lt;/strong>
é›¶å€¼å’Œ&lt;strong>ç»“æ„å­—é¢é‡&lt;/strong>åˆå§‹åŒ–&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//å¼•ç”¨ç±»å‹, å„ä¸ªå­—æ®µåˆå§‹åŒ–ä¸ºå¯¹åº”çš„é›¶å€¼
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">bill&lt;/span> &lt;span class="nx">user&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="p">{&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">//åˆ›å»ºå¹¶åˆå§‹åŒ–, ä½¿ç”¨ç»“æ„å­—é¢é‡
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">lisa&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">{&lt;/span> &lt;span class="c1">//{Lisa lisa@email.com 123 true}
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;Lisa&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">email&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;lisa@email.com&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ext&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">123&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">privileged&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>ç»“æ„å­—é¢é‡çš„èµ‹å€¼æ–¹å¼:&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ä¸åŒè¡Œå£°æ˜æ¯ä¸€ä¸ªå­—æ®µå’Œå¯¹åº”çš„å€¼, å­—æ®µåå’Œå­—æ®µä»¥&lt;code>:&lt;/code>åˆ†éš”, æœ«å°¾ä»¥&lt;code>,&lt;/code>ç»“å°¾&lt;/li>
&lt;li>ä¸é€‚ç”¨å­—æ®µå, åªå£°æ˜å¯¹åº”çš„å€¼. å†™åœ¨ä¸€è¡Œé‡Œ, ä»¥&lt;code>,&lt;/code>åˆ†éš”, ç»“å°¾ä¸éœ€è¦&lt;code>,&lt;/code>. &lt;strong>è¦ä¿è¯é¡ºåº&lt;/strong>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">lisa&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;Lisa&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;lisa@email.com&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">123&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>ä½¿ç”¨å…¶ä»–ç±»å‹ç»“æ„å£°æ˜å­—æ®µ&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">admin&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">person&lt;/span> &lt;span class="nx">user&lt;/span>
&lt;span class="nx">level&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fred&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">admin&lt;/span>&lt;span class="p">{&lt;/span> &lt;span class="c1">//{{Fred fred@email.com 123 true} super}
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">person&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;Fred&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">email&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;fred@email.com&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ext&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">123&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">privileged&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nx">level&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;super&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>å¦ä¸€ç§å£°æ˜ç”¨æˆ·å®šä¹‰çš„ç±»å‹çš„æ–¹æ³•æ˜¯, åŸºäºä¸€ä¸ªå·²æœ‰çš„ç±»å‹, å°†å…¶ä½œä¸ºæ–°ç±»å‹çš„ç±»å‹è¯´æ˜&lt;/strong>
æ–°çš„ç±»å‹æ˜¯ç‹¬ç«‹çš„ç±»å‹, &lt;em>å€¼äº’ç›¸å…¼å®¹, ä½†ä¸èƒ½äº’ç›¸èµ‹å€¼&lt;/em>.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Duration&lt;/span> &lt;span class="kt">int64&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">d&lt;/span> &lt;span class="nx">Duration&lt;/span>
&lt;span class="c1">//d = int64(1000) #ç¼–è¯‘é”™è¯¯cannot use int64(1000) (type int64) as type Duration in assignment
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">d&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ–¹æ³•">æ–¹æ³•&lt;/h3>
&lt;p>æè¿°ç”¨æˆ·è‡ªå®šä¹‰ç±»å‹çš„è¡Œä¸º, å®é™…ä¸ºå‡½æ•°. åªæ˜¯åœ¨å£°æ˜çš„æ—¶å€™åœ¨&lt;code>func&lt;/code>å’Œæ–¹æ³•åä¹‹é—´å¢åŠ äº†ä¸€ä¸ªå‚æ•°(æ¥æ”¶è€…), å°†å‡½æ•°å’Œæ¥æ”¶è€…çš„ç±»å‹ç»‘å®šåˆ°ä¸€èµ·.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">user&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">email&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">u&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Sending User Email To %s&amp;lt;%s&amp;gt;\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">u&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">u&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">email&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">u&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">user&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">changeEmail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">email&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">u&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">email&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">email&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">bill&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;Bill&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;bill@email.com&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nx">bill&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">lisa&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">user&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;Lisa&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;lisa@email.com&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nx">lisa&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//å®é™…æ‰§è¡Œ (*lisa).notify()
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">bill&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">changeEmail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;bill@newDomain.com&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//å®é™…æ‰§è¡Œ (&amp;amp;bill).changeEmail(&amp;#34;bill@newDomain.com&amp;#34;)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">bill&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">lisa&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">changeEmail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;lisa@newDomain.com&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">lisa&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//å®é™…æ‰§è¡Œ (*lisa).notify()
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">//Sending User Email To Bill&amp;lt;bill@email.com&amp;gt;
&lt;/span>&lt;span class="c1">//Sending User Email To Lisa&amp;lt;lisa@email.com&amp;gt;
&lt;/span>&lt;span class="c1">//Sending User Email To Bill&amp;lt;bill@newDomain.com&amp;gt;
&lt;/span>&lt;span class="c1">//Sending User Email To Lisa&amp;lt;lisa@newDomain.com&amp;gt;
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Goè¯­è¨€é‡Œæœ‰ä¸¤ç§ç±»å‹çš„æ¥æ”¶è€…: å€¼æ¥æ”¶è€…å’ŒæŒ‡é’ˆæ¥æ”¶è€….&lt;/p>
&lt;ul>
&lt;li>å¦‚æœä½¿ç”¨å€¼æ¥æ”¶è€…, è°ƒç”¨çš„æ—¶å€™ä¼šä½¿ç”¨&lt;strong>å€¼çš„å‰¯æœ¬&lt;/strong>æ¥æ‰§è¡Œ&lt;/li>
&lt;li>å¦‚æœä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…, è°ƒç”¨çš„æ—¶å€™è¿™ä¸ªæ–¹æ³•ä¼šå…±äº«è°ƒç”¨æ–¹æ³•æ—¶æ¥æ”¶è€…æ‰€æŒ‡å‘çš„å€¼&lt;/li>
&lt;/ul>
&lt;h3 id="ç±»å‹çš„æœ¬è´¨">ç±»å‹çš„æœ¬è´¨&lt;/h3>
&lt;p>å£°æ˜ç±»å‹çš„æ–¹æ³•å‰è¦ç¡®å®šè¯¥æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªæ–°å€¼(ä½¿ç”¨å€¼æ¥æ”¶è€…), è¿˜æ˜¯ä¿®æ”¹å½“å‰å€¼(ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…)&lt;/p>
&lt;h4 id="å†…ç½®ç±»å‹">å†…ç½®ç±»å‹&lt;/h4>
&lt;p>ç”±è¯­è¨€æä¾›: æ•°å€¼ç±»å‹, å¸ƒå°”ç±»å‹, å­—ç¬¦ä¸²ç±»å‹. æœ¬è´¨ä¸Šæ˜¯åŸå§‹ç±»å‹.
å¯¹è¿™äº›å€¼å¢åŠ æˆ–åˆ é™¤æ“ä½œçš„æ­»å, éƒ½ä¼šåˆ›å»ºæ–°çš„å€¼.&lt;/p>
&lt;p>å¦‚ &lt;code>golang.org/src/strings/strings.go&lt;/code>çš„&lt;code>Trim&lt;/code>å‡½æ•°ä¼ å…¥å­—ç¬¦ä¸²å€¼, è¿”å›æ–°çš„å­—ç¬¦ä¸².&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">Trim&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cutset&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">cutset&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">s&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">TrimFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">makeCutsetFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cutset&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å¼•ç”¨ç±»å‹">å¼•ç”¨ç±»å‹&lt;/h4>
&lt;p>Goè¯­è¨€é‡Œæœ‰å‡ ç§: åˆ‡ç‰‡, æ˜ å°„, é€šé“, æ¥å£å’Œå‡½æ•°ç±»å‹.&lt;/p>
&lt;p>å£°æ˜ä¸Šè¿°ç±»å‹çš„å˜é‡æ—¶, åˆ›å»ºçš„å˜é‡è¢«ç§°ä½œæ ‡å¤´(header)å€¼. æ¯ä¸ªå¼•ç”¨ç±»å‹åˆ›å»ºçš„æ ‡å¤´å€¼æ˜¯åŒ…å«ä¸€ä¸ªæŒ‡å‘åº•å±‚æ•°æ®ç»“æ„çš„æŒ‡é’ˆ.
æ ‡å¤´å€¼é‡ŒåŒ…å«ä¸€ä¸ªæŒ‡é’ˆ, é€šè¿‡å¤åˆ¶æ¥ä¼ é€’ä¸€ä¸ªå¼•ç”¨ç±»å‹çš„å€¼å¾—å‰¯æœ¬, æœ¬è´¨æ˜¯å°±æ˜¯åœ¨å…±äº«åº•å±‚æ•°æ®ç»“æ„.&lt;/p>
&lt;p>&lt;code>golang.org/src/net/ip.go&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">IP&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ç»“æ„ç±»å‹">ç»“æ„ç±»å‹&lt;/h4>
&lt;p>æè¿°ä¸€ç»„æ•°æ®å€¼, è¿™ç»„å€¼å¯ä»¥æ˜¯åŸå§‹ç±»å‹, ä¹Ÿå¯ä»¥æ˜¯éåŸå§‹çš„.
ç»“æ„ç±»å‹çš„æœ¬è´¨æ˜¯éåŸå§‹çš„. å¯¹è¿™ä¸ªç±»å‹çš„å€¼åšå¢åŠ æˆ–è€…åˆ é™¤çš„æ“ä½œåº”è¯¥æ›´æ”¹å€¼æœ¬èº«. å½“éœ€è¦ä¿®æ”¹å€¼æœ¬èº«æ—¶, åœ¨ç¨‹åºä¸­å…¶ä»–åœ°æ–¹, éœ€è¦ä½¿ç”¨æŒ‡é’ˆæ¥å…±äº«è¿™ä¸ªå€¼.&lt;/p>
&lt;p>&lt;code>golang.org/time/time.go&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Time&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">wall&lt;/span> &lt;span class="kt">uint64&lt;/span>
&lt;span class="nx">ext&lt;/span> &lt;span class="kt">int64&lt;/span>
&lt;span class="nx">loc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Location&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Now&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Time&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//å€¼æ¥æ”¶è€…, è¿”å›æ–°çš„Time
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span> &lt;span class="nx">Time&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span> &lt;span class="nx">Duration&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Time&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span> &lt;span class="nx">Time&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//æŒ‡é’ˆæ¥æ”¶è€…
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">UnmarshalBinary&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœä¸€ä¸ªåˆ›å»ºç”¨çš„å·¥å‚å‡½æ•°è¿”å›äº†ä¸€ä¸ªæŒ‡é’ˆ, å°±è¡¨ç¤ºè¿™ä¸ªè¢«è¿”å›çš„å€¼çš„æœ¬è´¨æ˜¯éåŸå§‹çš„.
&lt;code>golang.org/src/os/file.go&lt;/code>çš„&lt;code>open&lt;/code>å‡½æ•°.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">File&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="nx">file&lt;/span> &lt;span class="c1">//å†…åµŒç±»å‹: åµŒå…¥çš„æŒ‡é’ˆ, æŒ‡å‘ä¸€ä¸ªæœªå…¬å¼€çš„ç±»å‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//ä¸€ç§ä¿æŠ¤çš„æ–¹å¼
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">file&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">pfd&lt;/span> &lt;span class="nx">poll&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FD&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">dirinfo&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">dirInfo&lt;/span> &lt;span class="c1">// nil unless directory being read
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">nonblock&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="c1">// whether we set nonblocking mode
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">OpenFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">flag&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">perm&lt;/span> &lt;span class="nx">FileMode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">File&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ¥å£">æ¥å£&lt;/h3>
&lt;p>å¤šæ€æ˜¯æŒ‡ä»£ç å¯ä»¥æ ¹æ®ç±»å‹çš„å…·ä½“å®ç°é‡‡å–ä¸åŒè¡Œä¸ºçš„èƒ½åŠ›.
å¦‚æœä¸€ä¸ªç±»å‹å®ç°äº†æŸä¸ªæ¥å£, æ‰€æœ‰ä½¿ç”¨è¿™ä¸ªæ¥å£çš„åœ°æ–¹, éƒ½å¯ä»¥æ”¯æŒè¿™ç§ç±»å‹çš„å€¼.&lt;/p>
&lt;h4 id="æ ‡å‡†åº“">æ ‡å‡†åº“&lt;/h4>
&lt;p>&lt;code>golang.org/src/io/io.go&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Reader&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Writer&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">WriterTo&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">WriteTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span> &lt;span class="nx">Writer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="kt">int64&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//bytes.Bufferå®ç°äº†io.Reader, io.WriteToæ¥å£
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">var&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="nx">bytes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Buffer&lt;/span>
&lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;World!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//os.Stdoutå®ç°äº†io.Writeræ¥å£
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Copy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdout&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å®ç°">å®ç°&lt;/h4>
&lt;p>æ¥å£æ˜¯å®šä¹‰è¡Œä¸ºçš„ç±»å‹, å…·ä½“çš„å®ç°ç”±ç”¨æˆ·å®šä¹‰çš„ç±»å‹å®Œæˆ. ç”¨æˆ·å®šä¹‰çš„ç±»å‹é€šå¸¸ç§°ä½œå®ä½“ç±»å‹.
å¦‚æœç”¨æˆ·å®šä¹‰çš„ç±»å‹å®ç°äº†æŸä¸ªæ¥å£ç±»å‹å£°æ˜çš„ä¸€ç»„æ–¹æ³•, é‚£ä¹ˆè¿™ä¸ªç”¨æˆ·å®šä¹‰çš„ç±»å‹çš„&lt;strong>å€¼&lt;/strong>å°±å¯ä»¥èµ‹ç»™è¿™ä¸ªæ¥å£ç±»å‹çš„&lt;strong>å€¼&lt;/strong>. è¿™ä¸ªèµ‹å€¼ä¼šæŠŠç”¨æˆ·å®šä¹‰çš„ç±»å‹çš„&lt;strong>å€¼&lt;/strong>å­˜å…¥æ¥å£ç±»å‹çš„&lt;strong>å€¼&lt;/strong>.&lt;/p>
&lt;p>æ¥å£çš„å€¼æ˜¯ä¸€ä¸ªä¸¤ä¸ªå­—é•¿åº¦çš„æ•°æ®ç»“æ„:&lt;/p>
&lt;ul>
&lt;li>ç¬¬ä¸€ä¸ªå­—åŒ…å«ä¸€ä¸ªæŒ‡å‘å†…éƒ¨è¡¨(iTable)çš„æŒ‡é’ˆ. å†…éƒ¨è¡¨åŒ…å«äº†æ‰€å­˜å‚¨çš„å€¼çš„ç±»å‹ä¿¡æ¯, è¿˜åŒ…å«äº†ä¸è¿™ä¸ªå€¼ç›¸å…³è”çš„ä¸€ç»„æ–¹æ³•.&lt;/li>
&lt;li>ç¬¬äºŒä¸ªå­—æ˜¯ä¸€ä¸ªæŒ‡å‘æ‰€å­˜å‚¨çš„å€¼çš„æŒ‡é’ˆ.&lt;/li>
&lt;/ul>
&lt;p>è¿™éƒ¨åˆ†å¯ä»¥å‚è€ƒ&lt;a href="https://blog.golang.org/laws-of-reflection">Laws of Reflecation&lt;/a>&lt;/p>
&lt;h4 id="æ–¹æ³•é›†">æ–¹æ³•é›†&lt;/h4>
&lt;p>æ–¹æ³•é›†å®šä¹‰äº†æ¥å£çš„æ¥å—è§„åˆ™.
æ–¹æ³•é›†å®šä¹‰äº†ä¸€ç»„å…³è”åˆ°ç»™å®šç±»å‹çš„å€¼æˆ–è€…æŒ‡é’ˆçš„æ–¹æ³•. å®šä¹‰æ–¹æ³•çš„æ—¶ä½¿ç”¨çš„æ¥æ”¶è€…çš„ç±»å‹å†³å®šäº†è¿™ä¸ªæ–¹æ³•æ˜¯å…³è”åˆ°å€¼è¿˜æ˜¯å…³è”åˆ°æŒ‡é’ˆ, è¿˜æ˜¯ä¸¤ä¸ªéƒ½å…³è”.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">notifier&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">user&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">email&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//notifyæ˜¯ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…å®ç°çš„æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">u&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">user&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Send email to %s&amp;lt;%s&amp;gt;\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">u&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">u&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">email&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">u&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;Bill&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;bill@email.com&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">//sendNotificationTo(u) //ç”¨è¿™ä¸€è¡Œä¼šæœ‰ç¼–è¯‘é”™è¯¯. useræ²¡æœ‰å®ç°notifieræ¥å£, èµ‹å€¼ç»™notifierä¼šå‘ç”Ÿé”™è¯¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">sendNotificationTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">u&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//ä¸Šé¢notifyæ–¹æ³•çš„å®ç°çš„æ¥æ”¶è€…ä¸º useræŒ‡é’ˆ, å› æ­¤åœ¨èµ‹å€¼çš„æ—¶å€™åªèƒ½æ¥å—useræŒ‡é’ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//æˆ–è€…ä¸Šé¢æ–¹æ³•å®ç°çš„æ¥æ”¶è€…æ”¹ä¸ºuser
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">//æ¥å—ä¸€ä¸ªå®ç°äº†notifierçš„å€¼ä½œä¸ºå‚æ•°
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">sendNotificationTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="nx">notifier&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>Goè¯­è¨€è§„èŒƒé‡Œå®šä¹‰çš„æ–¹æ³•é›†çš„è§„åˆ™:&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Values&lt;/th>
&lt;th>Methods Receiver&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>T&lt;/td>
&lt;td>(t T)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>*T&lt;/td>
&lt;td>(t T) and (t *T)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>Tç±»å‹çš„å€¼çš„æ–¹æ³•é›†åªåŒ…å«å€¼æ¥æ”¶è€…å£°æ˜çš„æ–¹æ³•. è€ŒæŒ‡å‘Tç±»å‹çš„æŒ‡é’ˆçš„æ–¹æ³•é›†æ—¢åŒ…æ‹¬æŒ‡é’ˆæ¥æ”¶è€…å£°æ˜çš„æ–¹æ³•, ä¹ŸåŒ…å«å€¼æ¥æ”¶è€…å£°æ˜çš„æ–¹æ³•.&lt;/p>
&lt;p>ä¸Šé¢çš„ä»£ç ç¨å¾®åšä¸‹ä¿®æ”¹, æ›´åŠ æ¸…æ™°ä¸€äº›.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">notifier&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">user&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">email&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//notifyæ˜¯ä½¿ç”¨å€¼æ¥æ”¶è€…å®ç°çš„æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">u&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Send email to %s&amp;lt;%s&amp;gt;\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">u&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">u&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">email&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">u&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;Bill&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;bill@email.com&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nf">sendNotificationTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">u&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">sendNotificationTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">u&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//&amp;amp;uèµ‹å€¼ç»™notifierçš„å˜é‡næ—¶, nçš„æ–¹æ³•é›†åŒ…å«äº†å€¼æ¥æ”¶è€…å®ç°çš„æ–¹æ³•.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">sendNotificationTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="nx">notifier&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…æ¢ä¸ªè§’åº¦, ä»æ¥æ”¶è€…æ¥çœ‹.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Method Receiver&lt;/th>
&lt;th>Value&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>(t T)&lt;/td>
&lt;td>T and *T&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(t *T)&lt;/td>
&lt;td>*T&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…å®ç°çš„æ¥å£, é‚£åªæœ‰æŒ‡å‘é‚£ä¸ªç±»å‹çš„æŒ‡é’ˆæ‰èƒ½å®ç°å¯¹åº”çš„æ¥å£. ä½¿ç”¨å€¼æ¥æ”¶è€…å®ç°çš„æ¥å£, é‚£ä¹ˆé‚£ä¸ªç±»å‹çš„å€¼å’ŒæŒ‡é’ˆéƒ½èƒ½å¤Ÿå®ç°å¯¹åº”çš„æ¥å£.&lt;/p>
&lt;h4 id="å¤šæ€">å¤šæ€&lt;/h4>
&lt;p>ä¸Šé¢çš„å‡½æ•°&lt;code>sendNotificationTo&lt;/code>å…¶å®å°±æ˜¯ä¸€ä¸ªå¤šæ€å‡½æ•°.&lt;/p>
&lt;h3 id="åµŒå…¥ç±»å‹">åµŒå…¥ç±»å‹&lt;/h3>
&lt;p>type embedding, Goè¯­è¨€å…è®¸ç”¨æˆ·æ‰©å±•æˆ–è€…ä¿®æ”¹å·²æœ‰ç±»å‹çš„è¡Œä¸º. å¯ç”¨äºä»£ç å¤ç”¨, æˆ–ä¿®æ”¹å·²æœ‰ç±»å‹ä»¥ç¬¦åˆæ–°ç±»å‹.
åµŒå…¥ç±»å‹æ˜¯å°†å·²æœ‰ç±»å‹ç›´æ¥å£°æ˜åœ¨æ–°çš„ç»“æ„ç±»å‹é‡Œ. è¢«åµŒå…¥çš„ç±»å‹ç§°ä¸ºæ–°çš„å¤–éƒ¨ç±»å‹çš„å†…éƒ¨ç±»å‹.&lt;/p>
&lt;p>é€šè¿‡åµŒå…¥ç±»å‹, ä¸å†…éƒ¨ç±»å‹ç›¸å…³çš„æ ‡è¯†ç¬¦ä¼šæå‡åˆ°å¤–éƒ¨ç±»å‹ä¸Š, ä¹Ÿæˆä¸ºå¤–éƒ¨ç±»å‹çš„ä¸€éƒ¨åˆ†. å¤–éƒ¨ç±»å‹ä¹Ÿå¯ä»¥é€šè¿‡å£°æ˜ç›¸åŒåç§°çš„æ ‡è¯†ç¬¦æ¥è¦†ç›–å†…éƒ¨ç±»å‹çš„æ ‡è¯†ç¬¦çš„å­—æ®µæˆ–è€…æ–¹æ³•, è¿™å°±æ˜¯ä¿®æ”¹å†…éƒ¨ç±»å‹çš„å±æ€§æˆ–è€…è¡Œä¸ºå®ç°. ä¹Ÿå¯ä»¥æ·»åŠ æ–°çš„å­—æ®µå’Œæ–¹æ³•.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">notifier&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">user&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">email&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">admin&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//å¤–éƒ¨ç±»å‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">user&lt;/span> &lt;span class="c1">//å†…éƒ¨ç±»å‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">level&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">u&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">user&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Send email to %s&amp;lt;%s&amp;gt;\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">u&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">u&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">email&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ad&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">admin&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">user&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;John&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">email&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;john@email.com&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nx">level&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;super&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">ad&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">user&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//å¯ä»¥ç›´æ¥è®¿é—®å†…éƒ¨ç±»å‹çš„æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">ad&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//å†…éƒ¨ç±»å‹çš„æ–¹æ³•ä¹Ÿè¢«æå‡åˆ°å¤–éƒ¨ç±»å‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">endNotificationTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">ad&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//ç”±äºå†…éƒ¨ç±»å‹çš„æå‡, å†…éƒ¨ç±»å‹å®ç°çš„æ¥å£ä¹Ÿè¢«æå‡åˆ°å¤–éƒ¨ç±»å‹. å¤–éƒ¨ç±»å‹ä¹Ÿå¯ä»¥æä¾›åŒåçš„æ–¹æ³•å®ç°, ä»¥è¾¾åˆ°è¦†ç›–çš„æ•ˆæœ.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">sendNotificationTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="nx">notifier&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœå¤–éƒ¨ç±»å‹åšäº†æ–¹æ³•è¦†ç›–, å¯¹å†…éƒ¨ç±»å‹æ–¹æ³•çš„è®¿é—®ä¹Ÿè¿˜æ˜¯ä¼šç»§ç»­æ‰§è¡Œå†…éƒ¨ç±»å‹çš„æ–¹æ³•&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ad&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">admin&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">ad&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">user&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//æ‰§è¡Œå†…éƒ¨ç±»å‹çš„æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">ad&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">notify&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//æ‰§è¡Œå¤–éƒ¨ç±»å‹çš„æ–¹æ³•
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å…¬å¼€æˆ–æœªå…¬å¼€çš„æ ‡è¯†ç¬¦">å…¬å¼€æˆ–æœªå…¬å¼€çš„æ ‡è¯†ç¬¦&lt;/h3>
&lt;p>ä½¿ç”¨è§„åˆ™æ¥æ§åˆ¶å£°æ˜åçš„æ ‡è¯†ç¬¦çš„å¯è§æ€§. Goè¯­è¨€æ”¯æŒä»åŒ…é‡Œå…¬å¼€æˆ–è€…éšè—è¡¨ç¤º. è¿™é‡Œçš„æ ‡è¯†ç¬¦åŒ…æ‹¬ç±»å‹, å˜é‡, æ–¹æ³•.
å½“ä¸€ä¸ªæ ‡è¯†ç¬¦çš„åå­—æ˜¯å°å†™å¼€å¤´çš„æ—¶å€™, è¿™ä¸ªæ ‡è¯†ç¬¦å°±æ˜¯æœªå…¬å¼€çš„. å¦‚æœæ˜¯å¤§å†™å­—æ¯å¼€å¤´å°±æ˜¯å…¬å¼€çš„, åŒ…å¤–çš„ä»£ç å¯è§.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">user&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">User&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="c1">//å…¬å¼€å­—æ®µ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">email&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="c1">//æœªå…¬å¼€å­—æ®µ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">//æ„é€ å™¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">email&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">User&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">email&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">---------------&lt;/span>
&lt;span class="kn">package&lt;/span> &lt;span class="nx">another&lt;/span>
&lt;span class="c1">//åœ¨å¦ä¸€ä¸ªåŒ…é‡Œä½¿ç”¨Userç±»å‹
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">u&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;Bill&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">email&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;bill@email.com&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">//ç¼–è¯‘å™¨æŠ¥é”™, æ‰¾ä¸åˆ°emailå­—æ®µ. å› ä¸ºemailå­—æ®µæœªå…¬å¼€
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ä½¿ç”¨æ„é€ å™¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">ur&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Bill&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;bill@email.com&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>å…¬å¼€æˆ–è€…æœªå…¬å¼€çš„æ ‡è¯†ç¬¦, ä¸æ˜¯ä¸€ä¸ªå€¼&lt;/li>
&lt;li>çŸ­å˜é‡å£°æ˜æ“ä½œç¬¦(:=), æœ‰èƒ½åŠ›æ•è·å¼•ç”¨çš„ç±»å‹, å¹¶åˆ›å»ºä¸€ä¸ªæœªå…¬å¼€çš„ç±»å‹çš„å˜é‡.&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">counter&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">alertCounter&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">//æœªå…¬å¼€ç±»å‹
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">---------------&lt;/span>
&lt;span class="kn">package&lt;/span> &lt;span class="nx">another&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//c = counter.alertCounter ç¼–è¯‘ä¼šæŠ¥é”™, æ— æ³•è®¿é—®æœªå…¬å¼€æ ‡è¯†ç¬¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">counter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">alertCounter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">counter&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// 20
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Go In Action è¯»ä¹¦ç¬”è®° ä¸€</title><link>https://atbug.com/go-in-action-one/</link><pubDate>Mon, 01 Jan 2018 12:27:10 +0000</pubDate><guid>https://atbug.com/go-in-action-one/</guid><description>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15142714785285.jpg" alt="æ¶æ„æµç¨‹å›¾">&lt;/p>
&lt;h2 id="å…³é”®å­—">å…³é”®å­—&lt;/h2>
&lt;h3 id="var">var&lt;/h3>
&lt;p>å˜é‡ä½¿ç”¨&lt;code>var&lt;/code>å£°æ˜, å¦‚æœå˜é‡ä¸æ˜¯å®šä¹‰åœ¨ä»»ä½•ä¸€ä¸ªå‡½æ•°ä½œç”¨åŸŸå†…, è¿™ä¸ªå˜é‡å°±æ˜¯åŒ…çº§å˜é‡.&lt;/p>
&lt;blockquote>
&lt;p>Goè¯­è¨€ä¸­, æ‰€æœ‰å˜é‡éƒ½è¢«åˆå§‹åŒ–ä¸ºå…¶&lt;strong>é›¶å€¼&lt;/strong>. å¯¹äºæ•°å€¼ç±»å‹, å…¶é›¶å€¼æ˜¯&lt;strong>0&lt;/strong>; å¯¹äºå­—ç¬¦ä¸²ç±»å‹, å…¶é›¶å€¼æ˜¯&lt;strong>ç©ºå­—ç¬¦ä¸²&amp;quot;&amp;quot;&lt;/strong>; å¯¹äºå¸ƒå°”ç±»å‹, å…¶é›¶å€¼æ˜¯&lt;strong>false&lt;/strong>. å¯¹äºå¼•ç”¨ç±»å‹æ¥è¯´, åº•å±‚æ•°æ®ç»“æ„ä¼šè¢«åˆå§‹åŒ–å¯¹åº”çš„é›¶å€¼. ä½†æ˜¯è¢«ç”Ÿå‘½è¢«èµ·é›¶å€¼çš„å¼•ç”¨ç±»å‹çš„å˜é‡, ä¼šè¿”å›&lt;strong>nil&lt;/strong>ä½œä¸ºå…¶å€¼.&lt;/p>
&lt;/blockquote>
&lt;h3 id="const">const&lt;/h3>
&lt;p>å®šä¹‰å¸¸é‡&lt;/p>
&lt;h3 id="interface">interface&lt;/h3>
&lt;p>å£°æ˜æ¥å£&lt;/p>
&lt;h3 id="func">func&lt;/h3>
&lt;p>å£°æ˜å‡½æ•°&lt;/p>
&lt;h3 id="defer">defer&lt;/h3>
&lt;p>å®‰æ’åé¢çš„å‡½æ•°è°ƒç”¨åœ¨å½“å‰å‡½æ•°è¿”å›æ—¶æ‰æ‰§è¡Œ.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;filePath&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nb">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="err">#&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="nx">file&lt;/span> &lt;span class="nx">operation&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="go">go&lt;/h3>
&lt;p>å¯åŠ¨åé¢çš„å‡½æ•°ä½œä¸º&lt;code>goroutine&lt;/code>, å¦‚ä¸‹é¢å¯åŠ¨åŒ¿åå‡½æ•°ä½œä¸º&lt;code>goroutine&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(){}()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="import">import&lt;/h3>
&lt;p>å¯¼å…¥åŒ…, è®©ä½¿ç”¨è€…å¯ä»¥è®¿é—®å…¶ä¸­çš„æ ‡è¯†ç¬¦, å¦‚ç±»å‹, å‡½æ•°, å¸¸é‡å’Œæ¥å£.
ç¼–è¯‘å™¨æŸ¥æ‰¾åŒ…æ—¶ä¼šä»&lt;code>GOROOT&lt;/code>å’Œ&lt;code>GOPATH&lt;/code>ç¯å¢ƒå˜é‡å¼•ç”¨çš„ä½ç½®å»æŸ¥æ‰¾.
å¦‚æœå¼•ç”¨çš„åŒ…åå‰ä½¿ç”¨ä¸‹åˆ’çº¿&lt;code>_&lt;/code>, è¡¨æ˜ä¸ç›´æ¥ä½¿ç”¨åŒ…é‡Œçš„æ ‡è¯†ç¬¦, åªæ˜¯è°ƒç”¨å…¶&lt;code>init&lt;/code>å‡½æ•°æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="nx">_&lt;/span> &lt;span class="kn">package&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">hasNoPublicIdentifier&lt;/span>
&lt;span class="kn">package&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">hasPublicIdentifier&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="range">range&lt;/h3>
&lt;p>ç”¨äºè¿­ä»£æ•°ç»„, å­—ç¬¦ä¸², åˆ‡ç‰‡, æ˜ å°„å’Œé€šé“&lt;/p>
&lt;p>è¿­ä»£é€šé“æ—¶, å¦‚æœé€šé“ä¸­æ²¡æœ‰æ•°æ®æ—¶ä¼šé˜»å¡; æœ‰æ•°æ®å†™å…¥æ—¶ä¼šè§¦å‘æ‰§è¡Œåé¢çš„ä»£ç . å¦‚æœé€šé“å…³é—­, è¿­ä»£é€€å‡º.&lt;/p>
&lt;h3 id="type">type&lt;/h3>
&lt;p>å£°æ˜ç»“æ„ç±»å‹&lt;/p>
&lt;h3 id="struct">struct&lt;/h3>
&lt;p>ç»“æ„ç±»å‹&lt;/p>
&lt;h2 id="è¯­æ³•">è¯­æ³•&lt;/h2>
&lt;h3 id="æ ‡è¯†ç¬¦">æ ‡è¯†ç¬¦&lt;/h3>
&lt;p>å°å†™å­—æ¯å¼€å¤´çš„æ ‡è¯†ç¬¦ä¸ä¼šæš´éœ², åªä¼šæš´éœ²å¤§å†™å­—æ¯å¼€å¤´çš„æ ‡è¯†ç¬¦&lt;/p>
&lt;h3 id="mainåŒ…">mainåŒ…&lt;/h3>
&lt;p>ç¨‹åºçš„å…¥å£å¯ä»¥åœ¨main.goæ–‡ä»¶é‡Œæ‰¾åˆ°. æ¯ä¸ªå¯æ‰§è¡Œçš„Goç¨‹åºæœ‰2ä¸ªç‰¹å¾: æœ‰&lt;code>main&lt;/code>å‡½æ•°, ç¨‹åºçš„ç¬¬01è¡ŒåŒ…åä¸º&lt;code>main&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">()&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="initå‡½æ•°">initå‡½æ•°&lt;/h3>
&lt;p>&lt;code>init&lt;/code>å‡½æ•°æ€»æ˜¯åœ¨&lt;code>main&lt;/code>å‡½æ•°è°ƒç”¨ä¹‹å‰è¢«è°ƒç”¨. å¸¸è§&lt;code>import&lt;/code>ä¸­ä½¿ç”¨ä¸‹åˆ’çº¿&lt;code>_&lt;/code>å¼•å…¥æ²¡æœ‰æš´éœ²ä»»ä½•æ ‡è¯†ç¬¦çš„åŒ…, è°ƒç”¨å…¶&lt;code>init&lt;/code>å‡½æ•°&lt;/p>
&lt;h3 id="åŒ…">åŒ…&lt;/h3>
&lt;p>æ‰€æœ‰å¤„äºåŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„ä»£ç æ–‡ä»¶, å¿…é¡»ä½¿ç”¨åŒæ ·çš„åŒ…å&lt;/p>
&lt;h3 id="ä¸€ä¸ªå‡½æ•°å¤šä¸ªè¿”å›å€¼">ä¸€ä¸ªå‡½æ•°å¤šä¸ªè¿”å›å€¼&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">RetriveValue&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ç®€åŒ–å£°æ˜å˜é‡è¿ç®—ç¬¦-">ç®€åŒ–å£°æ˜å˜é‡è¿ç®—ç¬¦ (:=)&lt;/h3>
&lt;p>å£°æ˜å˜é‡åŒæ—¶èµ‹å€¼, æ ¹æ®åé¢çš„ç±»å‹ç¡®å®šå˜é‡çš„ç±»å‹.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">val&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å‡½æ•°é—´çš„å˜é‡ä¼ é€’">å‡½æ•°é—´çš„å˜é‡ä¼ é€’&lt;/h3>
&lt;p>éƒ½æ˜¯&lt;strong>å€¼ä¼ é€’&lt;/strong>&lt;/p>
&lt;h2 id="æ•°ç»„-åˆ‡ç‰‡å’Œæ˜ å°„">æ•°ç»„, åˆ‡ç‰‡å’Œæ˜ å°„&lt;/h2>
&lt;h3 id="æ•°æ®">æ•°æ®&lt;/h3>
&lt;p>é•¿åº¦å›ºå®šçš„æ•°æ®ç±»å‹. åœ¨å†…å­˜ä¸­çš„å ç”¨æ˜¯è¿ç»­çš„.&lt;/p>
&lt;h4 id="å£°æ˜å’Œåˆå§‹åŒ–">å£°æ˜å’Œåˆå§‹åŒ–&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="nx">array&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;span class="nx">array&lt;/span> &lt;span class="o">:=&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nx">array&lt;/span> &lt;span class="o">:=&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nx">array&lt;/span> &lt;span class="o">:=&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="nx">array&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">ä¸º0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ä½¿ç”¨">ä½¿ç”¨&lt;/h4>
&lt;p>ä½¿ç”¨ç´¢å¼•è®¿é—®&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">array&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="mi">2&lt;/span>
&lt;span class="nx">array&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]=&lt;/span>&lt;span class="mi">3&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="nx">ä¿®æ”¹&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="æŒ‡é’ˆæ•°ç»„">æŒ‡é’ˆæ•°ç»„&lt;/h5>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">array&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)}&lt;/span>
&lt;span class="c1">//å¤åˆ¶
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">array&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]=&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="nx">array&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]=&lt;/span>&lt;span class="mi">2&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="å¤šç»´æ•°ç»„">å¤šç»´æ•°ç»„&lt;/h5>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">array&lt;/span> &lt;span class="o">:=&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">}}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å‡½æ•°é—´ä¼ é€’æ•°ç»„">å‡½æ•°é—´ä¼ é€’æ•°ç»„&lt;/h4>
&lt;p>å€¼ä¼ é€’&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//å£°æ˜ä¸€ä¸ªéœ€è¦8MBçš„æ•°ç»„
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">array&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mf">1e6&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;span class="c1">//ä¼ é€’æ•°ç»„
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nf">foo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">array&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//æ¥å—ä¸€ä¸ª100wä¸ªæ•´å½¢å€¼çš„æ•°ç»„
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">foo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">array&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mf">1e6&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">){}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨æŒ‡é’ˆä¼ é€’&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//å£°æ˜ä¸€ä¸ªéœ€è¦8MBçš„æ•°ç»„
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">array&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mf">1e6&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;span class="c1">//ä¼ é€’æ•°ç»„
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nf">foo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">array&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">foo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">array&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mf">1e6&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">){}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ‡ç‰‡">åˆ‡ç‰‡&lt;/h3>
&lt;p>ä¸€ç§æ•°æ®ç»“æ„, ä¾¿äºä½¿ç”¨å’Œç®¡ç†æ•°æ®é›†åˆ. æ˜¯å›´ç»•&lt;strong>åŠ¨æ€æ•°ç»„&lt;/strong>çš„æ¦‚å¿µåˆ›å»ºçš„, å°±æ˜¯å¯å˜(å¢é•¿æˆ–ç¼©å°)æ•°ç»„.
&lt;strong>åˆ‡é¢çš„åº•å±‚å†…å­˜ä¹Ÿæ˜¯åœ¨è¿ç»­å¿«ä¸­åˆ†é…çš„&lt;/strong>, ä¹Ÿèƒ½è·å¾—ç´¢å¼•,è¿­ä»£.
åˆ‡ç‰‡çš„åŠ¨æ€å¢é•¿æ˜¯é€šè¿‡å†…ç½®å‡½æ•°&lt;code>append&lt;/code>å®ç°çš„.&lt;/p>
&lt;p>åˆ‡ç‰‡æ˜¯ä¸€ä¸ªå¾ˆå°çš„å¯¹è±¡, å¯¹åº•å±‚æ•°ç»„è¿›è¡Œäº†æŠ½è±¡, å¹¶æä¾›æ“ä½œæ–¹æ³•.
åŒ…å«ä¸‰ä¸ªå­—æ®µ: æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆ, å…ƒç´ ä¸ªæ•°(é•¿åº¦)å’Œå®¹é‡.&lt;/p>
&lt;h4 id="åˆ›å»ºå’Œåˆå§‹åŒ–">åˆ›å»ºå’Œåˆå§‹åŒ–&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//æŒ‡å®šé•¿åº¦, é•¿åº¦ç­‰äºå®¹é‡
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">slice&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//æŒ‡å®šé•¿åº¦å’Œå®¹é‡, åªèƒ½è®¿é—®3ä¸ª, å…¶ä½™2ä¸ªé€šè¿‡åæœŸæ“ä½œåˆå¹¶
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">slice&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">slice&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h6 id="nilå’Œç©ºåˆ‡ç‰‡">nilå’Œç©ºåˆ‡ç‰‡&lt;/h6>
&lt;p>nilåˆ‡ç‰‡&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="nx">slice&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç©ºåˆ‡ç‰‡, é•¿åº¦ä¸º0, å®¹é‡ä¸º0&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">slice&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">slice&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="ä½¿ç”¨åˆ‡ç‰‡">ä½¿ç”¨åˆ‡ç‰‡&lt;/h5>
&lt;h6 id="ä½¿ç”¨ä¸€ä¸ªç´¢å¼•è®¿é—®æ•°ç»„å…ƒç´ ">ä½¿ç”¨ä¸€ä¸ªç´¢å¼•è®¿é—®æ•°ç»„å…ƒç´ &lt;/h6>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">slice&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]=&lt;/span>&lt;span class="mi">10&lt;/span>
&lt;span class="nx">slice&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="mi">10&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨åˆ‡ç‰‡åˆ›å»ºåˆ‡ç‰‡, &lt;strong>æ–°æ—§åˆ‡ç‰‡å…±äº«åº•å±‚æ•°ç»„&lt;/strong>&lt;/p>
&lt;h6 id="ä½¿ç”¨ä¸¤ä¸ªç´¢å¼•åˆ›å»ºæ–°çš„ç´¢å¼•å…±ç”¨åº•å±‚æ•°ç»„">ä½¿ç”¨ä¸¤ä¸ªç´¢å¼•åˆ›å»ºæ–°çš„ç´¢å¼•(å…±ç”¨åº•å±‚æ•°ç»„)&lt;/h6>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//åº•å±‚æ•°ç»„é•¿åº¦ä¸º5
&lt;/span>&lt;span class="c1">//é•¿åº¦ä¸º2 = 3 - 1
&lt;/span>&lt;span class="c1">//å®¹é‡ä¸º4 = 5 - 1
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">newSlice&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">slice&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å¢é•¿">å¢é•¿&lt;/h4>
&lt;p>ä½¿ç”¨å†…ç½®çš„&lt;code>append&lt;/code>æ–¹æ³•è¿½åŠ , è¿”å›ä¸€ä¸ªæ–°çš„åˆ‡ç‰‡(&lt;strong>æ–°çš„åº•å±‚æ•°ç»„, æ•°ç»„æŒ‡é’ˆæ”¹å˜, é•¿åº¦æ”¹å˜, å®¹å™¨å¯èƒ½æ”¹å˜&lt;/strong>)&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">newSlice&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">appen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">slice&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="ä¸‰ä¸ªç´¢å¼•">ä¸‰ä¸ªç´¢å¼•&lt;/h5>
&lt;p>ä½¿ç”¨ä¸‰ä¸ªç´¢å¼•, ç¬¬ä¸€ä¸ªç´¢å¼•è¡¨ç¤ºèµ·å§‹ä½ç½®, ç¬¬äºŒä¸ªå…ƒç´ è¡¨ç¤ºèµ·å§‹ç´¢å¼•åŠ ä¸Šå¸Œæœ›åŒ…æ‹¬çš„å…ƒç´ ä¸ªæ•° 2 + 1 = 3. ç¬¬ä¸‰ä¸ªç´¢å¼•æ˜¯èµ·å§‹ç´¢å¼•åŠ ä¸Šå®¹é‡ 2 + 2 = 4.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//ä»ç¬¬3ä¸ªå…ƒç´ å¼€å§‹æˆªå–
&lt;/span>&lt;span class="c1">//é•¿åº¦ä¸º1 = 3 - 2
&lt;/span>&lt;span class="c1">//å®¹é‡ä¸º2 = 4 - 2
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">newSlice&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">slice&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="è¿­ä»£åˆ‡ç‰‡">è¿­ä»£åˆ‡ç‰‡&lt;/h4>
&lt;p>ä½¿ç”¨å…³é”®å­—range&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">slice&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">idx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">val&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">slice&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Index: %d Values: %d\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">idx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">val&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//è¿”å›é•¿åº¦
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">slice&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//è¿”å›å®¹é‡
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nb">cap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">slice&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å¤šç»´åˆ‡ç‰‡">å¤šç»´åˆ‡ç‰‡&lt;/h4>
&lt;h4 id="å‡½æ•°é—´çš„åˆ‡ç‰‡ä¼ é€’">å‡½æ•°é—´çš„åˆ‡ç‰‡ä¼ é€’&lt;/h4>
&lt;h3 id="æ˜ å°„">æ˜ å°„&lt;/h3>
&lt;p>å­˜å‚¨ä¸€ç³»åˆ—æ— åºé”®å€¼å¯¹çš„æ•°æ®ç»“æ„, å¯ä»¥åŸºäºé”®å¿«é€Ÿæ£€ç´¢.&lt;/p>
&lt;p>æ˜¯ä¸€ä¸ªé›†åˆ, å¯ä»¥ä½¿ç”¨ç±»ä¼¼æ•°ç»„æˆ–åˆ‡ç‰‡çš„æ–¹å¼è¿­ä»£æ•°ç»„. ä½†æ˜¯æ˜¯æ— åºçš„, æ— æ³•é¢„æµ‹é”®å€¼å¯¹è¢«è¿”å›çš„é¡ºåº.&lt;/p>
&lt;p>æ— åºçš„åŸå› æ˜¯æ˜ å°„ä½¿ç”¨äº†æ•£åˆ—è¡¨.&lt;/p>
&lt;h4 id="å®ç°æ–¹å¼">å®ç°æ–¹å¼&lt;/h4>
&lt;p>æ¡¶çš„æ•°æ®ç»“æ„: ä¸¤ä¸ªæ•°ç»„. ä¸€ä¸ªå­˜å‚¨æ•£åˆ—é”®çš„é«˜å…«ä½å€¼, ç”¨æ¥åšæ¡¶å®šä½. å¦ä¸€ä¸ªæ˜¯å­—èŠ‚æ•°ç»„, ç”¨äºå­˜å‚¨é”®å€¼å¯¹. å…ˆä¸€æ¬¡å­˜å‚¨æ‰€æœ‰çš„é”®, å†ä¸€æ¬¡å­˜å‚¨æ‰€æœ‰çš„å€¼.&lt;/p>
&lt;p>å°†é”®é€šè¿‡æ•£åˆ—å‡½æ•°è®¡ç®—å‡ºæ•£åˆ—å€¼, ç„¶åé€šè¿‡æ•£åˆ—å€¼çš„é«˜å…«ä½å®šä½å‡ºæ¡¶, ç„¶ååœ¨æ¡¶çš„æ•°ç»„é‡Œè¿›è¡Œå­˜å‚¨, åˆ é™¤æˆ–è€…æŸ¥æ‰¾.&lt;/p>
&lt;p>é”®å¯ä»¥æ˜¯ä»»ä½•ç±»å‹, åªè¦è¿™ä¸ªå€¼å¯ä»¥ä½¿ç”¨&lt;code>==&lt;/code>è¿ç®—ç¬¦åšæ¯”è¾ƒ. &lt;strong>åˆ‡ç‰‡, å‡½æ•°ä»¥åŠåŒ…å«åˆ‡ç‰‡çš„æœºæ„ç±»å‹ç”±äºå…·æœ‰å¼•ç”¨è¯­ä¹‰, ä¸èƒ½ä½œä¸ºæ˜ å°„çš„é”®.&lt;/strong>&lt;/p>
&lt;h4 id="åˆ›å»ºå’Œåˆå§‹åŒ–-1">åˆ›å»ºå’Œåˆå§‹åŒ–&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">dict&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">dict&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;red&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s">&amp;#34;#da1337&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;orange&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s">&amp;#34;#e95a22&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ç©ºæ˜ å°„
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">dict&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="c1">//ä½¿ç”¨åˆ‡ç‰‡ä½œä¸ºé”®
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">dict&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{}&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="nx">ç¼–è¯‘é”™è¯¯&lt;/span> &lt;span class="nx">invalid&lt;/span> &lt;span class="kd">map&lt;/span> &lt;span class="nx">key&lt;/span> &lt;span class="kd">type&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ä½¿ç”¨-1">ä½¿ç”¨&lt;/h4>
&lt;p>ç©ºæ˜ å°„&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="err">#&lt;/span>&lt;span class="nx">å£°æ˜ä¸€ä¸ªç©ºæ˜ å°„&lt;/span>
&lt;span class="nx">colors&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">[]{}&lt;/span>
&lt;span class="nx">colors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;red&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;#da1337&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>nilæ˜ å°„&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//å£°æ˜ä¸ºnilæ˜ å°„
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">colors&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="nx">colors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;red&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;#da1337&amp;#34;&lt;/span> &lt;span class="c1">//è¿è¡Œæ—¶å‡ºé”™ assignment to entry in nil map
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ¤æ–­æ˜¯å¦å­˜åœ¨é”®. å¦‚æœä¸å­˜åœ¨existä¸ºfalse, valueä¸ºé›¶å€¼. å¦‚æœå­˜åœ¨existä¸ºtrue, valueä¸ºå¯¹åº”çš„å€¼.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">exists&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">colors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;blue&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">exists&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éå†æ˜ å°„&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">colors&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Key: %s, Value %s\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ é™¤é”®å€¼å¯¹&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nb">delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">colors&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;red&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>è‡ªå®šä¹‰GOPATHä¸‹å®‰è£…godepå¤±è´¥</title><link>https://atbug.com/install-godep-issue-in-custom-gopath/</link><pubDate>Fri, 22 Dec 2017 13:02:38 +0000</pubDate><guid>https://atbug.com/install-godep-issue-in-custom-gopath/</guid><description>
&lt;p>æˆ‘çš„ç¯å¢ƒå˜é‡æ˜¯è¿™æ ·çš„:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nb">export&lt;/span> &lt;span class="nv">GOROOT&lt;/span>&lt;span class="o">=&lt;/span>/usr/local/go
&lt;span class="nb">export&lt;/span> &lt;span class="nv">GOPATH&lt;/span>&lt;span class="o">=&lt;/span>/Users/addo/Workspaces/go_w
&lt;span class="nb">export&lt;/span> &lt;span class="nv">GOBIN&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$GOROOT&lt;/span>/bin
&lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$PATH&lt;/span>:&lt;span class="nv">$GOBIN&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å®‰è£…æŠ¥é”™:&lt;/p>
&lt;p>&lt;code>go get -v github.com/tools/godep&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>github.com/tools/godep (download)
github.com/tools/godep/vendor/github.com/pmezard/go-difflib/difflib
github.com/tools/godep/vendor/github.com/kr/fs
github.com/tools/godep/vendor/github.com/kr/text
github.com/tools/godep/vendor/golang.org/x/tools/go/vcs
github.com/tools/godep/vendor/github.com/kr/pretty
github.com/tools/godep
go install github.com/tools/godep: open /usr/local/go/bin/godep: permission denied&lt;/p>
&lt;/blockquote>
&lt;p>é»˜è®¤æ˜¯å®‰è£…åˆ°&lt;code>$GOBIN&lt;/code>ç›®å½•ä¸‹, æƒé™ä¸å¤Ÿ.&lt;/p>
&lt;p>ä½¿ç”¨:&lt;/p>
&lt;p>&lt;code>sudo go get -v github.com/tools/godep&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>sudo go get -v github.com/tools/godep
github.com/tools/godep (download)
created GOPATH=/Users/addo/go; see &amp;lsquo;go help gopath&amp;rsquo;
github.com/tools/godep/vendor/github.com/kr/fs
github.com/tools/godep/vendor/github.com/kr/text
github.com/tools/godep/vendor/github.com/pmezard/go-difflib/difflib
github.com/tools/godep/vendor/golang.org/x/tools/go/vcs
github.com/tools/godep/vendor/github.com/kr/pretty
github.com/tools/godep&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>$GOBIN&lt;/code>å¹¶æ²¡æœ‰æ‰¾åˆ°&lt;code>godef&lt;/code>. è¾“å‡ºæç¤º&lt;code>created GOPATH=/Users/addo/go; &lt;/code>. å› ä¸ºsudoçš„æ—¶å€™æ‰¾ä¸åˆ°&lt;code>GOPATH&lt;/code>å˜é‡, ä¾¿é‡æ–°åˆ›å»ºäº†ç›®å½•.&lt;/p>
&lt;p>è§£å†³æ–¹æ¡ˆä¸€:&lt;/p>
&lt;ol>
&lt;li>ä¸´æ—¶ä¿®æ”¹&lt;code>GOBIN&lt;/code>: &lt;code>export GOBIN=$GOPATH/bin&lt;/code>&lt;/li>
&lt;li>è¿è¡Œ&lt;code>go get github.com/tools/godep&lt;/code>&lt;/li>
&lt;li>å°†ç”Ÿæˆçš„godefå¤åˆ¶åˆ°&lt;code>GOROOT/bin&lt;/code>ä¸‹&lt;/li>
&lt;li>å›æ»šä¿®æ”¹&lt;code>export GOBIN=$GOROOT/bin; export PATH=$PATH:$GOBIN&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>è§£å†³æ–¹æ¡ˆäºŒ:&lt;/p>
&lt;p>ä¿®æ”¹&lt;code>GOROOT/bin&lt;/code>çš„å±ç»„å±ä¸», å®‰å…¨æ€§é—®é¢˜, ä¸æ¨è.&lt;/p></description></item><item><title>SpringBootæºç  - å¯åŠ¨</title><link>https://atbug.com/glance-over-spring-boot-source/</link><pubDate>Fri, 08 Dec 2017 17:48:43 +0000</pubDate><guid>https://atbug.com/glance-over-spring-boot-source/</guid><description>
&lt;p>SpringBoot Applicationå¯åŠ¨éƒ¨åˆ†çš„æºç é˜…è¯».&lt;/p>
&lt;h2 id="springapplication">SpringApplication&lt;/h2>
&lt;p>å¸¸ç”¨çš„&lt;code>SpringApplication.run(Class, Args)&lt;/code>å¯åŠ¨Springåº”ç”¨, åˆ›å»ºæˆ–è€…æ›´æ–°&lt;code>ApplicationContext&lt;/code>&lt;/p>
&lt;h3 id="é™æ€æ–¹æ³•run">é™æ€æ–¹æ³•run&lt;/h3>
&lt;p>ä½¿ç”¨sourceç±»å®ä¾‹åŒ–ä¸€ä¸ª&lt;code>SpringApplication&lt;/code>å®ä¾‹, å¹¶è°ƒç”¨å®ä¾‹æ–¹æ³•&lt;code>run&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">ConfigurableApplicationContext&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">sources&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SpringApplication&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">run&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="åˆå§‹åŒ–initialize">åˆå§‹åŒ–initialize&lt;/h4>
&lt;ol>
&lt;li>
&lt;p>å®ä¾‹åŒ–çš„æ—¶å€™é¦–å…ˆé€šè¿‡å°è¯•åŠ è½½&lt;code>javax.servlet.Servlet&lt;/code>å’Œ&lt;code>org.springframework.web.context.ConfigurableWebApplicationContext&lt;/code>æ¨æ–­å½“å‰æ˜¯å¦æ˜¯&lt;strong>web&lt;/strong>ç¯å¢ƒ.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç„¶åä»&lt;code>spring.factories&lt;/code>è·å–&lt;code>ApplicationContextInitializer&lt;/code>çš„å®ç°ç±».&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä»&lt;code>spring.factories&lt;/code>è·å–&lt;code>ApplicationListener&lt;/code>çš„å®ç°ç±»&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¨æ–­å‡ºåº”ç”¨çš„å¯åŠ¨ç±»(åŒ…å«mainæ–¹æ³•çš„ç±»): æ£€æŸ¥çº¿ç¨‹æ ˆä¸­å…ƒç´ çš„æ–¹æ³•åæ˜¯å¦æ˜¯&lt;code>main&lt;/code>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">private&lt;/span> &lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;&lt;/span> &lt;span class="n">deduceMainApplicationClass&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//è·å–çº¿ç¨‹æ ˆæ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">StackTraceElement&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">stackTrace&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">RuntimeException&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">StackTraceElement&lt;/span> &lt;span class="n">stackTraceElement&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">stackTrace&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">stackTraceElement&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getMethodName&lt;/span>&lt;span class="o">()))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Class&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">forName&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">stackTraceElement&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getClassName&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ClassNotFoundException&lt;/span> &lt;span class="n">ex&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// Swallow and continue
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ°æ­¤å®ä¾‹åŒ–å°±å®Œæˆäº†.&lt;/p>
&lt;h3 id="å®ä¾‹æ–¹æ³•run">å®ä¾‹æ–¹æ³•run&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="n">ConfigurableApplicationContext&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">StopWatch&lt;/span> &lt;span class="n">stopWatch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">StopWatch&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">stopWatch&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">ConfigurableApplicationContext&lt;/span> &lt;span class="n">context&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="c1">//é»˜è®¤è®¾ç½®java.awt.headlessä¸ºtrue
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">configureHeadlessProperty&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="c1">//ä»spring.factoriesä¸­è·å–org.springframework.boot.SpringApplicationRunListenerçš„å®ç°ç±»
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">SpringApplicationRunListeners&lt;/span> &lt;span class="n">listeners&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getRunListeners&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//é€šè¿‡EventPublishingRunListenerå‘å¸ƒstartedäº‹ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">listeners&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">started&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ApplicationArguments&lt;/span> &lt;span class="n">applicationArguments&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">DefaultApplicationArguments&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//é‡ç‚¹: åˆ›å»ºæ›´æ–°ä¸Šä¸‹æ–‡å¯¹è±¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">context&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createAndRefreshContext&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">listeners&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">applicationArguments&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//ä¸Šä¸‹æ–‡å¯¹è±¡æ›´æ–°å®Œè°ƒç”¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">afterRefresh&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">applicationArguments&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//é€šè¿‡EventPublishingRunListenerå‘å¸ƒfinishedäº‹ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">listeners&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">finished&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">stopWatch&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">stop&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">logStartupInfo&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="n">StartupInfoLogger&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">mainApplicationClass&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">logStarted&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">getApplicationLog&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">stopWatch&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">context&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Throwable&lt;/span> &lt;span class="n">ex&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">handleRunFailure&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">listeners&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ex&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IllegalStateException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="springapplicationrunlistener">SpringApplicationRunListener&lt;/h3>
&lt;p>ç›‘å¬&lt;code>SpringApplication&lt;/code>çš„&lt;code>run&lt;/code>æ–¹æ³•. é€šè¿‡&lt;code>SpringFactoriesLoader&lt;/code>åŠ è½½, å®ç°æ—¶éœ€è¦æä¾›publicçš„æ„é€ æ–¹æ³•æ¥å—&lt;code>SpringApplication&lt;/code>å’Œ&lt;code>String[]&lt;/code>ä¸ºå‚æ•°.
äº‹ä»¶çš„å‘ç”Ÿé¡ºåºä¸º&lt;code>started -&amp;gt; environmentPrepared -&amp;gt; contextPrepared -&amp;gt; contextLoaded -&amp;gt; finished&lt;/code>.&lt;/p>
&lt;p>SpringBooté»˜è®¤ä½¿ç”¨&lt;code>EventPublishingRunListener&lt;/code>è¿™ä¸ªå®ç°ç±», å°†å„ä¸ªäº‹ä»¶å°è£…å¹¶å‘å¸ƒå‡ºå», æœ€ç»ˆè¢«&lt;code>ApplicationListener&lt;/code>æ•è·.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="nc">SpringApplicationRunListener&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">started&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">environmentPrepared&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConfigurableEnvironment&lt;/span> &lt;span class="n">environment&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">contextPrepared&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConfigurableApplicationContext&lt;/span> &lt;span class="n">context&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">contextLoaded&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConfigurableApplicationContext&lt;/span> &lt;span class="n">context&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">finished&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConfigurableApplicationContext&lt;/span> &lt;span class="n">context&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Throwable&lt;/span> &lt;span class="n">exception&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ›å»ºå¹¶æ›´æ–°ä¸Šä¸‹æ–‡å¯¹è±¡createandrefreshcontext">åˆ›å»ºå¹¶æ›´æ–°ä¸Šä¸‹æ–‡å¯¹è±¡createAndRefreshContext&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">private&lt;/span> &lt;span class="n">ConfigurableApplicationContext&lt;/span> &lt;span class="nf">createAndRefreshContext&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SpringApplicationRunListeners&lt;/span> &lt;span class="n">listeners&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ApplicationArguments&lt;/span> &lt;span class="n">applicationArguments&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ConfigurableApplicationContext&lt;/span> &lt;span class="n">context&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="c1">// Create and configure the environment
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//è·å–æˆ–åˆ›å»ºç¯å¢ƒå®ä¾‹, webç¯å¢ƒä½¿ç”¨StandardServletEnvironment, éwebç¯å¢ƒä½¿ç”¨StandardEnvironment
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ConfigurableEnvironment&lt;/span> &lt;span class="n">environment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getOrCreateEnvironment&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="c1">//é…ç½®ç¯å¢ƒæ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//1. **commandLineArgs**å±æ€§ä»å¯åŠ¨å‚æ•°ä¸­è§£æ, æ ¼å¼&amp;#34;--name=value&amp;#34;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//2. é…ç½®profiles. æœ‰æ•ˆçš„profile(é€šè¿‡**spring.profiles.active**é…ç½®) å’Œ é€šè¿‡SpringApplication.profiles()æŒ‡å®šçš„é¢å¤–profile
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">configureEnvironment&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">environment&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">applicationArguments&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getSourceArgs&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="c1">//é€šè¿‡EventPublishingRunListenerå‘å¸ƒenvironmentPreparedäº‹ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">listeners&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">environmentPrepared&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">environment&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//å¦‚æœæ˜¯webç¯å¢ƒ, å°†éwebç¯å¢ƒå®ä¾‹è½¬æ¢æˆwebç¯å¢ƒå®ä¾‹:
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//ä½¿ç”¨æœ‰æ•ˆçš„profileé…ç½®å’ŒjndiProperties, servletConfigInitParams, servletContextInitParamsçš„é…ç½®.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">isWebEnvironment&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">environment&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">webEnvironment&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">environment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">convertToStandardEnvironment&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">environment&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//è¾“å‡ºbanner
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">bannerMode&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">Banner&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Mode&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">OFF&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">printBanner&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">environment&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡, æ²¡æœ‰æŒ‡å®šå®ç°ç±»çš„è¯(ä½¿ç”¨SpringApplicationBuilder.contextClass), ä½¿ç”¨é»˜è®¤contextç±». ç„¶åé€šè¿‡åå°„å®ä¾‹åŒ–ä¸Šä¸‹æ–‡å¯¹è±¡.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//1. webç¯å¢ƒä½¿ç”¨org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//2. org.springframework.context.annotation.AnnotationConfigApplicationContext
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">//åˆå§‹åŒ–å®ä¾‹çš„æ—¶å€™ä¼šåšå¾ˆå¤šäº‹,
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//1. åˆ›å»ºAnnotatedBeanDefinitionReader. æ³¨å†Œç›¸å…³çš„Annotation Post Processor, åŒ…æ‹¬: ConfigurationClassPostProcessor(å¤„ç†@Configurationæ ‡æ³¨çš„ç±»), AutowiredAnnotationBeanPostProcessor, RequiredAnnotationBeanPostProcessor, CommonAnnotationBeanPostProcessor, PersistenceAnnotationBeanPostProcessor, EventListenerMethodProcessor, DefaultEventListenerFactory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//2. åˆ›å»ºClassPathBeanDefinitionScanner. æ‰«æå™¨, æ‰«æé»˜è®¤çš„è¿‡æ»¤å™¨@Service, @Component, @Registry, @Controller. åŒæ—¶æ”¯æŒJ2EE6çš„@ManagedBeanå’Œ@Named
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// Create, load, refresh and run the ApplicationContext
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">context&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createApplicationContext&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="c1">//è®¾ç½®ç¯å¢ƒ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">context&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setEnvironment&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">environment&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//åç»­çš„å¤„ç†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">postProcessApplicationContext&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//åº”ç”¨åˆå§‹åŒ–å™¨(ApplicationContextInitializerçš„å®ç°ç±»), å¯¹ä¸Šä¸‹æ–‡å¯¹è±¡åšæ›´å¤šåˆå§‹åŒ–çš„æ“ä½œ, æ¯”å¦‚:
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//1. æ·»åŠ BeanFactoryPostProcessor
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//2 .è®¾ç½®ä¸Šä¸‹æ–‡å¯¹è±¡id
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//3 .ä»£ç†é…ç½®ä¸­context.initializer.classesæŒ‡å®šçš„åˆå§‹åŒ–ç±»
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//4. æ·»åŠ listener, åœ¨webå®¹å™¨å¯åŠ¨åæ›´æ–°ç¯å¢ƒå˜é‡ä¸­çš„ç«¯å£å·(server.portsä¸­çš„local.server.port)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">applyInitializers&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//é€šè¿‡EventPublishingRunListenerå‘å¸ƒcontextPreparedäº‹ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">listeners&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">contextPrepared&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//æ‰“å°å¯åŠ¨ä¿¡æ¯å’Œæœ‰æ•ˆçš„profileä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">logStartupInfo&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">logStartupInfo&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getParent&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">logStartupProfileInfo&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//å°†ApplicationArgumentså®ä¾‹æ³¨å†Œåˆ°BeanFactoryä¸­, åå­—ä¸ºspringApplicationArguments
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// Add boot specific singleton beans
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">context&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getBeanFactory&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">registerSingleton&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;springApplicationArguments&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">applicationArguments&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//ä»source(å¯ä»¥æ˜¯Resource, Package, CharSequenceæˆ–è€…Class. ä»runæ–¹æ³•è¿›æ¥çš„ä¸ºClass)ç±»åŠ è½½Beanåˆ°ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// Load the sources
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Set&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">sources&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getSources&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">Assert&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">notEmpty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;Sources must not be empty&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">load&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">sources&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toArray&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Object&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="o">()]));&lt;/span>
&lt;span class="c1">//é€šè¿‡EventPublishingRunListenerå‘å¸ƒcontextLoadedäº‹ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">listeners&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">contextLoaded&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//æ›´æ–°ä¸Šä¸‹æ–‡å¯¹è±¡, è°ƒç”¨ApplicationContext.refresh()æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// Refresh the context
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">refresh&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">registerShutdownHook&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">context&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">registerShutdownHook&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">AccessControlException&lt;/span> &lt;span class="n">ex&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// Not allowed in some environments.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">context&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ›´æ–°ä¸Šä¸‹æ–‡-applicationcontextrefresh">æ›´æ–°ä¸Šä¸‹æ–‡ ApplicationContext.refresh()&lt;/h3>
&lt;ol>
&lt;li>prepareRefresh
è®°å½•å¯åŠ¨æ—¶é—´, åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç¯å¢ƒä¿¡æ¯ä¸­çš„å ä½ç¬¦, æ£€æŸ¥å¿…é¡»çš„å±æ€§&lt;/li>
&lt;li>obtainFreshBeanFactory
é‡å»ºå†…ç½®çš„BeanFactory, å¹¶åŠ è½½beanå®šä¹‰&lt;/li>
&lt;li>prepareBeanFactory
åˆå§‹åŒ–BeanFactoryçš„æ ‡å‡†ä¸Šä¸‹æ–‡å±æ€§, å¦‚BeanClassLoader, ExpressionResolver, PropertyEditorRegistrar, BeanPostProcessor, LoadTimeWeaverAwarePostProcessorç­‰ç­‰.&lt;/li>
&lt;li>postProcessBeanFactory
æ ‡å‡†åˆå§‹åŒ–åä¿®æ”¹ä¸Šä¸‹æ–‡å†…ç½®çš„BeanFactory&lt;/li>
&lt;li>invokeBeanFactoryPostProcessors
å®ä¾‹åŒ–å¹¶è°ƒç”¨æ³¨å†Œçš„&lt;code>BeanFactoryPostProcessor&lt;/code>, åŸºäºç²¾ç¡®çš„é¡ºåºå¦‚æœæŒ‡å®šäº†é¡ºåºçš„è¯.
æœ‰äº›processoræ˜¯æ“ä½œBeanå®šä¹‰æ³¨å†Œè¡¨çš„(å¦‚&lt;code>@Configuration&lt;/code>æ ‡æ³¨çš„ç±»beanåŒ…å«å…¶ä»–çš„beanå®šä¹‰), ä¼šåœ¨å¸¸è§„çš„&lt;code>BeanFactoryPostProcessor&lt;/code>çš„æ£€æŸ¥å‘ç”Ÿä¹‹å‰.
åœ¨ä¸Šä¸‹æ–‡å¯¹è±¡çš„beanå®šä¹‰æ³¨å†Œå™¨è¿›è¡Œäº†æ ‡å‡†åˆå§‹åŒ–ä¹‹åè¿›, æ‰€æœ‰çš„å¸¸è§„beanå®šä¹‰éƒ½å·²ç»è¢«åŠ è½½äº†, ä½†æ˜¯è¿˜æ²¡æœ‰beanè¢«å®ä¾‹åŒ–. åœ¨post-processiongä¹‹å‰å¯ä»¥æ·»åŠ æ›´å¤šçš„beanå®šä¹‰. &lt;strong>&lt;code>@Configuration&lt;/code>æ ‡æ³¨çš„ç±»ä¸­çš„beanå®šä¹‰ä¼šåœ¨æ­¤æ—¶å‡å¦‚åˆ°æ³¨å†Œå™¨ä¸­&lt;/strong>.&lt;/li>
&lt;li>registerBeanPostProcessors
å®ä¾‹åŒ–å¹¶è°ƒç”¨æ³¨å†Œçš„&lt;code>BeanPostProcessor&lt;/code>, å¦‚æœæœ‰é¡ºåºçš„è¯, æŒ‰ç…§é¡ºåºæ¥è°ƒç”¨.&lt;/li>
&lt;li>initMessageSource
åˆå§‹åŒ–åä¸º&lt;strong>messageSource&lt;/strong>çš„&lt;code>MessageSource&lt;/code>å®ä¾‹.&lt;/li>
&lt;li>initApplicationEventMulticaster
åˆå§‹åŒ–åä¸º&lt;strong>applicationEventMulticaster&lt;/strong>çš„&lt;code>ApplicationEventMulticaster&lt;/code>å®ä¾‹, åº”ç”¨å¯ä»¥ç”¨æ¥æ³¨å†Œåº”ç”¨äº‹ä»¶çš„ç›‘å¬.&lt;/li>
&lt;li>onRefresh
ä¾›å­ç±»å®ç°æ·»åŠ æ›´å¤šçš„æ›´æ–°æ“ä½œ.&lt;/li>
&lt;li>registerListeners
é€šè¿‡&lt;strong>applicationEventMulticaster&lt;/strong>æ³¨å†Œ&lt;code>ApplicationListener&lt;/code>å®ç°ç±»çš„ç›‘å¬å™¨.&lt;/li>
&lt;li>finishBeanFactoryInitialization
è¿›è¡Œä¸Šä¸‹æ–‡çš„BeanFactoryåˆå§‹åŒ–çš„æ”¶å°¾. å¦‚æå‰åˆå§‹åŒ–&lt;code>LoadTimeWeaverAware&lt;/code>çš„bean, å†»ç»“é…ç½®ç¦æ­¢ä¿®æ”¹beanå®šä¹‰, å®ä¾‹åŒ–non-lazy-initçš„bean.&lt;/li>
&lt;li>finishRefresh
å®Œæˆæ›´æ–°, è°ƒç”¨&lt;code>LifecycleProcessor.onRefresh()&lt;/code>, å‘å¸ƒ&lt;code>ContextRefreshedEvent&lt;/code>äº‹ä»¶, å°†ä¸Šä¸‹æ–‡å®ä¾‹æš´éœ²åœ¨MBeanä¸­.&lt;/li>
&lt;/ol>
&lt;h4 id="configurationclasspostprocessor">ConfigurationClassPostProcessor&lt;/h4>
&lt;p>&lt;code>BeanFactoryPostProcessor&lt;/code>çš„å®ç°ç±», ç”¨äºå¼•å¯¼&lt;code>@Configuration&lt;/code>ç±».
é»˜è®¤æƒ…å†µä¸‹é€šè¿‡ä½¿ç”¨&lt;code>&amp;lt;context:annotation-config/&amp;gt;&lt;/code>æˆ–è€…&lt;code>&amp;lt;context:component-scan/&amp;gt;&lt;/code>æ³¨å†Œ.&lt;/p>
&lt;h2 id="æ³¨è§£">æ³¨è§£&lt;/h2>
&lt;h2 id="springbootapplication">@SpringBootApplication&lt;/h2>
&lt;p>é›†åˆäº†&lt;code>@Configuration&lt;/code>, &lt;code>@EnableAutoConfiguration&lt;/code>å’Œ&lt;code>@ComponentScan&lt;/code>
å±æ€§: &lt;code>exclude&lt;/code>, &lt;code>excludeName&lt;/code>, &lt;code>scanBasePackage&lt;/code> , &lt;code>scanBasePackageClass&lt;/code>&lt;/p>
&lt;h3 id="configuration">@Configuration&lt;/h3>
&lt;p>ç±»ä¼¼æ—§ç‰ˆé…ç½®ä¸­çš„xmlé…ç½®æ–‡ä»¶, æä¾›Beançš„å®šä¹‰å’Œå¼•å…¥å…¶ä»–xmlé…ç½®. åˆ†åˆ«é€šè¿‡&lt;code>@Bean&lt;/code>å’Œ&lt;code>@Import&lt;/code>å®ç°.
åœ¨ApplicationContext.refresh()æ—¶æ˜¯ç”¨&lt;code>ConfigurationClassPostProcessor&lt;/code>è¿›è¡Œbeançš„å®ä¾‹åŒ–.&lt;/p>
&lt;p>å¯ä»¥ä¸&lt;code>@PropertySource&lt;/code>, &lt;code>@Autowired&lt;/code>, &lt;code> @Value&lt;/code>, &lt;code>@Profile&lt;/code>æ­é…ä½¿ç”¨.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="nd">@PropertySource&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;classpath:/com/acme/app.properties&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">AppConfig&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Value&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;${bean.name}&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">beanName&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Autowired&lt;/span> &lt;span class="n">DataSource&lt;/span> &lt;span class="n">dataSource&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">MyBean&lt;/span> &lt;span class="nf">myBean&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">MyBean&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">beanName&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="nd">@Profile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">DatabaseConfigTest&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="n">DataSource&lt;/span> &lt;span class="nf">dataSource&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">EmbeddedDatabaseBuilder&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="nd">@Profile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;production&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">DatabaseConfigProduction&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="n">DataSource&lt;/span> &lt;span class="nf">dataSource&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">EmbeddedDatabaseBuilder&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="enableautoconfiguration">@EnableAutoConfiguration&lt;/h3>
&lt;p>å¼€å¯Springä¸Šä¸‹æ–‡å¯¹è±¡çš„è‡ªåŠ¨é…ç½®åŠŸèƒ½, å°è¯•å»çŒœæµ‹å’Œå®ä¾‹åŒ–ä½ &lt;strong>å¯èƒ½éœ€è¦çš„&lt;/strong>bean.
è¿™ä¸ªåŠŸèƒ½æ˜¯åŸºäºclassPathæ¥å®Œæˆçš„. æ¯”å¦‚: é¡¹ç›®ä¸­å¼•ç”¨äº†&lt;code>tomcat-embedded.jar&lt;/code>, ä½ å¯èƒ½éœ€è¦ä¸€ä¸ª&lt;code>TomcatEmbeddedServletContainerFactory&lt;/code>å®ä¾‹, é™¤éå®šä¹‰äº†è‡ªå·±çš„&lt;code>EmbeddedServletContainerFactory&lt;/code>å®ä¾‹.&lt;/p>
&lt;h3 id="componentscan">@ComponentScan&lt;/h3>
&lt;p>æ‰«æä½¿ç”¨&lt;code>@Configuration&lt;/code>æ ‡æ³¨çš„ç±», ç±»ä¼¼äºSpring XMLçš„&lt;code>&amp;lt;context:component-scan&amp;gt;&lt;/code>å…ƒç´ .
ä½¿ç”¨&lt;code>basePackages&lt;/code>å’Œ&lt;code>basePackageClasses&lt;/code>å±æ€§æ¥æŒ‡å®šè¦æ‰«æçš„åŒ…, å¦‚æœæ²¡æœ‰æŒ‡å®š, åˆ™é»˜è®¤ä»ä½¿ç”¨äº†è¯¥æ³¨è§£çš„ç±»çš„åŒ…å¼€å§‹æ‰«æ.&lt;/p>
&lt;h3 id="import">@Import&lt;/h3>
&lt;p>æç¤º&lt;code>@Configuration&lt;/code>æœ‰æ›´å¤šçš„ç±»éœ€è¦å¼•å…¥, ç±»ä¼¼xmlä¸­çš„&lt;code>&amp;lt;import&amp;gt;&lt;/code>æ ‡ç­¾.
å¯ä»¥å¼•å…¥&lt;code>@Configuration&lt;/code>ç±», &lt;code>ImportSelector&lt;/code>çš„å®ç°ç±»å’Œ&lt;code>ImportBeanDefinitionRegistrar&lt;/code>çš„å®ç°ç±», è¿˜æœ‰å¸¸è§„çš„&lt;code>Component&lt;/code>ç±».&lt;/p>
&lt;p>ä¸‰è€…çš„å¤„ç†æ–¹å¼ä¸ä¸€æ ·:&lt;/p>
&lt;ul>
&lt;li>&lt;code>@Configuration&lt;/code>å¸¸è§„æ–¹å¼&lt;/li>
&lt;li>&lt;code>ImportSelector&lt;/code>ä¼šæ ¹æ®æ³›å‹ç±»å‹ä»&lt;strong>spring.factories&lt;/strong>æ‰¾åˆ°å¯¹åº”çš„é…ç½®ç±».&lt;/li>
&lt;li>&lt;code>ImportBeanDefinitionRegistrar&lt;/code> å¯ä»¥å®ç°åœ¨bean definitionçº§åˆ«çš„å¤„ç† (&lt;code>@Bean&lt;/code>å®ä¾‹çº§åˆ«)&lt;/li>
&lt;/ul>
&lt;p>åœ¨&lt;strong>å¼•å…¥&lt;/strong>&lt;code>@Configuration&lt;/code>ç±»ä¸­ä½¿ç”¨&lt;code>@Bean&lt;/code>æ ‡æ³¨çš„å®ä¾‹, å¯ä»¥é€šè¿‡&lt;code>@Autowired&lt;/code>æ³¨å…¥. Beanå’Œå£°æ˜Beançš„Configurationç±»æœ¬èº«éƒ½å¯ä»¥é€šè¿‡&lt;code>@Autowired&lt;/code>æ³¨å…¥.&lt;/p>
&lt;p>å¼•å…¥XMLæˆ–è€…éConfiguration, ä½¿ç”¨&lt;code>@ImportResource&lt;/code>.&lt;/p></description></item><item><title>Javaåºåˆ—åŒ–å·¥å…·æ€§èƒ½å¯¹æ¯”</title><link>https://atbug.com/java-serval-serializer-benchmark/</link><pubDate>Sat, 02 Dec 2017 07:35:43 +0000</pubDate><guid>https://atbug.com/java-serval-serializer-benchmark/</guid><description>
&lt;p>æœ€è¿‘åœ¨è°ƒæ•´ç³»ç»Ÿçš„æ€§èƒ½, ç³»ç»Ÿä¸­æ­£ä½¿ç”¨Jacksonä½œä¸ºåºåˆ—åŒ–å·¥å…·. åšäº†ä¸‹ä¸fastJson, Avro, ProtoStuffçš„åºåˆ—åŒ–ååå¯¹æ¯”.&lt;/p>
&lt;p>ç”±äºåªæ˜¯åšæ¨ªå‘å¯¹æ¯”, æ²¡æœ‰ä¼˜åŒ–ç³»ç»Ÿæˆ–è€…JVMä»»ä½•å‚æ•°. æœåŠ¡å™¨ä¸€èˆ¬éƒ½ç”¨Linux, åœ¨Dockeré‡Œåšäº†Linuxç³»ç»Ÿçš„æµ‹è¯•.&lt;/p>
&lt;p>Mac:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">Benchmark Mode Cnt Score Error Units
JMHTest.avroSerializer thrpt 2 3124799.325 ops/s
JMHTest.fastJsonSerializer thrpt 2 3122720.917 ops/s
JMHTest.jacksonSerializer thrpt 2 2373347.208 ops/s
JMHTest.protostuffSerializer thrpt 2 4196009.673 ops/s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Docker:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">Benchmark Mode Cnt Score Error Units
JMHTest.avroSerializer thrpt 2 3293260.676 ops/s
JMHTest.fastJsonSerializer thrpt 2 2996908.084 ops/s
JMHTest.jacksonSerializer thrpt 2 2189518.443 ops/s
JMHTest.protostuffSerializer thrpt 2 3998265.173 ops/s
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Kafkaçš„æ¶ˆæ¯å¯é ä¼ é€’</title><link>https://atbug.com/kafka-reliable-data-delivery/</link><pubDate>Sat, 18 Nov 2017 14:01:46 +0000</pubDate><guid>https://atbug.com/kafka-reliable-data-delivery/</guid><description>
&lt;p>Kafkaæä¾›çš„åŸºç¡€ä¿éšœå¯ä»¥ç”¨æ¥æ„å»ºå¯é çš„ç³»ç»Ÿ, å´æ— æ³•ä¿è¯å®Œå…¨å¯é . éœ€è¦åœ¨å¯é æ€§å’Œååä¹‹é—´åšå–èˆ.&lt;/p>
&lt;ul>
&lt;li>Kafkaåœ¨åˆ†åŒºä¸Šæä¾›äº†æ¶ˆæ¯çš„é¡ºåºä¿è¯.&lt;/li>
&lt;li>ç”Ÿäº§çš„æ¶ˆæ¯åœ¨å†™å…¥åˆ°æ‰€æœ‰çš„åŒæ­¥åˆ†åŒºä¸Šåè¢«è®¤ä¸ºæ˜¯&lt;strong>å·²æäº¤&lt;/strong> (ä¸éœ€è¦åˆ·åˆ°ç¡¬ç›˜). ç”Ÿäº§è€…å¯ä»¥é€‰æ‹©åœ¨æ¶ˆæ¯æäº¤å®Œæˆåæ¥æ”¶brokerçš„ç¡®è®¤, æ˜¯å†™å…¥leaderä¹‹å, æˆ–è€…æ‰€æœ‰çš„å‰¯æœ¬&lt;/li>
&lt;li>åªè¦æœ‰ä¸€ä¸ªå‰¯æœ¬å­˜åœ¨, æäº¤çš„æ¶ˆæ¯å°±ä¸ä¼šä¸¢å¤±&lt;/li>
&lt;li>æ¶ˆè´¹è€…åªèƒ½è¯»å–åˆ°å·²æäº¤çš„æ¶ˆæ¯&lt;/li>
&lt;/ul>
&lt;h2 id="å¤åˆ¶">å¤åˆ¶&lt;/h2>
&lt;p>Kafkaçš„å¤åˆ¶æœºåˆ¶ä¿è¯æ¯ä¸ªåˆ†åŒºæœ‰å¤šä¸ªå‰¯æœ¬, æ¯ä¸ªå‰¯æœ¬å¯ä»¥ä½œä¸ºleaderæˆ–è€…followerçš„è§’è‰²å­˜åœ¨. ä¸ºäº†ä¿è¯å‰¯æœ¬çš„åŒæ­¥, éœ€è¦åšåˆ°:&lt;/p>
&lt;ul>
&lt;li>ä¿æŒåˆ°zkçš„è¿æ¥ä¼šè¯: æ¯éš”6så‘zkå‘é€å¿ƒè·³, æ—¶é—´å¯é…ç½®&lt;/li>
&lt;li>æ¯éš”10så‘leaderæ‹‰å–æ¶ˆæ¯, æ—¶é—´å¯é…ç½®&lt;/li>
&lt;li>ä»leaderæ‹‰å–æœ€è¿‘10sçš„å†™å…¥çš„æ¶ˆæ¯. ä¿æŒä¸é—´æ–­çš„ä»leaderè·å–æ¶ˆæ¯æ˜¯ä¸å¤Ÿçš„, å¿…é¡»ä¿è¯å‡ ä¹æ²¡æœ‰å»¶è¿Ÿ&lt;/li>
&lt;/ul>
&lt;h2 id="brokeré…ç½®">Brokeré…ç½®&lt;/h2>
&lt;h3 id="å¤åˆ¶å› å­">å¤åˆ¶å› å­&lt;/h3>
&lt;p>&lt;code>default.replication.factor&lt;/code> brokerçº§åˆ«çš„å‰¯æœ¬æ•°è®¾ç½®, é€šè¿‡è¿™ä¸ªé…ç½®æ¥æ§åˆ¶&lt;strong>è‡ªåŠ¨åˆ›å»º&lt;/strong>çš„topicçš„å‰¯æœ¬æ•°. ä¸ºNçš„æ—¶å€™, å¯ä»¥å®¹å¿å¤±å»N-1ä¸ªå‰¯æœ¬, ä¿è¯topicçš„å¯è¯»å†™.&lt;/p>
&lt;h3 id="è„å‰¯æœ¬çš„leaderé€‰ä¸¾">è„å‰¯æœ¬çš„leaderé€‰ä¸¾&lt;/h3>
&lt;p>&lt;code>unclean.leader.election.enable&lt;/code> 0.11.0.0ä¹‹å‰çš„ç‰ˆæœ¬, é»˜è®¤ä¸ºtrue; ä¹‹åçš„ç‰ˆæœ¬é»˜è®¤ä¸ºfalse. è¿™ä¸ªè®¾ç½®æ§åˆ¶ä¸åŒæ­¥çš„å‰¯æœ¬èƒ½å¦å‚ä¸leaderçš„é€‰ä¸¾. å¦‚æœè®¾ç½®ä¸ºtrue, å½“æ²¡æœ‰åŒæ­¥å‰¯æœ¬å¯ç”¨çš„æ—¶å€™, ä¸åŒæ­¥çš„å‰¯æœ¬ä¼šæˆä¸ºleader, æ„å‘³ç€æœ‰æ•°æ®ä¸¢å¤±. å¦‚æœè®¾ç½®ä¸ºfalse, åˆ™æ„å‘³ç€ç³»ç»Ÿä¼šå¤„äºä¸å¯ç”¨çš„çŠ¶æ€, è¯¥éƒ¨åˆ†æ²¡æœ‰leaderæä¾›æœåŠ¡. éœ€è¦åœ¨&lt;strong>å¯ç”¨æ€§&lt;/strong>å’Œ&lt;strong>ä¸€è‡´æ€§&lt;/strong>ä¹‹é—´åšå–èˆ.&lt;/p>
&lt;h3 id="æœ€å°åŒæ­¥å‰¯æœ¬æ•°">æœ€å°åŒæ­¥å‰¯æœ¬æ•°&lt;/h3>
&lt;p>&lt;code>min.insync.replicas&lt;/code> è¿™ä¸ªè®¾ç½®å¯ä»¥ä½œç”¨äºbrokerå’Œtopicçº§åˆ«. å‡å¦‚brokeræ•°ä¸º3, æœ€å°åŒæ­¥å‰¯æœ¬æ•°ä¸º2. å½“2ä¸ªåŒæ­¥å‰¯æœ¬ä¸­çš„ä¸€ä¸ªå‡ºç°é—®é¢˜, é›†ç¾¤ä¾¿ä¸ä¼šå†æ¥å—ç”Ÿäº§è€…çš„å‘é€æ¶ˆæ¯è¯·æ±‚. åŒäº‹å®¢æˆ·ç«¯ä¼šæ”¶åˆ°&lt;code>NotEnoughReplicasException&lt;/code>. æ­¤æ—¶, æ¶ˆè´¹è€…è¿˜å¯ä»¥ç»§ç»­è¯»å–å­˜åœ¨çš„æ•°æ®. å”¯ä¸€çš„åŒæ­¥å‰¯æœ¬å˜æˆåªè¯».&lt;/p>
&lt;h2 id="å¯é ç³»ç»Ÿä¸­ä½¿ç”¨ç”Ÿäº§è€…">å¯é ç³»ç»Ÿä¸­ä½¿ç”¨ç”Ÿäº§è€…&lt;/h2>
&lt;h3 id="å‘é€ç¡®è®¤">å‘é€ç¡®è®¤&lt;/h3>
&lt;p>&lt;code>acks&lt;/code> å¯é€‰0, 1æˆ–è€…all. è®¾ç½®å½±å“ååå’Œä¸€è‡´æ€§.&lt;/p>
&lt;ul>
&lt;li>&lt;code>acks=0&lt;/code> æ„å‘³ç€æ¶ˆæ¯å‘é€å‡ºå»åå°±è®¤ä¸ºæ˜¯æˆåŠŸå†™å…¥topic.&lt;/li>
&lt;li>&lt;code>acks=1&lt;/code> å‘é€åç­‰å¾…leaderå†™å…¥åç¡®è®¤&lt;/li>
&lt;li>&lt;code>acks=all&lt;/code> å‘é€åç­‰å¾…æ‰€æœ‰å‰¯æœ¬å†™å…¥åç¡®è®¤&lt;/li>
&lt;/ul>
&lt;h3 id="é‡è¯•">é‡è¯•&lt;/h3>
&lt;p>&lt;code>retries&lt;/code> æ¶ˆæ¯å‘é€åä¼šæ”¶åˆ°æˆåŠŸæˆ–è€…é”™è¯¯ç . é”™è¯¯æœ‰ä¸¤ç§, å¯é‡è¯•çš„å’Œä¸å¯é‡è¯•çš„. å¯¹äºå¯é‡è¯•çš„é”™è¯¯, ç”Ÿäº§è€…ä¼šé‡å¤å‘é€, è€Œ&lt;code>reties&lt;/code>æ§åˆ¶é‡è¯•çš„æ¬¡æ•°. æ¯”å¦‚borkerè¿”å›&lt;code>LEADER_NOT_AVAILABLE&lt;/code>é”™è¯¯, ç”Ÿäº§è€…ä¼šè‡ªåŠ¨è¿›è¡Œé‡è¯•(retriesä¸ç­‰äº0), å› ä¸ºbrokerä¹‹åä¼šé€‰æ‹©æ–°çš„leader. å¦‚æœè¿”å›&lt;code>INVALID_CONFIG&lt;/code>, é‡è¯•ä¹Ÿä¸ä¼šè§£å†³é—®é¢˜.
åŒæ—¶&lt;code>retries&lt;/code>æœ‰å¯èƒ½å¯¼è‡´æ¶ˆæ¯é‡å¤, è¿™å°±æ˜¯Kafkaæ¶ˆæ¯çš„&lt;code>at least once&lt;/code>ä¿è¯. åœ¨0.11.0.0ä¹‹å, æä¾›äº†å¹‚ç­‰çš„ç‰¹æ€§, ä¿è¯æ¶ˆæ¯çš„&lt;code>exactly one&lt;/code>. å¯¹äºè·¨æ•°æ®ä¸­å¿ƒçš„å¤åˆ¶(æ¯”å¦‚MirrorMaker), é»˜è®¤è®¾ç½®ä¸º&lt;code>Integer.MAX_VALUE&lt;/code>&lt;/p>
&lt;h3 id="é¢å¤–çš„é”™è¯¯å¤„ç†">é¢å¤–çš„é”™è¯¯å¤„ç†&lt;/h3>
&lt;p>ä½¿ç”¨ç”Ÿäº§è€…å†…ç½®çš„é‡è¯•æ˜¯ä¸€ä¸ªæ­£ç¡®å¤„ç†å¤šç§é”™è¯¯è€Œä¸ä¸¢å¤±æ¶ˆæ¯çš„ç®€å•é€”å¾„. ä½†æ˜¯å¼€å‘è€…è¿˜éœ€è¦å¤„ç†å…¶ä»–çš„é”™è¯¯, æ¯”å¦‚:&lt;/p>
&lt;ul>
&lt;li>ä¸å¯é‡è¯•é”™è¯¯&lt;/li>
&lt;li>å‘é€ä¹‹å‰çš„é”™è¯¯&lt;/li>
&lt;li>åœºè¯•å®Œæ‰€æœ‰çš„é‡è¯•æ¬¡æ•°åè¿˜æ˜¯æœªæˆåŠŸå‘é€.&lt;/li>
&lt;/ul>
&lt;h2 id="å¯é ç³»ç»Ÿä¸­ä½¿ç”¨æ¶ˆè´¹è€…">å¯é ç³»ç»Ÿä¸­ä½¿ç”¨æ¶ˆè´¹è€…&lt;/h2>
&lt;p>&lt;strong>å·²æäº¤æ¶ˆæ¯&lt;/strong>å’Œ&lt;strong>å·²æäº¤åç§»é‡&lt;/strong>
å®Œå…¨ä¸åŒçš„ä¸¤ä¸ªæ¦‚å¿µ, å‰è€…æ˜¯å¯¹ç”Ÿäº§è€…æœ‰æ•ˆ, åè€…æ˜¯å¯¹æ¶ˆè´¹è€…æœ‰æ•ˆ.&lt;/p>
&lt;h3 id="é‡è¦è®¾ç½®">é‡è¦è®¾ç½®&lt;/h3>
&lt;ul>
&lt;li>&lt;code>group.id&lt;/code> ä¸¤ä¸ªæœ‰ç›¸åŒ&lt;code>group.id&lt;/code>å¹¶ä¸”è®¢é˜…åŒä¸€ä¸ªtopicçš„æ¶ˆè´¹è€…, ä¼šåˆ†é…åˆ°topicä¸‹åˆ†åŒºçš„ä¸€ä¸ªå­é›†, å¹¶ä¸”æ˜¯ç‹¬ç«‹çš„å­é›†.&lt;/li>
&lt;li>&lt;code>auto.offset.reset&lt;/code> è¿™ä¸ªå‚æ•°æ§åˆ¶å½“brokerç«¯æ²¡æœ‰å‘ç°ä»»ä½•æäº¤çš„åç§»é‡çš„æ—¶å€™, æ¶ˆè´¹è€…åº”è¯¥ä»ä»€ä¹ˆä½ç½®å¼€å§‹è¯»å–æ¶ˆæ¯. æ¥å—&lt;code>earliest&lt;/code>å’Œ&lt;code>latest&lt;/code>ä¸¤ç§è®¾ç½®. &lt;code>earliest&lt;/code>æ„æ€æ˜¯ä¼šä»0å¼€å§‹è¯»å–, è€Œ&lt;code>latest&lt;/code>æ„æ€æ˜¯ä»æœ€æœ«å°¾å¼€å§‹.&lt;/li>
&lt;li>&lt;code>enable.auto.commit&lt;/code> æŒ‰ç…§æ—¶é—´è®¡åˆ’æäº¤åç§»é‡æˆ–è€…ä»£ç ä¸­æ‰‹åŠ¨æäº¤. å¯¹consumeræ¥è¯´è¿™æ˜¯ä¸€ä¸ª&lt;strong>é‡å¤§&lt;/strong>çš„å†³å®š. è‡ªåŠ¨æäº¤ä¼šä¿è¯åªæäº¤å¾ªç¯ä¸­å·²ç»å¤„ç†çš„æ•°æ®, ä½†æ˜¯æœ‰å¯èƒ½ä¼šåœ¨ä¸‹æ¬¡æäº¤å§‹å‰ç³»ç»Ÿå´©æºƒ. è¿™å°±å¯¼è‡´å·²ç»è¢«å¤„ç†çš„æ¶ˆæ¯çš„åç§»é‡æ²¡æœ‰æäº¤åˆ°broker. ä¸‹æ¬¡æ‹‰å–çš„æ—¶å€™(consumeré‡æ–°ä¸Šçº¿æˆ–è€…rebalanceæ—¶å€™ç”±å…¶ä»–æ¶ˆè´¹è€…å¤„ç†è¯¥åˆ†åŒº)ä¼šé‡æ–°æ‹‰å–å·²ç»å¤„ç†è¿‡çš„æ¶ˆæ¯, &lt;strong>é‡å¤æ¶ˆè´¹&lt;/strong>. å‡å¦‚ä½ æ˜¯å°†æ‹‰å–çš„æ¶ˆæ¯äº¤ç”±å…¶ä»–çš„çº¿ç¨‹å¤„ç†, é‚£è‡ªåŠ¨æäº¤å¯èƒ½ä¼šåˆ°æ—¶æ¶ˆæ¯è¢«æ‹‰å–, å´æ²¡æœ‰è¢«å¤„ç†. è‡ªåŠ¨æäº¤çš„å¥½å¤„æ˜¯ååé‡å¤§.&lt;/li>
&lt;li>&lt;code>auto.commit.interval.ms&lt;/code> å½“&lt;code>enable.auto.commit&lt;/code>è®¾ç½®ä¸º&lt;strong>true&lt;/strong>çš„æ—¶å€™, é€šè¿‡è¿™ä¸ªé…ç½®æ§åˆ¶è‡ªåŠ¨æäº¤çš„æ—¶é—´é—´éš”. è¶Šå¤§ååå°±è¶Šå¤§, ä¸€è‡´æ€§å°±è¶Šä½. è¶Šå°, åˆ™ä¼šå¢åŠ æäº¤çš„æ¬¡æ•°, å½±å“åå, ä½†æ˜¯ä¼šæé«˜ä¸€è‡´æ€§.&lt;/li>
&lt;/ul>
&lt;h3 id="å‡†ç¡®æäº¤åç§»é‡">å‡†ç¡®æäº¤åç§»é‡&lt;/h3>
&lt;h4 id="æ€»æ˜¯æäº¤å·²ç»å¤„ç†è¿‡å¾—æ¶ˆæ¯">æ€»æ˜¯æäº¤å·²ç»å¤„ç†è¿‡å¾—æ¶ˆæ¯&lt;/h4>
&lt;p>å‡å¦‚ä½ æ˜¯åœ¨å¾ªç¯ä¸­å¤„ç†æ‰€æœ‰çš„æ¶ˆæ¯, å¹¶ä¸”ä¸éœ€è¦ç»´æŠ¤è·¨å¤šæ¬¡è½®è¯¢çš„çŠ¶æ€, ä¼šæ¯”è¾ƒå®¹æ˜“å®ç°. å¯ä»¥ä½¿ç”¨è‡ªåŠ¨æäº¤, æˆ–è€…åœ¨è½®è¯¢å¾ªç¯çš„æœ«å°¾è¿›è¡Œåç§»é‡æäº¤.&lt;/p>
&lt;h4 id="æäº¤é¢‘ç‡æ˜¯æ€§èƒ½å’Œç³»ç»Ÿå´©æºƒæ—¶é‡å¤çš„æ¶ˆæ¯æ•°é‡é—´çš„å–èˆ">æäº¤é¢‘ç‡æ˜¯æ€§èƒ½å’Œç³»ç»Ÿå´©æºƒæ—¶é‡å¤çš„æ¶ˆæ¯æ•°é‡é—´çš„å–èˆ&lt;/h4>
&lt;p>ä¸€æ¬¡è½®è¯¢å¾ªç¯ä¸­å¯ä»¥è¿›è¡Œå¤šæ¬¡åç§»é‡æäº¤, ç”šè‡³æ¯å¤„ç†ä¸€æ¡æäº¤ä¸€æ¬¡. æˆ–è€…å‡ ä¸ªè½®è¯¢æäº¤ä¸€æ¬¡. æäº¤ä¼šæœ‰æ€§èƒ½ä¸Šçš„å¼€é”€, ç±»ä¼¼ç”Ÿäº§è€…çš„&lt;code>acks=all&lt;/code>&lt;/p>
&lt;h4 id="ä¿è¯ä½ æ¸…æ¥šçš„äº†è§£å°†è¦æäº¤ä»€ä¹ˆåç§»é‡">ä¿è¯ä½ æ¸…æ¥šçš„äº†è§£å°†è¦æäº¤ä»€ä¹ˆåç§»é‡&lt;/h4>
&lt;p>å¸¸è§çš„ä¸€ä¸ªé™·é˜±å°±æ˜¯ä¸€æ¬¡è½®è¯¢å¾ªç¯ä¸­çš„åç§»é‡æäº¤äº†è¯»åˆ°çš„æœ€å¤§åç§»é‡, è€Œä¸æ˜¯å·²ç»å¤„ç†è¿‡å¾—æœ€å¤§åç§»é‡. ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±.&lt;/p>
&lt;h3 id="å†å¹³è¡¡">å†å¹³è¡¡&lt;/h3>
&lt;p>å‡†ç¡®å¤„ç†consumerçš„å†å¹³è¡¡(consumerä¸Šçº¿æˆ–è€…ä¸‹çº¿). å†å¹³è¡¡ä¼šå¼•èµ·å…ˆä»æ¶ˆè´¹è€…ä¸Šæ‘˜å–æŸäº›åˆ†åŒº, ç„¶ååœ¨åˆ†é…æŸäº›åˆ†åŒº. é€šè¿‡å®ç°RebalanceListeneræ¥å£æ¥å®ç°æ§åˆ¶.&lt;/p>
&lt;h3 id="æ¶ˆè´¹è€…å¯èƒ½éœ€è¦é‡è¯•">æ¶ˆè´¹è€…å¯èƒ½éœ€è¦é‡è¯•&lt;/h3>
&lt;p>æŸäº›åœºæ™¯ä¸‹, æš‚æ—¶ä¸æäº¤åç§»é‡, ä¸‹æ¬¡è½®è¯¢çš„æ—¶å€™ä¼šé‡å¤æ‹‰å–æ¶ˆæ¯. æ¯”å¦‚æ•°æ®åº“è¿æ¥æš‚æ—¶ä¸å¯ç”¨çš„æƒ…å†µä¸‹.&lt;/p>
&lt;h3 id="æ¶ˆè´¹è€…å¯èƒ½éœ€è¦ç»´æŠ¤çŠ¶æ€">æ¶ˆè´¹è€…å¯èƒ½éœ€è¦ç»´æŠ¤çŠ¶æ€&lt;/h3>
&lt;p>æŸäº›åœºæ™¯ä¸‹, éœ€è¦åœ¨å¤šä¸ªè½®è¯¢é—´å­˜åœ¨èšåˆè¿ç®—.&lt;/p>
&lt;h3 id="å¤„ç†é•¿æ—¶é—´çš„å¤„ç†">å¤„ç†é•¿æ—¶é—´çš„å¤„ç†&lt;/h3>
&lt;p>æœ‰äº›æ—¶å€™, æ¶ˆæ¯çš„å¤„ç†è€—æ—¶è¾ƒé•¿, æ¯”å¦‚ä¸å…¶ä»–ç³»ç»Ÿäº¤äº’æˆ–è€…è¿›è¡Œæ¯”è¾ƒå¤æ‚çš„è¿ç®—.
æŸäº›Kafkaç‰ˆæœ¬çš„æ¶ˆè´¹è€…, ä¸¤æ¬¡è½®è¯¢çš„é—´éš”ä¸èƒ½å¤ªé•¿ (0.10.0.0ä¹‹å‰ç‰ˆæœ¬çš„æ¶ˆè´¹è€…æ²¡æœ‰å•ç‹¬çš„å¿ƒè·³è¿›ç¨‹, æ˜¯é€šè¿‡è½®è¯¢åŒæ—¶è¾¾åˆ°å¿ƒè·³ç›®çš„). å¤ªé•¿, æ¶ˆè´¹è€…åˆ™ä¼šè¢«è®¤ä¸ºæ˜¯ä¸‹çº¿, ä¼šå‘ç”Ÿå†å¹³è¡¡.&lt;/p>
&lt;h3 id="æœ‰ä¸”åªæœ‰ä¸€æ¬¡çš„æ¶ˆæ¯æŠ•é€’">æœ‰ä¸”åªæœ‰ä¸€æ¬¡çš„æ¶ˆæ¯æŠ•é€’&lt;/h3>
&lt;p>æœ‰äº›åœºæ™¯éœ€è¦è‡³å°‘ä¸€æ¬¡çš„è¯­ä¹‰(æ²¡æœ‰æ¶ˆæ¯ä¸¢å¤±); è€ŒæŸäº›åœºæ™¯åˆ™éœ€è¦æœ‰äº›åªæœ‰ä¸€æ¬¡çš„è¯­ä¹‰. ä½†æ˜¯å½“å‰Kafkaæ²¡æœ‰æä¾›å®Œç¾çš„æœ‰ä¸”åªæœ‰ä¸€æ¬¡çš„æ”¯æŒ. éœ€è¦ä¸å…¶ä»–ç³»ç»Ÿç»“åˆä¸€èµ·å®ç°, æ¯”å¦‚ä½¿ç”¨å”¯ä¸€çš„keyå†™å…¥æ•°æ®åº“æˆ–è€…redisç­‰å­˜å‚¨ä¸­.&lt;/p></description></item><item><title>Spring Cloud - Eureka Clientæºç åˆ†æ</title><link>https://atbug.com/spring-cloud-eureka-client-source-code-analysis/</link><pubDate>Sat, 14 Oct 2017 22:04:59 +0000</pubDate><guid>https://atbug.com/spring-cloud-eureka-client-source-code-analysis/</guid><description>
&lt;p>å‡†å¤‡åšä¸ªSpring Cloudæºç åˆ†æç³»åˆ—, ä½œä¸ºSpring Cloudçš„æºç åˆ†æç¬”è®°.&lt;/p>
&lt;p>è¿™ä¸€ç¯‡æ˜¯Eurekaçš„å®¢æˆ·ç«¯.&lt;/p>
&lt;h2 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯&lt;/h2>
&lt;p>ä¸¤ç§æ–¹å¼, æœ€ç»ˆçš„å®ç°åŸºæœ¬ä¸€æ ·.&lt;/p>
&lt;h3 id="æ˜¾ç¤ºæŒ‡å®šæœåŠ¡å‘ç°çš„å®ç°ç±»å‹">æ˜¾ç¤ºæŒ‡å®šæœåŠ¡å‘ç°çš„å®ç°ç±»å‹&lt;/h3>
&lt;p>ä½¿ç”¨&lt;code>@EnableEurekaClient&lt;/code>æ³¨è§£æ˜¾ç¤ºçš„æŒ‡å®šä½¿ç”¨Eurekaä½œä¸ºæœåŠ¡å‘ç°çš„å®ç°, å¹¶å®ä¾‹åŒ–&lt;code>EurekaClient&lt;/code>å®ä¾‹. å®é™…ä¸Šä½¿ç”¨çš„æ˜¯&lt;code>@EnableDiscoveryClient&lt;/code>æ³¨è§£.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Target&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ElementType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">TYPE&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Retention&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RetentionPolicy&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">RUNTIME&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Documented&lt;/span>
&lt;span class="nd">@Inherited&lt;/span>
&lt;span class="nd">@EnableDiscoveryClient&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="nd">@interface&lt;/span> &lt;span class="n">EnableEurekaClient&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åŠ¨æ€é…ç½®å®ç°">åŠ¨æ€é…ç½®å®ç°&lt;/h3>
&lt;p>ä½¿ç”¨&lt;code>@EnableDiscoveryClient&lt;/code>æ³¨è§£æ¥é…ç½®æœåŠ¡å‘ç°çš„å®ç°.&lt;/p>
&lt;h4 id="æºç åˆ†æ">æºç åˆ†æ&lt;/h4>
&lt;p>&lt;strong>EnableDiscoveryClient&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Target&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ElementType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">TYPE&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Retention&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RetentionPolicy&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">RUNTIME&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@Documented&lt;/span>
&lt;span class="nd">@Inherited&lt;/span>
&lt;span class="nd">@Import&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">EnableDiscoveryClientImportSelector&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="nd">@interface&lt;/span> &lt;span class="n">EnableDiscoveryClient&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>EnableDiscoveryClient&lt;/code>æ³¨è§£çš„ä½œç”¨ä¸»è¦æ˜¯ç”¨æ¥å¼•å…¥&lt;code>EnableDiscoveryClientImportSelector&lt;/code>&lt;/p>
&lt;p>&lt;strong>EnableDiscoveryClientImportSelector&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Order&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Ordered&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">LOWEST_PRECEDENCE&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">100&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">EnableDiscoveryClientImportSelector&lt;/span>
&lt;span class="kd">extends&lt;/span> &lt;span class="n">SpringFactoryImportSelector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">EnableDiscoveryClient&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">protected&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">isEnabled&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">RelaxedPropertyResolver&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">getEnvironment&lt;/span>&lt;span class="o">()).&lt;/span>&lt;span class="na">getProperty&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="s">&amp;#34;spring.cloud.discovery.enabled&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Boolean&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Boolean&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">TRUE&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">protected&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">hasDefaultFactory&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>EnableDiscoveryClientImportSelector&lt;/code>ç»§æ‰¿äº†&lt;code>SpringFactoryImportSelector&lt;/code>å¹¶æŒ‡å®šäº†æ³›å‹&lt;code>EnableDiscoveryClient&lt;/code>. &lt;strong>è¿™é‡Œçš„æ³›å‹æ˜¯é‡ç‚¹&lt;/strong>.&lt;/p>
&lt;p>&lt;strong>SpringFactoryImportSelector&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">abstract&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">SpringFactoryImportSelector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;span class="kd">implements&lt;/span> &lt;span class="n">DeferredImportSelector&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">BeanClassLoaderAware&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">EnvironmentAware&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">ClassLoader&lt;/span> &lt;span class="n">beanClassLoader&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">annotationClass&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">protected&lt;/span> &lt;span class="nf">SpringFactoryImportSelector&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">annotationClass&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;)&lt;/span> &lt;span class="n">GenericTypeResolver&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">resolveTypeArgument&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getClass&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">SpringFactoryImportSelector&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="nf">selectImports&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">AnnotationMetadata&lt;/span> &lt;span class="n">metadata&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œåªæˆªå–äº†éƒ¨åˆ†å˜é‡å’Œæ–¹æ³•
&lt;code>SpringFactoryImportSelector&lt;/code>æ˜¯spring cloud commonåŒ…ä¸­çš„ä¸€ä¸ªæŠ½è±¡ç±», ä¸»è¦ä½œç”¨æ˜¯æ£€æŸ¥æ³›å‹Tæ˜¯å¦æœ‰æŒ‡å®šçš„factoryå®ç°, å³spring.factoriesä¸­æœ‰å¯¹åº”ç±»çš„é…ç½®.&lt;/p>
&lt;p>&lt;strong>spring.factories&lt;/strong>&lt;/p>
&lt;p>åœ¨&lt;code>spring-cloud-netflix-eureka-client.jar!/META-INF/spring.factories&lt;/code>ä¸­&lt;code>EnableDiscoveryClient&lt;/code>çš„æŒ‡å®šfactoryå®ç°æ˜¯&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.springframework.cloud.netflix.eureka.config.EurekaClientConfigServerAutoConfiguration,\
org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceAutoConfiguration,\
org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration,\
org.springframework.cloud.netflix.ribbon.eureka.RibbonEurekaAutoConfiguration
org.springframework.cloud.bootstrap.BootstrapConfiguration=\
org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceBootstrapConfiguration
org.springframework.cloud.client.discovery.EnableDiscoveryClient=\
org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŒæ—¶&lt;code>EnableAutoConfiguration&lt;/code>ä¸­åŒ…å«äº†&lt;code>org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration&lt;/code>, &lt;code>EurekaClientAutoConfiguration&lt;/code>ä¼šä¸º&lt;code>EurekaDiscoveryClientConfiguration&lt;/code>çš„å®ä¾‹ä¾èµ–è¿›è¡Œåˆå§‹åŒ–, å¦‚EurekaClient. EurekaClientåœ¨æ„é€ æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªHeartBeatçº¿ç¨‹, çº¿ç¨‹åœ¨è¿è¡Œçš„æ—¶å€™ä¼šåšrenewçš„æ“ä½œ, å°†Applicationçš„ä¿¡æ¯æ³¨å†Œæ›´æ–°åˆ°Eurekaçš„æœåŠ¡ç«¯.&lt;/p>
&lt;p>&lt;strong>EurekaDiscoveryClientConfiguration&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="nd">@EnableConfigurationProperties&lt;/span>
&lt;span class="nd">@ConditionalOnClass&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">EurekaClientConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@ConditionalOnProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;eureka.client.enabled&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">matchIfMissing&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="nd">@CommonsLog&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">EurekaDiscoveryClientConfiguration&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">SmartLifecycle&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Ordered&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Raftç®—æ³•å­¦ä¹ </title><link>https://atbug.com/learning-raft/</link><pubDate>Sat, 14 Oct 2017 05:57:34 +0000</pubDate><guid>https://atbug.com/learning-raft/</guid><description>
&lt;h1 id="raft">Raft&lt;/h1>
&lt;p>å¼ºä¸€è‡´æ€§ç®—æ³•&lt;/p>
&lt;h2 id="åè¯">åè¯&lt;/h2>
&lt;h3 id="å¤åˆ¶çŠ¶æ€æœº">å¤åˆ¶çŠ¶æ€æœº&lt;/h3>
&lt;p>&lt;img src="http://wx4.sinaimg.cn/mw690/4858d6a8ly1fbxcex0w1fj20gt08vwfr.jpg" alt="å¤åˆ¶çŠ¶æ€æœºçš„æ¶æ„">
å¤åˆ¶çŠ¶æ€æœºæ˜¯é€šè¿‡å¤åˆ¶æ—¥å¿—æ¥å®ç°çš„, æŒ‰ç…§æ—¥å¿—ä¸­çš„å‘½ä»¤çš„é¡ºåºæ¥æ‰§è¡Œè¿™äº›å‘½ä»¤. ç›¸åŒçš„çŠ¶æ€æœºæ‰§è¡Œç›¸åŒçš„æ—¥å¿—å‘½ä»¤, è·å¾—ç›¸åŒçš„æ‰§è¡Œç»“æœ.&lt;/p>
&lt;h3 id="ä»»æœŸå·-currentterm">ä»»æœŸå· (currentTerm)&lt;/h3>
&lt;p>æ¯ä¸ªæˆå‘˜éƒ½ä¼šä¿å­˜ä¸€ä¸ªä»»æœŸå·, ç§°ä¸º&lt;strong>æœåŠ¡å™¨æœ€åçŸ¥é“çš„ä»»æœŸå·&lt;/strong>.&lt;/p>
&lt;h3 id="æŠ•ç¥¨çš„å€™é€‰äººid-votedfor">æŠ•ç¥¨çš„å€™é€‰äººid (votedFor)&lt;/h3>
&lt;p>å½“å‰ä»»æœŸå†…, æŠ•ç¥¨çš„å€™é€‰äººid, å³å“åº”æŠ•ç¥¨è¯·æ±‚(è§ä¸‹æ–‡)è¿”å›trueæ—¶çš„å€™é€‰äººid.&lt;/p>
&lt;h3 id="å·²è¢«æäº¤çš„æœ€å¤§æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼-commitindex">å·²è¢«æäº¤çš„æœ€å¤§æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼ (commitIndex)&lt;/h3>
&lt;p>æ¯ä¸ªæˆå‘˜éƒ½ä¼šæŒæœ‰å·²è¢«æäº¤çš„æœ€å¤§æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼&lt;/p>
&lt;h3 id="è¢«çŠ¶æ€æœºæ‰§è¡Œçš„æœ€æ—¥å¿—æ¡çš„ç´¢å¼•å€¼-lastapplied">è¢«çŠ¶æ€æœºæ‰§è¡Œçš„æœ€â¼¤æ—¥å¿—æ¡â½¬çš„ç´¢å¼•å€¼ (lastApplied)&lt;/h3>
&lt;p>æ¯ä¸ªæˆå‘˜éƒ½ä¼šæŒæœ‰è¢«çŠ¶æ€æœºæ‰§è¡Œçš„æœ€â¼¤æ—¥å¿—æ¡â½¬çš„ç´¢å¼•å€¼&lt;/p>
&lt;h3 id="è¯·æ±‚">è¯·æ±‚&lt;/h3>
&lt;h4 id="æ—¥å¿—å¤åˆ¶è¯·æ±‚-appendentries-rpc">æ—¥å¿—å¤åˆ¶è¯·æ±‚ (AppendEntries RPC)&lt;/h4>
&lt;p>ç”±é¢†å¯¼äººå‘é€ç»™å…¶ä»–æœåŠ¡å™¨, ä¹Ÿç”¨ä½œheartbeat&lt;/p>
&lt;p>&lt;strong>è¯·æ±‚å†…å®¹&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>term é¢†å¯¼äººçš„ä»»æœŸå·&lt;/li>
&lt;li>leaderId é¢†å¯¼äººçš„id&lt;/li>
&lt;li>prevLogIndex å·²ç»è¢«çŠ¶æ€æœºæ‰§è¡Œçš„æœ€å¤§ç´¢å¼•å€¼, å³æœ€æ–°æ—¥å¿—ä¹‹å‰çš„æ—¥å¿—çš„ç´¢å¼•å€¼.&lt;/li>
&lt;li>preLogTerm æœ€æ–°æ—¥å¿—ä¹‹å‰çš„æ—¥å¿—çš„é¢†å¯¼äººçš„ä»»æœŸå·&lt;/li>
&lt;li>entries[] éœ€è¦è¢«å¤åˆ¶çš„æ—¥å¿—æ¡ç›®&lt;/li>
&lt;li>leaderCommit é¢†å¯¼äººæäº¤çš„æ—¥å¿—æ¡ç›®ç´¢å¼•å€¼&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>å“åº”å†…å®¹&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>term å½“å‰çš„ä»»æœŸå·, ç”¨äºé¢†å¯¼äººæ›´æ–°è‡ªå·±çš„ä»»æœŸå·&lt;/li>
&lt;li>success ç›®æ ‡æœåŠ¡å™¨æ˜¯å¦èƒ½å¤ŸåŒ¹é…prevLogIndexå’ŒpreLogTerm&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>æ¥å—è€…çš„å¤„ç†&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>å¦‚æœterm &amp;lt; currentTermè¿”å›false, å³å‘é€è¯·æ±‚çš„é¢†å¯¼äººä»»æœŸå·å°äºæœåŠ¡å™¨æœ€åçŸ¥é“çš„ä»»æœŸå·, æ„å‘³ç€é¢†å¯¼äººå‘ç”Ÿäº†å˜æ›´.&lt;/li>
&lt;li>å¦‚æœprevLogIndexå’ŒpreLogTermä¸åŒ¹é…, è¿”å›false. å³å‘é€è¯·æ±‚çš„é¢†å¯¼äººçš„æ—¥å¿—ä¸æ˜¯æœ€æ–°çš„,&lt;/li>
&lt;li>å¦‚æœæœ‰ä¸€æ¡å·²ç»å­˜åœ¨çš„â½‡å¿—ä¸æ–°çš„å†²çªï¼ˆindex ç›¸åŒä½†æ˜¯ä»»æœŸå· termä¸åŒï¼‰ï¼Œåˆ™åˆ é™¤å·²ç»å­˜åœ¨çš„â½‡å¿—å’Œå®ƒä¹‹åæ‰€æœ‰çš„æ—¥å¿—&lt;/li>
&lt;li>æ·»åŠ ä»»ä½•åœ¨å·²æœ‰çš„æ—¥å¿—ä¸­ä¸å­˜åœ¨çš„æ¡ç›®&lt;/li>
&lt;li>å¦‚æœleaderCommit &amp;gt; commitIndex, åˆ™æ›´æ–°commitIndexä¸ºleaderCommitå’Œæœ€æ–°æ—¥å¿—æ¡ç›®ç´¢å¼•å€¼ä¸­è¾ƒå°çš„ä¸€ä¸ª&lt;/li>
&lt;/ol>
&lt;h4 id="å‘èµ·æŠ•ç¥¨è¯·æ±‚-requestvote-rpc">å‘èµ·æŠ•ç¥¨è¯·æ±‚ (RequestVote RPC)&lt;/h4>
&lt;p>ç”±å€™é€‰äººå‘èµ·çš„, å‘ç»™é›†ç¾¤ä¸­å·²çŸ¥çš„å…¶ä»–æˆå‘˜&lt;/p>
&lt;p>&lt;strong>è¯·æ±‚å†…å®¹&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>term å€™é€‰äººçš„ä»»æœŸå· (åœ¨å˜æ›´ä¸ºé¢†å¯¼äººä¹‹å‰çš„ä¿å­˜çš„ä»»æœŸå·çš„åŸºç¡€ä¸ŠåŠ 1)&lt;/li>
&lt;li>candidatedId è¯·æ±‚æŠ•ç¥¨çš„å€™é€‰äººid&lt;/li>
&lt;li>lastLogIndex å€™é€‰äººæœ€æ–°æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼&lt;/li>
&lt;li>lastLogTerm å€™é€‰äººæœ€æ–°æ—¥å¿—æ¡ç›®å¯¹åº”çš„ä»»æœŸå·&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>å“åº”å†…å®¹&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>term ç›®å‰çš„ä»»æœŸå·, ç”¨äºå€™é€‰äººæ›´æ–°è‡ªå·±çš„ä»»æœŸå·&lt;/li>
&lt;li>voteGranted æ”¶åˆ°é€‰ç¥¨ä¸ºtrue&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>æ¥å—è€…çš„å¤„ç†&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>å¦‚æœterm &amp;lt; currentTerm è¿”å›voteGrantedä¸ºfalse&lt;/li>
&lt;li>å¦‚æœvotedForä¸ºç©º, å¹¶ä¸”lastLogIndexå’ŒlastLogTermåŒ¹é…æˆåŠŸ, åˆ™ä¸ºè¯¥å€™é€‰äººæŠ•ç¥¨, è¿”å›voteGrantedä¸ºtrue. å¹¶æ›´æ–°ä¸ºå€™é€‰äººid&lt;/li>
&lt;/ol>
&lt;h4 id="å®‰è£…å¿«ç…§è¯·æ±‚-instalsnapshotrpc">å®‰è£…å¿«ç…§è¯·æ±‚ (InstalSnapshotRPC)&lt;/h4>
&lt;p>åœ¨é¢†å¯¼äººå‘é€å¿«ç…§ç»™è·Ÿéšè€…æ—¶ä½¿ç”¨, æŒ‰é¡ºåºå‘é€.&lt;/p>
&lt;p>&lt;strong>è¯·æ±‚å†…å®¹&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>term é¢†å¯¼äººçš„ä»»æœŸå·&lt;/li>
&lt;li>leaderId é¢†å¯¼äººid&lt;/li>
&lt;li>lastIncludedIndex å¿«ç…§ä¸­åŒ…å«çš„æœ€åæ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼&lt;/li>
&lt;li>lastIncludedTerm å¿«ç…§ä¸­åŒ…å«çš„æœ€åæ—¥å¿—æ¡ç›®çš„ä»»æœŸå·&lt;/li>
&lt;li>offset åˆ†å—åœ¨å¿«ç…§å—ä¸­çš„åç§»é‡&lt;/li>
&lt;li>data[] å¿«ç…§çš„åŸå§‹æ•°æ®&lt;/li>
&lt;li>done å¦‚æœæ˜¯æœ€åä¸€å—æ•°æ®åˆ™ä¸ºtrue&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>å“åº”å†…å®¹&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>term ç›®æ ‡æœåŠ¡å™¨çš„currentTerm, ç”¨äºé¢†å¯¼äººæ›´æ–°è‡ªå·±&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>æ¥å—è€…çš„å¤„ç†&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>å¦‚æœterm &amp;lt; currentTerm ç«‹åˆ»å›å¤&lt;/li>
&lt;li>å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªåˆ†å—(offsetä¸º0)åˆ™åˆ›å»ºæ–°çš„å¿«ç…§&lt;/li>
&lt;li>åœ¨æŒ‡å®šçš„åç§»é‡å†™å…¥æ•°æ®&lt;/li>
&lt;li>å¦‚æœdoneæœªfalse, åˆ™å›å¤å¹¶ç»§ç»­ç­‰å¾…ä¹‹åçš„æ•°æ®&lt;/li>
&lt;li>ä¿å­˜å¿«ç…§æ–‡ä»¶, ä¸¢å¼ƒæ‰€æœ‰å­˜åœ¨çš„æˆ–è€…éƒ¨åˆ†æœ‰ç€æ›´æ–°ç´¢å¼•å·çš„å¿«ç…§&lt;/li>
&lt;li>å¦‚æœç°å­˜çš„æ—¥å¿—æ‹¥æœ‰ç›¸åŒçš„æœ€åä»»æœŸå·å’Œç´¢å¼•å€¼, åˆ™åé¢çš„æ•°æ®ç»§ç»­ä¿ç•™å¹¶ä¸”å›å¤&lt;/li>
&lt;li>ä¸¢å¼ƒå…¨éƒ¨æ—¥å¿—&lt;/li>
&lt;li>èƒ½å¤Ÿä½¿ç”¨å¿«ç…§æ¥æ¢å¤çŠ¶æ€æœº (å¹¶ä¸”è£…è½½å¿«ç…§ä¸­çš„é›†ç¾¤é…ç½®)&lt;/li>
&lt;/ol>
&lt;h2 id="çº¦æŸåŸåˆ™">çº¦æŸ/åŸåˆ™&lt;/h2>
&lt;ul>
&lt;li>é€‰ä¸¾å®‰å…¨åŸåˆ™ Election Safety: ä¸€ä¸ªä»»æœŸå†…æœ€å¤šåªæœ‰ä¸€ä¸ªé¢†å¯¼äººå½“é€‰&lt;/li>
&lt;li>é¢†å¯¼äººåªå¢åŠ åŸåˆ™ Leader Append-Only: é¢†å¯¼äººæ°¸è¿œä¸ä¼šè¦†ç›–æˆ–è€…åˆ é™¤è‡ªå·±çš„æ—¥å¿—, å®ƒåªä¼šå¢åŠ æ¡ç›®&lt;/li>
&lt;li>æ—¥å¿—åŒ¹é…åŸåˆ™ Log Matching: å¦‚æœä¸¤ä¸ªæ—¥å¿—åœ¨ç›¸åŒçš„ç´¢å¼•ä½ç½®ä¸Šçš„æ—¥å¿—æ¡ç›®çš„ä»»æœŸå·ç›¸åŒ, é‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸ºæ—¥å¿—ä»å¤´åˆ°è¿™ä¸ªç´¢å¼•ä½ç½®ä¹‹é—´çš„æ¡ç›®å®Œå…¨ç›¸åŒ&lt;/li>
&lt;li>é¢†å¯¼äººå®Œå…¨åŸåˆ™ Leader Completeness: å¦‚æœä¸€ä¸ªæ—¥å¿—æ¡ç›®åœ¨ä¸€ä¸ªç»™å®šä»»æœŸå†…è¢«æäº¤, é‚£ä¹ˆè¿™ä¸ªæ¡ç›®ä¸€å®šä¼šå‡ºç°åœ¨æ‰€æœ‰ä»»æœŸå·æ›´å¤§çš„é¢†å¯¼äººä¸­&lt;/li>
&lt;li>çŠ¶æ€æœºå®‰å…¨åŸåˆ™ State Machine Safety: å¦‚æœä¸€ä¸ªæœåŠ¡å™¨å·²ç»å°†ç»™å®šç´¢å¼•ä½ç½®çš„æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°çŠ¶æ€æœºä¸­, åˆ™æ‰€æœ‰çš„å…¶ä»–æœåŠ¡å™¨ä¸ä¼šåœ¨è¯¥ç´¢å¼•ä½ç½®åº”ç”¨ä¸åŒçš„æ¡ç›®&lt;/li>
&lt;/ul>
&lt;h2 id="é¢†å¯¼äººé€‰ä¸¾-leader-election">é¢†å¯¼äººé€‰ä¸¾ (Leader election)&lt;/h2>
&lt;h3 id="é›†ç¾¤æˆå‘˜çš„çŠ¶æ€">é›†ç¾¤æˆå‘˜çš„çŠ¶æ€&lt;/h3>
&lt;ul>
&lt;li>é¢†å¯¼äºº&lt;/li>
&lt;li>å€™é€‰äºº&lt;/li>
&lt;li>è¿½éšè€….&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="http://wx2.sinaimg.cn/mw690/4858d6a8ly1fc9uv9fx6wj20hn07xt9z.jpg" alt="çŠ¶æ€è½¬æ¢">&lt;/p>
&lt;p>åœ¨åŒä¸€æ—¶é—´, æˆå‘˜åªä¼šå±äºå…¶ä¸­çš„ä¸€ç§çŠ¶æ€. å¹¶ä¸”é›†ç¾¤ä¸­åªä¼šå­˜åœ¨ä¸€ä¸ªé¢†å¯¼äºº.&lt;/p>
&lt;p>æœ‰é¢†å¯¼äººæ—¶: ä¸€ä¸ªé¢†å¯¼äºº, n-1ä¸ªè¿½éšè€…
æ— é¢†å¯¼äººæ—¶: xä¸ªå€™é€‰äºº, n-xä¸ªè¿½éšè€…&lt;/p>
&lt;h3 id="çº¦æŸ">çº¦æŸ&lt;/h3>
&lt;ul>
&lt;li>é›†ç¾¤ä¸­æœ€å¤šå­˜åœ¨ä¸€ä¸ªé¢†å¯¼äºº&lt;/li>
&lt;li>è¿½éšè€…ä¸ä¼šå‘é€è¯·æ±‚, åªä¼šæ¥å—æ¥è‡ªé¢†å¯¼äººçš„AppendEntries RPCè¯·æ±‚, å’Œå€™é€‰äººçš„RequestVote RPCè¯·æ±‚. &lt;em>AppendEntries RPCè¯·æ±‚åŒæ—¶æä¾›heartbeatæœºåˆ¶&lt;/em>&lt;/li>
&lt;li>é¢†å¯¼äººåªæ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚&lt;/li>
&lt;/ul>
&lt;h3 id="ä»»æœŸ">ä»»æœŸ&lt;/h3>
&lt;p>&lt;img src="http://wx3.sinaimg.cn/mw690/4858d6a8ly1fc9vx0s6l6j20ef05odg9.jpg" alt="æ—¶é—´æµ">&lt;/p>
&lt;p>æ—¶é—´è¢«åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªçš„ä»»æœŸ, æ¯ä¸€ä¸ªä»»æœŸçš„å¼€å§‹éƒ½æ˜¯é¢†å¯¼äººçš„é€‰ä¸¾.&lt;/p>
&lt;p>éšæœºçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ ä¾‹å¦‚150~300æ¯«ç§’, é˜²æ­¢æ— é™é€‰ä¸¾å¤±è´¥.&lt;/p>
&lt;h2 id="æ—¥å¿—å¤åˆ¶">æ—¥å¿—å¤åˆ¶&lt;/h2>
&lt;h3 id="çº¦æŸ-1">çº¦æŸ&lt;/h3>
&lt;p>æ—¥å¿—çš„æµå‘åªä¼šæ˜¯ä»é¢†å¯¼äººåˆ°è¿½éšè€…. é¢†å¯¼äººä¸ä¼šè¦†ç›–è‡ªå·±çš„æ—¥å¿—.&lt;/p>
&lt;h3 id="æµç¨‹">æµç¨‹&lt;/h3>
&lt;p>é¢†å¯¼äººæ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚, æŠŠè¯·æ±‚ä¸­çš„å‘½ä»¤ä½œä¸ºæ—¥å¿—æ¡ç›®åŠ å…¥åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­, ç„¶åå‘è¿½éšè€…å‘é€AppendEnties RPCè¯·æ±‚, è¦æ±‚è¿½éšè€…å¤åˆ¶è¿™æ¡æ—¥å¿—æ¡ç›®. è¿½éšè€…å¤åˆ¶å®Œæˆåä¼šå“åº”é¢†å¯¼äºº. æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šå“åº”å, é¢†å¯¼äººä¼šå°†è¯¥æ¡ç›®åº”ç”¨åˆ°çŠ¶æ€æœºä¸­, å¹¶å“åº”å®¢æˆ·ç«¯. å‡å¦‚æœ‰è¿½éšè€…æ²¡æœ‰å“åº”, é¢†å¯¼äººä¼šæ— é™åœ°é‡è¯•AppendEnties RPCè¯·æ±‚ç›´åˆ°æ‰€æœ‰çš„è¿½éšè€…éƒ½å¤åˆ¶äº†è¯¥æ¡ç›®.&lt;/p>
&lt;h2 id="å®‰å…¨æ€§">å®‰å…¨æ€§&lt;/h2>
&lt;p>æ²¡æœ‰åŒ…å«å…¨éƒ¨æ—¥å¿—çš„æœåŠ¡å™¨ä¸ä¼šèµ¢å¾—é€‰ä¸¾, å³æŸäº›æŠ•ç¥¨è¯·æ±‚çš„å“åº”è¿”å›false.&lt;/p>
&lt;h2 id="æ—¥å¿—å‹ç¼©">æ—¥å¿—å‹ç¼©&lt;/h2>
&lt;p>æŠŠå½“å‰çš„ç³»ç»ŸçŠ¶æ€å†™å…¥å¿«ç…§(snapshot)ä¸­, å¹¶æŒä¹…åŒ–åˆ°å­˜å‚¨ä¸­, ç„¶åä¸¢å¼ƒä¹‹å‰çš„å…¨éƒ¨æ—¥å¿—.&lt;/p>
&lt;p>&lt;img src="http://wx2.sinaimg.cn/mw690/4858d6a8ly1fccdvbs2y7j20g70ae75i.jpg" alt="ä¿å­˜æ¡ç›®1-5åˆ°å¿«ç…§ä¸­">&lt;/p>
&lt;p>å¿«ç…§ä¸­åŒ…å«äº†æœ€åçš„ç´¢å¼•å€¼å’Œä»»æœŸå·.&lt;/p>
&lt;p>å¢é‡å‹ç¼©(incremental approaches)&lt;/p>
&lt;p>é¢†å¯¼äººå¿…é¡»å¶å°”åœ°å‘é€å¿«ç…§ç»™ä¸€äº›è½åçš„è·Ÿéšè€…. è¿è¡Œéå¸¸ç¼“æ…¢æˆ–è€…æ–°åŠ å…¥çš„è·Ÿéšè€…ä¸èƒ½ä¸é¢†å¯¼äººä¿æŒåŒæ­¥, å¯ä»¥é€šè¿‡å‘é€å¿«ç…§çš„æ–¹å¼è®©è·Ÿéšè€…æ›´æ–°åˆ°æœ€æ–°çš„çŠ¶æ€.&lt;/p>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;p>&lt;a href="http://www.infoq.com/cn/articles/raft-paper">Raft ä¸€è‡´æ€§ç®—æ³•è®ºæ–‡è¯‘æ–‡&lt;/a>&lt;/p></description></item><item><title>Kafkaå‘é€ä¸åŒç¡®è®¤æ–¹å¼çš„æ€§èƒ½å·®å¼‚</title><link>https://atbug.com/kafka-producer-acknowledge-benchmark/</link><pubDate>Tue, 10 Oct 2017 11:49:58 +0000</pubDate><guid>https://atbug.com/kafka-producer-acknowledge-benchmark/</guid><description>
&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>Kafkaçš„æ€§èƒ½ä¼—æ‰€å‘¨çŸ¥ï¼ŒProduceræ”¯æŒacknowledgeæ¨¡å¼ã€‚å³Kafkaä¼šæƒ³Producerè¿”å›æ¶ˆæ¯å‘é€çš„ç»“æœã€‚ä½†æ˜¯åœ¨Java Clientä¸­ï¼Œacknowledgeçš„ç¡®è®¤æœ‰ä¸¤ç§ï¼šåŒæ­¥å’Œå¼‚æ­¥ã€‚
åŒæ­¥æ˜¯é€šè¿‡è°ƒç”¨future.get()å®ç°çš„ï¼›å¼‚æ­¥åˆ™æ˜¯é€šè¿‡æä¾›callbackæ–¹æ³•æ¥å®ç°ã€‚å†™äº†ä¸ªç®€å•çš„ç¨‹åºæµ‹è¯•ä¸€ä¸‹å•çº¿ç¨‹ä¸­ååå·®å¼‚èƒ½æœ‰å¤šå¤§ã€‚&lt;strong>æ³¨æ„è¿™é‡Œåªè€ƒè™‘æ¨ªå‘å¯¹æ¯”ã€‚&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>å‘é€ç«¯å•çº¿ç¨‹&lt;/li>
&lt;li>Kafkaä¸ºå•é›†ç¾¤èŠ‚ç‚¹&lt;/li>
&lt;li>topicçš„åˆ†åŒºæ•°ä¸º1&lt;/li>
&lt;li>keyé•¿åº¦1&lt;/li>
&lt;li>payloadé•¿åº¦100&lt;/li>
&lt;/ul>
&lt;h2 id="æµ‹è¯•å·¥å…·">æµ‹è¯•å·¥å…·&lt;/h2>
&lt;ul>
&lt;li>JMeter&lt;/li>
&lt;li>&lt;a href="https://github.com/addozhang/kafka-meter">Kafka Meter&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="futureget--batch-size-1">future.get() + batch size =1&lt;/h3>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15076056852541.jpg" alt="">&lt;/p>
&lt;h3 id="futureget--batch-size--16k">future.get() + batch size = 16K&lt;/h3>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15076057041954.jpg" alt="">&lt;/p>
&lt;h3 id="callback--batch-size--16k">callback + batch size = 16k&lt;/h3>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15076057158000.jpg" alt="">&lt;/p>
&lt;h3 id="callback--batch-size--1">callback + batch size = 1&lt;/h3>
&lt;p>&lt;img src="http://7xvxng.com1.z0.glb.clouddn.com/15076057250088.jpg" alt="">&lt;/p></description></item><item><title>Kafkaæ¶ˆæ¯æ¶ˆè´¹ä¸€è‡´æ€§</title><link>https://atbug.com/kafka-consumer-consistency/</link><pubDate>Tue, 26 Sep 2017 19:13:48 +0000</pubDate><guid>https://atbug.com/kafka-consumer-consistency/</guid><description>
&lt;p>Kafkaæ¶ˆè´¹ç«¯çš„offsetä¸»è¦ç”±consumeræ¥æ§åˆ¶, Kafkaé™æ¯ä¸ªconsumeræ‰€ç›‘å¬çš„tocpicçš„partitionçš„offsetä¿å­˜åœ¨__consumer_offsetsä¸»é¢˜ä¸­. consumeréœ€è¦å°†å¤„ç†å®Œæˆçš„æ¶ˆæ¯çš„offsetæäº¤åˆ°æœåŠ¡ç«¯, ä¸»è¦æœ‰ConsumerCoordinatorå®Œæˆçš„.&lt;/p>
&lt;p>æ¯æ¬¡ä»kafkaæ‹‰å–æ•°æ®ä¹‹å‰, å‡å¦‚æ˜¯å¼‚æ­¥æäº¤offset, ä¼šå…ˆè°ƒç”¨å·²ç»å®Œæˆçš„offset commitçš„callBack, ç„¶åæ£€æŸ¥ConsumerCoordinatorçš„è¿æ¥çŠ¶æ€. å¦‚æœè®¾ç½®äº†&lt;strong>è‡ªåŠ¨&lt;/strong>æäº¤offset, ä¼šç»§ç»­ä¸Šæ¬¡ä»æœåŠ¡ç«¯è·å–çš„æ•°æ®çš„offset&lt;strong>å¼‚æ­¥&lt;/strong>æäº¤åˆ°æœåŠ¡ç«¯. è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ä¼šæœ‰å‡ ç§æƒ…å†µå‡ºç°:&lt;/p>
&lt;ul>
&lt;li>æ¶ˆæ¯å¤„ç†è€—æ—¶è¾ƒå¤š, å‡å¦‚å¤„ç†å•æ¡æ¶ˆæ¯çš„è€—æ—¶ä¸ºt, æ‹‰å–çš„æ¶ˆæ¯ä¸ªæ•°ä¸ºn. t * n &amp;gt; auto_commit_interval_ms, ä¼šå¯¼è‡´æ²¡æœ‰å¤„ç†å®Œçš„æ¶ˆæ¯çš„offsetè¢«commitåˆ°æœåŠ¡ç«¯. å‡å¦‚æ­¤æ—¶æ¶ˆè´¹ç«¯æŒ‚æ‰, æ²¡æœ‰å¤„ç†å®Œçš„æ•°æ®å°†ä¼šä¸¢å¤±.&lt;/li>
&lt;li>å‡å¦‚æ¶ˆæ¯å¤„ç†å®Œæˆ, offsetè¿˜æœªcommitåˆ°æœåŠ¡ç«¯çš„æ—¶å€™æ¶ˆè´¹ç«¯æŒ‚æ‰, å·²ç»å¤„ç†å®Œçš„æ¶ˆæ¯ä¼šè¢«å†æ¬¡æ¶ˆè´¹.&lt;/li>
&lt;/ul>
&lt;p>ä¸‹é¢é…ç½®å½±å“ç€æ•°æ®ä¸€è‡´æ€§å’Œæ€§èƒ½, å› æ­¤éœ€è¦ç»“åˆä¸šåŠ¡åœºæ™¯åˆç†é…ç½®ä¸€ä¸‹å‚æ•°, è¿›è¡Œå–èˆ.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>enable.auto.commit&lt;/code> é»˜è®¤ä¸ºtrue&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>auto.commit.interval.ms&lt;/code> é»˜è®¤ä¸º5000 ms (5s)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>max.poll.records&lt;/code> é»˜è®¤ä¸º500&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>fetch.max.bytes&lt;/code> é»˜è®¤ä¸º52428800 bytes (50Mib).&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="ä¸€è‡´æ€§">ä¸€è‡´æ€§&lt;/h3>
&lt;p>è¿™é‡Œæˆ‘ä»¬é’ˆå¯¹å‰é¢å‡ºç°çš„ä¸¤ä¸ªé—®é¢˜ç»™å‡ºè§£å†³æ–¹æ¡ˆ.&lt;/p>
&lt;h4 id="kafka-java-client">Kafka Java Client&lt;/h4>
&lt;p>æŠŠ&lt;code>enable.auto.commit&lt;/code>è®¾ç½®ä¸º&lt;code>false&lt;/code>, å¹¶åœ¨æ¯å¤„ç†å®Œä¸€æ¡æ•°æ®åæ‰‹åŠ¨æäº¤offset.&lt;/p>
&lt;p>&lt;strong>è¿™é‡Œéœ€è¦ä¸»æ„çš„æ—¶, æäº¤çš„offsetæ˜¯å¯¹å½“å‰æ¶ˆæ¯çš„offsetåŸºç¡€ä¸Šè¿›è¡ŒåŠ 1.&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ConsumerTest&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Properties&lt;/span> &lt;span class="n">props&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Properties&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">BOOTSTRAP_SERVERS_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;192.168.31.186:9092&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">GROUP_ID_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">AUTO_OFFSET_RESET_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">OffsetResetStrategy&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">NONE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">toLowerCase&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Locale&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ROOT&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ENABLE_AUTO_COMMIT_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">KEY_DESERIALIZER_CLASS_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;org.apache.kafka.common.serialization.StringDeserializer&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">VALUE_DESERIALIZER_CLASS_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;org.apache.kafka.common.serialization.StringDeserializer&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">KafkaConsumer&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">consumer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">KafkaConsumer&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="n">props&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">consumer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">subscribe&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Arrays&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">asList&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;my-topic&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ConsumerRecords&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">records&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">consumer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">poll&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">100&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">records&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerRecord&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">record&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">records&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;offset = %d, key = %s, value = %s%n&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">offset&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">key&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="c1">//Manually commit each record
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">consumer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">commitSync&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Collections&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">singletonMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">TopicPartition&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">topic&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">partition&lt;/span>&lt;span class="o">()),&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">OffsetAndMetadata&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">offset&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="spring-kafka">Spring Kafka&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>æŠŠ&lt;code>enable.auto.commit&lt;/code>è®¾ç½®ä¸º&lt;code>false&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è®¾ç½®&lt;code>ContainerProperties&lt;/code>çš„&lt;code>ackMode&lt;/code>ä¸º&lt;code>MANUAL_IMMEDIATE&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä½¿ç”¨AcknowledgingMessageListenerä½œä¸ºlistener, å¹¶åœ¨æ¶ˆæ¯å¤„ç†å®Œæˆåè°ƒç”¨acknowledgment.acknowledge().&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">SpringConsumerTest&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">String&lt;/span> &lt;span class="n">bootstrapServer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;192.168.31.186:9092&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">String&lt;/span> &lt;span class="n">groupId&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;spring-consumer-group&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">ContainerProperties&lt;/span> &lt;span class="n">containerProperties&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ContainerProperties&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;my-topic&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">containerProperties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setAckMode&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">AbstractMessageListenerContainer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">AckMode&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MANUAL_IMMEDIATE&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">containerProperties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setMessageListener&lt;/span>&lt;span class="o">(&lt;/span>
&lt;span class="o">(&lt;/span>&lt;span class="n">AcknowledgingMessageListener&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;)&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">consumerRecord&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">acknowledgment&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">consumerRecord&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">acknowledgment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">acknowledge&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">});&lt;/span>
&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">consumerConfigs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;();&lt;/span>
&lt;span class="n">consumerConfigs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">BOOTSTRAP_SERVERS_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">bootstrapServer&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">consumerConfigs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">GROUP_ID_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">groupId&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">consumerConfigs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ENABLE_AUTO_COMMIT_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">consumerConfigs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SESSION_TIMEOUT_MS_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">10&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">1000&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">consumerConfigs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">AUTO_OFFSET_RESET_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;earliest&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">consumerConfigs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">METADATA_MAX_AGE_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">10&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">1000&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">consumerConfigs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">KEY_DESERIALIZER_CLASS_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">StringDeserializer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">consumerConfigs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">VALUE_DESERIALIZER_CLASS_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">StringDeserializer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">KafkaMessageListenerContainer&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">listenerContainer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">KafkaMessageListenerContainer&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;(&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="n">DefaultKafkaConsumerFactory&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">consumerConfigs&lt;/span>&lt;span class="o">),&lt;/span>
&lt;span class="n">containerProperties&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">listenerContainer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Kafka æ°å¥½ä¸€æ¬¡å‘é€å’Œäº‹åŠ¡æ¶ˆè´¹ç¤ºä¾‹</title><link>https://atbug.com/kafka-exactly-once-delivery-and-transactional-messaging-example/</link><pubDate>Fri, 22 Sep 2017 18:03:43 +0000</pubDate><guid>https://atbug.com/kafka-exactly-once-delivery-and-transactional-messaging-example/</guid><description>
&lt;h3 id="æ ¸å¿ƒæ€æƒ³">æ ¸å¿ƒæ€æƒ³&lt;/h3>
&lt;ul>
&lt;li>ç”Ÿäº§ç«¯ä¸€è‡´æ€§: å¼€å¯å¹‚ç­‰å’Œäº‹åŠ¡, åŒ…å«é‡è¯•, å‘é€ç¡®è®¤, åŒä¸€ä¸ªè¿æ¥çš„æœ€å¤§æœªç¡®è®¤è¯·æ±‚æ•°.&lt;/li>
&lt;li>æ¶ˆè´¹ç«¯ä¸€è‡´æ€§: é€šè¿‡è®¾ç½®è¯»å·²æäº¤çš„æ•°æ®å’ŒåŒæ—¶å¤„ç†å®Œæˆæ¯ä¸€æ¡æ¶ˆæ¯ä¹‹åæ‰‹åŠ¨æäº¤offset.&lt;/li>
&lt;/ul>
&lt;h3 id="ç”Ÿäº§ç«¯">ç”Ÿäº§ç«¯&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ProducerTest&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ExecutionException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Properties&lt;/span> &lt;span class="n">props&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Properties&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ProducerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">BOOTSTRAP_SERVERS_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;192.168.31.186:9092&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ProducerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">TRANSACTIONAL_ID_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;my-transactional-id&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ProducerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ACKS_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;all&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ProducerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">RETRIES_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ProducerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">Producer&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">producer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">KafkaProducer&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="n">props&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">StringSerializer&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">StringSerializer&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="n">producer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">initTransactions&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">producer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">beginTransaction&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">5&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Future&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">RecordMetadata&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">send&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">producer&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">send&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">ProducerRecord&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="s">&amp;#34;my-topic&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Integer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">),&lt;/span> &lt;span class="n">Integer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">)));&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">send&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">offset&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1000L&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">producer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">commitTransaction&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ProducerFencedException&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">OutOfOrderSequenceException&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">AuthorizationException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// We can&amp;#39;t recover from these exceptions, so our only option is to close the producer and exit.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">producer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">KafkaException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// For all other exceptions, just abort the transaction and try again.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">producer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">abortTransaction&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">producer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ¶ˆè´¹ç«¯">æ¶ˆè´¹ç«¯&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ConsumerTest&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Properties&lt;/span> &lt;span class="n">props&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Properties&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">BOOTSTRAP_SERVERS_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;192.168.31.186:9092&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">GROUP_ID_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">AUTO_OFFSET_RESET_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">OffsetResetStrategy&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">NONE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">toLowerCase&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Locale&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ROOT&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ENABLE_AUTO_COMMIT_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">KEY_DESERIALIZER_CLASS_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;org.apache.kafka.common.serialization.StringDeserializer&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">VALUE_DESERIALIZER_CLASS_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;org.apache.kafka.common.serialization.StringDeserializer&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ISOLATION_LEVEL_CONFIG&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">IsolationLevel&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">READ_COMMITTED&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">toLowerCase&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Locale&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ROOT&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">KafkaConsumer&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">consumer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">KafkaConsumer&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="n">props&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">consumer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">subscribe&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Arrays&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">asList&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;my-topic&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ConsumerRecords&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">records&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">consumer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">poll&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">100&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">records&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ConsumerRecord&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">record&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">records&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;offset = %d, key = %s, value = %s%n&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">offset&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">key&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="c1">//Manually commit each record
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">consumer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">commitSync&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Collections&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">singletonMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">TopicPartition&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">topic&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">partition&lt;/span>&lt;span class="o">()),&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">OffsetAndMetadata&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">offset&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>æ°å¥½ä¸€æ¬¡å‘é€å’Œäº‹åŠ¡æ¶ˆæ¯(è¯‘)</title><link>https://atbug.com/kafka-exactly-once-delivery-and-transactional-messaging/</link><pubDate>Tue, 19 Sep 2017 19:13:26 +0000</pubDate><guid>https://atbug.com/kafka-exactly-once-delivery-and-transactional-messaging/</guid><description>
&lt;p>Kafkaæä¾›â€œè‡³å°‘ä¸€æ¬¡â€äº¤ä»˜è¯­ä¹‰, è¿™æ„å‘³ç€å‘é€çš„æ¶ˆæ¯å¯ä»¥ä¼ é€ä¸€æ¬¡æˆ–å¤šæ¬¡. äººä»¬çœŸæ­£æƒ³è¦çš„æ˜¯â€œä¸€æ¬¡â€è¯­ä¹‰,å› ä¸ºé‡å¤çš„æ¶ˆæ¯æ²¡æœ‰è¢«ä¼ é€’ã€‚&lt;/p>
&lt;p>æ™®éåœ°å‘å£°é‡å¤æ¶ˆæ¯çš„æƒ…å†µæœ‰ä¸¤ç§:&lt;/p>
&lt;ul>
&lt;li>å¦‚æœå®¢æˆ·ç«¯å°è¯•å‘é›†ç¾¤å‘é€æ¶ˆæ¯å¹¶è·å–ç½‘ç»œé”™è¯¯, åˆ™é‡è¯•å¯èƒ½ä¼šå¯¼è‡´é‡å¤. å¦‚æœåœ¨å‘é€æ¶ˆæ¯ä¹‹å‰å‘ç”Ÿç½‘ç»œé”™è¯¯, åˆ™ä¸ä¼šå‘ç”Ÿé‡å¤. ä½†æ˜¯, å¦‚æœåœ¨å°†æ¶ˆæ¯é™„åŠ åˆ°æ—¥å¿—ä¹‹åå‘ç”Ÿç½‘ç»œé”™è¯¯, ä½†åœ¨å°†å“åº”å‘é€ç»™å‘ä»¶äººä¹‹å‰, å‘ä»¶äººå°†ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ. å”¯ä¸€çš„é€‰æ‹©æ˜¯é‡è¯•å’Œå†’é™©é‡å¤æˆ–æ”¾å¼ƒå¹¶å£°æ˜æ¶ˆæ¯ä¸¢å¤±ã€‚&lt;/li>
&lt;li>å¦‚æœå®¢æˆ·ç«¯å°è¯•å‘é›†ç¾¤å‘é€æ¶ˆæ¯å¹¶è·å–ç½‘ç»œé”™è¯¯, åˆ™é‡è¯•å¯èƒ½ä¼šå¯¼è‡´é‡å¤. å¦‚æœåœ¨å‘é€æ¶ˆæ¯ä¹‹å‰å‘ç”Ÿç½‘ç»œé”™è¯¯, åˆ™ä¸ä¼šå‘ç”Ÿé‡å¤. ä½†æ˜¯, å¦‚æœåœ¨å°†æ¶ˆæ¯é™„åŠ åˆ°æ—¥å¿—ä¹‹åå‘ç”Ÿç½‘ç»œé”™è¯¯, ä½†åœ¨å°†å“åº”å‘é€ç»™å‘ä»¶äººä¹‹å‰, å‘ä»¶äººå°†ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ. å”¯ä¸€çš„é€‰æ‹©æ˜¯é‡è¯•å’Œå†’é™©é‡å¤æˆ–æ”¾å¼ƒå¹¶å£°æ˜æ¶ˆæ¯ä¸¢å¤±ã€‚&lt;/li>
&lt;/ul>
&lt;p>ç¬¬äºŒç§æƒ…å†µå¯ä»¥é€šè¿‡ä½¿ç”¨Kafkaæä¾›çš„åç§»é‡ç”±æ¶ˆè´¹è€…å¤„ç†. ä»–ä»¬å¯ä»¥å°†åç§»é‡ä¸å…¶è¾“å‡ºè¿›è¡Œå­˜å‚¨, ç„¶åç¡®ä¿æ–°æ¶ˆè´¹è€…å§‹ç»ˆä»æœ€åå­˜å‚¨çš„åç§»é‡ä¸­æå–. æˆ–è€…, ä»–ä»¬å¯ä»¥ä½¿ç”¨åç§»é‡ä½œä¸ºä¸€ç§å…³é”®å­—, å¹¶ä½¿ç”¨å®ƒæ¥å¯¹å…¶è¾“å‡ºçš„ä»»ä½•æœ€ç»ˆç›®æ ‡ç³»ç»Ÿè¿›è¡Œé‡å¤æ•°æ®åˆ é™¤ã€‚&lt;/p>
&lt;h2 id="producer-apiæ”¹åŠ¨">Producer APIæ”¹åŠ¨&lt;/h2>
&lt;p>&lt;strong>KafkaProducer.java&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="nc">Producer&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">Closeable&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Needs to be called before any of the other transaction methods. Assumes that
&lt;/span>&lt;span class="cm"> * the transactional.id is specified in the producer configuration.
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * This method does the following:
&lt;/span>&lt;span class="cm"> * 1. Ensures any transactions initiated by previous instances of the producer
&lt;/span>&lt;span class="cm"> * are completed. If the previous instance had failed with a transaction in
&lt;/span>&lt;span class="cm"> * progress, it will be aborted. If the last transaction had begun completion,
&lt;/span>&lt;span class="cm"> * but not yet finished, this method awaits its completion.
&lt;/span>&lt;span class="cm"> * 2. Gets the internal producer id and epoch, used in all future transactional
&lt;/span>&lt;span class="cm"> * messages issued by the producer.
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * @throws IllegalStateException if the TransactionalId for the producer is not set
&lt;/span>&lt;span class="cm"> * in the configuration.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">initTransactions&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">IllegalStateException&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Should be called before the start of each new transaction.
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * @throws ProducerFencedException if another producer is with the same
&lt;/span>&lt;span class="cm"> * transactional.id is active.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">beginTransaction&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">ProducerFencedException&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Sends a list of consumed offsets to the consumer group coordinator, and also marks
&lt;/span>&lt;span class="cm"> * those offsets as part of the current transaction. These offsets will be considered
&lt;/span>&lt;span class="cm"> * consumed only if the transaction is committed successfully.
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * This method should be used when you need to batch consumed and produced messages
&lt;/span>&lt;span class="cm"> * together, typically in a consume-transform-produce pattern.
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * @throws ProducerFencedException if another producer is with the same
&lt;/span>&lt;span class="cm"> * transactional.id is active.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">sendOffsetsToTransaction&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">TopicPartition&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">OffsetAndMetadata&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">offsets&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">String&lt;/span> &lt;span class="n">consumerGroupId&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">ProducerFencedException&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Commits the ongoing transaction.
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * @throws ProducerFencedException if another producer is with the same
&lt;/span>&lt;span class="cm"> * transactional.id is active.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">commitTransaction&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">ProducerFencedException&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Aborts the ongoing transaction.
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * @throws ProducerFencedException if another producer is with the same
&lt;/span>&lt;span class="cm"> * transactional.id is active.
&lt;/span>&lt;span class="cm">
&lt;/span>&lt;span class="cm">
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">abortTransaction&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">ProducerFencedException&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Send the given record asynchronously and return a future which will eventually contain the response information.
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * @param record The record to send
&lt;/span>&lt;span class="cm"> * @return A future which will eventually contain the response information
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Future&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">RecordMetadata&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">send&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ProducerRecord&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Send a record and invoke the given callback when the record has been acknowledged by the server
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Future&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">RecordMetadata&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">send&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ProducerRecord&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Callback&lt;/span> &lt;span class="n">callback&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="outofsequenceexception">OutOfSequenceException&lt;/h3>
&lt;p>å¦‚æœbrokeræ£€æµ‹åˆ°æ•°æ®ä¸¢å¤±ï¼Œç”Ÿäº§è€…å°†æŠ›å‡ºOutOfOrderSequenceExceptionã€‚ æ¢å¥è¯è¯´ï¼Œå¦‚æœå®ƒæ¥æ”¶åˆ°å¤§äºå…¶é¢„æœŸçš„åºåˆ—çš„åºåˆ—å·ã€‚ æœªæ¥å°†è¿”å›æ­¤å¼‚å¸¸ï¼Œå¹¶ä¼ é€’ç»™å›è°ƒï¼ˆå¦‚æœæœ‰ï¼‰ã€‚ è¿™æ˜¯ä¸€ä¸ªè‡´å‘½çš„å¼‚å¸¸ï¼Œæ–°çš„Produceræ–¹æ³•å¦‚sendï¼ŒbeginTransactionï¼ŒcommitTransactionç­‰å°†ä¼šæŠ›å‡ºIlegalStateExceptionã€‚&lt;/p>
&lt;h3 id="åº”ç”¨ç¤ºä¾‹">åº”ç”¨ç¤ºä¾‹&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">KafkaTransactionsExample&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">[])&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">KafkaConsumer&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">consumer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">KafkaConsumer&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="n">consumerConfig&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// Note that the â€˜transactional.idâ€™ configuration _must_ be specified in the
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// producer config in order to use transactions.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">KafkaProducer&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">producer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">KafkaProducer&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="n">producerConfig&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// We need to initialize transactions once per producer instance. To use transactions,
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// it is assumed that the application id is specified in the config with the key
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// transactional.id.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// This method will recover or abort transactions initiated by previous instances of a
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// producer with the same app id. Any other transactional messages will report an error
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// if initialization was not performed.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// The response indicates success or failure. Some failures are irrecoverable and will
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// require a new producer instance. See the documentation for TransactionMetadata for a
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// list of error codes.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">producer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">initTransactions&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">while&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ConsumerRecords&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">records&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">consumer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">poll&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">CONSUMER_POLL_TIMEOUT&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">records&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// Start a new transaction. This will begin the process of batching the consumed
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// records as well
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// as an records produced as a result of processing the input records.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// We need to check the response to make sure that this producer is able to initiate
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// a new transaction.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">producer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">beginTransaction&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="c1">// Process the input records and send them to the output topic(s).
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ProducerRecord&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">outputRecords&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">processRecords&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">records&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ProducerRecord&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">outputRecord&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">outputRecords&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">producer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">send&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">outputRecord&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// To ensure that the consumed and produced messages are batched, we need to commit
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// the offsets through
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// the producer and not the consumer.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// If this returns an error, we should abort the transaction.
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="n">sendOffsetsResult&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">producer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sendOffsetsToTransaction&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">getUncommittedOffsets&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="c1">// Now that we have consumed, processed, and produced a batch of messages, let&amp;#39;s
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// commit the results.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// If this does not report success, then the transaction will be rolled back.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">producer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">endTransaction&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ–°å¢é…ç½®">æ–°å¢é…ç½®&lt;/h3>
&lt;h4 id="brokeré…ç½®">Brokeré…ç½®&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>é…ç½®&lt;/th>
&lt;th>æè¿°&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>transactional.id.timeout.ms&lt;/td>
&lt;td>äº‹åŠ¡åè°ƒå™¨åœ¨ä¸»åŠ¨è¿‡æœŸç”Ÿæˆå™¨TransactionalIdä¹‹å‰ç­‰å¾…çš„æœ€å¤§æ—¶é—´ï¼ˆä»¥msä¸ºå•ä½ï¼‰ï¼Œè€Œä¸ä»ä¸­æ¥æ”¶ä»»ä½•äº‹åŠ¡çŠ¶æ€æ›´æ–°ã€‚é»˜è®¤ä¸º604800000ï¼ˆ7å¤©ï¼‰ã€‚ è¿™å…è®¸å®šæœŸçš„æ¯å‘¨ç”Ÿäº§è€…å·¥ä½œæ¥ç»´æŠ¤å…¶IDã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>max.transaction.timeout.ms&lt;/td>
&lt;td>å…è®¸çš„æœ€å¤§çš„äº‹åŠ¡è¶…æ—¶æ—¶é—´. å¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯çš„äº‹åŠ¡è¯·æ±‚è¶…å‡ºè¿™ä¸ªè®¾ç½®, brokerä¼šåœ¨InitPidRequestçš„æ—¶å€™è¿”å›ä¸€ä¸ªInvalidTransactionTimeout. è¿™æ ·å¯ä»¥é˜²æ­¢å®¢æˆ·ç«¯å¤ªå¤§çš„è¶…æ—¶ï¼Œè¿™å¯èƒ½ä¼šå»¶è¿Ÿæ¶ˆè´¹è€…ä»åŒ…å«åœ¨äº‹åŠ¡ä¸­çš„ä¸»é¢˜ä¸­è¯»å–æ¶ˆæ¯. é»˜è®¤å€¼ä¸º900000ï¼ˆ15åˆ†é’Ÿï¼‰ã€‚ è¿™æ˜¯åœ¨æ¶ˆæ¯çš„äº¤æ˜“éœ€è¦å‘é€çš„æ—¶é—´æ®µå†…çš„ä¿å®ˆä¸Šé™ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>transaction.state.log.replication.factor&lt;/td>
&lt;td>äº‹åŠ¡çŠ¶æ€ä¸»é¢˜(__transaction_state)çš„å‰¯æœ¬æ•°, é»˜è®¤ä¸º3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>transaction.state.log.num.partitions&lt;/td>
&lt;td>äº‹åŠ¡çŠ¶æ€ä¸»é¢˜(__transaction_state)çš„çš„åˆ†åŒºæ•°, é»˜è®¤ä¸º50&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>transaction.state.log.min.isr&lt;/td>
&lt;td>äº‹åŠ¡çŠ¶æ€ä¸»é¢˜çš„æ¯ä¸ªåˆ†åŒºçš„æœ€å°æ•°é‡çš„å¼‚æ­¥å‰¯æœ¬éœ€è¦è¢«è§†ä¸ºè”æœºçš„ã€‚ é»˜è®¤ä¸º2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>transaction.state.log.segment.bytes&lt;/td>
&lt;td>äº‹åŠ¡çŠ¶æ€ä¸»é¢˜çš„æ®µå¤§å°ã€‚é»˜è®¤å€¼ï¼š104857600å­—èŠ‚ã€‚100m&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="ç”Ÿäº§è€…é…ç½®">ç”Ÿäº§è€…é…ç½®&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>é…ç½®&lt;/th>
&lt;th>æè¿°&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>enable.idempotence&lt;/td>
&lt;td>æ˜¯å¦å¯ç”¨å¹‚ç­‰ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸ºfalseï¼‰ã€‚ å¦‚æœç¦ç”¨ï¼Œç”Ÿäº§è€…å°†ä¸ä¼šåœ¨ç”Ÿæˆè¯·æ±‚ä¸­è®¾ç½®PIDå­—æ®µï¼Œå¹¶ä¸”å½“å‰çš„ç”Ÿäº§è€…ä¼ é€’è¯­ä¹‰å°†ç”Ÿæ•ˆã€‚ è¯·æ³¨æ„ï¼Œå¿…é¡»å¯ç”¨å¹‚ç­‰æ‰èƒ½ä½¿ç”¨äº‹åŠ¡ã€‚å½“å¯ç”¨å¹‚ç­‰æ—¶ï¼Œæˆ‘ä»¬å¼ºåˆ¶æ‰§è¡Œacks = allï¼Œretries&amp;gt; 1å’Œmax.inflight.requests.per.connection = 1ã€‚ æ²¡æœ‰è¿™äº›é…ç½®çš„è¿™äº›å€¼ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿è¯å¹‚ç­‰ã€‚ å¦‚æœè¿™äº›è®¾ç½®æœªè¢«åº”ç”¨ç¨‹åºæ˜¾å¼è¦†ç›–ï¼Œåˆ™åœ¨å¯ç”¨å¹‚ç­‰æ—¶ï¼Œç”Ÿäº§è€…å°†è®¾ç½®acks = allï¼Œretries = Integer.MAX_VALUEå’Œmax.inflight.requests.per.connection = 1ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>transaction.timeout.ms&lt;/td>
&lt;td>åœ¨ä¸»åŠ¨ä¸­æ­¢æ­£åœ¨è¿›è¡Œçš„äº‹åŠ¡ä¹‹å‰ï¼Œäº‹åŠ¡åè°ƒå™¨å°†ç­‰å¾…ç”Ÿäº§è€…çš„äº‹åŠ¡çŠ¶æ€æ›´æ–°çš„æœ€é•¿æ—¶é—´ï¼ˆä»¥msä¸ºå•ä½ï¼‰ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>transactional.id&lt;/td>
&lt;td>ç”¨äºäº‹åŠ¡ä¼ é€’çš„TransactionalIdã€‚ è¿™ä½¿å¾—å¯ä»¥è·¨è¶Šå¤šä¸ªç”Ÿäº§è€…ä¼šè¯çš„å¯é æ€§è¯­ä¹‰ï¼Œå› ä¸ºå®ƒå…è®¸å®¢æˆ·ç«¯ä¿è¯åœ¨å¼€å§‹ä»»ä½•æ–°äº‹åŠ¡ä¹‹å‰ä½¿ç”¨ç›¸åŒçš„TransactionalIdçš„äº‹åŠ¡å·²ç»å®Œæˆã€‚ å¦‚æœæ²¡æœ‰æä¾›TransactionalIdï¼Œåˆ™ç”Ÿäº§è€…è¢«é™åˆ¶ä¸ºå¹‚ç­‰ä¼ é€’ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœé…ç½®äº†TransactionalIdï¼Œåˆ™å¿…é¡»å¯ç”¨enable.idempotenceã€‚é»˜è®¤å€¼ä¸ºç©ºï¼Œè¿™æ„å‘³ç€æ— æ³•ä½¿ç”¨äº‹åŠ¡ã€‚&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="æ¶ˆè´¹è€…é…ç½®">æ¶ˆè´¹è€…é…ç½®&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>é…ç½®&lt;/th>
&lt;th>æè¿°&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>isolation.level&lt;/td>
&lt;td>ä»¥ä¸‹æ˜¯å¯èƒ½çš„å€¼ï¼ˆé»˜è®¤ä¸ºread_uncommittedï¼‰ï¼šread_uncommittedï¼šåœ¨åç§»é¡ºåºä¸­æ¶ˆè´¹å·²æäº¤å’Œæœªæäº¤çš„æ¶ˆæ¯; read_committedï¼šä»…ä»¥åç§»é¡ºåºæ¶ˆè€—éäº‹åŠ¡æ€§æ¶ˆæ¯æˆ–å·²æäº¤äº‹åŠ¡æ¶ˆæ¯ã€‚ ä¸ºäº†ä¿æŒåç§»é¡ºåºï¼Œè¯¥è®¾ç½®æ„å‘³ç€æˆ‘ä»¬å¿…é¡»ç¼“å†²æ¶ˆè´¹è€…ä¸­çš„æ¶ˆæ¯ï¼Œç›´åˆ°æˆ‘ä»¬çœ‹åˆ°ç»™å®šäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ã€‚&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="2">2&lt;/h4>
&lt;h2 id="idempotent-producer">Idempotent Producer&lt;/h2>
&lt;h3 id="å¹‚ç­‰ç”Ÿäº§è€…ä¿éšœ">å¹‚ç­‰ç”Ÿäº§è€…ä¿éšœ&lt;/h3>
&lt;p>ä¸ºäº†å®ç°å¹‚ç­‰ç”Ÿäº§è€…è¯­ä¹‰, å¼•å…¥äº†&lt;code>producer id&lt;/code>çš„æ¦‚å¿µ, ä¸‹é¢ç§°&lt;code>PID&lt;/code>. æ¯ä¸ªproduceråœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€PID. PIDçš„åˆ†é…å¯¹ç”¨æˆ·æ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„, ä¸”æ²¡æœ‰è¢«å®¢æˆ·ç«¯æš´éœ².&lt;/p>
&lt;p>PIDæ˜¯ä»0å¼€å§‹å•è°ƒé€’å¢çš„, è¿˜æœ‰ä¸€ä¸ªå°†è¦å°†è¦æ¥å—æ¶ˆæ¯çš„ä¸»é¢˜åˆ†åŒºçš„åºå·. åºå·ä¼šéšç€producerå‘brokerå‘é€æ¶ˆæ¯å¢é•¿. brokeråœ¨å†…å­˜ä¸­ç»´æŠ¤ç€ä»æ¯ä¸ªPIDä¸­å‘è¿‡æ¥çš„åºå·. å¦‚æœåºå·ä¸æ˜¯æ¯”ä¸Šæ¬¡æäº¤PID/TopicParitionç»„ä¸­çš„çš„åºå·å¤§ä¸€, brokerä¼šæ‹’ç»producerçš„è¯·æ±‚. å¸¦æœ‰è¾ƒå°åºå·çš„æ¶ˆæ¯ä¼šå¼•å‘é‡å¤é”™è¯¯, producerå¯ä»¥å¿½ç•¥è¯¥é”™è¯¯. å¸¦æœ‰è¾ƒå¤§çš„åºå·çš„æ¶ˆæ¯ä¼šå¯¼è‡´è¶…å‡ºåºå·çš„é”™è¯¯, æ„å‘³ç€å­˜åœ¨æ¶ˆæ¯ä¸¢å¤±, è¿™æ˜¯è‡´å‘½çš„é”™è¯¯.&lt;/p>
&lt;p>ä¸ºäº†ä¿è¯æ¯æ¡æ¶ˆæ¯éƒ½è¢«æ°å¥½ä¸€æ¬¡åœ°æŒä¹…åŒ–åœ¨logä¸­, produceréœ€è¦åœ¨å¤±è´¥çš„æ—¶å€™é‡è¯•è¯·æ±‚. æ¯ä¸ªç”Ÿäº§è€…å®ä¾‹éƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„å”¯ä¸€çš„PID, å› æ­¤æˆ‘ä»¬åªèƒ½åœ¨å•ä¸€çš„ç”Ÿäº§è€…ä¼šè¯ä¸­ä¿è¯å¹‚ç­‰.&lt;/p>
&lt;p>è¿™äº›å¹‚ç­‰ç”Ÿæˆå™¨è¯­ä¹‰å¯¹äºæ— çŠ¶æ€åº”ç”¨ç¨‹åºï¼ˆå¦‚æŒ‡æ ‡è·Ÿè¸ªå’Œå®¡è®¡ï¼‰æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚&lt;/p>
&lt;h3 id="äº‹åŠ¡ä¿éšœ">äº‹åŠ¡ä¿éšœ&lt;/h3>
&lt;p>åœ¨æ ¸å¿ƒä¸Š, äº‹åŠ¡ä¿è¯ä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿä»¥åŸå­æ–¹å¼ç”Ÿæˆå¤šä¸ªä¸»é¢˜åˆ†åŒº, å¯¹è¿™äº›ä¸»é¢˜åˆ†åŒºçš„æ‰€æœ‰å†™å…¥å°†æˆåŠŸæˆ–å¤±è´¥ä½œä¸ºä¸€ä¸ªå•å…ƒã€‚&lt;/p>
&lt;p>æ­¤å¤–, ç”±äºæ¶ˆè´¹è€…è¿›åº¦è¢«è®°å½•ä¸ºå¯¹åç§»ä¸»é¢˜çš„å†™å…¥, æ‰€ä»¥åˆ©ç”¨ä¸Šè¿°èƒ½åŠ›æ¥ä½¿å¾—åº”ç”¨èƒ½å¤Ÿå°†æ¶ˆè´¹å’Œäº§ç”Ÿçš„æ¶ˆæ¯æ‰¹é‡åŒ–æˆå•ä¸ªåŸå­å•å…ƒ. åªæœ‰æ•´ä¸ªâ€œæ¶ˆè´¹å˜æ¢äº§å“â€å…¨éƒ¨æ‰§è¡Œ, æ‰èƒ½å°†æ¶ˆæ¯é›†åˆè§†ä¸ºæ¶ˆè´¹ã€‚&lt;/p>
&lt;p>ä¸ºäº†è·¨å¤šä¸ªç”Ÿäº§è€…ä¼šè¯å®ç°å¹‚ç­‰, éœ€è¦æä¾›ä¸€ä¸ªåœ¨åº”ç”¨å±‚é¢å¯ä»¥ç¨³å®šçš„è·¨å¤šä¸ªä¼šè¯çš„transactionalId. transactionalIdç”±ç”¨æˆ·æä¾›.&lt;/p>
&lt;p>æœ‰transactionalIdå, Kafkaå¯ä»¥ä¿è¯:&lt;/p>
&lt;ol>
&lt;li>ä¸€ä¸ªç»™å®šçš„transactionalIdåªæœ‰ä¸€ä¸ªæ´»è·ƒçš„producer. å¦‚æœæœ‰æ–°çš„ä½¿ç”¨åŒä¸€ä¸ªtransactionalIdçš„producerå®ä¾‹ä¸Šçº¿, æ—§çš„å®ä¾‹ä¼šè¢«éš”ç¦».&lt;/li>
&lt;li>è·¨åº”ç”¨ä¼šè¯çš„äº‹åŠ¡æ¢å¤, å½“ä¸€ä¸ªåº”ç”¨å®ä¾‹æ­»æ‰å, brokerä¼šç»“æŸ(å–æ¶ˆæˆ–è€…æäº¤)æœªå®Œæˆçš„äº‹åŠ¡ä»¥ä¿æŠ¤æ–°ä¸Šçº¿çš„å®ä¾‹, åœ¨æ¢å¤å·¥ä½œä¹‹å‰å°†æ–°å®ä¾‹ç½®äºå¹²å‡€çš„çŠ¶æ€.&lt;/li>
&lt;/ol>
&lt;p>æ³¨æ„è¿™é‡Œæåˆ°çš„äº‹åŠ¡ä¿éšœæ˜¯ä»producerçš„è§’åº¦. åœ¨consumerç«¯, ä¿éšœå°±ä¼šå¼±ä¸€äº›. ç‰¹åˆ«æ˜¯, æˆ‘ä»¬ä¸èƒ½ä¿è¯æ‰¿è¯ºäº‹åŠ¡çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å°†ä¸€èµ·è¢«æ¶ˆè´¹ã€‚åŸå› å¦‚ä¸‹:&lt;/p>
&lt;ol>
&lt;li>å¯¹äºå‹ç¼©ä¸»é¢˜, äº‹åŠ¡çš„ä¸€äº›æ¶ˆæ¯å¯èƒ½è¢«è¾ƒæ–°ç‰ˆæœ¬è¦†ç›–ã€‚&lt;/li>
&lt;li>äº‹åŠ¡å¯èƒ½è·¨è¶Šæ—¥å¿—æ®µ. å› æ­¤, å½“æ—§æ®µåˆ é™¤æ—¶, æˆ‘ä»¬å¯èƒ½ä¼šåœ¨äº‹åŠ¡çš„ç¬¬ä¸€éƒ¨åˆ†ä¸¢å¤±ä¸€äº›æ¶ˆæ¯ã€‚&lt;/li>
&lt;li>æ¶ˆè´¹è€…å¯èƒ½ä¼šåœ¨äº‹åŠ¡ä¸­å¯»æ±‚ä»»æ„çš„offset, å› æ­¤ç¼ºå°‘ä¸€äº›åˆå§‹æ¶ˆæ¯ã€‚&lt;/li>
&lt;li>æ¶ˆè´¹è€…å¯èƒ½ä¸ä¼šä»å‚ä¸äº‹åŠ¡çš„æ‰€æœ‰åˆ†åŒºä¸­æ¶ˆè´¹. å› æ­¤, ä»–ä»¬æ°¸è¿œæ— æ³•è¯»å–åŒ…å«è¯¥äº‹åŠ¡çš„æ‰€æœ‰æ¶ˆæ¯ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="å…³é”®æ¦‚å¿µ">å…³é”®æ¦‚å¿µ&lt;/h2>
&lt;p>å®ç°äº‹åŠ¡, å³ç¡®ä¿ä¸€ç»„æ¶ˆæ¯ä»¥åŸå­æ–¹å¼äº§ç”Ÿå’Œæ¶ˆè´¹, æˆ‘ä»¬ä»‹ç»å‡ ä¸ªæ–°æ¦‚å¿µï¼š&lt;/p>
&lt;ol>
&lt;li>æˆ‘ä»¬å¼•è¿›ä¸€ä¸ªç§°ä¸ºäº‹åŠ¡åè°ƒå™¨(Transaction Coordinator)çš„æ–°å®ä½“ã€‚ä¸æ¶ˆè´¹è€…ç»„åè°ƒå™¨ç±»ä¼¼, æ¯ä¸ªç”Ÿäº§è€…éƒ½è¢«åˆ†é…ä¸€ä¸ªäº‹åŠ¡åè°ƒå™¨, æ‰€æœ‰åˆ†é…PIDå’Œç®¡ç†äº‹åŠ¡çš„é€»è¾‘éƒ½ç”±äº‹åŠ¡åè°ƒå™¨å®Œæˆã€‚&lt;/li>
&lt;li>æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªåä¸ºäº‹åŠ¡æ—¥å¿—(Transaction Log)çš„æ–°çš„å†…éƒ¨kafkaä¸»é¢˜(__transaction_state)ã€‚ä¸Consumer Offsetsä¸»é¢˜(__consumer_offsets)ç±»ä¼¼, äº‹åŠ¡æ—¥å¿—æ˜¯æ¯ä¸ªäº‹åŠ¡çš„æŒä¹…å’Œå¤åˆ¶è®°å½•ã€‚äº‹åŠ¡æ—¥å¿—æ˜¯äº‹åŠ¡åè°ƒå™¨çš„çŠ¶æ€å­˜å‚¨, æœ€æ–°ç‰ˆæœ¬çš„æ—¥å¿—çš„å¿«ç…§å°è£…äº†æ¯ä¸ªæ´»åŠ¨äº‹åŠ¡çš„å½“å‰çŠ¶æ€ã€‚&lt;/li>
&lt;li>æˆ‘ä»¬å¼•å…¥æ§åˆ¶æ¶ˆæ¯(Control Messages)çš„æ¦‚å¿µã€‚è¿™äº›æ˜¯å†™å…¥ç”¨æˆ·ä¸»é¢˜çš„ç‰¹æ®Šæ¶ˆæ¯, ç”±å®¢æˆ·ç«¯å¤„ç†, ä½†ä¸ä¼šæš´éœ²ç»™ç”¨æˆ·ã€‚ä¾‹å¦‚, å®ƒä»¬è¢«ç”¨äºè®©brokerå‘æ¶ˆè´¹è€…è¡¨æ˜å…ˆå‰æå–çš„æ¶ˆæ¯æ˜¯å¦å·²ç»åŸå­æ€§åœ°æäº¤ã€‚ä»¥å‰åœ¨&lt;a href="https://issues.apache.org/jira/browse/KAFKA-1639">è¿™é‡Œ&lt;/a>æå‡ºæ§åˆ¶æ¶ˆæ¯ã€‚&lt;/li>
&lt;li>æˆ‘ä»¬å¼•å…¥äº†TransactionalIdçš„æ¦‚å¿µ, ä½¿ç”¨æˆ·èƒ½å¤Ÿä»¥æŒç»­çš„æ–¹å¼å”¯ä¸€åœ°è¯†åˆ«ç”Ÿäº§è€…ã€‚å…·æœ‰ç›¸åŒTransactionalIdçš„ç”Ÿäº§è€…çš„ä¸åŒå®ä¾‹å°†èƒ½å¤Ÿæ¢å¤ï¼ˆæˆ–ä¸­æ­¢ï¼‰ç”±ä¸Šä¸€ä¸ªå®ä¾‹å®ä¾‹åŒ–çš„ä»»ä½•äº‹åŠ¡ã€‚&lt;/li>
&lt;li>æˆ‘ä»¬å¼•å…¥ç”Ÿäº§è€…ä»£(producer epoch)çš„æ¦‚å¿µ, è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿç¡®ä¿åªæœ‰ä¸€ä¸ªå…·æœ‰ç»™å®šçš„TransactionalIdçš„ç”Ÿäº§è€…çš„åˆæ³•æ´»åŠ¨å®ä¾‹, ä»è€Œä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨å‘ç”Ÿæ•…éšœçš„æƒ…å†µä¸‹ç»´æŠ¤äº‹åŠ¡ä¿è¯ã€‚&lt;/li>
&lt;/ol>
&lt;p>é™¤äº†ä¸Šè¿°æ–°æ¦‚å¿µä¹‹å¤–, æˆ‘ä»¬è¿˜å¼•å…¥äº†æ–°çš„è¯·æ±‚ç±»å‹, æ–°ç‰ˆæœ¬çš„ç°æœ‰è¯·æ±‚ä»¥åŠæ–°ç‰ˆæœ¬çš„æ ¸å¿ƒæ¶ˆæ¯æ ¼å¼, ä»¥æ”¯æŒäº‹åŠ¡ã€‚æ‰€æœ‰è¿™äº›çš„ç»†èŠ‚å°†æ¨è¿Ÿåˆ°å…¶ä»–æ–‡æ¡£ã€‚&lt;/p>
&lt;h2 id="æ•°æ®æµ">æ•°æ®æµ&lt;/h2>
&lt;p>&lt;img src="https://cwiki.apache.org/confluence/download/attachments/66854913/Kafka%20Transactions%20Data%20Flow.png?version=1&amp;amp;modificationDate=1487185558000&amp;amp;api=v2" alt="img">&lt;/p>
&lt;p>åœ¨ä¸Šå›¾ä¸­, å°–é”çš„è¾¹æ¡†è¡¨ç¤ºä¸åŒçš„æœºå™¨. åº•éƒ¨çš„åœ†å½¢ç›’å­è¡¨ç¤ºKafka TopicPartitions, è€Œå¯¹è§’åœ†å½¢çš„æ¡†ä»£è¡¨åœ¨brokerå†…éƒ¨è¿è¡Œçš„é€»è¾‘å®ä½“ã€‚&lt;/p>
&lt;p>æ¯ä¸ªç®­å¤´è¡¨ç¤ºRPCæˆ–å†™å…¥Kafkaä¸»é¢˜. è¿™äº›æ“ä½œæŒ‰ç…§æ¯ä¸ªç®­å¤´æ—è¾¹çš„æ•°å­—è¡¨ç¤ºçš„é¡ºåºè¿›è¡Œ. ä¸‹é¢çš„éƒ¨åˆ†ç¼–å·ä¸ºä¸ä¸Šå›¾ä¸­çš„æ“ä½œç›¸åŒ¹é…, å¹¶æè¿°ç›¸å…³æ“ä½œã€‚&lt;/p>
&lt;h3 id="1-æŸ¥æ‰¾ä¸€ä¸ªäº‹åŠ¡åè°ƒå™¨--findcoordinatorrequest">1. æŸ¥æ‰¾ä¸€ä¸ªäº‹åŠ¡åè°ƒå™¨ â€” FindCoordinatorRequest&lt;/h3>
&lt;p>äº‹åŠ¡åè°ƒå™¨æ˜¯åˆ†é…PIDså’Œç®¡ç†äº‹åŠ¡çš„æ ¸å¿ƒç»„ä»¶, producerçš„ç¬¬ä¸€ä»¶äº‹æ˜¯å‘é€ä¸€ä¸ªFindCoordinatorRequestè¯·æ±‚(ä¹‹å‰è¢«ç§°ä¸ºGroupCoordinatorRequest, ä½†æ˜¯ç°åœ¨æ›´åä¸ºæ›´ä¸€èˆ¬çš„ç”¨æ³•)åˆ°brokerå»è·å–å…¶coordinatorçš„ä½ç½®. è¯‘è€…è¡¥å……æ¯”å¦‚ip, port.&lt;/p>
&lt;h3 id="2-è·å–ä¸€ä¸ªproducer-id--initpidrequest">2. è·å–ä¸€ä¸ªProducer Id â€” InitPidRequest&lt;/h3>
&lt;p>è·å–åˆ°coordinatorä½ç½®ä¹‹å, ä¸‹ä¸€æ­¥æ˜¯è·å–producerçš„PID. è¿™ä¸ªé€šè¿‡å‘é€InitPidRequestè¯·æ±‚åˆ°äº‹åŠ¡åè°ƒå™¨å®Œæˆ.&lt;/p>
&lt;h4 id="21å½“æœ‰æŒ‡å®štransactionlidæ—¶">2.1å½“æœ‰æŒ‡å®šTransactionlIdæ—¶&lt;/h4>
&lt;p>å¦‚æœæœ‰é…ç½®transactionl.id, TransactionalIdä¼šéšç€InitPidRequestè¯·æ±‚å‘å‡º, åŒæ—¶åœ¨2aä¸­å°†PIDå’ŒTransactionalIdçš„å¯¹åº”å…³ç³»ä¿å­˜åœ¨äº‹åŠ¡æ—¥å¿—ä¸­. è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†TransactionalIdè¿”å›ç›¸åŒçš„PIDç»™ç”Ÿäº§è€…çš„æœªæ¥å®ä¾‹, å› æ­¤å¯ä»¥æ¢å¤æˆ–ä¸­æ­¢ä»¥å‰ä¸å®Œæ•´çš„äº‹åŠ¡ã€‚&lt;/p>
&lt;p>é™¤äº†è¿”å›PIDä¹‹å¤–, InitPidRequestè¿˜æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š&lt;/p>
&lt;pre>&lt;code> 1. æå‡PIDçš„ä»£, ä½¿ç”Ÿäº§è€…çš„ä»»ä½•ä¹‹å‰çš„åƒµå°¸å®ä¾‹è¢«éš”ç¦»èµ·æ¥, ä¸èƒ½å¤„ç†äº‹åŠ¡.
2. æ¢å¤(å‘å‰æ»šåŠ¨æˆ–å›æ»š)ç”±ç”Ÿäº§è€…çš„ä¸Šä¸€ä¸ªå®ä¾‹æ²¡æœ‰å®Œæˆçš„ä»»åŠ¡äº‹åŠ¡.
&lt;/code>&lt;/pre>
&lt;p>InitPIDRequestçš„å¤„ç†æ˜¯åŒæ­¥å®Œæˆçš„. ä¸€æ—¦è¿”å›, producerå¯ä»¥å‘é€æ•°æ®å’Œå¼€å§‹æ–°çš„äº‹åŠ¡.&lt;/p>
&lt;h4 id="22å½“æ²¡æœ‰æŒ‡å®štransactionalid">2.2å½“æ²¡æœ‰æŒ‡å®šTransactionalId&lt;/h4>
&lt;p>å¦‚æœæ²¡æœ‰é…ç½®TransactionalId, ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„PID. è¿™æ˜¯produceråªåœ¨å•ä¸€çš„sessionä¸­å®ç°äº†å¹‚ç­‰è¯­ä¹‰å’Œäº‹åŠ¡è¯­ä¹‰.&lt;/p>
&lt;h3 id="3-å¯åŠ¨äº‹åŠ¡--begintransaction-api">3. å¯åŠ¨äº‹åŠ¡ â€” beginTransaction() API&lt;/h3>
&lt;p>æ–°çš„&lt;code>KafkaProducer&lt;/code>æœ‰ä¸€ä¸ªbeginTransaction()æ–¹æ³•ç”¨æ¥å‘å‡ºå¼€å§‹äº‹åŠ¡çš„ä¿¡å·. ç”Ÿäº§è€…è®°å½•æŒ‡ç¤ºäº¤æ˜“å·²ç»å¼€å§‹çš„æœ¬åœ°çŠ¶æ€, ä½†æ˜¯åœ¨å‘é€ç¬¬ä¸€æ¡è®°å½•ä¹‹å‰, åœ¨åè°ƒå™¨çœ‹æ¥äº‹åŠ¡è¿˜æ²¡æœ‰å¼€å§‹.&lt;/p>
&lt;h3 id="4-æ¶ˆè´¹-è½¬æ¢-ç”Ÿäº§å¾ªç¯">4. æ¶ˆè´¹-è½¬æ¢-ç”Ÿäº§å¾ªç¯&lt;/h3>
&lt;p>åœ¨è¿™ä¸ªé˜¶æ®µ, producerå¼€å§‹æ‰§è¡Œç»„æˆäº‹åŠ¡æ¶ˆè´¹-è½¬æ¢-ç”Ÿäº§æ¶ˆæ¯çš„æµç¨‹. è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„é˜¶æ®µ, å¯èƒ½åŒ…å«å¤šä¸ªè¯·æ±‚&lt;/p>
&lt;h4 id="41-addpartitionstotxnrequest">4.1 AddPartitionsToTxnRequest&lt;/h4>
&lt;p>ä½œä¸ºäº‹åŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œç”Ÿäº§è€…é¦–æ¬¡å°†æ–°çš„TopicPartitionä½œä¸ºäº‹åŠ¡çš„ä¸€éƒ¨åˆ†å‘é€ç»™äº‹åŠ¡åè°ƒå™¨ã€‚ åè°ƒå™¨åœ¨æ­¥éª¤4.1aä¸­è®°å½•äº†å°†æ­¤TopicPartitionæ·»åŠ åˆ°äº‹åŠ¡ä¸­ã€‚ æˆ‘ä»¬éœ€è¦è¿™äº›ä¿¡æ¯ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å°†æäº¤æˆ–ä¸­æ­¢æ ‡è®°å†™å…¥æ¯ä¸ªTopicPartitionï¼ˆæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…ç¬¬5.2èŠ‚ï¼‰ã€‚ å¦‚æœè¿™æ˜¯æ·»åŠ åˆ°äº‹åŠ¡çš„ç¬¬ä¸€ä¸ªåˆ†åŒºï¼Œåè°ƒå™¨ä¹Ÿå°†å¯åŠ¨äº‹åŠ¡è®¡æ—¶å™¨ã€‚&lt;/p>
&lt;h4 id="42-producerequest">4.2 ProduceRequest&lt;/h4>
&lt;p>ç”Ÿäº§è€…é€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ªProduceRequestsï¼ˆä»ç”Ÿäº§è€…çš„å‘é€æ–¹æ³•è§¦å‘ï¼‰å‘ç”¨æˆ·çš„ä¸»é¢˜åˆ†åŒºå†™å…¥ä¸€å †æ¶ˆæ¯ã€‚ è¿™äº›è¯·æ±‚åŒ…æ‹¬å¦‚4.2aæ‰€ç¤ºçš„PIDï¼Œä»£å’Œåºå·ã€‚&lt;/p>
&lt;h4 id="43-addoffsetcommitstotxnrequest">4.3 AddOffsetCommitsToTxnRequest&lt;/h4>
&lt;p>ç”Ÿäº§è€…æœ‰ä¸€ä¸ªæ–°çš„KafkaProducer.sendOffsetsToTransaction APIæ–¹æ³•ï¼Œå®ƒå¯ä»¥æ‰¹é‡æ¶ˆè´¹å’Œç”Ÿæˆçš„æ¶ˆæ¯ã€‚ æ­¤æ–¹æ³•æ¥å—Map &amp;lt;TopicPartitionsï¼ŒOffsetAndMetadata&amp;gt;å’ŒgroupIdå‚æ•°ã€‚&lt;/p>
&lt;p>sendOffsetsToTransactionæ–¹æ³•å‘äº‹åŠ¡åè°ƒå™¨å‘é€ä¸€ä¸ªå¸¦æœ‰groupIdçš„AddOffsetCommitsToTxnRequestsï¼Œä»è€Œå¯ä»¥åœ¨å†…éƒ¨__consumer-offsetsä¸»é¢˜ä¸­æ¨å¯¼å‡ºè¯¥æ¶ˆè´¹è€…ç»„çš„TopicPartitionã€‚ äº‹åŠ¡åè°ƒå™¨å°†åœ¨æ­¥éª¤4.3aä¸­å°†è¯¥ä¸»é¢˜åˆ†åŒºæ·»åŠ åˆ°äº‹åŠ¡æ—¥å¿—ä¸­ã€‚&lt;/p>
&lt;h4 id="44-txnoffsetcommitrequest">4.4 TxnOffsetCommitRequest&lt;/h4>
&lt;p>å¦å¤–ä½œä¸ºsendOffsetçš„ä¸€éƒ¨åˆ†ï¼Œç”Ÿäº§è€…å°†å‘æ¶ˆè´¹è€…åè°ƒå™¨å‘é€ä¸€ä¸ªTxnOffsetCommitRequestï¼Œä»¥åœ¨__consumer-offsetsä¸»é¢˜ä¸­ä¿ç•™åç§»é‡ï¼ˆæ­¥éª¤4.4aï¼‰ã€‚ æ¶ˆè´¹è€…åè°ƒå‘˜é€šè¿‡ä½¿ç”¨ä½œä¸ºè¯¥è¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€çš„PIDå’Œç”Ÿäº§è€…ä»£æ¥éªŒè¯ç”Ÿäº§è€…æ˜¯å¦å…è®¸å‘å‡ºè¯·æ±‚ï¼ˆè€Œä¸æ˜¯åƒµå°¸ï¼‰ã€‚&lt;/p>
&lt;p>æ¶ˆè´¹çš„offsetsåœ¨äº‹åŠ¡æäº¤ä¹‹å‰ä¸å¯è§ï¼Œè¿™æ˜¯æˆ‘ä»¬ç°åœ¨å°†è®¨è®ºçš„è¿‡ç¨‹ã€‚&lt;/p>
&lt;h3 id="5-æäº¤æˆ–è€…ç»ˆç»“äº‹åŠ¡">5. æäº¤æˆ–è€…ç»ˆç»“äº‹åŠ¡&lt;/h3>
&lt;p>ä¸€æ—¦å†™å…¥æ•°æ®ï¼Œç”¨æˆ·å¿…é¡»è°ƒç”¨KafkaProducerçš„æ–°çš„commitTransactionæˆ–abortTransaction APIæ–¹æ³•ã€‚ è¿™äº›æ–¹æ³•å°†åˆ†åˆ«å¼€å§‹æäº¤æˆ–ä¸­æ­¢äº‹åŠ¡ã€‚&lt;/p>
&lt;h4 id="51-endtxnrquest">5.1 EndTxnRquest&lt;/h4>
&lt;p>å½“ç”Ÿäº§è€…å®Œæˆäº‹åŠ¡æ—¶ï¼Œå¿…é¡»è°ƒç”¨æ–°å¼•å…¥çš„KafkaProducer.endTransactionæˆ–KafkaProducer.abortTransaction APIæ–¹æ³•ã€‚ å‰è€…ä½¿å¾—&lt;code>æ­¥éª¤4&lt;/code>ä¸­ç”Ÿäº§çš„æ•°æ®å¯ç”¨äºä¸‹æ¸¸æ¶ˆè´¹è€…ã€‚ åè€…æœ‰æ•ˆåœ°ä»æ—¥å¿—ä¸­æ“¦é™¤ç”Ÿæˆçš„æ•°æ®: ç”¨æˆ·æ°¸è¿œä¸å¯è®¿é—®ã€‚ ä¸‹æ¸¸æ¶ˆè´¹è€…å°†è¯»å–å¹¶ä¸¢å¼ƒå·²ä¸­æ­¢çš„æ¶ˆæ¯ã€‚&lt;/p>
&lt;p>æ— è®ºè°ƒç”¨å“ªä¸ªç”Ÿäº§è€…æ–¹æ³•ï¼Œç”Ÿäº§è€…å‘äº‹åŠ¡åè°ƒå™¨å‘å‡ºä¸€ä¸ªEndTxnRequestè¯·æ±‚ï¼Œé™„åŠ æ•°æ®æŒ‡ç¤ºäº‹åŠ¡æ˜¯æäº¤è¿˜æ˜¯ä¸­æ­¢ã€‚ åœ¨æ”¶åˆ°æ­¤è¯·æ±‚åï¼Œåè°ƒå™¨ï¼š&lt;/p>
&lt;ol>
&lt;li>å°†PREPARE_COMMITæˆ–PREPARE_ABORTæ¶ˆæ¯å†™å…¥äº‹åŠ¡æ—¥å¿—ã€‚ (æ­¥éª¤5.1a)&lt;/li>
&lt;li>é€šè¿‡WriteTxnMarkerRequestå¼€å§‹å‘ç”¨æˆ·æ—¥å¿—å†™å…¥ç§°ä¸ºCOMMIT(æˆ–ABORT)æ ‡è®°çš„å‘½ä»¤æ¶ˆæ¯çš„è¿‡ç¨‹ã€‚ (è§ä¸‹æ–‡ç¬¬5.2èŠ‚)ã€‚&lt;/li>
&lt;li>æœ€åå°†COMMITTEDï¼ˆæˆ–ABORTEDï¼‰æ¶ˆæ¯å†™å…¥äº‹åŠ¡æ—¥å¿—ã€‚ (è§ä¸‹æ–‡5.3)ã€‚&lt;/li>
&lt;/ol>
&lt;h4 id="52-writetxnmarkerrequest">5.2 WriteTxnMarkerRequest&lt;/h4>
&lt;p>è¯¥è¯·æ±‚ç”±äº‹åŠ¡åè°ƒå™¨å‘é€ç»™ä½œä¸ºäº‹åŠ¡ä¸€éƒ¨åˆ†çš„æ¯ä¸ªä¸»é¢˜åˆ†é…çš„leader. åœ¨æ”¶åˆ°æ­¤è¯·æ±‚å, æ¯ä¸ªä»£ç†å°†å‘æ—¥å¿—å†™å…¥COMMIT(PID)æˆ–ABORT(PID)æ§åˆ¶æ¶ˆæ¯ã€‚ (æ­¥éª¤5.2a)&lt;/p>
&lt;p>è¯¥æ¶ˆæ¯å‘æ¶ˆè´¹è€…æŒ‡ç¤ºå…·æœ‰ç»™å®šPIDçš„æ¶ˆæ¯æ˜¯å¦å¿…é¡»ä¼ é€’ç»™ç”¨æˆ·æˆ–ä¸¢å¼ƒã€‚ å› æ­¤ï¼Œæ¶ˆè´¹è€…å°†ç¼“å†²å…·æœ‰PIDçš„æ¶ˆæ¯ï¼Œç›´åˆ°å®ƒè¯»å–ç›¸åº”çš„COMMITæˆ–ABORTæ¶ˆæ¯ï¼Œæ­¤æ—¶å®ƒå°†åˆ†åˆ«é€’é€æˆ–ä¸¢å¼ƒæ¶ˆæ¯ã€‚&lt;/p>
&lt;p>è¯·æ³¨æ„ï¼Œå¦‚æœ__consumer-offsetsä¸»é¢˜æ˜¯äº‹åŠ¡ä¸­çš„TopicPartitionä¹‹ä¸€ï¼Œåˆ™æäº¤ï¼ˆæˆ–ä¸­æ­¢ï¼‰æ ‡è®°ä¹Ÿå°†å†™å…¥æ—¥å¿—ï¼Œå¹¶ä¸”é€šçŸ¥æ¶ˆè´¹è€…åè°ƒå™¨ï¼Œä»¥ä¾¿åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å®ç°è¿™äº›åç§»é‡ åœ¨ä¸­æ­¢æƒ…å†µä¸‹æäº¤æˆ–å¿½ç•¥å®ƒä»¬ï¼ˆå·¦ä¾§çš„æ­¥éª¤5.2aï¼‰ã€‚&lt;/p>
&lt;h4 id="53-writing-the-final-commit-or-abort-message">5.3 Writing the final Commit or Abort Message&lt;/h4>
&lt;p>åœ¨æ‰€æœ‰æäº¤æˆ–ä¸­æ­¢æ ‡è®°å†™å…¥æ•°æ®æ—¥å¿—ä¹‹åï¼Œäº‹åŠ¡åè°ƒå™¨å°†æœ€åçš„COMMITTEDæˆ–ABORTEDæ¶ˆæ¯å†™å…¥äº‹åŠ¡æ—¥å¿—ï¼ŒæŒ‡ç¤ºäº‹åŠ¡å®Œæˆï¼ˆå›¾ä¸­çš„æ­¥éª¤5.3ï¼‰ã€‚ æ­¤æ—¶ï¼Œå¯ä»¥åˆ é™¤ä¸äº‹åŠ¡æ—¥å¿—ä¸­çš„äº‹åŠ¡æœ‰å…³çš„å¤§å¤šæ•°æ¶ˆæ¯ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬åªéœ€è¦ä¿ç•™å®Œæˆçš„äº‹åŠ¡çš„PIDä»¥åŠæ—¶é—´æˆ³ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆå¯ä»¥åˆ é™¤ç”Ÿäº§è€…çš„TransactionalId-&amp;gt; PIDæ˜ å°„ã€‚ è¯·å‚é˜…ä¸‹é¢çš„è¿‡æœŸPIDéƒ¨åˆ†ã€‚&lt;/p>
&lt;h2 id="ç®€å•çš„å®ç°ä»£ç ">ç®€å•çš„å®ç°ä»£ç &lt;/h2>
&lt;p>&lt;a href="http://atbug.com/kafka-exactly-once-delivery-and-transactional-messaging-example/">è¿™é‡Œ&lt;/a>&lt;/p>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-98+-+Exactly+Once+Delivery+and+Transactional+Messaging">Exactly Once Delivery and Transactional Messaging&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Kafka Produceré…ç½®è§£è¯»</title><link>https://atbug.com/kafka-producer-config/</link><pubDate>Tue, 19 Sep 2017 15:38:03 +0000</pubDate><guid>https://atbug.com/kafka-producer-config/</guid><description>
&lt;p>æŒ‰ç…§é‡è¦æ€§åˆ†ç±», åŸºäºç‰ˆæœ¬0.11.0.0&lt;/p>
&lt;h2 id="é«˜">é«˜&lt;/h2>
&lt;h3 id="bootstrapservers">bootstrap.servers&lt;/h3>
&lt;p>ä¸€ç»„hostå’Œportç”¨äºåˆå§‹åŒ–è¿æ¥. ä¸ç®¡è¿™é‡Œé…ç½®äº†å¤šå°‘å°server, éƒ½åªæ˜¯ç”¨ä½œå‘ç°æ•´ä¸ªé›†ç¾¤å…¨éƒ¨serverä¿¡æ¯. è¿™ä¸ªé…ç½®ä¸éœ€è¦åŒ…å«é›†ç¾¤æ‰€æœ‰çš„æœºå™¨ä¿¡æ¯. ä½†æ˜¯æœ€å¥½å¤šäºä¸€ä¸ª, ä»¥é˜²æœåŠ¡å™¨æŒ‚æ‰.&lt;/p>
&lt;h3 id="keyserializer">key.serializer&lt;/h3>
&lt;p>ç”¨æ¥åºåˆ—åŒ–keyçš„&lt;code>Serializer&lt;/code>æ¥å£çš„å®ç°ç±».&lt;/p>
&lt;h3 id="valueserializer">value.serializer&lt;/h3>
&lt;p>ç”¨æ¥åºåˆ—åŒ–valueçš„&lt;code>Serializer&lt;/code>æ¥å£çš„å®ç°ç±»&lt;/p>
&lt;h3 id="acks">acks&lt;/h3>
&lt;p>producerå¸Œæœ›leaderè¿”å›çš„ç”¨äºç¡®è®¤è¯·æ±‚å®Œæˆçš„ç¡®è®¤æ•°é‡. å¯é€‰å€¼ all, -1, 0 1. é»˜è®¤å€¼ä¸º1&lt;/p>
&lt;ul>
&lt;li>&lt;code>acks=0&lt;/code> ä¸éœ€è¦ç­‰å¾…æœåŠ¡å™¨çš„ç¡®è®¤. è¿™æ˜¯&lt;code>retries&lt;/code>è®¾ç½®æ— æ•ˆ. å“åº”é‡Œæ¥è‡ªæœåŠ¡ç«¯çš„offsetæ€»æ˜¯-1. produceråªç®¡å‘ä¸ç®¡å‘é€æˆåŠŸä¸å¦ã€‚å»¶è¿Ÿä½ï¼Œå®¹æ˜“ä¸¢å¤±æ•°æ®ã€‚&lt;/li>
&lt;li>&lt;code>acks=1&lt;/code> è¡¨ç¤ºleaderå†™å…¥æˆåŠŸï¼ˆä½†æ˜¯å¹¶æ²¡æœ‰åˆ·æ–°åˆ°ç£ç›˜ï¼‰åå³å‘producerå“åº”ã€‚å»¶è¿Ÿä¸­ç­‰ï¼Œä¸€æ—¦leaderå‰¯æœ¬æŒ‚äº†ï¼Œå°±ä¼šä¸¢å¤±æ•°æ®ã€‚&lt;/li>
&lt;li>&lt;code>acks=all&lt;/code>ç­‰å¾…æ•°æ®å®Œæˆå‰¯æœ¬çš„å¤åˆ¶, ç­‰åŒäº&lt;code>-1&lt;/code>. å‡å¦‚éœ€è¦ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±, éœ€è¦ä½¿ç”¨è¯¥è®¾ç½®. åŒæ—¶éœ€è¦è®¾ç½®&lt;code>unclean.leader.election.enable&lt;/code>ä¸ºtrue, ä¿è¯å½“ISRåˆ—è¡¨ä¸ºç©ºæ—¶, é€‰æ‹©å…¶ä»–å­˜æ´»çš„å‰¯æœ¬ä½œä¸ºæ–°çš„leader.&lt;/li>
&lt;/ul>
&lt;h3 id="buffermemory">buffer.memory&lt;/h3>
&lt;p>producerå¯ä»¥ä½¿ç”¨çš„æœ€å¤§å†…å­˜æ¥ç¼“å­˜ç­‰å¾…å‘é€åˆ°serverç«¯çš„æ¶ˆæ¯. å¦‚æœæ¶ˆæ¯é€Ÿåº¦å¤§äºproduceräº¤ä»˜åˆ°serverç«¯çš„é˜»å¡æ—¶é—´&lt;code>max.block.ms&lt;/code>, å°†ä¼šæŠ›å‡ºå¼‚å¸¸. é»˜è®¤å€¼33554432 byte (32m). è¿™ä¸ªè®¾ç½®ä¸æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„è¾¹ç•Œ, å› ä¸ºproduceré™¤äº†ç”¨æ¥ç¼“å­˜æ¶ˆæ¯, è¿˜è¦ç”¨æ¥è¿›è¡Œå‹ç¼©.&lt;/p>
&lt;h3 id="compressiontype">compression.type&lt;/h3>
&lt;p>producerå‹ç¼©æ•°æ®çš„ç±»å‹, é»˜è®¤ä¸ºnone, å°±æ˜¯ä¸å‹ç¼©. å¯é€‰&lt;code>none&lt;/code>, &lt;code>gzip&lt;/code>, &lt;code>snappy&lt;/code> å’Œ&lt;code>lz4&lt;/code>. å‹ç¼©æ•´ä¸ªbatchçš„æ•°æ®, å› æ­¤batchçš„æ•ˆæœå¯¹å‹ç¼©ç‡ä¹Ÿæœ‰å½±å“. æ›´å¤šçš„æ‰¹å¤„ç†æ„å‘³ç€æ›´å¥½çš„å‹ç¼©&lt;/p>
&lt;h3 id="retries">retries&lt;/h3>
&lt;p>è®¾ç½®å¤§äºé›¶çš„å€¼å°†å¯¼è‡´å®¢æˆ·ç«¯é‡æ–°å‘é€å…¶å‘é€å¤±è´¥å¹¶å‘ç”Ÿæ½œåœ¨çš„ç¬æ—¶é”™è¯¯çš„è®°å½•. ç›¸å½“äºclientåœ¨å‘é€å¤±è´¥çš„æ—¶å€™ä¼šé‡æ–°å‘è¡Œ. å¦‚æœè®¾ç½®äº†&lt;code>retries&lt;/code>è€Œæ²¡æœ‰å°†&lt;code>max.in.flight.request.per.connection&lt;/code>è®¾ç½®ä¸º1, åœ¨ä¸¤ä¸ªbatchå‘é€åˆ°åŒä¸€ä¸ªpartitionæ—¶æœ‰å¯èƒ½æ‰“ä¹±æ¶ˆæ¯çš„å‘é€é¡ºåº(ç¬¬ä¸€ä¸ªå‘é€å¤±è´¥, è€Œç¬¬äºŒä¸ªå‘é€æˆåŠŸ)&lt;/p>
&lt;h2 id="ä¸­">ä¸­&lt;/h2>
&lt;h3 id="batchsize">batch.size&lt;/h3>
&lt;p>producerä¼šå°è¯•æ‰¹é‡å‘é€å±äºåŒä¸€ä¸ªpartitionçš„æ¶ˆæ¯ä»¥å‡å°‘è¯·æ±‚çš„æ•°é‡. è¿™æ ·å¯ä»¥æå‡å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æ€§èƒ½. é»˜è®¤å¤§å°æ˜¯16348 byte (16k).&lt;/p>
&lt;p>å‘é€åˆ°brokerçš„è¯·æ±‚å¯ä»¥åŒ…å«å¤šä¸ªbatch, æ¯ä¸ªbatchçš„æ•°æ®å±äºåŒä¸€ä¸ªpartition.&lt;/p>
&lt;p>å¤ªå°çš„batchä¼šé™ä½åå. å¤ªå¤§ä¼šæµªè´¹å†…å­˜.&lt;/p>
&lt;h3 id="clientid">client.id&lt;/h3>
&lt;p>å‘é€è¯·æ±‚æ—¶ä¼ é€’ç»™æœåŠ¡ç«¯çš„idå­—ç¬¦. ç”¨æ¥è¿½æº¯è¯·æ±‚æº, é™¤äº†ä½¿ç”¨ip/port. æœåŠ¡ç«¯çš„è¯·æ±‚æ—¥å¿—ä¸­ä¼šåŒ…å«ä¸€ä¸ªåˆç†çš„åº”ç”¨å. é»˜è®¤ä¸ºç©º&lt;/p>
&lt;h3 id="lingerms">linger.ms&lt;/h3>
&lt;p>åœ¨æ­£å¸¸è´Ÿè½½çš„æƒ…å†µä¸‹, è¦æƒ³å‡å°‘è¯·æ±‚çš„æ•°é‡. åŠ ä¸Šä¸€ä¸ªè®¤ä¸ºçš„å»¶è¿Ÿ: ä¸æ˜¯ç«‹å³å‘é€æ¶ˆæ¯, è€Œæ˜¯å»¶è¿Ÿç­‰å¾…æ›´å¤šçš„æ¶ˆæ¯ä¸€èµ·æ‰¹é‡å‘é€. ç±»ä¼¼TCPä¸­çš„Nagleç®—æ³•. å½“è·å¾—äº†&lt;code>batch.size&lt;/code>çš„åŒä¸€partitionçš„æ¶ˆæ¯ä¼šç«‹å³å‘é€, ä¸ç®¡&lt;code>linger.ms&lt;/code>çš„è®¾ç½®. å‡å¦‚è¦å‘é€çš„æ¶ˆæ¯æ¯”è¾ƒå°‘, ä¼šç­‰å¾…æŒ‡å®šçš„æ—¶é—´ä»¥è·å–æ›´å¤šçš„æ¶ˆæ¯.&lt;/p>
&lt;p>é»˜è®¤è®¾ç½®ä¸º0 ms(æ²¡æœ‰å»¶è¿Ÿ).&lt;/p>
&lt;h4 id="maxblockms">max.block.ms&lt;/h4>
&lt;p>æ§åˆ¶&lt;code>KafkaProducer.send()&lt;/code>å’Œ&lt;code>KafkaProducer.partitionsFor()&lt;/code>çš„é˜»å¡æ—¶é—´. è¿™äº›æ–¹æ³•ä¼šå› ä¸ºbufferæ»¡äº†æˆ–è€…metadataä¸å¯ç”¨è€Œé˜»å¡. ç”¨æˆ·è®¾ç½®åœ¨serializersæˆ–è€…partitionerä¸­çš„é˜»å¡ä¸ä¼šè®¡ç®—åœ¨å†….&lt;/p>
&lt;h4 id="maxrequestsize">max.request.size&lt;/h4>
&lt;p>è¯·æ±‚çš„æœ€å¤§å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ æ­¤è®¾ç½®å°†é™åˆ¶ç”Ÿäº§è€…åœ¨å•ä¸ªè¯·æ±‚ä¸­å‘é€çš„è®°å½•æ‰¹æ¬¡æ•°ï¼Œä»¥é¿å…å‘é€å·¨å¤§çš„è¯·æ±‚ã€‚ è¿™ä¹Ÿæ˜¯æœ€å¤§è®°å½•æ‰¹é‡å¤§å°çš„ä¸Šé™ã€‚ è¯·æ³¨æ„ï¼ŒæœåŠ¡å™¨æ‹¥æœ‰è‡ªå·±çš„è®°å½•æ‰¹é‡å¤§å°ï¼Œå¯èƒ½ä¸æ­¤ä¸åŒã€‚&lt;/p>
&lt;h4 id="partitionerclass">partitioner.class&lt;/h4>
&lt;p>&lt;code>Partitioner&lt;/code>æ¥å£çš„å®ç°ç±», é»˜è®¤æ˜¯&lt;code>org.apache.kafka.clients.producer.internals.DefaultPartitioner&lt;/code>. éœ€è¦å¤„ç†æ•°æ®å€¾æ–œç­‰åŸå› è°ƒæ•´åˆ†åŒºé€»è¾‘çš„æ—¶å€™ä½¿ç”¨.&lt;/p>
&lt;h4 id="requesttimeoutms">request.timeout.ms&lt;/h4>
&lt;p>é…ç½®æ§åˆ¶å®¢æˆ·ç«¯ç­‰å¾…è¯·æ±‚å“åº”çš„æœ€é•¿æ—¶é—´ã€‚ å¦‚æœåœ¨è¶…æ—¶ä¹‹å‰æœªæ”¶åˆ°å“åº”ï¼Œå®¢æˆ·ç«¯å°†åœ¨å¿…è¦æ—¶é‡æ–°å‘é€è¯·æ±‚ï¼Œå¦‚æœé‡è¯•è€—å°½ï¼Œåˆ™è¯¥è¯·æ±‚å°†å¤±è´¥ã€‚ è¿™åº”è¯¥å¤§äºreplica.lag.time.max.ms(brokeré…ç½®)ï¼Œä»¥å‡å°‘ç”±äºä¸å¿…è¦çš„ç”Ÿäº§è€…é‡è¯•å¼•èµ·çš„æ¶ˆæ¯é‡å¤çš„å¯èƒ½æ€§ã€‚&lt;/p>
&lt;h2 id="ä½">ä½&lt;/h2>
&lt;h4 id="enableidempotence">enable.idempotence&lt;/h4>
&lt;p>è®¾ç½®ä¸º&amp;rsquo;true', å°†å¼€å¯&lt;code>exactly-once&lt;/code>æ¨¡å¼. è®¾ç½®ä¸º&amp;rsquo;false'(é»˜è®¤å€¼), producerä¼šå› ä¸ºborkerå¤±è´¥ç­‰åŸå› é‡è¯•å‘é€, å¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤.&lt;/p>
&lt;p>è®¾ç½®ä¸º&amp;rsquo;true&amp;rsquo;æ—¶éœ€è¦ç»“åˆ&lt;code>max.in.flight.requests.per.connection&lt;/code>è®¾ä¸º'1&amp;rsquo;å’Œ&lt;code>retires&lt;/code>ä¸èƒ½ä¸º'0', åŒæ—¶&lt;code>acks&lt;/code>éœ€è¦è®¾ç½®ä¸º&amp;rsquo;all&amp;rsquo;æˆ–è€…''-1'.&lt;/p>
&lt;h4 id="interceptorclasses">interceptor.classes&lt;/h4>
&lt;p>ä¸€ç»„&lt;code>ProducerInterceptor&lt;/code>æ¥å£çš„å®ç°ç±», é»˜è®¤ä¸ºnull. å¯ä»¥é€šè¿‡è¯¥æ¥å£çš„å®ç°ç±»å»æ‹¦æˆª(å¯èƒ½éœ€è¦ä¿®æ”¹)producerè¦å‘é€çš„æ¶ˆæ¯åœ¨å‘é€åˆ°æœåŠ¡ç«¯ä¹‹å‰.&lt;/p>
&lt;h4 id="maxinflightrequestsperconnection">max.in.flight.requests.per.connection&lt;/h4>
&lt;p>æ²¡æœ‰è¢«ç¡®è®¤unacknowledgeçš„batchæ•°, å¦‚æœè®¾ç½®å¤§äº1åœ¨&lt;code>retries&lt;/code>è®¾ç½®äº†çš„æƒ…å†µä¸‹ä¼šå‡ºç°æ¶ˆæ¯å‘é€é¡ºåºé”™è¯¯.&lt;/p>
&lt;h4 id="retrybackoffms">retry.backoff.ms&lt;/h4>
&lt;p>å¤±è´¥è¯·æ±‚é‡è¯•çš„é—´éš”æ—¶é—´. é»˜è®¤æ˜¯100æ¯«ç§’&lt;/p>
&lt;h4 id="transactiontimeoutms">transaction.timeout.ms&lt;/h4>
&lt;p>äº‹åŠ¡åè°ƒå™¨ç­‰å¾…produceræ›´æ–°äº‹åŠ¡çŠ¶æ€çš„æœ€å¤§æ¯«ç§’æ•°, è¶…è¿‡çš„è¯äº‹åŠ¡åè°ƒå™¨ä¼šç»ˆæ­¢è¿›è¡Œä¸­çš„äº‹åŠ¡. å¦‚æœè®¾ç½®çš„æ—¶é—´å¤§äºbrokerçš„&lt;code>max.transaction.timeout.ms&lt;/code>ä¼šæ”¶åˆ°&lt;code>InvalidTransactionTimeout&lt;/code>é”™è¯¯.&lt;/p>
&lt;h4 id="transactionalid">transactional.id&lt;/h4>
&lt;p>ç”¨äºäº‹åŠ¡ä¼ é€’çš„TransactionalIdã€‚ è¿™ä½¿å¾—å¯ä»¥è·¨è¶Šå¤šä¸ªç”Ÿäº§è€…ä¼šè¯çš„å¯é æ€§è¯­ä¹‰ï¼Œå› ä¸ºå®ƒå…è®¸å®¢æˆ·ç«¯ä¿è¯åœ¨å¼€å§‹ä»»ä½•æ–°äº‹åŠ¡ä¹‹å‰ä½¿ç”¨ç›¸åŒçš„TransactionalIdçš„äº‹åŠ¡å·²ç»å®Œæˆã€‚ å¦‚æœæ²¡æœ‰æä¾›TransactionalIdï¼Œåˆ™ç”Ÿäº§è€…è¢«é™åˆ¶ä¸ºå¹‚ç­‰ä¼ é€’ã€‚ è¯·æ³¨æ„ï¼Œå¦‚æœé…ç½®äº†TransactionalIdï¼Œåˆ™å¿…é¡»å¯ç”¨enable.idempotenceã€‚ é»˜è®¤å€¼ä¸ºç©ºï¼Œè¿™æ„å‘³ç€æ— æ³•ä½¿ç”¨äº‹åŠ¡ã€‚&lt;/p></description></item><item><title>JSON Patch</title><link>https://atbug.com/json-patch/</link><pubDate>Sun, 27 Aug 2017 14:41:44 +0000</pubDate><guid>https://atbug.com/json-patch/</guid><description>
&lt;p>JSON Pathæ˜¯åœ¨ä½¿ç”¨Kubernetes APIçš„è¿‡ç¨‹ä¸­é¦–æ¬¡ä½¿ç”¨çš„. ä½¿ç”¨APIåšæ‰©ç¼©å®¹çš„æ—¶å€™, å‘é€æ•´ä¸ªDeploymentçš„å…¨æ–‡ä¸æ˜¯ä¸ªæ˜æ™ºçš„åšæ³•, è™½ç„¶å¯è¡Œ. å› æ­¤ä¾¿ä½¿ç”¨äº†JSON Patch.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">JsonObject&lt;/span> &lt;span class="n">item&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">JsonObject&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">JsonPrimitive&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;replace&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">JsonPrimitive&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/spec/replicas&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;value&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">JsonPrimitive&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">instances&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">JsonArray&lt;/span> &lt;span class="n">body&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">JsonArray&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">body&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">appsV1beta1Api&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">patchNamespacedScaleScale&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">namespace&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">body&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>fabric8sæä¾›çš„kubernetes-clientä¸­ä½¿ç”¨çš„&lt;a href="https://github.com/flipkart-incubator/zjsonpatch">zjsonpatch&lt;/a>åˆ™å°è£…äº†JSON Patchæ“ä½œ. ä¾‹å¦‚åœ¨åšæ‰©ç¼©å®¹çš„æ—¶å€™æˆ–è€…å½“å‰çš„deployment, ä¿®æ”¹replicasçš„å€¼. ç„¶åæ¯”è¾ƒå¯¹è±¡çš„ä¸åŒ(JsonDiff.asJson(sourceJsonNode, targetJsonNode)).&lt;/p>
&lt;p>ä¸‹é¢çš„å†…å®¹éƒ¨åˆ†ç¿»è¯‘è‡ª&lt;a href="http://jsonpatch.com">JSON PATH&lt;/a>, æœ‰å…´è¶£çš„å¯ä»¥è·³è½¬çœ‹åŸæ–‡.&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯json-patch">ä»€ä¹ˆæ˜¯JSON Patch&lt;/h2>
&lt;p>JSON Pathæ˜¯ä¸€ç›´æè¿°JSONæ–‡æ¡£å˜åŒ–çš„æ ¼å¼. ä½¿ç”¨å®ƒå¯ä»¥é¿å…åœ¨åªéœ€è¦ä¿®æ”¹æŸä¸€éƒ¨åˆ†çš„æ—¶å€™å‘é€æ•´ä¸ªæ–‡æ¡£å†…å®¹. å½“ä¸HTTP PATCHæ–¹æ³•æ··åˆä½¿ç”¨çš„æ—¶å€™, å®ƒå…è®¸åœ¨æ ‡å‡†è§„èŒƒçš„åŸºç¡€ä¸Šä½¿ç”¨HTTP APIsè¿›è¡Œéƒ¨åˆ†æ›´æ–°.&lt;/p>
&lt;p>è¡¥ä¸(Patch)å†…å®¹çš„æ ¼å¼ä¹Ÿæ˜¯JSON.&lt;/p>
&lt;p>JSON Patchç”±IETFåœ¨&lt;a href="http://tools.ietf.org/html/rfc6902">RFC 6902&lt;/a>ä¸­è§„èŒƒ.&lt;/p>
&lt;h3 id="ç®€å•çš„ä¾‹å­">ç®€å•çš„ä¾‹å­&lt;/h3>
&lt;h4 id="åŸå§‹æ–‡æ¡£">åŸå§‹æ–‡æ¡£&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">
&lt;span class="s2">&amp;#34;baz&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="s2">&amp;#34;qux&amp;#34;&lt;/span>&lt;span class="err">,&lt;/span>
&lt;span class="s2">&amp;#34;foo&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="s2">&amp;#34;bar&amp;#34;&lt;/span>
&lt;span class="err">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="è¡¥ä¸">è¡¥ä¸&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">[&lt;/span>
&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;replace&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/baz&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;value&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;boo&amp;#34;&lt;/span> &lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;add&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/hello&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;value&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;world&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;remove&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/foo&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ç»“æœ">ç»“æœ&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;baz&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;boo&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;hello&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;world&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¦‚ä½•å®ç°">å¦‚ä½•å®ç°&lt;/h2>
&lt;p>ä¸€ä¸ªJSON Pathæ–‡æ¡£æ˜¯ä¸€ä¸ªåŒ…å«äº†ä¸€ç»„patchæ“ä½œçš„JSONæ–‡ä»¶. æ”¯æŒçš„patchæ“ä½œåŒ…æ‹¬&amp;quot;add&amp;quot;, &amp;ldquo;remove&amp;rdquo;, &amp;ldquo;replace&amp;rdquo;, &amp;ldquo;move&amp;rdquo;, &amp;ldquo;copy&amp;quot;å’Œ&amp;quot;test&amp;rdquo;. è¿™äº›patchæ“ä½œæ˜¯æŒ‰ç…§é¡ºåºåº”ç”¨çš„: å¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªæ“ä½œå¤±è´¥, æ•´ä¸ªpatchéƒ½ä¼šè¢«ç»ˆæ­¢.&lt;/p>
&lt;h4 id="json-pointeræŒ‡é’ˆ">JSON Pointer(æŒ‡é’ˆ)&lt;/h4>
&lt;p>JSONæŒ‡é’ˆ&lt;a href="http://tools.ietf.org/html/rfc6901">IETF RFC 6901&lt;/a>å®šä¹‰äº†ä¸€ä¸ªå¦‚ä½•åœ¨JSONæ–‡æ¡£ä¸­å®šä½æŒ‡å®šå€¼çš„å­—ç¬¦æ ¼å¼. ç”¨æ¥åœ¨æ‰€æœ‰çš„JSON Patchæ“ä½œä¸­æŒ‡å®šè¦ä¿®æ”¹çš„æ–‡æ¡£éƒ¨åˆ†.&lt;/p>
&lt;p>JSONæŒ‡é’ˆæ˜¯ä½¿ç”¨&lt;code>/&lt;/code>åˆ†éš”çš„tokenå­—ç¬¦ä¸², è¿™äº›tokenæŒ‡å®šäº†å¯¹è±¡çš„keyæˆ–è€…æ˜¯æ•°ç»„çš„ç´¢å¼•. ä¾‹å¦‚, ç»™å®šJSON&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;biscuits&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Digestive&amp;#34;&lt;/span> &lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Choco Leibniz&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>/biscuits&lt;/code>å°†æŒ‡å‘æ•°ç»„biscuits, åŒæ—¶&lt;code>/biscuits/1/name&lt;/code>æŒ‡å‘&lt;code>Choco Leibniz&lt;/code>.&lt;/p>
&lt;p>è¦æŒ‡å‘JSONæ–‡æ¡£çš„æ ¹è¦ä½¿ç”¨ä¸€ä¸ªç©ºçš„å­—ç¬¦ä¸²&lt;code>''&lt;/code>. æŒ‡é’ˆ&lt;code>/&lt;/code>å¹¶ä¸æ˜¯æŒ‡å‘æ ¹, è€Œæ˜¯æŒ‡å‘æ ¹ä¸Škeyä¸º&lt;code>&amp;quot;&amp;quot;&lt;/code>çš„ä½ç½®(åœ¨JSONä¸­æ˜¯éæ³•çš„).&lt;/p>
&lt;h3 id="æ“ä½œ">æ“ä½œ&lt;/h3>
&lt;h4 id="add">Add&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;add&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/biscuits/1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;value&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Ginger Nut&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨å¯¹è±¡ä¸Šå¢åŠ ä¸€ä¸ªå€¼, æˆ–è€…æ•°ç»„ä¸­æ’å…¥æ•°æ®. å¦‚æœæ˜¯æ•°ç»„, å€¼å°†è¢«æ’å…¥åˆ°ç»™å®šä½ç½®çš„å‰é¢. &lt;code>-&lt;/code>ç”¨æ¥è¡¨ç¤ºæ’å…¥åˆ°æ•°ç»„çš„å°¾éƒ¨.&lt;/p>
&lt;h4 id="remove">Remove&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;remove&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/biscuits&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ é™¤å¯¹è±¡æˆ–è€…æ•°ç»„ä¸­çš„å€¼.&lt;/p>
&lt;h4 id="replace">Replace&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;replace&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/biscuits/0/name&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;value&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Chocolate Digestive&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ›¿æ¢ä¸€ä¸ªå€¼. ç­‰åŒäºå…ˆåˆ é™¤å†å¢åŠ .&lt;/p>
&lt;h4 id="copy">Copy&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;copy&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;from&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/biscuits/0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/best_biscuit&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»ä¸€ä¸ªä½ç½®(from)å¤åˆ¶æ•°æ®åˆ°æŒ‡å®šçš„ä½ç½®(path)ä¸Š. &lt;code>from&lt;/code>å’Œ&lt;code>to&lt;/code>éƒ½æ˜¯JSONæŒ‡é’ˆ.&lt;/p>
&lt;h4 id="move">Move&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;move&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;from&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/biscuits&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/cookies&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»ä¸€ä¸ªä½ç½®(from)ç§»åŠ¨æ•°æ®åˆ°æŒ‡å®šçš„ä½ç½®(path)ä¸Š. &lt;code>from&lt;/code>å’Œ&lt;code>to&lt;/code>éƒ½æ˜¯JSONæŒ‡é’ˆ.&lt;/p>
&lt;h4 id="test">Test&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;op&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/best_biscuit/name&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;value&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Choco Leibniz&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥æŸä¸ªä½ç½®çš„å€¼æ˜¯å¦æ˜¯æŒ‡å®šçš„å€¼.å¦‚æœå¤±è´¥, æ•´ä¸ªPatchæ“ä½œå°±ä¼šç»ˆæ­¢.&lt;/p>
&lt;h3 id="åº“">åº“&lt;/h3>
&lt;h4 id="javascript">JavaScript&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="http://jsonpatchjs.com/">jsonpatch.js&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://bruth.github.com/jsonpatch-js/">jsonpatch-js&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/cujojs/jiff">jiff&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/Starcounter-Jack/Fast-JSON-Patch">Fast-JSON-Patch&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/JSON8/patch">JSON8 Patch&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/MarketsWorld/json-patch-utils">JSON Patch Utils&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="python">Python&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/stefankoegl/python-json-patch">python-json-patch&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="php">PHP&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/mikemccabe/json-patch-php">json-patch-php&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/raphaelstolt/php-jsonpatch">php-jsonpatch/php-jsonpatch&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/xp-forge/json-patch">xp-forge/json-patch&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/gamringer/JSONPatch">JSONPatch&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="ruby">Ruby&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/jasnell/json-tools">json_tools&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://rubygems.org/gems/json_patch">json_patch&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/tenderlove/hana">hana&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="perl">Perl&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/zigorou/perl-json-patch">perl-json-patch&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="c">C&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/DaveGamble/cJSON">cJSON&lt;/a> (JSON library in C, includes JSON Patch support in cJSON_Utils)&lt;/li>
&lt;/ul>
&lt;h4 id="java">Java&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/flipkart-incubator/zjsonpatch">zjsonpatch&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/fge/json-patch">json-patch&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="scala">Scala&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/gnieh/diffson">diffson&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="c-1">C++&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/nlohmann/json">JSON&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="c-2">C####&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/JornWildt/Ramone">Ramone&lt;/a> (a framework for consuming REST services, includes a JSON Patch implementation)&lt;/li>
&lt;li>&lt;a href="https://github.com/myquay/JsonPatch">JsonPatch&lt;/a> (Adds JSON Patch support to ASP.NET Web API)&lt;/li>
&lt;li>&lt;a href="https://starcounter.io/">Starcounter&lt;/a> (In-memory Application Engine, uses JSON Patch with OT for client-server sync)&lt;/li>
&lt;li>&lt;a href="https://github.com/DSaunders/Nancy.JsonPatch">Nancy.JsonPatch&lt;/a> (Adds JSON Patch support to NancyFX)&lt;/li>
&lt;/ul>
&lt;h4 id="go">Go&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/evanphx/json-patch">json-patch&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/mattbaird/jsonpatch">jsonpatch&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="haskell">Haskell&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/GallagherCommaJack/Haskell-JSON-Patch">Haskell-JSON-Patch&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="erlang">Erlang&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="https://github.com/marianoguerra/json-patch.erl">json-patch.erl&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="elm">Elm&lt;/h4>
&lt;ul>
&lt;li>&lt;a href="http://package.elm-lang.org/packages/norpan/elm-json-patch/latest">norpan/elm-json-patch&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="æµ‹è¯•å¥—ä»¶">æµ‹è¯•å¥—ä»¶&lt;/h2>
&lt;p>githubä¸Šç»´æŠ¤çš„ä¸€ç»„ä¸€è‡´æ€§æµ‹è¯• &lt;a href="https://github.com/json-patch/json-patch-tests">github.com/json-patch/json-patch-tests&lt;/a>&lt;/p></description></item><item><title>å¦‚ä½•åœ¨Openshiftä¸­ä½¿ç”¨hostPath</title><link>https://atbug.com/how-to-use-hostpath-in-openshift/</link><pubDate>Wed, 23 Aug 2017 19:29:51 +0000</pubDate><guid>https://atbug.com/how-to-use-hostpath-in-openshift/</guid><description>
&lt;p>ä½¿ç”¨openshiftæ­å»ºçš„k8sçš„apiåˆ›å»ºDeploymentï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™æŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Invalid value: &amp;ldquo;hostPath&amp;rdquo;: hostPath volumes are not allowed to be used]&lt;/p>
&lt;/blockquote>
&lt;p>è§£å†³æ–¹æ¡ˆï¼š&lt;/p>
&lt;p>ä¸€ä¸ªæ–¹æ¡ˆæ˜¯å°†useråŠ å…¥&lt;code>privileged&lt;/code> sccä¸­ï¼Œå¦ä¸€ä¸ªæ–¹æ¡ˆå°±æ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">oc edit scc restricted
#æ·»åŠ ä¸‹é¢è¿™è¡Œ
allowHostDirVolumePlugin: true
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Kubernetes â€” æŒä¹…å·</title><link>https://atbug.com/kubernetes-persistent-volumes/</link><pubDate>Sun, 20 Aug 2017 22:25:40 +0000</pubDate><guid>https://atbug.com/kubernetes-persistent-volumes/</guid><description>
&lt;h1 id="persistent-volume">Persistent Volume&lt;/h1>
&lt;p>è¯‘è‡ª&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Persistent Volumes&lt;/a>&lt;/p>
&lt;h2 id="ä»‹ç»">ä»‹ç»&lt;/h2>
&lt;p>ç®¡ç†å­˜å‚¨æ˜¯ç®¡ç†è®¡ç®—çš„ç‹¬ç‰¹é—®é¢˜ã€‚ PersistentVolumeå­ç³»ç»Ÿä¸ºç”¨æˆ·å’Œç®¡ç†å‘˜æä¾›äº†ä¸€ä¸ªAPIï¼Œå…¶ä¸­æä¾›äº†å¦‚ä½•ä»å¦‚ä½•ä½¿ç”¨å­˜å‚¨æä¾›å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä»‹ç»ä¸¤ç§æ–°çš„APIèµ„æºï¼šPersistentVolumeå’ŒPersistentVolumeClaimã€‚&lt;/p>
&lt;p>PersistentVolumeï¼ˆPVï¼‰æ˜¯ç”±ç®¡ç†å‘˜é…ç½®çš„é›†ç¾¤ä¸­çš„ä¸€æ®µå­˜å‚¨ã€‚å®ƒæ˜¯é›†ç¾¤ä¸­çš„ä¸€ç§èµ„æºå°±åƒä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªé›†ç¾¤çš„èµ„æºã€‚ PVæ˜¯ç±»ä¼¼Volumesçš„å·æ’ä»¶ï¼Œä½†æ˜¯å…·æœ‰ç‹¬ç«‹äºä½¿ç”¨PVçš„ä»»ä½•å•ä¸ªpodçš„ç”Ÿå‘½å‘¨æœŸã€‚è¯¥APIå¯¹è±¡æ•è·å­˜å‚¨çš„å®ç°ç»†èŠ‚ï¼Œå³NFSï¼ŒiSCSIæˆ–äº‘æä¾›å•†ç‰¹å®šçš„å­˜å‚¨ç³»ç»Ÿã€‚&lt;/p>
&lt;p>PersistentVolumeClaimï¼ˆPVCï¼‰æ˜¯ç”¨æˆ·å­˜å‚¨çš„è¯·æ±‚ã€‚å®ƒç±»ä¼¼äºpodã€‚ Podæ¶ˆè€—èŠ‚ç‚¹èµ„æºï¼ŒPVCæ¶ˆè€—PVèµ„æºã€‚Podså¯ä»¥è¯·æ±‚ç‰¹å®šçº§åˆ«çš„èµ„æºï¼ˆCPUå’Œå†…å­˜ï¼‰ã€‚å£°æ˜å¯ä»¥è¯·æ±‚ç‰¹å®šçš„å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼ˆä¾‹å¦‚ï¼Œä¸€æ¬¡è¯»å†™æˆ–è€…å¤šæ¬¡åªè¯»ï¼‰ã€‚&lt;/p>
&lt;p>è™½ç„¶PersistentVolumeClaimså…è®¸ç”¨æˆ·ä½¿ç”¨æŠ½è±¡å­˜å‚¨èµ„æºï¼Œä½†æ˜¯å¸¸è§çš„æ˜¯ï¼Œç”¨æˆ·éœ€è¦å…·æœ‰ä¸åŒå±æ€§ï¼ˆå¦‚æ€§èƒ½ï¼‰çš„PersistentVolumesï¼Œç”¨äºä¸åŒçš„é—®é¢˜ã€‚ é›†ç¾¤ç®¡ç†å‘˜éœ€è¦èƒ½å¤Ÿæä¾›å¤šç§å½¼æ­¤ä¸åŒçš„PersistentVolumesï¼Œè€Œä¸ä»…ä»…æ˜¯å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼Œè€Œä¸ä¼šä½¿ç”¨æˆ·äº†è§£è¿™äº›å·çš„å®ç°ç»†èŠ‚ã€‚ å¯¹äºè¿™äº›éœ€æ±‚ï¼Œæœ‰ä¸€ä¸ªStorageClassèµ„æºã€‚&lt;/p>
&lt;p>StorageClassä¸ºç®¡ç†å‘˜æä¾›äº†ä¸€ç§æè¿°ä»–ä»¬æä¾›çš„å­˜å‚¨çš„â€œç±»â€çš„æ–¹æ³•ã€‚ ä¸åŒçš„ç±»å¯èƒ½æ˜ å°„åˆ°æœåŠ¡è´¨é‡çº§åˆ«ï¼Œæˆ–å¤‡ä»½ç­–ç•¥ï¼Œæˆ–è€…ç”±ç¾¤é›†ç®¡ç†å‘˜ç¡®å®šçš„ä»»æ„ç­–ç•¥ã€‚ Kubernetesæœ¬èº«å¯¹äºä»€ä¹ˆç±»åˆ«ä»£è¡¨æ˜¯ä¸è¨€è€Œå–»çš„ã€‚ è¿™ä¸ªæ¦‚å¿µæœ‰æ—¶åœ¨å…¶ä»–å­˜å‚¨ç³»ç»Ÿä¸­ç§°ä¸ºâ€œé…ç½®æ–‡ä»¶â€ã€‚&lt;/p>
&lt;p>è¯·å‚é˜…&lt;a href="https://kubernetes.io/docs/user-guide/persistent-volumes/walkthrough/">è¯¦ç»†æ¼”ç»ƒä¸å·¥ä½œç¤ºä¾‹&lt;/a>ã€‚&lt;/p>
&lt;h2 id="å­˜å‚¨å’Œå£°æ˜çš„ç”Ÿå‘½å‘¨æœŸ">å­˜å‚¨å’Œå£°æ˜çš„ç”Ÿå‘½å‘¨æœŸ&lt;/h2>
&lt;p>PVsæ˜¯é›†ç¾¤ä¸­çš„èµ„æºï¼›PVCsæ˜¯å¯¹è¿™ç§èµ„æºçš„å£°æ˜ï¼ŒåŒæ—¶ä¹Ÿæ‰®æ¼”è€…å¯¹èµ„æºå£°æ˜çš„æ£€æŸ¥ã€‚PVså’ŒPVCsä¹‹å‰çš„äº¤äº’éµå¾ªç”Ÿå‘½å‘¨æœŸï¼šä¾›åº”ã€ç»‘å®šã€ä½¿ç”¨ä¸­ã€é‡æ–°ç”³è¯·ã€‚&lt;/p>
&lt;p>é›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºå¤šä¸ªPVã€‚å®ƒä»¬æºå¸¦å¯ä¾›é›†ç¾¤ç”¨æˆ·ä½¿ç”¨çš„çœŸå®å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚å®ƒä»¬å­˜åœ¨äºKubernetes APIä¸­ï¼Œå¯ç”¨äºæ¶ˆè´¹ã€‚&lt;/p>
&lt;h3 id="ä¾›åº”provisioning">ä¾›åº”(Provisioning)&lt;/h3>
&lt;p>PVsä¼šä»¥ä¸¤ç§æ–¹å¼ä¾›åº”ï¼šé™æ€å’ŒåŠ¨æ€ã€‚&lt;/p>
&lt;h4 id="é™æ€">é™æ€&lt;/h4>
&lt;p>é›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºå¤šä¸ªPVã€‚ å®ƒä»¬æºå¸¦å¯ä¾›é›†ç¾¤ç”¨æˆ·ä½¿ç”¨çš„çœŸå®å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚ å®ƒä»¬å­˜åœ¨äºKubernetes APIä¸­ï¼Œå¯è¢«ä½¿ç”¨ã€‚&lt;/p>
&lt;h4 id="åŠ¨æ€">åŠ¨æ€&lt;/h4>
&lt;p>å½“ç®¡ç†å‘˜åˆ›å»ºçš„é™æ€PVéƒ½ä¸åŒ¹é…ç”¨æˆ·çš„PersistentVolumeClaimæ—¶ï¼Œé›†ç¾¤å¯èƒ½ä¼šå°è¯•ä¸ºPVCæŒ‡å®šåŠ¨æ€é…ç½®å·ã€‚ æ­¤é…ç½®åŸºäºStorageClassesï¼šPVCå¿…é¡»æŒ‡å®šä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ç®¡ç†å‘˜å¿…é¡»å·²åˆ›å»ºå¹¶é…ç½®è¯¥ç±»æ‰èƒ½è¿›è¡ŒåŠ¨æ€é…ç½®ã€‚ è¦æ±‚è¯¥ç±»çš„å£°æ˜æœ‰æ•ˆåœ°ä¸ºè‡ªå·±ç¦ç”¨åŠ¨æ€é…ç½®ã€‚&lt;/p>
&lt;h3 id="ç»‘å®šbinding">ç»‘å®š(Binding)&lt;/h3>
&lt;p>å½“ç”¨æˆ·åˆ›å»ºã€æˆ–å·²ç»åˆ›å»ºäº†ä¸€ä¸ªPersistenVolumenClaimå¹¶æŒ‡å®šå¤§å°å’Œè®¿é—®ç±»å‹ã€‚Masterä¸­çš„æ§åˆ¶å¾ªç¯ä¼šæ£€æµ‹æ–°çš„PVCï¼Œæ‰¾åˆ°ä¸€ä¸ªåŒ¹é…çš„PVï¼ˆå¦‚æœå¯èƒ½çš„è¯ï¼‰ï¼Œå¹¶å°†å®ƒä»¬ç»‘å®šåœ¨ä¸€èµ·ã€‚å¦‚æœä¸€ä¸ªPVè¢«åŠ¨æ€åœ°ä¾›åº”æŸä¸ªPVCï¼Œå¾ªç¯å°†æ€»æ˜¯æŠŠè¿™ä¸ªPVå’Œè¯¥PVCç»‘å®šã€‚å¦åˆ™ï¼Œç”¨æˆ·æ€»æ˜¯è‡³å°‘å¾—åˆ°ä»–ä»¬è¦æ±‚çš„å†…å®¹ï¼Œä½†æ˜¯å·å¯èƒ½è¶…å‡ºäº†è¦æ±‚ã€‚ä¸€æ—¦ç»‘å®šï¼ŒPersistentVolumeClaimç»‘å®šæ˜¯æ’ä»–çš„ï¼Œä¸ç®¡ç”¨äºç»‘å®šå®ƒä»¬çš„æ¨¡å¼ã€‚&lt;/p>
&lt;p>å¦‚æœåŒ¹é…çš„å·ä¸å­˜åœ¨ï¼Œè¯·æ±‚å°†æ— é™æœŸåœ°ä¿æŒã€‚ éšç€åŒ¹é…å·å˜å¾—å¯ç”¨ï¼Œè¯·æ±‚å°†è¢«ç»‘å®šã€‚ ä¾‹å¦‚ï¼Œæä¾›è®¸å¤š50Gi PVçš„é›†ç¾¤å°†ä¸åŒ¹é…è¦æ±‚100Giçš„PVCã€‚ å½“é›†ç¾¤ä¸­æ·»åŠ 100Gi PVæ—¶ï¼Œå¯ä»¥ç»‘å®šPVCã€‚&lt;/p>
&lt;h3 id="ä½¿ç”¨ä½¿ç”¨">ä½¿ç”¨(ä½¿ç”¨)&lt;/h3>
&lt;p>PODsæŠŠPVCå½“åšvolumeä½¿ç”¨ã€‚é›†ç¾¤æ£€æŸ¥å£°æ˜ä»¥æ‰¾åˆ°ç»‘å®šçš„å·å¹¶ä¸ºPODæŒ‚è½½è¯¥å·ã€‚ å¯¹äºæ”¯æŒå¤šç§è®¿é—®æ¨¡å¼çš„å·ï¼Œç”¨æˆ·åœ¨å°†å…¶å£°æ˜ç”¨ä½œpodä¸­çš„å·æ—¶æŒ‡å®šæ‰€éœ€çš„æ¨¡å¼ã€‚&lt;/p>
&lt;p>ä¸€æ—¦ç”¨æˆ·æœ‰å£°æ˜å¹¶ä¸”è¯¥å£°æ˜è¢«ç»‘å®šï¼Œç»‘å®šçš„PVå±äºç”¨æˆ·ï¼Œåªè¦ä»–ä»¬éœ€è¦å®ƒã€‚ ç”¨æˆ·é€šè¿‡åœ¨å…¶Podçš„å·å—ä¸­åŒ…å«persistentVolumeClaimæ¥å®‰æ’Podså¹¶è®¿é—®å…¶å£°æ˜çš„PVã€‚ è¯·å‚é˜…ä¸‹é¢çš„è¯­æ³•è¯¦ç»†ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myfrontend&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dockerfile/nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/var/www/html&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeClaim&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">claimName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myclaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å›æ”¶reclaiming">å›æ”¶(Reclaiming)&lt;/h3>
&lt;p>å½“ç”¨æˆ·ä½¿ç”¨å®Œvolumeï¼Œå¯ä»¥é€šè¿‡è¯·æ±‚å…è®¸å›æ”¶èµ„æºçš„APIæ¥åˆ é™¤è¯¥PVCå¯¹è±¡ã€‚PersistentVolumeçš„å›æ”¶ç­–ç•¥å‘Šè¯‰é›†ç¾¤å¦‚ä½•å¤„ç†å½“å£°æ˜é‡Šæ”¾PVåã€‚ç›®å‰ï¼Œå·å¯ä»¥è¢«ä¿ç•™ï¼Œå›æ”¶æˆ–åˆ é™¤ã€‚&lt;/p>
&lt;h4 id="ä¿ç•™retaining">ä¿ç•™(Retaining)&lt;/h4>
&lt;p>ä¿ç•™å›æ”¶ç­–ç•¥å…è®¸æ‰‹åŠ¨å›æ”¶èµ„æºã€‚ å½“PersistentVolumeClaimè¢«åˆ é™¤æ—¶ï¼ŒPersistentVolumeä»ç„¶å­˜åœ¨ï¼Œå¹¶ä¸”è¯¥å·è¢«è®¤ä¸ºæ˜¯â€œé‡Šæ”¾çš„â€ã€‚ ä½†æ˜¯ï¼Œç”±äºä¸Šä¸€ä¸ªå£°æ˜è€…çš„æ•°æ®ä»ä¿ç•™åœ¨å·ä¸Šï¼Œå› æ­¤å°šä¸å¯ç”¨äºå…¶ä»–å£°æ˜ã€‚ ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨å›æ”¶å·ã€‚&lt;/p>
&lt;ul>
&lt;li>åˆ é™¤PersistentVolumeã€‚ åˆ é™¤PVåï¼Œå¤–éƒ¨åŸºç¡€è®¾æ–½ï¼ˆå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–Cinderå·ï¼‰ä¸­çš„å…³è”å­˜å‚¨èµ„äº§ä»ç„¶å­˜åœ¨ã€‚&lt;/li>
&lt;li>ç›¸åº”åœ°æ‰‹åŠ¨æ¸…ç†ç›¸å…³å­˜å‚¨èµ„äº§ä¸Šçš„æ•°æ®ã€‚&lt;/li>
&lt;li>æ‰‹åŠ¨åˆ é™¤å…³è”çš„å­˜å‚¨èµ„äº§ï¼Œæˆ–è€…å¦‚æœè¦é‡ç”¨ç›¸åŒçš„å­˜å‚¨èµ„äº§ï¼Œè¯·ä½¿ç”¨å­˜å‚¨èµ„äº§å®šä¹‰åˆ›å»ºä¸€ä¸ªæ–°çš„PersistentVolumeã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="å›æ”¶recycling">å›æ”¶(Recycling)&lt;/h4>
&lt;p>å¦‚æœå—ç›¸åº”çš„å·æ’ä»¶æ”¯æŒï¼Œå›æ”¶å°†å¯¹å·æ‰§è¡ŒåŸºæœ¬çš„æ“¦é™¤ï¼ˆrm -rf / thevolume / *ï¼‰ï¼Œå¹¶ä½¿å…¶å†æ¬¡å¯ç”¨äºæ–°çš„å£°æ˜ã€‚
ä½†æ˜¯ï¼Œç®¡ç†å‘˜å¯ä»¥ä½¿ç”¨Kubernetesæ§åˆ¶å™¨ç®¡ç†å™¨å‘½ä»¤è¡Œå‚æ•°æ¥é…ç½®è‡ªå®šä¹‰çš„å›æ”¶å™¨podæ¨¡æ¿ï¼Œå¦‚&lt;a href="https://kubernetes.io/docs/admin/kube-controller-manager/">è¿™é‡Œ&lt;/a>æ‰€è¿°ã€‚ å®šåˆ¶å›æ”¶ç«™æ¨¡æ¿å¿…é¡»åŒ…å«å·è§„èŒƒï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pv-recycler-&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Never&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">vol&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/any/path/it/will/be/replaced&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pv-recycler&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;gcr.io/google_containers/busybox&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/bin/sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;-c&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;test -e /scrub &amp;amp;&amp;amp; rm -rf /scrub/..?* /scrub/.[!.]* /scrub/* &amp;amp;&amp;amp; test -z \&amp;#34;$(ls -A /scrub)\&amp;#34; || exit 1&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">vol&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/scrub&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯ï¼Œå·éƒ¨åˆ†ä¸­çš„è‡ªå®šä¹‰å›æ”¶å™¨podæ¨¡æ¿ä¸­æŒ‡å®šçš„ç‰¹å®šè·¯å¾„å°†æ›¿æ¢ä¸ºæ­£åœ¨å›æ”¶çš„å·çš„ç‰¹å®šè·¯å¾„ã€‚&lt;/p>
&lt;h4 id="åˆ é™¤deleting">åˆ é™¤(Deleting)&lt;/h4>
&lt;p>å¯¹äºæ”¯æŒâ€œåˆ é™¤å›æ”¶â€ç­–ç•¥çš„å·æ’ä»¶ï¼Œåˆ é™¤å°†ä»Kubernetesä¸­åˆ é™¤PersistentVolumeå¯¹è±¡ï¼Œå¹¶åˆ é™¤å¤–éƒ¨åŸºç¡€æ¶æ„ï¼ˆå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–Cinderå·ï¼‰ä¸­å…³è”çš„å­˜å‚¨èµ„äº§ã€‚ åŠ¨æ€é…ç½®çš„å·å§‹ç»ˆè¢«åˆ é™¤ã€‚ å¦‚æœä¸å¸Œæœ›è¿™æ ·åšï¼Œç›®å‰å”¯ä¸€çš„é€‰æ‹©æ˜¯åœ¨åˆ›å»ºPVä¹‹åç¼–è¾‘æˆ–ä¿®è¡¥PVã€‚ è¯·å‚é˜…&lt;a href="https://kubernetes.io/docs/tasks/administer-cluster/change-pv-reclaim-policy/">æ›´æ”¹PersistentVolumeçš„å›æ”¶ç­–ç•¥&lt;/a>ã€‚&lt;/p>
&lt;h3 id="persistent-volumeçš„ç±»å‹">Persistent Volumeçš„ç±»å‹&lt;/h3>
&lt;ul>
&lt;li>GCEPersistentDisk&lt;/li>
&lt;li>AWSElasticBlockStore&lt;/li>
&lt;li>AzureFile&lt;/li>
&lt;li>AzureDisk&lt;/li>
&lt;li>FC (Fibre Channel)&lt;/li>
&lt;li>FlexVolume&lt;/li>
&lt;li>Flocker&lt;/li>
&lt;li>NFS&lt;/li>
&lt;li>iSCSI&lt;/li>
&lt;li>RBD (Ceph Block Device)&lt;/li>
&lt;li>CephFS&lt;/li>
&lt;li>Cinder (OpenStack block storage)&lt;/li>
&lt;li>Glusterfs&lt;/li>
&lt;li>VsphereVolume&lt;/li>
&lt;li>Quobyte Volumes&lt;/li>
&lt;li>HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)&lt;/li>
&lt;li>VMware Photon&lt;/li>
&lt;li>Portworx Volumes&lt;/li>
&lt;li>ScaleIO Volumes&lt;/li>
&lt;li>StorageOS&lt;/li>
&lt;/ul>
&lt;h2 id="persistent-volumes">Persistent Volumes&lt;/h2>
&lt;p>æ¯ä¸ªPVéƒ½åŒ…å«è§„æ ¼å’ŒçŠ¶æ€ï¼Œè¿™æ˜¯è§„æ ¼å’ŒçŠ¶æ€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolume&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pv0003&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">capacity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">5Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeReclaimPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Recycle&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">slow&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">nfs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/tmp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">172.17.0.2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®¹é‡">å®¹é‡&lt;/h3>
&lt;p>é€šå¸¸ï¼ŒPVå°†å…·æœ‰ç‰¹å®šçš„å­˜å‚¨å®¹é‡ã€‚è¿™æ˜¯ä½¿ç”¨PVçš„&lt;code>capacity&lt;/code>å±æ€§è®¾ç½®çš„ã€‚çœ‹åˆ°Kubernetesçš„&lt;a href="https://git.k8s.io/community/contributors/design-proposals/resources.md">èµ„æºæ¨¡å‹&lt;/a>ï¼Œä»¥äº†è§£å®¹é‡ä½¿ç”¨çš„å•ä½ã€‚&lt;/p>
&lt;p>ç›®å‰ï¼Œå­˜å‚¨å¤§å°æ˜¯å”¯ä¸€å¯ä»¥è®¾ç½®æˆ–è¯·æ±‚çš„èµ„æºã€‚æœªæ¥çš„å±æ€§å¯èƒ½åŒ…æ‹¬IOPSï¼Œååé‡ç­‰ã€‚&lt;/p>
&lt;h3 id="è®¿é—®æ¨¡å¼">è®¿é—®æ¨¡å¼&lt;/h3>
&lt;p>PersistentVolumeå¯ä»¥ä»¥èµ„æºæä¾›è€…æ”¯æŒçš„ä»»ä½•æ–¹å¼å®‰è£…åœ¨ä¸»æœºä¸Šã€‚ å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œæä¾›è€…å°†å…·æœ‰ä¸åŒçš„ç‰¹æ€§ï¼Œæ¯ä¸ªPVçš„è®¿é—®æ¨¡å¼éƒ½è¢«è®¾ç½®ä¸ºè¯¥ç‰¹å®šå·æ”¯æŒçš„ç‰¹å®šæ¨¡å¼ã€‚ ä¾‹å¦‚ï¼ŒNFSå¯ä»¥æ”¯æŒå¤šä¸ªè¯»/å†™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯ç‰¹å®šçš„NFS PVå¯èƒ½ä¼šä»¥åªè¯»æ–¹å¼åœ¨æœåŠ¡å™¨ä¸Šå¯¼å‡ºã€‚ æ¯ä¸ªPVéƒ½æœ‰è‡ªå·±çš„ä¸€ç»„è®¿é—®æ¨¡å¼æ¥æè¿°å…·ä½“çš„PVåŠŸèƒ½ã€‚&lt;/p>
&lt;p>è®¿é—®æ¨¡å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>ReadWriteOnce - å·å¯ä»¥ç”±å•ä¸ªèŠ‚ç‚¹ä½œä¸ºè¯»å†™è£…è½½&lt;/li>
&lt;li>ReadOnlyMany - è®¸å¤šèŠ‚ç‚¹å¯ä»¥åªè¯»å®¹é‡&lt;/li>
&lt;li>ReadWriteMany - å·å¯ä»¥é€šè¿‡è®¸å¤šèŠ‚ç‚¹çš„è¯»å†™è£…è½½&lt;/li>
&lt;/ul>
&lt;p>åœ¨CLIä¸­ï¼Œè®¿é—®æ¨¡å¼ç¼©å†™ä¸ºï¼š&lt;/p>
&lt;ul>
&lt;li>RWO - ReadWriteOnce&lt;/li>
&lt;li>ROX - ReadOnlyMany&lt;/li>
&lt;li>RWX - ReadWriteMany&lt;/li>
&lt;/ul>
&lt;p>é‡è¦ï¼ä¸€ä¸ªå·åªèƒ½ä¸€æ¬¡ä½¿ç”¨ä¸€ç§è®¿é—®æ¨¡å¼è¿›è¡ŒæŒ‚è½½ï¼Œå³ä½¿å®ƒæ”¯æŒå¾ˆå¤šã€‚ä¾‹å¦‚ï¼ŒGCEPersistentDiskå¯ä»¥ç”±å•ä¸ªèŠ‚ç‚¹æŒ‚è½½ä¸ºReadWriteOnceæˆ–å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½ä¸ºReadOnlyManyï¼Œä½†ä¸èƒ½åŒæ—¶ä½¿ç”¨ä¸¤ç§ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Volumeæ’ä»¶&lt;/th>
&lt;th>å•èŠ‚ç‚¹è¯»å†™&lt;/th>
&lt;th>å¤šä¸ªèŠ‚ç‚¹åªè¯»&lt;/th>
&lt;th>å¤šä¸ªèŠ‚ç‚¹è¯»å†™&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>AWSElasticBlockStore&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AzureFile&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AzureDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>CephFS&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Cinder&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>FC&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>FlexVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Flocker&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GCEPersistentDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Glusterfs&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>HostPath&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>iSCSI&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PhotonPersistentDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Quobyte&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>NFS&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>RBD&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>VsphereVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PortworxVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ScaleIO&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>StorageOS&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="ç±»å‹">ç±»å‹&lt;/h3>
&lt;p>PVå¯ä»¥æœ‰ä¸€ä¸ªç±»å‹ï¼Œé€šè¿‡å°†storageClassNameå±æ€§è®¾ç½®ä¸ºStorageClassçš„åç§°æ¥æŒ‡å®šã€‚ ç‰¹å®šç±»å‹çš„PVåªèƒ½ç»‘å®šåˆ°è¯·æ±‚è¯¥ç±»å‹çš„PVCã€‚ æ²¡æœ‰storageClassNameçš„PVæ²¡æœ‰ç±»å‹ï¼Œåªèƒ½ç»‘å®šåˆ°ä¸éœ€è¦ç‰¹å®šç±»å‹çš„PVCã€‚
åœ¨è¿‡å»ï¼Œä½¿ç”¨äº†æ³¨é‡Švolume.beta.kubernetes.io/storage-classè€Œä¸æ˜¯storageClassNameå±æ€§ã€‚ è¯¥æ³¨é‡Šä»ç„¶å¯ä»¥å·¥ä½œï¼Œä½†å°†æ¥Kubernetesç‰ˆæœ¬å°†ä¸å†é€‚ç”¨ã€‚&lt;/p>
&lt;h3 id="å›æ”¶ç­–ç•¥">å›æ”¶ç­–ç•¥&lt;/h3>
&lt;p>ç›®å‰çš„å›æ”¶ç­–ç•¥æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>Retain - æ‰‹åŠ¨å›æ”¶&lt;/li>
&lt;li>Recycle - åŸºæœ¬æ“¦æ´—ï¼ˆâ€œrm -rf / thevolume / *â€ï¼‰&lt;/li>
&lt;li>Delete - ç›¸å…³è”çš„å­˜å‚¨èµ„äº§ï¼Œå¦‚AWS EBSï¼ŒGCE PDï¼ŒAzure Diskæˆ–OpenStack Cinderå·è¢«åˆ é™¤&lt;/li>
&lt;/ul>
&lt;p>ç›®å‰ï¼Œåªæœ‰NFSå’ŒHostPathæ”¯æŒå›æ”¶ã€‚ AWS EBSï¼ŒGCE PDï¼ŒAzure Diskå’ŒCinderå·æ”¯æŒåˆ é™¤ã€‚&lt;/p>
&lt;h3 id="é˜¶æ®µ">é˜¶æ®µ&lt;/h3>
&lt;p>å·å°†å¤„äºä»¥ä¸‹é˜¶æ®µä¹‹ä¸€ï¼š&lt;/p>
&lt;ul>
&lt;li>Available å¯ç”¨ - ä¸€ä¸ªå°šæœªç»‘å®šåˆ°ç´¢èµ”çš„å…è´¹èµ„æº&lt;/li>
&lt;li>Bound ç»‘å®š - éŸ³é‡å¿…é¡»æ˜¯å£°æ˜&lt;/li>
&lt;li>Released é‡Šæ”¾ - å£°æ˜å·²è¢«åˆ é™¤ï¼Œä½†èµ„æºå°šæœªè¢«é›†ç¾¤å›æ”¶&lt;/li>
&lt;li>Failed å¤±è´¥ - å·è‡ªåŠ¨å›æ”¶å¤±è´¥&lt;/li>
&lt;/ul>
&lt;p>CLIå°†æ˜¾ç¤ºç»‘å®šåˆ°PVçš„PVCçš„åç§°ã€‚&lt;/p>
&lt;h3 id="æŒ‚è½½é€‰é¡¹">æŒ‚è½½é€‰é¡¹&lt;/h3>
&lt;p>Kubernetesç®¡ç†å‘˜å¯ä»¥æŒ‡å®šåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸ŠæŒ‚è½½ä¸€ä¸ªæŒä¹…å·æ—¶çš„å…¶ä»–æŒ‚è½½é€‰é¡¹ã€‚&lt;/p>
&lt;p>æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨æŒä¹…å·ä¸Šçš„æ³¨é‡Švolume.beta.kubernetes.io/mount-optionsæ¥æŒ‡å®šå®‰è£…é€‰é¡¹ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;v1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;PersistentVolume&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gce-disk-1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volume.beta.kubernetes.io/mount-options&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;discard&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">capacity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;10Gi&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;ReadWriteOnce&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">gcePersistentDisk&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fsType&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;ext4&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">pdName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;gce-disk-1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®‰è£…é€‰é¡¹æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨å°†å·å®‰è£…åˆ°ç£ç›˜æ—¶å°†è¢«ç´¯ç§¯åœ°è¿æ¥å’Œä½¿ç”¨ã€‚&lt;/p>
&lt;p>è¯·æ³¨æ„ï¼Œå¹¶éæ‰€æœ‰Persistentå·ç±»å‹éƒ½æ”¯æŒæŒ‚è½½é€‰é¡¹ã€‚ åœ¨Kubernetes 1.6ç‰ˆä¸­ï¼Œä»¥ä¸‹å·ç±»å‹æ”¯æŒæŒ‚è½½é€‰é¡¹ã€‚&lt;/p>
&lt;ul>
&lt;li>GCEPersistentDisk&lt;/li>
&lt;li>AWSElasticBlockStore&lt;/li>
&lt;li>AzureFile&lt;/li>
&lt;li>AzureDisk&lt;/li>
&lt;li>NFS&lt;/li>
&lt;li>iSCSI&lt;/li>
&lt;li>RBD (Ceph Block Device)&lt;/li>
&lt;li>CephFS&lt;/li>
&lt;li>Cinder (OpenStack block storage)&lt;/li>
&lt;li>Glusterfs&lt;/li>
&lt;li>VsphereVolume&lt;/li>
&lt;li>Quobyte Volumes&lt;/li>
&lt;li>VMware Photon&lt;/li>
&lt;/ul>
&lt;h2 id="persistentvolumeclaims">PersistentVolumeClaims&lt;/h2>
&lt;p>æ¯ä¸ªPVCåŒ…å«è§„æ ¼å’ŒçŠ¶æ€ï¼Œè¿™æ˜¯å£°æ˜çš„è§„èŒƒå’ŒçŠ¶æ€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PersistentVolumeClaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myclaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">8Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">slow&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">release&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;stable&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- {&lt;span class="nt">key: environment, operator: In, values&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="l">dev]}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è®¿é—®æ¨¡å¼-1">è®¿é—®æ¨¡å¼&lt;/h3>
&lt;p>å½“è¯·æ±‚å…·æœ‰ç‰¹å®šè®¿é—®æ¨¡å¼çš„å­˜å‚¨æ—¶ï¼Œå£°æ˜ä½¿ç”¨ä¸å·ç›¸åŒçš„çº¦å®šã€‚&lt;/p>
&lt;h3 id="èµ„æº">èµ„æº&lt;/h3>
&lt;p>å£°æ˜ï¼ˆå°±åƒpodsï¼‰å¯ä»¥è¯·æ±‚ç‰¹å®šæ•°é‡çš„èµ„æºã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·æ±‚ç”¨äºå­˜å‚¨ã€‚ ç›¸åŒçš„èµ„æºæ¨¡å‹é€‚ç”¨äºå·å’Œå£°æ˜ã€‚&lt;/p>
&lt;h3 id="é€‰æ‹©å™¨">é€‰æ‹©å™¨&lt;/h3>
&lt;p>å£°æ˜å¯ä»¥æŒ‡å®šæ ‡ç­¾é€‰æ‹©å™¨ä»¥è¿›ä¸€æ­¥è¿‡æ»¤Volumesé›†ã€‚ åªæœ‰æ ‡ç­¾ä¸é€‰æ‹©å™¨åŒ¹é…çš„å·æ‰èƒ½ç»‘å®šåˆ°å£°æ˜ã€‚ é€‰æ‹©å™¨å¯ä»¥ç”±ä¸¤ä¸ªå­—æ®µç»„æˆï¼š&lt;/p>
&lt;ul>
&lt;li>matchLabels - å·å¿…é¡»å…·æœ‰å¸¦æ­¤å€¼çš„æ ‡ç­¾&lt;/li>
&lt;li>matchExpressions - é€šè¿‡æŒ‡å®šå…³é”®å­—å’Œå€¼çš„å…³é”®å­—ï¼Œå€¼åˆ—è¡¨å’Œè¿ç®—ç¬¦æ‰€åšçš„è¦æ±‚åˆ—è¡¨ã€‚ æœ‰æ•ˆè¿ç®—ç¬¦åŒ…æ‹¬Inï¼ŒNotInï¼ŒExistså’ŒDoesNotExistã€‚&lt;/li>
&lt;/ul>
&lt;p>æ‰€æœ‰æ¥è‡ªmatchLabelså’ŒmatchExpressionsçš„è¦æ±‚æ˜¯ç»„åˆåœ¨ä¸€èµ·çš„ï¼Œæ‰€æœ‰è¿™äº›è¦æ±‚éƒ½å¿…é¡»æ»¡è¶³æ‰èƒ½åŒ¹é…ã€‚&lt;/p>
&lt;h3 id="ç±»å‹-1">ç±»å‹&lt;/h3>
&lt;p>å£°æ˜å¯ä»¥é€šè¿‡ä½¿ç”¨å±æ€§storageClassNameæŒ‡å®šStorageClassçš„åç§°æ¥è¯·æ±‚ç‰¹å®šçš„ç±»å‹ã€‚åªæœ‰æ‰€è¯·æ±‚çš„ç±»å‹çš„PVï¼Œä¸PVCç›¸åŒçš„storageClassNameçš„PVå¯ä»¥ç»‘å®šåˆ°PVCã€‚&lt;/p>
&lt;p>PVCä¸ä¸€å®šè¦æ±‚ä¸€ä¸ªç±»å‹ã€‚ å®ƒçš„storageClassNameè®¾ç½®ä¸ºç­‰äºâ€œâ€çš„PVCæ€»æ˜¯è¢«è§£é‡Šä¸ºè¯·æ±‚æ²¡æœ‰ç±»å‹çš„PVï¼Œå› æ­¤å®ƒåªèƒ½ç»‘å®šåˆ°æ²¡æœ‰ç±»å‹çš„PVï¼ˆæ²¡æœ‰æ³¨é‡Šæˆ–ä¸€ä¸ªç­‰äºâ€œâ€ï¼‰ã€‚ æ²¡æœ‰storageClassNameçš„PVCä¸å®Œå…¨ç›¸åŒï¼Œå¹¶ä¸”æ ¹æ®æ˜¯å¦å¯ç”¨äº†DefaultStorageClass admissionæ’ä»¶ï¼Œé›†ç¾¤çš„å¤„ç†æ–¹å¼ä¸åŒã€‚&lt;/p>
&lt;ul>
&lt;li>å¦‚æœadmissionæ’ä»¶å·²æ‰“å¼€ï¼Œåˆ™ç®¡ç†å‘˜å¯ä»¥æŒ‡å®šé»˜è®¤çš„StorageClassã€‚ æ²¡æœ‰storageClassNameçš„æ‰€æœ‰PVCåªèƒ½ç»‘å®šåˆ°è¯¥é»˜è®¤çš„PVã€‚ é€šè¿‡å°†StorageClasså¯¹è±¡ä¸­çš„æ³¨è§£storageclass.kubernetes.io/is-default-classè®¾ç½®ä¸ºâ€œtrueâ€æ¥æŒ‡å®šé»˜è®¤çš„StorageClassã€‚ å¦‚æœç®¡ç†å‘˜æ²¡æœ‰æŒ‡å®šé»˜è®¤å€¼ï¼Œåˆ™é›†ç¾¤ä¼šå¯¹PVCåˆ›å»ºåšå‡ºå“åº”ï¼Œå°±åƒadmissionæ’ä»¶è¢«å…³é—­ä¸€æ ·ã€‚ å¦‚æœæŒ‡å®šäº†å¤šä¸ªé»˜è®¤å€¼ï¼Œåˆ™admissionæ’ä»¶ç¦æ­¢åˆ›å»ºæ‰€æœ‰PVCã€‚&lt;/li>
&lt;li>å¦‚æœadmissionæ’ä»¶å·²å…³é—­ï¼Œåˆ™ä¸å­˜åœ¨é»˜è®¤StorageClassçš„æ¦‚å¿µã€‚ æ²¡æœ‰&lt;code>storageClassName&lt;/code>çš„æ‰€æœ‰PVCåªèƒ½ç»‘å®šåˆ°æ²¡æœ‰ç±»çš„PVã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ²¡æœ‰&lt;code>storageClassName&lt;/code>çš„PVCçš„å¤„ç†æ–¹å¼ä¸å°†å…¶&lt;code>storageClassName&lt;/code>è®¾ç½®ä¸ºâ€œâ€çš„PVCç›¸åŒã€‚&lt;/li>
&lt;/ul>
&lt;p>æ ¹æ®æŒ‚è½½æ–¹æ³•ï¼ŒæŒ‚è½½è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡addon manageråœ¨Kubernetesç¾¤é›†ä¸­éƒ¨ç½²é»˜è®¤çš„&lt;code>StorageClass&lt;/code>ã€‚&lt;/p>
&lt;p>å½“PVCæŒ‡å®šä¸€ä¸ªé€‰æ‹©å™¨ï¼Œé™¤äº†è¯·æ±‚ä¸€ä¸ª&lt;code>StorageClass&lt;/code>ä¹‹å¤–ï¼Œè¿™äº›è¦æ±‚è¢«ANDç»„åˆåœ¨ä¸€èµ·ï¼šåªæœ‰æ‰€è¯·æ±‚çš„ç±»å’Œæ‰€è¯·æ±‚çš„æ ‡ç­¾çš„PVå¯èƒ½è¢«ç»‘å®šåˆ°PVCã€‚ è¯·æ³¨æ„ï¼Œå½“å‰ï¼Œå…·æœ‰éç©ºé€‰æ‹©å™¨çš„PVCä¸èƒ½ä¸ºå…¶åŠ¨æ€é…ç½®PVã€‚&lt;/p>
&lt;p>åœ¨è¿‡å»ï¼Œä½¿ç”¨äº†æ³¨è§£&lt;code>volume.beta.kubernetes.io/storage-class&lt;/code>ï¼Œè€Œä¸æ˜¯&lt;code>storageClassName&lt;/code>å±æ€§ã€‚ è¯¥æ³¨è§£ä»ç„¶å¯ä»¥å·¥ä½œï¼Œä½†åœ¨æœªæ¥çš„Kubernetesç‰ˆæœ¬ä¸­å®ƒå°†ä¸è¢«æ”¯æŒã€‚&lt;/p>
&lt;h2 id="claims-vs-volumes">Claims VS Volumes&lt;/h2>
&lt;p>Podsé€šè¿‡å°†å£°æ˜ç”¨ä½œå·æ¥è®¿é—®å­˜å‚¨ã€‚ å£°æ˜å¿…é¡»å­˜åœ¨äºä¸ä½¿ç”¨å£°æ˜çš„podç›¸åŒçš„å‘½åç©ºé—´ä¸­ã€‚ é›†ç¾¤åœ¨podçš„å‘½åç©ºé—´ä¸­æŸ¥æ‰¾å£°æ˜ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥è·å–æ”¯æŒå£°æ˜çš„&lt;code>PersistentVolume&lt;/code>ã€‚ ç„¶åå°†å·æŒ‚è½½åˆ°ä¸»æœºå¹¶è¿›å…¥podã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myfrontend&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dockerfile/nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/var/www/html&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mypd&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">persistentVolumeClaim&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">claimName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myclaim&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å…³äºå‘½åç©ºé—´çš„æ³¨æ„">å…³äºå‘½åç©ºé—´çš„æ³¨æ„&lt;/h3>
&lt;p>&lt;code>PersistentVolumes&lt;/code>ç»‘å®šæ˜¯ç‹¬å çš„ï¼Œå¹¶ä¸”ç”±äº&lt;code>PersistentVolumeClaims&lt;/code>æ˜¯å‘½åç©ºé—´å¯¹è±¡ï¼Œå› æ­¤åªèƒ½åœ¨ä¸€ä¸ªå‘½åç©ºé—´å†…æŒ‚è½½â€œmanyâ€æ¨¡å¼ï¼ˆROXï¼ŒRWXï¼‰çš„å£°æ˜ã€‚&lt;/p>
&lt;h2 id="storageclasses">StorageClasses&lt;/h2>
&lt;p>æ¯ä¸ª&lt;code>StorageClass&lt;/code>åŒ…å«å­—æ®µ&lt;code>provisioninger&lt;/code>å’Œ&lt;code>parameter&lt;/code>ï¼Œå½“å±äºç±»å‹çš„&lt;code>PersistentVolume&lt;/code>éœ€è¦åŠ¨æ€é…ç½®æ—¶ä½¿ç”¨ã€‚&lt;/p>
&lt;p>&lt;code>StorageClass&lt;/code>å¯¹è±¡çš„åç§°å¾ˆé‡è¦ï¼Œç”¨æˆ·å¯ä»¥å¦‚ä½•è¯·æ±‚ç‰¹å®šçš„ç±»ã€‚ ç®¡ç†å‘˜åœ¨é¦–æ¬¡åˆ›å»º&lt;code>StorageClass&lt;/code>å¯¹è±¡æ—¶è®¾ç½®ç±»çš„åç§°å’Œå…¶ä»–å‚æ•°ï¼Œå¹¶ä¸”åœ¨åˆ›å»ºå¯¹è±¡åæ— æ³•æ›´æ–°å¯¹è±¡ã€‚&lt;/p>
&lt;p>ç®¡ç†å‘˜å¯ä»¥ä»…ä¸ºä¸è¦æ±‚ä»»ä½•ç‰¹å®šç±»ç»‘å®šçš„PVCæŒ‡å®šé»˜è®¤çš„StorageClassï¼šæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">PersistentVolumeClaim&lt;/a>éƒ¨åˆ†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">StorageClass&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">storage.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">standard&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">provisioner&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubernetes.io/aws-ebs&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">parameters&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gp2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ä¾›åº”è€…provisioner">ä¾›åº”è€…(Provisioner)&lt;/h3>
&lt;p>å­˜å‚¨ç±»æœ‰ä¸€ä¸ªä¾›åº”è€…ï¼Œå®ƒç¡®å®šç”¨äºé…ç½®PVçš„å·æ’ä»¶ã€‚å¿…é¡»æŒ‡å®šæ­¤å­—æ®µã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Volume Plugin&lt;/th>
&lt;th>Internal Provisioner&lt;/th>
&lt;th>Config Example&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>AWSElasticBlockStore&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#aws">AWS&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AzureFile&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#azure-file">Azure File&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AzureDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#azure-disk">Azure Disk&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>CephFS&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Cinder&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#openstack-cinder">OpenStack Cinder&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>FC&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>FlexVolume&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Flocker&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GCEPersistentDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#gce">GCE&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Glusterfs&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#glusterfs">Glusterfs&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>iSCSI&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PhotonPersistentDisk&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Quobyte&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#quobyte">Quobyte&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>NFS&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>RBD&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#ceph-rbd">Ceph RBD&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>VsphereVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#vsphere">vSphere&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PortworxVolume&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#portworx-volume">Portworx Volume&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ScaleIO&lt;/td>
&lt;td>âœ“&lt;/td>
&lt;td>&lt;a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#scaleio">ScaleIO&lt;/a>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>ä½ ä¸é™äºæŒ‡å®šæ­¤å¤„åˆ—å‡ºçš„â€œinternalâ€ä¾›åº”è€…ï¼ˆå…¶åç§°å‰ç¼€ä¸ºâ€œkubernetes.ioâ€å¹¶ä¸Kubernetesä¸€èµ·å‘é€ï¼‰ã€‚ ä½ è¿˜å¯ä»¥è¿è¡Œå’ŒæŒ‡å®šå¤–éƒ¨æä¾›ç¨‹åºï¼Œå®ƒä»¬æ˜¯éµå¾ªKuberneteså®šä¹‰çš„è§„èŒƒçš„ç‹¬ç«‹ç¨‹åºã€‚ å¤–éƒ¨æä¾›è€…çš„ä½œè€…å¯¹ä»£ç çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¾›åº”å•†çš„è¿è¾“çŠ¶å†µï¼Œè¿è¡ŒçŠ¶å†µä»¥åŠä½¿ç”¨çš„å·æ’ä»¶ï¼ˆåŒ…æ‹¬Flexï¼‰ç­‰éƒ½æœ‰å……åˆ†çš„è‡ªä¸»æƒã€‚å­˜å‚¨åº“kubernetes-incubator /å¤–éƒ¨å­˜å‚¨åº“åŒ…å«ä¸€ä¸ªåº“ ç”¨äºç¼–å†™å®æ–½å¤§éƒ¨åˆ†è§„èŒƒçš„å¤–éƒ¨æä¾›è€…ä»¥åŠå„ç§ç¤¾åŒºç»´æŠ¤çš„å¤–éƒ¨æä¾›è€…ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼ŒNFSä¸æä¾›å†…éƒ¨æä¾›ç¨‹åºï¼Œä½†å¯ä»¥ä½¿ç”¨å¤–éƒ¨æä¾›ç¨‹åºã€‚ ä¸€äº›å¤–éƒ¨æä¾›è€…åˆ—åœ¨å­˜å‚¨åº“kubernetes-incubator/external-storageä¸­ã€‚ è¿˜æœ‰ç¬¬ä¸‰æ–¹å­˜å‚¨ä¾›åº”å•†æä¾›è‡ªå·±çš„å¤–éƒ¨ä¾›åº”å•†çš„æƒ…å†µã€‚&lt;/p>
&lt;h3 id="å›æ”¶ç­–ç•¥-1">å›æ”¶ç­–ç•¥&lt;/h3>
&lt;p>ç”±å­˜å‚¨ç±»åŠ¨æ€åˆ›å»ºçš„æŒä¹…å·å°†å…·æœ‰&lt;code>delete&lt;/code>çš„å›æ”¶ç­–ç•¥ã€‚ å¦‚æœä¸å¸Œæœ›è¿™æ ·åšï¼Œå”¯ä¸€çš„å½“å‰é€‰é¡¹æ˜¯åœ¨åˆ›å»ºPVä¹‹åç¼–è¾‘PVã€‚&lt;/p>
&lt;p>é€šè¿‡å­˜å‚¨ç±»æ‰‹åŠ¨åˆ›å»ºå’Œç®¡ç†çš„æŒä¹…å·å°†å…·æœ‰åœ¨åˆ›å»ºæ—¶åˆ†é…çš„ä»»ä½•å›æ”¶ç­–ç•¥ã€‚&lt;/p>
&lt;h3 id="å‚æ•°">å‚æ•°&lt;/h3>
&lt;p>å­˜å‚¨ç±»å‹å…·æœ‰æè¿°å±äºå­˜å‚¨ç±»å‹çš„å·çš„å‚æ•°ã€‚ å–å†³äºä¾›åº”è€…ï¼Œå¯ä»¥æ¥å—ä¸åŒçš„å‚æ•°ã€‚ ä¾‹å¦‚ï¼Œå‚æ•°ç±»å‹çš„å€¼io1å’Œå‚æ•°iopsPerGBç‰¹å®šäºEBSã€‚ å½“çœç•¥å‚æ•°æ—¶ï¼Œä½¿ç”¨ä¸€äº›é»˜è®¤å€¼ã€‚&lt;/p></description></item><item><title>Kuberneteså­¦ä¹  â€” Macoså®‰è£…Kubernetes</title><link>https://atbug.com/install-kubernetes-on-macos/</link><pubDate>Thu, 17 Aug 2017 09:44:17 +0000</pubDate><guid>https://atbug.com/install-kubernetes-on-macos/</guid><description>
&lt;h1 id="kubernetes">Kubernetes&lt;/h1>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;h2 id="macos">macos&lt;/h2>
&lt;h3 id="æ£€æŸ¥ç¯å¢ƒ">æ£€æŸ¥ç¯å¢ƒ&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">sysctl -a &lt;span class="p">|&lt;/span> grep machdep.cpu.features &lt;span class="p">|&lt;/span> grep VMX
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…virtualbox">å®‰è£…VirtualBox&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">http://download.virtualbox.org/virtualbox/5.1.26/Oracle_VM_VirtualBox_Extension_Pack-5.1.26-117224.vbox-extpack
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…minikube">å®‰è£…minikube&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.21.0/minikube-darwin-amd64 &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> chmod +x minikube &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> sudo mv minikube /usr/local/bin/
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ›å»ºé›†ç¾¤">åˆ›å»ºé›†ç¾¤&lt;/h3>
&lt;p>é»˜è®¤ä½¿ç”¨virtualboxã€‚&lt;/p>
&lt;p>ä¸»æœºçš„ipæ˜¯&lt;code>192.168.31.186&lt;/code>ï¼Œ &lt;code>1087&lt;/code>æ˜¯proxyçš„ç«¯å£ã€‚éœ€è¦å°†ssçš„httpä»£ç†ç›‘å¬åœ°å€ä»&lt;code>127.0.0.1&lt;/code>æ”¹ä¸ºä¸»æœºçš„ipã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1">#å¯åŠ¨&lt;/span>
minikube start
&lt;span class="c1">#ä½¿ç”¨ç§æœ‰åº“&lt;/span>
minikube start --insecure-registry&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.31.34&amp;#34;&lt;/span>
&lt;span class="c1">#ä½¿ç”¨proxyï¼Œç”¨äºè·å–é•œåƒ&lt;/span>
minikube start --docker-env &lt;span class="nv">HTTP_PROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.31.186:1087&amp;#34;&lt;/span> --docker-env &lt;span class="nv">HTTPS_PROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;192.168.31.186:1087&amp;#34;&lt;/span> --docker-env &lt;span class="nv">NO_PROXY&lt;/span>&lt;span class="o">=&lt;/span>192.168.99.0/24
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®‰è£…kubectl">å®‰è£…kubectl&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">curl -Lo kubectl http://storage.googleapis.com/kubernetes-release/release/v1.7.3/bin/darwin/amd64/kubectl &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> chmod +x kubectl &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> sudo mv kubectl /usr/local/bin/
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="oh-my-zsh-tab-completion">oh-my-zsh tab completion&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">vi ~/.zshrc
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>æ·»åŠ åˆ°pluginéƒ¨åˆ†&lt;br>
plugins=(git zsh-completions kubectl)&lt;/p>
&lt;/blockquote>
&lt;h2 id="ä½¿ç”¨">ä½¿ç”¨&lt;/h2>
&lt;h3 id="minikube">minikube&lt;/h3>
&lt;h4 id="æ£€æŸ¥ç‰ˆæœ¬">æ£€æŸ¥ç‰ˆæœ¬&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube version
&lt;span class="c1">#minikube version: v0.21.0&lt;/span>
kubectl version
&lt;span class="c1">#Client Version: version.Info{Major:&amp;#34;1&amp;#34;, Minor:&amp;#34;3&amp;#34;, GitVersion:&amp;#34;v1.3.0&amp;#34;, GitCommit:&amp;#34;283137936a498aed572ee22af6774b6fb6e9fd94&amp;#34;, GitTreeState:&amp;#34;clean&amp;#34;, BuildDate:&amp;#34;2016-07-01T19:26:38Z&amp;#34;, GoVersion:&amp;#34;go1.6.2&amp;#34;, Compiler:&amp;#34;gc&amp;#34;, Platform:&amp;#34;darwin/amd64&amp;#34;}&lt;/span>
&lt;span class="c1">#Server Version: version.Info{Major:&amp;#34;1&amp;#34;, Minor:&amp;#34;7&amp;#34;, GitVersion:&amp;#34;v1.7.0&amp;#34;, GitCommit:&amp;#34;d3ada0119e776222f11ec7945e6d860061339aad&amp;#34;, GitTreeState:&amp;#34;clean&amp;#34;, BuildDate:&amp;#34;2017-07-26T00:12:31Z&amp;#34;, GoVersion:&amp;#34;go1.8.3&amp;#34;, Compiler:&amp;#34;gc&amp;#34;, Platform:&amp;#34;linux/amd64&amp;#34;}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="è·å–é›†ç¾¤åœ°å€">è·å–é›†ç¾¤åœ°å€&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube ip
192.168.99.100
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="è·å–æœåŠ¡åˆ—è¡¨">è·å–æœåŠ¡åˆ—è¡¨&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube service list
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ‰“å¼€dashboard">æ‰“å¼€dashboard&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">minikube dashboard
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="kubectl">kubectl&lt;/h2>
&lt;h4 id="éƒ¨ç½²dashboard-ui">éƒ¨ç½²Dashboard UI&lt;/h4>
&lt;p>é»˜è®¤minikubeä¼šè‡ªåŠ¨éƒ¨ç½²dashboard&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl create -f https://rawgit.com/kubernetes/dashboard/master/src/deploy/kubernetes-dashboard.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å¯åŠ¨proxy">å¯åŠ¨proxy&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl proxy
&lt;span class="c1">#Starting to serve on 127.0.0.1:8001&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="è·å–podä¿¡æ¯">è·å–podä¿¡æ¯&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl get pods --namespace kube-system
NAME READY STATUS RESTARTS AGE
kube-addon-manager-minikube 0/1 Running &lt;span class="m">0&lt;/span> 1h
kubernetes-dashboard-3313488171-90s64 0/1 Running &lt;span class="m">0&lt;/span> 20m
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœSTATUSä¸€ç›´å¤„äº&lt;strong>ContainerCreating&lt;/strong>çŠ¶æ€ï¼Œåº”è¯¥æ˜¯pull imageå¤±è´¥ã€‚é»˜è®¤æ˜¯å»gcr.ioæ‹‰é•œåƒï¼Œè¢«å¢™äº†ã€‚éœ€è¦åœ¨å¯åŠ¨minikubeçš„æ—¶å€™è®¾ç½®dockerä½¿ç”¨çš„ä»£ç†ã€‚&lt;/p>
&lt;h4 id="è·å–podè¯¦ç»†ä¿¡æ¯">è·å–podè¯¦ç»†ä¿¡æ¯&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl describe pod kubernetes-dashboard-3313488171-90s64 --namespace kube-system
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="æŸ¥çœ‹log">æŸ¥çœ‹log&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">kubectl logs -f kubernetes-dashboard-3313488171-90s64
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>æš´åŠ›åœæ­¢ExecutorServiceçš„çº¿ç¨‹</title><link>https://atbug.com/stop-a-thread-of-executor-service/</link><pubDate>Wed, 19 Jul 2017 22:25:19 +0000</pubDate><guid>https://atbug.com/stop-a-thread-of-executor-service/</guid><description>
&lt;p>åœæ­¢ï¼Œstopï¼Œè¿™é‡Œè¯´çš„æ˜¯çœŸçš„åœæ­¢ã€‚å¦‚ä½•ä¼˜é›…çš„ç»“æŸï¼Œè¿™é‡Œå°±ä¸æäº†ã€‚&lt;/p>
&lt;p>è¿™é‡Œè¦ç”¨&lt;code>Thread.stop()&lt;/code>ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œstop()æ–¹æ³•åœ¨JDKä¸­æ˜¯åºŸå¼ƒçš„ã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¯¥æ–¹æ³•å¤©ç”Ÿæ˜¯ä¸å®‰å…¨çš„ã€‚ä½¿ç”¨thread.stop()åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯¼è‡´é‡Šæ”¾ï¼ˆè§£é”ï¼‰æ‰€æœ‰è¯¥çº¿ç¨‹å·²ç»é”å®šçš„ç›‘è§†å™¨ï¼ˆå› æ²¿å †æ ˆå‘ä¸Šä¼ æ’­çš„æœªæ£€æŸ¥å¼‚å¸¸ThreadDeathè€Œè§£é”ï¼‰ã€‚å¦‚æœä¹‹å‰å—è¿™äº›ç›‘è§†å™¨ä¿æŠ¤çš„ä»»ä½•å¯¹è±¡å¤„äºä¸ä¸€è‡´çŠ¶æ€ï¼Œåˆ™ä¸ä¸€è‡´çŠ¶æ€çš„å¯¹è±¡ï¼ˆå—æŸå¯¹è±¡ï¼‰å°†å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼Œè¿™å¯èƒ½å¯¼è‡´ä»»æ„çš„è¡Œä¸ºã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æœ‰æ—¶å€™æˆ‘ä»¬ä¼šæœ‰è¿™ç§éœ€æ±‚ï¼Œä¸éœ€è¦è€ƒè™‘çº¿ç¨‹æ‰§è¡Œåˆ°å“ªä¸€æ­¥ã€‚ä¸€èˆ¬è¿™ç§æƒ…å†µæ˜¯å¤–éƒ¨æ‰§è¡Œstopï¼Œæ¯”å¦‚æ‰§è¡Œä¸šåŠ¡çš„çº¿ç¨‹å› ä¸ºå„ç§åŸå› å‡æ­»æˆ–è€…è€—æ—¶è¾ƒé•¿ï¼Œç”±äºè®¾è®¡é—®é¢˜åˆæ— æ³•å“åº”ä¼˜é›…çš„åœæ­¢æŒ‡ä»¤ã€‚&lt;/p>
&lt;p>ç°åœ¨å¤§å®¶åœ¨é¡¹ç›®ä¸­éƒ½å¾ˆå°‘ç›´æ¥ä½¿ç”¨çº¿ç¨‹ï¼Œè€Œæ˜¯é€šè¿‡concurrentåŒ…ä¸­çš„ç±»æ¥å®ç°å¤šçº¿ç¨‹ï¼Œä¾‹å¦‚ExecutorServiceçš„å„ç§å®ç°ç±»ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªç®€å•çš„åœæ­¢çº¿ç¨‹çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-JAVA" data-lang="JAVA">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ExecutorServiceTest&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ExecutorService&lt;/span> &lt;span class="n">executor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Executors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newSingleThreadExecutor&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="n">AtomicReference&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">AtomicReference&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;();&lt;/span>
&lt;span class="n">Future&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;&lt;/span> &lt;span class="n">firstFuture&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">executor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">submit&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Runnable&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Thread&lt;/span> &lt;span class="n">currentThread&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">currentThread&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">});&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">firstFuture&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">500&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">isAlive&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">stop&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">50&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">executor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">submit&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Runnable&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;submit again&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">});&lt;/span>
&lt;span class="n">executor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">shutdown&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœä½ è¿è¡Œäº†ä¸Šé¢çš„ä»£ç å°±ä¼šå‘ç°ç¨‹åºå‡æ­»äº†ï¼Œé€šè¿‡stack dumpçœ‹æ˜¯å‘ç”Ÿäº†æ­»é”ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">&amp;#34;pool-1-thread-2&amp;#34; #11 prio=5 os_prio=31 tid=0x00007fa91006e800 nid=0x5903 waiting on condition [0x00007000060f8000]
java.lang.Thread.State: WAITING (parking)
at sun.misc.Unsafe.park(Native Method)
- parking to wait for &amp;lt;0x000000076ab76ea0&amp;gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:870)
at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043)
at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)
at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1067)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
at java.lang.Thread.run(Thread.java:745)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ­»é”å‘ç”Ÿåœ¨ç¬¬äºŒæ¬¡submitåï¼Œåœ¨LinkedBlockingQueue.take()æ—¶ï¼ŒLinkedBlockingQueueåœ¨ThreadPoolExecutorä¸­ç”¨æ¥æš‚å­˜taskçš„ã€‚çœŸæ­£æ‰§è¡Œä»»åŠ¡çº¿ç¨‹çš„æ—¶å€™å†ä»é˜Ÿåˆ—ä¸­å–å‡ºã€‚æˆ‘ä»¬éƒ½çŸ¥é“LinkedBlockingQueueæ˜¯çº¿ç¨‹çš„å®‰å…¨çš„ï¼Œå…¶é«˜å¹¶å‘å’Œçº¿ç¨‹å®‰å…¨æ˜¯é€šè¿‡ä¸€ä¸ªReentrantLockä»£æ›¿å†…ç½®é”æ¥å®ç°çš„ï¼ˆå‡å°äº†é”çš„ç²’åº¦ï¼‰ã€‚submitç¬¬äºŒä¸ªtaskæ—¶ï¼Œå†æ¬¡æ‰§è¡Œtakeä¼šå†æ¬¡è·å–é”ã€‚ä½†æ˜¯ç”±äºstopç›´æ¥æ€æ­»äº†çº¿ç¨‹ï¼Œæ²¡æœ‰é‡Šæ”¾å½“æ¬¡æ‰§è¡Œtakeæ–¹æ³•æ—¶è·å–ReentrantLocké”ï¼Œå¯¼è‡´äº†æ­»é”ã€‚&lt;/p>
&lt;p>stopç›´æ¥åœæ­¢äº†çº¿ç¨‹ï¼ŒæŠ›å‡ºäº†&lt;code>ThreadDeath&lt;/code>ã€‚&lt;code>ThreadDeath&lt;/code>æ˜¯Errorï¼Œä¸æ˜¯Exceptionã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ThreadDeath&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">Error&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">serialVersionUID&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">4417128565033088268L&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ç§æƒ…å†µä¸‹ï¼ŒåŸæœ‰çš„ExecutorServiceå®ä¾‹å°±ä¸èƒ½å†ä½¿ç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•é€šè¿‡ç¨‹åºæ¥é‡Šæ”¾æœªé‡Šæ”¾çš„é”ï¼ˆç”±è™šæ‹Ÿæœºçš„GCæ¥è§£å†³ï¼‰ã€‚å¦‚æ­¤ï¼Œä¾¿éœ€è¦é‡å»ºExecutorServiceå®ä¾‹ã€‚&lt;/p>
&lt;p>å¯¹ä¸Šé¢çš„ä»£ç åšäº†ä¿®æ”¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ExecutorServiceTest&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ExecutorService&lt;/span> &lt;span class="n">executor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Executors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newSingleThreadExecutor&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="n">AtomicReference&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ExecutorService&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">es&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">AtomicReference&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;();&lt;/span>
&lt;span class="n">es&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">executor&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="n">AtomicReference&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">AtomicReference&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;();&lt;/span>
&lt;span class="n">Future&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;&lt;/span> &lt;span class="n">future&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">es&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">submit&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Runnable&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Thread&lt;/span> &lt;span class="n">currentThread&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">currentThread&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">currentThread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setUncaughtExceptionHandler&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">UncaughtExceptionHandler&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">uncaughtException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span> &lt;span class="n">t&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Throwable&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">ThreadDeath&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">IllegalMonitorStateException&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">es&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">shutdownNow&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">es&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Executors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newSingleThreadExecutor&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">});&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">});&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">future&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">500&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">isAlive&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">stop&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">50&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">es&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">submit&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Runnable&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;submit again&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">});&lt;/span>
&lt;span class="n">es&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">shutdown&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ³¨ï¼šè¿™ä¸ªä¾‹å­åªè€ƒè™‘äº†ExecutorServiceå®ä¾‹åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸­çš„ä½¿ç”¨ï¼Œå¦‚æœéœ€è¦åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­éœ€è¦è€ƒè™‘é‡å»ºå®ä¾‹æ—¶çš„æ’ä»–æ€§ã€‚&lt;/strong>&lt;/p>
&lt;p>ä¿®æ”¹åçš„æ ¸å¿ƒæ˜¯UncaughtExceptionHandlerï¼š&lt;/p>
&lt;blockquote>
&lt;p>å½“çº¿ç¨‹ç”±äºæœªæ•è·çš„å¼‚å¸¸çªç„¶ç»ˆæ­¢è€Œè°ƒç”¨å¤„ç†ç¨‹åºçš„æ¥å£ã€‚
å½“çº¿ç¨‹ç”±äºæœªæ•è·çš„å¼‚å¸¸å³å°†ç»ˆæ­¢æ—¶ï¼ŒJavaè™šæ‹Ÿæœºå°†ä½¿ç”¨Thread.getUncaughtExceptionHandlerï¼ˆï¼‰å‘çº¿ç¨‹æŸ¥è¯¢å…¶UncaughtExceptionHandlerï¼Œå¹¶å°†è°ƒç”¨å¤„ç†ç¨‹åºçš„uncaughtExceptionæ–¹æ³•ï¼Œå°†çº¿ç¨‹å’Œå¼‚å¸¸ä½œä¸ºå‚æ•°ä¼ é€’ã€‚ å¦‚æœä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰æ˜¾ç¤ºå®ƒçš„UncaughtExceptionHandlerï¼Œé‚£ä¹ˆå®ƒçš„ThreadGroupå¯¹è±¡å……å½“å®ƒçš„UncaughtExceptionHandlerã€‚ å¦‚æœThreadGroupå¯¹è±¡æ²¡æœ‰å¤„ç†å¼‚å¸¸çš„ç‰¹æ®Šè¦æ±‚ï¼Œå®ƒå¯ä»¥å°†è°ƒç”¨è½¬å‘åˆ°é»˜è®¤çš„æœªæ•è·çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚&lt;/p>
&lt;/blockquote></description></item><item><title>ç§æœ‰æ„é€ å‡½æ•°æ•è·æ¨¡å¼</title><link>https://atbug.com/private-constructor-capture-idiom/</link><pubDate>Wed, 24 May 2017 06:50:44 +0000</pubDate><guid>https://atbug.com/private-constructor-capture-idiom/</guid><description>
&lt;p>ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®è·µã€‹çš„æ³¨è§£ä¸­æœ‰æåˆ°è¿™ä¸€æ¦‚å¿µã€‚&lt;/p>
&lt;blockquote>
&lt;p>The private constructor exists to avoid the race condition that would occur if the copy constructor were implemented as this (p.x, p.y); this is an example of the private constructor capture idiom (Bloch and Gafter, 2005).&lt;/p>
&lt;/blockquote>
&lt;p>ç»“åˆåŸæ–‡ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="nd">@ThreadSafe&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">SafePoint&lt;/span>&lt;span class="o">{&lt;/span>
&lt;span class="nd">@GuardedBy&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;this&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="nf">SafePoint&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="o">[]&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="k">this&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">],&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">]);&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="nf">SafePoint&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SafePoint&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="k">this&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">());&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="nf">SafePoint&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">){&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">synchronized&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="o">(){&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="o">};&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">synchronized&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">){&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçš„æ„é€ å™¨&lt;code>public SafePoint(SafePoint p) { this (p.get()); }&lt;/code>æ˜¯ä¸ºäº†æ•è·å¦ä¸€ä¸ªå®ä¾‹çš„çŠ¶æ€ã€‚get()æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œä¸ºäº†é¿å…ç«æ€æ²¡æœ‰åˆ†åˆ«æä¾›xã€yçš„å…¬æœ‰getteræ–¹æ³•ã€‚&lt;/p>
&lt;p>ä¸ºäº†ä¿è¯SafePointçš„å¤šçº¿ç¨‹å®‰å…¨æ€§ï¼Œåœ¨ä½¿ç”¨å¦ä¸€ä¸ªå®ä¾‹æ„é€ æ–°çš„å®ä¾‹æ—¶ï¼Œä½¿ç”¨äº†ä¸€ä¸ªç§æœ‰çš„æ„é€ å™¨ã€‚&lt;/p>
&lt;p>é¦–å…ˆä¸ºä»€ä¹ˆä¸ç”¨ä¸‹é¢è¿™ç§ï¼Œè¿˜æ˜¯ä¸ºäº†é¿å…ç«æ€ï¼ˆp.xå’Œp.yè°ƒç”¨ä¸æ˜¯åŸå­æ“ä½œï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="nf">SafePoint&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SafePoint&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">x&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">y&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŒç†ï¼Œè¿™ç§ä¹Ÿä¸è¡Œï¼Œä¸¤æ¬¡è°ƒç”¨get()æ–¹æ³•ä¸æ˜¯åŸå­æ“ä½œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="nf">SafePoint&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SafePoint&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">()[&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">],&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">()[&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">])&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸ºä»€ä¹ˆä¸ç”¨ç›´æ¥ç”¨æ•°ç»„ï¼Œç¼–è¯‘ä¸é€šè¿‡ï¼š&lt;code>Call to &amp;quot;this()&amp;quot; must be first statement in constructor body&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="nf">SafePoint&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SafePoint&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">int&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">],&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">]);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸ºä»€ä¹ˆæ¥å—æ•°ç»„ä¸ºå‚æ•°çš„æ„é€ å™¨ä¸èƒ½å…¬å¼€ï¼Œæ•°ç»„aæ˜¯æœ‰å¤–éƒ¨ä¼ å…¥çš„ï¼Œå¹¶ä¸èƒ½ä¿è¯æ•°ç»„å†…å®¹ä¸ä¼šå…¶ä»–çº¿ç¨‹ä¿®æ”¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="nf">SafePoint&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="o">[]&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">],&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">]);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ç§ä»£æ›¿ç§æœ‰çš„æ„é€ å™¨ï¼Œè¿™ç§æ–¹æ³•æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯ä¼šäº§ç”Ÿé‡å¤çš„åˆå§‹åŒ–ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="nf">SafePoint&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SafePoint&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">int&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">];&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">];&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†å›å¤´çœ‹SafePointçš„çº¿ç¨‹å®‰å…¨æ€§ï¼ŒSafePointæœ‰ä¸¤ä¸ªçŠ¶æ€å˜é‡xã€yã€‚ä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ï¼Œæ²¡æœ‰ä¸ºå…¶åˆ†åˆ«æä¾›getterå’Œsetteræ–¹æ³•ï¼Œè€Œæ˜¯å°†å…¶å°è£…åå‘å¸ƒå¹¶ä½¿ç”¨å†…ç½®é”ä¿æŠ¤ã€‚&lt;/p>
&lt;p>å¯ä»¥å‚è€ƒ&lt;a href="%5Bhttps://stackoverflow.com/questions/12028925/private-constructor-to-avoid-race-condition/12037506">stackoverflow&lt;/a>ä¸Šçš„ç¤ºä¾‹ä»£ç ã€‚&lt;/p></description></item><item><title>Dockerå¿«é€Ÿæ„å»ºCassandraå’ŒJavaæ“ä½œ</title><link>https://atbug.com/java-operate-cassandra-deployed-in-docker/</link><pubDate>Thu, 18 May 2017 23:33:24 +0000</pubDate><guid>https://atbug.com/java-operate-cassandra-deployed-in-docker/</guid><description>
&lt;h3 id="æ­å»ºcassandra">æ­å»ºCassandra&lt;/h3>
&lt;p>ä½¿ç”¨dockeråˆ›å»ºCassandraï¼Œæ–¹ä¾¿å¿«æ·&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker pull cassandra:latest
docker run -d --name cassandra -p 9042:9042 cassandra
docker &lt;span class="nb">exec&lt;/span> -it cassandra bash
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ›å»ºkeyspacetable">åˆ›å»ºkeyspaceã€table&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-cql" data-lang="cql">&lt;span class="o">#&lt;/span>&lt;span class="n">cqlsh&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="o">#&lt;/span>&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">keyspace&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEYSPACE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">contacts&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WITH&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">REPLICATION&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;class&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;SimpleStrategy&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;replication_factor&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mf">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">};&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="o">#&lt;/span>&lt;span class="k">use&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">USE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">contacts&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="o">#&lt;/span>&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">table&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">contact&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">UUID&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">email&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">TEXT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="æŸ¥çœ‹è¡¨æ•°æ®">æŸ¥çœ‹è¡¨æ•°æ®&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">cqlsh:contacts&amp;gt; SELECT * FROM contact&lt;span class="p">;&lt;/span>
email &lt;span class="p">|&lt;/span> id
-------+----
&lt;span class="o">(&lt;/span>&lt;span class="m">0&lt;/span> rows&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="javaå®¢æˆ·ç«¯">Javaå®¢æˆ·ç«¯&lt;/h3>
&lt;h4 id="å¼•å…¥ä¾èµ–">å¼•å…¥ä¾èµ–&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.datastax.cassandra&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>cassandra-driver-core&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>3.2.0&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="è¿æ¥åˆ°cassandraå¹¶æ’å…¥æ•°æ®">è¿æ¥åˆ°Cassandraå¹¶æ’å…¥æ•°æ®&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">Cluster&lt;/span> &lt;span class="n">cluster&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Cluster&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">addContactPoint&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;127.0.0.1&amp;#34;&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">Session&lt;/span> &lt;span class="n">session&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cluster&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">connect&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;contacts&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">String&lt;/span> &lt;span class="n">insert&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;INSERT INTO contact (id, email) &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;span class="s">&amp;#34;VALUES (&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;span class="s">&amp;#34;bd297650-2885-11e4-8c21-0800200c9a66,&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;span class="s">&amp;#34;&amp;#39;contact@example.com&amp;#39; &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;span class="s">&amp;#34;);&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">insert&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="æŸ¥çœ‹è¡¨æ•°æ®-1">æŸ¥çœ‹è¡¨æ•°æ®&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">cqlsh:contacts&amp;gt; SELECT * FROM contact&lt;span class="p">;&lt;/span>
email &lt;span class="p">|&lt;/span> id
---------------------+--------------------------------------
contact@example.com &lt;span class="p">|&lt;/span> bd297650-2885-11e4-8c21-0800200c9a66
&lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> rows&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>ä»é›¶å¼€å§‹ç”¨dockerè¿è¡Œspring bootåº”ç”¨</title><link>https://atbug.com/run-spring-boot-app-in-docker/</link><pubDate>Thu, 20 Apr 2017 21:58:42 +0000</pubDate><guid>https://atbug.com/run-spring-boot-app-in-docker/</guid><description>
&lt;p>å‡è®¾å·²ç»å®‰è£…å¥½Docker&lt;/p>
&lt;h3 id="springbootåº”ç”¨">Springbootåº”ç”¨&lt;/h3>
&lt;h4 id="pomæ·»åŠ ä¾èµ–å’Œæ„å»ºæ’ä»¶">pomæ·»åŠ ä¾èµ–å’Œæ„å»ºæ’ä»¶&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="nt">&amp;lt;parent&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.boot&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-boot-starter-parent&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>1.5.3.RELEASE&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/parent&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;dependencies&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.boot&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-boot-starter-web&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/dependencies&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;build&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;plugins&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;plugin&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.boot&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-boot-maven-plugin&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/plugin&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/plugins&amp;gt;&lt;/span>
&lt;span class="nt">&amp;lt;/build&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="åº”ç”¨ä»£ç ">åº”ç”¨ä»£ç &lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">package&lt;/span> &lt;span class="nn">com.atbug.spring.boot.test&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">org.springframework.boot.SpringApplication&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">org.springframework.boot.web.servlet.FilterRegistrationBean&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">org.springframework.context.annotation.Bean&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">org.springframework.web.bind.annotation.RequestMapping&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">org.springframework.web.bind.annotation.RestController&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Created by addo on 2017/5/15.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="nd">@SpringBootApplication&lt;/span>
&lt;span class="nd">@RestController&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Application&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@RequestMapping&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">home&lt;/span>&lt;span class="o">(){&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;Hello world!&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">SpringApplication&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">run&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Application&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="åº”ç”¨æ„å»º">åº”ç”¨æ„å»º&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">mvn clean package
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="centos-7-with-java8">Centos 7 with Java8&lt;/h3>
&lt;h4 id="è·å–centos7-é•œåƒ">è·å–Centos7 é•œåƒ&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker pull centos:7
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å‡†å¤‡centos-java8çš„dockerfile">å‡†å¤‡centos-java8çš„dockerfile&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">FROM centos:7
MAINTAINER Addo Zhang &lt;span class="s2">&amp;#34;duwasai@gmail.com&amp;#34;&lt;/span>
&lt;span class="c1"># Set correct environment variables.&lt;/span>
ENV HOME /root
ENV LANG en_US.UTF-8
ENV LC_ALL en_US.UTF-8
RUN yum install -y curl&lt;span class="p">;&lt;/span> yum upgrade -y&lt;span class="p">;&lt;/span> yum update -y&lt;span class="p">;&lt;/span> yum clean all
ENV JDK_VERSION 8u11
ENV JDK_BUILD_VERSION b12
RUN curl -LO &lt;span class="s2">&amp;#34;http://download.oracle.com/otn-pub/java/jdk/&lt;/span>&lt;span class="nv">$JDK_VERSION&lt;/span>&lt;span class="s2">-&lt;/span>&lt;span class="nv">$JDK_BUILD_VERSION&lt;/span>&lt;span class="s2">/jdk-&lt;/span>&lt;span class="nv">$JDK_VERSION&lt;/span>&lt;span class="s2">-linux-x64.rpm&amp;#34;&lt;/span> -H &lt;span class="s1">&amp;#39;Cookie: oraclelicense=accept-securebackup-cookie&amp;#39;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> rpm -i jdk-&lt;span class="nv">$JDK_VERSION&lt;/span>-linux-x64.rpm&lt;span class="p">;&lt;/span> rm -f jdk-&lt;span class="nv">$JDK_VERSION&lt;/span>-linux-x64.rpm&lt;span class="p">;&lt;/span> yum clean all
ENV JAVA_HOME /usr/java/default
RUN yum remove curl&lt;span class="p">;&lt;/span> yum clean all
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="åˆ›å»ºcentos-java8é•œåƒ">åˆ›å»ºcentos-java8é•œåƒ&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker build -t addo/centos-java8 .
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="dockerä¸­è¿è¡Œåº”ç”¨">Dockerä¸­è¿è¡Œåº”ç”¨&lt;/h3>
&lt;h4 id="å‡†å¤‡åº”ç”¨é•œåƒçš„dockerfile">å‡†å¤‡åº”ç”¨é•œåƒçš„dockerfile&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">FROM addo/centos-java8
ADD target/boot-test-1.0-SNAPSHOT.jar /opt/app.jar
EXPOSE &lt;span class="m">8080&lt;/span>
CMD java -jar /opt/app.jar
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="æ„å»ºåº”ç”¨é•œåƒ">æ„å»ºåº”ç”¨é•œåƒ&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker build -t temp/spring-boot-app .
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="è¿è¡Œ">è¿è¡Œ&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">docker run --name spring-boot-app -p 8080:8080 temp/spring-boot-app
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Jasig CAS Web and Proxy flow</title><link>https://atbug.com/jasig-cas-web-and-proxy-flow/</link><pubDate>Tue, 18 Apr 2017 10:36:16 +0000</pubDate><guid>https://atbug.com/jasig-cas-web-and-proxy-flow/</guid><description>
&lt;p>æœ€è¿‘å› ä¸ºéœ€æ±‚åœ¨çœ‹CASç›¸å…³çš„åªæ˜¯ï¼Œç”±äºéœ€è¦åç«¯è°ƒç”¨ï¼Œç”¨åˆ°proxyï¼ˆä»£ç†ï¼‰æ¨¡å¼ã€‚æ•´ç†äº†ä¸‹web flowå’Œproxy web flowçš„æµç¨‹ã€‚&lt;/p>
&lt;h2 id="web-flow">Web Flow&lt;/h2>
&lt;p>&lt;img src="./media/CAS-Service-Ticket.jpg" alt="Web Flow">&lt;/p>
&lt;h2 id="proxy-web-flow">Proxy Web Flow&lt;/h2>
&lt;p>&lt;img src="./media/CAS-Proxy-Ticket.jpg" alt="Proxy Web Flow">&lt;/p></description></item><item><title>MetaspaceSizeçš„å‘</title><link>https://atbug.com/java8-metaspace-size-issue/</link><pubDate>Thu, 13 Apr 2017 11:55:14 +0000</pubDate><guid>https://atbug.com/java8-metaspace-size-issue/</guid><description>
&lt;p>è¿™å‡ å¤©ç”Ÿäº§ä¸Šæœ‰å°æœºå™¨çš„Metaspaceä¸€ç›´åœ¨å‘Šè­¦ï¼ŒMetaspaceä½¿ç”¨è¾¾åˆ°äº†97%ã€‚ä½¿ç”¨&lt;code>-XX:MetaspaceSize=512m&lt;/code>ï¼Œå‘Šè­¦ä¹Ÿè¿˜åœ¨åœ¨æŒç»­ï¼ŒæŸ¥çœ‹MCåªæœ‰81536.0ï¼Œæ˜¾ç„¶è¿™ä¸ªå‚æ•°æ²¡èµ·ä½œç”¨ã€‚&lt;/p>
&lt;p>ä¹Ÿæœ‰äººé‡åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼Œå¹¶åœ¨openjdkä¸Šæè¿‡ç±»ä¼¼çš„bugï¼Œå…¶å®æ˜¯ä¸€ä¸ªæ³¨é‡Šçš„bugï¼Œæœ€ç»ˆåœ¨&lt;a href="https://bugs.openjdk.java.net/browse/JDK-8151845">JDK-8151845&lt;/a>ä¸­ä¿®å¤äº†ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Class metadata is deallocated when the corresponding Java class is unloaded. Java classes are unloaded as a result of garbage collection, and garbage collections may be induced in order to unload classes and deallocate class metadata. When the space committed for class metadata reaches a certain level (a high-water mark), a garbage collection is induced. After the garbage collection, the high-water mark may be raised or lowered depending on the amount of space freed from class metadata. The high-water mark would be raised so as not to induce another garbage collection too soon. The high-water mark is initially set to the value of the command-line option MetaspaceSize. It is raised or lowered based on the options MaxMetaspaceFreeRatio and MinMetaspaceFreeRatio. If the committed space available for class metadata as a percentage of the total committed space for class metadata is greater than MaxMetaspaceFreeRatio, then the high-water mark will be lowered. If it is less than MinMetaspaceFreeRatio, then the high-water mark will be raised.&lt;/p>
&lt;/blockquote>
&lt;p>æŸ¥çœ‹äº†Oracleçš„æ‰‹å†Œï¼ŒMetaspaceçš„GCä¼šåœ¨committed sizeè¾¾åˆ°high-water markä¹‹åå‘ç”Ÿã€‚å¹¶ä¸”GCä¹‹åhigh-water markä¼šå˜åŒ–ï¼šå˜å¤§æˆ–è€…å˜å°ï¼Œå˜å¤§çš„è¯ä¼šé˜²æ­¢ä¸‹æ¬¡GCå‘ç”Ÿå¾—å¤ªæ—©ã€‚high-water markçš„é»˜è®¤åˆå§‹å¤§å°20.8Mï¼Œé€šè¿‡&lt;strong>MetaspaceSize&lt;/strong>æ¥è®¾ç½®ï¼Œå¯è§MetaspaceSizeæ˜¯æ§åˆ¶Metaspaceå‘ç”ŸGCçš„é˜ˆå€¼ã€‚GCåhigh-water markçš„å˜åŒ–ï¼Œé€šè¿‡MaxMetaspaceFreeRatioå’ŒMinMetaspaceFreeRatioæ§åˆ¶ã€‚&lt;/p>
&lt;p>MaxMetaspaceSizeé»˜è®¤ä¸º-1ï¼Œæ— é™å¤§ã€‚ä¸è¿‡å¦‚æœæ²¡æœ‰é™åˆ¶çš„è¯ï¼Œä¸€ç›´å¢å¤§ä¼šè¢«ç³»ç»Ÿå¹²æ‰è¿›ç¨‹ã€‚æœ€å¥½è¿˜æ˜¯è®¾ç½®ä¸€ä¸‹ï¼Œæ¯”å¦‚1Gã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯æˆ‘æµ‹è¯•äº†åˆ†åˆ«è®¾ç½®MetaspaceSizeã€MaxMetaspaceSizeã€InitialBootClassLoaderMetaspaceSizeä¸º1Gï¼ŒMetaspaceçš„å˜åŒ–ã€‚&lt;/p>
&lt;p>&lt;code>-XX:MetaspaceSize=1024m&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>committed: 29360128
init: 0
max: -1
used: 28440648&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>-XX:MaxMetaspaceSize=1024m&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>committed: 29360128
init: 0
max: 1073741824
used: 28503552&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>-XX:InitialBootClassLoaderMetaspaceSize=1024m&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>committed: 1087635456
init: 0
max: -1
used: 28500344&lt;/p>
&lt;/blockquote>
&lt;p>ä¸‰ä¸ªå‚æ•°éƒ½æ˜¯æ²¡æœ‰æ”¹å˜initçš„å¤§å°ï¼Œä½†æ˜¯InitialBootClassLoaderMetaspaceSizeæ”¹å˜äº†committedçš„å¤§å°ï¼Œå…¶å®ä¹Ÿæ˜¯æœ€ç»ˆæˆ‘ä»¬è¦çš„è®¾ç½®ã€‚&lt;/p>
&lt;p>å…³äºè¿™ä¸ªå‚æ•°ï¼Œå¯ä»¥çœ‹ä½ å‡ç¬¨çš„å…³äº&lt;a href="http://lovestblog.cn/blog/2016/10/29/metaspace/">Metaspaceçš„æºç è§£è¯»&lt;/a>ï¼Œå‘ç°çš„æœ‰ç‚¹æ™šäº†ã€‚&lt;/p>
&lt;p>æœ€åçš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨è¿™ä¸ªé…ç½®ï¼š&lt;code>-XX:MaxMetaspaceSize=1024m -XX:InitialBootClassLoaderMetaspaceSize=256m&lt;/code>ã€‚&lt;/p></description></item><item><title>ä¸€ä¸ªTomcatç±»åŠ è½½é—®é¢˜</title><link>https://atbug.com/one-tomcat-class-load-issue/</link><pubDate>Wed, 12 Apr 2017 10:40:01 +0000</pubDate><guid>https://atbug.com/one-tomcat-class-load-issue/</guid><description>
&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>ä¸€ä¸ªTomcatå®ä¾‹ä¸­è¿è¡Œäº†ä¸‰ä¸ªåº”ç”¨ï¼Œå…¶ä¸­ä¸€ä¸ªå¯¹æ¥äº†Apereoçš„CASç³»ç»Ÿã€‚ç°åœ¨è¦æ±‚å¦å¤–ä¸¤ä¸ªç³»ç»Ÿä¹Ÿå¯¹æ¥CASç³»ç»Ÿï¼Œé—®é¢˜å°±å‡ºç°äº†ï¼š&lt;/p>
&lt;blockquote>
&lt;p>åº”ç”¨å¯åŠ¨åæ‰“å¼€å…¶ä¸­ä¸¤ä¸ªåº”ç”¨çš„ä»»ä½•ä¸€ä¸ªï¼Œç™»å½•å®Œæˆåç³»ç»Ÿéƒ½æ²¡æœ‰é—®é¢˜ã€‚å”¯ç‹¬é¦–é€‰æ‰“å¼€ç¬¬ä¸‰ä¸ªï¼Œå…¶ä»–ä¸¤ä¸ªæŠ¥é”™ClassNotFoundException: org.apache.xerces.parsers.SAXParserã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å‘ç°è¿™ä¸ªç±»æ¥è‡ª&lt;code>xerces:xercesImpl:jar:2.6.2&lt;/code>ï¼Œä½¿ç”¨&lt;code>mvn dependency:tree&lt;/code>å‘ç°æ˜¯è¢«xom:xom:1.1ç®€æ´å¼•ç”¨ã€‚&lt;/p>
&lt;h2 id="åˆ†æ">åˆ†æ&lt;/h2>
&lt;p>CAS client jarä¸­ä½¿ç”¨XMLReaderFactoryåˆ›å»ºXMLReaderï¼Œé¦–æ¬¡åˆ›å»ºä¼šä»classpathä¸­æŸ¥æ‰¾&lt;code>META-INF/services/org.xml.sax.driver&lt;/code>æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œçš„å†…å®¹æ˜¯ä¸€ä¸ªç±»çš„å…¨åã€‚æ¯”å¦‚xercesImplä¸­è¯¥æ–‡ä»¶çš„å†…å®¹æ˜¯&lt;code>org.apache.xerces.parsers.SAXParser&lt;/code>ã€‚&lt;/p>
&lt;p>æ‰¾åˆ°ä¹‹åä¼šå°†ç±»åä¿å­˜åœ¨XMLReaderFactoryçš„é™æ€å˜é‡_clsFromJarï¼Œå¹¶æ ‡è®°ä¸ä¼šå†æŸ¥æ‰¾org.xml.sax.driveræ–‡ä»¶ã€‚æ‰¾ä¸åˆ°çš„è¯åˆ™ä½¿ç”¨&lt;code>com.sun.org.apache.xerces.internal.parsers.SAXParser&lt;/code>ç±»ã€‚&lt;/p>
&lt;p>ç„¶åå†ä½¿ç”¨å½“å‰çº¿ç¨‹çš„ContextClassLoaderå¯¹ç±»è¿›è¡ŒåŠ è½½ï¼Œè¿™é‡Œçš„çš„ContextClassLoaderæ˜¯ä¸€ä¸ªWebAppClassLoaderçš„å®ä¾‹ã€‚&lt;/p>
&lt;p>åŒæ—¶XMLReaderFactoryç±»æ˜¯è¢«BootStrapClassLoaderåŠ è½½çš„ï¼Œä¸ºä¸‰ä¸ªåº”ç”¨å…±äº«ã€‚&lt;/p>
&lt;h2 id="tomcatç±»è®°è½½æœºåˆ¶">Tomcatç±»è®°è½½æœºåˆ¶&lt;/h2>
&lt;p>Tomcatä¸­æœ‰å››ä¸ªä½ç½®å¯ä»¥å­˜æ”¾Javaç±»åº“ï¼š/commonsã€/serverã€/sharedå’Œå„Webåº”ç”¨çš„WEB-INF/libç›®å½•ã€‚&lt;/p>
&lt;blockquote>
&lt;p>/commonsç›®å½•ä¸­çš„ç±»åº“å¯ä»¥è¢«Tomcatå’Œæ‰€æœ‰Webåº”ç”¨ä½¿ç”¨
/serverç›®å½•ä¸­çš„ç±»åº“åªèƒ½è¢«Tomcatä½¿ç”¨
/sharedç›®å½•ä¸­çš„å¯ä»¥è¢«æ‰€æœ‰Webåº”ç”¨çš„ä½¿ç”¨ï¼Œä½†æ˜¯å¯¹Tomcatä¸å¯è§
å„Webåº”ç”¨çš„WEB-INF/libç›®å½•ä¸­çš„ç±»åº“åˆ™åªèƒ½è¢«è¯¥çš„åº”ç”¨ä½¿ç”¨&lt;/p>
&lt;/blockquote>
&lt;p>Tomcatçš„ä½¿ç”¨CommonClassLoaderã€CatalinaClassLoaderã€SharedClassLoaderã€WebAPPClassLoaderåŠ è½½å¯¹åº”ç›®å½•ä¸­çš„ç±»åº“ã€‚&lt;/p>
&lt;p>Bootstrapã€Extensionã€Applicationæ˜¯è™šæ‹Ÿæœºä½¿ç”¨çš„ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚&lt;/p>
&lt;p>ç±»çš„åŠ è½½ä½¿ç”¨åŒäº²å§”æ´¾æœºåˆ¶(Parent-Delegation)ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback"> Bootstrap
|
Extension
|
Application
|
System
|
Common
/ \
Catalina Shared
/ \
WebApp1 ... WebApp2
| |
Jasper Jasper
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ&lt;/h2>
&lt;p>åœ¨å¦å¤–ä¸¤ä¸ªåº”ç”¨ä¸­æ·»åŠ &lt;code>xerces:xercesImpl:jar:2.6.2&lt;/code>ä¾èµ–ã€‚&lt;/p></description></item><item><title>Scalaç¬”è®°ï¼šç”¨å‡½æ•°å­—é¢é‡å—è°ƒç”¨é«˜é˜¶å‡½æ•°</title><link>https://atbug.com/call-high-order-function-in-function-literal/</link><pubDate>Tue, 11 Apr 2017 10:15:15 +0000</pubDate><guid>https://atbug.com/call-high-order-function-in-function-literal/</guid><description>
&lt;p>è¿™é‡Œä¼šç”¨åˆ°å‡ ä¸ªæ¦‚å¿µé«˜é˜¶å‡½æ•°ã€å‡½æ•°å­—é¢é‡ã€å‚æ•°ç»„&lt;/p>
&lt;h2 id="é«˜é˜¶å‡½æ•°">é«˜é˜¶å‡½æ•°&lt;/h2>
&lt;p>high-order function å‡½æ•°çš„ä¸€ç§ï¼Œç®€å•æ¥è¯´å®ƒåŒ…å«äº†ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å‚æ•°æˆ–è€…è¿”å›å€¼ã€‚&lt;/p>
&lt;p>æ‰€è°“çš„é«˜é˜¶æ˜¯è·Ÿä¸€é˜¶å‡½æ•°ç›¸æ¯”ï¼Œæ·±å…¥ä¸€ä¸‹ï¼š&lt;/p>
&lt;blockquote>
&lt;ol>
&lt;li>ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°æ˜¯å‡½æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå€¼ã€‚&lt;/li>
&lt;li>è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ²¡æœ‰å‚æ•°æ˜¯å‡½æ•°ã€‚&lt;/li>
&lt;li>ä¸Šè¿°ä¸¤è€…å åŠ ï¼šä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°æ˜¯å‡½æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå‡½æ•°ã€‚&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>ç¤ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-scala" data-lang="scala">&lt;span class="k">def&lt;/span> &lt;span class="n">stringSafeOp&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="k">:&lt;/span> &lt;span class="kt">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="k">:&lt;/span> &lt;span class="kt">String&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nc">String&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="n">s&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//stringSafeOp: (s: String, f: String =&amp;gt; String)String
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">def&lt;/span> &lt;span class="n">reverse&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="k">:&lt;/span> &lt;span class="kt">String&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reverse&lt;/span>
&lt;span class="c1">//reverse: (s: String)String
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">stringSafeOp&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Ready&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">reverse&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="c1">//res86: String = ydaeR
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‡½æ•°å­—é¢é‡">å‡½æ•°å­—é¢é‡&lt;/h2>
&lt;p>function literalï¼Œå…¶ä»–åå­—ï¼šåŒ¿åå‡½æ•°ã€Lambdaè¡¨è¾¾å¼ç­‰ã€‚
å‡½æ•°å­—é¢é‡å¯ä»¥å­˜å‚¨åœ¨å‡½æ•°å€¼å’Œå˜é‡ä¸­ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥å®šä¹‰ä¸ºé«˜é˜¶å‡½æ•°è°ƒç”¨çš„ä¸€éƒ¨åˆ†ã€‚åœ¨ä»»ä½•æ¥å—å‡½æ•°ç±»å‹çš„åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨å‡½æ•°å­—é¢é‡ã€‚&lt;/p>
&lt;p>reverseçš„å‡½æ•°å­—é¢é‡å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-scala" data-lang="scala">&lt;span class="k">val&lt;/span> &lt;span class="n">reverse&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="k">:&lt;/span>&lt;span class="kt">String&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">=&amp;gt;&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reverse&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>(s:String) =&amp;gt; s.reverse&lt;/code>å®šä¹‰äº†ä¸€ä¸ªæœ‰ç±»å‹çš„è¾“å…¥å‚æ•°ï¼ˆs:Stringï¼‰å’Œå‡½æ•°ä½“ï¼ˆs.reverseï¼‰ã€‚&lt;/p>
&lt;p>å®šä¹‰ä¸ºé«˜é˜¶å‡½æ•°è°ƒç”¨çš„ä¸€éƒ¨åˆ†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-scala" data-lang="scala">&lt;span class="n">stringSafeOp&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Ready&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="k">:&lt;/span>&lt;span class="kt">String&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">=&amp;gt;&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reverse&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±äºå·²ç»å®šä¹‰äº†å‚æ•°fçš„ç±»å‹&lt;code>String =&amp;gt; String&lt;/code>ï¼Œå¯ä»¥ä»å‡½æ•°å­—é¢é‡ä¸­åˆ é™¤æ˜¾ç¤ºç±»å‹ï¼Œäº¤ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼å…¶ç±»å‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-scala" data-lang="scala">&lt;span class="n">stringSafeOp&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Ready&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="k">=&amp;gt;&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reverse&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å ä½ç¬¦è¯­æ³•">å ä½ç¬¦è¯­æ³•&lt;/h3>
&lt;p>Placeholder syntaxæ˜¯å‡½æ•°å­—é¢é‡çš„ä¸€ç§ç¼©å†™å½¢å¼ï¼Œå°†å‘½åå‚æ•°æ›¿æ¢ä¸ºé€šé…ç¬¦ï¼ˆ_ï¼‰ã€‚&lt;/p>
&lt;p>ä½¿ç”¨æ¡ä»¶ï¼š&lt;/p>
&lt;blockquote>
&lt;p>å‡½æ•°çš„æ˜¾ç¤ºç±»å‹åœ¨å­—é¢é‡ä¹‹å¤–æŒ‡å®š&lt;/p>
&lt;p>å‚æ•°æœ€å¤šåªä½¿ç”¨ä¸€æ¬¡&lt;/p>
&lt;/blockquote>
&lt;p>å‰é¢çš„ä¾‹å­æ­£å¥½ç¬¦åˆæ¡ä»¶ï¼š&lt;/p>
&lt;blockquote>
&lt;p>stringSafeOpå®šä¹‰ä¸­æŒ‡å®šäº†å­—é¢é‡çš„ç±»å‹ï¼ˆå­—é¢é‡ä¹‹å¤–ï¼‰ &lt;code>String =&amp;gt; String&lt;/code>&lt;/p>
&lt;p>å‚æ•°såªä½¿ç”¨ä¸€æ¬¡ &lt;code>s.reverse&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-scala" data-lang="scala">&lt;span class="n">stringSafeOp&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Ready&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">_&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reverse&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‚æ•°ç»„">å‚æ•°ç»„&lt;/h2>
&lt;p>parameter groups å‡½æ•°çš„å‚æ•°åˆ—è¡¨çš„å¦ä¸€ç§å½¢å¼ï¼šåˆ†è§£å¹¶ä½¿ç”¨å°æ‹¬å·åˆ†éš”ã€‚&lt;/p>
&lt;p>stringSafeOpçš„å‚æ•°ç»„è¡¨ç¤ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-scala" data-lang="scala">&lt;span class="k">def&lt;/span> &lt;span class="n">stringSafeOp&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="k">:&lt;/span> &lt;span class="kt">String&lt;/span>&lt;span class="o">)(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="k">:&lt;/span> &lt;span class="kt">String&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nc">String&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="n">s&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//stringSafeOp: (s: String)(f: String =&amp;gt; String)String
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ç”¨å‡½æ•°å­—é¢é‡å—è°ƒç”¨é«˜é˜¶å‡½æ•°">ç”¨å‡½æ•°å­—é¢é‡å—è°ƒç”¨é«˜é˜¶å‡½æ•°&lt;/h2>
&lt;p>ç»„åˆä¸Šé¢çš„ç‰¹æ€§ï¼Œå°±æœ‰äº†&lt;strong>ç”¨å‡½æ•°å­—é¢é‡å—è°ƒç”¨é«˜é˜¶å‡½æ•°&lt;/strong>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-scala" data-lang="scala">&lt;span class="k">val&lt;/span> &lt;span class="n">newStringSafeOp&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="n">stringSafeOp&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Ready&amp;#34;&lt;/span>&lt;span class="o">){&lt;/span>&lt;span class="k">_&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reverse&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è¿›é˜¶">è¿›é˜¶&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-scala" data-lang="scala">&lt;span class="k">def&lt;/span> &lt;span class="n">timer&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="kt">A&lt;/span>&lt;span class="o">](&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="k">:&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="n">A&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="n">now&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="nc">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">currentTimeMillis&lt;/span>
&lt;span class="k">val&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="n">now&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="k">val&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="k">val&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="n">now&lt;/span>
&lt;span class="n">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">s&amp;#34;Executed int &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="n">end&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s"> ms&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">a&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">val&lt;/span> &lt;span class="n">veryRandomAmount&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="n">timer&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">util&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nc">Random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setSeed&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nc">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">currentTimeMillis&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="k">&amp;lt;-&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="mi">100000&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">util&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nc">Random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nextDouble&lt;/span>
&lt;span class="n">util&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nc">Random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nextDouble&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>timeræ–¹æ³•å¯¹æ–¹æ³•è°ƒç”¨è¿›è¡Œæ—¶é—´è®°å½•ï¼Œå¯¹ç›®æ ‡ä»£ç æ²¡æœ‰ä¾µå…¥æ€§ã€‚&lt;/p></description></item><item><title>GreenPlum JDBCå’ŒC3P0æ•°æ®æº</title><link>https://atbug.com/greenplum-jdbc-and-c3p0-datasource/</link><pubDate>Mon, 10 Apr 2017 08:29:00 +0000</pubDate><guid>https://atbug.com/greenplum-jdbc-and-c3p0-datasource/</guid><description>
&lt;p>åœ¨ç½‘ä¸Šæœç´¢GreenPlumï¼ˆGPDBï¼‰çš„æ•°æ®æºé…ç½®çš„æ—¶å€™ï¼Œå‘ç°æœç´¢ç»“æœéƒ½æ˜¯ç”¨postgresqlçš„é…ç½®ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">import&lt;/span> &lt;span class="nn">com.mchange.v2.c3p0.DataSources&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">javax.sql.DataSource&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">java.sql.*&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">java.util.Properties&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Created by addo on 2017/4/10.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">JDBCTest&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">POSTGRESQL_URL&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;jdbc:postgresql://192.168.56.101:5432/example&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">POSTGRESQL_USERNAME&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;dbuser&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">POSTGRESQL_PASSWORD&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">GPDB_URL&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;jdbc:pivotal:greenplum://192.168.56.101:5432;DatabaseName=test&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">GPDB_USERNAME&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;dbuser&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">GPDB_PASSWORD&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Postgresql Connection
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * @return
&lt;/span>&lt;span class="cm"> * @throws ClassNotFoundException
&lt;/span>&lt;span class="cm"> * @throws SQLException
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Connection&lt;/span> &lt;span class="nf">postgresqlConnection&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">ClassNotFoundException&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">SQLException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Class&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">forName&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;org.postgresql.Driver&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">DriverManager&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getConnection&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">POSTGRESQL_URL&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">POSTGRESQL_USERNAME&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">POSTGRESQL_PASSWORD&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * GreenPlum Connection
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * @return
&lt;/span>&lt;span class="cm"> * @throws ClassNotFoundException
&lt;/span>&lt;span class="cm"> * @throws SQLException
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Connection&lt;/span> &lt;span class="nf">gpdbConnection&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">ClassNotFoundException&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">SQLException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Class&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">forName&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;com.pivotal.jdbc.GreenplumDriver&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">DriverManager&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getConnection&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">GPDB_URL&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">GPDB_USERNAME&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">GPDB_PASSWORD&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * GreenPlud C3P0 Datasource Connection
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * @return
&lt;/span>&lt;span class="cm"> * @throws SQLException
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Connection&lt;/span> &lt;span class="nf">gpdbC3P0Connection&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">SQLException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Properties&lt;/span> &lt;span class="n">c3p0Props&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Properties&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">c3p0Props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;driverClass&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;com.pivotal.jdbc.GreenplumDriver&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">c3p0Props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;jdbcUrl&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">GPDB_URL&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">c3p0Props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;user&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">GPDB_USERNAME&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">c3p0Props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">GPDB_PASSWORD&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">c3p0Props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;acquireIncrement&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;5&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">c3p0Props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;initialPoolSize1&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">c3p0Props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;maxIdleTime&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;60&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">c3p0Props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;maxPoolSize&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;50&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">c3p0Props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;minPoolSize&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">c3p0Props&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setProperty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;idleConnectionTestPeriod&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;60&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">DataSources&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unpooledDataSource&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">GPDB_URL&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">c3p0Props&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">getConnection&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">ClassNotFoundException&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">SQLException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Connection&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">connections&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Connection&lt;/span>&lt;span class="o">[]{&lt;/span>&lt;span class="n">postgresqlConnection&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">gpdbConnection&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">gpdbC3P0Connection&lt;/span>&lt;span class="o">()};&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Connection&lt;/span> &lt;span class="n">connection&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">connections&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">CallableStatement&lt;/span> &lt;span class="n">callableStatement&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">connection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">prepareCall&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;select * from user&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kt">boolean&lt;/span> &lt;span class="n">execute&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">callableStatement&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">ResultSet&lt;/span> &lt;span class="n">resultSet&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">callableStatement&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getResultSet&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">resultSet&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">resultSet&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;current_user&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">callableStatement&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">connection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;a href="https://gist.github.com/addozhang/0d83704af6656079878bd5614c82c16c">æºä»£ç &lt;/a>&lt;/p></description></item><item><title>Scalaç¬”è®°ï¼šdef VS val</title><link>https://atbug.com/def-vs-val-in-scala/</link><pubDate>Sun, 09 Apr 2017 08:24:40 +0000</pubDate><guid>https://atbug.com/def-vs-val-in-scala/</guid><description>
&lt;h2 id="å…ˆè¯´åŸç†">å…ˆè¯´åŸç†ï¼š&lt;/h2>
&lt;blockquote>
&lt;p>valä¿®é¥°çš„åœ¨å®šä¹‰çš„æ—¶å€™æ‰§è¡Œ&lt;/p>
&lt;p>defä¿®é¥°çš„åœ¨è°ƒç”¨çš„æ—¶å€™æ‰§è¡Œ&lt;/p>
&lt;/blockquote>
&lt;h2 id="ç›´è§‚çš„ä¾‹å­">ç›´è§‚çš„ä¾‹å­ï¼š&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-scala" data-lang="scala">&lt;span class="c1">//æ³¨é‡Šçš„è¡Œä¸ºREPLè¾“å‡º
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">def&lt;/span> &lt;span class="n">test&lt;/span>&lt;span class="k">:&lt;/span> &lt;span class="o">()&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nc">Int&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;def called&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">val&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="n">util&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nc">Random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nextInt&lt;/span>
&lt;span class="o">()&lt;/span> &lt;span class="k">=&amp;gt;&lt;/span> &lt;span class="n">r&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//test: () =&amp;gt; Int
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="c1">//def called
&lt;/span>&lt;span class="c1">//res82: Int = -950077410
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="n">test&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="c1">//def called
&lt;/span>&lt;span class="c1">//res83: Int = 1027028032
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="k">val&lt;/span> &lt;span class="n">test&lt;/span>&lt;span class="k">:&lt;/span> &lt;span class="o">()&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nc">Int&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;def called&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">val&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="n">util&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nc">Random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nextInt&lt;/span>
&lt;span class="o">()&lt;/span> &lt;span class="k">=&amp;gt;&lt;/span> &lt;span class="n">r&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//def called
&lt;/span>&lt;span class="c1">//test: () =&amp;gt; Int = $$Lambda$1382/338526071@42f2515d
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="n">test&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="c1">//res84: Int = 300588352
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="c1">//res84: Int = 300588352
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>defåœ¨æ–¹æ³•å®šä¹‰çš„æ—¶å€™é™¤äº†æ–°çš„æ–¹æ³•æ²¡æœ‰ä»»ä½•è¾“å‡ºï¼›ä¹‹åæ¯æ¬¡è°ƒç”¨çš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œè€Œä¸”æ˜¯æ¯æ¬¡è°ƒç”¨éƒ½è·å¾—ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼ˆrandomå€¼ä¸åŒï¼‰&lt;/p>
&lt;p>valåœ¨æ–¹æ³•å®šä¹‰çš„æ—¶å€™é™¤äº†æ–°çš„æ–¹æ³•ï¼Œè¿˜ä¼šæ‰§è¡Œå¹¶è·å¾—ä¸€ä¸ªæ–¹æ³•ï¼›ä¹‹åæ¯æ¬¡è°ƒç”¨éƒ½åªæ˜¯æ‰§è¡Œäº†å®šä¹‰çš„æ—¶å€™è·å¾—çš„æ–¹æ³•ï¼ˆ() =&amp;gt; rï¼Œrå€¼å›ºå®šï¼‰&lt;/p>
&lt;/blockquote>
&lt;h3 id="è¿›é˜¶">è¿›é˜¶&lt;/h3>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-scala" data-lang="scala">&lt;span class="k">def&lt;/span> &lt;span class="n">timer&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="kt">A&lt;/span>&lt;span class="o">](&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="k">:&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="n">A&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="n">now&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="nc">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">currentTimeMillis&lt;/span>
&lt;span class="k">val&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="n">now&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="k">val&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="k">val&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="n">now&lt;/span>
&lt;span class="n">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">s&amp;#34;Executed int &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="n">end&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s"> ms&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">a&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">val&lt;/span> &lt;span class="n">veryRandomAmount&lt;/span> &lt;span class="k">=&lt;/span> &lt;span class="n">timer&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">util&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nc">Random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setSeed&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nc">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">currentTimeMillis&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="k">&amp;lt;-&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="mi">100000&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">util&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nc">Random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nextDouble&lt;/span>
&lt;span class="n">util&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nc">Random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nextDouble&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹è¿‡ä¸Šé¢çš„ä¾‹å­å°±ä¸éš¾ç†è§£äº†ï¼Œé‡æ–°å®šä¹‰nowæ˜¯ä¸ºäº†ä½¿ç”¨ç®€æ´ä¼˜é›…çš„æ–¹å¼è·å–å½“å‰æ¯«ç§’æ•°ã€‚&lt;/p>
&lt;ol>
&lt;li>&lt;code>val start = now;&lt;/code> ç”¨valä¿®é¥°ï¼Œè®°å½•æ–¹æ³•æ‰§è¡Œå‰çš„æ—¶é—´åˆ°startä¸­ã€‚&lt;/li>
&lt;li>&lt;code>val a = f&lt;/code> ç”¨valä¿®é¥°ï¼Œæ‰§è¡Œfæ–¹æ³•ï¼Œå¹¶ä¿å­˜æ•°æ®åˆ°aä¸­ã€‚&lt;/li>
&lt;li>&lt;code>val end = now&lt;/code> ç”¨vlaä¿®é¥°ï¼Œè®°å½•æ–¹æ³•æ‰§è¡Œç»“æŸæ—¶é—´åˆ°endä¸­ã€‚&lt;/li>
&lt;li>æœ€åè¿”å›aï¼Œ&lt;/li>
&lt;/ol></description></item><item><title>Centosç¼–è¯‘å®‰è£…Redis</title><link>https://atbug.com/install-redis-on-centos/</link><pubDate>Fri, 07 Apr 2017 16:48:46 +0000</pubDate><guid>https://atbug.com/install-redis-on-centos/</guid><description>
&lt;h4 id="ç‰ˆæœ¬">ç‰ˆæœ¬&lt;/h4>
&lt;blockquote>
&lt;p>Centos7&lt;/p>
&lt;p>Redis3.2.8&lt;/p>
&lt;/blockquote>
&lt;h4 id="ç¼–è¯‘å®‰è£…">ç¼–è¯‘å®‰è£…&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">wget http://download.redis.io/releases/redis-3.2.8.tar.gz
tar -zxvf redis-3.2.8.tar.gz
&lt;span class="nb">cd&lt;/span> redis-3.2.8
sudo make &lt;span class="nb">test&lt;/span>
sudo make install
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="å¯åŠ¨">å¯åŠ¨&lt;/h4>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">redis-server
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="é—®é¢˜">é—®é¢˜&lt;/h4>
&lt;ol>
&lt;li>
&lt;p>&lt;code>/bin/sh: cc: command not found&lt;/code>&lt;/p>
&lt;p>**åŸå› ï¼š**Centoså®‰è£…æ—¶é€‰æ‹©çš„ç±»å‹æ˜¯Infrastructureï¼Œæ²¡æœ‰c++çš„ç¼–è¯‘å·¥å…·ã€‚&lt;/p>
&lt;p>&lt;strong>è§£å†³ï¼š&lt;/strong>&lt;code>sudo yum -y install gcc gcc-c++ libstdc++-devel&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>malloc.h:50:31: fatal error: jemalloc/jemalloc.h: No such file or directory&lt;/code>&lt;/p>
&lt;p>**åŸå› ï¼š**Redisä½¿ç”¨çš„é»˜è®¤çš„memory allocatoræ˜¯libcï¼Œè€ŒLinuxç³»ç»Ÿä¸­é»˜è®¤çš„æ˜¯jemallocï¼Œéœ€è¦åˆ¶åŠ¨&lt;code>MALLOC&lt;/code>å˜é‡ã€‚&lt;/p>
&lt;p>&lt;strong>è§£å†³ï¼š&lt;/strong>&lt;code>sudo make MALLOC=libc install&lt;/code>&lt;/p>
&lt;/li>
&lt;/ol></description></item><item><title>Centosä¸Šå®‰è£…Postgresql</title><link>https://atbug.com/install-postgresql-on-centos/</link><pubDate>Thu, 06 Apr 2017 22:54:17 +0000</pubDate><guid>https://atbug.com/install-postgresql-on-centos/</guid><description>
&lt;h4 id="ç‰ˆæœ¬">ç‰ˆæœ¬&lt;/h4>
&lt;p>Centos7&lt;/p>
&lt;p>Postgresql9.2&lt;/p>
&lt;h4 id="enable-ssh">Enable ssh&lt;/h4>
&lt;blockquote>
&lt;p>service sshd start&lt;/p>
&lt;/blockquote>
&lt;h4 id="open-firewall-for-22">Open firewall for 22&lt;/h4>
&lt;blockquote>
&lt;p>firewall-cmd â€”state&lt;/p>
&lt;p>firewall-cmd â€”list-all&lt;/p>
&lt;p>firewall-cmd â€”permanent â€”zone=public â€”add-port=22/tcp&lt;/p>
&lt;p>firewall-cmd â€”reload&lt;/p>
&lt;/blockquote>
&lt;h4 id="install-postgresql">Install Postgresql&lt;/h4>
&lt;blockquote>
&lt;p>yum install postgres&lt;/p>
&lt;p>su postgres&lt;/p>
&lt;p>postgres â€”version&lt;/p>
&lt;/blockquote>
&lt;p>é»˜è®¤ä¼šåˆ›å»ºpostgres:postgresç”¨æˆ·å’Œç»„&lt;/p>
&lt;h4 id="åˆ‡æ¢ç”¨æˆ·">åˆ‡æ¢ç”¨æˆ·&lt;/h4>
&lt;blockquote>
&lt;p>su - postgres&lt;/p>
&lt;/blockquote>
&lt;h4 id="åˆå§‹åŒ–æ•°æ®åº“">åˆå§‹åŒ–æ•°æ®åº“&lt;/h4>
&lt;p>é€šè¿‡æŒ‡å®šæ•°æ®æ–‡ä»¶ç›®å½•åˆå§‹åŒ–db&lt;/p>
&lt;blockquote>
&lt;p>initdb -D /var/lib/pgsql/data&lt;/p>
&lt;/blockquote>
&lt;h4 id="ä¿®æ”¹ç«¯å£é˜²ç«å¢™">ä¿®æ”¹ç«¯å£é˜²ç«å¢™&lt;/h4>
&lt;p>é»˜è®¤ç«¯å£æ˜¯5432ï¼Œéœ€è¦åœ¨é˜²ç«å¢™ä¸­æ‰“å¼€ç«¯å£&lt;/p>
&lt;blockquote>
&lt;p>firewall-cmd &amp;ndash;permanent &amp;ndash;zone=public &amp;ndash;add-port=5432/tcp&lt;/p>
&lt;/blockquote>
&lt;h4 id="ä¿®æ”¹ç›‘å¬çš„ip">ä¿®æ”¹ç›‘å¬çš„ip&lt;/h4>
&lt;p>éœ€è¦å¤–éƒ¨è®¿é—®çš„è¯ï¼Œéœ€è¦ä¿®æ”¹postgresql.confä¸­çš„ç›‘å¬ipï¼Œ&amp;lsquo;0.0.0.0&amp;rsquo;å…è®¸æ‰€æœ‰ipv4çš„ipè®¿é—®ï¼Œ''::&amp;lsquo;&amp;lsquo;å…è®¸æ‰€æœ‰ipv6çš„ipè®¿é—®&lt;/p>
&lt;blockquote>
&lt;p>listen_addresses = &amp;ldquo;0.0.0.0&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;p>ä¿®æ”¹éœ€è¦é‡å¯postgresql&lt;/p>
&lt;h4 id="å¯åŠ¨">å¯åŠ¨&lt;/h4>
&lt;blockquote>
&lt;p>postgres -D /var/lib/pgsql/data &amp;gt;logfile 2&amp;gt;&amp;amp;1 &amp;amp;&lt;/p>
&lt;/blockquote>
&lt;h4 id="ç™»å½•æ§åˆ¶å°">ç™»å½•æ§åˆ¶å°&lt;/h4>
&lt;p>ä¼šä½¿ç”¨å½“å‰ç³»ç»Ÿç”¨æˆ·postgresè®¿é—®ï¼Œç³»ç»Ÿæç¤ºç¬¦ä¼šå˜æˆ&amp;rsquo;postgres=#&amp;rsquo;&lt;/p>
&lt;blockquote>
&lt;p>psql&lt;/p>
&lt;/blockquote>
&lt;p>ä¿®æ”¹å¯†ç &lt;/p>
&lt;blockquote>
&lt;p>\password postgres&lt;/p>
&lt;/blockquote>
&lt;p>åˆ›å»ºç”¨æˆ·&lt;/p>
&lt;blockquote>
&lt;p>CREATE USER dbuser WITH PASSWORD &amp;lsquo;password&amp;rsquo;;&lt;/p>
&lt;p>CREATE DATABASE example OWNER dbuser;&lt;/p>
&lt;p>GRANT ALL PRIVILEGES ON DATABASE example to dbuser;&lt;/p>
&lt;/blockquote>
&lt;h4 id="å®¢æˆ·ç«¯æƒé™é…ç½®æ–‡ä»¶">å®¢æˆ·ç«¯æƒé™é…ç½®æ–‡ä»¶&lt;/h4>
&lt;p>é»˜è®¤åªå…è®¸æœ¬åœ°å®¢æˆ·ç«¯è¿æ¥ï¼Œéœ€è¦ä¿®æ”¹pg_hba.confæ–‡ä»¶ï¼Œ&lt;/p>
&lt;blockquote>
&lt;p>host all all 127.0.0.1/32 trust&lt;/p>
&lt;p>æ”¹ä¸º&lt;/p>
&lt;p>host all all 0.0.0.0 /0 trust&lt;/p>
&lt;/blockquote>
&lt;h4 id="å®¢æˆ·ç«¯è¿æ¥">å®¢æˆ·ç«¯è¿æ¥&lt;/h4>
&lt;blockquote>
&lt;p>psql -U dbuser -d example -h 127.0.0.1 -p 5432&lt;/p>
&lt;/blockquote></description></item><item><title>Keyé•¿åº¦å¯¹Redisæ€§èƒ½å½±å“</title><link>https://atbug.com/redis-performance-key-length/</link><pubDate>Thu, 16 Mar 2017 10:37:03 +0000</pubDate><guid>https://atbug.com/redis-performance-key-length/</guid><description>
&lt;p>æœ€è¿‘Redisçš„ä½¿ç”¨ä¸­ç”¨çš„åˆ°keyå¯èƒ½æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯Redisçš„å®˜æ–¹æ–‡æ¡£æ²¡æåˆ°keyé•¿åº¦å¯¹æ€§èƒ½çš„å½±å“ï¼Œæ•…ç®€å•åšäº†ä¸ªæµ‹è¯•ã€‚&lt;/p>
&lt;h3 id="ç¯å¢ƒ">ç¯å¢ƒ&lt;/h3>
&lt;p>Rediså’Œæµ‹è¯•ç¨‹åºéƒ½æ˜¯è¿è¡Œåœ¨æœ¬åœ°ï¼Œä¸çœ‹å•æ¬¡çš„æ€§èƒ½ï¼Œåªçœ‹ä¸åŒçš„é•¿åº¦å †è¯»å†™æ€§èƒ½çš„å½±å“ã€‚&lt;/p>
&lt;h3 id="æµ‹è¯•æ–¹æ³•">æµ‹è¯•æ–¹æ³•&lt;/h3>
&lt;p>ä½¿ç”¨é•¿åº¦åˆ†åˆ«ä¸º10, 100, 500, 1000, 2500, 5000, 7500, 10,000, and 20,000çš„keyï¼Œvalueé•¿åº¦1000ï¼Œè¯»å†™1000æ¬¡ã€‚&lt;/p>
&lt;h3 id="ç»“æœ">ç»“æœ&lt;/h3>
&lt;p>&lt;img src="./media/14896309668401.jpg" alt="å†™">&lt;/p>
&lt;p>&lt;img src="./media/14896309585857.jpg" alt="è¯»">&lt;/p>
&lt;p>ä»ç»“æœæ¥çœ‹éšç€é•¿åº¦çš„å¢åŠ ï¼Œè¯»å†™çš„è€—æ—¶éƒ½éšä¹‹å¢åŠ ã€‚&lt;/p>
&lt;ul>
&lt;li>é•¿åº¦ä¸º10ï¼šå†™å¹³å‡è€—æ—¶0.053msï¼Œè¯»0.040ms&lt;/li>
&lt;li>é•¿åº¦ä¸º20000ï¼šå†™å¹³å‡è€—æ—¶0.352msï¼Œè¯»0.084ms&lt;/li>
&lt;/ul>
&lt;h3 id="æµ‹è¯•ä»£ç ">æµ‹è¯•ä»£ç &lt;/h3>
&lt;p>&lt;a href="https://gist.github.com/addozhang/cd8551af4ca008c1f86896b9232c7a3b">æºç &lt;/a>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Created by addo on 2017/3/16.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">RedisTest&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">keys&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">1000&lt;/span>&lt;span class="o">];&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">randomString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Random&lt;/span> &lt;span class="n">random&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Random&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="kt">char&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">chars&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toCharArray&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">StringBuilder&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">StringBuilder&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">key&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">chars&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">nextInt&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">chars&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">)]);&lt;/span>
&lt;span class="n">i&lt;/span>&lt;span class="o">--;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">write&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Jedis&lt;/span> &lt;span class="n">jedis&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">long&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">String&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">1000&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">randomString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">keys&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">randomString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1000&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">jedis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">format&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;put key length %d with value length 1000 in 1000 tims costs: %d ms&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">read&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Jedis&lt;/span> &lt;span class="n">jedis&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">long&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">keys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">jedis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">]);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">format&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;get key length %d with value length 1000 in 1000 tims costs: %d ms&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Jedis&lt;/span> &lt;span class="n">jedis&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Jedis&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;localhost&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">6379&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kt">int&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">lengths&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="n">10&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">100&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">500&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">1000&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">2500&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">5000&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">7500&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">10000&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">20000&lt;/span>&lt;span class="o">};&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">lengths&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">write&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">jedis&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">lengths&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">]);&lt;/span>
&lt;span class="n">read&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">jedis&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">lengths&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">]);&lt;/span>
&lt;span class="n">keys&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">1000&lt;/span>&lt;span class="o">];&lt;/span>
&lt;span class="n">jedis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">flushAll&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>éå†Collectionæ—¶åˆ é™¤å…ƒç´ </title><link>https://atbug.com/remove-element-while-looping-collection/</link><pubDate>Sun, 05 Mar 2017 22:04:58 +0000</pubDate><guid>https://atbug.com/remove-element-while-looping-collection/</guid><description>
&lt;p>å…¶å®æ ‡é¢˜æˆ‘æƒ³ç”¨ã€Šä¸ºä»€ä¹ˆforeachè¾¹å¾ªç¯è¾¹ç§»é™¤å…ƒç´ è¦ç”¨Iteratorï¼Ÿã€‹å¯æ˜¯å¤ªé•¿ã€‚&lt;/p>
&lt;p>ä¸ç”¨Iteratorï¼Œç”¨Collection.remove()ï¼Œä¼šæŠ¥ConcurrentModificationExceptioné”™è¯¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="k">for&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Integer&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">list&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">remove&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="c1">//Throw ConcurrentModificationException
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶å®ä½¿ç”¨foreachçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªIteratoræ¥éå†listã€‚ä¸åªæ˜¯removeï¼Œä½¿ç”¨addã€clearç­‰æ–¹æ³•ä¸€æ ·ä¼šå‡ºé”™ã€‚&lt;/p>
&lt;p>æ‹¿ArrayListæ¥è¯´ï¼Œå®ƒæœ‰ä¸€ä¸ªç§æœ‰çš„Iteratoræ¥å£çš„å†…éƒ¨ç±»Itrï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">private&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Itr&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">Iterator&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">cursor&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="c1">// index of next element to return
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">lastRet&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="c1">// index of last element returned; -1 if no such
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">expectedModCount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">modCount&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="c1">//sevrval methods
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨Iteratoræ¥éå†ArrayListå®é™…ä¸Šæ˜¯é€šè¿‡ä¸¤ä¸ªæŒ‡é’ˆæ¥éå†ArrayListåº•å±‚çš„æ•°ç»„ï¼šcursoræ˜¯ä¸‹ä¸€ä¸ªè¿”å›çš„å…ƒç´ åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡ï¼›lastRetæ˜¯ä¸Šä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡ã€‚è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„expectedModCountä½¿ç”¨çš„æ˜¯ArrayListçš„modCountçš„ï¼ˆmodCountå…·ä½“æ˜¯ä»€ä¹ˆæ„æ€ä¸‹æ–‡ä¼šæåˆ°ï¼‰ã€‚&lt;/p>
&lt;p>ä»Itrçš„å®ç°æ¥çœ‹ï¼Œæœ‰ä¸‰ç§æƒ…å†µä¼šæŠ›å‡ºConcurrentModificationExceptionï¼š&lt;/p>
&lt;ul>
&lt;li>cursorè¶…å‡ºäº†æ•°ç»„çš„æœ€å¤§ä¸‹æ ‡&lt;/li>
&lt;li>expectedModCountä¸ç­‰äºmodCount&lt;/li>
&lt;li>åˆ é™¤å…ƒç´ æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ArrayListçš„removeæ–¹æ³•ï¼Œæ­¤æ–¹æ³•å¯èƒ½ä¼šæŠ›å‡ºIndexOutOfBoundsException&lt;/li>
&lt;/ul>
&lt;h3 id="expectedmodcountä¸ç­‰äºmodcount">expectedModCountä¸ç­‰äºmodCount&lt;/h3>
&lt;p>å¼€å¤´æ‰€è¯´çš„é—®é¢˜æ­£æ˜¯æ˜¯&lt;strong>ç¬¬äºŒç§æƒ…å†µ&lt;/strong>ä¸‹å‡ºç°çš„ã€‚modCountç®€å•è¯´è®°å½•äº†Collectionè¢«ä¿®æ”¹çš„æ¬¡æ•°ï¼šæ·»åŠ æˆ–è€…åˆ é™¤å…ƒç´ ã€‚&lt;/p>
&lt;p>å‡å¦‚åœ¨foreachå¾ªç¯ä¸­åˆ é™¤å…ƒç´ ï¼Œä¸”æ­¤æ—¶modCountç­‰2ï¼š&lt;/p>
&lt;ul>
&lt;li>å¾ªç¯å¼€å§‹åˆ›å»ºæ–°Itrå®ä¾‹ï¼ŒexpectedModCount=modCount=2&lt;/li>
&lt;li>ä½¿ç”¨ArrayList.remove()åˆ é™¤å…ƒç´ ï¼ŒmodCountåŠ 1&lt;/li>
&lt;li>ç»§ç»­è°ƒç”¨next()æ–¹æ³•æŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œæ­¤æ—¶æ£€æŸ¥expectedModCountæ˜¯å¦ç­‰äºmodCountï¼Œä¸ç­‰åˆ™æŠ›ConcurrentModificationException&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="n">E&lt;/span> &lt;span class="nf">next&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">checkForComodification&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cursor&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">NoSuchElementException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">Object&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">elementData&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ArrayList&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">elementData&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">elementData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ConcurrentModificationException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">cursor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">elementData&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">lastRet&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">];&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">checkForComodification&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">modCount&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">expectedModCount&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ConcurrentModificationException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢æåˆ°Iteratorçš„å®ç°ä¸­åˆ é™¤å…ƒç´ å®é™…è°ƒç”¨çš„è¿˜æ˜¯ArrayList.remove()æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆä¸ä¼šæŠ›é”™ï¼Ÿ&lt;/p>
&lt;p>Itrçš„removeæ–¹æ³•åœ¨è°ƒç”¨ArrayList.remove()ä¹‹åï¼Œä¼šæ›´æ–°&lt;strong>expectedModCount&lt;/strong>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">remove&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">lastRet&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IllegalStateException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">checkForComodification&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ArrayList&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">remove&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">lastRet&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">cursor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lastRet&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">lastRet&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">expectedModCount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">modCount&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">IndexOutOfBoundsException&lt;/span> &lt;span class="n">ex&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ConcurrentModificationException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Java Volatileå…³é”®å­—</title><link>https://atbug.com/deep-in-java-volatile-keywork/</link><pubDate>Thu, 02 Mar 2017 08:30:29 +0000</pubDate><guid>https://atbug.com/deep-in-java-volatile-keywork/</guid><description>
&lt;p>volatileé€šè¿‡ä¿è¯å¯¹å˜é‡çš„è¯»æˆ–å†™éƒ½æ˜¯ç›´æ¥ä»å†…å­˜ä¸­è¯»å–æˆ–ç›´æ¥å†™å…¥å†…å­˜ä¸­ï¼Œä¿è¯äº†å¯è§æ€§ï¼›ä½†æ˜¯volatileå¹¶ä¸è¶³ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå› ä¸ºæ— æ³•ä¿è¯åŸå­æ€§ï¼Œå¦‚count++æ“ä½œï¼š&lt;/p>
&lt;ol>
&lt;li>å°†å€¼ä»å†…å­˜è¯»å…¥å¯„å­˜å™¨ä¸­&lt;/li>
&lt;li>è¿›è¡ŒåŠ 1æ“ä½œï¼Œå†…å­˜ä¿å­˜åˆ°å¯„å­˜å™¨ä¸­&lt;/li>
&lt;li>ç»“æœä»å¯„å­˜å™¨flushåˆ°å†…å­˜ä¸­&lt;/li>
&lt;/ol>
&lt;p>å€Ÿç”¨ä¸€å¼ å›¾æ¥çœ‹ï¼š&lt;/p>
&lt;p>&lt;img src="http://tutorials.jenkov.com/images/java-concurrency/java-volatile-2.png" alt="123">&lt;/p>
&lt;p>ä¸æ˜¯volatileçš„å˜é‡çš„æŒ‡ä»¤æ‰§è¡Œé¡ºåºæ˜¯1-&amp;gt;2-&amp;gt;3ï¼›è€Œå£°æ˜ä¸ºvolatileçš„å˜é‡ï¼Œé¡ºåºæ˜¯1-&amp;gt;23ã€‚ä»è¿™é‡Œçœ‹ï¼Œvolatileä¿è¯äº†ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†volatileä¿®é¥°çš„å˜é‡ï¼Œå˜åŒ–ä¼šé©¬ä¸Šä½“ç°åœ¨å†…å­˜ä¸­ã€‚çº¿ç¨‹é—´çœ‹åˆ°çš„å€¼æ˜¯ä¸€æ ·çš„ã€‚&lt;/p>
&lt;p>ä¸Šé¢è¯´äº†æ— æ³•ä¿è¯åŸå­æ€§æ˜¯æŒ‡ï¼šå¤šæ ¸cpuï¼Œçº¿ç¨‹Aæ‰§è¡Œäº†æŒ‡ä»¤1ï¼Œçº¿ç¨‹Bä¹Ÿæ‰§è¡Œäº†æŒ‡ä»¤1ã€‚Aè¿›è¡Œäº†åŠ 1æ“ä½œï¼Œç»“æœå†™å…¥å¯„å­˜å™¨åŒæ—¶flushåˆ°å†…å­˜ï¼›éšåBä¹Ÿæ‰§è¡Œäº†åŒæ ·çš„æ“ä½œã€‚countæœ¬æ¥åº”è¯¥çš„ç»“æœæ˜¯åŠ 2ï¼Œä½†æ˜¯å´åªåŠ äº†1ã€‚åŸå› å°±æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€æŒ‡çš„è¯»å’Œå†™ä¸æ˜¯åŸå­æ“ä½œã€‚æˆ‘ä»¬æœ€å¸Œæœ›çœ‹åˆ°çš„æ˜¯123åŒæ—¶æ‰§è¡Œï¼Œæ‰‹æ®µå°±æ˜¯sychronizedæˆ–è€…java.util.concurrentåŒ…ä¸­çš„åŸå­æ•°æ®ç±»å‹ã€‚&lt;/p>
&lt;p>ç®€å•æ‹¿AtomicIntegeræ¥çœ‹ï¼Œå…¶ä¸­çš„ä¸€ä¸ªintç±»å‹çš„valueå­—æ®µå£°æ˜ä¸ºvolatileï¼Œä¿è¯äº†123åŒæ—¶æ‰§è¡Œã€‚&lt;/p>
&lt;p>å‚è€ƒï¼š&lt;a href="http://tutorials.jenkov.com/java-concurrency/volatile.html">Java Volatile&lt;/a>&lt;/p></description></item><item><title>Haproxyè™šæ‹Ÿä¸»æœºSSL</title><link>https://atbug.com/haproxy-multi-host-with-ssl/</link><pubDate>Mon, 27 Feb 2017 19:31:53 +0000</pubDate><guid>https://atbug.com/haproxy-multi-host-with-ssl/</guid><description>
&lt;p>Haproxyä¸ºå¤šä¸ªåŸŸåé…ç½®SSL&lt;/p>
&lt;h2 id="ç”Ÿæˆè‡ªç­¾åè¯ä¹¦">ç”Ÿæˆè‡ªç­¾åè¯ä¹¦&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">sudo mkdir /etc/ssl/atbug.com
sudo openssl genrsa -out /etc/ssl/atbug.com/atbug.com.key &lt;span class="m">1024&lt;/span>
sudo openssl req -new -key /etc/ssl/atbug.com/atbug.com.key -out /etc/ssl/atbug.com/atbug.com.csr
sudo openssl x509 -req -days &lt;span class="m">365&lt;/span> -in /etc/ssl/atbug.com/atbug.com.csr -singkey /etc/ssl/atbug.com/atbug.com.key -out /etc/ssl/atbug.com/atbug.com.crt
sudo openssl x509 -req -days &lt;span class="m">365&lt;/span> -in /etc/ssl/atbug.com/atbug.com.csr -signkey /etc/ssl/atbug.com/atbug.com.key -out /etc/ssl/atbug.com/atbug.com.crt
sudo cat /etc/ssl/atbug.com/atbug.com.crt /etc/ssl/atbug.com/atbug.com.key &lt;span class="p">|&lt;/span> sudo tee /etc/ssl/atbug.com/atbug.com.pem
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="haproxyé…ç½®">Haproxyé…ç½®&lt;/h2>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">frontend https
bind *:443 ssl crt /etc/ssl/atbug.com/atbug.com.pem
option tcplog
mode http
#option forwardfor
###atbug-https
acl atbug-https hdr_beg(host) -i test.atbug.com
use_backend rome-atbug-https-backend if atbug-https
backend rome-atbug-https-backend
balance roundrobin
mode http
option ssl-hello-chk
server node-1 ip:port cookie dw2-vm-test-apps003 check inter 2000 rise 3 fall 3 weight 50
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>mybatisæŠ¥é”™â€œResult Maps collection already contains value for ***â€</title><link>https://atbug.com/duplicate-resultmap-in-mybatis-mapper/</link><pubDate>Wed, 22 Feb 2017 14:12:18 +0000</pubDate><guid>https://atbug.com/duplicate-resultmap-in-mybatis-mapper/</guid><description>
&lt;p>è¿™æ˜¯å·¥ä½œä¸­é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼šæµ‹è¯•ç¯å¢ƒéƒ¨ç½²å‡ºé”™ï¼ŒæŠ¥äº†ä¸‹é¢çš„é—®é¢˜ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">Caused&lt;/span> &lt;span class="n">by&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">java&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lang&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">IllegalArgumentException&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">Result&lt;/span> &lt;span class="n">Maps&lt;/span> &lt;span class="n">collection&lt;/span> &lt;span class="n">already&lt;/span> &lt;span class="n">contains&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">xxx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">xxx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">xxxRepository&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">BaseResultMap&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Configuration$StrictMap&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">802&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Configuration$StrictMap&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">774&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">addResultMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">556&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MapperBuilderAssistant&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">addResultMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MapperBuilderAssistant&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">217&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ResultMapResolver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">resolve&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ResultMapResolver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">47&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">xml&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">resultMapElement&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">285&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">xml&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">resultMapElement&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">252&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">xml&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">resultMapElements&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">244&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">at&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">apache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ibatis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">xml&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">configurationElement&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">XMLMapperBuilder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">java&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">116&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æŸ¥äº†å¯¹åº”çš„mapperæ–‡ä»¶å’Œjavaæ–‡ä»¶ï¼Œå·²ç»8ä¸ªå¤šæœˆæ²¡æœ‰ä¿®æ”¹è¿‡äº†ã€‚ä¹Ÿæ£€æŸ¥äº†å†…å®¹ï¼Œæ²¡æœ‰å‘ç°é‡å¤çš„BaseResultMapï¼›selectä¸­ä¹ŸresultMapçš„å¼•ç”¨ä¹Ÿéƒ½æ­£ç¡®ã€‚&lt;/p>
&lt;p>å…¶å®åˆ°æœ€åå‘ç°è·Ÿä»£ç ä¸€ä¸ç‚¹å…³ç³»éƒ½æ²¡æœ‰ï¼Œæ˜¯éƒ¨ç½²çš„æ—¶å€™æ²¡æœ‰åˆ é™¤æ—§ç‰ˆæœ¬çš„ä»£ç å¯¼è‡´ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„jaråŒæ—¶å­˜åœ¨ï¼Œç›¸åº”çš„mapperæ–‡ä»¶ä¹Ÿæœ‰ä¸¤ä¸ªã€‚&lt;/p>
&lt;p>çœ‹äº†ä¸‹æºç ï¼Œmybatisåœ¨åˆ›å»ºSessionFactoryBeanè§£æxmlæ—¶å€™ï¼Œä¼šæŠŠxmlä¸­çš„resultMapæ”¾å…¥åˆ°ä¸€ä¸ªHashMapçš„å­ç±»StrictMapä¸­ï¼Œkeyæ˜¯&lt;strong>mapperçš„namespaceä¸resultmapçš„id&lt;/strong>æ‹¼æ¥æˆçš„ã€‚&lt;/p>
&lt;p>StrictMapåœ¨putå…ƒç´ çš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥mapä¸­æ˜¯å¦å·²å­˜åœ¨keyã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">addResultMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ResultMap&lt;/span> &lt;span class="n">rm&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">resultMaps&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">rm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">rm&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">checkLocallyForDiscriminatedNestedResultMaps&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">rm&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">checkGloballyForDiscriminatedNestedResultMaps&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">rm&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>æ¶ˆè´¹æ—¶offsetè¢«é‡ç½®å¯¼è‡´é‡å¤æ¶ˆè´¹</title><link>https://atbug.com/offset-be-reset-when-consuming/</link><pubDate>Mon, 20 Feb 2017 13:23:49 +0000</pubDate><guid>https://atbug.com/offset-be-reset-when-consuming/</guid><description>
&lt;p>è¿™æ˜¯å®é™…ä½¿ç”¨æ—¶é‡åˆ°çš„é—®é¢˜ï¼škafka apiçš„ç‰ˆæœ¬æ˜¯0.10ï¼Œå‘ç°æœ‰é‡å¤æ¶ˆè´¹é—®é¢˜ï¼›æ£€æŸ¥logåå‘ç°åœ¨commit offsetçš„æ—¶å€™å‘ç”Ÿè¶…æ—¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-text" data-lang="text">Auto offset commit failed for group test: Commit cannot be completed since the group has already rebalanced and assigned the partitions to another member. This means that the time between subsequent calls to poll() was longer than the configured session.timeout.ms, which typically implies that the poll loop is spending too much time message processing. You can address this either by increasing the session timeout or by reducing the maximum size of batches returned in poll() with max.poll.records.
15:12:12.364 [main] WARN o.a.k.c.c.i.ConsumerCoordinator - Auto offset commit failed for group test: Commit offsets failed with retriable exception. You should retry committing offsets.
&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹äº†Kafkaçš„APIæ–‡æ¡£ï¼Œå‘ç°0.10ä¸­æä¾›äº†æ–°çš„é…ç½®&lt;strong>max.poll.records&lt;/strong>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-text" data-lang="text">The maximum number of records returned in a single call to poll().
type: int
default: 2147483647
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœç”Ÿäº§ç«¯å†™å…¥å¾ˆå¿«ï¼Œæ¶ˆè´¹ç«¯å¤„ç†è€—æ—¶ã€‚ä¸€ä¸ªbatchçš„å¤„ç†æ—¶é—´å¤§äºsession.timeout.msï¼Œä¼šå¯¼è‡´session time outï¼Œå¼•èµ·offset commitå¤±è´¥ã€‚&lt;/p></description></item><item><title>TheadPoolExecutoræºç åˆ†æ</title><link>https://atbug.com/threadpoolexecutor-sourcecode-analysis/</link><pubDate>Mon, 20 Feb 2017 09:56:07 +0000</pubDate><guid>https://atbug.com/threadpoolexecutor-sourcecode-analysis/</guid><description>
&lt;h1 id="theadpoolexecutoræºç åˆ†æ">TheadPoolExecutoræºç åˆ†æ&lt;/h1>
&lt;p>ThreadPoolExecutoræ˜¯å¤šçº¿ç¨‹ä¸­ç»å¸¸ç”¨åˆ°çš„ç±»ï¼Œå…¶ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ± æ‰§è¡Œæäº¤çš„ä»»åŠ¡ã€‚&lt;/p>
&lt;h2 id="å®ç°">å®ç°&lt;/h2>
&lt;p>æ²¡æœ‰ç‰¹æ®Šéœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œé€šå¸¸éƒ½æ˜¯ç”¨Executorsç±»çš„é™æ€æ–¹æ³•å¦‚newCachedThreadPollæ¥åˆå§‹åŒ–ThreadPoolExecutorå®ä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">ExecutorService&lt;/span> &lt;span class="nf">newCachedThreadPool&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ThreadPoolExecutor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Integer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MAX_VALUE&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">60L&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SECONDS&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="n">SynchronousQueue&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Runnable&lt;/span>&lt;span class="o">&amp;gt;());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»Executorsçš„æ–¹æ³•å®ç°ä¸­çœ‹å‡ºï¼ŒBlockingQueueä½¿ç”¨çš„SynchronousQueueï¼Œåº•å±‚ä½¿ç”¨äº†æ ˆçš„å®ç°ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªSynchronousQueueæ˜¯æ²¡æœ‰å®¹é‡é™åˆ¶çš„ï¼ŒExecutorsä¹Ÿå°†maximumPoolSizeè®¾ä¸ºInteger.MAX_VALUEã€‚&lt;/p>
&lt;p>ThreadPoolExecutorçš„æ„é€ æ–¹æ³•ï¼š&lt;/p>
&lt;p>æŒ‰ç…§javadocçš„è§£é‡Šï¼š&lt;/p>
&lt;ul>
&lt;li>corePoolSizeæ˜¯æ± ä¸­é—²ç½®çš„æœ€å°çº¿ç¨‹æ•°&lt;/li>
&lt;li>maximumPoolSizeæ˜¯æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°&lt;/li>
&lt;li>keepAliveTimeæ˜¯çº¿ç¨‹æ•°å¤§äºæœ€å°çº¿ç¨‹æ•°æ—¶ï¼Œè¿‡é‡é—²ç½®çº¿ç¨‹çš„æœ€å¤§å­˜æ´»æ—¶é—´&lt;/li>
&lt;li>unitæ˜¯ä¸Šé¢å­˜æ´»æ—¶é—´çš„å•ä½&lt;/li>
&lt;li>workQueueæ˜¯ç”¨æ¥æš‚æ—¶ä¿å­˜è¿è¡Œå‰çš„ä»»åŠ¡&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="nf">ThreadPoolExecutor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">corePoolSize&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">maximumPoolSize&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="kt">long&lt;/span> &lt;span class="n">keepAliveTime&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">TimeUnit&lt;/span> &lt;span class="n">unit&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">BlockingQueue&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Runnable&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">workQueue&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">execute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Runnable&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">NullPointerException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ctl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">workerCountOf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">corePoolSize&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">addWorker&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="k">return&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ctl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">isRunning&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">workQueue&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">offer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">recheck&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ctl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span> &lt;span class="n">isRunning&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">recheck&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">remove&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="n">reject&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">workerCountOf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">recheck&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">addWorker&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">addWorker&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="n">reject&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é™¤å»ç¬¬ä¸€ä¸ªåšä»»åŠ¡éç©ºæ£€æŸ¥çš„ifã€‚&lt;/p>
&lt;p>ç¬¬äºŒä¸ªifï¼Œæ£€æŸ¥å½“å‰ä½¿ç”¨çš„çº¿ç¨‹æ•°æ˜¯å¦è¶…è¿‡corePoolSizeã€‚æœªè¶…è¿‡ï¼Œè°ƒç”¨addWorkerå¹¶æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°ä¸ºtrueã€‚addWorkerä¼šå†æ¬¡æ£€æŸ¥çº¿ç¨‹æ•°æ˜¯å¦è¶…è¿‡corePoolSizeï¼Œå¦‚æœè¿˜æœªè¶…è¿‡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚&lt;/p>
&lt;p>ç¬¬ä¸‰ä¸ªifï¼Œå½“ç›®å‰ä½¿ç”¨çš„çº¿ç¨‹æ•°å¤§äºç­‰äºcorePoolSizeï¼Œå°†ä»»åŠ¡ä¿å­˜åˆ°workQueueä¸­ã€‚ä¿å­˜æˆåŠŸï¼Œå†æ¬¡æ£€æŸ¥æ˜¯å¦éœ€è¦å†åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚&lt;/p>
&lt;p>æœ€åä¸€ä¸ªelseï¼Œè°ƒç”¨addWorkerå¹¶æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°ä¸ºfalseã€‚åœ¨åˆ›å»ºçº¿ç¨‹å‰ï¼Œæ£€æŸ¥å½“æ—¶çº¿ç¨‹æ•°æ˜¯å¦è¶…è¿‡maximumPoolSizeï¼Œä¸ºè¶…è¿‡åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">private&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">addWorker&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Runnable&lt;/span> &lt;span class="n">firstTask&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">core&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">retry&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(;;)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ctl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">rs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">runStateOf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// Check if queue empty only if necessary.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">rs&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">SHUTDOWN&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="o">!&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">rs&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">SHUTDOWN&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="n">firstTask&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="o">!&lt;/span> &lt;span class="n">workQueue&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="o">()))&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(;;)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">wc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">workerCountOf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">wc&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">CAPACITY&lt;/span> &lt;span class="o">||&lt;/span>
&lt;span class="n">wc&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">core&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="n">corePoolSize&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">maximumPoolSize&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">compareAndIncrementWorkerCount&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">))&lt;/span>
&lt;span class="k">break&lt;/span> &lt;span class="n">retry&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ctl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// Re-read ctl
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">runStateOf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">rs&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">continue&lt;/span> &lt;span class="n">retry&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="c1">// else CAS failed due to workerCount change; retry inner loop
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="é—®é¢˜">é—®é¢˜&lt;/h2>
&lt;p>ä¸€èˆ¬åœºæ™¯ä¸‹ï¼Œä¸èƒ½ä½¿ç”¨Integer.MAX_VALUEå¦‚æ­¤å¤§çš„çº¿ç¨‹æ•°ã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨æ„é€ å™¨è‡ªå·±è¿›è¡Œå®ä¾‹åŒ–ã€‚&lt;/p>
&lt;p>å¦‚æŒ‡å®šcorePoolSize=5ã€maximumPoolSize=20&lt;/p>
&lt;p>ã€keepAliveTime=60Lã€unit=TimeUnit.SECONDSã€workQueue=new SynchronousQueue&lt;!-- raw HTML omitted -->()ã€‚&lt;/p>
&lt;p>ä½†æ˜¯å®é™…æ‰§è¡Œçš„æ—¶å€™ï¼Œçº¿ç¨‹æ•°ä¸€ç›´æ˜¯5ã€‚&lt;/p>
&lt;p>å›å¤´çœ‹ThreadPoolExecutorçš„å®ç°ï¼Œå¦‚æœæƒ³è¦è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœéœ€è¦ç¨‹åºè¿›å…¥æœ€åçš„é‚£ä¸ªelseã€‚é‚£é‡ç‚¹å°±åœ¨ç¬¬ä¸‰ä¸ªifé‡Œçš„workQueue.offer(command)ã€‚&lt;/p>
&lt;p>çœ‹BlockingQueueæ¥å£ä¸­è¯¥æ–¹æ³•çš„æè¿°ï¼šå°†å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œæ²¡æœ‰è¶…è¿‡å®¹é‡é™åˆ¶åˆ™æ’å…¥å¹¶è¿”å›trueã€‚&lt;/p>
&lt;p>è€Œä½¿ç”¨çš„SynchronousQueueåº•å±‚å®ç°ä½¿ç”¨çš„æ ˆæ²¡æœ‰å®¹é‡é™åˆ¶ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸€ç›´æ˜¯corePoolSizeã€‚&lt;/p></description></item><item><title>Kafka Javaç”Ÿäº§è€…æ¨¡å‹</title><link>https://atbug.com/kafka-java-producer-model/</link><pubDate>Wed, 04 Jan 2017 16:33:02 +0000</pubDate><guid>https://atbug.com/kafka-java-producer-model/</guid><description>
&lt;p>&lt;img src="./media/14835174309242.jpg" alt="">&lt;/p>
&lt;h3 id="produceråˆå§‹åŒ–">Produceråˆå§‹åŒ–&lt;/h3>
&lt;p>åˆå§‹åŒ–KafkaProducerå®ä¾‹ï¼ŒåŒæ—¶é€šè¿‡Configæ•°æ®åˆå§‹åŒ–MetaDataã€NetWorkClientã€Accumulatorå’ŒSenderçº¿ç¨‹ã€‚å¯åŠ¨Senderçº¿ç¨‹ã€‚&lt;/p>
&lt;h4 id="metadataä¿¡æ¯">MetaDataä¿¡æ¯&lt;/h4>
&lt;p>è®°å½•Clusterçš„ç›¸å…³ä¿¡æ¯ï¼Œç¬¬ä¸€æ¬¡é“¾æ¥ä½¿ç”¨Configè®¾ç½®ï¼Œä¹‹åä¼šä»è¿œç«¯pollä¿¡æ¯å›æ¥ï¼Œæ¯”å¦‚host.nameç­‰ä¿¡æ¯ã€‚&lt;/p>
&lt;h4 id="accumulatorå®ä¾‹">Accumulatorå®ä¾‹&lt;/h4>
&lt;p>AccumulatoræŒæœ‰ä¸€ä¸ªMapå®ä¾‹ï¼Œkeyä¸ºTopicPartitionï¼ˆå°è£…äº†topicå’Œpartitionä¿¡æ¯ï¼‰å¯¹è±¡ï¼ŒValueä¸ºRecordBatchçš„Dequeé›†åˆã€‚&lt;/p>
&lt;h4 id="networkclientå®ä¾‹">NetworkClientå®ä¾‹&lt;/h4>
&lt;p>é€šè¿‡MetaDataä¿¡æ¯åˆå§‹åŒ–NetworkClientå®ä¾‹ï¼ŒNetworkClientä½¿ç”¨NIOæ¨¡å‹ã€‚&lt;/p>
&lt;h4 id="senderçº¿ç¨‹">Senderçº¿ç¨‹&lt;/h4>
&lt;p>senderæŒæœ‰NetworkClientå’ŒAccumulatorå®ä¾‹ï¼Œåœ¨Producerå®ä¾‹åˆå§‹åŒ–å®Œæˆä¹‹åï¼ŒæŒç»­åœ°å°†Accumulatorä¸­çš„Batchæ•°æ®drainåˆ°ä¸€ä¸ªListä¸­ï¼Œè°ƒç”¨NetworkClientè¿›è¡Œå‘é€ã€‚&lt;/p>
&lt;h3 id="å‘é€">å‘é€&lt;/h3>
&lt;p>è°ƒç”¨Producerå®ä¾‹è¿›è¡Œæ¶ˆæ¯å‘é€ï¼Œé¦–å…ˆå°†æ¶ˆæ¯åºåˆ—åŒ–ä¹‹åè¿½åŠ åˆ°Accumulatorçš„Dequeçš„æœ€åä¸€ä¸ªbatchä¸­ï¼Œä¹‹åå”¤é†’sender-&amp;gt;client-&amp;gt;Selectorè¿›è¡Œæ¶ˆæ¯å‘é€ã€‚&lt;/p></description></item><item><title>Redisæ¸…ç†ç¼“å­˜</title><link>https://atbug.com/clean-speicified-keys-in-redis/</link><pubDate>Tue, 13 Dec 2016 16:54:41 +0000</pubDate><guid>https://atbug.com/clean-speicified-keys-in-redis/</guid><description>
&lt;p>æœ€è¿‘æœ‰ä¸ªéœ€æ±‚éœ€è¦ä¸»åŠ¨çš„å»æ¸…ç†éƒ¨åˆ†ç¼“å­˜ï¼Œè€ƒè™‘çš„åŸå­æ€§çš„é—®é¢˜ï¼Œç”¨Luaè„šæœ¬è¿›è¡Œå®ç°ã€‚&lt;/p>
&lt;p>Luaè„šæœ¬&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="kd">local&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="kr">for&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">k&lt;/span> &lt;span class="kr">in&lt;/span> &lt;span class="n">ipairs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;KEYS&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;span class="kr">do&lt;/span>
&lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;DEL&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="n">count&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>shellè¿è¡Œ&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-sh" data-lang="sh">redis-cli --eval file.lua ,&lt;span class="o">[&lt;/span>KEY PATTERN&lt;span class="o">]&lt;/span>
&lt;span class="c1">#sample: æ¸…ç†æ‰€æœ‰keyä»¥Testå¼€å¤´çš„è®°å½•&lt;/span>
redis-cli --eval clear.lua , Test*
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Java&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">Jedis&lt;/span> &lt;span class="n">jedis&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Jedis&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;127.0.0.1&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">6379&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">URL&lt;/span> &lt;span class="n">resource&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Resources&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getResource&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;META-INF/scripts/clear.lua&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">String&lt;/span> &lt;span class="n">lua&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Resources&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Charsets&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">UTF_8&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">Object&lt;/span> &lt;span class="n">eval&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">jedis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">eval&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">lua&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;Name*&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">eval&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Flume - FileChannel ï¼ˆä¸€ï¼‰</title><link>https://atbug.com/flume-filechannel-overview/</link><pubDate>Wed, 23 Nov 2016 09:23:57 +0000</pubDate><guid>https://atbug.com/flume-filechannel-overview/</guid><description>
&lt;h3 id="æ¦‚è¿°">æ¦‚è¿°&lt;/h3>
&lt;p>å½“ä½¿ç”¨Flumeçš„æ—¶å€™ï¼Œæ¯ä¸ªæµç¨‹éƒ½åŒ…å«äº†è¾“å…¥æºã€é€šé“å’Œè¾“å‡ºã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯ä¸€ä¸ªwebæœåŠ¡å™¨å°†äº‹ä»¶é€šè¿‡RPCï¼ˆæ¬å…¥&lt;a href="http://flume.apache.org/FlumeUserGuide.html#avro-sink">AvroSource&lt;/a>ï¼‰å†™å…¥è¾“å…¥æºä¸­ï¼Œè¾“å…¥æºå°†å…¶å†™å…¥&lt;a href="http://flume.apache.org/FlumeUserGuide.html#memory-channel">MemoryChannel&lt;/a>ï¼Œæœ€å&lt;a href="http://flume.apache.org/FlumeUserGuide.html#hdfs-sink">HDFS Sink&lt;/a>æ¶ˆè´¹äº‹ä»¶å°†å…¶å†™å…¥HDFSä¸­ã€‚&lt;/p>
&lt;p>&lt;img src="http://blog.cloudera.com//wp-content/uploads/2012/09/flume1.png" alt="Flume1">&lt;/p>
&lt;p>MemeoryChannelæä¾›äº†é«˜ååé‡ä½†æ˜¯åœ¨ç³»ç»Ÿå´©æºƒæˆ–è€…æ–­ç”µæ—¶ä¼šä¸¢å¤±æ•°æ®ã€‚å› æ­¤éœ€è¦å¼€å‘ä¸€ä¸ªå¯æŒä¹…è¯é€šé“ã€‚FileChannelæ˜¯åœ¨&lt;a href="https://issues.apache.org/jira/browse/FLUME-1085">FLUME-1085&lt;/a>é‡Œå®ç°çš„ã€‚ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªé«˜å¯ç”¨é«˜ååé‡çš„é€šé“ã€‚FileChannleä¿è¯äº†åœ¨å¤±è¯¯æäº¤ä¹‹åï¼Œåœ¨å´©æºƒæˆ–è€…æ–­ç”µåä¸ä¸¢å¤±æ•°æ®ã€‚&lt;/p>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯FileChannelè‡ªå·±ä¸åšä»»ä½•çš„æ•°æ®å¤åˆ¶ï¼Œå› æ­¤å®ƒåªæ˜¯å’ŒåŸºæœ¬çš„ç£ç›˜ä¸€æ ·é«˜å¯ç”¨ã€‚ä½¿ç”¨FileChannleçš„ç”¨æˆ·éœ€è¦è´­ä¹°é…ç½®æ›´å¤šçš„ç¡¬ç›˜ã€‚ç¡¬ç›˜æœ€å¥½æ˜¯RAIDã€SANæˆ–è€…ç±»ä¼¼çš„ã€‚&lt;/p>
&lt;p>å¾ˆå¤šéœ€è¦é€šè¿‡æŸå¤±å°‘é‡çš„æ•°æ®ï¼ˆæ¯éš”å‡ ç§’å°†å†…å­˜æ•°æ®&lt;a href="http://pubs.opengroup.org/onlinepubs/7908799/xsh/fsync.html">fsync&lt;/a>åˆ°ç¡¬ç›˜ï¼‰æ¢å–é«˜ååé‡ã€‚Flumeå›¢é˜Ÿå†³å®šä½¿ç”¨å¦ä¸€ç§æ–¹å¼å®ç°FileChannelã€‚Flueæ˜¯ä¸€ä¸ªäº‹åŠ¡å‹çš„ç³»ç»Ÿï¼Œåœ¨ä¸€æ¬¡å­˜æˆ–å–çš„äº‹åŠ¡ä¸­å¯ä»¥æ“ä½œå¤šä¸ªäº‹ä»¶ã€‚é€šè¿‡æ”¹å˜æ‰¹é‡å¤§å°æ¥æ§åˆ¶ååé‡ã€‚ä½¿ç”¨å¤§çš„æ‰¹é‡ï¼ŒFlumeå¯ä»¥ä»¥æ¯”è¾ƒé«˜çš„ååé‡ä¼ é€æ•°æ®ï¼ŒåŒæ—¶ä¸ä¸¢å¤±æ•°æ®ã€‚æ‰¹é‡çš„å¤§å°å®Œå…¨ç”±å®¢æˆ·ç«¯æ§åˆ¶ã€‚ä½¿ç”¨RDBMSçš„ç”¨æˆ·å¯¹è¿™ç§æ–¹å¼ä¼šæ¯”è¾ƒç†Ÿæ‚‰ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªFlumeäº‹åŠ¡ç”±å­˜æˆ–å–ç»„æˆï¼Œä½†ä¸èƒ½åŒæ—¶åšä¸¤ç§æ“ä½œï¼ŒåŒæ ·æäº¤å’Œå›æ»šä¹Ÿæ˜¯ä¸€æ ·ã€‚æ¯ä¸ªäº‹åŠ¡å®ç°äº†å­˜å’Œå–çš„æ–¹æ³•ã€‚æ•°æ®æºå°†äº‹ä»¶å­˜å…¥é€šé“ï¼Œè¾“å‡ºä»é€šé“ä¸­å°†äº‹ä»¶å–å‡ºã€‚&lt;/p>
&lt;h3 id="è®¾è®¡">è®¾è®¡&lt;/h3>
&lt;p>FileChannelåœ¨WALï¼ˆé¢„å†™å¼æ—¥å¿—ï¼‰çš„åŸºç¡€ä¸Šæ·»åŠ äº†ä¸€ä¸ªå†…å­˜é˜Ÿåˆ—ã€‚æ¯ä¸ªäº‹åŠ¡éƒ½è¢«å†™æˆä¸€ä¸ªåŸºäºäº‹åŠ¡ç±»å‹ï¼ˆå­˜æˆ–å–ï¼‰çš„WALï¼Œå†…å­˜é˜Ÿåˆ—ä¹Ÿç›¸åº”çš„è¢«æ›´æ–°ã€‚æ¯æ¬¡æ˜¯äº‹åŠ¡æäº¤ï¼Œæ­£ç¡®çš„æ–‡ä»¶è¢«fsyncä¿è¯æ•°æ®è¢«çœŸæ­£åœ°ä¿å­˜åˆ°ç£ç›˜ä¸Šï¼ŒåŒæ—¶è¯¥äº‹ä»¶çš„æŒ‡é’ˆä¹Ÿè¢«ä¿å­˜åˆ°äº†å†…å­˜é˜Ÿåˆ—ä¸­ã€‚è¿™ä¸ªé˜Ÿåˆ—æä¾›çš„åŠŸèƒ½è·Ÿå…¶ä»–é˜Ÿåˆ—æ²¡æœ‰åŒºåˆ«ï¼šç®¡ç†é‚£äº›è¿˜æ²¡æœ‰è¢«è¾“å‡ºæ¶ˆè´¹çš„äº‹ä»¶ã€‚åœ¨å–çš„è¿‡ç¨‹ä¸­ï¼ŒæŒ‡é’ˆè¢«ä»é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚äº‹ä»¶ç›´æ¥ä»WALä¸­è¯»å–ã€‚å¾—ç›Šäºå½“å‰å¤§å®¹é‡çš„RAMï¼Œä»æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç¼“å­˜ä¸­è¯»å–å¾ˆå¸¸è§ã€‚&lt;/p>
&lt;p>åœ¨ç³»ç»Ÿå´©æºƒä¹‹åï¼ŒWALå¯ä»¥è¢«é‡ç°åˆ°é˜Ÿåˆ—ä¸­ä¿æŒåŸæ¥çš„çŠ¶æ€ï¼Œæ²¡æœ‰è¢«æäº¤çš„äº‹åŠ¡ä¼šä¸¢å¤±ã€‚é‡ç°WALæ˜¯è€—æ—¶çš„ï¼Œå› æ­¤é˜Ÿåˆ—ä¹Ÿè¢«å‘¨æœŸæ€§åœ°å†™åˆ°ç£ç›˜ä¸Šã€‚å†™é˜Ÿåˆ—åˆ°ç£ç›˜è¢«ç§°ä½œcheckpointã€‚å´©æºƒåï¼Œä»ç£ç›˜è¯»å–é˜Ÿåˆ—ã€‚åªæœ‰é˜Ÿåˆ—ä¿å­˜åˆ°ç£ç›˜ä¹‹åæäº¤çš„äº‹åŠ¡è¢«é‡ç°ï¼Œè¿™æ ·å¯ä»¥æ˜¾è‘—çš„å‡å°‘éœ€è¦è¯»å–çš„WALçš„æ•°é‡ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œå¦‚ä¸‹æœ‰ä¸¤ä¸ªäº‹ä»¶çš„é€šé“ï¼š&lt;/p>
&lt;p>&lt;img src="http://blog.cloudera.com//wp-content/uploads/2012/09/flume2-269x300.png" alt="img">&lt;/p>
&lt;p>WALåŒ…å«äº†ä¸‰ä¸ªé‡è¦çš„å…ƒç´ ï¼šäº‹åŠ¡idã€åºåˆ—å·å’Œäº‹ä»¶æ•°æ®ã€‚æ¯ä¸ªäº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡idï¼Œæ¯ä¸ªäº‹ä»¶éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åºåˆ—å·ã€‚äº‹åŠ¡idåªè¢«ç”¨æ¥æ ‡è¯†äº‹åŠ¡ä¸­çš„ä¸€ç»„äº‹ä»¶ï¼Œåºåˆ—å·åœ¨é‡æ¼”æ—¥å¿—çš„æ—¶å€™è¢«ç”¨åˆ°ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œäº‹åŠ¡idæ˜¯1ï¼Œåºåˆ—å·æ˜¯1ã€2ã€3ã€‚&lt;/p>
&lt;p>å½“é˜Ÿåˆ—è¢«ä¿å­˜åˆ°ç¡¬ç›˜å &amp;ndash; ä¸€æ¬¡checkpoint &amp;ndash; åºåˆ—å·è‡ªåŠ¨å¢åŠ å¹¶åŒæ ·è¢«ä¿å­˜ã€‚åœ¨é‡å¯æ—¶ï¼Œé˜Ÿåˆ—æœ€å…ˆè¢«ä»ç¡¬ç›˜ä¸ŠåŠ è½½ï¼Œæ‰€æœ‰åºåˆ—å·å¤§äºé˜Ÿåˆ—çš„WALé¡¹è¢«é‡ç°ã€‚åœ¨checkpointæ“ä½œæ—¶ï¼Œchannleè¢«é”ä½ä»¥ä¿è¯æ²¡æœ‰å­˜å–æ“ä½œæ”¹å˜å®ƒçš„çŠ¶æ€ã€‚å¦‚æœå…è®¸ä¿®æ”¹ï¼Œä¼šå¯¼è‡´ä¿å­˜åˆ°ç¡¬ç›˜ä¸Šçš„é˜Ÿåˆ—å¿«ç…§ä¸ä¸€è‡´ã€‚&lt;/p>
&lt;p>ä¸Šé¢ä¾‹å­ä¸­çš„é˜Ÿåˆ—ï¼Œcheckpointå‘é€åœ¨äº‹åŠ¡1æäº¤ä¹‹åï¼Œå› æ­¤äº‹ä»¶aã€bçš„æŒ‡é’ˆå’Œåºåˆ—å·4è¢«ä¿å­˜åˆ°ç¡¬ç›˜ã€‚&lt;/p>
&lt;p>ä¹‹åï¼Œäº‹ä»¶aåœ¨äº‹åŠ¡2ä¸­è¢«ä»é˜Ÿåˆ—ä¸­å–å‡ºï¼š&lt;/p>
&lt;p>&lt;img src="http://blog.cloudera.com//wp-content/uploads/2012/09/flume3-296x300.png" alt="img">&lt;/p>
&lt;p>å¦‚æœè¿™æ—¶ç³»ç»Ÿå´©æºƒï¼Œé˜Ÿåˆ—çš„checkpointä»ç¡¬ç›˜ä¸­åŠ è½½ã€‚æ³¨æ„è¿™ä¸ªcheckpointå‘ç”Ÿåœ¨äº‹åŠ¡2ä¹‹å‰ï¼Œäº‹ä»¶aã€bçš„æŒ‡é’ˆå­˜åœ¨é˜Ÿåˆ—ä¸­ã€‚å› æ­¤WALä¸­åºåˆ—å·å¤§äº4çš„å·²æäº¤çš„äº‹åŠ¡è¢«é‡ç°ï¼Œäº‹ä»¶aæŒ‡é’ˆè¢«ä»é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚&lt;/p>
&lt;p>ä¸Šé¢çš„è®¾è®¡æœ‰ä¸¤ç‚¹æ²¡æåˆ°ã€‚checkpointæ—¶å‘ç”Ÿçš„å­˜å’Œå–æ“ä½œä¼šä¸¢å¤±ã€‚å‡è®¾checkpointåœ¨å–äº‹ä»¶aä¹‹åå‘ç”Ÿï¼š&lt;/p>
&lt;p>&lt;img src="http://blog.cloudera.com//wp-content/uploads/2012/09/flume4-296x300.png" alt="img">&lt;/p>
&lt;p>å¦‚æœè¿™æ—¶ç³»ç»Ÿå´©æºƒï¼Œæ ¹æ®ä¸Šé¢çš„è®¾è®¡ï¼Œäº‹ä»¶bæŒ‡é’ˆä¿å­˜åœ¨é˜Ÿåˆ—ä¸­ï¼Œæ‰€æœ‰åºåˆ—å·å¤§äº5çš„WALé¡¹è¢«é‡ç°ï¼šäº‹åŠ¡2çš„å›æ»šè¢«é‡ç°ã€‚ä½†æ˜¯äº‹åŠ¡2çš„å–æ“ä½œä¸ä¼šè¢«é‡ç°ã€‚å› æ­¤äº‹ä»¶aæŒ‡é’ˆä¸ä¼šè¢«æ”¾å›é˜Ÿåˆ—å› è€Œå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚å­˜çš„åœºæ™¯ä¹Ÿç±»ä¼¼ã€‚å› æ­¤åœ¨é˜Ÿåˆ—checkpointçš„æ—¶å€™ï¼Œè¿›è¡Œä¸­çš„äº‹åŠ¡æ“ä½œä¹Ÿä¼šè¢«é‡ç°ï¼Œè¿™æ ·è¿™ç§æƒ…å†µèƒ½è¢«æ­£ç¡®å¤„ç†ã€‚&lt;/p>
&lt;h3 id="å®ç°">å®ç°&lt;/h3>
&lt;p>FileChannelè¢«ä¿å­˜åœ¨flumeé¡¹ç›®çš„flume-file-channelæ¨¡å—ä¸­ï¼Œä»–çš„javaåŒ…åæ˜¯org.apache.flume.channel.fileã€‚ä¸Šé¢æåˆ°é˜Ÿåˆ—è¢«å«åš&lt;a href="https://github.com/apache/flume/blob/trunk/flume-ng-channels/flume-file-channel/src/main/java/org/apache/flume/channel/file/FlumeEventQueue.java">FlumeEventQueue&lt;/a>ï¼ŒWALè¢«å«åšÂ &lt;a href="https://github.com/apache/flume/blob/trunk/flume-ng-channels/flume-file-channel/src/main/java/org/apache/flume/channel/file/Log.java">Log&lt;/a>ã€‚é˜Ÿåˆ—æ˜¯ä¸€ä¸ªç¯å½¢æ•°ç»„ï¼Œä½¿ç”¨&lt;a href="https://github.com/apache/flume/blob/trunk/flume-ng-channels/flume-file-channel/src/main/java/org/apache/flume/channel/file/EventQueueBackingStoreFile.java">Memory Mapped File&lt;/a>ã€‚WALæ˜¯ä¸€ç»„ä»¥&lt;a href="https://github.com/apache/flume/blob/trunk/flume-ng-channels/flume-file-channel/src/main/java/org/apache/flume/channel/file/LogFile.java">LogFile&lt;/a>æˆ–å…¶å­ç±»åºåˆ—åŒ–çš„æ–‡ä»¶ã€‚&lt;/p>
&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;p>FileChannleåœ¨ç¡¬ä»¶ã€è½¯ä»¶å’Œç³»ç»Ÿæ•…éšœä¸‹çš„æŒä¹…åŒ–å¹¶åŒæ—¶ä¿è¯é«˜ååé‡ã€‚å¦‚æœè¿™äº®ç‚¹éƒ½çœ‹ä¸­çš„è¯ï¼ŒFileChannelæ˜¯æ¨èä½¿ç”¨çš„é€šé“ã€‚&lt;/p>
&lt;p>&lt;a href="http://blog.cloudera.com/blog/2012/09/about-apache-flume-filechannel/">åŸæ–‡&lt;/a>&lt;/p></description></item><item><title>æ¢ç´¢Rabbitmqçš„Javaå®¢æˆ·ç«¯</title><link>https://atbug.com/deep-in-rabbitmq-java-client/</link><pubDate>Sun, 09 Oct 2016 09:20:07 +0000</pubDate><guid>https://atbug.com/deep-in-rabbitmq-java-client/</guid><description>
&lt;h2 id="amqpconnection">AMQPConnection&lt;/h2>
&lt;h3 id="å®ä¾‹åˆå§‹åŒ–">å®ä¾‹åˆå§‹åŒ–&lt;/h3>
&lt;p>åˆ›å»ºConnectionæ—¶ä¼šé€šè¿‡FrameHandlerFacotryåˆ›å»ºä¸€ä¸ªSocketFrameHandlerï¼ŒSocketFrameHandlerå¯¹Socketè¿›è¡Œäº†å°è£…ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="nf">AMQConnection&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ConnectionParams&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">FrameHandler&lt;/span> &lt;span class="n">frameHandler&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">{&lt;/span>
&lt;span class="n">checkPreconditions&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">username&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getUsername&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getPassword&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">_frameHandler&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">frameHandler&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">_virtualHost&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getVirtualHost&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">_exceptionHandler&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getExceptionHandler&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">_clientProperties&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span>&lt;span class="o">&amp;gt;(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getClientProperties&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">requestedFrameMax&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRequestedFrameMax&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">requestedChannelMax&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRequestedChannelMax&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">requestedHeartbeat&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRequestedHeartbeat&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">shutdownTimeout&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getShutdownTimeout&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">saslConfig&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getSaslConfig&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">executor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getExecutor&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">threadFactory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getThreadFactory&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">_channelManager&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">_brokerInitiatedShutdown&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">_inConnectionNegotiation&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="c1">// we start out waiting for the first protocol response
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å¯åŠ¨è¿æ¥">å¯åŠ¨è¿æ¥&lt;/h3>
&lt;p>åˆå§‹åŒ–WorkServiceå’ŒHeartBeatSenderã€‚&lt;/p>
&lt;p>åˆ›å»ºä¸€ä¸ªchannel0çš„AMQChannelï¼Œè¿™ä¸ªchannel&lt;strong>ä¸ä¼šè¢«ChannelManagerç®¡ç†&lt;/strong>ã€‚&lt;/p>
&lt;p>é¦–å…ˆchannel0ä¼šå°†ä¸€ä¸ªBlockingRpcContinuationä½œä¸ºå½“å‰æœªå®Œæˆçš„Rpcè¯·æ±‚ï¼Œç”¨äºæ¥æ”¶&lt;strong>handshake&lt;/strong>çš„å“åº”ã€‚&lt;/p>
&lt;p>ç„¶åchannel0ä¼šå‘socketä¸­å†™å…¥ä¸€æ¡åªæœ‰headerçš„æ¶ˆæ¯ä½œä¸º&lt;strong>handshake&lt;/strong>ï¼Œheaderä¸­åŒ…å«äº†å®¢æˆ·ç«¯çš„ç‰ˆæœ¬å·ã€‚&lt;/p>
&lt;p>ç´§æ¥ç€ä¼šå¯åŠ¨ä¸»å¾ªç¯çº¿ç¨‹ï¼Œä¸»å¾ªç¯ä¼šé€šè¿‡SocketFrameHandlerä»socketæ¥æ”¶å­—èŠ‚æµã€‚æ­¤æ—¶æ¥æ”¶åˆ°çš„ç¬¬ä¸€æ¡æ•°æ®æ˜¯æœåŠ¡ç«¯å“åº”handshakeè¿”å›çš„Connection.Startä¿¡æ¯ï¼ˆåŒ…å«æœåŠ¡ç«¯ç‰ˆæœ¬ã€æœºåˆ¶ã€åŸºç¡€ä¿¡æ¯ï¼‰ã€‚&lt;/p>
&lt;p>ä¸»å¾ªç¯çº¿ç¨‹å¯åŠ¨åï¼Œä¸»çº¿ç¨‹ä¼šé˜»å¡åœ°ç­‰å¾…æœåŠ¡ç«¯çš„handshakeå“åº”ã€‚æ‹¿åˆ°å“åº”ä¹‹åä¼šå¯¹æœåŠ¡å™¨å›ä¼ çš„ä¿¡æ¯è¿›è¡Œæ¯”å¯¹ï¼Œç„¶åå‘é€Connection.StartOKçš„ä¿¡æ¯å»æœåŠ¡ç«¯ï¼ˆè¿™ä¸ªè¯·æ±‚ä¹Ÿè¿˜æ˜¯é˜»å¡å¼çš„ï¼‰ï¼Œç­‰å¾…æœåŠ¡ç«¯å›ä¼ Connection.Tuneï¼ˆåŒ…å«æœ€å¤§channelæ•°ã€æœ€å¤§frameé•¿åº¦å’Œheartbeaté—´éš”ï¼‰ã€‚å°†è¿™äº›ä¿¡æ¯ä¸å®ä¾‹åˆå§‹åŒ–æ˜¯çš„è®¾ç½®ä¿¡æ¯è¿›è¡Œå¯¹æ¯”ï¼Œåˆå§‹åŒ–ChannelManager&lt;/p>
&lt;p>ç´§æ¥ç€å‘é€Connection.TuneOkå’ŒConnection.Openæ¶ˆæ¯å»æœåŠ¡ç«¯ï¼Œå®Œæˆconnectionçš„å»ºç«‹ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Connection &amp;gt; MainLoop &amp;gt; readFrame&lt;/p>
&lt;/blockquote>
&lt;h2 id="æ¶ˆæ¯ä½“">æ¶ˆæ¯ä½“&lt;/h2>
&lt;p>Frameæ˜¯å¯¹AMQPæ¶ˆæ¯çš„å°è£…ï¼šåŒ…å«frameçš„typeã€channelå·ã€æ¶ˆæ¯å†…å®¹&lt;/p>
&lt;blockquote>
&lt;p>type|channelNumber|payloadSize|payload|frameEndMarker&lt;/p>
&lt;/blockquote>
&lt;p>PayloadåŒ…å«äº†æ¶ˆæ¯ç±»å‹ã€æ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä¸»é¢˜&lt;/p>
&lt;blockquote>
&lt;p>method|header|body&lt;/p>
&lt;/blockquote>
&lt;h2 id="æ¶ˆæ¯å‘é€å’Œæ¥æ”¶">æ¶ˆæ¯å‘é€å’Œæ¥æ”¶&lt;/h2>
&lt;p>æ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶éƒ½è¦channelæ¥å®Œæˆã€‚&lt;/p>
&lt;h3 id="åˆ›å»ºchannel">åˆ›å»ºChannel&lt;/h3>
&lt;p>é€šè¿‡Connectionçš„ChannelManageræ¥åˆ›å»ºChannelï¼Œé€šè¿‡æŒ‡å®šçš„ChannelNumberæˆ–è€…ç”±åˆ†é…å™¨åˆ†é…ã€‚åˆ›å»ºå¥½çš„Channelå®ä¾‹ä¼šæ”¾å…¥ChannelManagerçš„Mapä¸­ï¼Œ&lt;strong>keyä¸ºChannelNumber&lt;/strong>ã€‚ç”±æ­¤å¯è§Channelæ˜¯Connectionå”¯ä¸€çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="n">ChannelN&lt;/span> &lt;span class="nf">createChannel&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">AMQConnection&lt;/span> &lt;span class="n">connection&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">ChannelN&lt;/span> &lt;span class="nf">createChannel&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">AMQConnection&lt;/span> &lt;span class="n">connection&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">channelNumber&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">ChannelN&lt;/span> &lt;span class="nf">addNewChannel&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">AMQConnection&lt;/span> &lt;span class="n">connection&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">channelNumber&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kd">protected&lt;/span> &lt;span class="n">ChannelN&lt;/span> &lt;span class="nf">instantiateChannel&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">AMQConnection&lt;/span> &lt;span class="n">connection&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">channelNumber&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ConsumerWorkService&lt;/span> &lt;span class="n">workService&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Channelå®ä¾‹åŒ–ä¹‹åä¼šè°ƒç”¨Channel.openæ–¹æ³•ï¼Œå‘é€Channel.Openå»æœåŠ¡ç«¯ï¼ˆé˜»å¡å¼ï¼‰ï¼Œç­‰å¾…æœåŠ¡ç«¯å“åº”Channel.OpenOkã€‚&lt;/p>
&lt;h3 id="æ¶ˆæ¯å‘é€">æ¶ˆæ¯å‘é€&lt;/h3>
&lt;p>Channel.transmit å‘é€æ¶ˆæ¯ï¼Œè°ƒç”¨AMQCommand.transmitå®Œæˆå‘é€ã€‚&lt;/p>
&lt;p>AMQCommand.transmitå°†æ¶ˆæ¯å°è£…æˆFrameï¼Œé€šè¿‡connectionçš„SocketFrameHandlerå†™å…¥OutpuStreamã€‚&lt;/p>
&lt;h3 id="æ¶ˆæ¯æ¥æ”¶">æ¶ˆæ¯æ¥æ”¶&lt;/h3>
&lt;p>ä¸»å¾ªç¯çº¿ç¨‹åœ¨é“¾æ¥åˆ›å»ºå®Œæˆåä¼šç›‘å¬socketï¼Œä»InputStreamä¸­è¯»å–äºŒè¿›åˆ¶æµå°è£…æˆFrameã€‚é€šè¿‡Frameä¸­çš„ChannelNumberä»ChannelManagerä¸­è·å–å¯¹åº”çš„Channelå®ä¾‹å¤„ç†Frameã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">_running&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Frame&lt;/span> &lt;span class="n">frame&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">_frameHandler&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">readFrame&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">frame&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">_missedHeartbeats&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">frame&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">type&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">AMQP&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">FRAME_HEARTBEAT&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// Ignore it: we&amp;#39;ve already just reset the heartbeat counter.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">frame&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">channel&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// the special channel
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">_channel0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">handleFrame&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">frame&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">isOpen&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// If we&amp;#39;re still _running, but not isOpen(), then we
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// must be quiescing, which means any inbound frames
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// for non-zero channels (and any inbound commands on
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// channel zero that aren&amp;#39;t Connection.CloseOk) must
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// be discarded.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ChannelManager&lt;/span> &lt;span class="n">cm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">_channelManager&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">cm&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">cm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getChannel&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">frame&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">channel&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">handleFrame&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">frame&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// Socket timeout waiting for a frame.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// Maybe missed heartbeat.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">handleSocketTimeout&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Channelä¼šä½¿ç”¨å·²ç»å‡†å¤‡å¥½çš„AMQCommandå¤„ç†Frameï¼Œå¹¶æœªä¸‹ä¸€ä¸ªFrameå‡†å¤‡æ–°çš„AMQCommandã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">handleFrame&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Frame&lt;/span> &lt;span class="n">frame&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">IOException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">AMQCommand&lt;/span> &lt;span class="n">command&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">_command&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">handleFrame&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">frame&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// a complete command has rolled off the assembly line
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">_command&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">AMQCommand&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// prepare for the next one
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">handleCompleteInboundCommand&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>AMQCommadä¼šä½¿ç”¨CommandAssemblerä¾æ¬¡ä»Frameçš„payloadä¸­æ£€å‡ºå¯¹åº”çš„Methodã€Headerå’ŒBodyã€‚å¦‚æœæ£€å‡ºäº†Bodyï¼Œæ•´ä¸ªFrameä¼šè¢«æ£€å‡ºå®Œæˆã€‚å¦‚è¿‡æœªå®Œæˆï¼Œä¼šè¿›å…¥ä¸»å¾ªç¯å†æ¬¡å¤„ç†ç›´è‡³å®Œæˆã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">synchronized&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">handleFrame&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Frame&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">IOException&lt;/span>
&lt;span class="o">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">state&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="n">EXPECTING_METHOD&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">consumeMethodFrame&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="k">break&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="n">EXPECTING_CONTENT_HEADER&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">consumeHeaderFrame&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="k">break&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="n">EXPECTING_CONTENT_BODY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">consumeBodyFrame&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="k">break&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">AssertionError&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Bad Command State &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">state&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">isComplete&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Frameè¢«æ£€å‡ºå®Œåï¼Œä¼šæ ¹æ®Methodçš„ç±»å‹è¿›å…¥ä¸åŒçš„å¼‚æ­¥å¤„ç†æµç¨‹ã€‚&lt;/p>
&lt;p>Methodåœ¨channelæ‰“å¼€å’Œå…³é—­çš„æƒ…å†µä¸‹ä¼šä»¥ä¸‹çš„å¯èƒ½ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Channelæ‰“å¼€ï¼šBasic.Deliver, Basic.Return, Basic.Flow, Basic.Ack, Basic.Nack, Basic.RecoveryOk, Basic.Cancel&lt;/p>
&lt;p>Channelå…³é—­ï¼šChannel.CloseOk&lt;/p>
&lt;/blockquote>
&lt;h2 id="ç”Ÿäº§å’Œæ¶ˆè´¹">ç”Ÿäº§å’Œæ¶ˆè´¹&lt;/h2>
&lt;h3 id="ç”Ÿäº§">ç”Ÿäº§&lt;/h3>
&lt;p>è°ƒç”¨Channel.basicPublish()æ–¹æ³•ï¼ŒæŒ‡å®šexchangeã€routingKeyç­‰ä¿¡æ¯ï¼Œæ¶ˆæ¯å±æ€§ã€æ¶ˆæ¯ä½“ã€‚å°è£…æˆBaisc.Publishï¼Œæ”¾å…¥AMQCommandï¼Œæœ€åè°ƒç”¨transmitæ–¹æ³•å®Œæˆå‘é€ã€‚å‚è€ƒ&lt;a href="http://atbug.com/deep-in-rabbitmq-java-client/#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81">æ¶ˆæ¯å‘é€&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">basicPublish&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">exchange&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">routingKey&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="kt">boolean&lt;/span> &lt;span class="n">mandatory&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">immediate&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">BasicProperties&lt;/span> &lt;span class="n">props&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">byte&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">body&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">throws&lt;/span> &lt;span class="n">IOException&lt;/span>
&lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">nextPublishSeqNo&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">unconfirmedSet&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">getNextPublishSeqNo&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="n">nextPublishSeqNo&lt;/span>&lt;span class="o">++;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">BasicProperties&lt;/span> &lt;span class="n">useProps&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">props&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">props&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">useProps&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MessageProperties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MINIMAL_BASIC&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">transmit&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">AMQCommand&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Basic&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Publish&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Builder&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">exchange&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">routingKey&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">routingKey&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">mandatory&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">mandatory&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">immediate&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">immediate&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">(),&lt;/span>
&lt;span class="n">useProps&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">body&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ¶ˆè´¹">æ¶ˆè´¹&lt;/h3>
&lt;p>åˆ›å»ºQueueingConsumerå®ä¾‹ï¼Œç„¶åè°ƒç”¨Channel.basicConsumeæ–¹æ³•ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">queueingConsumer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">QueueingConsumer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">channel&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">basicConsume&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;queue_name&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">queueingConsumer&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="n">QueueingConsumer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Delivery&lt;/span> &lt;span class="n">delivery&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">queueingConsumer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">nextDelivery&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span>&lt;span class="o">{&lt;/span>
&lt;span class="n">delivery&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getEnvelope&lt;/span>&lt;span class="o">();&lt;/span>&lt;span class="c1">//æ¶ˆæ¯å¤´
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">delivery&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getProperties&lt;/span>&lt;span class="o">();&lt;/span>&lt;span class="c1">//æ¶ˆæ¯å±æ€§
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">delivery&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getBody&lt;/span>&lt;span class="o">()&lt;/span>&lt;span class="err">ï¼›&lt;/span>&lt;span class="c1">//æ¶ˆæ¯ä½“
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>&lt;span class="k">finally&lt;/span>&lt;span class="o">{&lt;/span>
&lt;span class="c1">//channel.basicAck();
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//channel.basicNack()
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>QueueingConsumerå®ç°äº†Consumeræ¥å£ã€‚&lt;/p>
&lt;p>Channel.basicConsumeæ–¹æ³•ä¼šå°è£…Channel.Consumeæ¶ˆæ¯å‘é€åˆ°æœåŠ¡ç«¯ï¼ˆé˜»å¡å¼ï¼‰ï¼Œç­‰å¾…æœåŠ¡ç«¯çš„Channel.ConsumeOkå“åº”ï¼ˆåŒ…å«äº†æœåŠ¡ç«¯ä¸ºConsumeråˆ†é…çš„ConsumerTagï¼‰ã€‚ç„¶åå°†QueueingConsumeræ”¾å…¥Mapä¸­ï¼Œ&lt;strong>keyä¸ºConsumerTag&lt;/strong>ã€‚consumeræ˜¯Channelå”¯ä¸€ã€‚&lt;/p>
&lt;p>å½“å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå‚è€ƒ&lt;a href="http://atbug.com/deep-in-rabbitmq-java-client/#%E6%B6%88%E6%81%AF%E6%8E%A5%E6%94%B6">æ¶ˆæ¯æ¥æ”¶&lt;/a>ã€‚Basic.Deliverç±»å‹çš„æ¶ˆæ¯ï¼ˆconsumerTagã€deliveryTagã€redeliveredã€exchangeã€routingKeyï¼‰ä¼šè¿›å…¥æ¶ˆè´¹å¤„ç†æµç¨‹ã€‚Channelæ ¹æ®ConsumerTagä»Mapä¸­è·å–å¯¹åº”çš„QueueConsumerå®ä¾‹ï¼Œç”±Channelçš„ConsumerDispatcheré€šè¿‡Connectionåˆå§‹åŒ–çš„WorkServiceåˆ›å»ºæ–°çš„å¤„ç†çº¿ç¨‹ï¼Œè°ƒç”¨QueueConsumerå®ä¾‹çš„handleDeliveryæ–¹æ³•ã€‚QueueConsumerå°†æ¶ˆæ¯å°è£…æˆDeliveryå¯¹è±¡ï¼Œæ”¾å…¥BlockingQueueä¸­ã€‚&lt;/p>
&lt;p>æ¶ˆè´¹çº¿ç¨‹ç­‰å¾…æ–°çš„Deliveryï¼ˆé˜»å¡å¼ï¼‰ï¼Œä¹‹ååˆ›å»ºæ–°çš„çº¿ç¨‹å®Œæˆæ¶ˆæ¯çš„å¤„ç†ã€‚&lt;/p></description></item><item><title>Gitå›è½¦æ¢è¡Œ</title><link>https://atbug.com/crlf-in-git/</link><pubDate>Wed, 14 Sep 2016 09:16:10 +0000</pubDate><guid>https://atbug.com/crlf-in-git/</guid><description>
&lt;p>æœ€è¿‘åˆä¸ªé¡¹ç›®ï¼Œcheckoutä¹‹åï¼Œæ²¡åšä»»ä½•æ”¹åŠ¨å‰git statuså‘ç°å·²ç»æœ‰modifiedäº†ï¼Œé€šè¿‡git diffå‘ç°æœ‰ä¸¤ç§æ”¹åŠ¨ï¼š&lt;/p>
&lt;blockquote>
&lt;p>- warning: CRLF will be replaced by LF inÂ *&lt;em>*&lt;/em>&lt;/p>
&lt;p>- åˆ é™¤å¹¶æ·»åŠ çš„åŒæ ·çš„è¡Œ&lt;/p>
&lt;/blockquote>
&lt;p>ä½¿ç”¨git diff -wå´æ²¡æœ‰æ”¹åŠ¨ï¼›ä½¿ç”¨git diff â€“ws-error-highlight=new,oldå‘ç°è¡Œå°¾æœ‰**^M**&lt;/p>
&lt;p>æˆ‘æœ¬äººç”¨çš„æ˜¯Linuxï¼Œå…¶ä»–åŒäº‹æœ‰ç”¨Windowsï¼Œé—®é¢˜å°±å‡ºåœ¨å¹³å°ä¸Šã€‚&lt;/p>
&lt;blockquote>
&lt;p>Windowsç”¨CR LFæ¥å®šä¹‰æ¢è¡Œï¼ŒLinuxç”¨LFã€‚CRå…¨ç§°æ˜¯Carriage Return ,æˆ–è€…è¡¨ç¤ºä¸º\r, æ„æ€æ˜¯å›è½¦ã€‚ LFå…¨ç§°æ˜¯Line Feedï¼Œå®ƒæ‰æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æ¢è¡Œè¡¨ç¤ºç¬¦ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>git configä¸­å…³äºCRLFæœ‰ä¸¤ä¸ªè®¾å®šï¼šcore.autocrlfå’Œcore.safecrlfã€‚&lt;/p>
&lt;blockquote>
&lt;p>ä¸€ã€AutoCRLF&lt;/p>
&lt;p>#æäº¤æ—¶è½¬æ¢ä¸ºLFï¼Œæ£€å‡ºæ—¶è½¬æ¢ä¸ºCRLF&lt;/p>
&lt;p>git config â€“global core.autocrlf true&lt;/p>
&lt;p>#æäº¤æ—¶è½¬æ¢ä¸ºLFï¼Œæ£€å‡ºæ—¶ä¸è½¬æ¢&lt;/p>
&lt;p>git config â€“global core.autocrlf input&lt;/p>
&lt;p>#æäº¤æ£€å‡ºå‡ä¸è½¬æ¢&lt;/p>
&lt;p>git config â€“global core.autocrlf false&lt;/p>
&lt;p>äºŒã€SafeCRLF&lt;/p>
&lt;p>#æ‹’ç»æäº¤åŒ…å«æ··åˆæ¢è¡Œç¬¦çš„æ–‡ä»¶&lt;/p>
&lt;p>git config â€“global core.safecrlf true&lt;/p>
&lt;p>#å…è®¸æäº¤åŒ…å«æ··åˆæ¢è¡Œç¬¦çš„æ–‡ä»¶&lt;/p>
&lt;p>git config â€“global core.safecrlf false&lt;/p>
&lt;p>#æäº¤åŒ…å«æ··åˆæ¢è¡Œç¬¦çš„æ–‡ä»¶æ—¶ç»™å‡ºè­¦å‘Š&lt;/p>
&lt;p>git config â€“global core.safecrlf warn&lt;/p>
&lt;/blockquote>
&lt;p>è¿™ç§æƒ…å†µï¼ŒæŠŠautocrlfç½®ä¸ºfalseï¼Œsafecrlfä¹Ÿç½®ä¸ºfalseï¼Œå¯ä»¥å¿½ç•¥ä¸åŒå¹³å°ä¸Šå›è½¦æ¢è¡Œçš„å·®å¼‚ã€‚&lt;/p>
&lt;p>è®¾ç½®å®Œæˆåï¼Œå‘ç°ç¬¬äºŒä¸ªé—®é¢˜è¿˜æ˜¯å­˜åœ¨ã€‚è¿™æ—¶è¦æŸ¥çœ‹ä»£ç åº“ä¸­æ˜¯å¦å­˜åœ¨.gitattributesæ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨æ‰“å¼€.gitattributesã€‚&lt;/p>
&lt;p>åœ¨è¯¥é¡¹ç›®çš„.gitattributesä¸­æœ‰å‡ ç§è®¾å®šï¼š&lt;/p>
&lt;blockquote>
&lt;ol>
&lt;li>* text=auto !eol æ‰€æœ‰å¸¦æœ‰textå±æ€§çš„æ–‡ä»¶ä½¿ç”¨autoçš„EOLï¼Œä½†æ˜¯ä¸æŒ‡å®šEOLæ–¹å¼ï¼ˆCRLF or LFï¼‰&lt;/li>
&lt;li>[path]/file -text å–æ¶ˆæ–‡ä»¶çš„textå±æ€§&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>å¦‚æœä¸æŒ‡å®šEOLï¼Œgitä¼šä½¿ç”¨configä¸­çš„core.eolã€‚å¦‚æœæœªè®¾ç½®core.eolï¼Œgitä¼šä½¿ç”¨å¹³å°é»˜è®¤çš„å›è½¦æ¢è¡Œã€‚&lt;/p>
&lt;p>ä¼˜å…ˆçº§ core.autocrlf &amp;gt; text=auto + core.eolã€‚&lt;/p>
&lt;p>ä»¥ä¸‹è®¾ç½®çš„ç»“æœç›¸åŒï¼š&lt;/p>
&lt;blockquote>
&lt;p>core.autocrlf=true&lt;/p>
&lt;p>core.eol=CRLF åŒæ—¶ * text=auto !eol&lt;/p>
&lt;p>* text=auto CRLF&lt;/p>
&lt;/blockquote>
&lt;p>.gitattributesè®¾ç½®ä¼šå½±å“checkoutå’Œcheckin&lt;/p>
&lt;p>æœ€åçš„è§£å†³æ–¹æ¡ˆæ˜¯ç›´æ¥æ¸…ç©ºäº†.gitattributeså†…å®¹ï¼Œè¿™ä¸ªé—®é¢˜åº”è¯¥æ˜¯åœ¨é¡¹ç›®ä»svnè¿ç§»åˆ°gitæ—¶è¿ç§»å·¥å…·è‡ªåŠ¨æ·»åŠ çš„ç»“æœã€‚&lt;/p></description></item><item><title>æ·±å…¥å‰–æHashSetå’ŒHashMapå®ç°</title><link>https://atbug.com/deep-in-implementation-of-hashset/</link><pubDate>Mon, 11 Jul 2016 14:57:16 +0000</pubDate><guid>https://atbug.com/deep-in-implementation-of-hashset/</guid><description>
&lt;p>HashSetæ˜¯ä¸€ä¸ªåŒ…å«éé‡å¤å…ƒç´ çš„é›†åˆï¼Œå¦‚ä½•å®ç°çš„ï¼Œè¦ä»åº•å±‚å®ç°ä»£ç çœ‹èµ·ã€‚&lt;/p>
&lt;h4 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h4>
&lt;p>é¦–å…ˆéé‡å¤å…ƒç´ å¦‚ä½•å®šä¹‰ï¼Œçœ‹Setçš„æè¿°ï¼š&lt;/p>
&lt;blockquote>
&lt;p>More formally, sets contain no pair of elements e1 and e2 such that e1.equals(e2), and at most one null element.&lt;/p>
&lt;p>Setä¸ä¼šæ‰¾åˆ°ä¸¤ä¸ªå…ƒç´ ï¼Œå¹¶ä¸”ä¸¤ä¸ªå…ƒç´ æ»¡è¶³e1.equals(e2)ä¸ºtrueï¼›å¹¶ä¸”æœ€å¤šåªæœ‰ä¸€ä¸ªnullå…ƒç´ ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å¦‚æœæ²¡æœ‰é‡å†™equalsæ–¹æ³•ï¼ŒæŸ¥çœ‹Objectç±»ä¸­equalæ–¹æ³•çš„å®ç°ï¼Œ==æ¯”è¾ƒçš„å…¶å®æ˜¯ä¸¤ä¸ªå¯¹è±¡åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">equals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯´èµ·equalsæ–¹æ³•ï¼Œå°±ä¸å¾—ä¸è¯´hashCodeæ–¹æ³•äº†ã€‚Javaä¸­å¯¹äºhashCodeæœ‰ä¸ªå¸¸è§„åå®š&lt;/p>
&lt;blockquote>
&lt;p>The general contract of hashCode is:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Whenever it is invoked on the same object more than once during an execution of a Java application, the hashCode method must consistently return the same integer, provided no information used in equals comparisons on the object is modified. This integer need not remain consistent from one execution of an application to another execution of the same application.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>If two objects are equal according to the equals(Object) method, then calling the hashCode method on each of the two objects must produce the same integer result.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>It is not required that if two objects are unequal according to the equals(java.lang.Object) method, then calling the hashCode method on each of the two objects must produce distinct integer results. However, the programmer should be aware that producing distinct integer results for unequal objects may improve the performance of hash tables.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç¨‹åºæ‰§è¡ŒæœŸé—´ï¼Œåœ¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šæ‰§è¡Œå¤šæ¬¡hashCodeæ–¹æ³•ï¼Œéƒ½è¿”å›ç›¸åŒçš„æ•´æ•°ï¼Œå‰ææ˜¯equalsæ¯”è¾ƒä¸­æ‰€ä½¿ç”¨çš„å­—æ®µæ²¡æœ‰è¢«ä¿®æ”¹ã€‚è·¨åº”ç”¨ä¸­çš„hashCodeæ–¹æ³•è°ƒç”¨è¿”å›çš„æ•´æ•°ä¸è¦æ±‚ç›¸åŒã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœä¸¤ä¸ªå¯¹è±¡æ ¹æ®equalsæ–¹æ³•æ¯”è¾ƒç›¸åŒï¼Œé‚£hashCodeè¿”å›çš„æ•´æ•°ä¹Ÿå¿…é¡»ç›¸åŒã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœä¸¤ä¸ªå¯¹è±¡equalsæ–¹æ³•æ¯”è¾ƒä¸ç›¸åŒï¼Œè°ƒç”¨hashCodeè¿”å›çš„æ•´æ•°ä¸éœ€è¦ä¸åŒã€‚ä½†æ˜¯ç¨‹åºå‘˜åº”è¯¥çŸ¥é“ä¸ºä¸ç›¸ç­‰çš„å¯¹è±¡ç”Ÿæˆä¸åŒçš„æ•´æ•°å¯ä»¥æé«˜å“ˆå¸Œè¡¨çš„æ€§èƒ½ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h4 id="hashsetçš„åº•å±‚å®ç°">HashSetçš„åº•å±‚å®ç°&lt;/h4>
&lt;p>HashSetçš„åº•å±‚æ˜¯é€šè¿‡HashMapå®ç°çš„ï¼Œå°†å…ƒç´ ä½œä¸ºmapçš„keyä»¥è¾¾åˆ°å»é‡çš„ç›®çš„ï¼Œvalueä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªè™šæ‹Ÿçš„Objectå®ä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">private&lt;/span> &lt;span class="kd">transient&lt;/span> &lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="c1">// Dummy value to associate with an Object in the backing Map
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="n">PRESENT&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Object&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">E&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">PRESENT&lt;/span>&lt;span class="o">)==&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="hashmapçš„åº•å±‚å®ç°">HashMapçš„åº•å±‚å®ç°&lt;/h4>
&lt;p>{% asset_img hashmap-structure.jpg %}&lt;/p>
&lt;p>åˆ°æœ€åæˆ‘ä»¬è¦çœ‹HashMapçš„å®ç°äº†ï¼Œç®€å•è¯´å°±æ˜¯ä¸€ä¸ª&lt;strong>æ•°ç»„&lt;/strong>+&lt;strong>é“¾è¡¨&lt;/strong>çš„ç»“åˆã€‚&lt;/p>
&lt;ul>
&lt;li>é»˜è®¤åˆå§‹å®¹é‡16&lt;/li>
&lt;li>é»˜è®¤è´Ÿè·ç³»æ•°0.75&lt;/li>
&lt;li>Entryæ•°ç»„&lt;/li>
&lt;li>å¤§å°&lt;/li>
&lt;li>é˜ˆå€¼ï¼šåˆå§‹å€¼ç­‰äºåˆå§‹å®¹é‡&lt;/li>
&lt;li>è´Ÿè·ç³»æ•°&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">DEFAULT_INITIAL_CAPACITY&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">1&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">4&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">DEFAULT_LOAD_FACTOR&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">75f&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Entry&lt;/span>&lt;span class="o">&amp;lt;?,?&amp;gt;[]&lt;/span> &lt;span class="n">EMPTY_TABLE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">{};&lt;/span>
&lt;span class="kd">transient&lt;/span> &lt;span class="n">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;[]&lt;/span> &lt;span class="n">table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;[])&lt;/span> &lt;span class="n">EMPTY_TABLE&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">transient&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">threshold&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">loadFactor&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="entryå…ƒç´ ">Entryå…ƒç´ &lt;/h5>
&lt;p>Entryæ˜¯é“¾è¡¨çš„ç»“æœï¼Œkeyä¸ºMapä¸­çš„keyï¼Œvalueä¸ºMapä¸­çš„valueï¼Œhashä¸ºkeyçš„hashç»“æœï¼Œnextä¸ºä¸‹ä¸€ä¸ªå…ƒç´ ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">Map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="n">K&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">V&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">next&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">hash&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="æ·»åŠ å…ƒç´ ">æ·»åŠ å…ƒç´ &lt;/h5>
&lt;ul>
&lt;li>å¦‚æœæ•°ç»„ä¸ºç©ºï¼ˆå³mapåˆå§‹åŒ–åç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ ï¼‰æ‰©å……table&lt;/li>
&lt;li>å¦‚æœkeyä¸ºnullï¼Œåˆ™è°ƒç”¨putForNullKeyæ–¹æ³•ï¼Œnullä½äºtableçš„ä¸‹æ ‡0å¤„&lt;/li>
&lt;li>ç®—å‡ºkeyçš„hashå€¼&lt;/li>
&lt;li>é€šè¿‡hashå€¼ç®—å‡ºå…ƒç´ åœ¨tableä¸­çš„ä¸‹æ ‡å€¼
&lt;ul>
&lt;li>å¦‚æœè¯¥ä½ç½®å…ƒç´ ä¸ä¸ºç©ºï¼Œç„¶åéœ€è¦æ¯”è¾ƒå…ƒç´ çš„hashå€¼å’Œä¸Šé¢ç®—å‡ºçš„hashå€¼æ˜¯å¦ç›¸ç­‰ï¼ŒåŒæ—¶å…ƒç´ çš„keyå¯¹è±¡å’Œè¦å‡ºå…¥çš„keyæ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡ï¼ˆç›¸åŒçš„åœ°å€ ==æ¯”è¾ƒä¸ºtrueï¼‰æˆ–è€…equalsæ–¹æ³•æ˜¯å¦ä¸ºtrueã€‚å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œåˆ™æ›´æ–°è¯¥entryçš„valueå€¼ï¼›è‹¥ä¸æ»¡è¶³åˆ™éå†æ•´ä¸ªé“¾è¡¨ã€‚&lt;/li>
&lt;li>å¦‚æœä¸ºç©ºç›´æ¥æ·»åŠ æ–°çš„entryã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>JDK8æ­¤å¤„æœ‰æ›´æ–°ï¼Œè§æœ«å°¾&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="nf">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">K&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">table&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">EMPTY_TABLE&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">inflateTable&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">threshold&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">putForNullKey&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">hash&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hash&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">indexFor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hash&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">];&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Object&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hash&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">hash&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">((&lt;/span>&lt;span class="n">k&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">key&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="o">)))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">V&lt;/span> &lt;span class="n">oldValue&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">recordAccess&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">oldValue&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">modCount&lt;/span>&lt;span class="o">++;&lt;/span>
&lt;span class="n">addEntry&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hash&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="æ‰©å……table">æ‰©å……table&lt;/h5>
&lt;p>å¯¹toSzieç®—å‡ºæœ€å°çš„2çš„å¹‚å€¼ï¼Œç”¨äº†Integer.highestOneBit((toSize -1) &amp;laquo; 1)ã€‚å‡ä¸€ä¹‹åå·¦ç§»ä¸€ä½ï¼Œç„¶åå–æœ€é«˜ä½å€¼ï¼Œå…¶ä½™ä¸ºè¡¥0ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆæ•°ç»„é•¿åº¦å¿…é¡»ä¸º2çš„å¹‚å€¼ï¼Œè¯·ç»§ç»­çœ‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * æ‰©å……table
&lt;/span>&lt;span class="cm">**/&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">inflateTable&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">toSize&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// Find a power of 2 &amp;gt;= toSize
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">capacity&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">roundUpToPowerOf2&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">toSize&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">threshold&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">Math&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">min&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">capacity&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">loadFactor&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">MAXIMUM_CAPACITY&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Entry&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">capacity&lt;/span>&lt;span class="o">];&lt;/span>
&lt;span class="n">initHashSeedAsNeeded&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">capacity&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="è®¡ç®—hashå€¼">è®¡ç®—hashå€¼&lt;/h5>
&lt;p>hashSeedå€¼ä¸º0ï¼Œå°†keyçš„hashCodeå€¼åšå¤šæ¬¡ä½ç§»å’Œå¼‚æˆ–è¿ç®—&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">final&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">hash&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hashSeed&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">0&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">h&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">sun&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">misc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Hashing&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">stringHash32&lt;/span>&lt;span class="o">((&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">h&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hashCode&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="c1">// This function ensures that hashCodes that differ only by
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// constant multiples at each bit position have a bounded
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// number of collisions (approximately 8 at default load factor).
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">h&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">h&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">20&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">^&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">h&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">12&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">h&lt;/span> &lt;span class="o">^&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">h&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">7&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">^&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">h&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">4&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="è®¡ç®—å…ƒç´ ä½ç½®">è®¡ç®—å…ƒç´ ä½ç½®&lt;/h5>
&lt;p>è¿™é‡Œçš„é€»è¾‘å¾ˆç®€å•ï¼šå°†hashå€¼è·Ÿæ•°ç»„é•¿åº¦-1åšäº†æŒ‰ä½ä¸ã€‚&lt;/p>
&lt;p>åœ¨è¿›è¡ŒæŸ¥æ‰¾çš„æ—¶å€™æ˜¯é€šè¿‡keyçš„hashå€¼ï¼Œå¦‚æœæˆ‘ä»¬å°†å…ƒç´ çš„ä½ç½®åˆ†å¸ƒå¾—å°½é‡å‡åŒ€ä¸€äº›ï¼Œå°½é‡åšåˆ°æ¯ä¸ªä½ç½®ä¸Šåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œè¾¾åˆ°O(1)çš„æŸ¥æ‰¾ã€‚è¿™ç§æŸ¥æ‰¾é€šè¿‡å–ä½™å°±å¯ä»¥åšåˆ°ï¼Œåœ¨Javaä¸­å¦‚ä½•åšåˆ°æ¯”è¾ƒå¿«çš„å–ä½™å‘¢ï¼Œç­”æ¡ˆæ˜¯ä½ä¸è¿ç®—ã€‚&lt;/p>
&lt;p>ä¸Šé¢æ‰©å……æ•°ç»„çš„æ—¶å€™æˆ‘ä»¬ä¿è¯é•¿åº¦ä¸º2çš„å¹‚å€¼ï¼Œé‚£å‡ä¸€ä¹‹åå°±æ˜¯æ¯ä½éƒ½æ˜¯&lt;strong>1&lt;/strong>ã€‚åšä½ä¸è¿ç®—å°±èƒ½ä¿è¯ä½ä½ä¸åŒçš„hashå€¼ä¼šè½åœ¨ä¸åŒçš„ä½ç½®ä¸Šï¼Œé™ä½å†²çªï¼ˆç¢°æ’ï¼‰ï¼Œæœ€å¤§ç¨‹åº¦åšåˆ°å‡åŒ€åˆ†å¸ƒï¼Œå‡å°‘é“¾è¡¨çš„å‡ºç°ï¼ˆæŸ¥æ‰¾å˜æˆO(n)ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">indexFor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">h&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// assert Integer.bitCount(length) == 1 : &amp;#34;length must be a non-zero power of 2&amp;#34;;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">h&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="æ·»åŠ entry">æ·»åŠ entry&lt;/h5>
&lt;p>æ·»åŠ æ–°çš„å…ƒç´ æ—¶è¦æ£€æŸ¥å…ƒç´ ä¸ªæ•°æ˜¯å¦è¾¾åˆ°é˜ˆå€¼ï¼Œå¦åˆ™è¦åšæ‰©å®¹å¤„ç†ï¼Œæ–°tableçš„å®¹é‡ä¸ºå½“å‰tableé•¿åº¦çš„ä¸¤å€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kt">void&lt;/span> &lt;span class="nf">addEntry&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">hash&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">K&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">bucketIndex&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">((&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">threshold&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kc">null&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">bucketIndex&lt;/span>&lt;span class="o">]))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">resize&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">2&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">hash&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kc">null&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="n">hash&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">bucketIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">indexFor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hash&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">createEntry&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hash&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">bucketIndex&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="resize">resize&lt;/h5>
&lt;p>æ–°tableçš„å®¹é‡ä¸ºå½“å‰tableé•¿åº¦çš„ä¸¤å€ï¼ˆtable.length &amp;gt;= sizeï¼‰ï¼Œå°†æ—§æ•°æ®ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ä¸­ï¼Œè¿ç§»çš„è¿‡ç¨‹ä¸­è¦é‡æ–°è®¡ç®—å…ƒç´ åœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½®ã€‚ç½‘ä¸Šå¾ˆå¤šåœ°æ–¹æåˆ°è¿™ä¸ªæ“ä½œrehashï¼Œä½†æˆ‘è§‰å¾—reindexåè€Œæ›´æ°å½“ä¸€äº›ã€‚JDKä¸­å¯¹rehashæœ‰é¢å¤–çš„å®šä¹‰ï¼Œå°±æ˜¯&lt;strong>initHashSeedAsNeeded&lt;/strong>ã€‚å½“æ–°çš„å®¹é‡&amp;gt;=&lt;strong>jdk.map.althashing.threshold&lt;/strong>çš„é…ç½®æ—¶ï¼Œä¼šé‡æ–°è®¡ç®—keyçš„hashå€¼ï¼Œå³hash(e.key)ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kt">void&lt;/span> &lt;span class="nf">resize&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">newCapacity&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Entry&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">oldTable&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">oldCapacity&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">oldTable&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">oldCapacity&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">MAXIMUM_CAPACITY&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">threshold&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Integer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MAX_VALUE&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">return&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">Entry&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">newTable&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Entry&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">newCapacity&lt;/span>&lt;span class="o">];&lt;/span>
&lt;span class="n">transfer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">newTable&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">initHashSeedAsNeeded&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">newCapacity&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="n">table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">newTable&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">threshold&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="n">Math&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">min&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">newCapacity&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">loadFactor&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">MAXIMUM_CAPACITY&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="reindex">reindex&lt;/h5>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kt">void&lt;/span> &lt;span class="nf">transfer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">newTable&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">rehash&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">newCapacity&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">newTable&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">while&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">null&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">next&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">rehash&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hash&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">key&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="n">0&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">hash&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">key&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">indexFor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hash&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newCapacity&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">newTable&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">];&lt;/span>
&lt;span class="n">newTable&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">next&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;p>JDK8 update
æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œå¦‚æœå‘ç”Ÿå“ˆå¸Œå†²çªï¼Œä¼šéå†é“¾è¡¨ã€‚åŠ å…¥é“¾è¡¨çš„é•¿åº¦å¤§äºTREEIFY_THRESHOLDï¼ˆé»˜è®¤ä¸º8ï¼‰ï¼Œä¼šå°†é“¾è¡¨è½¬æˆ&lt;strong>çº¢é»‘æ ‘&lt;/strong>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">final&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="nf">putVal&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">hash&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">K&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">onlyIfAbsent&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="kt">boolean&lt;/span> &lt;span class="n">evict&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Node&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;[]&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">Node&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">((&lt;/span>&lt;span class="n">tab&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">tab&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">resize&lt;/span>&lt;span class="o">()).&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">((&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">hash&lt;/span>&lt;span class="o">])&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">tab&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">newNode&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hash&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Node&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">K&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hash&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">hash&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="o">((&lt;/span>&lt;span class="n">k&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">key&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="o">))))&lt;/span>
&lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="k">instanceof&lt;/span> &lt;span class="n">TreeNode&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">((&lt;/span>&lt;span class="n">TreeNode&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;)&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">putTreeVal&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">hash&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">binCount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="o">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">binCount&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">((&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">newNode&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">hash&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">binCount&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">TREEIFY_THRESHOLD&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="c1">// -1 for 1st
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">treeifyBin&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tab&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">hash&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hash&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">hash&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="o">((&lt;/span>&lt;span class="n">k&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">key&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="o">))))&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// existing mapping for key
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="n">oldValue&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">onlyIfAbsent&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">oldValue&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">afterNodeAccess&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">oldValue&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">++&lt;/span>&lt;span class="n">modCount&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(++&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">threshold&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">resize&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">afterNodeInsertion&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">evict&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">&amp;lt;!----&amp;gt;&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">treeifyBin&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Node&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;[]&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">hash&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">Node&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">tab&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">MIN_TREEIFY_CAPACITY&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">resize&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">((&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">hash&lt;/span>&lt;span class="o">])&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">TreeNode&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">hd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">tl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">do&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">TreeNode&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">replacementTreeNode&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">tl&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">hd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">prev&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tl&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">tl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">tl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="o">((&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">((&lt;/span>&lt;span class="n">tab&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hd&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">hd&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">treeify&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tab&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŒæ ·ï¼Œget(key)çš„æ—¶å€™ä¹Ÿä¼šç›¸åº”çš„ä»æ ‘ä¸­æŸ¥æ‰¾å…ƒç´ ã€‚&lt;/p></description></item><item><title>å¤šçº¿ç¨‹ä¸‹çš„å•ä¾‹æ¨¡å¼+åæ±‡ç¼–</title><link>https://atbug.com/singleton-in-multi-threads-programming/</link><pubDate>Wed, 06 Jul 2016 16:57:09 +0000</pubDate><guid>https://atbug.com/singleton-in-multi-threads-programming/</guid><description>
&lt;p>å¤šçº¿ç¨‹ä¸‹çš„å•ä¾‹æ¨¡å¼çš„å®ç°ï¼Œé¡ºä¾¿åšäº†åæ±‡ç¼–ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">MySingleton&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">MySingleton&lt;/span> &lt;span class="n">INSTANCE&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="nf">MySingleton&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">MySingleton&lt;/span> &lt;span class="nf">getInstance&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">INSTANCE&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">synchronized&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">MySingleton&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">INSTANCE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">MySingleton&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">INSTANCE&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="n">Compiled&lt;/span> &lt;span class="n">from&lt;/span> &lt;span class="s">&amp;#34;MySingleton.java&amp;#34;&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">MySingleton&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">MySingleton&lt;/span> &lt;span class="nf">getInstance&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">Code&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">0&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">getstatic&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="n">2&lt;/span> &lt;span class="c1">// Field INSTANCE:LMySingleton; //+è·å¾—ç±»çš„æŒ‡å®šåŸŸï¼Œå¹¶å‹å…¥æ ˆé¡¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">3&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">ifnonnull&lt;/span> &lt;span class="n">32&lt;/span> &lt;span class="c1">//+ä¸ä¸ºnullæ—¶è·³è½¬åˆ°è¡Œå·32
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">6&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">ldc_w&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="n">3&lt;/span> &lt;span class="c1">// class MySingleton //+å¸¸é‡å€¼ä»å¸¸é‡æ± ä¸­æ¨é€è‡³æ ˆé¡¶ï¼ˆå®½ç´¢å¼•ï¼‰ï¼Œæ¨é€çš„ä¸ºåœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">9&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">dup&lt;/span> &lt;span class="c1">//+å¤åˆ¶æ ˆé¡¶æ•°å€¼ï¼Œå¹¶ä¸”å¤åˆ¶å€¼è¿›æ ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">10&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">astore_0&lt;/span> &lt;span class="c1">//+å°†æ ˆé¡¶æ•°å€¼ï¼ˆobjectrefï¼‰å­˜å…¥å½“å‰ frameçš„å±€éƒ¨å˜é‡æ•°ç»„ä¸­æŒ‡å®šä¸‹æ ‡(indexï¼‰å¤„çš„å˜é‡ä¸­ï¼Œæ ˆé¡¶æ•°å€¼å‡ºæ ˆã€‚è¿™é‡Œå­˜çš„æ˜¯MySingletonç±»å®šä¹‰çš„åœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">11&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">monitorenter&lt;/span> &lt;span class="c1">//+è·å¾—å¯¹è±¡é”å³MySingletonåœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">12&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="n">3&lt;/span> &lt;span class="c1">// class MySingleton //+åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”å…¶å¼•ç”¨è¿›æ ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">15&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">dup&lt;/span> &lt;span class="c1">//+å¤åˆ¶æ ˆé¡¶æ•°å€¼ï¼Œå¹¶ä¸”å¤åˆ¶å€¼è¿›æ ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">16&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">invokespecial&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="n">4&lt;/span> &lt;span class="c1">// Method &amp;#34;&amp;lt;init&amp;gt;&amp;#34;:()V //+è°ƒç”¨è¶…ç±»æ„é€ æ–¹æ³•ã€å®ä¾‹åˆå§‹åŒ–æ–¹æ³•ã€ç§æœ‰æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">19&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">putstatic&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="n">2&lt;/span> &lt;span class="c1">// Field INSTANCE:LMySingleton; //+ä¸ºæŒ‡å®šçš„ç±»çš„é™æ€åŸŸèµ‹å€¼
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">22&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">aload_0&lt;/span> &lt;span class="c1">//+å½“å‰frameçš„å±€éƒ¨å˜é‡æ•°ç»„ä¸­ä¸‹æ ‡ä¸º indexçš„å¼•ç”¨å‹å±€éƒ¨å˜é‡è¿›æ ˆï¼Œè¿™é‡Œæ˜¯MySingletonç±»å®šä¹‰çš„åœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">23&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">monitorexit&lt;/span> &lt;span class="c1">//+é‡Šæ”¾å¯¹è±¡é”
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">24&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">goto&lt;/span> &lt;span class="n">32&lt;/span> &lt;span class="c1">//+è·³è½¬åˆ°è¡Œå·32
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">27&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">astore_1&lt;/span> &lt;span class="c1">//+å°†æ ˆé¡¶æ•°å€¼ï¼ˆobjectrefï¼‰å­˜å…¥å½“å‰ frameçš„å±€éƒ¨å˜é‡æ•°ç»„ä¸­æŒ‡å®šä¸‹æ ‡(indexï¼‰å¤„çš„å˜é‡ä¸­ï¼Œæ ˆé¡¶æ•°å€¼å‡ºæ ˆã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">28&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">aload_0&lt;/span> &lt;span class="c1">//+å½“å‰frameçš„å±€éƒ¨å˜é‡æ•°ç»„ä¸­ä¸‹æ ‡ä¸º 0çš„å¼•ç”¨å‹å±€éƒ¨å˜é‡è¿›æ ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">29&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">monitorexit&lt;/span> &lt;span class="c1">//+//+é‡Šæ”¾å¯¹è±¡é”
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">30&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">aload_1&lt;/span> &lt;span class="c1">//+å½“å‰frameçš„å±€éƒ¨å˜é‡æ•°ç»„ä¸­ä¸‹æ ‡ä¸º 1çš„å¼•ç”¨å‹å±€éƒ¨å˜é‡è¿›æ ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">31&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">athrow&lt;/span> &lt;span class="c1">//+å°†æ ˆé¡¶çš„æ•°å€¼ä½œä¸ºå¼‚å¸¸æˆ–é”™è¯¯æŠ›å‡º
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">32&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">getstatic&lt;/span> &lt;span class="err">#&lt;/span>&lt;span class="n">2&lt;/span> &lt;span class="c1">// Field INSTANCE:LMySingleton; //+è·å¾—ç±»çš„æŒ‡å®šåŸŸï¼Œå¹¶å‹å…¥æ ˆé¡¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">35&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">areturn&lt;/span> &lt;span class="c1">//+ä»æ–¹æ³•ä¸­è¿”å›ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">from&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">target&lt;/span> &lt;span class="n">type&lt;/span>
&lt;span class="n">12&lt;/span> &lt;span class="n">24&lt;/span> &lt;span class="n">27&lt;/span> &lt;span class="n">any&lt;/span>
&lt;span class="n">27&lt;/span> &lt;span class="n">30&lt;/span> &lt;span class="n">27&lt;/span> &lt;span class="n">any&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>ä½¿ç”¨Kryoæ›¿æ¢spring amqpçš„Javaåºåˆ—åŒ–</title><link>https://atbug.com/use-kryo-in-spring-amqp-serialization/</link><pubDate>Wed, 29 Jun 2016 05:29:14 +0000</pubDate><guid>https://atbug.com/use-kryo-in-spring-amqp-serialization/</guid><description>
&lt;p>spring amqpçš„åŸç”Ÿå¹¶æ²¡æœ‰å¯¹KryoåŠ ä»¥æ”¯æŒï¼ŒKryoçš„ä¼˜ç‚¹å°±ä¸å¤šè¯´äº†ã€‚&lt;/p>
&lt;p>gitåœ°å€ï¼š&lt;a href="https://github.com/addozhang/spring-kryo-messaeg-converter">https://github.com/addozhang/spring-kryo-messaeg-converter&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">KryoMessageConverter&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">AbstractMessageConverter&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">CONTENT_TYPE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;application/x-kryo&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">DEFAULT_CHARSET&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;UTF-8&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">defaultCharset&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">DEFAULT_CHARSET&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">KryoFactory&lt;/span> &lt;span class="n">kryoFactory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">DefaultKryoFactory&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> * Crate a message from the payload object and message properties provided. The message id will be added to the
&lt;/span>&lt;span class="cm"> * properties if necessary later.
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * @param object the payload
&lt;/span>&lt;span class="cm"> * @param messageProperties the message properties (headers)
&lt;/span>&lt;span class="cm"> * @return a message
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">protected&lt;/span> &lt;span class="n">Message&lt;/span> &lt;span class="nf">createMessage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span> &lt;span class="n">object&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">MessageProperties&lt;/span> &lt;span class="n">messageProperties&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kt">byte&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">bytes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">Kryo&lt;/span> &lt;span class="n">kryo&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">kryoFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">Output&lt;/span> &lt;span class="n">output&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ByteBufferOutput&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">4096&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">1024&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">kryo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">writeClassAndObject&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">output&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">object&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">bytes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toBytes&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">messageProperties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setContentType&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">CONTENT_TYPE&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">messageProperties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getContentEncoding&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">messageProperties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setContentEncoding&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">defaultCharset&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Message&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">bytes&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">messageProperties&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="nf">fromMessage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Message&lt;/span> &lt;span class="n">message&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">MessageConversionException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Object&lt;/span> &lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">MessageProperties&lt;/span> &lt;span class="n">properties&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">message&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getMessageProperties&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">properties&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">properties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getContentType&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">amp&lt;/span>&lt;span class="o">;&amp;amp;&lt;/span>&lt;span class="n">amp&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">properties&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getContentType&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">contains&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;x-kryo&amp;#34;&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Kryo&lt;/span> &lt;span class="n">kryo&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">kryoFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">kryo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">readClassAndObject&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">ByteBufferInput&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getBody&lt;/span>&lt;span class="o">()));&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">MessageConversionException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Converter not applicable to this message&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">content&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">DefaultKryoFactory&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">KryoFactory&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Kryo&lt;/span> &lt;span class="nf">create&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Kryo&lt;/span> &lt;span class="n">kryo&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Kryo&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">kryo&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Rabbitmqå»¶è¿Ÿé˜Ÿåˆ—å®ç°</title><link>https://atbug.com/rabbitmq-delay-queue-implementation/</link><pubDate>Wed, 30 Mar 2016 14:27:02 +0000</pubDate><guid>https://atbug.com/rabbitmq-delay-queue-implementation/</guid><description>
&lt;!-- raw HTML omitted -->
&lt;ul>
&lt;li>åœ¨requeue=falseçš„æƒ…å†µç³»ï¼Œæ¶ˆæ¯è¢«client reject&lt;/li>
&lt;li>æ¶ˆæ¯è¿‡æœŸ&lt;/li>
&lt;li>é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é™åˆ¶&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted --></description></item><item><title>å…³äºSLF4J</title><link>https://atbug.com/about-slf4j/</link><pubDate>Sat, 18 Apr 2015 11:16:26 +0000</pubDate><guid>https://atbug.com/about-slf4j/</guid><description>
&lt;p>Springçš„åŠŸèƒ½è¶Šæ¥è¶Šå¼ºå¤§ï¼ŒåŒæ—¶ä¹Ÿè¶Šæ¥è¶Šè‡ƒè‚¿ã€‚æ¯”å¦‚æƒ³å¿«é€Ÿæ­å»ºä¸€ä¸ªåŸºäºSpringçš„é¡¹ç›®ï¼Œè§£å†³ä¾èµ–é—®é¢˜éå¸¸è€—æ—¶ã€‚Springçš„é¡¹ç›®æ¨¡æ¿çš„å‡ºç°å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡&lt;a href="http://dist.springsource.com/release/STS/help/descriptors-3.0.xml">è¿™ä¸ªæè¿°æ–‡ä»¶&lt;/a>ï¼Œå¯ä»¥å¿«é€Ÿçš„æ‰¾åˆ°ä½ æ‰€éœ€è¦çš„æ¨¡æ¿ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€æ¬¡è®¤è¯†SLF4Jå°±æ˜¯åœ¨è¿™äº›é¡¹ç›®æ¨¡æ¿é‡Œï¼Œå®ƒçš„å…¨ç§°æ˜¯Simple Logging Facade for Javaã€‚ä»å­—é¢ä¸Šå¯ä»¥çœ‹å‡ºå®ƒåªæ˜¯ä¸€ä¸ªFacadeï¼Œä¸æä¾›å…·ä½“çš„æ—¥å¿—è§£å†³æ–¹æ¡ˆï¼ŒåªæœåŠ¡äºå„ä¸ªæ—¥å¿—ç³»ç»Ÿã€‚ç®€å•è¯´æœ‰äº†å®ƒï¼Œæˆ‘ä»¬å°±å¯ä»¥&lt;strong>éšæ„&lt;/strong>çš„æ›´æ¢æ—¥å¿—ç³»ç»Ÿï¼ˆå¦‚java.util.loggingã€logbackã€log4jï¼‰ã€‚æ¯”å¦‚åœ¨å¼€å‘çš„æ—¶å€™ä½¿ç”¨logbackï¼Œéƒ¨ç½²çš„æ—¶å€™å¯ä»¥åˆ‡æ¢åˆ°log4jï¼›å¦‚æœå…³é—­æ‰€æœ‰çš„logï¼Œåˆ‡æ¢åˆ°NOPå°±å¯ä»¥äº†ã€‚åªéœ€è¦æ›´æ”¹ä¾èµ–ï¼Œæä¾›æ—¥å¿—é…ç½®æ–‡ä»¶ï¼Œå…å»äº†ä¿®æ”¹ä»£ç çš„éº»çƒ¦ã€‚&lt;/p>
&lt;p>é¦–å…ˆçœ‹å¦‚ä½•ä½¿ç”¨ï¼š&lt;/p>
&lt;p>[java]
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;&lt;/p>
&lt;p>public class HelloWorld {
public static void main(String[] args) {
Logger logger = LoggerFactory.getLogger(HelloWorld.class);
logger.info(&amp;quot;Hello World&amp;quot;);
}
}
[/java]&lt;/p>
&lt;p>SLF4Jå°è£…äº†ä½¿ç”¨èµ·æ¥å’Œå…¶ä»–æ—¥å¿—ç³»ç»Ÿä¸€æ ·ç®€å•ã€‚ä¸Šé¢æåˆ°è¿‡SLF4Jä¸æä¾›å…·ä½“çš„æ—¥å¿—è§£å†³æ–¹æ¡ˆï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ—¶å€™é™¤äº†è¦å¼•ç”¨SLF4JåŒ…ï¼Œè¿˜è¦å¼•ç”¨å…·ä½“çš„æ—¥å¿—è§£å†³æ–¹æ¡ˆåŒ…ï¼ˆlog4jã€logging&amp;ndash;JDKæä¾›ã€logbackï¼‰ï¼Œè¿˜æœ‰æ‰€å¯¹åº”çš„bindingåŒ…ï¼ˆ&lt;em>slf4j-log4j&lt;/em>_ã€slf4j-jdk14ã€logback-classic_ï¼‰ã€‚&lt;/p>
&lt;p>ä»¥log4jä¸ºä¾‹ï¼Œæˆ‘ä»¬çœ‹SLF4Jçš„å®ç°æ–¹å¼ã€‚&lt;/p>
&lt;p>SLF4Jç±»åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šå°è¯•ä»ClassLoaderä¸­&lt;strong>org/slf4j/impl/StaticLoggerBinder.class&lt;/strong>ã€‚è¿™ä¸ªç±»æ¯”è¾ƒç‰¹æ®Šï¼Œæ¯ä¸ªbindingåŒ…é‡Œéƒ½æœ‰ã€‚ä¸åŒbindingåŒ…é‡Œçš„StaticLoggerBinderç±»ä¼šå»åˆå§‹åŒ–ä¸€ä¸ªç›¸åº”çš„å®ä¾‹ï¼Œå¦‚slf4j-log4jé‡Œï¼š&lt;/p>
&lt;p>[java]
/**&lt;/p>
&lt;ul>
&lt;li>æˆªå–çš„éƒ¨åˆ†ä»£ç 
*/
private StaticLoggerBinder() {
loggerFactory = new Log4jLoggerFactory();
}
[/java]&lt;/li>
&lt;/ul>
&lt;p>è€ŒLog4jLoggerAdapterå®ç°äº†SLF4Jçš„Loggeræ¥å£ï¼Œä½¿ç”¨äº†Adapteræ¨¡å¼å¯¹Log4jçš„Loggerè¿›è¡Œäº†å°è£…å¹¶æš´éœ²äº†Loggerçš„æ¥å£ï¼ŒLog4jLoggerFactoryæŒæœ‰äº†Log4jLoggerAdapterçš„å®ä¾‹ã€‚&lt;/p>
&lt;p>[java]
/**&lt;/p>
&lt;ul>
&lt;li>æˆªå–çš„éƒ¨åˆ†ä»£ç 
*/
public class Log4jLoggerFactory implements ILoggerFactory {
public Logger getLogger(String name) {
Logger slf4jLogger = null;
// protect against concurrent access of loggerMap
synchronized (this) {
slf4jLogger = (Logger) loggerMap.get(name);
if (slf4jLogger == null) {
org.apache.log4j.Logger log4jLogger;
if(name.equalsIgnoreCase(Logger.ROOT_LOGGER_NAME)) {
log4jLogger = LogManager.getRootLogger();
} else {
log4jLogger = LogManager.getLogger(name);
}
slf4jLogger = new Log4jLoggerAdapter(log4jLogger);
loggerMap.put(name, slf4jLogger);
}
}
return slf4jLogger;
}
}
[/java]&lt;/li>
&lt;/ul>
&lt;p>å…·ä½“çš„Logè§£å†³æ–¹æ¡ˆå°±ä¸åšå‰–æäº†ã€‚&lt;/p></description></item><item><title>æ—¥å¸¸å·¥ä½œä¸­ä½¿ç”¨çš„chromeæ’ä»¶</title><link>https://atbug.com/chrome-extensions-for-daily-work/</link><pubDate>Sun, 09 Feb 2014 09:26:50 +0000</pubDate><guid>https://atbug.com/chrome-extensions-for-daily-work/</guid><description>
&lt;p>å…ˆè¯´ä¸‹èƒŒæ™¯ï¼ŒJavaç¨‹åºçŒ¿ä¸€æšï¼Œå…¼åšhybrid appã€‚æ‰€ä»¥æ—¥å¸¸å·¥ä½œä¸­å…ä¸äº†è¦è·Ÿæµè§ˆå™¨æ‰“äº¤é“ï¼Œä¸€èˆ¬å°±åªç”¨chromeäº†ï¼Œçœ‹ä¸­å®ƒçš„è°ƒè¯•åŠŸèƒ½å’Œåºå¤§çš„æ’ä»¶åº“ã€‚ä¸‹é¢å°±åˆ—å‡ºå·¥ä½œä¸­ä½¿ç”¨çš„å„ç§æ’ä»¶ï¼Œæ’åä¸åˆ†å…ˆåã€‚&lt;/p>
&lt;ul>
&lt;li>googleå¸å·è¦æœ‰ï¼Œè€Œä¸”ä¸¤ä¸ªã€‚ä¸€ä¸ªæ—¥å¸¸ç”Ÿæ´»å¨±ä¹ï¼Œä¸€ä¸ªå·¥ä½œä½¿ç”¨ã€‚å¯ä»¥åŒæ­¥å„ç§æ•°æ®åˆ°äº‘ç«¯ï¼Œå¦‚appã€æ’ä»¶ã€è®¾ç½®ã€è‡ªåŠ¨å¡«å†™æ•°æ®ã€å¯†ç ã€è®¿é—®å†å²ã€æ‰“å¼€çš„æ ‡ç­¾ç­‰ç­‰ã€‚åŸè°…æˆ‘æŠŠåŒæ­¥ä¹Ÿå½“ä½œæ’ä»¶ï¼Œç®€ç›´å°±æ˜¯æ’ä»¶ä¸­çš„æˆ˜æ–—æœºã€‚&lt;/li>
&lt;li>Developer toolï¼Œè¿™ä¸ªæ˜¯chromeè‡ªå¸¦çš„å¼€å‘äººå‘˜å·¥å…·ï¼Œé›†å‰å°è®¾è®¡ã€ä»£ç è°ƒè¯•ã€èµ„æºç®¡ç†ç­‰åŠŸèƒ½ã€‚&lt;/li>
&lt;li>&lt;a href="https://chrome.google.com/webstore/detail/adblock-plus/cfhdojbkjhnklbpkdaibdccddilifddb">Adblock Plus&lt;/a>Â ä¸ç®¡å·¥ä½œè¿˜æ˜¯ç”Ÿæ´»ç”¨ï¼Œè¿™ä¸ªæ’ä»¶å¿…è£…ã€‚æœ‰é€‚åˆå›½äººä½¿ç”¨çš„å±è”½æ¸…å•ï¼ˆ&lt;a href="https://github.com/chinalist/chinalist">ChinaList+EasyList&lt;/a>ï¼‰ï¼Œè½»æ¾æå®šå„ç§å¹¿å‘Šï¼Œå°¤å…¶æ˜¯ç°åœ¨çš„å¹¿å‘Šæ— èŠ‚æ“ï¼Œå½±å“å·¥ä½œã€‚&lt;/li>
&lt;li>&lt;a href="https://chrome.google.com/webstore/detail/clear-cache/cppjkneekbjaeellbfkmgnhonkkjfpdn">Clear Cache&lt;/a>Â å¼€å‘ä¸­å¸¸å¸¸é‡åˆ°ç¼“å­˜å¼•èµ·çš„å„ç§å¥‡è‘©é—®é¢˜ï¼Œç¼“å­˜æ¸…ç†ä½¿ç”¨æ–¹ä¾¿ï¼Œå¯è®¾ç½®å¿«æ·é”®ã€‚&lt;/li>
&lt;li>&lt;a href="https://chrome.google.com/webstore/detail/edit-this-cookie/fngmhnnpilhplaeedifhccceomclgfbg">Edit This Cookie&lt;/a>Â Cookieçš„ä¿®æ”¹ï¼Œä¸è§£é‡Šã€‚&lt;/li>
&lt;li>&lt;a href="https://chrome.google.com/webstore/detail/gmbgaklkmjakoegficnlkhebmhkjfich">Google Calendar (by Google)&lt;/a>Â æ—¥ç¨‹å®‰æ’ç®¡ç†ã€‚&lt;/li>
&lt;li>&lt;a href="https://chrome.google.com/webstore/detail/niloccemoadcdkdjlinkgdfekeahmflj">Pocket&lt;/a>Â å¸¸è¯´çš„read it laterï¼Œç”¨ä½œæ”¶è—æˆ–è€…é‡åˆ°æš‚æ—¶æ²¡æ—¶é—´é˜…è¯»ï¼ˆæˆ–è€…ä¸æ–¹ä¾¿é˜…è¯»çš„ï¼Œä½ æ‡‚çš„ï¼‰ã€‚è·¨å¹³å°ï¼Œæœ‰ç§»åŠ¨ç«¯åº”ç”¨ã€‚éå¸¸å¥½ç”¨ï¼Œæ ¹æœ¬åœæ­¥ä¸‹æ¥ã€‚&lt;/li>
&lt;li>&lt;a href="https://chrome.google.com/webstore/detail/cpngackimfmofbokmjmljamhdncknpmg">Screen Capture (by Google)&lt;/a>Â googleå‡ºå“çš„ç½‘é¡µæˆªå›¾æ’ä»¶ï¼Œå¼ºå¤§ï¼Œå¯æˆªå–æ•´å¼ é¡µé¢ã€‚&lt;/li>
&lt;li>&lt;a href="http://streamus.com/">Streamusâ„¢ (Beta!)&lt;/a>Â å¥½å§ï¼Œè¿™æ˜¯å¨±ä¹çš„ï¼Œwork life balanceå˜›ï¼å…¬å¸ç½‘ç»œæ˜¯VPNä»é¦™æ¸¯å‡ºå¢ƒï¼Œå¹¶blockæ‰å„ç§å¨±ä¹éå¨±ä¹ç½‘ç«™ï¼Œå”¯ç‹¬youtubeè¿˜åœ¨ã€‚è¿™ä¸ªæ’ä»¶å¯ä»¥æ”¶å¬youtubeä¸Šçš„éŸ³ä¹ï¼Œæ¨èï¼&lt;/li>
&lt;li>&lt;a href="https://chrome.google.com/webstore/detail/djflhoibgkdhkhhcedjiklpkjnoahfmg">User-Agent Switcher for Chrome&lt;/a>Â ä¿®æ”¹æµè§ˆå™¨çš„user agentï¼Œå¤šæµè§ˆå™¨è°ƒè¯•ç”¨ã€‚&lt;/li>
&lt;li>&lt;a href="https://chrome.google.com/webstore/detail/%E7%AE%80%E5%8D%95-qr-%E7%94%9F%E6%88%90%E5%99%A8/ajaomcmkalmeeahjfdklkcjbljhbokjl">ç®€å• QR ç”Ÿæˆå™¨&lt;/a>Â ç”Ÿæˆå½“å‰æ ‡ç­¾ç½‘å€çš„äºŒç»´ç ï¼Œæ–¹ä¾¿æ‰‹æœºæ‰«æã€‚
Â &lt;/li>
&lt;/ul></description></item><item><title>About</title><link>https://atbug.com/about/</link><pubDate>Tue, 22 Jan 2013 10:02:37 +0800</pubDate><guid>https://atbug.com/about/</guid><description>
&lt;h3 id="åŸºæœ¬ä¿¡æ¯">åŸºæœ¬ä¿¡æ¯&lt;/h3>
&lt;p>&lt;strong>å¼ æ™“è¾‰&lt;/strong>&lt;/p>
&lt;p>èµ„æ·±ç å†œï¼Œ12 å¹´è½¯ä»¶å¼€å‘ç»éªŒã€‚æ›¾åœ¨æ±‡ä¸°è½¯ä»¶ã€å”¯å“ä¼šã€æ•°äººäº‘ç­‰å…¬å¸ä»»èŒã€‚&lt;/p>
&lt;p>ç›®å‰å°±èŒå°é¹æ±½è½¦ï¼Œåœ¨åŸºç¡€æ¶æ„å›¢é˜Ÿä»äº‹æŠ€æœ¯ä¸­å°çš„ç ”å‘ã€‚&lt;/p>
&lt;p>è¿™é‡Œæ‰€æœ‰çš„æ–‡ç« éƒ½ä¼šåŒæ­¥å‘é€åˆ°å…¬ä¼—å·ï¼šäº‘ç¼–ç  (å¾®ä¿¡å·ï¼šsevenfeet)&lt;/p>
&lt;p>&lt;img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/qrcode.jpg" alt="">&lt;/p></description></item></channel></rss>